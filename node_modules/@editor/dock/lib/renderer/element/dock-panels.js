"use strict";const panel=require("@editor/panel"),utils=require("../../utils");class DockPanels extends window.HTMLElement{get panels(){return this._panels}set panels(e){this._panels=e;for(let t=0;t<e.length;t++)this.addPanel(e[t])}get active(){return this._active}set active(e){this._active=e;let t=null;for(let n=0;n<this.children.length;n++){const a=this.children[n];a.name!==e?a.hidden=!0:t=a}t&&(t.hidden=!1,this._$active=t,null===t.getAttribute("focused")&&t.focus())}emit(e){const t=document.createEvent("HTMLEvents");t.initEvent("resize",!0,!1),this._$active.dispatchEvent(t)}constructor(){super(),this.addEventListener("dragover",e=>{if(!utils.drag.getDrag())return;e.preventDefault(),e.stopPropagation();let t=document.createEvent("HTMLEvents");t.pageX=e.pageX,t.pageY=e.pageY,t.initEvent("panel-area",!0,!1),this.dispatchEvent(t)},!0),this.addEventListener("drop",e=>{if(!utils.drag.getDrag())return;e.preventDefault(),e.stopPropagation();let t=document.createEvent("HTMLEvents");t.pageX=e.pageX,t.pageY=e.pageY,t.dataTransfer=e.dataTransfer,t.initEvent("panel-drop",!0,!1),this.dispatchEvent(t)},!0),this.addEventListener("dragleave",e=>{if(!utils.drag.getDrag())return;e.preventDefault(),e.stopPropagation();let t=document.createEvent("HTMLEvents");t.pageX=e.pageX,t.pageY=e.pageY,t.initEvent("panel-leave",!0,!1),this.dispatchEvent(t)},!0)}addPanel(e,t){const n=this.querySelectorAll("panel-frame");let a=n?Array.prototype.find.call(n,t=>t.name===e):null;const i=a&&a.userData.flags&&a.userData.flags.multiple;if(a&&!i){if(this.active===e){const e=document.createEvent("HTMLEvents");e.initEvent("hide",!1,!1),a.dispatchEvent(e);const t=document.createEvent("HTMLEvents");t.initEvent("show",!1,!1),a.dispatchEvent(t)}}else(a=document.createElement("panel-frame")).name=e;a.hidden=a.name!==this.active,a.addEventListener("load",e=>{this.updateOptions(),this.$groups.$tabs.addTab(e.target.getAttribute("name"))});let s=this.children;t>=s.length?this.appendChild(a):this.insertBefore(a,s[t])}async removePanel(e,t){let n=this.children;for(let a=0;a<n.length;a++){let i=n[a];if(i.name===e){if(!1===await i.close(t))return!1;i.parentElement===this&&this.removeChild(i)}}return this.updateOptions(),!0}removeLoadingPanel(){const e=[];let t=this.children;for(let n=0;n<t.length;n++){let a=t[n];a.isLoaded||(n--,e.push(a.name),a.parentElement===this&&this.removeChild(a))}return e}updateOptions(){let e=0,t=0;Array.prototype.forEach.call(this.children,n=>{const a=n.getData("size");e=a?Math.max(e,a["min-width"]||0):0,t=a?Math.max(t,a["min-height"]||0):0});let n=document.createEvent("HTMLEvents");n.initEvent("min-size-resize",!0,!0),n.minWidth=e,n.minHeight=t,this.dispatchEvent(n)}}module.exports=DockPanels;