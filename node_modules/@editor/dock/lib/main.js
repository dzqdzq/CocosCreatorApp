'use stirct';

const ipc = require('@base/electron-base-ipc');

const pkg = require('../package.json');
const ipcFlag = `${pkg.name}@${pkg.version}`;

/**
 * 拖拽某 panel 的事件记录
 * 因为需要跨窗口拖拽，所以需要主进程进行数据记录
 * 
 * start 消息的时候将 reply callback 记录下来
 * end 消息的时候得到是否放入 layout 布局内（isDrop），然后执行 start 的回调，记录自己的 reply callback
 * 页面收到 start 回调之后，判断是否关闭 panel，并尝试关闭，然后发送 closed 消息
 * closed 消息的时候获得页面是否被关闭，并执行 end 的回调，告诉页面是否删除被拖拽的 panel
 */

let _startReply = null;
let _endReply = null;

// 一个 panel 正在被拖拽
ipc.on(`${ipcFlag}:panel-drag-start`, (event) => {
    _startReply = event.reply;
    ipc.broadcast(`${ipcFlag}:panel-drag-start`);
});

// 拖拽结束
ipc.on(`${ipcFlag}:panel-drag-end`, (event, isDrop) => {
    if (!_startReply) {
        return event.reply(null, false);
    }
    _startReply(null, isDrop);
    _startReply = null;
    _endReply = event.reply;
    ipc.broadcast(`${ipcFlag}:panel-drag-end`);
});

// 拖拽对象是否被关闭
ipc.on(`${ipcFlag}:panel-drag-closed`, (event, isClosed) => {
    if (!_endReply) {
        return;
    }
    _endReply(null, isClosed);
    _endReply = null;
});