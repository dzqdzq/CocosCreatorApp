"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.quickPackRootURL = exports.FsLocator = exports.isQuickPackURL = void 0;
const asserts_1 = require("../../../utils/asserts");
const chunk_id_1 = require("./chunk-id");
const relateurl_1 = __importDefault(require("relateurl"));
const url_1 = require("url");
function isQuickPackURL(url) {
    return url.protocol === 'quick-pack:';
}
exports.isQuickPackURL = isQuickPackURL;
function isFsQuickPackURL(url) {
    asserts_1.asserts(isQuickPackURL(url));
    return url.pathname.startsWith('/file/');
}
class FsLocator {
    constructor(pathname) {
        this._fsRoot = getFsQuickPackURLRoot(pathname.endsWith('/') ? pathname : `${pathname}/`);
        this._relateUrlEvaluator = new relateurl_1.default(this._fsRoot.href);
    }
    getOrigin() {
        return new url_1.URL('.', this._fsRoot);
    }
    toQuickPackURL(chunkId) {
        return chunk_id_1.isRelocatableChunkId(chunkId)
            ? new url_1.URL(chunkId, this._fsRoot)
            : new url_1.URL(chunkId);
    }
    toChunkId(quickPackURL) {
        asserts_1.asserts(isQuickPackURL(quickPackURL));
        if (!isFsQuickPackURL(quickPackURL)) {
            return quickPackURL.href;
        }
        else {
            const relUrl = this._relateUrlEvaluator.relate(quickPackURL.href);
            return relUrl;
        }
    }
}
exports.FsLocator = FsLocator;
exports.quickPackRootURL = new url_1.URL('quick-pack:/');
function getFsQuickPackURLRoot(pathname) {
    return new url_1.URL(`/file/${pathname.startsWith('/') ? pathname.substr(1) : pathname}`, exports.quickPackRootURL);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstdXJsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svdXRpbHMvY2h1bmstdXJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9EQUFpRDtBQUNqRCx5Q0FBMkQ7QUFDM0QsMERBQWtDO0FBQ2xDLDZCQUEwQjtBQUUxQixTQUFnQixjQUFjLENBQUMsR0FBUTtJQUNuQyxPQUFPLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxDQUFDO0FBQzFDLENBQUM7QUFGRCx3Q0FFQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsR0FBUTtJQUM5QixpQkFBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzdCLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0MsQ0FBQztBQUVELE1BQWEsU0FBUztJQUNsQixZQUFZLFFBQWdCO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcscUJBQXFCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDekYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksbUJBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFTSxTQUFTO1FBQ1osT0FBTyxJQUFJLFNBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFTSxjQUFjLENBQUMsT0FBZTtRQUNqQyxPQUFPLCtCQUFvQixDQUFDLE9BQU8sQ0FBQztZQUNoQyxDQUFDLENBQUMsSUFBSSxTQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDaEMsQ0FBQyxDQUFDLElBQUksU0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTSxTQUFTLENBQUMsWUFBaUI7UUFDOUIsaUJBQU8sQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDakMsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDO1NBQzVCO2FBQU07WUFDSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRSxPQUFPLE1BQU0sQ0FBQztTQUNqQjtJQUNMLENBQUM7Q0FJSjtBQTVCRCw4QkE0QkM7QUFFWSxRQUFBLGdCQUFnQixHQUFrQixJQUFJLFNBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV2RSxTQUFTLHFCQUFxQixDQUFDLFFBQWdCO0lBQzNDLE9BQU8sSUFBSSxTQUFHLENBQUMsU0FBUyxRQUFRLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSx3QkFBZ0IsQ0FBQyxDQUFDO0FBQzFHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXNzZXJ0cyc7XHJcbmltcG9ydCB7IENodW5rSWQsIGlzUmVsb2NhdGFibGVDaHVua0lkIH0gZnJvbSAnLi9jaHVuay1pZCc7XHJcbmltcG9ydCBSZWxhdGVVcmwgZnJvbSAncmVsYXRldXJsJztcclxuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1F1aWNrUGFja1VSTCh1cmw6IFVSTCkge1xyXG4gICAgcmV0dXJuIHVybC5wcm90b2NvbCA9PT0gJ3F1aWNrLXBhY2s6JztcclxufVxyXG5cclxuZnVuY3Rpb24gaXNGc1F1aWNrUGFja1VSTCh1cmw6IFVSTCkge1xyXG4gICAgYXNzZXJ0cyhpc1F1aWNrUGFja1VSTCh1cmwpKTtcclxuICAgIHJldHVybiB1cmwucGF0aG5hbWUuc3RhcnRzV2l0aCgnL2ZpbGUvJyk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBGc0xvY2F0b3Ige1xyXG4gICAgY29uc3RydWN0b3IocGF0aG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX2ZzUm9vdCA9IGdldEZzUXVpY2tQYWNrVVJMUm9vdChwYXRobmFtZS5lbmRzV2l0aCgnLycpID8gcGF0aG5hbWUgOiBgJHtwYXRobmFtZX0vYCk7XHJcbiAgICAgICAgdGhpcy5fcmVsYXRlVXJsRXZhbHVhdG9yID0gbmV3IFJlbGF0ZVVybCh0aGlzLl9mc1Jvb3QuaHJlZik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldE9yaWdpbigpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFVSTCgnLicsIHRoaXMuX2ZzUm9vdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvUXVpY2tQYWNrVVJMKGNodW5rSWQ6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBpc1JlbG9jYXRhYmxlQ2h1bmtJZChjaHVua0lkKVxyXG4gICAgICAgICAgICA/IG5ldyBVUkwoY2h1bmtJZCwgdGhpcy5fZnNSb290KVxyXG4gICAgICAgICAgICA6IG5ldyBVUkwoY2h1bmtJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvQ2h1bmtJZChxdWlja1BhY2tVUkw6IFVSTCk6IENodW5rSWQge1xyXG4gICAgICAgIGFzc2VydHMoaXNRdWlja1BhY2tVUkwocXVpY2tQYWNrVVJMKSk7XHJcbiAgICAgICAgaWYgKCFpc0ZzUXVpY2tQYWNrVVJMKHF1aWNrUGFja1VSTCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHF1aWNrUGFja1VSTC5ocmVmO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlbFVybCA9IHRoaXMuX3JlbGF0ZVVybEV2YWx1YXRvci5yZWxhdGUocXVpY2tQYWNrVVJMLmhyZWYpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVsVXJsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9yZWxhdGVVcmxFdmFsdWF0b3I6IFJlbGF0ZVVybDtcclxuICAgIHByaXZhdGUgX2ZzUm9vdDogUmVhZG9ubHk8VVJMPjtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHF1aWNrUGFja1Jvb3RVUkw6IFJlYWRvbmx5PFVSTD4gPSBuZXcgVVJMKCdxdWljay1wYWNrOi8nKTtcclxuXHJcbmZ1bmN0aW9uIGdldEZzUXVpY2tQYWNrVVJMUm9vdChwYXRobmFtZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbmV3IFVSTChgL2ZpbGUvJHtwYXRobmFtZS5zdGFydHNXaXRoKCcvJykgPyBwYXRobmFtZS5zdWJzdHIoMSkgOiBwYXRobmFtZX1gLCBxdWlja1BhY2tSb290VVJMKTtcclxufVxyXG5cclxuIl19