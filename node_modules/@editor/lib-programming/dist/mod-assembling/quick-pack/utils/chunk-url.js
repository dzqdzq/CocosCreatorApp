"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.quickPackRootURL = exports.FsLocator = exports.isQuickPackURL = void 0;
const asserts_1 = require("../../../utils/asserts");
const chunk_id_1 = require("./chunk-id");
const relateurl_1 = __importDefault(require("relateurl"));
const url_1 = require("url");
function isQuickPackURL(url) {
    return url.protocol === 'quick-pack:';
}
exports.isQuickPackURL = isQuickPackURL;
function isFsQuickPackURL(url) {
    asserts_1.asserts(isQuickPackURL(url));
    return url.pathname.startsWith('/file/');
}
class FsLocator {
    constructor(pathname) {
        this._fsRoot = getFsQuickPackURLRoot(pathname.endsWith('/') ? pathname : `${pathname}/`);
        this._relateUrlEvaluator = new relateurl_1.default(this._fsRoot.href);
    }
    getOrigin() {
        return new url_1.URL('.', this._fsRoot);
    }
    toQuickPackURL(chunkId) {
        return chunk_id_1.isRelocatableChunkId(chunkId)
            ? new url_1.URL(chunkId, this._fsRoot)
            : new url_1.URL(chunkId);
    }
    toChunkId(quickPackURL) {
        asserts_1.asserts(isQuickPackURL(quickPackURL));
        if (!isFsQuickPackURL(quickPackURL)) {
            return quickPackURL.href;
        }
        else {
            const relUrl = this._relateUrlEvaluator.relate(quickPackURL.href);
            return relUrl;
        }
    }
}
exports.FsLocator = FsLocator;
exports.quickPackRootURL = new url_1.URL('quick-pack:/');
function getFsQuickPackURLRoot(pathname) {
    return new url_1.URL(`/file/${pathname.startsWith('/') ? pathname.substr(1) : pathname}`, exports.quickPackRootURL);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstdXJsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svdXRpbHMvY2h1bmstdXJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9EQUFpRDtBQUNqRCx5Q0FBMkQ7QUFDM0QsMERBQWtDO0FBQ2xDLDZCQUEwQjtBQUUxQixTQUFnQixjQUFjLENBQUMsR0FBUTtJQUNuQyxPQUFPLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxDQUFDO0FBQzFDLENBQUM7QUFGRCx3Q0FFQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsR0FBUTtJQUM5QixpQkFBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzdCLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0MsQ0FBQztBQUVELE1BQWEsU0FBUztJQUNsQixZQUFZLFFBQWdCO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcscUJBQXFCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDekYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksbUJBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFTSxTQUFTO1FBQ1osT0FBTyxJQUFJLFNBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFTSxjQUFjLENBQUMsT0FBZTtRQUNqQyxPQUFPLCtCQUFvQixDQUFDLE9BQU8sQ0FBQztZQUNoQyxDQUFDLENBQUMsSUFBSSxTQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDaEMsQ0FBQyxDQUFDLElBQUksU0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTSxTQUFTLENBQUMsWUFBaUI7UUFDOUIsaUJBQU8sQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDakMsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDO1NBQzVCO2FBQU07WUFDSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRSxPQUFPLE1BQU0sQ0FBQztTQUNqQjtJQUNMLENBQUM7Q0FJSjtBQTVCRCw4QkE0QkM7QUFFWSxRQUFBLGdCQUFnQixHQUFrQixJQUFJLFNBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV2RSxTQUFTLHFCQUFxQixDQUFDLFFBQWdCO0lBQzNDLE9BQU8sSUFBSSxTQUFHLENBQUMsU0FBUyxRQUFRLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSx3QkFBZ0IsQ0FBQyxDQUFDO0FBQzFHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXNzZXJ0cyc7XG5pbXBvcnQgeyBDaHVua0lkLCBpc1JlbG9jYXRhYmxlQ2h1bmtJZCB9IGZyb20gJy4vY2h1bmstaWQnO1xuaW1wb3J0IFJlbGF0ZVVybCBmcm9tICdyZWxhdGV1cmwnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcblxuZXhwb3J0IGZ1bmN0aW9uIGlzUXVpY2tQYWNrVVJMKHVybDogVVJMKSB7XG4gICAgcmV0dXJuIHVybC5wcm90b2NvbCA9PT0gJ3F1aWNrLXBhY2s6Jztcbn1cblxuZnVuY3Rpb24gaXNGc1F1aWNrUGFja1VSTCh1cmw6IFVSTCkge1xuICAgIGFzc2VydHMoaXNRdWlja1BhY2tVUkwodXJsKSk7XG4gICAgcmV0dXJuIHVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvZmlsZS8nKTtcbn1cblxuZXhwb3J0IGNsYXNzIEZzTG9jYXRvciB7XG4gICAgY29uc3RydWN0b3IocGF0aG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9mc1Jvb3QgPSBnZXRGc1F1aWNrUGFja1VSTFJvb3QocGF0aG5hbWUuZW5kc1dpdGgoJy8nKSA/IHBhdGhuYW1lIDogYCR7cGF0aG5hbWV9L2ApO1xuICAgICAgICB0aGlzLl9yZWxhdGVVcmxFdmFsdWF0b3IgPSBuZXcgUmVsYXRlVXJsKHRoaXMuX2ZzUm9vdC5ocmVmKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0T3JpZ2luKCkge1xuICAgICAgICByZXR1cm4gbmV3IFVSTCgnLicsIHRoaXMuX2ZzUm9vdCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvUXVpY2tQYWNrVVJMKGNodW5rSWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gaXNSZWxvY2F0YWJsZUNodW5rSWQoY2h1bmtJZClcbiAgICAgICAgICAgID8gbmV3IFVSTChjaHVua0lkLCB0aGlzLl9mc1Jvb3QpXG4gICAgICAgICAgICA6IG5ldyBVUkwoY2h1bmtJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvQ2h1bmtJZChxdWlja1BhY2tVUkw6IFVSTCk6IENodW5rSWQge1xuICAgICAgICBhc3NlcnRzKGlzUXVpY2tQYWNrVVJMKHF1aWNrUGFja1VSTCkpO1xuICAgICAgICBpZiAoIWlzRnNRdWlja1BhY2tVUkwocXVpY2tQYWNrVVJMKSkge1xuICAgICAgICAgICAgcmV0dXJuIHF1aWNrUGFja1VSTC5ocmVmO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcmVsVXJsID0gdGhpcy5fcmVsYXRlVXJsRXZhbHVhdG9yLnJlbGF0ZShxdWlja1BhY2tVUkwuaHJlZik7XG4gICAgICAgICAgICByZXR1cm4gcmVsVXJsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVsYXRlVXJsRXZhbHVhdG9yOiBSZWxhdGVVcmw7XG4gICAgcHJpdmF0ZSBfZnNSb290OiBSZWFkb25seTxVUkw+O1xufVxuXG5leHBvcnQgY29uc3QgcXVpY2tQYWNrUm9vdFVSTDogUmVhZG9ubHk8VVJMPiA9IG5ldyBVUkwoJ3F1aWNrLXBhY2s6LycpO1xuXG5mdW5jdGlvbiBnZXRGc1F1aWNrUGFja1VSTFJvb3QocGF0aG5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgVVJMKGAvZmlsZS8ke3BhdGhuYW1lLnN0YXJ0c1dpdGgoJy8nKSA/IHBhdGhuYW1lLnN1YnN0cigxKSA6IHBhdGhuYW1lfWAsIHF1aWNrUGFja1Jvb3RVUkwpO1xufVxuXG4iXX0=