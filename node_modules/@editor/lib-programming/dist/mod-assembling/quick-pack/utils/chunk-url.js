"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.quickPackRootURL = exports.FsLocator = exports.isQuickPackURL = void 0;
const asserts_1 = require("../../../utils/asserts");
const chunk_id_1 = require("./chunk-id");
const relateurl_1 = __importDefault(require("relateurl"));
function isQuickPackURL(url) {
    return url.protocol === 'quick-pack:';
}
exports.isQuickPackURL = isQuickPackURL;
function isFsQuickPackURL(url) {
    asserts_1.asserts(isQuickPackURL(url));
    return url.pathname.startsWith('/file/');
}
class FsLocator {
    constructor(pathname) {
        this._fsRoot = getFsQuickPackURLRoot(pathname.endsWith('/') ? pathname : `${pathname}/`);
        this._relateUrlEvaluator = new relateurl_1.default(this._fsRoot.href);
    }
    getOrigin() {
        return new URL('.', this._fsRoot);
    }
    toQuickPackURL(chunkId) {
        return chunk_id_1.isRelocatableChunkId(chunkId)
            ? new URL(chunkId, this._fsRoot)
            : new URL(chunkId);
    }
    toChunkId(quickPackURL) {
        asserts_1.asserts(isQuickPackURL(quickPackURL));
        if (!isFsQuickPackURL(quickPackURL)) {
            return quickPackURL.href;
        }
        else {
            const relUrl = this._relateUrlEvaluator.relate(quickPackURL.href);
            return relUrl;
        }
    }
}
exports.FsLocator = FsLocator;
exports.quickPackRootURL = new URL('quick-pack:/');
function getFsQuickPackURLRoot(pathname) {
    return new URL(`/file/${pathname.startsWith('/') ? pathname.substr(1) : pathname}`, exports.quickPackRootURL);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstdXJsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svdXRpbHMvY2h1bmstdXJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9EQUFpRDtBQUNqRCx5Q0FBMkQ7QUFDM0QsMERBQWtDO0FBRWxDLFNBQWdCLGNBQWMsQ0FBQyxHQUFRO0lBQ25DLE9BQU8sR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLENBQUM7QUFDMUMsQ0FBQztBQUZELHdDQUVDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxHQUFRO0lBQzlCLGlCQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDN0IsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBRUQsTUFBYSxTQUFTO0lBQ2xCLFlBQVksUUFBZ0I7UUFDeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxHQUFHLENBQUMsQ0FBQztRQUN6RixJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVNLFNBQVM7UUFDWixPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVNLGNBQWMsQ0FBQyxPQUFlO1FBQ2pDLE9BQU8sK0JBQW9CLENBQUMsT0FBTyxDQUFDO1lBQ2hDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNoQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVNLFNBQVMsQ0FBQyxZQUFpQjtRQUM5QixpQkFBTyxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUNqQyxPQUFPLFlBQVksQ0FBQyxJQUFJLENBQUM7U0FDNUI7YUFBTTtZQUNILE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xFLE9BQU8sTUFBTSxDQUFDO1NBQ2pCO0lBQ0wsQ0FBQztDQUlKO0FBNUJELDhCQTRCQztBQUVZLFFBQUEsZ0JBQWdCLEdBQWtCLElBQUksR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRXZFLFNBQVMscUJBQXFCLENBQUMsUUFBZ0I7SUFDM0MsT0FBTyxJQUFJLEdBQUcsQ0FBQyxTQUFTLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLHdCQUFnQixDQUFDLENBQUM7QUFDMUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9hc3NlcnRzJztcbmltcG9ydCB7IENodW5rSWQsIGlzUmVsb2NhdGFibGVDaHVua0lkIH0gZnJvbSAnLi9jaHVuay1pZCc7XG5pbXBvcnQgUmVsYXRlVXJsIGZyb20gJ3JlbGF0ZXVybCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1F1aWNrUGFja1VSTCh1cmw6IFVSTCkge1xuICAgIHJldHVybiB1cmwucHJvdG9jb2wgPT09ICdxdWljay1wYWNrOic7XG59XG5cbmZ1bmN0aW9uIGlzRnNRdWlja1BhY2tVUkwodXJsOiBVUkwpIHtcbiAgICBhc3NlcnRzKGlzUXVpY2tQYWNrVVJMKHVybCkpO1xuICAgIHJldHVybiB1cmwucGF0aG5hbWUuc3RhcnRzV2l0aCgnL2ZpbGUvJyk7XG59XG5cbmV4cG9ydCBjbGFzcyBGc0xvY2F0b3Ige1xuICAgIGNvbnN0cnVjdG9yKHBhdGhuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fZnNSb290ID0gZ2V0RnNRdWlja1BhY2tVUkxSb290KHBhdGhuYW1lLmVuZHNXaXRoKCcvJykgPyBwYXRobmFtZSA6IGAke3BhdGhuYW1lfS9gKTtcbiAgICAgICAgdGhpcy5fcmVsYXRlVXJsRXZhbHVhdG9yID0gbmV3IFJlbGF0ZVVybCh0aGlzLl9mc1Jvb3QuaHJlZik7XG4gICAgfVxuXG4gICAgcHVibGljIGdldE9yaWdpbigpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwoJy4nLCB0aGlzLl9mc1Jvb3QpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b1F1aWNrUGFja1VSTChjaHVua0lkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGlzUmVsb2NhdGFibGVDaHVua0lkKGNodW5rSWQpXG4gICAgICAgICAgICA/IG5ldyBVUkwoY2h1bmtJZCwgdGhpcy5fZnNSb290KVxuICAgICAgICAgICAgOiBuZXcgVVJMKGNodW5rSWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b0NodW5rSWQocXVpY2tQYWNrVVJMOiBVUkwpOiBDaHVua0lkIHtcbiAgICAgICAgYXNzZXJ0cyhpc1F1aWNrUGFja1VSTChxdWlja1BhY2tVUkwpKTtcbiAgICAgICAgaWYgKCFpc0ZzUXVpY2tQYWNrVVJMKHF1aWNrUGFja1VSTCkpIHtcbiAgICAgICAgICAgIHJldHVybiBxdWlja1BhY2tVUkwuaHJlZjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbFVybCA9IHRoaXMuX3JlbGF0ZVVybEV2YWx1YXRvci5yZWxhdGUocXVpY2tQYWNrVVJMLmhyZWYpO1xuICAgICAgICAgICAgcmV0dXJuIHJlbFVybDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlbGF0ZVVybEV2YWx1YXRvcjogUmVsYXRlVXJsO1xuICAgIHByaXZhdGUgX2ZzUm9vdDogUmVhZG9ubHk8VVJMPjtcbn1cblxuZXhwb3J0IGNvbnN0IHF1aWNrUGFja1Jvb3RVUkw6IFJlYWRvbmx5PFVSTD4gPSBuZXcgVVJMKCdxdWljay1wYWNrOi8nKTtcblxuZnVuY3Rpb24gZ2V0RnNRdWlja1BhY2tVUkxSb290KHBhdGhuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFVSTChgL2ZpbGUvJHtwYXRobmFtZS5zdGFydHNXaXRoKCcvJykgPyBwYXRobmFtZS5zdWJzdHIoMSkgOiBwYXRobmFtZX1gLCBxdWlja1BhY2tSb290VVJMKTtcbn1cblxuIl19