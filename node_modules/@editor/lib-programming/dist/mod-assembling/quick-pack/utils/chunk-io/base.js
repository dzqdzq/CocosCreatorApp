"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChunkIOBase = void 0;
const url_1 = require("url");
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
class ChunkIOBase {
    constructor({ chunkRecordFile, sourceCacheDir, }) {
        this._chunks = {};
        this._chunkRecordFile = chunkRecordFile;
        this._sourceCacheDirUrl = url_1.pathToFileURL(sourceCacheDir + path_1.default.sep);
    }
    _getChunkSourceFile(physicalLocation) {
        return url_1.fileURLToPath(new url_1.URL(`${physicalLocation}`, this._sourceCacheDirUrl));
    }
    async clear() {
        const chunkRecordFile = this._chunkRecordFile;
        try {
            await fs_extra_1.default.unlink(chunkRecordFile);
            await fs_extra_1.default.remove(url_1.fileURLToPath(this._sourceCacheDirUrl));
        }
        catch (err) {
        }
    }
    async _loadChunkRecord() {
        try {
            this._chunks = await fs_extra_1.default.readJson(this._chunkRecordFile, { encoding: 'utf8' });
            return true;
        }
        catch (_a) {
            return false;
        }
    }
    async _writeChunkRecord() {
        await fs_extra_1.default.outputJson(this._chunkRecordFile, this._chunks, { encoding: 'utf8', spaces: 2 });
    }
}
exports.ChunkIOBase = ChunkIOBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL3V0aWxzL2NodW5rLWlvL2Jhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNkJBQXdEO0FBQ3hELGdEQUFzQjtBQUN0Qix3REFBMEI7QUFJMUIsTUFBYSxXQUFXO0lBQ3BCLFlBQVksRUFDUixlQUFlLEVBQ2YsY0FBYyxHQUlqQjtRQWlDUyxZQUFPLEdBQTJCLEVBQUUsQ0FBQztRQWhDM0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztRQUN4QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsbUJBQWEsQ0FBQyxjQUFjLEdBQUcsY0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFUyxtQkFBbUIsQ0FBQyxnQkFBa0M7UUFDNUQsT0FBTyxtQkFBYSxDQUFDLElBQUksU0FBRyxDQUFDLEdBQUcsZ0JBQWdCLEVBQUUsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFUyxLQUFLLENBQUMsS0FBSztRQUNqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDOUMsSUFBSTtZQUNBLE1BQU0sa0JBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDakMsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxtQkFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7U0FDM0Q7UUFBQyxPQUFPLEdBQUcsRUFBRTtTQUNiO0lBQ0wsQ0FBQztJQUVTLEtBQUssQ0FBQyxnQkFBZ0I7UUFDNUIsSUFBSTtZQUNBLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxrQkFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM5RSxPQUFPLElBQUksQ0FBQztTQUNmO1FBQUMsV0FBTTtZQUNKLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO0lBQ0wsQ0FBQztJQUVTLEtBQUssQ0FBQyxpQkFBaUI7UUFDN0IsTUFBTSxrQkFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDOUYsQ0FBQztDQUtKO0FBekNELGtDQXlDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbGVVUkxUb1BhdGgsIHBhdGhUb0ZpbGVVUkwsIFVSTCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgQ2h1bmssIFBoeXNpY2FsTG9jYXRpb24gfSBmcm9tICcuLi9jaHVuayc7XHJcbmltcG9ydCB7IENodW5rSWQgfSBmcm9tICcuLi9jaHVuay1pZCc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2h1bmtJT0Jhc2Uge1xyXG4gICAgY29uc3RydWN0b3Ioe1xyXG4gICAgICAgIGNodW5rUmVjb3JkRmlsZSxcclxuICAgICAgICBzb3VyY2VDYWNoZURpcixcclxuICAgIH06IHtcclxuICAgICAgICBjaHVua1JlY29yZEZpbGU6IHN0cmluZztcclxuICAgICAgICBzb3VyY2VDYWNoZURpcjogc3RyaW5nO1xyXG4gICAgfSkge1xyXG4gICAgICAgIHRoaXMuX2NodW5rUmVjb3JkRmlsZSA9IGNodW5rUmVjb3JkRmlsZTtcclxuICAgICAgICB0aGlzLl9zb3VyY2VDYWNoZURpclVybCA9IHBhdGhUb0ZpbGVVUkwoc291cmNlQ2FjaGVEaXIgKyBwcy5zZXApO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBfZ2V0Q2h1bmtTb3VyY2VGaWxlKHBoeXNpY2FsTG9jYXRpb246IFBoeXNpY2FsTG9jYXRpb24pIHtcclxuICAgICAgICByZXR1cm4gZmlsZVVSTFRvUGF0aChuZXcgVVJMKGAke3BoeXNpY2FsTG9jYXRpb259YCwgdGhpcy5fc291cmNlQ2FjaGVEaXJVcmwpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgY2xlYXIoKSB7XHJcbiAgICAgICAgY29uc3QgY2h1bmtSZWNvcmRGaWxlID0gdGhpcy5fY2h1bmtSZWNvcmRGaWxlO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGZzLnVubGluayhjaHVua1JlY29yZEZpbGUpO1xyXG4gICAgICAgICAgICBhd2FpdCBmcy5yZW1vdmUoZmlsZVVSTFRvUGF0aCh0aGlzLl9zb3VyY2VDYWNoZURpclVybCkpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgX2xvYWRDaHVua1JlY29yZCgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLl9jaHVua3MgPSBhd2FpdCBmcy5yZWFkSnNvbih0aGlzLl9jaHVua1JlY29yZEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGFzeW5jIF93cml0ZUNodW5rUmVjb3JkKCkge1xyXG4gICAgICAgIGF3YWl0IGZzLm91dHB1dEpzb24odGhpcy5fY2h1bmtSZWNvcmRGaWxlLCB0aGlzLl9jaHVua3MsIHsgZW5jb2Rpbmc6ICd1dGY4Jywgc3BhY2VzOiAyIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NodW5rUmVjb3JkRmlsZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfc291cmNlQ2FjaGVEaXJVcmw6IFVSTDtcclxuICAgIHByb3RlY3RlZCBfY2h1bmtzOiBSZWNvcmQ8Q2h1bmtJZCwgQ2h1bms+ID0ge307XHJcbn1cclxuIl19