"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChunkIOBase = void 0;
const url_1 = require("url");
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
class ChunkIOBase {
    constructor({ chunkRecordFile, sourceCacheDir, }) {
        this._chunks = {};
        this._chunkRecordFile = chunkRecordFile;
        this._sourceCacheDirUrl = url_1.pathToFileURL(sourceCacheDir + path_1.default.sep);
    }
    _getChunkSourceFile(physicalLocation) {
        return url_1.fileURLToPath(new url_1.URL(`${physicalLocation}`, this._sourceCacheDirUrl));
    }
    async clear() {
        const chunkRecordFile = this._chunkRecordFile;
        try {
            await fs_extra_1.default.unlink(chunkRecordFile);
            await fs_extra_1.default.remove(url_1.fileURLToPath(this._sourceCacheDirUrl));
        }
        catch (err) {
        }
    }
    async _loadChunkRecord() {
        try {
            this._chunks = await fs_extra_1.default.readJson(this._chunkRecordFile, { encoding: 'utf8' });
            return true;
        }
        catch (_a) {
            return false;
        }
    }
    async _writeChunkRecord() {
        await fs_extra_1.default.outputJson(this._chunkRecordFile, this._chunks, { encoding: 'utf8', spaces: 2 });
    }
}
exports.ChunkIOBase = ChunkIOBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL3V0aWxzL2NodW5rLWlvL2Jhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNkJBQXdEO0FBQ3hELGdEQUFzQjtBQUN0Qix3REFBMEI7QUFJMUIsTUFBYSxXQUFXO0lBQ3BCLFlBQVksRUFDUixlQUFlLEVBQ2YsY0FBYyxHQUlqQjtRQWlDUyxZQUFPLEdBQTJCLEVBQUUsQ0FBQztRQWhDM0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztRQUN4QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsbUJBQWEsQ0FBQyxjQUFjLEdBQUcsY0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFUyxtQkFBbUIsQ0FBQyxnQkFBa0M7UUFDNUQsT0FBTyxtQkFBYSxDQUFDLElBQUksU0FBRyxDQUFDLEdBQUcsZ0JBQWdCLEVBQUUsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFUyxLQUFLLENBQUMsS0FBSztRQUNqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDOUMsSUFBSTtZQUNBLE1BQU0sa0JBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDakMsTUFBTSxrQkFBRSxDQUFDLE1BQU0sQ0FBQyxtQkFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7U0FDM0Q7UUFBQyxPQUFPLEdBQUcsRUFBRTtTQUNiO0lBQ0wsQ0FBQztJQUVTLEtBQUssQ0FBQyxnQkFBZ0I7UUFDNUIsSUFBSTtZQUNBLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxrQkFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM5RSxPQUFPLElBQUksQ0FBQztTQUNmO1FBQUMsV0FBTTtZQUNKLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO0lBQ0wsQ0FBQztJQUVTLEtBQUssQ0FBQyxpQkFBaUI7UUFDN0IsTUFBTSxrQkFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDOUYsQ0FBQztDQUtKO0FBekNELGtDQXlDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbGVVUkxUb1BhdGgsIHBhdGhUb0ZpbGVVUkwsIFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgcHMgZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgQ2h1bmssIFBoeXNpY2FsTG9jYXRpb24gfSBmcm9tICcuLi9jaHVuayc7XG5pbXBvcnQgeyBDaHVua0lkIH0gZnJvbSAnLi4vY2h1bmstaWQnO1xuXG5leHBvcnQgY2xhc3MgQ2h1bmtJT0Jhc2Uge1xuICAgIGNvbnN0cnVjdG9yKHtcbiAgICAgICAgY2h1bmtSZWNvcmRGaWxlLFxuICAgICAgICBzb3VyY2VDYWNoZURpcixcbiAgICB9OiB7XG4gICAgICAgIGNodW5rUmVjb3JkRmlsZTogc3RyaW5nO1xuICAgICAgICBzb3VyY2VDYWNoZURpcjogc3RyaW5nO1xuICAgIH0pIHtcbiAgICAgICAgdGhpcy5fY2h1bmtSZWNvcmRGaWxlID0gY2h1bmtSZWNvcmRGaWxlO1xuICAgICAgICB0aGlzLl9zb3VyY2VDYWNoZURpclVybCA9IHBhdGhUb0ZpbGVVUkwoc291cmNlQ2FjaGVEaXIgKyBwcy5zZXApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfZ2V0Q2h1bmtTb3VyY2VGaWxlKHBoeXNpY2FsTG9jYXRpb246IFBoeXNpY2FsTG9jYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGZpbGVVUkxUb1BhdGgobmV3IFVSTChgJHtwaHlzaWNhbExvY2F0aW9ufWAsIHRoaXMuX3NvdXJjZUNhY2hlRGlyVXJsKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIGNsZWFyKCkge1xuICAgICAgICBjb25zdCBjaHVua1JlY29yZEZpbGUgPSB0aGlzLl9jaHVua1JlY29yZEZpbGU7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBmcy51bmxpbmsoY2h1bmtSZWNvcmRGaWxlKTtcbiAgICAgICAgICAgIGF3YWl0IGZzLnJlbW92ZShmaWxlVVJMVG9QYXRoKHRoaXMuX3NvdXJjZUNhY2hlRGlyVXJsKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFzeW5jIF9sb2FkQ2h1bmtSZWNvcmQoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLl9jaHVua3MgPSBhd2FpdCBmcy5yZWFkSnNvbih0aGlzLl9jaHVua1JlY29yZEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBfd3JpdGVDaHVua1JlY29yZCgpIHtcbiAgICAgICAgYXdhaXQgZnMub3V0cHV0SnNvbih0aGlzLl9jaHVua1JlY29yZEZpbGUsIHRoaXMuX2NodW5rcywgeyBlbmNvZGluZzogJ3V0ZjgnLCBzcGFjZXM6IDIgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2h1bmtSZWNvcmRGaWxlOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfc291cmNlQ2FjaGVEaXJVcmw6IFVSTDtcbiAgICBwcm90ZWN0ZWQgX2NodW5rczogUmVjb3JkPENodW5rSWQsIENodW5rPiA9IHt9O1xufVxuIl19