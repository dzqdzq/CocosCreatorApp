"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChunkWriter = void 0;
const base_1 = require("./base");
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const chunk_id_1 = require("../chunk-id");
const asserts_1 = require("../../../../utils/asserts");
const url_1 = require("url");
const relateurl_1 = __importDefault(require("relateurl"));
class ChunkWriter extends base_1.ChunkIOBase {
    constructor({ origin, chunkRecordFile, sourceCacheDir, importMapFile, logger, }) {
        super({ chunkRecordFile, sourceCacheDir });
        this._origin = origin;
        this._logger = logger;
        this._importMapFile = importMapFile;
    }
    async loadCache() {
        await this._loadChunkRecord();
    }
    async clear() {
        const importMapFile = this._importMapFile;
        try {
            await fs_extra_1.default.unlink(importMapFile);
        }
        catch (err) {
            this._logger.debug(`Failed to delete module record file ${importMapFile}: ${err}`);
        }
        await super.clear();
    }
    getChunkId(url) {
        return chunk_id_1.calculateChunkId(url, this._origin);
    }
    async getChunk(id) {
        return this._chunks[id];
    }
    async addChunk(id, code, map) {
        const physicalLocation = chunk_id_1.calculatePhysicalLocation(id);
        const mTimestamp = Date.now();
        this._chunks[id] = {
            imports: {},
            physicalLocation,
            mTimestamp,
        };
        const sourceCacheFile = this._getChunkSourceFile(physicalLocation);
        // const metadataCacheFile = this._getMetadataCacheFile(qpLocation);
        let sourceMappingURL;
        let serializedMap;
        if (map) {
            serializedMap = typeof map === 'string'
                ? map
                : JSON.stringify(map);
            sourceMappingURL = `${path_1.default.basename(sourceCacheFile)}.map`;
        }
        const codeWithMap = sourceMappingURL
            ? `${code}\n//# sourceMappingURL=${sourceMappingURL}`
            : code;
        await Promise.all([
            // Write metadata
            // fs.outputFile(metadataCacheFile, JSON.stringify(metadata, undefined, 2), { encoding: 'utf8' }),
            // Write code
            fs_extra_1.default.outputFile(sourceCacheFile, codeWithMap, { encoding: 'utf8' }),
            // Write map
            serializedMap
                ? fs_extra_1.default.outputFile(`${sourceCacheFile}.map`, serializedMap, { encoding: 'utf8' })
                : undefined,
        ]);
    }
    async removeChunk(id) {
        delete this._chunks[id];
    }
    async syncChunk(chunkAlias) {
        await this._writeChunkRecord();
        await this._writeImportMap(this._importMapFile, chunkAlias);
    }
    async _writeImportMap(outFile, chunkAlias) {
        const importMapURL = url_1.pathToFileURL(outFile);
        const importMapRelate = new relateurl_1.default(importMapURL.href);
        const getChunkRelativePathFromImportMap = (chunkId) => {
            asserts_1.asserts(chunkId in this._chunks, 'Missed chunks');
            const chunkSourceFile = this._getChunkSourceFile(this._chunks[chunkId].physicalLocation);
            const relativePath = importMapRelate.relate(url_1.pathToFileURL(chunkSourceFile).href);
            return `./${relativePath}`;
        };
        const importMap = {};
        importMap.imports = {};
        const imports = importMap.imports;
        for (const [alias, chunkId] of Object.entries(chunkAlias)) {
            imports[alias] = getChunkRelativePathFromImportMap(chunkId);
        }
        importMap.scopes = {};
        const scopes = importMap.scopes;
        for (const [chunkId, chunk] of Object.entries(this._chunks)) {
            const importsEntries = Object.entries(chunk.imports);
            if (importsEntries.length === 0) {
                continue;
            }
            const chunkPath = getChunkRelativePathFromImportMap(chunkId);
            const specifierMap = scopes[chunkPath] = {};
            for (const [specifier, resolvedChunkId] of importsEntries) {
                if (typeof resolvedChunkId === 'string') {
                    specifierMap[specifier] = getChunkRelativePathFromImportMap(resolvedChunkId);
                }
                else {
                    specifierMap[specifier] = resolvedChunkId.url;
                }
            }
        }
        await fs_extra_1.default.outputJson(outFile, importMap, { spaces: 2, });
    }
}
exports.ChunkWriter = ChunkWriter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JpdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svdXRpbHMvY2h1bmstaW8vd3JpdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLGlDQUFxQztBQUNyQyxnREFBc0I7QUFDdEIsd0RBQTBCO0FBQzFCLDBDQUFtRjtBQUVuRix1REFBb0Q7QUFDcEQsNkJBQW9DO0FBQ3BDLDBEQUFrQztBQUdsQyxNQUFhLFdBQVksU0FBUSxrQkFBVztJQUN4QyxZQUFZLEVBQ1IsTUFBTSxFQUNOLGVBQWUsRUFDZixjQUFjLEVBQ2QsYUFBYSxFQUNiLE1BQU0sR0FPVDtRQUNHLEtBQUssQ0FBQyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDO0lBQ3hDLENBQUM7SUFFTSxLQUFLLENBQUMsU0FBUztRQUNsQixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxLQUFLLENBQUMsS0FBSztRQUNkLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7UUFDMUMsSUFBSTtZQUNBLE1BQU0sa0JBQUUsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDbEM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxhQUFhLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQztTQUN0RjtRQUNELE1BQU0sS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFTSxVQUFVLENBQUMsR0FBUTtRQUN0QixPQUFPLDJCQUFnQixDQUFDLEdBQUcsRUFB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QUFVLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVELENBQUM7Q0FDSjtBQTNIRCxrQ0EySEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTb3VyY2VNYXAgfSBmcm9tICcuLi8uLi8uLi9tb2QtbG8vbW9kLWxvJztcbmltcG9ydCB7IENodW5rSU9CYXNlIH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBDaHVua0lkLCBjYWxjdWxhdGVDaHVua0lkLCBjYWxjdWxhdGVQaHlzaWNhbExvY2F0aW9uIH0gZnJvbSAnLi4vY2h1bmstaWQnO1xuaW1wb3J0IHsgSW1wb3J0TWFwIH0gZnJvbSAnLi4vLi4vbG9hZGVyJztcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy9hc3NlcnRzJztcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IFJlbGF0ZVVybCBmcm9tICdyZWxhdGV1cmwnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIENodW5rV3JpdGVyIGV4dGVuZHMgQ2h1bmtJT0Jhc2Uge1xuICAgIGNvbnN0cnVjdG9yKHtcbiAgICAgICAgb3JpZ2luLFxuICAgICAgICBjaHVua1JlY29yZEZpbGUsXG4gICAgICAgIHNvdXJjZUNhY2hlRGlyLFxuICAgICAgICBpbXBvcnRNYXBGaWxlLFxuICAgICAgICBsb2dnZXIsXG4gICAgfToge1xuICAgICAgICBvcmlnaW46IHN0cmluZztcbiAgICAgICAgY2h1bmtSZWNvcmRGaWxlOiBzdHJpbmc7XG4gICAgICAgIHNvdXJjZUNhY2hlRGlyOiBzdHJpbmc7XG4gICAgICAgIGltcG9ydE1hcEZpbGU6IHN0cmluZztcbiAgICAgICAgbG9nZ2VyOiBMb2dnZXIsXG4gICAgfSkge1xuICAgICAgICBzdXBlcih7IGNodW5rUmVjb3JkRmlsZSwgc291cmNlQ2FjaGVEaXIgfSk7XG4gICAgICAgIHRoaXMuX29yaWdpbiA9IG9yaWdpbjtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICB0aGlzLl9pbXBvcnRNYXBGaWxlID0gaW1wb3J0TWFwRmlsZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgbG9hZENhY2hlKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9sb2FkQ2h1bmtSZWNvcmQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgY2xlYXIoKSB7XG4gICAgICAgIGNvbnN0IGltcG9ydE1hcEZpbGUgPSB0aGlzLl9pbXBvcnRNYXBGaWxlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgZnMudW5saW5rKGltcG9ydE1hcEZpbGUpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgRmFpbGVkIHRvIGRlbGV0ZSBtb2R1bGUgcmVjb3JkIGZpbGUgJHtpbXBvcnRNYXBGaWxlfTogJHtlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgc3VwZXIuY2xlYXIoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q2h1bmtJZCh1cmw6IFVSTCkge1xuICAgICAgICByZXR1cm4gY2FsY3VsYXRlQ2h1bmtJZCh1cmwsIHRoaXMuX29yaWdpbik7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGdldENodW5rKGlkOiBDaHVua0lkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jaHVua3NbaWRdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhZGRDaHVuayhpZDogQ2h1bmtJZCwgY29kZTogc3RyaW5nLCBtYXA/OiBTb3VyY2VNYXApIHtcbiAgICAgICAgY29uc3QgcGh5c2ljYWxMb2NhdGlvbiA9IGNhbGN1bGF0ZVBoeXNpY2FsTG9jYXRpb24oaWQpO1xuICAgICAgICBjb25zdCBtVGltZXN0YW1wID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5fY2h1bmtzW2lkXSA9IHtcbiAgICAgICAgICAgIGltcG9ydHM6IHt9LFxuICAgICAgICAgICAgcGh5c2ljYWxMb2NhdGlvbixcbiAgICAgICAgICAgIG1UaW1lc3RhbXAsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgc291cmNlQ2FjaGVGaWxlID0gdGhpcy5fZ2V0Q2h1bmtTb3VyY2VGaWxlKHBoeXNpY2FsTG9jYXRpb24pO1xuICAgICAgICAvLyBjb25zdCBtZXRhZGF0YUNhY2hlRmlsZSA9IHRoaXMuX2dldE1ldGFkYXRhQ2FjaGVGaWxlKHFwTG9jYXRpb24pO1xuICAgICAgICBsZXQgc291cmNlTWFwcGluZ1VSTDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICBsZXQgc2VyaWFsaXplZE1hcDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICBpZiAobWFwKSB7XG4gICAgICAgICAgICBzZXJpYWxpemVkTWFwID0gdHlwZW9mIG1hcCA9PT0gJ3N0cmluZydcbiAgICAgICAgICAgICAgICA/IG1hcFxuICAgICAgICAgICAgICAgIDogSlNPTi5zdHJpbmdpZnkobWFwKTtcbiAgICAgICAgICAgIHNvdXJjZU1hcHBpbmdVUkwgPSBgJHtwcy5iYXNlbmFtZShzb3VyY2VDYWNoZUZpbGUpfS5tYXBgO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvZGVXaXRoTWFwID0gc291cmNlTWFwcGluZ1VSTFxuICAgICAgICAgICAgPyBgJHtjb2RlfVxcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPSR7c291cmNlTWFwcGluZ1VSTH1gXG4gICAgICAgICAgICA6IGNvZGU7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIC8vIFdyaXRlIG1ldGFkYXRhXG4gICAgICAgICAgICAvLyBmcy5vdXRwdXRGaWxlKG1ldGFkYXRhQ2FjaGVGaWxlLCBKU09OLnN0cmluZ2lmeShtZXRhZGF0YSwgdW5kZWZpbmVkLCAyKSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pLFxuICAgICAgICAgICAgLy8gV3JpdGUgY29kZVxuICAgICAgICAgICAgZnMub3V0cHV0RmlsZShzb3VyY2VDYWNoZUZpbGUsIGNvZGVXaXRoTWFwLCB7IGVuY29kaW5nOiAndXRmOCcgfSksXG4gICAgICAgICAgICAvLyBXcml0ZSBtYXBcbiAgICAgICAgICAgIHNlcmlhbGl6ZWRNYXBcbiAgICAgICAgICAgICAgICA/IGZzLm91dHB1dEZpbGUoYCR7c291cmNlQ2FjaGVGaWxlfS5tYXBgLCBzZXJpYWxpemVkTWFwLCB7IGVuY29kaW5nOiAndXRmOCcgfSlcbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgXSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZUNodW5rKGlkOiBDaHVua0lkKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9jaHVua3NbaWRdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzeW5jQ2h1bmsoY2h1bmtBbGlhczogUmVjb3JkPENodW5rSWQsIHN0cmluZz4pIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fd3JpdGVDaHVua1JlY29yZCgpO1xuICAgICAgICBhd2FpdCB0aGlzLl93cml0ZUltcG9ydE1hcCh0aGlzLl9pbXBvcnRNYXBGaWxlLCBjaHVua0FsaWFzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vcmlnaW46IHN0cmluZztcbiAgICBwcml2YXRlIF9sb2dnZXI6IExvZ2dlcjtcbiAgICBwcml2YXRlIF9pbXBvcnRNYXBGaWxlOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIGFzeW5jIF93cml0ZUltcG9ydE1hcChvdXRGaWxlOiBzdHJpbmcsIGNodW5rQWxpYXM6IFJlY29yZDxzdHJpbmcsIENodW5rSWQ+KSB7XG4gICAgICAgIGNvbnN0IGltcG9ydE1hcFVSTCA9IHBhdGhUb0ZpbGVVUkwob3V0RmlsZSk7XG4gICAgICAgIGNvbnN0IGltcG9ydE1hcFJlbGF0ZSA9IG5ldyBSZWxhdGVVcmwoaW1wb3J0TWFwVVJMLmhyZWYpO1xuICAgICAgICBjb25zdCBnZXRDaHVua1JlbGF0aXZlUGF0aEZyb21JbXBvcnRNYXAgPSAoY2h1bmtJZDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgIGFzc2VydHMoY2h1bmtJZCBpbiB0aGlzLl9jaHVua3MsICdNaXNzZWQgY2h1bmtzJyk7XG4gICAgICAgICAgICBjb25zdCBjaHVua1NvdXJjZUZpbGUgPSB0aGlzLl9nZXRDaHVua1NvdXJjZUZpbGUodGhpcy5fY2h1bmtzW2NodW5rSWRdLnBoeXNpY2FsTG9jYXRpb24pO1xuICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gaW1wb3J0TWFwUmVsYXRlLnJlbGF0ZShwYXRoVG9GaWxlVVJMKGNodW5rU291cmNlRmlsZSkuaHJlZik7XG4gICAgICAgICAgICByZXR1cm4gYC4vJHtyZWxhdGl2ZVBhdGh9YDtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgaW1wb3J0TWFwOiBJbXBvcnRNYXAgPSB7fTtcbiAgICAgICAgaW1wb3J0TWFwLmltcG9ydHMgPSB7fTtcbiAgICAgICAgY29uc3QgaW1wb3J0cyA9IGltcG9ydE1hcC5pbXBvcnRzO1xuICAgICAgICBmb3IgKGNvbnN0IFthbGlhcywgY2h1bmtJZF0gb2YgT2JqZWN0LmVudHJpZXMoY2h1bmtBbGlhcykpIHtcbiAgICAgICAgICAgIGltcG9ydHNbYWxpYXNdID0gZ2V0Q2h1bmtSZWxhdGl2ZVBhdGhGcm9tSW1wb3J0TWFwKGNodW5rSWQpO1xuICAgICAgICB9XG4gICAgICAgIGltcG9ydE1hcC5zY29wZXMgPSB7fTtcbiAgICAgICAgY29uc3Qgc2NvcGVzID0gaW1wb3J0TWFwLnNjb3BlcztcbiAgICAgICAgZm9yIChjb25zdCBbY2h1bmtJZCwgY2h1bmtdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX2NodW5rcykpIHtcbiAgICAgICAgICAgIGNvbnN0IGltcG9ydHNFbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoY2h1bmsuaW1wb3J0cyk7XG4gICAgICAgICAgICBpZiAoaW1wb3J0c0VudHJpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBjaHVua1BhdGggPSBnZXRDaHVua1JlbGF0aXZlUGF0aEZyb21JbXBvcnRNYXAoY2h1bmtJZCk7XG4gICAgICAgICAgICBjb25zdCBzcGVjaWZpZXJNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSBzY29wZXNbY2h1bmtQYXRoXSA9IHt9O1xuICAgICAgICAgICAgZm9yIChjb25zdCBbc3BlY2lmaWVyLCByZXNvbHZlZENodW5rSWRdIG9mIGltcG9ydHNFbnRyaWVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXNvbHZlZENodW5rSWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwZWNpZmllck1hcFtzcGVjaWZpZXJdID0gZ2V0Q2h1bmtSZWxhdGl2ZVBhdGhGcm9tSW1wb3J0TWFwKHJlc29sdmVkQ2h1bmtJZCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWVyTWFwW3NwZWNpZmllcl0gPSByZXNvbHZlZENodW5rSWQudXJsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBmcy5vdXRwdXRKc29uKG91dEZpbGUsIGltcG9ydE1hcCwgeyBzcGFjZXM6IDIsIH0pO1xuICAgIH1cbn1cbiJdfQ==