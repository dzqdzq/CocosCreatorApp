"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChunkWriter = void 0;
const base_1 = require("./base");
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const chunk_id_1 = require("../chunk-id");
class ChunkWriter extends base_1.ChunkIOBase {
    constructor({ origin, chunkRecordFile, sourceCacheDir, }) {
        super({ chunkRecordFile, sourceCacheDir });
        this._origin = origin;
    }
    async loadCache() {
        await this._loadChunkRecord();
    }
    getChunkId(url) {
        return chunk_id_1.calculateChunkId(url, this._origin);
    }
    async getChunk(id) {
        return this._chunks[id];
    }
    async addChunk(id, code, map) {
        const physicalLocation = chunk_id_1.calculatePhysicalLocation(id);
        const mTimestamp = Date.now();
        this._chunks[id] = {
            imports: {},
            physicalLocation,
            mTimestamp,
        };
        const sourceCacheFile = this._getChunkSourceFile(physicalLocation);
        // const metadataCacheFile = this._getMetadataCacheFile(qpLocation);
        let sourceMappingURL;
        let serializedMap;
        if (map) {
            serializedMap = typeof map === 'string'
                ? map
                : JSON.stringify(map);
            sourceMappingURL = `${path_1.default.basename(sourceCacheFile)}.map`;
        }
        const codeWithMap = sourceMappingURL
            ? `${code}\n//# sourceMappingURL=${sourceMappingURL}`
            : code;
        await Promise.all([
            // Write metadata
            // fs.outputFile(metadataCacheFile, JSON.stringify(metadata, undefined, 2), { encoding: 'utf8' }),
            // Write code
            fs_extra_1.default.outputFile(sourceCacheFile, codeWithMap, { encoding: 'utf8' }),
            // Write map
            serializedMap
                ? fs_extra_1.default.outputFile(`${sourceCacheFile}.map`, serializedMap, { encoding: 'utf8' })
                : undefined,
        ]);
    }
    async removeChunk(id) {
        delete this._chunks[id];
    }
    async syncChunk() {
        await this._writeChunkRecord();
    }
}
exports.ChunkWriter = ChunkWriter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JpdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svdXRpbHMvY2h1bmstaW8vd3JpdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLGlDQUFxQztBQUNyQyxnREFBc0I7QUFDdEIsd0RBQTBCO0FBQzFCLDBDQUFtRjtBQUVuRixNQUFhLFdBQVksU0FBUSxrQkFBVztJQUN4QyxZQUFZLEVBQ1IsTUFBTSxFQUNOLGVBQWUsRUFDZixjQUFjLEdBS2pCO1FBQ0csS0FBSyxDQUFDLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7SUFDMUIsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTO1FBQ2xCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVNLFVBQVUsQ0FBQyxHQUFRO1FBQ3RCLE9BQU8sMkJBQWdCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFXO1FBQzdCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFXLEVBQUUsSUFBWSxFQUFFLEdBQWU7UUFDNUQsTUFBTSxnQkFBZ0IsR0FBRyxvQ0FBeUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2RCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRztZQUNmLE9BQU8sRUFBRSxFQUFFO1lBQ1gsZ0JBQWdCO1lBQ2hCLFVBQVU7U0FDYixDQUFDO1FBRUYsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbkUsb0VBQW9FO1FBQ3BFLElBQUksZ0JBQW9DLENBQUM7UUFDekMsSUFBSSxhQUFpQyxDQUFDO1FBQ3RDLElBQUksR0FBRyxFQUFFO1lBQ0wsYUFBYSxHQUFHLE9BQU8sR0FBRyxLQUFLLFFBQVE7Z0JBQ25DLENBQUMsQ0FBQyxHQUFHO2dCQUNMLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzFCLGdCQUFnQixHQUFHLEdBQUcsY0FBRSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO1NBQzVEO1FBQ0QsTUFBTSxXQUFXLEdBQUcsZ0JBQWdCO1lBQ2hDLENBQUMsQ0FBQyxHQUFHLElBQUksMEJBQTBCLGdCQUFnQixFQUFFO1lBQ3JELENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDWCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDZCxpQkFBaUI7WUFDakIsa0dBQWtHO1lBQ2xHLGFBQWE7WUFDYixrQkFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLEVBQUUsV0FBVyxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQ2pFLFlBQVk7WUFDWixhQUFhO2dCQUNULENBQUMsQ0FBQyxrQkFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLGVBQWUsTUFBTSxFQUFFLGFBQWEsRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQztnQkFDOUUsQ0FBQyxDQUFDLFNBQVM7U0FDbEIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBVztRQUNoQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTO1FBQ2xCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDbkMsQ0FBQztDQUdKO0FBckVELGtDQXFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNvdXJjZU1hcCB9IGZyb20gJy4uLy4uLy4uL21vZC1sby9tb2QtbG8nO1xuaW1wb3J0IHsgQ2h1bmtJT0Jhc2UgfSBmcm9tICcuL2Jhc2UnO1xuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IENodW5rSWQsIGNhbGN1bGF0ZUNodW5rSWQsIGNhbGN1bGF0ZVBoeXNpY2FsTG9jYXRpb24gfSBmcm9tICcuLi9jaHVuay1pZCc7XG5cbmV4cG9ydCBjbGFzcyBDaHVua1dyaXRlciBleHRlbmRzIENodW5rSU9CYXNlIHtcbiAgICBjb25zdHJ1Y3Rvcih7XG4gICAgICAgIG9yaWdpbixcbiAgICAgICAgY2h1bmtSZWNvcmRGaWxlLFxuICAgICAgICBzb3VyY2VDYWNoZURpcixcbiAgICB9OiB7XG4gICAgICAgIG9yaWdpbjogc3RyaW5nO1xuICAgICAgICBjaHVua1JlY29yZEZpbGU6IHN0cmluZztcbiAgICAgICAgc291cmNlQ2FjaGVEaXI6IHN0cmluZyxcbiAgICB9KSB7XG4gICAgICAgIHN1cGVyKHsgY2h1bmtSZWNvcmRGaWxlLCBzb3VyY2VDYWNoZURpciB9KTtcbiAgICAgICAgdGhpcy5fb3JpZ2luID0gb3JpZ2luO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBsb2FkQ2FjaGUoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRDaHVua1JlY29yZCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDaHVua0lkKHVybDogVVJMKSB7XG4gICAgICAgIHJldHVybiBjYWxjdWxhdGVDaHVua0lkKHVybCwgdGhpcy5fb3JpZ2luKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0Q2h1bmsoaWQ6IENodW5rSWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NodW5rc1tpZF07XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGFkZENodW5rKGlkOiBDaHVua0lkLCBjb2RlOiBzdHJpbmcsIG1hcD86IFNvdXJjZU1hcCkge1xuICAgICAgICBjb25zdCBwaHlzaWNhbExvY2F0aW9uID0gY2FsY3VsYXRlUGh5c2ljYWxMb2NhdGlvbihpZCk7XG4gICAgICAgIGNvbnN0IG1UaW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgICB0aGlzLl9jaHVua3NbaWRdID0ge1xuICAgICAgICAgICAgaW1wb3J0czoge30sXG4gICAgICAgICAgICBwaHlzaWNhbExvY2F0aW9uLFxuICAgICAgICAgICAgbVRpbWVzdGFtcCxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzb3VyY2VDYWNoZUZpbGUgPSB0aGlzLl9nZXRDaHVua1NvdXJjZUZpbGUocGh5c2ljYWxMb2NhdGlvbik7XG4gICAgICAgIC8vIGNvbnN0IG1ldGFkYXRhQ2FjaGVGaWxlID0gdGhpcy5fZ2V0TWV0YWRhdGFDYWNoZUZpbGUocXBMb2NhdGlvbik7XG4gICAgICAgIGxldCBzb3VyY2VNYXBwaW5nVVJMOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzZXJpYWxpemVkTWFwOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChtYXApIHtcbiAgICAgICAgICAgIHNlcmlhbGl6ZWRNYXAgPSB0eXBlb2YgbWFwID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgICAgID8gbWFwXG4gICAgICAgICAgICAgICAgOiBKU09OLnN0cmluZ2lmeShtYXApO1xuICAgICAgICAgICAgc291cmNlTWFwcGluZ1VSTCA9IGAke3BzLmJhc2VuYW1lKHNvdXJjZUNhY2hlRmlsZSl9Lm1hcGA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29kZVdpdGhNYXAgPSBzb3VyY2VNYXBwaW5nVVJMXG4gICAgICAgICAgICA/IGAke2NvZGV9XFxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9JHtzb3VyY2VNYXBwaW5nVVJMfWBcbiAgICAgICAgICAgIDogY29kZTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgLy8gV3JpdGUgbWV0YWRhdGFcbiAgICAgICAgICAgIC8vIGZzLm91dHB1dEZpbGUobWV0YWRhdGFDYWNoZUZpbGUsIEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhLCB1bmRlZmluZWQsIDIpLCB7IGVuY29kaW5nOiAndXRmOCcgfSksXG4gICAgICAgICAgICAvLyBXcml0ZSBjb2RlXG4gICAgICAgICAgICBmcy5vdXRwdXRGaWxlKHNvdXJjZUNhY2hlRmlsZSwgY29kZVdpdGhNYXAsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSxcbiAgICAgICAgICAgIC8vIFdyaXRlIG1hcFxuICAgICAgICAgICAgc2VyaWFsaXplZE1hcFxuICAgICAgICAgICAgICAgID8gZnMub3V0cHV0RmlsZShgJHtzb3VyY2VDYWNoZUZpbGV9Lm1hcGAsIHNlcmlhbGl6ZWRNYXAsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICBdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVtb3ZlQ2h1bmsoaWQ6IENodW5rSWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuX2NodW5rc1tpZF07XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHN5bmNDaHVuaygpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fd3JpdGVDaHVua1JlY29yZCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX29yaWdpbjogc3RyaW5nO1xufVxuIl19