"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isRelocatableChunkId = exports.calculatePhysicalLocation = exports.calculateChunkId = void 0;
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const relateurl_1 = __importDefault(require("relateurl"));
const chunk_url_1 = require("./chunk-url");
const asserts_1 = require("../../../utils/asserts");
function calculateChunkId(url, origin) {
    if (url.username || url.password || url.host) {
        throw new Error(`Can not decide chunk id for '${url}': only protocol, pathname and searches is allowed.`);
    }
    if (url.protocol === 'file:') {
        const originUrl = url_1.pathToFileURL(`${origin}${path_1.default.sep}`);
        const relative = relateurl_1.default.relate(originUrl.href, url.href);
        const parts = relative.split('/');
        const nDotDots = parts.findIndex((p) => p !== '..');
        return `${[
            ...parts.slice(0, nDotDots),
            ...parts.slice(nDotDots),
        ].join('/')}`;
    }
    else if (!url.protocol) {
        throw new Error(`Can not decide chunk id for '${url}': protocol is expected.`);
    }
    else {
        const protocolName = url.protocol.substr(0, url.protocol.length - 1);
        // Remove dumplited slashes, prefix slash and suffix slash
        const parts = url.pathname.split('/').filter((p) => p);
        if (parts.some((p) => p === '.' || p === '..')) {
            throw new Error(`Can not decide chunk id for '${url}': absolute URL expected.`);
        }
        const pathname = parts.join('/');
        return new URL(`${protocolName}/${pathname}`, chunk_url_1.quickPackRootURL).href;
    }
}
exports.calculateChunkId = calculateChunkId;
function calculatePhysicalLocation(chunkId) {
    if (isRelocatableChunkId(chunkId)) {
        const parts = chunkId.split('/');
        const nDotsDots = parts.findIndex((p) => p !== '..');
        return `fs/${nDotsDots.toString()}/${parts.slice(nDotsDots).join('/')}`;
    }
    else {
        const url = new URL(chunkId);
        asserts_1.asserts(url.pathname.startsWith('/'));
        return url.pathname.slice(1);
    }
}
exports.calculatePhysicalLocation = calculatePhysicalLocation;
function isRelocatableChunkId(chunkId) {
    return !chunkId.includes(':');
}
exports.isRelocatableChunkId = isRelocatableChunkId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstaWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay91dGlscy9jaHVuay1pZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBc0I7QUFDdEIsNkJBQW9DO0FBQ3BDLDBEQUFrQztBQUNsQywyQ0FBK0M7QUFDL0Msb0RBQWlEO0FBSWpELFNBQWdCLGdCQUFnQixDQUFDLEdBQVEsRUFBRSxNQUFjO0lBQ3JELElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7UUFDMUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRyxxREFBcUQsQ0FBQyxDQUFDO0tBQzdHO0lBQ0QsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtRQUMxQixNQUFNLFNBQVMsR0FBRyxtQkFBYSxDQUFDLEdBQUcsTUFBTSxHQUFHLGNBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sUUFBUSxHQUFHLG1CQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3BELE9BQU8sR0FBRztZQUNOLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQzNCLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7U0FDM0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztLQUNqQjtTQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLEdBQUcsMEJBQTBCLENBQUMsQ0FBQztLQUNsRjtTQUFNO1FBQ0gsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLDBEQUEwRDtRQUMxRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7WUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRywyQkFBMkIsQ0FBQyxDQUFDO1NBQ25GO1FBQ0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsWUFBWSxJQUFJLFFBQVEsRUFBRSxFQUFFLDRCQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDO0tBQ3hFO0FBQ0wsQ0FBQztBQXpCRCw0Q0F5QkM7QUFFRCxTQUFnQix5QkFBeUIsQ0FBQyxPQUFnQjtJQUN0RCxJQUFJLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQy9CLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3JELE9BQU8sTUFBTSxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztLQUMzRTtTQUFNO1FBQ0gsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0IsaUJBQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDaEM7QUFDTCxDQUFDO0FBVkQsOERBVUM7QUFFRCxTQUFnQixvQkFBb0IsQ0FBQyxPQUFnQjtJQUNqRCxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRkQsb0RBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHMgZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBwYXRoVG9GaWxlVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCBSZWxhdGVVcmwgZnJvbSAncmVsYXRldXJsJztcbmltcG9ydCB7IHF1aWNrUGFja1Jvb3RVUkwgfSBmcm9tICcuL2NodW5rLXVybCc7XG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXNzZXJ0cyc7XG5cbmV4cG9ydCB0eXBlIENodW5rSWQgPSBzdHJpbmc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVDaHVua0lkKHVybDogVVJMLCBvcmlnaW46IHN0cmluZykge1xuICAgIGlmICh1cmwudXNlcm5hbWUgfHwgdXJsLnBhc3N3b3JkIHx8IHVybC5ob3N0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FuIG5vdCBkZWNpZGUgY2h1bmsgaWQgZm9yICcke3VybH0nOiBvbmx5IHByb3RvY29sLCBwYXRobmFtZSBhbmQgc2VhcmNoZXMgaXMgYWxsb3dlZC5gKTtcbiAgICB9XG4gICAgaWYgKHVybC5wcm90b2NvbCA9PT0gJ2ZpbGU6Jykge1xuICAgICAgICBjb25zdCBvcmlnaW5VcmwgPSBwYXRoVG9GaWxlVVJMKGAke29yaWdpbn0ke3BzLnNlcH1gKTtcbiAgICAgICAgY29uc3QgcmVsYXRpdmUgPSBSZWxhdGVVcmwucmVsYXRlKG9yaWdpblVybC5ocmVmLCB1cmwuaHJlZik7XG4gICAgICAgIGNvbnN0IHBhcnRzID0gcmVsYXRpdmUuc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgbkRvdERvdHMgPSBwYXJ0cy5maW5kSW5kZXgoKHApID0+IHAgIT09ICcuLicpO1xuICAgICAgICByZXR1cm4gYCR7W1xuICAgICAgICAgICAgLi4ucGFydHMuc2xpY2UoMCwgbkRvdERvdHMpLFxuICAgICAgICAgICAgLi4ucGFydHMuc2xpY2UobkRvdERvdHMpLFxuICAgICAgICBdLmpvaW4oJy8nKX1gO1xuICAgIH0gZWxzZSBpZiAoIXVybC5wcm90b2NvbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbiBub3QgZGVjaWRlIGNodW5rIGlkIGZvciAnJHt1cmx9JzogcHJvdG9jb2wgaXMgZXhwZWN0ZWQuYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcHJvdG9jb2xOYW1lID0gdXJsLnByb3RvY29sLnN1YnN0cigwLCB1cmwucHJvdG9jb2wubGVuZ3RoIC0gMSk7XG4gICAgICAgIC8vIFJlbW92ZSBkdW1wbGl0ZWQgc2xhc2hlcywgcHJlZml4IHNsYXNoIGFuZCBzdWZmaXggc2xhc2hcbiAgICAgICAgY29uc3QgcGFydHMgPSB1cmwucGF0aG5hbWUuc3BsaXQoJy8nKS5maWx0ZXIoKHApID0+IHApO1xuICAgICAgICBpZiAocGFydHMuc29tZSgocCkgPT4gcCA9PT0gJy4nIHx8IHAgPT09ICcuLicpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbiBub3QgZGVjaWRlIGNodW5rIGlkIGZvciAnJHt1cmx9JzogYWJzb2x1dGUgVVJMIGV4cGVjdGVkLmApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhdGhuYW1lID0gcGFydHMuam9pbignLycpO1xuICAgICAgICByZXR1cm4gbmV3IFVSTChgJHtwcm90b2NvbE5hbWV9LyR7cGF0aG5hbWV9YCwgcXVpY2tQYWNrUm9vdFVSTCkuaHJlZjtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVQaHlzaWNhbExvY2F0aW9uKGNodW5rSWQ6IENodW5rSWQpIHtcbiAgICBpZiAoaXNSZWxvY2F0YWJsZUNodW5rSWQoY2h1bmtJZCkpIHtcbiAgICAgICAgY29uc3QgcGFydHMgPSBjaHVua0lkLnNwbGl0KCcvJyk7XG4gICAgICAgIGNvbnN0IG5Eb3RzRG90cyA9IHBhcnRzLmZpbmRJbmRleCgocCkgPT4gcCAhPT0gJy4uJyk7XG4gICAgICAgIHJldHVybiBgZnMvJHtuRG90c0RvdHMudG9TdHJpbmcoKX0vJHtwYXJ0cy5zbGljZShuRG90c0RvdHMpLmpvaW4oJy8nKX1gO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY2h1bmtJZCk7XG4gICAgICAgIGFzc2VydHModXJsLnBhdGhuYW1lLnN0YXJ0c1dpdGgoJy8nKSk7XG4gICAgICAgIHJldHVybiB1cmwucGF0aG5hbWUuc2xpY2UoMSk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNSZWxvY2F0YWJsZUNodW5rSWQoY2h1bmtJZDogQ2h1bmtJZCkge1xuICAgIHJldHVybiAhY2h1bmtJZC5pbmNsdWRlcygnOicpO1xufVxuIl19