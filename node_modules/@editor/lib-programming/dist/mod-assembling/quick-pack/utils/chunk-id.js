"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isRelocatableChunkId = exports.calculatePhysicalLocation = exports.calculateChunkId = void 0;
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const relateurl_1 = __importDefault(require("relateurl"));
const chunk_url_1 = require("./chunk-url");
const asserts_1 = require("../../../utils/asserts");
function calculateChunkId(url, origin) {
    if (url.username || url.password || url.host) {
        throw new Error(`Can not decide chunk id for '${url}': only protocol, pathname and searches is allowed.`);
    }
    if (url.protocol === 'file:') {
        const originUrl = url_1.pathToFileURL(`${origin}${path_1.default.sep}`);
        const relative = relateurl_1.default.relate(originUrl.href, url.href);
        const parts = relative.split('/');
        const nDotDots = parts.findIndex((p) => p !== '..');
        return `${[
            ...parts.slice(0, nDotDots),
            ...parts.slice(nDotDots),
        ].join('/')}`;
    }
    else if (!url.protocol) {
        throw new Error(`Can not decide chunk id for '${url}': protocol is expected.`);
    }
    else {
        const protocolName = url.protocol.substr(0, url.protocol.length - 1);
        // Remove dumplited slashes, prefix slash and suffix slash
        const parts = url.pathname.split('/').filter((p) => p);
        if (parts.some((p) => p === '.' || p === '..')) {
            throw new Error(`Can not decide chunk id for '${url}': absolute URL expected.`);
        }
        const pathname = parts.join('/');
        return new url_1.URL(`${protocolName}/${pathname}`, chunk_url_1.quickPackRootURL).href;
    }
}
exports.calculateChunkId = calculateChunkId;
const PATH_CHAR_MAP_TABLE = {
    '@': '@@',
    '?': `@${'?'.charCodeAt(0)}`,
};
function calculatePhysicalLocation(chunkId) {
    const encode = (str) => {
        return Array.from(str).map((c) => { var _a; return (_a = PATH_CHAR_MAP_TABLE[c]) !== null && _a !== void 0 ? _a : c; }).join('');
    };
    if (isRelocatableChunkId(chunkId)) {
        const parts = chunkId.split('/');
        const nDotsDots = parts.findIndex((p) => p !== '..');
        return encode(`fs/${nDotsDots.toString()}/${parts.slice(nDotsDots).join('/')}`);
    }
    else {
        const url = new url_1.URL(chunkId);
        asserts_1.asserts(url.pathname.startsWith('/'));
        return encode(url.pathname.slice(1));
    }
}
exports.calculatePhysicalLocation = calculatePhysicalLocation;
function isRelocatableChunkId(chunkId) {
    return !chunkId.includes(':');
}
exports.isRelocatableChunkId = isRelocatableChunkId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstaWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay91dGlscy9jaHVuay1pZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBc0I7QUFDdEIsNkJBQXlDO0FBQ3pDLDBEQUFrQztBQUNsQywyQ0FBK0M7QUFDL0Msb0RBQWlEO0FBSWpELFNBQWdCLGdCQUFnQixDQUFDLEdBQVEsRUFBRSxNQUFjO0lBQ3JELElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7UUFDMUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRyxxREFBcUQsQ0FBQyxDQUFDO0tBQzdHO0lBQ0QsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtRQUMxQixNQUFNLFNBQVMsR0FBRyxtQkFBYSxDQUFDLEdBQUcsTUFBTSxHQUFHLGNBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sUUFBUSxHQUFHLG1CQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3BELE9BQU8sR0FBRztZQUNOLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQzNCLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7U0FDM0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztLQUNqQjtTQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLEdBQUcsMEJBQTBCLENBQUMsQ0FBQztLQUNsRjtTQUFNO1FBQ0gsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLDBEQUEwRDtRQUMxRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7WUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRywyQkFBMkIsQ0FBQyxDQUFDO1NBQ25GO1FBQ0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxPQUFPLElBQUksU0FBRyxDQUFDLEdBQUcsWUFBWSxJQUFJLFFBQVEsRUFBRSxFQUFFLDRCQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDO0tBQ3hFO0FBQ0wsQ0FBQztBQXpCRCw0Q0F5QkM7QUFFRCxNQUFNLG1CQUFtQixHQUF1QztJQUM1RCxHQUFHLEVBQUUsSUFBSTtJQUNULEdBQUcsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUU7Q0FDL0IsQ0FBQztBQUVGLFNBQWdCLHlCQUF5QixDQUFDLE9BQWdCO0lBQ3RELE1BQU0sTUFBTSxHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUU7UUFDM0IsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLHdCQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxtQ0FBSSxDQUFDLEdBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1RSxDQUFDLENBQUM7SUFFRixJQUFJLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQy9CLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3JELE9BQU8sTUFBTSxDQUFDLE1BQU0sU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNuRjtTQUFNO1FBQ0gsTUFBTSxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0IsaUJBQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEM7QUFDTCxDQUFDO0FBZEQsOERBY0M7QUFHRCxTQUFnQixvQkFBb0IsQ0FBQyxPQUFnQjtJQUNqRCxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRkQsb0RBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHMgZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IFVSTCwgcGF0aFRvRmlsZVVSTCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCBSZWxhdGVVcmwgZnJvbSAncmVsYXRldXJsJztcclxuaW1wb3J0IHsgcXVpY2tQYWNrUm9vdFVSTCB9IGZyb20gJy4vY2h1bmstdXJsJztcclxuaW1wb3J0IHsgYXNzZXJ0cyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2Fzc2VydHMnO1xyXG5cclxuZXhwb3J0IHR5cGUgQ2h1bmtJZCA9IHN0cmluZztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVDaHVua0lkKHVybDogVVJMLCBvcmlnaW46IHN0cmluZykge1xyXG4gICAgaWYgKHVybC51c2VybmFtZSB8fCB1cmwucGFzc3dvcmQgfHwgdXJsLmhvc3QpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbiBub3QgZGVjaWRlIGNodW5rIGlkIGZvciAnJHt1cmx9Jzogb25seSBwcm90b2NvbCwgcGF0aG5hbWUgYW5kIHNlYXJjaGVzIGlzIGFsbG93ZWQuYCk7XHJcbiAgICB9XHJcbiAgICBpZiAodXJsLnByb3RvY29sID09PSAnZmlsZTonKSB7XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luVXJsID0gcGF0aFRvRmlsZVVSTChgJHtvcmlnaW59JHtwcy5zZXB9YCk7XHJcbiAgICAgICAgY29uc3QgcmVsYXRpdmUgPSBSZWxhdGVVcmwucmVsYXRlKG9yaWdpblVybC5ocmVmLCB1cmwuaHJlZik7XHJcbiAgICAgICAgY29uc3QgcGFydHMgPSByZWxhdGl2ZS5zcGxpdCgnLycpO1xyXG4gICAgICAgIGNvbnN0IG5Eb3REb3RzID0gcGFydHMuZmluZEluZGV4KChwKSA9PiBwICE9PSAnLi4nKTtcclxuICAgICAgICByZXR1cm4gYCR7W1xyXG4gICAgICAgICAgICAuLi5wYXJ0cy5zbGljZSgwLCBuRG90RG90cyksXHJcbiAgICAgICAgICAgIC4uLnBhcnRzLnNsaWNlKG5Eb3REb3RzKSxcclxuICAgICAgICBdLmpvaW4oJy8nKX1gO1xyXG4gICAgfSBlbHNlIGlmICghdXJsLnByb3RvY29sKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4gbm90IGRlY2lkZSBjaHVuayBpZCBmb3IgJyR7dXJsfSc6IHByb3RvY29sIGlzIGV4cGVjdGVkLmApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBwcm90b2NvbE5hbWUgPSB1cmwucHJvdG9jb2wuc3Vic3RyKDAsIHVybC5wcm90b2NvbC5sZW5ndGggLSAxKTtcclxuICAgICAgICAvLyBSZW1vdmUgZHVtcGxpdGVkIHNsYXNoZXMsIHByZWZpeCBzbGFzaCBhbmQgc3VmZml4IHNsYXNoXHJcbiAgICAgICAgY29uc3QgcGFydHMgPSB1cmwucGF0aG5hbWUuc3BsaXQoJy8nKS5maWx0ZXIoKHApID0+IHApO1xyXG4gICAgICAgIGlmIChwYXJ0cy5zb21lKChwKSA9PiBwID09PSAnLicgfHwgcCA9PT0gJy4uJykpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4gbm90IGRlY2lkZSBjaHVuayBpZCBmb3IgJyR7dXJsfSc6IGFic29sdXRlIFVSTCBleHBlY3RlZC5gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGF0aG5hbWUgPSBwYXJ0cy5qb2luKCcvJyk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwoYCR7cHJvdG9jb2xOYW1lfS8ke3BhdGhuYW1lfWAsIHF1aWNrUGFja1Jvb3RVUkwpLmhyZWY7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IFBBVEhfQ0hBUl9NQVBfVEFCTEU6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSB7XHJcbiAgICAnQCc6ICdAQCcsXHJcbiAgICAnPyc6IGBAJHsnPycuY2hhckNvZGVBdCgwKX1gLFxyXG59O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZVBoeXNpY2FsTG9jYXRpb24oY2h1bmtJZDogQ2h1bmtJZCkge1xyXG4gICAgY29uc3QgZW5jb2RlID0gKHN0cjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oc3RyKS5tYXAoKGMpID0+IFBBVEhfQ0hBUl9NQVBfVEFCTEVbY10gPz8gYykuam9pbignJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChpc1JlbG9jYXRhYmxlQ2h1bmtJZChjaHVua0lkKSkge1xyXG4gICAgICAgIGNvbnN0IHBhcnRzID0gY2h1bmtJZC5zcGxpdCgnLycpO1xyXG4gICAgICAgIGNvbnN0IG5Eb3RzRG90cyA9IHBhcnRzLmZpbmRJbmRleCgocCkgPT4gcCAhPT0gJy4uJyk7XHJcbiAgICAgICAgcmV0dXJuIGVuY29kZShgZnMvJHtuRG90c0RvdHMudG9TdHJpbmcoKX0vJHtwYXJ0cy5zbGljZShuRG90c0RvdHMpLmpvaW4oJy8nKX1gKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChjaHVua0lkKTtcclxuICAgICAgICBhc3NlcnRzKHVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvJykpO1xyXG4gICAgICAgIHJldHVybiBlbmNvZGUodXJsLnBhdGhuYW1lLnNsaWNlKDEpKTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1JlbG9jYXRhYmxlQ2h1bmtJZChjaHVua0lkOiBDaHVua0lkKSB7XHJcbiAgICByZXR1cm4gIWNodW5rSWQuaW5jbHVkZXMoJzonKTtcclxufVxyXG4iXX0=