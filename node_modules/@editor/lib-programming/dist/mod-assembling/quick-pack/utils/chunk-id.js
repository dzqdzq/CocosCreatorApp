"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isRelocatableChunkId = exports.calculatePhysicalLocation = exports.calculateChunkId = void 0;
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const relateurl_1 = __importDefault(require("relateurl"));
const chunk_url_1 = require("./chunk-url");
const asserts_1 = require("../../../utils/asserts");
function calculateChunkId(url, origin) {
    if (url.username || url.password || url.host) {
        throw new Error(`Can not decide chunk id for '${url}': only protocol, pathname and searches is allowed.`);
    }
    if (url.protocol === 'file:') {
        const originUrl = url_1.pathToFileURL(`${origin}${path_1.default.sep}`);
        const relative = relateurl_1.default.relate(originUrl.href, url.href);
        const parts = relative.split('/');
        const nDotDots = parts.findIndex((p) => p !== '..');
        return `${[
            ...parts.slice(0, nDotDots),
            ...parts.slice(nDotDots),
        ].join('/')}`;
    }
    else if (!url.protocol) {
        throw new Error(`Can not decide chunk id for '${url}': protocol is expected.`);
    }
    else {
        const protocolName = url.protocol.substr(0, url.protocol.length - 1);
        // Remove dumplited slashes, prefix slash and suffix slash
        const parts = url.pathname.split('/').filter((p) => p);
        if (parts.some((p) => p === '.' || p === '..')) {
            throw new Error(`Can not decide chunk id for '${url}': absolute URL expected.`);
        }
        const pathname = parts.join('/');
        return new url_1.URL(`${protocolName}/${pathname}`, chunk_url_1.quickPackRootURL).href;
    }
}
exports.calculateChunkId = calculateChunkId;
const PATH_CHAR_MAP_TABLE = {
    '@': '@@',
    '?': `@${'?'.charCodeAt(0)}`,
};
function calculatePhysicalLocation(chunkId) {
    const encode = (str) => {
        return Array.from(str).map((c) => { var _a; return (_a = PATH_CHAR_MAP_TABLE[c]) !== null && _a !== void 0 ? _a : c; }).join('');
    };
    if (isRelocatableChunkId(chunkId)) {
        const parts = chunkId.split('/');
        const nDotsDots = parts.findIndex((p) => p !== '..');
        return encode(`fs/${nDotsDots.toString()}/${parts.slice(nDotsDots).join('/')}`);
    }
    else {
        const url = new url_1.URL(chunkId);
        asserts_1.asserts(url.pathname.startsWith('/'));
        return encode(url.pathname.slice(1));
    }
}
exports.calculatePhysicalLocation = calculatePhysicalLocation;
function isRelocatableChunkId(chunkId) {
    return !chunkId.includes(':');
}
exports.isRelocatableChunkId = isRelocatableChunkId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2h1bmstaWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay91dGlscy9jaHVuay1pZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBc0I7QUFDdEIsNkJBQXlDO0FBQ3pDLDBEQUFrQztBQUNsQywyQ0FBK0M7QUFDL0Msb0RBQWlEO0FBSWpELFNBQWdCLGdCQUFnQixDQUFDLEdBQVEsRUFBRSxNQUFjO0lBQ3JELElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7UUFDMUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRyxxREFBcUQsQ0FBQyxDQUFDO0tBQzdHO0lBQ0QsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtRQUMxQixNQUFNLFNBQVMsR0FBRyxtQkFBYSxDQUFDLEdBQUcsTUFBTSxHQUFHLGNBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sUUFBUSxHQUFHLG1CQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3BELE9BQU8sR0FBRztZQUNOLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQzNCLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7U0FDM0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztLQUNqQjtTQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLEdBQUcsMEJBQTBCLENBQUMsQ0FBQztLQUNsRjtTQUFNO1FBQ0gsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLDBEQUEwRDtRQUMxRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7WUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsR0FBRywyQkFBMkIsQ0FBQyxDQUFDO1NBQ25GO1FBQ0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxPQUFPLElBQUksU0FBRyxDQUFDLEdBQUcsWUFBWSxJQUFJLFFBQVEsRUFBRSxFQUFFLDRCQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDO0tBQ3hFO0FBQ0wsQ0FBQztBQXpCRCw0Q0F5QkM7QUFFRCxNQUFNLG1CQUFtQixHQUF1QztJQUM1RCxHQUFHLEVBQUUsSUFBSTtJQUNULEdBQUcsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUU7Q0FDL0IsQ0FBQztBQUVGLFNBQWdCLHlCQUF5QixDQUFDLE9BQWdCO0lBQ3RELE1BQU0sTUFBTSxHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUU7UUFDM0IsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLHdCQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxtQ0FBSSxDQUFDLEdBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1RSxDQUFDLENBQUM7SUFFRixJQUFJLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQy9CLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3JELE9BQU8sTUFBTSxDQUFDLE1BQU0sU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNuRjtTQUFNO1FBQ0gsTUFBTSxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0IsaUJBQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEM7QUFDTCxDQUFDO0FBZEQsOERBY0M7QUFHRCxTQUFnQixvQkFBb0IsQ0FBQyxPQUFnQjtJQUNqRCxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRkQsb0RBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHMgZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBVUkwsIHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IFJlbGF0ZVVybCBmcm9tICdyZWxhdGV1cmwnO1xuaW1wb3J0IHsgcXVpY2tQYWNrUm9vdFVSTCB9IGZyb20gJy4vY2h1bmstdXJsJztcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9hc3NlcnRzJztcblxuZXhwb3J0IHR5cGUgQ2h1bmtJZCA9IHN0cmluZztcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUNodW5rSWQodXJsOiBVUkwsIG9yaWdpbjogc3RyaW5nKSB7XG4gICAgaWYgKHVybC51c2VybmFtZSB8fCB1cmwucGFzc3dvcmQgfHwgdXJsLmhvc3QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4gbm90IGRlY2lkZSBjaHVuayBpZCBmb3IgJyR7dXJsfSc6IG9ubHkgcHJvdG9jb2wsIHBhdGhuYW1lIGFuZCBzZWFyY2hlcyBpcyBhbGxvd2VkLmApO1xuICAgIH1cbiAgICBpZiAodXJsLnByb3RvY29sID09PSAnZmlsZTonKSB7XG4gICAgICAgIGNvbnN0IG9yaWdpblVybCA9IHBhdGhUb0ZpbGVVUkwoYCR7b3JpZ2lufSR7cHMuc2VwfWApO1xuICAgICAgICBjb25zdCByZWxhdGl2ZSA9IFJlbGF0ZVVybC5yZWxhdGUob3JpZ2luVXJsLmhyZWYsIHVybC5ocmVmKTtcbiAgICAgICAgY29uc3QgcGFydHMgPSByZWxhdGl2ZS5zcGxpdCgnLycpO1xuICAgICAgICBjb25zdCBuRG90RG90cyA9IHBhcnRzLmZpbmRJbmRleCgocCkgPT4gcCAhPT0gJy4uJyk7XG4gICAgICAgIHJldHVybiBgJHtbXG4gICAgICAgICAgICAuLi5wYXJ0cy5zbGljZSgwLCBuRG90RG90cyksXG4gICAgICAgICAgICAuLi5wYXJ0cy5zbGljZShuRG90RG90cyksXG4gICAgICAgIF0uam9pbignLycpfWA7XG4gICAgfSBlbHNlIGlmICghdXJsLnByb3RvY29sKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FuIG5vdCBkZWNpZGUgY2h1bmsgaWQgZm9yICcke3VybH0nOiBwcm90b2NvbCBpcyBleHBlY3RlZC5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBwcm90b2NvbE5hbWUgPSB1cmwucHJvdG9jb2wuc3Vic3RyKDAsIHVybC5wcm90b2NvbC5sZW5ndGggLSAxKTtcbiAgICAgICAgLy8gUmVtb3ZlIGR1bXBsaXRlZCBzbGFzaGVzLCBwcmVmaXggc2xhc2ggYW5kIHN1ZmZpeCBzbGFzaFxuICAgICAgICBjb25zdCBwYXJ0cyA9IHVybC5wYXRobmFtZS5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XG4gICAgICAgIGlmIChwYXJ0cy5zb21lKChwKSA9PiBwID09PSAnLicgfHwgcCA9PT0gJy4uJykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FuIG5vdCBkZWNpZGUgY2h1bmsgaWQgZm9yICcke3VybH0nOiBhYnNvbHV0ZSBVUkwgZXhwZWN0ZWQuYCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGF0aG5hbWUgPSBwYXJ0cy5qb2luKCcvJyk7XG4gICAgICAgIHJldHVybiBuZXcgVVJMKGAke3Byb3RvY29sTmFtZX0vJHtwYXRobmFtZX1gLCBxdWlja1BhY2tSb290VVJMKS5ocmVmO1xuICAgIH1cbn1cblxuY29uc3QgUEFUSF9DSEFSX01BUF9UQUJMRTogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiA9IHtcbiAgICAnQCc6ICdAQCcsXG4gICAgJz8nOiBgQCR7Jz8nLmNoYXJDb2RlQXQoMCl9YCxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVQaHlzaWNhbExvY2F0aW9uKGNodW5rSWQ6IENodW5rSWQpIHtcbiAgICBjb25zdCBlbmNvZGUgPSAoc3RyOiBzdHJpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oc3RyKS5tYXAoKGMpID0+IFBBVEhfQ0hBUl9NQVBfVEFCTEVbY10gPz8gYykuam9pbignJyk7XG4gICAgfTtcblxuICAgIGlmIChpc1JlbG9jYXRhYmxlQ2h1bmtJZChjaHVua0lkKSkge1xuICAgICAgICBjb25zdCBwYXJ0cyA9IGNodW5rSWQuc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgbkRvdHNEb3RzID0gcGFydHMuZmluZEluZGV4KChwKSA9PiBwICE9PSAnLi4nKTtcbiAgICAgICAgcmV0dXJuIGVuY29kZShgZnMvJHtuRG90c0RvdHMudG9TdHJpbmcoKX0vJHtwYXJ0cy5zbGljZShuRG90c0RvdHMpLmpvaW4oJy8nKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNodW5rSWQpO1xuICAgICAgICBhc3NlcnRzKHVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvJykpO1xuICAgICAgICByZXR1cm4gZW5jb2RlKHVybC5wYXRobmFtZS5zbGljZSgxKSk7XG4gICAgfVxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBpc1JlbG9jYXRhYmxlQ2h1bmtJZChjaHVua0lkOiBDaHVua0lkKSB7XG4gICAgcmV0dXJuICFjaHVua0lkLmluY2x1ZGVzKCc6Jyk7XG59XG4iXX0=