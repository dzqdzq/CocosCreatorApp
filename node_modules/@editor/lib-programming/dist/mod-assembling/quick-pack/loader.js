"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.QuickPackLoaderContext = exports.QuickPackLoader = exports.ResourceNotFoundError = void 0;
const loader_context_1 = require("./utils/loader-context");
Object.defineProperty(exports, "QuickPackLoaderContext", { enumerable: true, get: function () { return loader_context_1.LoaderContext; } });
const base_1 = require("./utils/chunk-io/base");
const chunk_url_1 = require("./utils/chunk-url");
const url_1 = require("url");
const i18n_1 = require("../../utils/i18n");
const fs_extra_1 = __importDefault(require("fs-extra"));
class ResourceNotFoundError extends Error {
    constructor(id) {
        super(i18n_1.i18nTranslate('quick_pack_loader_resource_not_found_error', { id }));
    }
}
exports.ResourceNotFoundError = ResourceNotFoundError;
class QuickPackLoader extends base_1.ChunkIOBase {
    constructor(context, options) {
        super({ chunkRecordFile: context.chunkRecordFile, sourceCacheDir: context.sourceCacheDir });
        this._importMap = {};
        this._physicalLocationMap = {};
        this._origin = context.origin;
        this._options = options;
        this._importMapFile = context.importMapFile;
        const realFsRoot = url_1.pathToFileURL(this._origin).pathname;
        this._fsLocator = new chunk_url_1.FsLocator(realFsRoot);
    }
    async getImportMap() {
        return this._importMap;
    }
    async getResource(link) {
        const resourceId = this.getResourceId(link);
        return await this.getResourceFromId(resourceId);
    }
    getResourceId(link) {
        return link.startsWith('/') ? link.substr(1) : link;
    }
    async getResourceFromId(resourceId) {
        const physicalLocation = resourceId;
        const file = this._getChunkSourceFile(physicalLocation);
        return {
            type: 'file',
            path: file,
        };
    }
    /**
     * 获取指定资源的 mtime 时间戳。若不存在则返回负值。
     */
    async getResourceMTimestamp(resource) {
        var _a, _b;
        const physicalLocation = resource;
        return (_b = (_a = this._physicalLocationMap[physicalLocation]) === null || _a === void 0 ? void 0 : _a.mTimestamp) !== null && _b !== void 0 ? _b : -1;
    }
    /**
     * 获取指定所有资源的 mtime 时间戳。不存在的资源将返回负值。
     */
    async getResourceMTimestamps(resources) {
        return resources.map((resourceId) => { var _a, _b; return (_b = (_a = this._physicalLocationMap[resourceId]) === null || _a === void 0 ? void 0 : _a.mTimestamp) !== null && _b !== void 0 ? _b : -1; });
    }
    async reload() {
        await this._loadChunkRecord();
        this._physicalLocationMap = {};
        for (const [chunkId, chunk] of Object.entries(this._chunks)) {
            this._physicalLocationMap[chunk.physicalLocation] = {
                mTimestamp: chunk.mTimestamp,
            };
        }
        this._importMap = await fs_extra_1.default.readJson(this._importMapFile);
    }
}
exports.QuickPackLoader = QuickPackLoader;
function quickPackURLToExternalLink(url) {
    return `${url.pathname.substr(1)}${url.search}`;
}
function linkToQuickPackURL(link) {
    return new url_1.URL(link, chunk_url_1.quickPackRootURL);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDJEQUF1RDtBQThGN0IsdUdBOUZqQiw4QkFBYSxPQThGMEI7QUE3RmhELGdEQUFvRDtBQUVwRCxpREFBZ0Y7QUFDaEYsNkJBQXlDO0FBTXpDLDJDQUFpRDtBQUNqRCx3REFBMEI7QUFNMUIsTUFBYSxxQkFBc0IsU0FBUSxLQUFLO0lBQzVDLFlBQVksRUFBVTtRQUNsQixLQUFLLENBQUMsb0JBQWEsQ0FBQyw0Q0FBNEMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMvRSxDQUFDO0NBQ0o7QUFKRCxzREFJQztBQUVELE1BQWEsZUFBZ0IsU0FBUSxrQkFBVztJQUM1QyxZQUNJLE9BQXNCLEVBQ3RCLE9BQWdCO1FBRWhCLEtBQUssQ0FBQyxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsZUFBZSxFQUFFLGNBQWMsRUFBRSxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQTREeEYsZUFBVSxHQUFjLEVBQUUsQ0FBQztRQUMzQix5QkFBb0IsR0FFdkIsRUFBRSxDQUFDO1FBOURKLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDNUMsTUFBTSxVQUFVLEdBQUcsbUJBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO1FBQ3hELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxxQkFBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWTtRQUNyQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBWTtRQUNqQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLE9BQU8sTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVNLGFBQWEsQ0FBQyxJQUFZO1FBQzdCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3hELENBQUM7SUFFTSxLQUFLLENBQUMsaUJBQWlCLENBQUMsVUFBc0I7UUFDakQsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUM7UUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsT0FBTztZQUNILElBQUksRUFBRSxNQUFNO1lBQ1osSUFBSSxFQUFFLElBQUk7U0FDSixDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLHFCQUFxQixDQUFDLFFBQW9COztRQUNuRCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQztRQUNsQyxtQkFBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsMENBQUUsVUFBVSxtQ0FBSSxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsU0FBdUI7UUFDdkQsT0FBTyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsa0NBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQywwQ0FBRSxVQUFVLG1DQUFJLENBQUMsQ0FBQyxHQUFBLENBQUMsQ0FBQztJQUNsRyxDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQU07UUFDZixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7UUFDL0IsS0FBSyxNQUFNLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3pELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBRztnQkFDaEQsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO2FBQy9CLENBQUM7U0FDTDtRQUNELElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxrQkFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDN0QsQ0FBQztDQVVKO0FBckVELDBDQXFFQztBQWtCRCxTQUFTLDBCQUEwQixDQUFDLEdBQVE7SUFDeEMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUNwRCxDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxJQUFZO0lBQ3BDLE9BQU8sSUFBSSxTQUFHLENBQUMsSUFBSSxFQUFFLDRCQUFnQixDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tIFwiLi91dGlscy9sb2FkZXItY29udGV4dFwiO1xuaW1wb3J0IHsgQ2h1bmtJT0Jhc2UgfSBmcm9tICcuL3V0aWxzL2NodW5rLWlvL2Jhc2UnO1xuaW1wb3J0IHsgYXNzZXJ0cyB9IGZyb20gJy4uLy4uL3V0aWxzL2Fzc2VydHMnO1xuaW1wb3J0IHsgRnNMb2NhdG9yLCBpc1F1aWNrUGFja1VSTCwgcXVpY2tQYWNrUm9vdFVSTCB9IGZyb20gJy4vdXRpbHMvY2h1bmstdXJsJztcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwsIFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgcHMgZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBDaHVua0lkIH0gZnJvbSAnLi91dGlscy9jaHVuay1pZCc7XG5pbXBvcnQgeyBDaHVua01UaW1lc3RhbXAsIFBoeXNpY2FsTG9jYXRpb24gfSBmcm9tICcuL3V0aWxzL2NodW5rJztcbmltcG9ydCB7IGlzUmVsYXRpdmVTcGVjaWZpZXIgfSBmcm9tICcuLi91dGlscy9zcGVjaWZpZXInO1xuaW1wb3J0IHsgdHJ5UGFyc2VVUkwgfSBmcm9tICcuLi91dGlscy91cmwnO1xuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uLy4uL3V0aWxzL2kxOG4nO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcblxuaW50ZXJmYWNlIE9wdGlvbnMge1xuICAgIGltcG9ydE1hcEJhc2VkUm9vdDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUmVzb3VyY2VOb3RGb3VuZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoaTE4blRyYW5zbGF0ZSgncXVpY2tfcGFja19sb2FkZXJfcmVzb3VyY2Vfbm90X2ZvdW5kX2Vycm9yJywgeyBpZCB9KSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUXVpY2tQYWNrTG9hZGVyIGV4dGVuZHMgQ2h1bmtJT0Jhc2Uge1xuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICAgICAgY29udGV4dDogTG9hZGVyQ29udGV4dCxcbiAgICAgICAgb3B0aW9uczogT3B0aW9ucyxcbiAgICApIHtcbiAgICAgICAgc3VwZXIoeyBjaHVua1JlY29yZEZpbGU6IGNvbnRleHQuY2h1bmtSZWNvcmRGaWxlLCBzb3VyY2VDYWNoZURpcjogY29udGV4dC5zb3VyY2VDYWNoZURpciB9KTtcbiAgICAgICAgdGhpcy5fb3JpZ2luID0gY29udGV4dC5vcmlnaW47XG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgICB0aGlzLl9pbXBvcnRNYXBGaWxlID0gY29udGV4dC5pbXBvcnRNYXBGaWxlO1xuICAgICAgICBjb25zdCByZWFsRnNSb290ID0gcGF0aFRvRmlsZVVSTCh0aGlzLl9vcmlnaW4pLnBhdGhuYW1lO1xuICAgICAgICB0aGlzLl9mc0xvY2F0b3IgPSBuZXcgRnNMb2NhdG9yKHJlYWxGc1Jvb3QpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRJbXBvcnRNYXAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbXBvcnRNYXA7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGdldFJlc291cmNlKGxpbms6IHN0cmluZyk6IFByb21pc2U8TW9kdWxlUmVzb3VyY2U+IHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2VJZCA9IHRoaXMuZ2V0UmVzb3VyY2VJZChsaW5rKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0UmVzb3VyY2VGcm9tSWQocmVzb3VyY2VJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFJlc291cmNlSWQobGluazogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBsaW5rLnN0YXJ0c1dpdGgoJy8nKSA/IGxpbmsuc3Vic3RyKDEpIDogbGluaztcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0UmVzb3VyY2VGcm9tSWQocmVzb3VyY2VJZDogUmVzb3VyY2VJZCkge1xuICAgICAgICBjb25zdCBwaHlzaWNhbExvY2F0aW9uID0gcmVzb3VyY2VJZDtcbiAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuX2dldENodW5rU291cmNlRmlsZShwaHlzaWNhbExvY2F0aW9uKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICdmaWxlJyxcbiAgICAgICAgICAgIHBhdGg6IGZpbGUsXG4gICAgICAgIH0gYXMgY29uc3Q7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W5oyH5a6a6LWE5rqQ55qEIG10aW1lIOaXtumXtOaIs+OAguiLpeS4jeWtmOWcqOWImei/lOWbnui0n+WAvOOAglxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRSZXNvdXJjZU1UaW1lc3RhbXAocmVzb3VyY2U6IFJlc291cmNlSWQpOiBQcm9taXNlPFJlc291cmNlTVRpbWVzdGFtcD4ge1xuICAgICAgICBjb25zdCBwaHlzaWNhbExvY2F0aW9uID0gcmVzb3VyY2U7XG4gICAgICAgIHJldHVybiB0aGlzLl9waHlzaWNhbExvY2F0aW9uTWFwW3BoeXNpY2FsTG9jYXRpb25dPy5tVGltZXN0YW1wID8/IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOiOt+WPluaMh+WumuaJgOaciei1hOa6kOeahCBtdGltZSDml7bpl7TmiLPjgILkuI3lrZjlnKjnmoTotYTmupDlsIbov5Tlm57otJ/lgLzjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZ2V0UmVzb3VyY2VNVGltZXN0YW1wcyhyZXNvdXJjZXM6IFJlc291cmNlSWRbXSk6IFByb21pc2U8UmVzb3VyY2VNVGltZXN0YW1wW10+IHtcbiAgICAgICAgcmV0dXJuIHJlc291cmNlcy5tYXAoKHJlc291cmNlSWQpID0+IHRoaXMuX3BoeXNpY2FsTG9jYXRpb25NYXBbcmVzb3VyY2VJZF0/Lm1UaW1lc3RhbXAgPz8gLTEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyByZWxvYWQoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRDaHVua1JlY29yZCgpO1xuICAgICAgICB0aGlzLl9waHlzaWNhbExvY2F0aW9uTWFwID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW2NodW5rSWQsIGNodW5rXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9jaHVua3MpKSB7XG4gICAgICAgICAgICB0aGlzLl9waHlzaWNhbExvY2F0aW9uTWFwW2NodW5rLnBoeXNpY2FsTG9jYXRpb25dID0ge1xuICAgICAgICAgICAgICAgIG1UaW1lc3RhbXA6IGNodW5rLm1UaW1lc3RhbXAsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcCA9IGF3YWl0IGZzLnJlYWRKc29uKHRoaXMuX2ltcG9ydE1hcEZpbGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX29yaWdpbjogc3RyaW5nO1xuICAgIHByaXZhdGUgX29wdGlvbnM6IE9wdGlvbnM7XG4gICAgcHJpdmF0ZSBfZnNMb2NhdG9yOiBGc0xvY2F0b3I7XG4gICAgcHJpdmF0ZSBfaW1wb3J0TWFwRmlsZTogc3RyaW5nO1xuICAgIHByaXZhdGUgX2ltcG9ydE1hcDogSW1wb3J0TWFwID0ge307XG4gICAgcHJpdmF0ZSBfcGh5c2ljYWxMb2NhdGlvbk1hcDogUmVjb3JkPFBoeXNpY2FsTG9jYXRpb24sIHtcbiAgICAgICAgbVRpbWVzdGFtcDogbnVtYmVyO1xuICAgIH0+ID0ge307XG59XG5cbmV4cG9ydCB7IExvYWRlckNvbnRleHQgYXMgUXVpY2tQYWNrTG9hZGVyQ29udGV4dCB9O1xuXG5leHBvcnQgdHlwZSBSZXNvdXJjZUlkID0gc3RyaW5nO1xuXG5leHBvcnQgdHlwZSBSZXNvdXJjZU1UaW1lc3RhbXAgPSBDaHVua01UaW1lc3RhbXA7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW9kdWxlUmVzb3VyY2Uge1xuICAgIHR5cGU6ICdmaWxlJztcbiAgICBwYXRoOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW1wb3J0TWFwIHtcbiAgICBpbXBvcnRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICBzY29wZXM/OiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+Pjtcbn1cblxuZnVuY3Rpb24gcXVpY2tQYWNrVVJMVG9FeHRlcm5hbExpbmsodXJsOiBVUkwpIHtcbiAgICByZXR1cm4gYCR7dXJsLnBhdGhuYW1lLnN1YnN0cigxKX0ke3VybC5zZWFyY2h9YDtcbn1cblxuZnVuY3Rpb24gbGlua1RvUXVpY2tQYWNrVVJMKGxpbms6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgVVJMKGxpbmssIHF1aWNrUGFja1Jvb3RVUkwpO1xufVxuIl19