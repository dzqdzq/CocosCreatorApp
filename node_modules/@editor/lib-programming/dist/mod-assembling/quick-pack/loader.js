"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.QuickPackLoaderContext = exports.QuickPackLoader = exports.ResourceNotFoundError = void 0;
const loader_context_1 = require("./utils/loader-context");
Object.defineProperty(exports, "QuickPackLoaderContext", { enumerable: true, get: function () { return loader_context_1.LoaderContext; } });
const base_1 = require("./utils/chunk-io/base");
const chunk_url_1 = require("./utils/chunk-url");
const url_1 = require("url");
const i18n_1 = require("../../utils/i18n");
const fs_extra_1 = __importDefault(require("fs-extra"));
class ResourceNotFoundError extends Error {
    constructor(id) {
        super(i18n_1.i18nTranslate('quick_pack_loader_resource_not_found_error', { id }));
    }
}
exports.ResourceNotFoundError = ResourceNotFoundError;
class QuickPackLoader extends base_1.ChunkIOBase {
    constructor(context, options) {
        super({ chunkRecordFile: context.chunkRecordFile, sourceCacheDir: context.sourceCacheDir });
        this._importMap = {};
        this._physicalLocationMap = {};
        this._origin = context.origin;
        this._options = options;
        this._importMapFile = context.importMapFile;
        const realFsRoot = url_1.pathToFileURL(this._origin).pathname;
        this._fsLocator = new chunk_url_1.FsLocator(realFsRoot);
    }
    async getImportMap() {
        return this._importMap;
    }
    async getResource(link) {
        const resourceId = this.getResourceId(link);
        return await this.getResourceFromId(resourceId);
    }
    getResourceId(link) {
        return link.startsWith('/') ? link.substr(1) : link;
    }
    async getResourceFromId(resourceId) {
        const physicalLocation = resourceId;
        const file = this._getChunkSourceFile(physicalLocation);
        return {
            type: 'file',
            path: file,
        };
    }
    /**
     * 获取指定资源的 mtime 时间戳。若不存在则返回负值。
     */
    async getResourceMTimestamp(resource) {
        var _a, _b;
        const physicalLocation = resource;
        return (_b = (_a = this._physicalLocationMap[physicalLocation]) === null || _a === void 0 ? void 0 : _a.mTimestamp) !== null && _b !== void 0 ? _b : -1;
    }
    /**
     * 获取指定所有资源的 mtime 时间戳。不存在的资源将返回负值。
     */
    async getResourceMTimestamps(resources) {
        return resources.map((resourceId) => { var _a, _b; return (_b = (_a = this._physicalLocationMap[resourceId]) === null || _a === void 0 ? void 0 : _a.mTimestamp) !== null && _b !== void 0 ? _b : -1; });
    }
    async reload() {
        await this._loadChunkRecord();
        this._physicalLocationMap = {};
        for (const [chunkId, chunk] of Object.entries(this._chunks)) {
            this._physicalLocationMap[chunk.physicalLocation] = {
                mTimestamp: chunk.mTimestamp,
            };
        }
        this._importMap = await fs_extra_1.default.readJson(this._importMapFile);
    }
}
exports.QuickPackLoader = QuickPackLoader;
function quickPackURLToExternalLink(url) {
    return `${url.pathname.substr(1)}${url.search}`;
}
function linkToQuickPackURL(link) {
    return new url_1.URL(link, chunk_url_1.quickPackRootURL);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDJEQUF1RDtBQThGN0IsdUdBOUZqQiw4QkFBYSxPQThGMEI7QUE3RmhELGdEQUFvRDtBQUVwRCxpREFBZ0Y7QUFDaEYsNkJBQXlDO0FBTXpDLDJDQUFpRDtBQUNqRCx3REFBMEI7QUFNMUIsTUFBYSxxQkFBc0IsU0FBUSxLQUFLO0lBQzVDLFlBQVksRUFBVTtRQUNsQixLQUFLLENBQUMsb0JBQWEsQ0FBQyw0Q0FBNEMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMvRSxDQUFDO0NBQ0o7QUFKRCxzREFJQztBQUVELE1BQWEsZUFBZ0IsU0FBUSxrQkFBVztJQUM1QyxZQUNJLE9BQXNCLEVBQ3RCLE9BQWdCO1FBRWhCLEtBQUssQ0FBQyxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsZUFBZSxFQUFFLGNBQWMsRUFBRSxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQTREeEYsZUFBVSxHQUFjLEVBQUUsQ0FBQztRQUMzQix5QkFBb0IsR0FFdkIsRUFBRSxDQUFDO1FBOURKLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDNUMsTUFBTSxVQUFVLEdBQUcsbUJBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDO1FBQ3hELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxxQkFBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWTtRQUNyQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVNLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBWTtRQUNqQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLE9BQU8sTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVNLGFBQWEsQ0FBQyxJQUFZO1FBQzdCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3hELENBQUM7SUFFTSxLQUFLLENBQUMsaUJBQWlCLENBQUMsVUFBc0I7UUFDakQsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUM7UUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsT0FBTztZQUNILElBQUksRUFBRSxNQUFNO1lBQ1osSUFBSSxFQUFFLElBQUk7U0FDSixDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLHFCQUFxQixDQUFDLFFBQW9COztRQUNuRCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQztRQUNsQyxtQkFBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsMENBQUUsVUFBVSxtQ0FBSSxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsU0FBdUI7UUFDdkQsT0FBTyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsa0NBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQywwQ0FBRSxVQUFVLG1DQUFJLENBQUMsQ0FBQyxHQUFBLENBQUMsQ0FBQztJQUNsRyxDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQU07UUFDZixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7UUFDL0IsS0FBSyxNQUFNLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3pELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBRztnQkFDaEQsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO2FBQy9CLENBQUM7U0FDTDtRQUNELElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxrQkFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDN0QsQ0FBQztDQVVKO0FBckVELDBDQXFFQztBQWtCRCxTQUFTLDBCQUEwQixDQUFDLEdBQVE7SUFDeEMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUNwRCxDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxJQUFZO0lBQ3BDLE9BQU8sSUFBSSxTQUFHLENBQUMsSUFBSSxFQUFFLDRCQUFnQixDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tIFwiLi91dGlscy9sb2FkZXItY29udGV4dFwiO1xyXG5pbXBvcnQgeyBDaHVua0lPQmFzZSB9IGZyb20gJy4vdXRpbHMvY2h1bmstaW8vYmFzZSc7XHJcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi91dGlscy9hc3NlcnRzJztcclxuaW1wb3J0IHsgRnNMb2NhdG9yLCBpc1F1aWNrUGFja1VSTCwgcXVpY2tQYWNrUm9vdFVSTCB9IGZyb20gJy4vdXRpbHMvY2h1bmstdXJsJztcclxuaW1wb3J0IHsgcGF0aFRvRmlsZVVSTCwgVVJMIH0gZnJvbSAndXJsJztcclxuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBDaHVua0lkIH0gZnJvbSAnLi91dGlscy9jaHVuay1pZCc7XHJcbmltcG9ydCB7IENodW5rTVRpbWVzdGFtcCwgUGh5c2ljYWxMb2NhdGlvbiB9IGZyb20gJy4vdXRpbHMvY2h1bmsnO1xyXG5pbXBvcnQgeyBpc1JlbGF0aXZlU3BlY2lmaWVyIH0gZnJvbSAnLi4vdXRpbHMvc3BlY2lmaWVyJztcclxuaW1wb3J0IHsgdHJ5UGFyc2VVUkwgfSBmcm9tICcuLi91dGlscy91cmwnO1xyXG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vLi4vdXRpbHMvaTE4bic7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcblxyXG5pbnRlcmZhY2UgT3B0aW9ucyB7XHJcbiAgICBpbXBvcnRNYXBCYXNlZFJvb3Q6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFJlc291cmNlTm90Rm91bmRFcnJvciBleHRlbmRzIEVycm9yIHtcclxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcpIHtcclxuICAgICAgICBzdXBlcihpMThuVHJhbnNsYXRlKCdxdWlja19wYWNrX2xvYWRlcl9yZXNvdXJjZV9ub3RfZm91bmRfZXJyb3InLCB7IGlkIH0pKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFF1aWNrUGFja0xvYWRlciBleHRlbmRzIENodW5rSU9CYXNlIHtcclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcclxuICAgICAgICBjb250ZXh0OiBMb2FkZXJDb250ZXh0LFxyXG4gICAgICAgIG9wdGlvbnM6IE9wdGlvbnMsXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcih7IGNodW5rUmVjb3JkRmlsZTogY29udGV4dC5jaHVua1JlY29yZEZpbGUsIHNvdXJjZUNhY2hlRGlyOiBjb250ZXh0LnNvdXJjZUNhY2hlRGlyIH0pO1xyXG4gICAgICAgIHRoaXMuX29yaWdpbiA9IGNvbnRleHQub3JpZ2luO1xyXG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xyXG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcEZpbGUgPSBjb250ZXh0LmltcG9ydE1hcEZpbGU7XHJcbiAgICAgICAgY29uc3QgcmVhbEZzUm9vdCA9IHBhdGhUb0ZpbGVVUkwodGhpcy5fb3JpZ2luKS5wYXRobmFtZTtcclxuICAgICAgICB0aGlzLl9mc0xvY2F0b3IgPSBuZXcgRnNMb2NhdG9yKHJlYWxGc1Jvb3QpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBnZXRJbXBvcnRNYXAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ltcG9ydE1hcDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZ2V0UmVzb3VyY2UobGluazogc3RyaW5nKTogUHJvbWlzZTxNb2R1bGVSZXNvdXJjZT4ge1xyXG4gICAgICAgIGNvbnN0IHJlc291cmNlSWQgPSB0aGlzLmdldFJlc291cmNlSWQobGluayk7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0UmVzb3VyY2VGcm9tSWQocmVzb3VyY2VJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFJlc291cmNlSWQobGluazogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIGxpbmsuc3RhcnRzV2l0aCgnLycpID8gbGluay5zdWJzdHIoMSkgOiBsaW5rO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBnZXRSZXNvdXJjZUZyb21JZChyZXNvdXJjZUlkOiBSZXNvdXJjZUlkKSB7XHJcbiAgICAgICAgY29uc3QgcGh5c2ljYWxMb2NhdGlvbiA9IHJlc291cmNlSWQ7XHJcbiAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuX2dldENodW5rU291cmNlRmlsZShwaHlzaWNhbExvY2F0aW9uKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0eXBlOiAnZmlsZScsXHJcbiAgICAgICAgICAgIHBhdGg6IGZpbGUsXHJcbiAgICAgICAgfSBhcyBjb25zdDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluaMh+Wumui1hOa6kOeahCBtdGltZSDml7bpl7TmiLPjgILoi6XkuI3lrZjlnKjliJnov5Tlm57otJ/lgLzjgIJcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGdldFJlc291cmNlTVRpbWVzdGFtcChyZXNvdXJjZTogUmVzb3VyY2VJZCk6IFByb21pc2U8UmVzb3VyY2VNVGltZXN0YW1wPiB7XHJcbiAgICAgICAgY29uc3QgcGh5c2ljYWxMb2NhdGlvbiA9IHJlc291cmNlO1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9waHlzaWNhbExvY2F0aW9uTWFwW3BoeXNpY2FsTG9jYXRpb25dPy5tVGltZXN0YW1wID8/IC0xO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5oyH5a6a5omA5pyJ6LWE5rqQ55qEIG10aW1lIOaXtumXtOaIs+OAguS4jeWtmOWcqOeahOi1hOa6kOWwhui/lOWbnui0n+WAvOOAglxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgZ2V0UmVzb3VyY2VNVGltZXN0YW1wcyhyZXNvdXJjZXM6IFJlc291cmNlSWRbXSk6IFByb21pc2U8UmVzb3VyY2VNVGltZXN0YW1wW10+IHtcclxuICAgICAgICByZXR1cm4gcmVzb3VyY2VzLm1hcCgocmVzb3VyY2VJZCkgPT4gdGhpcy5fcGh5c2ljYWxMb2NhdGlvbk1hcFtyZXNvdXJjZUlkXT8ubVRpbWVzdGFtcCA/PyAtMSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLl9sb2FkQ2h1bmtSZWNvcmQoKTtcclxuICAgICAgICB0aGlzLl9waHlzaWNhbExvY2F0aW9uTWFwID0ge307XHJcbiAgICAgICAgZm9yIChjb25zdCBbY2h1bmtJZCwgY2h1bmtdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX2NodW5rcykpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGh5c2ljYWxMb2NhdGlvbk1hcFtjaHVuay5waHlzaWNhbExvY2F0aW9uXSA9IHtcclxuICAgICAgICAgICAgICAgIG1UaW1lc3RhbXA6IGNodW5rLm1UaW1lc3RhbXAsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcCA9IGF3YWl0IGZzLnJlYWRKc29uKHRoaXMuX2ltcG9ydE1hcEZpbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX29yaWdpbjogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfb3B0aW9uczogT3B0aW9ucztcclxuICAgIHByaXZhdGUgX2ZzTG9jYXRvcjogRnNMb2NhdG9yO1xyXG4gICAgcHJpdmF0ZSBfaW1wb3J0TWFwRmlsZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfaW1wb3J0TWFwOiBJbXBvcnRNYXAgPSB7fTtcclxuICAgIHByaXZhdGUgX3BoeXNpY2FsTG9jYXRpb25NYXA6IFJlY29yZDxQaHlzaWNhbExvY2F0aW9uLCB7XHJcbiAgICAgICAgbVRpbWVzdGFtcDogbnVtYmVyO1xyXG4gICAgfT4gPSB7fTtcclxufVxyXG5cclxuZXhwb3J0IHsgTG9hZGVyQ29udGV4dCBhcyBRdWlja1BhY2tMb2FkZXJDb250ZXh0IH07XHJcblxyXG5leHBvcnQgdHlwZSBSZXNvdXJjZUlkID0gc3RyaW5nO1xyXG5cclxuZXhwb3J0IHR5cGUgUmVzb3VyY2VNVGltZXN0YW1wID0gQ2h1bmtNVGltZXN0YW1wO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNb2R1bGVSZXNvdXJjZSB7XHJcbiAgICB0eXBlOiAnZmlsZSc7XHJcbiAgICBwYXRoOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSW1wb3J0TWFwIHtcclxuICAgIGltcG9ydHM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xyXG4gICAgc2NvcGVzPzogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj47XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHF1aWNrUGFja1VSTFRvRXh0ZXJuYWxMaW5rKHVybDogVVJMKSB7XHJcbiAgICByZXR1cm4gYCR7dXJsLnBhdGhuYW1lLnN1YnN0cigxKX0ke3VybC5zZWFyY2h9YDtcclxufVxyXG5cclxuZnVuY3Rpb24gbGlua1RvUXVpY2tQYWNrVVJMKGxpbms6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIG5ldyBVUkwobGluaywgcXVpY2tQYWNrUm9vdFVSTCk7XHJcbn1cclxuIl19