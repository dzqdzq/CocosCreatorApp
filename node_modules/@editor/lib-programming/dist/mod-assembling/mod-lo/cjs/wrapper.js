"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCjsInteropModuleSource = exports.wrapCjs = exports.cjsWrapperImports = void 0;
const dedent_1 = __importDefault(require("dedent"));
const mod_lo_builtin_mods_1 = require("../utils/mod-lo-builtin-mods");
const babel = __importStar(require("@babel/core"));
exports.cjsWrapperImports = [mod_lo_builtin_mods_1.modLoBuiltinModCommonJsURL];
function wrapCjs(requires, exports, reexports) {
    return (context) => {
        return {
            visitor: {
                Program: {
                    exit: (path) => {
                        wrap(context, path, requires, exports, reexports);
                    },
                }
            },
        };
    };
}
exports.wrapCjs = wrapCjs;
const cjsMetaUrlExportName = '__cjsMetaURL';
/**
 * 在推测 CommonJS 模块的所有命名化导出时过滤掉这些。
 */
const reservedIds = [
    'default',
    cjsMetaUrlExportName,
];
function wrap({ types }, path, requires, exports, reexports) {
    const originalProgram = path.node;
    const reqIds = requires.map((req) => path.scope.generateUid('req'));
    const filteredExports = exports.filter((exportName) => !reservedIds.includes(exportName));
    let cjsExportVarId = path.scope.generateUid('cjsExports');
    let declExportVars = [];
    let updateExportVars = [];
    let exportStatements = [];
    if (filteredExports.length !== 0) {
        const exportVars = filteredExports.map((exportName) => {
            return [exportName, path.scope.generateUid(exportName)];
        });
        declExportVars = exportVars.map(([, localName]) => types.variableDeclaration('let', [types.variableDeclarator(types.identifier(localName))]));
        updateExportVars = exportVars.map(([exportName, localName]) => {
            return types.expressionStatement(types.assignmentExpression('=', types.identifier(localName), types.memberExpression(types.memberExpression(types.identifier('module'), types.identifier('exports')), types.identifier(exportName))));
        });
        exportStatements = [types.exportNamedDeclaration(undefined, exportVars.map(([exportName, localName]) => types.exportSpecifier(types.identifier(localName), types.identifier(exportName))))];
    }
    const program = template({
        cjsExportVar: types.identifier(cjsExportVarId),
        declCjsExportVar: types.variableDeclaration('let', [types.variableDeclarator(types.identifier(cjsExportVarId))]),
        declExportVars,
        updateExportVars,
        loaderVar: path.scope.generateUidIdentifier('loader'),
        requireVar: path.scope.generateUidIdentifier('require'),
        deps: requires.map((req, index) => types.importDeclaration([
            types.importSpecifier(types.identifier(reqIds[index]), types.identifier(cjsMetaUrlExportName)),
        ], types.stringLiteral(req))),
        resolveMap: types.objectExpression(requires.map((req, index) => types.objectProperty(types.stringLiteral(req), types.identifier(reqIds[index])))),
        cjsLoader: types.stringLiteral(mod_lo_builtin_mods_1.modLoBuiltinModCommonJsURL),
        code: originalProgram.body,
        exports: exportStatements,
        cjsMetaUrlExportName: types.identifier(cjsMetaUrlExportName),
    });
    path.node.directives = [];
    path.node.body = [];
    path.pushContainer('directives', program.directives);
    path.pushContainer('body', program.body);
}
const template = babel.template.program(dedent_1.default `
    %%deps%%
    import %%loaderVar%% from %%cjsLoader%%;
    %%declCjsExportVar%%
    %%declExportVars%%
    %%loaderVar%%.define(import.meta.url, function (exports, %%requireVar%%, module, __filename, __dirname) {
        let require = %%loaderVar%%.createRequireWithReqMap(%%resolveMap%%, %%requireVar%%);
        (function () {
            %%code%%
        })();
        %%cjsExportVar%% = module.exports;
        %%updateExportVars%%
    });
    export { %%cjsExportVar%% as default }
    %%exports%%
    export const %%cjsMetaUrlExportName%% = import.meta.url;
`);
async function getCjsInteropModuleSource(requestTarget) {
    return dedent_1.default `
        // I am the facade module who provides access to the CommonJS module '${requestTarget}'~
        import { ${cjsMetaUrlExportName} as req } from '${requestTarget}';
        import loader from '${mod_lo_builtin_mods_1.modLoBuiltinModCommonJsURL}';
        if (!req) {
            loader.throwInvalidWrapper('${requestTarget}', import.meta.url);
        }
        loader.require(req);
        export * from '${requestTarget}';
        import { default as d } from '${requestTarget}'
        export { d as default };
    `;
}
exports.getCjsInteropModuleSource = getCjsInteropModuleSource;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2QtYXNzZW1ibGluZy9tb2QtbG8vY2pzL3dyYXBwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG9EQUE0QjtBQUM1QixzRUFBMEU7QUFDMUUsbURBQXFDO0FBRXhCLFFBQUEsaUJBQWlCLEdBQUcsQ0FBQyxnREFBMEIsQ0FBVSxDQUFDO0FBRXZFLFNBQWdCLE9BQU8sQ0FDbkIsUUFBMkIsRUFDM0IsT0FBMEIsRUFDMUIsU0FBNEI7SUFFNUIsT0FBTyxDQUFDLE9BQXFCLEVBQW1CLEVBQUU7UUFDOUMsT0FBTztZQUNILE9BQU8sRUFBRTtnQkFDTCxPQUFPLEVBQUU7b0JBQ0wsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7d0JBQ1gsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDdEQsQ0FBQztpQkFDSjthQUNKO1NBQ0osQ0FBQztJQUNOLENBQUMsQ0FBQztBQUNOLENBQUM7QUFoQkQsMEJBZ0JDO0FBRUQsTUFBTSxvQkFBb0IsR0FBRyxjQUFjLENBQUM7QUFFNUM7O0dBRUc7QUFDSCxNQUFNLFdBQVcsR0FBRztJQUNoQixTQUFTO0lBQ1Qsb0JBQW9CO0NBQ3ZCLENBQUM7QUFFRixTQUFTLElBQUksQ0FDVCxFQUFFLEtBQUssRUFBZ0IsRUFDdkIsSUFBeUMsRUFDekMsUUFBMkIsRUFDM0IsT0FBMEIsRUFDMUIsU0FBNEI7SUFFNUIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztJQUNsQyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRXBFLE1B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OztLQUVoRCxDQUFDO0FBQ04sQ0FBQztBQWJELDhEQWFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlZGVudCBmcm9tICdkZWRlbnQnO1xuaW1wb3J0IHsgbW9kTG9CdWlsdGluTW9kQ29tbW9uSnNVUkwgfSBmcm9tICcuLi91dGlscy9tb2QtbG8tYnVpbHRpbi1tb2RzJztcbmltcG9ydCAqIGFzIGJhYmVsIGZyb20gJ0BiYWJlbC9jb3JlJztcblxuZXhwb3J0IGNvbnN0IGNqc1dyYXBwZXJJbXBvcnRzID0gW21vZExvQnVpbHRpbk1vZENvbW1vbkpzVVJMXSBhcyBjb25zdDtcblxuZXhwb3J0IGZ1bmN0aW9uIHdyYXBDanMoXG4gICAgcmVxdWlyZXM6IHJlYWRvbmx5IHN0cmluZ1tdLFxuICAgIGV4cG9ydHM6IHJlYWRvbmx5IHN0cmluZ1tdLFxuICAgIHJlZXhwb3J0czogcmVhZG9ubHkgc3RyaW5nW10sXG4pIHtcbiAgICByZXR1cm4gKGNvbnRleHQ6IHR5cGVvZiBiYWJlbCk6IGJhYmVsLlBsdWdpbk9iaiA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2aXNpdG9yOiB7XG4gICAgICAgICAgICAgICAgUHJvZ3JhbToge1xuICAgICAgICAgICAgICAgICAgICBleGl0OiAocGF0aCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgd3JhcChjb250ZXh0LCBwYXRoLCByZXF1aXJlcywgZXhwb3J0cywgcmVleHBvcnRzKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgIH07XG59XG5cbmNvbnN0IGNqc01ldGFVcmxFeHBvcnROYW1lID0gJ19fY2pzTWV0YVVSTCc7XG5cbi8qKlxuICog5Zyo5o6o5rWLIENvbW1vbkpTIOaooeWdl+eahOaJgOacieWRveWQjeWMluWvvOWHuuaXtui/h+a7pOaOiei/meS6m+OAglxuICovXG5jb25zdCByZXNlcnZlZElkcyA9IFtcbiAgICAnZGVmYXVsdCcsIC8vIGBkZWZhdWx0YCDmib/ovb3kuoYgYG1vZHVsZS5leHBvcnRzYFxuICAgIGNqc01ldGFVcmxFeHBvcnROYW1lLCAvLyDov5nkuKrmiJHku6znlKjmnaUgYHJlcXVpcmVgIOebruagh+aooeWdl1xuXTtcblxuZnVuY3Rpb24gd3JhcChcbiAgICB7IHR5cGVzIH06IHR5cGVvZiBiYWJlbCxcbiAgICBwYXRoOiBiYWJlbC5Ob2RlUGF0aDxiYWJlbC50eXBlcy5Qcm9ncmFtPixcbiAgICByZXF1aXJlczogcmVhZG9ubHkgc3RyaW5nW10sXG4gICAgZXhwb3J0czogcmVhZG9ubHkgc3RyaW5nW10sXG4gICAgcmVleHBvcnRzOiByZWFkb25seSBzdHJpbmdbXSxcbikge1xuICAgIGNvbnN0IG9yaWdpbmFsUHJvZ3JhbSA9IHBhdGgubm9kZTtcbiAgICBjb25zdCByZXFJZHMgPSByZXF1aXJlcy5tYXAoKHJlcSkgPT4gcGF0aC5zY29wZS5nZW5lcmF0ZVVpZCgncmVxJykpO1xuXG4gICAgY29uc3QgZmlsdGVyZWRFeHBvcnRzID0gZXhwb3J0cy5maWx0ZXIoKGV4cG9ydE5hbWUpID0+ICFyZXNlcnZlZElkcy5pbmNsdWRlcyhleHBvcnROYW1lKSk7XG5cbiAgICBsZXQgY2pzRXhwb3J0VmFySWQgPSBwYXRoLnNjb3BlLmdlbmVyYXRlVWlkKCdjanNFeHBvcnRzJyk7XG5cbiAgICBsZXQgZGVjbEV4cG9ydFZhcnM6IGJhYmVsLnR5cGVzLlN0YXRlbWVudFtdID0gW107XG4gICAgbGV0IHVwZGF0ZUV4cG9ydFZhcnM6IGJhYmVsLnR5cGVzLlN0YXRlbWVudFtdID0gW107XG4gICAgbGV0IGV4cG9ydFN0YXRlbWVudHM6IGJhYmVsLnR5cGVzLlN0YXRlbWVudFtdID0gW107XG5cbiAgICBpZiAoZmlsdGVyZWRFeHBvcnRzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICBjb25zdCBleHBvcnRWYXJzID0gZmlsdGVyZWRFeHBvcnRzLm1hcCgoZXhwb3J0TmFtZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFtleHBvcnROYW1lLCBwYXRoLnNjb3BlLmdlbmVyYXRlVWlkKGV4cG9ydE5hbWUpXTtcbiAgICAgICAgfSk7XG4gICAgXG4gICAgICAgIGRlY2xFeHBvcnRWYXJzID0gZXhwb3J0VmFycy5tYXAoKFssIGxvY2FsTmFtZV0pID0+XG4gICAgICAgICAgICB0eXBlcy52YXJpYWJsZURlY2xhcmF0aW9uKCdsZXQnLCBbdHlwZXMudmFyaWFibGVEZWNsYXJhdG9yKHR5cGVzLmlkZW50aWZpZXIobG9jYWxOYW1lKSldKSxcbiAgICAgICAgKTtcbiAgICBcbiAgICAgICAgdXBkYXRlRXhwb3J0VmFycyA9IGV4cG9ydFZhcnMubWFwKChbZXhwb3J0TmFtZSwgbG9jYWxOYW1lXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHR5cGVzLmV4cHJlc3Npb25TdGF0ZW1lbnQodHlwZXMuYXNzaWdubWVudEV4cHJlc3Npb24oXG4gICAgICAgICAgICAgICAgJz0nLFxuICAgICAgICAgICAgICAgIHR5cGVzLmlkZW50aWZpZXIobG9jYWxOYW1lKSxcbiAgICAgICAgICAgICAgICB0eXBlcy5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgICAgICAgICAgICAgICB0eXBlcy5tZW1iZXJFeHByZXNzaW9uKHR5cGVzLmlkZW50aWZpZXIoJ21vZHVsZScpLCB0eXBlcy5pZGVudGlmaWVyKCdleHBvcnRzJykpLFxuICAgICAgICAgICAgICAgICAgICB0eXBlcy5pZGVudGlmaWVyKGV4cG9ydE5hbWUpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfSk7XG4gICAgXG4gICAgICAgIGV4cG9ydFN0YXRlbWVudHMgPSBbdHlwZXMuZXhwb3J0TmFtZWREZWNsYXJhdGlvbihcbiAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGV4cG9ydFZhcnMubWFwKChbZXhwb3J0TmFtZSwgbG9jYWxOYW1lXSkgPT5cbiAgICAgICAgICAgICAgICB0eXBlcy5leHBvcnRTcGVjaWZpZXIodHlwZXMuaWRlbnRpZmllcihsb2NhbE5hbWUpLCB0eXBlcy5pZGVudGlmaWVyKGV4cG9ydE5hbWUpKSksXG4gICAgICAgICldO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBwcm9ncmFtID0gdGVtcGxhdGUoe1xuICAgICAgICBjanNFeHBvcnRWYXI6IHR5cGVzLmlkZW50aWZpZXIoY2pzRXhwb3J0VmFySWQpLFxuICAgICAgICBkZWNsQ2pzRXhwb3J0VmFyOiB0eXBlcy52YXJpYWJsZURlY2xhcmF0aW9uKCdsZXQnLFxuICAgICAgICAgICAgW3R5cGVzLnZhcmlhYmxlRGVjbGFyYXRvcih0eXBlcy5pZGVudGlmaWVyKGNqc0V4cG9ydFZhcklkKSldKSxcbiAgICAgICAgZGVjbEV4cG9ydFZhcnMsXG4gICAgICAgIHVwZGF0ZUV4cG9ydFZhcnMsXG4gICAgICAgIGxvYWRlclZhcjogcGF0aC5zY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoJ2xvYWRlcicpLFxuICAgICAgICByZXF1aXJlVmFyOiBwYXRoLnNjb3BlLmdlbmVyYXRlVWlkSWRlbnRpZmllcigncmVxdWlyZScpLFxuICAgICAgICBkZXBzOiByZXF1aXJlcy5tYXAoKHJlcSwgaW5kZXgpID0+IHR5cGVzLmltcG9ydERlY2xhcmF0aW9uKFtcbiAgICAgICAgICAgIHR5cGVzLmltcG9ydFNwZWNpZmllcih0eXBlcy5pZGVudGlmaWVyKHJlcUlkc1tpbmRleF0pLCB0eXBlcy5pZGVudGlmaWVyKGNqc01ldGFVcmxFeHBvcnROYW1lKSksXG4gICAgICAgIF0sIHR5cGVzLnN0cmluZ0xpdGVyYWwocmVxKSkpLFxuICAgICAgICByZXNvbHZlTWFwOiB0eXBlcy5vYmplY3RFeHByZXNzaW9uKHJlcXVpcmVzLm1hcCgocmVxLCBpbmRleCkgPT4gdHlwZXMub2JqZWN0UHJvcGVydHkoXG4gICAgICAgICAgICB0eXBlcy5zdHJpbmdMaXRlcmFsKHJlcSksXG4gICAgICAgICAgICB0eXBlcy5pZGVudGlmaWVyKHJlcUlkc1tpbmRleF0pLFxuICAgICAgICApKSksXG4gICAgICAgIGNqc0xvYWRlcjogdHlwZXMuc3RyaW5nTGl0ZXJhbChtb2RMb0J1aWx0aW5Nb2RDb21tb25Kc1VSTCksXG4gICAgICAgIGNvZGU6IG9yaWdpbmFsUHJvZ3JhbS5ib2R5LFxuICAgICAgICBleHBvcnRzOiBleHBvcnRTdGF0ZW1lbnRzLFxuICAgICAgICBjanNNZXRhVXJsRXhwb3J0TmFtZTogdHlwZXMuaWRlbnRpZmllcihjanNNZXRhVXJsRXhwb3J0TmFtZSksXG4gICAgfSk7XG4gICAgcGF0aC5ub2RlLmRpcmVjdGl2ZXMgPSBbXTtcbiAgICBwYXRoLm5vZGUuYm9keSA9IFtdO1xuICAgIHBhdGgucHVzaENvbnRhaW5lcignZGlyZWN0aXZlcycsIHByb2dyYW0uZGlyZWN0aXZlcyk7XG4gICAgcGF0aC5wdXNoQ29udGFpbmVyKCdib2R5JywgcHJvZ3JhbS5ib2R5KTtcbn1cblxuY29uc3QgdGVtcGxhdGUgPSBiYWJlbC50ZW1wbGF0ZS5wcm9ncmFtKGRlZGVudGBcbiAgICAlJWRlcHMlJVxuICAgIGltcG9ydCAlJWxvYWRlclZhciUlIGZyb20gJSVjanNMb2FkZXIlJTtcbiAgICAlJWRlY2xDanNFeHBvcnRWYXIlJVxuICAgICUlZGVjbEV4cG9ydFZhcnMlJVxuICAgICUlbG9hZGVyVmFyJSUuZGVmaW5lKGltcG9ydC5tZXRhLnVybCwgZnVuY3Rpb24gKGV4cG9ydHMsICUlcmVxdWlyZVZhciUlLCBtb2R1bGUsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSkge1xuICAgICAgICBsZXQgcmVxdWlyZSA9ICUlbG9hZGVyVmFyJSUuY3JlYXRlUmVxdWlyZVdpdGhSZXFNYXAoJSVyZXNvbHZlTWFwJSUsICUlcmVxdWlyZVZhciUlKTtcbiAgICAgICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICUlY29kZSUlXG4gICAgICAgIH0pKCk7XG4gICAgICAgICUlY2pzRXhwb3J0VmFyJSUgPSBtb2R1bGUuZXhwb3J0cztcbiAgICAgICAgJSV1cGRhdGVFeHBvcnRWYXJzJSVcbiAgICB9KTtcbiAgICBleHBvcnQgeyAlJWNqc0V4cG9ydFZhciUlIGFzIGRlZmF1bHQgfVxuICAgICUlZXhwb3J0cyUlXG4gICAgZXhwb3J0IGNvbnN0ICUlY2pzTWV0YVVybEV4cG9ydE5hbWUlJSA9IGltcG9ydC5tZXRhLnVybDtcbmApO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q2pzSW50ZXJvcE1vZHVsZVNvdXJjZShyZXF1ZXN0VGFyZ2V0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZGVkZW50YFxuICAgICAgICAvLyBJIGFtIHRoZSBmYWNhZGUgbW9kdWxlIHdobyBwcm92aWRlcyBhY2Nlc3MgdG8gdGhlIENvbW1vbkpTIG1vZHVsZSAnJHtyZXF1ZXN0VGFyZ2V0fSd+XG4gICAgICAgIGltcG9ydCB7ICR7Y2pzTWV0YVVybEV4cG9ydE5hbWV9IGFzIHJlcSB9IGZyb20gJyR7cmVxdWVzdFRhcmdldH0nO1xuICAgICAgICBpbXBvcnQgbG9hZGVyIGZyb20gJyR7bW9kTG9CdWlsdGluTW9kQ29tbW9uSnNVUkx9JztcbiAgICAgICAgaWYgKCFyZXEpIHtcbiAgICAgICAgICAgIGxvYWRlci50aHJvd0ludmFsaWRXcmFwcGVyKCcke3JlcXVlc3RUYXJnZXR9JywgaW1wb3J0Lm1ldGEudXJsKTtcbiAgICAgICAgfVxuICAgICAgICBsb2FkZXIucmVxdWlyZShyZXEpO1xuICAgICAgICBleHBvcnQgKiBmcm9tICcke3JlcXVlc3RUYXJnZXR9JztcbiAgICAgICAgaW1wb3J0IHsgZGVmYXVsdCBhcyBkIH0gZnJvbSAnJHtyZXF1ZXN0VGFyZ2V0fSdcbiAgICAgICAgZXhwb3J0IHsgZCBhcyBkZWZhdWx0IH07XG4gICAgYDtcbn1cbiJdfQ==