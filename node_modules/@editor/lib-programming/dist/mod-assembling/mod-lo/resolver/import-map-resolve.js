"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.importMapResolve = void 0;
const asserts_1 = require("../../../utils/asserts");
const url_1 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
/**
 * @param specifier
 * @param asURL
 * @param parentURL
 * @param importMap
 */
function importMapResolve(specifier, asURL, parentURL, importMap) {
    const normalizedSpecifier = asURL ? asURL.href : specifier;
    const topLevelImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, importMap.imports);
    if (topLevelImportsMatch) {
        return topLevelImportsMatch;
    }
    else {
        return undefined;
    }
}
exports.importMapResolve = importMapResolve;
function resolveImportsMatch(normalizedSpecifier, asURL, specifierMap) {
    for (const [specifierKey, resolutionResult] of specifierMap) {
        if (specifierKey === normalizedSpecifier) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            else {
                return resolutionResult;
            }
        }
        if (specifierKey.endsWith('/') &&
            normalizedSpecifier.startsWith(specifierKey) &&
            (asURL === null || isSpecialURL(asURL))) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            const afterPrefix = normalizedSpecifier.substr(specifierKey.length);
            asserts_1.asserts(resolutionResult.href.endsWith('/'));
            const url = url_1.tryParseURL(afterPrefix, resolutionResult);
            if (!url) {
                throw new resolve_error_1.ImportMapImportMatchError();
            }
            if (!url.href.startsWith(resolutionResult.href)) {
                throw new resolve_error_1.ImportMapBackTrackingError(specifierKey);
            }
            return url;
        }
    }
    return null;
}
function isSpecialURL(url) {
    // https://url.spec.whatwg.org/#is-special
    return [
        'ftp:',
        'file:',
        'http:',
        'https:',
        'ws:',
        'wss:',
    ].includes(url.protocol);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LW1hcC1yZXNvbHZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL21vZC1sby9yZXNvbHZlci9pbXBvcnQtbWFwLXJlc29sdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBQ2pELHlDQUE4QztBQUU5QyxtREFBaUg7QUFHakg7Ozs7O0dBS0c7QUFDSCxTQUFnQixnQkFBZ0IsQ0FDNUIsU0FBaUIsRUFBRSxLQUFpQixFQUFFLFNBQWMsRUFBRSxTQUEwQjtJQUNoRixNQUFNLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzNELE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRyxJQUFJLG9CQUFvQixFQUFFO1FBQ3RCLE9BQU8sb0JBQW9CLENBQUM7S0FDL0I7U0FBTTtRQUNILE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQVRELDRDQVNDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxtQkFBMkIsRUFBRSxLQUFpQixFQUFFLFlBQWdDO0lBQ3pHLEtBQUssTUFBTSxDQUFDLFlBQVksRUFBRSxnQkFBZ0IsQ0FBQyxJQUFJLFlBQVksRUFBRTtRQUN6RCxJQUFJLFlBQVksS0FBSyxtQkFBbUIsRUFBRTtZQUN0QyxJQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDM0IsTUFBTSxJQUFJLHVDQUF1QixFQUFFLENBQUM7YUFDdkM7aUJBQU07Z0JBQ0gsT0FBTyxnQkFBZ0IsQ0FBQzthQUMzQjtTQUNKO1FBQ0QsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUMxQixtQkFBbUIsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO1lBQzVDLENBQUMsS0FBSyxLQUFLLElBQUksSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsRUFDekM7WUFDRSxJQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDM0IsTUFBTSxJQUFJLHVDQUF1QixFQUFFLENBQUM7YUFDdkM7WUFDRCxNQUFNLFdBQVcsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BFLGlCQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sR0FBRyxHQUFHLGlCQUFXLENBQUMsV0FBVyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDTixNQUFNLElBQUkseUNBQXlCLEVBQUUsQ0FBQzthQUN6QztZQUNELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0MsTUFBTSxJQUFJLDBDQUEwQixDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ3REO1lBQ0QsT0FBTyxHQUFHLENBQUM7U0FDZDtLQUNKO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLEdBQVE7SUFDMUIsMENBQTBDO0lBQzFDLE9BQU87UUFDSCxNQUFNO1FBQ04sT0FBTztRQUNQLE9BQU87UUFDUCxRQUFRO1FBQ1IsS0FBSztRQUNMLE1BQU07S0FDVCxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9hc3NlcnRzJztcbmltcG9ydCB7IHRyeVBhcnNlVVJMIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXJsJztcbmltcG9ydCB7IFBhcnNlZFNwZWNpZmllck1hcCwgUGFyc2VkSW1wb3J0TWFwIH0gZnJvbSAnLi9wYXJzZWQtaW1wb3J0LW1hcCc7XG5pbXBvcnQgeyBJbXBvcnRNYXBCYWNrVHJhY2tpbmdFcnJvciwgSW1wb3J0TWFwSW1wb3J0TWF0Y2hFcnJvciwgSW1wb3J0TWFwTnVsbEVudHJ5RXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcblxuLyoqXG4gKiBAcGFyYW0gc3BlY2lmaWVyXG4gKiBAcGFyYW0gYXNVUkwgXG4gKiBAcGFyYW0gcGFyZW50VVJMIFxuICogQHBhcmFtIGltcG9ydE1hcCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydE1hcFJlc29sdmUoXG4gICAgc3BlY2lmaWVyOiBzdHJpbmcsIGFzVVJMOiBVUkwgfCBudWxsLCBwYXJlbnRVUkw6IFVSTCwgaW1wb3J0TWFwOiBQYXJzZWRJbXBvcnRNYXApIHtcbiAgICBjb25zdCBub3JtYWxpemVkU3BlY2lmaWVyID0gYXNVUkwgPyBhc1VSTC5ocmVmIDogc3BlY2lmaWVyO1xuICAgIGNvbnN0IHRvcExldmVsSW1wb3J0c01hdGNoID0gcmVzb2x2ZUltcG9ydHNNYXRjaChub3JtYWxpemVkU3BlY2lmaWVyLCBhc1VSTCwgaW1wb3J0TWFwLmltcG9ydHMpO1xuICAgIGlmICh0b3BMZXZlbEltcG9ydHNNYXRjaCkge1xuICAgICAgICByZXR1cm4gdG9wTGV2ZWxJbXBvcnRzTWF0Y2g7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbXBvcnRzTWF0Y2gobm9ybWFsaXplZFNwZWNpZmllcjogc3RyaW5nLCBhc1VSTDogVVJMIHwgbnVsbCwgc3BlY2lmaWVyTWFwOiBQYXJzZWRTcGVjaWZpZXJNYXApIHtcbiAgICBmb3IgKGNvbnN0IFtzcGVjaWZpZXJLZXksIHJlc29sdXRpb25SZXN1bHRdIG9mIHNwZWNpZmllck1hcCkge1xuICAgICAgICBpZiAoc3BlY2lmaWVyS2V5ID09PSBub3JtYWxpemVkU3BlY2lmaWVyKSB7XG4gICAgICAgICAgICBpZiAocmVzb2x1dGlvblJlc3VsdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBOdWxsRW50cnlFcnJvcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x1dGlvblJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc3BlY2lmaWVyS2V5LmVuZHNXaXRoKCcvJykgJiZcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRTcGVjaWZpZXIuc3RhcnRzV2l0aChzcGVjaWZpZXJLZXkpICYmXG4gICAgICAgICAgICAoYXNVUkwgPT09IG51bGwgfHwgaXNTcGVjaWFsVVJMKGFzVVJMKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAocmVzb2x1dGlvblJlc3VsdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBOdWxsRW50cnlFcnJvcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgYWZ0ZXJQcmVmaXggPSBub3JtYWxpemVkU3BlY2lmaWVyLnN1YnN0cihzcGVjaWZpZXJLZXkubGVuZ3RoKTtcbiAgICAgICAgICAgIGFzc2VydHMocmVzb2x1dGlvblJlc3VsdC5ocmVmLmVuZHNXaXRoKCcvJykpO1xuICAgICAgICAgICAgY29uc3QgdXJsID0gdHJ5UGFyc2VVUkwoYWZ0ZXJQcmVmaXgsIHJlc29sdXRpb25SZXN1bHQpO1xuICAgICAgICAgICAgaWYgKCF1cmwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW1wb3J0TWFwSW1wb3J0TWF0Y2hFcnJvcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF1cmwuaHJlZi5zdGFydHNXaXRoKHJlc29sdXRpb25SZXN1bHQuaHJlZikpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW1wb3J0TWFwQmFja1RyYWNraW5nRXJyb3Ioc3BlY2lmaWVyS2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1cmw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGlzU3BlY2lhbFVSTCh1cmw6IFVSTCk6IGJvb2xlYW4ge1xuICAgIC8vIGh0dHBzOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jaXMtc3BlY2lhbFxuICAgIHJldHVybiBbXG4gICAgICAgICdmdHA6JyxcbiAgICAgICAgJ2ZpbGU6JyxcbiAgICAgICAgJ2h0dHA6JyxcbiAgICAgICAgJ2h0dHBzOicsXG4gICAgICAgICd3czonLFxuICAgICAgICAnd3NzOicsXG4gICAgXS5pbmNsdWRlcyh1cmwucHJvdG9jb2wpO1xufVxuIl19