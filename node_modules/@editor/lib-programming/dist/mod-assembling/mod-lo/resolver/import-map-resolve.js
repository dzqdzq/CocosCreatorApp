"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.importMapResolve = void 0;
const asserts_1 = require("../../../utils/asserts");
const url_1 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
/**
 * @param specifier
 * @param asURL
 * @param parentURL
 * @param importMap
 */
function importMapResolve(specifier, asURL, parentURL, importMap) {
    const normalizedSpecifier = asURL ? asURL.href : specifier;
    const parentURLString = parentURL.href;
    for (const [scopePrefix, scopeImports] of importMap.scopes) {
        if (scopePrefix === parentURLString || scopePrefix.endsWith('/') && parentURLString.startsWith(scopePrefix)) {
            const scopeImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, scopeImports);
            if (scopeImportsMatch) {
                return scopeImportsMatch;
            }
        }
    }
    const topLevelImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, importMap.imports);
    if (topLevelImportsMatch) {
        return topLevelImportsMatch;
    }
    else {
        return undefined;
    }
}
exports.importMapResolve = importMapResolve;
function resolveImportsMatch(normalizedSpecifier, asURL, specifierMap) {
    for (const [specifierKey, resolutionResult] of specifierMap) {
        if (specifierKey === normalizedSpecifier) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            else {
                return resolutionResult;
            }
        }
        if (specifierKey.endsWith('/') &&
            normalizedSpecifier.startsWith(specifierKey) &&
            (asURL === null || isSpecialURL(asURL))) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            const afterPrefix = normalizedSpecifier.substr(specifierKey.length);
            asserts_1.asserts(resolutionResult.href.endsWith('/'));
            const url = url_1.tryParseURL(afterPrefix, resolutionResult);
            if (!url) {
                throw new resolve_error_1.ImportMapImportMatchError();
            }
            if (!url.href.startsWith(resolutionResult.href)) {
                throw new resolve_error_1.ImportMapBackTrackingError(specifierKey);
            }
            return url;
        }
    }
    return null;
}
function isSpecialURL(url) {
    // https://url.spec.whatwg.org/#is-special
    return [
        'ftp:',
        'file:',
        'http:',
        'https:',
        'ws:',
        'wss:',
        'db:',
    ].includes(url.protocol);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LW1hcC1yZXNvbHZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL21vZC1sby9yZXNvbHZlci9pbXBvcnQtbWFwLXJlc29sdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBQ2pELHlDQUE4QztBQUU5QyxtREFBaUg7QUFHakg7Ozs7O0dBS0c7QUFDSCxTQUFnQixnQkFBZ0IsQ0FDNUIsU0FBaUIsRUFBRSxLQUFpQixFQUFFLFNBQWMsRUFBRSxTQUEwQjtJQUNoRixNQUFNLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBRTNELE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7SUFDdkMsS0FBSyxNQUFNLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFDeEQsSUFBSSxXQUFXLEtBQUssZUFBZSxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksZUFBZSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN6RyxNQUFNLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztZQUN4RixJQUFJLGlCQUFpQixFQUFFO2dCQUNuQixPQUFPLGlCQUFpQixDQUFDO2FBQzVCO1NBQ0o7S0FDSjtJQUVELE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRyxJQUFJLG9CQUFvQixFQUFFO1FBQ3RCLE9BQU8sb0JBQW9CLENBQUM7S0FDL0I7U0FBTTtRQUNILE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQXBCRCw0Q0FvQkM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLG1CQUEyQixFQUFFLEtBQWlCLEVBQUUsWUFBZ0M7SUFDekcsS0FBSyxNQUFNLENBQUMsWUFBWSxFQUFFLGdCQUFnQixDQUFDLElBQUksWUFBWSxFQUFFO1FBQ3pELElBQUksWUFBWSxLQUFLLG1CQUFtQixFQUFFO1lBQ3RDLElBQUksZ0JBQWdCLEtBQUssSUFBSSxFQUFFO2dCQUMzQixNQUFNLElBQUksdUNBQXVCLEVBQUUsQ0FBQzthQUN2QztpQkFBTTtnQkFDSCxPQUFPLGdCQUFnQixDQUFDO2FBQzNCO1NBQ0o7UUFDRCxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQzFCLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFDNUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxJQUFJLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUN6QztZQUNFLElBQUksZ0JBQWdCLEtBQUssSUFBSSxFQUFFO2dCQUMzQixNQUFNLElBQUksdUNBQXVCLEVBQUUsQ0FBQzthQUN2QztZQUNELE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEUsaUJBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDN0MsTUFBTSxHQUFHLEdBQUcsaUJBQVcsQ0FBQyxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNOLE1BQU0sSUFBSSx5Q0FBeUIsRUFBRSxDQUFDO2FBQ3pDO1lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3QyxNQUFNLElBQUksMENBQTBCLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDdEQ7WUFDRCxPQUFPLEdBQUcsQ0FBQztTQUNkO0tBQ0o7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsR0FBUTtJQUMxQiwwQ0FBMEM7SUFDMUMsT0FBTztRQUNILE1BQU07UUFDTixPQUFPO1FBQ1AsT0FBTztRQUNQLFFBQVE7UUFDUixLQUFLO1FBQ0wsTUFBTTtRQUNOLEtBQUs7S0FDUixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9hc3NlcnRzJztcbmltcG9ydCB7IHRyeVBhcnNlVVJMIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXJsJztcbmltcG9ydCB7IFBhcnNlZFNwZWNpZmllck1hcCwgUGFyc2VkSW1wb3J0TWFwIH0gZnJvbSAnLi9wYXJzZWQtaW1wb3J0LW1hcCc7XG5pbXBvcnQgeyBJbXBvcnRNYXBCYWNrVHJhY2tpbmdFcnJvciwgSW1wb3J0TWFwSW1wb3J0TWF0Y2hFcnJvciwgSW1wb3J0TWFwTnVsbEVudHJ5RXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcblxuLyoqXG4gKiBAcGFyYW0gc3BlY2lmaWVyXG4gKiBAcGFyYW0gYXNVUkwgXG4gKiBAcGFyYW0gcGFyZW50VVJMIFxuICogQHBhcmFtIGltcG9ydE1hcCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydE1hcFJlc29sdmUoXG4gICAgc3BlY2lmaWVyOiBzdHJpbmcsIGFzVVJMOiBVUkwgfCBudWxsLCBwYXJlbnRVUkw6IFVSTCwgaW1wb3J0TWFwOiBQYXJzZWRJbXBvcnRNYXApIHtcbiAgICBjb25zdCBub3JtYWxpemVkU3BlY2lmaWVyID0gYXNVUkwgPyBhc1VSTC5ocmVmIDogc3BlY2lmaWVyO1xuXG4gICAgY29uc3QgcGFyZW50VVJMU3RyaW5nID0gcGFyZW50VVJMLmhyZWY7XG4gICAgZm9yIChjb25zdCBbc2NvcGVQcmVmaXgsIHNjb3BlSW1wb3J0c10gb2YgaW1wb3J0TWFwLnNjb3Blcykge1xuICAgICAgICBpZiAoc2NvcGVQcmVmaXggPT09IHBhcmVudFVSTFN0cmluZyB8fCBzY29wZVByZWZpeC5lbmRzV2l0aCgnLycpICYmIHBhcmVudFVSTFN0cmluZy5zdGFydHNXaXRoKHNjb3BlUHJlZml4KSkge1xuICAgICAgICAgICAgY29uc3Qgc2NvcGVJbXBvcnRzTWF0Y2ggPSByZXNvbHZlSW1wb3J0c01hdGNoKG5vcm1hbGl6ZWRTcGVjaWZpZXIsIGFzVVJMLCBzY29wZUltcG9ydHMpO1xuICAgICAgICAgICAgaWYgKHNjb3BlSW1wb3J0c01hdGNoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlSW1wb3J0c01hdGNoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdG9wTGV2ZWxJbXBvcnRzTWF0Y2ggPSByZXNvbHZlSW1wb3J0c01hdGNoKG5vcm1hbGl6ZWRTcGVjaWZpZXIsIGFzVVJMLCBpbXBvcnRNYXAuaW1wb3J0cyk7XG4gICAgaWYgKHRvcExldmVsSW1wb3J0c01hdGNoKSB7XG4gICAgICAgIHJldHVybiB0b3BMZXZlbEltcG9ydHNNYXRjaDtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcmVzb2x2ZUltcG9ydHNNYXRjaChub3JtYWxpemVkU3BlY2lmaWVyOiBzdHJpbmcsIGFzVVJMOiBVUkwgfCBudWxsLCBzcGVjaWZpZXJNYXA6IFBhcnNlZFNwZWNpZmllck1hcCkge1xuICAgIGZvciAoY29uc3QgW3NwZWNpZmllcktleSwgcmVzb2x1dGlvblJlc3VsdF0gb2Ygc3BlY2lmaWVyTWFwKSB7XG4gICAgICAgIGlmIChzcGVjaWZpZXJLZXkgPT09IG5vcm1hbGl6ZWRTcGVjaWZpZXIpIHtcbiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uUmVzdWx0ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcE51bGxFbnRyeUVycm9yKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHV0aW9uUmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzcGVjaWZpZXJLZXkuZW5kc1dpdGgoJy8nKSAmJlxuICAgICAgICAgICAgbm9ybWFsaXplZFNwZWNpZmllci5zdGFydHNXaXRoKHNwZWNpZmllcktleSkgJiZcbiAgICAgICAgICAgIChhc1VSTCA9PT0gbnVsbCB8fCBpc1NwZWNpYWxVUkwoYXNVUkwpKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uUmVzdWx0ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcE51bGxFbnRyeUVycm9yKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBhZnRlclByZWZpeCA9IG5vcm1hbGl6ZWRTcGVjaWZpZXIuc3Vic3RyKHNwZWNpZmllcktleS5sZW5ndGgpO1xuICAgICAgICAgICAgYXNzZXJ0cyhyZXNvbHV0aW9uUmVzdWx0LmhyZWYuZW5kc1dpdGgoJy8nKSk7XG4gICAgICAgICAgICBjb25zdCB1cmwgPSB0cnlQYXJzZVVSTChhZnRlclByZWZpeCwgcmVzb2x1dGlvblJlc3VsdCk7XG4gICAgICAgICAgICBpZiAoIXVybCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBJbXBvcnRNYXRjaEVycm9yKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXVybC5ocmVmLnN0YXJ0c1dpdGgocmVzb2x1dGlvblJlc3VsdC5ocmVmKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBCYWNrVHJhY2tpbmdFcnJvcihzcGVjaWZpZXJLZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVybDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gaXNTcGVjaWFsVVJMKHVybDogVVJMKTogYm9vbGVhbiB7XG4gICAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNpcy1zcGVjaWFsXG4gICAgcmV0dXJuIFtcbiAgICAgICAgJ2Z0cDonLFxuICAgICAgICAnZmlsZTonLFxuICAgICAgICAnaHR0cDonLFxuICAgICAgICAnaHR0cHM6JyxcbiAgICAgICAgJ3dzOicsXG4gICAgICAgICd3c3M6JyxcbiAgICAgICAgJ2RiOicsXG4gICAgXS5pbmNsdWRlcyh1cmwucHJvdG9jb2wpO1xufVxuIl19