"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.importMapResolve = void 0;
const asserts_1 = require("../../../utils/asserts");
const url_1 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
/**
 * @param specifier
 * @param asURL
 * @param parentURL
 * @param importMap
 */
function importMapResolve(specifier, asURL, parentURL, importMap) {
    const normalizedSpecifier = asURL ? asURL.href : specifier;
    const parentURLString = parentURL.href;
    for (const [scopePrefix, scopeImports] of importMap.scopes) {
        if (scopePrefix === parentURLString || scopePrefix.endsWith('/') && parentURLString.startsWith(scopePrefix)) {
            const scopeImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, scopeImports);
            if (scopeImportsMatch) {
                return scopeImportsMatch;
            }
        }
    }
    const topLevelImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, importMap.imports);
    if (topLevelImportsMatch) {
        return topLevelImportsMatch;
    }
    else {
        return undefined;
    }
}
exports.importMapResolve = importMapResolve;
function resolveImportsMatch(normalizedSpecifier, asURL, specifierMap) {
    for (const [specifierKey, resolutionResult] of specifierMap) {
        if (specifierKey === normalizedSpecifier) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            else {
                return resolutionResult;
            }
        }
        if (specifierKey.endsWith('/') &&
            normalizedSpecifier.startsWith(specifierKey) &&
            (asURL === null || isSpecialURL(asURL))) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            const afterPrefix = normalizedSpecifier.substr(specifierKey.length);
            asserts_1.asserts(resolutionResult.href.endsWith('/'));
            const url = url_1.tryParseURL(afterPrefix, resolutionResult);
            if (!url) {
                throw new resolve_error_1.ImportMapImportMatchError();
            }
            if (!url.href.startsWith(resolutionResult.href)) {
                throw new resolve_error_1.ImportMapBackTrackingError(specifierKey);
            }
            return url;
        }
    }
    return null;
}
function isSpecialURL(url) {
    // https://url.spec.whatwg.org/#is-special
    return [
        'ftp:',
        'file:',
        'http:',
        'https:',
        'ws:',
        'wss:',
        'db:',
    ].includes(url.protocol);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LW1hcC1yZXNvbHZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL21vZC1sby9yZXNvbHZlci9pbXBvcnQtbWFwLXJlc29sdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBQ2pELHlDQUE4QztBQUU5QyxtREFBaUg7QUFHakg7Ozs7O0dBS0c7QUFDSCxTQUFnQixnQkFBZ0IsQ0FDNUIsU0FBaUIsRUFBRSxLQUFpQixFQUFFLFNBQWMsRUFBRSxTQUEwQjtJQUNoRixNQUFNLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBRTNELE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7SUFDdkMsS0FBSyxNQUFNLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFDeEQsSUFBSSxXQUFXLEtBQUssZUFBZSxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksZUFBZSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN6RyxNQUFNLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztZQUN4RixJQUFJLGlCQUFpQixFQUFFO2dCQUNuQixPQUFPLGlCQUFpQixDQUFDO2FBQzVCO1NBQ0o7S0FDSjtJQUVELE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRyxJQUFJLG9CQUFvQixFQUFFO1FBQ3RCLE9BQU8sb0JBQW9CLENBQUM7S0FDL0I7U0FBTTtRQUNILE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQXBCRCw0Q0FvQkM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLG1CQUEyQixFQUFFLEtBQWlCLEVBQUUsWUFBZ0M7SUFDekcsS0FBSyxNQUFNLENBQUMsWUFBWSxFQUFFLGdCQUFnQixDQUFDLElBQUksWUFBWSxFQUFFO1FBQ3pELElBQUksWUFBWSxLQUFLLG1CQUFtQixFQUFFO1lBQ3RDLElBQUksZ0JBQWdCLEtBQUssSUFBSSxFQUFFO2dCQUMzQixNQUFNLElBQUksdUNBQXVCLEVBQUUsQ0FBQzthQUN2QztpQkFBTTtnQkFDSCxPQUFPLGdCQUFnQixDQUFDO2FBQzNCO1NBQ0o7UUFDRCxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQzFCLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFDNUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxJQUFJLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUN6QztZQUNFLElBQUksZ0JBQWdCLEtBQUssSUFBSSxFQUFFO2dCQUMzQixNQUFNLElBQUksdUNBQXVCLEVBQUUsQ0FBQzthQUN2QztZQUNELE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEUsaUJBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDN0MsTUFBTSxHQUFHLEdBQUcsaUJBQVcsQ0FBQyxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNOLE1BQU0sSUFBSSx5Q0FBeUIsRUFBRSxDQUFDO2FBQ3pDO1lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3QyxNQUFNLElBQUksMENBQTBCLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDdEQ7WUFDRCxPQUFPLEdBQUcsQ0FBQztTQUNkO0tBQ0o7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsR0FBUTtJQUMxQiwwQ0FBMEM7SUFDMUMsT0FBTztRQUNILE1BQU07UUFDTixPQUFPO1FBQ1AsT0FBTztRQUNQLFFBQVE7UUFDUixLQUFLO1FBQ0wsTUFBTTtRQUNOLEtBQUs7S0FDUixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9hc3NlcnRzJztcclxuaW1wb3J0IHsgdHJ5UGFyc2VVUkwgfSBmcm9tICcuLi8uLi91dGlscy91cmwnO1xyXG5pbXBvcnQgeyBQYXJzZWRTcGVjaWZpZXJNYXAsIFBhcnNlZEltcG9ydE1hcCB9IGZyb20gJy4vcGFyc2VkLWltcG9ydC1tYXAnO1xyXG5pbXBvcnQgeyBJbXBvcnRNYXBCYWNrVHJhY2tpbmdFcnJvciwgSW1wb3J0TWFwSW1wb3J0TWF0Y2hFcnJvciwgSW1wb3J0TWFwTnVsbEVudHJ5RXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xyXG5pbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xyXG5cclxuLyoqXHJcbiAqIEBwYXJhbSBzcGVjaWZpZXJcclxuICogQHBhcmFtIGFzVVJMIFxyXG4gKiBAcGFyYW0gcGFyZW50VVJMIFxyXG4gKiBAcGFyYW0gaW1wb3J0TWFwIFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydE1hcFJlc29sdmUoXHJcbiAgICBzcGVjaWZpZXI6IHN0cmluZywgYXNVUkw6IFVSTCB8IG51bGwsIHBhcmVudFVSTDogVVJMLCBpbXBvcnRNYXA6IFBhcnNlZEltcG9ydE1hcCkge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZFNwZWNpZmllciA9IGFzVVJMID8gYXNVUkwuaHJlZiA6IHNwZWNpZmllcjtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRVUkxTdHJpbmcgPSBwYXJlbnRVUkwuaHJlZjtcclxuICAgIGZvciAoY29uc3QgW3Njb3BlUHJlZml4LCBzY29wZUltcG9ydHNdIG9mIGltcG9ydE1hcC5zY29wZXMpIHtcclxuICAgICAgICBpZiAoc2NvcGVQcmVmaXggPT09IHBhcmVudFVSTFN0cmluZyB8fCBzY29wZVByZWZpeC5lbmRzV2l0aCgnLycpICYmIHBhcmVudFVSTFN0cmluZy5zdGFydHNXaXRoKHNjb3BlUHJlZml4KSkge1xyXG4gICAgICAgICAgICBjb25zdCBzY29wZUltcG9ydHNNYXRjaCA9IHJlc29sdmVJbXBvcnRzTWF0Y2gobm9ybWFsaXplZFNwZWNpZmllciwgYXNVUkwsIHNjb3BlSW1wb3J0cyk7XHJcbiAgICAgICAgICAgIGlmIChzY29wZUltcG9ydHNNYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlSW1wb3J0c01hdGNoO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRvcExldmVsSW1wb3J0c01hdGNoID0gcmVzb2x2ZUltcG9ydHNNYXRjaChub3JtYWxpemVkU3BlY2lmaWVyLCBhc1VSTCwgaW1wb3J0TWFwLmltcG9ydHMpO1xyXG4gICAgaWYgKHRvcExldmVsSW1wb3J0c01hdGNoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRvcExldmVsSW1wb3J0c01hdGNoO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXNvbHZlSW1wb3J0c01hdGNoKG5vcm1hbGl6ZWRTcGVjaWZpZXI6IHN0cmluZywgYXNVUkw6IFVSTCB8IG51bGwsIHNwZWNpZmllck1hcDogUGFyc2VkU3BlY2lmaWVyTWFwKSB7XHJcbiAgICBmb3IgKGNvbnN0IFtzcGVjaWZpZXJLZXksIHJlc29sdXRpb25SZXN1bHRdIG9mIHNwZWNpZmllck1hcCkge1xyXG4gICAgICAgIGlmIChzcGVjaWZpZXJLZXkgPT09IG5vcm1hbGl6ZWRTcGVjaWZpZXIpIHtcclxuICAgICAgICAgICAgaWYgKHJlc29sdXRpb25SZXN1bHQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBOdWxsRW50cnlFcnJvcigpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdXRpb25SZXN1bHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNwZWNpZmllcktleS5lbmRzV2l0aCgnLycpICYmXHJcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRTcGVjaWZpZXIuc3RhcnRzV2l0aChzcGVjaWZpZXJLZXkpICYmXHJcbiAgICAgICAgICAgIChhc1VSTCA9PT0gbnVsbCB8fCBpc1NwZWNpYWxVUkwoYXNVUkwpKVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICBpZiAocmVzb2x1dGlvblJlc3VsdCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcE51bGxFbnRyeUVycm9yKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgYWZ0ZXJQcmVmaXggPSBub3JtYWxpemVkU3BlY2lmaWVyLnN1YnN0cihzcGVjaWZpZXJLZXkubGVuZ3RoKTtcclxuICAgICAgICAgICAgYXNzZXJ0cyhyZXNvbHV0aW9uUmVzdWx0LmhyZWYuZW5kc1dpdGgoJy8nKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IHRyeVBhcnNlVVJMKGFmdGVyUHJlZml4LCByZXNvbHV0aW9uUmVzdWx0KTtcclxuICAgICAgICAgICAgaWYgKCF1cmwpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBJbXBvcnRNYXRjaEVycm9yKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCF1cmwuaHJlZi5zdGFydHNXaXRoKHJlc29sdXRpb25SZXN1bHQuaHJlZikpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBCYWNrVHJhY2tpbmdFcnJvcihzcGVjaWZpZXJLZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB1cmw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzU3BlY2lhbFVSTCh1cmw6IFVSTCk6IGJvb2xlYW4ge1xyXG4gICAgLy8gaHR0cHM6Ly91cmwuc3BlYy53aGF0d2cub3JnLyNpcy1zcGVjaWFsXHJcbiAgICByZXR1cm4gW1xyXG4gICAgICAgICdmdHA6JyxcclxuICAgICAgICAnZmlsZTonLFxyXG4gICAgICAgICdodHRwOicsXHJcbiAgICAgICAgJ2h0dHBzOicsXHJcbiAgICAgICAgJ3dzOicsXHJcbiAgICAgICAgJ3dzczonLFxyXG4gICAgICAgICdkYjonLFxyXG4gICAgXS5pbmNsdWRlcyh1cmwucHJvdG9jb2wpO1xyXG59XHJcbiJdfQ==