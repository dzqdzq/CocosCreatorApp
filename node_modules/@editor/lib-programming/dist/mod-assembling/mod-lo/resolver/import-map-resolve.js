"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.importMapResolve = void 0;
const asserts_1 = require("../../../utils/asserts");
const url_1 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
/**
 * @param specifier
 * @param asURL
 * @param parentURL
 * @param importMap
 */
function importMapResolve(specifier, asURL, parentURL, importMap) {
    const normalizedSpecifier = asURL ? asURL.href : specifier;
    const topLevelImportsMatch = resolveImportsMatch(normalizedSpecifier, asURL, importMap.imports);
    if (topLevelImportsMatch) {
        return topLevelImportsMatch;
    }
    else {
        return undefined;
    }
}
exports.importMapResolve = importMapResolve;
function resolveImportsMatch(normalizedSpecifier, asURL, specifierMap) {
    for (const [specifierKey, resolutionResult] of specifierMap) {
        if (specifierKey === normalizedSpecifier) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            else {
                return resolutionResult;
            }
        }
        if (specifierKey.endsWith('/') &&
            normalizedSpecifier.startsWith(specifierKey) &&
            (asURL === null || isSpecialURL(asURL))) {
            if (resolutionResult === null) {
                throw new resolve_error_1.ImportMapNullEntryError();
            }
            const afterPrefix = normalizedSpecifier.substr(specifierKey.length);
            asserts_1.asserts(resolutionResult.href.endsWith('/'));
            const url = url_1.tryParseURL(afterPrefix, resolutionResult);
            if (!url) {
                throw new resolve_error_1.ImportMapImportMatchError();
            }
            if (!url.href.startsWith(resolutionResult.href)) {
                throw new resolve_error_1.ImportMapBackTrackingError(specifierKey);
            }
            return url;
        }
    }
    return null;
}
function isSpecialURL(url) {
    // https://url.spec.whatwg.org/#is-special
    return [
        'ftp:',
        'file:',
        'http:',
        'https:',
        'ws:',
        'wss:',
        'db:',
    ].includes(url.protocol);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LW1hcC1yZXNvbHZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZC1hc3NlbWJsaW5nL21vZC1sby9yZXNvbHZlci9pbXBvcnQtbWFwLXJlc29sdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWlEO0FBQ2pELHlDQUE4QztBQUU5QyxtREFBaUg7QUFHakg7Ozs7O0dBS0c7QUFDSCxTQUFnQixnQkFBZ0IsQ0FDNUIsU0FBaUIsRUFBRSxLQUFpQixFQUFFLFNBQWMsRUFBRSxTQUEwQjtJQUNoRixNQUFNLG1CQUFtQixHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzNELE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRyxJQUFJLG9CQUFvQixFQUFFO1FBQ3RCLE9BQU8sb0JBQW9CLENBQUM7S0FDL0I7U0FBTTtRQUNILE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQVRELDRDQVNDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxtQkFBMkIsRUFBRSxLQUFpQixFQUFFLFlBQWdDO0lBQ3pHLEtBQUssTUFBTSxDQUFDLFlBQVksRUFBRSxnQkFBZ0IsQ0FBQyxJQUFJLFlBQVksRUFBRTtRQUN6RCxJQUFJLFlBQVksS0FBSyxtQkFBbUIsRUFBRTtZQUN0QyxJQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDM0IsTUFBTSxJQUFJLHVDQUF1QixFQUFFLENBQUM7YUFDdkM7aUJBQU07Z0JBQ0gsT0FBTyxnQkFBZ0IsQ0FBQzthQUMzQjtTQUNKO1FBQ0QsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUMxQixtQkFBbUIsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO1lBQzVDLENBQUMsS0FBSyxLQUFLLElBQUksSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsRUFDekM7WUFDRSxJQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDM0IsTUFBTSxJQUFJLHVDQUF1QixFQUFFLENBQUM7YUFDdkM7WUFDRCxNQUFNLFdBQVcsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BFLGlCQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sR0FBRyxHQUFHLGlCQUFXLENBQUMsV0FBVyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDTixNQUFNLElBQUkseUNBQXlCLEVBQUUsQ0FBQzthQUN6QztZQUNELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0MsTUFBTSxJQUFJLDBDQUEwQixDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ3REO1lBQ0QsT0FBTyxHQUFHLENBQUM7U0FDZDtLQUNKO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLEdBQVE7SUFDMUIsMENBQTBDO0lBQzFDLE9BQU87UUFDSCxNQUFNO1FBQ04sT0FBTztRQUNQLE9BQU87UUFDUCxRQUFRO1FBQ1IsS0FBSztRQUNMLE1BQU07UUFDTixLQUFLO0tBQ1IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXNzZXJ0cyc7XG5pbXBvcnQgeyB0cnlQYXJzZVVSTCB9IGZyb20gJy4uLy4uL3V0aWxzL3VybCc7XG5pbXBvcnQgeyBQYXJzZWRTcGVjaWZpZXJNYXAsIFBhcnNlZEltcG9ydE1hcCB9IGZyb20gJy4vcGFyc2VkLWltcG9ydC1tYXAnO1xuaW1wb3J0IHsgSW1wb3J0TWFwQmFja1RyYWNraW5nRXJyb3IsIEltcG9ydE1hcEltcG9ydE1hdGNoRXJyb3IsIEltcG9ydE1hcE51bGxFbnRyeUVycm9yIH0gZnJvbSAnLi9yZXNvbHZlLWVycm9yJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5cbi8qKlxuICogQHBhcmFtIHNwZWNpZmllclxuICogQHBhcmFtIGFzVVJMIFxuICogQHBhcmFtIHBhcmVudFVSTCBcbiAqIEBwYXJhbSBpbXBvcnRNYXAgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbXBvcnRNYXBSZXNvbHZlKFxuICAgIHNwZWNpZmllcjogc3RyaW5nLCBhc1VSTDogVVJMIHwgbnVsbCwgcGFyZW50VVJMOiBVUkwsIGltcG9ydE1hcDogUGFyc2VkSW1wb3J0TWFwKSB7XG4gICAgY29uc3Qgbm9ybWFsaXplZFNwZWNpZmllciA9IGFzVVJMID8gYXNVUkwuaHJlZiA6IHNwZWNpZmllcjtcbiAgICBjb25zdCB0b3BMZXZlbEltcG9ydHNNYXRjaCA9IHJlc29sdmVJbXBvcnRzTWF0Y2gobm9ybWFsaXplZFNwZWNpZmllciwgYXNVUkwsIGltcG9ydE1hcC5pbXBvcnRzKTtcbiAgICBpZiAodG9wTGV2ZWxJbXBvcnRzTWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIHRvcExldmVsSW1wb3J0c01hdGNoO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZXNvbHZlSW1wb3J0c01hdGNoKG5vcm1hbGl6ZWRTcGVjaWZpZXI6IHN0cmluZywgYXNVUkw6IFVSTCB8IG51bGwsIHNwZWNpZmllck1hcDogUGFyc2VkU3BlY2lmaWVyTWFwKSB7XG4gICAgZm9yIChjb25zdCBbc3BlY2lmaWVyS2V5LCByZXNvbHV0aW9uUmVzdWx0XSBvZiBzcGVjaWZpZXJNYXApIHtcbiAgICAgICAgaWYgKHNwZWNpZmllcktleSA9PT0gbm9ybWFsaXplZFNwZWNpZmllcikge1xuICAgICAgICAgICAgaWYgKHJlc29sdXRpb25SZXN1bHQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW1wb3J0TWFwTnVsbEVudHJ5RXJyb3IoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdXRpb25SZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNwZWNpZmllcktleS5lbmRzV2l0aCgnLycpICYmXG4gICAgICAgICAgICBub3JtYWxpemVkU3BlY2lmaWVyLnN0YXJ0c1dpdGgoc3BlY2lmaWVyS2V5KSAmJlxuICAgICAgICAgICAgKGFzVVJMID09PSBudWxsIHx8IGlzU3BlY2lhbFVSTChhc1VSTCkpXG4gICAgICAgICkge1xuICAgICAgICAgICAgaWYgKHJlc29sdXRpb25SZXN1bHQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW1wb3J0TWFwTnVsbEVudHJ5RXJyb3IoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGFmdGVyUHJlZml4ID0gbm9ybWFsaXplZFNwZWNpZmllci5zdWJzdHIoc3BlY2lmaWVyS2V5Lmxlbmd0aCk7XG4gICAgICAgICAgICBhc3NlcnRzKHJlc29sdXRpb25SZXN1bHQuaHJlZi5lbmRzV2l0aCgnLycpKTtcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IHRyeVBhcnNlVVJMKGFmdGVyUHJlZml4LCByZXNvbHV0aW9uUmVzdWx0KTtcbiAgICAgICAgICAgIGlmICghdXJsKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcEltcG9ydE1hdGNoRXJyb3IoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdXJsLmhyZWYuc3RhcnRzV2l0aChyZXNvbHV0aW9uUmVzdWx0LmhyZWYpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcEJhY2tUcmFja2luZ0Vycm9yKHNwZWNpZmllcktleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdXJsO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBpc1NwZWNpYWxVUkwodXJsOiBVUkwpOiBib29sZWFuIHtcbiAgICAvLyBodHRwczovL3VybC5zcGVjLndoYXR3Zy5vcmcvI2lzLXNwZWNpYWxcbiAgICByZXR1cm4gW1xuICAgICAgICAnZnRwOicsXG4gICAgICAgICdmaWxlOicsXG4gICAgICAgICdodHRwOicsXG4gICAgICAgICdodHRwczonLFxuICAgICAgICAnd3M6JyxcbiAgICAgICAgJ3dzczonLFxuICAgICAgICAnZGI6JyxcbiAgICBdLmluY2x1ZGVzKHVybC5wcm90b2NvbCk7XG59XG4iXX0=