"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseImportMap = void 0;
const url_1 = require("url");
const resolve_error_1 = require("./resolve-error");
function parseImportMap(json, baseUrl) {
    if (typeof json !== 'object') {
        throw new resolve_error_1.ImportMapParseError(`The top-level value needs to be a JSON object.`);
    }
    const parsed = { imports: [], scopes: [] };
    let nValidKeys = 0;
    if (('imports' in json)) {
        ++nValidKeys;
        const imports = json.imports;
        if (typeof imports !== 'object') {
            throw new resolve_error_1.ImportMapParseError(`The "imports" top-level key needs to be a JSON object.`);
        }
        parsed.imports = sortAndNormalizeSpecifierMap(imports, baseUrl);
    }
    if (('scopes' in json)) {
        ++nValidKeys;
        const scopes = json.scopes;
        if (typeof scopes !== 'object') {
            throw new resolve_error_1.ImportMapParseError(`The "scopes" top-level key needs to be a JSON object.`);
        }
        parsed.scopes = sortAndNormalizeScopes(scopes, baseUrl);
    }
    for (const key of Object.keys(json)) {
        if (key !== 'imports' && key !== 'scopes') {
            console.warn(`An invalid top-level key ${key} was present in the import map.`);
        }
    }
    return parsed;
}
exports.parseImportMap = parseImportMap;
function sortAndNormalizeSpecifierMap(originalMap, baseUrl) {
    const normalized = [];
    for (const specifierKey in originalMap) {
        const normalizedSpecifierKey = normalizeSpecifierKey(specifierKey, baseUrl);
        if (normalizedSpecifierKey === null) {
            continue;
        }
        const value = originalMap[specifierKey];
        if (typeof value !== 'string') {
            console.warn(`The address need to be strings.`);
            normalized.push([normalizedSpecifierKey, null]);
            continue;
        }
        const addressUrl = parseUrlLikeImportSpecifier(value, baseUrl);
        if (addressUrl === null) {
            console.warn(`The address was invalid.`);
            normalized.push([normalizedSpecifierKey, null]);
            continue;
        }
        if (specifierKey.endsWith('/') && !serializeUrl(addressUrl).endsWith('/')) {
            console.warn(`an invalid address was given for the specifier key ${specifierKey}; ` +
                `since ${specifierKey} ended in a slash, the address needs to as well.`);
            normalized.push([normalizedSpecifierKey, null]);
            continue;
        }
        normalized.push([normalizedSpecifierKey, addressUrl]);
    }
    sortMap(normalized);
    return normalized;
}
function sortAndNormalizeScopes(originalMap, baseUrl) {
    const normalized = [];
    for (const scopePrefix in originalMap) {
        const potentialSpecifierMap = originalMap[scopePrefix];
        if (typeof potentialSpecifierMap !== 'object') {
            throw new resolve_error_1.ImportMapParseError(`The value of the scope with prefix ${scopePrefix} needs to be a JSON object.`);
        }
        const scopePrefixUrl = parseUrl(scopePrefix, baseUrl);
        if (!scopePrefixUrl) {
            console.warn(`The scope prefix URL ${scopePrefixUrl} was not parsable.`);
            continue;
        }
        const normalizedScopePrefix = serializeUrl(scopePrefixUrl);
        normalized.push([
            normalizedScopePrefix,
            sortAndNormalizeSpecifierMap(potentialSpecifierMap, baseUrl),
        ]);
    }
    sortMapReverse(normalized);
    return normalized;
}
function sortMap(map) {
    return map.sort(([a], [b]) => a > b ? 1 : (a < b ? -1 : 0));
}
function sortMapReverse(map) {
    return map.sort(([b], [a]) => a > b ? 1 : (a < b ? -1 : 0));
}
function normalizeSpecifierKey(key, baseUrl) {
    if (key.length === 0) {
        console.warn(`Specifier keys cannot be the empty string.`);
        return null;
    }
    const url = parseUrlLikeImportSpecifier(key, baseUrl);
    if (url) {
        return serializeUrl(url);
    }
    return key;
}
function parseUrlLikeImportSpecifier(specifier, baseUrl) {
    if (specifier.startsWith('/') ||
        specifier.startsWith('./') ||
        specifier.startsWith('../')) {
        return parseUrl(specifier, baseUrl);
    }
    return parseUrl(specifier);
}
function parseUrl(url, base) {
    try {
        return new url_1.URL(url, base);
    }
    catch (_a) {
        return null;
    }
}
function serializeUrl(url) {
    return url.href;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2UtaW1wb3J0LW1hcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2QtYXNzZW1ibGluZy9tb2QtbG8vcmVzb2x2ZXIvcGFyc2UtaW1wb3J0LW1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBMEI7QUFFMUIsbURBQXNEO0FBRXRELFNBQWdCLGNBQWMsQ0FBQyxJQUFTLEVBQUUsT0FBWTtJQUNsRCxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtRQUMxQixNQUFNLElBQUksbUNBQW1CLENBQUMsZ0RBQWdELENBQUMsQ0FBQztLQUNuRjtJQUNELE1BQU0sTUFBTSxHQUFvQixFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQzVELElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztJQUNuQixJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxFQUFFO1FBQ3JCLEVBQUUsVUFBVSxDQUFDO1FBQ2IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUM3QixJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsRUFBRTtZQUM3QixNQUFNLElBQUksbUNBQW1CLENBQUMsd0RBQXdELENBQUMsQ0FBQztTQUMzRjtRQUNELE1BQU0sQ0FBQyxPQUFPLEdBQUcsNEJBQTRCLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ25FO0lBQ0QsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsRUFBRTtRQUNwQixFQUFFLFVBQVUsQ0FBQztRQUNiLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDM0IsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDNUIsTUFBTSxJQUFJLG1DQUFtQixDQUFDLHVEQUF1RCxDQUFDLENBQUM7U0FDMUY7UUFDRCxNQUFNLENBQUMsTUFBTSxHQUFHLHNCQUFzQixDQUFDLE1B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QUMsU0FBaUIsRUFBRSxPQUFZO0lBQ2hFLElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFDekIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7UUFDMUIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUM3QixPQUFPLFFBQVEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDdkM7SUFDRCxPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsR0FBVyxFQUFFLElBQVU7SUFDckMsSUFBSTtRQUNBLE9BQU8sSUFBSSxTQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQzdCO0lBQUMsV0FBTTtRQUNKLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7QUFDTCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsR0FBUTtJQUMxQixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCB7IFBhcnNlZEltcG9ydE1hcCwgUGFyc2VkU2NvcGVNYXAsIFBhcnNlZFNwZWNpZmllck1hcCB9IGZyb20gJy4vcGFyc2VkLWltcG9ydC1tYXAnO1xyXG5pbXBvcnQgeyBJbXBvcnRNYXBQYXJzZUVycm9yIH0gZnJvbSAnLi9yZXNvbHZlLWVycm9yJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUltcG9ydE1hcChqc29uOiBhbnksIGJhc2VVcmw6IFVSTCkge1xyXG4gICAgaWYgKHR5cGVvZiBqc29uICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIHRocm93IG5ldyBJbXBvcnRNYXBQYXJzZUVycm9yKGBUaGUgdG9wLWxldmVsIHZhbHVlIG5lZWRzIHRvIGJlIGEgSlNPTiBvYmplY3QuYCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJzZWQ6IFBhcnNlZEltcG9ydE1hcCA9IHsgaW1wb3J0czogW10sIHNjb3BlczogW10gfTtcclxuICAgIGxldCBuVmFsaWRLZXlzID0gMDtcclxuICAgIGlmICgoJ2ltcG9ydHMnIGluIGpzb24pKSB7XHJcbiAgICAgICAgKytuVmFsaWRLZXlzO1xyXG4gICAgICAgIGNvbnN0IGltcG9ydHMgPSBqc29uLmltcG9ydHM7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBpbXBvcnRzICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgSW1wb3J0TWFwUGFyc2VFcnJvcihgVGhlIFwiaW1wb3J0c1wiIHRvcC1sZXZlbCBrZXkgbmVlZHMgdG8gYmUgYSBKU09OIG9iamVjdC5gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyc2VkLmltcG9ydHMgPSBzb3J0QW5kTm9ybWFsaXplU3BlY2lmaWVyTWFwKGltcG9ydHMsIGJhc2VVcmwpO1xyXG4gICAgfVxyXG4gICAgaWYgKCgnc2NvcGVzJyBpbiBqc29uKSkge1xyXG4gICAgICAgICsrblZhbGlkS2V5cztcclxuICAgICAgICBjb25zdCBzY29wZXMgPSBqc29uLnNjb3BlcztcclxuICAgICAgICBpZiAodHlwZW9mIHNjb3BlcyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcFBhcnNlRXJyb3IoYFRoZSBcInNjb3Blc1wiIHRvcC1sZXZlbCBrZXkgbmVlZHMgdG8gYmUgYSBKU09OIG9iamVjdC5gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyc2VkLnNjb3BlcyA9IHNvcnRBbmROb3JtYWxpemVTY29wZXMoc2NvcGVzLCBiYXNlVXJsKTtcclxuICAgIH1cclxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGpzb24pKSB7XHJcbiAgICAgICAgaWYgKGtleSAhPT0gJ2ltcG9ydHMnICYmIGtleSAhPT0gJ3Njb3BlcycpIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGBBbiBpbnZhbGlkIHRvcC1sZXZlbCBrZXkgJHtrZXl9IHdhcyBwcmVzZW50IGluIHRoZSBpbXBvcnQgbWFwLmApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwYXJzZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNvcnRBbmROb3JtYWxpemVTcGVjaWZpZXJNYXAob3JpZ2luYWxNYXA6IFJlY29yZDxzdHJpbmcsIGFueT4sIGJhc2VVcmw6IFVSTCkge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZDogUGFyc2VkU3BlY2lmaWVyTWFwID0gW107XHJcbiAgICBmb3IgKGNvbnN0IHNwZWNpZmllcktleSBpbiBvcmlnaW5hbE1hcCkge1xyXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRTcGVjaWZpZXJLZXkgPSBub3JtYWxpemVTcGVjaWZpZXJLZXkoc3BlY2lmaWVyS2V5LCBiYXNlVXJsKTtcclxuICAgICAgICBpZiAobm9ybWFsaXplZFNwZWNpZmllcktleSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBvcmlnaW5hbE1hcFtzcGVjaWZpZXJLZXldO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgVGhlIGFkZHJlc3MgbmVlZCB0byBiZSBzdHJpbmdzLmApO1xyXG4gICAgICAgICAgICBub3JtYWxpemVkLnB1c2goW25vcm1hbGl6ZWRTcGVjaWZpZXJLZXksIG51bGxdKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGFkZHJlc3NVcmwgPSBwYXJzZVVybExpa2VJbXBvcnRTcGVjaWZpZXIodmFsdWUsIGJhc2VVcmwpO1xyXG4gICAgICAgIGlmIChhZGRyZXNzVXJsID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgVGhlIGFkZHJlc3Mgd2FzIGludmFsaWQuYCk7XHJcbiAgICAgICAgICAgIG5vcm1hbGl6ZWQucHVzaChbbm9ybWFsaXplZFNwZWNpZmllcktleSwgbnVsbF0pO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNwZWNpZmllcktleS5lbmRzV2l0aCgnLycpICYmICFzZXJpYWxpemVVcmwoYWRkcmVzc1VybCkuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgICBgYW4gaW52YWxpZCBhZGRyZXNzIHdhcyBnaXZlbiBmb3IgdGhlIHNwZWNpZmllciBrZXkgJHtzcGVjaWZpZXJLZXl9OyBgICtcclxuICAgICAgICAgICAgICAgIGBzaW5jZSAke3NwZWNpZmllcktleX0gZW5kZWQgaW4gYSBzbGFzaCwgdGhlIGFkZHJlc3MgbmVlZHMgdG8gYXMgd2VsbC5gKTtcclxuICAgICAgICAgICAgbm9ybWFsaXplZC5wdXNoKFtub3JtYWxpemVkU3BlY2lmaWVyS2V5LCBudWxsXSk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBub3JtYWxpemVkLnB1c2goW25vcm1hbGl6ZWRTcGVjaWZpZXJLZXksIGFkZHJlc3NVcmxdKTtcclxuICAgIH1cclxuICAgIHNvcnRNYXAobm9ybWFsaXplZCk7XHJcbiAgICByZXR1cm4gbm9ybWFsaXplZDtcclxufVxyXG5cclxuZnVuY3Rpb24gc29ydEFuZE5vcm1hbGl6ZVNjb3BlcyhvcmlnaW5hbE1hcDogUmVjb3JkPHN0cmluZywgYW55PiwgYmFzZVVybDogVVJMKSB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkOiBQYXJzZWRTY29wZU1hcCA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBzY29wZVByZWZpeCBpbiBvcmlnaW5hbE1hcCkge1xyXG4gICAgICAgIGNvbnN0IHBvdGVudGlhbFNwZWNpZmllck1hcCA9IG9yaWdpbmFsTWFwW3Njb3BlUHJlZml4XTtcclxuICAgICAgICBpZiAodHlwZW9mIHBvdGVudGlhbFNwZWNpZmllck1hcCAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEltcG9ydE1hcFBhcnNlRXJyb3IoYFRoZSB2YWx1ZSBvZiB0aGUgc2NvcGUgd2l0aCBwcmVmaXggJHtzY29wZVByZWZpeH0gbmVlZHMgdG8gYmUgYSBKU09OIG9iamVjdC5gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2NvcGVQcmVmaXhVcmwgPSBwYXJzZVVybChzY29wZVByZWZpeCwgYmFzZVVybCk7XHJcbiAgICAgICAgaWYgKCFzY29wZVByZWZpeFVybCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFRoZSBzY29wZSBwcmVmaXggVVJMICR7c2NvcGVQcmVmaXhVcmx9IHdhcyBub3QgcGFyc2FibGUuYCk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBub3JtYWxpemVkU2NvcGVQcmVmaXggPSBzZXJpYWxpemVVcmwoc2NvcGVQcmVmaXhVcmwpO1xyXG4gICAgICAgIG5vcm1hbGl6ZWQucHVzaChbXHJcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRTY29wZVByZWZpeCxcclxuICAgICAgICAgICAgc29ydEFuZE5vcm1hbGl6ZVNwZWNpZmllck1hcChwb3RlbnRpYWxTcGVjaWZpZXJNYXAsIGJhc2VVcmwpLFxyXG4gICAgICAgIF0pO1xyXG4gICAgfVxyXG4gICAgc29ydE1hcFJldmVyc2Uobm9ybWFsaXplZCk7XHJcbiAgICByZXR1cm4gbm9ybWFsaXplZDtcclxufVxyXG5cclxuZnVuY3Rpb24gc29ydE1hcDxUPihtYXA6IFtzdHJpbmcsIFRdW10pIHtcclxuICAgIHJldHVybiBtYXAuc29ydCgoW2FdLCBbYl0pID0+IGEgPiBiID8gMSA6IChhIDwgYiA/IC0xIDogMCkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzb3J0TWFwUmV2ZXJzZTxUPihtYXA6IFtzdHJpbmcsIFRdW10pIHtcclxuICAgIHJldHVybiBtYXAuc29ydCgoW2JdLCBbYV0pID0+IGEgPiBiID8gMSA6IChhIDwgYiA/IC0xIDogMCkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBub3JtYWxpemVTcGVjaWZpZXJLZXkoa2V5OiBzdHJpbmcsIGJhc2VVcmw6IFVSTCk6IHN0cmluZyB8IG51bGwge1xyXG4gICAgaWYgKGtleS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYFNwZWNpZmllciBrZXlzIGNhbm5vdCBiZSB0aGUgZW1wdHkgc3RyaW5nLmApO1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdXJsID0gcGFyc2VVcmxMaWtlSW1wb3J0U3BlY2lmaWVyKGtleSwgYmFzZVVybCk7XHJcbiAgICBpZiAodXJsKSB7XHJcbiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZVVybCh1cmwpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGtleTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VVcmxMaWtlSW1wb3J0U3BlY2lmaWVyKHNwZWNpZmllcjogc3RyaW5nLCBiYXNlVXJsOiBVUkwpOiBVUkwgfCBudWxsIHtcclxuICAgIGlmIChzcGVjaWZpZXIuc3RhcnRzV2l0aCgnLycpIHx8XHJcbiAgICAgICAgc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJy4vJykgfHxcclxuICAgICAgICBzcGVjaWZpZXIuc3RhcnRzV2l0aCgnLi4vJykpIHtcclxuICAgICAgICByZXR1cm4gcGFyc2VVcmwoc3BlY2lmaWVyLCBiYXNlVXJsKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXJzZVVybChzcGVjaWZpZXIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVVybCh1cmw6IHN0cmluZywgYmFzZT86IFVSTCk6IFVSTCB8IG51bGwge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICByZXR1cm4gbmV3IFVSTCh1cmwsIGJhc2UpO1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNlcmlhbGl6ZVVybCh1cmw6IFVSTCkge1xyXG4gICAgcmV0dXJuIHVybC5ocmVmO1xyXG59XHJcbiJdfQ==