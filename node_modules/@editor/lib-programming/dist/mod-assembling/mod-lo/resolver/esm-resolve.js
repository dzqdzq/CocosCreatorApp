"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.readPackageScope = exports.defaultLegacyMainResolveExtensions = exports.defaultConditions = exports.esmResolve = void 0;
const url_1 = require("url");
const specifier_1 = require("../../utils/specifier");
const url_2 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
const fs_extra_1 = __importDefault(require("fs-extra"));
const import_map_resolve_1 = require("./import-map-resolve");
/**
 * Reference:
 * https://nodejs.org/api/esm.html#esm_resolver_algorithm
 * Modification:
 * - Import map are considered.
 */
async function esmResolve(specifier, parentURL, options) {
    var _a;
    const { conditions = exports.defaultConditions, legacyMainResolveExtensions = exports.defaultLegacyMainResolveExtensions, importMap, } = options !== null && options !== void 0 ? options : {};
    const context = {
        conditions,
        legacyMainResolveExtensions,
    };
    let asURL;
    if (specifier_1.isRelativeSpecifier(specifier)) {
        asURL = new url_1.URL(specifier, parentURL);
    }
    else {
        asURL = (_a = url_2.tryParseURL(specifier)) !== null && _a !== void 0 ? _a : null;
    }
    if (importMap) {
        const importMapResolved = import_map_resolve_1.importMapResolve(specifier, asURL, parentURL, importMap);
        if (importMapResolved) {
            return importMapResolved;
        }
    }
    if (asURL) {
        return asURL;
    }
    if (specifier.startsWith('#')) {
        return await packageImportsResolve(specifier, parentURL, context);
    }
    return await packageResolve(specifier, parentURL, context);
}
exports.esmResolve = esmResolve;
exports.defaultConditions = ['import'];
exports.defaultLegacyMainResolveExtensions = ['.js', '.json'];
async function packageImportsResolve(_specifier, _parentURL, _context) {
    throw new Error(`We currently do not support package 'imports' field.`);
}
async function packageResolve(specifier, parentURL, context) {
    const { packageName, isScoped } = parsePackageName(specifier);
    const packageSubpath = `.${specifier.substr(packageName.length)}`;
    // Package self resolve
    const selfURL = await packageSelfResolve(packageName, packageSubpath, parentURL, context);
    if (selfURL !== undefined) {
        return selfURL;
    }
    if (packageSubpath === '.' && isNodeJsBuiltinModule(packageName)) {
        return new url_1.URL(`node:${specifier}`);
    }
    const onlyFilePackages = true;
    let packageJsonUrl = new url_1.URL(`./node_modules/${packageName}/package.json`, parentURL);
    let lastPackJsonPathname = '';
    while (true) {
        if (onlyFilePackages && !url_2.hasFileProtocol(packageJsonUrl)) {
            break;
        }
        if (packageJsonUrl.pathname === lastPackJsonPathname) {
            break;
        }
        lastPackJsonPathname = packageJsonUrl.pathname;
        if (!await dirExists(new url_1.URL('..', packageJsonUrl))) {
            packageJsonUrl = new url_1.URL(`${isScoped ? '../../../../' : '../../../'}node_modules/${packageName}/package.json`, packageJsonUrl);
            continue;
        }
        const packageJson = await readPackageJson(packageJsonUrl);
        if (!packageJson) {
            continue;
        }
        if (packageJson !== null && !isNullOrUndefined(packageJson.exports)) {
            return await packageExportsResolve(packageJsonUrl, packageSubpath, packageJson.exports, context, parentURL);
        }
        else if (packageSubpath === '.') {
            return await legacyMainResolve(packageJsonUrl, packageJson, context);
        }
        else {
            const resolved = new url_1.URL(packageSubpath, packageJsonUrl);
            return resolved;
        }
    }
    throw new resolve_error_1.ModuleNotFoundError(specifier, parentURL);
}
function parsePackageName(specifier) {
    let packageName;
    let isScoped = false;
    if (specifier.length === 0) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    const iFirstSlash = specifier.indexOf('/');
    if (!specifier.startsWith('@')) {
        packageName = iFirstSlash < 0
            ? specifier
            : specifier.substr(0, iFirstSlash);
    }
    else {
        if (iFirstSlash < 0) {
            throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
        }
        else {
            isScoped = true;
            const iSecondSlash = specifier.indexOf('/', iFirstSlash + 1);
            packageName = iSecondSlash < 0 ? specifier : specifier.substr(0, iSecondSlash);
        }
    }
    let isValid = true;
    if (packageName.startsWith('.')) {
        isValid = false;
    }
    for (let i = 0; i < packageName.length; i++) {
        if (packageName[i] === '%' || packageName[i] === '\\') {
            isValid = false;
            break;
        }
    }
    if (!isValid) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    return { packageName, isScoped };
}
async function packageSelfResolve(packageName, packageSubpath, parentURL, context) {
    const packageJson = await readPackageScope(parentURL);
    if (packageJson === null || isNullOrUndefined(packageJson.exports)) {
        return undefined;
    }
    if (packageName === packageJson.name) {
        return await packageExportsResolve(packageJson.url, packageSubpath, packageJson.exports, context, parentURL);
    }
    return undefined;
}
async function readPackageScope(url) {
    let packageJsonURL = new url_1.URL('./package.json', url);
    while (true) {
        if (packageJsonURL.pathname.endsWith('node_modules/package.json')) {
            break;
        }
        const packageJson = await readPackageJson(packageJsonURL);
        if (packageJson !== null) {
            return packageJson;
        }
        const lastPackageJsonPathname = packageJsonURL.pathname;
        packageJsonURL = new url_1.URL('../package.json', packageJsonURL);
        if (packageJsonURL.pathname === lastPackageJsonPathname) {
            break;
        }
    }
    return null;
}
exports.readPackageScope = readPackageScope;
function isNullOrUndefined(v) {
    return v === null || v === undefined;
}
async function readPackageJson(url) {
    if (!url_2.hasFileProtocol(url)) {
        return null;
    }
    let source;
    try {
        const path = url_1.fileURLToPath(url);
        source = await fs_extra_1.default.readFile(path, 'utf8');
    }
    catch (_a) {
        return null;
    }
    let json;
    try {
        json = JSON.parse(source);
    }
    catch (err) {
        throw new resolve_error_1.InvalidPackageConfigurationError(err);
    }
    const { main, name, type, imports, exports } = json;
    const normalized = {
        url,
        name: typeof name === 'string' ? name : undefined,
        type: type === 'module' || type === 'commonjs' ? type : undefined,
        main: typeof main === 'string' ? main : undefined,
        imports: typeof imports !== 'object' || imports === null ? undefined : imports,
        exports,
    };
    return normalized;
}
async function packageExportsResolve(packageJsonURL, subpath, exports, context, parentURL) {
    let prefixedWithDot;
    if (typeof exports === 'object' && exports !== null) {
        const keys = Object.keys(exports);
        if (keys.length !== 0) {
            prefixedWithDot = keys[0].startsWith('.');
            if (!keys.every((key) => key.startsWith('.') === prefixedWithDot)) {
                throw new resolve_error_1.InvalidPackageConfigurationError(packageJsonURL);
            }
        }
    }
    if (subpath === '.') {
        const mainExport = typeof exports === 'string' || Array.isArray(exports) || prefixedWithDot === false
            ? exports
            : prefixedWithDot === true ? exports['.'] : undefined;
        if (mainExport !== undefined) {
            const resolved = await packageTargetResolve(packageJsonURL, mainExport, '', false, false, context);
            if (!isNullOrUndefined(resolved)) {
                return resolved;
            }
        }
    }
    else if (prefixedWithDot === true) {
        const matchKey = subpath;
        const resolvedMatch = await packageImportsExportsResolve(matchKey, exports, packageJsonURL, false, context);
        if (!isNullOrUndefined(resolvedMatch.resolved)) {
            return resolvedMatch.resolved;
        }
    }
    throw new resolve_error_1.PackagePathNotExportedError(subpath, packageJsonURL);
}
async function packageImportsExportsResolve(matchKey, matchObj, packageURL, isImports, context) {
    if (!matchKey.endsWith('*') && Object.prototype.hasOwnProperty.call(matchObj, matchKey)) {
        const target = matchObj[matchKey];
        const resolved = await packageTargetResolve(packageURL, target, '', false, isImports, context);
        return {
            resolved,
            exact: true,
        };
    }
    const keys = Object.getOwnPropertyNames(matchObj).sort((a, b) => a.length - b.length);
    for (const expansionKey of keys) {
        if (!(expansionKey.endsWith('/') || expansionKey.endsWith('*'))) {
            continue;
        }
        if (expansionKey.endsWith('*') &&
            matchKey.startsWith(expansionKey) &&
            matchKey !== expansionKey) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length - 1);
            const resolved = await packageTargetResolve(packageURL, target, subpath, true, isImports, context);
            return { resolved, exact: true };
        }
        if (matchKey.startsWith(expansionKey)) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length);
            const resolved = await packageTargetResolve(packageURL, target, subpath, false, isImports, context);
            return { resolved, exact: false };
        }
    }
    return { resolved: null, exact: true };
}
async function packageTargetResolve(packageURL, target, subpath, pattern, internal, context) {
    if (typeof target === 'string') {
        return await resolvePackageTargetString(packageURL, target, subpath, pattern, internal, context);
    }
    if (Array.isArray(target)) {
        return await resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context);
    }
    if (typeof target === 'object' && target !== null) {
        return await resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context);
    }
    if (target === null) {
        return null;
    }
    throw new resolve_error_1.InvalidPackageTargetError(packageURL);
}
async function resolvePackageTargetString(packageJsonURL, target, subpath, pattern, internal, context) {
    if (!pattern && subpath.length !== 0 && !target.endsWith('/')) {
        throw new resolve_error_1.InvalidModuleSpecifierError(target);
    }
    if (!target.startsWith('./')) {
        if (internal && !target.startsWith('../') && !target.startsWith('/') && !url_2.tryParseURL(target)) {
            const exportTarget = pattern
                ? applyPattern(target, subpath)
                : target + subpath;
            return await packageResolve(exportTarget, packageJsonURL, context);
        }
        else {
            throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
        }
    }
    // Note: `target` starts with './' now
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(target.substr(2))) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    const resolved = new url_1.URL(target, packageJsonURL);
    const packagePath = new url_1.URL('.', packageJsonURL);
    if (!resolved.pathname.startsWith(packagePath.pathname)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    if (subpath === '') {
        return resolved;
    }
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(subpath)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    return pattern
        ? new url_1.URL(applyPattern(resolved.href, subpath))
        : new url_1.URL(subpath, resolved);
}
async function resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context) {
    const keys = Object.getOwnPropertyNames(target);
    if (keys.some(isArrayIndex)) {
        throw new resolve_error_1.InvalidPackageConfigurationError(packageURL);
    }
    for (const key of keys) {
        if (key === 'default' || context.conditions.includes(key)) {
            const targetValue = target[key];
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else {
                return resolved;
            }
        }
    }
    return undefined;
}
async function resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context) {
    if (target.length === 0) {
        return null;
    }
    let lastErr;
    for (const targetValue of target) {
        try {
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else if (resolved === null) {
                lastErr = null;
                continue;
            }
            return resolved;
        }
        catch (err) {
            //  continuing the loop on any Invalid Package Target error.
            if (err instanceof resolve_error_1.InvalidPackageTargetError) {
                lastErr = err;
                continue;
            }
            else {
                throw err;
            }
        }
    }
    if (isNullOrUndefined(lastErr)) {
        return lastErr;
    }
    else {
        throw lastErr;
    }
}
function applyPattern(s, replacer) {
    return s.replace(/\*/g, replacer);
}
// Match path segment
const dotOrDotDotOrNodeModulesSegmentRegex = /(^|\\|\/)(\.\.?|node_modules)(\\|\/|$)/;
function isArrayIndex(s) {
    const keyNum = +s;
    if (`${keyNum}` !== s) {
        return false;
    }
    return keyNum >= 0 && keyNum < 4294967295;
}
async function legacyMainResolve(packageJsonUrl, packageJson, context) {
    let guess;
    if (packageJson.main !== undefined) {
        // Note: fs check redundances will be handled by Descriptor cache here.
        if (await fileExists(guess = new url_1.URL(`./${packageJson.main}`, packageJsonUrl))) {
            return guess;
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}/index${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        // Fallthrough.
    }
    for (const extension of context.legacyMainResolveExtensions) {
        if (await fileExists(guess = new url_1.URL(`./index${extension}`, packageJsonUrl))) {
            return guess;
        }
    }
    // Not found.
    throw new resolve_error_1.ModuleNotFoundError('<main>', new url_1.URL('.', packageJsonUrl));
}
async function fileExists(url) {
    return (await tryStat(url)).isFile();
}
async function dirExists(url) {
    return (await tryStat(url)).isDirectory();
}
async function tryStat(url) {
    try {
        const path = url_1.fileURLToPath(url);
        return await fs_extra_1.default.stat(path);
    }
    catch (_a) {
        return new fs_extra_1.default.Stats();
    }
}
function isNodeJsBuiltinModule(packageName) {
    return [
        'assert',
        'buffer',
        'child_process',
        'cluster',
        'crypto',
        'dgram',
        'dns',
        'domain',
        'events',
        'fs',
        'http',
        'https',
        'net',
        'os',
        'path',
        'punycode',
        'querystring',
        'readline',
        'stream',
        'string_decoder',
        'timers',
        'tls',
        'tty',
        'url',
        'util',
        'v8',
        'vm',
        'zlib',
    ].includes(packageName);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNtLXJlc29sdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvbW9kLWxvL3Jlc29sdmVyL2VzbS1yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLDZCQUF3RDtBQUN4RCxxREFBNEQ7QUFDNUQseUNBQStEO0FBQy9ELG1EQUE4TTtBQUM5TSx3REFBMEI7QUFHMUIsNkRBQXdEO0FBRXhEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLFVBQVUsQ0FBQyxTQUFpQixFQUFFLFNBQWMsRUFBRSxPQUluRTs7SUFDRyxNQUFNLEVBQ0YsVUFBVSxHQUFHLHlCQUFpQixFQUM5QiwyQkFBMkIsR0FBRywwQ0FBa0MsRUFDaEUsU0FBUyxHQUNaLEdBQUcsT0FBTyxhQUFQLE9BQU8sY0FBUCxPQUFPLEdBQUksRUFBRSxDQUFDO0lBRWxCLE1BQU0sT0FBTyxHQUFtQjtRQUM1QixVQUFVO1FBQ1YsMkJBQTJCO0tBQzlCLENBQUM7SUFFRixJQUFJLEtBQWlCLENBQUM7SUFDdEIsSUFBSSwrQkFBbUIsQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUNoQyxLQUFLLEdBQUcsSUFBSSxTQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ3pDO1NBQU07UUFDSCxLQUFLLFNBQUcsaUJBQVcsQ0FBQyxTQUFTLENBQUMsbUNBQUksSUFBSSxDQUFDO0tBQzFDO0lBRUQsSUFBSSxTQUFTLEVBQUU7UUFDWCxNQUFNLGlCQUFpQixHQUFHLHFDQUFnQixDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ25GLElBQUksaUJBQWlCLEVBQUU7WUFDbkIsT0FBTyxpQkFBaUIsQ0FBQztTQUM1QjtLQUNKO0lBRUQsSUFBSSxLQUFLLEVBQUU7UUFDUCxPQUFPLEtBQUssQ0FBQztLQUNoQjtJQUVELElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENB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TUFBTSxrQkFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUM5QjtJQUFDLFdBQU07UUFDSixPQUFPLElBQUksa0JBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztLQUN6QjtBQUNMLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLFdBQW1CO0lBQzlDLE9BQU87UUFDSCxRQUFRO1FBQ1IsUUFBUTtRQUNSLGVBQWU7UUFDZixTQUFTO1FBQ1QsUUFBUTtRQUNSLE9BQU87UUFDUCxLQUFLO1FBQ0wsUUFBUTtRQUNSLFFBQVE7UUFDUixJQUFJO1FBQ0osTUFBTTtRQUNOLE9BQU87UUFDUCxLQUFLO1FBQ0wsSUFBSTtRQUNKLE1BQU07UUFDTixVQUFVO1FBQ1YsYUFBYTtRQUNiLFVBQVU7UUFDVixRQUFRO1FBQ1IsZ0JBQWdCO1FBQ2hCLFFBQVE7UUFDUixLQUFLO1FBQ0wsS0FBSztRQUNMLEtBQUs7UUFDTCxNQUFNO1FBQ04sSUFBSTtRQUNKLElBQUk7UUFDSixNQUFNO0tBQ1QsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgVVJMLCBmaWxlVVJMVG9QYXRoLCBwYXRoVG9GaWxlVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IGlzUmVsYXRpdmVTcGVjaWZpZXIgfSBmcm9tICcuLi8uLi91dGlscy9zcGVjaWZpZXInO1xuaW1wb3J0IHsgaGFzRmlsZVByb3RvY29sLCB0cnlQYXJzZVVSTCB9IGZyb20gJy4uLy4uL3V0aWxzL3VybCc7XG5pbXBvcnQgeyBJbnZhbGlkTW9kdWxlU3BlY2lmaWVyRXJyb3IsIEludmFsaWRQYWNrYWdlQ29uZmlndXJhdGlvbkVycm9yLCBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yLCBNb2R1bGVOb3RGb3VuZEVycm9yLCBQYWNrYWdlUGF0aE5vdEV4cG9ydGVkRXJyb3IsIFVuc3VwcG9ydGVkRGlyZWN0b3J5SW1wb3J0RXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBhcnNlZEltcG9ydE1hcCB9IGZyb20gJy4vcGFyc2VkLWltcG9ydC1tYXAnO1xuaW1wb3J0IHsgaW1wb3J0TWFwUmVzb2x2ZSB9IGZyb20gJy4vaW1wb3J0LW1hcC1yZXNvbHZlJztcblxuLyoqXG4gKiBSZWZlcmVuY2U6XG4gKiBodHRwczovL25vZGVqcy5vcmcvYXBpL2VzbS5odG1sI2VzbV9yZXNvbHZlcl9hbGdvcml0aG1cbiAqIE1vZGlmaWNhdGlvbjpcbiAqIC0gSW1wb3J0IG1hcCBhcmUgY29uc2lkZXJlZC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVzbVJlc29sdmUoc3BlY2lmaWVyOiBzdHJpbmcsIHBhcmVudFVSTDogVVJMLCBvcHRpb25zPzoge1xuICAgIGltcG9ydE1hcD86IFBhcnNlZEltcG9ydE1hcDtcbiAgICBjb25kaXRpb25zPzogQ29uZGl0aW9ucztcbiAgICBsZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnM/OiBzdHJpbmdbXTtcbn0pOiBQcm9taXNlPFVSTD4ge1xuICAgIGNvbnN0IHtcbiAgICAgICAgY29uZGl0aW9ucyA9IGRlZmF1bHRDb25kaXRpb25zLFxuICAgICAgICBsZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMgPSBkZWZhdWx0TGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxuICAgICAgICBpbXBvcnRNYXAsXG4gICAgfSA9IG9wdGlvbnMgPz8ge307XG5cbiAgICBjb25zdCBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCA9IHtcbiAgICAgICAgY29uZGl0aW9ucyxcbiAgICAgICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxuICAgIH07XG5cbiAgICBsZXQgYXNVUkw6IFVSTCB8IG51bGw7XG4gICAgaWYgKGlzUmVsYXRpdmVTcGVjaWZpZXIoc3BlY2lmaWVyKSkge1xuICAgICAgICBhc1VSTCA9IG5ldyBVUkwoc3BlY2lmaWVyLCBwYXJlbnRVUkwpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGFzVVJMID0gdHJ5UGFyc2VVUkwoc3BlY2lmaWVyKSA/PyBudWxsO1xuICAgIH1cblxuICAgIGlmIChpbXBvcnRNYXApIHtcbiAgICAgICAgY29uc3QgaW1wb3J0TWFwUmVzb2x2ZWQgPSBpbXBvcnRNYXBSZXNvbHZlKHNwZWNpZmllciwgYXNVUkwsIHBhcmVudFVSTCwgaW1wb3J0TWFwKTtcbiAgICAgICAgaWYgKGltcG9ydE1hcFJlc29sdmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gaW1wb3J0TWFwUmVzb2x2ZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoYXNVUkwpIHtcbiAgICAgICAgcmV0dXJuIGFzVVJMO1xuICAgIH1cblxuICAgIGlmIChzcGVjaWZpZXIuc3RhcnRzV2l0aCgnIycpKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBwYWNrYWdlSW1wb3J0c1Jlc29sdmUoc3BlY2lmaWVyLCBwYXJlbnRVUkwsIGNvbnRleHQpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBwYWNrYWdlUmVzb2x2ZShzcGVjaWZpZXIsIHBhcmVudFVSTCwgY29udGV4dCk7XG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0Q29uZGl0aW9uczogcmVhZG9ubHkgc3RyaW5nW10gPSBbJ2ltcG9ydCddO1xuXG50eXBlIENvbmRpdGlvbnMgPSByZWFkb25seSBzdHJpbmdbXTtcblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRMZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMgPSBbJy5qcycsICcuanNvbiddIGFzIGNvbnN0IGFzIHJlYWRvbmx5IHN0cmluZ1tdO1xuXG5pbnRlcmZhY2UgUmVzb2x2ZUNvbnRleHQge1xuICAgIGNvbmRpdGlvbnM6IENvbmRpdGlvbnM7XG4gICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zOiByZWFkb25seSBzdHJpbmdbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFja2FnZUltcG9ydHNSZXNvbHZlKF9zcGVjaWZpZXI6IHN0cmluZywgX3BhcmVudFVSTDogVVJMLCBfY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTD4ge1xuICAgIHRocm93IG5ldyBFcnJvcihgV2UgY3VycmVudGx5IGRvIG5vdCBzdXBwb3J0IHBhY2thZ2UgJ2ltcG9ydHMnIGZpZWxkLmApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlUmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgcGFyZW50VVJMOiBVUkwsIGNvbnRleHQ6IFJlc29sdmVDb250ZXh0KTogUHJvbWlzZTxVUkw+IHtcbiAgICBjb25zdCB7IHBhY2thZ2VOYW1lLCBpc1Njb3BlZCB9ID0gcGFyc2VQYWNrYWdlTmFtZShzcGVjaWZpZXIpO1xuICAgIGNvbnN0IHBhY2thZ2VTdWJwYXRoID0gYC4ke3NwZWNpZmllci5zdWJzdHIocGFja2FnZU5hbWUubGVuZ3RoKX1gO1xuXG4gICAgLy8gUGFja2FnZSBzZWxmIHJlc29sdmVcbiAgICBjb25zdCBzZWxmVVJMID0gYXdhaXQgcGFja2FnZVNlbGZSZXNvbHZlKHBhY2thZ2VOYW1lLCBwYWNrYWdlU3VicGF0aCwgcGFyZW50VVJMLCBjb250ZXh0KTtcbiAgICBpZiAoc2VsZlVSTCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBzZWxmVVJMO1xuICAgIH1cblxuICAgIGlmIChwYWNrYWdlU3VicGF0aCA9PT0gJy4nICYmIGlzTm9kZUpzQnVpbHRpbk1vZHVsZShwYWNrYWdlTmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwoYG5vZGU6JHtzcGVjaWZpZXJ9YCk7XG4gICAgfVxuXG4gICAgY29uc3Qgb25seUZpbGVQYWNrYWdlcyA9IHRydWU7XG4gICAgbGV0IHBhY2thZ2VKc29uVXJsID0gbmV3IFVSTChgLi9ub2RlX21vZHVsZXMvJHtwYWNrYWdlTmFtZX0vcGFja2FnZS5qc29uYCwgcGFyZW50VVJMKTtcbiAgICBsZXQgbGFzdFBhY2tKc29uUGF0aG5hbWUgPSAnJztcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBpZiAob25seUZpbGVQYWNrYWdlcyAmJiAhaGFzRmlsZVByb3RvY29sKHBhY2thZ2VKc29uVXJsKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFja2FnZUpzb25VcmwucGF0aG5hbWUgPT09IGxhc3RQYWNrSnNvblBhdGhuYW1lKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBsYXN0UGFja0pzb25QYXRobmFtZSA9IHBhY2thZ2VKc29uVXJsLnBhdGhuYW1lO1xuXG4gICAgICAgIGlmICghYXdhaXQgZGlyRXhpc3RzKG5ldyBVUkwoJy4uJywgcGFja2FnZUpzb25VcmwpKSkge1xuICAgICAgICAgICAgcGFja2FnZUpzb25VcmwgPSBuZXcgVVJMKFxuICAgICAgICAgICAgICAgIGAke2lzU2NvcGVkID8gJy4uLy4uLy4uLy4uLycgOiAnLi4vLi4vLi4vJ31ub2RlX21vZHVsZXMvJHtwYWNrYWdlTmFtZX0vcGFja2FnZS5qc29uYCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVybCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gYXdhaXQgcmVhZFBhY2thZ2VKc29uKHBhY2thZ2VKc29uVXJsKTtcbiAgICAgICAgaWYgKCFwYWNrYWdlSnNvbikge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFja2FnZUpzb24gIT09IG51bGwgJiYgIWlzTnVsbE9yVW5kZWZpbmVkKHBhY2thZ2VKc29uLmV4cG9ydHMpKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgcGFja2FnZUV4cG9ydHNSZXNvbHZlKFxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uVXJsLFxuICAgICAgICAgICAgICAgIHBhY2thZ2VTdWJwYXRoLFxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uLmV4cG9ydHMsXG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBwYXJlbnRVUkwsXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHBhY2thZ2VTdWJwYXRoID09PSAnLicpIHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBsZWdhY3lNYWluUmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVybCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvbixcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gbmV3IFVSTChwYWNrYWdlU3VicGF0aCwgcGFja2FnZUpzb25VcmwpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IE1vZHVsZU5vdEZvdW5kRXJyb3Ioc3BlY2lmaWVyLCBwYXJlbnRVUkwpO1xufVxuXG5mdW5jdGlvbiBwYXJzZVBhY2thZ2VOYW1lKHNwZWNpZmllcjogc3RyaW5nKSB7XG4gICAgbGV0IHBhY2thZ2VOYW1lOiBzdHJpbmc7XG4gICAgbGV0IGlzU2NvcGVkID0gZmFsc2U7XG5cbiAgICBpZiAoc3BlY2lmaWVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE1vZHVsZVNwZWNpZmllckVycm9yKHNwZWNpZmllcik7XG4gICAgfVxuXG4gICAgY29uc3QgaUZpcnN0U2xhc2ggPSBzcGVjaWZpZXIuaW5kZXhPZignLycpO1xuICAgIGlmICghc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJ0AnKSkge1xuICAgICAgICBwYWNrYWdlTmFtZSA9IGlGaXJzdFNsYXNoIDwgMFxuICAgICAgICAgICAgPyBzcGVjaWZpZXJcbiAgICAgICAgICAgIDogc3BlY2lmaWVyLnN1YnN0cigwLCBpRmlyc3RTbGFzaCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlGaXJzdFNsYXNoIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcihzcGVjaWZpZXIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXNTY29wZWQgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgaVNlY29uZFNsYXNoID0gc3BlY2lmaWVyLmluZGV4T2YoJy8nLCBpRmlyc3RTbGFzaCArIDEpO1xuICAgICAgICAgICAgcGFja2FnZU5hbWUgPSBpU2Vjb25kU2xhc2ggPCAwID8gc3BlY2lmaWVyIDogc3BlY2lmaWVyLnN1YnN0cigwLCBpU2Vjb25kU2xhc2gpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGlzVmFsaWQgPSB0cnVlO1xuICAgIGlmIChwYWNrYWdlTmFtZS5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgICAgaXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhY2thZ2VOYW1lLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChwYWNrYWdlTmFtZVtpXSA9PT0gJyUnIHx8IHBhY2thZ2VOYW1lW2ldID09PSAnXFxcXCcpIHtcbiAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE1vZHVsZVNwZWNpZmllckVycm9yKHNwZWNpZmllcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcGFja2FnZU5hbWUsIGlzU2NvcGVkIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VTZWxmUmVzb2x2ZShwYWNrYWdlTmFtZTogc3RyaW5nLCBwYWNrYWdlU3VicGF0aDogc3RyaW5nLCBwYXJlbnRVUkw6IFVSTCwgY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gYXdhaXQgcmVhZFBhY2thZ2VTY29wZShwYXJlbnRVUkwpO1xuICAgIGlmIChwYWNrYWdlSnNvbiA9PT0gbnVsbCB8fCBpc051bGxPclVuZGVmaW5lZChwYWNrYWdlSnNvbi5leHBvcnRzKSkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAocGFja2FnZU5hbWUgPT09IHBhY2thZ2VKc29uLm5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VFeHBvcnRzUmVzb2x2ZShwYWNrYWdlSnNvbi51cmwsIHBhY2thZ2VTdWJwYXRoLCBwYWNrYWdlSnNvbi5leHBvcnRzLCBjb250ZXh0LCBwYXJlbnRVUkwpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVhZFBhY2thZ2VTY29wZSh1cmw6IFVSTCk6IFByb21pc2U8Tm9ybWFsaXplZFBhY2thZ2VKc29uIHwgbnVsbD4ge1xuICAgIGxldCBwYWNrYWdlSnNvblVSTCA9IG5ldyBVUkwoJy4vcGFja2FnZS5qc29uJywgdXJsKTtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBpZiAocGFja2FnZUpzb25VUkwucGF0aG5hbWUuZW5kc1dpdGgoJ25vZGVfbW9kdWxlcy9wYWNrYWdlLmpzb24nKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBhd2FpdCByZWFkUGFja2FnZUpzb24ocGFja2FnZUpzb25VUkwpO1xuICAgICAgICBpZiAocGFja2FnZUpzb24gIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBwYWNrYWdlSnNvbjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsYXN0UGFja2FnZUpzb25QYXRobmFtZSA9IHBhY2thZ2VKc29uVVJMLnBhdGhuYW1lO1xuICAgICAgICBwYWNrYWdlSnNvblVSTCA9IG5ldyBVUkwoJy4uL3BhY2thZ2UuanNvbicsIHBhY2thZ2VKc29uVVJMKTtcbiAgICAgICAgaWYgKHBhY2thZ2VKc29uVVJMLnBhdGhuYW1lID09PSBsYXN0UGFja2FnZUpzb25QYXRobmFtZSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkPFQ+KHY6IFQgfCBudWxsIHwgdW5kZWZpbmVkKTogdiBpcyBudWxsIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdiA9PT0gbnVsbCB8fCB2ID09PSB1bmRlZmluZWQ7XG59XG5cbmludGVyZmFjZSBOb3JtYWxpemVkUGFja2FnZUpzb24ge1xuICAgIHVybDogUmVhZG9ubHk8VVJMPjtcbiAgICBuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgdHlwZTogJ21vZHVsZScgfCAnY29tbW9uanMnIHwgdW5kZWZpbmVkO1xuICAgIG1haW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpbXBvcnRzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICBleHBvcnRzOiB1bmtub3duO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkUGFja2FnZUpzb24odXJsOiBVUkwpOiBQcm9taXNlPE5vcm1hbGl6ZWRQYWNrYWdlSnNvbiB8IG51bGw+IHtcbiAgICBpZiAoIWhhc0ZpbGVQcm90b2NvbCh1cmwpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgc291cmNlO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBmaWxlVVJMVG9QYXRoKHVybCk7XG4gICAgICAgIHNvdXJjZSA9IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgsICd1dGY4Jyk7XG4gICAgfSBjYXRjaCB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxldCBqc29uO1xuICAgIHRyeSB7XG4gICAgICAgIGpzb24gPSBKU09OLnBhcnNlKHNvdXJjZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZUNvbmZpZ3VyYXRpb25FcnJvcihlcnIpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgbWFpbiwgbmFtZSwgdHlwZSwgaW1wb3J0cywgZXhwb3J0cyB9ID0ganNvbjtcblxuICAgIGNvbnN0IG5vcm1hbGl6ZWQ6IE5vcm1hbGl6ZWRQYWNrYWdlSnNvbiA9IHtcbiAgICAgICAgdXJsLFxuICAgICAgICBuYW1lOiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycgPyBuYW1lIDogdW5kZWZpbmVkLFxuICAgICAgICB0eXBlOiB0eXBlID09PSAnbW9kdWxlJyB8fCB0eXBlID09PSAnY29tbW9uanMnID8gdHlwZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgbWFpbjogdHlwZW9mIG1haW4gPT09ICdzdHJpbmcnID8gbWFpbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgaW1wb3J0czogdHlwZW9mIGltcG9ydHMgIT09ICdvYmplY3QnIHx8IGltcG9ydHMgPT09IG51bGwgPyB1bmRlZmluZWQgOiBpbXBvcnRzLFxuICAgICAgICBleHBvcnRzLFxuICAgIH07XG5cblxuICAgIHJldHVybiBub3JtYWxpemVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlRXhwb3J0c1Jlc29sdmUoXG4gICAgcGFja2FnZUpzb25VUkw6IFVSTCxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgZXhwb3J0czogdW5rbm93bixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbiAgICBwYXJlbnRVUkw6IFVSTCxcbik6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IHByZWZpeGVkV2l0aERvdDogdW5kZWZpbmVkIHwgYm9vbGVhbjtcblxuICAgIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgZXhwb3J0cyAhPT0gbnVsbCkge1xuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZXhwb3J0cyk7XG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgcHJlZml4ZWRXaXRoRG90ID0ga2V5c1swXS5zdGFydHNXaXRoKCcuJyk7XG4gICAgICAgICAgICBpZiAoIWtleXMuZXZlcnkoKGtleSkgPT4ga2V5LnN0YXJ0c1dpdGgoJy4nKSA9PT0gcHJlZml4ZWRXaXRoRG90KSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZUNvbmZpZ3VyYXRpb25FcnJvcihwYWNrYWdlSnNvblVSTCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc3VicGF0aCA9PT0gJy4nKSB7XG4gICAgICAgIGNvbnN0IG1haW5FeHBvcnQgPSB0eXBlb2YgZXhwb3J0cyA9PT0gJ3N0cmluZycgfHwgQXJyYXkuaXNBcnJheShleHBvcnRzKSB8fCBwcmVmaXhlZFdpdGhEb3QgPT09IGZhbHNlXG4gICAgICAgICAgICA/IGV4cG9ydHNcbiAgICAgICAgICAgIDogcHJlZml4ZWRXaXRoRG90ID09PSB0cnVlID8gKGV4cG9ydHMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pWycuJ10gOiB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChtYWluRXhwb3J0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUocGFja2FnZUpzb25VUkwsIG1haW5FeHBvcnQsICcnLCBmYWxzZSwgZmFsc2UsIGNvbnRleHQpO1xuICAgICAgICAgICAgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZXNvbHZlZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByZWZpeGVkV2l0aERvdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjb25zdCBtYXRjaEtleSA9IHN1YnBhdGg7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkTWF0Y2ggPSBhd2FpdCBwYWNrYWdlSW1wb3J0c0V4cG9ydHNSZXNvbHZlKFxuICAgICAgICAgICAgbWF0Y2hLZXksXG4gICAgICAgICAgICBleHBvcnRzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgICAgICAgICAgcGFja2FnZUpzb25VUkwsXG4gICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgICAgIGlmICghaXNOdWxsT3JVbmRlZmluZWQocmVzb2x2ZWRNYXRjaC5yZXNvbHZlZCkpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZE1hdGNoLnJlc29sdmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IFBhY2thZ2VQYXRoTm90RXhwb3J0ZWRFcnJvcihzdWJwYXRoLCBwYWNrYWdlSnNvblVSTCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VJbXBvcnRzRXhwb3J0c1Jlc29sdmUoXG4gICAgbWF0Y2hLZXk6IHN0cmluZyxcbiAgICBtYXRjaE9iajogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgcGFja2FnZVVSTDogVVJMLFxuICAgIGlzSW1wb3J0czogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbik6IFByb21pc2U8eyByZXNvbHZlZDogVVJMIHwgbnVsbCB8IHVuZGVmaW5lZCwgZXhhY3Q6IGJvb2xlYW47IH0+IHtcbiAgICBpZiAoIW1hdGNoS2V5LmVuZHNXaXRoKCcqJykgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1hdGNoT2JqLCBtYXRjaEtleSkpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbbWF0Y2hLZXldO1xuICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBpc0ltcG9ydHMsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVzb2x2ZWQsXG4gICAgICAgICAgICBleGFjdDogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMobWF0Y2hPYmopLnNvcnQoKGEsIGIpID0+IGEubGVuZ3RoIC0gYi5sZW5ndGgpO1xuICAgIGZvciAoY29uc3QgZXhwYW5zaW9uS2V5IG9mIGtleXMpIHtcbiAgICAgICAgaWYgKCEoZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcvJykgfHwgZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcqJykpKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcqJykgJiZcbiAgICAgICAgICAgIG1hdGNoS2V5LnN0YXJ0c1dpdGgoZXhwYW5zaW9uS2V5KSAmJlxuICAgICAgICAgICAgbWF0Y2hLZXkgIT09IGV4cGFuc2lvbktleSkge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbZXhwYW5zaW9uS2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnBhdGggPSBtYXRjaEtleS5zdWJzdHIoZXhwYW5zaW9uS2V5Lmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxuICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgaXNJbXBvcnRzLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZWQsIGV4YWN0OiB0cnVlIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGNoS2V5LnN0YXJ0c1dpdGgoZXhwYW5zaW9uS2V5KSkge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbZXhwYW5zaW9uS2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnBhdGggPSBtYXRjaEtleS5zdWJzdHIoZXhwYW5zaW9uS2V5Lmxlbmd0aCk7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgICAgICAgICAgICAgIHBhY2thZ2VVUkwsXG4gICAgICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgaXNJbXBvcnRzLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZWQsIGV4YWN0OiBmYWxzZSB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcmVzb2x2ZWQ6IG51bGwsIGV4YWN0OiB0cnVlIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgIHBhY2thZ2VVUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHVua25vd24sXG4gICAgc3VicGF0aDogc3RyaW5nLFxuICAgIHBhdHRlcm46IGJvb2xlYW4sXG4gICAgaW50ZXJuYWw6IGJvb2xlYW4sXG4gICAgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsXG4pOiBQcm9taXNlPFVSTCB8IG51bGwgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHJlc29sdmVQYWNrYWdlVGFyZ2V0U3RyaW5nKFxuICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICBwYXR0ZXJuLFxuICAgICAgICAgICAgaW50ZXJuYWwsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHJlc29sdmVQYWNrYWdlVGFyZ2V0QXJyYXkoXG4gICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgc3VicGF0aCxcbiAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICdvYmplY3QnICYmIHRhcmdldCAhPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gYXdhaXQgcmVzb2x2ZVBhY2thZ2VUYXJnZXRPYmplY3QoXG4gICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgdGFyZ2V0IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgICAgICAgICAgc3VicGF0aCxcbiAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRhcmdldCA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VUYXJnZXRFcnJvcihwYWNrYWdlVVJMKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVBhY2thZ2VUYXJnZXRTdHJpbmcoXG4gICAgcGFja2FnZUpzb25VUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHN0cmluZyxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGlmICghcGF0dGVybiAmJiBzdWJwYXRoLmxlbmd0aCAhPT0gMCAmJiAhdGFyZ2V0LmVuZHNXaXRoKCcvJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcih0YXJnZXQpO1xuICAgIH1cblxuICAgIGlmICghdGFyZ2V0LnN0YXJ0c1dpdGgoJy4vJykpIHtcbiAgICAgICAgaWYgKGludGVybmFsICYmICF0YXJnZXQuc3RhcnRzV2l0aCgnLi4vJykgJiYgIXRhcmdldC5zdGFydHNXaXRoKCcvJykgJiYgIXRyeVBhcnNlVVJMKHRhcmdldCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydFRhcmdldCA9IHBhdHRlcm5cbiAgICAgICAgICAgICAgICA/IGFwcGx5UGF0dGVybih0YXJnZXQsIHN1YnBhdGgpXG4gICAgICAgICAgICAgICAgOiB0YXJnZXQgKyBzdWJwYXRoO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VSZXNvbHZlKFxuICAgICAgICAgICAgICAgIGV4cG9ydFRhcmdldCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVSTCxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdGU6IGB0YXJnZXRgIHN0YXJ0cyB3aXRoICcuLycgbm93XG4gICAgaWYgKGRvdE9yRG90RG90T3JOb2RlTW9kdWxlc1NlZ21lbnRSZWdleC50ZXN0KHRhcmdldC5zdWJzdHIoMikpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXNvbHZlZCA9IG5ldyBVUkwodGFyZ2V0LCBwYWNrYWdlSnNvblVSTCk7XG4gICAgY29uc3QgcGFja2FnZVBhdGggPSBuZXcgVVJMKCcuJywgcGFja2FnZUpzb25VUkwpO1xuICAgIGlmICghcmVzb2x2ZWQucGF0aG5hbWUuc3RhcnRzV2l0aChwYWNrYWdlUGF0aC5wYXRobmFtZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IocGFja2FnZUpzb25VUkwpO1xuICAgIH1cblxuICAgIGlmIChzdWJwYXRoID09PSAnJykge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgfVxuXG4gICAgaWYgKGRvdE9yRG90RG90T3JOb2RlTW9kdWxlc1NlZ21lbnRSZWdleC50ZXN0KHN1YnBhdGgpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF0dGVyblxuICAgICAgICA/IG5ldyBVUkwoYXBwbHlQYXR0ZXJuKHJlc29sdmVkLmhyZWYsIHN1YnBhdGgpKVxuICAgICAgICA6IG5ldyBVUkwoc3VicGF0aCwgcmVzb2x2ZWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUGFja2FnZVRhcmdldE9iamVjdChcbiAgICBwYWNrYWdlVVJMOiBVUkwsXG4gICAgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpO1xuICAgIGlmIChrZXlzLnNvbWUoaXNBcnJheUluZGV4KSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VDb25maWd1cmF0aW9uRXJyb3IocGFja2FnZVVSTCk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ2RlZmF1bHQnIHx8IGNvbnRleHQuY29uZGl0aW9ucy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9IHRhcmdldFtrZXldO1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgICAgIHRhcmdldFZhbHVlLFxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICAgICAgcGF0dGVybixcbiAgICAgICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChyZXNvbHZlZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUGFja2FnZVRhcmdldEFycmF5KFxuICAgIHBhY2thZ2VVUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHVua25vd25bXSxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGlmICh0YXJnZXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgbGFzdEVycjogSW52YWxpZFBhY2thZ2VUYXJnZXRFcnJvciB8IG51bGwgfCB1bmRlZmluZWQ7XG4gICAgZm9yIChjb25zdCB0YXJnZXRWYWx1ZSBvZiB0YXJnZXQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUoXG4gICAgICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgICAgICB0YXJnZXRWYWx1ZSxcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxuICAgICAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICAgICAgaW50ZXJuYWwsXG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNvbHZlZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGxhc3RFcnIgPSBudWxsO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIC8vICBjb250aW51aW5nIHRoZSBsb29wIG9uIGFueSBJbnZhbGlkIFBhY2thZ2UgVGFyZ2V0IGVycm9yLlxuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IpIHtcbiAgICAgICAgICAgICAgICBsYXN0RXJyID0gZXJyO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKGxhc3RFcnIpKSB7XG4gICAgICAgIHJldHVybiBsYXN0RXJyO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGxhc3RFcnI7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhcHBseVBhdHRlcm4oczogc3RyaW5nLCByZXBsYWNlcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHMucmVwbGFjZSgvXFwqL2csIHJlcGxhY2VyKTtcbn1cblxuLy8gTWF0Y2ggcGF0aCBzZWdtZW50XG5jb25zdCBkb3RPckRvdERvdE9yTm9kZU1vZHVsZXNTZWdtZW50UmVnZXggPSAvKF58XFxcXHxcXC8pKFxcLlxcLj98bm9kZV9tb2R1bGVzKShcXFxcfFxcL3wkKS87XG5cbmZ1bmN0aW9uIGlzQXJyYXlJbmRleChzOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBrZXlOdW0gPSArcztcbiAgICBpZiAoYCR7a2V5TnVtfWAgIT09IHMpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4ga2V5TnVtID49IDAgJiYga2V5TnVtIDwgMHhGRkZGX0ZGRkY7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxlZ2FjeU1haW5SZXNvbHZlKFxuICAgIHBhY2thZ2VKc29uVXJsOiBVUkwsXG4gICAgcGFja2FnZUpzb246IE5vcm1hbGl6ZWRQYWNrYWdlSnNvbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbik6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IGd1ZXNzO1xuICAgIGlmIChwYWNrYWdlSnNvbi5tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gTm90ZTogZnMgY2hlY2sgcmVkdW5kYW5jZXMgd2lsbCBiZSBoYW5kbGVkIGJ5IERlc2NyaXB0b3IgY2FjaGUgaGVyZS5cbiAgICAgICAgaWYgKGF3YWl0IGZpbGVFeGlzdHMoZ3Vlc3MgPSBuZXcgVVJMKGAuLyR7cGFja2FnZUpzb24ubWFpbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3Vlc3M7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgY29udGV4dC5sZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMpIHtcbiAgICAgICAgICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGd1ZXNzID0gbmV3IFVSTChgLi8ke3BhY2thZ2VKc29uLm1haW59JHtleHRlbnNpb259YCwgcGFja2FnZUpzb25VcmwpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBndWVzcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IGV4dGVuc2lvbiBvZiBjb250ZXh0LmxlZ2FjeU1haW5SZXNvbHZlRXh0ZW5zaW9ucykge1xuICAgICAgICAgICAgaWYgKGF3YWl0IGZpbGVFeGlzdHMoZ3Vlc3MgPSBuZXcgVVJMKGAuLyR7cGFja2FnZUpzb24ubWFpbn0vaW5kZXgke2V4dGVuc2lvbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGd1ZXNzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIEZhbGx0aHJvdWdoLlxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGV4dGVuc2lvbiBvZiBjb250ZXh0LmxlZ2FjeU1haW5SZXNvbHZlRXh0ZW5zaW9ucykge1xuICAgICAgICBpZiAoYXdhaXQgZmlsZUV4aXN0cyhndWVzcyA9IG5ldyBVUkwoYC4vaW5kZXgke2V4dGVuc2lvbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3Vlc3M7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gTm90IGZvdW5kLlxuICAgIHRocm93IG5ldyBNb2R1bGVOb3RGb3VuZEVycm9yKCc8bWFpbj4nLCBuZXcgVVJMKCcuJywgcGFja2FnZUpzb25VcmwpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmlsZUV4aXN0cyh1cmw6IFVSTCkge1xuICAgIHJldHVybiAoYXdhaXQgdHJ5U3RhdCh1cmwpKS5pc0ZpbGUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGlyRXhpc3RzKHVybDogVVJMKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0cnlTdGF0KHVybCkpLmlzRGlyZWN0b3J5KCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRyeVN0YXQodXJsOiBVUkwpIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aCh1cmwpO1xuICAgICAgICByZXR1cm4gYXdhaXQgZnMuc3RhdChwYXRoKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIG5ldyBmcy5TdGF0cygpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaXNOb2RlSnNCdWlsdGluTW9kdWxlKHBhY2thZ2VOYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gW1xuICAgICAgICAnYXNzZXJ0JyxcbiAgICAgICAgJ2J1ZmZlcicsXG4gICAgICAgICdjaGlsZF9wcm9jZXNzJyxcbiAgICAgICAgJ2NsdXN0ZXInLFxuICAgICAgICAnY3J5cHRvJyxcbiAgICAgICAgJ2RncmFtJyxcbiAgICAgICAgJ2RucycsXG4gICAgICAgICdkb21haW4nLFxuICAgICAgICAnZXZlbnRzJyxcbiAgICAgICAgJ2ZzJyxcbiAgICAgICAgJ2h0dHAnLFxuICAgICAgICAnaHR0cHMnLFxuICAgICAgICAnbmV0JyxcbiAgICAgICAgJ29zJyxcbiAgICAgICAgJ3BhdGgnLFxuICAgICAgICAncHVueWNvZGUnLFxuICAgICAgICAncXVlcnlzdHJpbmcnLFxuICAgICAgICAncmVhZGxpbmUnLFxuICAgICAgICAnc3RyZWFtJyxcbiAgICAgICAgJ3N0cmluZ19kZWNvZGVyJyxcbiAgICAgICAgJ3RpbWVycycsXG4gICAgICAgICd0bHMnLFxuICAgICAgICAndHR5JyxcbiAgICAgICAgJ3VybCcsXG4gICAgICAgICd1dGlsJyxcbiAgICAgICAgJ3Y4JyxcbiAgICAgICAgJ3ZtJyxcbiAgICAgICAgJ3psaWInLFxuICAgIF0uaW5jbHVkZXMocGFja2FnZU5hbWUpO1xufVxuXG4iXX0=