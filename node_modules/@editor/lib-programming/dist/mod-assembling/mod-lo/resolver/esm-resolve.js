"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.readPackageScope = exports.defaultLegacyMainResolveExtensions = exports.defaultConditions = exports.esmResolve = void 0;
const url_1 = require("url");
const specifier_1 = require("../../utils/specifier");
const url_2 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
const fs_extra_1 = __importDefault(require("fs-extra"));
const import_map_resolve_1 = require("./import-map-resolve");
const node_builtins_1 = require("../utils/node-builtins");
/**
 * Reference:
 * https://nodejs.org/api/esm.html#esm_resolver_algorithm
 * Modification:
 * - Import map are considered.
 */
async function esmResolve(specifier, parentURL, options) {
    var _a;
    const { conditions = exports.defaultConditions, legacyMainResolveExtensions = exports.defaultLegacyMainResolveExtensions, importMap, } = options !== null && options !== void 0 ? options : {};
    const context = {
        conditions,
        legacyMainResolveExtensions,
    };
    let asURL;
    if (specifier_1.isRelativeSpecifier(specifier)) {
        asURL = new url_1.URL(specifier, parentURL);
    }
    else {
        asURL = (_a = url_2.tryParseURL(specifier)) !== null && _a !== void 0 ? _a : null;
    }
    if (importMap) {
        const importMapResolved = import_map_resolve_1.importMapResolve(specifier, asURL, parentURL, importMap);
        if (importMapResolved) {
            return importMapResolved;
        }
    }
    if (asURL) {
        return asURL;
    }
    if (specifier.startsWith('#')) {
        return await packageImportsResolve(specifier, parentURL, context);
    }
    return await packageResolve(specifier, parentURL, context);
}
exports.esmResolve = esmResolve;
exports.defaultConditions = ['import'];
exports.defaultLegacyMainResolveExtensions = ['.js', '.json'];
async function packageImportsResolve(_specifier, _parentURL, _context) {
    throw new Error(`We currently do not support package 'imports' field.`);
}
async function packageResolve(specifier, parentURL, context) {
    const { packageName, isScoped } = parsePackageName(specifier);
    const packageSubpath = `.${specifier.substr(packageName.length)}`;
    // Package self resolve
    const selfURL = await packageSelfResolve(packageName, packageSubpath, parentURL, context);
    if (selfURL !== undefined) {
        return selfURL;
    }
    if (packageSubpath === '.' && node_builtins_1.isNodeJsBuiltinModule(packageName)) {
        return new url_1.URL(node_builtins_1.toNodeProtocolUrl(specifier));
    }
    const onlyFilePackages = true;
    let packageJsonUrl = new url_1.URL(`./node_modules/${packageName}/package.json`, parentURL);
    let lastPackJsonPathname = '';
    while (true) {
        if (onlyFilePackages && !url_2.hasFileProtocol(packageJsonUrl)) {
            break;
        }
        if (packageJsonUrl.pathname === lastPackJsonPathname) {
            break;
        }
        lastPackJsonPathname = packageJsonUrl.pathname;
        if (!await dirExists(new url_1.URL('..', packageJsonUrl))) {
            packageJsonUrl = new url_1.URL(`${isScoped ? '../../../../' : '../../../'}node_modules/${packageName}/package.json`, packageJsonUrl);
            continue;
        }
        const packageJson = await readPackageJson(packageJsonUrl);
        if (!packageJson) {
            continue;
        }
        if (packageJson !== null && !isNullOrUndefined(packageJson.exports)) {
            return await packageExportsResolve(packageJsonUrl, packageSubpath, packageJson.exports, context, parentURL);
        }
        else if (packageSubpath === '.') {
            return await legacyMainResolve(packageJsonUrl, packageJson, context);
        }
        else {
            const resolved = new url_1.URL(packageSubpath, packageJsonUrl);
            return resolved;
        }
    }
    throw new resolve_error_1.ModuleNotFoundError(specifier, parentURL);
}
function parsePackageName(specifier) {
    let packageName;
    let isScoped = false;
    if (specifier.length === 0) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    const iFirstSlash = specifier.indexOf('/');
    if (!specifier.startsWith('@')) {
        packageName = iFirstSlash < 0
            ? specifier
            : specifier.substr(0, iFirstSlash);
    }
    else {
        if (iFirstSlash < 0) {
            throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
        }
        else {
            isScoped = true;
            const iSecondSlash = specifier.indexOf('/', iFirstSlash + 1);
            packageName = iSecondSlash < 0 ? specifier : specifier.substr(0, iSecondSlash);
        }
    }
    let isValid = true;
    if (packageName.startsWith('.')) {
        isValid = false;
    }
    for (let i = 0; i < packageName.length; i++) {
        if (packageName[i] === '%' || packageName[i] === '\\') {
            isValid = false;
            break;
        }
    }
    if (!isValid) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    return { packageName, isScoped };
}
async function packageSelfResolve(packageName, packageSubpath, parentURL, context) {
    const packageJson = await readPackageScope(parentURL);
    if (packageJson === null || isNullOrUndefined(packageJson.exports)) {
        return undefined;
    }
    if (packageName === packageJson.name) {
        return await packageExportsResolve(packageJson.url, packageSubpath, packageJson.exports, context, parentURL);
    }
    return undefined;
}
async function readPackageScope(url) {
    let packageJsonURL = new url_1.URL('./package.json', url);
    while (true) {
        if (packageJsonURL.pathname.endsWith('node_modules/package.json')) {
            break;
        }
        const packageJson = await readPackageJson(packageJsonURL);
        if (packageJson !== null) {
            return packageJson;
        }
        const lastPackageJsonPathname = packageJsonURL.pathname;
        packageJsonURL = new url_1.URL('../package.json', packageJsonURL);
        if (packageJsonURL.pathname === lastPackageJsonPathname) {
            break;
        }
    }
    return null;
}
exports.readPackageScope = readPackageScope;
function isNullOrUndefined(v) {
    return v === null || v === undefined;
}
async function readPackageJson(url) {
    if (!url_2.hasFileProtocol(url)) {
        return null;
    }
    let source;
    try {
        const path = url_1.fileURLToPath(url);
        source = await fs_extra_1.default.readFile(path, 'utf8');
    }
    catch (_a) {
        return null;
    }
    let json;
    try {
        json = JSON.parse(source);
    }
    catch (err) {
        throw new resolve_error_1.InvalidPackageConfigurationError(err);
    }
    const { main, name, type, imports, exports } = json;
    const normalized = {
        url,
        name: typeof name === 'string' ? name : undefined,
        type: type === 'module' || type === 'commonjs' ? type : undefined,
        main: typeof main === 'string' ? main : undefined,
        imports: typeof imports !== 'object' || imports === null ? undefined : imports,
        exports,
    };
    return normalized;
}
async function packageExportsResolve(packageJsonURL, subpath, exports, context, parentURL) {
    let prefixedWithDot;
    if (typeof exports === 'object' && exports !== null) {
        const keys = Object.keys(exports);
        if (keys.length !== 0) {
            prefixedWithDot = keys[0].startsWith('.');
            if (!keys.every((key) => key.startsWith('.') === prefixedWithDot)) {
                throw new resolve_error_1.InvalidPackageConfigurationError(packageJsonURL);
            }
        }
    }
    if (subpath === '.') {
        const mainExport = typeof exports === 'string' || Array.isArray(exports) || prefixedWithDot === false
            ? exports
            : prefixedWithDot === true ? exports['.'] : undefined;
        if (mainExport !== undefined) {
            const resolved = await packageTargetResolve(packageJsonURL, mainExport, '', false, false, context);
            if (!isNullOrUndefined(resolved)) {
                return resolved;
            }
        }
    }
    else if (prefixedWithDot === true) {
        const matchKey = subpath;
        const resolvedMatch = await packageImportsExportsResolve(matchKey, exports, packageJsonURL, false, context);
        if (!isNullOrUndefined(resolvedMatch.resolved)) {
            return resolvedMatch.resolved;
        }
    }
    throw new resolve_error_1.PackagePathNotExportedError(subpath, packageJsonURL);
}
async function packageImportsExportsResolve(matchKey, matchObj, packageURL, isImports, context) {
    if (!matchKey.endsWith('*') && Object.prototype.hasOwnProperty.call(matchObj, matchKey)) {
        const target = matchObj[matchKey];
        const resolved = await packageTargetResolve(packageURL, target, '', false, isImports, context);
        return {
            resolved,
            exact: true,
        };
    }
    const keys = Object.getOwnPropertyNames(matchObj).sort((a, b) => a.length - b.length);
    for (const expansionKey of keys) {
        if (!(expansionKey.endsWith('/') || expansionKey.endsWith('*'))) {
            continue;
        }
        if (expansionKey.endsWith('*') &&
            matchKey.startsWith(expansionKey) &&
            matchKey !== expansionKey) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length - 1);
            const resolved = await packageTargetResolve(packageURL, target, subpath, true, isImports, context);
            return { resolved, exact: true };
        }
        if (matchKey.startsWith(expansionKey)) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length);
            const resolved = await packageTargetResolve(packageURL, target, subpath, false, isImports, context);
            return { resolved, exact: false };
        }
    }
    return { resolved: null, exact: true };
}
async function packageTargetResolve(packageURL, target, subpath, pattern, internal, context) {
    if (typeof target === 'string') {
        return await resolvePackageTargetString(packageURL, target, subpath, pattern, internal, context);
    }
    if (Array.isArray(target)) {
        return await resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context);
    }
    if (typeof target === 'object' && target !== null) {
        return await resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context);
    }
    if (target === null) {
        return null;
    }
    throw new resolve_error_1.InvalidPackageTargetError(packageURL);
}
async function resolvePackageTargetString(packageJsonURL, target, subpath, pattern, internal, context) {
    if (!pattern && subpath.length !== 0 && !target.endsWith('/')) {
        throw new resolve_error_1.InvalidModuleSpecifierError(target);
    }
    if (!target.startsWith('./')) {
        if (internal && !target.startsWith('../') && !target.startsWith('/') && !url_2.tryParseURL(target)) {
            const exportTarget = pattern
                ? applyPattern(target, subpath)
                : target + subpath;
            return await packageResolve(exportTarget, packageJsonURL, context);
        }
        else {
            throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
        }
    }
    // Note: `target` starts with './' now
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(target.substr(2))) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    const resolved = new url_1.URL(target, packageJsonURL);
    const packagePath = new url_1.URL('.', packageJsonURL);
    if (!resolved.pathname.startsWith(packagePath.pathname)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    if (subpath === '') {
        return resolved;
    }
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(subpath)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    return pattern
        ? new url_1.URL(applyPattern(resolved.href, subpath))
        : new url_1.URL(subpath, resolved);
}
async function resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context) {
    const keys = Object.getOwnPropertyNames(target);
    if (keys.some(isArrayIndex)) {
        throw new resolve_error_1.InvalidPackageConfigurationError(packageURL);
    }
    for (const key of keys) {
        if (key === 'default' || context.conditions.includes(key)) {
            const targetValue = target[key];
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else {
                return resolved;
            }
        }
    }
    return undefined;
}
async function resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context) {
    if (target.length === 0) {
        return null;
    }
    let lastErr;
    for (const targetValue of target) {
        try {
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else if (resolved === null) {
                lastErr = null;
                continue;
            }
            return resolved;
        }
        catch (err) {
            //  continuing the loop on any Invalid Package Target error.
            if (err instanceof resolve_error_1.InvalidPackageTargetError) {
                lastErr = err;
                continue;
            }
            else {
                throw err;
            }
        }
    }
    if (isNullOrUndefined(lastErr)) {
        return lastErr;
    }
    else {
        throw lastErr;
    }
}
function applyPattern(s, replacer) {
    return s.replace(/\*/g, replacer);
}
// Match path segment
const dotOrDotDotOrNodeModulesSegmentRegex = /(^|\\|\/)(\.\.?|node_modules)(\\|\/|$)/;
function isArrayIndex(s) {
    const keyNum = +s;
    if (`${keyNum}` !== s) {
        return false;
    }
    return keyNum >= 0 && keyNum < 4294967295;
}
async function legacyMainResolve(packageJsonUrl, packageJson, context) {
    let guess;
    if (packageJson.main !== undefined) {
        // Note: fs check redundances will be handled by Descriptor cache here.
        if (await fileExists(guess = new url_1.URL(`./${packageJson.main}`, packageJsonUrl))) {
            return guess;
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}/index${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        // Fallthrough.
    }
    for (const extension of context.legacyMainResolveExtensions) {
        if (await fileExists(guess = new url_1.URL(`./index${extension}`, packageJsonUrl))) {
            return guess;
        }
    }
    // Not found.
    throw new resolve_error_1.ModuleNotFoundError('<main>', new url_1.URL('.', packageJsonUrl));
}
async function fileExists(url) {
    return (await tryStat(url)).isFile();
}
async function dirExists(url) {
    return (await tryStat(url)).isDirectory();
}
async function tryStat(url) {
    try {
        const path = url_1.fileURLToPath(url);
        return await fs_extra_1.default.stat(path);
    }
    catch (_a) {
        return new fs_extra_1.default.Stats();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNtLXJlc29sdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvbW9kLWxvL3Jlc29sdmVyL2VzbS1yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLDZCQUF3RDtBQUN4RCxxREFBNEQ7QUFDNUQseUNBQStEO0FBQy9ELG1EQUE4TTtBQUM5TSx3REFBMEI7QUFHMUIsNkRBQXdEO0FBQ3hELDBEQUFrRjtBQUVsRjs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxVQUFVLENBQUMsU0FBaUIsRUFBRSxTQUFjLEVBQUUsT0FJbkU7O0lBQ0csTUFBTSxFQUNGLFVBQVUsR0FBRyx5QkFBaUIsRUFDOUIsMkJBQTJCLEdBQUcsMENBQWtDLEVBQ2hFLFNBQVMsR0FDWixHQUFHLE9BQU8sYUFBUCxPQUFPLGNBQVAsT0FBTyxHQUFJLEVBQUUsQ0FBQztJQUVsQixNQUFNLE9BQU8sR0FBbUI7UUFDNUIsVUFBVTtRQUNWLDJCQUEyQjtLQUM5QixDQUFDO0lBRUYsSUFBSSxLQUFpQixDQUFDO0lBQ3RCLElBQUksK0JBQW1CLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDaEMsS0FBSyxHQUFHLElBQUksU0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUN6QztTQUFNO1FBQ0gsS0FBSyxTQUFHLGlCQUFXLENBQUMsU0FBUyxDQUFDLG1DQUFJLElBQUksQ0FBQztLQUMxQztJQUVELElBQUksU0FBUyxFQUFFO1FBQ1gsTUFBTSxpQkFBaUIsR0FBRyxxQ0FBZ0IsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNuRixJQUFJLGlCQUFpQixFQUFFO1lBQ25CLE9BQU8saUJBQWlCLENBQUM7U0FDNUI7S0FDSjtJQUVELElBQUksS0FBSyxFQUFFO1FBQ1AsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFFRCxJQUFJLFNBQVMsQ0FBQyxVQUFV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QUFDLENBQUM7UUFDaEMsT0FBTyxNQUFNLGtCQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQzlCO0lBQUMsV0FBTTtRQUNKLE9BQU8sSUFBSSxrQkFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQ3pCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBVUkwsIGZpbGVVUkxUb1BhdGgsIHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnO1xyXG5pbXBvcnQgeyBpc1JlbGF0aXZlU3BlY2lmaWVyIH0gZnJvbSAnLi4vLi4vdXRpbHMvc3BlY2lmaWVyJztcclxuaW1wb3J0IHsgaGFzRmlsZVByb3RvY29sLCB0cnlQYXJzZVVSTCB9IGZyb20gJy4uLy4uL3V0aWxzL3VybCc7XHJcbmltcG9ydCB7IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvciwgSW52YWxpZFBhY2thZ2VDb25maWd1cmF0aW9uRXJyb3IsIEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IsIE1vZHVsZU5vdEZvdW5kRXJyb3IsIFBhY2thZ2VQYXRoTm90RXhwb3J0ZWRFcnJvciwgVW5zdXBwb3J0ZWREaXJlY3RvcnlJbXBvcnRFcnJvciB9IGZyb20gJy4vcmVzb2x2ZS1lcnJvcic7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgUGFyc2VkSW1wb3J0TWFwIH0gZnJvbSAnLi9wYXJzZWQtaW1wb3J0LW1hcCc7XHJcbmltcG9ydCB7IGltcG9ydE1hcFJlc29sdmUgfSBmcm9tICcuL2ltcG9ydC1tYXAtcmVzb2x2ZSc7XHJcbmltcG9ydCB7IGlzTm9kZUpzQnVpbHRpbk1vZHVsZSwgdG9Ob2RlUHJvdG9jb2xVcmwgfSBmcm9tICcuLi91dGlscy9ub2RlLWJ1aWx0aW5zJztcclxuXHJcbi8qKlxyXG4gKiBSZWZlcmVuY2U6XHJcbiAqIGh0dHBzOi8vbm9kZWpzLm9yZy9hcGkvZXNtLmh0bWwjZXNtX3Jlc29sdmVyX2FsZ29yaXRobVxyXG4gKiBNb2RpZmljYXRpb246XHJcbiAqIC0gSW1wb3J0IG1hcCBhcmUgY29uc2lkZXJlZC5cclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBlc21SZXNvbHZlKHNwZWNpZmllcjogc3RyaW5nLCBwYXJlbnRVUkw6IFVSTCwgb3B0aW9ucz86IHtcclxuICAgIGltcG9ydE1hcD86IFBhcnNlZEltcG9ydE1hcDtcclxuICAgIGNvbmRpdGlvbnM/OiBDb25kaXRpb25zO1xyXG4gICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zPzogc3RyaW5nW107XHJcbn0pOiBQcm9taXNlPFVSTD4ge1xyXG4gICAgY29uc3Qge1xyXG4gICAgICAgIGNvbmRpdGlvbnMgPSBkZWZhdWx0Q29uZGl0aW9ucyxcclxuICAgICAgICBsZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMgPSBkZWZhdWx0TGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxyXG4gICAgICAgIGltcG9ydE1hcCxcclxuICAgIH0gPSBvcHRpb25zID8/IHt9O1xyXG5cclxuICAgIGNvbnN0IGNvbnRleHQ6IFJlc29sdmVDb250ZXh0ID0ge1xyXG4gICAgICAgIGNvbmRpdGlvbnMsXHJcbiAgICAgICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxyXG4gICAgfTtcclxuXHJcbiAgICBsZXQgYXNVUkw6IFVSTCB8IG51bGw7XHJcbiAgICBpZiAoaXNSZWxhdGl2ZVNwZWNpZmllcihzcGVjaWZpZXIpKSB7XHJcbiAgICAgICAgYXNVUkwgPSBuZXcgVVJMKHNwZWNpZmllciwgcGFyZW50VVJMKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXNVUkwgPSB0cnlQYXJzZVVSTChzcGVjaWZpZXIpID8/IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGltcG9ydE1hcCkge1xyXG4gICAgICAgIGNvbnN0IGltcG9ydE1hcFJlc29sdmVkID0gaW1wb3J0TWFwUmVzb2x2ZShzcGVjaWZpZXIsIGFzVVJMLCBwYXJlbnRVUkwsIGltcG9ydE1hcCk7XHJcbiAgICAgICAgaWYgKGltcG9ydE1hcFJlc29sdmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpbXBvcnRNYXBSZXNvbHZlZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGFzVVJMKSB7XHJcbiAgICAgICAgcmV0dXJuIGFzVVJMO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzcGVjaWZpZXIuc3RhcnRzV2l0aCgnIycpKSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VJbXBvcnRzUmVzb2x2ZShzcGVjaWZpZXIsIHBhcmVudFVSTCwgY29udGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VSZXNvbHZlKHNwZWNpZmllciwgcGFyZW50VVJMLCBjb250ZXh0KTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGRlZmF1bHRDb25kaXRpb25zOiByZWFkb25seSBzdHJpbmdbXSA9IFsnaW1wb3J0J107XHJcblxyXG50eXBlIENvbmRpdGlvbnMgPSByZWFkb25seSBzdHJpbmdbXTtcclxuXHJcbmV4cG9ydCBjb25zdCBkZWZhdWx0TGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zID0gWycuanMnLCAnLmpzb24nXSBhcyBjb25zdCBhcyByZWFkb25seSBzdHJpbmdbXTtcclxuXHJcbmludGVyZmFjZSBSZXNvbHZlQ29udGV4dCB7XHJcbiAgICBjb25kaXRpb25zOiBDb25kaXRpb25zO1xyXG4gICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zOiByZWFkb25seSBzdHJpbmdbXTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcGFja2FnZUltcG9ydHNSZXNvbHZlKF9zcGVjaWZpZXI6IHN0cmluZywgX3BhcmVudFVSTDogVVJMLCBfY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTD4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBXZSBjdXJyZW50bHkgZG8gbm90IHN1cHBvcnQgcGFja2FnZSAnaW1wb3J0cycgZmllbGQuYCk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VSZXNvbHZlKHNwZWNpZmllcjogc3RyaW5nLCBwYXJlbnRVUkw6IFVSTCwgY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTD4ge1xyXG4gICAgY29uc3QgeyBwYWNrYWdlTmFtZSwgaXNTY29wZWQgfSA9IHBhcnNlUGFja2FnZU5hbWUoc3BlY2lmaWVyKTtcclxuICAgIGNvbnN0IHBhY2thZ2VTdWJwYXRoID0gYC4ke3NwZWNpZmllci5zdWJzdHIocGFja2FnZU5hbWUubGVuZ3RoKX1gO1xyXG5cclxuICAgIC8vIFBhY2thZ2Ugc2VsZiByZXNvbHZlXHJcbiAgICBjb25zdCBzZWxmVVJMID0gYXdhaXQgcGFja2FnZVNlbGZSZXNvbHZlKHBhY2thZ2VOYW1lLCBwYWNrYWdlU3VicGF0aCwgcGFyZW50VVJMLCBjb250ZXh0KTtcclxuICAgIGlmIChzZWxmVVJMICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gc2VsZlVSTDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocGFja2FnZVN1YnBhdGggPT09ICcuJyAmJiBpc05vZGVKc0J1aWx0aW5Nb2R1bGUocGFja2FnZU5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwodG9Ob2RlUHJvdG9jb2xVcmwoc3BlY2lmaWVyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgb25seUZpbGVQYWNrYWdlcyA9IHRydWU7XHJcbiAgICBsZXQgcGFja2FnZUpzb25VcmwgPSBuZXcgVVJMKGAuL25vZGVfbW9kdWxlcy8ke3BhY2thZ2VOYW1lfS9wYWNrYWdlLmpzb25gLCBwYXJlbnRVUkwpO1xyXG4gICAgbGV0IGxhc3RQYWNrSnNvblBhdGhuYW1lID0gJyc7XHJcbiAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgIGlmIChvbmx5RmlsZVBhY2thZ2VzICYmICFoYXNGaWxlUHJvdG9jb2wocGFja2FnZUpzb25VcmwpKSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBhY2thZ2VKc29uVXJsLnBhdGhuYW1lID09PSBsYXN0UGFja0pzb25QYXRobmFtZSkge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgbGFzdFBhY2tKc29uUGF0aG5hbWUgPSBwYWNrYWdlSnNvblVybC5wYXRobmFtZTtcclxuXHJcbiAgICAgICAgaWYgKCFhd2FpdCBkaXJFeGlzdHMobmV3IFVSTCgnLi4nLCBwYWNrYWdlSnNvblVybCkpKSB7XHJcbiAgICAgICAgICAgIHBhY2thZ2VKc29uVXJsID0gbmV3IFVSTChcclxuICAgICAgICAgICAgICAgIGAke2lzU2NvcGVkID8gJy4uLy4uLy4uLy4uLycgOiAnLi4vLi4vLi4vJ31ub2RlX21vZHVsZXMvJHtwYWNrYWdlTmFtZX0vcGFja2FnZS5qc29uYCxcclxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uVXJsKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYWNrYWdlSnNvbiA9IGF3YWl0IHJlYWRQYWNrYWdlSnNvbihwYWNrYWdlSnNvblVybCk7XHJcbiAgICAgICAgaWYgKCFwYWNrYWdlSnNvbikge1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwYWNrYWdlSnNvbiAhPT0gbnVsbCAmJiAhaXNOdWxsT3JVbmRlZmluZWQocGFja2FnZUpzb24uZXhwb3J0cykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VFeHBvcnRzUmVzb2x2ZShcclxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uVXJsLFxyXG4gICAgICAgICAgICAgICAgcGFja2FnZVN1YnBhdGgsXHJcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvbi5leHBvcnRzLFxyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgICAgIHBhcmVudFVSTCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHBhY2thZ2VTdWJwYXRoID09PSAnLicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGxlZ2FjeU1haW5SZXNvbHZlKFxyXG4gICAgICAgICAgICAgICAgcGFja2FnZUpzb25VcmwsXHJcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvbixcclxuICAgICAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBuZXcgVVJMKHBhY2thZ2VTdWJwYXRoLCBwYWNrYWdlSnNvblVybCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhyb3cgbmV3IE1vZHVsZU5vdEZvdW5kRXJyb3Ioc3BlY2lmaWVyLCBwYXJlbnRVUkwpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVBhY2thZ2VOYW1lKHNwZWNpZmllcjogc3RyaW5nKSB7XHJcbiAgICBsZXQgcGFja2FnZU5hbWU6IHN0cmluZztcclxuICAgIGxldCBpc1Njb3BlZCA9IGZhbHNlO1xyXG5cclxuICAgIGlmIChzcGVjaWZpZXIubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcihzcGVjaWZpZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlGaXJzdFNsYXNoID0gc3BlY2lmaWVyLmluZGV4T2YoJy8nKTtcclxuICAgIGlmICghc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJ0AnKSkge1xyXG4gICAgICAgIHBhY2thZ2VOYW1lID0gaUZpcnN0U2xhc2ggPCAwXHJcbiAgICAgICAgICAgID8gc3BlY2lmaWVyXHJcbiAgICAgICAgICAgIDogc3BlY2lmaWVyLnN1YnN0cigwLCBpRmlyc3RTbGFzaCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChpRmlyc3RTbGFzaCA8IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcihzcGVjaWZpZXIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlzU2NvcGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgY29uc3QgaVNlY29uZFNsYXNoID0gc3BlY2lmaWVyLmluZGV4T2YoJy8nLCBpRmlyc3RTbGFzaCArIDEpO1xyXG4gICAgICAgICAgICBwYWNrYWdlTmFtZSA9IGlTZWNvbmRTbGFzaCA8IDAgPyBzcGVjaWZpZXIgOiBzcGVjaWZpZXIuc3Vic3RyKDAsIGlTZWNvbmRTbGFzaCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBpc1ZhbGlkID0gdHJ1ZTtcclxuICAgIGlmIChwYWNrYWdlTmFtZS5zdGFydHNXaXRoKCcuJykpIHtcclxuICAgICAgICBpc1ZhbGlkID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhY2thZ2VOYW1lLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKHBhY2thZ2VOYW1lW2ldID09PSAnJScgfHwgcGFja2FnZU5hbWVbaV0gPT09ICdcXFxcJykge1xyXG4gICAgICAgICAgICBpc1ZhbGlkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghaXNWYWxpZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkTW9kdWxlU3BlY2lmaWVyRXJyb3Ioc3BlY2lmaWVyKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4geyBwYWNrYWdlTmFtZSwgaXNTY29wZWQgfTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcGFja2FnZVNlbGZSZXNvbHZlKHBhY2thZ2VOYW1lOiBzdHJpbmcsIHBhY2thZ2VTdWJwYXRoOiBzdHJpbmcsIHBhcmVudFVSTDogVVJMLCBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCk6IFByb21pc2U8VVJMIHwgdW5kZWZpbmVkPiB7XHJcbiAgICBjb25zdCBwYWNrYWdlSnNvbiA9IGF3YWl0IHJlYWRQYWNrYWdlU2NvcGUocGFyZW50VVJMKTtcclxuICAgIGlmIChwYWNrYWdlSnNvbiA9PT0gbnVsbCB8fCBpc051bGxPclVuZGVmaW5lZChwYWNrYWdlSnNvbi5leHBvcnRzKSkge1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICBpZiAocGFja2FnZU5hbWUgPT09IHBhY2thZ2VKc29uLm5hbWUpIHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgcGFja2FnZUV4cG9ydHNSZXNvbHZlKHBhY2thZ2VKc29uLnVybCwgcGFja2FnZVN1YnBhdGgsIHBhY2thZ2VKc29uLmV4cG9ydHMsIGNvbnRleHQsIHBhcmVudFVSTCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVhZFBhY2thZ2VTY29wZSh1cmw6IFVSTCk6IFByb21pc2U8Tm9ybWFsaXplZFBhY2thZ2VKc29uIHwgbnVsbD4ge1xyXG4gICAgbGV0IHBhY2thZ2VKc29uVVJMID0gbmV3IFVSTCgnLi9wYWNrYWdlLmpzb24nLCB1cmwpO1xyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgICBpZiAocGFja2FnZUpzb25VUkwucGF0aG5hbWUuZW5kc1dpdGgoJ25vZGVfbW9kdWxlcy9wYWNrYWdlLmpzb24nKSkge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBhd2FpdCByZWFkUGFja2FnZUpzb24ocGFja2FnZUpzb25VUkwpO1xyXG4gICAgICAgIGlmIChwYWNrYWdlSnNvbiAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcGFja2FnZUpzb247XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGxhc3RQYWNrYWdlSnNvblBhdGhuYW1lID0gcGFja2FnZUpzb25VUkwucGF0aG5hbWU7XHJcbiAgICAgICAgcGFja2FnZUpzb25VUkwgPSBuZXcgVVJMKCcuLi9wYWNrYWdlLmpzb24nLCBwYWNrYWdlSnNvblVSTCk7XHJcbiAgICAgICAgaWYgKHBhY2thZ2VKc29uVVJMLnBhdGhuYW1lID09PSBsYXN0UGFja2FnZUpzb25QYXRobmFtZSkge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQ8VD4odjogVCB8IG51bGwgfCB1bmRlZmluZWQpOiB2IGlzIG51bGwgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHYgPT09IG51bGwgfHwgdiA9PT0gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTm9ybWFsaXplZFBhY2thZ2VKc29uIHtcclxuICAgIHVybDogUmVhZG9ubHk8VVJMPjtcclxuICAgIG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgIHR5cGU6ICdtb2R1bGUnIHwgJ2NvbW1vbmpzJyB8IHVuZGVmaW5lZDtcclxuICAgIG1haW46IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgIGltcG9ydHM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xyXG4gICAgZXhwb3J0czogdW5rbm93bjtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcmVhZFBhY2thZ2VKc29uKHVybDogVVJMKTogUHJvbWlzZTxOb3JtYWxpemVkUGFja2FnZUpzb24gfCBudWxsPiB7XHJcbiAgICBpZiAoIWhhc0ZpbGVQcm90b2NvbCh1cmwpKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBsZXQgc291cmNlO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aCh1cmwpO1xyXG4gICAgICAgIHNvdXJjZSA9IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgsICd1dGY4Jyk7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQganNvbjtcclxuICAgIHRyeSB7XHJcbiAgICAgICAganNvbiA9IEpTT04ucGFyc2Uoc291cmNlKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZUNvbmZpZ3VyYXRpb25FcnJvcihlcnIpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgbWFpbiwgbmFtZSwgdHlwZSwgaW1wb3J0cywgZXhwb3J0cyB9ID0ganNvbjtcclxuXHJcbiAgICBjb25zdCBub3JtYWxpemVkOiBOb3JtYWxpemVkUGFja2FnZUpzb24gPSB7XHJcbiAgICAgICAgdXJsLFxyXG4gICAgICAgIG5hbWU6IHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJyA/IG5hbWUgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgdHlwZTogdHlwZSA9PT0gJ21vZHVsZScgfHwgdHlwZSA9PT0gJ2NvbW1vbmpzJyA/IHR5cGUgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgbWFpbjogdHlwZW9mIG1haW4gPT09ICdzdHJpbmcnID8gbWFpbiA6IHVuZGVmaW5lZCxcclxuICAgICAgICBpbXBvcnRzOiB0eXBlb2YgaW1wb3J0cyAhPT0gJ29iamVjdCcgfHwgaW1wb3J0cyA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IGltcG9ydHMsXHJcbiAgICAgICAgZXhwb3J0cyxcclxuICAgIH07XHJcblxyXG5cclxuICAgIHJldHVybiBub3JtYWxpemVkO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlRXhwb3J0c1Jlc29sdmUoXHJcbiAgICBwYWNrYWdlSnNvblVSTDogVVJMLFxyXG4gICAgc3VicGF0aDogc3RyaW5nLFxyXG4gICAgZXhwb3J0czogdW5rbm93bixcclxuICAgIGNvbnRleHQ6IFJlc29sdmVDb250ZXh0LFxyXG4gICAgcGFyZW50VVJMOiBVUkwsXHJcbik6IFByb21pc2U8VVJMPiB7XHJcbiAgICBsZXQgcHJlZml4ZWRXaXRoRG90OiB1bmRlZmluZWQgfCBib29sZWFuO1xyXG5cclxuICAgIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgZXhwb3J0cyAhPT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhleHBvcnRzKTtcclxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgcHJlZml4ZWRXaXRoRG90ID0ga2V5c1swXS5zdGFydHNXaXRoKCcuJyk7XHJcbiAgICAgICAgICAgIGlmICgha2V5cy5ldmVyeSgoa2V5KSA9PiBrZXkuc3RhcnRzV2l0aCgnLicpID09PSBwcmVmaXhlZFdpdGhEb3QpKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VDb25maWd1cmF0aW9uRXJyb3IocGFja2FnZUpzb25VUkwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChzdWJwYXRoID09PSAnLicpIHtcclxuICAgICAgICBjb25zdCBtYWluRXhwb3J0ID0gdHlwZW9mIGV4cG9ydHMgPT09ICdzdHJpbmcnIHx8IEFycmF5LmlzQXJyYXkoZXhwb3J0cykgfHwgcHJlZml4ZWRXaXRoRG90ID09PSBmYWxzZVxyXG4gICAgICAgICAgICA/IGV4cG9ydHNcclxuICAgICAgICAgICAgOiBwcmVmaXhlZFdpdGhEb3QgPT09IHRydWUgPyAoZXhwb3J0cyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilbJy4nXSA6IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAobWFpbkV4cG9ydCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUocGFja2FnZUpzb25VUkwsIG1haW5FeHBvcnQsICcnLCBmYWxzZSwgZmFsc2UsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKHJlc29sdmVkKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChwcmVmaXhlZFdpdGhEb3QgPT09IHRydWUpIHtcclxuICAgICAgICBjb25zdCBtYXRjaEtleSA9IHN1YnBhdGg7XHJcbiAgICAgICAgY29uc3QgcmVzb2x2ZWRNYXRjaCA9IGF3YWl0IHBhY2thZ2VJbXBvcnRzRXhwb3J0c1Jlc29sdmUoXHJcbiAgICAgICAgICAgIG1hdGNoS2V5LFxyXG4gICAgICAgICAgICBleHBvcnRzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxyXG4gICAgICAgICAgICBwYWNrYWdlSnNvblVSTCxcclxuICAgICAgICAgICAgZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKHJlc29sdmVkTWF0Y2gucmVzb2x2ZWQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZE1hdGNoLnJlc29sdmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aHJvdyBuZXcgUGFja2FnZVBhdGhOb3RFeHBvcnRlZEVycm9yKHN1YnBhdGgsIHBhY2thZ2VKc29uVVJMKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcGFja2FnZUltcG9ydHNFeHBvcnRzUmVzb2x2ZShcclxuICAgIG1hdGNoS2V5OiBzdHJpbmcsXHJcbiAgICBtYXRjaE9iajogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXHJcbiAgICBwYWNrYWdlVVJMOiBVUkwsXHJcbiAgICBpc0ltcG9ydHM6IGJvb2xlYW4sXHJcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcclxuKTogUHJvbWlzZTx7IHJlc29sdmVkOiBVUkwgfCBudWxsIHwgdW5kZWZpbmVkLCBleGFjdDogYm9vbGVhbjsgfT4ge1xyXG4gICAgaWYgKCFtYXRjaEtleS5lbmRzV2l0aCgnKicpICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtYXRjaE9iaiwgbWF0Y2hLZXkpKSB7XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbbWF0Y2hLZXldO1xyXG4gICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUoXHJcbiAgICAgICAgICAgIHBhY2thZ2VVUkwsXHJcbiAgICAgICAgICAgIHRhcmdldCxcclxuICAgICAgICAgICAgJycsXHJcbiAgICAgICAgICAgIGZhbHNlLFxyXG4gICAgICAgICAgICBpc0ltcG9ydHMsXHJcbiAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXNvbHZlZCxcclxuICAgICAgICAgICAgZXhhY3Q6IHRydWUsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMobWF0Y2hPYmopLnNvcnQoKGEsIGIpID0+IGEubGVuZ3RoIC0gYi5sZW5ndGgpO1xyXG4gICAgZm9yIChjb25zdCBleHBhbnNpb25LZXkgb2Yga2V5cykge1xyXG4gICAgICAgIGlmICghKGV4cGFuc2lvbktleS5lbmRzV2l0aCgnLycpIHx8IGV4cGFuc2lvbktleS5lbmRzV2l0aCgnKicpKSkge1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV4cGFuc2lvbktleS5lbmRzV2l0aCgnKicpICYmXHJcbiAgICAgICAgICAgIG1hdGNoS2V5LnN0YXJ0c1dpdGgoZXhwYW5zaW9uS2V5KSAmJlxyXG4gICAgICAgICAgICBtYXRjaEtleSAhPT0gZXhwYW5zaW9uS2V5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG1hdGNoT2JqW2V4cGFuc2lvbktleV07XHJcbiAgICAgICAgICAgIGNvbnN0IHN1YnBhdGggPSBtYXRjaEtleS5zdWJzdHIoZXhwYW5zaW9uS2V5Lmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxyXG4gICAgICAgICAgICAgICAgcGFja2FnZVVSTCxcclxuICAgICAgICAgICAgICAgIHRhcmdldCxcclxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXHJcbiAgICAgICAgICAgICAgICB0cnVlLFxyXG4gICAgICAgICAgICAgICAgaXNJbXBvcnRzLFxyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZWQsIGV4YWN0OiB0cnVlIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtYXRjaEtleS5zdGFydHNXaXRoKGV4cGFuc2lvbktleSkpIHtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbZXhwYW5zaW9uS2V5XTtcclxuICAgICAgICAgICAgY29uc3Qgc3VicGF0aCA9IG1hdGNoS2V5LnN1YnN0cihleHBhbnNpb25LZXkubGVuZ3RoKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcclxuICAgICAgICAgICAgICAgIHBhY2thZ2VVUkwsXHJcbiAgICAgICAgICAgICAgICB0YXJnZXQsXHJcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxyXG4gICAgICAgICAgICAgICAgZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0ltcG9ydHMsXHJcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICByZXR1cm4geyByZXNvbHZlZCwgZXhhY3Q6IGZhbHNlIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7IHJlc29sdmVkOiBudWxsLCBleGFjdDogdHJ1ZSB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcclxuICAgIHBhY2thZ2VVUkw6IFVSTCxcclxuICAgIHRhcmdldDogdW5rbm93bixcclxuICAgIHN1YnBhdGg6IHN0cmluZyxcclxuICAgIHBhdHRlcm46IGJvb2xlYW4sXHJcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcclxuICAgIGNvbnRleHQ6IFJlc29sdmVDb250ZXh0LFxyXG4pOiBQcm9taXNlPFVSTCB8IG51bGwgfCB1bmRlZmluZWQ+IHtcclxuICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCByZXNvbHZlUGFja2FnZVRhcmdldFN0cmluZyhcclxuICAgICAgICAgICAgcGFja2FnZVVSTCxcclxuICAgICAgICAgICAgdGFyZ2V0LFxyXG4gICAgICAgICAgICBzdWJwYXRoLFxyXG4gICAgICAgICAgICBwYXR0ZXJuLFxyXG4gICAgICAgICAgICBpbnRlcm5hbCxcclxuICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgcmVzb2x2ZVBhY2thZ2VUYXJnZXRBcnJheShcclxuICAgICAgICAgICAgcGFja2FnZVVSTCxcclxuICAgICAgICAgICAgdGFyZ2V0LFxyXG4gICAgICAgICAgICBzdWJwYXRoLFxyXG4gICAgICAgICAgICBwYXR0ZXJuLFxyXG4gICAgICAgICAgICBpbnRlcm5hbCxcclxuICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnb2JqZWN0JyAmJiB0YXJnZXQgIT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgcmVzb2x2ZVBhY2thZ2VUYXJnZXRPYmplY3QoXHJcbiAgICAgICAgICAgIHBhY2thZ2VVUkwsXHJcbiAgICAgICAgICAgIHRhcmdldCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcclxuICAgICAgICAgICAgc3VicGF0aCxcclxuICAgICAgICAgICAgcGF0dGVybixcclxuICAgICAgICAgICAgaW50ZXJuYWwsXHJcbiAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGFyZ2V0ID09PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdGhyb3cgbmV3IEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IocGFja2FnZVVSTCk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHJlc29sdmVQYWNrYWdlVGFyZ2V0U3RyaW5nKFxyXG4gICAgcGFja2FnZUpzb25VUkw6IFVSTCxcclxuICAgIHRhcmdldDogc3RyaW5nLFxyXG4gICAgc3VicGF0aDogc3RyaW5nLFxyXG4gICAgcGF0dGVybjogYm9vbGVhbixcclxuICAgIGludGVybmFsOiBib29sZWFuLFxyXG4gICAgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsXHJcbikge1xyXG4gICAgaWYgKCFwYXR0ZXJuICYmIHN1YnBhdGgubGVuZ3RoICE9PSAwICYmICF0YXJnZXQuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkTW9kdWxlU3BlY2lmaWVyRXJyb3IodGFyZ2V0KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRhcmdldC5zdGFydHNXaXRoKCcuLycpKSB7XHJcbiAgICAgICAgaWYgKGludGVybmFsICYmICF0YXJnZXQuc3RhcnRzV2l0aCgnLi4vJykgJiYgIXRhcmdldC5zdGFydHNXaXRoKCcvJykgJiYgIXRyeVBhcnNlVVJMKHRhcmdldCkpIHtcclxuICAgICAgICAgICAgY29uc3QgZXhwb3J0VGFyZ2V0ID0gcGF0dGVyblxyXG4gICAgICAgICAgICAgICAgPyBhcHBseVBhdHRlcm4odGFyZ2V0LCBzdWJwYXRoKVxyXG4gICAgICAgICAgICAgICAgOiB0YXJnZXQgKyBzdWJwYXRoO1xyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgcGFja2FnZVJlc29sdmUoXHJcbiAgICAgICAgICAgICAgICBleHBvcnRUYXJnZXQsXHJcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVSTCxcclxuICAgICAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IocGFja2FnZUpzb25VUkwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBOb3RlOiBgdGFyZ2V0YCBzdGFydHMgd2l0aCAnLi8nIG5vd1xyXG4gICAgaWYgKGRvdE9yRG90RG90T3JOb2RlTW9kdWxlc1NlZ21lbnRSZWdleC50ZXN0KHRhcmdldC5zdWJzdHIoMikpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IocGFja2FnZUpzb25VUkwpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlc29sdmVkID0gbmV3IFVSTCh0YXJnZXQsIHBhY2thZ2VKc29uVVJMKTtcclxuICAgIGNvbnN0IHBhY2thZ2VQYXRoID0gbmV3IFVSTCgnLicsIHBhY2thZ2VKc29uVVJMKTtcclxuICAgIGlmICghcmVzb2x2ZWQucGF0aG5hbWUuc3RhcnRzV2l0aChwYWNrYWdlUGF0aC5wYXRobmFtZSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VUYXJnZXRFcnJvcihwYWNrYWdlSnNvblVSTCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHN1YnBhdGggPT09ICcnKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChkb3RPckRvdERvdE9yTm9kZU1vZHVsZXNTZWdtZW50UmVnZXgudGVzdChzdWJwYXRoKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGF0dGVyblxyXG4gICAgICAgID8gbmV3IFVSTChhcHBseVBhdHRlcm4ocmVzb2x2ZWQuaHJlZiwgc3VicGF0aCkpXHJcbiAgICAgICAgOiBuZXcgVVJMKHN1YnBhdGgsIHJlc29sdmVkKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVBhY2thZ2VUYXJnZXRPYmplY3QoXHJcbiAgICBwYWNrYWdlVVJMOiBVUkwsXHJcbiAgICB0YXJnZXQ6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxyXG4gICAgc3VicGF0aDogc3RyaW5nLFxyXG4gICAgcGF0dGVybjogYm9vbGVhbixcclxuICAgIGludGVybmFsOiBib29sZWFuLFxyXG4gICAgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsXHJcbikge1xyXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XHJcbiAgICBpZiAoa2V5cy5zb21lKGlzQXJyYXlJbmRleCkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VDb25maWd1cmF0aW9uRXJyb3IocGFja2FnZVVSTCk7XHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XHJcbiAgICAgICAgaWYgKGtleSA9PT0gJ2RlZmF1bHQnIHx8IGNvbnRleHQuY29uZGl0aW9ucy5pbmNsdWRlcyhrZXkpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gdGFyZ2V0W2tleV07XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUoXHJcbiAgICAgICAgICAgICAgICBwYWNrYWdlVVJMLFxyXG4gICAgICAgICAgICAgICAgdGFyZ2V0VmFsdWUsXHJcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxyXG4gICAgICAgICAgICAgICAgcGF0dGVybixcclxuICAgICAgICAgICAgICAgIGludGVybmFsLFxyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgaWYgKHJlc29sdmVkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVBhY2thZ2VUYXJnZXRBcnJheShcclxuICAgIHBhY2thZ2VVUkw6IFVSTCxcclxuICAgIHRhcmdldDogdW5rbm93bltdLFxyXG4gICAgc3VicGF0aDogc3RyaW5nLFxyXG4gICAgcGF0dGVybjogYm9vbGVhbixcclxuICAgIGludGVybmFsOiBib29sZWFuLFxyXG4gICAgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsXHJcbikge1xyXG4gICAgaWYgKHRhcmdldC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGxldCBsYXN0RXJyOiBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yIHwgbnVsbCB8IHVuZGVmaW5lZDtcclxuICAgIGZvciAoY29uc3QgdGFyZ2V0VmFsdWUgb2YgdGFyZ2V0KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcclxuICAgICAgICAgICAgICAgIHBhY2thZ2VVUkwsXHJcbiAgICAgICAgICAgICAgICB0YXJnZXRWYWx1ZSxcclxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXHJcbiAgICAgICAgICAgICAgICBwYXR0ZXJuLFxyXG4gICAgICAgICAgICAgICAgaW50ZXJuYWwsXHJcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzb2x2ZWQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxhc3RFcnIgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAvLyAgY29udGludWluZyB0aGUgbG9vcCBvbiBhbnkgSW52YWxpZCBQYWNrYWdlIFRhcmdldCBlcnJvci5cclxuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGxhc3RFcnIgPSBlcnI7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChpc051bGxPclVuZGVmaW5lZChsYXN0RXJyKSkge1xyXG4gICAgICAgIHJldHVybiBsYXN0RXJyO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICB0aHJvdyBsYXN0RXJyO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBseVBhdHRlcm4oczogc3RyaW5nLCByZXBsYWNlcjogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gcy5yZXBsYWNlKC9cXCovZywgcmVwbGFjZXIpO1xyXG59XHJcblxyXG4vLyBNYXRjaCBwYXRoIHNlZ21lbnRcclxuY29uc3QgZG90T3JEb3REb3RPck5vZGVNb2R1bGVzU2VnbWVudFJlZ2V4ID0gLyhefFxcXFx8XFwvKShcXC5cXC4/fG5vZGVfbW9kdWxlcykoXFxcXHxcXC98JCkvO1xyXG5cclxuZnVuY3Rpb24gaXNBcnJheUluZGV4KHM6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qga2V5TnVtID0gK3M7XHJcbiAgICBpZiAoYCR7a2V5TnVtfWAgIT09IHMpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ga2V5TnVtID49IDAgJiYga2V5TnVtIDwgMHhGRkZGX0ZGRkY7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGxlZ2FjeU1haW5SZXNvbHZlKFxyXG4gICAgcGFja2FnZUpzb25Vcmw6IFVSTCxcclxuICAgIHBhY2thZ2VKc29uOiBOb3JtYWxpemVkUGFja2FnZUpzb24sXHJcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcclxuKTogUHJvbWlzZTxVUkw+IHtcclxuICAgIGxldCBndWVzcztcclxuICAgIGlmIChwYWNrYWdlSnNvbi5tYWluICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAvLyBOb3RlOiBmcyBjaGVjayByZWR1bmRhbmNlcyB3aWxsIGJlIGhhbmRsZWQgYnkgRGVzY3JpcHRvciBjYWNoZSBoZXJlLlxyXG4gICAgICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGd1ZXNzID0gbmV3IFVSTChgLi8ke3BhY2thZ2VKc29uLm1haW59YCwgcGFja2FnZUpzb25VcmwpKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ3Vlc3M7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAoY29uc3QgZXh0ZW5zaW9uIG9mIGNvbnRleHQubGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zKSB7XHJcbiAgICAgICAgICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGd1ZXNzID0gbmV3IFVSTChgLi8ke3BhY2thZ2VKc29uLm1haW59JHtleHRlbnNpb259YCwgcGFja2FnZUpzb25VcmwpKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGd1ZXNzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAoY29uc3QgZXh0ZW5zaW9uIG9mIGNvbnRleHQubGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zKSB7XHJcbiAgICAgICAgICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGd1ZXNzID0gbmV3IFVSTChgLi8ke3BhY2thZ2VKc29uLm1haW59L2luZGV4JHtleHRlbnNpb259YCwgcGFja2FnZUpzb25VcmwpKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGd1ZXNzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEZhbGx0aHJvdWdoLlxyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgY29udGV4dC5sZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMpIHtcclxuICAgICAgICBpZiAoYXdhaXQgZmlsZUV4aXN0cyhndWVzcyA9IG5ldyBVUkwoYC4vaW5kZXgke2V4dGVuc2lvbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBndWVzcztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyBOb3QgZm91bmQuXHJcbiAgICB0aHJvdyBuZXcgTW9kdWxlTm90Rm91bmRFcnJvcignPG1haW4+JywgbmV3IFVSTCgnLicsIHBhY2thZ2VKc29uVXJsKSk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGZpbGVFeGlzdHModXJsOiBVUkwpIHtcclxuICAgIHJldHVybiAoYXdhaXQgdHJ5U3RhdCh1cmwpKS5pc0ZpbGUoKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZGlyRXhpc3RzKHVybDogVVJMKSB7XHJcbiAgICByZXR1cm4gKGF3YWl0IHRyeVN0YXQodXJsKSkuaXNEaXJlY3RvcnkoKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gdHJ5U3RhdCh1cmw6IFVSTCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aCh1cmwpO1xyXG4gICAgICAgIHJldHVybiBhd2FpdCBmcy5zdGF0KHBhdGgpO1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBmcy5TdGF0cygpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==