"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.readPackageScope = exports.defaultLegacyMainResolveExtensions = exports.defaultConditions = exports.esmResolve = void 0;
const url_1 = require("url");
const specifier_1 = require("../../utils/specifier");
const url_2 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
const fs_extra_1 = __importDefault(require("fs-extra"));
const import_map_resolve_1 = require("./import-map-resolve");
const node_builtins_1 = require("../utils/node-builtins");
/**
 * Reference:
 * https://nodejs.org/api/esm.html#esm_resolver_algorithm
 * Modification:
 * - Import map are considered.
 */
async function esmResolve(specifier, parentURL, options) {
    var _a;
    const { conditions = exports.defaultConditions, legacyMainResolveExtensions = exports.defaultLegacyMainResolveExtensions, importMap, } = options !== null && options !== void 0 ? options : {};
    const context = {
        conditions,
        legacyMainResolveExtensions,
    };
    let asURL;
    if (specifier_1.isRelativeSpecifier(specifier)) {
        asURL = new url_1.URL(specifier, parentURL);
    }
    else {
        asURL = (_a = url_2.tryParseURL(specifier)) !== null && _a !== void 0 ? _a : null;
    }
    if (importMap) {
        const importMapResolved = import_map_resolve_1.importMapResolve(specifier, asURL, parentURL, importMap);
        if (importMapResolved) {
            return importMapResolved;
        }
    }
    if (asURL) {
        return asURL;
    }
    if (specifier.startsWith('#')) {
        return await packageImportsResolve(specifier, parentURL, context);
    }
    return await packageResolve(specifier, parentURL, context);
}
exports.esmResolve = esmResolve;
exports.defaultConditions = ['import'];
exports.defaultLegacyMainResolveExtensions = ['.js', '.json'];
async function packageImportsResolve(_specifier, _parentURL, _context) {
    throw new Error(`We currently do not support package 'imports' field.`);
}
async function packageResolve(specifier, parentURL, context) {
    const { packageName, isScoped } = parsePackageName(specifier);
    const packageSubpath = `.${specifier.substr(packageName.length)}`;
    // Package self resolve
    const selfURL = await packageSelfResolve(packageName, packageSubpath, parentURL, context);
    if (selfURL !== undefined) {
        return selfURL;
    }
    if (packageSubpath === '.' && node_builtins_1.isNodeJsBuiltinModule(packageName)) {
        return new url_1.URL(node_builtins_1.toNodeProtocolUrl(specifier));
    }
    const onlyFilePackages = true;
    let packageJsonUrl = new url_1.URL(`./node_modules/${packageName}/package.json`, parentURL);
    let lastPackJsonPathname = '';
    while (true) {
        if (onlyFilePackages && !url_2.hasFileProtocol(packageJsonUrl)) {
            break;
        }
        if (packageJsonUrl.pathname === lastPackJsonPathname) {
            break;
        }
        lastPackJsonPathname = packageJsonUrl.pathname;
        if (!await dirExists(new url_1.URL('..', packageJsonUrl))) {
            packageJsonUrl = new url_1.URL(`${isScoped ? '../../../../' : '../../../'}node_modules/${packageName}/package.json`, packageJsonUrl);
            continue;
        }
        const packageJson = await readPackageJson(packageJsonUrl);
        if (!packageJson) {
            continue;
        }
        if (packageJson !== null && !isNullOrUndefined(packageJson.exports)) {
            return await packageExportsResolve(packageJsonUrl, packageSubpath, packageJson.exports, context, parentURL);
        }
        else if (packageSubpath === '.') {
            return await legacyMainResolve(packageJsonUrl, packageJson, context);
        }
        else {
            const resolved = new url_1.URL(packageSubpath, packageJsonUrl);
            return resolved;
        }
    }
    throw new resolve_error_1.ModuleNotFoundError(specifier, parentURL);
}
function parsePackageName(specifier) {
    let packageName;
    let isScoped = false;
    if (specifier.length === 0) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    const iFirstSlash = specifier.indexOf('/');
    if (!specifier.startsWith('@')) {
        packageName = iFirstSlash < 0
            ? specifier
            : specifier.substr(0, iFirstSlash);
    }
    else {
        if (iFirstSlash < 0) {
            throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
        }
        else {
            isScoped = true;
            const iSecondSlash = specifier.indexOf('/', iFirstSlash + 1);
            packageName = iSecondSlash < 0 ? specifier : specifier.substr(0, iSecondSlash);
        }
    }
    let isValid = true;
    if (packageName.startsWith('.')) {
        isValid = false;
    }
    for (let i = 0; i < packageName.length; i++) {
        if (packageName[i] === '%' || packageName[i] === '\\') {
            isValid = false;
            break;
        }
    }
    if (!isValid) {
        throw new resolve_error_1.InvalidModuleSpecifierError(specifier);
    }
    return { packageName, isScoped };
}
async function packageSelfResolve(packageName, packageSubpath, parentURL, context) {
    const packageJson = await readPackageScope(parentURL);
    if (packageJson === null || isNullOrUndefined(packageJson.exports)) {
        return undefined;
    }
    if (packageName === packageJson.name) {
        return await packageExportsResolve(packageJson.url, packageSubpath, packageJson.exports, context, parentURL);
    }
    return undefined;
}
async function readPackageScope(url) {
    let packageJsonURL = new url_1.URL('./package.json', url);
    while (true) {
        if (packageJsonURL.pathname.endsWith('node_modules/package.json')) {
            break;
        }
        const packageJson = await readPackageJson(packageJsonURL);
        if (packageJson !== null) {
            return packageJson;
        }
        const lastPackageJsonPathname = packageJsonURL.pathname;
        packageJsonURL = new url_1.URL('../package.json', packageJsonURL);
        if (packageJsonURL.pathname === lastPackageJsonPathname) {
            break;
        }
    }
    return null;
}
exports.readPackageScope = readPackageScope;
function isNullOrUndefined(v) {
    return v === null || v === undefined;
}
async function readPackageJson(url) {
    if (!url_2.hasFileProtocol(url)) {
        return null;
    }
    let source;
    try {
        const path = url_1.fileURLToPath(url);
        source = await fs_extra_1.default.readFile(path, 'utf8');
    }
    catch (_a) {
        return null;
    }
    let json;
    try {
        json = JSON.parse(source);
    }
    catch (err) {
        throw new resolve_error_1.InvalidPackageConfigurationError(err);
    }
    const { main, name, type, imports, exports } = json;
    const normalized = {
        url,
        name: typeof name === 'string' ? name : undefined,
        type: type === 'module' || type === 'commonjs' ? type : undefined,
        main: typeof main === 'string' ? main : undefined,
        imports: typeof imports !== 'object' || imports === null ? undefined : imports,
        exports,
    };
    return normalized;
}
async function packageExportsResolve(packageJsonURL, subpath, exports, context, parentURL) {
    let prefixedWithDot;
    if (typeof exports === 'object' && exports !== null) {
        const keys = Object.keys(exports);
        if (keys.length !== 0) {
            prefixedWithDot = keys[0].startsWith('.');
            if (!keys.every((key) => key.startsWith('.') === prefixedWithDot)) {
                throw new resolve_error_1.InvalidPackageConfigurationError(packageJsonURL);
            }
        }
    }
    if (subpath === '.') {
        const mainExport = typeof exports === 'string' || Array.isArray(exports) || prefixedWithDot === false
            ? exports
            : prefixedWithDot === true ? exports['.'] : undefined;
        if (mainExport !== undefined) {
            const resolved = await packageTargetResolve(packageJsonURL, mainExport, '', false, false, context);
            if (!isNullOrUndefined(resolved)) {
                return resolved;
            }
        }
    }
    else if (prefixedWithDot === true) {
        const matchKey = subpath;
        const resolvedMatch = await packageImportsExportsResolve(matchKey, exports, packageJsonURL, false, context);
        if (!isNullOrUndefined(resolvedMatch.resolved)) {
            return resolvedMatch.resolved;
        }
    }
    throw new resolve_error_1.PackagePathNotExportedError(subpath, packageJsonURL);
}
async function packageImportsExportsResolve(matchKey, matchObj, packageURL, isImports, context) {
    if (!matchKey.endsWith('*') && Object.prototype.hasOwnProperty.call(matchObj, matchKey)) {
        const target = matchObj[matchKey];
        const resolved = await packageTargetResolve(packageURL, target, '', false, isImports, context);
        return {
            resolved,
            exact: true,
        };
    }
    const keys = Object.getOwnPropertyNames(matchObj).sort((a, b) => a.length - b.length);
    for (const expansionKey of keys) {
        if (!(expansionKey.endsWith('/') || expansionKey.endsWith('*'))) {
            continue;
        }
        if (expansionKey.endsWith('*') &&
            matchKey.startsWith(expansionKey) &&
            matchKey !== expansionKey) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length - 1);
            const resolved = await packageTargetResolve(packageURL, target, subpath, true, isImports, context);
            return { resolved, exact: true };
        }
        if (matchKey.startsWith(expansionKey)) {
            const target = matchObj[expansionKey];
            const subpath = matchKey.substr(expansionKey.length);
            const resolved = await packageTargetResolve(packageURL, target, subpath, false, isImports, context);
            return { resolved, exact: false };
        }
    }
    return { resolved: null, exact: true };
}
async function packageTargetResolve(packageURL, target, subpath, pattern, internal, context) {
    if (typeof target === 'string') {
        return await resolvePackageTargetString(packageURL, target, subpath, pattern, internal, context);
    }
    if (Array.isArray(target)) {
        return await resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context);
    }
    if (typeof target === 'object' && target !== null) {
        return await resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context);
    }
    if (target === null) {
        return null;
    }
    throw new resolve_error_1.InvalidPackageTargetError(packageURL);
}
async function resolvePackageTargetString(packageJsonURL, target, subpath, pattern, internal, context) {
    if (!pattern && subpath.length !== 0 && !target.endsWith('/')) {
        throw new resolve_error_1.InvalidModuleSpecifierError(target);
    }
    if (!target.startsWith('./')) {
        if (internal && !target.startsWith('../') && !target.startsWith('/') && !url_2.tryParseURL(target)) {
            const exportTarget = pattern
                ? applyPattern(target, subpath)
                : target + subpath;
            return await packageResolve(exportTarget, packageJsonURL, context);
        }
        else {
            throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
        }
    }
    // Note: `target` starts with './' now
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(target.substr(2))) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    const resolved = new url_1.URL(target, packageJsonURL);
    const packagePath = new url_1.URL('.', packageJsonURL);
    if (!resolved.pathname.startsWith(packagePath.pathname)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    if (subpath === '') {
        return resolved;
    }
    if (dotOrDotDotOrNodeModulesSegmentRegex.test(subpath)) {
        throw new resolve_error_1.InvalidPackageTargetError(packageJsonURL);
    }
    return pattern
        ? new url_1.URL(applyPattern(resolved.href, subpath))
        : new url_1.URL(subpath, resolved);
}
async function resolvePackageTargetObject(packageURL, target, subpath, pattern, internal, context) {
    const keys = Object.getOwnPropertyNames(target);
    if (keys.some(isArrayIndex)) {
        throw new resolve_error_1.InvalidPackageConfigurationError(packageURL);
    }
    for (const key of keys) {
        if (key === 'default' || context.conditions.includes(key)) {
            const targetValue = target[key];
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else {
                return resolved;
            }
        }
    }
    return undefined;
}
async function resolvePackageTargetArray(packageURL, target, subpath, pattern, internal, context) {
    if (target.length === 0) {
        return null;
    }
    let lastErr;
    for (const targetValue of target) {
        try {
            const resolved = await packageTargetResolve(packageURL, targetValue, subpath, pattern, internal, context);
            if (resolved === undefined) {
                continue;
            }
            else if (resolved === null) {
                lastErr = null;
                continue;
            }
            return resolved;
        }
        catch (err) {
            //  continuing the loop on any Invalid Package Target error.
            if (err instanceof resolve_error_1.InvalidPackageTargetError) {
                lastErr = err;
                continue;
            }
            else {
                throw err;
            }
        }
    }
    if (isNullOrUndefined(lastErr)) {
        return lastErr;
    }
    else {
        throw lastErr;
    }
}
function applyPattern(s, replacer) {
    return s.replace(/\*/g, replacer);
}
// Match path segment
const dotOrDotDotOrNodeModulesSegmentRegex = /(^|\\|\/)(\.\.?|node_modules)(\\|\/|$)/;
function isArrayIndex(s) {
    const keyNum = +s;
    if (`${keyNum}` !== s) {
        return false;
    }
    return keyNum >= 0 && keyNum < 4294967295;
}
async function legacyMainResolve(packageJsonUrl, packageJson, context) {
    let guess;
    if (packageJson.main !== undefined) {
        // Note: fs check redundances will be handled by Descriptor cache here.
        if (await fileExists(guess = new url_1.URL(`./${packageJson.main}`, packageJsonUrl))) {
            return guess;
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        for (const extension of context.legacyMainResolveExtensions) {
            if (await fileExists(guess = new url_1.URL(`./${packageJson.main}/index${extension}`, packageJsonUrl))) {
                return guess;
            }
        }
        // Fallthrough.
    }
    for (const extension of context.legacyMainResolveExtensions) {
        if (await fileExists(guess = new url_1.URL(`./index${extension}`, packageJsonUrl))) {
            return guess;
        }
    }
    // Not found.
    throw new resolve_error_1.ModuleNotFoundError('<main>', new url_1.URL('.', packageJsonUrl));
}
async function fileExists(url) {
    return (await tryStat(url)).isFile();
}
async function dirExists(url) {
    return (await tryStat(url)).isDirectory();
}
async function tryStat(url) {
    try {
        const path = url_1.fileURLToPath(url);
        return await fs_extra_1.default.stat(path);
    }
    catch (_a) {
        return new fs_extra_1.default.Stats();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNtLXJlc29sdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvbW9kLWxvL3Jlc29sdmVyL2VzbS1yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLDZCQUF3RDtBQUN4RCxxREFBNEQ7QUFDNUQseUNBQStEO0FBQy9ELG1EQUE4TTtBQUM5TSx3REFBMEI7QUFHMUIsNkRBQXdEO0FBQ3hELDBEQUFrRjtBQUVsRjs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxVQUFVLENBQUMsU0FBaUIsRUFBRSxTQUFjLEVBQUUsT0FJbkU7O0lBQ0csTUFBTSxFQUNGLFVBQVUsR0FBRyx5QkFBaUIsRUFDOUIsMkJBQTJCLEdBQUcsMENBQWtDLEVBQ2hFLFNBQVMsR0FDWixHQUFHLE9BQU8sYUFBUCxPQUFPLGNBQVAsT0FBTyxHQUFJLEVBQUUsQ0FBQztJQUVsQixNQUFNLE9BQU8sR0FBbUI7UUFDNUIsVUFBVTtRQUNWLDJCQUEyQjtLQUM5QixDQUFDO0lBRUYsSUFBSSxLQUFpQixDQUFDO0lBQ3RCLElBQUksK0JBQW1CLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDaEMsS0FBSyxHQUFHLElBQUksU0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUN6QztTQUFNO1FBQ0gsS0FBSyxTQUFHLGlCQUFXLENBQUMsU0FBUyxDQUFDLG1DQUFJLElBQUksQ0FBQztLQUMxQztJQUVELElBQUksU0FBUyxFQUFFO1FBQ1gsTUFBTSxpQkFBaUIsR0FBRyxxQ0FBZ0IsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNuRixJQUFJLGlCQUFpQixFQUFFO1lBQ25CLE9BQU8saUJBQWlCLENBQUM7U0FDNUI7S0FDSjtJQUVELElBQUksS0FBSyxFQUFFO1FBQ1AsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFFRCxJQUFJLFNBQVMsQ0FBQyxVQUFV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QUFDLENBQUM7UUFDaEMsT0FBTyxNQUFNLGtCQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQzlCO0lBQUMsV0FBTTtRQUNKLE9BQU8sSUFBSSxrQkFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQ3pCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgVVJMLCBmaWxlVVJMVG9QYXRoLCBwYXRoVG9GaWxlVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IGlzUmVsYXRpdmVTcGVjaWZpZXIgfSBmcm9tICcuLi8uLi91dGlscy9zcGVjaWZpZXInO1xuaW1wb3J0IHsgaGFzRmlsZVByb3RvY29sLCB0cnlQYXJzZVVSTCB9IGZyb20gJy4uLy4uL3V0aWxzL3VybCc7XG5pbXBvcnQgeyBJbnZhbGlkTW9kdWxlU3BlY2lmaWVyRXJyb3IsIEludmFsaWRQYWNrYWdlQ29uZmlndXJhdGlvbkVycm9yLCBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yLCBNb2R1bGVOb3RGb3VuZEVycm9yLCBQYWNrYWdlUGF0aE5vdEV4cG9ydGVkRXJyb3IsIFVuc3VwcG9ydGVkRGlyZWN0b3J5SW1wb3J0RXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBhcnNlZEltcG9ydE1hcCB9IGZyb20gJy4vcGFyc2VkLWltcG9ydC1tYXAnO1xuaW1wb3J0IHsgaW1wb3J0TWFwUmVzb2x2ZSB9IGZyb20gJy4vaW1wb3J0LW1hcC1yZXNvbHZlJztcbmltcG9ydCB7IGlzTm9kZUpzQnVpbHRpbk1vZHVsZSwgdG9Ob2RlUHJvdG9jb2xVcmwgfSBmcm9tICcuLi91dGlscy9ub2RlLWJ1aWx0aW5zJztcblxuLyoqXG4gKiBSZWZlcmVuY2U6XG4gKiBodHRwczovL25vZGVqcy5vcmcvYXBpL2VzbS5odG1sI2VzbV9yZXNvbHZlcl9hbGdvcml0aG1cbiAqIE1vZGlmaWNhdGlvbjpcbiAqIC0gSW1wb3J0IG1hcCBhcmUgY29uc2lkZXJlZC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVzbVJlc29sdmUoc3BlY2lmaWVyOiBzdHJpbmcsIHBhcmVudFVSTDogVVJMLCBvcHRpb25zPzoge1xuICAgIGltcG9ydE1hcD86IFBhcnNlZEltcG9ydE1hcDtcbiAgICBjb25kaXRpb25zPzogQ29uZGl0aW9ucztcbiAgICBsZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnM/OiBzdHJpbmdbXTtcbn0pOiBQcm9taXNlPFVSTD4ge1xuICAgIGNvbnN0IHtcbiAgICAgICAgY29uZGl0aW9ucyA9IGRlZmF1bHRDb25kaXRpb25zLFxuICAgICAgICBsZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMgPSBkZWZhdWx0TGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxuICAgICAgICBpbXBvcnRNYXAsXG4gICAgfSA9IG9wdGlvbnMgPz8ge307XG5cbiAgICBjb25zdCBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCA9IHtcbiAgICAgICAgY29uZGl0aW9ucyxcbiAgICAgICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zLFxuICAgIH07XG5cbiAgICBsZXQgYXNVUkw6IFVSTCB8IG51bGw7XG4gICAgaWYgKGlzUmVsYXRpdmVTcGVjaWZpZXIoc3BlY2lmaWVyKSkge1xuICAgICAgICBhc1VSTCA9IG5ldyBVUkwoc3BlY2lmaWVyLCBwYXJlbnRVUkwpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGFzVVJMID0gdHJ5UGFyc2VVUkwoc3BlY2lmaWVyKSA/PyBudWxsO1xuICAgIH1cblxuICAgIGlmIChpbXBvcnRNYXApIHtcbiAgICAgICAgY29uc3QgaW1wb3J0TWFwUmVzb2x2ZWQgPSBpbXBvcnRNYXBSZXNvbHZlKHNwZWNpZmllciwgYXNVUkwsIHBhcmVudFVSTCwgaW1wb3J0TWFwKTtcbiAgICAgICAgaWYgKGltcG9ydE1hcFJlc29sdmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gaW1wb3J0TWFwUmVzb2x2ZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoYXNVUkwpIHtcbiAgICAgICAgcmV0dXJuIGFzVVJMO1xuICAgIH1cblxuICAgIGlmIChzcGVjaWZpZXIuc3RhcnRzV2l0aCgnIycpKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBwYWNrYWdlSW1wb3J0c1Jlc29sdmUoc3BlY2lmaWVyLCBwYXJlbnRVUkwsIGNvbnRleHQpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBwYWNrYWdlUmVzb2x2ZShzcGVjaWZpZXIsIHBhcmVudFVSTCwgY29udGV4dCk7XG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0Q29uZGl0aW9uczogcmVhZG9ubHkgc3RyaW5nW10gPSBbJ2ltcG9ydCddO1xuXG50eXBlIENvbmRpdGlvbnMgPSByZWFkb25seSBzdHJpbmdbXTtcblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRMZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMgPSBbJy5qcycsICcuanNvbiddIGFzIGNvbnN0IGFzIHJlYWRvbmx5IHN0cmluZ1tdO1xuXG5pbnRlcmZhY2UgUmVzb2x2ZUNvbnRleHQge1xuICAgIGNvbmRpdGlvbnM6IENvbmRpdGlvbnM7XG4gICAgbGVnYWN5TWFpblJlc29sdmVFeHRlbnNpb25zOiByZWFkb25seSBzdHJpbmdbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFja2FnZUltcG9ydHNSZXNvbHZlKF9zcGVjaWZpZXI6IHN0cmluZywgX3BhcmVudFVSTDogVVJMLCBfY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTD4ge1xuICAgIHRocm93IG5ldyBFcnJvcihgV2UgY3VycmVudGx5IGRvIG5vdCBzdXBwb3J0IHBhY2thZ2UgJ2ltcG9ydHMnIGZpZWxkLmApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlUmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgcGFyZW50VVJMOiBVUkwsIGNvbnRleHQ6IFJlc29sdmVDb250ZXh0KTogUHJvbWlzZTxVUkw+IHtcbiAgICBjb25zdCB7IHBhY2thZ2VOYW1lLCBpc1Njb3BlZCB9ID0gcGFyc2VQYWNrYWdlTmFtZShzcGVjaWZpZXIpO1xuICAgIGNvbnN0IHBhY2thZ2VTdWJwYXRoID0gYC4ke3NwZWNpZmllci5zdWJzdHIocGFja2FnZU5hbWUubGVuZ3RoKX1gO1xuXG4gICAgLy8gUGFja2FnZSBzZWxmIHJlc29sdmVcbiAgICBjb25zdCBzZWxmVVJMID0gYXdhaXQgcGFja2FnZVNlbGZSZXNvbHZlKHBhY2thZ2VOYW1lLCBwYWNrYWdlU3VicGF0aCwgcGFyZW50VVJMLCBjb250ZXh0KTtcbiAgICBpZiAoc2VsZlVSTCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBzZWxmVVJMO1xuICAgIH1cblxuICAgIGlmIChwYWNrYWdlU3VicGF0aCA9PT0gJy4nICYmIGlzTm9kZUpzQnVpbHRpbk1vZHVsZShwYWNrYWdlTmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwodG9Ob2RlUHJvdG9jb2xVcmwoc3BlY2lmaWVyKSk7XG4gICAgfVxuXG4gICAgY29uc3Qgb25seUZpbGVQYWNrYWdlcyA9IHRydWU7XG4gICAgbGV0IHBhY2thZ2VKc29uVXJsID0gbmV3IFVSTChgLi9ub2RlX21vZHVsZXMvJHtwYWNrYWdlTmFtZX0vcGFja2FnZS5qc29uYCwgcGFyZW50VVJMKTtcbiAgICBsZXQgbGFzdFBhY2tKc29uUGF0aG5hbWUgPSAnJztcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBpZiAob25seUZpbGVQYWNrYWdlcyAmJiAhaGFzRmlsZVByb3RvY29sKHBhY2thZ2VKc29uVXJsKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFja2FnZUpzb25VcmwucGF0aG5hbWUgPT09IGxhc3RQYWNrSnNvblBhdGhuYW1lKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBsYXN0UGFja0pzb25QYXRobmFtZSA9IHBhY2thZ2VKc29uVXJsLnBhdGhuYW1lO1xuXG4gICAgICAgIGlmICghYXdhaXQgZGlyRXhpc3RzKG5ldyBVUkwoJy4uJywgcGFja2FnZUpzb25VcmwpKSkge1xuICAgICAgICAgICAgcGFja2FnZUpzb25VcmwgPSBuZXcgVVJMKFxuICAgICAgICAgICAgICAgIGAke2lzU2NvcGVkID8gJy4uLy4uLy4uLy4uLycgOiAnLi4vLi4vLi4vJ31ub2RlX21vZHVsZXMvJHtwYWNrYWdlTmFtZX0vcGFja2FnZS5qc29uYCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVybCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gYXdhaXQgcmVhZFBhY2thZ2VKc29uKHBhY2thZ2VKc29uVXJsKTtcbiAgICAgICAgaWYgKCFwYWNrYWdlSnNvbikge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFja2FnZUpzb24gIT09IG51bGwgJiYgIWlzTnVsbE9yVW5kZWZpbmVkKHBhY2thZ2VKc29uLmV4cG9ydHMpKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgcGFja2FnZUV4cG9ydHNSZXNvbHZlKFxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uVXJsLFxuICAgICAgICAgICAgICAgIHBhY2thZ2VTdWJwYXRoLFxuICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uLmV4cG9ydHMsXG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICBwYXJlbnRVUkwsXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHBhY2thZ2VTdWJwYXRoID09PSAnLicpIHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBsZWdhY3lNYWluUmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVybCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvbixcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gbmV3IFVSTChwYWNrYWdlU3VicGF0aCwgcGFja2FnZUpzb25VcmwpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IE1vZHVsZU5vdEZvdW5kRXJyb3Ioc3BlY2lmaWVyLCBwYXJlbnRVUkwpO1xufVxuXG5mdW5jdGlvbiBwYXJzZVBhY2thZ2VOYW1lKHNwZWNpZmllcjogc3RyaW5nKSB7XG4gICAgbGV0IHBhY2thZ2VOYW1lOiBzdHJpbmc7XG4gICAgbGV0IGlzU2NvcGVkID0gZmFsc2U7XG5cbiAgICBpZiAoc3BlY2lmaWVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE1vZHVsZVNwZWNpZmllckVycm9yKHNwZWNpZmllcik7XG4gICAgfVxuXG4gICAgY29uc3QgaUZpcnN0U2xhc2ggPSBzcGVjaWZpZXIuaW5kZXhPZignLycpO1xuICAgIGlmICghc3BlY2lmaWVyLnN0YXJ0c1dpdGgoJ0AnKSkge1xuICAgICAgICBwYWNrYWdlTmFtZSA9IGlGaXJzdFNsYXNoIDwgMFxuICAgICAgICAgICAgPyBzcGVjaWZpZXJcbiAgICAgICAgICAgIDogc3BlY2lmaWVyLnN1YnN0cigwLCBpRmlyc3RTbGFzaCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlGaXJzdFNsYXNoIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcihzcGVjaWZpZXIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXNTY29wZWQgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgaVNlY29uZFNsYXNoID0gc3BlY2lmaWVyLmluZGV4T2YoJy8nLCBpRmlyc3RTbGFzaCArIDEpO1xuICAgICAgICAgICAgcGFja2FnZU5hbWUgPSBpU2Vjb25kU2xhc2ggPCAwID8gc3BlY2lmaWVyIDogc3BlY2lmaWVyLnN1YnN0cigwLCBpU2Vjb25kU2xhc2gpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGlzVmFsaWQgPSB0cnVlO1xuICAgIGlmIChwYWNrYWdlTmFtZS5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgICAgaXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhY2thZ2VOYW1lLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChwYWNrYWdlTmFtZVtpXSA9PT0gJyUnIHx8IHBhY2thZ2VOYW1lW2ldID09PSAnXFxcXCcpIHtcbiAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE1vZHVsZVNwZWNpZmllckVycm9yKHNwZWNpZmllcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcGFja2FnZU5hbWUsIGlzU2NvcGVkIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VTZWxmUmVzb2x2ZShwYWNrYWdlTmFtZTogc3RyaW5nLCBwYWNrYWdlU3VicGF0aDogc3RyaW5nLCBwYXJlbnRVUkw6IFVSTCwgY29udGV4dDogUmVzb2x2ZUNvbnRleHQpOiBQcm9taXNlPFVSTCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gYXdhaXQgcmVhZFBhY2thZ2VTY29wZShwYXJlbnRVUkwpO1xuICAgIGlmIChwYWNrYWdlSnNvbiA9PT0gbnVsbCB8fCBpc051bGxPclVuZGVmaW5lZChwYWNrYWdlSnNvbi5leHBvcnRzKSkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAocGFja2FnZU5hbWUgPT09IHBhY2thZ2VKc29uLm5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VFeHBvcnRzUmVzb2x2ZShwYWNrYWdlSnNvbi51cmwsIHBhY2thZ2VTdWJwYXRoLCBwYWNrYWdlSnNvbi5leHBvcnRzLCBjb250ZXh0LCBwYXJlbnRVUkwpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVhZFBhY2thZ2VTY29wZSh1cmw6IFVSTCk6IFByb21pc2U8Tm9ybWFsaXplZFBhY2thZ2VKc29uIHwgbnVsbD4ge1xuICAgIGxldCBwYWNrYWdlSnNvblVSTCA9IG5ldyBVUkwoJy4vcGFja2FnZS5qc29uJywgdXJsKTtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBpZiAocGFja2FnZUpzb25VUkwucGF0aG5hbWUuZW5kc1dpdGgoJ25vZGVfbW9kdWxlcy9wYWNrYWdlLmpzb24nKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBhd2FpdCByZWFkUGFja2FnZUpzb24ocGFja2FnZUpzb25VUkwpO1xuICAgICAgICBpZiAocGFja2FnZUpzb24gIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBwYWNrYWdlSnNvbjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsYXN0UGFja2FnZUpzb25QYXRobmFtZSA9IHBhY2thZ2VKc29uVVJMLnBhdGhuYW1lO1xuICAgICAgICBwYWNrYWdlSnNvblVSTCA9IG5ldyBVUkwoJy4uL3BhY2thZ2UuanNvbicsIHBhY2thZ2VKc29uVVJMKTtcbiAgICAgICAgaWYgKHBhY2thZ2VKc29uVVJMLnBhdGhuYW1lID09PSBsYXN0UGFja2FnZUpzb25QYXRobmFtZSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkPFQ+KHY6IFQgfCBudWxsIHwgdW5kZWZpbmVkKTogdiBpcyBudWxsIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdiA9PT0gbnVsbCB8fCB2ID09PSB1bmRlZmluZWQ7XG59XG5cbmludGVyZmFjZSBOb3JtYWxpemVkUGFja2FnZUpzb24ge1xuICAgIHVybDogUmVhZG9ubHk8VVJMPjtcbiAgICBuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgdHlwZTogJ21vZHVsZScgfCAnY29tbW9uanMnIHwgdW5kZWZpbmVkO1xuICAgIG1haW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpbXBvcnRzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICBleHBvcnRzOiB1bmtub3duO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkUGFja2FnZUpzb24odXJsOiBVUkwpOiBQcm9taXNlPE5vcm1hbGl6ZWRQYWNrYWdlSnNvbiB8IG51bGw+IHtcbiAgICBpZiAoIWhhc0ZpbGVQcm90b2NvbCh1cmwpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgc291cmNlO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBmaWxlVVJMVG9QYXRoKHVybCk7XG4gICAgICAgIHNvdXJjZSA9IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgsICd1dGY4Jyk7XG4gICAgfSBjYXRjaCB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxldCBqc29uO1xuICAgIHRyeSB7XG4gICAgICAgIGpzb24gPSBKU09OLnBhcnNlKHNvdXJjZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZUNvbmZpZ3VyYXRpb25FcnJvcihlcnIpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgbWFpbiwgbmFtZSwgdHlwZSwgaW1wb3J0cywgZXhwb3J0cyB9ID0ganNvbjtcblxuICAgIGNvbnN0IG5vcm1hbGl6ZWQ6IE5vcm1hbGl6ZWRQYWNrYWdlSnNvbiA9IHtcbiAgICAgICAgdXJsLFxuICAgICAgICBuYW1lOiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycgPyBuYW1lIDogdW5kZWZpbmVkLFxuICAgICAgICB0eXBlOiB0eXBlID09PSAnbW9kdWxlJyB8fCB0eXBlID09PSAnY29tbW9uanMnID8gdHlwZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgbWFpbjogdHlwZW9mIG1haW4gPT09ICdzdHJpbmcnID8gbWFpbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgaW1wb3J0czogdHlwZW9mIGltcG9ydHMgIT09ICdvYmplY3QnIHx8IGltcG9ydHMgPT09IG51bGwgPyB1bmRlZmluZWQgOiBpbXBvcnRzLFxuICAgICAgICBleHBvcnRzLFxuICAgIH07XG5cblxuICAgIHJldHVybiBub3JtYWxpemVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWNrYWdlRXhwb3J0c1Jlc29sdmUoXG4gICAgcGFja2FnZUpzb25VUkw6IFVSTCxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgZXhwb3J0czogdW5rbm93bixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbiAgICBwYXJlbnRVUkw6IFVSTCxcbik6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IHByZWZpeGVkV2l0aERvdDogdW5kZWZpbmVkIHwgYm9vbGVhbjtcblxuICAgIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgZXhwb3J0cyAhPT0gbnVsbCkge1xuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZXhwb3J0cyk7XG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgcHJlZml4ZWRXaXRoRG90ID0ga2V5c1swXS5zdGFydHNXaXRoKCcuJyk7XG4gICAgICAgICAgICBpZiAoIWtleXMuZXZlcnkoKGtleSkgPT4ga2V5LnN0YXJ0c1dpdGgoJy4nKSA9PT0gcHJlZml4ZWRXaXRoRG90KSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZUNvbmZpZ3VyYXRpb25FcnJvcihwYWNrYWdlSnNvblVSTCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc3VicGF0aCA9PT0gJy4nKSB7XG4gICAgICAgIGNvbnN0IG1haW5FeHBvcnQgPSB0eXBlb2YgZXhwb3J0cyA9PT0gJ3N0cmluZycgfHwgQXJyYXkuaXNBcnJheShleHBvcnRzKSB8fCBwcmVmaXhlZFdpdGhEb3QgPT09IGZhbHNlXG4gICAgICAgICAgICA/IGV4cG9ydHNcbiAgICAgICAgICAgIDogcHJlZml4ZWRXaXRoRG90ID09PSB0cnVlID8gKGV4cG9ydHMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pWycuJ10gOiB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChtYWluRXhwb3J0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUocGFja2FnZUpzb25VUkwsIG1haW5FeHBvcnQsICcnLCBmYWxzZSwgZmFsc2UsIGNvbnRleHQpO1xuICAgICAgICAgICAgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZXNvbHZlZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByZWZpeGVkV2l0aERvdCA9PT0gdHJ1ZSkge1xuICAgICAgICBjb25zdCBtYXRjaEtleSA9IHN1YnBhdGg7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkTWF0Y2ggPSBhd2FpdCBwYWNrYWdlSW1wb3J0c0V4cG9ydHNSZXNvbHZlKFxuICAgICAgICAgICAgbWF0Y2hLZXksXG4gICAgICAgICAgICBleHBvcnRzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgICAgICAgICAgcGFja2FnZUpzb25VUkwsXG4gICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgICAgIGlmICghaXNOdWxsT3JVbmRlZmluZWQocmVzb2x2ZWRNYXRjaC5yZXNvbHZlZCkpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZE1hdGNoLnJlc29sdmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IFBhY2thZ2VQYXRoTm90RXhwb3J0ZWRFcnJvcihzdWJwYXRoLCBwYWNrYWdlSnNvblVSTCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VJbXBvcnRzRXhwb3J0c1Jlc29sdmUoXG4gICAgbWF0Y2hLZXk6IHN0cmluZyxcbiAgICBtYXRjaE9iajogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgcGFja2FnZVVSTDogVVJMLFxuICAgIGlzSW1wb3J0czogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbik6IFByb21pc2U8eyByZXNvbHZlZDogVVJMIHwgbnVsbCB8IHVuZGVmaW5lZCwgZXhhY3Q6IGJvb2xlYW47IH0+IHtcbiAgICBpZiAoIW1hdGNoS2V5LmVuZHNXaXRoKCcqJykgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1hdGNoT2JqLCBtYXRjaEtleSkpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbbWF0Y2hLZXldO1xuICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBpc0ltcG9ydHMsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVzb2x2ZWQsXG4gICAgICAgICAgICBleGFjdDogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMobWF0Y2hPYmopLnNvcnQoKGEsIGIpID0+IGEubGVuZ3RoIC0gYi5sZW5ndGgpO1xuICAgIGZvciAoY29uc3QgZXhwYW5zaW9uS2V5IG9mIGtleXMpIHtcbiAgICAgICAgaWYgKCEoZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcvJykgfHwgZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcqJykpKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXhwYW5zaW9uS2V5LmVuZHNXaXRoKCcqJykgJiZcbiAgICAgICAgICAgIG1hdGNoS2V5LnN0YXJ0c1dpdGgoZXhwYW5zaW9uS2V5KSAmJlxuICAgICAgICAgICAgbWF0Y2hLZXkgIT09IGV4cGFuc2lvbktleSkge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbZXhwYW5zaW9uS2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnBhdGggPSBtYXRjaEtleS5zdWJzdHIoZXhwYW5zaW9uS2V5Lmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxuICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgaXNJbXBvcnRzLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZWQsIGV4YWN0OiB0cnVlIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1hdGNoS2V5LnN0YXJ0c1dpdGgoZXhwYW5zaW9uS2V5KSkge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gbWF0Y2hPYmpbZXhwYW5zaW9uS2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHN1YnBhdGggPSBtYXRjaEtleS5zdWJzdHIoZXhwYW5zaW9uS2V5Lmxlbmd0aCk7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgICAgICAgICAgICAgIHBhY2thZ2VVUkwsXG4gICAgICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgaXNJbXBvcnRzLFxuICAgICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZWQsIGV4YWN0OiBmYWxzZSB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcmVzb2x2ZWQ6IG51bGwsIGV4YWN0OiB0cnVlIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhY2thZ2VUYXJnZXRSZXNvbHZlKFxuICAgIHBhY2thZ2VVUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHVua25vd24sXG4gICAgc3VicGF0aDogc3RyaW5nLFxuICAgIHBhdHRlcm46IGJvb2xlYW4sXG4gICAgaW50ZXJuYWw6IGJvb2xlYW4sXG4gICAgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsXG4pOiBQcm9taXNlPFVSTCB8IG51bGwgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHJlc29sdmVQYWNrYWdlVGFyZ2V0U3RyaW5nKFxuICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICBwYXR0ZXJuLFxuICAgICAgICAgICAgaW50ZXJuYWwsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHJlc29sdmVQYWNrYWdlVGFyZ2V0QXJyYXkoXG4gICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgc3VicGF0aCxcbiAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICdvYmplY3QnICYmIHRhcmdldCAhPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gYXdhaXQgcmVzb2x2ZVBhY2thZ2VUYXJnZXRPYmplY3QoXG4gICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgdGFyZ2V0IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgICAgICAgICAgc3VicGF0aCxcbiAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRhcmdldCA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VUYXJnZXRFcnJvcihwYWNrYWdlVVJMKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVBhY2thZ2VUYXJnZXRTdHJpbmcoXG4gICAgcGFja2FnZUpzb25VUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHN0cmluZyxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGlmICghcGF0dGVybiAmJiBzdWJwYXRoLmxlbmd0aCAhPT0gMCAmJiAhdGFyZ2V0LmVuZHNXaXRoKCcvJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRNb2R1bGVTcGVjaWZpZXJFcnJvcih0YXJnZXQpO1xuICAgIH1cblxuICAgIGlmICghdGFyZ2V0LnN0YXJ0c1dpdGgoJy4vJykpIHtcbiAgICAgICAgaWYgKGludGVybmFsICYmICF0YXJnZXQuc3RhcnRzV2l0aCgnLi4vJykgJiYgIXRhcmdldC5zdGFydHNXaXRoKCcvJykgJiYgIXRyeVBhcnNlVVJMKHRhcmdldCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGV4cG9ydFRhcmdldCA9IHBhdHRlcm5cbiAgICAgICAgICAgICAgICA/IGFwcGx5UGF0dGVybih0YXJnZXQsIHN1YnBhdGgpXG4gICAgICAgICAgICAgICAgOiB0YXJnZXQgKyBzdWJwYXRoO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHBhY2thZ2VSZXNvbHZlKFxuICAgICAgICAgICAgICAgIGV4cG9ydFRhcmdldCxcbiAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblVSTCxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdGU6IGB0YXJnZXRgIHN0YXJ0cyB3aXRoICcuLycgbm93XG4gICAgaWYgKGRvdE9yRG90RG90T3JOb2RlTW9kdWxlc1NlZ21lbnRSZWdleC50ZXN0KHRhcmdldC5zdWJzdHIoMikpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXNvbHZlZCA9IG5ldyBVUkwodGFyZ2V0LCBwYWNrYWdlSnNvblVSTCk7XG4gICAgY29uc3QgcGFja2FnZVBhdGggPSBuZXcgVVJMKCcuJywgcGFja2FnZUpzb25VUkwpO1xuICAgIGlmICghcmVzb2x2ZWQucGF0aG5hbWUuc3RhcnRzV2l0aChwYWNrYWdlUGF0aC5wYXRobmFtZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IocGFja2FnZUpzb25VUkwpO1xuICAgIH1cblxuICAgIGlmIChzdWJwYXRoID09PSAnJykge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gICAgfVxuXG4gICAgaWYgKGRvdE9yRG90RG90T3JOb2RlTW9kdWxlc1NlZ21lbnRSZWdleC50ZXN0KHN1YnBhdGgpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkUGFja2FnZVRhcmdldEVycm9yKHBhY2thZ2VKc29uVVJMKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF0dGVyblxuICAgICAgICA/IG5ldyBVUkwoYXBwbHlQYXR0ZXJuKHJlc29sdmVkLmhyZWYsIHN1YnBhdGgpKVxuICAgICAgICA6IG5ldyBVUkwoc3VicGF0aCwgcmVzb2x2ZWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUGFja2FnZVRhcmdldE9iamVjdChcbiAgICBwYWNrYWdlVVJMOiBVUkwsXG4gICAgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0YXJnZXQpO1xuICAgIGlmIChrZXlzLnNvbWUoaXNBcnJheUluZGV4KSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFBhY2thZ2VDb25maWd1cmF0aW9uRXJyb3IocGFja2FnZVVSTCk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ2RlZmF1bHQnIHx8IGNvbnRleHQuY29uZGl0aW9ucy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9IHRhcmdldFtrZXldO1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBwYWNrYWdlVGFyZ2V0UmVzb2x2ZShcbiAgICAgICAgICAgICAgICBwYWNrYWdlVVJMLFxuICAgICAgICAgICAgICAgIHRhcmdldFZhbHVlLFxuICAgICAgICAgICAgICAgIHN1YnBhdGgsXG4gICAgICAgICAgICAgICAgcGF0dGVybixcbiAgICAgICAgICAgICAgICBpbnRlcm5hbCxcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChyZXNvbHZlZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUGFja2FnZVRhcmdldEFycmF5KFxuICAgIHBhY2thZ2VVUkw6IFVSTCxcbiAgICB0YXJnZXQ6IHVua25vd25bXSxcbiAgICBzdWJwYXRoOiBzdHJpbmcsXG4gICAgcGF0dGVybjogYm9vbGVhbixcbiAgICBpbnRlcm5hbDogYm9vbGVhbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbikge1xuICAgIGlmICh0YXJnZXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgbGFzdEVycjogSW52YWxpZFBhY2thZ2VUYXJnZXRFcnJvciB8IG51bGwgfCB1bmRlZmluZWQ7XG4gICAgZm9yIChjb25zdCB0YXJnZXRWYWx1ZSBvZiB0YXJnZXQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcGFja2FnZVRhcmdldFJlc29sdmUoXG4gICAgICAgICAgICAgICAgcGFja2FnZVVSTCxcbiAgICAgICAgICAgICAgICB0YXJnZXRWYWx1ZSxcbiAgICAgICAgICAgICAgICBzdWJwYXRoLFxuICAgICAgICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgICAgICAgaW50ZXJuYWwsXG4gICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNvbHZlZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGxhc3RFcnIgPSBudWxsO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIC8vICBjb250aW51aW5nIHRoZSBsb29wIG9uIGFueSBJbnZhbGlkIFBhY2thZ2UgVGFyZ2V0IGVycm9yLlxuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEludmFsaWRQYWNrYWdlVGFyZ2V0RXJyb3IpIHtcbiAgICAgICAgICAgICAgICBsYXN0RXJyID0gZXJyO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKGxhc3RFcnIpKSB7XG4gICAgICAgIHJldHVybiBsYXN0RXJyO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGxhc3RFcnI7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhcHBseVBhdHRlcm4oczogc3RyaW5nLCByZXBsYWNlcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHMucmVwbGFjZSgvXFwqL2csIHJlcGxhY2VyKTtcbn1cblxuLy8gTWF0Y2ggcGF0aCBzZWdtZW50XG5jb25zdCBkb3RPckRvdERvdE9yTm9kZU1vZHVsZXNTZWdtZW50UmVnZXggPSAvKF58XFxcXHxcXC8pKFxcLlxcLj98bm9kZV9tb2R1bGVzKShcXFxcfFxcL3wkKS87XG5cbmZ1bmN0aW9uIGlzQXJyYXlJbmRleChzOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBrZXlOdW0gPSArcztcbiAgICBpZiAoYCR7a2V5TnVtfWAgIT09IHMpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4ga2V5TnVtID49IDAgJiYga2V5TnVtIDwgMHhGRkZGX0ZGRkY7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxlZ2FjeU1haW5SZXNvbHZlKFxuICAgIHBhY2thZ2VKc29uVXJsOiBVUkwsXG4gICAgcGFja2FnZUpzb246IE5vcm1hbGl6ZWRQYWNrYWdlSnNvbixcbiAgICBjb250ZXh0OiBSZXNvbHZlQ29udGV4dCxcbik6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IGd1ZXNzO1xuICAgIGlmIChwYWNrYWdlSnNvbi5tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gTm90ZTogZnMgY2hlY2sgcmVkdW5kYW5jZXMgd2lsbCBiZSBoYW5kbGVkIGJ5IERlc2NyaXB0b3IgY2FjaGUgaGVyZS5cbiAgICAgICAgaWYgKGF3YWl0IGZpbGVFeGlzdHMoZ3Vlc3MgPSBuZXcgVVJMKGAuLyR7cGFja2FnZUpzb24ubWFpbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3Vlc3M7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgY29udGV4dC5sZWdhY3lNYWluUmVzb2x2ZUV4dGVuc2lvbnMpIHtcbiAgICAgICAgICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGd1ZXNzID0gbmV3IFVSTChgLi8ke3BhY2thZ2VKc29uLm1haW59JHtleHRlbnNpb259YCwgcGFja2FnZUpzb25VcmwpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBndWVzcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IGV4dGVuc2lvbiBvZiBjb250ZXh0LmxlZ2FjeU1haW5SZXNvbHZlRXh0ZW5zaW9ucykge1xuICAgICAgICAgICAgaWYgKGF3YWl0IGZpbGVFeGlzdHMoZ3Vlc3MgPSBuZXcgVVJMKGAuLyR7cGFja2FnZUpzb24ubWFpbn0vaW5kZXgke2V4dGVuc2lvbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGd1ZXNzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIEZhbGx0aHJvdWdoLlxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGV4dGVuc2lvbiBvZiBjb250ZXh0LmxlZ2FjeU1haW5SZXNvbHZlRXh0ZW5zaW9ucykge1xuICAgICAgICBpZiAoYXdhaXQgZmlsZUV4aXN0cyhndWVzcyA9IG5ldyBVUkwoYC4vaW5kZXgke2V4dGVuc2lvbn1gLCBwYWNrYWdlSnNvblVybCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gZ3Vlc3M7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gTm90IGZvdW5kLlxuICAgIHRocm93IG5ldyBNb2R1bGVOb3RGb3VuZEVycm9yKCc8bWFpbj4nLCBuZXcgVVJMKCcuJywgcGFja2FnZUpzb25VcmwpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmlsZUV4aXN0cyh1cmw6IFVSTCkge1xuICAgIHJldHVybiAoYXdhaXQgdHJ5U3RhdCh1cmwpKS5pc0ZpbGUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGlyRXhpc3RzKHVybDogVVJMKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0cnlTdGF0KHVybCkpLmlzRGlyZWN0b3J5KCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRyeVN0YXQodXJsOiBVUkwpIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aCh1cmwpO1xuICAgICAgICByZXR1cm4gYXdhaXQgZnMuc3RhdChwYXRoKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIG5ldyBmcy5TdGF0cygpO1xuICAgIH1cbn1cbiJdfQ==