"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cjsResolve = void 0;
const resolve_1 = __importDefault(require("resolve"));
const url_1 = require("url");
const path_1 = __importDefault(require("path"));
const url_2 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
const asserts_1 = require("../../../utils/asserts");
async function cjsResolve(specifier, parentURL) {
    if (!url_2.hasFileProtocol(parentURL)) {
        throw new resolve_error_1.CjsModuleNotFileError(parentURL);
    }
    const parentPath = url_1.fileURLToPath(parentURL);
    const basedir = path_1.default.dirname(parentPath);
    const resolveOpts = {
        basedir,
    };
    const resolvedPath = await new Promise((done, rejected) => {
        resolve_1.default(specifier, resolveOpts, (err, resolved, _pkg) => {
            if (err) {
                rejected(new resolve_error_1.ModuleNotFoundError(specifier, parentURL));
            }
            else {
                asserts_1.asserts(resolved);
                done(resolved);
            }
        });
    });
    const resolved = url_1.pathToFileURL(resolvedPath);
    return resolved;
}
exports.cjsResolve = cjsResolve;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2pzLXJlc29sdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvbW9kLWxvL3Jlc29sdmVyL2Nqcy1yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLHNEQUE4QjtBQUM5Qiw2QkFBd0Q7QUFDeEQsZ0RBQXNCO0FBQ3RCLHlDQUFrRDtBQUNsRCxtREFBNkU7QUFDN0Usb0RBQWlEO0FBRTFDLEtBQUssVUFBVSxVQUFVLENBQUMsU0FBaUIsRUFBRSxTQUFjO0lBQzlELElBQUksQ0FBQyxxQkFBZSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQzdCLE1BQU0sSUFBSSxxQ0FBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUM5QztJQUVELE1BQU0sVUFBVSxHQUFHLG1CQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsTUFBTSxPQUFPLEdBQUcsY0FBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN2QyxNQUFNLFdBQVcsR0FBc0I7UUFDbkMsT0FBTztLQUNWLENBQUM7SUFFRixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksT0FBTyxDQUFTLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFO1FBQzlELGlCQUFPLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDcEQsSUFBSSxHQUFHLEVBQUU7Z0JBQ0wsUUFBUSxDQUFDLElBQUksbUNBQW1CLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7YUFDM0Q7aUJBQU07Z0JBQ0gsaUJBQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2xCO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sUUFBUSxHQUFHLG1CQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0MsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQztBQXhCRCxnQ0F3QkMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCByZXNvbHZlIGZyb20gJ3Jlc29sdmUnO1xuaW1wb3J0IHsgVVJMLCBmaWxlVVJMVG9QYXRoLCBwYXRoVG9GaWxlVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IGhhc0ZpbGVQcm90b2NvbCB9IGZyb20gJy4uLy4uL3V0aWxzL3VybCc7XG5pbXBvcnQgeyBDanNNb2R1bGVOb3RGaWxlRXJyb3IsIE1vZHVsZU5vdEZvdW5kRXJyb3IgfSBmcm9tICcuL3Jlc29sdmUtZXJyb3InO1xuaW1wb3J0IHsgYXNzZXJ0cyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2Fzc2VydHMnO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2pzUmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgcGFyZW50VVJMOiBVUkwpOiBQcm9taXNlPFVSTD4ge1xuICAgIGlmICghaGFzRmlsZVByb3RvY29sKHBhcmVudFVSTCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IENqc01vZHVsZU5vdEZpbGVFcnJvcihwYXJlbnRVUkwpO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcmVudFBhdGggPSBmaWxlVVJMVG9QYXRoKHBhcmVudFVSTCk7XG4gICAgY29uc3QgYmFzZWRpciA9IHBzLmRpcm5hbWUocGFyZW50UGF0aCk7XG4gICAgY29uc3QgcmVzb2x2ZU9wdHM6IHJlc29sdmUuQXN5bmNPcHRzID0ge1xuICAgICAgICBiYXNlZGlyLFxuICAgIH07XG5cbiAgICBjb25zdCByZXNvbHZlZFBhdGggPSBhd2FpdCBuZXcgUHJvbWlzZTxzdHJpbmc+KChkb25lLCByZWplY3RlZCkgPT4ge1xuICAgICAgICByZXNvbHZlKHNwZWNpZmllciwgcmVzb2x2ZU9wdHMsIChlcnIsIHJlc29sdmVkLCBfcGtnKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0ZWQobmV3IE1vZHVsZU5vdEZvdW5kRXJyb3Ioc3BlY2lmaWVyLCBwYXJlbnRVUkwpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0cyhyZXNvbHZlZCk7XG4gICAgICAgICAgICAgICAgZG9uZShyZXNvbHZlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzb2x2ZWQgPSBwYXRoVG9GaWxlVVJMKHJlc29sdmVkUGF0aCk7XG4gICAgcmV0dXJuIHJlc29sdmVkO1xufVxuIl19