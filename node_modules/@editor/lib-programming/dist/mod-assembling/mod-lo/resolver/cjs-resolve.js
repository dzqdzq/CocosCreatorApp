"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cjsResolve = void 0;
const resolve_1 = __importDefault(require("resolve"));
const url_1 = require("url");
const path_1 = __importDefault(require("path"));
const url_2 = require("../../utils/url");
const resolve_error_1 = require("./resolve-error");
const asserts_1 = require("../../../utils/asserts");
const node_builtins_1 = require("../utils/node-builtins");
async function cjsResolve(specifier, parentURL) {
    if (!url_2.hasFileProtocol(parentURL)) {
        throw new resolve_error_1.CjsModuleNotFileError(parentURL);
    }
    const parentPath = url_1.fileURLToPath(parentURL);
    const basedir = path_1.default.dirname(parentPath);
    const resolveOpts = {
        basedir,
    };
    const resolvedPath = await new Promise((done, rejected) => {
        resolve_1.default(specifier, resolveOpts, (err, resolved, _pkg) => {
            if (err) {
                rejected(new resolve_error_1.ModuleNotFoundError(specifier, parentURL));
            }
            else {
                asserts_1.asserts(resolved);
                done(resolved);
            }
        });
    });
    if (node_builtins_1.isNodeJsBuiltinModule(resolvedPath)) {
        return new url_1.URL(node_builtins_1.toNodeProtocolUrl(resolvedPath));
    }
    const resolved = url_1.pathToFileURL(resolvedPath);
    return resolved;
}
exports.cjsResolve = cjsResolve;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2pzLXJlc29sdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvbW9kLWxvL3Jlc29sdmVyL2Nqcy1yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLHNEQUE4QjtBQUM5Qiw2QkFBd0Q7QUFDeEQsZ0RBQXNCO0FBQ3RCLHlDQUFrRDtBQUNsRCxtREFBNkU7QUFDN0Usb0RBQWlEO0FBQ2pELDBEQUFrRjtBQUUzRSxLQUFLLFVBQVUsVUFBVSxDQUFDLFNBQWlCLEVBQUUsU0FBYztJQUM5RCxJQUFJLENBQUMscUJBQWUsQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUM3QixNQUFNLElBQUkscUNBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDOUM7SUFFRCxNQUFNLFVBQVUsR0FBRyxtQkFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVDLE1BQU0sT0FBTyxHQUFHLGNBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdkMsTUFBTSxXQUFXLEdBQXNCO1FBQ25DLE9BQU87S0FDVixDQUFDO0lBRUYsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRTtRQUM5RCxpQkFBTyxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3BELElBQUksR0FBRyxFQUFFO2dCQUNMLFFBQVEsQ0FBQyxJQUFJLG1DQUFtQixDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO2FBQzNEO2lCQUFNO2dCQUNILGlCQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNsQjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLHFDQUFxQixDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQ3JDLE9BQU8sSUFBSSxTQUFHLENBQUMsaUNBQWlCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztLQUNuRDtJQUVELE1BQU0sUUFBUSxHQUFHLG1CQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0MsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQztBQTVCRCxnQ0E0QkMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHJlc29sdmUgZnJvbSAncmVzb2x2ZSc7XHJcbmltcG9ydCB7IFVSTCwgZmlsZVVSTFRvUGF0aCwgcGF0aFRvRmlsZVVSTCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgaGFzRmlsZVByb3RvY29sIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXJsJztcclxuaW1wb3J0IHsgQ2pzTW9kdWxlTm90RmlsZUVycm9yLCBNb2R1bGVOb3RGb3VuZEVycm9yIH0gZnJvbSAnLi9yZXNvbHZlLWVycm9yJztcclxuaW1wb3J0IHsgYXNzZXJ0cyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2Fzc2VydHMnO1xyXG5pbXBvcnQgeyBpc05vZGVKc0J1aWx0aW5Nb2R1bGUsIHRvTm9kZVByb3RvY29sVXJsIH0gZnJvbSAnLi4vdXRpbHMvbm9kZS1idWlsdGlucyc7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2pzUmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgcGFyZW50VVJMOiBVUkwpOiBQcm9taXNlPFVSTD4ge1xyXG4gICAgaWYgKCFoYXNGaWxlUHJvdG9jb2wocGFyZW50VVJMKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBDanNNb2R1bGVOb3RGaWxlRXJyb3IocGFyZW50VVJMKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYXJlbnRQYXRoID0gZmlsZVVSTFRvUGF0aChwYXJlbnRVUkwpO1xyXG4gICAgY29uc3QgYmFzZWRpciA9IHBzLmRpcm5hbWUocGFyZW50UGF0aCk7XHJcbiAgICBjb25zdCByZXNvbHZlT3B0czogcmVzb2x2ZS5Bc3luY09wdHMgPSB7XHJcbiAgICAgICAgYmFzZWRpcixcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzb2x2ZWRQYXRoID0gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPigoZG9uZSwgcmVqZWN0ZWQpID0+IHtcclxuICAgICAgICByZXNvbHZlKHNwZWNpZmllciwgcmVzb2x2ZU9wdHMsIChlcnIsIHJlc29sdmVkLCBfcGtnKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdGVkKG5ldyBNb2R1bGVOb3RGb3VuZEVycm9yKHNwZWNpZmllciwgcGFyZW50VVJMKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnRzKHJlc29sdmVkKTtcclxuICAgICAgICAgICAgICAgIGRvbmUocmVzb2x2ZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoaXNOb2RlSnNCdWlsdGluTW9kdWxlKHJlc29sdmVkUGF0aCkpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFVSTCh0b05vZGVQcm90b2NvbFVybChyZXNvbHZlZFBhdGgpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXNvbHZlZCA9IHBhdGhUb0ZpbGVVUkwocmVzb2x2ZWRQYXRoKTtcclxuICAgIHJldHVybiByZXNvbHZlZDtcclxufVxyXG4iXX0=