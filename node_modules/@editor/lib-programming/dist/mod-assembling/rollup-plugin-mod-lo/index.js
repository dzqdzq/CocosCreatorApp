"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const generator_1 = __importDefault(require("@babel/generator"));
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const asserts_1 = require("../../utils/asserts");
const specifier_1 = require("../utils/specifier");
const babel = __importStar(require("@babel/core"));
// NOTE: DO NOT REMOVE the null character `\0` as it may be used by other plugins
// e.g. https://github.com/rollup/rollup-plugin-node-resolve/blob/313a3e32f432f9eb18cc4c231cc7aac6df317a51/src/index.js#L74
const HELPERS = '\0rollupPluginModLoBabelHelpers.js';
function $({ modLo, }) {
    const myName = 'rollup-plugin-mod-lo';
    const baseURL = url_1.pathToFileURL(process.cwd() + path_1.default.sep);
    const loadMetaMap = {};
    return {
        name: myName,
        resolveId,
        load,
    };
    async function resolveId(source, importer, _options) {
        if (source === HELPERS) {
            return {
                id: HELPERS,
            };
        }
        if (!importer) {
            asserts_1.asserts(!specifier_1.isRelativeSpecifier(source));
            return {
                id: source,
            };
        }
        const loadMeta = loadMetaMap[importer];
        if (!loadMeta) {
            return null;
        }
        const { url: importerURL, modLoMetadata: importerModLoMetadata, } = loadMeta;
        try {
            const resolved = await modLo.resolve(source, importerURL, importerModLoMetadata);
            if (resolved.isExternal) {
                return {
                    external: true,
                    id: source,
                };
            }
            else {
                return {
                    id: resolved.url.href,
                };
            }
        }
        catch (err) {
            return this.error(err);
        }
    }
    async function load(id) {
        if (id === HELPERS) {
            // @ts-ignore
            return babel.buildExternalHelpers(null, 'module');
        }
        let url;
        try {
            url = new url_1.URL(id);
        }
        catch (_a) {
            return null;
        }
        let modLoModule;
        try {
            modLoModule = await modLo.load(url);
        }
        catch (err) {
            return null;
        }
        loadMetaMap[id] = {
            url,
            modLoMetadata: modLoModule.modLoMetadata,
        };
        let code;
        let map;
        if (typeof modLoModule.code === 'string') {
            code = modLoModule.code;
            map = modLoModule.map;
        }
        else {
            const generateResult = generator_1.default(modLoModule.code);
            code = generateResult.code;
            map = generateResult.map;
        }
        return {
            code,
            map,
        };
    }
}
(function ($) {
    function filterWarns(warning, defaultHandler) {
        if (warning.code === 'CIRCULAR_DEPENDENCY') {
            if (warning.cycle && warning.cycle.every((id) => id.includes('node_modules'))) {
                return;
            }
        }
        defaultHandler(warning);
    }
    $.filterWarns = filterWarns;
    $.helperModule = HELPERS;
})($ || ($ = {}));
exports.default = $;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcm9sbHVwLXBsdWdpbi1tb2QtbG8vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0EsaUVBQXdDO0FBQ3hDLGdEQUFzQjtBQUN0Qiw2QkFBeUM7QUFFekMsaURBQThDO0FBQzlDLGtEQUF5RDtBQUN6RCxtREFBcUM7QUFFckMsaUZBQWlGO0FBQ2pGLDJIQUEySDtBQUMzSCxNQUFNLE9BQU8sR0FBRyxvQ0FBb0MsQ0FBQztBQUVyRCxTQUFTLENBQUMsQ0FBQyxFQUNQLEtBQUssR0FHUjtJQUNHLE1BQU0sTUFBTSxHQUFHLHNCQUFzQixDQUFDO0lBQ3RDLE1BQU0sT0FBTyxHQUFrQixtQkFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxjQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckUsTUFBTSxXQUFXLEdBR1osRUFBRSxDQUFDO0lBRVIsT0FBTztRQUNILElBQUksRUFBRSxNQUFNO1FBQ1osU0FBUztRQUNULElBQUk7S0FDUCxDQUFDO0lBRUYsS0FBSyxVQUFVLFNBQVMsQ0FFcEIsTUFBYyxFQUNkLFFBQTRCLEVBQzVCLFFBQWlEO1FBRWpELElBQUksTUFBTSxLQUFLLE9BQU8sRUFBRTtZQUNwQixPQUFPO2dCQUNILEVBQUUsRUFBRSxPQUFPO2FBQ2QsQ0FBQztTQUNMO1FBRUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLGlCQUFPLENBQUMsQ0FBQywrQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLE9BQU87Z0JBQ0gsRUFBRSxFQUFFLE1BQU07YUFDYixDQUFDO1NBQ0w7UUFDRCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLEVBQ0YsR0FBRyxFQUFFLFdBQVcsRUFDaEIsYUFBYSxFQUFFLHFCQUFxQixHQUN2QyxHQUFHLFFBQVEsQ0FBQztRQUViLElBQUk7WUFDQSxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxPQUFPLENBQ2hDLE1BQU0sRUFDTixXQUFXLEVBQ1gscUJBQXFCLENBQ3hCLENBQUM7WUFDRixJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3JCLE9BQU87b0JBQ0gsUUFBUSxFQUFFLElBQUk7b0JBQ2QsRUFBRSxFQUFFLE1BQU07aUJBQ2IsQ0FBQzthQUNMO2lCQUFNO2dCQUNILE9BQU87b0JBQ0gsRUFBRSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSTtpQkFDeEIsQ0FBQzthQUNMO1NBQ0o7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFFRCxLQUFLLFVBQVUsSUFBSSxDQUVmLEVBQVU7UUFFVixJQUFJLEVBQUUsS0FBSyxPQUFPLEVBQUU7WUFDaEIsYUFBYTtZQUNiLE9BQU8sS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNyRDtRQUVELElBQUksR0FBUSxDQUFDO1FBQ2IsSUFBSTtZQUNBLEdBQUcsR0FBRyxJQUFJLFNBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNyQjtRQUFDLFdBQU07WUFDSixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsSUFBSSxXQUFnQixDQUFDO1FBQ3JCLElBQUk7WUFDQSxXQUFXLEdBQUcsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsV0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHO1lBQ2QsR0FBRztZQUNILGFBQWEsRUFBRSxXQUFXLENBQUMsYUFBYTtTQUMzQyxDQUFDO1FBRUYsSUFBSSxJQUFZLENBQUM7UUFDakIsSUFBSSxHQUFRLENBQUM7UUFDYixJQUFJLE9BQU8sV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDdEMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUM7WUFDeEIsR0FBRyxHQUFHLFdBQVcsQ0FBQyxHQUF1RCxDQUFDO1NBQzdFO2FBQU07WUFDSCxNQUFNLGNBQWMsR0FBRyxtQkFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRCxJQUFJLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQztZQUMzQixHQUFHLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQztTQUM1QjtRQUVELE9BQU87WUFDSCxJQUFJO1lBQ0osR0FBRztTQUNOLENBQUM7SUFDTixDQUFDO0FBQ0wsQ0FBQztBQUVELFdBQVUsQ0FBQztJQUNQLFNBQWdCLFdBQVcsQ0FDdkIsT0FBNkIsRUFDN0IsY0FBcUM7UUFDckMsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLHFCQUFxQixFQUFFO1lBQ3hDLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFO2dCQUMzRSxPQUFPO2FBQ1Y7U0FDSjtRQUNELGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBVGUsYUFBVyxjQVMxQixDQUFBO0lBRVksY0FBWSxHQUFHLE9BQU8sQ0FBQztBQUN4QyxDQUFDLEVBYlMsQ0FBQyxLQUFELENBQUMsUUFhVjtBQUVELGtCQUFlLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5cclxuaW1wb3J0ICogYXMgcm9sbHVwIGZyb20gJ3JvbGx1cCc7XHJcbmltcG9ydCBnZW5lcmF0ZSBmcm9tICdAYmFiZWwvZ2VuZXJhdG9yJztcclxuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBwYXRoVG9GaWxlVVJMLCBVUkwgfSBmcm9tICd1cmwnO1xyXG5pbXBvcnQgeyBNb2QsIE1vZExvLCBNb2RMb01ldGFkYXRhIH0gZnJvbSAnLi4vbW9kLWxvL21vZC1sbyc7XHJcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi91dGlscy9hc3NlcnRzJztcclxuaW1wb3J0IHsgaXNSZWxhdGl2ZVNwZWNpZmllciB9IGZyb20gJy4uL3V0aWxzL3NwZWNpZmllcic7XHJcbmltcG9ydCAqIGFzIGJhYmVsIGZyb20gJ0BiYWJlbC9jb3JlJztcclxuXHJcbi8vIE5PVEU6IERPIE5PVCBSRU1PVkUgdGhlIG51bGwgY2hhcmFjdGVyIGBcXDBgIGFzIGl0IG1heSBiZSB1c2VkIGJ5IG90aGVyIHBsdWdpbnNcclxuLy8gZS5nLiBodHRwczovL2dpdGh1Yi5jb20vcm9sbHVwL3JvbGx1cC1wbHVnaW4tbm9kZS1yZXNvbHZlL2Jsb2IvMzEzYTNlMzJmNDMyZjllYjE4Y2M0YzIzMWNjN2FhYzZkZjMxN2E1MS9zcmMvaW5kZXguanMjTDc0XHJcbmNvbnN0IEhFTFBFUlMgPSAnXFwwcm9sbHVwUGx1Z2luTW9kTG9CYWJlbEhlbHBlcnMuanMnO1xyXG5cclxuZnVuY3Rpb24gJCh7XHJcbiAgICBtb2RMbyxcclxufToge1xyXG4gICAgbW9kTG86IE1vZExvO1xyXG59KTogcm9sbHVwLlBsdWdpbiB7XHJcbiAgICBjb25zdCBteU5hbWUgPSAncm9sbHVwLXBsdWdpbi1tb2QtbG8nO1xyXG4gICAgY29uc3QgYmFzZVVSTDogUmVhZG9ubHk8VVJMPiA9IHBhdGhUb0ZpbGVVUkwocHJvY2Vzcy5jd2QoKSArIHBzLnNlcCk7XHJcbiAgICBjb25zdCBsb2FkTWV0YU1hcDogUmVjb3JkPHN0cmluZywge1xyXG4gICAgICAgIHVybDogUmVhZG9ubHk8VVJMPjtcclxuICAgICAgICBtb2RMb01ldGFkYXRhOiBNb2RMb01ldGFkYXRhO1xyXG4gICAgfT4gPSB7fTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIG5hbWU6IG15TmFtZSxcclxuICAgICAgICByZXNvbHZlSWQsXHJcbiAgICAgICAgbG9hZCxcclxuICAgIH07XHJcblxyXG4gICAgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUlkKFxyXG4gICAgICAgIHRoaXM6IHJvbGx1cC5QbHVnaW5Db250ZXh0LFxyXG4gICAgICAgIHNvdXJjZTogc3RyaW5nLFxyXG4gICAgICAgIGltcG9ydGVyOiBzdHJpbmcgfCB1bmRlZmluZWQsXHJcbiAgICAgICAgX29wdGlvbnM6IHsgY3VzdG9tPzogcm9sbHVwLkN1c3RvbVBsdWdpbk9wdGlvbnMgfSxcclxuICAgICk6IFByb21pc2U8cm9sbHVwLlBhcnRpYWxSZXNvbHZlZElkIHwgbnVsbD4ge1xyXG4gICAgICAgIGlmIChzb3VyY2UgPT09IEhFTFBFUlMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGlkOiBIRUxQRVJTLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIWltcG9ydGVyKSB7XHJcbiAgICAgICAgICAgIGFzc2VydHMoIWlzUmVsYXRpdmVTcGVjaWZpZXIoc291cmNlKSk7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpZDogc291cmNlLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBsb2FkTWV0YSA9IGxvYWRNZXRhTWFwW2ltcG9ydGVyXTtcclxuICAgICAgICBpZiAoIWxvYWRNZXRhKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICAgIHVybDogaW1wb3J0ZXJVUkwsXHJcbiAgICAgICAgICAgIG1vZExvTWV0YWRhdGE6IGltcG9ydGVyTW9kTG9NZXRhZGF0YSxcclxuICAgICAgICB9ID0gbG9hZE1ldGE7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgbW9kTG8ucmVzb2x2ZShcclxuICAgICAgICAgICAgICAgIHNvdXJjZSxcclxuICAgICAgICAgICAgICAgIGltcG9ydGVyVVJMLFxyXG4gICAgICAgICAgICAgICAgaW1wb3J0ZXJNb2RMb01ldGFkYXRhLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpZiAocmVzb2x2ZWQuaXNFeHRlcm5hbCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBleHRlcm5hbDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBpZDogc291cmNlLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc29sdmVkLnVybC5ocmVmLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5lcnJvcihlcnIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBmdW5jdGlvbiBsb2FkKFxyXG4gICAgICAgIHRoaXM6IHJvbGx1cC5QbHVnaW5Db250ZXh0LFxyXG4gICAgICAgIGlkOiBzdHJpbmcsXHJcbiAgICApOiBQcm9taXNlPHJvbGx1cC5Mb2FkUmVzdWx0IHwgbnVsbD4ge1xyXG4gICAgICAgIGlmIChpZCA9PT0gSEVMUEVSUykge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBiYWJlbC5idWlsZEV4dGVybmFsSGVscGVycyhudWxsLCAnbW9kdWxlJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdXJsOiBVUkw7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdXJsID0gbmV3IFVSTChpZCk7XHJcbiAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG1vZExvTW9kdWxlOiBNb2Q7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbW9kTG9Nb2R1bGUgPSBhd2FpdCBtb2RMby5sb2FkKHVybCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbG9hZE1ldGFNYXBbaWRdID0ge1xyXG4gICAgICAgICAgICB1cmwsXHJcbiAgICAgICAgICAgIG1vZExvTWV0YWRhdGE6IG1vZExvTW9kdWxlLm1vZExvTWV0YWRhdGEsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbGV0IGNvZGU6IHN0cmluZztcclxuICAgICAgICBsZXQgbWFwOiBhbnk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBtb2RMb01vZHVsZS5jb2RlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBjb2RlID0gbW9kTG9Nb2R1bGUuY29kZTtcclxuICAgICAgICAgICAgbWFwID0gbW9kTG9Nb2R1bGUubWFwIGFzIHVua25vd24gYXMgcm9sbHVwLlNvdXJjZU1hcCB8IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBnZW5lcmF0ZVJlc3VsdCA9IGdlbmVyYXRlKG1vZExvTW9kdWxlLmNvZGUpO1xyXG4gICAgICAgICAgICBjb2RlID0gZ2VuZXJhdGVSZXN1bHQuY29kZTtcclxuICAgICAgICAgICAgbWFwID0gZ2VuZXJhdGVSZXN1bHQubWFwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY29kZSxcclxuICAgICAgICAgICAgbWFwLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuXHJcbm5hbWVzcGFjZSAkIHtcclxuICAgIGV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJXYXJucyhcclxuICAgICAgICB3YXJuaW5nOiByb2xsdXAuUm9sbHVwV2FybmluZyxcclxuICAgICAgICBkZWZhdWx0SGFuZGxlcjogcm9sbHVwLldhcm5pbmdIYW5kbGVyKSB7XHJcbiAgICAgICAgaWYgKHdhcm5pbmcuY29kZSA9PT0gJ0NJUkNVTEFSX0RFUEVOREVOQ1knKSB7XHJcbiAgICAgICAgICAgIGlmICh3YXJuaW5nLmN5Y2xlICYmIHdhcm5pbmcuY3ljbGUuZXZlcnkoKGlkKSA9PiBpZC5pbmNsdWRlcygnbm9kZV9tb2R1bGVzJykpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZGVmYXVsdEhhbmRsZXIod2FybmluZyk7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNvbnN0IGhlbHBlck1vZHVsZSA9IEhFTFBFUlM7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0ICQ7XHJcbiJdfQ==