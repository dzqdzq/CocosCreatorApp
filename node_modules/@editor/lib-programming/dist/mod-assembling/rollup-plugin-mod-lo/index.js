"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const generator_1 = __importDefault(require("@babel/generator"));
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const asserts_1 = require("../../utils/asserts");
const specifier_1 = require("../utils/specifier");
const babel = __importStar(require("@babel/core"));
// NOTE: DO NOT REMOVE the null character `\0` as it may be used by other plugins
// e.g. https://github.com/rollup/rollup-plugin-node-resolve/blob/313a3e32f432f9eb18cc4c231cc7aac6df317a51/src/index.js#L74
const HELPERS = '\0rollupPluginModLoBabelHelpers.js';
function $({ modLo, }) {
    const myName = 'rollup-plugin-mod-lo';
    const baseURL = url_1.pathToFileURL(process.cwd() + path_1.default.sep);
    const loadMetaMap = {};
    return {
        name: myName,
        resolveId,
        load,
    };
    async function resolveId(source, importer, _options) {
        if (source === HELPERS) {
            return {
                id: HELPERS,
            };
        }
        if (!importer) {
            asserts_1.asserts(!specifier_1.isRelativeSpecifier(source));
            return {
                id: source,
            };
        }
        const loadMeta = loadMetaMap[importer];
        if (!loadMeta) {
            return null;
        }
        const { url: importerURL, modLoMetadata: importerModLoMetadata, } = loadMeta;
        try {
            const resolved = await modLo.resolve(source, importerURL, importerModLoMetadata);
            if (resolved.isExternal) {
                return {
                    external: true,
                    id: source,
                };
            }
            else {
                return {
                    id: resolved.url.href,
                };
            }
        }
        catch (err) {
            return this.error(err);
        }
    }
    async function load(id) {
        if (id === HELPERS) {
            // @ts-ignore
            return babel.buildExternalHelpers(null, 'module');
        }
        let url;
        try {
            url = new url_1.URL(id);
        }
        catch (_a) {
            return null;
        }
        let modLoModule;
        try {
            modLoModule = await modLo.load(url);
        }
        catch (err) {
            return null;
        }
        loadMetaMap[id] = {
            url,
            modLoMetadata: modLoModule.modLoMetadata,
        };
        let code;
        let map;
        if (typeof modLoModule.code === 'string') {
            code = modLoModule.code;
            map = modLoModule.map;
        }
        else {
            const generateResult = generator_1.default(modLoModule.code);
            code = generateResult.code;
            map = generateResult.map;
        }
        return {
            code,
            map,
        };
    }
}
(function ($) {
    function filterWarns(warning, defaultHandler) {
        if (warning.code === 'CIRCULAR_DEPENDENCY') {
            if (warning.cycle && warning.cycle.every((id) => id.includes('node_modules'))) {
                return;
            }
        }
        defaultHandler(warning);
    }
    $.filterWarns = filterWarns;
    $.helperModule = HELPERS;
})($ || ($ = {}));
exports.default = $;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcm9sbHVwLXBsdWdpbi1tb2QtbG8vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0EsaUVBQXdDO0FBQ3hDLGdEQUFzQjtBQUN0Qiw2QkFBeUM7QUFFekMsaURBQThDO0FBQzlDLGtEQUF5RDtBQUN6RCxtREFBcUM7QUFFckMsaUZBQWlGO0FBQ2pGLDJIQUEySDtBQUMzSCxNQUFNLE9BQU8sR0FBRyxvQ0FBb0MsQ0FBQztBQUVyRCxTQUFTLENBQUMsQ0FBQyxFQUNQLEtBQUssR0FHUjtJQUNHLE1BQU0sTUFBTSxHQUFHLHNCQUFzQixDQUFDO0lBQ3RDLE1BQU0sT0FBTyxHQUFrQixtQkFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxjQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckUsTUFBTSxXQUFXLEdBR1osRUFBRSxDQUFDO0lBRVIsT0FBTztRQUNILElBQUksRUFBRSxNQUFNO1FBQ1osU0FBUztRQUNULElBQUk7S0FDUCxDQUFDO0lBRUYsS0FBSyxVQUFVLFNBQVMsQ0FFcEIsTUFBYyxFQUNkLFFBQTRCLEVBQzVCLFFBQWlEO1FBRWpELElBQUksTUFBTSxLQUFLLE9BQU8sRUFBRTtZQUNwQixPQUFPO2dCQUNILEVBQUUsRUFBRSxPQUFPO2FBQ2QsQ0FBQztTQUNMO1FBRUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLGlCQUFPLENBQUMsQ0FBQywrQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLE9BQU87Z0JBQ0gsRUFBRSxFQUFFLE1BQU07YUFDYixDQUFDO1NBQ0w7UUFDRCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLEVBQ0YsR0FBRyxFQUFFLFdBQVcsRUFDaEIsYUFBYSxFQUFFLHFCQUFxQixHQUN2QyxHQUFHLFFBQVEsQ0FBQztRQUViLElBQUk7WUFDQSxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxPQUFPLENBQ2hDLE1BQU0sRUFDTixXQUFXLEVBQ1gscUJBQXFCLENBQ3hCLENBQUM7WUFDRixJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3JCLE9BQU87b0JBQ0gsUUFBUSxFQUFFLElBQUk7b0JBQ2QsRUFBRSxFQUFFLE1BQU07aUJBQ2IsQ0FBQzthQUNMO2lCQUFNO2dCQUNILE9BQU87b0JBQ0gsRUFBRSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSTtpQkFDeEIsQ0FBQzthQUNMO1NBQ0o7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFFRCxLQUFLLFVBQVUsSUFBSSxDQUVmLEVBQVU7UUFFVixJQUFJLEVBQUUsS0FBSyxPQUFPLEVBQUU7WUFDaEIsYUFBYTtZQUNiLE9BQU8sS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNyRDtRQUVELElBQUksR0FBUSxDQUFDO1FBQ2IsSUFBSTtZQUNBLEdBQUcsR0FBRyxJQUFJLFNBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNyQjtRQUFDLFdBQU07WUFDSixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsSUFBSSxXQUFnQixDQUFDO1FBQ3JCLElBQUk7WUFDQSxXQUFXLEdBQUcsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsV0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHO1lBQ2QsR0FBRztZQUNILGFBQWEsRUFBRSxXQUFXLENBQUMsYUFBYTtTQUMzQyxDQUFDO1FBRUYsSUFBSSxJQUFZLENBQUM7UUFDakIsSUFBSSxHQUFRLENBQUM7UUFDYixJQUFJLE9BQU8sV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDdEMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUM7WUFDeEIsR0FBRyxHQUFHLFdBQVcsQ0FBQyxHQUF1RCxDQUFDO1NBQzdFO2FBQU07WUFDSCxNQUFNLGNBQWMsR0FBRyxtQkFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRCxJQUFJLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQztZQUMzQixHQUFHLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQztTQUM1QjtRQUVELE9BQU87WUFDSCxJQUFJO1lBQ0osR0FBRztTQUNOLENBQUM7SUFDTixDQUFDO0FBQ0wsQ0FBQztBQUVELFdBQVUsQ0FBQztJQUNQLFNBQWdCLFdBQVcsQ0FDdkIsT0FBNkIsRUFDN0IsY0FBcUM7UUFDckMsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLHFCQUFxQixFQUFFO1lBQ3hDLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFO2dCQUMzRSxPQUFPO2FBQ1Y7U0FDSjtRQUNELGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBVGUsYUFBVyxjQVMxQixDQUFBO0lBRVksY0FBWSxHQUFHLE9BQU8sQ0FBQztBQUN4QyxDQUFDLEVBYlMsQ0FBQyxLQUFELENBQUMsUUFhVjtBQUVELGtCQUFlLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG5pbXBvcnQgKiBhcyByb2xsdXAgZnJvbSAncm9sbHVwJztcbmltcG9ydCBnZW5lcmF0ZSBmcm9tICdAYmFiZWwvZ2VuZXJhdG9yJztcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwsIFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBNb2QsIE1vZExvLCBNb2RMb01ldGFkYXRhIH0gZnJvbSAnLi4vbW9kLWxvL21vZC1sbyc7XG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vLi4vdXRpbHMvYXNzZXJ0cyc7XG5pbXBvcnQgeyBpc1JlbGF0aXZlU3BlY2lmaWVyIH0gZnJvbSAnLi4vdXRpbHMvc3BlY2lmaWVyJztcbmltcG9ydCAqIGFzIGJhYmVsIGZyb20gJ0BiYWJlbC9jb3JlJztcblxuLy8gTk9URTogRE8gTk9UIFJFTU9WRSB0aGUgbnVsbCBjaGFyYWN0ZXIgYFxcMGAgYXMgaXQgbWF5IGJlIHVzZWQgYnkgb3RoZXIgcGx1Z2luc1xuLy8gZS5nLiBodHRwczovL2dpdGh1Yi5jb20vcm9sbHVwL3JvbGx1cC1wbHVnaW4tbm9kZS1yZXNvbHZlL2Jsb2IvMzEzYTNlMzJmNDMyZjllYjE4Y2M0YzIzMWNjN2FhYzZkZjMxN2E1MS9zcmMvaW5kZXguanMjTDc0XG5jb25zdCBIRUxQRVJTID0gJ1xcMHJvbGx1cFBsdWdpbk1vZExvQmFiZWxIZWxwZXJzLmpzJztcblxuZnVuY3Rpb24gJCh7XG4gICAgbW9kTG8sXG59OiB7XG4gICAgbW9kTG86IE1vZExvO1xufSk6IHJvbGx1cC5QbHVnaW4ge1xuICAgIGNvbnN0IG15TmFtZSA9ICdyb2xsdXAtcGx1Z2luLW1vZC1sbyc7XG4gICAgY29uc3QgYmFzZVVSTDogUmVhZG9ubHk8VVJMPiA9IHBhdGhUb0ZpbGVVUkwocHJvY2Vzcy5jd2QoKSArIHBzLnNlcCk7XG4gICAgY29uc3QgbG9hZE1ldGFNYXA6IFJlY29yZDxzdHJpbmcsIHtcbiAgICAgICAgdXJsOiBSZWFkb25seTxVUkw+O1xuICAgICAgICBtb2RMb01ldGFkYXRhOiBNb2RMb01ldGFkYXRhO1xuICAgIH0+ID0ge307XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiBteU5hbWUsXG4gICAgICAgIHJlc29sdmVJZCxcbiAgICAgICAgbG9hZCxcbiAgICB9O1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUlkKFxuICAgICAgICB0aGlzOiByb2xsdXAuUGx1Z2luQ29udGV4dCxcbiAgICAgICAgc291cmNlOiBzdHJpbmcsXG4gICAgICAgIGltcG9ydGVyOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgICAgIF9vcHRpb25zOiB7IGN1c3RvbT86IHJvbGx1cC5DdXN0b21QbHVnaW5PcHRpb25zIH0sXG4gICAgKTogUHJvbWlzZTxyb2xsdXAuUGFydGlhbFJlc29sdmVkSWQgfCBudWxsPiB7XG4gICAgICAgIGlmIChzb3VyY2UgPT09IEhFTFBFUlMpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWQ6IEhFTFBFUlMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIWltcG9ydGVyKSB7XG4gICAgICAgICAgICBhc3NlcnRzKCFpc1JlbGF0aXZlU3BlY2lmaWVyKHNvdXJjZSkpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpZDogc291cmNlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsb2FkTWV0YSA9IGxvYWRNZXRhTWFwW2ltcG9ydGVyXTtcbiAgICAgICAgaWYgKCFsb2FkTWV0YSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgdXJsOiBpbXBvcnRlclVSTCxcbiAgICAgICAgICAgIG1vZExvTWV0YWRhdGE6IGltcG9ydGVyTW9kTG9NZXRhZGF0YSxcbiAgICAgICAgfSA9IGxvYWRNZXRhO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IGF3YWl0IG1vZExvLnJlc29sdmUoXG4gICAgICAgICAgICAgICAgc291cmNlLFxuICAgICAgICAgICAgICAgIGltcG9ydGVyVVJMLFxuICAgICAgICAgICAgICAgIGltcG9ydGVyTW9kTG9NZXRhZGF0YSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZWQuaXNFeHRlcm5hbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGV4dGVybmFsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBpZDogc291cmNlLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiByZXNvbHZlZC51cmwuaHJlZixcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBsb2FkKFxuICAgICAgICB0aGlzOiByb2xsdXAuUGx1Z2luQ29udGV4dCxcbiAgICAgICAgaWQ6IHN0cmluZyxcbiAgICApOiBQcm9taXNlPHJvbGx1cC5Mb2FkUmVzdWx0IHwgbnVsbD4ge1xuICAgICAgICBpZiAoaWQgPT09IEhFTFBFUlMpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHJldHVybiBiYWJlbC5idWlsZEV4dGVybmFsSGVscGVycyhudWxsLCAnbW9kdWxlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdXJsOiBVUkw7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB1cmwgPSBuZXcgVVJMKGlkKTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtb2RMb01vZHVsZTogTW9kO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbW9kTG9Nb2R1bGUgPSBhd2FpdCBtb2RMby5sb2FkKHVybCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBsb2FkTWV0YU1hcFtpZF0gPSB7XG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICBtb2RMb01ldGFkYXRhOiBtb2RMb01vZHVsZS5tb2RMb01ldGFkYXRhLFxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjb2RlOiBzdHJpbmc7XG4gICAgICAgIGxldCBtYXA6IGFueTtcbiAgICAgICAgaWYgKHR5cGVvZiBtb2RMb01vZHVsZS5jb2RlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29kZSA9IG1vZExvTW9kdWxlLmNvZGU7XG4gICAgICAgICAgICBtYXAgPSBtb2RMb01vZHVsZS5tYXAgYXMgdW5rbm93biBhcyByb2xsdXAuU291cmNlTWFwIHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgZ2VuZXJhdGVSZXN1bHQgPSBnZW5lcmF0ZShtb2RMb01vZHVsZS5jb2RlKTtcbiAgICAgICAgICAgIGNvZGUgPSBnZW5lcmF0ZVJlc3VsdC5jb2RlO1xuICAgICAgICAgICAgbWFwID0gZ2VuZXJhdGVSZXN1bHQubWFwO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICBtYXAsXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5uYW1lc3BhY2UgJCB7XG4gICAgZXhwb3J0IGZ1bmN0aW9uIGZpbHRlcldhcm5zKFxuICAgICAgICB3YXJuaW5nOiByb2xsdXAuUm9sbHVwV2FybmluZyxcbiAgICAgICAgZGVmYXVsdEhhbmRsZXI6IHJvbGx1cC5XYXJuaW5nSGFuZGxlcikge1xuICAgICAgICBpZiAod2FybmluZy5jb2RlID09PSAnQ0lSQ1VMQVJfREVQRU5ERU5DWScpIHtcbiAgICAgICAgICAgIGlmICh3YXJuaW5nLmN5Y2xlICYmIHdhcm5pbmcuY3ljbGUuZXZlcnkoKGlkKSA9PiBpZC5pbmNsdWRlcygnbm9kZV9tb2R1bGVzJykpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHRIYW5kbGVyKHdhcm5pbmcpO1xuICAgIH1cblxuICAgIGV4cG9ydCBjb25zdCBoZWxwZXJNb2R1bGUgPSBIRUxQRVJTO1xufVxuXG5leHBvcnQgZGVmYXVsdCAkO1xuIl19