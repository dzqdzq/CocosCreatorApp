"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const generator_1 = __importDefault(require("@babel/generator"));
const path_1 = __importDefault(require("path"));
const url_1 = require("url");
const asserts_1 = require("../../utils/asserts");
const specifier_1 = require("../utils/specifier");
function $({ modLo, }) {
    const myName = 'rollup-plugin-mod-lo';
    const baseURL = url_1.pathToFileURL(process.cwd() + path_1.default.sep);
    const loadMetaMap = {};
    return {
        name: myName,
        resolveId,
        load,
    };
    async function resolveId(source, importer, _options) {
        if (!importer) {
            asserts_1.asserts(!specifier_1.isRelativeSpecifier(source));
            return {
                id: source,
            };
        }
        const loadMeta = loadMetaMap[importer];
        if (!loadMeta) {
            return null;
        }
        const { url: importerURL, modLoMetadata: importerModLoMetadata, } = loadMeta;
        try {
            const resolved = await modLo.resolve(source, importerURL, importerModLoMetadata);
            if (resolved.isExternal) {
                return {
                    external: true,
                    id: source,
                };
            }
            else {
                return {
                    id: resolved.url.href,
                };
            }
        }
        catch (err) {
            return this.error(err);
        }
    }
    async function load(id) {
        let url;
        try {
            url = new url_1.URL(id);
        }
        catch (_a) {
            return null;
        }
        let modLoModule;
        try {
            modLoModule = await modLo.load(url);
        }
        catch (err) {
            return null;
        }
        loadMetaMap[id] = {
            url,
            modLoMetadata: modLoModule.modLoMetadata,
        };
        let code;
        let map;
        if (typeof modLoModule.code === 'string') {
            code = modLoModule.code;
            map = modLoModule.map;
        }
        else {
            const generateResult = generator_1.default(modLoModule.code);
            code = generateResult.code;
            map = generateResult.map;
        }
        return {
            code,
            map,
        };
    }
}
(function ($) {
    function filterWarns(warning, defaultHandler) {
        if (warning.code === 'CIRCULAR_DEPENDENCY') {
            if (warning.cycle && warning.cycle.every((id) => id.includes('node_modules'))) {
                return;
            }
        }
        defaultHandler(warning);
    }
    $.filterWarns = filterWarns;
})($ || ($ = {}));
exports.default = $;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbW9kLWFzc2VtYmxpbmcvcm9sbHVwLXBsdWdpbi1tb2QtbG8vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFHQSxpRUFBd0M7QUFDeEMsZ0RBQXNCO0FBQ3RCLDZCQUF5QztBQUV6QyxpREFBOEM7QUFDOUMsa0RBQXlEO0FBRXpELFNBQVMsQ0FBQyxDQUFDLEVBQ1AsS0FBSyxHQUdSO0lBQ0csTUFBTSxNQUFNLEdBQUcsc0JBQXNCLENBQUM7SUFDdEMsTUFBTSxPQUFPLEdBQWtCLG1CQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLGNBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyRSxNQUFNLFdBQVcsR0FHWixFQUFFLENBQUM7SUFFUixPQUFPO1FBQ0gsSUFBSSxFQUFFLE1BQU07UUFDWixTQUFTO1FBQ1QsSUFBSTtLQUNQLENBQUM7SUFFRixLQUFLLFVBQVUsU0FBUyxDQUVwQixNQUFjLEVBQ2QsUUFBNEIsRUFDNUIsUUFBaUQ7UUFFakQsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLGlCQUFPLENBQUMsQ0FBQywrQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLE9BQU87Z0JBQ0gsRUFBRSxFQUFFLE1BQU07YUFDYixDQUFDO1NBQ0w7UUFDRCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLEVBQ0YsR0FBRyxFQUFFLFdBQVcsRUFDaEIsYUFBYSxFQUFFLHFCQUFxQixHQUN2QyxHQUFHLFFBQVEsQ0FBQztRQUViLElBQUk7WUFDQSxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxPQUFPLENBQ2hDLE1BQU0sRUFDTixXQUFXLEVBQ1gscUJBQXFCLENBQ3hCLENBQUM7WUFDRixJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3JCLE9BQU87b0JBQ0gsUUFBUSxFQUFFLElBQUk7b0JBQ2QsRUFBRSxFQUFFLE1BQU07aUJBQ2IsQ0FBQzthQUNMO2lCQUFNO2dCQUNILE9BQU87b0JBQ0gsRUFBRSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSTtpQkFDeEIsQ0FBQzthQUNMO1NBQ0o7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFFRCxLQUFLLFVBQVUsSUFBSSxDQUVmLEVBQVU7UUFFVixJQUFJLEdBQVEsQ0FBQztRQUNiLElBQUk7WUFDQSxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDckI7UUFBQyxXQUFNO1lBQ0osT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELElBQUksV0FBZ0IsQ0FBQztRQUNyQixJQUFJO1lBQ0EsV0FBVyxHQUFHLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN2QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELFdBQVcsQ0FBQyxFQUFFLENBQUMsR0FBRztZQUNkLEdBQUc7WUFDSCxhQUFhLEVBQUUsV0FBVyxDQUFDLGFBQWE7U0FDM0MsQ0FBQztRQUVGLElBQUksSUFBWSxDQUFDO1FBQ2pCLElBQUksR0FBUSxDQUFDO1FBQ2IsSUFBSSxPQUFPLFdBQVcsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3RDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDO1lBQ3hCLEdBQUcsR0FBRyxXQUFXLENBQUMsR0FBdUQsQ0FBQztTQUM3RTthQUFNO1lBQ0gsTUFBTSxjQUFjLEdBQUcsbUJBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEQsSUFBSSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUM7WUFDM0IsR0FBRyxHQUFHLGNBQWMsQ0FBQyxHQUFHLENBQUM7U0FDNUI7UUFFRCxPQUFPO1lBQ0gsSUFBSTtZQUNKLEdBQUc7U0FDTixDQUFDO0lBQ04sQ0FBQztBQUNMLENBQUM7QUFFRCxXQUFVLENBQUM7SUFDUCxTQUFnQixXQUFXLENBQ3ZCLE9BQTZCLEVBQzdCLGNBQXFDO1FBQ3JDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxxQkFBcUIsRUFBRTtZQUN4QyxJQUFJLE9BQU8sQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRTtnQkFDM0UsT0FBTzthQUNWO1NBQ0o7UUFDRCxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQVRlLGFBQVcsY0FTMUIsQ0FBQTtBQUNMLENBQUMsRUFYUyxDQUFDLEtBQUQsQ0FBQyxRQVdWO0FBRUQsa0JBQWUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbmltcG9ydCAqIGFzIHJvbGx1cCBmcm9tICdyb2xsdXAnO1xuaW1wb3J0IGdlbmVyYXRlIGZyb20gJ0BiYWJlbC9nZW5lcmF0b3InO1xuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcGF0aFRvRmlsZVVSTCwgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IE1vZCwgTW9kTG8sIE1vZExvTWV0YWRhdGEgfSBmcm9tICcuLi9tb2QtbG8vbW9kLWxvJztcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi8uLi91dGlscy9hc3NlcnRzJztcbmltcG9ydCB7IGlzUmVsYXRpdmVTcGVjaWZpZXIgfSBmcm9tICcuLi91dGlscy9zcGVjaWZpZXInO1xuXG5mdW5jdGlvbiAkKHtcbiAgICBtb2RMbyxcbn06IHtcbiAgICBtb2RMbzogTW9kTG87XG59KTogcm9sbHVwLlBsdWdpbiB7XG4gICAgY29uc3QgbXlOYW1lID0gJ3JvbGx1cC1wbHVnaW4tbW9kLWxvJztcbiAgICBjb25zdCBiYXNlVVJMOiBSZWFkb25seTxVUkw+ID0gcGF0aFRvRmlsZVVSTChwcm9jZXNzLmN3ZCgpICsgcHMuc2VwKTtcbiAgICBjb25zdCBsb2FkTWV0YU1hcDogUmVjb3JkPHN0cmluZywge1xuICAgICAgICB1cmw6IFJlYWRvbmx5PFVSTD47XG4gICAgICAgIG1vZExvTWV0YWRhdGE6IE1vZExvTWV0YWRhdGE7XG4gICAgfT4gPSB7fTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IG15TmFtZSxcbiAgICAgICAgcmVzb2x2ZUlkLFxuICAgICAgICBsb2FkLFxuICAgIH07XG5cbiAgICBhc3luYyBmdW5jdGlvbiByZXNvbHZlSWQoXG4gICAgICAgIHRoaXM6IHJvbGx1cC5QbHVnaW5Db250ZXh0LFxuICAgICAgICBzb3VyY2U6IHN0cmluZyxcbiAgICAgICAgaW1wb3J0ZXI6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgX29wdGlvbnM6IHsgY3VzdG9tPzogcm9sbHVwLkN1c3RvbVBsdWdpbk9wdGlvbnMgfSxcbiAgICApOiBQcm9taXNlPHJvbGx1cC5QYXJ0aWFsUmVzb2x2ZWRJZCB8IG51bGw+IHtcbiAgICAgICAgaWYgKCFpbXBvcnRlcikge1xuICAgICAgICAgICAgYXNzZXJ0cyghaXNSZWxhdGl2ZVNwZWNpZmllcihzb3VyY2UpKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWQ6IHNvdXJjZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbG9hZE1ldGEgPSBsb2FkTWV0YU1hcFtpbXBvcnRlcl07XG4gICAgICAgIGlmICghbG9hZE1ldGEpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIHVybDogaW1wb3J0ZXJVUkwsXG4gICAgICAgICAgICBtb2RMb01ldGFkYXRhOiBpbXBvcnRlck1vZExvTWV0YWRhdGEsXG4gICAgICAgIH0gPSBsb2FkTWV0YTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCBtb2RMby5yZXNvbHZlKFxuICAgICAgICAgICAgICAgIHNvdXJjZSxcbiAgICAgICAgICAgICAgICBpbXBvcnRlclVSTCxcbiAgICAgICAgICAgICAgICBpbXBvcnRlck1vZExvTWV0YWRhdGEsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKHJlc29sdmVkLmlzRXh0ZXJuYWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBleHRlcm5hbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHNvdXJjZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBpZDogcmVzb2x2ZWQudXJsLmhyZWYsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5lcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZnVuY3Rpb24gbG9hZChcbiAgICAgICAgdGhpczogcm9sbHVwLlBsdWdpbkNvbnRleHQsXG4gICAgICAgIGlkOiBzdHJpbmcsXG4gICAgKTogUHJvbWlzZTxyb2xsdXAuTG9hZFJlc3VsdCB8IG51bGw+IHtcbiAgICAgICAgbGV0IHVybDogVVJMO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdXJsID0gbmV3IFVSTChpZCk7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbW9kTG9Nb2R1bGU6IE1vZDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIG1vZExvTW9kdWxlID0gYXdhaXQgbW9kTG8ubG9hZCh1cmwpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9hZE1ldGFNYXBbaWRdID0ge1xuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgbW9kTG9NZXRhZGF0YTogbW9kTG9Nb2R1bGUubW9kTG9NZXRhZGF0YSxcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgY29kZTogc3RyaW5nO1xuICAgICAgICBsZXQgbWFwOiBhbnk7XG4gICAgICAgIGlmICh0eXBlb2YgbW9kTG9Nb2R1bGUuY29kZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGNvZGUgPSBtb2RMb01vZHVsZS5jb2RlO1xuICAgICAgICAgICAgbWFwID0gbW9kTG9Nb2R1bGUubWFwIGFzIHVua25vd24gYXMgcm9sbHVwLlNvdXJjZU1hcCB8IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlUmVzdWx0ID0gZ2VuZXJhdGUobW9kTG9Nb2R1bGUuY29kZSk7XG4gICAgICAgICAgICBjb2RlID0gZ2VuZXJhdGVSZXN1bHQuY29kZTtcbiAgICAgICAgICAgIG1hcCA9IGdlbmVyYXRlUmVzdWx0Lm1hcDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgbWFwLFxuICAgICAgICB9O1xuICAgIH1cbn1cblxubmFtZXNwYWNlICQge1xuICAgIGV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJXYXJucyhcbiAgICAgICAgd2FybmluZzogcm9sbHVwLlJvbGx1cFdhcm5pbmcsXG4gICAgICAgIGRlZmF1bHRIYW5kbGVyOiByb2xsdXAuV2FybmluZ0hhbmRsZXIpIHtcbiAgICAgICAgaWYgKHdhcm5pbmcuY29kZSA9PT0gJ0NJUkNVTEFSX0RFUEVOREVOQ1knKSB7XG4gICAgICAgICAgICBpZiAod2FybmluZy5jeWNsZSAmJiB3YXJuaW5nLmN5Y2xlLmV2ZXJ5KChpZCkgPT4gaWQuaW5jbHVkZXMoJ25vZGVfbW9kdWxlcycpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0SGFuZGxlcih3YXJuaW5nKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0ICQ7XG4iXX0=