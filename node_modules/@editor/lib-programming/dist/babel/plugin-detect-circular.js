"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.$ = void 0;
function $({ types, template, traverse }, options) {
    if (!options || !options.reporter) {
        throw new Error(`'reporter' options is required.`);
    }
    const templateBuilderOptions = {
        preserveComments: true,
        // @ts-ignore
        syntacticPlaceholders: true,
    };
    const createReportFxTemplate = (observerFxName, observee, moduleRequest) => template.statements(`\
function ${observerFxName}(extras) {
    (%%reporterFx%%)("${observee}", "${moduleRequest}", import.meta, extras);
}`, Object.assign({}, templateBuilderOptions, {
        plugins: [
            'importMeta',
        ],
    }));
    const observedTemplate = template.expression(`\
(((%%condition%%) && (%%observee%% === (void 0))) ? (%%reportFxName%%({ error: Error() }), %%observee%%) : %%observee%%)
`, templateBuilderOptions);
    const isTypeUsedIdentifier = (id) => {
        // IS THIS GOOD??
        return id.parent.type.startsWith('TS');
    };
    return {
        name: 'detect-circular-reference',
        visitor: {
            Program: {
                enter: function (programPath) {
                    handleProgram(programPath);
                },
            },
        },
    };
    function handleProgram(programPath) {
        const crdId = programPath.scope.generateUid('_crd');
        programPath.node.body.unshift(types.variableDeclaration('let', [types.variableDeclarator(types.identifier(crdId), types.valueToNode(true))]));
        programPath.node.body.push(types.expressionStatement(types.assignmentExpression('=', types.identifier(crdId), types.valueToNode(false))));
        const reporterNsName = programPath.scope.generateUid('_reporterNs');
        const reportFxs = [];
        traverse(programPath.node, {
            ImportDeclaration: function (path) {
                handleImportDeclaration(programPath, path, crdId, reportFxs, reporterNsName);
            },
        });
        if (reportFxs.length !== 0) {
            programPath.node.body.unshift(types.importDeclaration([types.importNamespaceSpecifier(types.identifier(reporterNsName))], types.stringLiteral(options.reporter.moduleName)));
            programPath.node.body.push(...reportFxs);
        }
    }
    function handleImportDeclaration(programPath, importDeclarationPath, crdId, reportFxs, reporterNsName) {
        if (options.moduleRequestFilter) {
            const tests = Array.isArray(options.moduleRequestFilter) ? options.moduleRequestFilter : [options.moduleRequestFilter];
            if (tests.some((test) => importDeclarationPath.node.source.value.match(test))) {
                return;
            }
        }
        for (const specifier of importDeclarationPath.node.specifiers) {
            let local;
            if (types.isImportDefaultSpecifier(specifier)) {
                local = specifier.local.name;
            }
            else if (types.isImportNamespaceSpecifier(specifier)) {
                // TODO
            }
            else {
                local = specifier.local.name;
            }
            if (!local) {
                continue;
            }
            const binding = importDeclarationPath.scope.getBinding(local);
            if (binding && binding.referencePaths.length !== 0) {
                const reportFxName = programPath.scope.generateUid(`reportPossibleCrUseOf${local}`);
                reportFxs.push(...createReportFxTemplate(reportFxName, local, importDeclarationPath.node.source.value)({
                    reporterFx: types.memberExpression(types.identifier(reporterNsName), types.identifier(options.reporter.functionName)),
                }));
                for (const referencePath of binding.referencePaths) {
                    if (types.isIdentifier(referencePath.node) &&
                        !types.isExportSpecifier(referencePath.parent) &&
                        !types.isImportSpecifier(referencePath.parent) &&
                        !isTypeUsedIdentifier(referencePath)) {
                        referencePath.replaceWith(observedTemplate({
                            reportFxName: types.identifier(reportFxName),
                            observee: types.identifier(local),
                            condition: types.identifier(crdId),
                        }));
                    }
                }
            }
        }
    }
}
exports.$ = $;
exports.default = $;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLWRldGVjdC1jaXJjdWxhci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iYWJlbC9wbHVnaW4tZGV0ZWN0LWNpcmN1bGFyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLFNBQWdCLENBQUMsQ0FDYixFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFnQixFQUMzQyxPQUFrQjtJQUVsQixJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtRQUMvQixNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7S0FDdEQ7SUFFRCxNQUFNLHNCQUFzQixHQUFxRDtRQUM3RSxnQkFBZ0IsRUFBRSxJQUFJO1FBQ3RCLGFBQWE7UUFDYixxQkFBcUIsRUFBRSxJQUFJO0tBQzlCLENBQUM7SUFFRixNQUFNLHNCQUFzQixHQUFHLENBQzNCLGNBQXNCLEVBQ3RCLFFBQWdCLEVBQ2hCLGFBQXFCLEVBQ3ZCLEVBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDO1dBQ2xCLGNBQWM7d0JBQ0QsUUFBUSxPQUFPLGFBQWE7RUFDbEQsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxzQkFBc0IsRUFBRTtRQUN0QyxPQUFPLEVBQUU7WUFDTCxZQUFZO1NBQ2Y7S0FDSixDQUFDLENBQUMsQ0FBQztJQUVKLE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQzs7Q0FFaEQsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBRXZCLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxFQUEwQyxFQUFXLEVBQUU7UUFDakYsaUJBQWlCO1FBQ2pCLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLENBQUMsQ0FBQztJQUVGLE9BQU87UUFDSCxJQUFJLEVBQUUsMkJBQTJCO1FBQ2pDLE9BQU8sRUFBRTtZQUNMLE9B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QyxZQUFZLENBQUM7NEJBQzVDLFFBQVEsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQzs0QkFDakMsU0FBUyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO3lCQUNyQyxDQUFDLENBQUMsQ0FBQztxQkFDUDtpQkFDSjthQUNKO1NBQ0o7SUFDTCxDQUFDO0FBQ0wsQ0FBQztBQTFIRCxjQTBIQztBQVlELGtCQUFlLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgdHlwZSAqIGFzIGJhYmVsIGZyb20gJ0BiYWJlbC9jb3JlJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiAkKFxyXG4gICAgeyB0eXBlcywgdGVtcGxhdGUsIHRyYXZlcnNlIH06IHR5cGVvZiBiYWJlbCxcclxuICAgIG9wdGlvbnM6ICQuT3B0aW9ucyxcclxuKTogYmFiZWwuUGx1Z2luT2JqIHtcclxuICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5yZXBvcnRlcikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJ3JlcG9ydGVyJyBvcHRpb25zIGlzIHJlcXVpcmVkLmApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRlbXBsYXRlQnVpbGRlck9wdGlvbnM6IGltcG9ydCgnQGJhYmVsL3RlbXBsYXRlJykuVGVtcGxhdGVCdWlsZGVyT3B0aW9ucyA9IHtcclxuICAgICAgICBwcmVzZXJ2ZUNvbW1lbnRzOiB0cnVlLFxyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBzeW50YWN0aWNQbGFjZWhvbGRlcnM6IHRydWUsXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGNyZWF0ZVJlcG9ydEZ4VGVtcGxhdGUgPSAoXHJcbiAgICAgICAgb2JzZXJ2ZXJGeE5hbWU6IHN0cmluZyxcclxuICAgICAgICBvYnNlcnZlZTogc3RyaW5nLFxyXG4gICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZyxcclxuICAgICkgPT4gdGVtcGxhdGUuc3RhdGVtZW50cyhgXFxcclxuZnVuY3Rpb24gJHtvYnNlcnZlckZ4TmFtZX0oZXh0cmFzKSB7XHJcbiAgICAoJSVyZXBvcnRlckZ4JSUpKFwiJHtvYnNlcnZlZX1cIiwgXCIke21vZHVsZVJlcXVlc3R9XCIsIGltcG9ydC5tZXRhLCBleHRyYXMpO1xyXG59YCwgT2JqZWN0LmFzc2lnbih7fSwgdGVtcGxhdGVCdWlsZGVyT3B0aW9ucywge1xyXG4gICAgICAgIHBsdWdpbnM6IFtcclxuICAgICAgICAgICAgJ2ltcG9ydE1ldGEnLFxyXG4gICAgICAgIF0sXHJcbiAgICB9KSk7XHJcblxyXG4gICAgY29uc3Qgb2JzZXJ2ZWRUZW1wbGF0ZSA9IHRlbXBsYXRlLmV4cHJlc3Npb24oYFxcXHJcbigoKCUlY29uZGl0aW9uJSUpICYmICglJW9ic2VydmVlJSUgPT09ICh2b2lkIDApKSkgPyAoJSVyZXBvcnRGeE5hbWUlJSh7IGVycm9yOiBFcnJvcigpIH0pLCAlJW9ic2VydmVlJSUpIDogJSVvYnNlcnZlZSUlKVxyXG5gLCB0ZW1wbGF0ZUJ1aWxkZXJPcHRpb25zKTtcclxuXHJcbiAgICBjb25zdCBpc1R5cGVVc2VkSWRlbnRpZmllciA9IChpZDogYmFiZWwuTm9kZVBhdGg8YmFiZWwudHlwZXMuSWRlbnRpZmllcj4pOiBib29sZWFuID0+IHtcclxuICAgICAgICAvLyBJUyBUSElTIEdPT0Q/P1xyXG4gICAgICAgIHJldHVybiBpZC5wYXJlbnQudHlwZS5zdGFydHNXaXRoKCdUUycpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIG5hbWU6ICdkZXRlY3QtY2lyY3VsYXItcmVmZXJlbmNlJyxcclxuICAgICAgICB2aXNpdG9yOiB7XHJcbiAgICAgICAgICAgIFByb2dyYW06IHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbihwcm9ncmFtUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZVByb2dyYW0ocHJvZ3JhbVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVQcm9ncmFtKHByb2dyYW1QYXRoOiBiYWJlbC5Ob2RlUGF0aDxiYWJlbC50eXBlcy5Qcm9ncmFtPikge1xyXG4gICAgICAgIGNvbnN0IGNyZElkID0gcHJvZ3JhbVBhdGguc2NvcGUuZ2VuZXJhdGVVaWQoJ19jcmQnKTtcclxuICAgICAgICBwcm9ncmFtUGF0aC5ub2RlLmJvZHkudW5zaGlmdCh0eXBlcy52YXJpYWJsZURlY2xhcmF0aW9uKCdsZXQnLCBbdHlwZXMudmFyaWFibGVEZWNsYXJhdG9yKFxyXG4gICAgICAgICAgICB0eXBlcy5pZGVudGlmaWVyKGNyZElkKSwgdHlwZXMudmFsdWVUb05vZGUodHJ1ZSkpXSkpO1xyXG4gICAgICAgIHByb2dyYW1QYXRoLm5vZGUuYm9keS5wdXNoKHR5cGVzLmV4cHJlc3Npb25TdGF0ZW1lbnQodHlwZXMuYXNzaWdubWVudEV4cHJlc3Npb24oXHJcbiAgICAgICAgICAgICc9JywgdHlwZXMuaWRlbnRpZmllcihjcmRJZCksIHR5cGVzLnZhbHVlVG9Ob2RlKGZhbHNlKSkpKTtcclxuICAgICAgICBjb25zdCByZXBvcnRlck5zTmFtZSA9IHByb2dyYW1QYXRoLnNjb3BlLmdlbmVyYXRlVWlkKCdfcmVwb3J0ZXJOcycpO1xyXG4gICAgICAgIGNvbnN0IHJlcG9ydEZ4czogYmFiZWwudHlwZXMuU3RhdGVtZW50W10gPSBbXTtcclxuICAgICAgICB0cmF2ZXJzZShwcm9ncmFtUGF0aC5ub2RlLCB7XHJcbiAgICAgICAgICAgIEltcG9ydERlY2xhcmF0aW9uOiBmdW5jdGlvbihwYXRoKSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVJbXBvcnREZWNsYXJhdGlvbihwcm9ncmFtUGF0aCwgcGF0aCwgY3JkSWQsIHJlcG9ydEZ4cywgcmVwb3J0ZXJOc05hbWUpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChyZXBvcnRGeHMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgIHByb2dyYW1QYXRoLm5vZGUuYm9keS51bnNoaWZ0KHR5cGVzLmltcG9ydERlY2xhcmF0aW9uKFxyXG4gICAgICAgICAgICAgICAgW3R5cGVzLmltcG9ydE5hbWVzcGFjZVNwZWNpZmllcih0eXBlcy5pZGVudGlmaWVyKHJlcG9ydGVyTnNOYW1lKSldLFxyXG4gICAgICAgICAgICAgICAgdHlwZXMuc3RyaW5nTGl0ZXJhbChvcHRpb25zLnJlcG9ydGVyLm1vZHVsZU5hbWUpLFxyXG4gICAgICAgICAgICApKTtcclxuICAgICAgICAgICAgcHJvZ3JhbVBhdGgubm9kZS5ib2R5LnB1c2goLi4ucmVwb3J0RnhzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlSW1wb3J0RGVjbGFyYXRpb24oXHJcbiAgICAgICAgcHJvZ3JhbVBhdGg6IGJhYmVsLk5vZGVQYXRoPGJhYmVsLnR5cGVzLlByb2dyYW0+LFxyXG4gICAgICAgIGltcG9ydERlY2xhcmF0aW9uUGF0aDogYmFiZWwuTm9kZVBhdGg8YmFiZWwudHlwZXMuSW1wb3J0RGVjbGFyYXRpb24+LFxyXG4gICAgICAgIGNyZElkOiBzdHJpbmcsXHJcbiAgICAgICAgcmVwb3J0RnhzOiBiYWJlbC50eXBlcy5TdGF0ZW1lbnRbXSxcclxuICAgICAgICByZXBvcnRlck5zTmFtZTogc3RyaW5nLFxyXG4gICAgKSB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMhLm1vZHVsZVJlcXVlc3RGaWx0ZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgdGVzdHMgPSBBcnJheS5pc0FycmF5KG9wdGlvbnMhLm1vZHVsZVJlcXVlc3RGaWx0ZXIpID8gb3B0aW9ucyEubW9kdWxlUmVxdWVzdEZpbHRlciA6IFtvcHRpb25zIS5tb2R1bGVSZXF1ZXN0RmlsdGVyXTtcclxuICAgICAgICAgICAgaWYgKHRlc3RzLnNvbWUoKHRlc3QpID0+IGltcG9ydERlY2xhcmF0aW9uUGF0aC5ub2RlLnNvdXJjZS52YWx1ZS5tYXRjaCh0ZXN0KSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGNvbnN0IHNwZWNpZmllciBvZiBpbXBvcnREZWNsYXJhdGlvblBhdGgubm9kZS5zcGVjaWZpZXJzKSB7XHJcbiAgICAgICAgICAgIGxldCBsb2NhbDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBpZiAodHlwZXMuaXNJbXBvcnREZWZhdWx0U3BlY2lmaWVyKHNwZWNpZmllcikpIHtcclxuICAgICAgICAgICAgICAgIGxvY2FsID0gc3BlY2lmaWVyLmxvY2FsLm5hbWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZXMuaXNJbXBvcnROYW1lc3BhY2VTcGVjaWZpZXIoc3BlY2lmaWVyKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ET1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbG9jYWwgPSBzcGVjaWZpZXIubG9jYWwubmFtZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWxvY2FsKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nID0gaW1wb3J0RGVjbGFyYXRpb25QYXRoLnNjb3BlLmdldEJpbmRpbmcobG9jYWwpO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZyAmJiBiaW5kaW5nLnJlZmVyZW5jZVBhdGhzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVwb3J0RnhOYW1lID0gcHJvZ3JhbVBhdGguc2NvcGUuZ2VuZXJhdGVVaWQoYHJlcG9ydFBvc3NpYmxlQ3JVc2VPZiR7bG9jYWx9YCk7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRGeHMucHVzaCguLi5jcmVhdGVSZXBvcnRGeFRlbXBsYXRlKFxyXG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEZ4TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBsb2NhbCxcclxuICAgICAgICAgICAgICAgICAgICBpbXBvcnREZWNsYXJhdGlvblBhdGgubm9kZS5zb3VyY2UudmFsdWUsXHJcbiAgICAgICAgICAgICAgICApKHtcclxuICAgICAgICAgICAgICAgICAgICByZXBvcnRlckZ4OiB0eXBlcy5tZW1iZXJFeHByZXNzaW9uKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlcy5pZGVudGlmaWVyKHJlcG9ydGVyTnNOYW1lKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZXMuaWRlbnRpZmllcihvcHRpb25zLnJlcG9ydGVyLmZ1bmN0aW9uTmFtZSksXHJcbiAgICAgICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVmZXJlbmNlUGF0aCBvZiBiaW5kaW5nLnJlZmVyZW5jZVBhdGhzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVzLmlzSWRlbnRpZmllcihyZWZlcmVuY2VQYXRoLm5vZGUpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICF0eXBlcy5pc0V4cG9ydFNwZWNpZmllcihyZWZlcmVuY2VQYXRoLnBhcmVudCkgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgIXR5cGVzLmlzSW1wb3J0U3BlY2lmaWVyKHJlZmVyZW5jZVBhdGgucGFyZW50KSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAhaXNUeXBlVXNlZElkZW50aWZpZXIocmVmZXJlbmNlUGF0aCBhcyBiYWJlbC5Ob2RlUGF0aDxiYWJlbC50eXBlcy5JZGVudGlmaWVyPikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlUGF0aC5yZXBsYWNlV2l0aChvYnNlcnZlZFRlbXBsYXRlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9ydEZ4TmFtZTogdHlwZXMuaWRlbnRpZmllcihyZXBvcnRGeE5hbWUpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZWU6IHR5cGVzLmlkZW50aWZpZXIobG9jYWwpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiB0eXBlcy5pZGVudGlmaWVyKGNyZElkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IG5hbWVzcGFjZSAkIHtcclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XHJcbiAgICAgICAgbW9kdWxlUmVxdWVzdEZpbHRlcj86IFJlZ0V4cCB8IEFycmF5PFJlZ0V4cD47XHJcbiAgICAgICAgcmVwb3J0ZXI6IHtcclxuICAgICAgICAgICAgbW9kdWxlTmFtZTogc3RyaW5nO1xyXG4gICAgICAgICAgICBmdW5jdGlvbk5hbWU6IHN0cmluZztcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCAkO1xyXG4iXX0=