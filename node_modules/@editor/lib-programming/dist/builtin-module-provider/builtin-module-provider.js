"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BuiltinModuleProvider = void 0;
const build_time_constants_1 = require("./build-time-constants");
const babel = __importStar(require("@babel/core"));
// import babelPresetCC from '@cocos/babel-preset-cc';
// @ts-ignore
// import babelPresetEnv from '@babel/preset-env';
const plugin_transform_modules_systemjs_1 = __importDefault(require("@babel/plugin-transform-modules-systemjs"));
const url_1 = __importDefault(require("url"));
/**
 * `BuiltinModuleProvider` 用于提供项目脚本用到的所有“内置”模块，例如：
 * - `"cc.base"` 等引擎模块
 * - 模块 `"cc/env"` —— 提供了构建时常量
 *
 * 它提供的内置模块可以用于在**编辑器环境**中、**预览环境**中以及**构建时打包工具**的环境中运行。
 */
class BuiltinModuleProvider {
    constructor(options) {
        var _a;
        this._modules = {};
        this._format = (_a = options.format) !== null && _a !== void 0 ? _a : 'esm';
    }
    static async create(options) {
        const provider = new BuiltinModuleProvider(options);
        await provider._initialize(options);
        return provider;
    }
    async addEngineIndexMod(url, xSourceKind) {
        if (Array.isArray(url)) {
            this._modules['cc'] = await this._transform(makeModuleCCSource(url));
        }
        else {
            this._modules['cc'] = await this._makeModuleAlias(url, xSourceKind);
        }
    }
    async addEngineMods(ccMods, xSourceKind) {
        await Promise.all(Object.entries(ccMods).map(async ([id, alias]) => {
            this._modules[id] = await this._makeModuleAlias(alias, xSourceKind);
        }));
    }
    async addBuildTimeConstantsMod(constants, xSourceKind) {
        if (typeof constants === 'object') {
            this._modules[ModuleNames.buildTimeConstants] =
                await this._transform(await build_time_constants_1.makeBuildTimeConstantModule(constants));
        }
        else {
            this._modules[ModuleNames.buildTimeConstants] =
                await this._makeModuleAlias(constants !== null && constants !== void 0 ? constants : this.getBTCMappingSource(), xSourceKind);
        }
        // Deprecated: use 'cc/env'
        this._modules['cce.env'] = this._modules[ModuleNames.buildTimeConstants];
    }
    getBTCMappingSource() {
        return `cc/editor/populate-internal-constants`;
    }
    /**
     * 当前提供的所有模块以及它们的源码。
     */
    get modules() {
        return this._modules;
    }
    async _initialize(options) {
    }
    async _makeModuleAlias(alias, targetKind) {
        if (targetKind === 'commonjs') {
            let moduleName;
            try {
                moduleName = url_1.default.fileURLToPath(alias);
            }
            catch (_a) {
                moduleName = alias;
            }
            return `\
System.register([], (_export) => {
    return {
        execute: () => { _export(require('${moduleName.replace(/\\/g, '\\\\')}')); },
    };
});
`;
        }
        else if (targetKind === 'amd') {
            return `\
System.register(['${alias}'], (_export) => {
    let m;
    return {
        setters: [(mAmd) => { m = mAmd.default; }],
        execute: () => { _export(m); },
    };
});
`;
        }
        else {
            return await this._transform(`export * from '${alias}';`);
        }
    }
    async _transform(code) {
        if (this._format === 'esm') {
            return code;
        }
        const babelFileResult = await babel.transformAsync(code, {
            plugins: [[plugin_transform_modules_systemjs_1.default]],
            presets: [
            // [babelPresetEnv, {
            //     modules: 'systemjs',
            // }],
            // [babelPresetCC, {
            //     useDefineForClassFields: true,
            //     allowDeclareFields: true,
            // }],
            ],
        });
        if (!babelFileResult) {
            throw new Error(`Failed to transform code in PreviewFacet: ${code}`);
        }
        return babelFileResult.code;
    }
}
exports.BuiltinModuleProvider = BuiltinModuleProvider;
function makeModuleCCSource(dependencies) {
    const source = dependencies.map((dependency) => `export * from '${dependency}';`).join('\n');
    return source;
}
var ModuleNames;
(function (ModuleNames) {
    ModuleNames["codeQualityCr"] = "cce:code-quality/cr";
    ModuleNames["buildTimeConstants"] = "cc/env";
})(ModuleNames || (ModuleNames = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIvYnVpbHRpbi1tb2R1bGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLGlFQUE4RjtBQUM5RixtREFBcUM7QUFDckMsc0RBQXNEO0FBQ3RELGFBQWE7QUFDYixrREFBa0Q7QUFDbEQsaUhBQTJGO0FBQzNGLDhDQUFzQjtBQWV0Qjs7Ozs7O0dBTUc7QUFDSCxNQUFhLHFCQUFxQjtJQW9FOUIsWUFBb0IsT0FBNkI7O1FBSHpDLGFBQVEsR0FBMkIsRUFBRSxDQUFDO1FBSTFDLElBQUksQ0FBQyxPQUFPLFNBQUcsT0FBTyxDQUFDLE1BQU0sbUNBQUksS0FBSyxDQUFDO0lBQzNDLENBQUM7SUFyRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBNkI7UUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwRCxNQUFNLFFBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQVVNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFzQixFQUFFLFdBQXdCO1FBQzNFLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3hFO2FBQU07WUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN2RTtJQUNMLENBQUM7SUFFTSxLQUFLLENBQUMsYUFBYSxDQUFDLE1BQThCLEVBQUUsV0FBd0I7UUFDL0UsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQy9ELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3hFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDO0lBZU0sS0FBSyxDQUFDLHdCQUF3QixDQUFDLFNBQXVFLEVBQUUsV0FBd0I7UUFDbkksSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUM7Z0JBQ3pDLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLGtEQUEyQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7U0FDM0U7YUFBTTtZQUNILElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDO2dCQUN6QyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLGFBQVQsU0FBUyxjQUFULFNBQVMsR0FBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN6RjtRQUNELDJCQUEyQjtRQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVNLG1CQUFtQjtRQUN0QixPQUFPLHVDQUF1QyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7T0FFRztJQUNILElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBU08sS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUE2QjtJQUN2RCxDQUFDO0lBRU8sS0FBSyxDQUFDLGdCQUFnQixDQUFDLEtBQWEsRUFBRSxVQUFrQztRQUM1RSxJQUFJLFVBQVUsS0FBSyxVQUFVLEVBQUU7WUFDM0IsSUFBSSxVQUFrQixDQUFDO1lBQ3ZCLElBQUk7Z0JBQ0EsVUFBVSxHQUFHLGFBQUcsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDekM7WUFBQyxXQUFNO2dCQUNKLFVBQVUsR0FBRyxLQUFLLENBQUM7YUFDdEI7WUFDRCxPQUFPOzs7NENBR3lCLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQzs7O0NBRzVFLENBQUM7U0FDTzthQUFNLElBQUksVUFBVSxLQUFLLEtBQUssRUFBRTtZQUM3QixPQUFPO29CQUNDLEtBQUs7Ozs7Ozs7Q0FPeEIsQ0FBQztTQUNPO2FBQU07WUFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsS0FBSyxJQUFJLENBQUMsQ0FBQztTQUM3RDtJQUNMLENBQUM7SUFFTyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQVk7UUFDakMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLEtBQUssRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsTUFBTSxlQUFlLEdBQUcsTUFBTSxLQUFLLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRTtZQUNyRCxPQUFPLEVBQUUsQ0FBQyxDQUFDLDJDQUFtQyxDQUFDLENBQUM7WUFDaEQsT0FBTyxFQUFFO1lBQ0wscUJBQXFCO1lBQ3JCLDJCQUEyQjtZQUMzQixNQUFNO1lBQ04sb0JBQW9CO1lBQ3BCLHFDQUFxQztZQUNyQyxnQ0FBZ0M7WUFDaEMsTUFBTTthQUNUO1NBQ0osQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ3hFO1FBQ0QsT0FBTyxlQUFlLENBQUMsSUFBSyxDQUFDO0lBQ2pDLENBQUM7Q0FDSjtBQTlIRCxzREE4SEM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFlBQXNCO0lBQzlDLE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixVQUFVLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3RixPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBRUQsSUFBSyxXQUdKO0FBSEQsV0FBSyxXQUFXO0lBQ1osb0RBQXFDLENBQUE7SUFDckMsNENBQTZCLENBQUE7QUFDakMsQ0FBQyxFQUhJLFdBQVcsS0FBWCxXQUFXLFFBR2YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgcHMgZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IElCdWlsZFRpbWVDb25zdGFudFZhbHVlLCBtYWtlQnVpbGRUaW1lQ29uc3RhbnRNb2R1bGUgfSBmcm9tICcuL2J1aWxkLXRpbWUtY29uc3RhbnRzJztcclxuaW1wb3J0ICogYXMgYmFiZWwgZnJvbSAnQGJhYmVsL2NvcmUnO1xyXG4vLyBpbXBvcnQgYmFiZWxQcmVzZXRDQyBmcm9tICdAY29jb3MvYmFiZWwtcHJlc2V0LWNjJztcclxuLy8gQHRzLWlnbm9yZVxyXG4vLyBpbXBvcnQgYmFiZWxQcmVzZXRFbnYgZnJvbSAnQGJhYmVsL3ByZXNldC1lbnYnO1xyXG5pbXBvcnQgYmFiZWxQbHVnaW5UcmFuc2Zvcm1Nb2R1bGVzU3lzdGVtSnMgZnJvbSAnQGJhYmVsL3BsdWdpbi10cmFuc2Zvcm0tbW9kdWxlcy1zeXN0ZW1qcyc7XHJcbmltcG9ydCBVUkwgZnJvbSAndXJsJztcclxuXHJcbmludGVyZmFjZSBCdWlsdGluTW9kdWxlT3B0aW9ucyB7XHJcbiAgICAvKipcclxuICAgICAqIGBCdWlsdGluTW9kdWxlUHJvdmlkZXJgIOS4reaPkOS+m+eahOaooeWdl+eahOagvOW8j+OAglxyXG4gICAgICovXHJcbiAgICBmb3JtYXQ/OiAnc3lzdGVtanMnIHwgJ2VzbSc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlvojlpJrml7blgJkgYEJ1aWx0aW5Nb2R1bGVQcm92aWRlcmAg5Lit55qE5qih5Z2X6ZyA6KaB5pig5bCE5Yiw5YW25a6D5qih5Z2X44CCXHJcbiAqIGBUYXJnZXRLaW5kYCDku6Pooajkuobnm67moIfmqKHlnZfnmoTmqKHlnZfmoLzlvI/jgIJcclxuICovXHJcbnR5cGUgVGFyZ2V0S2luZCA9ICdjb21tb25qcycgfCAnYW1kJztcclxuXHJcbi8qKlxyXG4gKiBgQnVpbHRpbk1vZHVsZVByb3ZpZGVyYCDnlKjkuo7mj5Dkvpvpobnnm67ohJrmnKznlKjliLDnmoTmiYDmnInigJzlhoXnva7igJ3mqKHlnZfvvIzkvovlpoLvvJpcclxuICogLSBgXCJjYy5iYXNlXCJgIOetieW8leaTjuaooeWdl1xyXG4gKiAtIOaooeWdlyBgXCJjYy9lbnZcImAg4oCU4oCUIOaPkOS+m+S6huaehOW7uuaXtuW4uOmHj1xyXG4gKiBcclxuICog5a6D5o+Q5L6b55qE5YaF572u5qih5Z2X5Y+v5Lul55So5LqO5ZyoKirnvJbovpHlmajnjq/looMqKuS4reOAgSoq6aKE6KeI546v5aKDKirkuK3ku6Xlj4oqKuaehOW7uuaXtuaJk+WMheW3peWFtyoq55qE546v5aKD5Lit6L+Q6KGM44CCXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQnVpbHRpbk1vZHVsZVByb3ZpZGVyIHtcclxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY3JlYXRlKG9wdGlvbnM6IEJ1aWx0aW5Nb2R1bGVPcHRpb25zKTogUHJvbWlzZTxCdWlsdGluTW9kdWxlUHJvdmlkZXI+IHtcclxuICAgICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBCdWlsdGluTW9kdWxlUHJvdmlkZXIob3B0aW9ucyk7XHJcbiAgICAgICAgYXdhaXQgcHJvdmlkZXIuX2luaXRpYWxpemUob3B0aW9ucyk7XHJcbiAgICAgICAgcmV0dXJuIHByb3ZpZGVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5re75YqgIGAnY2MnYCDmqKHlnZfjgIJcclxuICAgICAqIEBwYXJhbSBtb2RzIGAnY2MnYCDmqKHlnZflr7zlh7rnmoTmiYDmnInlrZDmqKHlnZfjgIJcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGFkZEVuZ2luZUluZGV4TW9kKG1vZHM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgYWRkRW5naW5lSW5kZXhNb2QodXJsOiBzdHJpbmcsIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCk6IFByb21pc2U8dm9pZD47XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGFkZEVuZ2luZUluZGV4TW9kKHVybDogc3RyaW5nW10gfCBzdHJpbmcsIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCkge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVybCkpIHtcclxuICAgICAgICAgICAgdGhpcy5fbW9kdWxlc1snY2MnXSA9IGF3YWl0IHRoaXMuX3RyYW5zZm9ybShtYWtlTW9kdWxlQ0NTb3VyY2UodXJsKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fbW9kdWxlc1snY2MnXSA9IGF3YWl0IHRoaXMuX21ha2VNb2R1bGVBbGlhcyh1cmwsIHhTb3VyY2VLaW5kKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGFkZEVuZ2luZU1vZHMoY2NNb2RzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LCB4U291cmNlS2luZD86IFRhcmdldEtpbmQpIHtcclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChPYmplY3QuZW50cmllcyhjY01vZHMpLm1hcChhc3luYyAoW2lkLCBhbGlhc10pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fbW9kdWxlc1tpZF0gPSBhd2FpdCB0aGlzLl9tYWtlTW9kdWxlQWxpYXMoYWxpYXMsIHhTb3VyY2VLaW5kKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmt7vliqAgYCdjYy9lbnYnYCDmqKHlnZfjgIJcclxuICAgICAqIEBwYXJhbSBjb25zdGFudHMgYCdjYy9lbnYnYCDmqKHlnZfkuK3nmoTluLjph4/ku6Xlj4rlroPku6znmoTlgLzjgIJcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGFkZEJ1aWxkVGltZUNvbnN0YW50c01vZChjb25zdGFudHM6IFJlY29yZDxzdHJpbmcsIElCdWlsZFRpbWVDb25zdGFudFZhbHVlPik6IFByb21pc2U8dm9pZD47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmt7vliqAgYCdjYy9lbnYnYCDmqKHlnZfjgILorqkgYCdjYy9lbnYnYCDmmKDlsITkuLrmjIflrprnmoTmqKHlnZcuXHJcbiAgICAgKiBAcGFyYW0gdXJsIOaMh+WumueahOaooeWdl+OAguiLpeacquaMh+WumuWImeS4uiBgdGhpcy5nZXRCVENNYXBwaW5nU291cmNlKClg44CCXHJcbiAgICAgKiBAcGFyYW0geFNvdXJjZUtpbmQg5oyH5a6a5qih5Z2X55qE5qC85byP44CCXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBhZGRCdWlsZFRpbWVDb25zdGFudHNNb2QodXJsPzogc3RyaW5nLCB4U291cmNlS2luZD86IFRhcmdldEtpbmQpOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICAgIHB1YmxpYyBhc3luYyBhZGRCdWlsZFRpbWVDb25zdGFudHNNb2QoY29uc3RhbnRzOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBSZWNvcmQ8c3RyaW5nLCBJQnVpbGRUaW1lQ29uc3RhbnRWYWx1ZT4sIHhTb3VyY2VLaW5kPzogVGFyZ2V0S2luZCkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgY29uc3RhbnRzID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICB0aGlzLl9tb2R1bGVzW01vZHVsZU5hbWVzLmJ1aWxkVGltZUNvbnN0YW50c10gPVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fdHJhbnNmb3JtKGF3YWl0IG1ha2VCdWlsZFRpbWVDb25zdGFudE1vZHVsZShjb25zdGFudHMpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9tb2R1bGVzW01vZHVsZU5hbWVzLmJ1aWxkVGltZUNvbnN0YW50c10gPVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbWFrZU1vZHVsZUFsaWFzKGNvbnN0YW50cyA/PyB0aGlzLmdldEJUQ01hcHBpbmdTb3VyY2UoKSwgeFNvdXJjZUtpbmQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBEZXByZWNhdGVkOiB1c2UgJ2NjL2VudidcclxuICAgICAgICB0aGlzLl9tb2R1bGVzWydjY2UuZW52J10gPSB0aGlzLl9tb2R1bGVzW01vZHVsZU5hbWVzLmJ1aWxkVGltZUNvbnN0YW50c107XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEJUQ01hcHBpbmdTb3VyY2UoKSB7XHJcbiAgICAgICAgcmV0dXJuIGBjYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOW9k+WJjeaPkOS+m+eahOaJgOacieaooeWdl+S7peWPiuWug+S7rOeahOa6kOeggeOAglxyXG4gICAgICovXHJcbiAgICBnZXQgbW9kdWxlcygpOiBSZWFkb25seTxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vZHVsZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbW9kdWxlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xyXG4gICAgcHJpdmF0ZSBfZm9ybWF0OiBOb25OdWxsYWJsZTxCdWlsdGluTW9kdWxlT3B0aW9uc1snZm9ybWF0J10+O1xyXG5cclxuICAgIHByaXZhdGUgY29uc3RydWN0b3Iob3B0aW9uczogQnVpbHRpbk1vZHVsZU9wdGlvbnMpIHtcclxuICAgICAgICB0aGlzLl9mb3JtYXQgPSBvcHRpb25zLmZvcm1hdCA/PyAnZXNtJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEJ1aWx0aW5Nb2R1bGVPcHRpb25zKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfbWFrZU1vZHVsZUFsaWFzKGFsaWFzOiBzdHJpbmcsIHRhcmdldEtpbmQ6IFRhcmdldEtpbmQgfCB1bmRlZmluZWQpIHtcclxuICAgICAgICBpZiAodGFyZ2V0S2luZCA9PT0gJ2NvbW1vbmpzJykge1xyXG4gICAgICAgICAgICBsZXQgbW9kdWxlTmFtZTogc3RyaW5nO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbW9kdWxlTmFtZSA9IFVSTC5maWxlVVJMVG9QYXRoKGFsaWFzKTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gYWxpYXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGBcXFxyXG5TeXN0ZW0ucmVnaXN0ZXIoW10sIChfZXhwb3J0KSA9PiB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGV4ZWN1dGU6ICgpID0+IHsgX2V4cG9ydChyZXF1aXJlKCcke21vZHVsZU5hbWUucmVwbGFjZSgvXFxcXC9nLCAnXFxcXFxcXFwnKX0nKSk7IH0sXHJcbiAgICB9O1xyXG59KTtcclxuYDtcclxuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldEtpbmQgPT09ICdhbWQnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgXFxcclxuU3lzdGVtLnJlZ2lzdGVyKFsnJHthbGlhc30nXSwgKF9leHBvcnQpID0+IHtcclxuICAgIGxldCBtO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzZXR0ZXJzOiBbKG1BbWQpID0+IHsgbSA9IG1BbWQuZGVmYXVsdDsgfV0sXHJcbiAgICAgICAgZXhlY3V0ZTogKCkgPT4geyBfZXhwb3J0KG0pOyB9LFxyXG4gICAgfTtcclxufSk7XHJcbmA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3RyYW5zZm9ybShgZXhwb3J0ICogZnJvbSAnJHthbGlhc30nO2ApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF90cmFuc2Zvcm0oY29kZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2Zvcm1hdCA9PT0gJ2VzbScpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvZGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGJhYmVsRmlsZVJlc3VsdCA9IGF3YWl0IGJhYmVsLnRyYW5zZm9ybUFzeW5jKGNvZGUsIHtcclxuICAgICAgICAgICAgcGx1Z2luczogW1tiYWJlbFBsdWdpblRyYW5zZm9ybU1vZHVsZXNTeXN0ZW1Kc11dLFxyXG4gICAgICAgICAgICBwcmVzZXRzOiBbXHJcbiAgICAgICAgICAgICAgICAvLyBbYmFiZWxQcmVzZXRFbnYsIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICBtb2R1bGVzOiAnc3lzdGVtanMnLFxyXG4gICAgICAgICAgICAgICAgLy8gfV0sXHJcbiAgICAgICAgICAgICAgICAvLyBbYmFiZWxQcmVzZXRDQywge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIHVzZURlZmluZUZvckNsYXNzRmllbGRzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgIGFsbG93RGVjbGFyZUZpZWxkczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIC8vIH1dLFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmICghYmFiZWxGaWxlUmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHRyYW5zZm9ybSBjb2RlIGluIFByZXZpZXdGYWNldDogJHtjb2RlfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYmFiZWxGaWxlUmVzdWx0LmNvZGUhO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlTW9kdWxlQ0NTb3VyY2UoZGVwZW5kZW5jaWVzOiBzdHJpbmdbXSkge1xyXG4gICAgY29uc3Qgc291cmNlID0gZGVwZW5kZW5jaWVzLm1hcCgoZGVwZW5kZW5jeSkgPT4gYGV4cG9ydCAqIGZyb20gJyR7ZGVwZW5kZW5jeX0nO2ApLmpvaW4oJ1xcbicpO1xyXG4gICAgcmV0dXJuIHNvdXJjZTtcclxufVxyXG5cclxuZW51bSBNb2R1bGVOYW1lcyB7XHJcbiAgICBjb2RlUXVhbGl0eUNyID0gJ2NjZTpjb2RlLXF1YWxpdHkvY3InLFxyXG4gICAgYnVpbGRUaW1lQ29uc3RhbnRzID0gJ2NjL2VudicsXHJcbn1cclxuIl19