"use strict";
/// <reference path="../../@types/systemjs/systemjs.d.ts"/>
/// <reference path="../../@types/systemjs/extras/named-register.d.ts"/>
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalEditorSystem = exports.ExecutorSystem = void 0;
const out_1 = require("../../static/executor/systemjs-bridge/out");
const url_1 = __importDefault(require("url"));
const i18n_1 = require("../utils/i18n");
class ExecutorSystem {
    constructor() {
        this._registry = Object.create(null);
        this._lastRegister = null;
        this._baseUrl = 'project:///';
        this._instantiationHandlers = [];
        this._importMap = {
            imports: {},
            scopes: {},
        };
        const me = this;
        if (!out_1.systemJSPrototype.prepareImport) {
            out_1.systemJSPrototype.prepareImport = () => { };
        }
        out_1.systemJSPrototype.resolve = function (...args) {
            // @ts-ignore
            return me._resolve(this, ...args);
        };
        out_1.systemJSPrototype.instantiate = function (...args) {
            // @ts-ignore
            return me._instantiate(this, ...args);
        };
        this._vendorRegisterFn = out_1.systemJSPrototype.register;
        out_1.systemJSPrototype.register = function (...args) {
            if (typeof args[0] === 'string') {
                // @ts-ignore
                return me.setRegister(...args);
            }
            // @ts-ignore
            return me._register(this, ...args);
        };
        this._detailResolve = out_1.createDetailResolver(undefined, // logger,
        undefined);
    }
    get importMap() {
        return this._importMap;
    }
    async import(url) {
        return await System.import(url);
    }
    /**
     * Provides the last anonymous `System.register` call.
     */
    getRegister() {
        const lastRegister = this._lastRegister;
        this._lastRegister = null;
        return lastRegister;
    }
    clearImportMap() {
        this._importMap.imports = {};
        this._importMap.scopes = {};
    }
    extendImportMap(importMap, baseUrl) {
        out_1.systemJsCommon.resolveAndComposeImportMap(importMap, baseUrl, this._importMap);
    }
    setRegister(id, dependencies, declare) {
        this._registry[id] = [dependencies, declare];
    }
    deleteRegister(id) {
        delete this._registry[id];
    }
    encodeModsMgrRequest(id) {
        const url = `${ExecutorSystem.protocolHeadModsMgr}${encodeURIComponent(id)}`;
        return url;
    }
    addInstantiationHandler(handler) {
        this._instantiationHandlers.push(handler);
    }
    setResolutionDetailMap(resolutionDetailMap, url) {
        console.debug(`Set detail map ${url}: ${JSON.stringify(resolutionDetailMap, undefined, 2)}`);
        out_1.setResolutionDetailMap(resolutionDetailMap, url);
    }
    _resolve(systemJSPrototype, id, parentURL) {
        parentURL = parentURL !== null && parentURL !== void 0 ? parentURL : this._baseUrl;
        this._detailResolve(id, parentURL);
        const result = out_1.systemJsCommon.resolveImportMap(this._importMap, out_1.systemJsCommon.resolveIfNotPlainOrUrl(id, parentURL) || id, parentURL);
        if (result) {
            return result;
        }
        if (id in this._registry) {
            return id;
        }
        return this._throwUnresolved(id, parentURL);
    }
    async _instantiate(systemJSPrototype, url, firstParentUrl) {
        if (url in this._registry) {
            // TODO: this._registry[url] = null;
            return this._registry[url];
        }
        for (const handler of this._instantiationHandlers) {
            const register = await handler(url);
            if (register) {
                return register;
            }
        }
        let path;
        if (url.startsWith('file:')) {
            try {
                path = url_1.default.fileURLToPath(url);
            }
            catch (_a) { }
        }
        if (url.startsWith(ExecutorSystem.protocolHeadModsMgr)) {
            const urlObject = new URL(url);
            const pathname = urlObject.pathname;
            const id = decodeURIComponent(pathname);
            return [[], (exportBindings) => {
                    return {
                        execute: () => {
                            const modsMgr = require('cc/mods-mgr');
                            const mod = modsMgr.syncImport(id);
                            exportBindings(mod);
                        },
                    };
                }];
        }
        if (path) {
            require(path);
            const register = this.getRegister();
            if (!register) {
                throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url }));
            }
            return register;
        }
        return this._throwInstantiationError(url, firstParentUrl);
    }
    /**
     * 处理 `System.register()` 调用。
     */
    _register(systemJSPrototype, deps, declare) {
        this._lastRegister = [deps, declare];
    }
    _throwUnresolved(id, parentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_resolve', { specifier: id, parentURL: parentUrl !== null && parentUrl !== void 0 ? parentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
    _throwInstantiationError(url, firstParentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_instantiate', { url, firstParentURL: firstParentUrl !== null && firstParentUrl !== void 0 ? firstParentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
}
exports.ExecutorSystem = ExecutorSystem;
ExecutorSystem.protocolHeadModsMgr = 'mods-mgr:';
exports.globalEditorSystem = new ExecutorSystem();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLXN5c3RlbWpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyREFBMkQ7QUFDM0Qsd0VBQXdFOzs7Ozs7QUFFeEUsbUVBTW1EO0FBQ25ELDhDQUEwQjtBQUMxQix3Q0FBOEM7QUFPOUMsTUFBYSxjQUFjO0lBVXZCO1FBUFEsY0FBUyxHQUFxQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELGtCQUFhLEdBQTBCLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQUcsYUFBYSxDQUFDO1FBQ3pCLDJCQUFzQixHQUEyQixFQUFFLENBQUM7UUErRXBELGVBQVUsR0FHZDtZQUNBLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBakZFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsdUJBQWlCLENBQUMsYUFBYSxFQUFFO1lBQ2xDLHVCQUFpQixDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7U0FDOUM7UUFDRCx1QkFBaUIsQ0FBQyxPQUFPLEdBQUcsVUFBUyxHQUFHLElBQVM7WUFDN0MsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUM7UUFDRix1QkFBaUIsQ0FBQyxXQUFXLEdBQUcsVUFBUyxHQUFHLElBQVM7WUFDakQsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsdUJBQWlCLENBQUMsUUFBUSxDQUFDO1FBQ3BELHVCQUFpQixDQUFDLFFBQVEsR0FBRyxVQUFTLEdBQUcsSUFBUztZQUM5QyxJQUFJ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QUMsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7O0FBMUxMLHdDQTJMQztBQTFMMEIsa0NBQW1CLEdBQUcsV0FBVyxDQUFDO0FBaU1oRCxRQUFBLGtCQUFrQixHQUFHLElBQUksY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vQHR5cGVzL3N5c3RlbWpzL3N5c3RlbWpzLmQudHNcIi8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvZXh0cmFzL25hbWVkLXJlZ2lzdGVyLmQudHNcIi8+XHJcblxyXG5pbXBvcnQge1xyXG4gICAgc3lzdGVtSlNQcm90b3R5cGUsXHJcbiAgICBzeXN0ZW1Kc0NvbW1vbixcclxuICAgIHNldFJlc29sdXRpb25EZXRhaWxNYXAsXHJcbiAgICBjcmVhdGVEZXRhaWxSZXNvbHZlcixcclxuICAgIC8vIEB0cy1pZ25vcmVcclxufSBmcm9tICcuLi8uLi9zdGF0aWMvZXhlY3V0b3Ivc3lzdGVtanMtYnJpZGdlL291dCc7XHJcbmltcG9ydCBOb2RlVXJsIGZyb20gJ3VybCc7XHJcbmltcG9ydCB7IGkxOG5UcmFuc2xhdGUgfSBmcm9tICcuLi91dGlscy9pMThuJztcclxuaW1wb3J0IHR5cGUgeyBSZXNvbHV0aW9uRGV0YWlsTWFwIH0gZnJvbSAnQGNvY29zL2NyZWF0b3ItcHJvZ3JhbW1pbmctcXVpY2stcGFjay9saWIvcmVzb2x1dGlvbi1kZXRhaWwtbWFwJztcclxuXHJcbnR5cGUgU3lzdGVtSnNSZWdpc3RyeSA9IFJlY29yZDxzdHJpbmcsIE1vZHVsZVJlZ2lzdGVyPjtcclxuXHJcbnR5cGUgSW5zdGFudGlhdGlvbkhhbmRsZXIgPSAodXJsOiBzdHJpbmcpID0+IE1vZHVsZVJlZ2lzdGVyIHwgdW5kZWZpbmVkIHwgUHJvbWlzZTxNb2R1bGVSZWdpc3RlciB8IHVuZGVmaW5lZD47XHJcblxyXG5leHBvcnQgY2xhc3MgRXhlY3V0b3JTeXN0ZW0ge1xyXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBwcm90b2NvbEhlYWRNb2RzTWdyID0gJ21vZHMtbWdyOic7XHJcblxyXG4gICAgcHJpdmF0ZSBfcmVnaXN0cnk6IFN5c3RlbUpzUmVnaXN0cnkgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgcHJpdmF0ZSBfdmVuZG9yUmVnaXN0ZXJGbjogRnVuY3Rpb247XHJcbiAgICBwcml2YXRlIF9sYXN0UmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIF9iYXNlVXJsID0gJ3Byb2plY3Q6Ly8vJztcclxuICAgIHByaXZhdGUgX2luc3RhbnRpYXRpb25IYW5kbGVyczogSW5zdGFudGlhdGlvbkhhbmRsZXJbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfZGV0YWlsUmVzb2x2ZTogKHNwZWNpZmllcjogc3RyaW5nLCBpbXBvcnRlcj86IHN0cmluZykgPT4gdm9pZDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBjb25zdCBtZSA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCFzeXN0ZW1KU1Byb3RvdHlwZS5wcmVwYXJlSW1wb3J0KSB7XHJcbiAgICAgICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLnByZXBhcmVJbXBvcnQgPSAoKSA9PiB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKC4uLmFyZ3M6IGFueSkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVzb2x2ZSh0aGlzLCAuLi5hcmdzKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLmluc3RhbnRpYXRlID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgcmV0dXJuIG1lLl9pbnN0YW50aWF0ZSh0aGlzLCAuLi5hcmdzKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX3ZlbmRvclJlZ2lzdGVyRm4gPSBzeXN0ZW1KU1Byb3RvdHlwZS5yZWdpc3RlcjtcclxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uKC4uLmFyZ3M6IGFueSkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbWUuc2V0UmVnaXN0ZXIoLi4uYXJncyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICByZXR1cm4gbWUuX3JlZ2lzdGVyKHRoaXMsIC4uLmFyZ3MpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5fZGV0YWlsUmVzb2x2ZSA9IGNyZWF0ZURldGFpbFJlc29sdmVyKFxyXG4gICAgICAgICAgICB1bmRlZmluZWQsIC8vIGxvZ2dlcixcclxuICAgICAgICAgICAgdW5kZWZpbmVkLCAvLyByZWplY3RvclxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGltcG9ydE1hcCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW1wb3J0TWFwO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGltcG9ydCh1cmw6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCBTeXN0ZW0uaW1wb3J0KHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcm92aWRlcyB0aGUgbGFzdCBhbm9ueW1vdXMgYFN5c3RlbS5yZWdpc3RlcmAgY2FsbC5cclxuICAgICAqL1xyXG4gICAgZ2V0UmVnaXN0ZXIoKSB7XHJcbiAgICAgICAgY29uc3QgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xyXG4gICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckltcG9ydE1hcCgpIHtcclxuICAgICAgICB0aGlzLl9pbXBvcnRNYXAuaW1wb3J0cyA9IHt9O1xyXG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcC5zY29wZXMgPSB7fTtcclxuICAgIH1cclxuXHJcbiAgICBleHRlbmRJbXBvcnRNYXAoaW1wb3J0TWFwOiBJbXBvcnRNYXAsIGJhc2VVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKGltcG9ydE1hcCwgYmFzZVVybCwgdGhpcy5faW1wb3J0TWFwKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRSZWdpc3RlcihpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XHJcbiAgICAgICAgdGhpcy5fcmVnaXN0cnlbaWRdID0gW2RlcGVuZGVuY2llcywgZGVjbGFyZV07XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlUmVnaXN0ZXIoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLl9yZWdpc3RyeVtpZF07XHJcbiAgICB9XHJcblxyXG4gICAgZW5jb2RlTW9kc01nclJlcXVlc3QoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHVybCA9IGAke0V4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3J9JHtlbmNvZGVVUklDb21wb25lbnQoaWQpfWA7XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH1cclxuXHJcbiAgICBhZGRJbnN0YW50aWF0aW9uSGFuZGxlcihoYW5kbGVyOiBJbnN0YW50aWF0aW9uSGFuZGxlcikge1xyXG4gICAgICAgIHRoaXMuX2luc3RhbnRpYXRpb25IYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFJlc29sdXRpb25EZXRhaWxNYXAocmVzb2x1dGlvbkRldGFpbE1hcDogUmVzb2x1dGlvbkRldGFpbE1hcCwgdXJsOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKGBTZXQgZGV0YWlsIG1hcCAke3VybH06ICR7SlNPTi5zdHJpbmdpZnkocmVzb2x1dGlvbkRldGFpbE1hcCwgdW5kZWZpbmVkLCAyKX1gKTtcclxuICAgICAgICBzZXRSZXNvbHV0aW9uRGV0YWlsTWFwKHJlc29sdXRpb25EZXRhaWxNYXAsIHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfaW1wb3J0TWFwOiBJbXBvcnRNYXAgJiB7XHJcbiAgICAgICAgaW1wb3J0czogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydpbXBvcnRzJ10+O1xyXG4gICAgICAgIHNjb3BlczogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydzY29wZXMnXT47XHJcbiAgICB9ID0ge1xyXG4gICAgICAgIGltcG9ydHM6IHt9LFxyXG4gICAgICAgIHNjb3Blczoge30sXHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgX3Jlc29sdmUoXHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxyXG4gICAgICAgIGlkOiBzdHJpbmcsXHJcbiAgICAgICAgcGFyZW50VVJMPzogc3RyaW5nLFxyXG4gICAgKTogc3RyaW5nIHtcclxuICAgICAgICBwYXJlbnRVUkwgPSBwYXJlbnRVUkwgPz8gdGhpcy5fYmFzZVVybDtcclxuXHJcbiAgICAgICAgdGhpcy5fZGV0YWlsUmVzb2x2ZShpZCwgcGFyZW50VVJMKTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc3lzdGVtSnNDb21tb24ucmVzb2x2ZUltcG9ydE1hcChcclxuICAgICAgICAgICAgdGhpcy5faW1wb3J0TWFwLFxyXG4gICAgICAgICAgICBzeXN0ZW1Kc0NvbW1vbi5yZXNvbHZlSWZOb3RQbGFpbk9yVXJsKGlkLCBwYXJlbnRVUkwpIHx8IGlkLFxyXG4gICAgICAgICAgICBwYXJlbnRVUkwsXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGlkIGluIHRoaXMuX3JlZ2lzdHJ5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl90aHJvd1VucmVzb2x2ZWQoaWQsIHBhcmVudFVSTCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfaW5zdGFudGlhdGUoXHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxyXG4gICAgICAgIHVybDogc3RyaW5nLFxyXG4gICAgICAgIGZpcnN0UGFyZW50VXJsOiBzdHJpbmcsXHJcbiAgICApOiBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyPiB7XHJcbiAgICAgICAgaWYgKHVybCBpbiB0aGlzLl9yZWdpc3RyeSkge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzLl9yZWdpc3RyeVt1cmxdID0gbnVsbDtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lzdHJ5W3VybF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5faW5zdGFudGlhdGlvbkhhbmRsZXJzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gYXdhaXQgaGFuZGxlcih1cmwpO1xyXG4gICAgICAgICAgICBpZiAocmVnaXN0ZXIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6JykpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHBhdGggPSBOb2RlVXJsLmZpbGVVUkxUb1BhdGgodXJsKTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7IH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChFeGVjdXRvclN5c3RlbS5wcm90b2NvbEhlYWRNb2RzTWdyKSkge1xyXG4gICAgICAgICAgICBjb25zdCB1cmxPYmplY3QgPSBuZXcgVVJMKHVybCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhuYW1lID0gdXJsT2JqZWN0LnBhdGhuYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXRobmFtZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBbW10sIChleHBvcnRCaW5kaW5ncyk6IERlY2xhcmVSZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHNNZ3IgPSByZXF1aXJlKCdjYy9tb2RzLW1ncicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtb2QgPSBtb2RzTWdyLnN5bmNJbXBvcnQoaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRCaW5kaW5ncyhtb2QpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgICAgIHJlcXVpcmUocGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gdGhpcy5nZXRSZWdpc3RlcigpO1xyXG4gICAgICAgICAgICBpZiAoIXJlZ2lzdGVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJywgeyB1cmwgfSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl90aHJvd0luc3RhbnRpYXRpb25FcnJvcih1cmwsIGZpcnN0UGFyZW50VXJsKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWkhOeQhiBgU3lzdGVtLnJlZ2lzdGVyKClgIOiwg+eUqOOAglxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZWdpc3RlcihzeXN0ZW1KU1Byb3RvdHlwZTogU3lzdGVtSnNQcm90b3R5cGUsIGRlcHM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XHJcbiAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gW2RlcHMsIGRlY2xhcmVdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3Rocm93VW5yZXNvbHZlZChpZDogc3RyaW5nLCBwYXJlbnRVcmw/OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19yZXNvbHZlJyxcclxuICAgICAgICAgICAgeyBzcGVjaWZpZXI6IGlkLCBwYXJlbnRVUkw6IHBhcmVudFVybCA/PyBpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9zeXN0ZW1fanNfb3JpZ2luJykgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3Rocm93SW5zdGFudGlhdGlvbkVycm9yKHVybDogc3RyaW5nLCBmaXJzdFBhcmVudFVybDogc3RyaW5nKTogTW9kdWxlUmVnaXN0ZXIge1xyXG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19pbnN0YW50aWF0ZScsXHJcbiAgICAgICAgICAgIHsgdXJsLCBmaXJzdFBhcmVudFVSTDogZmlyc3RQYXJlbnRVcmwgPz8gaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX29yaWdpbicpIH0pKTtcclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIEltcG9ydE1hcCB7XHJcbiAgICBpbXBvcnRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxuICAgIHNjb3Blcz86IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+O1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZ2xvYmFsRWRpdG9yU3lzdGVtID0gbmV3IEV4ZWN1dG9yU3lzdGVtKCk7XHJcblxyXG4iXX0=