"use strict";
/// <reference path="../../@types/systemjs/systemjs.d.ts"/>
/// <reference path="../../@types/systemjs/extras/named-register.d.ts"/>
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalEditorSystem = exports.ExecutorSystem = void 0;
const out_1 = require("../../static/executor/systemjs-bridge/out");
const url_1 = __importDefault(require("url"));
const i18n_1 = require("../utils/i18n");
class ExecutorSystem {
    constructor() {
        this._registry = Object.create(null);
        this._lastRegister = null;
        this._baseUrl = 'project:///';
        this._instantiationHandlers = [];
        this._importMap = {
            imports: {},
            scopes: {},
        };
        const me = this;
        if (!out_1.systemJSPrototype.prepareImport) {
            out_1.systemJSPrototype.prepareImport = () => { };
        }
        out_1.systemJSPrototype.resolve = function (...args) {
            // @ts-ignore
            return me._resolve(this, ...args);
        };
        out_1.systemJSPrototype.instantiate = function (...args) {
            // @ts-ignore
            return me._instantiate(this, ...args);
        };
        this._vendorRegisterFn = out_1.systemJSPrototype.register;
        out_1.systemJSPrototype.register = function (...args) {
            if (typeof args[0] === 'string') {
                // @ts-ignore
                return me.setRegister(...args);
            }
            // @ts-ignore
            return me._register(this, ...args);
        };
        this._detailResolve = out_1.createDetailResolver(undefined, // logger,
        undefined);
        // TODO: merge systemjs implementation
        const upvalueMap = {};
        const vendorCreateContext = out_1.systemJSPrototype.createContext;
        out_1.systemJSPrototype.createContext = function (id) {
            const name2class = {};
            const context = vendorCreateContext.call(this, id);
            upvalueMap[context.url] = name2class;
            return Object.assign(Object.assign({}, context), { upvalue(name) {
                    return function (target) {
                        name2class[name] = target;
                    };
                } });
        };
    }
    get importMap() {
        return this._importMap;
    }
    async import(url) {
        return await System.import(url);
    }
    /**
     * Provides the last anonymous `System.register` call.
     */
    getRegister() {
        const lastRegister = this._lastRegister;
        this._lastRegister = null;
        return lastRegister;
    }
    clearImportMap() {
        this._importMap.imports = {};
        this._importMap.scopes = {};
    }
    extendImportMap(importMap, baseUrl) {
        out_1.systemJsCommon.resolveAndComposeImportMap(importMap, baseUrl, this._importMap);
    }
    setRegister(id, dependencies, declare) {
        this._registry[id] = [dependencies, declare];
    }
    deleteRegister(id) {
        delete this._registry[id];
    }
    encodeModsMgrRequest(id) {
        const url = `${ExecutorSystem.protocolHeadModsMgr}${encodeURIComponent(id)}`;
        return url;
    }
    addInstantiationHandler(handler) {
        this._instantiationHandlers.push(handler);
    }
    setResolutionDetailMap(resolutionDetailMap, url) {
        console.debug(`Set detail map ${url}: ${JSON.stringify(resolutionDetailMap, undefined, 2)}`);
        out_1.setResolutionDetailMap(resolutionDetailMap, url);
    }
    _resolve(systemJSPrototype, id, parentURL) {
        parentURL = parentURL !== null && parentURL !== void 0 ? parentURL : this._baseUrl;
        this._detailResolve(id, parentURL);
        const result = out_1.systemJsCommon.resolveImportMap(this._importMap, out_1.systemJsCommon.resolveIfNotPlainOrUrl(id, parentURL) || id, parentURL);
        if (result) {
            return result;
        }
        if (id in this._registry) {
            return id;
        }
        return this._throwUnresolved(id, parentURL);
    }
    async _instantiate(systemJSPrototype, url, firstParentUrl) {
        if (url in this._registry) {
            // TODO: this._registry[url] = null;
            return this._registry[url];
        }
        for (const handler of this._instantiationHandlers) {
            const register = await handler(url);
            if (register) {
                return register;
            }
        }
        let path;
        if (url.startsWith('file:')) {
            try {
                path = url_1.default.fileURLToPath(url);
            }
            catch (_a) { }
        }
        if (url.startsWith(ExecutorSystem.protocolHeadModsMgr)) {
            const urlObject = new URL(url);
            const pathname = urlObject.pathname;
            const id = decodeURIComponent(pathname);
            return [[], (exportBindings) => {
                    return {
                        execute: () => {
                            const modsMgr = require('cc/mods-mgr');
                            const mod = modsMgr.syncImport(id);
                            exportBindings(mod);
                        },
                    };
                }];
        }
        if (path) {
            require(path);
            const register = this.getRegister();
            if (!register) {
                throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url }));
            }
            return register;
        }
        return this._throwInstantiationError(url, firstParentUrl);
    }
    /**
     * 处理 `System.register()` 调用。
     */
    _register(systemJSPrototype, deps, declare) {
        this._lastRegister = [deps, declare];
    }
    _throwUnresolved(id, parentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_resolve', { specifier: id, parentURL: parentUrl !== null && parentUrl !== void 0 ? parentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
    _throwInstantiationError(url, firstParentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_instantiate', { url, firstParentURL: firstParentUrl !== null && firstParentUrl !== void 0 ? firstParentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
}
exports.ExecutorSystem = ExecutorSystem;
ExecutorSystem.protocolHeadModsMgr = 'mods-mgr:';
exports.globalEditorSystem = new ExecutorSystem();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLXN5c3RlbWpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyREFBMkQ7QUFDM0Qsd0VBQXdFOzs7Ozs7QUFFeEUsbUVBTW1EO0FBQ25ELDhDQUEwQjtBQUMxQix3Q0FBOEM7QUFPOUMsTUFBYSxjQUFjO0lBVXZCO1FBUFEsY0FBUyxHQUFxQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELGtCQUFhLEdBQTBCLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQUcsYUFBYSxDQUFDO1FBQ3pCLDJCQUFzQixHQUEyQixFQUFFLENBQUM7UUFnR3BELGVBQVUsR0FHZDtZQUNBLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBbEdFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsdUJBQWlCLENBQUMsYUFBYSxFQUFFO1lBQ2xDLHVCQUFpQixDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7U0FDOUM7UUFDRCx1QkFBaUIsQ0FBQyxPQUFPLEdBQUcsVUFBVSxHQUFHLElBQVM7WUFDOUMsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUM7UUFDRix1QkFBaUIsQ0FBQyxXQUFXLEdBQUcsVUFBVSxHQUFHLElBQVM7WUFDbEQsYUFBYTtZQUNiLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsdUJBQWlCLENBQUMsUUFBUSxDQUFDO1FBQ3BELHVCQUFpQixDQUFDLFFBQVEsR0FBRyxVQUFVLEdBQUcsSUFBUztZQUMvQyxJQUFJ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Q3BGLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEVBQVUsRUFBRSxTQUFrQjtRQUNuRCxNQUFNLEtBQUssQ0FBQyxvQkFBYSxDQUFDLDRCQUE0QixFQUNsRCxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFNBQVMsYUFBVCxTQUFTLGNBQVQsU0FBUyxHQUFJLG9CQUFhLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0lBRU8sd0JBQXdCLENBQUMsR0FBVyxFQUFFLGNBQXNCO1FBQ2hFLE1BQU0sS0FBSyxDQUFDLG9CQUFhLENBQUMsZ0NBQWdDLEVBQ3RELEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxjQUFjLGFBQWQsY0FBYyxjQUFkLGNBQWMsR0FBSSxvQkFBYSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQzs7QUEzTUwsd0NBNE1DO0FBM00wQixrQ0FBbUIsR0FBRyxXQUFXLENBQUM7QUFrTmhELFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvc3lzdGVtanMuZC50c1wiLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL0B0eXBlcy9zeXN0ZW1qcy9leHRyYXMvbmFtZWQtcmVnaXN0ZXIuZC50c1wiLz5cclxuXHJcbmltcG9ydCB7XHJcbiAgICBzeXN0ZW1KU1Byb3RvdHlwZSxcclxuICAgIHN5c3RlbUpzQ29tbW9uLFxyXG4gICAgc2V0UmVzb2x1dGlvbkRldGFpbE1hcCxcclxuICAgIGNyZWF0ZURldGFpbFJlc29sdmVyLFxyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG59IGZyb20gJy4uLy4uL3N0YXRpYy9leGVjdXRvci9zeXN0ZW1qcy1icmlkZ2Uvb3V0JztcclxuaW1wb3J0IE5vZGVVcmwgZnJvbSAndXJsJztcclxuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xyXG5pbXBvcnQgdHlwZSB7IFJlc29sdXRpb25EZXRhaWxNYXAgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi9yZXNvbHV0aW9uLWRldGFpbC1tYXAnO1xyXG5cclxudHlwZSBTeXN0ZW1Kc1JlZ2lzdHJ5ID0gUmVjb3JkPHN0cmluZywgTW9kdWxlUmVnaXN0ZXI+O1xyXG5cclxudHlwZSBJbnN0YW50aWF0aW9uSGFuZGxlciA9ICh1cmw6IHN0cmluZykgPT4gTW9kdWxlUmVnaXN0ZXIgfCB1bmRlZmluZWQgfCBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyIHwgdW5kZWZpbmVkPjtcclxuXHJcbmV4cG9ydCBjbGFzcyBFeGVjdXRvclN5c3RlbSB7XHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IHByb3RvY29sSGVhZE1vZHNNZ3IgPSAnbW9kcy1tZ3I6JztcclxuXHJcbiAgICBwcml2YXRlIF9yZWdpc3RyeTogU3lzdGVtSnNSZWdpc3RyeSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XHJcbiAgICBwcml2YXRlIF92ZW5kb3JSZWdpc3RlckZuOiBGdW5jdGlvbjtcclxuICAgIHByaXZhdGUgX2xhc3RSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIgfCBudWxsID0gbnVsbDtcclxuICAgIHByaXZhdGUgX2Jhc2VVcmwgPSAncHJvamVjdDovLy8nO1xyXG4gICAgcHJpdmF0ZSBfaW5zdGFudGlhdGlvbkhhbmRsZXJzOiBJbnN0YW50aWF0aW9uSGFuZGxlcltdID0gW107XHJcbiAgICBwcml2YXRlIF9kZXRhaWxSZXNvbHZlOiAoc3BlY2lmaWVyOiBzdHJpbmcsIGltcG9ydGVyPzogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIGNvbnN0IG1lID0gdGhpcztcclxuICAgICAgICBpZiAoIXN5c3RlbUpTUHJvdG90eXBlLnByZXBhcmVJbXBvcnQpIHtcclxuICAgICAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUucHJlcGFyZUltcG9ydCA9ICgpID0+IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IGFueSkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVzb2x2ZSh0aGlzLCAuLi5hcmdzKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLmluc3RhbnRpYXRlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IGFueSkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBtZS5faW5zdGFudGlhdGUodGhpcywgLi4uYXJncyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLl92ZW5kb3JSZWdpc3RlckZuID0gc3lzdGVtSlNQcm90b3R5cGUucmVnaXN0ZXI7XHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAoLi4uYXJnczogYW55KSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIHJldHVybiBtZS5zZXRSZWdpc3RlciguLi5hcmdzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVnaXN0ZXIodGhpcywgLi4uYXJncyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLl9kZXRhaWxSZXNvbHZlID0gY3JlYXRlRGV0YWlsUmVzb2x2ZXIoXHJcbiAgICAgICAgICAgIHVuZGVmaW5lZCwgLy8gbG9nZ2VyLFxyXG4gICAgICAgICAgICB1bmRlZmluZWQsIC8vIHJlamVjdG9yXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy8gVE9ETzogbWVyZ2Ugc3lzdGVtanMgaW1wbGVtZW50YXRpb25cclxuICAgICAgICBjb25zdCB1cHZhbHVlTWFwOiBhbnkgPSB7fTtcclxuICAgICAgICBjb25zdCB2ZW5kb3JDcmVhdGVDb250ZXh0ID0gc3lzdGVtSlNQcm90b3R5cGUuY3JlYXRlQ29udGV4dDtcclxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5jcmVhdGVDb250ZXh0ID0gZnVuY3Rpb24gKGlkOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lMmNsYXNzOiBhbnkgPSB7fTtcclxuICAgICAgICAgICAgY29uc3QgY29udGV4dCA9IHZlbmRvckNyZWF0ZUNvbnRleHQuY2FsbCh0aGlzLCBpZCk7XHJcbiAgICAgICAgICAgIHVwdmFsdWVNYXBbY29udGV4dC51cmxdID0gbmFtZTJjbGFzcztcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLmNvbnRleHQsXHJcbiAgICAgICAgICAgICAgICB1cHZhbHVlIChuYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldDogYW55KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUyY2xhc3NbbmFtZV0gPSB0YXJnZXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGltcG9ydE1hcCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW1wb3J0TWFwO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGltcG9ydCh1cmw6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCBTeXN0ZW0uaW1wb3J0KHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcm92aWRlcyB0aGUgbGFzdCBhbm9ueW1vdXMgYFN5c3RlbS5yZWdpc3RlcmAgY2FsbC5cclxuICAgICAqL1xyXG4gICAgZ2V0UmVnaXN0ZXIoKSB7XHJcbiAgICAgICAgY29uc3QgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xyXG4gICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckltcG9ydE1hcCgpIHtcclxuICAgICAgICB0aGlzLl9pbXBvcnRNYXAuaW1wb3J0cyA9IHt9O1xyXG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcC5zY29wZXMgPSB7fTtcclxuICAgIH1cclxuXHJcbiAgICBleHRlbmRJbXBvcnRNYXAoaW1wb3J0TWFwOiBJbXBvcnRNYXAsIGJhc2VVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKGltcG9ydE1hcCwgYmFzZVVybCwgdGhpcy5faW1wb3J0TWFwKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRSZWdpc3RlcihpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XHJcbiAgICAgICAgdGhpcy5fcmVnaXN0cnlbaWRdID0gW2RlcGVuZGVuY2llcywgZGVjbGFyZV07XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlUmVnaXN0ZXIoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLl9yZWdpc3RyeVtpZF07XHJcbiAgICB9XHJcblxyXG4gICAgZW5jb2RlTW9kc01nclJlcXVlc3QoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHVybCA9IGAke0V4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3J9JHtlbmNvZGVVUklDb21wb25lbnQoaWQpfWA7XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH1cclxuXHJcbiAgICBhZGRJbnN0YW50aWF0aW9uSGFuZGxlcihoYW5kbGVyOiBJbnN0YW50aWF0aW9uSGFuZGxlcikge1xyXG4gICAgICAgIHRoaXMuX2luc3RhbnRpYXRpb25IYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFJlc29sdXRpb25EZXRhaWxNYXAocmVzb2x1dGlvbkRldGFpbE1hcDogUmVzb2x1dGlvbkRldGFpbE1hcCwgdXJsOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKGBTZXQgZGV0YWlsIG1hcCAke3VybH06ICR7SlNPTi5zdHJpbmdpZnkocmVzb2x1dGlvbkRldGFpbE1hcCwgdW5kZWZpbmVkLCAyKX1gKTtcclxuICAgICAgICBzZXRSZXNvbHV0aW9uRGV0YWlsTWFwKHJlc29sdXRpb25EZXRhaWxNYXAsIHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfaW1wb3J0TWFwOiBJbXBvcnRNYXAgJiB7XHJcbiAgICAgICAgaW1wb3J0czogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydpbXBvcnRzJ10+O1xyXG4gICAgICAgIHNjb3BlczogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydzY29wZXMnXT47XHJcbiAgICB9ID0ge1xyXG4gICAgICAgIGltcG9ydHM6IHt9LFxyXG4gICAgICAgIHNjb3Blczoge30sXHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgX3Jlc29sdmUoXHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxyXG4gICAgICAgIGlkOiBzdHJpbmcsXHJcbiAgICAgICAgcGFyZW50VVJMPzogc3RyaW5nLFxyXG4gICAgKTogc3RyaW5nIHtcclxuICAgICAgICBwYXJlbnRVUkwgPSBwYXJlbnRVUkwgPz8gdGhpcy5fYmFzZVVybDtcclxuXHJcbiAgICAgICAgdGhpcy5fZGV0YWlsUmVzb2x2ZShpZCwgcGFyZW50VVJMKTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc3lzdGVtSnNDb21tb24ucmVzb2x2ZUltcG9ydE1hcChcclxuICAgICAgICAgICAgdGhpcy5faW1wb3J0TWFwLFxyXG4gICAgICAgICAgICBzeXN0ZW1Kc0NvbW1vbi5yZXNvbHZlSWZOb3RQbGFpbk9yVXJsKGlkLCBwYXJlbnRVUkwpIHx8IGlkLFxyXG4gICAgICAgICAgICBwYXJlbnRVUkwsXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGlkIGluIHRoaXMuX3JlZ2lzdHJ5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl90aHJvd1VucmVzb2x2ZWQoaWQsIHBhcmVudFVSTCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfaW5zdGFudGlhdGUoXHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxyXG4gICAgICAgIHVybDogc3RyaW5nLFxyXG4gICAgICAgIGZpcnN0UGFyZW50VXJsOiBzdHJpbmcsXHJcbiAgICApOiBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyPiB7XHJcbiAgICAgICAgaWYgKHVybCBpbiB0aGlzLl9yZWdpc3RyeSkge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzLl9yZWdpc3RyeVt1cmxdID0gbnVsbDtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lzdHJ5W3VybF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5faW5zdGFudGlhdGlvbkhhbmRsZXJzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gYXdhaXQgaGFuZGxlcih1cmwpO1xyXG4gICAgICAgICAgICBpZiAocmVnaXN0ZXIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6JykpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHBhdGggPSBOb2RlVXJsLmZpbGVVUkxUb1BhdGgodXJsKTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7IH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChFeGVjdXRvclN5c3RlbS5wcm90b2NvbEhlYWRNb2RzTWdyKSkge1xyXG4gICAgICAgICAgICBjb25zdCB1cmxPYmplY3QgPSBuZXcgVVJMKHVybCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhuYW1lID0gdXJsT2JqZWN0LnBhdGhuYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXRobmFtZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBbW10sIChleHBvcnRCaW5kaW5ncyk6IERlY2xhcmVSZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHNNZ3IgPSByZXF1aXJlKCdjYy9tb2RzLW1ncicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtb2QgPSBtb2RzTWdyLnN5bmNJbXBvcnQoaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRCaW5kaW5ncyhtb2QpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgICAgIHJlcXVpcmUocGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gdGhpcy5nZXRSZWdpc3RlcigpO1xyXG4gICAgICAgICAgICBpZiAoIXJlZ2lzdGVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJywgeyB1cmwgfSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl90aHJvd0luc3RhbnRpYXRpb25FcnJvcih1cmwsIGZpcnN0UGFyZW50VXJsKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWkhOeQhiBgU3lzdGVtLnJlZ2lzdGVyKClgIOiwg+eUqOOAglxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZWdpc3RlcihzeXN0ZW1KU1Byb3RvdHlwZTogU3lzdGVtSnNQcm90b3R5cGUsIGRlcHM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XHJcbiAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gW2RlcHMsIGRlY2xhcmVdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3Rocm93VW5yZXNvbHZlZChpZDogc3RyaW5nLCBwYXJlbnRVcmw/OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19yZXNvbHZlJyxcclxuICAgICAgICAgICAgeyBzcGVjaWZpZXI6IGlkLCBwYXJlbnRVUkw6IHBhcmVudFVybCA/PyBpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9zeXN0ZW1fanNfb3JpZ2luJykgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3Rocm93SW5zdGFudGlhdGlvbkVycm9yKHVybDogc3RyaW5nLCBmaXJzdFBhcmVudFVybDogc3RyaW5nKTogTW9kdWxlUmVnaXN0ZXIge1xyXG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19pbnN0YW50aWF0ZScsXHJcbiAgICAgICAgICAgIHsgdXJsLCBmaXJzdFBhcmVudFVSTDogZmlyc3RQYXJlbnRVcmwgPz8gaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX29yaWdpbicpIH0pKTtcclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIEltcG9ydE1hcCB7XHJcbiAgICBpbXBvcnRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxuICAgIHNjb3Blcz86IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+O1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZ2xvYmFsRWRpdG9yU3lzdGVtID0gbmV3IEV4ZWN1dG9yU3lzdGVtKCk7XHJcblxyXG4iXX0=