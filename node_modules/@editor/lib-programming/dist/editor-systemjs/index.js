"use strict";
/// <reference path="../../@types/systemjs/systemjs.d.ts"/>
/// <reference path="../../@types/systemjs/extras/named-register.d.ts"/>
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalEditorSystem = exports.ExecutorSystem = void 0;
const out_1 = require("../../static/executor/systemjs-bridge/out");
const url_1 = __importDefault(require("url"));
const i18n_1 = require("../utils/i18n");
class ExecutorSystem {
    constructor() {
        this._registry = Object.create(null);
        this._lastRegister = null;
        this._baseUrl = 'project:///';
        this._instantiationHandlers = [];
        this._importMap = {
            imports: {},
            scopes: {},
        };
        const me = this;
        out_1.systemJSPrototype.prepareImport = () => { };
        out_1.systemJSPrototype.resolve = function (...args) {
            // @ts-ignore
            return me._resolve(this, ...args);
        };
        out_1.systemJSPrototype.instantiate = function (...args) {
            // @ts-ignore
            return me._instantiate(this, ...args);
        };
        this._vendorRegisterFn = out_1.systemJSPrototype.register;
        out_1.systemJSPrototype.register = function (...args) {
            if (typeof args[0] === 'string') {
                // @ts-ignore
                return me.setRegister(...args);
            }
            // @ts-ignore
            return me._register(this, ...args);
        };
    }
    get importMap() {
        return this._importMap;
    }
    /**
     * Provides the last anonymous `System.register` call.
     */
    getRegister() {
        const lastRegister = this._lastRegister;
        this._lastRegister = null;
        return lastRegister;
    }
    clearImportMap() {
        this._importMap.imports = {};
        this._importMap.scopes = {};
    }
    extendImportMap(importMap, baseUrl) {
        out_1.systemJsCommon.resolveAndComposeImportMap(importMap, baseUrl, this._importMap);
    }
    setRegister(id, dependencies, declare) {
        this._registry[id] = [dependencies, declare];
    }
    deleteRegister(id) {
        delete this._registry[id];
    }
    encodeModsMgrRequest(id) {
        const url = `${ExecutorSystem.protocolHeadModsMgr}${encodeURIComponent(id)}`;
        return url;
    }
    addInstantiationHandler(handler) {
        this._instantiationHandlers.push(handler);
    }
    _resolve(systemJSPrototype, id, parentURL) {
        parentURL = parentURL !== null && parentURL !== void 0 ? parentURL : this._baseUrl;
        let result = out_1.systemJsCommon.resolveImportMap(this._importMap, out_1.systemJsCommon.resolveIfNotPlainOrUrl(id, parentURL) || id, parentURL);
        if (result) {
            return result;
        }
        if (id in this._registry) {
            return id;
        }
        return this._throwUnresolved(id, parentURL);
    }
    async _instantiate(systemJSPrototype, url, firstParentUrl) {
        if (url in this._registry) {
            // TODO: this._registry[url] = null;
            return this._registry[url];
        }
        for (const handler of this._instantiationHandlers) {
            const register = await handler(url);
            if (register) {
                return register;
            }
        }
        let path;
        if (url.startsWith('file:')) {
            try {
                path = url_1.default.fileURLToPath(url);
            }
            catch (_a) { }
        }
        if (url.startsWith(ExecutorSystem.protocolHeadModsMgr)) {
            const urlObject = new URL(url);
            const pathname = urlObject.pathname;
            const id = decodeURIComponent(pathname);
            return [[], (exportBindings) => {
                    return {
                        execute: () => {
                            const modsMgr = require('cc/mods-mgr');
                            const mod = modsMgr.syncImport(id);
                            exportBindings(mod);
                        },
                    };
                }];
        }
        if (path) {
            require(path);
            const register = this.getRegister();
            if (!register) {
                throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url }));
            }
            return register;
        }
        return this._throwInstantiationError(url, firstParentUrl);
    }
    /**
     * 处理 `System.register()` 调用。
     */
    _register(systemJSPrototype, deps, declare) {
        this._lastRegister = [deps, declare];
    }
    _throwUnresolved(id, parentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_resolve', { specifier: id, parentURL: parentUrl !== null && parentUrl !== void 0 ? parentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
    _throwInstantiationError(url, firstParentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_instantiate', { url, firstParentURL: firstParentUrl !== null && firstParentUrl !== void 0 ? firstParentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
}
exports.ExecutorSystem = ExecutorSystem;
ExecutorSystem.protocolHeadModsMgr = 'mods-mgr:';
exports.globalEditorSystem = new ExecutorSystem();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLXN5c3RlbWpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyREFBMkQ7QUFDM0Qsd0VBQXdFOzs7Ozs7QUFFeEUsbUVBSW1EO0FBQ25ELDhDQUEwQjtBQUMxQix3Q0FBOEM7QUFNOUMsTUFBYSxjQUFjO0lBU3ZCO1FBTlEsY0FBUyxHQUFxQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELGtCQUFhLEdBQTBCLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQUcsYUFBYSxDQUFDO1FBQ3pCLDJCQUFzQixHQUEyQixFQUFFLENBQUM7UUErRHBELGVBQVUsR0FHZDtZQUNBLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBbEVFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQix1QkFBaUIsQ0FBQyxhQUFhLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDO1FBQzNDLHVCQUFpQixDQUFDLE9BQU8sR0FBRyxVQUFTLEdBQUcsSUFBUztZQUM3QyxhQUFhO1lBQ2IsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQztRQUNGLHVCQUFpQixDQUFDLFdBQVcsR0FBRyxVQUFTLEdBQUcsSUFBUztZQUNqRCxhQUFhO1lBQ2IsT0FBTyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxpQkFBaUIsR0FBRyx1QkFBaUIsQ0FBQyxRQUFRLENBQUM7UUFDcEQsdUJBQWlCLENBQUMsUUFBUSxHQUFHLFVBQVMsR0FBRyxJQUFTO1lBQzlDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFO2dC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YyxFQUFFLE9BQWdCO1FBQ3BGLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEVBQVUsRUFBRSxTQUFrQjtRQUNuRCxNQUFNLEtBQUssQ0FBQyxvQkFBYSxDQUFDLDRCQUE0QixFQUNsRCxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFNBQVMsYUFBVCxTQUFTLGNBQVQsU0FBUyxHQUFJLG9CQUFhLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0lBRU8sd0JBQXdCLENBQUMsR0FBVyxFQUFFLGNBQXNCO1FBQ2hFLE1BQU0sS0FBSyxDQUFDLG9CQUFhLENBQUMsZ0NBQWdDLEVBQ3RELEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxjQUFjLGFBQWQsY0FBYyxjQUFkLGNBQWMsR0FBSSxvQkFBYSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQzs7QUF4S0wsd0NBeUtDO0FBeEswQixrQ0FBbUIsR0FBRyxXQUFXLENBQUM7QUErS2hELFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvc3lzdGVtanMuZC50c1wiLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvZXh0cmFzL25hbWVkLXJlZ2lzdGVyLmQudHNcIi8+XG5cbmltcG9ydCB7XG4gICAgc3lzdGVtSlNQcm90b3R5cGUsXG4gICAgc3lzdGVtSnNDb21tb24sXG4gICAgLy8gQHRzLWlnbm9yZVxufSBmcm9tICcuLi8uLi9zdGF0aWMvZXhlY3V0b3Ivc3lzdGVtanMtYnJpZGdlL291dCc7XG5pbXBvcnQgTm9kZVVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xuXG50eXBlIFN5c3RlbUpzUmVnaXN0cnkgPSBSZWNvcmQ8c3RyaW5nLCBNb2R1bGVSZWdpc3Rlcj47XG5cbnR5cGUgSW5zdGFudGlhdGlvbkhhbmRsZXIgPSAodXJsOiBzdHJpbmcpID0+IE1vZHVsZVJlZ2lzdGVyIHwgdW5kZWZpbmVkIHwgUHJvbWlzZTxNb2R1bGVSZWdpc3RlciB8IHVuZGVmaW5lZD47XG5cbmV4cG9ydCBjbGFzcyBFeGVjdXRvclN5c3RlbSB7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBwcm90b2NvbEhlYWRNb2RzTWdyID0gJ21vZHMtbWdyOic7XG5cbiAgICBwcml2YXRlIF9yZWdpc3RyeTogU3lzdGVtSnNSZWdpc3RyeSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgcHJpdmF0ZSBfdmVuZG9yUmVnaXN0ZXJGbjogRnVuY3Rpb247XG4gICAgcHJpdmF0ZSBfbGFzdFJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlciB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgX2Jhc2VVcmwgPSAncHJvamVjdDovLy8nO1xuICAgIHByaXZhdGUgX2luc3RhbnRpYXRpb25IYW5kbGVyczogSW5zdGFudGlhdGlvbkhhbmRsZXJbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUucHJlcGFyZUltcG9ydCA9ICgpID0+IHt9O1xuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICByZXR1cm4gbWUuX3Jlc29sdmUodGhpcywgLi4uYXJncyk7XG4gICAgICAgIH07XG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLmluc3RhbnRpYXRlID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICByZXR1cm4gbWUuX2luc3RhbnRpYXRlKHRoaXMsIC4uLmFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLl92ZW5kb3JSZWdpc3RlckZuID0gc3lzdGVtSlNQcm90b3R5cGUucmVnaXN0ZXI7XG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIHJldHVybiBtZS5zZXRSZWdpc3RlciguLi5hcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVnaXN0ZXIodGhpcywgLi4uYXJncyk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0IGltcG9ydE1hcCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ltcG9ydE1hcDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQcm92aWRlcyB0aGUgbGFzdCBhbm9ueW1vdXMgYFN5c3RlbS5yZWdpc3RlcmAgY2FsbC5cbiAgICAgKi9cbiAgICBnZXRSZWdpc3RlcigpIHtcbiAgICAgICAgY29uc3QgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xuICAgICAgICB0aGlzLl9sYXN0UmVnaXN0ZXIgPSBudWxsO1xuICAgICAgICByZXR1cm4gbGFzdFJlZ2lzdGVyO1xuICAgIH1cblxuICAgIGNsZWFySW1wb3J0TWFwKCkge1xuICAgICAgICB0aGlzLl9pbXBvcnRNYXAuaW1wb3J0cyA9IHt9O1xuICAgICAgICB0aGlzLl9pbXBvcnRNYXAuc2NvcGVzID0ge307XG4gICAgfVxuXG4gICAgZXh0ZW5kSW1wb3J0TWFwKGltcG9ydE1hcDogSW1wb3J0TWFwLCBiYXNlVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgc3lzdGVtSnNDb21tb24ucmVzb2x2ZUFuZENvbXBvc2VJbXBvcnRNYXAoaW1wb3J0TWFwLCBiYXNlVXJsLCB0aGlzLl9pbXBvcnRNYXApO1xuICAgIH1cblxuICAgIHNldFJlZ2lzdGVyKGlkOiBzdHJpbmcsIGRlcGVuZGVuY2llczogc3RyaW5nW10sIGRlY2xhcmU6IERlY2xhcmUpIHtcbiAgICAgICAgdGhpcy5fcmVnaXN0cnlbaWRdID0gW2RlcGVuZGVuY2llcywgZGVjbGFyZV07XG4gICAgfVxuXG4gICAgZGVsZXRlUmVnaXN0ZXIoaWQ6IHN0cmluZykge1xuICAgICAgICBkZWxldGUgdGhpcy5fcmVnaXN0cnlbaWRdO1xuICAgIH1cblxuICAgIGVuY29kZU1vZHNNZ3JSZXF1ZXN0KGlkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7RXhlY3V0b3JTeXN0ZW0ucHJvdG9jb2xIZWFkTW9kc01ncn0ke2VuY29kZVVSSUNvbXBvbmVudChpZCl9YDtcbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICB9XG5cbiAgICBhZGRJbnN0YW50aWF0aW9uSGFuZGxlcihoYW5kbGVyOiBJbnN0YW50aWF0aW9uSGFuZGxlcikge1xuICAgICAgICB0aGlzLl9pbnN0YW50aWF0aW9uSGFuZGxlcnMucHVzaChoYW5kbGVyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbXBvcnRNYXA6IEltcG9ydE1hcCAmIHtcbiAgICAgICAgaW1wb3J0czogTm9uTnVsbGFibGU8SW1wb3J0TWFwWydpbXBvcnRzJ10+O1xuICAgICAgICBzY29wZXM6IE5vbk51bGxhYmxlPEltcG9ydE1hcFsnc2NvcGVzJ10+O1xuICAgIH0gPSB7XG4gICAgICAgIGltcG9ydHM6IHt9LFxuICAgICAgICBzY29wZXM6IHt9LFxuICAgIH07XG5cbiAgICBwcml2YXRlIF9yZXNvbHZlKFxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZTogU3lzdGVtSnNQcm90b3R5cGUsXG4gICAgICAgIGlkOiBzdHJpbmcsXG4gICAgICAgIHBhcmVudFVSTD86IHN0cmluZyxcbiAgICApOiBzdHJpbmcge1xuICAgICAgICBwYXJlbnRVUkwgPSBwYXJlbnRVUkwgPz8gdGhpcy5fYmFzZVVybDtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gc3lzdGVtSnNDb21tb24ucmVzb2x2ZUltcG9ydE1hcChcbiAgICAgICAgICAgIHRoaXMuX2ltcG9ydE1hcCxcbiAgICAgICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVJZk5vdFBsYWluT3JVcmwoaWQsIHBhcmVudFVSTCkgfHwgaWQsXG4gICAgICAgICAgICBwYXJlbnRVUkwsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpZCBpbiB0aGlzLl9yZWdpc3RyeSkge1xuICAgICAgICAgICAgcmV0dXJuIGlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93VW5yZXNvbHZlZChpZCwgcGFyZW50VVJMKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbnN0YW50aWF0ZShcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGU6IFN5c3RlbUpzUHJvdG90eXBlLFxuICAgICAgICB1cmw6IHN0cmluZyxcbiAgICAgICAgZmlyc3RQYXJlbnRVcmw6IHN0cmluZyxcbiAgICApOiBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyPiB7XG4gICAgICAgIGlmICh1cmwgaW4gdGhpcy5fcmVnaXN0cnkpIHtcbiAgICAgICAgICAgIC8vIFRPRE86IHRoaXMuX3JlZ2lzdHJ5W3VybF0gPSBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lzdHJ5W3VybF07XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5faW5zdGFudGlhdGlvbkhhbmRsZXJzKSB7XG4gICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IGF3YWl0IGhhbmRsZXIodXJsKTtcbiAgICAgICAgICAgIGlmIChyZWdpc3Rlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBwYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgnZmlsZTonKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBwYXRoID0gTm9kZVVybC5maWxlVVJMVG9QYXRoKHVybCk7XG4gICAgICAgICAgICB9IGNhdGNoIHsgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKEV4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3IpKSB7XG4gICAgICAgICAgICBjb25zdCB1cmxPYmplY3QgPSBuZXcgVVJMKHVybCk7XG4gICAgICAgICAgICBjb25zdCBwYXRobmFtZSA9IHVybE9iamVjdC5wYXRobmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhdGhuYW1lKTtcbiAgICAgICAgICAgIHJldHVybiBbW10sIChleHBvcnRCaW5kaW5ncyk6IERlY2xhcmVSZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHNNZ3IgPSByZXF1aXJlKCdjYy9tb2RzLW1ncicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbW9kID0gbW9kc01nci5zeW5jSW1wb3J0KGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydEJpbmRpbmdzKG1vZCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1dO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgICAgIHJlcXVpcmUocGF0aCk7XG4gICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IHRoaXMuZ2V0UmVnaXN0ZXIoKTtcbiAgICAgICAgICAgIGlmICghcmVnaXN0ZXIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJywgeyB1cmwgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93SW5zdGFudGlhdGlvbkVycm9yKHVybCwgZmlyc3RQYXJlbnRVcmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWkhOeQhiBgU3lzdGVtLnJlZ2lzdGVyKClgIOiwg+eUqOOAglxuICAgICAqL1xuICAgIHByaXZhdGUgX3JlZ2lzdGVyKHN5c3RlbUpTUHJvdG90eXBlOiBTeXN0ZW1Kc1Byb3RvdHlwZSwgZGVwczogc3RyaW5nW10sIGRlY2xhcmU6IERlY2xhcmUpIHtcbiAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gW2RlcHMsIGRlY2xhcmVdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Rocm93VW5yZXNvbHZlZChpZDogc3RyaW5nLCBwYXJlbnRVcmw/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICB0aHJvdyBFcnJvcihpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9mYWlsZWRfdG9fcmVzb2x2ZScsXG4gICAgICAgICAgICB7IHNwZWNpZmllcjogaWQsIHBhcmVudFVSTDogcGFyZW50VXJsID8/IGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX3N5c3RlbV9qc19vcmlnaW4nKSB9KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdGhyb3dJbnN0YW50aWF0aW9uRXJyb3IodXJsOiBzdHJpbmcsIGZpcnN0UGFyZW50VXJsOiBzdHJpbmcpOiBNb2R1bGVSZWdpc3RlciB7XG4gICAgICAgIHRocm93IEVycm9yKGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX2ZhaWxlZF90b19pbnN0YW50aWF0ZScsXG4gICAgICAgICAgICB7IHVybCwgZmlyc3RQYXJlbnRVUkw6IGZpcnN0UGFyZW50VXJsID8/IGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX3N5c3RlbV9qc19vcmlnaW4nKSB9KSk7XG4gICAgfVxufVxuXG5pbnRlcmZhY2UgSW1wb3J0TWFwIHtcbiAgICBpbXBvcnRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICBzY29wZXM/OiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+Pjtcbn1cblxuZXhwb3J0IGNvbnN0IGdsb2JhbEVkaXRvclN5c3RlbSA9IG5ldyBFeGVjdXRvclN5c3RlbSgpO1xuXG4iXX0=