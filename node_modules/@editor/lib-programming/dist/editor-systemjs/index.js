"use strict";
/// <reference path="../../@types/systemjs/systemjs.d.ts"/>
/// <reference path="../../@types/systemjs/extras/named-register.d.ts"/>
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalEditorSystem = exports.ExecutorSystem = void 0;
const out_1 = require("../../static/executor/systemjs-bridge/out");
const url_1 = __importDefault(require("url"));
const i18n_1 = require("../utils/i18n");
class ExecutorSystem {
    constructor() {
        this._registry = Object.create(null);
        this._lastRegister = null;
        this._baseUrl = 'project:///';
        this._instantiationHandlers = [];
        this._importMap = {
            imports: {},
            scopes: {},
        };
        const me = this;
        out_1.systemJSPrototype.prepareImport = () => { };
        out_1.systemJSPrototype.resolve = function (...args) {
            // @ts-ignore
            return me._resolve(this, ...args);
        };
        out_1.systemJSPrototype.instantiate = function (...args) {
            // @ts-ignore
            return me._instantiate(this, ...args);
        };
        this._vendorRegisterFn = out_1.systemJSPrototype.register;
        out_1.systemJSPrototype.register = function (...args) {
            if (typeof args[0] === 'string') {
                // @ts-ignore
                return me.setRegister(...args);
            }
            // @ts-ignore
            return me._register(this, ...args);
        };
    }
    get importMap() {
        return this._importMap;
    }
    /**
     * Provides the last anonymous `System.register` call.
     */
    getRegister() {
        const lastRegister = this._lastRegister;
        this._lastRegister = null;
        return lastRegister;
    }
    clearImportMap() {
        this._importMap.imports = {};
        this._importMap.scopes = {};
    }
    extendImportMap(importMap, baseUrl) {
        out_1.systemJsCommon.resolveAndComposeImportMap(importMap, baseUrl, this._importMap);
    }
    setRegister(id, dependencies, declare) {
        this._registry[id] = [dependencies, declare];
    }
    deleteRegister(id) {
        delete this._registry[id];
    }
    encodeModsMgrRequest(id) {
        const url = `${ExecutorSystem.protocolHeadModsMgr}${encodeURIComponent(id)}`;
        return url;
    }
    addInstantiationHandler(handler) {
        this._instantiationHandlers.push(handler);
    }
    _resolve(systemJSPrototype, id, parentURL) {
        parentURL = parentURL !== null && parentURL !== void 0 ? parentURL : this._baseUrl;
        let result = out_1.systemJsCommon.resolveImportMap(this._importMap, out_1.systemJsCommon.resolveIfNotPlainOrUrl(id, parentURL) || id, parentURL);
        if (result) {
            return result;
        }
        if (id in this._registry) {
            return id;
        }
        return this._throwUnresolved(id, parentURL);
    }
    async _instantiate(systemJSPrototype, url, firstParentUrl) {
        if (url in this._registry) {
            // TODO: this._registry[url] = null;
            return this._registry[url];
        }
        for (const handler of this._instantiationHandlers) {
            const register = await handler(url);
            if (register) {
                return register;
            }
        }
        let path;
        if (url.startsWith('file:')) {
            try {
                path = url_1.default.fileURLToPath(url);
            }
            catch (_a) { }
        }
        if (url.startsWith(ExecutorSystem.protocolHeadModsMgr)) {
            const urlObject = new URL(url);
            const pathname = urlObject.pathname;
            const id = decodeURIComponent(pathname);
            return [[], (exportBindings) => {
                    return {
                        execute: () => {
                            const modsMgr = require('cc/mods-mgr');
                            const mod = modsMgr.syncImport(id);
                            exportBindings(mod);
                        },
                    };
                }];
        }
        if (path) {
            require(path);
            const register = this.getRegister();
            if (!register) {
                throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url }));
            }
            return register;
        }
        return this._throwInstantiationError(url, firstParentUrl);
    }
    /**
     * 处理 `System.register()` 调用。
     */
    _register(systemJSPrototype, deps, declare) {
        this._lastRegister = [deps, declare];
    }
    _throwUnresolved(id, parentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_resolve', { specifier: id, parentURL: parentUrl !== null && parentUrl !== void 0 ? parentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
    _throwInstantiationError(url, firstParentUrl) {
        throw Error(i18n_1.i18nTranslate('executor_failed_to_instantiate', { url, firstParentURL: firstParentUrl !== null && firstParentUrl !== void 0 ? firstParentUrl : i18n_1.i18nTranslate('executor_system_js_origin') }));
    }
}
exports.ExecutorSystem = ExecutorSystem;
ExecutorSystem.protocolHeadModsMgr = 'mods-mgr:';
exports.globalEditorSystem = new ExecutorSystem();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLXN5c3RlbWpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwyREFBMkQ7QUFDM0Qsd0VBQXdFOzs7Ozs7QUFFeEUsbUVBSW1EO0FBQ25ELDhDQUEwQjtBQUMxQix3Q0FBOEM7QUFNOUMsTUFBYSxjQUFjO0lBU3ZCO1FBTlEsY0FBUyxHQUFxQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELGtCQUFhLEdBQTBCLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQUcsYUFBYSxDQUFDO1FBQ3pCLDJCQUFzQixHQUEyQixFQUFFLENBQUM7UUErRHBELGVBQVUsR0FHZDtZQUNBLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBbEVFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQix1QkFBaUIsQ0FBQyxhQUFhLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDO1FBQzNDLHVCQUFpQixDQUFDLE9BQU8sR0FBRyxVQUFTLEdBQUcsSUFBUztZQUM3QyxhQUFhO1lBQ2IsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQztRQUNGLHVCQUFpQixDQUFDLFdBQVcsR0FBRyxVQUFTLEdBQUcsSUFBUztZQUNqRCxhQUFhO1lBQ2IsT0FBTyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxpQkFBaUIsR0FBRyx1QkFBaUIsQ0FBQyxRQUFRLENBQUM7UUFDcEQsdUJBQWlCLENBQUMsUUFBUSxHQUFHLFVBQVMsR0FBRyxJQUFTO1lBQzlDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFO2dC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YyxFQUFFLE9BQWdCO1FBQ3BGLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEVBQVUsRUFBRSxTQUFrQjtRQUNuRCxNQUFNLEtBQUssQ0FBQyxvQkFBYSxDQUFDLDRCQUE0QixFQUNsRCxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFNBQVMsYUFBVCxTQUFTLGNBQVQsU0FBUyxHQUFJLG9CQUFhLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0lBRU8sd0JBQXdCLENBQUMsR0FBVyxFQUFFLGNBQXNCO1FBQ2hFLE1BQU0sS0FBSyxDQUFDLG9CQUFhLENBQUMsZ0NBQWdDLEVBQ3RELEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxjQUFjLGFBQWQsY0FBYyxjQUFkLGNBQWMsR0FBSSxvQkFBYSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQzs7QUF4S0wsd0NBeUtDO0FBeEswQixrQ0FBbUIsR0FBRyxXQUFXLENBQUM7QUErS2hELFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi9AdHlwZXMvc3lzdGVtanMvc3lzdGVtanMuZC50c1wiLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL0B0eXBlcy9zeXN0ZW1qcy9leHRyYXMvbmFtZWQtcmVnaXN0ZXIuZC50c1wiLz5cclxuXHJcbmltcG9ydCB7XHJcbiAgICBzeXN0ZW1KU1Byb3RvdHlwZSxcclxuICAgIHN5c3RlbUpzQ29tbW9uLFxyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG59IGZyb20gJy4uLy4uL3N0YXRpYy9leGVjdXRvci9zeXN0ZW1qcy1icmlkZ2Uvb3V0JztcclxuaW1wb3J0IE5vZGVVcmwgZnJvbSAndXJsJztcclxuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xyXG5cclxudHlwZSBTeXN0ZW1Kc1JlZ2lzdHJ5ID0gUmVjb3JkPHN0cmluZywgTW9kdWxlUmVnaXN0ZXI+O1xyXG5cclxudHlwZSBJbnN0YW50aWF0aW9uSGFuZGxlciA9ICh1cmw6IHN0cmluZykgPT4gTW9kdWxlUmVnaXN0ZXIgfCB1bmRlZmluZWQgfCBQcm9taXNlPE1vZHVsZVJlZ2lzdGVyIHwgdW5kZWZpbmVkPjtcclxuXHJcbmV4cG9ydCBjbGFzcyBFeGVjdXRvclN5c3RlbSB7XHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IHByb3RvY29sSGVhZE1vZHNNZ3IgPSAnbW9kcy1tZ3I6JztcclxuXHJcbiAgICBwcml2YXRlIF9yZWdpc3RyeTogU3lzdGVtSnNSZWdpc3RyeSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XHJcbiAgICBwcml2YXRlIF92ZW5kb3JSZWdpc3RlckZuOiBGdW5jdGlvbjtcclxuICAgIHByaXZhdGUgX2xhc3RSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIgfCBudWxsID0gbnVsbDtcclxuICAgIHByaXZhdGUgX2Jhc2VVcmwgPSAncHJvamVjdDovLy8nO1xyXG4gICAgcHJpdmF0ZSBfaW5zdGFudGlhdGlvbkhhbmRsZXJzOiBJbnN0YW50aWF0aW9uSGFuZGxlcltdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xyXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLnByZXBhcmVJbXBvcnQgPSAoKSA9PiB7fTtcclxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgcmV0dXJuIG1lLl9yZXNvbHZlKHRoaXMsIC4uLmFyZ3MpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgc3lzdGVtSlNQcm90b3R5cGUuaW5zdGFudGlhdGUgPSBmdW5jdGlvbiguLi5hcmdzOiBhbnkpIHtcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICByZXR1cm4gbWUuX2luc3RhbnRpYXRlKHRoaXMsIC4uLmFyZ3MpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5fdmVuZG9yUmVnaXN0ZXJGbiA9IHN5c3RlbUpTUHJvdG90eXBlLnJlZ2lzdGVyO1xyXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlLnJlZ2lzdGVyID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIHJldHVybiBtZS5zZXRSZWdpc3RlciguLi5hcmdzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBtZS5fcmVnaXN0ZXIodGhpcywgLi4uYXJncyk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgaW1wb3J0TWFwKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pbXBvcnRNYXA7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcm92aWRlcyB0aGUgbGFzdCBhbm9ueW1vdXMgYFN5c3RlbS5yZWdpc3RlcmAgY2FsbC5cclxuICAgICAqL1xyXG4gICAgZ2V0UmVnaXN0ZXIoKSB7XHJcbiAgICAgICAgY29uc3QgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xyXG4gICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhckltcG9ydE1hcCgpIHtcclxuICAgICAgICB0aGlzLl9pbXBvcnRNYXAuaW1wb3J0cyA9IHt9O1xyXG4gICAgICAgIHRoaXMuX2ltcG9ydE1hcC5zY29wZXMgPSB7fTtcclxuICAgIH1cclxuXHJcbiAgICBleHRlbmRJbXBvcnRNYXAoaW1wb3J0TWFwOiBJbXBvcnRNYXAsIGJhc2VVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKGltcG9ydE1hcCwgYmFzZVVybCwgdGhpcy5faW1wb3J0TWFwKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRSZWdpc3RlcihpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBkZWNsYXJlOiBEZWNsYXJlKSB7XHJcbiAgICAgICAgdGhpcy5fcmVnaXN0cnlbaWRdID0gW2RlcGVuZGVuY2llcywgZGVjbGFyZV07XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlUmVnaXN0ZXIoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLl9yZWdpc3RyeVtpZF07XHJcbiAgICB9XHJcblxyXG4gICAgZW5jb2RlTW9kc01nclJlcXVlc3QoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHVybCA9IGAke0V4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3J9JHtlbmNvZGVVUklDb21wb25lbnQoaWQpfWA7XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH1cclxuXHJcbiAgICBhZGRJbnN0YW50aWF0aW9uSGFuZGxlcihoYW5kbGVyOiBJbnN0YW50aWF0aW9uSGFuZGxlcikge1xyXG4gICAgICAgIHRoaXMuX2luc3RhbnRpYXRpb25IYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2ltcG9ydE1hcDogSW1wb3J0TWFwICYge1xyXG4gICAgICAgIGltcG9ydHM6IE5vbk51bGxhYmxlPEltcG9ydE1hcFsnaW1wb3J0cyddPjtcclxuICAgICAgICBzY29wZXM6IE5vbk51bGxhYmxlPEltcG9ydE1hcFsnc2NvcGVzJ10+O1xyXG4gICAgfSA9IHtcclxuICAgICAgICBpbXBvcnRzOiB7fSxcclxuICAgICAgICBzY29wZXM6IHt9LFxyXG4gICAgfTtcclxuXHJcbiAgICBwcml2YXRlIF9yZXNvbHZlKFxyXG4gICAgICAgIHN5c3RlbUpTUHJvdG90eXBlOiBTeXN0ZW1Kc1Byb3RvdHlwZSxcclxuICAgICAgICBpZDogc3RyaW5nLFxyXG4gICAgICAgIHBhcmVudFVSTD86IHN0cmluZyxcclxuICAgICk6IHN0cmluZyB7XHJcbiAgICAgICAgcGFyZW50VVJMID0gcGFyZW50VVJMID8/IHRoaXMuX2Jhc2VVcmw7XHJcblxyXG4gICAgICAgIGxldCByZXN1bHQgPSBzeXN0ZW1Kc0NvbW1vbi5yZXNvbHZlSW1wb3J0TWFwKFxyXG4gICAgICAgICAgICB0aGlzLl9pbXBvcnRNYXAsXHJcbiAgICAgICAgICAgIHN5c3RlbUpzQ29tbW9uLnJlc29sdmVJZk5vdFBsYWluT3JVcmwoaWQsIHBhcmVudFVSTCkgfHwgaWQsXHJcbiAgICAgICAgICAgIHBhcmVudFVSTCxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaWQgaW4gdGhpcy5fcmVnaXN0cnkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGlkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93VW5yZXNvbHZlZChpZCwgcGFyZW50VVJMKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbnN0YW50aWF0ZShcclxuICAgICAgICBzeXN0ZW1KU1Byb3RvdHlwZTogU3lzdGVtSnNQcm90b3R5cGUsXHJcbiAgICAgICAgdXJsOiBzdHJpbmcsXHJcbiAgICAgICAgZmlyc3RQYXJlbnRVcmw6IHN0cmluZyxcclxuICAgICk6IFByb21pc2U8TW9kdWxlUmVnaXN0ZXI+IHtcclxuICAgICAgICBpZiAodXJsIGluIHRoaXMuX3JlZ2lzdHJ5KSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IHRoaXMuX3JlZ2lzdHJ5W3VybF0gPSBudWxsO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVnaXN0cnlbdXJsXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgaGFuZGxlciBvZiB0aGlzLl9pbnN0YW50aWF0aW9uSGFuZGxlcnMpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCBoYW5kbGVyKHVybCk7XHJcbiAgICAgICAgICAgIGlmIChyZWdpc3Rlcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgnZmlsZTonKSkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcGF0aCA9IE5vZGVVcmwuZmlsZVVSTFRvUGF0aCh1cmwpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIHsgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKEV4ZWN1dG9yU3lzdGVtLnByb3RvY29sSGVhZE1vZHNNZ3IpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVybE9iamVjdCA9IG5ldyBVUkwodXJsKTtcclxuICAgICAgICAgICAgY29uc3QgcGF0aG5hbWUgPSB1cmxPYmplY3QucGF0aG5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhdGhuYW1lKTtcclxuICAgICAgICAgICAgcmV0dXJuIFtbXSwgKGV4cG9ydEJpbmRpbmdzKTogRGVjbGFyZVJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbW9kc01nciA9IHJlcXVpcmUoJ2NjL21vZHMtbWdyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZCA9IG1vZHNNZ3Iuc3luY0ltcG9ydChpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydEJpbmRpbmdzKG1vZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1dO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICAgICAgcmVxdWlyZShwYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSB0aGlzLmdldFJlZ2lzdGVyKCk7XHJcbiAgICAgICAgICAgIGlmICghcmVnaXN0ZXIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9zeXN0ZW1fanNfbm9fbW9kdWxlX3JlZ2lzdGVyZWQnLCB7IHVybCB9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rocm93SW5zdGFudGlhdGlvbkVycm9yKHVybCwgZmlyc3RQYXJlbnRVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5aSE55CGIGBTeXN0ZW0ucmVnaXN0ZXIoKWAg6LCD55So44CCXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3JlZ2lzdGVyKHN5c3RlbUpTUHJvdG90eXBlOiBTeXN0ZW1Kc1Byb3RvdHlwZSwgZGVwczogc3RyaW5nW10sIGRlY2xhcmU6IERlY2xhcmUpIHtcclxuICAgICAgICB0aGlzLl9sYXN0UmVnaXN0ZXIgPSBbZGVwcywgZGVjbGFyZV07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdGhyb3dVbnJlc29sdmVkKGlkOiBzdHJpbmcsIHBhcmVudFVybD86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3JfZmFpbGVkX3RvX3Jlc29sdmUnLFxyXG4gICAgICAgICAgICB7IHNwZWNpZmllcjogaWQsIHBhcmVudFVSTDogcGFyZW50VXJsID8/IGkxOG5UcmFuc2xhdGUoJ2V4ZWN1dG9yX3N5c3RlbV9qc19vcmlnaW4nKSB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdGhyb3dJbnN0YW50aWF0aW9uRXJyb3IodXJsOiBzdHJpbmcsIGZpcnN0UGFyZW50VXJsOiBzdHJpbmcpOiBNb2R1bGVSZWdpc3RlciB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoaTE4blRyYW5zbGF0ZSgnZXhlY3V0b3JfZmFpbGVkX3RvX2luc3RhbnRpYXRlJyxcclxuICAgICAgICAgICAgeyB1cmwsIGZpcnN0UGFyZW50VVJMOiBmaXJzdFBhcmVudFVybCA/PyBpMThuVHJhbnNsYXRlKCdleGVjdXRvcl9zeXN0ZW1fanNfb3JpZ2luJykgfSkpO1xyXG4gICAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgSW1wb3J0TWFwIHtcclxuICAgIGltcG9ydHM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xyXG4gICAgc2NvcGVzPzogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj47XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBnbG9iYWxFZGl0b3JTeXN0ZW0gPSBuZXcgRXhlY3V0b3JTeXN0ZW0oKTtcclxuXHJcbiJdfQ==