"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EmbeddedCommonJs = void 0;
const out_1 = require("../../static/embedded-commonjs-helpers/out");
const url_1 = __importDefault(require("url"));
class EmbeddedCommonJs {
    constructor({ importMap, importMapUrl, }) {
        this._parsedImportMap = { imports: {}, scopes: {} };
        this._moduleCache = {};
        this._namedWrappers = {};
        out_1.resolveAndComposeImportMap(importMap, importMapUrl, this._parsedImportMap);
    }
    addNamedWrappers(wrappers) {
        Object.assign(this._namedWrappers, wrappers);
    }
    syncImport(id) {
        return this._require(id);
    }
    resolve(id) {
        return this._resolve(id);
    }
    _require(specifier, parent) {
        const id = this._resolve(specifier, parent);
        const cachedModule = this._moduleCache[id];
        if (cachedModule) {
            return cachedModule.exports;
        }
        const module = { id, exports: {} };
        this._moduleCache[id] = module;
        this._tryModuleLoad(module, id);
        return module.exports;
    }
    _resolve(specifier, parent) {
        const parentUrl = parent ? parent.id : undefined;
        return out_1.resolveImportMap(this._parsedImportMap, out_1.resolveIfNotPlainOrUrl(specifier, parentUrl) || specifier, parentUrl) || this._throwUnresolved(specifier, parentUrl);
    }
    _tryModuleLoad(module, id) {
        let threw = true;
        try {
            this._load(module, id);
            threw = false;
        }
        finally {
            if (threw) {
                delete this._moduleCache[id];
            }
        }
    }
    _load(module, id) {
        const wrapper = this._loadWrapper(id);
        const require = this._createRequire(module);
        wrapper(module.exports, require, module);
    }
    _loadWrapper(id) {
        if (id in this._namedWrappers) {
            return this._namedWrappers[id];
        }
        else {
            return this._loadExternalWrapper(id);
        }
    }
    _loadExternalWrapper(id) {
        return (exports, _require, _module) => {
            let path;
            try {
                path = url_1.default.fileURLToPath(id);
            }
            catch (err) {
                throw new Error(`${id} is not a valid file URL`);
            }
            _module.exports = require(path);
        };
    }
    _createRequire(module) {
        return (specifier) => this._require(specifier, module);
    }
    _throwUnresolved(specifier, parentUrl) {
        throw new Error(`Unable to resolve ${specifier} from ${parent}.`);
    }
}
exports.EmbeddedCommonJs = EmbeddedCommonJs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZW1iZWRkZWQtY29tbW9uanMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0Esb0VBS29EO0FBQ3BELDhDQUFzQjtBQUV0QixNQUFhLGdCQUFnQjtJQUN6QixZQUFZLEVBQ1IsU0FBUyxFQUNULFlBQVksR0FJZjtRQWdCTyxxQkFBZ0IsR0FBUSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ3BELGlCQUFZLEdBQTJCLEVBQUUsQ0FBQztRQUMxQyxtQkFBYyxHQUE0QixFQUFFLENBQUM7UUFqQmpELGdDQUEwQixDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUVNLGdCQUFnQixDQUFDLFFBQWlDO1FBQ3JELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRU0sVUFBVSxDQUFDLEVBQVU7UUFDeEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxPQUFPLENBQUMsRUFBVTtRQUNyQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQU1PLFFBQVEsQ0FBQyxTQUFpQixFQUFFLE1BQWU7UUFDL0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFNUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMzQyxJQUFJLFlBQVksRUFBRTtZQUNkLE9BQU8sWUFBWSxDQUFDLE9BQU8sQ0FBQztTQUMvQjtRQUVELE1BQU0sTUFBTSxHQUFXLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUMvQixJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNoQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxTQUFpQixFQUFFLE1BQWU7UUFDL0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDakQsT0FBTyxzQkFBZ0IsQ0FDbkIsSUFBSSxDQUFDLGdCQUFnQixFQUNyQiw0QkFBc0IsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLElBQUksU0FBUyxFQUN6RCxTQUFTLENBQ1osSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFTyxjQUFjLENBQUMsTUFBYyxFQUFFLEVBQVU7UUFDN0MsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUk7WUFDQSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN2QixLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQ2pCO2dCQUFTO1lBQ04sSUFBSSxLQUFLLEVBQUU7Z0JBQ1AsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ2hDO1NBQ0o7SUFDTCxDQUFDO0lBRU8sS0FBSyxDQUFDLE1BQWMsRUFBRSxFQUFVO1FBQ3BDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVPLFlBQVksQ0FBQyxFQUFVO1FBQzNCLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ2xDO2FBQU07WUFDSCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN4QztJQUNMLENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxFQUFVO1FBQ25DLE9BQU8sQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ2xDLElBQUksSUFBWSxDQUFDO1lBQ2pCLElBQUk7Z0JBQ0EsSUFBSSxHQUFHLGFBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDaEM7WUFBQyxPQUFPLEdBQUcsRUFBRTtnQkFDVixNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRSwwQkFBMEIsQ0FBQyxDQUFDO2FBQ3BEO1lBQ0QsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVPLGNBQWMsQ0FBQyxNQUFjO1FBQ2pDLE9BQU8sQ0FBQyxTQUFpQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsU0FBaUIsRUFBRSxTQUFrQjtRQUMxRCxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixTQUFTLFNBQVMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUN0RSxDQUFDO0NBQ0o7QUEvRkQsNENBK0ZDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7XHJcbiAgICByZXNvbHZlQW5kQ29tcG9zZUltcG9ydE1hcCxcclxuICAgIHJlc29sdmVJbXBvcnRNYXAsXHJcbiAgICByZXNvbHZlSWZOb3RQbGFpbk9yVXJsLFxyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG59IGZyb20gJy4uLy4uL3N0YXRpYy9lbWJlZGRlZC1jb21tb25qcy1oZWxwZXJzL291dCc7XHJcbmltcG9ydCBVUkwgZnJvbSAndXJsJztcclxuXHJcbmV4cG9ydCBjbGFzcyBFbWJlZGRlZENvbW1vbkpzIHtcclxuICAgIGNvbnN0cnVjdG9yKHtcclxuICAgICAgICBpbXBvcnRNYXAsXHJcbiAgICAgICAgaW1wb3J0TWFwVXJsLFxyXG4gICAgfToge1xyXG4gICAgICAgIGltcG9ydE1hcDogYW55O1xyXG4gICAgICAgIGltcG9ydE1hcFVybDogc3RyaW5nO1xyXG4gICAgfSkge1xyXG4gICAgICAgIHJlc29sdmVBbmRDb21wb3NlSW1wb3J0TWFwKGltcG9ydE1hcCwgaW1wb3J0TWFwVXJsLCB0aGlzLl9wYXJzZWRJbXBvcnRNYXApO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGROYW1lZFdyYXBwZXJzKHdyYXBwZXJzOiBSZWNvcmQ8c3RyaW5nLCBXcmFwcGVyPikge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fbmFtZWRXcmFwcGVycywgd3JhcHBlcnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzeW5jSW1wb3J0KGlkOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcmVxdWlyZShpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlc29sdmUoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9yZXNvbHZlKGlkKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9wYXJzZWRJbXBvcnRNYXA6IGFueSA9IHsgaW1wb3J0czoge30sIHNjb3Blczoge30gfTtcclxuICAgIHByaXZhdGUgX21vZHVsZUNhY2hlOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGU+ID0ge307XHJcbiAgICBwcml2YXRlIF9uYW1lZFdyYXBwZXJzOiBSZWNvcmQ8c3RyaW5nLCBXcmFwcGVyPiA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgX3JlcXVpcmUoc3BlY2lmaWVyOiBzdHJpbmcsIHBhcmVudD86IE1vZHVsZSkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5fcmVzb2x2ZShzcGVjaWZpZXIsIHBhcmVudCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNhY2hlZE1vZHVsZSA9IHRoaXMuX21vZHVsZUNhY2hlW2lkXTtcclxuICAgICAgICBpZiAoY2FjaGVkTW9kdWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0cztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG1vZHVsZTogTW9kdWxlID0geyBpZCwgZXhwb3J0czoge30gfTtcclxuICAgICAgICB0aGlzLl9tb2R1bGVDYWNoZVtpZF0gPSBtb2R1bGU7XHJcbiAgICAgICAgdGhpcy5fdHJ5TW9kdWxlTG9hZChtb2R1bGUsIGlkKTtcclxuICAgICAgICByZXR1cm4gbW9kdWxlLmV4cG9ydHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfcmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgcGFyZW50PzogTW9kdWxlKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRVcmwgPSBwYXJlbnQgPyBwYXJlbnQuaWQgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmVJbXBvcnRNYXAoXHJcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlZEltcG9ydE1hcCxcclxuICAgICAgICAgICAgcmVzb2x2ZUlmTm90UGxhaW5PclVybChzcGVjaWZpZXIsIHBhcmVudFVybCkgfHwgc3BlY2lmaWVyLFxyXG4gICAgICAgICAgICBwYXJlbnRVcmwsXHJcbiAgICAgICAgKSB8fCB0aGlzLl90aHJvd1VucmVzb2x2ZWQoc3BlY2lmaWVyLCBwYXJlbnRVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3RyeU1vZHVsZUxvYWQobW9kdWxlOiBNb2R1bGUsIGlkOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgdGhyZXcgPSB0cnVlO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWQobW9kdWxlLCBpZCk7XHJcbiAgICAgICAgICAgIHRocmV3ID0gZmFsc2U7XHJcbiAgICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICAgICAgaWYgKHRocmV3KSB7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fbW9kdWxlQ2FjaGVbaWRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2xvYWQobW9kdWxlOiBNb2R1bGUsIGlkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB3cmFwcGVyID0gdGhpcy5fbG9hZFdyYXBwZXIoaWQpO1xyXG4gICAgICAgIGNvbnN0IHJlcXVpcmUgPSB0aGlzLl9jcmVhdGVSZXF1aXJlKG1vZHVsZSk7XHJcbiAgICAgICAgd3JhcHBlcihtb2R1bGUuZXhwb3J0cywgcmVxdWlyZSwgbW9kdWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9sb2FkV3JhcHBlcihpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGlkIGluIHRoaXMuX25hbWVkV3JhcHBlcnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX25hbWVkV3JhcHBlcnNbaWRdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2FkRXh0ZXJuYWxXcmFwcGVyKGlkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbG9hZEV4dGVybmFsV3JhcHBlcihpZDogc3RyaW5nKTogV3JhcHBlciB7XHJcbiAgICAgICAgcmV0dXJuIChleHBvcnRzLCBfcmVxdWlyZSwgX21vZHVsZSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcGF0aDogc3RyaW5nO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcGF0aCA9IFVSTC5maWxlVVJMVG9QYXRoKGlkKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7aWR9IGlzIG5vdCBhIHZhbGlkIGZpbGUgVVJMYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX21vZHVsZS5leHBvcnRzID0gcmVxdWlyZShwYXRoKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NyZWF0ZVJlcXVpcmUobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICByZXR1cm4gKHNwZWNpZmllcjogc3RyaW5nKSA9PiB0aGlzLl9yZXF1aXJlKHNwZWNpZmllciwgbW9kdWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90aHJvd1VucmVzb2x2ZWQoc3BlY2lmaWVyOiBzdHJpbmcsIHBhcmVudFVybD86IHN0cmluZykge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHJlc29sdmUgJHtzcGVjaWZpZXJ9IGZyb20gJHtwYXJlbnR9LmApO1xyXG4gICAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgTW9kdWxlIHtcclxuICAgIGlkOiBzdHJpbmc7XHJcbiAgICBleHBvcnRzOiBhbnk7XHJcbn1cclxuXHJcbnR5cGUgV3JhcHBlciA9IChleHBvcnRzOiB7fSwgcmVxdWlyZTogKGlkOiBzdHJpbmcpID0+IGFueSwgX21vZHVsZTogTW9kdWxlKSA9PiB2b2lkO1xyXG4iXX0=