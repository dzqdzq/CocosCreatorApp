"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("../mod-assembling/quick-pack/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineEditorExportsPrefix = `cce:/internal/x/editor-exports/`;
class Executor {
    constructor(quickPackLoaderContext) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._entries = [];
        this._instantiatedPackMods = [];
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        this._packModsImportMapURL = new url_1.URL('pack:///import-map.json');
        const packModulesDirFromImportMap = './mods/';
        this._packModsDirURL = new url_1.URL(packModulesDirFromImportMap, this._packModsImportMapURL);
        this._packModsDirPrefix = this._packModsDirURL.href;
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext, {
            importMapBasedRoot: packModulesDirFromImportMap,
        });
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem);
    }
    static async create(options) {
        const executor = new Executor(options.quickPackLoaderContext);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineEditorExportsPrefix}cc/editor/exports/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineEditorExportsPrefix)) {
                quickCompilerRequest = url.substr(engineEditorExportsPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: () => {
                                const exports = importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(this._packModsDirPrefix)) {
                const link = url.substr(this._packModsDirPrefix.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        await this._reloadPackMods();
        console.groupCollapsed(`Invalidate all modules`);
        await this._invalidateAllModules();
        console.groupEnd();
        this._invalidateAllPlugins();
        this._loadAllPlugins();
        console.groupCollapsed(`Imports all modules`);
        await this._importPrerequisiteModules();
        console.groupEnd();
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, this._packModsImportMapURL.href);
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
        const entries = this._packModInstantiation.getEntries();
        this._entries = entries.map((entry) => new url_1.URL(entry, this._packModsImportMapURL).href);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            console.warn(err);
        }
        finally {
            this._cachedExceptions.clear();
            EditorExtends.removeListener('class-registered', onClassRegistered);
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                console.error(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQTBEO0FBQzFELHdEQUF3RTtBQUN4RSw2QkFBMEI7QUFFMUIsZ0VBQXNFO0FBQ3RFLHFFQUFnRTtBQUtoRSxlQUFlO0FBQ2YsTUFBTSxjQUFjLEdBQUcsb0JBQW9CLENBQUM7QUFDNUMsbUJBQW1CO0FBQ25CLE1BQU0sd0JBQXdCLEdBQUcsd0JBQXdCLENBQUM7QUFDMUQsc0JBQXNCO0FBQ3RCLE1BQU0seUJBQXlCLEdBQUcsaUNBQWlDLENBQUM7QUFFcEUsTUFBYSxRQUFRO0lBT2pCLFlBQW9CLHNCQUFxQztRQStQakQsc0JBQWlCLEdBQXFCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEQsa0JBQWEsR0FBK0IsRUFBRSxDQUFDO1FBRS9DLGlCQUFZLEdBQTJCLEVBQUUsQ0FBQztRQUcxQyxhQUFRLEdBQXFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakUsdUJBQWtCLEdBQWUsRUFBRSxDQUFDO1FBRXBDLGFBQVEsR0FBNkMsRUFBRSxDQUFDO1FBRXhELG9CQUFlLEdBQXdDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ3ZFLHdCQUFtQixHQUFXLEVBQUUsQ0FBQztRQUtqQyxhQUFRLEdBQWEsRUFBRSxDQUFDO1FBQ3hCLDBCQUFxQixHQUFhLEVBQUUsQ0FBQztRQWhSekMsSUFBSSxDQUFDLGFBQWEsR0FBRyxvQ0FBa0IsQ0FBQztRQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxTQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNoRSxNQUFNLDJCQUEyQixHQUFHLFNBQVMsQ0FBQztRQUM5QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksU0FBRyxDQUFDLDJCQUEyQixFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3hGLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQztRQUVwRCxNQUFNLGVBQWUsR0FBRyxJQUFJLHdCQUFlLENBQUMsc0JBQXNCLEVBQUU7WUFDaEUsa0JBQWtCLEVBQUUsMkJBQTJCO1NBQ2xELENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLDZDQUFvQixDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDL0YsQ0FBQztJQWxCTSxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUF5QjtRQUNoRCxNQUFNLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUM5RCxNQUFNLFFBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQWdCTyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQXlCO1FBQy9DLElBQUksT0FBTyxDQUFDLHFCQUFxQixFQUFFO1lBQy9CLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUM7U0FDL0Q7UUFFRCxJQUFJLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRXhELElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQztRQUNwRCxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLHlCQUF5QiwrQ0FBK0MsQ0FBQztRQUNySCx1REFBdUQ7UUFDdkQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFakYsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQ3pELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBUyxHQUFHLElBQTZDO1lBQzNGLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUM5QixJQUFJLE9BQU8sWUFBWSxLQUFLLFVBQVUsRUFBRTtnQkFDcEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDdkM7UUFDTCxDQUFDLENBQUM7UUFFRixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFTyx5QkFBeUIsQ0FBQyxRQUF5QjtRQUN2RCxhQUFhO1FBQ2IsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDckQsSUFBSSxvQkFBb0IsR0FBVyxFQUFFLENBQUM7WUFDdEMsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLEVBQUU7Z0JBQzFDLG9CQUFvQixHQUFHLEdBQUcsQ0FBQzthQUM5QjtpQkFBTSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsRUFBRTtnQkFDbEQsb0JBQW9CLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN2RTtZQUNELElBQUksb0JBQW9CLEVBQUU7Z0JBQ3RCLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTt3QkFDcEIsT0FBTzs0QkFDSCxPQUFPLEVBQUUsR0FBRyxFQUFFO2dDQUNWLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dDQUMvQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7NEJBQ3JCLENBQUM7eUJBQ0osQ0FBQztvQkFDTixDQUFDLENBQUMsQ0FBQzthQUNOO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDckQsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO2dCQUN6QyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDeEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLFFBQVEsQ0FBQzthQUNuQjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLGVBQWUsQ0FBQyxJQUFZO1FBQy9CLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsTUFBTTtRQUNmLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRTdCLE9BQU8sQ0FBQyxjQUFjLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUNqRCxNQUFNLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ25DLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFdkIsT0FBTyxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDeEMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTSxLQUFLLENBQUMsc0JBQXNCLENBQUMsRUFDaEMsT0FBTyxFQUNQLFFBQVEsR0FVWDtRQUNHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzVELE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRTdCLE9BQU87UUFDUCxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDakM7UUFFRCxLQUFLLE1BQU0sQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3RFLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLEdBQUcsZ0JBQWdCLENBQUM7U0FDcEQ7UUFFRCxNQUFNLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRU0sUUFBUSxDQUFDLEVBQVU7UUFDdEIsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQUs7UUFDZCxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixNQUFNLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksb0JBQW9CLENBQUMsSUFBWTtRQUNwQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVPLEtBQUssQ0FBQyxlQUFlO1FBQ3pCLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRTFDLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFcEMsTUFBTSx3QkFBd0IsR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNqRixJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyx3QkFBd0IsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUVuRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDeEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLFNBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVPLEtBQUssQ0FBQyxxQkFBcUI7UUFDL0IsTUFBTSxFQUFFLEdBQUcsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBa0IsQ0FBQztRQUV0RCxLQUFLLE1BQU0sZUFBZSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUNuRCxJQUFJLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtnQkFDN0IsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxDQUFDO2FBQ2hEO1lBQ0QsRUFBRSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLGVBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZEO1FBQ0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUV4QixFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUV4QixJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRU8sc0JBQXNCO1FBQzFCLEtBQUssTUFBTSxTQUFTLElBQUksSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQ2hELE9BQU8sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLFNBQVMsR0FBRyxDQUFDLENBQUM7WUFDN0MsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN4QyxJQUFJLE1BQU0sS0FBSyxLQUFLLEVBQUU7Z0JBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLFNBQVMsK0JBQStCLENBQUMsQ0FBQzthQUNyRjtTQUNKO1FBQ0QsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVPLEtBQUssQ0FBQywwQkFBMEI7UUFDcEMsTUFBTSxpQkFBaUIsR0FBK0MsQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLEVBQUUsRUFBRTs7O1lBQ2pHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUMvQyxPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLElBQUksUUFBUSxFQUFFO2dCQUNWLGFBQUMsSUFBSSxDQUFDLGFBQWEsT0FBQyxRQUFRLENBQUMsSUFBSSw4Q0FBTSxFQUFFLEVBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQzthQUNyRTtRQUNMLENBQUMsQ0FBQztRQUVGLGFBQWEsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUV4RCxJQUFJO1lBQ0EsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7U0FDL0Q7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDckI7Z0JBQVM7WUFDTixJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDL0IsYUFBYSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1NBQ3ZFO0lBQ0wsQ0FBQztJQUVPLEtBQUssQ0FBQyxlQUFlO1FBQ3pCLE1BQU0seUJBQXlCLEdBQXVDLEVBQUUsQ0FBQztRQUN6RSxLQUFLLE1BQU0sQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1RSx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztTQUNuRjtRQUNELE1BQU0sTUFBTSxHQUFHLHVDQUFpQixDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDNUQsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RixLQUFLLE1BQU0sSUFBSSxJQUFJLFlBQVksRUFBRTtZQUM3QixJQUFJO2dCQUNBLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNqQjtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDeEI7U0FDSjtJQUNMLENBQUM7SUFFTyxxQkFBcUI7UUFDekIsS0FBSyxNQUFNLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzlELE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMvQztJQUNMLENBQUM7SUFFTyxPQUFPLENBQW9DLEdBQVEsRUFBRSxHQUFHLElBQW1EO1FBQy9HLGFBQWE7UUFDYixPQUFPLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDM0YsQ0FBQztJQUVPLFdBQVcsQ0FBQyxHQUFHLElBQVM7UUFDNUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFTyxlQUFlLENBQUMsS0FBWSxFQUFFLEVBQVUsRUFBRSxZQUF1QjtRQUNyRSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztRQUNoRCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN4QjtZQUNELElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDdEUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNuQztJQUNMLENBQUM7Q0F3Qko7QUF6UkQsNEJBeVJDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBzb3J0UGx1Z2luU2NyaXB0cyB9IGZyb20gJy4vc29ydC1wbHVnaW4tc2NyaXB0cyc7XG5pbXBvcnQgeyBFeGVjdXRvclN5c3RlbSwgZ2xvYmFsRWRpdG9yU3lzdGVtIH0gZnJvbSAnLi4vZWRpdG9yLXN5c3RlbWpzJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBMb2FkZXJDb250ZXh0IH0gZnJvbSAnLi4vbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay91dGlscy9sb2FkZXItY29udGV4dCc7XG5pbXBvcnQgeyBRdWlja1BhY2tMb2FkZXIgfSBmcm9tICcuLi9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL2xvYWRlcic7XG5pbXBvcnQgeyBQYWNrTW9kSW5zdGFudGlhdGlvbiB9IGZyb20gJy4vcGFjay1tb2QtaW5zdGFudGlhdGlvbic7XG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XG5cbnR5cGUgSW1wb3J0RW5naW5lTW9kID0gKGlkOiBzdHJpbmcpID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4vLyBgJ2NjJ2Ag55qEIFVSTFxuY29uc3QgZW5naW5lSW5kZXhVUkwgPSBgY2NlOi9pbnRlcm5hbC94L2NjYDtcbi8vIOW8leaTjuWKn+iDveWNleWFg+aooeWdl+eahCBVUkwg5YmN57yAXG5jb25zdCBlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2NjLWZ1L2A7XG4vLyDlvJXmk47lhazlvIDoh7PnvJbovpHlmajnmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvZWRpdG9yLWV4cG9ydHMvYDtcblxuZXhwb3J0IGNsYXNzIEV4ZWN1dG9yIHtcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBFeGVjdXRvci5PcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gbmV3IEV4ZWN1dG9yKG9wdGlvbnMucXVpY2tQYWNrTG9hZGVyQ29udGV4dCk7XG4gICAgICAgIGF3YWl0IGV4ZWN1dG9yLl9pbml0aWFsaXplKG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gZXhlY3V0b3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0KSB7XG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbSA9IGdsb2JhbEVkaXRvclN5c3RlbTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0ge307XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzSW1wb3J0TWFwVVJMID0gbmV3IFVSTCgncGFjazovLy9pbXBvcnQtbWFwLmpzb24nKTtcbiAgICAgICAgY29uc3QgcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwID0gJy4vbW9kcy8nO1xuICAgICAgICB0aGlzLl9wYWNrTW9kc0RpclVSTCA9IG5ldyBVUkwocGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLCB0aGlzLl9wYWNrTW9kc0ltcG9ydE1hcFVSTCk7XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzRGlyUHJlZml4ID0gdGhpcy5fcGFja01vZHNEaXJVUkwuaHJlZjtcblxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXIgPSBuZXcgUXVpY2tQYWNrTG9hZGVyKHF1aWNrUGFja0xvYWRlckNvbnRleHQsIHtcbiAgICAgICAgICAgIGltcG9ydE1hcEJhc2VkUm9vdDogcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24gPSBuZXcgUGFja01vZEluc3RhbnRpYXRpb24ocXVpY2tQYWNrTG9hZGVyLCB0aGlzLl9lZGl0b3JTeXN0ZW0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2luaXRpYWxpemUob3B0aW9uczogRXhlY3V0b3IuT3B0aW9ucykge1xuICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcbiAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IG9wdGlvbnMuYmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKG9wdGlvbnMuaW1wb3J0RW5naW5lTW9kKTtcblxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYyddID0gZW5naW5lSW5kZXhVUkw7XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjL2VudiddID0gYCR7ZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeH1jYy9lZGl0b3IvZXhwb3J0cy9wb3B1bGF0ZS1pbnRlcm5hbC1jb25zdGFudHNgO1xuICAgICAgICAvLyBUT0RPOiBkZXByZWNhdGVkIGNjZS5lbnYgaXMgb25seSBsaXZlIGluIDMuMC1wcmV2aWV3XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjZS5lbnYnXSA9IHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjL2VudiddO1xuXG4gICAgICAgIGNvbnN0IHZlbmRlck9uTG9hZCA9IFN5c3RlbS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUub25sb2FkO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQgPSBmdW5jdGlvbiguLi5hcmdzOiBQYXJhbWV0ZXJzPEV4ZWN1dG9yWydfb25Nb2R1bGVMb2FkZWQnXT4pIHtcbiAgICAgICAgICAgIHNlbGYuX29uTW9kdWxlTG9hZGVkKC4uLmFyZ3MpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2ZW5kZXJPbkxvYWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICB2ZW5kZXJPbkxvYWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLl9sb2dnZXIgPSBvcHRpb25zLmxvZ2dlciB8fCB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hZGRJbnN0YW50aWF0aW9uSGFuZGxlcnMoaW1wb3J0ZXI6IEltcG9ydEVuZ2luZU1vZCkge1xuICAgICAgICAvLyDlpITnkIblvJXmk47mqKHlnZfnmoTlrp7kvovljJZcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKGFzeW5jICh1cmwpID0+IHtcbiAgICAgICAgICAgIGxldCBxdWlja0NvbXBpbGVyUmVxdWVzdDogc3RyaW5nID0gJyc7XG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoZW5naW5lRmVhdHVyZVVuaXRzUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gdXJsO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVFZGl0b3JFeHBvcnRzUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gdXJsLnN1YnN0cihlbmdpbmVFZGl0b3JFeHBvcnRzUHJlZml4Lmxlbmd0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocXVpY2tDb21waWxlclJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW1tdLCAoX2V4cG9ydCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0ZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cG9ydHMgPSBpbXBvcnRlcihxdWlja0NvbXBpbGVyUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2V4cG9ydChleHBvcnRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOWkhOeQhiBQYWNrZXIg6YeM55qE5qih5Z2X55qE5a6e5L6L5YyWXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcihhc3luYyAodXJsKSA9PiB7XG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgodGhpcy5fcGFja01vZHNEaXJQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGluayA9IHVybC5zdWJzdHIodGhpcy5fcGFja01vZHNEaXJQcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmluc3RhbnRpYXRlKGxpbmspO1xuICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzLnB1c2godXJsKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVnaXN0ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRQb2x5ZmlsbEZpbGUoZmlsZTogc3RyaW5nKSB7XG4gICAgICAgIHJlcXVpcmUoZmlsZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6YeN5paw6K+75Y+WIFBhY2tlciDnmoTlhoXlrrnlubbph43mlrDmiafooYzmiYDmnInpobnnm67ohJrmnKzlkozmj5Lku7bohJrmnKzjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9yZWxvYWRQYWNrTW9kcygpO1xuXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEludmFsaWRhdGUgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5faW52YWxpZGF0ZUFsbE1vZHVsZXMoKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XG5cbiAgICAgICAgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcblxuICAgICAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKGBJbXBvcnRzIGFsbCBtb2R1bGVzYCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2ltcG9ydFByZXJlcXVpc2l0ZU1vZHVsZXMoKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBob3RSZWxvYWRQbHVnaW5TY3JpcHRzKHtcbiAgICAgICAgY2hhbmdlcyxcbiAgICAgICAgcmVtb3ZhbHMsXG4gICAgfToge1xuICAgICAgICAvKipcbiAgICAgICAgICog5omA5pyJ6KaB5L+u5pS555qE77yI5oiW5paw5aKe55qE77yJ5o+S5Lu26ISa5pys44CCXG4gICAgICAgICAqL1xuICAgICAgICBjaGFuZ2VzOiBSZWNvcmQ8UGx1Z2luU2NyaXB0SWQsIFBsdWdpblNjcmlwdEluZm8+XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmiYDmnInopoHnp7vpmaTnmoTmj5Lku7bohJrmnKzjgIJcbiAgICAgICAgICovXG4gICAgICAgIHJlbW92YWxzOiBQbHVnaW5TY3JpcHRJZFtdO1xuICAgIH0pIHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGNoYW5nZXMpLmxlbmd0aCA9PT0gMCAmJiByZW1vdmFscy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XG5cbiAgICAgICAgLy8g5bqU55So5L+u5pS5XG4gICAgICAgIGZvciAoY29uc3QgcmVtb3ZhbCBvZiByZW1vdmFscykge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3BsdWdpbnNbcmVtb3ZhbF07XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IFtwbHVnaW5TY3JpcHRJZCwgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXMoY2hhbmdlcykpIHtcbiAgICAgICAgICAgIHRoaXMuX3BsdWdpbnNbcGx1Z2luU2NyaXB0SWRdID0gcGx1Z2luU2NyaXB0SW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRBbGxQbHVnaW5zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzTW9kdWxlKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGlkIGluIHRoaXMuX21vZHVsZXM7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNsZWFyKCkge1xuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0ge307XG4gICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5p+l5om+5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu+OAglxuICAgICAqIEBwYXJhbSB1dWlkIOaooeWdl+eahCB1dWlk44CCXG4gICAgICogQHJldHVybnMg5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu++8m+WmguaenCBbdXVpZF0g5bm25LiN5a+55bqU5LiA5Liq5qih5Z2X5oiW5qih5Z2X5Lit5pyq5rOo5YaM5Lu75L2V57G75YiZ6L+U5ZueIGB1bmRlZmluZWRg44CCXG4gICAgICovXG4gICAgcHVibGljIHF1ZXJ5Q2xhc3Nlc0luTW9kdWxlKHV1aWQ6IHN0cmluZyk6IHVuZGVmaW5lZCB8IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHk8RnVuY3Rpb24+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1V1aWRNYXBbdXVpZF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfcmVsb2FkUGFja01vZHMoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLnJlbG9hZCgpO1xuXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5jbGVhckltcG9ydE1hcCgpO1xuXG4gICAgICAgIGNvbnN0IHF1aWNrUGFja0xvYWRlckltcG9ydE1hcCA9IGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmdldEltcG9ydE1hcCgpO1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uZXh0ZW5kSW1wb3J0TWFwKHF1aWNrUGFja0xvYWRlckltcG9ydE1hcCwgdGhpcy5fcGFja01vZHNJbXBvcnRNYXBVUkwuaHJlZik7XG5cbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmV4dGVuZEltcG9ydE1hcCh0aGlzLl9maXhlZEltcG9ydE1hcCwgdGhpcy5fZW5naW5lSW1wb3J0TWFwVVJMKTtcblxuICAgICAgICBjb25zdCBlbnRyaWVzID0gdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24uZ2V0RW50cmllcygpO1xuICAgICAgICB0aGlzLl9lbnRyaWVzID0gZW50cmllcy5tYXAoKGVudHJ5KSA9PiBuZXcgVVJMKGVudHJ5LCB0aGlzLl9wYWNrTW9kc0ltcG9ydE1hcFVSTCkuaHJlZik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfaW52YWxpZGF0ZUFsbE1vZHVsZXMoKSB7XG4gICAgICAgIGNvbnN0IGNjID0gYXdhaXQgU3lzdGVtLmltcG9ydCgnY2MnKSBhcyBFbmdpbmVFeHBvcnRzO1xuXG4gICAgICAgIGZvciAoY29uc3QgcmVnaXN0ZXJlZENsYXNzIG9mIHRoaXMuX3JlZ2lzdGVyZWRDbGFzc2VzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYy5qcy51bnJlZ2lzdGVyQ2xhc3MocmVnaXN0ZXJlZENsYXNzKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFVucmVnaXN0ZXIgJHtyZWdpc3RlcmVkQ2xhc3MubmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3NlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuX2NsYXNzVXVpZE1hcCA9IHt9O1xuXG4gICAgICAgIGNjLmNjbGVnYWN5Ll9SRi5yZXNldCgpO1xuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpIHtcbiAgICAgICAgZm9yIChjb25zdCBwYWNrTW9kSWQgb2YgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYEludmFsaWRhdGluZyAnJHtwYWNrTW9kSWR9J2ApO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gU3lzdGVtLmRlbGV0ZShwYWNrTW9kSWQpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBOb3RlOiBmYWlsZWQgdG8gZGVsZXRlICR7cGFja01vZElkfSwgbWF5YmUgaXQncyBiZWluZyBleGVjdXRpbmc/YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMubGVuZ3RoID0gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCkge1xuICAgICAgICBjb25zdCBvbkNsYXNzUmVnaXN0ZXJlZDogRWRpdG9yRXh0ZW5kcy5MaXN0ZW5lcjwnY2xhc3MtcmVnaXN0ZXJlZCc+ID0gKGNsYXNzQ29uc3RydWN0b3IsIG1ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3Nlcy5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgW1tFeGVjdXRvcl1dIFJlZ2lzdGVyICR7Y2xhc3NDb25zdHJ1Y3Rvci5uYW1lfWApO1xuICAgICAgICAgICAgaWYgKG1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgKHRoaXMuX2NsYXNzVXVpZE1hcFttZXRhZGF0YS51dWlkXSA/Pz0gW10pLnB1c2goY2xhc3NDb25zdHJ1Y3Rvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgRWRpdG9yRXh0ZW5kcy5vbignY2xhc3MtcmVnaXN0ZXJlZCcsIG9uQ2xhc3NSZWdpc3RlcmVkKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgU3lzdGVtLmltcG9ydCgnY2NlOi9pbnRlcm5hbC94L3ByZXJlcXVpc2l0ZS1pbXBvcnRzJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGVycik7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRFeGNlcHRpb25zLmNsZWFyKCk7XG4gICAgICAgICAgICBFZGl0b3JFeHRlbmRzLnJlbW92ZUxpc3RlbmVyKCdjbGFzcy1yZWdpc3RlcmVkJywgb25DbGFzc1JlZ2lzdGVyZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfbG9hZEFsbFBsdWdpbnMoKSB7XG4gICAgICAgIGNvbnN0IHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXA6IEFycmF5PFtzdHJpbmcsIHJlYWRvbmx5IHN0cmluZ1tdXT4gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm9dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX3BsdWdpbnMpKSB7XG4gICAgICAgICAgICBwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwLnB1c2goW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvLmRlcGVuZGVuY2llc10pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNvcnRlZCA9IHNvcnRQbHVnaW5TY3JpcHRzKHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXApO1xuICAgICAgICBjb25zdCBzb3J0ZWRNYXBwZWQgPSBzb3J0ZWQubWFwKChwbHVnaW5TY3JpcHRJZCkgPT4gdGhpcy5fcGx1Z2luc1twbHVnaW5TY3JpcHRJZF0uZmlsZSk7XG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBzb3J0ZWRNYXBwZWQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZShmaWxlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGx1Z2lucygpIHtcbiAgICAgICAgZm9yIChjb25zdCBbLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xuICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcGx1Z2luU2NyaXB0SW5mby5maWxlXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3RyeUxvZzxDYXQgZXh0ZW5kcyBrZXlvZiBFeGVjdXRvci5Mb2dnZXI+KGNhdDogQ2F0LCAuLi5hcmdzOiBQYXJhbWV0ZXJzPE5vbk51bGxhYmxlPEV4ZWN1dG9yLkxvZ2dlcltDYXRdPj4pIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gKGNhdCBpbiB0aGlzLl9sb2dnZXIpID8gdGhpcy5fbG9nZ2VyW2NhdF0hKC4uLmFyZ3MpIDogdGhpcy5fZGVmYXVsdExvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kZWZhdWx0TG9nKC4uLmFyZ3M6IGFueSkge1xuICAgICAgICBjb25zb2xlLmxvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vbk1vZHVsZUxvYWRlZChlcnJvcjogRXJyb3IsIGlkOiBzdHJpbmcsIGRlcGVuZGVuY2llcz86IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlZEV4Y2VwdGlvbnMgPSB0aGlzLl9jYWNoZWRFeGNlcHRpb25zO1xuICAgICAgICBpZiAoIWVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBbW0V4ZWN1dG9yXV0gTW9kdWxlIFwiJHtpZH1cIiBsb2FkZWQuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIWNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fdHJ5TG9nKCdsb2FkRXhjZXB0aW9uJywgaWQsIGVycm9yLCBjYWNoZWRFeGNlcHRpb25zLmhhcyhlcnJvcikpO1xuICAgICAgICAgICAgY2FjaGVkRXhjZXB0aW9ucy5zZXQoZXJyb3IsIGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVjbGFyZSBfcGFja01vZEluc3RhbnRpYXRpb246IFBhY2tNb2RJbnN0YW50aWF0aW9uO1xuXG4gICAgcHJpdmF0ZSBfYmVmb3JlVW5yZWdpc3RlckNsYXNzPzogRXhlY3V0b3IuQmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgIHByaXZhdGUgX2NhY2hlZEV4Y2VwdGlvbnM6IE1hcDxhbnksIHN0cmluZz4gPSBuZXcgTWFwKCk7XG4gICAgcHJpdmF0ZSBfY2xhc3NVdWlkTWFwOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbltdPiA9IHt9O1xuICAgIHByaXZhdGUgX2xvZ2dlcjogUGFydGlhbDxFeGVjdXRvci5Mb2dnZXI+O1xuICAgIHByaXZhdGUgX2J1aWx0aW5Nb2RzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cbiAgICBwcml2YXRlIF9lZGl0b3JTeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xuICAgIHByaXZhdGUgX21vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZVNjcmlwdEluZm8+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBwcml2YXRlIF9yZWdpc3RlcmVkQ2xhc3NlczogRnVuY3Rpb25bXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfcGx1Z2luczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPiA9IHt9O1xuXG4gICAgcHJpdmF0ZSBfZml4ZWRJbXBvcnRNYXA6IHsgaW1wb3J0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9ID0geyBpbXBvcnRzOiB7fSB9O1xuICAgIHByaXZhdGUgX2VuZ2luZUltcG9ydE1hcFVSTDogc3RyaW5nID0gJyc7XG5cbiAgICBwcml2YXRlIF9wYWNrTW9kc0ltcG9ydE1hcFVSTDogUmVhZG9ubHk8VVJMPjtcbiAgICBwcml2YXRlIF9wYWNrTW9kc0RpclVSTDogUmVhZG9ubHk8VVJMPjtcbiAgICBwcml2YXRlIF9wYWNrTW9kc0RpclByZWZpeDogUmVhZG9ubHk8c3RyaW5nPjtcbiAgICBwcml2YXRlIF9lbnRyaWVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgX2luc3RhbnRpYXRlZFBhY2tNb2RzOiBzdHJpbmdbXSA9IFtdO1xufVxuXG5leHBvcnQgbmFtZXNwYWNlIEV4ZWN1dG9yIHtcbiAgICBleHBvcnQgdHlwZSBCZWZvcmVVbnJlZ2lzdGVyQ2xhc3MgPSAoY2xhc3NDb25zdHJ1Y3RvcjogRnVuY3Rpb24pID0+IHZvaWQ7XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIFJlcG9ydGVyTWFwIHtcbiAgICAgICAgWydwb3NzaWJsZS1jci11c2UnXToge1xuICAgICAgICAgICAgaW1wb3J0ZWQ6IHN0cmluZztcbiAgICAgICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZztcbiAgICAgICAgICAgIGltcG9ydE1ldGE6IGFueTtcbiAgICAgICAgICAgIGV4dHJhczogYW55O1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGV4cG9ydCB0eXBlIExvZ2dlciA9IFBhcnRpYWw8e1xuICAgICAgICBwb3NzaWJsZUNpcmN1bGFyUmVmZXJlbmNlOiAoXG4gICAgICAgICAgICBpbXBvcnRlZDogc3RyaW5nLFxuICAgICAgICAgICAgbW9kdWxlUmVxdWVzdDogc3RyaW5nLFxuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55LFxuICAgICAgICAgICAgZXh0cmFzOiBhbnlcbiAgICAgICAgKSA9PiB2b2lkO1xuXG4gICAgICAgIGxvYWRFeGNlcHRpb246IChcbiAgICAgICAgICAgIG1vZHVsZVVybDogc3RyaW5nLFxuICAgICAgICAgICAgZXJyb3I/OiBhbnksXG4gICAgICAgICAgICBoYXNCZWVuVGhyb3duPzogYm9vbGVhbixcbiAgICAgICAgKSA9PiB2b2lkO1xuICAgIH0+O1xuXG4gICAgZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgICAgICAgaW1wb3J0RW5naW5lTW9kOiAoaWQ6IHN0cmluZykgPT4gUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICAgIHF1aWNrUGFja0xvYWRlckNvbnRleHQ6IExvYWRlckNvbnRleHQ7XG4gICAgICAgIGJlZm9yZVVucmVnaXN0ZXJDbGFzcz86IEJlZm9yZVVucmVnaXN0ZXJDbGFzcztcbiAgICAgICAgbG9nZ2VyPzogTG9nZ2VyO1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgRXhlY3V0ZUluZm8ge1xuICAgICAgICBwb2x5ZmlsbHM6IHN0cmluZ1tdO1xuICAgICAgICBtb2R1bGVzOiBzdHJpbmdbXTtcbiAgICAgICAgYmFyZVNwZWNpZmllclJlc29sdmVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gICAgICAgIGluc3RhbnRpYXRlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgIH1cbn1cblxudHlwZSBQbHVnaW5TY3JpcHRJZCA9IHN0cmluZztcblxuaW50ZXJmYWNlIFBsdWdpblNjcmlwdEluZm8ge1xuICAgIC8qKlxuICAgICAqIOiEmuacrOaWh+S7tuOAglxuICAgICAqL1xuICAgIGZpbGU6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIOS+nei1lueahOaPkuS7tuiEmuacrOOAglxuICAgICAqL1xuICAgIGRlcGVuZGVuY2llczogUGx1Z2luU2NyaXB0SWRbXTtcbn1cblxuaW50ZXJmYWNlIE1vZHVsZVNjcmlwdEluZm8ge1xuICAgIC8qKlxuICAgICAqIOaooeWdlyBVUkzjgIJcbiAgICAgKi9cbiAgICBtb2R1bGVVcmw6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIOS7o+eggeaWh+S7tuOAglxuICAgICAqL1xuICAgIGZpbGU6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEVuZ2luZUV4cG9ydHMge1xuICAgIGNjbGVnYWN5OiB7IF9SRjogeyByZXNldCgpOiB2b2lkOyB9IH07XG4gICAganM6IHsgdW5yZWdpc3RlckNsYXNzKGY6IEZ1bmN0aW9uKTogdm9pZDsgfTtcbn1cblxuZGVjbGFyZSBuYW1lc3BhY2UgRWRpdG9yRXh0ZW5kcyB7XG4gICAgaW50ZXJmYWNlIEV2ZW50TWFwIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENhbGxlZCB3aGVuIGEgY2MtY2xhc3MgaXMgcmVnaXN0ZXJlZC5cbiAgICAgICAgICogQHBhcmFtIGNsYXNzQ29uc3RydWN0b3IgUmVnaXN0ZXJpbmcgY2xhc3MuXG4gICAgICAgICAqL1xuICAgICAgICAnY2xhc3MtcmVnaXN0ZXJlZCcoY2xhc3NDb25zdHJ1Y3RvcjogRnVuY3Rpb24sIG1ldGFkYXRhPzogUmVhZG9ubHk8YW55Pik6IHZvaWQ7XG4gICAgfVxuXG4gICAgdHlwZSBFdmVudEFyZ3M8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+ID0gUGFyYW1ldGVyczxFdmVudE1hcFtFdmVudE5hbWVdPjtcblxuICAgIHR5cGUgTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+ID0gKC4uLmFyZ3M6IEV2ZW50QXJnczxFdmVudE5hbWU+KSA9PiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gZW1pdDxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCAuLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPik6IHZvaWQ7XG5cbiAgICBmdW5jdGlvbiBvbjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCBsaXN0ZW5lcjogTGlzdGVuZXI8RXZlbnROYW1lPik6IHZvaWQ7XG5cbiAgICBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCBsaXN0ZW5lcjogTGlzdGVuZXI8RXZlbnROYW1lPik6IHZvaWQ7XG59XG4iXX0=