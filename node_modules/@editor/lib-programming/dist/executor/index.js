"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const path_1 = __importDefault(require("path"));
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("@cocos/creator-programming-quick-pack/lib/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineExportToEditorPrefix = `cce:/internal/x/engine-export-to-editor/`;
// 编辑器公开给项目的模块的 URL 前缀
const editorExportToProjectPrefix = `cce:/internal/x/editor-export-to-project/`;
// 项目路径相关 URL 前缀
const projectUrlPrefix = 'cce:/internal/x/project/';
const packResourceBaseURL = new url_1.URL('pack:///');
const defaultImportExceptionHandler = (err) => {
    console.warn(err);
};
class Executor {
    constructor(quickPackLoaderContext, packModuleEvaluator, importExceptionHandler) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._cceModuleMap = {};
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext);
        this._packLoader = quickPackLoader;
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem, packModuleEvaluator);
        this._importExceptionHandler = importExceptionHandler !== null && importExceptionHandler !== void 0 ? importExceptionHandler : defaultImportExceptionHandler;
    }
    static async create(options) {
        if (Executor._inst) {
            return Executor._inst;
        }
        const executor = Executor._inst = new Executor(options.quickPackLoaderContext, options.packModuleEvaluator, options.importExceptionHandler);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._cceModuleMap = options.cceModuleMap;
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineExportToEditorPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const projectCustomMacroURL = new url_1.URL('./temp/programming/custom-macro.js', projectUrlPrefix);
        this._fixedImportMap.imports['cc/userland/macro'] = projectCustomMacroURL.href;
        for (const [moduleName, moduleConfig] of Object.entries(this._cceModuleMap)) {
            if (moduleName === 'mapLocation') {
                continue;
            }
            this._fixedImportMap.imports[moduleName] = `${editorExportToProjectPrefix}${moduleName}`;
        }
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理项目里的自定义配置模块，比如 custom-macro 模块
        this._editorSystem.addInstantiationHandler((url) => {
            if (url.startsWith(projectUrlPrefix)) {
                let quickCompilerRequest = url.substr(projectUrlPrefix.length);
                quickCompilerRequest = path_1.default.join(Editor.Project.path, quickCompilerRequest);
                require(quickCompilerRequest);
                return this._editorSystem.getRegister();
            }
        });
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineExportToEditorPrefix)) {
                quickCompilerRequest = url.substr(engineExportToEditorPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: async () => {
                                const exports = await importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        const packResourceBaseURLString = packResourceBaseURL.href;
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(packResourceBaseURLString)) {
                const link = url.slice(packResourceBaseURLString.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(editorExportToProjectPrefix)) {
                const moduleName = url.slice(editorExportToProjectPrefix.length);
                const moduleConfig = this._cceModuleMap[moduleName];
                const mapLocation = this._cceModuleMap.mapLocation;
                if (moduleConfig) {
                    const exportedObj = require(path_1.default.join(path_1.default.dirname(mapLocation), moduleConfig.main));
                    return [[], (_export) => {
                            return {
                                execute: async () => {
                                    _export(exportedObj);
                                },
                            };
                        }];
                }
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    async prepare() {
        await this._reloadPackMods();
    }
    async import(url) {
        return await this._editorSystem.import(url);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        try {
            await this._reloadPackMods();
            console.groupCollapsed(`Invalidate all modules`);
            await this._invalidateAllModules();
            console.groupEnd();
            this._invalidateAllPlugins();
            this._loadAllPlugins();
            console.groupCollapsed(`Imports all modules`);
            await this._importPrerequisiteModules();
            console.groupEnd();
        }
        catch (e) {
            console.error(`Executor failed to reload.`, e);
            throw e;
        }
        finally {
            EditorExtends.removeListener('class-registered', onClassRegistered);
        }
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    setPluginScripts(plugins) {
        this._invalidateAllPlugins();
        this._plugins = plugins;
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        // 多进程操作同一个资源。如果不给文件加锁，会导致文件读写冲突
        await this._packModInstantiation.lock();
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, new url_1.URL(this._packLoader.importMapURL, packResourceBaseURL).href);
        await this._packModInstantiation.unlock();
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
        const resolutionDetailMap = await this._packLoader.loadResolutionDetailMap();
        this._editorSystem.setResolutionDetailMap(resolutionDetailMap, new url_1.URL(this._packLoader.resolutionDetailMapURL, packResourceBaseURL).href);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const cc = await System.import('cc');
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            this._importExceptionHandler(err);
        }
        finally {
            this._cachedExceptions.clear();
            // 项目脚本可能在执行的时候会抛出异常，这导致 `cc._RF` 没有正确弹出。
            // 我们在最后清理一下。
            cc.cclegacy._RF.reset();
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                this._importExceptionHandler(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXNCO0FBQ3RCLCtEQUEwRDtBQUMxRCx3REFBd0U7QUFDeEUsNkJBQTBCO0FBRTFCLDZFQUFtRjtBQUNuRixxRUFBcUY7QUFLckYsZUFBZTtBQUNmLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO0FBQzVDLG1CQUFtQjtBQUNuQixNQUFNLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO0FBQzFELHNCQUFzQjtBQUN0QixNQUFNLDBCQUEwQixHQUFHLDBDQUEwQyxDQUFDO0FBQzlFLHNCQUFzQjtBQUN0QixNQUFNLDJCQUEyQixHQUFHLDJDQUEyQyxDQUFDO0FBQ2hGLGdCQUFnQjtBQUNoQixNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBRXBELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxTQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFJaEQsTUFBTSw2QkFBNkIsR0FBMkIsQ0FBQyxHQUFZLEVBQUUsRUFBRTtJQUMzRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQUVGLE1BQWEsUUFBUTtJQWVqQixZQUNJLHNCQUFxQyxFQUNyQyxtQkFBb0QsRUFDcEQsc0JBQTBEO1FBK1R0RCxzQkFBaUIsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoRCxrQkFBYSxHQUErQixFQUFFLENBQUM7UUFFL0MsaUJBQVksR0FBMkIsRUFBRSxDQUFDO1FBSzFDLGFBQVEsR0FBcUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRSx1QkFBa0IsR0FBZSxFQUFFLENBQUM7UUFFcEMsYUFBUSxHQUE2QyxFQUFFLENBQUM7UUFFeEQsb0JBQWUsR0FBd0MsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDdkUs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Q0FBQztRQUNoRCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3ZDO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUN0RSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ25DO0lBQ0wsQ0FBQztDQXdCSjtBQXBXRCw0QkFvV0MiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNvcnRQbHVnaW5TY3JpcHRzIH0gZnJvbSAnLi9zb3J0LXBsdWdpbi1zY3JpcHRzJztcbmltcG9ydCB7IEV4ZWN1dG9yU3lzdGVtLCBnbG9iYWxFZGl0b3JTeXN0ZW0gfSBmcm9tICcuLi9lZGl0b3Itc3lzdGVtanMnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi91dGlscy9sb2FkZXItY29udGV4dCc7XG5pbXBvcnQgeyBRdWlja1BhY2tMb2FkZXIgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi9sb2FkZXInO1xuaW1wb3J0IHsgUGFja01vZEluc3RhbnRpYXRpb24sIFBhY2tNb2R1bGVFdmFsdWF0b3IgfSBmcm9tICcuL3BhY2stbW9kLWluc3RhbnRpYXRpb24nO1xuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xuXG50eXBlIEltcG9ydEVuZ2luZU1vZCA9IChpZDogc3RyaW5nKSA9PiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB8IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4+O1xuXG4vLyBgJ2NjJ2Ag55qEIFVSTFxuY29uc3QgZW5naW5lSW5kZXhVUkwgPSBgY2NlOi9pbnRlcm5hbC94L2NjYDtcbi8vIOW8leaTjuWKn+iDveWNleWFg+aooeWdl+eahCBVUkwg5YmN57yAXG5jb25zdCBlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2NjLWZ1L2A7XG4vLyDlvJXmk47lhazlvIDoh7PnvJbovpHlmajnmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZW5naW5lRXhwb3J0VG9FZGl0b3JQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2VuZ2luZS1leHBvcnQtdG8tZWRpdG9yL2A7XG4vLyDnvJbovpHlmajlhazlvIDnu5npobnnm67nmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZWRpdG9yRXhwb3J0VG9Qcm9qZWN0UHJlZml4ID0gYGNjZTovaW50ZXJuYWwveC9lZGl0b3ItZXhwb3J0LXRvLXByb2plY3QvYDtcbi8vIOmhueebrui3r+W+hOebuOWFsyBVUkwg5YmN57yAXG5jb25zdCBwcm9qZWN0VXJsUHJlZml4ID0gJ2NjZTovaW50ZXJuYWwveC9wcm9qZWN0Lyc7XG5cbmNvbnN0IHBhY2tSZXNvdXJjZUJhc2VVUkwgPSBuZXcgVVJMKCdwYWNrOi8vLycpO1xuXG50eXBlIEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB2b2lkO1xuXG5jb25zdCBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjogSW1wb3J0RXhjZXB0aW9uSGFuZGxlciA9IChlcnI6IHVua25vd24pID0+IHtcbiAgICBjb25zb2xlLndhcm4oZXJyKTtcbn07XG5cbmV4cG9ydCBjbGFzcyBFeGVjdXRvciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3Q6IEV4ZWN1dG9yO1xuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY3JlYXRlKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcbiAgICAgICAgaWYgKEV4ZWN1dG9yLl9pbnN0KSB7XG4gICAgICAgICAgICByZXR1cm4gRXhlY3V0b3IuX2luc3Q7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZXhlY3V0b3IgPSBFeGVjdXRvci5faW5zdCA9IG5ldyBFeGVjdXRvcihcbiAgICAgICAgICAgIG9wdGlvbnMucXVpY2tQYWNrTG9hZGVyQ29udGV4dCxcbiAgICAgICAgICAgIG9wdGlvbnMucGFja01vZHVsZUV2YWx1YXRvcixcbiAgICAgICAgICAgIG9wdGlvbnMuaW1wb3J0RXhjZXB0aW9uSGFuZGxlcixcbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgZXhlY3V0b3IuX2luaXRpYWxpemUob3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBleGVjdXRvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKFxuICAgICAgICBxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0LFxuICAgICAgICBwYWNrTW9kdWxlRXZhbHVhdG9yOiBQYWNrTW9kdWxlRXZhbHVhdG9yIHwgdW5kZWZpbmVkLFxuICAgICAgICBpbXBvcnRFeGNlcHRpb25IYW5kbGVyOiBJbXBvcnRFeGNlcHRpb25IYW5kbGVyIHwgdW5kZWZpbmVkLFxuICAgICkge1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0gPSBnbG9iYWxFZGl0b3JTeXN0ZW07XG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IHt9O1xuXG4gICAgICAgIGNvbnN0IHF1aWNrUGFja0xvYWRlciA9IG5ldyBRdWlja1BhY2tMb2FkZXIocXVpY2tQYWNrTG9hZGVyQ29udGV4dCk7XG4gICAgICAgIHRoaXMuX3BhY2tMb2FkZXIgPSBxdWlja1BhY2tMb2FkZXI7XG4gICAgICAgIHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uID0gbmV3IFBhY2tNb2RJbnN0YW50aWF0aW9uKHF1aWNrUGFja0xvYWRlciwgdGhpcy5fZWRpdG9yU3lzdGVtLCBwYWNrTW9kdWxlRXZhbHVhdG9yKTtcblxuICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyID0gaW1wb3J0RXhjZXB0aW9uSGFuZGxlciA/PyBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuYmVmb3JlVW5yZWdpc3RlckNsYXNzKSB7XG4gICAgICAgICAgICB0aGlzLl9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MgPSBvcHRpb25zLmJlZm9yZVVucmVnaXN0ZXJDbGFzcztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2FkZEluc3RhbnRpYXRpb25IYW5kbGVycyhvcHRpb25zLmltcG9ydEVuZ2luZU1vZCk7XG5cbiAgICAgICAgdGhpcy5fY2NlTW9kdWxlTWFwID0gb3B0aW9ucy5jY2VNb2R1bGVNYXA7XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjJ10gPSBlbmdpbmVJbmRleFVSTDtcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvZW52J10gPSBgJHtlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeH1jYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcbiAgICAgICAgLy8gVE9ETzogZGVwcmVjYXRlZCBjY2UuZW52IGlzIG9ubHkgbGl2ZSBpbiAzLjAtcHJldmlld1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjY2UuZW52J10gPSB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy9lbnYnXTtcbiAgICAgICAgY29uc3QgcHJvamVjdEN1c3RvbU1hY3JvVVJMID0gbmV3IFVSTCgnLi90ZW1wL3Byb2dyYW1taW5nL2N1c3RvbS1tYWNyby5qcycsIHByb2plY3RVcmxQcmVmaXgpO1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy91c2VybGFuZC9tYWNybyddID0gcHJvamVjdEN1c3RvbU1hY3JvVVJMLmhyZWY7XG5cbiAgICAgICAgZm9yIChjb25zdCBbbW9kdWxlTmFtZSwgbW9kdWxlQ29uZmlnXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9jY2VNb2R1bGVNYXApKSB7XG4gICAgICAgICAgICBpZiAobW9kdWxlTmFtZSA9PT0gJ21hcExvY2F0aW9uJykge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1ttb2R1bGVOYW1lXSA9IGAke2VkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeH0ke21vZHVsZU5hbWV9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZlbmRlck9uTG9hZCA9IFN5c3RlbS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUub25sb2FkO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQgPSBmdW5jdGlvbiAoLi4uYXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnX29uTW9kdWxlTG9hZGVkJ10+KSB7XG4gICAgICAgICAgICBzZWxmLl9vbk1vZHVsZUxvYWRlZCguLi5hcmdzKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmVuZGVyT25Mb2FkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdmVuZGVyT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gb3B0aW9ucy5sb2dnZXIgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKGltcG9ydGVyOiBJbXBvcnRFbmdpbmVNb2QpIHtcbiAgICAgICAgLy8g5aSE55CG6aG555uu6YeM55qE6Ieq5a6a5LmJ6YWN572u5qih5Z2X77yM5q+U5aaCIGN1c3RvbS1tYWNybyDmqKHlnZdcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKCh1cmwpID0+IHtcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChwcm9qZWN0VXJsUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIGxldCBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybC5zdWJzdHIocHJvamVjdFVybFByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gcHMuam9pbihFZGl0b3IuUHJvamVjdC5wYXRoLCBxdWlja0NvbXBpbGVyUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgcmVxdWlyZShxdWlja0NvbXBpbGVyUmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VkaXRvclN5c3RlbS5nZXRSZWdpc3RlcigpIGFzIE1vZHVsZVJlZ2lzdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8g5aSE55CG5byV5pOO5qih5Z2X55qE5a6e5L6L5YyWXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcihhc3luYyAodXJsKSA9PiB7XG4gICAgICAgICAgICBsZXQgcXVpY2tDb21waWxlclJlcXVlc3QgPSAnJztcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmw7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVybC5zdGFydHNXaXRoKGVuZ2luZUV4cG9ydFRvRWRpdG9yUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gdXJsLnN1YnN0cihlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtbXSwgKF9leHBvcnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBvcnRzID0gYXdhaXQgaW1wb3J0ZXIocXVpY2tDb21waWxlclJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyDlpITnkIYgUGFja2VyIOmHjOeahOaooeWdl+eahOWunuS+i+WMllxuICAgICAgICBjb25zdCBwYWNrUmVzb3VyY2VCYXNlVVJMU3RyaW5nID0gcGFja1Jlc291cmNlQmFzZVVSTC5ocmVmO1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKHBhY2tSZXNvdXJjZUJhc2VVUkxTdHJpbmcpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGluayA9IHVybC5zbGljZShwYWNrUmVzb3VyY2VCYXNlVVJMU3RyaW5nLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5pbnN0YW50aWF0ZShsaW5rKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW50aWF0ZWRQYWNrTW9kcy5wdXNoKHVybCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKGVkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2R1bGVOYW1lID0gdXJsLnNsaWNlKGVkaXRvckV4cG9ydFRvUHJvamVjdFByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZUNvbmZpZyA9IHRoaXMuX2NjZU1vZHVsZU1hcFttb2R1bGVOYW1lXTtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXBMb2NhdGlvbiA9IHRoaXMuX2NjZU1vZHVsZU1hcC5tYXBMb2NhdGlvbjtcbiAgICAgICAgICAgICAgICBpZiAobW9kdWxlQ29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVkT2JqID0gcmVxdWlyZShwcy5qb2luKHBzLmRpcm5hbWUobWFwTG9jYXRpb24pLCBtb2R1bGVDb25maWcubWFpbikpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1tdLCAoX2V4cG9ydCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0ZWRPYmopO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRQb2x5ZmlsbEZpbGUoZmlsZTogc3RyaW5nKSB7XG4gICAgICAgIHJlcXVpcmUoZmlsZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHByZXBhcmUoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3JlbG9hZFBhY2tNb2RzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGltcG9ydCh1cmw6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZWRpdG9yU3lzdGVtLmltcG9ydCh1cmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOivu+WPliBQYWNrZXIg55qE5YaF5a655bm26YeN5paw5omn6KGM5omA5pyJ6aG555uu6ISa5pys5ZKM5o+S5Lu26ISa5pys44CCXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICAgICAgY29uc3Qgb25DbGFzc1JlZ2lzdGVyZWQ6IEVkaXRvckV4dGVuZHMuTGlzdGVuZXI8J2NsYXNzLXJlZ2lzdGVyZWQnPiA9IChjbGFzc0NvbnN0cnVjdG9yLCBtZXRhZGF0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMucHVzaChjbGFzc0NvbnN0cnVjdG9yKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBSZWdpc3RlciAke2NsYXNzQ29uc3RydWN0b3IubmFtZX1gKTtcbiAgICAgICAgICAgIGlmIChtZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgICh0aGlzLl9jbGFzc1V1aWRNYXBbbWV0YWRhdGEudXVpZF0gPz89IFtdKS5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIEVkaXRvckV4dGVuZHMub24oJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XG4gICAgICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5fcmVsb2FkUGFja01vZHMoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEludmFsaWRhdGUgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgXG4gICAgICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgIFxuICAgICAgICAgICAgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEltcG9ydHMgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ltcG9ydFByZXJlcXVpc2l0ZU1vZHVsZXMoKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFeGVjdXRvciBmYWlsZWQgdG8gcmVsb2FkLmAsIGUpO1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIEVkaXRvckV4dGVuZHMucmVtb3ZlTGlzdGVuZXIoJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBob3RSZWxvYWRQbHVnaW5TY3JpcHRzKHtcbiAgICAgICAgY2hhbmdlcyxcbiAgICAgICAgcmVtb3ZhbHMsXG4gICAgfToge1xuICAgICAgICAvKipcbiAgICAgICAgICog5omA5pyJ6KaB5L+u5pS555qE77yI5oiW5paw5aKe55qE77yJ5o+S5Lu26ISa5pys44CCXG4gICAgICAgICAqL1xuICAgICAgICBjaGFuZ2VzOiBSZWNvcmQ8UGx1Z2luU2NyaXB0SWQsIFBsdWdpblNjcmlwdEluZm8+XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmiYDmnInopoHnp7vpmaTnmoTmj5Lku7bohJrmnKzjgIJcbiAgICAgICAgICovXG4gICAgICAgIHJlbW92YWxzOiBQbHVnaW5TY3JpcHRJZFtdO1xuICAgIH0pIHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGNoYW5nZXMpLmxlbmd0aCA9PT0gMCAmJiByZW1vdmFscy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XG5cbiAgICAgICAgLy8g5bqU55So5L+u5pS5XG4gICAgICAgIGZvciAoY29uc3QgcmVtb3ZhbCBvZiByZW1vdmFscykge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3BsdWdpbnNbcmVtb3ZhbF07XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IFtwbHVnaW5TY3JpcHRJZCwgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXMoY2hhbmdlcykpIHtcbiAgICAgICAgICAgIHRoaXMuX3BsdWdpbnNbcGx1Z2luU2NyaXB0SWRdID0gcGx1Z2luU2NyaXB0SW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRBbGxQbHVnaW5zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzTW9kdWxlKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGlkIGluIHRoaXMuX21vZHVsZXM7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNsZWFyKCkge1xuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuICAgICAgICB0aGlzLl9wbHVnaW5zID0ge307XG4gICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFBsdWdpblNjcmlwdHMgKHBsdWdpbnM6IFJlY29yZDxQbHVnaW5TY3JpcHRJZCwgUGx1Z2luU2NyaXB0SW5mbz4pIHtcbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBsdWdpbnMoKTtcbiAgICAgICAgdGhpcy5fcGx1Z2lucyA9IHBsdWdpbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5p+l5om+5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu+OAglxuICAgICAqIEBwYXJhbSB1dWlkIOaooeWdl+eahCB1dWlk44CCXG4gICAgICogQHJldHVybnMg5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu++8m+WmguaenCBbdXVpZF0g5bm25LiN5a+55bqU5LiA5Liq5qih5Z2X5oiW5qih5Z2X5Lit5pyq5rOo5YaM5Lu75L2V57G75YiZ6L+U5ZueIGB1bmRlZmluZWRg44CCXG4gICAgICovXG4gICAgcHVibGljIHF1ZXJ5Q2xhc3Nlc0luTW9kdWxlKHV1aWQ6IHN0cmluZyk6IHVuZGVmaW5lZCB8IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHk8RnVuY3Rpb24+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1V1aWRNYXBbdXVpZF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfcmVsb2FkUGFja01vZHMoKSB7XG4gICAgICAgIC8vIOWkmui/m+eoi+aTjeS9nOWQjOS4gOS4qui1hOa6kOOAguWmguaenOS4jee7meaWh+S7tuWKoOmUge+8jOS8muWvvOiHtOaWh+S7tuivu+WGmeWGsueqgVxuICAgICAgICBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5sb2NrKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLnJlbG9hZCgpO1xuXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5jbGVhckltcG9ydE1hcCgpO1xuXG4gICAgICAgIGNvbnN0IHF1aWNrUGFja0xvYWRlckltcG9ydE1hcCA9IGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmdldEltcG9ydE1hcCgpO1xuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uZXh0ZW5kSW1wb3J0TWFwKHF1aWNrUGFja0xvYWRlckltcG9ydE1hcCwgbmV3IFVSTCh0aGlzLl9wYWNrTG9hZGVyLmltcG9ydE1hcFVSTCwgcGFja1Jlc291cmNlQmFzZVVSTCkuaHJlZik7XG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLnVubG9jaygpO1xuXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5leHRlbmRJbXBvcnRNYXAodGhpcy5fZml4ZWRJbXBvcnRNYXAsIHRoaXMuX2VuZ2luZUltcG9ydE1hcFVSTCk7XG5cbiAgICAgICAgY29uc3QgcmVzb2x1dGlvbkRldGFpbE1hcCA9IGF3YWl0IHRoaXMuX3BhY2tMb2FkZXIubG9hZFJlc29sdXRpb25EZXRhaWxNYXAoKTtcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLnNldFJlc29sdXRpb25EZXRhaWxNYXAocmVzb2x1dGlvbkRldGFpbE1hcCwgbmV3IFVSTCh0aGlzLl9wYWNrTG9hZGVyLnJlc29sdXRpb25EZXRhaWxNYXBVUkwsIHBhY2tSZXNvdXJjZUJhc2VVUkwpLmhyZWYpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ludmFsaWRhdGVBbGxNb2R1bGVzKCkge1xuICAgICAgICBjb25zdCBjYyA9IGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjJykgYXMgRW5naW5lRXhwb3J0cztcblxuICAgICAgICBmb3IgKGNvbnN0IHJlZ2lzdGVyZWRDbGFzcyBvZiB0aGlzLl9yZWdpc3RlcmVkQ2xhc3Nlcykge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyhyZWdpc3RlcmVkQ2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2MuanMudW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBVbnJlZ2lzdGVyICR7cmVnaXN0ZXJlZENsYXNzLm5hbWV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMgPSBbXTtcblxuICAgICAgICB0aGlzLl9jbGFzc1V1aWRNYXAgPSB7fTtcblxuICAgICAgICBjYy5jY2xlZ2FjeS5fUkYucmVzZXQoKTtcblxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGFja01vZHMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGFja01vZHMoKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGFja01vZElkIG9mIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBJbnZhbGlkYXRpbmcgJyR7cGFja01vZElkfSdgKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFN5c3RlbS5kZWxldGUocGFja01vZElkKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgTm90ZTogZmFpbGVkIHRvIGRlbGV0ZSAke3BhY2tNb2RJZH0sIG1heWJlIGl0J3MgYmVpbmcgZXhlY3V0aW5nP2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzLmxlbmd0aCA9IDA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfaW1wb3J0UHJlcmVxdWlzaXRlTW9kdWxlcygpIHtcbiAgICAgICAgY29uc3QgY2MgPSBhd2FpdCBTeXN0ZW0uaW1wb3J0KCdjYycpIGFzIEVuZ2luZUV4cG9ydHM7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjZTovaW50ZXJuYWwveC9wcmVyZXF1aXNpdGUtaW1wb3J0cycpO1xuICAgICAgICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICAgICAgICAgIHRoaXMuX2ltcG9ydEV4Y2VwdGlvbkhhbmRsZXIoZXJyKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlZEV4Y2VwdGlvbnMuY2xlYXIoKTtcbiAgICAgICAgICAgIC8vIOmhueebruiEmuacrOWPr+iDveWcqOaJp+ihjOeahOaXtuWAmeS8muaKm+WHuuW8guW4uO+8jOi/meWvvOiHtCBgY2MuX1JGYCDmsqHmnInmraPnoa7lvLnlh7rjgIJcbiAgICAgICAgICAgIC8vIOaIkeS7rOWcqOacgOWQjua4heeQhuS4gOS4i+OAglxuICAgICAgICAgICAgY2MuY2NsZWdhY3kuX1JGLnJlc2V0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9sb2FkQWxsUGx1Z2lucygpIHtcbiAgICAgICAgY29uc3QgcGx1Z2luU2NyaXB0RGVwZW5kZW5jeU1hcDogQXJyYXk8W3N0cmluZywgcmVhZG9ubHkgc3RyaW5nW11dPiA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IFtwbHVnaW5TY3JpcHRJZCwgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXModGhpcy5fcGx1Z2lucykpIHtcbiAgICAgICAgICAgIHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXAucHVzaChbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm8uZGVwZW5kZW5jaWVzXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc29ydGVkID0gc29ydFBsdWdpblNjcmlwdHMocGx1Z2luU2NyaXB0RGVwZW5kZW5jeU1hcCk7XG4gICAgICAgIGNvbnN0IHNvcnRlZE1hcHBlZCA9IHNvcnRlZC5tYXAoKHBsdWdpblNjcmlwdElkKSA9PiB0aGlzLl9wbHVnaW5zW3BsdWdpblNjcmlwdElkXS5maWxlKTtcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIHNvcnRlZE1hcHBlZCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXF1aXJlKGZpbGUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2ludmFsaWRhdGVBbGxQbHVnaW5zKCkge1xuICAgICAgICBmb3IgKGNvbnN0IFssIHBsdWdpblNjcmlwdEluZm9dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX3BsdWdpbnMpKSB7XG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtwbHVnaW5TY3JpcHRJbmZvLmZpbGVdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdHJ5TG9nPENhdCBleHRlbmRzIGtleW9mIEV4ZWN1dG9yLkxvZ2dlcj4oY2F0OiBDYXQsIC4uLmFyZ3M6IFBhcmFtZXRlcnM8Tm9uTnVsbGFibGU8RXhlY3V0b3IuTG9nZ2VyW0NhdF0+Pikge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJldHVybiAoY2F0IGluIHRoaXMuX2xvZ2dlcikgPyB0aGlzLl9sb2dnZXJbY2F0XSEoLi4uYXJncykgOiB0aGlzLl9kZWZhdWx0TG9nKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2RlZmF1bHRMb2coLi4uYXJnczogYW55KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX29uTW9kdWxlTG9hZGVkKGVycm9yOiBFcnJvciwgaWQ6IHN0cmluZywgZGVwZW5kZW5jaWVzPzogc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3QgY2FjaGVkRXhjZXB0aW9ucyA9IHRoaXMuX2NhY2hlZEV4Y2VwdGlvbnM7XG4gICAgICAgIGlmICghZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBNb2R1bGUgXCIke2lkfVwiIGxvYWRlZC5gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghY2FjaGVkRXhjZXB0aW9ucy5oYXMoZXJyb3IpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5faW1wb3J0RXhjZXB0aW9uSGFuZGxlcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl90cnlMb2coJ2xvYWRFeGNlcHRpb24nLCBpZCwgZXJyb3IsIGNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSk7XG4gICAgICAgICAgICBjYWNoZWRFeGNlcHRpb25zLnNldChlcnJvciwgaWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWNsYXJlIF9wYWNrTW9kSW5zdGFudGlhdGlvbjogUGFja01vZEluc3RhbnRpYXRpb247XG5cbiAgICBwcml2YXRlIF9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3M/OiBFeGVjdXRvci5CZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XG4gICAgcHJpdmF0ZSBfY2FjaGVkRXhjZXB0aW9uczogTWFwPGFueSwgc3RyaW5nPiA9IG5ldyBNYXAoKTtcbiAgICBwcml2YXRlIF9jbGFzc1V1aWRNYXA6IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uW10+ID0ge307XG4gICAgcHJpdmF0ZSBfbG9nZ2VyOiBQYXJ0aWFsPEV4ZWN1dG9yLkxvZ2dlcj47XG4gICAgcHJpdmF0ZSBfYnVpbHRpbk1vZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIHByaXZhdGUgX2ltcG9ydEV4Y2VwdGlvbkhhbmRsZXI6IEltcG9ydEV4Y2VwdGlvbkhhbmRsZXI7XG5cbiAgICBwcml2YXRlIF9lZGl0b3JTeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xuICAgIHByaXZhdGUgX21vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZVNjcmlwdEluZm8+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBwcml2YXRlIF9yZWdpc3RlcmVkQ2xhc3NlczogRnVuY3Rpb25bXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfcGx1Z2luczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPiA9IHt9O1xuXG4gICAgcHJpdmF0ZSBfZml4ZWRJbXBvcnRNYXA6IHsgaW1wb3J0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9ID0geyBpbXBvcnRzOiB7fSB9O1xuICAgIHByaXZhdGUgX2VuZ2luZUltcG9ydE1hcFVSTCA9ICcnO1xuXG4gICAgcHJpdmF0ZSBfcGFja0xvYWRlcjogUXVpY2tQYWNrTG9hZGVyO1xuICAgIHByaXZhdGUgX2luc3RhbnRpYXRlZFBhY2tNb2RzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgX2NjZU1vZHVsZU1hcDogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xufVxuXG5leHBvcnQgbmFtZXNwYWNlIEV4ZWN1dG9yIHtcbiAgICBleHBvcnQgdHlwZSBCZWZvcmVVbnJlZ2lzdGVyQ2xhc3MgPSAoY2xhc3NDb25zdHJ1Y3RvcjogRnVuY3Rpb24pID0+IHZvaWQ7XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIFJlcG9ydGVyTWFwIHtcbiAgICAgICAgWydwb3NzaWJsZS1jci11c2UnXToge1xuICAgICAgICAgICAgaW1wb3J0ZWQ6IHN0cmluZztcbiAgICAgICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZztcbiAgICAgICAgICAgIGltcG9ydE1ldGE6IGFueTtcbiAgICAgICAgICAgIGV4dHJhczogYW55O1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGV4cG9ydCB0eXBlIExvZ2dlciA9IFBhcnRpYWw8e1xuICAgICAgICBwb3NzaWJsZUNpcmN1bGFyUmVmZXJlbmNlOiAoXG4gICAgICAgICAgICBpbXBvcnRlZDogc3RyaW5nLFxuICAgICAgICAgICAgbW9kdWxlUmVxdWVzdDogc3RyaW5nLFxuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55LFxuICAgICAgICAgICAgZXh0cmFzOiBhbnlcbiAgICAgICAgKSA9PiB2b2lkO1xuXG4gICAgICAgIGxvYWRFeGNlcHRpb246IChcbiAgICAgICAgICAgIG1vZHVsZVVybDogc3RyaW5nLFxuICAgICAgICAgICAgZXJyb3I/OiBhbnksXG4gICAgICAgICAgICBoYXNCZWVuVGhyb3duPzogYm9vbGVhbixcbiAgICAgICAgKSA9PiB2b2lkO1xuICAgIH0+O1xuXG4gICAgZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgICAgICAgaW1wb3J0RW5naW5lTW9kOiBJbXBvcnRFbmdpbmVNb2Q7XG4gICAgICAgIHF1aWNrUGFja0xvYWRlckNvbnRleHQ6IExvYWRlckNvbnRleHQ7XG4gICAgICAgIGJlZm9yZVVucmVnaXN0ZXJDbGFzcz86IEJlZm9yZVVucmVnaXN0ZXJDbGFzcztcbiAgICAgICAgcGFja01vZHVsZUV2YWx1YXRvcj86IFBhY2tNb2R1bGVFdmFsdWF0b3I7XG4gICAgICAgIGxvZ2dlcj86IExvZ2dlcjtcbiAgICAgICAgaW1wb3J0RXhjZXB0aW9uSGFuZGxlcj86IChlcnI6IHVua25vd24pID0+IHZvaWQ7XG4gICAgICAgIGNjZU1vZHVsZU1hcDogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICB9XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVJbmZvIHtcbiAgICAgICAgcG9seWZpbGxzOiBzdHJpbmdbXTtcbiAgICAgICAgbW9kdWxlczogc3RyaW5nW107XG4gICAgICAgIGJhcmVTcGVjaWZpZXJSZXNvbHZlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgICAgICBpbnN0YW50aWF0ZU1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICB9XG59XG5cbnR5cGUgUGx1Z2luU2NyaXB0SWQgPSBzdHJpbmc7XG5cbmludGVyZmFjZSBQbHVnaW5TY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDohJrmnKzmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDkvp3otZbnmoTmj5Lku7bohJrmnKzjgIJcbiAgICAgKi9cbiAgICBkZXBlbmRlbmNpZXM6IFBsdWdpblNjcmlwdElkW107XG59XG5cbmludGVyZmFjZSBNb2R1bGVTY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDmqKHlnZcgVVJM44CCXG4gICAgICovXG4gICAgbW9kdWxlVXJsOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDku6PnoIHmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFbmdpbmVFeHBvcnRzIHtcbiAgICBjY2xlZ2FjeTogeyBfUkY6IHsgcmVzZXQoKTogdm9pZDsgfSB9O1xuICAgIGpzOiB7IHVucmVnaXN0ZXJDbGFzcyhmOiBGdW5jdGlvbik6IHZvaWQ7IH07XG59XG5cbmRlY2xhcmUgbmFtZXNwYWNlIEVkaXRvckV4dGVuZHMge1xuICAgIGludGVyZmFjZSBFdmVudE1hcCB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDYWxsZWQgd2hlbiBhIGNjLWNsYXNzIGlzIHJlZ2lzdGVyZWQuXG4gICAgICAgICAqIEBwYXJhbSBjbGFzc0NvbnN0cnVjdG9yIFJlZ2lzdGVyaW5nIGNsYXNzLlxuICAgICAgICAgKi9cbiAgICAgICAgJ2NsYXNzLXJlZ2lzdGVyZWQnKGNsYXNzQ29uc3RydWN0b3I6IEZ1bmN0aW9uLCBtZXRhZGF0YT86IFJlYWRvbmx5PGFueT4pOiB2b2lkO1xuICAgIH1cblxuICAgIHR5cGUgRXZlbnRBcmdzPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9IFBhcmFtZXRlcnM8RXZlbnRNYXBbRXZlbnROYW1lXT47XG5cbiAgICB0eXBlIExpc3RlbmVyPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9ICguLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPikgPT4gdm9pZDtcblxuICAgIGZ1bmN0aW9uIGVtaXQ8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgLi4uYXJnczogRXZlbnRBcmdzPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gb248RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xufVxuIl19