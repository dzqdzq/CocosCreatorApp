"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("../mod-assembling/quick-pack/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineEditorExportsPrefix = `cce:/internal/x/editor-exports/`;
class Executor {
    constructor(quickPackLoaderContext) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        this._packModsImportMapURL = new url_1.URL('pack:///import-map.json');
        const packModulesDirFromImportMap = './mods/';
        this._packModsDirURL = new url_1.URL(packModulesDirFromImportMap, this._packModsImportMapURL);
        this._packModsDirPrefix = this._packModsDirURL.href;
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext, {
            importMapBasedRoot: packModulesDirFromImportMap,
        });
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem);
    }
    static async create(options) {
        const executor = new Executor(options.quickPackLoaderContext);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineEditorExportsPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineEditorExportsPrefix)) {
                quickCompilerRequest = url.substr(engineEditorExportsPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: () => {
                                const exports = importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(this._packModsDirPrefix)) {
                const link = url.substr(this._packModsDirPrefix.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        await this._reloadPackMods();
        console.groupCollapsed(`Invalidate all modules`);
        await this._invalidateAllModules();
        console.groupEnd();
        this._invalidateAllPlugins();
        this._loadAllPlugins();
        console.groupCollapsed(`Imports all modules`);
        await this._importPrerequisiteModules();
        console.groupEnd();
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, this._packModsImportMapURL.href);
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            console.warn(err);
        }
        finally {
            this._cachedExceptions.clear();
            EditorExtends.removeListener('class-registered', onClassRegistered);
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                console.error(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQTBEO0FBQzFELHdEQUF3RTtBQUN4RSw2QkFBMEI7QUFFMUIsZ0VBQXNFO0FBQ3RFLHFFQUFnRTtBQUtoRSxlQUFlO0FBQ2YsTUFBTSxjQUFjLEdBQUcsb0JBQW9CLENBQUM7QUFDNUMsbUJBQW1CO0FBQ25CLE1BQU0sd0JBQXdCLEdBQUcsd0JBQXdCLENBQUM7QUFDMUQsc0JBQXNCO0FBQ3RCLE1BQU0seUJBQXlCLEdBQUcsaUNBQWlDLENBQUM7QUFFcEUsTUFBYSxRQUFRO0lBT2pCLFlBQW9CLHNCQUFxQztRQTRQakQsc0JBQWlCLEdBQXFCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEQsa0JBQWEsR0FBK0IsRUFBRSxDQUFDO1FBRS9DLGlCQUFZLEdBQTJCLEVBQUUsQ0FBQztRQUcxQyxhQUFRLEdBQXFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakUsdUJBQWtCLEdBQWUsRUFBRSxDQUFDO1FBRXBDLGFBQVEsR0FBNkMsRUFBRSxDQUFDO1FBRXhELG9CQUFlLEdBQXdDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQ3ZFLHdCQUFtQixHQUFXLEVBQUUsQ0FBQztRQUtqQywwQkFBcUIsR0FBYSxFQUFFLENBQUM7UUE1UXpDLElBQUksQ0FBQyxhQUFhLEdBQUcsb0NBQWtCLENBQUM7UUFDeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksU0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDaEUsTUFBTSwyQkFBMkIsR0FBRyxTQUFTLENBQUM7UUFDOUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLFNBQUcsQ0FBQywyQkFBMkIsRUFBRSxJQUFJLENBQUMscUJBQXFCLENB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QVUsRUFBRSxZQUF1QjtRQUNyRSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztRQUNoRCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN4QjtZQUNELElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDdEUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNuQztJQUNMLENBQUM7Q0F1Qko7QUFyUkQsNEJBcVJDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBzb3J0UGx1Z2luU2NyaXB0cyB9IGZyb20gJy4vc29ydC1wbHVnaW4tc2NyaXB0cyc7XG5pbXBvcnQgeyBFeGVjdXRvclN5c3RlbSwgZ2xvYmFsRWRpdG9yU3lzdGVtIH0gZnJvbSAnLi4vZWRpdG9yLXN5c3RlbWpzJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBMb2FkZXJDb250ZXh0IH0gZnJvbSAnLi4vbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay91dGlscy9sb2FkZXItY29udGV4dCc7XG5pbXBvcnQgeyBRdWlja1BhY2tMb2FkZXIgfSBmcm9tICcuLi9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL2xvYWRlcic7XG5pbXBvcnQgeyBQYWNrTW9kSW5zdGFudGlhdGlvbiB9IGZyb20gJy4vcGFjay1tb2QtaW5zdGFudGlhdGlvbic7XG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XG5cbnR5cGUgSW1wb3J0RW5naW5lTW9kID0gKGlkOiBzdHJpbmcpID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4vLyBgJ2NjJ2Ag55qEIFVSTFxuY29uc3QgZW5naW5lSW5kZXhVUkwgPSBgY2NlOi9pbnRlcm5hbC94L2NjYDtcbi8vIOW8leaTjuWKn+iDveWNleWFg+aooeWdl+eahCBVUkwg5YmN57yAXG5jb25zdCBlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXggPSBgY2NlOi9pbnRlcm5hbC94L2NjLWZ1L2A7XG4vLyDlvJXmk47lhazlvIDoh7PnvJbovpHlmajnmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxuY29uc3QgZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvZWRpdG9yLWV4cG9ydHMvYDtcblxuZXhwb3J0IGNsYXNzIEV4ZWN1dG9yIHtcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBFeGVjdXRvci5PcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gbmV3IEV4ZWN1dG9yKG9wdGlvbnMucXVpY2tQYWNrTG9hZGVyQ29udGV4dCk7XG4gICAgICAgIGF3YWl0IGV4ZWN1dG9yLl9pbml0aWFsaXplKG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gZXhlY3V0b3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0KSB7XG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbSA9IGdsb2JhbEVkaXRvclN5c3RlbTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0ge307XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzSW1wb3J0TWFwVVJMID0gbmV3IFVSTCgncGFjazovLy9pbXBvcnQtbWFwLmpzb24nKTtcbiAgICAgICAgY29uc3QgcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwID0gJy4vbW9kcy8nO1xuICAgICAgICB0aGlzLl9wYWNrTW9kc0RpclVSTCA9IG5ldyBVUkwocGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLCB0aGlzLl9wYWNrTW9kc0ltcG9ydE1hcFVSTCk7XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzRGlyUHJlZml4ID0gdGhpcy5fcGFja01vZHNEaXJVUkwuaHJlZjtcblxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXIgPSBuZXcgUXVpY2tQYWNrTG9hZGVyKHF1aWNrUGFja0xvYWRlckNvbnRleHQsIHtcbiAgICAgICAgICAgIGltcG9ydE1hcEJhc2VkUm9vdDogcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24gPSBuZXcgUGFja01vZEluc3RhbnRpYXRpb24ocXVpY2tQYWNrTG9hZGVyLCB0aGlzLl9lZGl0b3JTeXN0ZW0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2luaXRpYWxpemUob3B0aW9uczogRXhlY3V0b3IuT3B0aW9ucykge1xuICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcbiAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IG9wdGlvbnMuYmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKG9wdGlvbnMuaW1wb3J0RW5naW5lTW9kKTtcblxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYyddID0gZW5naW5lSW5kZXhVUkw7XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjL2VudiddID0gYCR7ZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeH1jYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcbiAgICAgICAgLy8gVE9ETzogZGVwcmVjYXRlZCBjY2UuZW52IGlzIG9ubHkgbGl2ZSBpbiAzLjAtcHJldmlld1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjY2UuZW52J10gPSB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy9lbnYnXTtcblxuICAgICAgICBjb25zdCB2ZW5kZXJPbkxvYWQgPSBTeXN0ZW0uY29uc3RydWN0b3IucHJvdG90eXBlLm9ubG9hZDtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIFN5c3RlbS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUub25sb2FkID0gZnVuY3Rpb24oLi4uYXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnX29uTW9kdWxlTG9hZGVkJ10+KSB7XG4gICAgICAgICAgICBzZWxmLl9vbk1vZHVsZUxvYWRlZCguLi5hcmdzKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmVuZGVyT25Mb2FkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgdmVuZGVyT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gb3B0aW9ucy5sb2dnZXIgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKGltcG9ydGVyOiBJbXBvcnRFbmdpbmVNb2QpIHtcbiAgICAgICAgLy8g5aSE55CG5byV5pOO5qih5Z2X55qE5a6e5L6L5YyWXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcihhc3luYyAodXJsKSA9PiB7XG4gICAgICAgICAgICBsZXQgcXVpY2tDb21waWxlclJlcXVlc3Q6IHN0cmluZyA9ICcnO1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKGVuZ2luZUZlYXR1cmVVbml0c1ByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodXJsLnN0YXJ0c1dpdGgoZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybC5zdWJzdHIoZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtbXSwgKF9leHBvcnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBvcnRzID0gaW1wb3J0ZXIocXVpY2tDb21waWxlclJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyDlpITnkIYgUGFja2VyIOmHjOeahOaooeWdl+eahOWunuS+i+WMllxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKHRoaXMuX3BhY2tNb2RzRGlyUHJlZml4KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmsgPSB1cmwuc3Vic3RyKHRoaXMuX3BhY2tNb2RzRGlyUHJlZml4Lmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5pbnN0YW50aWF0ZShsaW5rKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW50aWF0ZWRQYWNrTW9kcy5wdXNoKHVybCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUG9seWZpbGxGaWxlKGZpbGU6IHN0cmluZykge1xuICAgICAgICByZXF1aXJlKGZpbGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOivu+WPliBQYWNrZXIg55qE5YaF5a655bm26YeN5paw5omn6KGM5omA5pyJ6aG555uu6ISa5pys5ZKM5o+S5Lu26ISa5pys44CCXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcmVsb2FkUGFja01vZHMoKTtcblxuICAgICAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKGBJbnZhbGlkYXRlIGFsbCBtb2R1bGVzYCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcblxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuXG4gICAgICAgIHRoaXMuX2xvYWRBbGxQbHVnaW5zKCk7XG5cbiAgICAgICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgSW1wb3J0cyBhbGwgbW9kdWxlc2ApO1xuICAgICAgICBhd2FpdCB0aGlzLl9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgaG90UmVsb2FkUGx1Z2luU2NyaXB0cyh7XG4gICAgICAgIGNoYW5nZXMsXG4gICAgICAgIHJlbW92YWxzLFxuICAgIH06IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOaJgOacieimgeS/ruaUueeahO+8iOaIluaWsOWinueahO+8ieaPkuS7tuiEmuacrOOAglxuICAgICAgICAgKi9cbiAgICAgICAgY2hhbmdlczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPlxuICAgICAgICAvKipcbiAgICAgICAgICog5omA5pyJ6KaB56e76Zmk55qE5o+S5Lu26ISa5pys44CCXG4gICAgICAgICAqL1xuICAgICAgICByZW1vdmFsczogUGx1Z2luU2NyaXB0SWRbXTtcbiAgICB9KSB7XG4gICAgICAgIGlmIChPYmplY3Qua2V5cyhjaGFuZ2VzKS5sZW5ndGggPT09IDAgJiYgcmVtb3ZhbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xuXG4gICAgICAgIC8vIOW6lOeUqOS/ruaUuVxuICAgICAgICBmb3IgKGNvbnN0IHJlbW92YWwgb2YgcmVtb3ZhbHMpIHtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9wbHVnaW5zW3JlbW92YWxdO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm9dIG9mIE9iamVjdC5lbnRyaWVzKGNoYW5nZXMpKSB7XG4gICAgICAgICAgICB0aGlzLl9wbHVnaW5zW3BsdWdpblNjcmlwdElkXSA9IHBsdWdpblNjcmlwdEluZm87XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLl9sb2FkQWxsUGx1Z2lucygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc01vZHVsZShpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBpZCBpbiB0aGlzLl9tb2R1bGVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjbGVhcigpIHtcbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBsdWdpbnMoKTtcbiAgICAgICAgdGhpcy5fcGx1Z2lucyA9IHt9O1xuICAgICAgICBhd2FpdCB0aGlzLl9pbnZhbGlkYXRlQWxsTW9kdWxlcygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOafpeaJvuaMh+WumuiEmuacrOaooeWdl+S4reazqOWGjOeahOaJgOaciSBjYyDnsbvjgIJcbiAgICAgKiBAcGFyYW0gdXVpZCDmqKHlnZfnmoQgdXVpZOOAglxuICAgICAqIEByZXR1cm5zIOaMh+WumuiEmuacrOaooeWdl+S4reazqOWGjOeahOaJgOaciSBjYyDnsbvvvJvlpoLmnpwgW3V1aWRdIOW5tuS4jeWvueW6lOS4gOS4quaooeWdl+aIluaooeWdl+S4reacquazqOWGjOS7u+S9leexu+WImei/lOWbniBgdW5kZWZpbmVkYOOAglxuICAgICAqL1xuICAgIHB1YmxpYyBxdWVyeUNsYXNzZXNJbk1vZHVsZSh1dWlkOiBzdHJpbmcpOiB1bmRlZmluZWQgfCBSZWFkb25seUFycmF5PFJlYWRvbmx5PEZ1bmN0aW9uPj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fY2xhc3NVdWlkTWFwW3V1aWRdO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX3JlbG9hZFBhY2tNb2RzKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5yZWxvYWQoKTtcblxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uY2xlYXJJbXBvcnRNYXAoKTtcblxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXJJbXBvcnRNYXAgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5nZXRJbXBvcnRNYXAoKTtcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmV4dGVuZEltcG9ydE1hcChxdWlja1BhY2tMb2FkZXJJbXBvcnRNYXAsIHRoaXMuX3BhY2tNb2RzSW1wb3J0TWFwVVJMLmhyZWYpO1xuXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5leHRlbmRJbXBvcnRNYXAodGhpcy5fZml4ZWRJbXBvcnRNYXAsIHRoaXMuX2VuZ2luZUltcG9ydE1hcFVSTCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfaW52YWxpZGF0ZUFsbE1vZHVsZXMoKSB7XG4gICAgICAgIGNvbnN0IGNjID0gYXdhaXQgU3lzdGVtLmltcG9ydCgnY2MnKSBhcyBFbmdpbmVFeHBvcnRzO1xuXG4gICAgICAgIGZvciAoY29uc3QgcmVnaXN0ZXJlZENsYXNzIG9mIHRoaXMuX3JlZ2lzdGVyZWRDbGFzc2VzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYy5qcy51bnJlZ2lzdGVyQ2xhc3MocmVnaXN0ZXJlZENsYXNzKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFVucmVnaXN0ZXIgJHtyZWdpc3RlcmVkQ2xhc3MubmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3NlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuX2NsYXNzVXVpZE1hcCA9IHt9O1xuXG4gICAgICAgIGNjLmNjbGVnYWN5Ll9SRi5yZXNldCgpO1xuXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ludmFsaWRhdGVBbGxQYWNrTW9kcygpIHtcbiAgICAgICAgZm9yIChjb25zdCBwYWNrTW9kSWQgb2YgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYEludmFsaWRhdGluZyAnJHtwYWNrTW9kSWR9J2ApO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gU3lzdGVtLmRlbGV0ZShwYWNrTW9kSWQpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBOb3RlOiBmYWlsZWQgdG8gZGVsZXRlICR7cGFja01vZElkfSwgbWF5YmUgaXQncyBiZWluZyBleGVjdXRpbmc/YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMubGVuZ3RoID0gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCkge1xuICAgICAgICBjb25zdCBvbkNsYXNzUmVnaXN0ZXJlZDogRWRpdG9yRXh0ZW5kcy5MaXN0ZW5lcjwnY2xhc3MtcmVnaXN0ZXJlZCc+ID0gKGNsYXNzQ29uc3RydWN0b3IsIG1ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3Nlcy5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgW1tFeGVjdXRvcl1dIFJlZ2lzdGVyICR7Y2xhc3NDb25zdHJ1Y3Rvci5uYW1lfWApO1xuICAgICAgICAgICAgaWYgKG1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgKHRoaXMuX2NsYXNzVXVpZE1hcFttZXRhZGF0YS51dWlkXSA/Pz0gW10pLnB1c2goY2xhc3NDb25zdHJ1Y3Rvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgRWRpdG9yRXh0ZW5kcy5vbignY2xhc3MtcmVnaXN0ZXJlZCcsIG9uQ2xhc3NSZWdpc3RlcmVkKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgU3lzdGVtLmltcG9ydCgnY2NlOi9pbnRlcm5hbC94L3ByZXJlcXVpc2l0ZS1pbXBvcnRzJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGVycik7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRFeGNlcHRpb25zLmNsZWFyKCk7XG4gICAgICAgICAgICBFZGl0b3JFeHRlbmRzLnJlbW92ZUxpc3RlbmVyKCdjbGFzcy1yZWdpc3RlcmVkJywgb25DbGFzc1JlZ2lzdGVyZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfbG9hZEFsbFBsdWdpbnMoKSB7XG4gICAgICAgIGNvbnN0IHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXA6IEFycmF5PFtzdHJpbmcsIHJlYWRvbmx5IHN0cmluZ1tdXT4gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm9dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX3BsdWdpbnMpKSB7XG4gICAgICAgICAgICBwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwLnB1c2goW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvLmRlcGVuZGVuY2llc10pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNvcnRlZCA9IHNvcnRQbHVnaW5TY3JpcHRzKHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXApO1xuICAgICAgICBjb25zdCBzb3J0ZWRNYXBwZWQgPSBzb3J0ZWQubWFwKChwbHVnaW5TY3JpcHRJZCkgPT4gdGhpcy5fcGx1Z2luc1twbHVnaW5TY3JpcHRJZF0uZmlsZSk7XG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBzb3J0ZWRNYXBwZWQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZShmaWxlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGx1Z2lucygpIHtcbiAgICAgICAgZm9yIChjb25zdCBbLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xuICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcGx1Z2luU2NyaXB0SW5mby5maWxlXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3RyeUxvZzxDYXQgZXh0ZW5kcyBrZXlvZiBFeGVjdXRvci5Mb2dnZXI+KGNhdDogQ2F0LCAuLi5hcmdzOiBQYXJhbWV0ZXJzPE5vbk51bGxhYmxlPEV4ZWN1dG9yLkxvZ2dlcltDYXRdPj4pIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gKGNhdCBpbiB0aGlzLl9sb2dnZXIpID8gdGhpcy5fbG9nZ2VyW2NhdF0hKC4uLmFyZ3MpIDogdGhpcy5fZGVmYXVsdExvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kZWZhdWx0TG9nKC4uLmFyZ3M6IGFueSkge1xuICAgICAgICBjb25zb2xlLmxvZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vbk1vZHVsZUxvYWRlZChlcnJvcjogRXJyb3IsIGlkOiBzdHJpbmcsIGRlcGVuZGVuY2llcz86IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlZEV4Y2VwdGlvbnMgPSB0aGlzLl9jYWNoZWRFeGNlcHRpb25zO1xuICAgICAgICBpZiAoIWVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBbW0V4ZWN1dG9yXV0gTW9kdWxlIFwiJHtpZH1cIiBsb2FkZWQuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIWNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fdHJ5TG9nKCdsb2FkRXhjZXB0aW9uJywgaWQsIGVycm9yLCBjYWNoZWRFeGNlcHRpb25zLmhhcyhlcnJvcikpO1xuICAgICAgICAgICAgY2FjaGVkRXhjZXB0aW9ucy5zZXQoZXJyb3IsIGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVjbGFyZSBfcGFja01vZEluc3RhbnRpYXRpb246IFBhY2tNb2RJbnN0YW50aWF0aW9uO1xuXG4gICAgcHJpdmF0ZSBfYmVmb3JlVW5yZWdpc3RlckNsYXNzPzogRXhlY3V0b3IuQmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgIHByaXZhdGUgX2NhY2hlZEV4Y2VwdGlvbnM6IE1hcDxhbnksIHN0cmluZz4gPSBuZXcgTWFwKCk7XG4gICAgcHJpdmF0ZSBfY2xhc3NVdWlkTWFwOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbltdPiA9IHt9O1xuICAgIHByaXZhdGUgX2xvZ2dlcjogUGFydGlhbDxFeGVjdXRvci5Mb2dnZXI+O1xuICAgIHByaXZhdGUgX2J1aWx0aW5Nb2RzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cbiAgICBwcml2YXRlIF9lZGl0b3JTeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xuICAgIHByaXZhdGUgX21vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZVNjcmlwdEluZm8+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBwcml2YXRlIF9yZWdpc3RlcmVkQ2xhc3NlczogRnVuY3Rpb25bXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBfcGx1Z2luczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPiA9IHt9O1xuXG4gICAgcHJpdmF0ZSBfZml4ZWRJbXBvcnRNYXA6IHsgaW1wb3J0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9ID0geyBpbXBvcnRzOiB7fSB9O1xuICAgIHByaXZhdGUgX2VuZ2luZUltcG9ydE1hcFVSTDogc3RyaW5nID0gJyc7XG5cbiAgICBwcml2YXRlIF9wYWNrTW9kc0ltcG9ydE1hcFVSTDogUmVhZG9ubHk8VVJMPjtcbiAgICBwcml2YXRlIF9wYWNrTW9kc0RpclVSTDogUmVhZG9ubHk8VVJMPjtcbiAgICBwcml2YXRlIF9wYWNrTW9kc0RpclByZWZpeDogUmVhZG9ubHk8c3RyaW5nPjtcbiAgICBwcml2YXRlIF9pbnN0YW50aWF0ZWRQYWNrTW9kczogc3RyaW5nW10gPSBbXTtcbn1cblxuZXhwb3J0IG5hbWVzcGFjZSBFeGVjdXRvciB7XG4gICAgZXhwb3J0IHR5cGUgQmVmb3JlVW5yZWdpc3RlckNsYXNzID0gKGNsYXNzQ29uc3RydWN0b3I6IEZ1bmN0aW9uKSA9PiB2b2lkO1xuXG4gICAgZXhwb3J0IGludGVyZmFjZSBSZXBvcnRlck1hcCB7XG4gICAgICAgIFsncG9zc2libGUtY3ItdXNlJ106IHtcbiAgICAgICAgICAgIGltcG9ydGVkOiBzdHJpbmc7XG4gICAgICAgICAgICBtb2R1bGVSZXF1ZXN0OiBzdHJpbmc7XG4gICAgICAgICAgICBpbXBvcnRNZXRhOiBhbnk7XG4gICAgICAgICAgICBleHRyYXM6IGFueTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBleHBvcnQgdHlwZSBMb2dnZXIgPSBQYXJ0aWFsPHtcbiAgICAgICAgcG9zc2libGVDaXJjdWxhclJlZmVyZW5jZTogKFxuICAgICAgICAgICAgaW1wb3J0ZWQ6IHN0cmluZyxcbiAgICAgICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZyxcbiAgICAgICAgICAgIGltcG9ydE1ldGE6IGFueSxcbiAgICAgICAgICAgIGV4dHJhczogYW55XG4gICAgICAgICkgPT4gdm9pZDtcblxuICAgICAgICBsb2FkRXhjZXB0aW9uOiAoXG4gICAgICAgICAgICBtb2R1bGVVcmw6IHN0cmluZyxcbiAgICAgICAgICAgIGVycm9yPzogYW55LFxuICAgICAgICAgICAgaGFzQmVlblRocm93bj86IGJvb2xlYW4sXG4gICAgICAgICkgPT4gdm9pZDtcbiAgICB9PjtcblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gICAgICAgIGltcG9ydEVuZ2luZU1vZDogKGlkOiBzdHJpbmcpID0+IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICBxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0O1xuICAgICAgICBiZWZvcmVVbnJlZ2lzdGVyQ2xhc3M/OiBCZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XG4gICAgICAgIGxvZ2dlcj86IExvZ2dlcjtcbiAgICB9XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVJbmZvIHtcbiAgICAgICAgcG9seWZpbGxzOiBzdHJpbmdbXTtcbiAgICAgICAgbW9kdWxlczogc3RyaW5nW107XG4gICAgICAgIGJhcmVTcGVjaWZpZXJSZXNvbHZlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgICAgICBpbnN0YW50aWF0ZU1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICB9XG59XG5cbnR5cGUgUGx1Z2luU2NyaXB0SWQgPSBzdHJpbmc7XG5cbmludGVyZmFjZSBQbHVnaW5TY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDohJrmnKzmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDkvp3otZbnmoTmj5Lku7bohJrmnKzjgIJcbiAgICAgKi9cbiAgICBkZXBlbmRlbmNpZXM6IFBsdWdpblNjcmlwdElkW107XG59XG5cbmludGVyZmFjZSBNb2R1bGVTY3JpcHRJbmZvIHtcbiAgICAvKipcbiAgICAgKiDmqKHlnZcgVVJM44CCXG4gICAgICovXG4gICAgbW9kdWxlVXJsOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiDku6PnoIHmlofku7bjgIJcbiAgICAgKi9cbiAgICBmaWxlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFbmdpbmVFeHBvcnRzIHtcbiAgICBjY2xlZ2FjeTogeyBfUkY6IHsgcmVzZXQoKTogdm9pZDsgfSB9O1xuICAgIGpzOiB7IHVucmVnaXN0ZXJDbGFzcyhmOiBGdW5jdGlvbik6IHZvaWQ7IH07XG59XG5cbmRlY2xhcmUgbmFtZXNwYWNlIEVkaXRvckV4dGVuZHMge1xuICAgIGludGVyZmFjZSBFdmVudE1hcCB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDYWxsZWQgd2hlbiBhIGNjLWNsYXNzIGlzIHJlZ2lzdGVyZWQuXG4gICAgICAgICAqIEBwYXJhbSBjbGFzc0NvbnN0cnVjdG9yIFJlZ2lzdGVyaW5nIGNsYXNzLlxuICAgICAgICAgKi9cbiAgICAgICAgJ2NsYXNzLXJlZ2lzdGVyZWQnKGNsYXNzQ29uc3RydWN0b3I6IEZ1bmN0aW9uLCBtZXRhZGF0YT86IFJlYWRvbmx5PGFueT4pOiB2b2lkO1xuICAgIH1cblxuICAgIHR5cGUgRXZlbnRBcmdzPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9IFBhcmFtZXRlcnM8RXZlbnRNYXBbRXZlbnROYW1lXT47XG5cbiAgICB0eXBlIExpc3RlbmVyPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9ICguLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPikgPT4gdm9pZDtcblxuICAgIGZ1bmN0aW9uIGVtaXQ8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgLi4uYXJnczogRXZlbnRBcmdzPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gb248RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xufVxuIl19