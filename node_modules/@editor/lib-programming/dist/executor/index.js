"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const path_1 = __importDefault(require("path"));
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("../mod-assembling/quick-pack/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineEditorExportsPrefix = `cce:/internal/x/editor-exports/`;
// 项目路径相关 URL 前缀
const projectUrlPrefix = 'cce:/internal/x/project/';
class Executor {
    constructor(quickPackLoaderContext, packModuleEvaluator) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        this._packModsImportMapURL = new url_1.URL('pack:///import-map.json');
        const packModulesDirFromImportMap = './mods/';
        this._packModsDirURL = new url_1.URL(packModulesDirFromImportMap, this._packModsImportMapURL);
        this._packModsDirPrefix = this._packModsDirURL.href;
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext, {
            importMapBasedRoot: packModulesDirFromImportMap,
        });
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem, packModuleEvaluator);
    }
    static async create(options) {
        const executor = new Executor(options.quickPackLoaderContext, options.packModuleEvaluator);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineEditorExportsPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const projectCustomMacroURL = new url_1.URL('./temp/programming/custom-macro.js', projectUrlPrefix);
        this._fixedImportMap.imports['cc/userland/macro'] = projectCustomMacroURL.href;
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理项目里的自定义配置模块，比如 custom-macro 模块
        this._editorSystem.addInstantiationHandler((url) => {
            if (url.startsWith(projectUrlPrefix)) {
                let quickCompilerRequest = url.substr(projectUrlPrefix.length);
                quickCompilerRequest = path_1.default.join(Editor.Project.path, quickCompilerRequest);
                require(quickCompilerRequest);
                return this._editorSystem.getRegister();
            }
        });
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineEditorExportsPrefix)) {
                quickCompilerRequest = url.substr(engineEditorExportsPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: () => {
                                const exports = importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(this._packModsDirPrefix)) {
                const link = url.substr(this._packModsDirPrefix.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        await this._reloadPackMods();
        console.groupCollapsed(`Invalidate all modules`);
        await this._invalidateAllModules();
        console.groupEnd();
        this._invalidateAllPlugins();
        this._loadAllPlugins();
        console.groupCollapsed(`Imports all modules`);
        await this._importPrerequisiteModules();
        console.groupEnd();
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, this._packModsImportMapURL.href);
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            console.warn(err);
        }
        finally {
            this._cachedExceptions.clear();
            EditorExtends.removeListener('class-registered', onClassRegistered);
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                console.error(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXNCO0FBQ3RCLCtEQUEwRDtBQUMxRCx3REFBd0U7QUFDeEUsNkJBQTBCO0FBRTFCLGdFQUFzRTtBQUN0RSxxRUFBcUY7QUFLckYsZUFBZTtBQUNmLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO0FBQzVDLG1CQUFtQjtBQUNuQixNQUFNLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO0FBQzFELHNCQUFzQjtBQUN0QixNQUFNLHlCQUF5QixHQUFHLGlDQUFpQyxDQUFDO0FBQ3BFLGdCQUFnQjtBQUNoQixNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBRXBELE1BQWEsUUFBUTtJQU9qQixZQUFvQixzQkFBcUMsRUFBRSxtQkFBeUM7UUF1UTVGLHNCQUFpQixHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2hELGtCQUFhLEdBQStCLEVBQUUsQ0FBQztRQUUvQyxpQkFBWSxHQUEyQixFQUFFLENBQUM7UUFHMUMsYUFBUSxHQUFxQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pFLHVCQUFrQixHQUFlLEVBQUUsQ0FBQztRQUVwQyxhQUFRLEdBQTZDLEVBQUUsQ0FBQztRQUV4RCxvQkFBZSxHQUF3QyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUN2RSx3QkFBbUIsR0FBVyxFQUFFLENBQUM7UUFLakMsMEJBQXFCLEdBQWEsRUFBRSxDQUFDO1FBdlJ6QyxJQUFJLENBQUMsYUFBYSxHQUFHLG9DQUFrQixDQUFDO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLFNBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sMkJBQTJCLEdBQUcsU0FBUyxD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QU8sQ0FBQyxlQUFlLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUN0RSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ25DO0lBQ0wsQ0FBQztDQXVCSjtBQWhTRCw0QkFnU0MiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNvcnRQbHVnaW5TY3JpcHRzIH0gZnJvbSAnLi9zb3J0LXBsdWdpbi1zY3JpcHRzJztcbmltcG9ydCB7IEV4ZWN1dG9yU3lzdGVtLCBnbG9iYWxFZGl0b3JTeXN0ZW0gfSBmcm9tICcuLi9lZGl0b3Itc3lzdGVtanMnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tICcuLi9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL3V0aWxzL2xvYWRlci1jb250ZXh0JztcbmltcG9ydCB7IFF1aWNrUGFja0xvYWRlciB9IGZyb20gJy4uL21vZC1hc3NlbWJsaW5nL3F1aWNrLXBhY2svbG9hZGVyJztcbmltcG9ydCB7IFBhY2tNb2RJbnN0YW50aWF0aW9uLCBQYWNrTW9kdWxlRXZhbHVhdG9yIH0gZnJvbSAnLi9wYWNrLW1vZC1pbnN0YW50aWF0aW9uJztcbmltcG9ydCB7IGkxOG5UcmFuc2xhdGUgfSBmcm9tICcuLi91dGlscy9pMThuJztcblxudHlwZSBJbXBvcnRFbmdpbmVNb2QgPSAoaWQ6IHN0cmluZykgPT4gUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cbi8vIGAnY2MnYCDnmoQgVVJMXG5jb25zdCBlbmdpbmVJbmRleFVSTCA9IGBjY2U6L2ludGVybmFsL3gvY2NgO1xuLy8g5byV5pOO5Yqf6IO95Y2V5YWD5qih5Z2X55qEIFVSTCDliY3nvIBcbmNvbnN0IGVuZ2luZUZlYXR1cmVVbml0c1ByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvY2MtZnUvYDtcbi8vIOW8leaTjuWFrOW8gOiHs+e8lui+keWZqOeahOaooeWdl+eahCBVUkwg5YmN57yAXG5jb25zdCBlbmdpbmVFZGl0b3JFeHBvcnRzUHJlZml4ID0gYGNjZTovaW50ZXJuYWwveC9lZGl0b3ItZXhwb3J0cy9gO1xuLy8g6aG555uu6Lev5b6E55u45YWzIFVSTCDliY3nvIBcbmNvbnN0IHByb2plY3RVcmxQcmVmaXggPSAnY2NlOi9pbnRlcm5hbC94L3Byb2plY3QvJztcblxuZXhwb3J0IGNsYXNzIEV4ZWN1dG9yIHtcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBFeGVjdXRvci5PcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gbmV3IEV4ZWN1dG9yKG9wdGlvbnMucXVpY2tQYWNrTG9hZGVyQ29udGV4dCwgb3B0aW9ucy5wYWNrTW9kdWxlRXZhbHVhdG9yKTtcbiAgICAgICAgYXdhaXQgZXhlY3V0b3IuX2luaXRpYWxpemUob3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBleGVjdXRvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKHF1aWNrUGFja0xvYWRlckNvbnRleHQ6IExvYWRlckNvbnRleHQsIHBhY2tNb2R1bGVFdmFsdWF0b3I/OiBQYWNrTW9kdWxlRXZhbHVhdG9yKSB7XG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbSA9IGdsb2JhbEVkaXRvclN5c3RlbTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0ge307XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzSW1wb3J0TWFwVVJMID0gbmV3IFVSTCgncGFjazovLy9pbXBvcnQtbWFwLmpzb24nKTtcbiAgICAgICAgY29uc3QgcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwID0gJy4vbW9kcy8nO1xuICAgICAgICB0aGlzLl9wYWNrTW9kc0RpclVSTCA9IG5ldyBVUkwocGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLCB0aGlzLl9wYWNrTW9kc0ltcG9ydE1hcFVSTCk7XG4gICAgICAgIHRoaXMuX3BhY2tNb2RzRGlyUHJlZml4ID0gdGhpcy5fcGFja01vZHNEaXJVUkwuaHJlZjtcblxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXIgPSBuZXcgUXVpY2tQYWNrTG9hZGVyKHF1aWNrUGFja0xvYWRlckNvbnRleHQsIHtcbiAgICAgICAgICAgIGltcG9ydE1hcEJhc2VkUm9vdDogcGFja01vZHVsZXNEaXJGcm9tSW1wb3J0TWFwLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24gPSBuZXcgUGFja01vZEluc3RhbnRpYXRpb24ocXVpY2tQYWNrTG9hZGVyLCB0aGlzLl9lZGl0b3JTeXN0ZW0sIHBhY2tNb2R1bGVFdmFsdWF0b3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2luaXRpYWxpemUob3B0aW9uczogRXhlY3V0b3IuT3B0aW9ucykge1xuICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcbiAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IG9wdGlvbnMuYmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fYWRkSW5zdGFudGlhdGlvbkhhbmRsZXJzKG9wdGlvbnMuaW1wb3J0RW5naW5lTW9kKTtcblxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYyddID0gZW5naW5lSW5kZXhVUkw7XG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjL2VudiddID0gYCR7ZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeH1jYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcbiAgICAgICAgLy8gVE9ETzogZGVwcmVjYXRlZCBjY2UuZW52IGlzIG9ubHkgbGl2ZSBpbiAzLjAtcHJldmlld1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjY2UuZW52J10gPSB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy9lbnYnXTtcbiAgICAgICAgY29uc3QgcHJvamVjdEN1c3RvbU1hY3JvVVJMID0gbmV3IFVSTCgnLi90ZW1wL3Byb2dyYW1taW5nL2N1c3RvbS1tYWNyby5qcycsIHByb2plY3RVcmxQcmVmaXgpO1xuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy91c2VybGFuZC9tYWNybyddID0gcHJvamVjdEN1c3RvbU1hY3JvVVJMLmhyZWY7XG5cbiAgICAgICAgY29uc3QgdmVuZGVyT25Mb2FkID0gU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQ7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBTeXN0ZW0uY29uc3RydWN0b3IucHJvdG90eXBlLm9ubG9hZCA9IGZ1bmN0aW9uKC4uLmFyZ3M6IFBhcmFtZXRlcnM8RXhlY3V0b3JbJ19vbk1vZHVsZUxvYWRlZCddPikge1xuICAgICAgICAgICAgc2VsZi5fb25Nb2R1bGVMb2FkZWQoLi4uYXJncyk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHZlbmRlck9uTG9hZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHZlbmRlck9uTG9hZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IG9wdGlvbnMubG9nZ2VyIHx8IHt9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2FkZEluc3RhbnRpYXRpb25IYW5kbGVycyhpbXBvcnRlcjogSW1wb3J0RW5naW5lTW9kKSB7XG4gICAgICAgIC8vIOWkhOeQhumhueebrumHjOeahOiHquWumuS5iemFjee9ruaooeWdl++8jOavlOWmgiBjdXN0b20tbWFjcm8g5qih5Z2XXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcigodXJsKSA9PiB7XG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgocHJvamVjdFVybFByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmwuc3Vic3RyKHByb2plY3RVcmxQcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHBzLmpvaW4oRWRpdG9yLlByb2plY3QucGF0aCwgcXVpY2tDb21waWxlclJlcXVlc3QpO1xuICAgICAgICAgICAgICAgIHJlcXVpcmUocXVpY2tDb21waWxlclJlcXVlc3QpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3JTeXN0ZW0uZ2V0UmVnaXN0ZXIoKSBhcyBNb2R1bGVSZWdpc3RlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIOWkhOeQhuW8leaTjuaooeWdl+eahOWunuS+i+WMllxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgbGV0IHF1aWNrQ29tcGlsZXJSZXF1ZXN0OiBzdHJpbmcgPSAnJztcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmw7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVybC5zdGFydHNXaXRoKGVuZ2luZUVkaXRvckV4cG9ydHNQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmwuc3Vic3RyKGVuZ2luZUVkaXRvckV4cG9ydHNQcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChxdWlja0NvbXBpbGVyUmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBbW10sIChfZXhwb3J0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwb3J0cyA9IGltcG9ydGVyKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZXhwb3J0KGV4cG9ydHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8g5aSE55CGIFBhY2tlciDph4znmoTmqKHlnZfnmoTlrp7kvovljJZcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKGFzeW5jICh1cmwpID0+IHtcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCh0aGlzLl9wYWNrTW9kc0RpclByZWZpeCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5rID0gdXJsLnN1YnN0cih0aGlzLl9wYWNrTW9kc0RpclByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24uaW5zdGFudGlhdGUobGluayk7XG4gICAgICAgICAgICAgICAgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMucHVzaCh1cmwpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZFBvbHlmaWxsRmlsZShmaWxlOiBzdHJpbmcpIHtcbiAgICAgICAgcmVxdWlyZShmaWxlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDph43mlrDor7vlj5YgUGFja2VyIOeahOWGheWuueW5tumHjeaWsOaJp+ihjOaJgOaciemhueebruiEmuacrOWSjOaPkuS7tuiEmuacrOOAglxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyByZWxvYWQoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3JlbG9hZFBhY2tNb2RzKCk7XG5cbiAgICAgICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgSW52YWxpZGF0ZSBhbGwgbW9kdWxlc2ApO1xuICAgICAgICBhd2FpdCB0aGlzLl9pbnZhbGlkYXRlQWxsTW9kdWxlcygpO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG5cbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBsdWdpbnMoKTtcblxuICAgICAgICB0aGlzLl9sb2FkQWxsUGx1Z2lucygpO1xuXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEltcG9ydHMgYWxsIG1vZHVsZXNgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5faW1wb3J0UHJlcmVxdWlzaXRlTW9kdWxlcygpO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGhvdFJlbG9hZFBsdWdpblNjcmlwdHMoe1xuICAgICAgICBjaGFuZ2VzLFxuICAgICAgICByZW1vdmFscyxcbiAgICB9OiB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmiYDmnInopoHkv67mlLnnmoTvvIjmiJbmlrDlop7nmoTvvInmj5Lku7bohJrmnKzjgIJcbiAgICAgICAgICovXG4gICAgICAgIGNoYW5nZXM6IFJlY29yZDxQbHVnaW5TY3JpcHRJZCwgUGx1Z2luU2NyaXB0SW5mbz5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOaJgOacieimgeenu+mZpOeahOaPkuS7tuiEmuacrOOAglxuICAgICAgICAgKi9cbiAgICAgICAgcmVtb3ZhbHM6IFBsdWdpblNjcmlwdElkW107XG4gICAgfSkge1xuICAgICAgICBpZiAoT2JqZWN0LmtleXMoY2hhbmdlcykubGVuZ3RoID09PSAwICYmIHJlbW92YWxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBsdWdpbnMoKTtcblxuICAgICAgICAvLyDlupTnlKjkv67mlLlcbiAgICAgICAgZm9yIChjb25zdCByZW1vdmFsIG9mIHJlbW92YWxzKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fcGx1Z2luc1tyZW1vdmFsXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyhjaGFuZ2VzKSkge1xuICAgICAgICAgICAgdGhpcy5fcGx1Z2luc1twbHVnaW5TY3JpcHRJZF0gPSBwbHVnaW5TY3JpcHRJbmZvO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNNb2R1bGUoaWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gaWQgaW4gdGhpcy5fbW9kdWxlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgY2xlYXIoKSB7XG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XG4gICAgICAgIHRoaXMuX3BsdWdpbnMgPSB7fTtcbiAgICAgICAgYXdhaXQgdGhpcy5faW52YWxpZGF0ZUFsbE1vZHVsZXMoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmn6Xmib7mjIflrprohJrmnKzmqKHlnZfkuK3ms6jlhoznmoTmiYDmnIkgY2Mg57G744CCXG4gICAgICogQHBhcmFtIHV1aWQg5qih5Z2X55qEIHV1aWTjgIJcbiAgICAgKiBAcmV0dXJucyDmjIflrprohJrmnKzmqKHlnZfkuK3ms6jlhoznmoTmiYDmnIkgY2Mg57G777yb5aaC5p6cIFt1dWlkXSDlubbkuI3lr7nlupTkuIDkuKrmqKHlnZfmiJbmqKHlnZfkuK3mnKrms6jlhozku7vkvZXnsbvliJnov5Tlm54gYHVuZGVmaW5lZGDjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgcXVlcnlDbGFzc2VzSW5Nb2R1bGUodXVpZDogc3RyaW5nKTogdW5kZWZpbmVkIHwgUmVhZG9ubHlBcnJheTxSZWFkb25seTxGdW5jdGlvbj4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzVXVpZE1hcFt1dWlkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9yZWxvYWRQYWNrTW9kcygpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24ucmVsb2FkKCk7XG5cbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmNsZWFySW1wb3J0TWFwKCk7XG5cbiAgICAgICAgY29uc3QgcXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwID0gYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24uZ2V0SW1wb3J0TWFwKCk7XG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5leHRlbmRJbXBvcnRNYXAocXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwLCB0aGlzLl9wYWNrTW9kc0ltcG9ydE1hcFVSTC5ocmVmKTtcblxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uZXh0ZW5kSW1wb3J0TWFwKHRoaXMuX2ZpeGVkSW1wb3J0TWFwLCB0aGlzLl9lbmdpbmVJbXBvcnRNYXBVUkwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ludmFsaWRhdGVBbGxNb2R1bGVzKCkge1xuICAgICAgICBjb25zdCBjYyA9IGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjJykgYXMgRW5naW5lRXhwb3J0cztcblxuICAgICAgICBmb3IgKGNvbnN0IHJlZ2lzdGVyZWRDbGFzcyBvZiB0aGlzLl9yZWdpc3RlcmVkQ2xhc3Nlcykge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyhyZWdpc3RlcmVkQ2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2MuanMudW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBVbnJlZ2lzdGVyICR7cmVnaXN0ZXJlZENsYXNzLm5hbWV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMgPSBbXTtcblxuICAgICAgICB0aGlzLl9jbGFzc1V1aWRNYXAgPSB7fTtcblxuICAgICAgICBjYy5jY2xlZ2FjeS5fUkYucmVzZXQoKTtcblxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGFja01vZHMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGFja01vZHMoKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGFja01vZElkIG9mIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBJbnZhbGlkYXRpbmcgJyR7cGFja01vZElkfSdgKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFN5c3RlbS5kZWxldGUocGFja01vZElkKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgTm90ZTogZmFpbGVkIHRvIGRlbGV0ZSAke3BhY2tNb2RJZH0sIG1heWJlIGl0J3MgYmVpbmcgZXhlY3V0aW5nP2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzLmxlbmd0aCA9IDA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfaW1wb3J0UHJlcmVxdWlzaXRlTW9kdWxlcygpIHtcbiAgICAgICAgY29uc3Qgb25DbGFzc1JlZ2lzdGVyZWQ6IEVkaXRvckV4dGVuZHMuTGlzdGVuZXI8J2NsYXNzLXJlZ2lzdGVyZWQnPiA9IChjbGFzc0NvbnN0cnVjdG9yLCBtZXRhZGF0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMucHVzaChjbGFzc0NvbnN0cnVjdG9yKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBSZWdpc3RlciAke2NsYXNzQ29uc3RydWN0b3IubmFtZX1gKTtcbiAgICAgICAgICAgIGlmIChtZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgICh0aGlzLl9jbGFzc1V1aWRNYXBbbWV0YWRhdGEudXVpZF0gPz89IFtdKS5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIEVkaXRvckV4dGVuZHMub24oJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjZTovaW50ZXJuYWwveC9wcmVyZXF1aXNpdGUtaW1wb3J0cycpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihlcnIpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVkRXhjZXB0aW9ucy5jbGVhcigpO1xuICAgICAgICAgICAgRWRpdG9yRXh0ZW5kcy5yZW1vdmVMaXN0ZW5lcignY2xhc3MtcmVnaXN0ZXJlZCcsIG9uQ2xhc3NSZWdpc3RlcmVkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2xvYWRBbGxQbHVnaW5zKCkge1xuICAgICAgICBjb25zdCBwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwOiBBcnJheTxbc3RyaW5nLCByZWFkb25seSBzdHJpbmdbXV0+ID0gW107XG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xuICAgICAgICAgICAgcGx1Z2luU2NyaXB0RGVwZW5kZW5jeU1hcC5wdXNoKFtwbHVnaW5TY3JpcHRJZCwgcGx1Z2luU2NyaXB0SW5mby5kZXBlbmRlbmNpZXNdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzb3J0ZWQgPSBzb3J0UGx1Z2luU2NyaXB0cyhwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwKTtcbiAgICAgICAgY29uc3Qgc29ydGVkTWFwcGVkID0gc29ydGVkLm1hcCgocGx1Z2luU2NyaXB0SWQpID0+IHRoaXMuX3BsdWdpbnNbcGx1Z2luU2NyaXB0SWRdLmZpbGUpO1xuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2Ygc29ydGVkTWFwcGVkKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJlcXVpcmUoZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaW52YWxpZGF0ZUFsbFBsdWdpbnMoKSB7XG4gICAgICAgIGZvciAoY29uc3QgWywgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXModGhpcy5fcGx1Z2lucykpIHtcbiAgICAgICAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3BsdWdpblNjcmlwdEluZm8uZmlsZV07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF90cnlMb2c8Q2F0IGV4dGVuZHMga2V5b2YgRXhlY3V0b3IuTG9nZ2VyPihjYXQ6IENhdCwgLi4uYXJnczogUGFyYW1ldGVyczxOb25OdWxsYWJsZTxFeGVjdXRvci5Mb2dnZXJbQ2F0XT4+KSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmV0dXJuIChjYXQgaW4gdGhpcy5fbG9nZ2VyKSA/IHRoaXMuX2xvZ2dlcltjYXRdISguLi5hcmdzKSA6IHRoaXMuX2RlZmF1bHRMb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGVmYXVsdExvZyguLi5hcmdzOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5sb2coLi4uYXJncyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25Nb2R1bGVMb2FkZWQoZXJyb3I6IEVycm9yLCBpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM/OiBzdHJpbmdbXSkge1xuICAgICAgICBjb25zdCBjYWNoZWRFeGNlcHRpb25zID0gdGhpcy5fY2FjaGVkRXhjZXB0aW9ucztcbiAgICAgICAgaWYgKCFlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgW1tFeGVjdXRvcl1dIE1vZHVsZSBcIiR7aWR9XCIgbG9hZGVkLmApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFjYWNoZWRFeGNlcHRpb25zLmhhcyhlcnJvcikpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3RyeUxvZygnbG9hZEV4Y2VwdGlvbicsIGlkLCBlcnJvciwgY2FjaGVkRXhjZXB0aW9ucy5oYXMoZXJyb3IpKTtcbiAgICAgICAgICAgIGNhY2hlZEV4Y2VwdGlvbnMuc2V0KGVycm9yLCBpZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlY2xhcmUgX3BhY2tNb2RJbnN0YW50aWF0aW9uOiBQYWNrTW9kSW5zdGFudGlhdGlvbjtcblxuICAgIHByaXZhdGUgX2JlZm9yZVVucmVnaXN0ZXJDbGFzcz86IEV4ZWN1dG9yLkJlZm9yZVVucmVnaXN0ZXJDbGFzcztcbiAgICBwcml2YXRlIF9jYWNoZWRFeGNlcHRpb25zOiBNYXA8YW55LCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xuICAgIHByaXZhdGUgX2NsYXNzVXVpZE1hcDogUmVjb3JkPHN0cmluZywgRnVuY3Rpb25bXT4gPSB7fTtcbiAgICBwcml2YXRlIF9sb2dnZXI6IFBhcnRpYWw8RXhlY3V0b3IuTG9nZ2VyPjtcbiAgICBwcml2YXRlIF9idWlsdGluTW9kczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gICAgcHJpdmF0ZSBfZWRpdG9yU3lzdGVtOiBFeGVjdXRvclN5c3RlbTtcbiAgICBwcml2YXRlIF9tb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGVTY3JpcHRJbmZvPiA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgcHJpdmF0ZSBfcmVnaXN0ZXJlZENsYXNzZXM6IEZ1bmN0aW9uW10gPSBbXTtcblxuICAgIHByaXZhdGUgX3BsdWdpbnM6IFJlY29yZDxQbHVnaW5TY3JpcHRJZCwgUGx1Z2luU2NyaXB0SW5mbz4gPSB7fTtcblxuICAgIHByaXZhdGUgX2ZpeGVkSW1wb3J0TWFwOiB7IGltcG9ydHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gfSA9IHsgaW1wb3J0czoge30gfTtcbiAgICBwcml2YXRlIF9lbmdpbmVJbXBvcnRNYXBVUkw6IHN0cmluZyA9ICcnO1xuXG4gICAgcHJpdmF0ZSBfcGFja01vZHNJbXBvcnRNYXBVUkw6IFJlYWRvbmx5PFVSTD47XG4gICAgcHJpdmF0ZSBfcGFja01vZHNEaXJVUkw6IFJlYWRvbmx5PFVSTD47XG4gICAgcHJpdmF0ZSBfcGFja01vZHNEaXJQcmVmaXg6IFJlYWRvbmx5PHN0cmluZz47XG4gICAgcHJpdmF0ZSBfaW5zdGFudGlhdGVkUGFja01vZHM6IHN0cmluZ1tdID0gW107XG59XG5cbmV4cG9ydCBuYW1lc3BhY2UgRXhlY3V0b3Ige1xuICAgIGV4cG9ydCB0eXBlIEJlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IChjbGFzc0NvbnN0cnVjdG9yOiBGdW5jdGlvbikgPT4gdm9pZDtcblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgUmVwb3J0ZXJNYXAge1xuICAgICAgICBbJ3Bvc3NpYmxlLWNyLXVzZSddOiB7XG4gICAgICAgICAgICBpbXBvcnRlZDogc3RyaW5nO1xuICAgICAgICAgICAgbW9kdWxlUmVxdWVzdDogc3RyaW5nO1xuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55O1xuICAgICAgICAgICAgZXh0cmFzOiBhbnk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZXhwb3J0IHR5cGUgTG9nZ2VyID0gUGFydGlhbDx7XG4gICAgICAgIHBvc3NpYmxlQ2lyY3VsYXJSZWZlcmVuY2U6IChcbiAgICAgICAgICAgIGltcG9ydGVkOiBzdHJpbmcsXG4gICAgICAgICAgICBtb2R1bGVSZXF1ZXN0OiBzdHJpbmcsXG4gICAgICAgICAgICBpbXBvcnRNZXRhOiBhbnksXG4gICAgICAgICAgICBleHRyYXM6IGFueVxuICAgICAgICApID0+IHZvaWQ7XG5cbiAgICAgICAgbG9hZEV4Y2VwdGlvbjogKFxuICAgICAgICAgICAgbW9kdWxlVXJsOiBzdHJpbmcsXG4gICAgICAgICAgICBlcnJvcj86IGFueSxcbiAgICAgICAgICAgIGhhc0JlZW5UaHJvd24/OiBib29sZWFuLFxuICAgICAgICApID0+IHZvaWQ7XG4gICAgfT47XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICAgICAgICBpbXBvcnRFbmdpbmVNb2Q6IChpZDogc3RyaW5nKSA9PiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgcXVpY2tQYWNrTG9hZGVyQ29udGV4dDogTG9hZGVyQ29udGV4dDtcbiAgICAgICAgYmVmb3JlVW5yZWdpc3RlckNsYXNzPzogQmVmb3JlVW5yZWdpc3RlckNsYXNzO1xuICAgICAgICBwYWNrTW9kdWxlRXZhbHVhdG9yPzogUGFja01vZHVsZUV2YWx1YXRvcjtcbiAgICAgICAgbG9nZ2VyPzogTG9nZ2VyO1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgRXhlY3V0ZUluZm8ge1xuICAgICAgICBwb2x5ZmlsbHM6IHN0cmluZ1tdO1xuICAgICAgICBtb2R1bGVzOiBzdHJpbmdbXTtcbiAgICAgICAgYmFyZVNwZWNpZmllclJlc29sdmVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gICAgICAgIGluc3RhbnRpYXRlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICAgIH1cbn1cblxudHlwZSBQbHVnaW5TY3JpcHRJZCA9IHN0cmluZztcblxuaW50ZXJmYWNlIFBsdWdpblNjcmlwdEluZm8ge1xuICAgIC8qKlxuICAgICAqIOiEmuacrOaWh+S7tuOAglxuICAgICAqL1xuICAgIGZpbGU6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIOS+nei1lueahOaPkuS7tuiEmuacrOOAglxuICAgICAqL1xuICAgIGRlcGVuZGVuY2llczogUGx1Z2luU2NyaXB0SWRbXTtcbn1cblxuaW50ZXJmYWNlIE1vZHVsZVNjcmlwdEluZm8ge1xuICAgIC8qKlxuICAgICAqIOaooeWdlyBVUkzjgIJcbiAgICAgKi9cbiAgICBtb2R1bGVVcmw6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIOS7o+eggeaWh+S7tuOAglxuICAgICAqL1xuICAgIGZpbGU6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEVuZ2luZUV4cG9ydHMge1xuICAgIGNjbGVnYWN5OiB7IF9SRjogeyByZXNldCgpOiB2b2lkOyB9IH07XG4gICAganM6IHsgdW5yZWdpc3RlckNsYXNzKGY6IEZ1bmN0aW9uKTogdm9pZDsgfTtcbn1cblxuZGVjbGFyZSBuYW1lc3BhY2UgRWRpdG9yRXh0ZW5kcyB7XG4gICAgaW50ZXJmYWNlIEV2ZW50TWFwIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENhbGxlZCB3aGVuIGEgY2MtY2xhc3MgaXMgcmVnaXN0ZXJlZC5cbiAgICAgICAgICogQHBhcmFtIGNsYXNzQ29uc3RydWN0b3IgUmVnaXN0ZXJpbmcgY2xhc3MuXG4gICAgICAgICAqL1xuICAgICAgICAnY2xhc3MtcmVnaXN0ZXJlZCcoY2xhc3NDb25zdHJ1Y3RvcjogRnVuY3Rpb24sIG1ldGFkYXRhPzogUmVhZG9ubHk8YW55Pik6IHZvaWQ7XG4gICAgfVxuXG4gICAgdHlwZSBFdmVudEFyZ3M8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+ID0gUGFyYW1ldGVyczxFdmVudE1hcFtFdmVudE5hbWVdPjtcblxuICAgIHR5cGUgTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+ID0gKC4uLmFyZ3M6IEV2ZW50QXJnczxFdmVudE5hbWU+KSA9PiB2b2lkO1xuXG4gICAgZnVuY3Rpb24gZW1pdDxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCAuLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPik6IHZvaWQ7XG5cbiAgICBmdW5jdGlvbiBvbjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCBsaXN0ZW5lcjogTGlzdGVuZXI8RXZlbnROYW1lPik6IHZvaWQ7XG5cbiAgICBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCBsaXN0ZW5lcjogTGlzdGVuZXI8RXZlbnROYW1lPik6IHZvaWQ7XG59XG4iXX0=