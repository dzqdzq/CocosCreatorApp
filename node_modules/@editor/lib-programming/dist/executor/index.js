"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const path_1 = __importDefault(require("path"));
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("@cocos/creator-programming-quick-pack/lib/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineEditorExportsPrefix = `cce:/internal/x/editor-exports/`;
// 项目路径相关 URL 前缀
const projectUrlPrefix = 'cce:/internal/x/project/';
const packResourceBaseURL = new url_1.URL('pack:///');
const defaultImportExceptionHandler = (err) => {
    console.warn(err);
};
class Executor {
    constructor(quickPackLoaderContext, packModuleEvaluator, importExceptionHandler) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext);
        this._packLoader = quickPackLoader;
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem, packModuleEvaluator);
        this._importExceptionHandler = importExceptionHandler !== null && importExceptionHandler !== void 0 ? importExceptionHandler : defaultImportExceptionHandler;
    }
    static async create(options) {
        if (Executor._inst) {
            return Executor._inst;
        }
        const executor = Executor._inst = new Executor(options.quickPackLoaderContext, options.packModuleEvaluator, options.importExceptionHandler);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineEditorExportsPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const projectCustomMacroURL = new url_1.URL('./temp/programming/custom-macro.js', projectUrlPrefix);
        this._fixedImportMap.imports['cc/userland/macro'] = projectCustomMacroURL.href;
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理项目里的自定义配置模块，比如 custom-macro 模块
        this._editorSystem.addInstantiationHandler((url) => {
            if (url.startsWith(projectUrlPrefix)) {
                let quickCompilerRequest = url.substr(projectUrlPrefix.length);
                quickCompilerRequest = path_1.default.join(Editor.Project.path, quickCompilerRequest);
                require(quickCompilerRequest);
                return this._editorSystem.getRegister();
            }
        });
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineEditorExportsPrefix)) {
                quickCompilerRequest = url.substr(engineEditorExportsPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: async () => {
                                const exports = await importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        const packResourceBaseURLString = packResourceBaseURL.href;
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(packResourceBaseURLString)) {
                const link = url.slice(packResourceBaseURLString.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    async prepare() {
        await this._reloadPackMods();
    }
    async import(url) {
        return await this._editorSystem.import(url);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        await this._reloadPackMods();
        console.groupCollapsed(`Invalidate all modules`);
        await this._invalidateAllModules();
        console.groupEnd();
        this._invalidateAllPlugins();
        this._loadAllPlugins();
        console.groupCollapsed(`Imports all modules`);
        await this._importPrerequisiteModules();
        console.groupEnd();
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        // 多进程操作同一个资源。如果不给文件加锁，会导致文件读写冲突
        await this._packModInstantiation.lock();
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, new url_1.URL(this._packLoader.importMapURL, packResourceBaseURL).href);
        await this._packModInstantiation.unlock();
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
        const resolutionDetailMap = await this._packLoader.loadResolutionDetailMap();
        this._editorSystem.setResolutionDetailMap(resolutionDetailMap, new url_1.URL(this._packLoader.resolutionDetailMapURL, packResourceBaseURL).href);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        const cc = await System.import('cc');
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            this._importExceptionHandler(err);
        }
        finally {
            this._cachedExceptions.clear();
            EditorExtends.removeListener('class-registered', onClassRegistered);
            // 项目脚本可能在执行的时候会抛出异常，这导致 `cc._RF` 没有正确弹出。
            // 我们在最后清理一下。
            cc.cclegacy._RF.reset();
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                this._importExceptionHandler(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXNCO0FBQ3RCLCtEQUEwRDtBQUMxRCx3REFBd0U7QUFDeEUsNkJBQTBCO0FBRTFCLDZFQUFtRjtBQUNuRixxRUFBcUY7QUFLckYsZUFBZTtBQUNmLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO0FBQzVDLG1CQUFtQjtBQUNuQixNQUFNLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO0FBQzFELHNCQUFzQjtBQUN0QixNQUFNLHlCQUF5QixHQUFHLGlDQUFpQyxDQUFDO0FBQ3BFLGdCQUFnQjtBQUNoQixNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBRXBELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxTQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFJaEQsTUFBTSw2QkFBNkIsR0FBMkIsQ0FBQyxHQUFZLEVBQUUsRUFBRTtJQUMzRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQUVGLE1BQWEsUUFBUTtJQWVqQixZQUNJLHNCQUFxQyxFQUNyQyxtQkFBb0QsRUFDcEQsc0JBQTBEO1FBeVJ0RCxzQkFBaUIsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoRCxrQkFBYSxHQUErQixFQUFFLENBQUM7UUFFL0MsaUJBQVksR0FBMkIsRUFBRSxDQUFDO1FBSzFDLGFBQVEsR0FBcUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRSx1QkFBa0IsR0FBZSxFQUFFLENBQUM7UUFFcEMsYUFBUSxHQUE2QyxFQUFFLENBQUM7UUFFeEQsb0JBQWUsR0FBd0MsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDdkUsd0JBQW1CLEdBQUcsRUFBRSxDQUFDO1FBR3pCLDBCQUFxQixHQUFhLEVBQUUsQ0FB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LGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDbkM7SUFDTCxDQUFDO0NBdUJKO0FBN1RELDRCQTZUQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgcHMgZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IHNvcnRQbHVnaW5TY3JpcHRzIH0gZnJvbSAnLi9zb3J0LXBsdWdpbi1zY3JpcHRzJztcclxuaW1wb3J0IHsgRXhlY3V0b3JTeXN0ZW0sIGdsb2JhbEVkaXRvclN5c3RlbSB9IGZyb20gJy4uL2VkaXRvci1zeXN0ZW1qcyc7XHJcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCB7IExvYWRlckNvbnRleHQgfSBmcm9tICdAY29jb3MvY3JlYXRvci1wcm9ncmFtbWluZy1xdWljay1wYWNrL2xpYi91dGlscy9sb2FkZXItY29udGV4dCc7XHJcbmltcG9ydCB7IFF1aWNrUGFja0xvYWRlciB9IGZyb20gJ0Bjb2Nvcy9jcmVhdG9yLXByb2dyYW1taW5nLXF1aWNrLXBhY2svbGliL2xvYWRlcic7XHJcbmltcG9ydCB7IFBhY2tNb2RJbnN0YW50aWF0aW9uLCBQYWNrTW9kdWxlRXZhbHVhdG9yIH0gZnJvbSAnLi9wYWNrLW1vZC1pbnN0YW50aWF0aW9uJztcclxuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xyXG5cclxudHlwZSBJbXBvcnRFbmdpbmVNb2QgPSAoaWQ6IHN0cmluZykgPT4gUmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCBQcm9taXNlPFJlY29yZDxzdHJpbmcsIHVua25vd24+PjtcclxuXHJcbi8vIGAnY2MnYCDnmoQgVVJMXHJcbmNvbnN0IGVuZ2luZUluZGV4VVJMID0gYGNjZTovaW50ZXJuYWwveC9jY2A7XHJcbi8vIOW8leaTjuWKn+iDveWNleWFg+aooeWdl+eahCBVUkwg5YmN57yAXHJcbmNvbnN0IGVuZ2luZUZlYXR1cmVVbml0c1ByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvY2MtZnUvYDtcclxuLy8g5byV5pOO5YWs5byA6Iez57yW6L6R5Zmo55qE5qih5Z2X55qEIFVSTCDliY3nvIBcclxuY29uc3QgZW5naW5lRWRpdG9yRXhwb3J0c1ByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvZWRpdG9yLWV4cG9ydHMvYDtcclxuLy8g6aG555uu6Lev5b6E55u45YWzIFVSTCDliY3nvIBcclxuY29uc3QgcHJvamVjdFVybFByZWZpeCA9ICdjY2U6L2ludGVybmFsL3gvcHJvamVjdC8nO1xyXG5cclxuY29uc3QgcGFja1Jlc291cmNlQmFzZVVSTCA9IG5ldyBVUkwoJ3BhY2s6Ly8vJyk7XHJcblxyXG50eXBlIEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB2b2lkO1xyXG5cclxuY29uc3QgZGVmYXVsdEltcG9ydEV4Y2VwdGlvbkhhbmRsZXI6IEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB7XHJcbiAgICBjb25zb2xlLndhcm4oZXJyKTtcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBFeGVjdXRvciB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdDogRXhlY3V0b3I7XHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBFeGVjdXRvci5PcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKEV4ZWN1dG9yLl9pbnN0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFeGVjdXRvci5faW5zdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhlY3V0b3IgPSBFeGVjdXRvci5faW5zdCA9IG5ldyBFeGVjdXRvcihcclxuICAgICAgICAgICAgb3B0aW9ucy5xdWlja1BhY2tMb2FkZXJDb250ZXh0LFxyXG4gICAgICAgICAgICBvcHRpb25zLnBhY2tNb2R1bGVFdmFsdWF0b3IsXHJcbiAgICAgICAgICAgIG9wdGlvbnMuaW1wb3J0RXhjZXB0aW9uSGFuZGxlcixcclxuICAgICAgICApO1xyXG4gICAgICAgIGF3YWl0IGV4ZWN1dG9yLl9pbml0aWFsaXplKG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiBleGVjdXRvcjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHF1aWNrUGFja0xvYWRlckNvbnRleHQ6IExvYWRlckNvbnRleHQsXHJcbiAgICAgICAgcGFja01vZHVsZUV2YWx1YXRvcjogUGFja01vZHVsZUV2YWx1YXRvciB8IHVuZGVmaW5lZCxcclxuICAgICAgICBpbXBvcnRFeGNlcHRpb25IYW5kbGVyOiBJbXBvcnRFeGNlcHRpb25IYW5kbGVyIHwgdW5kZWZpbmVkLFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtID0gZ2xvYmFsRWRpdG9yU3lzdGVtO1xyXG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IHt9O1xyXG5cclxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXIgPSBuZXcgUXVpY2tQYWNrTG9hZGVyKHF1aWNrUGFja0xvYWRlckNvbnRleHQpO1xyXG4gICAgICAgIHRoaXMuX3BhY2tMb2FkZXIgPSBxdWlja1BhY2tMb2FkZXI7XHJcbiAgICAgICAgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24gPSBuZXcgUGFja01vZEluc3RhbnRpYXRpb24ocXVpY2tQYWNrTG9hZGVyLCB0aGlzLl9lZGl0b3JTeXN0ZW0sIHBhY2tNb2R1bGVFdmFsdWF0b3IpO1xyXG5cclxuICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyID0gaW1wb3J0RXhjZXB0aW9uSGFuZGxlciA/PyBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcclxuICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcclxuICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzID0gb3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9hZGRJbnN0YW50aWF0aW9uSGFuZGxlcnMob3B0aW9ucy5pbXBvcnRFbmdpbmVNb2QpO1xyXG5cclxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYyddID0gZW5naW5lSW5kZXhVUkw7XHJcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvZW52J10gPSBgJHtlbmdpbmVFZGl0b3JFeHBvcnRzUHJlZml4fWNjL2VkaXRvci9wb3B1bGF0ZS1pbnRlcm5hbC1jb25zdGFudHNgO1xyXG4gICAgICAgIC8vIFRPRE86IGRlcHJlY2F0ZWQgY2NlLmVudiBpcyBvbmx5IGxpdmUgaW4gMy4wLXByZXZpZXdcclxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjY2UuZW52J10gPSB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYy9lbnYnXTtcclxuICAgICAgICBjb25zdCBwcm9qZWN0Q3VzdG9tTWFjcm9VUkwgPSBuZXcgVVJMKCcuL3RlbXAvcHJvZ3JhbW1pbmcvY3VzdG9tLW1hY3JvLmpzJywgcHJvamVjdFVybFByZWZpeCk7XHJcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvdXNlcmxhbmQvbWFjcm8nXSA9IHByb2plY3RDdXN0b21NYWNyb1VSTC5ocmVmO1xyXG5cclxuICAgICAgICBjb25zdCB2ZW5kZXJPbkxvYWQgPSBTeXN0ZW0uY29uc3RydWN0b3IucHJvdG90eXBlLm9ubG9hZDtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgICAgICBTeXN0ZW0uY29uc3RydWN0b3IucHJvdG90eXBlLm9ubG9hZCA9IGZ1bmN0aW9uICguLi5hcmdzOiBQYXJhbWV0ZXJzPEV4ZWN1dG9yWydfb25Nb2R1bGVMb2FkZWQnXT4pIHtcclxuICAgICAgICAgICAgc2VsZi5fb25Nb2R1bGVMb2FkZWQoLi4uYXJncyk7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmVuZGVyT25Mb2FkID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICB2ZW5kZXJPbkxvYWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IG9wdGlvbnMubG9nZ2VyIHx8IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2FkZEluc3RhbnRpYXRpb25IYW5kbGVycyhpbXBvcnRlcjogSW1wb3J0RW5naW5lTW9kKSB7XHJcbiAgICAgICAgLy8g5aSE55CG6aG555uu6YeM55qE6Ieq5a6a5LmJ6YWN572u5qih5Z2X77yM5q+U5aaCIGN1c3RvbS1tYWNybyDmqKHlnZdcclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoKHVybCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgocHJvamVjdFVybFByZWZpeCkpIHtcclxuICAgICAgICAgICAgICAgIGxldCBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybC5zdWJzdHIocHJvamVjdFVybFByZWZpeC5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSBwcy5qb2luKEVkaXRvci5Qcm9qZWN0LnBhdGgsIHF1aWNrQ29tcGlsZXJSZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgIHJlcXVpcmUocXVpY2tDb21waWxlclJlcXVlc3QpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VkaXRvclN5c3RlbS5nZXRSZWdpc3RlcigpIGFzIE1vZHVsZVJlZ2lzdGVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8g5aSE55CG5byV5pOO5qih5Z2X55qE5a6e5L6L5YyWXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKGFzeW5jICh1cmwpID0+IHtcclxuICAgICAgICAgICAgbGV0IHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gJyc7XHJcbiAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVGZWF0dXJlVW5pdHNQcmVmaXgpKSB7XHJcbiAgICAgICAgICAgICAgICBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh1cmwuc3RhcnRzV2l0aChlbmdpbmVFZGl0b3JFeHBvcnRzUHJlZml4KSkge1xyXG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmwuc3Vic3RyKGVuZ2luZUVkaXRvckV4cG9ydHNQcmVmaXgubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocXVpY2tDb21waWxlclJlcXVlc3QpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbW10sIChfZXhwb3J0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0ZTogYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwb3J0cyA9IGF3YWl0IGltcG9ydGVyKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOWkhOeQhiBQYWNrZXIg6YeM55qE5qih5Z2X55qE5a6e5L6L5YyWXHJcbiAgICAgICAgY29uc3QgcGFja1Jlc291cmNlQmFzZVVSTFN0cmluZyA9IHBhY2tSZXNvdXJjZUJhc2VVUkwuaHJlZjtcclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgocGFja1Jlc291cmNlQmFzZVVSTFN0cmluZykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmsgPSB1cmwuc2xpY2UocGFja1Jlc291cmNlQmFzZVVSTFN0cmluZy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5pbnN0YW50aWF0ZShsaW5rKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzLnB1c2godXJsKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRQb2x5ZmlsbEZpbGUoZmlsZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmVxdWlyZShmaWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgcHJlcGFyZSgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLl9yZWxvYWRQYWNrTW9kcygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBpbXBvcnQodXJsOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+IHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZWRpdG9yU3lzdGVtLmltcG9ydCh1cmwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6YeN5paw6K+75Y+WIFBhY2tlciDnmoTlhoXlrrnlubbph43mlrDmiafooYzmiYDmnInpobnnm67ohJrmnKzlkozmj5Lku7bohJrmnKzjgIJcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLl9yZWxvYWRQYWNrTW9kcygpO1xyXG5cclxuICAgICAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKGBJbnZhbGlkYXRlIGFsbCBtb2R1bGVzYCk7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5faW52YWxpZGF0ZUFsbE1vZHVsZXMoKTtcclxuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX2xvYWRBbGxQbHVnaW5zKCk7XHJcblxyXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEltcG9ydHMgYWxsIG1vZHVsZXNgKTtcclxuICAgICAgICBhd2FpdCB0aGlzLl9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCk7XHJcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBob3RSZWxvYWRQbHVnaW5TY3JpcHRzKHtcclxuICAgICAgICBjaGFuZ2VzLFxyXG4gICAgICAgIHJlbW92YWxzLFxyXG4gICAgfToge1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOaJgOacieimgeS/ruaUueeahO+8iOaIluaWsOWinueahO+8ieaPkuS7tuiEmuacrOOAglxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNoYW5nZXM6IFJlY29yZDxQbHVnaW5TY3JpcHRJZCwgUGx1Z2luU2NyaXB0SW5mbz5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmiYDmnInopoHnp7vpmaTnmoTmj5Lku7bohJrmnKzjgIJcclxuICAgICAgICAgKi9cclxuICAgICAgICByZW1vdmFsczogUGx1Z2luU2NyaXB0SWRbXTtcclxuICAgIH0pIHtcclxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoY2hhbmdlcykubGVuZ3RoID09PSAwICYmIHJlbW92YWxzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xyXG5cclxuICAgICAgICAvLyDlupTnlKjkv67mlLlcclxuICAgICAgICBmb3IgKGNvbnN0IHJlbW92YWwgb2YgcmVtb3ZhbHMpIHtcclxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3BsdWdpbnNbcmVtb3ZhbF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IFtwbHVnaW5TY3JpcHRJZCwgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXMoY2hhbmdlcykpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGx1Z2luc1twbHVnaW5TY3JpcHRJZF0gPSBwbHVnaW5TY3JpcHRJbmZvO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNNb2R1bGUoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBpZCBpbiB0aGlzLl9tb2R1bGVzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBjbGVhcigpIHtcclxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGx1Z2lucygpO1xyXG4gICAgICAgIHRoaXMuX3BsdWdpbnMgPSB7fTtcclxuICAgICAgICBhd2FpdCB0aGlzLl9pbnZhbGlkYXRlQWxsTW9kdWxlcygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5p+l5om+5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu+OAglxyXG4gICAgICogQHBhcmFtIHV1aWQg5qih5Z2X55qEIHV1aWTjgIJcclxuICAgICAqIEByZXR1cm5zIOaMh+WumuiEmuacrOaooeWdl+S4reazqOWGjOeahOaJgOaciSBjYyDnsbvvvJvlpoLmnpwgW3V1aWRdIOW5tuS4jeWvueW6lOS4gOS4quaooeWdl+aIluaooeWdl+S4reacquazqOWGjOS7u+S9leexu+WImei/lOWbniBgdW5kZWZpbmVkYOOAglxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcXVlcnlDbGFzc2VzSW5Nb2R1bGUodXVpZDogc3RyaW5nKTogdW5kZWZpbmVkIHwgUmVhZG9ubHlBcnJheTxSZWFkb25seTxGdW5jdGlvbj4+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY2xhc3NVdWlkTWFwW3V1aWRdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgX3JlbG9hZFBhY2tNb2RzKCkge1xyXG4gICAgICAgIC8vIOWkmui/m+eoi+aTjeS9nOWQjOS4gOS4qui1hOa6kOOAguWmguaenOS4jee7meaWh+S7tuWKoOmUge+8jOS8muWvvOiHtOaWh+S7tuivu+WGmeWGsueqgVxyXG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmxvY2soKTtcclxuICAgICAgICBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5yZWxvYWQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmNsZWFySW1wb3J0TWFwKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHF1aWNrUGFja0xvYWRlckltcG9ydE1hcCA9IGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLmdldEltcG9ydE1hcCgpO1xyXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5leHRlbmRJbXBvcnRNYXAocXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwLCBuZXcgVVJMKHRoaXMuX3BhY2tMb2FkZXIuaW1wb3J0TWFwVVJMLCBwYWNrUmVzb3VyY2VCYXNlVVJMKS5ocmVmKTtcclxuICAgICAgICBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi51bmxvY2soKTtcclxuXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmV4dGVuZEltcG9ydE1hcCh0aGlzLl9maXhlZEltcG9ydE1hcCwgdGhpcy5fZW5naW5lSW1wb3J0TWFwVVJMKTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVzb2x1dGlvbkRldGFpbE1hcCA9IGF3YWl0IHRoaXMuX3BhY2tMb2FkZXIubG9hZFJlc29sdXRpb25EZXRhaWxNYXAoKTtcclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uc2V0UmVzb2x1dGlvbkRldGFpbE1hcChyZXNvbHV0aW9uRGV0YWlsTWFwLCBuZXcgVVJMKHRoaXMuX3BhY2tMb2FkZXIucmVzb2x1dGlvbkRldGFpbE1hcFVSTCwgcGFja1Jlc291cmNlQmFzZVVSTCkuaHJlZik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfaW52YWxpZGF0ZUFsbE1vZHVsZXMoKSB7XHJcbiAgICAgICAgY29uc3QgY2MgPSBhd2FpdCBTeXN0ZW0uaW1wb3J0KCdjYycpIGFzIEVuZ2luZUV4cG9ydHM7XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgcmVnaXN0ZXJlZENsYXNzIG9mIHRoaXMuX3JlZ2lzdGVyZWRDbGFzc2VzKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcyhyZWdpc3RlcmVkQ2xhc3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNjLmpzLnVucmVnaXN0ZXJDbGFzcyhyZWdpc3RlcmVkQ2xhc3MpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBVbnJlZ2lzdGVyICR7cmVnaXN0ZXJlZENsYXNzLm5hbWV9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3JlZ2lzdGVyZWRDbGFzc2VzID0gW107XHJcblxyXG4gICAgICAgIHRoaXMuX2NsYXNzVXVpZE1hcCA9IHt9O1xyXG5cclxuICAgICAgICBjYy5jY2xlZ2FjeS5fUkYucmVzZXQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBhY2tNb2RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfaW52YWxpZGF0ZUFsbFBhY2tNb2RzKCkge1xyXG4gICAgICAgIGZvciAoY29uc3QgcGFja01vZElkIG9mIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYEludmFsaWRhdGluZyAnJHtwYWNrTW9kSWR9J2ApO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBTeXN0ZW0uZGVsZXRlKHBhY2tNb2RJZCk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBOb3RlOiBmYWlsZWQgdG8gZGVsZXRlICR7cGFja01vZElkfSwgbWF5YmUgaXQncyBiZWluZyBleGVjdXRpbmc/YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMubGVuZ3RoID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbXBvcnRQcmVyZXF1aXNpdGVNb2R1bGVzKCkge1xyXG4gICAgICAgIGNvbnN0IG9uQ2xhc3NSZWdpc3RlcmVkOiBFZGl0b3JFeHRlbmRzLkxpc3RlbmVyPCdjbGFzcy1yZWdpc3RlcmVkJz4gPSAoY2xhc3NDb25zdHJ1Y3RvciwgbWV0YWRhdGEpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMucHVzaChjbGFzc0NvbnN0cnVjdG9yKTtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgW1tFeGVjdXRvcl1dIFJlZ2lzdGVyICR7Y2xhc3NDb25zdHJ1Y3Rvci5uYW1lfWApO1xyXG4gICAgICAgICAgICBpZiAobWV0YWRhdGEpIHtcclxuICAgICAgICAgICAgICAgICh0aGlzLl9jbGFzc1V1aWRNYXBbbWV0YWRhdGEudXVpZF0gPz89IFtdKS5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgRWRpdG9yRXh0ZW5kcy5vbignY2xhc3MtcmVnaXN0ZXJlZCcsIG9uQ2xhc3NSZWdpc3RlcmVkKTtcclxuXHJcbiAgICAgICAgY29uc3QgY2MgPSBhd2FpdCBTeXN0ZW0uaW1wb3J0KCdjYycpIGFzIEVuZ2luZUV4cG9ydHM7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjZTovaW50ZXJuYWwveC9wcmVyZXF1aXNpdGUtaW1wb3J0cycpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xyXG4gICAgICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyKGVycik7XHJcbiAgICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVkRXhjZXB0aW9ucy5jbGVhcigpO1xyXG4gICAgICAgICAgICBFZGl0b3JFeHRlbmRzLnJlbW92ZUxpc3RlbmVyKCdjbGFzcy1yZWdpc3RlcmVkJywgb25DbGFzc1JlZ2lzdGVyZWQpO1xyXG4gICAgICAgICAgICAvLyDpobnnm67ohJrmnKzlj6/og73lnKjmiafooYznmoTml7blgJnkvJrmipvlh7rlvILluLjvvIzov5nlr7zoh7QgYGNjLl9SRmAg5rKh5pyJ5q2j56Gu5by55Ye644CCXHJcbiAgICAgICAgICAgIC8vIOaIkeS7rOWcqOacgOWQjua4heeQhuS4gOS4i+OAglxyXG4gICAgICAgICAgICBjYy5jY2xlZ2FjeS5fUkYucmVzZXQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfbG9hZEFsbFBsdWdpbnMoKSB7XHJcbiAgICAgICAgY29uc3QgcGx1Z2luU2NyaXB0RGVwZW5kZW5jeU1hcDogQXJyYXk8W3N0cmluZywgcmVhZG9ubHkgc3RyaW5nW11dPiA9IFtdO1xyXG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xyXG4gICAgICAgICAgICBwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwLnB1c2goW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvLmRlcGVuZGVuY2llc10pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBzb3J0ZWQgPSBzb3J0UGx1Z2luU2NyaXB0cyhwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwKTtcclxuICAgICAgICBjb25zdCBzb3J0ZWRNYXBwZWQgPSBzb3J0ZWQubWFwKChwbHVnaW5TY3JpcHRJZCkgPT4gdGhpcy5fcGx1Z2luc1twbHVnaW5TY3JpcHRJZF0uZmlsZSk7XHJcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIHNvcnRlZE1hcHBlZCkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcmVxdWlyZShmaWxlKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2ludmFsaWRhdGVBbGxQbHVnaW5zKCkge1xyXG4gICAgICAgIGZvciAoY29uc3QgWywgcGx1Z2luU2NyaXB0SW5mb10gb2YgT2JqZWN0LmVudHJpZXModGhpcy5fcGx1Z2lucykpIHtcclxuICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcGx1Z2luU2NyaXB0SW5mby5maWxlXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdHJ5TG9nPENhdCBleHRlbmRzIGtleW9mIEV4ZWN1dG9yLkxvZ2dlcj4oY2F0OiBDYXQsIC4uLmFyZ3M6IFBhcmFtZXRlcnM8Tm9uTnVsbGFibGU8RXhlY3V0b3IuTG9nZ2VyW0NhdF0+Pikge1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICByZXR1cm4gKGNhdCBpbiB0aGlzLl9sb2dnZXIpID8gdGhpcy5fbG9nZ2VyW2NhdF0hKC4uLmFyZ3MpIDogdGhpcy5fZGVmYXVsdExvZyguLi5hcmdzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kZWZhdWx0TG9nKC4uLmFyZ3M6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKC4uLmFyZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX29uTW9kdWxlTG9hZGVkKGVycm9yOiBFcnJvciwgaWQ6IHN0cmluZywgZGVwZW5kZW5jaWVzPzogc3RyaW5nW10pIHtcclxuICAgICAgICBjb25zdCBjYWNoZWRFeGNlcHRpb25zID0gdGhpcy5fY2FjaGVkRXhjZXB0aW9ucztcclxuICAgICAgICBpZiAoIWVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFtbRXhlY3V0b3JdXSBNb2R1bGUgXCIke2lkfVwiIGxvYWRlZC5gKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoIWNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5faW1wb3J0RXhjZXB0aW9uSGFuZGxlcihlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5fdHJ5TG9nKCdsb2FkRXhjZXB0aW9uJywgaWQsIGVycm9yLCBjYWNoZWRFeGNlcHRpb25zLmhhcyhlcnJvcikpO1xyXG4gICAgICAgICAgICBjYWNoZWRFeGNlcHRpb25zLnNldChlcnJvciwgaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRlY2xhcmUgX3BhY2tNb2RJbnN0YW50aWF0aW9uOiBQYWNrTW9kSW5zdGFudGlhdGlvbjtcclxuXHJcbiAgICBwcml2YXRlIF9iZWZvcmVVbnJlZ2lzdGVyQ2xhc3M/OiBFeGVjdXRvci5CZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XHJcbiAgICBwcml2YXRlIF9jYWNoZWRFeGNlcHRpb25zOiBNYXA8YW55LCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xyXG4gICAgcHJpdmF0ZSBfY2xhc3NVdWlkTWFwOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbltdPiA9IHt9O1xyXG4gICAgcHJpdmF0ZSBfbG9nZ2VyOiBQYXJ0aWFsPEV4ZWN1dG9yLkxvZ2dlcj47XHJcbiAgICBwcml2YXRlIF9idWlsdGluTW9kczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgX2ltcG9ydEV4Y2VwdGlvbkhhbmRsZXI6IEltcG9ydEV4Y2VwdGlvbkhhbmRsZXI7XHJcblxyXG4gICAgcHJpdmF0ZSBfZWRpdG9yU3lzdGVtOiBFeGVjdXRvclN5c3RlbTtcclxuICAgIHByaXZhdGUgX21vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZVNjcmlwdEluZm8+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcclxuICAgIHByaXZhdGUgX3JlZ2lzdGVyZWRDbGFzc2VzOiBGdW5jdGlvbltdID0gW107XHJcblxyXG4gICAgcHJpdmF0ZSBfcGx1Z2luczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPiA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgX2ZpeGVkSW1wb3J0TWFwOiB7IGltcG9ydHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gfSA9IHsgaW1wb3J0czoge30gfTtcclxuICAgIHByaXZhdGUgX2VuZ2luZUltcG9ydE1hcFVSTCA9ICcnO1xyXG5cclxuICAgIHByaXZhdGUgX3BhY2tMb2FkZXI6IFF1aWNrUGFja0xvYWRlcjtcclxuICAgIHByaXZhdGUgX2luc3RhbnRpYXRlZFBhY2tNb2RzOiBzdHJpbmdbXSA9IFtdO1xyXG59XHJcblxyXG5leHBvcnQgbmFtZXNwYWNlIEV4ZWN1dG9yIHtcclxuICAgIGV4cG9ydCB0eXBlIEJlZm9yZVVucmVnaXN0ZXJDbGFzcyA9IChjbGFzc0NvbnN0cnVjdG9yOiBGdW5jdGlvbikgPT4gdm9pZDtcclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIFJlcG9ydGVyTWFwIHtcclxuICAgICAgICBbJ3Bvc3NpYmxlLWNyLXVzZSddOiB7XHJcbiAgICAgICAgICAgIGltcG9ydGVkOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZztcclxuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55O1xyXG4gICAgICAgICAgICBleHRyYXM6IGFueTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCB0eXBlIExvZ2dlciA9IFBhcnRpYWw8e1xyXG4gICAgICAgIHBvc3NpYmxlQ2lyY3VsYXJSZWZlcmVuY2U6IChcclxuICAgICAgICAgICAgaW1wb3J0ZWQ6IHN0cmluZyxcclxuICAgICAgICAgICAgbW9kdWxlUmVxdWVzdDogc3RyaW5nLFxyXG4gICAgICAgICAgICBpbXBvcnRNZXRhOiBhbnksXHJcbiAgICAgICAgICAgIGV4dHJhczogYW55XHJcbiAgICAgICAgKSA9PiB2b2lkO1xyXG5cclxuICAgICAgICBsb2FkRXhjZXB0aW9uOiAoXHJcbiAgICAgICAgICAgIG1vZHVsZVVybDogc3RyaW5nLFxyXG4gICAgICAgICAgICBlcnJvcj86IGFueSxcclxuICAgICAgICAgICAgaGFzQmVlblRocm93bj86IGJvb2xlYW4sXHJcbiAgICAgICAgKSA9PiB2b2lkO1xyXG4gICAgfT47XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcclxuICAgICAgICBpbXBvcnRFbmdpbmVNb2Q6IEltcG9ydEVuZ2luZU1vZDtcclxuICAgICAgICBxdWlja1BhY2tMb2FkZXJDb250ZXh0OiBMb2FkZXJDb250ZXh0O1xyXG4gICAgICAgIGJlZm9yZVVucmVnaXN0ZXJDbGFzcz86IEJlZm9yZVVucmVnaXN0ZXJDbGFzcztcclxuICAgICAgICBwYWNrTW9kdWxlRXZhbHVhdG9yPzogUGFja01vZHVsZUV2YWx1YXRvcjtcclxuICAgICAgICBsb2dnZXI/OiBMb2dnZXI7XHJcbiAgICAgICAgaW1wb3J0RXhjZXB0aW9uSGFuZGxlcj86IChlcnI6IHVua25vd24pID0+IHZvaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlSW5mbyB7XHJcbiAgICAgICAgcG9seWZpbGxzOiBzdHJpbmdbXTtcclxuICAgICAgICBtb2R1bGVzOiBzdHJpbmdbXTtcclxuICAgICAgICBiYXJlU3BlY2lmaWVyUmVzb2x2ZU1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxuICAgICAgICBpbnN0YW50aWF0ZU1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxuICAgIH1cclxufVxyXG5cclxudHlwZSBQbHVnaW5TY3JpcHRJZCA9IHN0cmluZztcclxuXHJcbmludGVyZmFjZSBQbHVnaW5TY3JpcHRJbmZvIHtcclxuICAgIC8qKlxyXG4gICAgICog6ISa5pys5paH5Lu244CCXHJcbiAgICAgKi9cclxuICAgIGZpbGU6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS+nei1lueahOaPkuS7tuiEmuacrOOAglxyXG4gICAgICovXHJcbiAgICBkZXBlbmRlbmNpZXM6IFBsdWdpblNjcmlwdElkW107XHJcbn1cclxuXHJcbmludGVyZmFjZSBNb2R1bGVTY3JpcHRJbmZvIHtcclxuICAgIC8qKlxyXG4gICAgICog5qih5Z2XIFVSTOOAglxyXG4gICAgICovXHJcbiAgICBtb2R1bGVVcmw6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS7o+eggeaWh+S7tuOAglxyXG4gICAgICovXHJcbiAgICBmaWxlOiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBFbmdpbmVFeHBvcnRzIHtcclxuICAgIGNjbGVnYWN5OiB7IF9SRjogeyByZXNldCgpOiB2b2lkOyB9IH07XHJcbiAgICBqczogeyB1bnJlZ2lzdGVyQ2xhc3MoZjogRnVuY3Rpb24pOiB2b2lkOyB9O1xyXG59XHJcblxyXG5kZWNsYXJlIG5hbWVzcGFjZSBFZGl0b3JFeHRlbmRzIHtcclxuICAgIGludGVyZmFjZSBFdmVudE1hcCB7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQ2FsbGVkIHdoZW4gYSBjYy1jbGFzcyBpcyByZWdpc3RlcmVkLlxyXG4gICAgICAgICAqIEBwYXJhbSBjbGFzc0NvbnN0cnVjdG9yIFJlZ2lzdGVyaW5nIGNsYXNzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgICdjbGFzcy1yZWdpc3RlcmVkJyhjbGFzc0NvbnN0cnVjdG9yOiBGdW5jdGlvbiwgbWV0YWRhdGE/OiBSZWFkb25seTxhbnk+KTogdm9pZDtcclxuICAgIH1cclxuXHJcbiAgICB0eXBlIEV2ZW50QXJnczxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4gPSBQYXJhbWV0ZXJzPEV2ZW50TWFwW0V2ZW50TmFtZV0+O1xyXG5cclxuICAgIHR5cGUgTGlzdGVuZXI8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+ID0gKC4uLmFyZ3M6IEV2ZW50QXJnczxFdmVudE5hbWU+KSA9PiB2b2lkO1xyXG5cclxuICAgIGZ1bmN0aW9uIGVtaXQ8RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgLi4uYXJnczogRXZlbnRBcmdzPEV2ZW50TmFtZT4pOiB2b2lkO1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPihuYW1lOiBFdmVudE5hbWUsIGxpc3RlbmVyOiBMaXN0ZW5lcjxFdmVudE5hbWU+KTogdm9pZDtcclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCBsaXN0ZW5lcjogTGlzdGVuZXI8RXZlbnROYW1lPik6IHZvaWQ7XHJcbn1cclxuIl19