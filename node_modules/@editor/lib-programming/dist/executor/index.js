"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Executor = void 0;
const path_1 = __importDefault(require("path"));
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
const editor_systemjs_1 = require("../editor-systemjs");
const url_1 = require("url");
const loader_1 = require("@cocos/creator-programming-quick-pack/lib/loader");
const pack_mod_instantiation_1 = require("./pack-mod-instantiation");
// `'cc'` 的 URL
const engineIndexURL = `cce:/internal/x/cc`;
// 引擎功能单元模块的 URL 前缀
const engineFeatureUnitsPrefix = `cce:/internal/x/cc-fu/`;
// 引擎公开至编辑器的模块的 URL 前缀
const engineExportToEditorPrefix = `cce:/internal/x/engine-export-to-editor/`;
// 编辑器公开给项目的模块的 URL 前缀
const editorExportToProjectPrefix = `cce:/internal/x/editor-export-to-project/`;
// 项目路径相关 URL 前缀
const projectUrlPrefix = 'cce:/internal/x/project/';
const packResourceBaseURL = new url_1.URL('pack:///');
const defaultImportExceptionHandler = (err) => {
    console.warn(err);
};
class Executor {
    constructor(quickPackLoaderContext, packModuleEvaluator, importExceptionHandler) {
        this._cachedExceptions = new Map();
        this._classUuidMap = {};
        this._builtinMods = {};
        this._modules = Object.create(null);
        this._registeredClasses = [];
        this._plugins = {};
        this._fixedImportMap = { imports: {} };
        this._engineImportMapURL = '';
        this._instantiatedPackMods = [];
        this._cceModuleMap = {};
        this._editorSystem = editor_systemjs_1.globalEditorSystem;
        this._logger = {};
        const quickPackLoader = new loader_1.QuickPackLoader(quickPackLoaderContext);
        this._packLoader = quickPackLoader;
        this._packModInstantiation = new pack_mod_instantiation_1.PackModInstantiation(quickPackLoader, this._editorSystem, packModuleEvaluator);
        this._importExceptionHandler = importExceptionHandler !== null && importExceptionHandler !== void 0 ? importExceptionHandler : defaultImportExceptionHandler;
    }
    static async create(options) {
        if (Executor._inst) {
            return Executor._inst;
        }
        const executor = Executor._inst = new Executor(options.quickPackLoaderContext, options.packModuleEvaluator, options.importExceptionHandler);
        await executor._initialize(options);
        return executor;
    }
    async _initialize(options) {
        if (options.beforeUnregisterClass) {
            this._beforeUnregisterClass = options.beforeUnregisterClass;
        }
        this._addInstantiationHandlers(options.importEngineMod);
        this._cceModuleMap = options.cceModuleMap;
        this._fixedImportMap.imports['cc'] = engineIndexURL;
        this._fixedImportMap.imports['cc/env'] = `${engineExportToEditorPrefix}cc/editor/populate-internal-constants`;
        // TODO: deprecated cce.env is only live in 3.0-preview
        this._fixedImportMap.imports['cce.env'] = this._fixedImportMap.imports['cc/env'];
        const projectCustomMacroURL = new url_1.URL('./temp/programming/custom-macro.js', projectUrlPrefix);
        this._fixedImportMap.imports['cc/userland/macro'] = projectCustomMacroURL.href;
        for (const [moduleName, moduleConfig] of Object.entries(this._cceModuleMap)) {
            if (moduleName === 'mapLocation') {
                continue;
            }
            this._fixedImportMap.imports[moduleName] = `${editorExportToProjectPrefix}${moduleName}`;
        }
        const venderOnLoad = System.constructor.prototype.onload;
        const self = this;
        System.constructor.prototype.onload = function (...args) {
            self._onModuleLoaded(...args);
            if (typeof venderOnLoad === 'function') {
                venderOnLoad.apply(this, arguments);
            }
        };
        this._logger = options.logger || {};
    }
    _addInstantiationHandlers(importer) {
        // 处理项目里的自定义配置模块，比如 custom-macro 模块
        this._editorSystem.addInstantiationHandler((url) => {
            if (url.startsWith(projectUrlPrefix)) {
                let quickCompilerRequest = url.substr(projectUrlPrefix.length);
                quickCompilerRequest = path_1.default.join(Editor.Project.path, quickCompilerRequest);
                require(quickCompilerRequest);
                return this._editorSystem.getRegister();
            }
        });
        // 处理引擎模块的实例化
        this._editorSystem.addInstantiationHandler(async (url) => {
            let quickCompilerRequest = '';
            if (url.startsWith(engineFeatureUnitsPrefix)) {
                quickCompilerRequest = url;
            }
            else if (url.startsWith(engineExportToEditorPrefix)) {
                quickCompilerRequest = url.substr(engineExportToEditorPrefix.length);
            }
            if (quickCompilerRequest) {
                return [[], (_export) => {
                        return {
                            execute: async () => {
                                const exports = await importer(quickCompilerRequest);
                                _export(exports);
                            },
                        };
                    }];
            }
        });
        // 处理 Packer 里的模块的实例化
        const packResourceBaseURLString = packResourceBaseURL.href;
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(packResourceBaseURLString)) {
                const link = url.slice(packResourceBaseURLString.length);
                const register = await this._packModInstantiation.instantiate(link);
                this._instantiatedPackMods.push(url);
                return register;
            }
        });
        this._editorSystem.addInstantiationHandler(async (url) => {
            if (url.startsWith(editorExportToProjectPrefix)) {
                const moduleName = url.slice(editorExportToProjectPrefix.length);
                const moduleConfig = this._cceModuleMap[moduleName];
                const mapLocation = this._cceModuleMap.mapLocation;
                if (moduleConfig) {
                    const exportedObj = require(path_1.default.join(path_1.default.dirname(mapLocation), moduleConfig.main));
                    return [[], (_export) => {
                            return {
                                execute: async () => {
                                    _export(exportedObj);
                                },
                            };
                        }];
                }
            }
        });
    }
    addPolyfillFile(file) {
        require(file);
    }
    async prepare() {
        await this._reloadPackMods();
    }
    async import(url) {
        return await this._editorSystem.import(url);
    }
    /**
     * 重新读取 Packer 的内容并重新执行所有项目脚本和插件脚本。
     */
    async reload() {
        await this._reloadPackMods();
        console.groupCollapsed(`Invalidate all modules`);
        await this._invalidateAllModules();
        console.groupEnd();
        this._invalidateAllPlugins();
        this._loadAllPlugins();
        console.groupCollapsed(`Imports all modules`);
        await this._importPrerequisiteModules();
        console.groupEnd();
    }
    async hotReloadPluginScripts({ changes, removals, }) {
        if (Object.keys(changes).length === 0 && removals.length === 0) {
            return;
        }
        this._invalidateAllPlugins();
        // 应用修改
        for (const removal of removals) {
            delete this._plugins[removal];
        }
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(changes)) {
            this._plugins[pluginScriptId] = pluginScriptInfo;
        }
        await this._loadAllPlugins();
    }
    isModule(id) {
        return id in this._modules;
    }
    async clear() {
        this._invalidateAllPlugins();
        this._plugins = {};
        await this._invalidateAllModules();
    }
    /**
     * 查找指定脚本模块中注册的所有 cc 类。
     * @param uuid 模块的 uuid。
     * @returns 指定脚本模块中注册的所有 cc 类；如果 [uuid] 并不对应一个模块或模块中未注册任何类则返回 `undefined`。
     */
    queryClassesInModule(uuid) {
        return this._classUuidMap[uuid];
    }
    async _reloadPackMods() {
        // 多进程操作同一个资源。如果不给文件加锁，会导致文件读写冲突
        await this._packModInstantiation.lock();
        await this._packModInstantiation.reload();
        this._editorSystem.clearImportMap();
        const quickPackLoaderImportMap = await this._packModInstantiation.getImportMap();
        this._editorSystem.extendImportMap(quickPackLoaderImportMap, new url_1.URL(this._packLoader.importMapURL, packResourceBaseURL).href);
        await this._packModInstantiation.unlock();
        this._editorSystem.extendImportMap(this._fixedImportMap, this._engineImportMapURL);
        const resolutionDetailMap = await this._packLoader.loadResolutionDetailMap();
        this._editorSystem.setResolutionDetailMap(resolutionDetailMap, new url_1.URL(this._packLoader.resolutionDetailMapURL, packResourceBaseURL).href);
    }
    async _invalidateAllModules() {
        const cc = await System.import('cc');
        for (const registeredClass of this._registeredClasses) {
            if (this._beforeUnregisterClass) {
                this._beforeUnregisterClass(registeredClass);
            }
            cc.js.unregisterClass(registeredClass);
            console.debug(`Unregister ${registeredClass.name}`);
        }
        this._registeredClasses = [];
        this._classUuidMap = {};
        cc.cclegacy._RF.reset();
        this._invalidateAllPackMods();
    }
    _invalidateAllPackMods() {
        for (const packModId of this._instantiatedPackMods) {
            console.debug(`Invalidating '${packModId}'`);
            const result = System.delete(packModId);
            if (result === false) {
                console.debug(`Note: failed to delete ${packModId}, maybe it's being executing?`);
            }
        }
        this._instantiatedPackMods.length = 0;
    }
    async _importPrerequisiteModules() {
        const onClassRegistered = (classConstructor, metadata) => {
            var _a;
            var _b, _c;
            this._registeredClasses.push(classConstructor);
            console.debug(`[[Executor]] Register ${classConstructor.name}`);
            if (metadata) {
                ((_a = (_b = this._classUuidMap)[_c = metadata.uuid]) !== null && _a !== void 0 ? _a : (_b[_c] = [])).push(classConstructor);
            }
        };
        EditorExtends.on('class-registered', onClassRegistered);
        const cc = await System.import('cc');
        try {
            await System.import('cce:/internal/x/prerequisite-imports');
        }
        catch (err) {
            this._importExceptionHandler(err);
        }
        finally {
            this._cachedExceptions.clear();
            EditorExtends.removeListener('class-registered', onClassRegistered);
            // 项目脚本可能在执行的时候会抛出异常，这导致 `cc._RF` 没有正确弹出。
            // 我们在最后清理一下。
            cc.cclegacy._RF.reset();
        }
    }
    async _loadAllPlugins() {
        const pluginScriptDependencyMap = [];
        for (const [pluginScriptId, pluginScriptInfo] of Object.entries(this._plugins)) {
            pluginScriptDependencyMap.push([pluginScriptId, pluginScriptInfo.dependencies]);
        }
        const sorted = sort_plugin_scripts_1.sortPluginScripts(pluginScriptDependencyMap);
        const sortedMapped = sorted.map((pluginScriptId) => this._plugins[pluginScriptId].file);
        for (const file of sortedMapped) {
            try {
                require(file);
            }
            catch (error) {
                console.error(error);
            }
        }
    }
    _invalidateAllPlugins() {
        for (const [, pluginScriptInfo] of Object.entries(this._plugins)) {
            delete require.cache[pluginScriptInfo.file];
        }
    }
    _tryLog(cat, ...args) {
        // @ts-ignore
        return (cat in this._logger) ? this._logger[cat](...args) : this._defaultLog(...args);
    }
    _defaultLog(...args) {
        console.log(...args);
    }
    _onModuleLoaded(error, id, dependencies) {
        const cachedExceptions = this._cachedExceptions;
        if (!error) {
            console.debug(`[[Executor]] Module "${id}" loaded.`);
        }
        else {
            if (!cachedExceptions.has(error)) {
                this._importExceptionHandler(error);
            }
            this._tryLog('loadException', id, error, cachedExceptions.has(error));
            cachedExceptions.set(error, id);
        }
    }
}
exports.Executor = Executor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXNCO0FBQ3RCLCtEQUEwRDtBQUMxRCx3REFBd0U7QUFDeEUsNkJBQTBCO0FBRTFCLDZFQUFtRjtBQUNuRixxRUFBcUY7QUFLckYsZUFBZTtBQUNmLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO0FBQzVDLG1CQUFtQjtBQUNuQixNQUFNLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO0FBQzFELHNCQUFzQjtBQUN0QixNQUFNLDBCQUEwQixHQUFHLDBDQUEwQyxDQUFDO0FBQzlFLHNCQUFzQjtBQUN0QixNQUFNLDJCQUEyQixHQUFHLDJDQUEyQyxDQUFDO0FBQ2hGLGdCQUFnQjtBQUNoQixNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBRXBELE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxTQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFJaEQsTUFBTSw2QkFBNkIsR0FBMkIsQ0FBQyxHQUFZLEVBQUUsRUFBRTtJQUMzRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQUVGLE1BQWEsUUFBUTtJQWVqQixZQUNJLHNCQUFxQyxFQUNyQyxtQkFBb0QsRUFDcEQsc0JBQTBEO1FBbVR0RCxzQkFBaUIsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoRCxrQkFBYSxHQUErQixFQUFFLENBQUM7UUFFL0MsaUJBQVksR0FBMkIsRUFBRSxDQUFDO1FBSzFDLGFBQVEsR0FBcUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRSx1QkFBa0IsR0FBZSxFQUFFLENBQUM7UUFFcEMsYUFBUSxHQUE2QyxFQUFFLENBQUM7UUFFeEQsb0JBQWUsR0FBd0MsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDdkUs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QUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDdEUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNuQztJQUNMLENBQUM7Q0F3Qko7QUF4VkQsNEJBd1ZDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgc29ydFBsdWdpblNjcmlwdHMgfSBmcm9tICcuL3NvcnQtcGx1Z2luLXNjcmlwdHMnO1xyXG5pbXBvcnQgeyBFeGVjdXRvclN5c3RlbSwgZ2xvYmFsRWRpdG9yU3lzdGVtIH0gZnJvbSAnLi4vZWRpdG9yLXN5c3RlbWpzJztcclxuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcclxuaW1wb3J0IHsgTG9hZGVyQ29udGV4dCB9IGZyb20gJ0Bjb2Nvcy9jcmVhdG9yLXByb2dyYW1taW5nLXF1aWNrLXBhY2svbGliL3V0aWxzL2xvYWRlci1jb250ZXh0JztcclxuaW1wb3J0IHsgUXVpY2tQYWNrTG9hZGVyIH0gZnJvbSAnQGNvY29zL2NyZWF0b3ItcHJvZ3JhbW1pbmctcXVpY2stcGFjay9saWIvbG9hZGVyJztcclxuaW1wb3J0IHsgUGFja01vZEluc3RhbnRpYXRpb24sIFBhY2tNb2R1bGVFdmFsdWF0b3IgfSBmcm9tICcuL3BhY2stbW9kLWluc3RhbnRpYXRpb24nO1xyXG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XHJcblxyXG50eXBlIEltcG9ydEVuZ2luZU1vZCA9IChpZDogc3RyaW5nKSA9PiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB8IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4+O1xyXG5cclxuLy8gYCdjYydgIOeahCBVUkxcclxuY29uc3QgZW5naW5lSW5kZXhVUkwgPSBgY2NlOi9pbnRlcm5hbC94L2NjYDtcclxuLy8g5byV5pOO5Yqf6IO95Y2V5YWD5qih5Z2X55qEIFVSTCDliY3nvIBcclxuY29uc3QgZW5naW5lRmVhdHVyZVVuaXRzUHJlZml4ID0gYGNjZTovaW50ZXJuYWwveC9jYy1mdS9gO1xyXG4vLyDlvJXmk47lhazlvIDoh7PnvJbovpHlmajnmoTmqKHlnZfnmoQgVVJMIOWJjee8gFxyXG5jb25zdCBlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeCA9IGBjY2U6L2ludGVybmFsL3gvZW5naW5lLWV4cG9ydC10by1lZGl0b3IvYDtcclxuLy8g57yW6L6R5Zmo5YWs5byA57uZ6aG555uu55qE5qih5Z2X55qEIFVSTCDliY3nvIBcclxuY29uc3QgZWRpdG9yRXhwb3J0VG9Qcm9qZWN0UHJlZml4ID0gYGNjZTovaW50ZXJuYWwveC9lZGl0b3ItZXhwb3J0LXRvLXByb2plY3QvYDtcclxuLy8g6aG555uu6Lev5b6E55u45YWzIFVSTCDliY3nvIBcclxuY29uc3QgcHJvamVjdFVybFByZWZpeCA9ICdjY2U6L2ludGVybmFsL3gvcHJvamVjdC8nO1xyXG5cclxuY29uc3QgcGFja1Jlc291cmNlQmFzZVVSTCA9IG5ldyBVUkwoJ3BhY2s6Ly8vJyk7XHJcblxyXG50eXBlIEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB2b2lkO1xyXG5cclxuY29uc3QgZGVmYXVsdEltcG9ydEV4Y2VwdGlvbkhhbmRsZXI6IEltcG9ydEV4Y2VwdGlvbkhhbmRsZXIgPSAoZXJyOiB1bmtub3duKSA9PiB7XHJcbiAgICBjb25zb2xlLndhcm4oZXJyKTtcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBFeGVjdXRvciB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdDogRXhlY3V0b3I7XHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShvcHRpb25zOiBFeGVjdXRvci5PcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKEV4ZWN1dG9yLl9pbnN0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFeGVjdXRvci5faW5zdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhlY3V0b3IgPSBFeGVjdXRvci5faW5zdCA9IG5ldyBFeGVjdXRvcihcclxuICAgICAgICAgICAgb3B0aW9ucy5xdWlja1BhY2tMb2FkZXJDb250ZXh0LFxyXG4gICAgICAgICAgICBvcHRpb25zLnBhY2tNb2R1bGVFdmFsdWF0b3IsXHJcbiAgICAgICAgICAgIG9wdGlvbnMuaW1wb3J0RXhjZXB0aW9uSGFuZGxlcixcclxuICAgICAgICApO1xyXG4gICAgICAgIGF3YWl0IGV4ZWN1dG9yLl9pbml0aWFsaXplKG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiBleGVjdXRvcjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHF1aWNrUGFja0xvYWRlckNvbnRleHQ6IExvYWRlckNvbnRleHQsXHJcbiAgICAgICAgcGFja01vZHVsZUV2YWx1YXRvcjogUGFja01vZHVsZUV2YWx1YXRvciB8IHVuZGVmaW5lZCxcclxuICAgICAgICBpbXBvcnRFeGNlcHRpb25IYW5kbGVyOiBJbXBvcnRFeGNlcHRpb25IYW5kbGVyIHwgdW5kZWZpbmVkLFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtID0gZ2xvYmFsRWRpdG9yU3lzdGVtO1xyXG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IHt9O1xyXG5cclxuICAgICAgICBjb25zdCBxdWlja1BhY2tMb2FkZXIgPSBuZXcgUXVpY2tQYWNrTG9hZGVyKHF1aWNrUGFja0xvYWRlckNvbnRleHQpO1xyXG4gICAgICAgIHRoaXMuX3BhY2tMb2FkZXIgPSBxdWlja1BhY2tMb2FkZXI7XHJcbiAgICAgICAgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24gPSBuZXcgUGFja01vZEluc3RhbnRpYXRpb24ocXVpY2tQYWNrTG9hZGVyLCB0aGlzLl9lZGl0b3JTeXN0ZW0sIHBhY2tNb2R1bGVFdmFsdWF0b3IpO1xyXG5cclxuICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyID0gaW1wb3J0RXhjZXB0aW9uSGFuZGxlciA/PyBkZWZhdWx0SW1wb3J0RXhjZXB0aW9uSGFuZGxlcjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbml0aWFsaXplKG9wdGlvbnM6IEV4ZWN1dG9yLk9wdGlvbnMpIHtcclxuICAgICAgICBpZiAob3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3MpIHtcclxuICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzID0gb3B0aW9ucy5iZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9hZGRJbnN0YW50aWF0aW9uSGFuZGxlcnMob3B0aW9ucy5pbXBvcnRFbmdpbmVNb2QpO1xyXG5cclxuICAgICAgICB0aGlzLl9jY2VNb2R1bGVNYXAgPSBvcHRpb25zLmNjZU1vZHVsZU1hcDtcclxuICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzWydjYyddID0gZW5naW5lSW5kZXhVUkw7XHJcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvZW52J10gPSBgJHtlbmdpbmVFeHBvcnRUb0VkaXRvclByZWZpeH1jYy9lZGl0b3IvcG9wdWxhdGUtaW50ZXJuYWwtY29uc3RhbnRzYDtcclxuICAgICAgICAvLyBUT0RPOiBkZXByZWNhdGVkIGNjZS5lbnYgaXMgb25seSBsaXZlIGluIDMuMC1wcmV2aWV3XHJcbiAgICAgICAgdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2NlLmVudiddID0gdGhpcy5fZml4ZWRJbXBvcnRNYXAuaW1wb3J0c1snY2MvZW52J107XHJcbiAgICAgICAgY29uc3QgcHJvamVjdEN1c3RvbU1hY3JvVVJMID0gbmV3IFVSTCgnLi90ZW1wL3Byb2dyYW1taW5nL2N1c3RvbS1tYWNyby5qcycsIHByb2plY3RVcmxQcmVmaXgpO1xyXG4gICAgICAgIHRoaXMuX2ZpeGVkSW1wb3J0TWFwLmltcG9ydHNbJ2NjL3VzZXJsYW5kL21hY3JvJ10gPSBwcm9qZWN0Q3VzdG9tTWFjcm9VUkwuaHJlZjtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBbbW9kdWxlTmFtZSwgbW9kdWxlQ29uZmlnXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9jY2VNb2R1bGVNYXApKSB7XHJcbiAgICAgICAgICAgIGlmIChtb2R1bGVOYW1lID09PSAnbWFwTG9jYXRpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLl9maXhlZEltcG9ydE1hcC5pbXBvcnRzW21vZHVsZU5hbWVdID0gYCR7ZWRpdG9yRXhwb3J0VG9Qcm9qZWN0UHJlZml4fSR7bW9kdWxlTmFtZX1gO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdmVuZGVyT25Mb2FkID0gU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQ7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgU3lzdGVtLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5vbmxvYWQgPSBmdW5jdGlvbiAoLi4uYXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnX29uTW9kdWxlTG9hZGVkJ10+KSB7XHJcbiAgICAgICAgICAgIHNlbGYuX29uTW9kdWxlTG9hZGVkKC4uLmFyZ3MpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHZlbmRlck9uTG9hZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgdmVuZGVyT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLl9sb2dnZXIgPSBvcHRpb25zLmxvZ2dlciB8fCB7fTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9hZGRJbnN0YW50aWF0aW9uSGFuZGxlcnMoaW1wb3J0ZXI6IEltcG9ydEVuZ2luZU1vZCkge1xyXG4gICAgICAgIC8vIOWkhOeQhumhueebrumHjOeahOiHquWumuS5iemFjee9ruaooeWdl++8jOavlOWmgiBjdXN0b20tbWFjcm8g5qih5Z2XXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmFkZEluc3RhbnRpYXRpb25IYW5kbGVyKCh1cmwpID0+IHtcclxuICAgICAgICAgICAgaWYgKHVybC5zdGFydHNXaXRoKHByb2plY3RVcmxQcmVmaXgpKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmwuc3Vic3RyKHByb2plY3RVcmxQcmVmaXgubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIHF1aWNrQ29tcGlsZXJSZXF1ZXN0ID0gcHMuam9pbihFZGl0b3IuUHJvamVjdC5wYXRoLCBxdWlja0NvbXBpbGVyUmVxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICByZXF1aXJlKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3JTeXN0ZW0uZ2V0UmVnaXN0ZXIoKSBhcyBNb2R1bGVSZWdpc3RlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOWkhOeQhuW8leaTjuaooeWdl+eahOWunuS+i+WMllxyXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5hZGRJbnN0YW50aWF0aW9uSGFuZGxlcihhc3luYyAodXJsKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBxdWlja0NvbXBpbGVyUmVxdWVzdCA9ICcnO1xyXG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoZW5naW5lRmVhdHVyZVVuaXRzUHJlZml4KSkge1xyXG4gICAgICAgICAgICAgICAgcXVpY2tDb21waWxlclJlcXVlc3QgPSB1cmw7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodXJsLnN0YXJ0c1dpdGgoZW5naW5lRXhwb3J0VG9FZGl0b3JQcmVmaXgpKSB7XHJcbiAgICAgICAgICAgICAgICBxdWlja0NvbXBpbGVyUmVxdWVzdCA9IHVybC5zdWJzdHIoZW5naW5lRXhwb3J0VG9FZGl0b3JQcmVmaXgubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocXVpY2tDb21waWxlclJlcXVlc3QpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbW10sIChfZXhwb3J0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0ZTogYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwb3J0cyA9IGF3YWl0IGltcG9ydGVyKHF1aWNrQ29tcGlsZXJSZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9leHBvcnQoZXhwb3J0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOWkhOeQhiBQYWNrZXIg6YeM55qE5qih5Z2X55qE5a6e5L6L5YyWXHJcbiAgICAgICAgY29uc3QgcGFja1Jlc291cmNlQmFzZVVSTFN0cmluZyA9IHBhY2tSZXNvdXJjZUJhc2VVUkwuaHJlZjtcclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgocGFja1Jlc291cmNlQmFzZVVSTFN0cmluZykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmsgPSB1cmwuc2xpY2UocGFja1Jlc291cmNlQmFzZVVSTFN0cmluZy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSBhd2FpdCB0aGlzLl9wYWNrTW9kSW5zdGFudGlhdGlvbi5pbnN0YW50aWF0ZShsaW5rKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbnRpYXRlZFBhY2tNb2RzLnB1c2godXJsKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uYWRkSW5zdGFudGlhdGlvbkhhbmRsZXIoYXN5bmMgKHVybCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodXJsLnN0YXJ0c1dpdGgoZWRpdG9yRXhwb3J0VG9Qcm9qZWN0UHJlZml4KSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbW9kdWxlTmFtZSA9IHVybC5zbGljZShlZGl0b3JFeHBvcnRUb1Byb2plY3RQcmVmaXgubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZUNvbmZpZyA9IHRoaXMuX2NjZU1vZHVsZU1hcFttb2R1bGVOYW1lXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1hcExvY2F0aW9uID0gdGhpcy5fY2NlTW9kdWxlTWFwLm1hcExvY2F0aW9uO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZHVsZUNvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVkT2JqID0gcmVxdWlyZShwcy5qb2luKHBzLmRpcm5hbWUobWFwTG9jYXRpb24pLCBtb2R1bGVDb25maWcubWFpbikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbW10sIChfZXhwb3J0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjdXRlOiBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2V4cG9ydChleHBvcnRlZE9iaik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZFBvbHlmaWxsRmlsZShmaWxlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXF1aXJlKGZpbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBwcmVwYXJlKCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3JlbG9hZFBhY2tNb2RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGltcG9ydCh1cmw6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9lZGl0b3JTeXN0ZW0uaW1wb3J0KHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDph43mlrDor7vlj5YgUGFja2VyIOeahOWGheWuueW5tumHjeaWsOaJp+ihjOaJgOaciemhueebruiEmuacrOWSjOaPkuS7tuiEmuacrOOAglxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3JlbG9hZFBhY2tNb2RzKCk7XHJcblxyXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQoYEludmFsaWRhdGUgYWxsIG1vZHVsZXNgKTtcclxuICAgICAgICBhd2FpdCB0aGlzLl9pbnZhbGlkYXRlQWxsTW9kdWxlcygpO1xyXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5faW52YWxpZGF0ZUFsbFBsdWdpbnMoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fbG9hZEFsbFBsdWdpbnMoKTtcclxuXHJcbiAgICAgICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgSW1wb3J0cyBhbGwgbW9kdWxlc2ApO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX2ltcG9ydFByZXJlcXVpc2l0ZU1vZHVsZXMoKTtcclxuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGhvdFJlbG9hZFBsdWdpblNjcmlwdHMoe1xyXG4gICAgICAgIGNoYW5nZXMsXHJcbiAgICAgICAgcmVtb3ZhbHMsXHJcbiAgICB9OiB7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5omA5pyJ6KaB5L+u5pS555qE77yI5oiW5paw5aKe55qE77yJ5o+S5Lu26ISa5pys44CCXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgY2hhbmdlczogUmVjb3JkPFBsdWdpblNjcmlwdElkLCBQbHVnaW5TY3JpcHRJbmZvPlxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOaJgOacieimgeenu+mZpOeahOaPkuS7tuiEmuacrOOAglxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHJlbW92YWxzOiBQbHVnaW5TY3JpcHRJZFtdO1xyXG4gICAgfSkge1xyXG4gICAgICAgIGlmIChPYmplY3Qua2V5cyhjaGFuZ2VzKS5sZW5ndGggPT09IDAgJiYgcmVtb3ZhbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XHJcblxyXG4gICAgICAgIC8vIOW6lOeUqOS/ruaUuVxyXG4gICAgICAgIGZvciAoY29uc3QgcmVtb3ZhbCBvZiByZW1vdmFscykge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fcGx1Z2luc1tyZW1vdmFsXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpblNjcmlwdElkLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyhjaGFuZ2VzKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9wbHVnaW5zW3BsdWdpblNjcmlwdElkXSA9IHBsdWdpblNjcmlwdEluZm87XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhd2FpdCB0aGlzLl9sb2FkQWxsUGx1Z2lucygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpc01vZHVsZShpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIGlkIGluIHRoaXMuX21vZHVsZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGNsZWFyKCkge1xyXG4gICAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxQbHVnaW5zKCk7XHJcbiAgICAgICAgdGhpcy5fcGx1Z2lucyA9IHt9O1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX2ludmFsaWRhdGVBbGxNb2R1bGVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xmib7mjIflrprohJrmnKzmqKHlnZfkuK3ms6jlhoznmoTmiYDmnIkgY2Mg57G744CCXHJcbiAgICAgKiBAcGFyYW0gdXVpZCDmqKHlnZfnmoQgdXVpZOOAglxyXG4gICAgICogQHJldHVybnMg5oyH5a6a6ISa5pys5qih5Z2X5Lit5rOo5YaM55qE5omA5pyJIGNjIOexu++8m+WmguaenCBbdXVpZF0g5bm25LiN5a+55bqU5LiA5Liq5qih5Z2X5oiW5qih5Z2X5Lit5pyq5rOo5YaM5Lu75L2V57G75YiZ6L+U5ZueIGB1bmRlZmluZWRg44CCXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBxdWVyeUNsYXNzZXNJbk1vZHVsZSh1dWlkOiBzdHJpbmcpOiB1bmRlZmluZWQgfCBSZWFkb25seUFycmF5PFJlYWRvbmx5PEZ1bmN0aW9uPj4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1V1aWRNYXBbdXVpZF07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfcmVsb2FkUGFja01vZHMoKSB7XHJcbiAgICAgICAgLy8g5aSa6L+b56iL5pON5L2c5ZCM5LiA5Liq6LWE5rqQ44CC5aaC5p6c5LiN57uZ5paH5Lu25Yqg6ZSB77yM5Lya5a+86Ie05paH5Lu26K+75YaZ5Yay56qBXHJcbiAgICAgICAgYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24ubG9jaygpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLnJlbG9hZCgpO1xyXG5cclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uY2xlYXJJbXBvcnRNYXAoKTtcclxuXHJcbiAgICAgICAgY29uc3QgcXVpY2tQYWNrTG9hZGVySW1wb3J0TWFwID0gYXdhaXQgdGhpcy5fcGFja01vZEluc3RhbnRpYXRpb24uZ2V0SW1wb3J0TWFwKCk7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9yU3lzdGVtLmV4dGVuZEltcG9ydE1hcChxdWlja1BhY2tMb2FkZXJJbXBvcnRNYXAsIG5ldyBVUkwodGhpcy5fcGFja0xvYWRlci5pbXBvcnRNYXBVUkwsIHBhY2tSZXNvdXJjZUJhc2VVUkwpLmhyZWYpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3BhY2tNb2RJbnN0YW50aWF0aW9uLnVubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLl9lZGl0b3JTeXN0ZW0uZXh0ZW5kSW1wb3J0TWFwKHRoaXMuX2ZpeGVkSW1wb3J0TWFwLCB0aGlzLl9lbmdpbmVJbXBvcnRNYXBVUkwpO1xyXG5cclxuICAgICAgICBjb25zdCByZXNvbHV0aW9uRGV0YWlsTWFwID0gYXdhaXQgdGhpcy5fcGFja0xvYWRlci5sb2FkUmVzb2x1dGlvbkRldGFpbE1hcCgpO1xyXG4gICAgICAgIHRoaXMuX2VkaXRvclN5c3RlbS5zZXRSZXNvbHV0aW9uRGV0YWlsTWFwKHJlc29sdXRpb25EZXRhaWxNYXAsIG5ldyBVUkwodGhpcy5fcGFja0xvYWRlci5yZXNvbHV0aW9uRGV0YWlsTWFwVVJMLCBwYWNrUmVzb3VyY2VCYXNlVVJMKS5ocmVmKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9pbnZhbGlkYXRlQWxsTW9kdWxlcygpIHtcclxuICAgICAgICBjb25zdCBjYyA9IGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjJykgYXMgRW5naW5lRXhwb3J0cztcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCByZWdpc3RlcmVkQ2xhc3Mgb2YgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2JlZm9yZVVucmVnaXN0ZXJDbGFzcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fYmVmb3JlVW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2MuanMudW5yZWdpc3RlckNsYXNzKHJlZ2lzdGVyZWRDbGFzcyk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFVucmVnaXN0ZXIgJHtyZWdpc3RlcmVkQ2xhc3MubmFtZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJlZENsYXNzZXMgPSBbXTtcclxuXHJcbiAgICAgICAgdGhpcy5fY2xhc3NVdWlkTWFwID0ge307XHJcblxyXG4gICAgICAgIGNjLmNjbGVnYWN5Ll9SRi5yZXNldCgpO1xyXG5cclxuICAgICAgICB0aGlzLl9pbnZhbGlkYXRlQWxsUGFja01vZHMoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9pbnZhbGlkYXRlQWxsUGFja01vZHMoKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBwYWNrTW9kSWQgb2YgdGhpcy5faW5zdGFudGlhdGVkUGFja01vZHMpIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgSW52YWxpZGF0aW5nICcke3BhY2tNb2RJZH0nYCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFN5c3RlbS5kZWxldGUocGFja01vZElkKTtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYE5vdGU6IGZhaWxlZCB0byBkZWxldGUgJHtwYWNrTW9kSWR9LCBtYXliZSBpdCdzIGJlaW5nIGV4ZWN1dGluZz9gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9pbnN0YW50aWF0ZWRQYWNrTW9kcy5sZW5ndGggPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgX2ltcG9ydFByZXJlcXVpc2l0ZU1vZHVsZXMoKSB7XHJcbiAgICAgICAgY29uc3Qgb25DbGFzc1JlZ2lzdGVyZWQ6IEVkaXRvckV4dGVuZHMuTGlzdGVuZXI8J2NsYXNzLXJlZ2lzdGVyZWQnPiA9IChjbGFzc0NvbnN0cnVjdG9yLCBtZXRhZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9yZWdpc3RlcmVkQ2xhc3Nlcy5wdXNoKGNsYXNzQ29uc3RydWN0b3IpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBbW0V4ZWN1dG9yXV0gUmVnaXN0ZXIgJHtjbGFzc0NvbnN0cnVjdG9yLm5hbWV9YCk7XHJcbiAgICAgICAgICAgIGlmIChtZXRhZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgKHRoaXMuX2NsYXNzVXVpZE1hcFttZXRhZGF0YS51dWlkXSA/Pz0gW10pLnB1c2goY2xhc3NDb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBFZGl0b3JFeHRlbmRzLm9uKCdjbGFzcy1yZWdpc3RlcmVkJywgb25DbGFzc1JlZ2lzdGVyZWQpO1xyXG5cclxuICAgICAgICBjb25zdCBjYyA9IGF3YWl0IFN5c3RlbS5pbXBvcnQoJ2NjJykgYXMgRW5naW5lRXhwb3J0cztcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgU3lzdGVtLmltcG9ydCgnY2NlOi9pbnRlcm5hbC94L3ByZXJlcXVpc2l0ZS1pbXBvcnRzJyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2ltcG9ydEV4Y2VwdGlvbkhhbmRsZXIoZXJyKTtcclxuICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRFeGNlcHRpb25zLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIEVkaXRvckV4dGVuZHMucmVtb3ZlTGlzdGVuZXIoJ2NsYXNzLXJlZ2lzdGVyZWQnLCBvbkNsYXNzUmVnaXN0ZXJlZCk7XHJcbiAgICAgICAgICAgIC8vIOmhueebruiEmuacrOWPr+iDveWcqOaJp+ihjOeahOaXtuWAmeS8muaKm+WHuuW8guW4uO+8jOi/meWvvOiHtCBgY2MuX1JGYCDmsqHmnInmraPnoa7lvLnlh7rjgIJcclxuICAgICAgICAgICAgLy8g5oiR5Lus5Zyo5pyA5ZCO5riF55CG5LiA5LiL44CCXHJcbiAgICAgICAgICAgIGNjLmNjbGVnYWN5Ll9SRi5yZXNldCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIF9sb2FkQWxsUGx1Z2lucygpIHtcclxuICAgICAgICBjb25zdCBwbHVnaW5TY3JpcHREZXBlbmRlbmN5TWFwOiBBcnJheTxbc3RyaW5nLCByZWFkb25seSBzdHJpbmdbXV0+ID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm9dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuX3BsdWdpbnMpKSB7XHJcbiAgICAgICAgICAgIHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXAucHVzaChbcGx1Z2luU2NyaXB0SWQsIHBsdWdpblNjcmlwdEluZm8uZGVwZW5kZW5jaWVzXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNvcnRlZCA9IHNvcnRQbHVnaW5TY3JpcHRzKHBsdWdpblNjcmlwdERlcGVuZGVuY3lNYXApO1xyXG4gICAgICAgIGNvbnN0IHNvcnRlZE1hcHBlZCA9IHNvcnRlZC5tYXAoKHBsdWdpblNjcmlwdElkKSA9PiB0aGlzLl9wbHVnaW5zW3BsdWdpblNjcmlwdElkXS5maWxlKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2Ygc29ydGVkTWFwcGVkKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICByZXF1aXJlKGZpbGUpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfaW52YWxpZGF0ZUFsbFBsdWdpbnMoKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBbLCBwbHVnaW5TY3JpcHRJbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLl9wbHVnaW5zKSkge1xyXG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVtwbHVnaW5TY3JpcHRJbmZvLmZpbGVdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90cnlMb2c8Q2F0IGV4dGVuZHMga2V5b2YgRXhlY3V0b3IuTG9nZ2VyPihjYXQ6IENhdCwgLi4uYXJnczogUGFyYW1ldGVyczxOb25OdWxsYWJsZTxFeGVjdXRvci5Mb2dnZXJbQ2F0XT4+KSB7XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIHJldHVybiAoY2F0IGluIHRoaXMuX2xvZ2dlcikgPyB0aGlzLl9sb2dnZXJbY2F0XSEoLi4uYXJncykgOiB0aGlzLl9kZWZhdWx0TG9nKC4uLmFyZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2RlZmF1bHRMb2coLi4uYXJnczogYW55KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coLi4uYXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfb25Nb2R1bGVMb2FkZWQoZXJyb3I6IEVycm9yLCBpZDogc3RyaW5nLCBkZXBlbmRlbmNpZXM/OiBzdHJpbmdbXSkge1xyXG4gICAgICAgIGNvbnN0IGNhY2hlZEV4Y2VwdGlvbnMgPSB0aGlzLl9jYWNoZWRFeGNlcHRpb25zO1xyXG4gICAgICAgIGlmICghZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgW1tFeGVjdXRvcl1dIE1vZHVsZSBcIiR7aWR9XCIgbG9hZGVkLmApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghY2FjaGVkRXhjZXB0aW9ucy5oYXMoZXJyb3IpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9pbXBvcnRFeGNlcHRpb25IYW5kbGVyKGVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLl90cnlMb2coJ2xvYWRFeGNlcHRpb24nLCBpZCwgZXJyb3IsIGNhY2hlZEV4Y2VwdGlvbnMuaGFzKGVycm9yKSk7XHJcbiAgICAgICAgICAgIGNhY2hlZEV4Y2VwdGlvbnMuc2V0KGVycm9yLCBpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZGVjbGFyZSBfcGFja01vZEluc3RhbnRpYXRpb246IFBhY2tNb2RJbnN0YW50aWF0aW9uO1xyXG5cclxuICAgIHByaXZhdGUgX2JlZm9yZVVucmVnaXN0ZXJDbGFzcz86IEV4ZWN1dG9yLkJlZm9yZVVucmVnaXN0ZXJDbGFzcztcclxuICAgIHByaXZhdGUgX2NhY2hlZEV4Y2VwdGlvbnM6IE1hcDxhbnksIHN0cmluZz4gPSBuZXcgTWFwKCk7XHJcbiAgICBwcml2YXRlIF9jbGFzc1V1aWRNYXA6IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uW10+ID0ge307XHJcbiAgICBwcml2YXRlIF9sb2dnZXI6IFBhcnRpYWw8RXhlY3V0b3IuTG9nZ2VyPjtcclxuICAgIHByaXZhdGUgX2J1aWx0aW5Nb2RzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XHJcblxyXG4gICAgcHJpdmF0ZSBfaW1wb3J0RXhjZXB0aW9uSGFuZGxlcjogSW1wb3J0RXhjZXB0aW9uSGFuZGxlcjtcclxuXHJcbiAgICBwcml2YXRlIF9lZGl0b3JTeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xyXG4gICAgcHJpdmF0ZSBfbW9kdWxlczogUmVjb3JkPHN0cmluZywgTW9kdWxlU2NyaXB0SW5mbz4gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgcHJpdmF0ZSBfcmVnaXN0ZXJlZENsYXNzZXM6IEZ1bmN0aW9uW10gPSBbXTtcclxuXHJcbiAgICBwcml2YXRlIF9wbHVnaW5zOiBSZWNvcmQ8UGx1Z2luU2NyaXB0SWQsIFBsdWdpblNjcmlwdEluZm8+ID0ge307XHJcblxyXG4gICAgcHJpdmF0ZSBfZml4ZWRJbXBvcnRNYXA6IHsgaW1wb3J0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9ID0geyBpbXBvcnRzOiB7fSB9O1xyXG4gICAgcHJpdmF0ZSBfZW5naW5lSW1wb3J0TWFwVVJMID0gJyc7XHJcblxyXG4gICAgcHJpdmF0ZSBfcGFja0xvYWRlcjogUXVpY2tQYWNrTG9hZGVyO1xyXG4gICAgcHJpdmF0ZSBfaW5zdGFudGlhdGVkUGFja01vZHM6IHN0cmluZ1tdID0gW107XHJcbiAgICBwcml2YXRlIF9jY2VNb2R1bGVNYXA6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxufVxyXG5cclxuZXhwb3J0IG5hbWVzcGFjZSBFeGVjdXRvciB7XHJcbiAgICBleHBvcnQgdHlwZSBCZWZvcmVVbnJlZ2lzdGVyQ2xhc3MgPSAoY2xhc3NDb25zdHJ1Y3RvcjogRnVuY3Rpb24pID0+IHZvaWQ7XHJcblxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBSZXBvcnRlck1hcCB7XHJcbiAgICAgICAgWydwb3NzaWJsZS1jci11c2UnXToge1xyXG4gICAgICAgICAgICBpbXBvcnRlZDogc3RyaW5nO1xyXG4gICAgICAgICAgICBtb2R1bGVSZXF1ZXN0OiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGltcG9ydE1ldGE6IGFueTtcclxuICAgICAgICAgICAgZXh0cmFzOiBhbnk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgdHlwZSBMb2dnZXIgPSBQYXJ0aWFsPHtcclxuICAgICAgICBwb3NzaWJsZUNpcmN1bGFyUmVmZXJlbmNlOiAoXHJcbiAgICAgICAgICAgIGltcG9ydGVkOiBzdHJpbmcsXHJcbiAgICAgICAgICAgIG1vZHVsZVJlcXVlc3Q6IHN0cmluZyxcclxuICAgICAgICAgICAgaW1wb3J0TWV0YTogYW55LFxyXG4gICAgICAgICAgICBleHRyYXM6IGFueVxyXG4gICAgICAgICkgPT4gdm9pZDtcclxuXHJcbiAgICAgICAgbG9hZEV4Y2VwdGlvbjogKFxyXG4gICAgICAgICAgICBtb2R1bGVVcmw6IHN0cmluZyxcclxuICAgICAgICAgICAgZXJyb3I/OiBhbnksXHJcbiAgICAgICAgICAgIGhhc0JlZW5UaHJvd24/OiBib29sZWFuLFxyXG4gICAgICAgICkgPT4gdm9pZDtcclxuICAgIH0+O1xyXG5cclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XHJcbiAgICAgICAgaW1wb3J0RW5naW5lTW9kOiBJbXBvcnRFbmdpbmVNb2Q7XHJcbiAgICAgICAgcXVpY2tQYWNrTG9hZGVyQ29udGV4dDogTG9hZGVyQ29udGV4dDtcclxuICAgICAgICBiZWZvcmVVbnJlZ2lzdGVyQ2xhc3M/OiBCZWZvcmVVbnJlZ2lzdGVyQ2xhc3M7XHJcbiAgICAgICAgcGFja01vZHVsZUV2YWx1YXRvcj86IFBhY2tNb2R1bGVFdmFsdWF0b3I7XHJcbiAgICAgICAgbG9nZ2VyPzogTG9nZ2VyO1xyXG4gICAgICAgIGltcG9ydEV4Y2VwdGlvbkhhbmRsZXI/OiAoZXJyOiB1bmtub3duKSA9PiB2b2lkO1xyXG4gICAgICAgIGNjZU1vZHVsZU1hcDogUmVjb3JkPHN0cmluZywgYW55PjtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVJbmZvIHtcclxuICAgICAgICBwb2x5ZmlsbHM6IHN0cmluZ1tdO1xyXG4gICAgICAgIG1vZHVsZXM6IHN0cmluZ1tdO1xyXG4gICAgICAgIGJhcmVTcGVjaWZpZXJSZXNvbHZlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xyXG4gICAgICAgIGluc3RhbnRpYXRlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xyXG4gICAgfVxyXG59XHJcblxyXG50eXBlIFBsdWdpblNjcmlwdElkID0gc3RyaW5nO1xyXG5cclxuaW50ZXJmYWNlIFBsdWdpblNjcmlwdEluZm8ge1xyXG4gICAgLyoqXHJcbiAgICAgKiDohJrmnKzmlofku7bjgIJcclxuICAgICAqL1xyXG4gICAgZmlsZTogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5L6d6LWW55qE5o+S5Lu26ISa5pys44CCXHJcbiAgICAgKi9cclxuICAgIGRlcGVuZGVuY2llczogUGx1Z2luU2NyaXB0SWRbXTtcclxufVxyXG5cclxuaW50ZXJmYWNlIE1vZHVsZVNjcmlwdEluZm8ge1xyXG4gICAgLyoqXHJcbiAgICAgKiDmqKHlnZcgVVJM44CCXHJcbiAgICAgKi9cclxuICAgIG1vZHVsZVVybDogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Luj56CB5paH5Lu244CCXHJcbiAgICAgKi9cclxuICAgIGZpbGU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIEVuZ2luZUV4cG9ydHMge1xyXG4gICAgY2NsZWdhY3k6IHsgX1JGOiB7IHJlc2V0KCk6IHZvaWQ7IH0gfTtcclxuICAgIGpzOiB7IHVucmVnaXN0ZXJDbGFzcyhmOiBGdW5jdGlvbik6IHZvaWQ7IH07XHJcbn1cclxuXHJcbmRlY2xhcmUgbmFtZXNwYWNlIEVkaXRvckV4dGVuZHMge1xyXG4gICAgaW50ZXJmYWNlIEV2ZW50TWFwIHtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBDYWxsZWQgd2hlbiBhIGNjLWNsYXNzIGlzIHJlZ2lzdGVyZWQuXHJcbiAgICAgICAgICogQHBhcmFtIGNsYXNzQ29uc3RydWN0b3IgUmVnaXN0ZXJpbmcgY2xhc3MuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgJ2NsYXNzLXJlZ2lzdGVyZWQnKGNsYXNzQ29uc3RydWN0b3I6IEZ1bmN0aW9uLCBtZXRhZGF0YT86IFJlYWRvbmx5PGFueT4pOiB2b2lkO1xyXG4gICAgfVxyXG5cclxuICAgIHR5cGUgRXZlbnRBcmdzPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPiA9IFBhcmFtZXRlcnM8RXZlbnRNYXBbRXZlbnROYW1lXT47XHJcblxyXG4gICAgdHlwZSBMaXN0ZW5lcjxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4gPSAoLi4uYXJnczogRXZlbnRBcmdzPEV2ZW50TmFtZT4pID0+IHZvaWQ7XHJcblxyXG4gICAgZnVuY3Rpb24gZW1pdDxFdmVudE5hbWUgZXh0ZW5kcyBrZXlvZiBFdmVudE1hcD4obmFtZTogRXZlbnROYW1lLCAuLi5hcmdzOiBFdmVudEFyZ3M8RXZlbnROYW1lPik6IHZvaWQ7XHJcblxyXG4gICAgZnVuY3Rpb24gb248RXZlbnROYW1lIGV4dGVuZHMga2V5b2YgRXZlbnRNYXA+KG5hbWU6IEV2ZW50TmFtZSwgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50TmFtZT4pOiB2b2lkO1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyPEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50TWFwPihuYW1lOiBFdmVudE5hbWUsIGxpc3RlbmVyOiBMaXN0ZW5lcjxFdmVudE5hbWU+KTogdm9pZDtcclxufVxyXG4iXX0=