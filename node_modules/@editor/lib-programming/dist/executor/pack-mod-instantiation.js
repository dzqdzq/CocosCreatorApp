"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PackModInstantiation = void 0;
const asserts_1 = require("../utils/asserts");
const i18n_1 = require("../utils/i18n");
const defaultPackModuleEvaluator = {
    evaluate(file) {
        let moduleFileResolved;
        try {
            moduleFileResolved = require.resolve(file);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_resolve_error', { url: file, reason: err }));
        }
        try {
            require(moduleFileResolved);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_execute_error', { url: file, reason: err }));
        }
        if (!(moduleFileResolved in require.cache)) {
            console.debug(`${file} resolved to ${moduleFileResolved} is not in module cache!`);
        }
        else {
            const mod = require.cache[moduleFileResolved];
            delete require.cache[moduleFileResolved];
            if (mod && mod.parent) {
                const index = mod.parent.children.indexOf(mod);
                if (index !== -1) {
                    mod.parent.children.splice(index, 1);
                }
            }
        }
    },
};
class PackModInstantiation {
    constructor(quickPackLoader, system, evaluator) {
        this._cachedRegisters = {};
        this._quickPackLoader = quickPackLoader;
        // const system = {
        //     register: (...moduleRegister: ModuleRegister) => {
        //         if (this._lastRegister) {
        //             throw new Error(`Unknown register. Did you have more than one System.register() in your code?`);
        //         }
        //         this._lastRegister = [...moduleRegister];
        //     },
        // };
        // this._registerContext = vm.createContext({
        //     System: system,
        // });
        this._system = system;
        this._evaluator = evaluator !== null && evaluator !== void 0 ? evaluator : defaultPackModuleEvaluator;
    }
    async instantiate(link) {
        const resourceId = this._quickPackLoader.getResourceId(link);
        let cached = this._cachedRegisters[resourceId];
        if (!cached) {
            this._cachedRegisters[resourceId] = undefined;
            const mTimestamp = await this._quickPackLoader.getResourceMTimestamp(resourceId);
            const resource = await this._quickPackLoader.getResourceFromId(resourceId);
            asserts_1.asserts(mTimestamp >= 0);
            asserts_1.asserts(resource.type === 'file');
            const file = resource.path;
            // const code = await fs.readFile(file, 'utf8');
            const register = this._evalCode2(file);
            cached = {
                register,
                mTimestamp,
            };
            this._cachedRegisters[resourceId] = cached;
        }
        return cached.register;
    }
    /**
     * 重新加载底层的 Pack Loader 并且移除所有失效的缓存。
     */
    async reload() {
        await this._quickPackLoader.reload();
        const cachedChunks = Object.keys(this._cachedRegisters);
        const mTimestamps = await this._quickPackLoader.getResourceMTimestamps(cachedChunks);
        cachedChunks.forEach((chunkId, iChunk) => {
            const cache = this._cachedRegisters[chunkId];
            if (!cache || cache.mTimestamp !== mTimestamps[iChunk]) {
                delete this._cachedRegisters[chunkId];
            }
        });
    }
    async getImportMap() {
        return await this._quickPackLoader.getImportMap();
    }
    _evalCode2(file) {
        this._evaluator.evaluate(file);
        const register = this._system.getRegister();
        if (!register) {
            throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url: file }));
        }
        return register;
    }
}
exports.PackModInstantiation = PackModInstantiation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjay1tb2QtaW5zdGFudGlhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGVjdXRvci9wYWNrLW1vZC1pbnN0YW50aWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDhDQUEyQztBQUkzQyx3Q0FBOEM7QUFNOUMsTUFBTSwwQkFBMEIsR0FBd0I7SUFDcEQsUUFBUSxDQUFDLElBQVk7UUFDakIsSUFBSSxrQkFBMEIsQ0FBQztRQUMvQixJQUFJO1lBQ0Esa0JBQWtCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBYSxDQUN6QiwwREFBMEQsRUFDMUQsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDN0IsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJO1lBQ0EsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDL0I7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQWEsQ0FDekIsMERBQTBELEVBQzFELEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQzdCLENBQUMsQ0FBQztTQUNOO1FBRUQsSUFBSSxDQUFDLENBQUMsa0JBQWtCLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLGdCQUFnQixrQkFBa0IsMEJBQTBCLENBQUMsQ0FBQztTQUN0RjthQUFNO1lBQ0gsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzlDLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3pDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUU7Z0JBQ25CLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0MsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7b0JBQ2QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDeEM7YUFDSjtTQUNKO0lBQ0wsQ0FBQztDQUNKLENBQUM7QUFFRixNQUFhLG9CQUFvQjtJQUM3QixZQUFZLGVBQWdDLEVBQUUsTUFBc0IsRUFBRSxTQUErQjtRQWdFN0YscUJBQWdCLEdBR1AsRUFBRSxDQUFDO1FBbEVoQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZUFBZSxDQUFDO1FBQ3hDLG1CQUFtQjtRQUNuQix5REFBeUQ7UUFDekQsb0NBQW9DO1FBQ3BDLCtHQUErRztRQUMvRyxZQUFZO1FBQ1osb0RBQW9EO1FBQ3BELFNBQVM7UUFDVCxLQUFLO1FBQ0wsNkNBQTZDO1FBQzdDLHNCQUFzQjtRQUN0QixNQUFNO1FBQ04sSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLGFBQVQsU0FBUyxjQUFULFNBQVMsR0FBSSwwQkFBMEIsQ0FBQztJQUM5RCxDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFZO1FBQ2pDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0QsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDVCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLEdBQUcsU0FBUyxDQUFDO1lBRTlDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pGLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTNFLGlCQUFPLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLGlCQUFPLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsQ0FBQztZQUVsQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQzNCLGdEQUFnRDtZQUNoRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sR0FBRztnQkFDTCxRQUFRO2dCQUNSLFVBQVU7YUFDYixDQUFDO1lBQ0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQztTQUM5QztRQUVELE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsTUFBTTtRQUNmLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3JDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFpQixDQUFDO1FBQ3hFLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JGLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLFVBQVUsS0FBSyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3BELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sS0FBSyxDQUFDLFlBQVk7UUFDckIsT0FBTyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBZ0NPLFVBQVUsQ0FBQyxJQUFZO1FBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRS9CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQWEsQ0FDekIseUNBQXlDLEVBQ3pDLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUNoQixDQUFDLENBQUM7U0FDTjtRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7Q0FDSjtBQTFHRCxvREEwR0MiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB2bSBmcm9tICd2bSc7XG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vdXRpbHMvYXNzZXJ0cyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgUmVzb3VyY2VNVGltZXN0YW1wLCBSZXNvdXJjZUlkLCBRdWlja1BhY2tMb2FkZXIgfSBmcm9tICcuLi9tb2QtYXNzZW1ibGluZy9xdWljay1wYWNrL2xvYWRlcic7XG5pbXBvcnQgdHlwZSB7IEV4ZWN1dG9yU3lzdGVtIH0gZnJvbSAnLi4vZWRpdG9yLXN5c3RlbWpzJztcbmltcG9ydCB7IGkxOG5UcmFuc2xhdGUgfSBmcm9tICcuLi91dGlscy9pMThuJztcblxuZXhwb3J0IGludGVyZmFjZSBQYWNrTW9kdWxlRXZhbHVhdG9yIHtcbiAgICBldmFsdWF0ZShmaWxlOiBzdHJpbmcpOiB2b2lkO1xufVxuXG5jb25zdCBkZWZhdWx0UGFja01vZHVsZUV2YWx1YXRvcjogUGFja01vZHVsZUV2YWx1YXRvciA9IHtcbiAgICBldmFsdWF0ZShmaWxlOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IG1vZHVsZUZpbGVSZXNvbHZlZDogc3RyaW5nO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbW9kdWxlRmlsZVJlc29sdmVkID0gcmVxdWlyZS5yZXNvbHZlKGZpbGUpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuVHJhbnNsYXRlKFxuICAgICAgICAgICAgICAgICdleGVjdXRvcl9wYWNrX21vZF9pbnN0YW50aWF0aW9uX2Vycm9yX2hvc3RfcmVzb2x2ZV9lcnJvcicsXG4gICAgICAgICAgICAgICAgeyB1cmw6IGZpbGUsIHJlYXNvbjogZXJyIH0sXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXF1aXJlKG1vZHVsZUZpbGVSZXNvbHZlZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG5UcmFuc2xhdGUoXG4gICAgICAgICAgICAgICAgJ2V4ZWN1dG9yX3BhY2tfbW9kX2luc3RhbnRpYXRpb25fZXJyb3JfaG9zdF9leGVjdXRlX2Vycm9yJyxcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSwgcmVhc29uOiBlcnIgfSxcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEobW9kdWxlRmlsZVJlc29sdmVkIGluIHJlcXVpcmUuY2FjaGUpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGAke2ZpbGV9IHJlc29sdmVkIHRvICR7bW9kdWxlRmlsZVJlc29sdmVkfSBpcyBub3QgaW4gbW9kdWxlIGNhY2hlIWApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbW9kID0gcmVxdWlyZS5jYWNoZVttb2R1bGVGaWxlUmVzb2x2ZWRdO1xuICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbbW9kdWxlRmlsZVJlc29sdmVkXTtcbiAgICAgICAgICAgIGlmIChtb2QgJiYgbW9kLnBhcmVudCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gbW9kLnBhcmVudC5jaGlsZHJlbi5pbmRleE9mKG1vZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBtb2QucGFyZW50LmNoaWxkcmVuLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjbGFzcyBQYWNrTW9kSW5zdGFudGlhdGlvbiB7XG4gICAgY29uc3RydWN0b3IocXVpY2tQYWNrTG9hZGVyOiBRdWlja1BhY2tMb2FkZXIsIHN5c3RlbTogRXhlY3V0b3JTeXN0ZW0sIGV2YWx1YXRvcj86IFBhY2tNb2R1bGVFdmFsdWF0b3IpIHtcbiAgICAgICAgdGhpcy5fcXVpY2tQYWNrTG9hZGVyID0gcXVpY2tQYWNrTG9hZGVyO1xuICAgICAgICAvLyBjb25zdCBzeXN0ZW0gPSB7XG4gICAgICAgIC8vICAgICByZWdpc3RlcjogKC4uLm1vZHVsZVJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlcikgPT4ge1xuICAgICAgICAvLyAgICAgICAgIGlmICh0aGlzLl9sYXN0UmVnaXN0ZXIpIHtcbiAgICAgICAgLy8gICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHJlZ2lzdGVyLiBEaWQgeW91IGhhdmUgbW9yZSB0aGFuIG9uZSBTeXN0ZW0ucmVnaXN0ZXIoKSBpbiB5b3VyIGNvZGU/YCk7XG4gICAgICAgIC8vICAgICAgICAgfVxuICAgICAgICAvLyAgICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IFsuLi5tb2R1bGVSZWdpc3Rlcl07XG4gICAgICAgIC8vICAgICB9LFxuICAgICAgICAvLyB9O1xuICAgICAgICAvLyB0aGlzLl9yZWdpc3RlckNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KHtcbiAgICAgICAgLy8gICAgIFN5c3RlbTogc3lzdGVtLFxuICAgICAgICAvLyB9KTtcbiAgICAgICAgdGhpcy5fc3lzdGVtID0gc3lzdGVtO1xuICAgICAgICB0aGlzLl9ldmFsdWF0b3IgPSBldmFsdWF0b3IgPz8gZGVmYXVsdFBhY2tNb2R1bGVFdmFsdWF0b3I7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGluc3RhbnRpYXRlKGxpbms6IHN0cmluZykge1xuICAgICAgICBjb25zdCByZXNvdXJjZUlkID0gdGhpcy5fcXVpY2tQYWNrTG9hZGVyLmdldFJlc291cmNlSWQobGluayk7XG5cbiAgICAgICAgbGV0IGNhY2hlZCA9IHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tyZXNvdXJjZUlkXTtcbiAgICAgICAgaWYgKCFjYWNoZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tyZXNvdXJjZUlkXSA9IHVuZGVmaW5lZDtcblxuICAgICAgICAgICAgY29uc3QgbVRpbWVzdGFtcCA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZU1UaW1lc3RhbXAocmVzb3VyY2VJZCk7XG4gICAgICAgICAgICBjb25zdCByZXNvdXJjZSA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZUZyb21JZChyZXNvdXJjZUlkKTtcblxuICAgICAgICAgICAgYXNzZXJ0cyhtVGltZXN0YW1wID49IDApO1xuICAgICAgICAgICAgYXNzZXJ0cyhyZXNvdXJjZS50eXBlID09PSAnZmlsZScpO1xuXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gcmVzb3VyY2UucGF0aDtcbiAgICAgICAgICAgIC8vIGNvbnN0IGNvZGUgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlLCAndXRmOCcpO1xuICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSB0aGlzLl9ldmFsQ29kZTIoZmlsZSk7XG4gICAgICAgICAgICBjYWNoZWQgPSB7XG4gICAgICAgICAgICAgICAgcmVnaXN0ZXIsXG4gICAgICAgICAgICAgICAgbVRpbWVzdGFtcCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbcmVzb3VyY2VJZF0gPSBjYWNoZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2FjaGVkLnJlZ2lzdGVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOWKoOi9veW6leWxgueahCBQYWNrIExvYWRlciDlubbkuJTnp7vpmaTmiYDmnInlpLHmlYjnmoTnvJPlrZjjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIucmVsb2FkKCk7XG4gICAgICAgIGNvbnN0IGNhY2hlZENodW5rcyA9IE9iamVjdC5rZXlzKHRoaXMuX2NhY2hlZFJlZ2lzdGVycykgYXMgUmVzb3VyY2VJZFtdO1xuICAgICAgICBjb25zdCBtVGltZXN0YW1wcyA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZU1UaW1lc3RhbXBzKGNhY2hlZENodW5rcyk7XG4gICAgICAgIGNhY2hlZENodW5rcy5mb3JFYWNoKChjaHVua0lkLCBpQ2h1bmspID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW2NodW5rSWRdO1xuICAgICAgICAgICAgaWYgKCFjYWNoZSB8fCBjYWNoZS5tVGltZXN0YW1wICE9PSBtVGltZXN0YW1wc1tpQ2h1bmtdKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tjaHVua0lkXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGdldEltcG9ydE1hcCgpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRJbXBvcnRNYXAoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9xdWlja1BhY2tMb2FkZXI6IFF1aWNrUGFja0xvYWRlcjtcblxuICAgIHByaXZhdGUgX2NhY2hlZFJlZ2lzdGVyczogUmVjb3JkPFJlc291cmNlSWQsIHtcbiAgICAgICAgbVRpbWVzdGFtcDogUmVzb3VyY2VNVGltZXN0YW1wO1xuICAgICAgICByZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXI7XG4gICAgfSB8IHVuZGVmaW5lZD4gPSB7fTtcblxuICAgIC8vIHByaXZhdGUgX3JlZ2lzdGVyQ29udGV4dDogdm0uQ29udGV4dDtcblxuICAgIC8vIHByaXZhdGUgX2xhc3RSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIgfCBudWxsID0gbnVsbDtcblxuICAgIC8vIHByaXZhdGUgX2V2YWxDb2RlKGNvZGU6IHN0cmluZywgZmlsZU5hbWU/OiBzdHJpbmcpOiBNb2R1bGVSZWdpc3RlciB8IG51bGwge1xuICAgIC8vICAgICBhc3NlcnRzKHRoaXMuX2xhc3RSZWdpc3RlciA9PT0gbnVsbCk7XG4gICAgLy8gICAgIGxldCBsYXN0UmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbDtcbiAgICAvLyAgICAgdHJ5IHtcbiAgICAvLyAgICAgICAgIHZtLnJ1bkluQ29udGV4dChjb2RlLCB0aGlzLl9yZWdpc3RlckNvbnRleHQsIHtcbiAgICAvLyAgICAgICAgICAgICBmaWxlbmFtZTogZmlsZU5hbWUsXG4gICAgLy8gICAgICAgICAgICAgZGlzcGxheUVycm9yczogdHJ1ZSxcbiAgICAvLyAgICAgICAgIH0pO1xuICAgIC8vICAgICAgICAgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xuICAgIC8vICAgICB9IGZpbmFsbHkge1xuICAgIC8vICAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gbnVsbDtcbiAgICAvLyAgICAgfVxuICAgIC8vICAgICByZXR1cm4gbGFzdFJlZ2lzdGVyO1xuICAgIC8vIH1cblxuICAgIHByaXZhdGUgX3N5c3RlbTogRXhlY3V0b3JTeXN0ZW07XG5cbiAgICBwcml2YXRlIF9ldmFsdWF0b3I6IFBhY2tNb2R1bGVFdmFsdWF0b3I7XG5cbiAgICBwcml2YXRlIF9ldmFsQ29kZTIoZmlsZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2V2YWx1YXRvci5ldmFsdWF0ZShmaWxlKTtcblxuICAgICAgICBjb25zdCByZWdpc3RlciA9IHRoaXMuX3N5c3RlbS5nZXRSZWdpc3RlcigpO1xuICAgICAgICBpZiAoIXJlZ2lzdGVyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZShcbiAgICAgICAgICAgICAgICAnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJyxcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSB9LFxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVnaXN0ZXI7XG4gICAgfVxufVxuIl19