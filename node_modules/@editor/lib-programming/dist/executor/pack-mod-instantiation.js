"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PackModInstantiation = void 0;
const asserts_1 = require("../utils/asserts");
const i18n_1 = require("../utils/i18n");
const defaultPackModuleEvaluator = {
    evaluate(file) {
        let moduleFileResolved;
        try {
            moduleFileResolved = require.resolve(file);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_resolve_error', { url: file, reason: err }));
        }
        try {
            require(moduleFileResolved);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_execute_error', { url: file, reason: err }));
        }
        if (!(moduleFileResolved in require.cache)) {
            console.debug(`${file} resolved to ${moduleFileResolved} is not in module cache!`);
        }
        else {
            delete require.cache[moduleFileResolved];
        }
    },
};
class PackModInstantiation {
    constructor(quickPackLoader, system, evaluator) {
        this._cachedRegisters = {};
        this._quickPackLoader = quickPackLoader;
        // const system = {
        //     register: (...moduleRegister: ModuleRegister) => {
        //         if (this._lastRegister) {
        //             throw new Error(`Unknown register. Did you have more than one System.register() in your code?`);
        //         }
        //         this._lastRegister = [...moduleRegister];
        //     },
        // };
        // this._registerContext = vm.createContext({
        //     System: system,
        // });
        this._system = system;
        this._evaluator = evaluator !== null && evaluator !== void 0 ? evaluator : defaultPackModuleEvaluator;
    }
    async instantiate(link) {
        const resourceId = this._quickPackLoader.getResourceId(link);
        let cached = this._cachedRegisters[resourceId];
        if (!cached) {
            this._cachedRegisters[resourceId] = undefined;
            const mTimestamp = await this._quickPackLoader.getResourceMTimestamp(resourceId);
            const resource = await this._quickPackLoader.getResourceFromId(resourceId);
            asserts_1.asserts(mTimestamp >= 0);
            asserts_1.asserts(resource.type === 'file');
            const file = resource.path;
            // const code = await fs.readFile(file, 'utf8');
            const register = this._evalCode2(file);
            cached = {
                register,
                mTimestamp,
            };
            this._cachedRegisters[resourceId] = cached;
        }
        return cached.register;
    }
    /**
     * 重新加载底层的 Pack Loader 并且移除所有失效的缓存。
     */
    async reload() {
        await this._quickPackLoader.reload();
        const cachedChunks = Object.keys(this._cachedRegisters);
        const mTimestamps = await this._quickPackLoader.getResourceMTimestamps(cachedChunks);
        cachedChunks.forEach((chunkId, iChunk) => {
            const cache = this._cachedRegisters[chunkId];
            if (!cache || cache.mTimestamp !== mTimestamps[iChunk]) {
                delete this._cachedRegisters[chunkId];
            }
        });
    }
    async getImportMap() {
        return await this._quickPackLoader.getImportMap();
    }
    _evalCode2(file) {
        this._evaluator.evaluate(file);
        const register = this._system.getRegister();
        if (!register) {
            throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url: file }));
        }
        return register;
    }
}
exports.PackModInstantiation = PackModInstantiation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjay1tb2QtaW5zdGFudGlhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGVjdXRvci9wYWNrLW1vZC1pbnN0YW50aWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDhDQUEyQztBQUkzQyx3Q0FBOEM7QUFNOUMsTUFBTSwwQkFBMEIsR0FBd0I7SUFDcEQsUUFBUSxDQUFDLElBQVk7UUFDakIsSUFBSSxrQkFBMEIsQ0FBQztRQUMvQixJQUFJO1lBQ0Esa0JBQWtCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBYSxDQUN6QiwwREFBMEQsRUFDMUQsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDN0IsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJO1lBQ0EsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDL0I7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQWEsQ0FDekIsMERBQTBELEVBQzFELEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQzdCLENBQUMsQ0FBQztTQUNOO1FBRUQsSUFBSSxDQUFDLENBQUMsa0JBQWtCLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLGdCQUFnQixrQkFBa0IsMEJBQTBCLENBQUMsQ0FBQztTQUN0RjthQUFNO1lBQ0gsT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDNUM7SUFDTCxDQUFDO0NBQ0osQ0FBQztBQUVGLE1BQWEsb0JBQW9CO0lBQzdCLFlBQVksZUFBZ0MsRUFBRSxNQUFzQixFQUFFLFNBQStCO1FBZ0U3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QkFBYSxDQUN6Qix5Q0FBeUMsRUFDekMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQ2hCLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztDQUNKO0FBMUdELG9EQTBHQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgdm0gZnJvbSAndm0nO1xyXG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vdXRpbHMvYXNzZXJ0cyc7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcbmltcG9ydCB7IFJlc291cmNlTVRpbWVzdGFtcCwgUmVzb3VyY2VJZCwgUXVpY2tQYWNrTG9hZGVyIH0gZnJvbSAnLi4vbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay9sb2FkZXInO1xyXG5pbXBvcnQgdHlwZSB7IEV4ZWN1dG9yU3lzdGVtIH0gZnJvbSAnLi4vZWRpdG9yLXN5c3RlbWpzJztcclxuaW1wb3J0IHsgaTE4blRyYW5zbGF0ZSB9IGZyb20gJy4uL3V0aWxzL2kxOG4nO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYWNrTW9kdWxlRXZhbHVhdG9yIHtcclxuICAgIGV2YWx1YXRlKGZpbGU6IHN0cmluZyk6IHZvaWQ7XHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRQYWNrTW9kdWxlRXZhbHVhdG9yOiBQYWNrTW9kdWxlRXZhbHVhdG9yID0ge1xyXG4gICAgZXZhbHVhdGUoZmlsZTogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IG1vZHVsZUZpbGVSZXNvbHZlZDogc3RyaW5nO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIG1vZHVsZUZpbGVSZXNvbHZlZCA9IHJlcXVpcmUucmVzb2x2ZShmaWxlKTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG5UcmFuc2xhdGUoXHJcbiAgICAgICAgICAgICAgICAnZXhlY3V0b3JfcGFja19tb2RfaW5zdGFudGlhdGlvbl9lcnJvcl9ob3N0X3Jlc29sdmVfZXJyb3InLFxyXG4gICAgICAgICAgICAgICAgeyB1cmw6IGZpbGUsIHJlYXNvbjogZXJyIH0sXHJcbiAgICAgICAgICAgICkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmVxdWlyZShtb2R1bGVGaWxlUmVzb2x2ZWQpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZShcclxuICAgICAgICAgICAgICAgICdleGVjdXRvcl9wYWNrX21vZF9pbnN0YW50aWF0aW9uX2Vycm9yX2hvc3RfZXhlY3V0ZV9lcnJvcicsXHJcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSwgcmVhc29uOiBlcnIgfSxcclxuICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIShtb2R1bGVGaWxlUmVzb2x2ZWQgaW4gcmVxdWlyZS5jYWNoZSkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJHtmaWxlfSByZXNvbHZlZCB0byAke21vZHVsZUZpbGVSZXNvbHZlZH0gaXMgbm90IGluIG1vZHVsZSBjYWNoZSFgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVttb2R1bGVGaWxlUmVzb2x2ZWRdO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgUGFja01vZEluc3RhbnRpYXRpb24ge1xyXG4gICAgY29uc3RydWN0b3IocXVpY2tQYWNrTG9hZGVyOiBRdWlja1BhY2tMb2FkZXIsIHN5c3RlbTogRXhlY3V0b3JTeXN0ZW0sIGV2YWx1YXRvcj86IFBhY2tNb2R1bGVFdmFsdWF0b3IpIHtcclxuICAgICAgICB0aGlzLl9xdWlja1BhY2tMb2FkZXIgPSBxdWlja1BhY2tMb2FkZXI7XHJcbiAgICAgICAgLy8gY29uc3Qgc3lzdGVtID0ge1xyXG4gICAgICAgIC8vICAgICByZWdpc3RlcjogKC4uLm1vZHVsZVJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlcikgPT4ge1xyXG4gICAgICAgIC8vICAgICAgICAgaWYgKHRoaXMuX2xhc3RSZWdpc3Rlcikge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biByZWdpc3Rlci4gRGlkIHlvdSBoYXZlIG1vcmUgdGhhbiBvbmUgU3lzdGVtLnJlZ2lzdGVyKCkgaW4geW91ciBjb2RlP2ApO1xyXG4gICAgICAgIC8vICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gWy4uLm1vZHVsZVJlZ2lzdGVyXTtcclxuICAgICAgICAvLyAgICAgfSxcclxuICAgICAgICAvLyB9O1xyXG4gICAgICAgIC8vIHRoaXMuX3JlZ2lzdGVyQ29udGV4dCA9IHZtLmNyZWF0ZUNvbnRleHQoe1xyXG4gICAgICAgIC8vICAgICBTeXN0ZW06IHN5c3RlbSxcclxuICAgICAgICAvLyB9KTtcclxuICAgICAgICB0aGlzLl9zeXN0ZW0gPSBzeXN0ZW07XHJcbiAgICAgICAgdGhpcy5fZXZhbHVhdG9yID0gZXZhbHVhdG9yID8/IGRlZmF1bHRQYWNrTW9kdWxlRXZhbHVhdG9yO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBpbnN0YW50aWF0ZShsaW5rOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCByZXNvdXJjZUlkID0gdGhpcy5fcXVpY2tQYWNrTG9hZGVyLmdldFJlc291cmNlSWQobGluayk7XHJcblxyXG4gICAgICAgIGxldCBjYWNoZWQgPSB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbcmVzb3VyY2VJZF07XHJcbiAgICAgICAgaWYgKCFjYWNoZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW3Jlc291cmNlSWRdID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgbVRpbWVzdGFtcCA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZU1UaW1lc3RhbXAocmVzb3VyY2VJZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc291cmNlID0gYXdhaXQgdGhpcy5fcXVpY2tQYWNrTG9hZGVyLmdldFJlc291cmNlRnJvbUlkKHJlc291cmNlSWQpO1xyXG5cclxuICAgICAgICAgICAgYXNzZXJ0cyhtVGltZXN0YW1wID49IDApO1xyXG4gICAgICAgICAgICBhc3NlcnRzKHJlc291cmNlLnR5cGUgPT09ICdmaWxlJyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gcmVzb3VyY2UucGF0aDtcclxuICAgICAgICAgICAgLy8gY29uc3QgY29kZSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGUsICd1dGY4Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gdGhpcy5fZXZhbENvZGUyKGZpbGUpO1xyXG4gICAgICAgICAgICBjYWNoZWQgPSB7XHJcbiAgICAgICAgICAgICAgICByZWdpc3RlcixcclxuICAgICAgICAgICAgICAgIG1UaW1lc3RhbXAsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tyZXNvdXJjZUlkXSA9IGNhY2hlZFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNhY2hlZC5yZWdpc3RlcjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOmHjeaWsOWKoOi9veW6leWxgueahCBQYWNrIExvYWRlciDlubbkuJTnp7vpmaTmiYDmnInlpLHmlYjnmoTnvJPlrZjjgIJcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIucmVsb2FkKCk7XHJcbiAgICAgICAgY29uc3QgY2FjaGVkQ2h1bmtzID0gT2JqZWN0LmtleXModGhpcy5fY2FjaGVkUmVnaXN0ZXJzKSBhcyBSZXNvdXJjZUlkW107XHJcbiAgICAgICAgY29uc3QgbVRpbWVzdGFtcHMgPSBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0UmVzb3VyY2VNVGltZXN0YW1wcyhjYWNoZWRDaHVua3MpO1xyXG4gICAgICAgIGNhY2hlZENodW5rcy5mb3JFYWNoKChjaHVua0lkLCBpQ2h1bmspID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY2FjaGUgPSB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbY2h1bmtJZF07XHJcbiAgICAgICAgICAgIGlmICghY2FjaGUgfHwgY2FjaGUubVRpbWVzdGFtcCAhPT0gbVRpbWVzdGFtcHNbaUNodW5rXSkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tjaHVua0lkXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBnZXRJbXBvcnRNYXAoKSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRJbXBvcnRNYXAoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9xdWlja1BhY2tMb2FkZXI6IFF1aWNrUGFja0xvYWRlcjtcclxuXHJcbiAgICBwcml2YXRlIF9jYWNoZWRSZWdpc3RlcnM6IFJlY29yZDxSZXNvdXJjZUlkLCB7XHJcbiAgICAgICAgbVRpbWVzdGFtcDogUmVzb3VyY2VNVGltZXN0YW1wO1xyXG4gICAgICAgIHJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlcjtcclxuICAgIH0gfCB1bmRlZmluZWQ+ID0ge307XHJcblxyXG4gICAgLy8gcHJpdmF0ZSBfcmVnaXN0ZXJDb250ZXh0OiB2bS5Db250ZXh0O1xyXG5cclxuICAgIC8vIHByaXZhdGUgX2xhc3RSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICAvLyBwcml2YXRlIF9ldmFsQ29kZShjb2RlOiBzdHJpbmcsIGZpbGVOYW1lPzogc3RyaW5nKTogTW9kdWxlUmVnaXN0ZXIgfCBudWxsIHtcclxuICAgIC8vICAgICBhc3NlcnRzKHRoaXMuX2xhc3RSZWdpc3RlciA9PT0gbnVsbCk7XHJcbiAgICAvLyAgICAgbGV0IGxhc3RSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIgfCBudWxsO1xyXG4gICAgLy8gICAgIHRyeSB7XHJcbiAgICAvLyAgICAgICAgIHZtLnJ1bkluQ29udGV4dChjb2RlLCB0aGlzLl9yZWdpc3RlckNvbnRleHQsIHtcclxuICAgIC8vICAgICAgICAgICAgIGZpbGVuYW1lOiBmaWxlTmFtZSxcclxuICAgIC8vICAgICAgICAgICAgIGRpc3BsYXlFcnJvcnM6IHRydWUsXHJcbiAgICAvLyAgICAgICAgIH0pO1xyXG4gICAgLy8gICAgICAgICBsYXN0UmVnaXN0ZXIgPSB0aGlzLl9sYXN0UmVnaXN0ZXI7XHJcbiAgICAvLyAgICAgfSBmaW5hbGx5IHtcclxuICAgIC8vICAgICAgICAgdGhpcy5fbGFzdFJlZ2lzdGVyID0gbnVsbDtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcclxuICAgIC8vIH1cclxuXHJcbiAgICBwcml2YXRlIF9zeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xyXG5cclxuICAgIHByaXZhdGUgX2V2YWx1YXRvcjogUGFja01vZHVsZUV2YWx1YXRvcjtcclxuXHJcbiAgICBwcml2YXRlIF9ldmFsQ29kZTIoZmlsZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fZXZhbHVhdG9yLmV2YWx1YXRlKGZpbGUpO1xyXG5cclxuICAgICAgICBjb25zdCByZWdpc3RlciA9IHRoaXMuX3N5c3RlbS5nZXRSZWdpc3RlcigpO1xyXG4gICAgICAgIGlmICghcmVnaXN0ZXIpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG5UcmFuc2xhdGUoXHJcbiAgICAgICAgICAgICAgICAnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJyxcclxuICAgICAgICAgICAgICAgIHsgdXJsOiBmaWxlIH0sXHJcbiAgICAgICAgICAgICkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlZ2lzdGVyO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==