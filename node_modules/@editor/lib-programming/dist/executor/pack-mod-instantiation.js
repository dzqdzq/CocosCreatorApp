"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PackModInstantiation = void 0;
const vm_1 = __importDefault(require("vm"));
const asserts_1 = require("../utils/asserts");
const fs_extra_1 = __importDefault(require("fs-extra"));
const i18n_1 = require("../utils/i18n");
const url_1 = require("url");
const defaultPackModuleEvaluator = {
    async evaluate(file) {
        let moduleFileResolved;
        try {
            moduleFileResolved = require.resolve(file);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_resolve_error', { url: file, reason: err }));
        }
        try {
            const source = await fs_extra_1.default.readFile(moduleFileResolved, 'utf8');
            // This is how Node.js implement require
            const fn = vm_1.default.compileFunction(source, ['System'], {
                filename: url_1.pathToFileURL(moduleFileResolved).href,
            });
            Reflect.apply(fn, undefined, [System]);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_execute_error', { url: file, reason: err }));
        }
    },
};
class PackModInstantiation {
    constructor(quickPackLoader, system, evaluator) {
        this._cachedRegisters = {};
        this._quickPackLoader = quickPackLoader;
        // const system = {
        //     register: (...moduleRegister: ModuleRegister) => {
        //         if (this._lastRegister) {
        //             throw new Error(`Unknown register. Did you have more than one System.register() in your code?`);
        //         }
        //         this._lastRegister = [...moduleRegister];
        //     },
        // };
        // this._registerContext = vm.createContext({
        //     System: system,
        // });
        this._system = system;
        this._evaluator = evaluator !== null && evaluator !== void 0 ? evaluator : defaultPackModuleEvaluator;
    }
    async instantiate(chunkURL) {
        const chunkId = this._quickPackLoader.getChunkId(chunkURL);
        let cached = this._cachedRegisters[chunkId];
        if (!cached) {
            this._cachedRegisters[chunkId] = undefined;
            const mTimestamp = await this._quickPackLoader.queryTimestamp(chunkId);
            const resource = await this._quickPackLoader.loadChunkFromId(chunkId);
            asserts_1.asserts(mTimestamp >= 0, `Chunk '${chunkId}' has a bad timestamp.`);
            asserts_1.asserts(resource.type === 'file');
            const file = resource.path;
            // const code = await fs.readFile(file, 'utf8');
            const register = await this._evalCode2(file);
            cached = {
                register,
                mTimestamp,
            };
            this._cachedRegisters[chunkId] = cached;
        }
        return cached.register;
    }
    /**
     * 重新加载底层的 Pack Loader 并且移除所有失效的缓存。
     */
    async reload() {
        await this._quickPackLoader.reload();
        const cachedChunks = Object.keys(this._cachedRegisters);
        const mTimestamps = await this._quickPackLoader.queryTimestamps(cachedChunks);
        cachedChunks.forEach((chunkId, iChunk) => {
            const cache = this._cachedRegisters[chunkId];
            if (!cache || cache.mTimestamp !== mTimestamps[iChunk]) {
                delete this._cachedRegisters[chunkId];
            }
        });
    }
    async getImportMap() {
        return await this._quickPackLoader.loadImportMap();
    }
    async _evalCode2(file) {
        await this._evaluator.evaluate(file);
        const register = this._system.getRegister();
        if (!register) {
            throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url: file }));
        }
        return register;
    }
}
exports.PackModInstantiation = PackModInstantiation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjay1tb2QtaW5zdGFudGlhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGVjdXRvci9wYWNrLW1vZC1pbnN0YW50aWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLDRDQUFvQjtBQUNwQiw4Q0FBMkM7QUFDM0Msd0RBQTBCO0FBRzFCLHdDQUE4QztBQUM5Qyw2QkFBb0M7QUFNcEMsTUFBTSwwQkFBMEIsR0FBd0I7SUFDcEQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFZO1FBQ3ZCLElBQUksa0JBQTBCLENBQUM7UUFDL0IsSUFBSTtZQUNBLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDOUM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQWEsQ0FDekIsMERBQTBELEVBQzFELEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQzdCLENBQUMsQ0FBQztTQUNOO1FBRUQsSUFBSTtZQUNBLE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQUUsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFN0Qsd0NBQXdDO1lBQ3hDLE1BQU0sRUFBRSxHQUFHLFlBQUUsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzlDLFFBQVEsRUFBRSxtQkFBYSxDQUFDLGtCQUFrQixDQUFDLENBQUMsSUFBSTthQUNuRCxDQUFDLENBQUM7WUFFSCxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQzFDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDVixNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFhLENBQ3pCLDBEQUEwRCxFQUMxRCxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUM3QixDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7Q0FDSixDQUFDO0FBRUYsTUFBYSxvQkFBb0I7SUFDN0IsWUFBWSxlQUFnQyxFQUFFLE1BQXNCLEVBQUUsU0FBK0I7UUFnRTdGLHFCQUFnQixHQUdQLEVBQUUsQ0FBQztRQWxFaEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztRQUN4QyxtQkFBbUI7UUFDbkIseURBQXlEO1FBQ3pELG9DQUFvQztRQUNwQywrR0FBK0c7UUFDL0csWUFBWTtRQUNaLG9EQUFvRDtRQUNwRCxTQUFTO1FBQ1QsS0FBSztRQUNMLDZDQUE2QztRQUM3QyxzQkFBc0I7UUFDdEIsTUFBTTtRQUNOLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxhQUFULFNBQVMsY0FBVCxTQUFTLEdBQUksMEJBQTBCLENBQUM7SUFDOUQsQ0FBQztJQUVNLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBZ0I7UUFDckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUzRCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7WUFFM0MsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZFLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV0RSxpQkFBTyxDQUFDLFVBQVUsSUFBSSxDQUFDLEVBQUUsVUFBVSxPQUFPLHdCQUF3QixDQUFDLENBQUM7WUFDcEUsaUJBQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxDQUFDO1lBRWxDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDM0IsZ0RBQWdEO1lBQ2hELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxNQUFNLEdBQUc7Z0JBQ0wsUUFBUTtnQkFDUixVQUFVO2FBQ2IsQ0FBQztZQUNGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxNQUFNLENBQUM7U0FDM0M7UUFFRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSyxDQUFDLE1BQU07UUFDZixNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNyQyxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBYyxDQUFDO1FBQ3JFLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5RSxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxVQUFVLEtBQUssV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUNwRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN6QztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxZQUFZO1FBQ3JCLE9BQU8sTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQWdDTyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQVk7UUFDakMsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzVDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFhLENBQ3pCLHlDQUF5QyxFQUN6QyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FDaEIsQ0FBQyxDQUFDO1NBQ047UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUExR0Qsb0RBMEdDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB2bSBmcm9tICd2bSc7XHJcbmltcG9ydCB7IGFzc2VydHMgfSBmcm9tICcuLi91dGlscy9hc3NlcnRzJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgQ2h1bmtUaW1lc3RhbXAsIENodW5rSWQsIFF1aWNrUGFja0xvYWRlciB9IGZyb20gJ0Bjb2Nvcy9jcmVhdG9yLXByb2dyYW1taW5nLXF1aWNrLXBhY2svbGliL2xvYWRlcic7XHJcbmltcG9ydCB0eXBlIHsgRXhlY3V0b3JTeXN0ZW0gfSBmcm9tICcuLi9lZGl0b3Itc3lzdGVtanMnO1xyXG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XHJcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYWNrTW9kdWxlRXZhbHVhdG9yIHtcclxuICAgIGV2YWx1YXRlKGZpbGU6IHN0cmluZyk6IHZvaWQgfCBQcm9taXNlPHZvaWQ+O1xyXG59XHJcblxyXG5jb25zdCBkZWZhdWx0UGFja01vZHVsZUV2YWx1YXRvcjogUGFja01vZHVsZUV2YWx1YXRvciA9IHtcclxuICAgIGFzeW5jIGV2YWx1YXRlKGZpbGU6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBtb2R1bGVGaWxlUmVzb2x2ZWQ6IHN0cmluZztcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBtb2R1bGVGaWxlUmVzb2x2ZWQgPSByZXF1aXJlLnJlc29sdmUoZmlsZSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuVHJhbnNsYXRlKFxyXG4gICAgICAgICAgICAgICAgJ2V4ZWN1dG9yX3BhY2tfbW9kX2luc3RhbnRpYXRpb25fZXJyb3JfaG9zdF9yZXNvbHZlX2Vycm9yJyxcclxuICAgICAgICAgICAgICAgIHsgdXJsOiBmaWxlLCByZWFzb246IGVyciB9LFxyXG4gICAgICAgICAgICApKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGF3YWl0IGZzLnJlYWRGaWxlKG1vZHVsZUZpbGVSZXNvbHZlZCwgJ3V0ZjgnKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgaG93IE5vZGUuanMgaW1wbGVtZW50IHJlcXVpcmVcclxuICAgICAgICAgICAgY29uc3QgZm4gPSB2bS5jb21waWxlRnVuY3Rpb24oc291cmNlLCBbJ1N5c3RlbSddLCB7XHJcbiAgICAgICAgICAgICAgICBmaWxlbmFtZTogcGF0aFRvRmlsZVVSTChtb2R1bGVGaWxlUmVzb2x2ZWQpLmhyZWYsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgUmVmbGVjdC5hcHBseShmbiwgdW5kZWZpbmVkLCBbU3lzdGVtXSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuVHJhbnNsYXRlKFxyXG4gICAgICAgICAgICAgICAgJ2V4ZWN1dG9yX3BhY2tfbW9kX2luc3RhbnRpYXRpb25fZXJyb3JfaG9zdF9leGVjdXRlX2Vycm9yJyxcclxuICAgICAgICAgICAgICAgIHsgdXJsOiBmaWxlLCByZWFzb246IGVyciB9LFxyXG4gICAgICAgICAgICApKTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIFBhY2tNb2RJbnN0YW50aWF0aW9uIHtcclxuICAgIGNvbnN0cnVjdG9yKHF1aWNrUGFja0xvYWRlcjogUXVpY2tQYWNrTG9hZGVyLCBzeXN0ZW06IEV4ZWN1dG9yU3lzdGVtLCBldmFsdWF0b3I/OiBQYWNrTW9kdWxlRXZhbHVhdG9yKSB7XHJcbiAgICAgICAgdGhpcy5fcXVpY2tQYWNrTG9hZGVyID0gcXVpY2tQYWNrTG9hZGVyO1xyXG4gICAgICAgIC8vIGNvbnN0IHN5c3RlbSA9IHtcclxuICAgICAgICAvLyAgICAgcmVnaXN0ZXI6ICguLi5tb2R1bGVSZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXIpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgIGlmICh0aGlzLl9sYXN0UmVnaXN0ZXIpIHtcclxuICAgICAgICAvLyAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcmVnaXN0ZXIuIERpZCB5b3UgaGF2ZSBtb3JlIHRoYW4gb25lIFN5c3RlbS5yZWdpc3RlcigpIGluIHlvdXIgY29kZT9gKTtcclxuICAgICAgICAvLyAgICAgICAgIH1cclxuICAgICAgICAvLyAgICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IFsuLi5tb2R1bGVSZWdpc3Rlcl07XHJcbiAgICAgICAgLy8gICAgIH0sXHJcbiAgICAgICAgLy8gfTtcclxuICAgICAgICAvLyB0aGlzLl9yZWdpc3RlckNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KHtcclxuICAgICAgICAvLyAgICAgU3lzdGVtOiBzeXN0ZW0sXHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgdGhpcy5fc3lzdGVtID0gc3lzdGVtO1xyXG4gICAgICAgIHRoaXMuX2V2YWx1YXRvciA9IGV2YWx1YXRvciA/PyBkZWZhdWx0UGFja01vZHVsZUV2YWx1YXRvcjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgaW5zdGFudGlhdGUoY2h1bmtVUkw6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGNodW5rSWQgPSB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0Q2h1bmtJZChjaHVua1VSTCk7XHJcblxyXG4gICAgICAgIGxldCBjYWNoZWQgPSB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbY2h1bmtJZF07XHJcbiAgICAgICAgaWYgKCFjYWNoZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW2NodW5rSWRdID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgbVRpbWVzdGFtcCA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5xdWVyeVRpbWVzdGFtcChjaHVua0lkKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIubG9hZENodW5rRnJvbUlkKGNodW5rSWQpO1xyXG5cclxuICAgICAgICAgICAgYXNzZXJ0cyhtVGltZXN0YW1wID49IDAsIGBDaHVuayAnJHtjaHVua0lkfScgaGFzIGEgYmFkIHRpbWVzdGFtcC5gKTtcclxuICAgICAgICAgICAgYXNzZXJ0cyhyZXNvdXJjZS50eXBlID09PSAnZmlsZScpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHJlc291cmNlLnBhdGg7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IGNvZGUgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlLCAndXRmOCcpO1xyXG4gICAgICAgICAgICBjb25zdCByZWdpc3RlciA9IGF3YWl0IHRoaXMuX2V2YWxDb2RlMihmaWxlKTtcclxuICAgICAgICAgICAgY2FjaGVkID0ge1xyXG4gICAgICAgICAgICAgICAgcmVnaXN0ZXIsXHJcbiAgICAgICAgICAgICAgICBtVGltZXN0YW1wLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbY2h1bmtJZF0gPSBjYWNoZWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY2FjaGVkLnJlZ2lzdGVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6YeN5paw5Yqg6L295bqV5bGC55qEIFBhY2sgTG9hZGVyIOW5tuS4lOenu+mZpOaJgOacieWkseaViOeahOe8k+WtmOOAglxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5yZWxvYWQoKTtcclxuICAgICAgICBjb25zdCBjYWNoZWRDaHVua3MgPSBPYmplY3Qua2V5cyh0aGlzLl9jYWNoZWRSZWdpc3RlcnMpIGFzIENodW5rSWRbXTtcclxuICAgICAgICBjb25zdCBtVGltZXN0YW1wcyA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5xdWVyeVRpbWVzdGFtcHMoY2FjaGVkQ2h1bmtzKTtcclxuICAgICAgICBjYWNoZWRDaHVua3MuZm9yRWFjaCgoY2h1bmtJZCwgaUNodW5rKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW2NodW5rSWRdO1xyXG4gICAgICAgICAgICBpZiAoIWNhY2hlIHx8IGNhY2hlLm1UaW1lc3RhbXAgIT09IG1UaW1lc3RhbXBzW2lDaHVua10pIHtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbY2h1bmtJZF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZ2V0SW1wb3J0TWFwKCkge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIubG9hZEltcG9ydE1hcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3F1aWNrUGFja0xvYWRlcjogUXVpY2tQYWNrTG9hZGVyO1xyXG5cclxuICAgIHByaXZhdGUgX2NhY2hlZFJlZ2lzdGVyczogUmVjb3JkPENodW5rSWQsIHtcclxuICAgICAgICBtVGltZXN0YW1wOiBDaHVua1RpbWVzdGFtcDtcclxuICAgICAgICByZWdpc3RlcjogTW9kdWxlUmVnaXN0ZXI7XHJcbiAgICB9IHwgdW5kZWZpbmVkPiA9IHt9O1xyXG5cclxuICAgIC8vIHByaXZhdGUgX3JlZ2lzdGVyQ29udGV4dDogdm0uQ29udGV4dDtcclxuXHJcbiAgICAvLyBwcml2YXRlIF9sYXN0UmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbCA9IG51bGw7XHJcblxyXG4gICAgLy8gcHJpdmF0ZSBfZXZhbENvZGUoY29kZTogc3RyaW5nLCBmaWxlTmFtZT86IHN0cmluZyk6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbCB7XHJcbiAgICAvLyAgICAgYXNzZXJ0cyh0aGlzLl9sYXN0UmVnaXN0ZXIgPT09IG51bGwpO1xyXG4gICAgLy8gICAgIGxldCBsYXN0UmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbDtcclxuICAgIC8vICAgICB0cnkge1xyXG4gICAgLy8gICAgICAgICB2bS5ydW5JbkNvbnRleHQoY29kZSwgdGhpcy5fcmVnaXN0ZXJDb250ZXh0LCB7XHJcbiAgICAvLyAgICAgICAgICAgICBmaWxlbmFtZTogZmlsZU5hbWUsXHJcbiAgICAvLyAgICAgICAgICAgICBkaXNwbGF5RXJyb3JzOiB0cnVlLFxyXG4gICAgLy8gICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICAgbGFzdFJlZ2lzdGVyID0gdGhpcy5fbGFzdFJlZ2lzdGVyO1xyXG4gICAgLy8gICAgIH0gZmluYWxseSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IG51bGw7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHJldHVybiBsYXN0UmVnaXN0ZXI7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgcHJpdmF0ZSBfc3lzdGVtOiBFeGVjdXRvclN5c3RlbTtcclxuXHJcbiAgICBwcml2YXRlIF9ldmFsdWF0b3I6IFBhY2tNb2R1bGVFdmFsdWF0b3I7XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBfZXZhbENvZGUyKGZpbGU6IHN0cmluZykge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX2V2YWx1YXRvci5ldmFsdWF0ZShmaWxlKTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVnaXN0ZXIgPSB0aGlzLl9zeXN0ZW0uZ2V0UmVnaXN0ZXIoKTtcclxuICAgICAgICBpZiAoIXJlZ2lzdGVyKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuVHJhbnNsYXRlKFxyXG4gICAgICAgICAgICAgICAgJ2V4ZWN1dG9yX3N5c3RlbV9qc19ub19tb2R1bGVfcmVnaXN0ZXJlZCcsXHJcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSB9LFxyXG4gICAgICAgICAgICApKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZWdpc3RlcjtcclxuICAgIH1cclxufVxyXG4iXX0=