"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PackModInstantiation = void 0;
const asserts_1 = require("../utils/asserts");
const i18n_1 = require("../utils/i18n");
class PackModInstantiation {
    constructor(quickPackLoader, system) {
        this._cachedRegisters = {};
        this._quickPackLoader = quickPackLoader;
        // const system = {
        //     register: (...moduleRegister: ModuleRegister) => {
        //         if (this._lastRegister) {
        //             throw new Error(`Unknown register. Did you have more than one System.register() in your code?`);
        //         }
        //         this._lastRegister = [...moduleRegister];
        //     },
        // };
        // this._registerContext = vm.createContext({
        //     System: system,
        // });
        this._system = system;
    }
    async instantiate(link) {
        const resourceId = this._quickPackLoader.getResourceId(link);
        let cached = this._cachedRegisters[resourceId];
        if (!cached) {
            this._cachedRegisters[resourceId] = undefined;
            const mTimestamp = await this._quickPackLoader.getResourceMTimestamp(resourceId);
            const resource = await this._quickPackLoader.getResourceFromId(resourceId);
            asserts_1.asserts(mTimestamp >= 0);
            asserts_1.asserts(resource.type === 'file');
            const file = resource.path;
            // const code = await fs.readFile(file, 'utf8');
            const register = this._evalCode2(file);
            cached = {
                register,
                mTimestamp,
            };
            this._cachedRegisters[resourceId] = cached;
        }
        return cached.register;
    }
    /**
     * 重新加载底层的 Pack Loader 并且移除所有失效的缓存。
     */
    async reload() {
        await this._quickPackLoader.reload();
        const cachedChunks = Object.keys(this._cachedRegisters);
        const mTimestamps = await this._quickPackLoader.getResourceMTimestamps(cachedChunks);
        cachedChunks.forEach((chunkId, iChunk) => {
            const cache = this._cachedRegisters[chunkId];
            if (!cache || cache.mTimestamp !== mTimestamps[iChunk]) {
                delete this._cachedRegisters[chunkId];
            }
        });
    }
    getEntries() {
        return this._quickPackLoader.getEntries();
    }
    async getImportMap() {
        return await this._quickPackLoader.getImportMap();
    }
    _evalCode2(file) {
        let moduleFileResolved;
        try {
            moduleFileResolved = require.resolve(file);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_resolve_error', { url: file, reason: err }));
        }
        try {
            require(moduleFileResolved);
        }
        catch (err) {
            throw new Error(i18n_1.i18nTranslate('executor_pack_mod_instantiation_error_host_execute_error', { url: file, reason: err }));
        }
        if (!(moduleFileResolved in require.cache)) {
            console.debug(`${file} resolved to ${moduleFileResolved} is not in module cache!`);
        }
        else {
            delete require.cache[moduleFileResolved];
        }
        const register = this._system.getRegister();
        if (!register) {
            throw new Error(i18n_1.i18nTranslate('executor_system_js_no_module_registered', { url: file }));
        }
        return register;
    }
}
exports.PackModInstantiation = PackModInstantiation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjay1tb2QtaW5zdGFudGlhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGVjdXRvci9wYWNrLW1vZC1pbnN0YW50aWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDhDQUEyQztBQUkzQyx3Q0FBOEM7QUFFOUMsTUFBYSxvQkFBb0I7SUFDN0IsWUFBWSxlQUFnQyxFQUFFLE1BQXNCO1FBbUU1RCxxQkFBZ0IsR0FHUCxFQUFFLENBQUM7UUFyRWhCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7UUFDeEMsbUJBQW1CO1FBQ25CLHlEQUF5RDtRQUN6RCxvQ0FBb0M7UUFDcEMsK0dBQStHO1FBQy9HLFlBQVk7UUFDWixvREFBb0Q7UUFDcEQsU0FBUztRQUNULEtBQUs7UUFDTCw2Q0FBNkM7UUFDN0Msc0JBQXNCO1FBQ3RCLE1BQU07UUFDTixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUMxQixDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFZO1FBQ2pDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0QsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDVCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLEdBQUcsU0FBUyxDQUFDO1lBRTlDLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pGLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTNFLGlCQUFPLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLGlCQUFPLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsQ0FBQztZQUVsQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQzNCLGdEQUFnRDtZQUNoRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sR0FBRztnQkFDTCxRQUFRO2dCQUNSLFVBQVU7YUFDYixDQUFDO1lBQ0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQTtTQUM3QztRQUVELE9BQU8sTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxLQUFLLENBQUMsTUFBTTtRQUNmLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3JDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFpQixDQUFDO1FBQ3hFLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JGLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLFVBQVUsS0FBSyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3BELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sVUFBVTtRQUNiLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzlDLENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWTtRQUNyQixPQUFPLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RELENBQUM7SUE4Qk8sVUFBVSxDQUFDLElBQVk7UUFDM0IsSUFBSSxrQkFBMEIsQ0FBQztRQUMvQixJQUFJO1lBQ0Esa0JBQWtCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBYSxDQUN6QiwwREFBMEQsRUFDMUQsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FDN0IsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJO1lBQ0EsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDL0I7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQWEsQ0FDekIsMERBQTBELEVBQzFELEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQzdCLENBQUMsQ0FBQztTQUNOO1FBRUQsSUFBSSxDQUFDLENBQUMsa0JBQWtCLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLGdCQUFnQixrQkFBa0IsMEJBQTBCLENBQUMsQ0FBQztTQUN0RjthQUFNO1lBQ0gsT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDNUM7UUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzVDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFhLENBQ3pCLHlDQUF5QyxFQUN6QyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FDaEIsQ0FBQyxDQUFDO1NBQ047UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0NBQ0o7QUFsSUQsb0RBa0lDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgdm0gZnJvbSAndm0nO1xuaW1wb3J0IHsgYXNzZXJ0cyB9IGZyb20gJy4uL3V0aWxzL2Fzc2VydHMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IFJlc291cmNlTVRpbWVzdGFtcCwgUmVzb3VyY2VJZCwgUXVpY2tQYWNrTG9hZGVyIH0gZnJvbSAnLi4vbW9kLWFzc2VtYmxpbmcvcXVpY2stcGFjay9sb2FkZXInO1xuaW1wb3J0IHR5cGUgeyBFeGVjdXRvclN5c3RlbSB9IGZyb20gJy4uL2VkaXRvci1zeXN0ZW1qcyc7XG5pbXBvcnQgeyBpMThuVHJhbnNsYXRlIH0gZnJvbSAnLi4vdXRpbHMvaTE4bic7XG5cbmV4cG9ydCBjbGFzcyBQYWNrTW9kSW5zdGFudGlhdGlvbiB7XG4gICAgY29uc3RydWN0b3IocXVpY2tQYWNrTG9hZGVyOiBRdWlja1BhY2tMb2FkZXIsIHN5c3RlbTogRXhlY3V0b3JTeXN0ZW0pIHtcbiAgICAgICAgdGhpcy5fcXVpY2tQYWNrTG9hZGVyID0gcXVpY2tQYWNrTG9hZGVyO1xuICAgICAgICAvLyBjb25zdCBzeXN0ZW0gPSB7XG4gICAgICAgIC8vICAgICByZWdpc3RlcjogKC4uLm1vZHVsZVJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlcikgPT4ge1xuICAgICAgICAvLyAgICAgICAgIGlmICh0aGlzLl9sYXN0UmVnaXN0ZXIpIHtcbiAgICAgICAgLy8gICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHJlZ2lzdGVyLiBEaWQgeW91IGhhdmUgbW9yZSB0aGFuIG9uZSBTeXN0ZW0ucmVnaXN0ZXIoKSBpbiB5b3VyIGNvZGU/YCk7XG4gICAgICAgIC8vICAgICAgICAgfVxuICAgICAgICAvLyAgICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IFsuLi5tb2R1bGVSZWdpc3Rlcl07XG4gICAgICAgIC8vICAgICB9LFxuICAgICAgICAvLyB9O1xuICAgICAgICAvLyB0aGlzLl9yZWdpc3RlckNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KHtcbiAgICAgICAgLy8gICAgIFN5c3RlbTogc3lzdGVtLFxuICAgICAgICAvLyB9KTtcbiAgICAgICAgdGhpcy5fc3lzdGVtID0gc3lzdGVtO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBpbnN0YW50aWF0ZShsaW5rOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2VJZCA9IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZUlkKGxpbmspO1xuXG4gICAgICAgIGxldCBjYWNoZWQgPSB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbcmVzb3VyY2VJZF07XG4gICAgICAgIGlmICghY2FjaGVkKSB7XG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRSZWdpc3RlcnNbcmVzb3VyY2VJZF0gPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgICAgIGNvbnN0IG1UaW1lc3RhbXAgPSBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0UmVzb3VyY2VNVGltZXN0YW1wKHJlc291cmNlSWQpO1xuICAgICAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0UmVzb3VyY2VGcm9tSWQocmVzb3VyY2VJZCk7XG5cbiAgICAgICAgICAgIGFzc2VydHMobVRpbWVzdGFtcCA+PSAwKTtcbiAgICAgICAgICAgIGFzc2VydHMocmVzb3VyY2UudHlwZSA9PT0gJ2ZpbGUnKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHJlc291cmNlLnBhdGg7XG4gICAgICAgICAgICAvLyBjb25zdCBjb2RlID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZSwgJ3V0ZjgnKTtcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyID0gdGhpcy5fZXZhbENvZGUyKGZpbGUpO1xuICAgICAgICAgICAgY2FjaGVkID0ge1xuICAgICAgICAgICAgICAgIHJlZ2lzdGVyLFxuICAgICAgICAgICAgICAgIG1UaW1lc3RhbXAsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW3Jlc291cmNlSWRdID0gY2FjaGVkXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2FjaGVkLnJlZ2lzdGVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOWKoOi9veW6leWxgueahCBQYWNrIExvYWRlciDlubbkuJTnp7vpmaTmiYDmnInlpLHmlYjnmoTnvJPlrZjjgIJcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIucmVsb2FkKCk7XG4gICAgICAgIGNvbnN0IGNhY2hlZENodW5rcyA9IE9iamVjdC5rZXlzKHRoaXMuX2NhY2hlZFJlZ2lzdGVycykgYXMgUmVzb3VyY2VJZFtdO1xuICAgICAgICBjb25zdCBtVGltZXN0YW1wcyA9IGF3YWl0IHRoaXMuX3F1aWNrUGFja0xvYWRlci5nZXRSZXNvdXJjZU1UaW1lc3RhbXBzKGNhY2hlZENodW5rcyk7XG4gICAgICAgIGNhY2hlZENodW5rcy5mb3JFYWNoKChjaHVua0lkLCBpQ2h1bmspID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fY2FjaGVkUmVnaXN0ZXJzW2NodW5rSWRdO1xuICAgICAgICAgICAgaWYgKCFjYWNoZSB8fCBjYWNoZS5tVGltZXN0YW1wICE9PSBtVGltZXN0YW1wc1tpQ2h1bmtdKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhY2hlZFJlZ2lzdGVyc1tjaHVua0lkXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEVudHJpZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0RW50cmllcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRJbXBvcnRNYXAoKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9xdWlja1BhY2tMb2FkZXIuZ2V0SW1wb3J0TWFwKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcXVpY2tQYWNrTG9hZGVyOiBRdWlja1BhY2tMb2FkZXI7XG5cbiAgICBwcml2YXRlIF9jYWNoZWRSZWdpc3RlcnM6IFJlY29yZDxSZXNvdXJjZUlkLCB7XG4gICAgICAgIG1UaW1lc3RhbXA6IFJlc291cmNlTVRpbWVzdGFtcDtcbiAgICAgICAgcmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyO1xuICAgIH0gfCB1bmRlZmluZWQ+ID0ge307XG5cbiAgICAvLyBwcml2YXRlIF9yZWdpc3RlckNvbnRleHQ6IHZtLkNvbnRleHQ7XG5cbiAgICAvLyBwcml2YXRlIF9sYXN0UmVnaXN0ZXI6IE1vZHVsZVJlZ2lzdGVyIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvLyBwcml2YXRlIF9ldmFsQ29kZShjb2RlOiBzdHJpbmcsIGZpbGVOYW1lPzogc3RyaW5nKTogTW9kdWxlUmVnaXN0ZXIgfCBudWxsIHtcbiAgICAvLyAgICAgYXNzZXJ0cyh0aGlzLl9sYXN0UmVnaXN0ZXIgPT09IG51bGwpO1xuICAgIC8vICAgICBsZXQgbGFzdFJlZ2lzdGVyOiBNb2R1bGVSZWdpc3RlciB8IG51bGw7XG4gICAgLy8gICAgIHRyeSB7XG4gICAgLy8gICAgICAgICB2bS5ydW5JbkNvbnRleHQoY29kZSwgdGhpcy5fcmVnaXN0ZXJDb250ZXh0LCB7XG4gICAgLy8gICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGVOYW1lLFxuICAgIC8vICAgICAgICAgICAgIGRpc3BsYXlFcnJvcnM6IHRydWUsXG4gICAgLy8gICAgICAgICB9KTtcbiAgICAvLyAgICAgICAgIGxhc3RSZWdpc3RlciA9IHRoaXMuX2xhc3RSZWdpc3RlcjtcbiAgICAvLyAgICAgfSBmaW5hbGx5IHtcbiAgICAvLyAgICAgICAgIHRoaXMuX2xhc3RSZWdpc3RlciA9IG51bGw7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgICAgcmV0dXJuIGxhc3RSZWdpc3RlcjtcbiAgICAvLyB9XG5cbiAgICBwcml2YXRlIF9zeXN0ZW06IEV4ZWN1dG9yU3lzdGVtO1xuXG4gICAgcHJpdmF0ZSBfZXZhbENvZGUyKGZpbGU6IHN0cmluZykge1xuICAgICAgICBsZXQgbW9kdWxlRmlsZVJlc29sdmVkOiBzdHJpbmc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBtb2R1bGVGaWxlUmVzb2x2ZWQgPSByZXF1aXJlLnJlc29sdmUoZmlsZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG5UcmFuc2xhdGUoXG4gICAgICAgICAgICAgICAgJ2V4ZWN1dG9yX3BhY2tfbW9kX2luc3RhbnRpYXRpb25fZXJyb3JfaG9zdF9yZXNvbHZlX2Vycm9yJyxcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSwgcmVhc29uOiBlcnIgfSxcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJlcXVpcmUobW9kdWxlRmlsZVJlc29sdmVkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZShcbiAgICAgICAgICAgICAgICAnZXhlY3V0b3JfcGFja19tb2RfaW5zdGFudGlhdGlvbl9lcnJvcl9ob3N0X2V4ZWN1dGVfZXJyb3InLFxuICAgICAgICAgICAgICAgIHsgdXJsOiBmaWxlLCByZWFzb246IGVyciB9LFxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIShtb2R1bGVGaWxlUmVzb2x2ZWQgaW4gcmVxdWlyZS5jYWNoZSkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCR7ZmlsZX0gcmVzb2x2ZWQgdG8gJHttb2R1bGVGaWxlUmVzb2x2ZWR9IGlzIG5vdCBpbiBtb2R1bGUgY2FjaGUhYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWxldGUgcmVxdWlyZS5jYWNoZVttb2R1bGVGaWxlUmVzb2x2ZWRdO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZWdpc3RlciA9IHRoaXMuX3N5c3RlbS5nZXRSZWdpc3RlcigpO1xuICAgICAgICBpZiAoIXJlZ2lzdGVyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaTE4blRyYW5zbGF0ZShcbiAgICAgICAgICAgICAgICAnZXhlY3V0b3Jfc3lzdGVtX2pzX25vX21vZHVsZV9yZWdpc3RlcmVkJyxcbiAgICAgICAgICAgICAgICB7IHVybDogZmlsZSB9LFxuICAgICAgICAgICAgKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVnaXN0ZXI7XG4gICAgfVxufVxuIl19