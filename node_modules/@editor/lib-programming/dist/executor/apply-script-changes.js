"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.applyScriptChanges = void 0;
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
/**
 * @param executor
 * @param changes
 */
async function applyScriptChanges(executor, changes) {
    var _a;
    const hotReloadPluginScriptsArgs = {
        changes: {},
        removals: [],
    };
    for (const changeId in changes) {
        if (Object.prototype.hasOwnProperty.call(changes, changeId)) {
            const change = changes[changeId];
            if (change.operation) {
                // Add
                const { asset, meta } = change;
                const { userData } = meta;
                if (userData.isPlugin && !userData.loadPluginInEditor) {
                    continue;
                }
                const codeFile = (_a = asset.library['editor.js']) !== null && _a !== void 0 ? _a : asset.library['.js'];
                if (!codeFile) {
                    // Because asset-db sends asset-change asynchronously.
                    // We may lose our sources during promise.
                    console.debug(`Script ${asset.source} is not successfully imported, it will not be load therefor.`);
                    continue;
                }
                if (userData.isPlugin) {
                    hotReloadPluginScriptsArgs.changes[asset.uuid] = {
                        file: codeFile,
                        dependencies: sort_plugin_scripts_1.getPluginScriptDependencies(userData),
                    };
                }
            }
            else {
                if (!executor.isModule(changeId)) {
                    hotReloadPluginScriptsArgs.removals.push(changeId);
                }
            }
        }
    }
    await executor.hotReloadPluginScripts(hotReloadPluginScriptsArgs);
}
exports.applyScriptChanges = applyScriptChanges;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHktc2NyaXB0LWNoYW5nZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvYXBwbHktc2NyaXB0LWNoYW5nZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQW9FO0FBZXBFOzs7R0FHRztBQUNJLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLE9BQXFDOztJQUM5RixNQUFNLDBCQUEwQixHQUFzRDtRQUNsRixPQUFPLEVBQUUsRUFBRTtRQUNYLFFBQVEsRUFBRSxFQUFFO0tBQ2YsQ0FBQztJQUNGLEtBQUssTUFBTSxRQUFRLElBQUksT0FBTyxFQUFFO1FBQzVCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRTtZQUN6RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakMsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUNsQixNQUFNO2dCQUNOLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDO2dCQUMvQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBa0IsQ0FBQztnQkFDeEMsSUFBSSxRQUFRLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFO29CQUNuRCxTQUFTO2lCQUNaO2dCQUNELE1BQU0sUUFBUSxTQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLG1DQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ1gsc0RBQXNEO29CQUN0RCwwQ0FBMEM7b0JBQzFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxLQUFLLENBQUMsTUFBTSw4REFBOEQsQ0FBQyxDQUFDO29CQUNwRyxTQUFTO2lCQUNaO2dCQUNELElBQUksUUFBUSxDQUFDLFFBQVEsRUFBRTtvQkFDbkIsMEJBQTBCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRzt3QkFDN0MsSUFBSSxFQUFFLFFBQVE7d0JBQ2QsWUFBWSxFQUFFLGlEQUEyQixDQUFDLFFBQVEsQ0FBQztxQkFDdEQsQ0FBQztpQkFDTDthQUNKO2lCQUFNO2dCQUNILElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUM5QiwwQkFBMEIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUN0RDthQUNKO1NBQ0o7S0FDSjtJQUNELE1BQU0sUUFBUSxDQUFDLHNCQUFzQixDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDdEUsQ0FBQztBQXBDRCxnREFvQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeGVjdXRvciB9IGZyb20gJy4nO1xuaW1wb3J0IHsgZ2V0UGx1Z2luU2NyaXB0RGVwZW5kZW5jaWVzIH0gZnJvbSAnLi9zb3J0LXBsdWdpbi1zY3JpcHRzJztcblxuaW50ZXJmYWNlIFNjcmlwdFJlbW92ZSB7XG4gICAgb3BlcmF0aW9uOiBmYWxzZTtcbn1cblxuaW50ZXJmYWNlIFNjcmlwdEFkZCB7XG4gICAgb3BlcmF0aW9uOiB0cnVlO1xuICAgIGFzc2V0OiBTY3JpcHRBc3NldDtcbiAgICBtZXRhOiB1bmtub3duO1xufVxuXG50eXBlIFNjcmlwdENoYW5nZSA9IFNjcmlwdEFkZCB8IFNjcmlwdFJlbW92ZTtcblxuXG4vKipcbiAqIEBwYXJhbSBleGVjdXRvclxuICogQHBhcmFtIGNoYW5nZXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFwcGx5U2NyaXB0Q2hhbmdlcyhleGVjdXRvcjogRXhlY3V0b3IsIGNoYW5nZXM6IFJlY29yZDxzdHJpbmcsIFNjcmlwdENoYW5nZT4pIHtcbiAgICBjb25zdCBob3RSZWxvYWRQbHVnaW5TY3JpcHRzQXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnaG90UmVsb2FkUGx1Z2luU2NyaXB0cyddPlswXSA9IHtcbiAgICAgICAgY2hhbmdlczoge30sXG4gICAgICAgIHJlbW92YWxzOiBbXSxcbiAgICB9O1xuICAgIGZvciAoY29uc3QgY2hhbmdlSWQgaW4gY2hhbmdlcykge1xuICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGNoYW5nZXMsIGNoYW5nZUlkKSkge1xuICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gY2hhbmdlc1tjaGFuZ2VJZF07XG4gICAgICAgICAgICBpZiAoY2hhbmdlLm9wZXJhdGlvbikge1xuICAgICAgICAgICAgICAgIC8vIEFkZFxuICAgICAgICAgICAgICAgIGNvbnN0IHsgYXNzZXQsIG1ldGEgfSA9IGNoYW5nZTtcbiAgICAgICAgICAgICAgICBjb25zdCB7IHVzZXJEYXRhIH0gPSBtZXRhIGFzIFNjcmlwdE1ldGE7XG4gICAgICAgICAgICAgICAgaWYgKHVzZXJEYXRhLmlzUGx1Z2luICYmICF1c2VyRGF0YS5sb2FkUGx1Z2luSW5FZGl0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGNvZGVGaWxlID0gYXNzZXQubGlicmFyeVsnZWRpdG9yLmpzJ10gPz8gYXNzZXQubGlicmFyeVsnLmpzJ107XG4gICAgICAgICAgICAgICAgaWYgKCFjb2RlRmlsZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBCZWNhdXNlIGFzc2V0LWRiIHNlbmRzIGFzc2V0LWNoYW5nZSBhc3luY2hyb25vdXNseS5cbiAgICAgICAgICAgICAgICAgICAgLy8gV2UgbWF5IGxvc2Ugb3VyIHNvdXJjZXMgZHVyaW5nIHByb21pc2UuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFNjcmlwdCAke2Fzc2V0LnNvdXJjZX0gaXMgbm90IHN1Y2Nlc3NmdWxseSBpbXBvcnRlZCwgaXQgd2lsbCBub3QgYmUgbG9hZCB0aGVyZWZvci5gKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS5pc1BsdWdpbikge1xuICAgICAgICAgICAgICAgICAgICBob3RSZWxvYWRQbHVnaW5TY3JpcHRzQXJncy5jaGFuZ2VzW2Fzc2V0LnV1aWRdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogY29kZUZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXM6IGdldFBsdWdpblNjcmlwdERlcGVuZGVuY2llcyh1c2VyRGF0YSksXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIWV4ZWN1dG9yLmlzTW9kdWxlKGNoYW5nZUlkKSkge1xuICAgICAgICAgICAgICAgICAgICBob3RSZWxvYWRQbHVnaW5TY3JpcHRzQXJncy5yZW1vdmFscy5wdXNoKGNoYW5nZUlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgZXhlY3V0b3IuaG90UmVsb2FkUGx1Z2luU2NyaXB0cyhob3RSZWxvYWRQbHVnaW5TY3JpcHRzQXJncyk7XG59XG5cbmludGVyZmFjZSBTY3JpcHRBc3NldCB7XG4gICAgdXVpZDogc3RyaW5nO1xuICAgIHNvdXJjZTogc3RyaW5nO1xuICAgIGxpYnJhcnk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG59XG5cbmludGVyZmFjZSBTY3JpcHRNZXRhIHtcbiAgICB1c2VyRGF0YToge1xuICAgICAgICBpc1BsdWdpbj86IGJvb2xlYW47XG4gICAgICAgIGxvYWRQbHVnaW5JbkVkaXRvcj86IGJvb2xlYW47XG4gICAgICAgIG1vZHVsZUlkOiBzdHJpbmc7XG4gICAgICAgIGRlcGVuZGVuY2llcz86IHN0cmluZ1tdO1xuICAgIH07XG59XG4iXX0=