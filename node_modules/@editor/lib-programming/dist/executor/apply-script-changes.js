"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.applyScriptChanges = void 0;
const sort_plugin_scripts_1 = require("./sort-plugin-scripts");
/**
 * @param executor
 * @param changes
 */
async function applyScriptChanges(executor, changes) {
    var _a;
    const hotReloadPluginScriptsArgs = {
        changes: {},
        removals: [],
    };
    for (const changeId in changes) {
        if (Object.prototype.hasOwnProperty.call(changes, changeId)) {
            const change = changes[changeId];
            if (change.operation) {
                // Add
                const { asset, meta } = change;
                const { userData } = meta;
                if (userData.isPlugin && !userData.loadPluginInEditor) {
                    continue;
                }
                const codeFile = (_a = asset.library['editor.js']) !== null && _a !== void 0 ? _a : asset.library['.js'];
                if (!codeFile) {
                    // Because asset-db sends asset-change asynchronously.
                    // We may lose our sources during promise.
                    console.debug(`Script ${asset.source} is not successfully imported, it will not be load therefor.`);
                    continue;
                }
                if (userData.isPlugin) {
                    hotReloadPluginScriptsArgs.changes[asset.uuid] = {
                        file: codeFile,
                        dependencies: sort_plugin_scripts_1.getPluginScriptDependencies(userData),
                    };
                }
            }
            else {
                if (!executor.isModule(changeId)) {
                    hotReloadPluginScriptsArgs.removals.push(changeId);
                }
            }
        }
    }
    await executor.hotReloadPluginScripts(hotReloadPluginScriptsArgs);
}
exports.applyScriptChanges = applyScriptChanges;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHktc2NyaXB0LWNoYW5nZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXhlY3V0b3IvYXBwbHktc2NyaXB0LWNoYW5nZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQW9FO0FBZXBFOzs7R0FHRztBQUNJLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLE9BQXFDOztJQUM5RixNQUFNLDBCQUEwQixHQUFzRDtRQUNsRixPQUFPLEVBQUUsRUFBRTtRQUNYLFFBQVEsRUFBRSxFQUFFO0tBQ2YsQ0FBQztJQUNGLEtBQUssTUFBTSxRQUFRLElBQUksT0FBTyxFQUFFO1FBQzVCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRTtZQUN6RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakMsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUNsQixNQUFNO2dCQUNOLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDO2dCQUMvQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBa0IsQ0FBQztnQkFDeEMsSUFBSSxRQUFRLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFO29CQUNuRCxTQUFTO2lCQUNaO2dCQUNELE1BQU0sUUFBUSxTQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLG1DQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ1gsc0RBQXNEO29CQUN0RCwwQ0FBMEM7b0JBQzFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxLQUFLLENBQUMsTUFBTSw4REFBOEQsQ0FBQyxDQUFDO29CQUNwRyxTQUFTO2lCQUNaO2dCQUNELElBQUksUUFBUSxDQUFDLFFBQVEsRUFBRTtvQkFDbkIsMEJBQTBCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRzt3QkFDN0MsSUFBSSxFQUFFLFFBQVE7d0JBQ2QsWUFBWSxFQUFFLGlEQUEyQixDQUFDLFFBQVEsQ0FBQztxQkFDdEQsQ0FBQztpQkFDTDthQUNKO2lCQUFNO2dCQUNILElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUM5QiwwQkFBMEIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUN0RDthQUNKO1NBQ0o7S0FDSjtJQUNELE1BQU0sUUFBUSxDQUFDLHNCQUFzQixDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDdEUsQ0FBQztBQXBDRCxnREFvQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeGVjdXRvciB9IGZyb20gJy4nO1xyXG5pbXBvcnQgeyBnZXRQbHVnaW5TY3JpcHREZXBlbmRlbmNpZXMgfSBmcm9tICcuL3NvcnQtcGx1Z2luLXNjcmlwdHMnO1xyXG5cclxuaW50ZXJmYWNlIFNjcmlwdFJlbW92ZSB7XHJcbiAgICBvcGVyYXRpb246IGZhbHNlO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgU2NyaXB0QWRkIHtcclxuICAgIG9wZXJhdGlvbjogdHJ1ZTtcclxuICAgIGFzc2V0OiBTY3JpcHRBc3NldDtcclxuICAgIG1ldGE6IHVua25vd247XHJcbn1cclxuXHJcbnR5cGUgU2NyaXB0Q2hhbmdlID0gU2NyaXB0QWRkIHwgU2NyaXB0UmVtb3ZlO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBAcGFyYW0gZXhlY3V0b3JcclxuICogQHBhcmFtIGNoYW5nZXNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcHBseVNjcmlwdENoYW5nZXMoZXhlY3V0b3I6IEV4ZWN1dG9yLCBjaGFuZ2VzOiBSZWNvcmQ8c3RyaW5nLCBTY3JpcHRDaGFuZ2U+KSB7XHJcbiAgICBjb25zdCBob3RSZWxvYWRQbHVnaW5TY3JpcHRzQXJnczogUGFyYW1ldGVyczxFeGVjdXRvclsnaG90UmVsb2FkUGx1Z2luU2NyaXB0cyddPlswXSA9IHtcclxuICAgICAgICBjaGFuZ2VzOiB7fSxcclxuICAgICAgICByZW1vdmFsczogW10sXHJcbiAgICB9O1xyXG4gICAgZm9yIChjb25zdCBjaGFuZ2VJZCBpbiBjaGFuZ2VzKSB7XHJcbiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjaGFuZ2VzLCBjaGFuZ2VJZCkpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gY2hhbmdlc1tjaGFuZ2VJZF07XHJcbiAgICAgICAgICAgIGlmIChjaGFuZ2Uub3BlcmF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBBZGRcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgYXNzZXQsIG1ldGEgfSA9IGNoYW5nZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgdXNlckRhdGEgfSA9IG1ldGEgYXMgU2NyaXB0TWV0YTtcclxuICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS5pc1BsdWdpbiAmJiAhdXNlckRhdGEubG9hZFBsdWdpbkluRWRpdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlRmlsZSA9IGFzc2V0LmxpYnJhcnlbJ2VkaXRvci5qcyddID8/IGFzc2V0LmxpYnJhcnlbJy5qcyddO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFjb2RlRmlsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEJlY2F1c2UgYXNzZXQtZGIgc2VuZHMgYXNzZXQtY2hhbmdlIGFzeW5jaHJvbm91c2x5LlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFdlIG1heSBsb3NlIG91ciBzb3VyY2VzIGR1cmluZyBwcm9taXNlLlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYFNjcmlwdCAke2Fzc2V0LnNvdXJjZX0gaXMgbm90IHN1Y2Nlc3NmdWxseSBpbXBvcnRlZCwgaXQgd2lsbCBub3QgYmUgbG9hZCB0aGVyZWZvci5gKTtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS5pc1BsdWdpbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGhvdFJlbG9hZFBsdWdpblNjcmlwdHNBcmdzLmNoYW5nZXNbYXNzZXQudXVpZF0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGU6IGNvZGVGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXM6IGdldFBsdWdpblNjcmlwdERlcGVuZGVuY2llcyh1c2VyRGF0YSksXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICghZXhlY3V0b3IuaXNNb2R1bGUoY2hhbmdlSWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaG90UmVsb2FkUGx1Z2luU2NyaXB0c0FyZ3MucmVtb3ZhbHMucHVzaChjaGFuZ2VJZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBhd2FpdCBleGVjdXRvci5ob3RSZWxvYWRQbHVnaW5TY3JpcHRzKGhvdFJlbG9hZFBsdWdpblNjcmlwdHNBcmdzKTtcclxufVxyXG5cclxuaW50ZXJmYWNlIFNjcmlwdEFzc2V0IHtcclxuICAgIHV1aWQ6IHN0cmluZztcclxuICAgIHNvdXJjZTogc3RyaW5nO1xyXG4gICAgbGlicmFyeTogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxufVxyXG5cclxuaW50ZXJmYWNlIFNjcmlwdE1ldGEge1xyXG4gICAgdXNlckRhdGE6IHtcclxuICAgICAgICBpc1BsdWdpbj86IGJvb2xlYW47XHJcbiAgICAgICAgbG9hZFBsdWdpbkluRWRpdG9yPzogYm9vbGVhbjtcclxuICAgICAgICBtb2R1bGVJZDogc3RyaW5nO1xyXG4gICAgICAgIGRlcGVuZGVuY2llcz86IHN0cmluZ1tdO1xyXG4gICAgfTtcclxufVxyXG4iXX0=