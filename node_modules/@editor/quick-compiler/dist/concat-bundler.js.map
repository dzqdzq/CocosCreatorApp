{"version":3,"file":"concat-bundler.js","sourceRoot":"","sources":["../src/concat-bundler.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs-extra';\r\nimport ps from 'path';\r\nimport { CacheTransformed } from './cache-transformed';\r\nimport ConcatWithSourceMaps from 'concat-with-sourcemaps';\r\nimport { IBundler, TransformTargetModule } from './bundler';\r\nimport { IndexedSourceMap } from './indexed-source-map';\r\nimport { RawSourceMap } from 'source-map';\r\nimport { pathToFileURL } from 'url';\r\nimport RelateURl from 'relateurl';\r\n\r\nclass RegularConcat {\r\n    constructor({\r\n        file,\r\n        separator,\r\n    }: {\r\n        file: string,\r\n        separator?: string,\r\n    }) {\r\n        this._concat = new ConcatWithSourceMaps(true, file, separator);\r\n    }\r\n\r\n    get code() {\r\n        return this._concat.content.toString('utf8');\r\n    }\r\n\r\n    get sourceMap() {\r\n        return this._concat.sourceMap!.toString();\r\n    }\r\n\r\n    public add(code: string | Buffer, map?: RawSourceMap) {\r\n        this._concat.add(null, code, map as any);\r\n    }\r\n\r\n    private _concat: ConcatWithSourceMaps;\r\n}\r\n\r\n\r\ntype ConcatTool = RegularConcat | IndexedSourceMap;\r\n\r\nexport class ConcatBundler extends CacheTransformed implements IBundler {\r\n    constructor(options: ConstructorParameters<typeof CacheTransformed>[0] & {\r\n        format: 'commonjs' | 'systemjs',\r\n    }) {\r\n        super(options);\r\n        this.targetMode = (options.format === 'commonjs') ?\r\n            TransformTargetModule.commonJs : TransformTargetModule.systemJsNamed;\r\n    }\r\n\r\n    targetMode = TransformTargetModule.systemJsNamed;\r\n\r\n    getModuleId(path: string) {\r\n        return this._getModuleIdOfOutFile(this.getRelativeOutputPath(path));\r\n    }\r\n\r\n    getFinalUrl(path: string) {\r\n        return this.getModuleId(path);\r\n    }\r\n\r\n    public async build({\r\n        outDir,\r\n        usedInElectron509,\r\n        sourceRoot,\r\n        inlineSourceMap,\r\n        indexedSourceMap: useIndexedSourceMap,\r\n    }: Parameters<IBundler['build']>[0]) {\r\n        const outFile = ps.join(outDir, 'index.js');\r\n        const concat: ConcatTool = new (useIndexedSourceMap ? IndexedSourceMap : RegularConcat)({\r\n            file: outFile,\r\n            separator: '\\n',\r\n        });\r\n\r\n        const outURL = pathToFileURL(outFile);\r\n        if (this.targetMode === TransformTargetModule.commonJs) {\r\n            await this._concatToCommonJs(concat, outURL);\r\n        } else {\r\n            await this._concatToSystemJs(concat, outURL);\r\n        }\r\n\r\n        let sourceMapPromise: undefined | Promise<void>;\r\n        if (inlineSourceMap) {\r\n            concat.add(`//# sourceMappingURL=data:application/json;base64,${Buffer.from(concat.sourceMap).toString('base64')}`);\r\n        } else {\r\n            const sourceMapFile = `${ps.basename(outFile)}.map`;\r\n            const sourceMapFileFullPath = ps.join(ps.dirname(outFile), sourceMapFile);\r\n            const sourceMappingUrl = usedInElectron509 ?\r\n                pathToFileURL(sourceMapFileFullPath).href :\r\n                sourceMapFile;\r\n            concat.add(`//# sourceMappingURL=${sourceMappingUrl}`);\r\n            const sourceMapText = concat.sourceMap;\r\n            // const hack509 = (sourceMap: any) => {\r\n            //     // Electron 5.0.9 require path\r\n            //     // sourceMap.file = outFile;\r\n            //     // Do not include sources in source map\r\n            //     delete sourceMap.sourcesContent;\r\n            //     return sourceMap;\r\n            // };\r\n            // const sourceMapText = usedInElectron509\r\n            //     ? JSON.stringify(hack509(JSON.parse(concat.sourceMap)), undefined, 2)\r\n            //     : JSON.stringify(Object.assign({ sourceRoot: `${pathToFileURL(sourceRoot)}/` }, JSON.parse(concat.sourceMap)));\r\n            sourceMapPromise = fs.outputFile(\r\n                sourceMapFileFullPath,\r\n                sourceMapText,\r\n                { encoding: 'utf8' },\r\n            );\r\n        }\r\n        await Promise.all([\r\n            fs.outputFile(outFile, concat.code, { encoding: 'utf8' }),\r\n            sourceMapPromise,\r\n        ]);\r\n    }\r\n\r\n    private async _concatToCommonJs(concat: ConcatTool, outURL: URL) {\r\n        wrapBigIIFEPre();\r\n\r\n        await this.forEachModule(async (path, code, map, mapURL) => {\r\n            if (map && mapURL) {\r\n                relocateSourceFilePaths(map, mapURL, outURL);\r\n            }\r\n            wrapIIFEPre(this._getModuleIdOfOutFile(path));\r\n            concat.add(/*path, */code, map);\r\n            wrapIIFEPost();\r\n        });\r\n\r\n        wrapBigIIFEPost();\r\n\r\n        function wrapBigIIFEPre() {\r\n            concat.add(`\\\r\nmodule.exports = (function(){ return {\r\n`);\r\n        }\r\n\r\n        function wrapBigIIFEPost() {\r\n            concat.add(`\\\r\n}; })();`);\r\n        }\r\n\r\n        function wrapIIFEPre(path: string) {\r\n            concat.add(`['${path}']: (function(exports, require){`);\r\n        }\r\n\r\n        function wrapIIFEPost() {\r\n            concat.add(`}),`);\r\n        }\r\n    }\r\n\r\n    private async _concatToSystemJs(concat: ConcatTool, outURL: URL) {\r\n        await this.forEachModule(async (path, code, map, mapURL) => {\r\n            if (map && mapURL) {\r\n                relocateSourceFilePaths(map, mapURL, outURL);\r\n            }\r\n            concat.add(/*path, */code, map);\r\n        });\r\n    }\r\n\r\n    protected _getModuleIdOfOutFile(relativeOutPath: string) {\r\n        const parts = relativeOutPath.split(/[\\\\/]/g);\r\n        return `q-bundled:///${parts.map((part) => encodeURIComponent(part)).join('/')}`;\r\n    }\r\n}\r\n\r\nfunction relocateSourceFilePaths(\r\n    sourceMap: RawSourceMap,\r\n    sourceMapURL: URL,\r\n    newSourceMapURL: URL,\r\n) {\r\n    if (!sourceMap.sources) {\r\n        return;\r\n    }\r\n    const sources = sourceMap.sources;\r\n\r\n    const resolveRelative = new RelateURl(newSourceMapURL.href);\r\n    sources.map((source, iSource) => {\r\n        const sourceURL = new URL(source, sourceMapURL);\r\n        const resolved = resolveRelative.relate(sourceURL.href);\r\n        sources[iSource] = resolved;\r\n    });\r\n\r\n    return sourceMap;\r\n}\r\n"]}