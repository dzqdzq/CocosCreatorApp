{"version":3,"file":"bundle-externals.js","sourceRoot":"","sources":["../src/bundle-externals.ts"],"names":[],"mappings":"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","sourcesContent":["import { OutputOptions, Plugin, rollup, RollupOptions, WarningHandlerWithDefault } from 'rollup';\r\nimport rpBabel, { RollupBabelInputPluginOptions } from '@rollup/plugin-babel';\r\n// @ts-ignore\r\nimport rpSourcemaps from 'rollup-plugin-sourcemaps';\r\nimport { terser } from 'rollup-plugin-terser';\r\nimport rpCommonJS from '@rollup/plugin-commonjs';\r\nimport rpNodeResolve from '@rollup/plugin-node-resolve';\r\n// @ts-ignore\r\nimport babelPresetEnv from '@babel/preset-env';\r\nimport UUID from 'node-uuid';\r\nimport { encodeUrlAsFilePath } from './utilts';\r\nimport fs from 'fs';\r\n\r\nexport interface ImportMap {\r\n    imports?: Record<string, string>;\r\n    scopes?: Record<string, Record<string, string>>;\r\n}\r\n\r\nexport interface BundleExternalsOptions {\r\n    perf?: boolean;\r\n\r\n    rootDir: string;\r\n}\r\n\r\nexport interface BundleResult {\r\n    /**\r\n     * Key is the entry, value is the relative url from chunkDir.\r\n     */\r\n    entryMap: Record<string, string>;\r\n\r\n    watchFiles: string[];\r\n}\r\n\r\nexport async function bundleExternals(entries: [string, string][], options: BundleExternalsOptions) {\r\n    // const withSourceMap = options.sourceMap;\r\n    // const doMinify = options.minify;\r\n\r\n    const realpath = typeof fs.realpath.native === 'function' ? fs.realpath.native : fs.realpath;\r\n    const realPath = (file: string) => new Promise<string>((resolve, reject) => {\r\n        realpath(file, function (err, path) {\r\n            if (err && err.code !== 'ENOENT') {\r\n                reject(err);\r\n            } else {\r\n                resolve(err ? file : path);\r\n            }\r\n        });\r\n    });\r\n\r\n    const rollupWarningHandler: WarningHandlerWithDefault = (warning, defaultHandler) => {\r\n        if (typeof warning !== 'string') {\r\n            if (warning.code === 'THIS_IS_UNDEFINED') {\r\n                // TODO: It's really inappropriate to do this...\r\n                // Let's fix these files instead of suppressing rollup.\r\n                if (warning.id?.match(/(?:spine-core\\.js$)|(?:dragonBones\\.js$)/)) {\r\n                    console.debug(`Rollup warning 'THIS_IS_UNDEFINED' is omitted for ${warning.id}`);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n        defaultHandler(warning);\r\n    };\r\n\r\n    const rollupPlugins: Plugin[] = [\r\n        rpNodeResolve({\r\n            jail: await realPath(options.rootDir),\r\n            rootDir: options.rootDir,\r\n        }),\r\n        rpCommonJS({\r\n            include: [\r\n                /node_modules[/\\\\]/,\r\n                /asm\\.js/,\r\n            ],\r\n            sourceMap: false, // Save performance\r\n        }),\r\n        rpBabel({\r\n            babelHelpers: 'bundled',\r\n            overrides: [{\r\n                // Eliminates the babel compact warning:\r\n                // 'The code generator has deoptimised the styling of ...'\r\n                // that came from node_modules/@cocos\r\n                test: /node_modules[/\\\\]@cocos[/\\\\]/,\r\n                compact: true,\r\n            }],\r\n            exclude: [\r\n                /node_modules[/\\\\]@cocos[/\\\\]ammo/,\r\n                /node_modules[/\\\\]@cocos[/\\\\]cannon/,\r\n                /node_modules[/\\\\]@cocos[/\\\\]physx/,\r\n                /asm\\.js/,\r\n            ],\r\n            presets: [\r\n                babelPresetEnv,\r\n            ],\r\n        } as RollupBabelInputPluginOptions),\r\n        // rpSourcemaps,\r\n    ];\r\n    // if (doMinify) {\r\n    //     rollupPlugins.push(terser);\r\n    // }\r\n\r\n    const entryMap: Record<string, string> = {};\r\n    const rollupInput: Record<string, string> = {};\r\n    for (const [entry, nameHint] of entries) {\r\n        const entryChunkUUID = nameHint.split(/[\\\\/]/g).map((part) => encodeUrlAsFilePath(part)).join('/');\r\n        entryMap[entry] = `${entryChunkUUID}.js`;\r\n        rollupInput[entryChunkUUID] = entry;\r\n    }\r\n\r\n    const rollupOptions: RollupOptions = {\r\n        input: rollupInput,\r\n        plugins: rollupPlugins,\r\n        perf: options.perf,\r\n        onwarn: rollupWarningHandler,\r\n    };\r\n\r\n    const rollupBuild = await rollup(rollupOptions);\r\n    if (rollupBuild.getTimings) {\r\n        console.debug(rollupBuild.getTimings());\r\n    }\r\n    const watchFiles = rollupBuild.watchFiles.slice();\r\n\r\n    return {\r\n        entryMap,\r\n        watchFiles,\r\n        write: async (writeOptions: {\r\n            minify?: boolean;\r\n            sourceMap?: boolean;\r\n            format: 'commonjs' | 'systemjs';\r\n            chunkDir: string;\r\n        }) => {\r\n            const rollupOutputOptions: OutputOptions = {\r\n                format: writeOptions.format === 'systemjs' ? 'system' : (writeOptions.format),\r\n                sourcemap: writeOptions.sourceMap,\r\n                dir: writeOptions.chunkDir,\r\n                exports: 'auto',\r\n            };\r\n\r\n            await rollupBuild.write(rollupOutputOptions);\r\n        },\r\n    };\r\n}\r\n"]}