{"version":3,"file":"babel-transformer.js","sourceRoot":"","sources":["../../src/transformer/babel-transformer.ts"],"names":[],"mappings":"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","sourcesContent":["import { ScriptTargets, Transformer, TransformOptions, TransformResult } from \"./transformer\";\r\nimport * as babel from '@babel/core';\r\nimport babelPresetEnv from '@babel/preset-env';\r\n// @ts-ignore\r\nimport babelPluginConstEnum from 'babel-plugin-const-enum';\r\n// @ts-ignore\r\nimport babelPluginTransformModulesUmd from '@babel/plugin-transform-modules-umd';\r\n// @ts-ignore\r\nimport babelPluginTransformModulesSystemJs from '@babel/plugin-transform-modules-systemjs';\r\n// @ts-ignore\r\nimport babelPluginTransformModulesCommonJs from '@babel/plugin-transform-modules-commonjs';\r\n// @ts-ignore\r\nimport babelPluginProposalDynamicImport from '@babel/plugin-proposal-dynamic-import';\r\nimport babelPluginDynamicVars from '@cocos/babel-plugin-dynamic-import-vars';\r\nimport { TransformTargetModule } from \"../bundler\";\r\nimport winston from 'winston';\r\nimport { makeVisitorOnModuleSpecifiers } from '../module-specifier-visitor';\r\nimport { importHelperPlugin } from '../bundled-helpers-plugin';\r\nimport { babelPresetCC } from '@cocos/creator-programming-babel-preset-cc'\r\nimport { IOptimizeDecorators } from \"@cocos/build-engine\";\r\n\r\nexport class BabelTransformer implements Transformer {\r\n    public static buildHelper(): string {\r\n        // @ts-ignore\r\n        return babel.buildExternalHelpers(null, 'module');\r\n    }\r\n\r\n    constructor({\r\n        targets,\r\n        loose,\r\n        targetModule,\r\n        logger,\r\n        optimizeDecorators,\r\n    }: {\r\n        targets: ScriptTargets | undefined;\r\n        loose: boolean;\r\n        targetModule: TransformTargetModule;\r\n        logger: winston.Logger;\r\n        optimizeDecorators: IOptimizeDecorators,\r\n    }) {\r\n        this._loose = loose;\r\n        this._targets = targets;\r\n        this._targetModule = targetModule;\r\n        this._logger = logger;\r\n        this._optimizeDecorators = optimizeDecorators;\r\n    }\r\n\r\n    public async transform(source: string, options: TransformOptions): Promise<TransformResult> {\r\n        const {\r\n            _logger,\r\n        } = this;\r\n\r\n        const {\r\n            fileName,\r\n            isFile,\r\n            sourceFileName,\r\n            moduleId,\r\n            replaceModuleSpecifier,\r\n            isBabelHelper,\r\n        } = options;\r\n\r\n        const sourceMaps = !!sourceFileName;\r\n\r\n        const targetModule = this._targetModule;\r\n        const babelOptionsBase: babel.TransformOptions = {\r\n            moduleIds: targetModule === TransformTargetModule.systemJsNamed,\r\n            moduleId,\r\n            filename: fileName,\r\n            sourceMaps,\r\n            sourceFileName,\r\n\r\n            configFile: false,\r\n            babelrc: false,\r\n        };\r\n        const addTransformModulesPlugin = (plugins: any[]) => {\r\n            if (targetModule === TransformTargetModule.umd) {\r\n                plugins.push([babelPluginTransformModulesUmd]);\r\n            } else if (targetModule === TransformTargetModule.commonJs) {\r\n                plugins.push([babelPluginTransformModulesCommonJs]);\r\n            } else if (targetModule === TransformTargetModule.systemJs || targetModule === TransformTargetModule.systemJsNamed) {\r\n                plugins.push([babelPluginTransformModulesSystemJs]);\r\n            }\r\n            return plugins;\r\n        };\r\n\r\n        if (isBabelHelper) {\r\n            const babelFileResult = await babel.transformAsync(source, {\r\n                ...babelOptionsBase,\r\n                plugins: [\r\n                    [babelPluginConstEnum, { transform: 'constObject' }]\r\n                ].concat(addTransformModulesPlugin([])),\r\n            });\r\n            if (!babelFileResult) {\r\n                throwUnexpectedBabelError();\r\n            } else {\r\n                return {\r\n                    code: babelFileResult.code!,\r\n                };\r\n            }\r\n        }\r\n\r\n        // const helperModuleRequest = getModuleRequestTo(babelHelpersModuleUid);\r\n\r\n        let resolveModuleSpecifier: babel.PluginObj | undefined;\r\n\r\n        if (replaceModuleSpecifier) {\r\n            // Resolves them and record the useful information.\r\n            const moduleSpecifierResolveMap: Record<string, string> = {};\r\n\r\n            const processModuleSpecifier = (moduleSpecifier: string) => {\r\n                const replacement = replaceModuleSpecifier(moduleSpecifier);\r\n                if (replacement) {\r\n                    moduleSpecifierResolveMap[moduleSpecifier] = replacement;\r\n                }\r\n            };\r\n            resolveModuleSpecifier = {\r\n                visitor: makeVisitorOnModuleSpecifiers((moduleSpecifierPath) => {\r\n                    const moduleSpecifier = moduleSpecifierPath.node.value;\r\n                    processModuleSpecifier(moduleSpecifier);\r\n                    // An in-place babel plugin which apply the resolve result.\r\n                    if (moduleSpecifier in moduleSpecifierResolveMap) {\r\n                        moduleSpecifierPath.replaceWith(babel.types.stringLiteral(moduleSpecifierResolveMap[moduleSpecifier]));\r\n                    }\r\n                }),\r\n            };\r\n        }\r\n\r\n        // 2020.10.10: esbuild will treat empty files(not using es6 features) as commonjs modules.\r\n        // 1. for commonjs modules, esbuild will generate strange _commonjs wrapper to handle.\r\n        // 2. If a module (transitively) export star from commonjs modules, the module is\r\n        // treated as commonjs module and will only export a default binding.\r\n        const injectEmptyExportStmt: babel.PluginObj = {\r\n            visitor: { Program: { exit: (path) => {\r\n                if (path.node.body.length === 0) {\r\n                    path.node.body.push(\r\n                        babel.types.exportNamedDeclaration(\r\n                            undefined,\r\n                            [],\r\n                        ));\r\n                }\r\n            } } },\r\n        };\r\n\r\n        const transformCodePassResult = await babel.transformAsync(source, {\r\n            ...babelOptionsBase,\r\n            presets: [\r\n                [{ plugins: [\r\n                    [babelPluginConstEnum, { transform: 'constObject' }],\r\n                    [babelPluginProposalDynamicImport],\r\n                ] }],\r\n                [babelPresetEnv, {\r\n                    modules: false,\r\n                    targets: this._targets,\r\n                    loose: this._loose,\r\n                } as babelPresetEnv.Options],\r\n                [{ plugins: [\r\n                    [injectEmptyExportStmt],\r\n                    [babelPluginDynamicVars],\r\n                    [resolveModuleSpecifier], // Resolve module specifiers\r\n                    ...addTransformModulesPlugin([]),\r\n                ] }],\r\n                [babelPresetCC, {\r\n                    allowDeclareFields: true,\r\n                    ccDecoratorHelpers: 'inline',\r\n                    fieldDecorators: this._optimizeDecorators.fieldDecorators,\r\n                } as babelPresetCC.Options],\r\n                [{ plugins: [\r\n                    // [importHelperPlugin, { helperModuleName: helperModuleRequest }],\r\n                ] }],\r\n            ],\r\n        });\r\n\r\n        if (!transformCodePassResult || !transformCodePassResult.code) {\r\n            throwUnexpectedBabelError();\r\n        }\r\n\r\n        if (transformCodePassResult.map?.sourcesContent) {\r\n            if (isFile) {\r\n                delete transformCodePassResult.map.sourcesContent;\r\n            }\r\n        }\r\n\r\n        return {\r\n            code: transformCodePassResult.code!,\r\n            map: transformCodePassResult.map? JSON.stringify(transformCodePassResult.map) : undefined,\r\n        };\r\n\r\n        function throwUnexpectedBabelError(): never {\r\n            throw new Error(`Babel returned empty result`);\r\n        }\r\n    }\r\n\r\n    private _targetModule: TransformTargetModule;\r\n    private _targets: ScriptTargets | undefined;\r\n    private _loose: boolean;\r\n    private _logger: winston.Logger;\r\n    private _optimizeDecorators: IOptimizeDecorators;\r\n}"]}