"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Package=void 0;const panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),electron_1=require("electron"),utils_1=require("../public/utils"),path_1=require("path"),fs_extra_1=require("fs-extra");let debugFile="";class Package{constructor(e){if(this.panels=[],this.enabled=!1,this.invalid=!1,this.path=e,!e||!fs_extra_1.existsSync(e))return void(this.invalid=!0);const i=fs_extra_1.readJSONSync(path_1.join(e,"package.json"));i.name=i.name||"(unknown)",i.version=i.version||"0.0.0",i.debug=i.debug||!1;const t=i.name.toLowerCase();t!==i.name&&(console.warn(`Plugin configuration error: plugin name(${i.name}) can only be in lowercase.`),i.name=t),this.json=i}static debugRely(e){debugFile=e}get name(){return this.json?this.json.name:"(unknown)"}get version(){return this.json?this.json.version:"0.0.0"}get debug(){return!!this.json&&!!this.json.debug}async _init(){if(this.invalid||!this.json)return;if(!this.path||!this.json.main)return;const e=path_1.join(this.path,this.json.main);if(this.json.debug){const i=this.win=new electron_1.BrowserWindow({width:0,height:0,show:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,backgroundThrottling:!1,preload:debugFile}});i.loadURL(`file://${path_1.join(__dirname,"../../static/worker.html")}`);let t=!1;await new Promise(n=>{i.webContents.once("dom-ready",()=>{i.openDevTools();let s=null;s=setInterval(()=>{if(!i.devToolsWebContents)return;null!==s&&clearInterval(s),i.devToolsWebContents.focus();let o=ipc.sendToWin(i,"init",e,{});!1===t&&(t=!0,o.callback(()=>{n()}))},100)})})}else try{this.module=require(e)}catch(e){console.error(`The plug-in main process failed to load. ${e.stack}`),this.module={}}}async _destroy(){if(this.path&&this.json&&this.json.main){const e=path_1.join(this.path,this.json.main);utils_1.removeCache(e,this.path),this.module={}}}async enable(){if(this.invalid||!this.json)return void console.error(`The  directory(${this.path}) is not a legal plug-in.`);if(this.enabled)return void console.warn(`The plug-in(${this.path}) has started`);const e=this.json;if(e.panels)for(let i in e.panels){const t="default"===i?this.name:this.name+"."+i,n=e.panels[i];n.package=this.name,n.packageDir=this.path,n.main?panel.register(t,path_1.join(this.path,n.main),n):console.warn(`The panel(${this.name}.${i}) cannot be registered because the address of the panel file was not filled in`),this.panels.push(t)}await this._init(),this.json.debug?await new Promise((e,i)=>{ipc.sendToWin(this.win,"load").callback((t,n)=>{if(t)return i(t);e(n)})}):this.module&&this.module.load&&await this.module.load.call(this),this.enabled=!0}async disable(){try{this.json&&this.json.debug?await new Promise((e,i)=>{ipc.sendToWin(this.win,"unload").callback((t,n)=>{if(t)return i(t);e(n)})}):this.module&&this.module.unload&&await this.module.unload.call(this)}catch(e){console.warn(`The plug-in unload has encountered some problems.\n  Path: ${this.path}`),console.warn(e)}this.enabled=!1,this._destroy()}exec(e,...i){if(this.json&&this.json.debug)return new Promise((t,n)=>{ipc.sendToWin(this.win,"message",e,...i).callback((e,...i)=>{e?n(e):t(...i)})});if(this.module&&this.module.methods){if(!this.module.methods[e])throw new Error(`Method does not exist(${this.name}.${e})`);return this.module.methods[e].call(this,...i)}}contributionTo(e,i,t){return this.json&&this.json.debug?new Promise((n,s)=>{ipc.sendToWin(this.win,"contributions",e,i,t).callback((e,...i)=>{e?s(e):n(...i)})}):this.module&&this.module.contributions&&this.module.contributions[e]?this.module.contributions[e].call(this,i,t):void 0}generateInfo(){return{name:this.name,version:this.version,debug:this.debug,path:this.path,enable:this.enabled,invalid:this.invalid,info:this.json||{}}}}exports.Package=Package;