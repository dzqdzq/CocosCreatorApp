"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Package=void 0;const panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),electron_1=require("electron"),utils_1=require("../public/utils"),path_1=require("path"),fs_extra_1=require("fs-extra");let debugFile="";class Package{constructor(e){if(this.json={name:"(unknown)",version:"0.0.0",debug:!1},this.panels=[],this.enabled=!1,this.invalid=!1,this.path=e,e&&(0,fs_extra_1.existsSync)(e)){const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"package.json"));t.name=t.name||"(unknown)",t.version=t.version||"0.0.0",t.debug=t.debug||!1;const n=t.name.toLowerCase();n!==t.name&&(console.warn(`Plugin configuration error: plugin name(${t.name}) can only be in lowercase.`),t.name=n),this.json=t}else this.invalid=!0}static debugRely(e){debugFile=e}get name(){return this.json?this.json.name:"(unknown)"}get version(){return this.json?this.json.version:"0.0.0"}get debug(){return!!this.json&&!!this.json.debug}async execLifeFunc(e){if(this.module&&this.module[e])return this.json.debug?await new Promise((t,n)=>{ipc.sendToWin(this.win,e).callback((e,i)=>{if(e)return n(e);t(i)})}):await this.module[e].call(this)}async execHook(e){if(this.json.debug)await new Promise((t,n)=>{ipc.sendToWin(this.win,"hooks",e).callback((e,i)=>{if(e)return n(e);t(i)})});else if(this.json&&this.json.creator&&this.json.creator.hooks){const t=(0,path_1.join)(this.path,this.json.creator.hooks),n=require(t);n[e]&&n[e].call(this,this.json)}}contributionTo(e,t,n){return this.json&&this.json.debug?new Promise((i,s)=>{ipc.sendToWin(this.win,"contributions",e,t,n).callback((e,...t)=>{e?s(e):i(t[0])})}):this.module&&this.module.contributions&&this.module.contributions[e]?this.module.contributions[e].call(this,t,n):void 0}async _init(){if(!this.path||!this.json.main)return;const e=(0,path_1.join)(this.path,this.json.main);if(this.json.debug){const t=this.win=new electron_1.BrowserWindow({width:0,height:0,show:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,backgroundThrottling:!1,preload:debugFile}});t.loadURL(`file://${(0,path_1.join)(__dirname,"../../static/worker.html")}`);let n=!1;await new Promise(i=>{t.webContents.once("dom-ready",()=>{t.openDevTools();let s=null;s=setInterval(()=>{if(!t.devToolsWebContents)return;null!==s&&clearInterval(s),t.devToolsWebContents.focus();let o=ipc.sendToWin(t,"init",e,{});!1===n&&(n=!0,o.callback(()=>{i(void 0)}))},100)})})}else try{this.module=require(e)}catch(e){console.error(`The plug-in main process failed to load. ${e.stack}`),this.module={}}}async _destroy(){if(this.path&&this.json&&this.json.main){const e=(0,path_1.join)(this.path,this.json.main);(0,utils_1.removeCache)(e,this.path),this.module={}}}async enable(){if(this.invalid||!this.json)return void console.error(`The  directory(${this.path}) is not a legal plug-in.`);if(this.enabled)return void console.warn(`The plug-in(${this.path}) has started`);const e=this.json;if(e.panels)for(let t in e.panels){const n="default"===t?this.name:this.name+"."+t,i=e.panels[t];i.package=this.name,i.packageDir=this.path,i.main?panel.register(n,(0,path_1.join)(this.path,i.main),i):console.warn(`The panel(${this.name}.${t}) cannot be registered because the address of the panel file was not filled in`),this.panels.push(n)}this._init();try{await this.execLifeFunc("load"),this.enabled=!0}catch(e){console.warn(`The plug-in load has encountered some problems.\n  Path: ${this.path}`),console.warn(e)}}async disable(){try{if(!1===await this.execLifeFunc("beforeUnload"))return void console.warn(`The ${this.name} plug-in refuses to unload.`);await this.execLifeFunc("unload")}catch(e){console.warn(`The plug-in unload has encountered some problems.\n  Path: ${this.path}`),console.warn(e)}this.enabled=!1,this._destroy()}exec(e,...t){if(this.json&&this.json.debug)return new Promise((n,i)=>{ipc.sendToWin(this.win,"method",e,...t).callback((e,...t)=>{e?i(e):n(t[0])})});if(this.module&&this.module.methods){if(!this.module.methods[e])throw new Error(`Method does not exist(${this.name}.${e})`);return this.module.methods[e].call(this,...t)}}generateInfo(){return{name:this.name,version:this.version,debug:this.debug,path:this.path,enable:this.enabled,invalid:this.invalid,info:this.json}}}exports.Package=Package;