"use strict";const ps=require("path"),ipc=require("@base/electron-base-ipc"),{BrowserWindow:BrowserWindow}=require("electron"),{EventEmitter:EventEmitter}=require("events"),electronSync=require("v-electron-sync"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;let panel2win=Object.create(null),windows=[],name2info=Object.create(null),focusPanelName="",lastFocusPanelName="";class PanelManager extends EventEmitter{register(e,n,i){ps.isAbsolute(n)||(n=ps.join(process.cwd(),n)),i=i||{},name2info[e]={name:e,userData:i,file:n,dirname:ps.dirname(n)},this.emit("register",e),ipc.broadcast(`${ipcFlag}:emit`,"register",e)}unregister(e){delete name2info[e],this.emit("unregister",e),ipc.broadcast(`${ipcFlag}:emit`,"unregister",e)}async exec(e,n,...i){const o=panel2win[e];if(void 0===o)return;const s=[];for(let a=0;a<o.length;a++){const l=o[a];for(let e=a;e>1;e--)o[e];s.push(new Promise((o,s)=>{const a=BrowserWindow.fromId(l);a&&ipc.sendToWin(a,`${ipcFlag}:exec`,e,n,...i).callback((e,n)=>{if(e)return s(e);o(n)})}))}let a;return(await Promise.all(s)).some(e=>{if(void 0!==e&&null!==e)return a=e,!0}),a}queryInfo(e){return name2info[e]||null}focus(e){const n=panel2win[e];if(void 0===n)return!1;const i=n[0];if(void 0===i)return!1;if(focusPanelName===e)return!0;if(panel2win[focusPanelName]){panel2win[focusPanelName].forEach(e=>{const n=BrowserWindow.fromId(e);ipc.sendToWin(n,`${ipcFlag}:blur`,focusPanelName)})}let o=BrowserWindow.fromId(i);return o.focus(),ipc.sendToWin(o,`${ipcFlag}:focus`,e),!0}getFocusPanel(){return{current:focusPanelName,last:lastFocusPanelName}}getPanelsFromWindow(e){return Object.keys(panel2win).filter(n=>-1!==panel2win[n].indexOf(e.id))}getWindow(e){return panel2win[e]||null}}module.exports=new PanelManager,ipc.on(`${ipcFlag}:call`,async(e,n,...i)=>module.exports[n](...i)),ipc.on(`${ipcFlag}:call-send`,(e,...n)=>{let i=module.exports.send(...n);i&&e.needCallback&&i.callback(e.reply)});const listenDestroy=function(e){const n=e.id,i=windows.indexOf(n);if(-1!==i)return;const o=()=>{Object.keys(panel2win).forEach(e=>{const i=panel2win[e].indexOf(n);-1!==i&&(panel2win[e].splice(i,1),0===panel2win[e].length&&delete panel2win[e])})};e.webContents.on("dom-ready",o),e.once("closed",()=>{windows.splice(i,1),o()})};ipc.on(`${ipcFlag}:connected`,(e,n)=>{const i=BrowserWindow.fromWebContents(e.sender);if(!i)return;const o=i.id,s=name2info[n];s&&s.userData.flags&&s.userData.flags.alwaysOnTop&&!i.isAlwaysOnTop()&&i.setAlwaysOnTop(!0),panel2win[n]=panel2win[n]||[],panel2win[n].push(o),-1===windows.indexOf(i.id)&&(listenDestroy(i),windows.push(o))}),ipc.on(`${ipcFlag}:disconnected`,(e,n)=>{const i=BrowserWindow.fromWebContents(e.sender);if(!i){if(panel2win[n])for(let e=0;e<panel2win[n].length;e++){const i=panel2win[n][e],o=BrowserWindow.fromId(i);!o&&o.isDestroyed()&&panel2win[n].splice(e--,1)}return}const o=i.id,s=panel2win[n].indexOf(o);-1!==s&&(panel2win[n].splice(s,1),0===panel2win[n].length&&delete panel2win[n]);const a=module.exports.getPanelsFromWindow(o);if(a){!a.some(e=>{const n=name2info[e];return n&&n.userData.flags&&n.userData.flags.alwaysOnTop})&&i.isAlwaysOnTop()&&i.setAlwaysOnTop(!1)}}),ipc.on(`${ipcFlag}:ready`,(e,n)=>{module.exports.emit("ready",n)}),ipc.on(`${ipcFlag}:close`,(e,n)=>{module.exports.emit("close",n)}),ipc.on(`${ipcFlag}:focus`,(e,n)=>{focusPanelName=n,lastFocusPanelName=n,module.exports.emit("focus",n),ipc.broadcast(`${ipcFlag}:emit`,"focus",n)}),ipc.on(`${ipcFlag}:blur`,(e,n)=>{n===focusPanelName&&(focusPanelName=""),module.exports.emit("blur",n),ipc.broadcast(`${ipcFlag}:emit`,"blur",n)});