/// <reference path="./editor.d.ts"/>
/// <reference path="./message.d.ts"/>

import { EventEmitter } from 'events';
import { BrowserWindow } from 'electron';
import { SpawnOptions } from 'child_process';

declare global {
    export namespace Editor {
        export namespace I18n {
            /**
             * 动态注册 i18n 数据
             * Dynamic registration of i18n data
             *
             * @param language 语言 language
             * @param key 翻译路径 Translation path
             * @param map 翻译表 Translation table
             */
            export function register(language: string, key: string, map: I18nMap): void;
        }
        export namespace Layout {
            export interface CacheLayoutInfo {
                builtin: Record<string, any>;
                custom: Record<string, any>;
                version: string;
            }

            export const __protected__: {
                /**
                 * 初始化布局系统
                 * Initialize the layout system
                 */
                init(layout: Editor.Layout.ILayout): void;
                add(name: string, layout?: Editor.Layout.ILayout): void;
                remove(name: string): void;
                query(name?: string): Promise<Editor.Layout.ILayout>;
                queryList(): Promise<CacheLayoutInfo>;
                on(action: string, handle: (...args: any[]) =>  void);
                once(action: string, handle: (...args: any[]) =>  void);
                emit(action: string);
                removeListener(action: string, handle: (...args: any[]) =>  void);
            };
        }
        export namespace Panel {
            /**
             * 打开指定面板的开发者工具
             * @param name 
             */
            export function _openDevTools(name: string): void;
            export namespace _kitControl {
                export interface IOptions {
                    $kit: HTMLElement;
                    name: string;
                    timestamp?: number;
                    events: Record<string, (...args: any[]) => void>;
                    [key: string]: any;
                }

                export function getOptionsCache(): IOptions;

                /**
                 * 注册预加载某个 kit 面板
                 * @param name
                 */
                export function register(name: string): void;

                /**
                 * 反注册某个已注册的 kit 面板
                 * @param name
                 */
                export function unregister(name: string): void;

                /**
                 * 反注册某个已注册的 kit 面板
                 * @param name
                 * @param parentWindow 渲染进程无需填写，主进程调用必填
                 */
                export function open(options: IOptions, parentWindow?: BrowserWindow): void;

                /**
                 * 隐藏现有的任意 kit 面板
                 */
                export function hide(): void;

                /**
                 * 保持现有窗口的显示状态不消失
                 */
                export function hold(): void;

                /**
                 * 主动派发消息
                 * @param message 消息名
                 * @param timestamp 时间戳
                 * @param args 参数数组
                 */
                export function emit(message: string, timestamp: number, ...args: any[]): void;
            }
        }
        export namespace Logger {
            /**
             * 监听 Logger 内发送的事件
             * Listeners for events sent in the Logger
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             *
             * @param action 监听动作 Monitor actions
             * @param handle 处理函数 The processing function
             */
            export function on(action: string, handle: Function): any;
            /**
             * 监听 Logger 内发送的事件
             * Listeners for events sent in the Logger
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             *
             * @param action 监听动作 Monitor actions
             * @param handle 处理函数 The processing function
             */
            export function once(action: string, handle: Function): any;
            /**
             * 移除监听的事件
             * Removes listener event
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             *
             * @param action 监听动作 Monitor actions
             * @param handle 处理函数 The processing function
             */
            export function removeListener(action: string, handle: Function): any;

            export const __protected__: {
                record(str: string): void;
            };
        }
        export namespace Menu {
            /**
             * 添加一个菜单
             * Add a menu
             * 只有主进程可以使用
             * Only the main process can use it
             *
             * @param path
             * @param options
             */
            export function add(path: string, options: BaseMenuItem): any;
            /**
             * 删除一个菜单
             * Delete a menu
             * 只有主进程可以使用
             * Only the main process can use it
             *
             * @param path
             * @param options
             */
            export function remove(path: string, options: BaseMenuItem): any;
            /**
             * 获取一个菜单对象
             * Gets a menu object
             * 只有主进程可以使用
             * Only the main process can use it
             *
             * @param path
             */
            export function get(path: string): any;
            /**
             * 应用之前的菜单修改
             * Apply the previous menu changes
             * 只有主进程可以使用
             * Only the main process can use it
             */
            export function apply(): any;
            /**
             * 添加分组信息
             * Add grouping information
             *
             * @param path
             * @param name
             * @param order
             */
            export function addGroup(path: string, name: string, order: number): any;
            /**
             * 删除分组信息
             * Delete grouping information
             *
             * @param path
             * @param name
             */
            export function removeGroup(path: string, name: string): any;
            /**
             * 注册菜单模版
             * Register the menu template
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             *
             * @param name
             * @param template
             */
            export function registerTemplate(name: string, template: MenuTemplateItem[]): any;
            /**
             * 移除菜单模版
             * Remove menu template
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             *
             * @param name
             */
            export function unregisterTemplate(name: string): any;
            /**
             * 查询当前弹出的右键菜单的模版信息
             */
            export function queryPopup(): Promise<any>;
            /**
             * 查询当前弹出的右键菜单的模版信息
             * @param searcher 选择器
             */
            export function clickPopup(searcher: string): Promise<any>;
            /**
             * 查询主菜单的模版信息
             */
            export function queryMain(): Promise<any>;
            /**
             * 查询当前弹出的右键菜单的模版信息
             * @param searcher 选择器
             */
            export function clickMain(searcher: string): Promise<any>;
        }
        export namespace Message {
            /**
             * 请勿使用
             * Do not use
             * 马上会被删除
             * It will be deleted immediately
             *
             * @param name
             * @param messageInfo
             */
            export function __register__(
                name: string,
                messageInfo: {
                    [message: string]: MessageInfo;
                },
            ): any;
            /**
             * 请勿使用
             * Do not use
             * 马上会被删除
             * It will be deleted immediately
             *
             * @param name
             */
            export function __unregister__(name: string): any;
            export const __eb__: EventEmitter;
        }
        export namespace Package {

            export type packageType = 'builtin' | 'cover' | 'local' | 'global' | 'other';

            export interface IDisableInfo {
                name: string;
                time: number;
            }

            export const __protected__: {
                /**
                 * 启动已经扫描到的插件
                 */
                startup(handle: (name: string, path: string) => Promise<void>): Promise<void>;
                /**
                 * 记录关闭的插件
                 * @param path 
                 */
                 addDisableInfo(path: string): void;
                 /**
                  * 移除记录的关闭信息
                  * @param path 
                  */
                 removeDisableInfo(path: string): void;
                /**
                 * 获取一个插件是否被有被关闭的记录信息
                 * @param path 
                 */
                queryDisbaleInfo(path: string): Promise<IDisableInfo | void>;
                /**
                 * 关闭同名的其他更高优先级的插件
                 * @param path 
                 */
                disableOther(path: string): Promise<void>;
                /**
                 * 关闭后打开同名的插件，根据优先级顺序打开
                 * @param path 
                 */
                enableOther(path: string): Promise<void>;
                /**
                 * 扫描一个目录，并将返回目录内的所有插件路径数组
                 * @param dir
                 */
                scan(dir: string): Promise<string[]>;
                /**
                 * 传入插件目录，返回插件的类别
                 * @param dir 
                 */
                checkType(dir: string): packageType;
                /**
                 * 检查是否能够在当前版本打开
                 * @param version
                 */
                checkVersion(version: string): boolean;
                /**
                 * 检查是否需要刷新插件数据
                 * @param path 
                 */
                checkReload(path: string): boolean;
                /**
                 * 格式化一个路径地址
                 * @param path 
                 */
                normalizePath(path: string): string;
                /**
                 * 监听插件事件
                 */
                on(action: string, handle: (...args: any[]) => void): any;
                /**
                 * 监听一次插件事件
                 */
                once(action: string, handle: (...args: any[]) => void): any;
                /**
                 * 触发一个监听事件
                 */
                emit(action: string, ...args: any[]): any;
                /**
                 * 移除监听插件的事件
                 */
                removeListener(action: string, handle: (...args: any[]) => void): any;
            };
        }
        export namespace Profile {
            /**
             * 监听 profile 事件
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             */
            export function on(action: string, handle: Function): any;
            /**
             * 监听一次 profile 事件
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             */
            export function once(action: string, handle: Function): any;
            /**
             * 移除监听的 profile 事件
             * 谨慎使用，之后会被移除
             * Use with caution and it will be removed later
             */
            export function removeListener(action: string, handle: Function): any;
        }
        export namespace Startup {
            export const ready: {
                readonly window: any;
                readonly package: any;
            };
            export function window(): Promise<void>;
            export function manager(skipLogin: boolean): Promise<void>;
            export function package(): Promise<void>;
            export function build(options: any, debug: boolean): Promise<any>;
            export function on(action: string, handle: Function): any;
            export function removeListener(action: string, handle: Function): any;
            export function once(action: string, handle: Function): any;

            export interface builtinJSON {
                // 关闭的内置插件
                disableBuiltin?: string[];
                // 启动的外部插件
                extensions?: string[];
                // 
                env?: {
                    // 更改编辑器配置目录
                    HOME?: string;
                    // 更改启动项目
                    PROJECT?: string;
                    // 启动默认使用的布局信息，支持文件路径和 json 对象
                    LAYOUT?: string;
            
                    // 启动默认使用的语言
                    LANGUAGE?: string;
            
                    // 主窗口钩子，在 Editor 执行后立即执行
                    // MAIN_WINDOW_HOOK?: string;
                    // 主窗口特殊的样式
                    // MAIN_WINDOW_STYLE?: string;
                    // 主窗口上的 Header
                    // MAIN_WINDOW_HEADER?: string; 
                    // 叠加新的头部内容
                    MAIN_WINDOW_CUSTOM_HEADER?: string;
                    // 控制内置头部区域显示
                    MAIN_WINDOW_ORIGIN_HEADER?: {
                        ALL?: boolean, // ALL 是控制整个头部的显示；配置为 false 为隐藏; undefined 等同于 true 为显示;
                        CENTER?: boolean, // 中间预览操作区域；true / false 同上意义
                        RIGHT?: boolean, // 右边区域，但不包括关闭窗口的三个按钮区域
                    };
           
                    // 主窗口上的 Footer
                    MAIN_WINDOW_FOOTER?: string;
            
                    // 所有窗口钩子，在 Editor 执行后立即执行
                    WINDOW_HOOK?: string;
                    // 所有窗口的样式
                    WINDOW_STYLE?: string;
                };
            }
        }
        export namespace Metrics {
            export interface trackEventInfo {
                sendToCocosAnalyticsOnly?: boolean;
                // 是否只发送到新的统计后台
                sendToNewCocosAnalyticsOnly?: boolean;
                [propName: string]: any;
            }
            export interface trackWithTimerEventInfo {
                category: string; // 分组目录
                id: string; // 事件行为 ID
                value: number; // 事件值
            }
            export interface trackOptions {
                uid: string;
                cid: string;
                debug?: boolean;
            }
            export interface trackExceptionInfo {
                code: number;
                message: string;
            }
            /**
             * 追踪一个事件
             * Track an event
             * 请勿使用
             * Do not use
             *
             * @param info 跟踪的错误信息 Error message for trace
             */
            export function trackEvent(info: trackEventInfo): any;
            /**
             * 数据自增统计接口，添加的数据会与缓存数据结合递增
             * @param info 统计事件数据
             * @returns 
             */
             export function _trackEventWithTimer(info: trackWithTimerEventInfo): any;
            /**
             * 追踪一个异常
             * Tracing an exception
             * 请勿使用
             * Do not use
             *
             * @param info 跟踪的错误信息 Error message for trace
             */
            export function trackException(info: trackExceptionInfo): any;
            /**
             * 开始追踪时间
             * Start tracking time
             * @param message
             */
            export function trackTimeStart(message: string): void;
            /**
             * 结束追踪时间
             * End tracking time
             * @param message 
             * @param options 输出选项 { output：是否 console.debug 打印; label: 打印的消息名词的替换文本，支持 i18n: 写法; value: 直接打印计算好的统计时间}
             * @return 返回统计时间
             */
            export function trackTimeEnd(message: string, options?: { output?: boolean, label?: string, value?: number }): Promise<number>;
        }

        export namespace Utils {
            export namespace Process {
                export interface IQuickSpawnOption extends SpawnOptions {
                    cwd?: string;
                    env?: any;
                    // 输出等级，默认 = 0，即 log 级别以上都打印
                    logLevel?: LogLevel;
                
                    downGradeWaring?: boolean; // 警告将会转为 log 打印，默认为 false
                    downGradeLog?: boolean; // log 将会转为 debug 打印，默认为 true
                    downGradeError?: boolean; // 错误将会转为警告打印，默认为 false

                    onlyPrintWhenError?: boolean; // 默认为 true, 日志都正常收集，但仅在发生错误时打印信息，其他时候静默处理

                    prefix?: string; // 日志输出前缀
                }
                /**
                 * 快速开启子进程，无需再自行监听输出，将会返回一个标记完成的 promise 对象
                 * @param command 命令
                 * @param cmdParams 参数数组
                 * @param options 可选，开启的一些参数配置
                 */
                 export function quickSpawn(command: string, cmdParams: string[], options?: IQuickSpawnOption):Promise<boolean>;
            }
        }
        export namespace Module {
            export type requireOptions = {
                root?: string;
            };
            /**
             * 动态加载一个脚本模块
             * @param file
             */
            export function requireFile(file: string, options?: requireOptions): any;
            /**
             * 删除加载的模块文件的缓存
             * @param file
             */
            export function removeCache(file: string): any;

            export type ImportProjectModuleDelegate = (url: string) => Promise<unknown>;

            export function setImportProjectModuleDelegate(delegate: ImportProjectModuleDelegate): void;
        }
        export namespace Windows {
            interface IWindowOptions {
                frame?: boolean;
                center?: boolean;
                width?: number;
                height?: number;
                minWidth?: number;
                minHeight?: number;
                titleBarStyle?: 'hiddenInset';
                titleBarOverlay?: number;
                autoHideMenuBar?: boolean;
                menuBarVisibility?: boolean;
                transparent?: boolean;
                resizable?: boolean;
                fullscreen?: boolean;
                minimizable?: boolean;
                show?: boolean;
                webPreferences?: {
                    nodeIntegration?: boolean;
                    webviewTag?: boolean;
                    // backgroundThrottling?: boolean;
                    enableRemoteModule?: boolean;
                    contextIsolation?: boolean;
                    backgroundThrottling?: boolean;
                };
            }

            export const __protected__: {
                startup(): void;
                maximize(): void;
                minimize(): void;
                close(): void;
                open(HTML: string, options?: IWindowOptions, userData?: {[key: string]: any}): Promise<string>;
            
                queryUserData(winID?: string): any;
                changeUserData(data: {[key: string]: any}, winID?: string): void;
                changeMinSize(width: number, height: number, winID?: string): void;
            
                generateBlank(): void;
                openSubWindow(size: { width: number, height: number }, userData: {[key: string]: any})
                openSimpleWindow(size: { width: number, height: number }, userData: {[key: string]: any})
            
                setBeforeOpenHook(func: (windows: any) => void): void;
                setAfterOpenHook(func: (windows: any) => void): void;
            };
        }
    }
}
export {};
