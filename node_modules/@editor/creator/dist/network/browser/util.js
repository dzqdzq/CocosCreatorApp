"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(n,s){function i(e){try{c(r.next(e))}catch(e){s(e)}}function u(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(i,u)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sendPostRequest=exports.sendGetRequest=exports.portIsOccupied=exports.canConnectPassport=exports.queryIpList=void 0;const os_1=require("os"),https=require("https"),http=require("http"),net=require("net"),url_1=require("url"),querystring_1=require("querystring");function queryIpList(){const e=(0,os_1.networkInterfaces)();let t=[];for(const o of Object.keys(e))e[o].forEach(e=>{"IPv4"===e.family&&!1===e.internal&&/^(?!169\.254)/.test(e.address)&&t.push(e.address)});return t}function canConnectPassport(){return new Promise(e=>{const t=https.request({method:"GET",host:"passport.cocos.com",port:443,path:"/oauth/token?xxx",headers:{},timeout:3e3},t=>{if(200!==t.statusCode)return console.warn("failed to connect login server... skipping login"),t.resume(),e(!1);e(!0)}).on("error",t=>{console.warn("failed to connect login server... skipping login"),e(!1)}).on("timeout",()=>{console.warn("failed to connect login server due to request timeout"),e(!1)});t.write(""),t.end()})}function portIsOccupied(e){return __awaiter(this,void 0,void 0,function*(){return new Promise((t,o)=>{const r=net.createServer().listen(e);r.on("listening",function(){r.close(),t(!1)}),r.on("error",function(e){e.code,t(!0)})})})}function sendGetRequest(e,t){return new Promise((o,r)=>{const n=(0,url_1.parse)(e);t=(0,querystring_1.stringify)(t||{});const s={"User-Agent":Editor.App.userAgent},i={method:"GET",host:n.hostname,port:n.port,path:n.pathname+(t?"?"+t:""),headers:s,ciphers:"ALL"},u=[];(n.protocol.startsWith("https:")?https:http).request(i,e=>{if(301!==e.statusCode&&302!==e.statusCode||!e.headers||!e.headers.location)return 200!==e.statusCode?(o(null),void e.resume()):void e.on("data",e=>{u.push(e)}).on("end",()=>{o(Buffer.concat(u))});sendGetRequest(e.headers.location,t).then(o).catch(r)}).on("error",e=>{r(e)}).setTimeout(8e3,()=>{r(new Error(`GET Timeout: ${e}`))}).end()})}function sendPostRequest(e,t){return new Promise((o,r)=>{const n=(0,url_1.parse)(e);"object"==typeof t?t=(0,querystring_1.stringify)(t||{}):t+="";const s={"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(t),"User-Agent":Editor.App.userAgent},i={method:"POST",host:n.hostname,port:n.port,path:n.pathname,headers:s,ciphers:"ALL"},u=[],c=(n.protocol.startsWith("https:")?https:http).request(i,e=>{if(301!==e.statusCode&&302!==e.statusCode||!e.headers||!e.headers.location)return 200!==e.statusCode?(r(new Error("Connect Failed")),void e.resume()):void e.on("data",e=>{u.push(e)}).on("end",()=>{o(Buffer.concat(u))});sendPostRequest(e.headers.location,t).then(o).catch(r)}).on("error",e=>{r(e)}).setTimeout(8e3,()=>{r(new Error(`POST Timeout: ${e}`))});c.write(t),c.end()})}exports.queryIpList=queryIpList,exports.canConnectPassport=canConnectPassport,exports.portIsOccupied=portIsOccupied,exports.sendGetRequest=sendGetRequest,exports.sendPostRequest=sendPostRequest;