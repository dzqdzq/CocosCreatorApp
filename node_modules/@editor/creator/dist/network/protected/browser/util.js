"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sendPostRequest=exports.sendGetRequest=exports.portIsOccupied=exports.canConnectPassport=exports.queryIpList=void 0;const os_1=require("os"),https=require("https"),http=require("http"),net=require("net"),url_1=require("url"),querystring_1=require("querystring"),electron_1=require("electron"),moment_timezone_1=require("moment-timezone");function queryIpList(){var e=(0,os_1.networkInterfaces)();let t=[];for(const o of Object.keys(e))e[o].forEach(e=>{"IPv4"===e.family&&!1===e.internal&&/^(?!169\.254)/.test(e.address)&&t.push(e.address)});return t}function canConnectPassport(){return new Promise(t=>{const o=https.request({method:"GET",host:"passport.cocos.com",port:443,path:"/oauth/token?xxx",headers:{},timeout:3e3},e=>{if(o.destroy(),!(200<=e.statusCode&&e.statusCode<300))return console.warn("failed to connect login server... skipping login"),t(!1);t(!0)});o.on("error",e=>{console.warn("Failed to connect to login server:",e.message),t(!1)}),o.on("timeout",()=>{console.warn("Request timeout, aborting..."),o.destroy(),t(!1)}),o.end()})}async function portIsOccupied(s){return new Promise((t,e)=>{const o=net.createServer().listen(s);o.on("listening",function(){o.close(),t(!1)}),o.on("error",function(e){e.code,t(!0)})})}function sendGetRequest(n,u){return new Promise((t,o)=>{var e=(0,url_1.parse)(n),s=(u=(0,querystring_1.stringify)(u||{}),{"User-Agent":Editor.App.userAgent,"Accept-Language":electron_1.app.getLocale(),"Time-Zone":moment_timezone_1.tz.guess()}),s={method:"GET",host:e.hostname,port:e.port,path:e.pathname+(u?"?"+u:""),headers:s,ciphers:"ALL"};const r=[];(e.protocol.startsWith("https:")?https:http).request(s,e=>{(301===e.statusCode||302===e.statusCode)&&e.headers&&e.headers.location?sendGetRequest(e.headers.location,u).then(t).catch(o):200<=e.statusCode&&e.statusCode<300?e.on("data",e=>{r.push(e)}).on("end",()=>{t(Buffer.concat(r))}):(t(null),e.resume())}).on("error",e=>{o(e)}).setTimeout(8e3,()=>{o(new Error("GET Timeout: "+n))}).end()})}function sendPostRequest(n,u){return new Promise((t,o)=>{var e=(0,url_1.parse)(n),s=("object"==typeof u?u=(0,querystring_1.stringify)(u||{}):u+="",{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(u),"User-Agent":Editor.App.userAgent,"Accept-Language":electron_1.app.getLocale(),"Time-Zone":moment_timezone_1.tz.guess()}),s={method:"POST",host:e.hostname,port:e.port,path:e.pathname,headers:s,ciphers:"ALL"};const r=[];e=(e.protocol.startsWith("https:")?https:http).request(s,e=>{(301===e.statusCode||302===e.statusCode)&&e.headers&&e.headers.location?sendPostRequest(e.headers.location,u).then(t).catch(o):200<=e.statusCode&&e.statusCode<300?e.on("data",e=>{r.push(e)}).on("end",()=>{t(Buffer.concat(r))}):(o(new Error("Connect Failed")),e.resume())}).on("error",e=>{o(e)}).setTimeout(8e3,()=>{o(new Error("POST Timeout: "+n))});e.write(u),e.end()})}exports.queryIpList=queryIpList,exports.canConnectPassport=canConnectPassport,exports.portIsOccupied=portIsOccupied,exports.sendGetRequest=sendGetRequest,exports.sendPostRequest=sendPostRequest;