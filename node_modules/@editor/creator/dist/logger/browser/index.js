"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const os_1=require("os"),events_1=require("events"),fse=require("fs-extra"),ps=require("path"),Stream=require("stream"),v_stacks_1=require("v-stacks"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),logger=require("@base/electron-logger"),utils=require("./utils");logger.setLogHandler(e=>{if(e.message="[Editor] "+e.message,("warn"===e.type||"error"===e.type)&&0===e.stack.length){const r=new Error("Unknown warning");e.stack=(0,v_stacks_1.ignoreStack)(r.stack,3)}});class Logger extends events_1.EventEmitter{constructor(){if(super(),setting.PATH.PROJECT){this.dirname=ps.join(setting.PATH.PROJECT,"./temp/logs"),fse.ensureDirSync(this.dirname),this.clear(),this.file=ps.join(this.dirname,"project.log"),fse.existsSync(this.file)&&fse.removeSync(this.file);const e=fse.createWriteStream(this.file,{flags:"a"});this._readStream=new Stream.Readable({read(){}}),this._readStream.pipe(e,{end:!1})}}clear(e){logger.clear&&logger.clear(e)}query(){return logger.query()}record(e){const r=utils.formatLog({message:e+"",type:"verbose",time:Date.now()})+os_1.EOL;this._readStream&&this._readStream.push(r)}}module.exports=new Logger;const cyptoDeprecated=/crypto\.createDecipher is deprecated\.$/;logger.setLogHandler(e=>!cyptoDeprecated.test(e.message)),logger.on("record",e=>{module.exports.emit("record",e);const r=utils.formatLog(e)+os_1.EOL,t=module.exports._readStream;t&&t.push(r)}),logger.on("clear",(e,r)=>{module.exports.emit("clear",r)}),ipc.on("editor-lib-logger:call",(e,r,t=[])=>{if(!module.exports[r])return;const s=module.exports[r](...t);e.reply(null,s)}),process.on("unhandledRejection",e=>{console.error(e)});