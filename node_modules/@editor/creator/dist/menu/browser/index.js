"use strict";var __awaiter=this&&this.__awaiter||function(e,n,o,t){return new(o||(o=Promise))(function(u,p){function r(e){try{i(t.next(e))}catch(e){p(e)}}function l(e){try{i(t.throw(e))}catch(e){p(e)}}function i(e){var n;e.done?u(e.value):(n=e.value,n instanceof o?n:new o(function(e){e(n)})).then(r,l)}i((t=t.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.connectMainMenu=exports.disconnectMainMenu=exports.unregisterTemplate=exports.registerTemplate=exports.apply=exports.removeGroup=exports.addGroup=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc");let connected=!0;const menuMap={};function add(e,n){menuMap[e]&&menuMap[n.label]&&remove(e,n),menuMap[e]=menuMap[e]||{},menuMap[e][n.label]=n,(0,main_menu_1.add)(e,n)}function remove(e,n){menuMap[e]&&delete menuMap[e][n.label],(0,main_menu_1.remove)(e,n)}exports.add=add,exports.remove=remove;const groupMap={};function addGroup(e,n,o){const t=(0,utils_1.translationPath)(e),u=menu.get(t);groupMap[e]=groupMap[e]||{},groupMap[e][n]=o,u&&u.group(n,o)}function removeGroup(e,n){const o=(0,utils_1.translationPath)(e),t=menu.get(o);groupMap[e]&&delete groupMap[e][n],t._groups.some((e,o)=>{if(e.name===n)return t._groups.splice(o,1),!0})}exports.addGroup=addGroup,exports.removeGroup=removeGroup;const timer=null;function apply(){clearTimeout(timer),menu.apply(),ipc.broadcast("editor-menu-lib:apply")}function registerTemplate(e,n){}function unregisterTemplate(e){}function disconnectMainMenu(){connected=!1}function connectMainMenu(){connected=!0,apply()}exports.apply=apply,exports.registerTemplate=registerTemplate,exports.unregisterTemplate=unregisterTemplate,exports.disconnectMainMenu=disconnectMainMenu,exports.connectMainMenu=connectMainMenu,i18n.on("switch",()=>__awaiter(void 0,void 0,void 0,function*(){menu.clear();for(const e in menuMap){const n=menuMap[e];for(const o in n)add(e,n[o])}for(const e in groupMap){const n=groupMap[e];for(const o in n)addGroup(e,o,n[o])}apply()}));let _popupMenu=null,_popupMenuOptions=null;ipc.on("editor-lib-menu:popup",(e,n)=>{_popupMenuOptions=n;const o=[];n.menu.forEach(n=>{const t=(0,utils_1.translationOption)(n,{click:(n,o)=>(delete o.menu,e.reply(null,o.__path__,n),!1)});o.push(t)});const t=electron_1.Menu.buildFromTemplate(o),u=electron_1.BrowserWindow.fromWebContents(e.sender);t.popup({window:u,x:n.x,y:n.y}),_popupMenu=t,_popupMenuOptions=n,t.once("menu-will-close",()=>{_popupMenu=null,_popupMenuOptions=null})}),ipc.on("editor-lib-menu:query-popup",e=>{if(!_popupMenu)return e.reply(null,null);const n={};!function e(n,o){for(const t of o.items)n[t.__path__]={path:t.__path__,label:t.label,enabled:t.enabled,order:t.order,group:t.group,message:t.message,params:t.params},t.submenu&&(n[t.__path__].submenu={},e(n[t.__path__].submenu,t.submenu))}(n,_popupMenu),e.reply(null,n)}),ipc.on("editor-lib-menu:click-popup",(e,n)=>{if(!_popupMenu)return e.reply(null,!1),!1;const o=n.split("/");let t={submenu:_popupMenu},u="";for(let n=0;n<o.length;n++){const p=o[n];if(u+=p,!t.submenu)return e.reply(null,!1),!1;if(t=t.submenu.items.find(e=>e.__path__===u),u+="/",!t)return e.reply(null,!1),!1}return t.click(),_popupMenu.closePopup(),_popupMenuOptions=null,_popupMenu=null,e.reply(null,!0),!0}),ipc.on("editor-lib-menu:query-main",e=>{const n={};return function e(n,o){for(const t of o.items){if(!t.__path__){if(!t.label){n[Math.random().toString()]={type:"separator"};continue}t.__path__=t.label}n[t.__path__]={path:t.__path__,label:t.label,enabled:t.enabled,order:t.order,group:t.group,message:t.message,params:t.params,sublabel:t.sublabel,accelerator:t.accelerator,icon:t.icon,checked:t.checked,type:t.type},t.submenu&&(n[t.__path__].submenu={},e(n[t.__path__].submenu,t.submenu))}}(n,electron_1.Menu.getApplicationMenu()),e.reply(null,n),n}),ipc.on("editor-lib-menu:click-main",(e,n)=>{const o=n.split("/");let t={submenu:electron_1.Menu.getApplicationMenu()};if(o.forEach(e=>{t=t&&t.submenu?t.submenu.items.find(n=>{if(n.__path__){const o=n.__path__.split("/");return o[o.length-1]===e}return!1}):null}),!t){const n=new Error(`Menu is missing: ${o.join("/")}`);throw e.reply(null,n),n}if(t.role){const n=electron_1.BrowserWindow.getFocusedWindow()||electron_1.BrowserWindow.fromWebContents(e.sender);if(n)switch(t.role){case"toggledevtools":n.webContents.isDevToolsOpened()?n.webContents.closeDevTools():n.webContents.openDevTools();break;default:n.webContents[t.role]&&n.webContents[t.role]()}}else t.click(),e.reply(null)});