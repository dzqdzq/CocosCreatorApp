"use strict";var __awaiter=this&&this.__awaiter||function(e,n,t,p){return new(t||(t=Promise))(function(o,u){function r(e){try{l(p.next(e))}catch(e){u(e)}}function a(e){try{l(p.throw(e))}catch(e){u(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(r,a)}l((p=p.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.connectMainMenu=exports.disconnectMainMenu=exports.unregisterTemplate=exports.registerTemplate=exports.apply=exports.removeGroup=exports.addGroup=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),menu_template_1=require("./menu-template");let connected=!0;const i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc"),menuMap={},templateMap={};function add(e,n){if(menuMap[e]&&menuMap[n.label]&&remove(e,n),menuMap[e]=menuMap[e]||{},menuMap[e][n.label]=n,n.template){templateMap[n.template]={path:e,option:n};const t=(0,menu_template_1.query)(n.template);t&&t.forEach(t=>{const p=(0,utils_1.mergeOption)(n,t);p.__template__=n.template,(0,main_menu_1.add)(e,p)})}else(0,main_menu_1.add)(e,n)}function remove(e,n){if(menuMap[e]&&delete menuMap[e][n.label],n.template){const t=(0,menu_template_1.query)(n.template);t&&t.forEach(n=>{(0,main_menu_1.remove)(e,n)})}else(0,main_menu_1.remove)(e,n)}exports.add=add,exports.remove=remove;const groupMap={};function addGroup(e,n,t){const p=(0,utils_1.translationPath)(e),o=menu.get(p);groupMap[e]=groupMap[e]||{},groupMap[e][n]=t,o&&o.group(n,t)}function removeGroup(e,n){const t=(0,utils_1.translationPath)(e),p=menu.get(t);groupMap[e]&&delete groupMap[e][n],p._groups.some((e,t)=>{if(e.name===n)return p._groups.splice(t,1),!0})}exports.addGroup=addGroup,exports.removeGroup=removeGroup;const timer=null;function apply(){clearTimeout(timer),menu.apply()}function registerTemplate(e,n){const t=templateMap[e];t&&remove(t.path,t.option),(0,menu_template_1.register)(e,n),t&&(add(t.path,t.option),apply())}function unregisterTemplate(e){const n=templateMap[e];n&&(remove(n.path,n.option),apply()),(0,menu_template_1.unregister)(e)}function disconnectMainMenu(){connected=!1}function connectMainMenu(){connected=!0,apply()}exports.apply=apply,exports.registerTemplate=registerTemplate,exports.unregisterTemplate=unregisterTemplate,exports.disconnectMainMenu=disconnectMainMenu,exports.connectMainMenu=connectMainMenu,i18n.on("switch",()=>__awaiter(void 0,void 0,void 0,function*(){menu.clear();for(const e in menuMap){const n=menuMap[e];for(const t in n)add(e,n[t])}for(const e in groupMap){const n=groupMap[e];for(const t in n)addGroup(e,t,n[t])}apply()}));let _popupMenu=null,_popupMenuOptions=null;ipc.on("editor-lib-menu:popup",(e,n)=>{_popupMenuOptions=n;const t=[];n.menu.forEach(n=>{if(n.template){const p=(0,menu_template_1.query)(n.template);p&&p.forEach(p=>{const o=(0,utils_1.mergeOption)(n,p);o.__template__=n.template,t.push((0,utils_1.translationOption)(o,{click:(n,t)=>(delete t.menu,e.reply(null,t.__path__,n),!1)}))})}else t.push((0,utils_1.translationOption)(n,{click:(n,t)=>(delete t.menu,e.reply(null,t.__path__,n),!1)}))});const p=electron_1.Menu.buildFromTemplate(t),o=electron_1.BrowserWindow.fromWebContents(e.sender);p.popup({window:o,x:n.x,y:n.y}),_popupMenu=p,_popupMenuOptions=n,p.once("menu-will-close",()=>{_popupMenu=null,_popupMenuOptions=null})}),ipc.on("editor-lib-menu:query-popup",e=>{if(!_popupMenu)return e.reply(null,null);const n={};!function e(n,t){for(const p of t.items)n[p.__path__]={path:p.__path__,label:p.label,enabled:p.enabled,order:p.order,group:p.group,message:p.message,params:p.params},p.submenu&&(n[p.__path__].submenu={},e(n[p.__path__].submenu,p.submenu))}(n,_popupMenu),e.reply(null,n)}),ipc.on("editor-lib-menu:click-popup",(e,n)=>{if(!_popupMenu)return e.reply(null,!1),!1;const t=n.split("/");let p={submenu:_popupMenu},o="";for(let n=0;n<t.length;n++){const u=t[n];if(o+=u,!p.submenu)return e.reply(null,!1),!1;if(p=p.submenu.items.find(e=>e.__path__===o),o+="/",!p)return e.reply(null,!1),!1}return p.click(),_popupMenu.closePopup(),_popupMenuOptions=null,_popupMenu=null,e.reply(null,!0),!0}),ipc.on("editor-lib-menu:query-main",e=>{const n={};return function e(n,t){for(const p of t.items)p.__path__?(n[p.__path__]={path:p.__path__,label:p.label,enabled:p.enabled,order:p.order,group:p.group,message:p.message,params:p.params,sublabel:p.sublabel,accelerator:p.accelerator,icon:p.icon,checked:p.checked,type:p.type},p.submenu&&(n[p.__path__].submenu={},e(n[p.__path__].submenu,p.submenu))):n[Math.random().toString()]={type:"separator"}}(n,electron_1.Menu.getApplicationMenu()),e.reply(null,n),n}),ipc.on("editor-lib-menu:click-main",(e,n)=>{const t=n.split("/");let p={submenu:electron_1.Menu.getApplicationMenu()};if(t.forEach(e=>{p=p&&p.submenu?p.submenu.items.find(n=>{if(n.__path__){const t=n.__path__.split("/");return t[t.length-1]===e}return!1}):null}),!p){const n=new Error(`Menu is missing: ${t.join("/")}`);throw e.reply(null,n),n}p.click(),e.reply(null)});