"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,p){return new(n||(n=Promise))(function(u,o){function r(e){try{a(p.next(e))}catch(e){o(e)}}function l(e){try{a(p.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?u(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}a((p=p.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unregisterTemplate=exports.registerTemplate=exports.apply=exports.removeGroup=exports.addGroup=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),menu_template_1=require("./menu-template"),i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc"),menuMap={},templateMap={};function add(e,t){if(menuMap[e]&&menuMap[t.label]&&remove(e,t),menuMap[e]=menuMap[e]||{},menuMap[e][t.label]=t,t.template){templateMap[t.template]={path:e,option:t};const n=(0,menu_template_1.query)(t.template);n&&n.forEach(n=>{const p=(0,utils_1.mergeOption)(t,n);p.__template__=t.template,(0,main_menu_1.add)(e,p)})}else(0,main_menu_1.add)(e,t)}function remove(e,t){if(menuMap[e]&&delete menuMap[e][t.label],t.template){const n=(0,menu_template_1.query)(t.template);n&&n.forEach(t=>{(0,main_menu_1.remove)(e,t)})}else(0,main_menu_1.remove)(e,t)}exports.add=add,exports.remove=remove;const groupMap={};function addGroup(e,t,n){const p=(0,utils_1.translationPath)(e),u=menu.get(p);groupMap[e]=groupMap[e]||{},groupMap[e][t]=n,u&&u.group(t,n)}function removeGroup(e,t){const n=(0,utils_1.translationPath)(e),p=menu.get(n);groupMap[e]&&delete groupMap[e][t],p._groups.some((e,n)=>{if(e.name===t)return p._groups.splice(n,1),!0})}exports.addGroup=addGroup,exports.removeGroup=removeGroup;const timer=null;function apply(){clearTimeout(timer),menu.apply()}function registerTemplate(e,t){const n=templateMap[e];n&&remove(n.path,n.option),(0,menu_template_1.register)(e,t),n&&(add(n.path,n.option),apply())}function unregisterTemplate(e){const t=templateMap[e];t&&(remove(t.path,t.option),apply()),(0,menu_template_1.unregister)(e)}exports.apply=apply,exports.registerTemplate=registerTemplate,exports.unregisterTemplate=unregisterTemplate,i18n.on("switch",()=>__awaiter(void 0,void 0,void 0,function*(){menu.clear();for(const e in menuMap){const t=menuMap[e];for(const n in t)add(e,t[n])}for(const e in groupMap){const t=groupMap[e];for(const n in t)addGroup(e,n,t[n])}apply()}));let _popupMenu=null,_popupMenuOptions=null;ipc.on("editor-lib-menu:popup",(e,t)=>{_popupMenuOptions=t;const n=[];t.menu.forEach(t=>{if(t.template){const p=(0,menu_template_1.query)(t.template);p&&p.forEach(p=>{const u=(0,utils_1.mergeOption)(t,p);u.__template__=t.template,n.push((0,utils_1.translationOption)(u,{click:(t,n)=>(delete n.menu,e.reply(null,n.__path__,t),!1)}))})}else n.push((0,utils_1.translationOption)(t,{click:(t,n)=>(delete n.menu,e.reply(null,n.__path__,t),!1)}))});const p=electron_1.Menu.buildFromTemplate(n),u=electron_1.BrowserWindow.fromWebContents(e.sender);p.popup({window:u,x:t.x,y:t.y}),_popupMenu=p,_popupMenuOptions=t,p.once("menu-will-close",()=>{_popupMenu=null,_popupMenuOptions=null})}),ipc.on("editor-lib-menu:query-popup",e=>{if(!_popupMenu)return e.reply(null,null);const t={};!function e(t,n){for(const p of n.items)t[p.__path__]={path:p.__path__,label:p.label,enabled:p.enabled,order:p.order,group:p.group,message:p.message,params:p.params},p.submenu&&(t[p.__path__].submenu={},e(t[p.__path__].submenu,p.submenu))}(t,_popupMenu),e.reply(null,t)}),ipc.on("editor-lib-menu:click-popup",(e,t)=>{if(!_popupMenu)return e.reply(null,!1),!1;const n=t.split("/");let p={submenu:_popupMenu},u="";for(let t=0;t<n.length;t++){const o=n[t];if(u+=o,!p.submenu)return e.reply(null,!1),!1;if(p=p.submenu.items.find(e=>e.__path__===u),u+="/",!p)return e.reply(null,!1),!1}return p.click(),_popupMenu.closePopup(),_popupMenuOptions=null,_popupMenu=null,e.reply(null,!0),!0}),ipc.on("editor-lib-menu:query-main",e=>{const t={};return function e(t,n){for(const p of n.items)p.__path__?(t[p.__path__]={path:p.__path__,label:p.label,enabled:p.enabled,order:p.order,group:p.group,message:p.message,params:p.params},p.submenu&&(t[p.__path__].submenu={},e(t[p.__path__].submenu,p.submenu))):t[Math.random().toString()]={type:"separator"}}(t,electron_1.Menu.getApplicationMenu()),e.reply(null,t),t}),ipc.on("editor-lib-menu:click-main",(e,t)=>{const n=t.split("/");let p={submenu:electron_1.Menu.getApplicationMenu()};if(n.forEach(e=>{p=p&&p.submenu?p.submenu.items.find(t=>{if(t.__path__){const n=t.__path__.split("/");return n[n.length-1]===e}return!1}):null}),!p){const t=new Error(`Menu is missing: ${n.join("/")}`);throw e.reply(null,t),t}p.click(),e.reply(null)});