"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.clickMain=exports.queryMain=exports.clickPopup=exports.queryPopup=exports.connectMainMenu=exports.disconnectMainMenu=exports.removeGroup=exports.addGroup=exports.apply=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc");let connected=!0;const menuMap={};function add(e,n){menuMap[e]&&menuMap[n.label]&&remove(e,n),menuMap[e]=menuMap[e]||{},menuMap[e][n.label]=n,(0,main_menu_1.add)(e,n)}function remove(e,n){menuMap[e]&&delete menuMap[e][n.label],(0,main_menu_1.remove)(e,n)}function apply(){menu.apply(),ipc.broadcast("editor-menu-lib:apply")}exports.add=add,exports.remove=remove,exports.apply=apply;const groupMap={};function addGroup(e,n,o=0){var r=(0,utils_1.translationPath)(e),r=menu.get(r);groupMap[e]=groupMap[e]||{},groupMap[e][n]=o,r&&r.group(n,o)}function removeGroup(e,o){var n=(0,utils_1.translationPath)(e);const r=menu.get(n);groupMap[e]&&delete groupMap[e][o],r._groups.some((e,n)=>{if(e.name===o)return r._groups.splice(n,1),!0})}function disconnectMainMenu(){connected=!1}function connectMainMenu(){connected=!0,apply()}async function queryPopup(){return console.warn("This method(queryPopup) is temporarily unavailable for the current process."),[]}async function clickPopup(e){console.warn("This method(clickPopup) is temporarily unavailable for the current process.")}async function queryMain(){return _queryMain()}async function clickMain(e){console.warn("This method(clickMain) is temporarily unavailable for the current process.")}exports.addGroup=addGroup,exports.removeGroup=removeGroup,exports.disconnectMainMenu=disconnectMainMenu,exports.connectMainMenu=connectMainMenu,exports.queryPopup=queryPopup,exports.clickPopup=clickPopup,exports.queryMain=queryMain,exports.clickMain=clickMain,i18n.on("switch",async()=>{menu.clear();for(const o in menuMap){var e=menuMap[o];for(const r in e)add(o,e[r])}for(const p in groupMap){var n=groupMap[p];for(const u in n)addGroup(p,u,n[u])}apply()}),ipc.on("editor-lib-task:call-protected",async(n,e,...o)=>{try{var r=await exports[e](...o);return n.reply(null,r),r}catch(e){n.reply(e)}return null});let _popupMenu=null,_popupMenuOptions=null;function _queryMain(){var e={};return function e(n,o){for(const r of o.items){if(!r.__path__){if(!r.label){n[Math.random().toString()]={type:"separator"};continue}r.__path__=r.label}n[r.__path__]={path:r.__path__,label:r.label,enabled:r.enabled,order:r.order,group:r.group,message:r.message,params:r.params,sublabel:r.sublabel,accelerator:r.accelerator,icon:r.icon,checked:r.checked,type:r.type,visible:r.visible},r.submenu&&(n[r.__path__].submenu={},e(n[r.__path__].submenu,r.submenu))}}(e,electron_1.Menu.getApplicationMenu()),e}ipc.on("editor-lib-menu:popup",(o,e)=>{var n=(_popupMenuOptions=e).menu;const r=[];n.forEach(e=>{e=(0,utils_1.translationOption)(e,(e,n)=>{n.click&&!n.role&&(n.click=()=>{delete n.menu,o.reply(null,n.__path__,e)})});r.push(e)});var n=electron_1.Menu.buildFromTemplate(r),p=electron_1.BrowserWindow.fromWebContents(o.sender);n.popup({window:p,x:e.x,y:e.y}),_popupMenu=n,_popupMenuOptions=e,n.once("menu-will-close",()=>{_popupMenu=null,_popupMenuOptions=null})}),ipc.on("editor-lib-menu:query-popup",e=>{if(!_popupMenu)return e.reply(null,null);var n={};!function e(n,o){for(const r of o.items)n[r.__path__]={path:r.__path__,label:r.label,enabled:r.enabled,order:r.order,group:r.group,message:r.message,params:r.params},r.submenu&&(n[r.__path__].submenu={},e(n[r.__path__].submenu,r.submenu))}(n,_popupMenu),e.reply(null,n)}),ipc.on("editor-lib-menu:click-popup",(n,e)=>{if(!_popupMenu)return n.reply(null,!1),!1;var o=e.split("/");let r={submenu:_popupMenu},p="";for(let e=0;e<o.length;e++){var u=o[e];if(p+=u,!r.submenu)return n.reply(null,!1),!1;if(r=r.submenu.items.find(e=>e.__path__===p),p+="/",!r)return n.reply(null,!1),!1}return r.click(),_popupMenu.closePopup(),_popupMenuOptions=null,_popupMenu=null,n.reply(null,!0),!0}),ipc.on("editor-lib-menu:query-main",e=>{var n=_queryMain();return e.reply(null,n),n}),ipc.on("editor-lib-menu:click-main",(e,n)=>{var n=n.split("/");let o={submenu:electron_1.Menu.getApplicationMenu()};if(n.forEach(n=>{o=o&&o.submenu?o.submenu.items.find(e=>{return!!e.__path__&&(e=e.__path__.split("/"))[e.length-1]===n}):null}),!o)throw n=new Error("Menu is missing: "+n.join("/")),e.reply(null,n),n;o.role?(n=electron_1.BrowserWindow.getFocusedWindow()||electron_1.BrowserWindow.fromWebContents(e.sender))&&("toggledevtools"===o.role?n.webContents.isDevToolsOpened()?n.webContents.closeDevTools():n.webContents.openDevTools():n.webContents[o.role]&&n.webContents[o.role]()):(o.click(),e.reply(null))});