"use strict";var __awaiter=this&&this.__awaiter||function(e,i,n,t){return new(n||(n=Promise))(function(a,l){function s(e){try{r(t.next(e))}catch(e){l(e)}}function o(e){try{r(t.throw(e))}catch(e){l(e)}}function r(e){var i;e.done?a(e.value):(i=e.value,i instanceof n?i:new n(function(e){e(i)})).then(s,o)}r((t=t.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),Profile=require("@base/electron-profile"),profile=Profile.load("global://editor/user.json"),ipc=require("@base/electron-base-ipc"),index_1=require("./login-panel/index");window.customElements.get("login-panel")||window.customElements.define("login-panel",index_1.Login);const flag="editor-lib-user",flag_protected="editor-lib-user-protected";class UserManager extends events_1.EventEmitter{constructor(){if(super(),this.isReady=!1,!window.__MAIN__)return;ipc.sendSync(`${flag}:check-skip-init`)||this._init()}_init(){this.isReady||(this.isReady=!0,this._panel=document.createElement("login-panel"),this._panel.loading=!0,this._panel.hidden=!0,document.body.prepend(this._panel),this.isLoggedIn().then(e=>{this._panel.loading=!1,e?ipc.send(`${flag}:call`,"nextInit"):this._panel.hidden=!1}).catch(e=>{console.warn(e),this._panel.loading=!1,this._panel.hidden=!1}),this.on("login",()=>{this._panel.loading=!1,this.hideMask()}),this.on("logout",()=>{this._panel.loading=!1,this.showMask()}))}skip(){ipc.send(`${flag}:call`,"skip")}showMask(){ipc.send(`${flag}:call`,"showMask")}hideMask(){ipc.send(`${flag}:call`,"hideMask")}getData(){return new Promise((e,i)=>{ipc.send(`${flag}:call`,"getData").callback((n,t)=>n?i(n):e(t))})}isLoggedIn(){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,i)=>{ipc.send(`${flag}:call`,"isLoggedIn").callback((n,t)=>n?i(n):e(t))})})}login(e,i){return __awaiter(this,void 0,void 0,function*(){return new Promise((n,t)=>{ipc.send(`${flag}:call`,"login",e,i).callback((e,i)=>e?t(e):n(i))})})}logout(){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,i)=>{ipc.send(`${flag}:call`,"logout").callback((n,t)=>n?i(n):e(t))})})}getUserToken(){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,i)=>{ipc.send(`${flag}:call`,"getUserToken").callback((n,t)=>n?i(n):e(t))})})}getSessionCode(e){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,n)=>{ipc.send(`${flag}:call`,"getSessionCode",e).callback((e,t)=>e?n(e):i(t))})})}get __protected__(){return{queryLicenseByPluginName:e=>new Promise((i,n)=>{ipc.send(`${flag_protected}:call`,"queryLicenseByPluginName",e).callback((e,t)=>e?n(e):i(t))}),queryLicenseByName:e=>new Promise((i,n)=>{ipc.send(`${flag_protected}:call`,"queryLicenseByName",e).callback((e,t)=>e?n(e):i(t))})}}}let user=module.exports=new UserManager;ipc.on(`${flag}:emit`,(e,i,...n)=>{user.emit(i,...n)}),window.__MAIN__&&(ipc.on(`${flag}:showMask`,(e,i,...n)=>{user._panel.hidden=!1}),ipc.on(`${flag}:hideMask`,(e,i,...n)=>{user._panel.hidden=!0}),ipc.on(`${flag}:init`,()=>__awaiter(void 0,void 0,void 0,function*(){user._init()})));