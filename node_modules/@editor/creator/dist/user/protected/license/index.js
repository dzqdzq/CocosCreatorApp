"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.licenseManager=void 0;const utils_1=require("./utils"),electron_base_ipc_1=require("@base/electron-base-ipc"),md5=require("md5"),user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user");class LicenseManager{licenseNames=["NintendoSwitchBuild"];licenses=new Map;constructor(){this.licenses=new Map}async getLicenseInOffline(s){var{licenseName:s,pluginName:t}=s,s=s||t;if(s){let e;try{e=utils_1.default.readCacheLicense(s)}catch(e){throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)})}var{i:t,l:i,m:a}=e;if(t!==utils_1.default.getMID())throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});t=utils_1.default.convertToPublicDecrypt(s,i,a);if(Math.round((new Date).getTime()/1e3)>t.grant_e_time)throw utils_1.default.newError({status:utils_1.code.license_expired,message:utils_1.default.getMessage(utils_1.code.license_expired)});(0,electron_base_ipc_1.broadcast)("license:pass");i={status:utils_1.code.ok,message:utils_1.default.getMessage(utils_1.code.ok),data:t};return this.licenses.set(s,i),i}}async getLicenseInOnline(e){var{cocos_uid:s,session_id:t}=await user.getData(),{pluginName:e,licenseName:i,client_type:a,enableCompanyMember:n}=e;let r=i||e,l="";l=r?`COCOS_UID::${s}::`+r:(r="Creator","COCOS_UID::"+s);s=new URL("api/account/get_license","https://creator-api.cocos.com").toString(),t={session_id:t,client_type:a||1,terminal_id:md5(l)},e&&(t.plugin_name=e),i&&(t.license_name=i),a=await Editor.Network.post(s,t);let o;try{o=JSON.parse(a.toString())}catch(e){throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)})}e=o&&o.data;if(e&&0!==o.status)throw utils_1.default.newError({status:e.status,message:e.msg});if(n&&0===e.company_member)throw utils_1.default.newError({status:utils_1.code.not_add,message:utils_1.default.getMessage(utils_1.code.not_add)});if(!e.license)throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});i=utils_1.default.convertToPublicDecrypt(r,e.license,e.license_mark);if(i.terminal_info!==l)throw utils_1.default.newError({status:utils_1.code.no_permission,message:utils_1.default.getMessage(utils_1.code.no_permission)});if(Math.round((new Date).getTime()/1e3)>i.grant_e_time)throw utils_1.default.newError({status:utils_1.code.license_expired,message:utils_1.default.getMessage(utils_1.code.license_expired)});utils_1.default.saveCacheLicense(r,e),(0,electron_base_ipc_1.broadcast)("license:pass");s={status:utils_1.code.ok,message:utils_1.default.getMessage(utils_1.code.ok),data:i};return this.licenses.set(r,s),s}async queryLicenseByPluginName(e,s=!1){var t=await Editor.Network.__protected__.testConnectServer();return this.licenses.delete(e),t?this.getLicenseInOnline({pluginName:e,enableCompanyMember:s}):this.getLicenseInOffline({pluginName:e})}async queryLicenseByName(e){var s=await Editor.Network.__protected__.testConnectServer();return this.licenses.delete(e),s?this.getLicenseInOnline({licenseName:e,enableCompanyMember:!0}):this.getLicenseInOffline({licenseName:e})}}exports.default=LicenseManager,exports.licenseManager=new LicenseManager;