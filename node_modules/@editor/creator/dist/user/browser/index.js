"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,r){return new(t||(t=Promise))(function(s,n){function o(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var i;e.done?s(e.value):(i=e.value,i instanceof t?i:new t(function(e){e(i)})).then(o,a)}l((r=r.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),index_1=require("../../menu/browser/index"),Profile=require("@base/electron-profile"),ipc=require("@base/electron-base-ipc"),flag="editor-lib-user",user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user");if(!process.send){const e=Profile.load("global://editor/user.json"),i=require("@editor/user"),t=e.get();i.setData(t),i.on("info-update",()=>__awaiter(void 0,void 0,void 0,function*(){const t=yield i.getData();e.set("session_id",t.session_id),e.set("session_key",t.session_key),e.set("cocos_uid",t.cocos_uid),e.set("email",t.email),e.set("nickname",t.nickname),e.save()}))}user.on("login",()=>{User.emit("login"),ipc.broadcast(`${flag}:emit`,"login")}),user.on("logout",()=>{User.emit("logout"),ipc.broadcast(`${flag}:emit`,"logout"),(0,index_1.remove)("i18n:menu.develop",{label:"i18n:menu.logout"}),(0,index_1.apply)()});class UserManager extends EventEmitter{constructor(){super(...arguments),this._initCallback=null,this._skip=!1}init(){return new Promise(e=>{void 0!==this._initCallback?(ipc.broadcast(`${flag}:init`),this._initCallback=e):e()})}nextInit(){this._initCallback&&this._initCallback(),this._initCallback=void 0}skip(){this._skip=!0,ipc.broadcast(`${flag}:hideMask`),this.emit("skip"),ipc.broadcast(`${flag}:emit`,"skip"),(0,index_1.apply)()}showMask(){ipc.broadcast(`${flag}:showMask`)}hideMask(){ipc.broadcast(`${flag}:hideMask`)}getData(){return __awaiter(this,void 0,void 0,function*(){return user.getData()})}isLoggedIn(){return __awaiter(this,void 0,void 0,function*(){return!0!==this._skip&&user.isLoggedIn()})}login(e,i){return __awaiter(this,void 0,void 0,function*(){return this._skip=!1,user.login(e,i)})}logout(){return __awaiter(this,void 0,void 0,function*(){return user.logout()})}getUserToken(){return __awaiter(this,void 0,void 0,function*(){return user.getUserToken()})}getSessionCode(e){return __awaiter(this,void 0,void 0,function*(){return yield user.getSessionCode(e)})}}const User=module.exports=new UserManager;ipc.on(`${flag}:call`,(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){const r=User[i];let s;try{s=yield r.call(User,...t)}catch(i){return void e.reply(i,null)}e.reply(null,s)})),ipc.on(`${flag}:check-skip-init`,(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){return e.reply(null,User._skip),User._skip}));