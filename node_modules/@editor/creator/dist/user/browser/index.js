"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,r){return new(t||(t=Promise))(function(n,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t(function(e){e(i)})).then(s,a)}u((r=r.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const license_1=require("../protected/license"),{EventEmitter:EventEmitter}=require("events"),menu_1=require("../../menu"),Profile=require("@base/electron-profile"),ipc=require("@base/electron-base-ipc"),flag="editor-lib-user",flag_protected="editor-lib-user-protected",user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user");if(!process.send){const e=Profile.load("global://editor/user.json"),i=require("@editor/user"),t=e.get();i.setData(t),i.on("info-update",()=>__awaiter(void 0,void 0,void 0,function*(){const t=yield i.getData();e.set("session_id",t.session_id),e.set("session_key",t.session_key),e.set("cocos_uid",t.cocos_uid),e.set("email",t.email),e.set("nickname",t.nickname),e.save()}))}user.on("login",()=>{User.emit("login"),ipc.broadcast(`${flag}:emit`,"login")}),user.on("logout",()=>{User.emit("logout"),ipc.broadcast(`${flag}:emit`,"logout"),menu_1.Menu.__protected__.remove("i18n:menu.develop",{label:"i18n:menu.logout"}),menu_1.Menu.__protected__.apply()});class UserManager extends EventEmitter{constructor(){super(...arguments),this._initCallback=null,this._skip=!1}init(){return new Promise(e=>{void 0!==this._initCallback?(ipc.broadcast(`${flag}:init`),this._initCallback=e):e()})}nextInit(){this._initCallback&&this._initCallback(),this._initCallback=void 0}skip(){this._skip=!0,ipc.broadcast(`${flag}:hideMask`),this.emit("skip"),ipc.broadcast(`${flag}:emit`,"skip"),menu_1.Menu.__protected__.apply()}showMask(){ipc.broadcast(`${flag}:showMask`)}hideMask(){ipc.broadcast(`${flag}:hideMask`)}getData(){return __awaiter(this,void 0,void 0,function*(){return user.getData()})}isLoggedIn(){return __awaiter(this,void 0,void 0,function*(){if(!0===this._skip)return!1;try{return yield user.isLoggedIn()}catch(e){return!1}})}login(e,i){return __awaiter(this,void 0,void 0,function*(){return this._skip=!1,user.login(e,i)})}logout(){return __awaiter(this,void 0,void 0,function*(){return user.logout()})}getUserToken(){return __awaiter(this,void 0,void 0,function*(){return user.getUserToken()})}getSessionCode(e){return __awaiter(this,void 0,void 0,function*(){return yield user.getSessionCode(e)})}get __protected__(){return{queryLicenseByPluginName(e){return __awaiter(this,void 0,void 0,function*(){return license_1.licenseManager.queryLicenseByPluginName(e)})},queryLicenseByName(e){return __awaiter(this,void 0,void 0,function*(){return license_1.licenseManager.queryLicenseByName(e)})}}}}const User=module.exports=new UserManager;ipc.on(`${flag_protected}:call`,(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){const r=User.__protected__[i];let n;try{n=yield r.call(User,...t)}catch(i){return void e.reply(i,null)}e.reply(null,n)})),ipc.on(`${flag}:call`,(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){const r=User[i];let n;try{n=yield r.call(User,...t)}catch(i){return void e.reply(i,null)}e.reply(null,n)})),ipc.on(`${flag}:check-skip-init`,(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){return e.reply(null,User._skip),User._skip}));