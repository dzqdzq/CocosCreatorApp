"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,n){return new(t||(t=Promise))(function(s,o){function r(e){try{h(n.next(e))}catch(e){o(e)}}function a(e){try{h(n.throw(e))}catch(e){o(e)}}function h(e){var i;e.done?s(e.value):(i=e.value,i instanceof t?i:new t(function(e){e(i)})).then(r,a)}h((n=n.apply(e,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),path_1=require("path"),events_1=require("events"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),kitHTML=(0,path_1.join)(__dirname,"../../../../static/windows/kit.html");class KitControl extends events_1.EventEmitter{constructor(){super(),this._registedPanels=new Set,this.window=null,this.parentWindow=null,this.name="",this.options=null,this.isHold=!1,this.timer=null,this.__hide=(()=>{this.isHold=!1,clearTimeout(this.timer),this.window.hide()})}getOptionsCache(){return this.options}init(){return __awaiter(this,void 0,void 0,function*(){return this.window=new electron_1.BrowserWindow({x:0,y:0,width:100,height:100,show:!1,autoHideMenuBar:!0,frame:!1,resizable:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1},fullscreenable:!1}),this.window.loadFile(kitHTML),this.window.addListener("blur",()=>{clearTimeout(this.timer),this.timer=setTimeout(()=>{this.isHold||this.hide()},100)}),this.window.setAlwaysOnTop(!0),this.window.addListener("focus",()=>{clearTimeout(this.timer)}),new Promise(e=>{this.window.once("ready-to-show",e)})})}register(e){const i=panel.queryInfo(e);i?(this._registedPanels.add(i.name),this._preload(i.name)):console.error(`Panel ${e} is not exist.`)}_preload(e){ipc.sendToWin(this.window,"editor-lib-panel:register-kit-panel",e)}unregister(e){return __awaiter(this,void 0,void 0,function*(){if(!e||!this._registedPanels.has(e))return;this._registedPanels.delete(e),this.name===e&&(yield this.hide(),this.name="");const i=panel.queryInfo(e);i?ipc.sendToWin(this.window,"editor-lib-panel:unregister-kit-panel",i.name):console.error(`Panel ${e} is not exist.`)})}open(e,i){if(!e||!i||!this.window)return void console.error("Invalid argument");if(!this._registedPanels.has(e.name))return void console.error(`Please register the kit panel(${e.name}) first!`);panel.queryInfo(e.name)?(clearTimeout(this.timer),i.removeListener("close",this.__hide),this.options=e,this.name=e.name,this.parentWindow=i,this.window.setParentWindow(this.parentWindow),this.parentWindow.on("close",this.__hide),this.transform(),this._show(),this.transform(),this.window.setParentWindow(null),panel.exec(this.name,"reset")):console.error(`Panel ${e.name} is not exist.`)}show(e){}_show(){this.window&&this.name&&(this._preload(this.name),this.window.show(),ipc.sendToWin(this.window,"editor-lib-panel:open-kit-panel",this.name),this.window.focus())}transform(){if(!this.window)return!1;const e=panel.queryInfo(this.name),i=0|e.userData.size.width,t=0|e.userData.size.height;this.window.setContentSize(i,t);const{x:n,y:s,screen:o}=this.options,r=this.parentWindow.getContentBounds();let a=r.x+n,h=r.y+s;return a<o.x&&(a=o.x),a+i>o.x+o.width&&(a=o.x+o.width-i),h<o.y&&(h=o.y),h+t>o.y+o.height&&(h=o.y+o.height-t),a|=0,h|=0,this.window.setPosition(a,h),!0}hide(){return __awaiter(this,void 0,void 0,function*(){this.name&&(this.window.isDestroyed()?yield this.init():(ipc.sendToWin(this.window,"editor-lib-panel:hide-kit-panel",this.name),yield panel.exec(this.name,"clear"),this.isHold=!1,this.removeAllListeners(),this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:hide"),clearTimeout(this.timer),this.timer=setTimeout(()=>{clearTimeout(this.timer),this.window.hide(),this.parentWindow.removeListener("close",this.__hide),this.parentWindow.focus()},50)))})}hold(){this.isHold=!0,this.window.setAlwaysOnTop(!1)}emit(e,i,...t){return this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:emit",e,i,...t),!0}}const control=new KitControl;exports.default=control,ipc.on("editor-lib-panel-kit:call",(e,i,...t)=>__awaiter(void 0,void 0,void 0,function*(){if(!control[i])return;let n=null;if("open"===i){const s=electron_1.BrowserWindow.fromWebContents(e.sender);n=yield control[i](...t,s)}else n=yield control[i](...t);e.reply(null,n)}));