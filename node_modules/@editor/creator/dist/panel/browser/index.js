"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),metrics_1=require("../../metrics"),electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),win=require("@base/electron-windows"),panel=require("@editor/panel"),kitControl=require("./kit-control"),subHTML=ps.join(__dirname,"../../../static/windows/sub.html"),simpleHTML=ps.join(__dirname,"../../../static/windows/simple.html");class Panel{constructor(){electron_1.app.isReady()?kitControl.init():electron_1.app.once("ready",()=>{kitControl.init()}),this.waitPanels=[],this._kitControl=kitControl}open(e,...t){return __awaiter(this,void 0,void 0,function*(){const n=panel.queryInfo(e);if(!n)return console.warn(`Panel(${e}) is not defined.`),!1;if("kit"===n.userData.type)return kitControl.show(n.name),!1;const i=n.userData&&n.userData.flags&&n.userData.flags.multiple;try{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`A100000_${e}`,value:1})}catch(e){}if(!i){if(this.waitPanels.includes(e))return console.warn(`A panel(${e}) is currently open. Please try again later.`),!1;if(panel.focus(e)){const t=panel.getWindow(e)||[];if(t.length>0)return!1;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return!!n&&(n.show(),!0)}}n.args=t||[],this.waitPanels.push(e);try{if("simple"===n.userData.type){const t=n.userData||{},i={webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},o=t.size||{};i.width=o.width||300,i.height=o.height||300,i.autoHideMenuBar=!0,i.minWidth=o["min-width"]||200,i.minHeight=o["min-height"]||200,t.flags&&(i.resizable=t.flags.resizable),win.open(simpleHTML,i,{panel:e})}else{const t=(n.userData||{}).size||{};win.open(subHTML,{width:t.width||300,height:t.height||300,autoHideMenuBar:!0,menuBarVisibility:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},{layout:{version:1,"min-width":t["min-width"]||200,"min-height":t["min-height"]||200,layout:{percent:1,panels:[e]}}})}yield new Promise(t=>{const n=setTimeout(()=>{panel.removeListener("ready",i),t()},5e3);function i(o){o===e&&(clearTimeout(n),panel.removeListener("ready",i),t())}panel.on("ready",i)})}catch(e){console.error(e)}const o=this.waitPanels.indexOf(e);return-1!==o&&this.waitPanels.splice(o,1),!0})}close(e){return __awaiter(this,void 0,void 0,function*(){const t=panel.getWindow(e)||[];if(0===t.length)return!0;const n=t.map(t=>{const n=electron_1.BrowserWindow.fromId(t);return ipc.sendToWin(n,"editor-lib-panel:close",e)});return(yield Promise.all(n)).every(Boolean)})}focus(e){return __awaiter(this,void 0,void 0,function*(){if(!panel.queryInfo(e))return console.warn(`Panel(${e}) is not defined.`),!1;if(panel.focus(e)){const t=panel.getWindow(e)||[];if(t.length>0)return!1;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return!!n&&(n.show(),!0)}return!1})}has(e){return __awaiter(this,void 0,void 0,function*(){const t=panel.getWindow(e);return!!(t&&t.length>0)})}_openDevTools(e){const t=this._getBrowserWindow(e);t&&t.webContents.openDevTools()}_getBrowserWindow(e){const t=panel.getWindow(e)||[];if(!t.length)return null;const n=electron_1.BrowserWindow.fromId(t[t.length-1]);return n||null}}module.exports=new Panel,ipc.on("editor-lib-panel:call",(e,t,...n)=>__awaiter(void 0,void 0,void 0,function*(){const i=module.exports[t];if(!i)return;const o=yield i.call(module.exports,...n);e.reply(null,o)}));const UsageTimeMap=new Map;panel.on("focus",e=>{UsageTimeMap.set(e,Date.now())}),panel.on("blur",e=>{if(UsageTimeMap.has(e)){const t=UsageTimeMap.get(e),n=Date.now();metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${e}`,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e)}}),panel.on("pause",e=>{if(UsageTimeMap.has(e)){const t=UsageTimeMap.get(e),n=Date.now();metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${e}`,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e)}}),panel.on("resume",e=>{UsageTimeMap.set(e,Date.now())}),setInterval(()=>{const e=Date.now();UsageTimeMap.forEach((t,n)=>{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:`B100001_${n}`,value:((e-t)/1e3/60*100|0)/100}),UsageTimeMap.set(n,e)})},6e4);