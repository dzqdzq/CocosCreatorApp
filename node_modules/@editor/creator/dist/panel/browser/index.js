"use strict";var __awaiter=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))(function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(s,a)}l((i=i.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),win=require("@base/electron-windows"),panel=require("@editor/panel"),kitControl=require("./kit-control"),subHTML=ps.join(__dirname,"../../../static/windows/sub.html"),simpleHTML=ps.join(__dirname,"../../../static/windows/simple.html");class Panel{constructor(){electron_1.app.isReady()?kitControl.init():electron_1.app.once("ready",()=>{kitControl.init()}),this.waitPanels=[],this._kitControl=kitControl}open(e,...n){return __awaiter(this,void 0,void 0,function*(){const t=panel.queryInfo(e);if(!t)return console.warn(`Panel(${e}) is not defined.`),!1;if("kit"===t.userData.type)return kitControl.show(t.name),!1;if(!(t.userData&&t.userData.flags&&t.userData.flags.multiple)){if(this.waitPanels.includes(e))return console.warn(`A panel(${e}) is currently open. Please try again later.`),!1;if(panel.focus(e)){const n=panel.getWindow(e)||[];if(n.length>0)return!1;const t=electron_1.BrowserWindow.fromId(n[n.length-1]);return!!t&&(t.show(),!0)}}t.args=n||[],this.waitPanels.push(e);try{if("simple"===t.userData.type){const n=t.userData||{},i={webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},o=n.size||{};i.width=o.width||300,i.height=o.height||300,i.autoHideMenuBar=!0,i.minWidth=o["min-width"]||200,i.minHeight=o["min-height"]||200,n.flags&&(i.resizable=n.flags.resizable),win.open(simpleHTML,i,{panel:e})}else{const n=(t.userData||{}).size||{};win.open(subHTML,{width:n.width||300,height:n.height||300,autoHideMenuBar:!0,menuBarVisibility:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},{layout:{version:1,"min-width":n["min-width"]||200,"min-height":n["min-height"]||200,layout:{percent:1,panels:[e]}}})}yield new Promise(n=>{const t=setTimeout(()=>{panel.removeListener("ready",i),n()},5e3);function i(o){o===e&&(clearTimeout(t),panel.removeListener("ready",i),n())}panel.on("ready",i)})}catch(e){console.error(e)}const i=this.waitPanels.indexOf(e);return-1!==i&&this.waitPanels.splice(i,1),!0})}close(e){return __awaiter(this,void 0,void 0,function*(){const n=panel.getWindow(e)||[];if(0===n.length)return!0;const t=n.map(n=>{const t=electron_1.BrowserWindow.fromId(n);return ipc.sendToWin(t,"editor-lib-panel:close",e)});return(yield Promise.all(t)).every(Boolean)})}focus(e){return __awaiter(this,void 0,void 0,function*(){if(!panel.queryInfo(e))return console.warn(`Panel(${e}) is not defined.`),!1;if(panel.focus(e)){const n=panel.getWindow(e)||[];if(n.length>0)return!1;const t=electron_1.BrowserWindow.fromId(n[n.length-1]);return!!t&&(t.show(),!0)}return!1})}has(e){return __awaiter(this,void 0,void 0,function*(){const n=panel.getWindow(e);return!!(n&&n.length>0)})}_openDevTools(e){const n=this._getBrowserWindow(e);n&&n.webContents.openDevTools()}_getBrowserWindow(e){const n=panel.getWindow(e)||[];if(!n.length)return null;const t=electron_1.BrowserWindow.fromId(n[n.length-1]);return t||null}}module.exports=new Panel,ipc.on("editor-lib-panel:call",(e,n,...t)=>__awaiter(void 0,void 0,void 0,function*(){const i=module.exports[n];if(!i)return;const o=yield i.call(module.exports,...t);e.reply(null,o)}));