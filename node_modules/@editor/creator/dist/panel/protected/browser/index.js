"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports._openDevTools=exports.has=exports.focus=exports.close=exports.openBeside=exports.open=exports.preloadKit=exports.closeKit=exports.holdKit=exports.openKit=void 0;const metrics_1=require("../../../metrics"),electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),panel=require("@editor/panel"),kit_1=require("./kit"),waitPanels=[];function openKit(e,t){console.warn("The kit panel needs to be opened from a window.")}function holdKit(){(0,kit_1.setKitHoldFlag)(!0)}function closeKit(e){(0,kit_1.hide)()}function preloadKit(){(0,kit_1.preload)()}async function open(i,...e){var t=panel.queryInfo(i);if(!t)return console.warn(`Panel(${i}) is not defined.`),!1;if("kit"===t.userData.type)return!1;var n=t.userData&&t.userData.flags&&t.userData.flags.multiple;try{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:"A100000_"+i,value:1})}catch(e){}if(!n){if(waitPanels.includes(i))return console.warn(`A panel(${i}) is currently open. Please try again later.`),!1;if(panel.focus(i))return!(0<(n=panel.getWindow(i)||[]).length||!(n=electron_1.BrowserWindow.fromId(n[n.length-1]))||(n.show(),0))}t.args=e||[],waitPanels.push(i);try{var o=(t.userData||{}).size||{};o.width||(o.width=o["min-width"]||200),o.height||(o.height=o["min-height"]||200),"simple"===t.userData.type?Editor.Windows.__protected__.openSimpleWindow(o,{panel:i}):Editor.Windows.__protected__.openSubWindow(o,{layout:{version:1,"min-width":o["min-width"]||200,"min-height":o["min-height"]||200,layout:{percent:1,panels:[i]}}}),await new Promise(t=>{const n=setTimeout(()=>{panel.removeListener("ready",o),t()},5e3);function o(e){e===i&&(clearTimeout(n),panel.removeListener("ready",o),t())}panel.on("ready",o)})}catch(e){console.error(e);const r=waitPanels.indexOf(i);return-1!==r&&waitPanels.splice(r,1),!1}const r=waitPanels.indexOf(i);return-1!==r&&waitPanels.splice(r,1),!0}async function openBeside(e,i,...t){var n=panel.queryInfo(i);if(!n)return console.warn(`Panel(${i}) is not defined.`),!1;if("kit"===n.userData.type)return!1;var o=n.userData&&n.userData.flags&&n.userData.flags.multiple;try{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:"A100000_"+i,value:1})}catch(e){}if("simple"===n.userData.type)return console.log(`Simple type panel${i} cannot be mounted in windows`),!1;if(!o){if(waitPanels.includes(i))return console.warn(`A panel(${i}) is currently open. Please try again later.`),!1;if(panel.focus(i))return!(0<(o=panel.getWindow(i)||[]).length||!(o=electron_1.BrowserWindow.fromId(o[o.length-1]))||(o.show(),0))}n.args=t||[],waitPanels.push(i);try{var r=(n.userData||{}).size||{},a=(r.width||(r.width=r["min-width"]||200),r.height||(r.height=r["min-height"]||200),panel.getWindow(e));ipc.sendToWin(electron_1.BrowserWindow.fromId(a[0]),"editor-lib-panel:open-beside",e,i),await new Promise(t=>{const n=setTimeout(()=>{panel.removeListener("ready",o),t()},5e3);function o(e){e===i&&(clearTimeout(n),panel.removeListener("ready",o),t())}panel.on("ready",o)})}catch(e){console.error(e);const s=waitPanels.indexOf(i);return-1!==s&&waitPanels.splice(s,1),!1}const s=waitPanels.indexOf(i);return-1!==s&&waitPanels.splice(s,1),!0}async function close(t){var e=panel.getWindow(t)||[];return 0===e.length||(e=e.map(e=>{e=electron_1.BrowserWindow.fromId(e);return ipc.sendToWin(e,"editor-lib-panel:close",t)}),(await Promise.all(e)).every(Boolean))}async function focus(e){var t;return panel.queryInfo(e)?!!panel.focus(e)&&!(0<(t=panel.getWindow(e)||[]).length||!(t=electron_1.BrowserWindow.fromId(t[t.length-1]))||(t.show(),0)):(console.warn(`Panel(${e}) is not defined.`),!1)}async function has(e){e=panel.getWindow(e);return!!(e&&0<e.length)}function _openDevTools(e){e=_getBrowserWindow(e);e&&e.webContents.openDevTools()}function _getBrowserWindow(e){e=panel.getWindow(e)||[];return e.length&&electron_1.BrowserWindow.fromId(e[e.length-1])||null}exports.openKit=openKit,exports.holdKit=holdKit,exports.closeKit=closeKit,exports.preloadKit=preloadKit,exports.open=open,exports.openBeside=openBeside,exports.close=close,exports.focus=focus,exports.has=has,exports._openDevTools=_openDevTools,ipc.on("editor-lib-panel:call",async(e,t,...n)=>{var t=exports[t];t&&(t=await t.call(exports,...n),e.reply(null,t))});const UsageTimeMap=new Map;panel.on("focus",e=>{UsageTimeMap.set(e,Date.now())}),panel.on("blur",e=>{var t,n;UsageTimeMap.has(e)&&(t=UsageTimeMap.get(e),n=Date.now(),metrics_1.Metrics._trackEventWithTimer({category:"extension",id:"B100001_"+e,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e))}),panel.on("pause",e=>{var t,n;UsageTimeMap.has(e)&&(t=UsageTimeMap.get(e),n=Date.now(),metrics_1.Metrics._trackEventWithTimer({category:"extension",id:"B100001_"+e,value:((n-t)/1e3/60*100|0)/100}),UsageTimeMap.delete(e))}),panel.on("resume",e=>{UsageTimeMap.set(e,Date.now())}),setInterval(()=>{const n=Date.now();UsageTimeMap.forEach((e,t)=>{metrics_1.Metrics._trackEventWithTimer({category:"extension",id:"B100001_"+t,value:((n-e)/1e3/60*100|0)/100}),UsageTimeMap.set(t,n)})},6e4);