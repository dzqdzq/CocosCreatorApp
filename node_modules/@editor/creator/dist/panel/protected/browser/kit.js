"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unregister=exports.register=exports.hide=exports.show=exports.transform=exports.open=exports.destroy=exports.preload=exports.init=exports.getBlurTimeout=exports.setBlurTimeout=exports.setKitHoldFlag=void 0;const panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),electron_1=require("electron"),path_1=require("path"),kitHTML=(0,path_1.join)(__dirname,"../../../../static/windows/kit.html"),main_1=require("@electron/remote/main");let holdKitFlag=!1;function setKitHoldFlag(e){holdKitFlag=e}exports.setKitHoldFlag=setKitHoldFlag;let currentParentWindow=null,closeTimer,win=null,blurTimeout=100,blurTimer=null;function setBlurTimeout(e){blurTimeout=e}function getBlurTimeout(){return blurTimeout}async function init(){if(!win||win.isDestroyed())return(win=new electron_1.BrowserWindow({x:0,y:0,width:100,height:100,show:!1,autoHideMenuBar:!0,frame:!1,resizable:!1,skipTaskbar:!0,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1},fullscreenable:!1})).loadFile(kitHTML),(0,main_1.enable)(win.webContents),win.addListener("blur",()=>{clearTimeout(blurTimer),clearTimeout(closeTimer),blurTimer=setTimeout(()=>{holdKitFlag?holdKitFlag=!1:hide()},blurTimeout)}),win.addListener("focus",()=>{clearTimeout(blurTimer),clearTimeout(closeTimer)}),new Promise(e=>{win.once("ready-to-show",e)})}async function preload(){win&&!win.isDestroyed()||await init()}async function destroy(){win&&(win.destroy(),win=null)}async function open(e,i,t){var n;win&&!win.isDestroyed()||await init(),e&&i&&t?(n=panel.queryInfo(e))?(currentParentWindow=t,clearTimeout(blurTimer),clearTimeout(closeTimer),win.setAlwaysOnTop(!0),win.setParentWindow(t),transform({x:i.position.x,y:i.position.y,width:n.userData.size.width,height:n.userData.size.height},i.screen,t),show(),ipc.sendToWin(win,"editor-lib-panel:open-kit-panel",e,i),transform({x:i.position.x,y:i.position.y,width:n.userData.size.width,height:n.userData.size.height},i.screen,t),win.setParentWindow(null),win.setAlwaysOnTop(!1)):console.error(`Panel ${e} is not exist.`):console.error("Invalid argument")}async function transform(t,n,r){if(win&&!win.isDestroyed()&&t.width&&t.height){var o=0|t.width,s=0|t.height,r=(win.setContentSize(o,s),r.getContentBounds());let e=r.x+t.x,i=r.y+t.y;return(e=e<n.x?n.x:e)+o>n.x+n.width&&(e=n.x+n.width-o),(i=i<n.y?n.y:i)+s>n.y+n.height&&(i=n.y+n.height-s),e|=0,i|=0,win.setPosition(e,i),!0}}async function show(){win&&!win.isDestroyed()&&(clearTimeout(blurTimer),clearTimeout(closeTimer),win.show())}async function hide(){win&&!win.isDestroyed()&&(ipc.sendToWin(win,"editor-lib-panel:hide-kit-panel"),win.hide(),closeTimer=setTimeout(()=>{clearTimeout(closeTimer),currentParentWindow&&!currentParentWindow.isDestroyed()&&currentParentWindow.focus()},50))}async function register(e){ipc.sendToWin(win,"editor-lib-panel:register-kit-panel",e)}async function unregister(e){ipc.sendToWin(win,"editor-lib-panel:unregister-kit-panel",e)}exports.setBlurTimeout=setBlurTimeout,exports.getBlurTimeout=getBlurTimeout,exports.init=init,exports.preload=preload,exports.destroy=destroy,exports.open=open,exports.transform=transform,exports.show=show,exports.hide=hide,exports.register=register,exports.unregister=unregister,ipc.on("editor-lib-panel:open-kit",async(e,i,t)=>{var n=electron_1.BrowserWindow.fromWebContents(e.sender),i=await open(i,{webContentID:n.webContents.id,...t},n);e.reply(null,i)});