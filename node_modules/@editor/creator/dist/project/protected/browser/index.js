"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.add=exports.open=exports.create=exports.init=exports.getLastEditorVersion=exports.tmpDir=exports.name=exports.uuid=exports.path=exports.type=void 0;const fs_extra_1=require("fs-extra"),node_uuid_1=require("node-uuid"),path_1=require("path"),setting=require("@editor/setting"),ipc=require("@base/electron-base-ipc"),project=require("@editor/project"),configFile=(0,path_1.join)(setting.PATH.HOME,"editor/project.json");function save(){var e=project.dump();(0,fs_extra_1.outputJSONSync)(configFile,e,{spaces:2}),ipc.broadcast("editor3d-lib-project:update")}function checkProjectJson(r){return r.projects&&r.projects.forEach((e,t)=>{(0,fs_extra_1.existsSync)(e.path)||r.projects.splice(t,1)}),r}(()=>{if((0,fs_extra_1.existsSync)(configFile)){let t;try{t=(0,fs_extra_1.readJSONSync)(configFile)}catch(e){console.error(e),t={}}t=checkProjectJson(t),(0,fs_extra_1.outputJSONSync)(configFile,t),project.init(t)}})(),project.on("add",save).on("remove",save).on("open",save),exports.type="3d",exports.path="",exports.uuid="",exports.name="",exports.tmpDir="";let lastEditorVersion=null;async function getLastEditorVersion(){return lastEditorVersion}async function init(){if(setting.PATH.PROJECT){var t=(0,path_1.join)(setting.PATH.PROJECT,"package.json"),r=("darwin"===process.platform&&Editor.App.path.startsWith("/private")&&(await Editor.Dialog.error(Editor.I18n.t("project.macSandbox")),process.exit(1)),(0,fs_extra_1.existsSync)(setting.PATH.PROJECT)&&(0,fs_extra_1.existsSync)(t)||(await Editor.Dialog.error(Editor.I18n.t("project.notExists")),process.exit(1)),(0,fs_extra_1.readJSONSync)(t));let e=!1;lastEditorVersion=r.creator?.version||r.version,r.creator=r.creator||{},r.creator.version!==Editor.App.version&&(r.creator.version=Editor.App.version,e=!0),r.uuid||(e=!0,r.uuid=(0,node_uuid_1.v4)()),e&&(0,fs_extra_1.outputJSONSync)(t,r,{spaces:2}),exports.path=(0,path_1.normalize)(setting.PATH.PROJECT),exports.uuid=r.uuid,exports.name=r.name||"",exports.tmpDir=(0,path_1.join)(exports.path,"temp"),(0,fs_extra_1.ensureDirSync)(exports.tmpDir)}}function create(){process.send?process.send({channel:"show-dashboard",options:{host:"creator-project"}}):Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]})}function open(e){process.send?process.send({channel:"open-project",options:{path:e,tab:0,type:"3d"}}):Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]})}function add(e){project.add(e)}exports.getLastEditorVersion=getLastEditorVersion,project.setOpenHandler(e=>{if(!process.send)return Editor.Dialog.error("Project warnning",{detail:Editor.I18n.t("menu.dashboard_missing"),default:0,cancel:0,buttons:["Cancel"]});process.send({channel:"open-project",path:e})}),exports.init=init,exports.create=create,exports.open=open,exports.add=add,ipc.on("editor3d-lib-project:call",async(e,t,...r)=>{t=await module.exports[t](...r);return e.reply(null,t),t}),ipc.on("editor3d-lib-project:get",(e,t)=>module.exports[t]);