"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.trackProcessMemoryEnd=exports.trackProcessMemoryStart=exports._trackCrashEvent=exports._sendEventGroup=exports._trackEventWithTimer=exports.trackTimeEnd=exports.trackTimeStart=exports.trackProcessMemory=exports.trackException=exports.trackEvent=exports.close=exports.init=exports.reset=exports.register=exports.trackAwaitHandler=exports.getTrackAwaitHandler=exports.getProcessMemoryMap=exports.getTrackTimeStartMap=exports.getTrackInfoList=exports.setMetricInitData=exports.getMetricInitData=exports.trackProcessMemoryMap=exports.trackTimeStartMap=exports.trackHandler=exports.trackInfoList=exports.metricInitData=void 0;const ipc=require("@base/electron-base-ipc");function getMetricInitData(){return exports.metricInitData}function setMetricInitData(t){exports.metricInitData=t}function getTrackInfoList(){return exports.trackInfoList}function getTrackTimeStartMap(){return exports.trackTimeStartMap}function getProcessMemoryMap(){return exports.trackProcessMemoryMap}function getTrackAwaitHandler(){return exports.trackAwaitHandler}exports.trackInfoList=[],exports.trackHandler={},exports.trackTimeStartMap=new Map,exports.trackProcessMemoryMap=new Map,exports.getMetricInitData=getMetricInitData,exports.setMetricInitData=setMetricInitData,exports.getTrackInfoList=getTrackInfoList,exports.getTrackTimeStartMap=getTrackTimeStartMap,exports.getProcessMemoryMap=getProcessMemoryMap,exports.getTrackAwaitHandler=getTrackAwaitHandler,exports.trackAwaitHandler=[];let index=0;function addTrackInfo(t,e){var r=new Date,a=r.getTime(),t={index:index,funcName:t,date:r,time:a,info:e};return index++,exports.trackInfoList.push(t),t}function executeAsyncFunc(e){var t=exports.trackAwaitHandler.findIndex(t=>t.index===e),r=exports.trackAwaitHandler[t];r&&(r.resolve(r.defaultResult),exports.trackAwaitHandler.splice(t,1))}function register(t,e){exports.trackHandler[t]=e}function reset(){index=0;for(let t=exports.trackInfoList.length=0;t<exports.trackAwaitHandler.length;t++){var e=exports.trackAwaitHandler[t];e&&e.resolve(e.defaultResult)}}async function init(t){exports.metricInitData={outputMetricLog:t};t=exports.trackHandler.init;t&&await t(),setInterval(()=>{var t=exports.trackHandler.clear;t&&t(),reset()},36e5)}async function close(){var t=exports.trackHandler.close;return!!t&&t()}function trackEvent(t){t=addTrackInfo("trackEvent",t);try{var e=exports.trackHandler.trackEvent;e&&e(t.index)}catch(t){}}function trackException(t){t=addTrackInfo("trackException",t);try{var e=exports.trackHandler.trackException;e&&e(t.index)}catch(t){}}function trackProcessMemory(t,e){t=addTrackInfo("trackProcessMemory",{process:t,memoryInfo:e});try{var r=exports.trackHandler.trackProcessMemory;r&&r(t.index)}catch(t){}}function trackTimeStart(t,e){exports.trackTimeStartMap.has(t)&&exports.trackTimeStartMap.delete(t),exports.trackTimeStartMap.set(t,e||Date.now());try{var r=exports.trackHandler.trackTimeStart;r&&r()}catch(t){}}async function trackTimeEnd(c,s={},n){return new Promise((e,t)=>{const r=addTrackInfo("trackTimeEnd",{message:c,options:s,time:n||new Date});try{var a=exports.trackHandler.trackTimeEnd;a?e(a(r.index)):(exports.trackAwaitHandler.push({index:r.index,resolve:e,reject:t,defaultResult:-1}),setTimeout(()=>{executeAsyncFunc(r.index)},5e3))}catch(t){e(-1)}})}function _trackEventWithTimer(t){t=addTrackInfo("_trackEventWithTimer",t);try{var e=exports.trackHandler._trackEventWithTimer;e&&e(t.index)}catch(t){}}function _sendEventGroup(){var t=addTrackInfo("_sendEventGroup");try{var e=exports.trackHandler._sendEventGroup;e&&e(t.index)}catch(t){}}async function _trackCrashEvent(c){return new Promise(async(t,e)=>{const r=addTrackInfo("_trackCrashEvent",c);try{var a=exports.trackHandler._trackCrashEvent;a?t(await a(r.index)):(exports.trackAwaitHandler.push({index:r.index,resolve:t,reject:e,defaultResult:null}),setTimeout(()=>{executeAsyncFunc(r.index)},5e3))}catch(t){return null}})}function trackProcessMemoryStart(t,e){try{exports.trackProcessMemoryMap.has(t)&&exports.trackProcessMemoryMap.delete(t);var r=e||process.memoryUsage(),a=(exports.trackProcessMemoryMap.set(t,r.heapUsed),exports.trackHandler.trackProcessMemoryStart);a&&a()}catch(t){}}function trackProcessMemoryEnd(c,s){return new Promise((e,t)=>{try{const a=addTrackInfo("trackProcessMemoryEnd",{message:c,memory:s});var r=exports.trackHandler.trackProcessMemoryEnd;r?r(a.index).then(e):(exports.trackAwaitHandler.push({index:a.index,resolve:e,reject:t,defaultResult:-1}),setTimeout(()=>{executeAsyncFunc(a.index)},5e3))}catch(t){e(-1)}})}exports.register=register,exports.reset=reset,exports.init=init,exports.close=close,exports.trackEvent=trackEvent,exports.trackException=trackException,exports.trackProcessMemory=trackProcessMemory,exports.trackTimeStart=trackTimeStart,exports.trackTimeEnd=trackTimeEnd,exports._trackEventWithTimer=_trackEventWithTimer,exports._sendEventGroup=_sendEventGroup,exports._trackCrashEvent=_trackCrashEvent,exports.trackProcessMemoryStart=trackProcessMemoryStart,exports.trackProcessMemoryEnd=trackProcessMemoryEnd,ipc.on("metrics:track-event",(t,e)=>{trackEvent(e)}),ipc.on("metrics:track-event-with-timer",(t,e)=>{_trackEventWithTimer(e)}),ipc.on("metrics:track-exception",(t,e)=>{trackException(e)}),ipc.on("metrics:send-event-group",t=>{_sendEventGroup()}),ipc.on("metrics:track-crash-event",async(e,t)=>{try{e.reply(null,await _trackCrashEvent(t))}catch(t){e.reply(t,null)}}),ipc.on("metrics:track-process-memory",(t,e,r)=>{trackProcessMemory(e,r)}),ipc.on("metrics:track-time-start",(t,e,r)=>{trackTimeStart(e,r)}),ipc.on("metrics:track-time-end",async(e,t,r,a)=>{try{r.output=!1;var c=await trackTimeEnd(t,r,a);return e.reply(null,c),c}catch(t){e.reply(t,null)}}),ipc.on("metrics:track-process-memory-start",async(t,e,r)=>{trackProcessMemoryStart(e,r)}),ipc.on("metrics:track-process-memory-end",async(e,t,r)=>{try{var a=await trackProcessMemoryEnd(t,r);e.reply(null,a)}catch(t){e.reply(t,-1)}});