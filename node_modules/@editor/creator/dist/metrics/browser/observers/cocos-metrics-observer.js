"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const metrics_observer_base_1=require("./metrics-observer-base"),util_1=require("../../../network/browser/util"),encrypt=require("./cocos-encrypt"),uuid=require("node-uuid");function createParam(e,t){return{appVersion:Editor.App.version,versionCode:"v1",uniqueID:t.uid,appID:"681395864",channelID:"100000",platform:"darwin"===process.platform?"Mac":"Windows",engine:"electron",userID:t.uid,resolution:t.resolution||"unknown",scaleFactor:t.scaleFactor||"1",osVersion:require("os").release(),manufacturer:"",store:"unknown",age:0,sex:0,callNumber:t.useTestServer?"demo.cocos.com":"creator.cocos.com",model:null,msgID:uuid.v4(),chargeTime:String(Date.now()/1e3|0),language:Editor.I18n.getLanguage()||"unknown"}}function sendData(e,t,n=!1){n&&console.log("receive analytics data --\x3e",t);try{(0,util_1.sendPostRequest)(e,t)}catch(e){n&&console.debug("send analytics data fail",e)}}class CocosMetricsObserver extends metrics_observer_base_1.MetricsObserverBase{constructor(){super(),this._caURL="https://logstorage.cocos.com/log/v2?"}trackEvent(e,t){t.cid?e.sendToCocosAnalyticsOnly||e.sendToNewCocosAnalyticsOnly?this.trackCocosEvent(e,t):this.trackNormalEvent(e,t):console.warn("Metrics: no valid client ID")}trackNormalEvent(e,t){const n=Object.assign({},e.opts||{});n.action=e.action,e.label&&(n.label=e.label);let o="succeed";e.opts&&e.opts.eventTag&&(o=e.opts.eventTag,delete n.eventTag);const a=createParam(e,t);a.eventID=e.category,a.eventValue=n,a.eventTag=o,e.exitTag&&(a.exitTag=e.exitTag,a.eventTag=e.exitTag),e.onlineDuration&&(a.onlineDuration=e.onlineDuration),delete e.onlineDuration,t.debug&&console.log("send analytics ---\x3e",JSON.stringify(a)),sendData(this._caURL,encodeURIComponent(encrypt.encryptPostData(JSON.stringify(a))),t.debug)}trackCocosEvent(e,t){if(e.sendToNewCocosAnalyticsOnly)return delete e.sendToCocosAnalyticsOnly,void this.trackNewCocosEvent(e,t);if(!e.eventId)return void console.error("Metrics: no valid eventId");delete e.sendToCocosAnalyticsOnly;const n=createParam(e,t);e.store&&(n.store=e.store,delete e.store),e.packageName&&(n.packageName=e.packageName,delete e.packageName);const o=e.eventId;delete e.eventId,n.eventID=o,n.eventValue=e,n.eventTag="succeed",e.onlineDuration&&(n.onlineDuration=e.onlineDuration),delete e.onlineDuration,t.debug&&console.log("send analytics ---\x3e",JSON.stringify(n)),sendData(this._caURL,encodeURIComponent(encrypt.encryptPostData(JSON.stringify(n))),t.debug)}trackNewCocosEvent(e,t){delete e.sendToNewCocosAnalyticsOnly;const n=createParam(e,t);n.eventID=e.category,n.eventValue=e.value,t.debug&&console.log("send analytics ---\x3e",JSON.stringify(n)),sendData(this._caURL,encodeURIComponent(encrypt.encryptPostData(JSON.stringify(n))),t.debug)}trackException(e,t){if(!t.cid)return void console.warn("Metrics: no valid client ID");const n=createParam({},t);n.eventID="exception",n.eventValue={code:e.code,desc:e.message},n.eventTag="succeed",sendData(this._caURL,encodeURIComponent(JSON.stringify(n)),t.debug)}sendAppInfo(e){}}module.exports=new CocosMetricsObserver;