"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))(function(s,c){function o(e){try{a(i.next(e))}catch(e){c(e)}}function n(e){try{a(i.throw(e))}catch(e){c(e)}}function a(e){var r;e.done?s(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,n)}a((i=i.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.trackTimeEnd=exports.trackTimeStart=exports.trackException=exports.trackEvent=exports.init=exports.removeAllMetricsObservers=exports.removeMetricsObserver=exports.addMetricsObserver=void 0;const electron_1=require("electron"),utils_1=require("./utils"),Logger=require("../../logger/browser/index"),setting=require("@editor/setting"),user=require("@editor/user");let _metricsObservers=[],_clientID="",_userID="",_metricsDebugMode=!1;const windows=require("@base/electron-windows");function getMainDisplay(){const{screen:e}=require("electron"),r=windows.uuids[0],t=windows.uuid2win[r];let i=null;if(t){const r=t.getBounds(),s=e.getAllDisplays();for(let e=0;e<s.length;e++){const t=s[e].bounds;if(r.x>t.x&&r.y>t.y&&r.x<t.x+t.width&&r.y<t.y+t.height){i=s[e];break}}if(!i)for(let e=0;e<s.length;e++){const t=s[e].bounds;if(r.x+r.width>t.x&&r.y>t.y&&r.x+r.width<t.x+t.width&&r.y<t.y+t.height){i=s[e];break}}}return i||(i=e.getPrimaryDisplay()),i}function addMetricsObserver(e){_metricsObservers.includes(e)||_metricsObservers.push(e)}function removeMetricsObserver(e){const r=_metricsObservers.indexOf(e);r<0||_metricsObservers.splice(r,1)}function removeAllMetricsObservers(){_metricsObservers=[]}function init(){return __awaiter(this,void 0,void 0,function*(){_clientID=yield(0,utils_1.getClientID)();const e=yield Editor.User.getData();let r;_userID=e&&e.cocos_uid?e.cocos_uid:"-1",_metricsDebugMode=yield Editor.Profile.getConfig("utils","features.analytics-debug"),addMetricsObserver(require("./observers/google-metrics-observer")),addMetricsObserver(require("./observers/cocos-metrics-observer"));try{r=getMainDisplay()}catch(e){console.debug(e),r={size:{width:0,height:0},scaleFactor:1}}const t={cid:_clientID,uid:_userID,debug:_metricsDebugMode||!1,resolution:`${r.size.width}x${r.size.height}`,scaleFactor:`${r.scaleFactor}`};_metricsObservers.forEach(e=>{e.sendAppInfo(t)})})}function trackEvent(e){if(!_userID)return;const r={cid:_clientID,uid:_userID,debug:_metricsDebugMode||!1};e.sendToCocosAnalyticsOnly||delete e.sendToCocosAnalyticsOnly,_metricsObservers.forEach(t=>{t.trackEvent(e,r)})}function trackException(e){if(!_userID)return;const r={cid:_clientID,uid:_userID,debug:_metricsDebugMode||!1};_metricsObservers.forEach(t=>{t.trackException(e,r)})}exports.addMetricsObserver=addMetricsObserver,exports.removeMetricsObserver=removeMetricsObserver,exports.removeAllMetricsObservers=removeAllMetricsObservers,exports.init=init,exports.trackEvent=trackEvent,exports.trackException=trackException;const trackTimeMap=new Map;function trackTimeStart(e){trackTimeMap.has(e)&&trackTimeMap.delete(e),trackTimeMap.set(e,Date.now())}function trackTimeEnd(e){if(!trackTimeMap.has(e))return;const r=Date.now()-trackTimeMap.get(e);trackTimeMap.delete(e),Logger.record(e+` (${r}ms)`)}exports.trackTimeStart=trackTimeStart,exports.trackTimeEnd=trackTimeEnd,electron_1.ipcMain.on("metrics:track-event",(e,r)=>{trackEvent(r)}),electron_1.ipcMain.on("metrics:track-exception",(e,r)=>{trackException(r)}),electron_1.ipcMain.on("metrics:track-time",(e,r)=>{Logger.record(r)});