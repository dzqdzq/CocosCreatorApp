"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(s,c){function o(e){try{a(r.next(e))}catch(e){c(e)}}function n(e){try{a(r.throw(e))}catch(e){c(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,n)}a((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRealTime=void 0;const utils_1=require("./utils"),path_1=require("path"),fs_extra_1=require("fs-extra"),Logger=require("../../logger/browser/index"),I18n=require("../../i18n/browser/index"),ProjectManager=require("../../project/browser/index"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),user=require("@editor/user"),windows=require("@base/electron-windows");function getMainDisplay(){const{screen:e}=require("electron"),t=windows.uuids[0],i=windows.uuid2win[t];let r=null;if(i){const t=i.getBounds(),s=e.getAllDisplays();for(let e=0;e<s.length;e++){const i=s[e].bounds;if(t.x>i.x&&t.y>i.y&&t.x<i.x+i.width&&t.y<i.y+i.height){r=s[e];break}}if(!r)for(let e=0;e<s.length;e++){const i=s[e].bounds;if(t.x+t.width>i.x&&t.y>i.y&&t.x+t.width<i.x+i.width&&t.y<i.y+i.height){r=s[e];break}}}return r||(r=e.getPrimaryDisplay()),r}class Metrics{constructor(){this._metricsObservers=[],this.trackTimeMap=new Map,this._collectLog=!1,this._clientID="",this._userID="",this._metricsDebugMode=!1,this._init=!1,this._logFile="",this._eventGroup={}}init(e){return __awaiter(this,void 0,void 0,function*(){this._collectLog=e,this._clientID=yield(0,utils_1.getClientID)();const t=yield Editor.User.getData();let i;this._userID=t&&t.cocos_uid?t.cocos_uid:"-1",this._metricsDebugMode=yield Editor.Profile.getConfig("utils","features.analytics-debug"),this.addMetricsObserver(require("./observers/google-metrics-observer")),this.addMetricsObserver(require("./observers/cocos-metrics-observer"));try{i=getMainDisplay()}catch(e){i={size:{width:0,height:0},scaleFactor:1}}const r={cid:this._clientID,uid:this._userID,debug:this._metricsDebugMode||!1,resolution:`${i.size.width}x${i.size.height}`,scaleFactor:`${i.scaleFactor}`};this._metricsObservers.forEach(e=>{e.sendAppInfo(r)});try{ProjectManager.tmpDir&&(this._logFile=(0,path_1.join)(ProjectManager.tmpDir,"metrics.log")),this._collectLog&&this._logFile&&(yield(0,fs_extra_1.outputFile)(this._logFile,`Cocos Creator v${setting.version}`+"\n"))}catch(e){console.log(e)}this._init=!0})}addMetricsObserver(e){this._metricsObservers.includes(e)||this._metricsObservers.push(e)}removeMetricsObserver(e){const t=this._metricsObservers.indexOf(e);t<0||this._metricsObservers.splice(t,1)}removeAllMetricsObservers(){this._metricsObservers=[]}trackEvent(e){if(!this._userID)return;const t={cid:this._clientID,uid:this._userID,debug:this._metricsDebugMode||!1,useTestServer:this._metricsDebugMode||!1};try{e.sendToCocosAnalyticsOnly||delete e.sendToCocosAnalyticsOnly,e.sendToNewCocosAnalyticsOnly||delete e.sendToNewCocosAnalyticsOnly}catch(e){console.error(e)}e.projectID=Editor.Project.uuid||"";try{this._metricsObservers.forEach(i=>{i.trackEvent(e,t)}),this._collectToFile("[trackEvent]",JSON.stringify(e))}catch(e){console.debug(e)}}_trackEventWithTimer(e){if(e)try{if(this._collectToFile("[trackEventWithTimmer]",JSON.stringify(e)),"number"!=typeof e.value)return void console.warn("trackEventSelfIncrement only support value with type of number.");this._eventGroup[e.category]||(this._eventGroup[e.category]={}),this._eventGroup[e.category][e.id]||(this._eventGroup[e.category][e.id]={}),"number"==typeof this._eventGroup[e.category][e.id]?this._eventGroup[e.category][e.id]=(100*(this._eventGroup[e.category][e.id]+e.value)|0)/100:this._eventGroup[e.category][e.id]=e.value,this._timer||(this._timer=setTimeout(()=>{clearTimeout(this._timer),this._timer=null,this._sendEventGroup()},3e5))}catch(e){console.error(e)}}trackException(e){if(!this._userID)return;const t={cid:this._clientID,uid:this._userID,debug:this._metricsDebugMode||!1};try{this._metricsObservers.forEach(i=>{i.trackException(e,t)}),this._collectToFile("[trackException]",JSON.stringify(e))}catch(e){console.debug(e)}}trackTimeStart(e,t){this.trackTimeMap.has(e)&&this.trackTimeMap.delete(e),this.trackTimeMap.set(e,t||Date.now())}trackTimeEnd(e,t={},i){if(!t.value&&!this.trackTimeMap.has(e))return void console.debug(`trackTimeEnd failed! Can not find the track time ${e} start`);const r=t.value||(i||Date.now())-this.trackTimeMap.get(e);if(this.trackTimeMap.delete(e),this._collectToFile(`[trackTime]${e}`,`${r}ms`),!t.output)return r;const s="string"==typeof t.label&&(I18n.t(t.label.replace("i18n:",""))||t.label)||e;return console.debug(s+` (${r}ms)`),r}_collectToFile(e,t){return __awaiter(this,void 0,void 0,function*(){if(this._collectLog&&this._init&&this._logFile)try{yield(0,fs_extra_1.appendFile)(this._logFile,`${getRealTime()}: ${e}:${t}`+"\n")}catch(e){console.debug(e)}})}_sendEventGroup(){if(!Object.keys(this._eventGroup).length)return;this._collectToFile("[sendCollectData]",String(Object.keys(this._eventGroup).length));const e=JSON.parse(JSON.stringify(this._eventGroup));this._eventGroup={},Object.keys(e).forEach(t=>{this.trackEvent({category:t,value:e[t],sendToNewCocosAnalyticsOnly:!0})})}_trackCrashEvent(e){return __awaiter(this,void 0,void 0,function*(){try{if(!this._userID)throw new Error("User ID invalid");const t={cid:this._clientID,uid:this._userID,debug:this._metricsDebugMode||!1,useTestServer:this._metricsDebugMode||!1};return e.projectID=Editor.Project.uuid||"",this._collectToFile("[trackEvent]",JSON.stringify(e)),yield require("./observers/cocos-metrics-observer")._trackCrashEvent(e,t)}catch(e){throw console.error(e),e}})}}const metricsManager=new Metrics;function getRealTime(){const e=new Date;return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().slice(0,8)}module.exports=metricsManager,exports.getRealTime=getRealTime,ipc.on("metrics:track-event",(e,t)=>{metricsManager.trackEvent(t)}),ipc.on("metrics:track-event-with-timer",(e,t,i)=>{metricsManager._trackEventWithTimer(t)}),ipc.on("metrics:track-exception",(e,t)=>{metricsManager.trackException(t)}),ipc.on("metrics:send-event-group",e=>{metricsManager._sendEventGroup()}),ipc.on("metrics:track-crash-event",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){try{e.reply(null,yield metricsManager._trackCrashEvent(t))}catch(t){e.reply(t,null)}})),ipc.on("metrics:track-time-start",(e,t,i)=>{metricsManager.trackTimeStart(t,i)}),ipc.on("metrics:track-time-end",(e,t,i,r)=>{try{i.output=!1;const s=metricsManager.trackTimeEnd(t,i,r);return e.reply(null,s),s}catch(t){e.reply(t,null)}});