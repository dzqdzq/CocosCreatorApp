"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.emit=exports.once=exports.on=exports.removeTemp=exports.setTemp=exports.getTemp=exports.removeProject=exports.setProject=exports.getProject=exports.removeConfig=exports.setConfig=exports.getConfig=exports.ensureProfiles=exports.profileMap=exports._registerMigration=exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=void 0;const ps=require("path"),fse=require("fs-extra"),config_1=require("../public/config"),events_1=require("events"),semver=require("semver"),profile=require("@base/electron-profile"),setting=require("@editor/setting"),packageManager=require("@editor/package"),ipc=require("@base/electron-base-ipc"),emitter=new events_1.EventEmitter;var migration_1=require("./migration");function ensureProfiles(e){return exports.profileMap[e]||(exports.profileMap[e]={defaultPreferences:profile.load(`defaultPreferences://packages/${e}.json`),global:profile.load(`global://packages/${e}.json`),local:profile.load(`local://packages/${e}.json`),defaultProject:profile.load(`defaultProject://packages/${e}.json`),project:profile.load(`project://packages/${e}.json`),temp:profile.load(`temp://packages/${e}.json`)})}async function getConfig(e,t,r){var e=ensureProfiles(e),o=!r;if("default"===(r=r||"local")){const s=e.defaultPreferences;return s.get(t)}const s=e[r];return s?s.get(t,{type:o?"deep":"current"}):null}async function setConfig(e,t,r,o="local"){"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)));e=ensureProfiles(e);if("default"===o){const s=e.defaultPreferences;void await s.set(t,r)}else{const s=e[o];s&&(await s.set(t,r),s.save())}}async function removeConfig(e,t,r){e=ensureProfiles(e);r?"default"===r?await e.defaultPreferences.remove(t):e[r]&&void 0!==await e[r].get(t)&&(await e[r].remove(t),e[r].save()):(void 0!==await e.local.get(t)&&(await e.local.remove(t),e.local.save()),void 0!==await e.global.get(t)&&(await e.global.remove(t),e.global.save()))}async function getProject(e,t,r){var e=ensureProfiles(e),o=!r;return"default"===(r=r||"project")?e.defaultProject.get(t):(e=e[r])?e.get(t,{type:o?"deep":"current"}):null}async function setProject(e,t,r,o="project"){"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)));var e=ensureProfiles(e);"default"===o?e.defaultProject.set(t,r):(e=e[o])&&(await e.set(t,r),e.save())}async function removeProject(e,t,r){e=ensureProfiles(e);r?"default"===r?await e.defaultPreferences.remove(t):e[r]&&void 0!==await e[r].get(t)&&(await e[r].remove(t),e[r].save()):void 0!==await e.project.get(t)&&(await e.project.remove(t),e.project.save())}async function getTemp(e,t){return ensureProfiles(e).temp.get(t)}async function setTemp(e,t,r){"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)));e=ensureProfiles(e);e.temp.set(t,r),e.temp.save()}async function removeTemp(e,t){e=ensureProfiles(e);e.temp.remove(t),e.temp.save()}function on(e,t){return emitter.on(e,t)}function once(e,t){return emitter.on(e,t)}function emit(e,...t){return emitter.emit(e,...t)}function removeListener(e,t){return emitter.removeListener(e,t)}function migrateFolder(e,t){if(fse.existsSync(t)){var r=fse.readdirSync(t).filter(e=>semver.valid(e)&&semver.lt(e,"3.0.1")).sort((e,t)=>semver.gt(e,t)?-1:1)[0];if(r)try{fse.copySync(ps.join(t,r),e)}catch(e){}else{try{fse.copySync(ps.join(t,"packages"),ps.join(e,"packages"))}catch(e){}try{fse.copySync(ps.join(t,"editor"),ps.join(e,"editor"))}catch(e){}}}}if(Object.defineProperty(exports,"migrateGlobal",{enumerable:!0,get:function(){return migration_1.migrateGlobal}}),Object.defineProperty(exports,"migrateLocal",{enumerable:!0,get:function(){return migration_1.migrateLocal}}),Object.defineProperty(exports,"migrateProject",{enumerable:!0,get:function(){return migration_1.migrateProject}}),Object.defineProperty(exports,"_registerMigration",{enumerable:!0,get:function(){return migration_1._registerMigration}}),exports.profileMap={},exports.ensureProfiles=ensureProfiles,exports.getConfig=getConfig,exports.setConfig=setConfig,exports.removeConfig=removeConfig,exports.getProject=getProject,exports.setProject=setProject,exports.removeProject=removeProject,exports.getTemp=getTemp,exports.setTemp=setTemp,exports.removeTemp=removeTemp,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,profile.on("change",(...e)=>{emitter.emit("change",...e)}),ps.isAbsolute(setting.PATH.HOME)){const ja=ps.join(setting.PATH.HOME,"./profiles",config_1.VERSION);if(fse.existsSync(ja))try{const ma=fse.readdirSync(ja);if(0===ma.length){fse.removeSync(ja);const na=ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles");migrateFolder(ja,na)}}catch(e){}else{const la=ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles");migrateFolder(ja,la)}const ka=ps.join(ja,"./default-profiles");fse.ensureDirSync(ka),fse.emptyDirSync(ka),profile.register("defaultPreferences",ka),fse.ensureDirSync(ja),profile.register("global",ja),profile.inherit("global","defaultPreferences")}if(ps.isAbsolute(setting.PATH.PROJECT)){const pa=ps.join(setting.PATH.PROJECT,"./profiles",config_1.VERSION);if(fse.ensureDirSync(pa),ps.isAbsolute(setting.PATH.PROJECT)){if(fse.existsSync(pa))try{const ra=fse.readdirSync(pa);if(0===ra.length){fse.removeSync(pa);const sa=ps.join(setting.PATH.PROJECT,"./profiles");migrateFolder(pa,sa)}}catch(e){}else{const qa=ps.join(setting.PATH.PROJECT,"./profiles");migrateFolder(pa,qa)}fse.ensureDirSync(pa),profile.register("local",pa),profile.inherit("local","global")}}if(ps.isAbsolute(setting.PATH.PROJECT)){const ua=ps.join(setting.PATH.PROJECT,"./settings",config_1.VERSION);if(fse.existsSync(ua))try{const xa=fse.readdirSync(ua);if(0===xa.length){fse.removeSync(ua);const ya=ps.join(setting.PATH.PROJECT,"./settings");migrateFolder(ua,ya)}}catch(e){}else{const wa=ps.join(setting.PATH.PROJECT,"./settings");migrateFolder(ua,wa)}const va=ps.join(ua,"./default-profiles");fse.ensureDirSync(va),fse.emptyDirSync(va),profile.register("defaultProject",va),fse.ensureDirSync(ua),profile.register("project",ua),profile.inherit("project","defaultProject")}if(ps.isAbsolute(setting.PATH.PROJECT)){const Aa=ps.join(setting.PATH.PROJECT,"./temp/profiles");fse.existsSync(Aa)||fse.mkdirsSync(Aa),profile.register("temp",Aa)}ipc.on("editor3d-lib-profile:call",async(t,e,...r)=>{try{var o=await module.exports[e](...r);return t.reply(null,o),o}catch(e){throw t.reply(e,null),e}});