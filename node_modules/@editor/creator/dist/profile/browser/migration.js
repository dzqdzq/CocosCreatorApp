"use strict";var __awaiter=this&&this.__awaiter||function(r,e,i,t){return new(i||(i=Promise))(function(o,n){function a(r){try{g(t.next(r))}catch(r){n(r)}}function s(r){try{g(t.throw(r))}catch(r){n(r)}}function g(r){var e;r.done?o(r.value):(e=r.value,e instanceof i?e:new i(function(r){r(e)})).then(a,s)}g((t=t.apply(r,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=exports._unregisterMigration=exports._registerMigration=void 0;const utils_1=require("../../package/utils"),index_1=require("../../module/index"),migrationsMap={},StartVerison="0.0.0";function _registerMigration(r,e){e=e.filter(r=>r.profile),migrationsMap[r]=e}function _unregisterMigration(r){migrationsMap[r]&&(migrationsMap[r].forEach(r=>{index_1.Module.removeCache(r.profile)}),delete migrationsMap[r])}function migrateGlobal(r,e,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateGlobal",r,e,i))})}function migrateLocal(r,e,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateLocal",r,e,i))})}function migrateProject(r,e,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[r]&&(yield runMigrateHandle("migrateProject",r,e,i))})}function runMigrateHandle(r,e,i,t){return __awaiter(this,void 0,void 0,function*(){let o=[];if(i===StartVerison){const r=migrationsMap[e].find(r=>r.version===StartVerison);if(!r)return;o=[r]}else o=i?migrationsMap[e].filter(r=>(0,utils_1.compareVersion)(r.version,i)>0):migrationsMap[e].filter(r=>r.version!==StartVerison);if(!o.length)return!1;for(const i of o){const o=index_1.Module.requireFile(i.profile);if(o[r])try{yield o[r](t),console.debug(`[Package] Profile ${r}: ${e}(${i.version})...`)}catch(t){console.error(t),console.error(`[Package] Profile ${r}: ${e}(${i.version}) failed!`)}}return!0})}exports._registerMigration=_registerMigration,exports._unregisterMigration=_unregisterMigration,exports.migrateGlobal=migrateGlobal,exports.migrateLocal=migrateLocal,exports.migrateProject=migrateProject;