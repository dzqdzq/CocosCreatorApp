"use strict";var __awaiter=this&&this.__awaiter||function(e,r,i,t){return new(i||(i=Promise))(function(o,n){function a(e){try{g(t.next(e))}catch(e){n(e)}}function s(e){try{g(t.throw(e))}catch(e){n(e)}}function g(e){var r;e.done?o(e.value):(r=e.value,r instanceof i?r:new i(function(e){e(r)})).then(a,s)}g((t=t.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=exports._unregisterMigration=exports._registerMigration=void 0;const utils_1=require("../../package/public/utils"),index_1=require("../../module/index"),migrationsMap={};function _registerMigration(e,r){r=r.filter(e=>e.profile),migrationsMap[e]=r}function _unregisterMigration(e){migrationsMap[e]&&(migrationsMap[e].forEach(e=>{index_1.Module.removeCache(e.profile)}),delete migrationsMap[e])}function migrateGlobal(e,r,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[e]&&(yield runMigrateHandle("migrateGlobal",e,r,i))})}function migrateLocal(e,r,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[e]&&(yield runMigrateHandle("migrateLocal",e,r,i))})}function migrateProject(e,r,i){return __awaiter(this,void 0,void 0,function*(){return!!migrationsMap[e]&&(yield runMigrateHandle("migrateProject",e,r,i))})}function runMigrateHandle(e,r,i,t){return __awaiter(this,void 0,void 0,function*(){const o=migrationsMap[r].filter(e=>i&&"0.0.0"!==i?(0,utils_1.compareVersion)(e.version,i)>0:"0.0.0"===e.version);if(!o.length)return!1;for(const i of o){const o=index_1.Module.requireFile(i.profile);if(o[e])try{yield o[e](t),console.debug(`[Package] Profile Migrated: ${r}(${i.version})`)}catch(e){console.error(e),console.error(`[Package] Profile Migrated: ${r}(${i.version}) failed!`)}}return!0})}exports._registerMigration=_registerMigration,exports._unregisterMigration=_unregisterMigration,exports.migrateGlobal=migrateGlobal,exports.migrateLocal=migrateLocal,exports.migrateProject=migrateProject;