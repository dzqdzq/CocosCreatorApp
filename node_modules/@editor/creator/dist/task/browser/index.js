"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(n,c){function a(e){try{r(i.next(e))}catch(e){c(e)}}function o(e){try{r(i.throw(e))}catch(e){c(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}r((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),ipc=require("@base/electron-base-ipc");let ID=0;class Task extends events_1.EventEmitter{constructor(){super(),this.syncTasks=[],this.syncTaskMap={},this.syncTaskTimer=null,this.noticeTasks=[],this.noticeTaskMap={}}_syncRendererMask(){const e=this.syncTasks[this.syncTasks.length-1];e?ipc.broadcast("editor-lib-task:show",e.title,e.describe,e.message):ipc.broadcast("editor-lib-task:show",null)}syncRendererMask(){null===this.syncTaskTimer&&(this._syncRendererMask(),this.syncTaskTimer=null)}addSyncTask(e,t,s){let i=this.syncTaskMap[e];i||(i={title:e,describe:t,message:s},this.syncTaskMap[e]=i,this.syncTasks.push(i),this.syncRendererMask())}updateSyncTask(e,t,s){let i=this.syncTaskMap[e];i&&(i.describe=t,i.message=s,this.syncRendererMask())}removeSyncTask(e){const t=this.syncTaskMap[e];if(!t)return;const s=this.syncTasks.indexOf(t);-1!==s&&this.syncTasks.splice(s,1),delete this.syncTaskMap[e],this.syncRendererMask()}addNotice(e){void 0===e.timeout&&(e.timeout=-1);const t=ID++,s=Object.assign({id:t},e);return this.noticeTasks.push(s),this.noticeTaskMap[t]=s,this.emit("add-notice",s),ipc.broadcast("editor-lib-task:emit","add-notice",s),e.timeout>0&&(s.timer=setTimeout(()=>{this.removeNotice(t)},e.timeout)),t}changeNoticeTimeout(e,t){const s=this.noticeTaskMap[e];s&&(clearTimeout(s.timer),(t=t||0)>0?(s.timeout=t,s.timer=setTimeout(()=>{this.removeNotice(e)},s.timeout)):s.timeout=t=0)}removeNotice(e){const t=this.noticeTaskMap[e];if(!t)return;const s=this.noticeTasks.indexOf(t);-1!==s&&this.noticeTasks.splice(s,1),delete this.noticeTaskMap[e],delete t.timer,this.emit("remove-notice",t),ipc.broadcast("editor-lib-task:emit","remove-notice",t)}queryNotices(){return this.noticeTasks}}module.exports=new Task,ipc.on("editor-lib-task:call",(e,t,...s)=>__awaiter(void 0,void 0,void 0,function*(){try{const i=yield module.exports[t](...s);return e.reply(null,i),i}catch(t){e.reply(t)}return null})),ipc.on("editor-lib-task:query",e=>{const t=module.exports.syncTasks[0];t?e.reply(null,t.title,t.describe,t.message):e.reply(null,"")});