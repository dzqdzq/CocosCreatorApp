"use strict";var __awaiter=this&&this.__awaiter||function(e,n,o,i){return new(o||(o=Promise))(function(r,t){function l(e){try{u(i.next(e))}catch(e){t(e)}}function a(e){try{u(i.throw(e))}catch(e){t(e)}}function u(e){var n;e.done?r(e.value):(n=e.value,n instanceof o?n:new o(function(e){e(n)})).then(l,a)}u((i=i.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.apply=exports.query=exports.init=void 0;const panel_1=require("../../panel"),{BrowserWindow:BrowserWindow}=require("electron"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows");let mainID=null;function init(){}function query(){return __awaiter(this,void 0,void 0,function*(){const e=windows.uuids[0],n=windows.uuid2info[e];return n?n.userData.layout:null})}function apply(e){return __awaiter(this,void 0,void 0,function*(){if(null===mainID)return;const n=[];!function e(o){o.panels&&o.panels.forEach(e=>{n.push(e)}),o.children&&o.children.forEach(e)}(e.layout);for(let e=0;e<n.length;e++){const o=n[e],i=panel.getWindow(o)||[];if(!(yield tryClose(o,i)))return void console.warn(`Failed to change layout: ${o} Panels are not allowed to close`);1!==i.length||i[0]!==mainID||n.splice(e--,1)}for(let e=0;e<n.length;e++){const o=n[e];if(!(yield panel_1.Panel.close(o)))return void console.warn(`Failed to change layout: ${o} Panels are not allowed to close`)}const o=BrowserWindow.fromId(mainID);ipc.sendToWin(o,"editor-lib-layout:apply",e)})}function tryClose(e,n){return __awaiter(this,void 0,void 0,function*(){if(null===n||void 0===n)return!0;const o=n.map(n=>new Promise((o,i)=>{const r=BrowserWindow.fromId(n);ipc.sendToWin(r,"editor-lib-layout:try-close",e).callback((e,n)=>{o(n)})}));return(yield Promise.all(o)).every(Boolean)})}exports.init=init,exports.query=query,exports.apply=apply,ipc.on("editor-lib-layout:main",e=>{if(!e.sender)return void(mainID=null);const n=BrowserWindow.fromWebContents(e.sender);mainID=n&&"number"==typeof n.id?n.id:null}),ipc.on("editor-lib-layout:query",e=>__awaiter(void 0,void 0,void 0,function*(){try{const n=yield query();return e.reply(null,n),n}catch(n){console.error(n),e.reply(n)}}));