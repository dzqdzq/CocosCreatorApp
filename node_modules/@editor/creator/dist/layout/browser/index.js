"use strict";var __awaiter=this&&this.__awaiter||function(e,n,i,o){return new(i||(i=Promise))(function(r,t){function l(e){try{c(o.next(e))}catch(e){t(e)}}function a(e){try{c(o.throw(e))}catch(e){t(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof i?n:new i(function(e){e(n)})).then(l,a)}c((o=o.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.apply=exports.init=void 0;const panel_1=require("../../panel"),{BrowserWindow:BrowserWindow}=require("electron"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc");let mainID=null;function init(){}function apply(e){return __awaiter(this,void 0,void 0,function*(){if(null===mainID)return;const n=[];!function e(i){i.panels&&i.panels.forEach(e=>{n.push(e)}),i.children&&i.children.forEach(e)}(e.layout);for(let e=0;e<n.length;e++){const i=n[e],o=panel.getWindow(i)||[];if(!(yield tryClose(i,o)))return void console.warn(`更改布局失败：${i} 面板不允许关闭`);1!==o.length||o[0]!==mainID||n.splice(e--,1)}for(let e=0;e<n.length;e++){const i=n[e];if(!(yield panel_1.Panel.close(i)))return void console.warn(`更改布局失败：${i} 面板不允许关闭`)}const i=BrowserWindow.fromId(mainID);ipc.sendToWin(i,"editor-lib-layout:apply",e)})}function tryClose(e,n){return __awaiter(this,void 0,void 0,function*(){if(null===n||void 0===n)return!0;const i=n.map(n=>new Promise((i,o)=>{const r=BrowserWindow.fromId(n);ipc.sendToWin(r,"editor-lib-layout:try-close",e).callback((e,n)=>{i(n)})}));return(yield Promise.all(i)).every(Boolean)})}exports.init=init,exports.apply=apply,ipc.on("editor-lib-layout:main",e=>{if(!e.sender)return void(mainID=null);const n=BrowserWindow.fromWebContents(e.sender);mainID=n&&"number"==typeof n.id?n.id:null});