"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))(function(o,i){function r(e){try{s(a.next(e))}catch(e){i(e)}}function l(e){try{s(a.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}s((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.apply=void 0;const panel_1=require("../../panel"),fs=require("fs"),ps=require("path"),windows=require("@base/electron-windows"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),$dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}function findPanelsFromLayout(e){const t=[];return e.panels&&e.panels.forEach(e=>{t.push(e)}),e.children&&e.children.forEach(e=>{findPanelsFromLayout(e).forEach(e=>{t.push(e)})}),t}function init(e){if($dock){if(!(e=e||windows.userData.layout)){const t=ps.join(__dirname,"../../../static/layout/default.json");e=JSON.parse(fs.readFileSync(t,"utf8"))}module.exports.apply(e);let t=null,n="";$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){const e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,a=e.top+e.bottom-e.height,o=windows.userData.layout=$dock.dump();windows.setMinSize(t+o.layout["min-width"],a+o.layout["min-height"]),windows.sync();try{if(!window.__MAIN__){const e=findPanelsFromLayout(o.layout),t=e.join(",");if(n===t)return;n=t;const a=e.map(e=>{const t=$dock.$layout.querySelector(`panel-frame[name="${e}"]`).userData.title||e;return t.startsWith("i18n:")&&Editor.I18n.t(t.substr(5))||t});document.title=a.join(",")}}catch(e){console.warn(e)}},300),requestAnimationFrame(()=>{const e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(t),void window.close()})}),dock.registerMenuParser(function(e,t){return __awaiter(this,void 0,void 0,function*(){const n=panel.queryInfo(t);let a=!0;n&&n.userData&&n.userData.flags&&!1===n.userData.flags.popup&&(a=!1);let o=!0;n&&n.userData&&n.userData.flags&&!1===n.userData.flags.close&&(o=!1);const i=[{label:i18n.translation("menu.panel_popup"),enabled:a,click(){return __awaiter(this,void 0,void 0,function*(){!1!==(yield e.removePanel(t))&&panel_1.Panel.open(t)})}},{label:i18n.translation("menu.panel_close"),enabled:o,click(){return __awaiter(this,void 0,void 0,function*(){e.removePanel(t)})}}];if(n&&n.userData&&n.userData.menu){if(!Array.isArray(n.userData.menu))return void console.warn(`Panel menu data must be an array - ${t}`);i.push({type:"separator"}),n.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(n.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,i.push(e)})}return i})})}}exports.apply=apply,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){window.__MAIN__&&module.exports.apply(t)})),ipc.on("editor-lib-layout:try-close",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const n=panel.query(t);if(!n||n.length<=0)return e.reply(null,!0);const a=yield Promise.all(n.map(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.emit("beforeClose")})));return e.reply(null,!a.some(e=>!1===e))})),exports.init=init;