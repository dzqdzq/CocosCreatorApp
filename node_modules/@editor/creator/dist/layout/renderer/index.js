"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))(function(o,i){function r(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(r,l)}s((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.query=exports.apply=void 0;const panel_1=require("../../panel"),fs=require("fs"),ps=require("path"),windows=require("@base/electron-windows"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),$dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}function query(){return new Promise((e,t)=>{ipc.send("editor-lib-layout:query").callback((a,n)=>{a?t(a):e(n)})})}function init(e){if($dock){if(!(e=e||windows.userData.layout)){const t=ps.join(__dirname,"../../../static/layout/default.json");e=JSON.parse(fs.readFileSync(t,"utf8"))}module.exports.apply(e);let t=null;$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){const e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,a=e.top+e.bottom-e.height,n=windows.userData.layout=$dock.dump();windows.setMinSize(t+n.layout["min-width"],a+n.layout["min-height"]),windows.sync()},300),requestAnimationFrame(()=>{const e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(t),void windows.close()})}),$dock.shadowRoot.addEventListener("panel-close",e=>{Editor.Module.removeCache(ps.join(e.target.getData("packageDir")||"",e.target.getData("main")||""))}),$dock.shadowRoot.addEventListener("panel-drop",e=>{e.target.focus()}),dock.registerMenuParser(function(e,t){return __awaiter(this,void 0,void 0,function*(){const a=panel.queryInfo(t),n=panel.queryAll();let o=!0;a&&a.userData&&a.userData.flags&&!1===a.userData.flags.popup&&(o=!1);let i=!0;a&&a.userData&&a.userData.flags&&!1===a.userData.flags.close&&(i=!1);const r=[{label:i18n.translation("menu.panel_popup"),enabled:o&&n.length>1,click(){return __awaiter(this,void 0,void 0,function*(){!1!==(yield e.removePanel(t))&&panel_1.Panel.open(t)})}},{label:i18n.translation("menu.panel_close"),enabled:i,click(){return __awaiter(this,void 0,void 0,function*(){e.removePanel(t)})}}];if(a&&a.userData&&a.userData.menu){if(!Array.isArray(a.userData.menu))return void console.warn(`Panel menu data must be an array - ${t}`);r.push({type:"separator"}),a.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(a.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,r.push(e)})}return r})})}}exports.apply=apply,exports.query=query,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){window.__MAIN__&&module.exports.apply(t)})),ipc.on("editor-lib-layout:try-close",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const a=panel.query(t);if(!a||a.length<=0)return e.reply(null,!0);const n=yield Promise.all(a.map(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.emit("beforeClose")})));return e.reply(null,!n.some(e=>!1===e))})),exports.init=init;