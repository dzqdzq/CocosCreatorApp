"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.emit=exports.once=exports.on=exports.queryList=exports.remove=exports.query=exports.add=exports.init=void 0;const events_1=require("events"),ipc=require("@base/electron-base-ipc"),dock=require("@editor/dock"),panel=require("@editor/panel"),i18n=require("@base/electron-i18n"),path_1=require("path");function send(e,...t){return new Promise((r,n)=>{ipc.send("editor-lib-layout:call",e,...t).callback((e,t)=>{e?n(e):r(t)})})}const emitter=new events_1.EventEmitter,$dock=document.querySelector("dock-frame");async function init(e){if($dock){const n=await Editor.Windows.__protected__.queryUserData();(e=n.layout||e)&&Editor.Layout.apply(e);let t=null;$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){var e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,e=e.top+e.bottom-e.height,r=n.layout=$dock.dump();Editor.Windows.__protected__.changeMinSize(t+r.layout["min-width"],e+r.layout["min-height"]),Editor.Windows.__protected__.changeUserData(n)},300),requestAnimationFrame(()=>{var e=$dock.$layout.firstElementChild;e&&("DOCK-GROUPS"!==e.tagName||0!==e.panels.length)||(clearTimeout(t),Editor.Windows.__protected__.close())})}),$dock.shadowRoot.addEventListener("panel-close",e=>{Editor.Module.__protected__.removeCache((0,path_1.join)(e.target.getData("packageDir")||"",e.target.getData("main")||""))}),$dock.shadowRoot.addEventListener("panel-drop",e=>{e.target.focus()}),dock.registerMenuParser(async function(e,t){const r=panel.queryInfo(t);var n=panel.queryAll();let o=!0,a=(r&&r.userData&&r.userData.flags&&!1===r.userData.flags.popup&&(o=!1),!0);r&&r.userData&&r.userData.flags&&!1===r.userData.flags.close&&(a=!1);const i=[{label:i18n.translation("menu.panel_popup"),enabled:o&&1<n.length,async click(){!1!==await e.removePanel(t)&&Editor.Panel.open(t)}},{label:i18n.translation("menu.panel_close"),enabled:a,async click(){e.removePanel(t)}}];if(r&&r.userData&&r.userData.menu){if(!Array.isArray(r.userData.menu))return void console.warn("Panel menu data must be an array - "+t);i.push({type:"separator"}),r.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(r.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,i.push(e)})}return i})}}async function add(e,t){return send("add",e,t)}async function query(e){return send("query",e)}async function remove(e){return send("remove",e)}async function queryList(){return send("queryList")}function on(e,t){return emitter.on(e,t)}function once(e,t){return emitter.once(e,t)}function emit(e,...t){return send("emit",e,...t)}function removeListener(e,t){return emitter.removeListener(e,t)}exports.init=init,exports.add=add,exports.query=query,exports.remove=remove,exports.queryList=queryList,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,ipc.on("editor-lib-layout:emit",(e,t,...r)=>{emitter.emit(t,...r)});