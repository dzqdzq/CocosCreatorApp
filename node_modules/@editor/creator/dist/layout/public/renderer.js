"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.query=exports.init=exports.apply=void 0;const path_1=require("path"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),$dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}async function init(e){if($dock){const o=await Editor.Windows.__protected__.queryUserData();(e=o.layout||e)&&module.exports.apply(e);let t=null;$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){var e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,e=e.top+e.bottom-e.height,a=o.layout=$dock.dump();Editor.Windows.__protected__.changeMinSize(t+a.layout["min-width"],e+a.layout["min-height"]),Editor.Windows.__protected__.changeUserData(o)},300),requestAnimationFrame(()=>{var e=$dock.$layout.firstElementChild;e&&("DOCK-GROUPS"!==e.tagName||0!==e.panels.length)||(clearTimeout(t),Editor.Windows.__protected__.close())})}),$dock.shadowRoot.addEventListener("panel-close",e=>{Editor.Module.__protected__.removeCache((0,path_1.join)(e.target.getData("packageDir")||"",e.target.getData("main")||""))}),$dock.shadowRoot.addEventListener("panel-drop",e=>{e.target.focus()}),dock.registerMenuParser(async function(e,t){const a=panel.queryInfo(t);var o=panel.queryAll();let r=!0,n=(a&&a.userData&&a.userData.flags&&!1===a.userData.flags.popup&&(r=!1),!0);a&&a.userData&&a.userData.flags&&!1===a.userData.flags.close&&(n=!1);const i=[{label:i18n.translation("menu.panel_popup"),enabled:r&&1<o.length,async click(){!1!==await e.removePanel(t)&&Editor.Panel.open(t)}},{label:i18n.translation("menu.panel_close"),enabled:n,async click(){e.removePanel(t)}}];if(a&&a.userData&&a.userData.menu){if(!Array.isArray(a.userData.menu))return void console.warn("Panel menu data must be an array - "+t);i.push({type:"separator"}),a.userData.menu.forEach(e=>{e.click=function(){Editor.Message.send(a.userData.package,e.message,...e.params||[])},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,i.push(e)})}return i})}}async function query(e){return Editor.Layout.__protected__.query(e)}exports.apply=apply,exports.init=init,exports.query=query,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",async(e,t)=>{window.__MAIN__&&module.exports.apply(t)}),ipc.on("editor-lib-layout:try-close",async(e,t)=>{var t=panel.query(t);return!t||t.length<=0?e.reply(null,!0):(t=await Promise.all(t.map(async e=>e.emit("beforeClose"))),e.reply(null,!t.some(e=>!1===e)))});