"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeBroadcastListener=exports.addBroadcastListener=exports.broadcast=exports.send=exports.request=exports.__unregister__=exports.__register__=exports.__eb__=void 0;const electron_1=require("electron"),events_1=require("events"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),panelManager=require("@editor/panel"),messageMap=(exports.__eb__=new events_1.EventEmitter,{}),broadcastWindowMap={},broadcastListenerMap={};function __register__(e,a){for(const r in a){var s=a[r];s.methods?Array.isArray(s.methods)||(console.warn(`Invalid message definition: ${e}(${r}) 'methods' must be an array`),a[r].methods=[]):a[r].methods=[]}messageMap[e]=a}function __unregister__(e){delete messageMap[e]}async function request(t,o,...a){const n={name:t,message:o,args:a};if(exports.__eb__.emit("request",n),!messageMap[t]||!messageMap[t][o])throw new Error(`Message does not exist: ${t} - `+o);var s=messageMap[t][o];if(!s.methods.length)throw new Error(`No methods specified for current message: ${t} - `+o);for(let e=0;e<s.methods.length-1;e++){const i=s.methods[e].split(".");1===i.length?packageManager.exec(t,o,...a):panelManager.exec(t+"."+i[0],i[1],...a)}const i=s.methods[s.methods.length-1].split(".");return new Promise((s,r)=>{1===i.length?packageManager.exec(t,i[0],...a).callback((e,a)=>{if(e)return e.stack=e.stack+`
    (Target: ${t}, Message: ${o})`,r(e);exports.__eb__.emit("reply",n),s(a)}):panelManager.exec("default"===i[0]?t:t+"."+i[0],i[1],...a).then(e=>{exports.__eb__.emit("reply",n),s(e)}).catch(e=>{exports.__eb__.emit("reply",n),r(e)})})}function send(s,e,...r){if(exports.__eb__.emit("send",{name:s,message:e,args:r}),!messageMap[s]||!messageMap[s][e])throw new Error(`Message does not exist: ${s} - `+e);messageMap[s][e].methods.forEach(e=>{var a=e.split(".");1===a.length?packageManager.execWithoutReply(s,e,...r):panelManager.execWithoutReply("default"===a[0]?s:s+"."+a[0],a[1],...r)})}function broadcast(a,...s){exports.__eb__.emit("broadcast",{message:a,args:s});for(const o in messageMap){var e;messageMap[o][a]&&(e=messageMap[o][a]).methods&&e.methods.forEach(e=>{var a=e.split(".");1===a.length?packageManager.execWithoutReply(o,e,...s):(e="default"===a[0]?o:o+"."+a[0],0<(panelManager.getWindow(e)||[]).length&&panelManager.execWithoutReply(e,a[1],...s))})}if(broadcastWindowMap[a]){var r=broadcastWindowMap[a];for(let e=0;e<r.length;e++){var t=r[e],t=electron_1.webContents.fromId(t);t?ipc.sendToWin(electron_1.BrowserWindow.fromWebContents(t),"editor-lib-message:emit-broadcast-listener",a,...s):(r.splice(e,1),e--)}}if(broadcastListenerMap[a])for(const n of[...broadcastListenerMap[a]])try{n(...s)}catch(e){console.error(e)}}function addBroadcastListener(e,a){broadcastListenerMap[e]=broadcastListenerMap[e]??[],broadcastListenerMap[e].push(a)}function removeBroadcastListener(e,a){broadcastListenerMap[e]&&-1!==(a=broadcastListenerMap[e].indexOf(a))&&broadcastListenerMap[e].splice(a,1)}exports.__register__=__register__,exports.__unregister__=__unregister__,exports.request=request,exports.send=send,exports.broadcast=broadcast,exports.addBroadcastListener=addBroadcastListener,exports.removeBroadcastListener=removeBroadcastListener,ipc.on("editor-lib-message:call",async(a,e,...s)=>{if(module.exports[e])try{var r=await module.exports[e](...s);a.reply(null,r)}catch(e){a.reply(e,null)}}),ipc.on("editor-lib-message:add-broadcast-listener",async(e,a)=>{e=e.sender.id;broadcastWindowMap[a]=broadcastWindowMap[a]||[],broadcastWindowMap[a].includes(e)||broadcastWindowMap[a].push(e)}),ipc.on("editor-lib-message:remove-broadcast-listener",async(e,a)=>{var e=e.sender.id;broadcastWindowMap[a]&&-1!==(e=broadcastWindowMap[a].indexOf(e))&&broadcastWindowMap[a].splice(e,1)});