"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,s){return new(a||(a=Promise))(function(r,o){function n(e){try{c(s.next(e))}catch(e){o(e)}}function i(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(n,i)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeBroadcastListener=exports.addBroadcastListener=exports.broadcast=exports.send=exports.request=exports.unregister=exports.register=void 0;const electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),panelManager=require("@editor/panel"),messageMap={},broadcastWindowMap={},broadcastListenerMap={};function register(e,t){for(const a in t){const s=t[a];s.methods?Array.isArray(s.methods)||(console.warn(`Invalid message definition: ${e}(${a}) 'methods' must be an array`),t[a].methods=[]):t[a].methods=[]}messageMap[e]=t}function unregister(e){delete messageMap[e]}function request(e,t,...a){return __awaiter(this,void 0,void 0,function*(){if(!messageMap[e]||!messageMap[e][t])throw new Error(`Message does not exist: ${e} - ${t}`);const s=messageMap[e][t];if(!s.methods.length)throw new Error(`No methods specified for current message: ${e} - ${t}`);for(let r=0;r<s.methods.length-1;r++){const o=s.methods[r].split(".");1===o.length?packageManager.exec(e,t,...a):panelManager.exec(e+"."+o[0],o[1],...a)}const r=s.methods[s.methods.length-1].split(".");return new Promise((t,s)=>{1===r.length?packageManager.exec(e,r[0],...a).callback((e,a)=>{if(e)return s(e);t(a)}):panelManager.exec("default"===r[0]?e:e+"."+r[0],r[1],...a).then(e=>{t(e)}).catch(e=>{s(e)})})})}function send(e,t,...a){if(!messageMap[e]||!messageMap[e][t])throw new Error(`Message does not exist: ${e} - ${t}`);messageMap[e][t].methods.forEach(t=>{const s=t.split(".");1===s.length?packageManager.execWithoutReply(e,t,...a):panelManager.execWithoutReply("default"===s[0]?e:e+"."+s[0],s[1],...a)})}function broadcast(e,...t){for(const a in messageMap){if(!messageMap[a][e])continue;const s=messageMap[a][e];s.methods&&s.methods.forEach(e=>{const s=e.split(".");if(1===s.length)packageManager.execWithoutReply(a,e,...t);else{const e="default"===s[0]?a:a+"."+s[0];(panelManager.getWindow(e)||[]).length>0&&panelManager.execWithoutReply(e,s[1],...t)}})}if(broadcastWindowMap[e]){const a=broadcastWindowMap[e];for(let s=0;s<a.length;s++){const r=a[s],o=electron_1.webContents.fromId(r);o?ipc.sendToWin(electron_1.BrowserWindow.fromWebContents(o),"editor-lib-message:emit-broadcast-listener",e,...t):(a.splice(s,1),s--)}}if(broadcastListenerMap[e]){const a=broadcastListenerMap[e];for(const e of[...a])try{e(...t)}catch(e){console.error(e)}}}function addBroadcastListener(e,t){var a;broadcastListenerMap[e]=null!==(a=broadcastListenerMap[e])&&void 0!==a?a:[],broadcastListenerMap[e].push(t)}function removeBroadcastListener(e,t){if(broadcastListenerMap[e]){const a=broadcastListenerMap[e].indexOf(t);-1!==a&&broadcastListenerMap[e].splice(a,1)}}exports.register=register,exports.unregister=unregister,exports.request=request,exports.send=send,exports.broadcast=broadcast,exports.addBroadcastListener=addBroadcastListener,exports.removeBroadcastListener=removeBroadcastListener,ipc.on("editor-lib-message:call",(e,t,...a)=>__awaiter(void 0,void 0,void 0,function*(){if(module.exports[t])try{const s=yield module.exports[t](...a);e.reply(null,s)}catch(t){e.reply(t,null)}})),ipc.on("editor-lib-message:add-broadcast-listener",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const a=e.sender.id;broadcastWindowMap[t]=broadcastWindowMap[t]||[],broadcastWindowMap[t].includes(a)||broadcastWindowMap[t].push(a)})),ipc.on("editor-lib-message:remove-broadcast-listener",(e,t)=>__awaiter(void 0,void 0,void 0,function*(){const a=e.sender.id;if(broadcastWindowMap[t]){const e=broadcastWindowMap[t].indexOf(a);-1!==e&&broadcastWindowMap[t].splice(e,1)}}));