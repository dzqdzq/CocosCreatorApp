"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Tree=void 0;const fs=require("fs"),path=require("path"),drag_area_1=require("../drag/drag-area"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./tree.css"),"utf8")}</style>`,CUSTOM_STYLE='<style class="style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./tree.html"),"utf8")}`,instanceArray=[];class Tree extends drag_area_1.DragArea{constructor(){super(),this.list=[],this._templates={left:"",icon:"",text:"",right:"",item:""},this._templateInits={left(t){},icon(t){},text(t){},right(t){},item(t){}},this._renders={left(t,e){},icon(t,e){},text(t,e){},right(t,e){},item(t,e){}},this.selectItems=[],this._lineHeight=24,this._indent=20,this._tree={index:0,fold:!0,indent:0,showArrow:!0,detail:{},parent:null,children:[]},this.$items=[],this.$style=null,this.$content=null,this.$fixed=null,this.$list=null,this.$prompt=null,this._firstIndex=0,this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$style=this.shadowRoot.querySelector(".style"),this.$content=this.shadowRoot.querySelector(".content"),this.$fixed=this.shadowRoot.querySelector(".fixed"),this.$list=this.shadowRoot.querySelector(".list"),this.$prompt=this.shadowRoot.querySelector(".prompt"),this.$content.addEventListener("scroll",()=>{this.render()}))}setTemplate(t,e){this._templates[t]=e}setTemplateInit(t,e){this._templateInits[t]=e}setRender(t,e){this._renders[t]=e}select(t){t&&(this.selectItems.includes(t)||this.selectItems.push(t))}unselect(t){if(!t)return;const e=this.selectItems.indexOf(t);-1!==e&&this.selectItems.splice(e,1)}clear(){this.selectItems=[]}get lineHeight(){return this._lineHeight}set lineHeight(t){this.setAttribute("line-height",t+"")}get indent(){return this._indent}set indent(t){this.setAttribute("indent",t+"")}get css(){return this.$style.innerHTML}set css(t){this.$style.innerHTML=t}set tree(t){t=t||[],this._tree.children=t,t.forEach(t=>{t.parent=this._tree}),this.list=treeToList(t),this.render()}get tree(){return this._tree.children}connectedCallback(){super.connectedCallback(),instanceArray.push(this)}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["disabled","readonly","invalid","path","line-height","css","droppable"]}attributeChangedCallback(t,e,i){switch(t){case"line-height":this._lineHeight=i?parseInt(i):0,this.render();break;case"indent":this._indent=i?parseInt(i):0,this.render()}}positioning(t){if(!t)return;const e=t.index*this._lineHeight;if(e<this.$content.scrollTop)this.$content.scrollTop=e;else{const t=e+this._lineHeight;t-this.$content.clientHeight>this.$content.scrollTop&&(this.$content.scrollTop=t-this.$content.clientHeight)}for(;t.parent;)t.parent.fold=!1,t=t.parent;this.tree=this.tree}prompt(t){if(!t)return void this.$prompt.setAttribute("hidden","");this.$prompt.removeAttribute("hidden"),this.$prompt.style.transform=`translateY(${t.index*this._lineHeight}px)`;let e=this.list[t.index+1];for(;e&&e.indent>t.indent;)e=this.list[e.index+1];this.$prompt.style.height=e?(e.index-t.index)*this._lineHeight+"px":this._lineHeight+"px"}collapse(t){let e;treeForEach(e=t?[t]:this.tree,t=>{t.fold=!0}),this.tree=this.tree}expand(t){let e;if(treeForEach(e=t?[t]:this.tree,t=>{t.fold=!1}),t)for(t.fold=!1;t.parent;)t.parent.fold=!1,t=t.parent;this.tree=this.tree}render(){cancelAnimationFrame(this._nextRender),this._nextRender=requestAnimationFrame(()=>{this._render()})}_render(){const t=this._firstIndex=Math.max(Math.floor(this.$content.scrollTop/this._lineHeight),0),e=t+Math.ceil(this.clientHeight/this._lineHeight)+1;this.$list.style.transform=`translateY(${t*this._lineHeight}px)`,this.$fixed.style.height=this.list.length*this._lineHeight+"px";let i=0;for(let s=t;s<e;s++){const t=this.list[s];if(t){let e=this.$list.children[i++];e||((e=document.createElement("ui-drag-item")).classList.add("item"),e.innerHTML=`\n<div class="left">${this._templates.left||""}</div>\n<div class="section">\n    <div class="arrow">\n        <ui-icon value="arrow-triangle"></ui-icon>\n    </div>\n    ${this._templates.icon?'<div class="icon">'+this._templates.icon+"</div>":""}\n    <div class="text">${this._templates.text||""}</div>\n</div>\n<div class="right">${this._templates.right||""}</div>\n                    `,e.$section=e.querySelector(".section"),e.$left=e.querySelector(".left"),e.$arrow=e.querySelector(".arrow"),e.$icon=e.querySelector(".icon"),e.$text=e.querySelector(".text"),e.$right=e.querySelector(".right"),e.$arrow.addEventListener("mousedown",t=>{t.stopPropagation(),t.preventDefault()}),e.$arrow.addEventListener("mouseup",t=>{t.stopPropagation(),t.preventDefault()}),e.$arrow.addEventListener("dblclick",t=>{t.stopPropagation(),t.preventDefault()}),e.$arrow.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),e.data.fold=!e.data.fold,this.tree=this.tree}),this._templateInits.item&&this._templateInits.item(e),this._templateInits.left&&this._templateInits.left(e.$left),this._templateInits.icon&&this._templateInits.icon(e.$icon),this._templateInits.text&&this._templateInits.text(e.$text),this._templateInits.right&&this._templateInits.right(e.$right),this.$list.appendChild(e)),e.removeAttribute("hidden"),e.style.height=this._lineHeight+"px",t.fold?e.setAttribute("fold",""):e.removeAttribute("fold"),!1===t.showArrow?e.$arrow.setAttribute("hidden",""):e.$arrow.removeAttribute("hidden"),this.selectItems.includes(t)?e.setAttribute("selected",""):e.removeAttribute("selected"),e.data=t,e.$left&&(e.$left.data=t),e.$icon&&(e.$icon.data=t),e.$text&&(e.$text.data=t),e.$right&&(e.$right.data=t),this._renders.item&&this._renders.item(e,t),this._renders.left&&this._renders.left(e.$left,t),this._renders.icon&&this._renders.icon(e.$icon,t),this._renders.text&&this._renders.text(e.$text,t),this._renders.right&&this._renders.right(e.$right,t),e.$section.style.paddingLeft=t.indent*this._indent+"px"}else{const t=this.$list.children[i++];t&&t.setAttribute("hidden","")}}for(;i<this.$list.children.length;)this.$list.children[i++].setAttribute("hidden","")}}function treeForEach(t,e){!function t(i,s){i.forEach(i=>{e(i),i.showArrow&&i.children&&t(i.children,s+1)})}(t,0)}function treeToList(t){const e=[];return function t(i,s,r){i.forEach(i=>{i.index=e.length,i.indent=s,r&&(i.parent=r),e.push(i),!0!==i.fold&&i.children&&t(i.children,s+1,i)})}(t,0),e}exports.Tree=Tree;