"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GradientPicker=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base"),Chroma=require("chroma-js"),CUSTOM_STYLE='<style id="custom-style"></style>',STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./gradient-picker.css"),"utf8")}</style>`,HTML=`${fs.readFileSync(path.join(__dirname,"./gradient-picker.html"),"utf8")}`,instanceArray=[];let customStyle="";class GradientPicker extends base_1.Base{constructor(){super(),this.activeOrbital=null,this.activeProgress=null,this._map={},this._value={},this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$preview=this.shadowRoot.querySelector(".preview"),this.$previewHybrid=this.shadowRoot.querySelector(".preview .hybrid .background"),this.$previewAlpha=this.shadowRoot.querySelector(".preview .alpha .background"),this.$previewColor=this.shadowRoot.querySelector(".preview .color .background"),this.$alphas=this.shadowRoot.querySelector(".preview .alpha .keys"),this.$colors=this.shadowRoot.querySelector(".preview .color .keys"),this.$location=this.shadowRoot.querySelector(".location"),this.$color=this.shadowRoot.querySelector(".operation .color"),this.$color.$root=this.$previewAlpha.$root=this.$previewColor.$root=this.$location.$root=this.$preview.$root=this)}static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),instanceArray.map(e=>{e.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}),this.activeOrbital=null,this.activeProgress=null)}get value(){return this._value}set value(e){if(e){"object"!=typeof e&&(e={alpha:[],color:[]});try{this.setAttribute("value",JSON.stringify(e))}catch(e){console.warn(e),this.removeAttribute("value")}}else this.removeAttribute("value")}get fixed(){return null!==this.getAttribute("fixed")}set fixed(e){e?this.setAttribute("fixed",""):this.removeAttribute("fixed"),this._updateAlpha(),this._updateAlphaKeys(),this._updateColor(),this._updateColorKeys(),this._updateHybrid()}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this._location=0,this.shadowRoot){const e=this.shadowRoot.querySelector("#custom-style");e&&(e.innerHTML=customStyle)}this.addEventListener("focus",this._onFocus),this.addEventListener("blur",this._onBlur),this.$preview.addEventListener("mouseup",this._onPreviewMouseDown,!0),this.$location.addEventListener("change",this._onLocationChange),this.$color.addEventListener("change",this._onColorChange),this.$color.addEventListener("cancel",this._onColorChange),this.$previewAlpha.addEventListener("click",this._onAlphaClick),this.$previewColor.addEventListener("click",this._onColorClick)}disconnectedCallback(){const e=instanceArray.indexOf(this);instanceArray.splice(e,1),this.$preview.removeEventListener("mouseup",this._onPreviewMouseDown,!0),this.$location.removeEventListener("change",this._onLocationChange),this.$color.removeEventListener("change",this._onColorChange),this.$previewAlpha.removeEventListener("click",this._onAlphaClick),this.$previewColor.removeEventListener("click",this._onColorClick)}static get observedAttributes(){return["focused","readonly","disabled","value","path"]}attributeChangedCallback(e,t,o){switch(super.attributeChangedCallback(e,t,o),e){case"invalid":requestAnimationFrame(()=>{this._updateHybrid()});break;case"value":if(this.invalid=!1,o)try{this._value=JSON.parse(o)}catch(e){console.warn(e),this.value=null}else this._value={};requestAnimationFrame(()=>{this._updateAlpha(),this._updateAlphaKeys(),this._updateColor(),this._updateColorKeys(),this._updateHybrid()})}}_onFocus(){}_onBlur(){this.dispatch("confirm")}_onPreviewMouseDown(e){const t=this;let o=e.offsetX,r=e.target;for(;r!==t.$root.$preview;)o+=r.offsetLeft,r=r.offsetParent;t.$root._location=Math.min(Math.max((o-20)/(t.$root.$preview.clientWidth-40),0),1)}_onLocationChange(e){const t=this;"alpha"===t.$root.activeOrbital?(t.$root._value.alpha.some(o=>{if(o.progress!==t.$root.activeProgress)return!1;t.$root.activeProgress=o.progress=e.target.value/100}),t.$root._value.alpha.sort((e,t)=>e.progress-t.progress),t.$root._updateAlpha(),t.$root._updateAlphaKeys(),t.$root._updateHybrid()):"color"===t.$root.activeOrbital&&(t.$root._value.color.some(o=>{if(o.progress!==t.$root.activeProgress)return!1;t.$root.activeProgress=o.progress=e.target.value/100}),t.$root._value.color.sort((e,t)=>e.progress-t.progress),t.$root._updateColor(),t.$root._updateColorKeys(),t.$root._updateHybrid())}_onColorChange(e){const t=this;"color"===t.$root.activeOrbital?(t.$root._value.color.some(o=>{if(o.progress!==t.$root.activeProgress)return!1;o.value=Chroma(e.target.value,"rgb").hex()}),t.$root._updateColor(),t.$root._updateColorKeys()):"alpha"===t.$root.activeOrbital&&(t.$root._value.alpha.some(o=>{if(o.progress!==t.$root.activeProgress)return!1;o.value=e.target.value[3]/255}),t.$root._updateAlpha(),t.$root._updateAlphaKeys()),t.$root._updateHybrid()}_onAlphaClick(e){const t={value:1,progress:this.$root._location};this.$root._value.alpha=this.$root._value.alpha||[],this.$root._value.alpha.push(t),this.$root._value.alpha.sort((e,t)=>e.progress-t.progress),this.$root.setAttribute("value",JSON.stringify(this.$root._value)),this.$root._updateActive("alpha",t)}_onColorClick(e){const t={value:{r:255,g:255,b:255},progress:this.$root._location};this.$root._value.color=this.$root._value.color||[],this.$root._value.color.push(t),this.$root._value.color.sort((e,t)=>e.progress-t.progress),this.$root.setAttribute("value",JSON.stringify(this.$root._value)),this.$root._updateActive("color",t)}_onAlphaKeyMouseDown(e){const t=this,o=e.pageX,r=e.pageY,a=this.getAttribute("index")||"",s=t.$root._value.alpha[a],i="SPAN"===e.target.tagName?e.target.parentElement:e.target,l=parseInt(i.style.left,10),h=s.progress;t.$root._updateActive("alpha",s);const n=e=>{const a=(e.pageX-o)/(t.$root.$preview.clientWidth-40);s.progress=Math.min(Math.max(h+a,0),1),i.style.left=Math.min(Math.max(l+(e.pageX-o),0),t.$root.$preview.clientWidth-40)+"px";const n=t.$root._value.alpha.indexOf(s);Math.abs(e.pageY-r)>20?-1!==n&&(t.$root._value.alpha.splice(n,1),i.hidden=!0,t.$root._updateActive("",null)):-1===n&&(t.$root._value.alpha.push(s),i.hidden=!1,t.$root._updateActive("alpha",s)),t.$root._value.alpha.sort((e,t)=>e.progress-t.progress),t.$root._updateAlpha(),t.$root._updateHybrid()},c=e=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",c),t.$root.setAttribute("value",JSON.stringify(t.$root._value)),t.$root._updateActive("alpha",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",c)}_onColorKeyMouseDown(e){const t=this,o=e.pageX,r=e.pageY,a=this.getAttribute("index")||"",s=t.$root._value.color[a],i="SPAN"===e.target.tagName?e.target.parentElement:e.target,l=parseInt(i.style.left,10),h=s.progress;t.$root._updateActive("color",s);const n=e=>{const a=(e.pageX-o)/(t.$root.$preview.clientWidth-40);s.progress=Math.min(Math.max(h+a,0),1),i.style.left=Math.min(Math.max(l+(e.pageX-o),0),t.$root.$preview.clientWidth-40)+"px";const n=t.$root._value.color.indexOf(s);Math.abs(e.pageY-r)>20?-1!==n&&(t.$root._value.color.splice(n,1),i.hidden=!0,t.$root._updateActive("",null)):-1===n&&(t.$root._value.color.push(s),i.hidden=!1,t.$root._updateActive("color",s)),t.$root._value.color.sort((e,t)=>e.progress-t.progress),t.$root._updateColor(),t.$root._updateHybrid()},c=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",c),t.$root.setAttribute("value",JSON.stringify(t.$root._value)),t.$root._updateActive("color",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",c)}_mountAlphaKeysEvent(){this.$alphas.querySelectorAll("div").forEach(e=>{e.$root=this,e.addEventListener("mousedown",this._onAlphaKeyMouseDown)})}_mountColorKeysEvent(){this.$colors.querySelectorAll("div").forEach(e=>{e.$root=this,e.addEventListener("mousedown",this._onColorKeyMouseDown)})}_updateColor(){const e=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]};let t="";e.color&&e.color.length&&(t="linear-gradient(to right",e.color.forEach((o,r)=>{const a=Chroma(o.value).rgb();if(0===r&&0!==o.progress&&(t+=`, rgb(${a[0]}, ${a[1]}, ${a[2]}) 0%`),t+=`, rgb(${a[0]}, ${a[1]}, ${a[2]}) ${100*o.progress|0}%`,this.fixed&&e.color[r+1]){const a=Chroma(e.color[r+1].value).rgb();t+=`, rgb(${a[0]}, ${a[1]}, ${a[2]}) ${(100*o.progress|0)-.01}%`}r===e.color.length-1&&1!==o.progress&&(t+=`, rgb(${a[0]}, ${a[1]}, ${a[2]}) 100%`)}),t+=")"),this.$previewColor.style.background=t}_updateColorKeys(){const e=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]};let t="";e.color&&e.color.forEach((e,o)=>{const r=Chroma(e.value).rgb(),a="color"===this.activeOrbital&&this.activeProgress===e.progress;t+=`<div index="${o}" ${a?"focused":""} style="left: ${e.progress*this.$colors.clientWidth}px;"><span style="background: rgb(${r[0]}, ${r[1]}, ${r[2]})"></span></div>`}),this.$colors.innerHTML=t,this._mountColorKeysEvent()}_updateAlpha(){const e=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]};let t="";e.alpha&&e.alpha.length&&(t="linear-gradient(to right",e.alpha.forEach((o,r)=>{0===r&&0!==o.progress&&(t+=`, rgba(255,255,255,${o.value}) 0%`),t+=`, rgba(255,255,255,${o.value}) ${100*o.progress|0}%`,this.fixed&&e.alpha[r+1]&&(t+=`, rgba(255,255,255,${e.alpha[r+1].value}) ${(100*o.progress|0)-.01}%`),r===e.alpha.length-1&&1!==o.progress&&(t+=`, rgba(255,255,255,${o.value}) 100%`)}),t+=")"),this.$previewAlpha.style.background=t}_updateAlphaKeys(){const e=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]};let t="";e.alpha&&e.alpha.forEach((e,o)=>{const r=255*e.value,a="alpha"===this.activeOrbital&&this.activeProgress===e.progress;t+=`<div index="${o}" ${a?"focused":""} style="left: ${e.progress*this.$alphas.clientWidth}px;"><span style="background: rgb(${r}, ${r}, ${r})"></span></div>`}),this.$alphas.innerHTML=t,this._mountAlphaKeysEvent()}_updateHybrid(){const e=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]},t=e.alpha||[{value:1,progress:0}],o=e.color||[{value:"#ffffff",progress:0}],r=this._map={0:{r:255,g:255,b:255,a:255},1:{r:255,g:255,b:255,a:255}};t.forEach((e,o)=>{(r[e.progress]=r[e.progress]||{}).a=255*e.value|0,o===t.length-1&&(r[1].a=255*e.value|0),0===o&&(r[0].a=255*e.value|0)}),o.forEach((e,t)=>{const a=Chroma(e.value).rgb(),s=r[e.progress]=r[e.progress]||{};s.r=a[0],s.g=a[1],s.b=a[2],t===o.length-1&&(r[1].r=a[0],r[1].g=a[1],r[1].b=a[2]),0===t&&(r[0].r=a[0],r[0].g=a[1],r[0].b=a[2])});const a=Object.keys(r).sort();function s(e,t){const o=a[e];let s,i,l;s=e;do{i=r[a[s-=1]]}while(void 0===i[t]);s=e;do{l=r[a[s+=1]]}while(void 0===l[t]);const h=(o-a[e-1])/(a[e+1]-a[e-1]);return(l[t]-i[t])*h+i[t]}let i="linear-gradient(to right";a.forEach((e,t)=>{const o=r[e];void 0===o.r&&(o.r=Math.round(s(t,"r"))),void 0===o.g&&(o.g=Math.round(s(t,"g"))),void 0===o.b&&(o.b=Math.round(s(t,"b"))),void 0===o.a&&(o.a=Math.round(s(t,"a"))),o.progress=e}),a.forEach((e,t)=>{const o=r[e];if(i+=`, rgba(${o.r}, ${o.g}, ${o.b}, ${o.a/255}) ${100*e|0}%`,this.fixed&&a[t+1]){const o=r[a[t+1]];i+=`, rgb(${o.r}, ${o.g}, ${o.b}, ${o.a/255}) ${(100*e|0)-.01}%`}o.progress=e}),i+=")",this.$previewHybrid.style.background=i,this.dispatch("change")}_updateActive(e,t){if(this.activeOrbital=e,this.activeProgress=t?t.progress:0,this.$location.parentElement.disabled=!this.activeOrbital,"color"===this.activeOrbital?(this.$color.removeAttribute("disabled-color"),this.$color.setAttribute("disabled-alpha","")):"alpha"===this.activeOrbital?(this.$color.setAttribute("disabled-color",""),this.$color.removeAttribute("disabled-alpha")):(this.$color.setAttribute("disabled-color",""),this.$color.setAttribute("disabled-alpha","")),"alpha"===e)this.$location.value=(100*t.progress).toFixed(2),this.$color.value=[255,255,255,255*t.value];else if("color"===e){this.$location.value=(100*t.progress).toFixed(2);let e=[t.value.r,t.value.g,t.value.b,255];"string"==typeof t.value&&((e=Chroma(t.value).rgba())[3]=255),this.$color.value=e}else this.$location.value=0,this.$color.value=[255,255,255,255]}}exports.GradientPicker=GradientPicker;