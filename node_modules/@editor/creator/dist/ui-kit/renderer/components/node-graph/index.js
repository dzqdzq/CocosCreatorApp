"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeGraph=void 0;const extension_1=require("./extension"),fs=require("fs"),path=require("path"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./node-graph.css"),"utf8")}</style>`,CUSTOM_STYLE='<style class="style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./node-graph.html"),"utf8")}`,instanceArray=[];let test=!0;class NodeGraph extends HTMLElement{constructor(){super(),this._nextFrameUpdater=null,this.scale=.5,this.$nodeMap={},test&&(test=!1,this._aa=document.createElement("ui-node-graph")),this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$content=this.shadowRoot.querySelector(".content"),this.$mesh=this.shadowRoot.querySelector(".mesh"),this.$line=this.shadowRoot.querySelector(".line"),this.$layout=this.shadowRoot.querySelector(".layout"),this.meshCtx=this.$mesh.getContext("2d"),this.lineCtx=this.$line.getContext("2d"),this.addEventListener("mousedown",this._onMouseDown),this.addEventListener("mousewheel",this._onMouseWheel),this.addEventListener("dblclick",this._onDBClick))}static registerNodeRender(t,e){(0,extension_1.setTypeDefineInfo)(t,e)}connectedCallback(){instanceArray.push(this)}disconnectedCallback(){const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["disabled","readonly","invalid","path"]}attributeChangedCallback(t,e,i){}render(t){this._json=t,this.origin={x:this.clientWidth/2,y:this.clientHeight/2},this.$mesh.width=this.clientWidth,this.$mesh.height=this.clientHeight,this.$line.width=this.clientWidth,this.$line.height=this.clientHeight,this.update()}update(){null===this._nextFrameUpdater&&(this._nextFrameUpdater=requestAnimationFrame(()=>{this._nextFrameUpdater=null,this._renderMesh(),this._renderNodes(),this._renderLines()}))}addNode(t,e,i){this._json.nodes[Date.now()]={type:t,details:{},position:{x:e||0,y:i||0}}}addLine(t,e,i,s){const n=this._json;if(!n||!n.lines)return;const o=this._json.lines;for(const n in o){const h=o[n];h.input.node===t&&h.input.param===e&&delete o[n],h.output.node===i&&h.output.param===s&&delete o[n]}o[Date.now()]={input:{node:t,param:e},output:{node:i,param:s},details:{}},this.update()}getLayout(){return JSON.parse(JSON.stringify(this._json))}_renderMesh(){const t=this._json;t&&t.nodes&&(this.meshCtx.beginPath(),this.meshCtx.clearRect(0,0,this.clientWidth,this.clientHeight),this.meshCtx.strokeStyle="#444851",this.meshCtx.moveTo(0,0|this.origin.y),this.meshCtx.lineTo(this.clientWidth,0|this.origin.y),this.meshCtx.moveTo(0|this.origin.x,0),this.meshCtx.lineTo(0|this.origin.x,this.clientHeight),this.meshCtx.stroke())}_renderNodes(){const t=this._json;if(!t||!t.nodes)return;const e=this.$layout.querySelectorAll("ui-node-graph-item");let i=0;this.$nodeMap={};for(const s in t.nodes){const n=t.nodes[s];let o=e[i++];o||(o=document.createElement("ui-node-graph-item"),this.$layout.appendChild(o)),o.id=s,o.node=n,o.$root=this,this.$nodeMap[s]=o,o.updatePosition(n.position.x,n.position.y)}for(;i<e.length;i++)this.$layout.removeChild(e[i])}_renderLines(){const t=this._json;if(t&&t.lines){this.lineCtx.clearRect(0,0,this.clientWidth,this.clientHeight);for(const e in t.lines){const i=t.lines[e],s=this.$nodeMap[i.input.node],n=this.$nodeMap[i.output.node],o=t.nodes[i.input.node],h=t.nodes[i.output.node],r=s.getOutputOffset(i.input.param),a=n.getInputOffset(i.output.param),d={x:o.position.x+s.info.size.width/2,y:o.position.y-s.info.size.height/2+r},l={x:h.position.x-n.info.size.width/2,y:h.position.y-n.info.size.height/2+a};this._drawLine(d,l)}this._temporaryLine&&this._drawLine(this._temporaryLine.start,this._temporaryLine.end)}}_drawLine(t,e){const i={x:t.x,y:t.y},s={x:e.x,y:e.y},n={x:0,y:0},o={x:0,y:0};if(s.x-i.x>20){const t=-(i.x-s.x)/2;n.x=i.x+t,n.y=i.y,o.x=s.x-t,o.y=s.y}else n.x=i.x+20,n.y=i.y,o.x=s.x-20,o.y=s.y;i.x*=this.scale,n.x*=this.scale,o.x*=this.scale,s.x*=this.scale,i.y*=this.scale,n.y*=this.scale,o.y*=this.scale,s.y*=this.scale,i.x+=this.origin.x,n.x+=this.origin.x,o.x+=this.origin.x,s.x+=this.origin.x,i.y+=this.origin.y,n.y+=this.origin.y,o.y+=this.origin.y,s.y+=this.origin.y,this.lineCtx.strokeStyle="#d1d5e1",this.lineCtx.beginPath(),this.lineCtx.moveTo(i.x,i.y),this.lineCtx.bezierCurveTo(n.x,n.y,o.x,o.y,s.x,s.y),this.lineCtx.stroke()}_onMouseDown(t){const e=Object.assign({},this.origin),i=t.pageX,s=t.pageY,n=(t,i)=>{this.origin.x=e.x+t.x,this.origin.y=e.y+t.y,this.update()},o=t=>{const e={x:t.pageX-i,y:t.pageY-s};0===e.x&&0===e.y||n(e)},h=t=>{const e={x:t.pageX-i,y:t.pageY-s};n(e),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",h)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",h)}_onMouseWheel(t){t.deltaY<0?(this.scale*=1.1,this.scale>2&&(this.scale=2)):t.deltaY>0&&(this.scale*=.9,this.scale<.1&&(this.scale=.1)),this.update()}_onMouseUp(){this._moveNodeElement=null,this._temporaryLine=null,this.update()}_onDBClick(){this.addNode("testB")}}exports.NodeGraph=NodeGraph;