"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeGraphItem=void 0;const extension_1=require("./extension"),STYLE="<style>\n:host { display: flex; flex-direction: column; }\n:host:hover { opacity: 1; }\n:host > header { padding: 0 6px;text-overflow: ellipsis; overflow: hidden; }\n:host > section { display: flex; flex: 1; }\n:host > section > div { width: 15px; }\n:host > section > ui-panel { flex: 1; }\n\n.input > div { width: 6px; height: 6px; background: var(--color-danger-fill-weakest); border-radius: 6px; margin: 10px -3px; }\n.output > div { width: 6px; height: 6px; background: var(--color-warn-fill-weaker); border-radius: 6px; margin: 10px 13px; }\n\n.input > div:hover, .output > div:hover { box-shadow: 0px 0px 3px 3px #fff; }\n</style>",HTML='\n<header></header>\n<section>\n    <div class="input"></div>\n    <ui-panel></ui-panel>\n    <div class="output"></div>\n</section>\n',instanceArray=[];class NodeGraphItem extends HTMLElement{constructor(){super(),this._node={type:"",position:{x:0,y:0}},this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${HTML}`,this.$header=this.shadowRoot.querySelector("header"),this.$panel=this.shadowRoot.querySelector("ui-panel"),this.$input=this.shadowRoot.querySelector(".input"),this.$output=this.shadowRoot.querySelector(".output"),this.addEventListener("mousedown",this._onMouseDown))}get node(){return this._node}set node(t){this._node=t;const e=t.type;this.info=(0,extension_1.getTypeDefineInfo)(e),this.info.title&&(this.$header.innerHTML=this.info.title),this.render()}connectedCallback(){instanceArray.push(this),this.render()}disconnectedCallback(){const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["disabled","readonly","invalid"]}attributeChangedCallback(t,e,o){}render(){this._renderOption(),this._renderInput(),this._renderOutput()}updatePosition(t,e){cancelAnimationFrame(this._nextFrameUpdater),this._nextFrameUpdater=requestAnimationFrame(()=>{this.node.position.x=t,this.node.position.y=e;const o=this.$root.scale,i=this.$root.origin,n=this.clientWidth/2,s=this.clientHeight/2;this.style.transform=`translate(${i.x+t*o-n}px, ${i.y+e*o-s}px) scale(${o})`})}getInputOffset(t){const e=this.$input.querySelectorAll("div");for(let o=0;o<e.length;o++){if(e[o].id===t)return 16*o+14+24}return 0}getOutputOffset(t){const e=this.$output.querySelectorAll("div");for(let o=0;o<e.length;o++){if(e[o].id===t)return 16*o+14+24}return 0}_renderOption(){this.info&&(this.info.size&&(this.style.width=this.info.size.width?`${this.info.size.width}px`:"auto",this.style.height=this.info.size.height?`${this.info.size.height}px`:"auto"),this.info.panel&&this.$panel.setAttribute("src",this.info.panel))}_renderInput(){if(!this.info)return;const t=this.$input.querySelectorAll("div");let e=0;for(const o in this.info.input){let i=t[e++];i||(i=document.createElement("div"),this.$input.appendChild(i),i.addEventListener("mousedown",t=>{t.stopPropagation();const e=this.info,i=this.node,n=this.getInputOffset(o);this._onDragParam(t,o,void 0,{x:i.position.x-e.size.width/2,y:i.position.y-e.size.height/2+n})}),i.addEventListener("mouseup",t=>{const e=this.$root._moveNodeElement;if(e){if(this.$root._moveNodeElement=null,this.$root._temporaryLine=null,"input"===e.type)return void this.$root.update();this.$root.addLine(e.node.id,e.param,this.id,o)}})),i.id=o,i.info=this.info.input[o]}}_renderOutput(){if(!this.info)return;const t=this.$output.querySelectorAll("div");let e=0;for(const o in this.info.output){let i=t[e++];i||(i=document.createElement("div"),this.$output.appendChild(i),i.addEventListener("mousedown",t=>{t.stopPropagation();const e=this.info,i=this.node,n=this.getOutputOffset(o);this._onDragParam(t,o,{x:i.position.x+e.size.width/2,y:i.position.y-e.size.height/2+n},void 0)}),i.addEventListener("mouseup",t=>{const e=this.$root._moveNodeElement;if(e){if(this.$root._moveNodeElement=null,this.$root._temporaryLine=null,"output"===e.type)return void this.$root.update();this.$root.addLine(this.id,o,e.node.id,e.param)}})),i.id=o,i.info=this.info.output[o]}}_onMouseDown(t){t.stopPropagation(),t.preventDefault();const e=Object.assign({},this.node.position),o=t.pageX,i=t.pageY,n=(t,o)=>{this.updatePosition(e.x+t.x,e.y+t.y),this.$root._renderMesh(),this.$root._renderLines()},s=t=>{const e={x:(t.pageX-o)/this.$root.scale,y:(t.pageY-i)/this.$root.scale};0===e.x&&0===e.y||n(e)},r=t=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",r)}_onDragParam(t,e,o,i){t.stopPropagation(),t.preventDefault();const n=o||{x:0,y:0},s=i||{x:0,y:0};this.$root._temporaryLine={start:n,end:s},this.$root._moveNodeElement={type:o?"output":"input",node:this,param:e};const r=t.pageX,d=t.pageY,h=t=>{o?(s.x=n.x+t.x,s.y=n.y+t.y):(n.x=s.x+t.x,n.y=s.y+t.y),this.$root._renderLines()},a=t=>{const e={x:(t.pageX-r)/this.$root.scale,y:(t.pageY-d)/this.$root.scale};0===e.x&&0===e.y||h(e)},p=t=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",p),this.$root._moveNodeElement=null,this.$root._temporaryLine=null,this.$root._renderLines()};document.addEventListener("mousemove",a),document.addEventListener("mouseup",p)}}exports.NodeGraphItem=NodeGraphItem;