"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.File=void 0;const fs=require("fs"),I18n=require("@base/electron-i18n"),path=require("path"),electron_1=require("electron"),path_1=require("path"),menu_1=require("../../../../menu"),ipc=require("@base/electron-base-ipc"),base_1=require("../base"),fileUrl_1=require("./fileUrl"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./file.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./file.html"),"utf8")}`,instanceArray=[];let customStyle="";function translateAll(){instanceArray.forEach(t=>{t._placeholder(t.getAttribute("placeholder"))})}I18n.on("switch",translateAll);const defaultProtocol={label:"file://",path:"",protocol:"file",description:"",invalidInfo:""};class File extends base_1.Base{constructor(){super(),this.url=new fileUrl_1.FileUrl(this),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$input=this.shadowRoot.querySelector(".input"),this.$select=this.shadowRoot.querySelector(".select"),this.$open=this.shadowRoot.querySelector(".open"),this.$location=this.shadowRoot.querySelector(".location"),this.$input.$root=this.$select.$root=this.$open.$root=this.$location.$root=this,this.$input.addEventListener("confirm",this._onInputChange),this.$select.addEventListener("click",this._onSelectClick),this.$open.addEventListener("click",this._onOpenClick),this.$location.addEventListener("click",this._onLocationClick),this.$location.style.display="none",this.addEventListener("mousedown",this._onMouseDown))}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}static resolveToRaw(t){return fileUrl_1.fileUrlManager.resolveToRaw(t)}static resolveToUrl(t,e){return fileUrl_1.fileUrlManager.resolveToUrl(t,e)}static getAllProtocolInfos(){return[defaultProtocol,...fileUrl_1.fileUrlManager.getAllFileProtocol()]}get value(){return this.invalid?"":this.url&&this.url.toString()}set value(t){t?this.setAttribute("value",t):this.removeAttribute("value")}get type(){const t=this.getAttribute("type");return t?t.trim():t}set type(t){t?this.setAttribute("type",t):this.removeAttribute("type")}get extensions(){const t=this.getAttribute("extensions");return t?t.trim():t}set extensions(t){t?this.setAttribute("extensions",t):this.removeAttribute("extensions")}get multi(){return this.hasAttribute("multi")}set multi(t){t?this.setAttribute("multi",""):this.removeAttribute("multi")}get protocol(){return this.url.protocol||"file"}set protocol(t){this.url.protocol!==t&&(this.url.protocol=t,this._urlChange())}get _protocols(){const t=this.getAttribute("protocols");return t?t.split(",").map(t=>t.trim()):[]}toAbsolutePath(){return this.url.raw}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}this._protocols.length>0&&!this.multi&&(this.$location.style.display="flex",this.url.value?this.protocol=this.url.protocol||"file":this.protocol=this._protocols[0],this._urlChange())}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["focused","readonly","disabled","invalid","placeholder","value","type","extensions","multi"]}attributeChangedCallback(t,e,o){switch(super.attributeChangedCallback(t,e,o),t){case"value":path.isAbsolute(o)&&(this.protocol="file"),this._updateValue(o);break;case"placeholder":this._placeholder(o);break;case"readonly":this.$input.setAttribute("readonly",o)}}_onSelectClick(){var t;const e=this;e.$root.readonly||ipc.send("editor-lib-ui-kit:select-file",{type:e.$root.type,extensions:e.$root.extensions,multi:e.$root.multi,defaultPath:e.$root.url.raw||(null===(t=e.$root.url.protocolInfo)||void 0===t?void 0:t.path)||Editor.Project.path}).callback((t,o)=>{t?console.error(t):o&&(e.$root.url.protocolInfo?(e.$root.url.relPath=(0,path_1.relative)(e.$root.url.protocolInfo.path,o),e.$root._urlChange()):e.$root._updateValue(o),e.$root.dispatch("change"),e.$root.dispatch("confirm"))})}_onOpenClick(){fs.existsSync(this.$root.toAbsolutePath())?electron_1.shell.showItemInFolder(this.$root.toAbsolutePath()):Editor.Dialog.warn("File does not exist.")}_onLocationClick(t){const e=this;let o=File.getAllProtocolInfos();const i=e.$root._protocols;i.length&&(o=o.filter(t=>i.includes(t.protocol)),menu_1.Menu.popup({x:t.pageX,y:t.pageY,menu:o.map(t=>({label:t.protocol,type:"checkbox",checked:e.$root.protocol===t.protocol||!e.$root.protocol&&"file"===t.protocol,click(){e.$root.url.protocol=t.protocol,e.$root._urlChange(),e.$root.dispatch("change"),e.$root.dispatch("confirm")}}))}))}_onInputChange(t){this.$root.readonly||(this.$root.url.value=t.target.value,this.$root._updateValue(t.target.value),this.$root.dispatch("change"),this.$root.dispatch("confirm"))}_placeholder(t){t&&t.startsWith("i18n:")&&(t=t.replace(/i18n:([^\s]+)/g,(t,e)=>{let o=Editor.I18n.t(e);return o||(console.debug(`${e} is not defined in i18n`),o=e),o})),this.$input.placeholder=t||""}_updateValue(t){if(!t)return this.url.relPath="",void this._urlChange();this.url.value=t,this._urlChange()}_urlChange(){var t;this.$input.value=this.url.value,this.$location.value=(this.url.protocol||defaultProtocol.protocol)+"://",this.$location.setAttribute("tooltip",(null===(t=this.url.protocolInfo)||void 0===t?void 0:t.description)||defaultProtocol.description),this.url.invalid?(this.setAttribute("invalid","true"),this.url.protocolInfo&&this.$input.setAttribute("tooltip",this.url.protocolInfo.invalidInfo)):(this.removeAttribute("invalid"),this.$input.removeAttribute("tooltip"))}}exports.File=File;