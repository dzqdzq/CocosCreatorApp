"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Slider=void 0;const fs=require("fs"),path=require("path"),{mathUtils:mathUtils,domUtils:domUtils}=require("../../utils"),base_1=require("../base");let customStyle="";const CUSTOM_STYLE='<style id="custom-style"></style>',STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./slider.css"),"utf8")}</style>`,HTML=`${fs.readFileSync(path.join(__dirname,"./slider.html"),"utf8")}`,instanceArray=[],controlMouseEvent=function(t,i=!1){const e=i=>{if(t.dragging){t.isClick=!1,t.resetSize();const e=t.boundingClientRect;let s=0;"touchmove"===i.type&&(i.clientX=i.touches[0].clientX,i.clientY=i.touches[0].clientY),s=t.vertical?(e.bottom-i.clientY)/t.sliderSize*100:(i.clientX-e.left)/t.sliderSize*100;const n=t.positionToValue(s);t.value=n,t.dispatch("change")}},s=()=>{t.dragging&&(t.dragging=!1,t.dispatch("change"),t._confirm(),window.removeEventListener("mousemove",e),window.removeEventListener("touchmove",e),window.removeEventListener("mouseup",s),window.removeEventListener("touchend",s),window.removeEventListener("contextmenu",s))};domUtils.controlDragEvent(t.$track,{start:i=>{if(t.disabled||t.readonly)return;t.dragging=!0,t.isClick=!0,t.resetSize(),"touchstart"===i.type&&(i.clientX=i.touches[0].clientX,i.clientY=i.touches[0].clientY);const e=t.boundingClientRect;let s=0;if(t.vertical)s=(e.bottom-i.clientY)/t.sliderSize*100;else{const n=e.left;s=(i.clientX-n)/t.sliderSize*100}t._staging=t.value,t.value=t.positionToValue(s)},drag:e,end:s},i)};class Slider extends base_1.Base{constructor(){super(),this.dragging=!1,this.sliderSize=1,this._staging=null,this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$input=this.shadowRoot.querySelector(".input"),this.$cursor=this.shadowRoot.querySelector(".cursor"),this.$track=this.shadowRoot.querySelector(".track"),this.$wrapper=this.shadowRoot.querySelector(".wrapper"),this.$child=this.$input,this.$input.$root=this.$cursor.$root=this.$track.$root=this.$wrapper.$root=this)}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.dragging=!1,this.sliderSize=1,this.disabled&&this.$input.setAttribute("disabled",""),this.preci=parseInt(this.getAttribute("preci")||"",10)||mathUtils.comPreci(this.step),this.min=parseFloat(this.getAttribute("min")||"")||0,controlMouseEvent(this),this.$input.addEventListener("change",this._onInputChange),this.$input.addEventListener("confirm",this._onInputConfirm),this.$input.addEventListener("cancel",this._onInputCancel),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}this.updateCursorAndInput()}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1),controlMouseEvent(this,!0),this.$input.removeEventListener("change",this._onInputChange),this.$input.removeEventListener("confirm",this._onInputConfirm),this.$input.removeEventListener("cancel",this._onInputCancel)}static get observedAttributes(){return["min","max","height","path","preci","step","value","readonly","disabled","invalid"]}attributeChangedCallback(t,i,e){switch(super.attributeChangedCallback(t,i,e),t){case"invalid":process.nextTick(()=>{this.$input.invalid=null!==e});break;case"readonly":return void(null!==e?this.$input.setAttribute("readonly",""):this.$input.removeAttribute("readonly"));case"value":if(i===e)break;if(isNaN(e)){this.$input.value=0;break}if(mathUtils.clamp(e,this.min,this.max)!==parseFloat(e))break;e=parseFloat(e).toFixed(this.preci),this.updateCursorAndInput();break;case"preci":this.preci=parseInt(e,10),this.$input.preci=this.preci;break;case"step":this.$input.step=isNaN(e)?1:e;break;case"min":this.$input.min=isNaN(e)?0:e;break;case"max":this.$input.max=isNaN(e)?100:e}}get boundingClientRect(){return this.$track.getBoundingClientRect()}get currentPosition(){if("-"===this.value)return 0;return(Number(this.value)-this.min)/(this.max-this.min)*100}get disabled(){return this.hasAttribute("disabled")}set disabled(t){null!==t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get vertical(){return this.hasAttribute("vertical")}get height(){return this.getAttribute("height")}get value(){const t=this.getAttribute("value");if("-"===t)return t;let i=parseFloat(t||"");return isNaN(i)?0:i}set value(t){if("-"!==t){if(this.min>this.max)return void console.error("min should not be greater than max");"number"!=typeof t||isNaN(t)||(t=mathUtils.clamp(t,this.min,this.max))}this.setAttribute("value",String(t))}get min(){const t=this.getAttribute("min"),i=Number(t);return isNaN(i)?0:i}set min(t){this.setAttribute("min",String(t))}get max(){const t=this.getAttribute("max"),i=Number(t);return isNaN(i)||null===t?100:i}set max(t){this.setAttribute("max",String(t))}get step(){const t=this.getAttribute("step"),i=Number(t);return isNaN(i)||null===t?1:i}set step(t){this.setAttribute("step",String(t))}set preci(t){if(isNaN(t)||!(t>=0)||t>20){console.warn("preci only allows numbers between 0 and 20!");let t=mathUtils.comPreci(this.step);this.setAttribute("preci",t)}else;}get preci(){const t=this.getAttribute("preci")||"0";return parseInt(t,10)||mathUtils.comPreci(this.step)}_onFocus(t){super._onFocus(t),this.dragging||this.$input.$input.focus()}_onInputChange(){const t=this;t.$input.invalid&&(t.invalid=!1),t.$root.value=t.value,t.$root.updateCursorAndInput(),t.$root.dispatch("change")}_onInputConfirm(){this.$root.dispatch("confirm")}_onInputCancel(){this.$root.dispatch("cancel")}_onKeyDown(t){if(super._onKeyDown(t),!this.disabled&&!this.readonly)if(27===t.keyCode){if(this.dragging){if(domUtils.acceptEvent(t),this.dragging=!1,this._staging===this.value)return;this.value=this._staging||"",this.dispatch("change"),this.dispatch("cancel")}}else 13===t.keyCode&&(null===this.$input._staging?this.$input.focus():this.focus())}positionToValue(t){const i=mathUtils.clamp(t,0,100),e=100/((this.max-this.min)/this.step),s=Math.round(i/e)*e*(this.max-this.min)*.01+this.min;return parseFloat(s.toFixed(this.preci))}updateCursor(){const t=this.vertical?"bottom":"left";this.$cursor.style[t]=`${this.currentPosition}%`}updateCursorAndInput(){this.updateCursor(),this.$input.value=this.value}_confirm(){this._staging!==this.value&&(this._staging=String(this.value),this.dispatch("confirm"))}_parseInput(){if(null===this.$input.value||""===this.$input.value.trim())return this.value=this.min,this.min;const t=parseFloat(this.$input.value),i=isNaN(t)?this.$input._staging:mathUtils.clamp(t,this.min,this.max);this.value=parseFloat(i.toFixed(this.preci))}resetSize(){this.sliderSize=this.vertical?this.$track.clientHeight:this.$track.clientWidth}stepDown(t){this.$input.invalid&&(this.invalid=!1);let i=this.step;t.shiftKey&&(i*=10),this.value=mathUtils.clamp(Number(this.value)-i,this.min,this.max),this.dispatch("change")}stepUp(t){this.$input.invalid&&(this.invalid=!1);let i=this.step;t.shiftKey&&(i*=10),this.value=mathUtils.clamp(Number(this.value)+i,this.min,this.max),this.dispatch("change")}}exports.Slider=Slider;