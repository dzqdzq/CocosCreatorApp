"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ColorPicker=void 0;const fs=require("fs"),path=require("path"),Chroma=require("chroma-js"),base_1=require("../base"),{clamp:clamp,domUtils:domUtils}=require("../../utils"),Profile=require("@base/electron-profile"),CUSTOM_STYLE='<style id="custom-style"></style>',STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./color-picker.css"),"utf8")}</style>`,HTML=`${fs.readFileSync(path.join(__dirname,"./color-picker.html"),"utf8")}`,profile=Profile.load("global://editor/ui-kit.json"),instanceArray=[];let customStyle="";class ColorPicker extends base_1.Base{constructor(){super(),this._rgb=[],this._stagingRGBA=[],this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$hueHandle=this.shadowRoot.querySelector(".hue-handle"),this.$colorHandle=this.shadowRoot.querySelector(".color-handle"),this.$alphaHandle=this.shadowRoot.querySelector(".alpha-handle"),this.$hueCtrl=this.shadowRoot.querySelector(".hue.ctrl"),this.$colorCtrl=this.shadowRoot.querySelector(".color.ctrl"),this.$alphaCtrl=this.shadowRoot.querySelector(".alpha.ctrl"),this.$sliderR=this.shadowRoot.querySelector("#r-slider"),this.$sliderG=this.shadowRoot.querySelector("#g-slider"),this.$sliderB=this.shadowRoot.querySelector("#b-slider"),this.$sliderA=this.shadowRoot.querySelector("#a-slider"),this.$newColor=this.shadowRoot.querySelector("#new-color"),this.$oldColor=this.shadowRoot.querySelector("#old-color"),this.$hexInput=this.shadowRoot.querySelector("#hex-input"),this.$btnAdd=this.shadowRoot.querySelector(".add-presets"),this.$palette=this.shadowRoot.querySelector(".palette"),this.$presets=this.shadowRoot.querySelector(".presets"),this.$gamma=this.shadowRoot.querySelector(".gamma"),this.$hueHandle.$root=this.$colorHandle.$root=this.$alphaHandle.$root=this.$btnAdd.$root=this.$hueCtrl.$root=this.$colorCtrl.$root=this.$alphaCtrl.$root=this.$palette.$root=this,this.$gamma.$root=this.$sliderR.$root=this.$sliderG.$root=this.$sliderA.$root=this.$sliderB.$root=this.$newColor.$root=this.$oldColor.$root=this.$hexInput.$root=domUtils.$root=this,this._h=1,this._a=1,this._cl=0,this._ct=0,this._rgb=[255,0,0],this._stagingRGBA=[0,0,0,1],this._updateColorPresets())}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.addEventListener("focus",this._onFocus),this.$hueHandle.addEventListener("mousedown",this._onHueHandleMousedown),this.$hueCtrl.addEventListener("mousedown",this._hubCtrlMousedown),this.$alphaHandle.addEventListener("mousedown",this._onAlphaHandleMousedown),this.$alphaCtrl.addEventListener("mousedown",this._alphaCtrlMousedown),this.$colorHandle.addEventListener("mousedown",this._onColorHandleMousedown),this.$colorCtrl.addEventListener("mousedown",this._colorCtrlMousedown),this.$sliderR.addEventListener("change",this._onRSliderChange),this.$sliderG.addEventListener("change",this._onGSliderChange),this.$sliderB.addEventListener("change",this._onBSliderChange),this.$sliderA.addEventListener("change",this._onASliderChange),this.$hexInput.addEventListener("change",this._onHexInputChange),this.$sliderR.addEventListener("confirm",this._onConfirm),this.$sliderG.addEventListener("confirm",this._onConfirm),this.$sliderB.addEventListener("confirm",this._onConfirm),this.$sliderA.addEventListener("confirm",this._onConfirm),this.$hexInput.addEventListener("confirm",this._onConfirm),this.$btnAdd.addEventListener("click",this._onAddClick),this.$gamma.addEventListener("change",this._onGammaChange),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}this._updateHueHandle(),this._updateColorHandle(),this._updateAlphaHandle(),this._updateColor(),this._updateRGB(),this._updateA()}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1),this.removeEventListener("focus",this._onFocus),this.$hueHandle.removeEventListener("mousedown",this._onHueHandleMousedown),this.$hueCtrl.removeEventListener("mousedown",this._hubCtrlMousedown),this.$alphaHandle.removeEventListener("mousedown",this._onAlphaHandleMousedown),this.$alphaCtrl.removeEventListener("mousedown",this._alphaCtrlMousedown),this.$colorHandle.removeEventListener("mousedown",this._onColorHandleMousedown),this.$colorCtrl.removeEventListener("mousedown",this._colorCtrlMousedown),this.$sliderR.removeEventListener("change",this._onRSliderChange),this.$sliderG.removeEventListener("change",this._onGSliderChange),this.$sliderB.removeEventListener("change",this._onBSliderChange),this.$sliderA.removeEventListener("change",this._onASliderChange),this.$hexInput.removeEventListener("change",this._onHexInputChange),this.$sliderR.removeEventListener("confirm",this._onConfirm),this.$sliderG.removeEventListener("confirm",this._onConfirm),this.$sliderB.removeEventListener("confirm",this._onConfirm),this.$sliderA.removeEventListener("confirm",this._onConfirm),this.$hexInput.removeEventListener("confirm",this._onConfirm),this.$btnAdd.removeEventListener("click",this._onAddClick),this.$gamma.removeEventListener("change",this._onGammaChange)}static get observedAttributes(){return["focused","readonly","disabled","value","path"]}attributeChangedCallback(t,e,o){switch(super.attributeChangedCallback(t,e,o),t){case"value":this._rgb=JSON.parse(o),void 0===this._rgb[3]?(this._a=1,this._rgb[3]=1):this._rgb[3]=this._a=this._rgb[3]/255,this._staging(),this._updateHueAndColor(),this._updateHexAndColor(),this._updateHueHandle(),this._updateColorHandle(),this._updateAlphaHandle(),this._updateColor(),this._updateRGB(),this._updateA()}}get value(){return[this._rgb[0],this._rgb[1],this._rgb[2],Math.round(255*this._a)]}set value(t){const e=domUtils.getValidColor(t);this.setAttribute("value",JSON.stringify(e))}_onBlur(){const t=domUtils.getValidColor(this.value);this.setAttribute("value",JSON.stringify(t)),this.dispatch("confirm"),this._staging()}_onDisconnected(){const t=domUtils.getValidColor(this.value);this.setAttribute("value",JSON.stringify(t)),this.dispatch("confirm"),this._staging()}_onHueHandleMousedown(t){const e=this.$root,o=t.screenY,s=Math.round(parseInt(this.style.top||0)*e.$hueCtrl.clientHeight/100);function i(t){const i=t.screenY-o,r=Math.min(Math.max(s+i,0),e.$hueCtrl.clientHeight);e._h=1-r/e.$hueCtrl.clientHeight,e._updateHueHandle(),e._updateColor(),e._updateRGB(),e.dispatch("change")}document.addEventListener("mousemove",i),document.addEventListener("mouseup",function t(o){document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",t),e.dispatch("change"),e.dispatch("confirm")})}_hubCtrlMousedown(t){if(t.target!==this)return;this.$root._h=1-t.offsetY/this.clientHeight,this.$root._updateHueHandle(),this.$root._updateColor(),this.$root._updateRGB(),this.$root._onHueHandleMousedown.call(this.$root.$hueHandle,t)}_onAlphaHandleMousedown(t){const e=this.$root,o=t.screenY,s=Math.round(parseInt(this.style.top||0)*e.$alphaCtrl.clientHeight/100);function i(t){const i=t.screenY-o,r=Math.min(Math.max(s+i,0),e.$alphaCtrl.clientHeight);e._a=1-r/e.$alphaCtrl.clientHeight,e._updateAlphaHandle(),e._updateColor(),e._updateA(),e.dispatch("change")}document.addEventListener("mousemove",i),document.addEventListener("mouseup",function t(o){document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",t),e.dispatch("change"),e.dispatch("confirm")})}_alphaCtrlMousedown(t){if(t.target!==this)return;this.$root._a=1-t.offsetY/this.clientHeight,this.$root._updateAlphaHandle(),this.$root._updateColor(),this.$root._updateA(),this.$root._onAlphaHandleMousedown.call(this.$root.$alphaHandle,t)}_onColorHandleMousedown(t){const e=this.$root,o=t.pageX,s=t.pageY,i=Math.round(parseInt(this.style.top||0)*e.$colorCtrl.clientHeight/100),r=Math.round(parseInt(this.style.left||0)*e.$colorCtrl.clientWidth/100);function h(t){const h=t.pageX-o,n=t.pageY-s,a=Math.min(Math.max(i+n,0),e.$colorCtrl.clientHeight),l=Math.min(Math.max(r+h,0),e.$colorCtrl.clientWidth);e._cl=l/e.$colorCtrl.clientWidth,e._ct=a/e.$colorCtrl.clientHeight,e._updateColorHandle(),e._updateRGB(),e.dispatch("change")}document.addEventListener("mousemove",h),document.addEventListener("mouseup",function t(o){document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",t),e.dispatch("change"),e.dispatch("confirm")})}_colorCtrlMousedown(t){if(t.target!==this)return;this.$root._cl=t.offsetX/this.clientWidth,this.$root._ct=t.offsetY/this.clientHeight,this.$root._updateColorHandle(),this.$root._updateRGB(),this.$root._onColorHandleMousedown.call(this.$root.$colorHandle,t)}_onRSliderChange(t){this.$root._rgb[0]=Math.round(t.target.value),this.$root._updateHueAndColor(),this.$root.dispatch("change")}_onGSliderChange(t){this.$root._rgb[1]=Math.round(t.target.value),this.$root._updateHueAndColor(),this.$root.dispatch("change")}_onBSliderChange(t){this.$root._rgb[2]=Math.round(t.target.value),this.$root._updateHueAndColor(),this.$root.dispatch("change")}_onASliderChange(t){this.$root._a=t.target.value/255,this.$root._updateAlphaHandle(),this.$root._updateA(),this.$root.dispatch("change")}_onConfirm(){this.$root.dispatch("confirm")}_onKeyDown(t){switch(t.keyCode){case 27:this.value=[this._stagingRGBA[0],this._stagingRGBA[1],this._stagingRGBA[2],Math.round(255*this._stagingRGBA[3])],this.dispatch("cancel")}}_onHexInputChange(t){let e;try{e=Chroma(t.target.value).rgb()}catch(t){e=[255,255,255]}this.$root._rgb=[e[0],e[1],e[2]],this.$root._updateHexAndColor(),this.$root._updateHueHandle(),this.$root._updateColorHandle(),this.$root._updateColor(),this.$root._updateHueAndColor(),this.$root._updateRGB(),this.$root.dispatch("change")}_onGammaChange(t){this.$root._updateHexAndColor()}_updateColorPresets(){let t="";(profile.get("color-picker.staging-colors")||[]).forEach((e,o)=>{t+=`<div class="item" index="${o}" style="background-color: rgba(${e.toString()})"></div>`}),this.$presets.innerHTML=t;const e=this.$presets.querySelectorAll(".item");for(let t=0;t<e.length;t++){const o=e[t];o.$root=this,o.addEventListener("click",this._onPaletteClick),o.addEventListener("mousedown",this._onPaletteContextMenu)}}_onAddClick(){const t=profile.get("color-picker.staging-colors")||[],e=Chroma(this.$root.value,"rgb").rgb();e[3]=this.$root._a,t.push(e),profile.set("color-picker.staging-colors",t),profile.save(),this.$root._updateColorPresets();const{$presets:o}=this.$root;o.scrollLeft=o.scrollWidth}_onPaletteClick(t){const e=Chroma(t.target.style.backgroundColor).rgba();this.$root._rgb=[e[0],e[1],e[2]],this.$root._a=e[3],this.$root._updateHexAndColor(),this.$root._updateHueHandle(),this.$root._updateColorHandle(),this.$root._updateColor(),this.$root._updateAlphaHandle(),this.$root._updateA(),this.$root._updateHueAndColor(),this.$root._updateRGB(),this.$root.dispatch("change")}_onPaletteContextMenu(t){if(2!==t.button)return;t.stopPropagation();const e=this,o=profile.get("color-picker.staging-colors")||[],s=Number(e.getAttribute("index")),i=[{label:"Replace",click(){const t=Chroma(e.$root.value,"rgb").rgb();t[3]=e.$root._a,o.splice(s,1,t),profile.set("color-picker.staging-colors",o),profile.save(),e.$root._updateColorPresets()}},{label:"Delete",click(){o.splice(s,1),profile.set("color-picker.staging-colors",o),profile.save(),e.$root._updateColorPresets()}}];Editor.Menu.popup({menu:i})}_staging(){this._stagingRGBA=[this._rgb[0],this._rgb[1],this._rgb[2],this._a]}_updateHueHandle(){this.$hueHandle.style.top=Math.round(100*(1-this._h))+"%"}_updateAlphaHandle(){this.$alphaHandle.style.top=Math.round(100*(1-this._a))+"%"}_updateColorHandle(){this.$colorHandle.style.left=Math.round(100*this._cl)+"%",this.$colorHandle.style.top=Math.round(100*this._ct)+"%"}_updateColor(){const t=Chroma([369*this._h,1,1],"hsv").rgb();this.$colorCtrl.style.backgroundColor=`rgb(${t[0]}, ${t[1]}, ${t[2]})`}_updateRGB(){const t=Chroma([360*this._h,this._cl,1-this._ct],"hsv").rgb();this._rgb[0]=this.$sliderR.value=t[0],this._rgb[1]=this.$sliderG.value=t[1],this._rgb[2]=this.$sliderB.value=t[2],this._updateHexAndColor()}_updateA(){this.$sliderA.value=Math.round(255*this._a),this._updateHexAndColor()}_updateHueAndColor(){const t=Chroma(this._rgb,"rgb").hsv();isNaN(t[0])&&(t[0]=360),this._h=t[0]/360,this._cl=t[1],this._ct=1-t[2],this._updateHueHandle(),this._updateColor(),this._updateColorHandle(),this._updateHexAndColor()}_gamma(t){return Math.round(255*Math.pow(t/255,.45454545454545453))}_updateHexAndColor(){this.$gamma.value?(this.$newColor.style.backgroundColor=`rgba(${this._gamma(this._rgb[0])}, ${this._gamma(this._rgb[1])}, ${this._gamma(this._rgb[2])}, ${this._a})`,this.$oldColor.style.backgroundColor=`rgba(${this._gamma(this._stagingRGBA[0])}, ${this._gamma(this._stagingRGBA[1])}, ${this._gamma(this._stagingRGBA[2])}, ${this._stagingRGBA[3]})`):(this.$newColor.style.backgroundColor=`rgba(${this._rgb[0]}, ${this._rgb[1]}, ${this._rgb[2]}, ${this._a})`,this.$oldColor.style.backgroundColor=`rgba(${this._stagingRGBA[0]}, ${this._stagingRGBA[1]}, ${this._stagingRGBA[2]}, ${this._stagingRGBA[3]})`),this.$hexInput.value=Chroma(this._rgb).hex().toUpperCase(),this.$alphaCtrl.style.background=`linear-gradient(rgba(${this._rgb[0]}, ${this._rgb[1]}, ${this._rgb[2]}, 1), rgba(0, 0, 0, 0))`}}exports.ColorPicker=ColorPicker;