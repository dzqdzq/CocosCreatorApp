"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))(function(i,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Image=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base"),channel_1=require("./channel"),{DragArea:DragArea}=require("../drag/drag-area"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./image.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./image.html"),"utf8")}`,instanceArray=[];let customStyle="",srcTranslator=function(e){return e};class Image extends base_1.Base{constructor(){super(),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$img=this.shadowRoot.querySelector("img"),this.$canvas=this.shadowRoot.querySelector("canvas"),this.$area=this.shadowRoot.querySelector(".area ui-drag-area"),this.$placeholder=this.shadowRoot.querySelector(".area ui-drag-area .placeholder"),this.$canvas.$root=this.$img.$root=this.$area.$root=this)}static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),instanceArray.map(e=>{e.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}get size(){const e=this.getAttribute("size");return e?e.trim():""}set size(e){(e+="")?this.setAttribute("size",e):this.removeAttribute("size")}get placeholder(){const e=this.getAttribute("placeholder");return e?e.trim():""}set placeholder(e){e?this.setAttribute("placeholder",e):this.removeAttribute("placeholder")}get value(){const e=this.getAttribute("value");return e?e.trim():this.innerHTML.trim()}set value(e){(e+="")?this.setAttribute("value",e):this.removeAttribute("value")}get channel(){return this.hasAttribute("channel")?this.getAttribute("channel")||"rgb":""}set channel(e){null===e?this.removeAttribute("channel"):this.setAttribute("channel",e)}get src(){return this.$img.src}set src(e){const t=this.$area.getBoundingClientRect();if(!t.width&&t.height)this.$img.style.width="auto",this.$img.style.height="100%";else if(t.width&&!t.height)this.$img.style.width="100%",this.$img.style.height="auto";else{null!==this.getAttribute("fill")?(this.$img.style.width="100%",this.$img.style.height="100%"):(this.$area.style.display="flex",this.$img.style.maxWidth="100%",this.$img.style.maxHeight="100%",this.$img.style.margin="auto")}e?this.$img.src=e.replace("#","%23"):this.$img.removeAttribute("src"),this.channel&&this._updateChannel()}get droppable(){return this.$area.droppable}set droppable(e){this.$area.droppable=e}static setSrcTranslator(e){"function"==typeof e&&(srcTranslator=e)}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this._droppable=this.getAttribute("droppable")||"",this._placeholder=this.getAttribute("placeholder")||this._droppable||"NONE",this._droppable&&(this.$area.droppable=this._droppable),this._placeholder&&(this.$placeholder.innerHTML=this._placeholder),!this.value&&this.setAttribute("title",this._droppable),this.shadowRoot){const e=this.shadowRoot.querySelector("#custom-style");e&&(e.innerHTML=customStyle)}this.$area.addEventListener("dragover",this._onAreaDragOver),this.$area.addEventListener("dragleave",this._onAreaDragLeave),this.$area.addEventListener("drop",this._onAreaDrop)}disconnectedCallback(){super.disconnectedCallback();const e=instanceArray.indexOf(this);instanceArray.splice(e,1),this.$area.removeEventListener("dragover",this._onAreaDragOver),this.$area.removeEventListener("dragleave",this._onAreaDragLeave),this.$area.removeEventListener("drop",this._onAreaDrop),this.channelInstance&&(this.channelInstance.clear(),this.channelInstance=void 0)}static get observedAttributes(){return["readonly","placeholder","disabled","value","src","channel","droppable","size","path","fill"]}attributeChangedCallback(e,t,a){const r=Object.create(null,{attributeChangedCallback:{get:()=>super.attributeChangedCallback}});return __awaiter(this,void 0,void 0,function*(){switch(r.attributeChangedCallback.call(this,e,t,a),e){case"value":if(t===a)return;const i=yield srcTranslator.call(this,a);this.src=i.replace("#","%23"),this.$area.value!==a&&(this.$area.value=a),a||this.removeAttribute("value");break;case"droppable":this._droppable=a,this.$area.droppable=this._droppable;break;case"placeholder":this._placeholder=a||"NONE",this.$placeholder.innerHTML=this._placeholder;break;case"channel":this._updateChannel()}})}_onAreaDragOver(e){if(this.$root.disabled||this.$root.readonly)return;const t=e.dataTransfer.files,a=this.droppable.includes("file");this.$root.setAttribute("state",this.hoving||this.additional||a&&t.length?"allow":"refused")}_onAreaDragLeave(){this.$root.disabled||this.$root.readonly||this.$root.removeAttribute("state")}_onAreaDrop(e){const t=this;if(t.$root.disabled||t.$root.readonly)return;const a=t.$root.getAttribute("state");if(t.$root.removeAttribute("state"),"refused"===a)return;const r=e.dataTransfer.getData("value");if(r)return t.$root.value=r,t.$root.dispatch("confirm"),void(t.$root.invalid=!1);if(this.droppable.includes("file")&&e.dataTransfer.files.length){const a=e.dataTransfer.files[0];return t.$root.value=a.path,t.$root.dispatch("confirm"),void(t.$root.invalid=!1)}if(t.hoving||t.additional){const e=t.droppable,a=DragArea.currentDragInfo.additional;if(a)for(const r of a)if(e.includes(r.type))return t.$root.value=r.value,t.$root.dispatch("confirm"),void(t.$root.invalid=!1)}}_updateChannel(){this.channelInstance||(this.channelInstance=new channel_1.Channel(this)),this.channelInstance.update()}}exports.Image=Image;