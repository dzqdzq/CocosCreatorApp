"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CurveEditor=void 0;const tooltip_1=require("../tooltip"),curve_ctrl_1=require("./lib/curve-ctrl"),fs=require("fs"),path=require("path"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./curve-editor.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./curve-editor.html"),"utf8")}`,customStyle="";class CurveEditor extends HTMLElement{constructor(){super(),this.config={type:"hermit",showPreWrapMode:!1,showPostWrapMode:!1,axisMargin:30,showXLabel:!0,showYLabel:!0,showXLine:!0,showYLine:!0,startXOffset:0,startYOffset:0,handlerSize:45,gridColor:"#333846",sample:1},this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$curveLabelX=this.shadowRoot.querySelector(".x-axis"),this.$curveLabelY=this.shadowRoot.querySelector(".y-axis"),this.$ctrlCanvas=this.shadowRoot.querySelector(".ctrl"))}set value(t){this._value=t,this._render(t)}get value(){return this.curveCtrl?this.curveCtrl.getCurrentCurveInfo():this._value}set focused(t){(t=!!t)?this.$ctrlCanvas.setAttribute("focused",""):this.$ctrlCanvas.removeAttribute("focused"),this.dispatch("focus-changed")}get disabled(){return null!==this.getAttribute("disabled")}set disabled(t){(t=!!t)?(this.setAttribute("disabled",""),this.$ctrlCanvas.setAttribute("tabindex","-1")):(this.removeAttribute("disabled"),this.$ctrlCanvas.setAttribute("tabindex","0"))}get readonly(){return null!==this.getAttribute("readonly")}set readonly(t){(t=!!t)?this.setAttribute("readonly",""):this.removeAttribute("readonly")}get sample(){return this.hasAttribute("sample")?parseInt(this.getAttribute("sample")):1}set sample(t){t?this.setAttribute("sample",t+""):this.removeAttribute("sample")}connectedCallback(){const t=null!==this.getAttribute("disabled"),e=this.getAttribute("tabindex")||"0";if(this.setAttribute("tabindex",t?"-1":e),!this.shadowRoot)return;const i=this.shadowRoot.querySelector("#custom-style");if(i&&(i.innerHTML=customStyle),this.hasAttribute("config")){const t=this.getAttribute("config");if(t)try{const e=JSON.parse(t);this.config=Object.assign(this.config,e)}catch(t){console.log(t)}this.initCurveCtrl()}if(this.hasAttribute("value"))try{const t=JSON.parse(this.getAttribute("value"));this.value=t}catch(t){console.debug(t)}tooltip_1.Tooltip.bind(this)}disconnectedCallback(){this.curveCtrl&&this.curveCtrl.unregisterHandler()}static get observedAttributes(){return["focused","readonly","disabled","value","sample"]}attributeChangedCallback(t,e,i){switch(t){case"readonly":this.curveCtrl.readonly=!!i;break;case"value":if(!this.curveCtrl)break;try{const t=JSON.parse(i);this._render(t)}catch(t){console.debug(t)}break;case"sample":this.curveCtrl&&this.curveCtrl.updateSample(parseInt(i))}}resize(t,e){this.curveCtrl&&(this.curveCtrl.resize(t,e),this.curveCtrl.rePaint())}rePaint(){this.curveCtrl&&this.curveCtrl.rePaint()}setConfig(t){this.config=t,this.initCurveCtrl(),this.value&&this._render(this.value)}initCurveCtrl(){const t={showLabel:this.config.showYLabel,showLine:this.config.showYLine,lineColor:this.config.gridColor},e={gridConfig:{axisXConfig:Object.assign({$container:this.config.showXLabel?this.$curveLabelX:void 0,maxValue:this.config.xRange&&this.config.xRange[1],minValue:this.config.xRange&&this.config.xRange[0],format:this.config.xFormat,startOffset:this.config.startXOffset,precision:this.config.precisionX},t),axisYConfig:Object.assign({$container:this.config.showYLabel?this.$curveLabelY:void 0,maxValue:this.config.yRange&&this.config.yRange[1],minValue:this.config.yRange&&this.config.yRange[0],format:this.config.yFormat,precision:this.config.precisionY},t),axisMargin:this.config.axisMargin,negative:this.config.negative},handlerSize:this.config.handlerSize,spacingFrame:this.config.spacingFrame,sample:this.config.sample};this.config.showXLabel||(this.$curveLabelX.innerHTML=""),this.config.showYLabel||(this.$curveLabelY.innerHTML=""),this.curveCtrl?this.curveCtrl.resetConfig(e):(this.$ctrlCanvas.width=this.clientWidth,this.$ctrlCanvas.height=this.clientHeight,this.curveCtrl=new curve_ctrl_1.CurveCtrl(this.$ctrlCanvas,e),this.curveCtrl.on("change",()=>this.dispatch("change")),this.curveCtrl.on("confirm",()=>this.dispatch("confirm")),this.curveCtrl.on("transform",()=>this.dispatch("transform")))}setDisplayRange(t,e){this.curveCtrl.setDisplayRange(t,e)}clear(){this.curveCtrl&&this.curveCtrl.clearAll()}_render(t){t&&t.curveInfos?this.curveCtrl.paint(t):(this.curveCtrl.clearAll(),this.curveCtrl.grid.render())}dispatch(t){const e=document.createEvent("HTMLEvents");e.initEvent(t,!0,!0),this.dispatchEvent(e)}}exports.CurveEditor=CurveEditor;