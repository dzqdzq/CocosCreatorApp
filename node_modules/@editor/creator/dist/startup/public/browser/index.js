"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function o(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),fs_extra_1=require("fs-extra"),app_1=require("../../../app"),task_1=require("../../../task"),i18n_1=require("../../../i18n"),package_1=require("../../../package"),browser_1=require("../../../project/protected/browser"),windows_1=require("../../../windows"),layout_1=require("../../../layout"),path_2=require("path"),init_1=require("./init"),events_1=require("events"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Metrics=require("../../../metrics/protected/browser"),User=require("../../../user/browser");class Startup extends events_1.EventEmitter{constructor(...e){super(...e),this.ready={window:!1,package:!1},this._builtinJSON=init_1.builtin}window(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Waiting windows");try{e.beforeOpen&&windows_1.Windows.__protected__.setBeforeOpenHook(e.beforeOpen),e.afterOpen&&windows_1.Windows.__protected__.setAfterOpenHook(e.afterOpen);const t=yield windows_1.Windows.__protected__.startup(),r=windows.uuid2win[t[0]];r&&(app_1.App.__userAgent=r.webContents.getUserAgent())}catch(e){console.error(e)}finally{this.ready.window=!0,this.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")})}manager(e,t){var r,a;return __awaiter(this,void 0,void 0,function*(){if(task_1.Task.addSyncTask("Starting Manager"),yield(0,browser_1.init)(),e?User.skip():yield User.init(),null===(r=this._builtinJSON.env)||void 0===r?void 0:r.LAYOUT)try{const e=(0,fs_extra_1.readJSONSync)(this._builtinJSON.env.LAYOUT);layout_1.Layout.__protected__.init(e)}catch(e){console.warn(e)}(null===(a=this._builtinJSON.env)||void 0===a?void 0:a.LANGUAGE)&&i18n_1.I18n.select(this._builtinJSON.env.LANGUAGE);try{yield Metrics.init(t)}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100000:1}}),task_1.Task.removeSyncTask("Starting Manager")})}package(e={}){return __awaiter(this,void 0,void 0,function*(){let t;task_1.Task.addSyncTask("Starting Package");try{if(t=init_1.builtin.disableBuiltin,Array.isArray(init_1.builtin.extensions))for(let e of init_1.builtin.extensions)(0,path_2.isAbsolute)(e)||(e=(0,path_1.join)(app_1.App.path,"..",e)),yield package_1.Package.register(e)}catch(e){console.error(e)}Array.isArray(t)||(t=[]);try{e.preList=e.preList||[],e.list=e.list||[];for(let t=0;t<e.preList.length;t++){const r=e.preList[t],a=(0,path_1.basename)(r);task_1.Task.addSyncTask(`startup.${a}`,i18n_1.I18n.t("startup.load_package",{name:a}));try{yield package_1.Package.register(r),yield package_1.Package.enable(r)}catch(e){console.error(`[Package] Register error: ${r}`),console.error(e)}task_1.Task.removeSyncTask(`startup.${a}`)}for(let t=0;t<e.list.length;t++){const r=e.list[t];try{yield package_1.Package.register(r)}catch(e){console.error(`[Package] Register error: ${r}`),console.error(e)}}task_1.Task.addSyncTask("startup.PckageManager","Scan Extensions"),yield package_1.Package.__protected__.startup((t,r)=>__awaiter(this,void 0,void 0,function*(){if(!e.preList.includes(r)){task_1.Task.addSyncTask(`startup.${t}`,i18n_1.I18n.t("startup.load_package",{name:t}));try{yield new Promise(e=>{setTimeout(e,20)}),yield package_1.Package.enable(r)}catch(e){console.error(`[Package] Enable error: ${r}`),console.error(e)}task_1.Task.removeSyncTask(`startup.${t}`)}})),task_1.Task.removeSyncTask("startup.PckageManager")}catch(e){console.error(e)}finally{this.ready.package=!0,this.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")})}build(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,a)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return a(e);r(t)})})})}test(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,a)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return a(e);r(t)})})})}}module.exports=new Startup,ipc.on("editor3d-lib-startup:get",(e,t)=>module.exports[t]);