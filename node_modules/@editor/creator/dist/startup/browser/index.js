"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(a,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function o(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),app_1=require("../../app"),task_1=require("../../task"),i18n_1=require("../../i18n"),Package=require("../../package/browser/index"),Windows=require("../../windows/browser/index"),Menu=require("../../menu/browser/index"),fs_extra_1=require("fs-extra"),path_1=require("path"),{EventEmitter:EventEmitter}=require("events"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Metrics=require("../../metrics/browser/index"),Project=require("../../project/browser/index"),User=require("../../user/browser/index"),preBuiltin=["menu","profile","project","messages","program","tester","preferences","engine","programming"],postBuiltin=["asset-db","scene","server","utils","preview","animator","builder","shortcuts","animation-graph"];class Startup extends EventEmitter{constructor(){super(),this.ready={window:!1,package:!1}}window(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Waiting windows");try{const t=yield Windows.restore(e),r=windows.uuid2win[t[0]];r&&(app_1.App.__userAgent=r.webContents.getUserAgent())}catch(e){console.error(e)}finally{this.ready.window=!0,this.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")})}manager(e,t){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Starting Manager"),yield Project.init(),e?User.skip():yield User.init();try{yield Metrics.init(t)}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100000:1}}),task_1.Task.removeSyncTask("Starting Manager")})}package(e){return __awaiter(this,void 0,void 0,function*(){e=e||{},task_1.Task.addSyncTask("Starting Package");try{for(let e=0;e<preBuiltin.length;e++){const t=preBuiltin[e],r=ps.join(Editor.App.path,`./builtin/${t}`);try{task_1.Task.addSyncTask(`startup.${t}`,i18n_1.I18n.t("startup.load_package",{name:t})),yield Package.register(r),yield Package.enable(r),task_1.Task.removeSyncTask(`startup.${t}`)}catch(e){console.error(`[Package] Register error: ${r}`),console.error(e)}}yield Package.register(ps.join(Editor.App.path,"./modules/editor-extensions/extensions/device")),yield Package.register(ps.join(Editor.App.path,"./modules/editor-extensions/extensions/ui-kit")),yield Package.scan(ps.join(Editor.App.path,"./modules/engine-extensions/extensions"));for(let e=0;e<postBuiltin.length;e++){const t=ps.join(Editor.App.path,`./builtin/${postBuiltin[e]}`);try{yield Package.register(t)}catch(e){console.error(`[Package] Register error: ${t}`),console.error(e)}}let t;yield Package.scan(ps.join(Editor.App.path,"./modules/editor-extensions/extensions")),yield Package.scan(ps.join(Editor.App.path,"./modules/platform-extensions/extensions"));try{const e=ps.join(Editor.App.path,"../builtin.json");if((0,fs_extra_1.existsSync)(e)){const r=yield(0,fs_extra_1.readJSON)(e);if(t=r.disableBuiltin,Array.isArray(r.extensions))for(let e of r.extensions)(0,path_1.isAbsolute)(e)||(e=ps.join(Editor.App.path,"..",e)),yield Package.register(e)}}catch(e){console.error(e)}yield Package.scan(ps.join(Editor.App.path,"./extension")),yield Package.scan(ps.join(Editor.App.home,"extensions")),yield Package.scan(ps.join(setting.PATH.PROJECT,"extensions")),this.emit("package-scanned-ready"),ipc.broadcast("editor3d-lib-startup:emit","package-scanned"),Array.isArray(t)||(t=[]),yield Package.beforeStartup(e.disable||[]),yield Package.startup(t,function(t,r){return __awaiter(this,void 0,void 0,function*(){if(e.disable&&e.disable.includes(r))return;task_1.Task.addSyncTask(`startup.${t}`,i18n_1.I18n.t("startup.load_package",{name:t})),yield new Promise(e=>{setTimeout(e,20)});const i=(yield Package.enable(r)).json;i.creator&&i.creator.flags&&i.creator.flags.disableMainMenu&&Menu.disconnectMainMenu(),task_1.Task.removeSyncTask(`startup.${t}`)})})}catch(e){console.error(e)}finally{this.ready.package=!0,this.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")})}build(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,i)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return i(e);r(t)})})})}test(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((r,i)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return i(e);r(t)})})})}}module.exports=new Startup,ipc.on("editor3d-lib-startup:ready",(e,t)=>module.exports.ready[t]);