"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(a,s){function n(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),app_1=require("../../app"),task_1=require("../../task"),i18n_1=require("../../i18n"),Package=require("../../package/browser/index"),Windows=require("../../windows/browser/index"),Metrics=require("../../metrics/browser/index"),fs_extra_1=require("fs-extra"),path_1=require("path"),{EventEmitter:EventEmitter}=require("events"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Project=require("../../project/browser/index"),User=require("../../user/browser/index"),preBuiltin=["menu","profile","project","messages","program","tester","preferences","engine","programming"],postBuiltin=["asset-db","scene","server","utils","preview","animator","builder","shortcuts","animation-graph","runtime-dev-tools","channel-upload-tools"];class Startup extends EventEmitter{constructor(){super(),this.ready={window:!1,package:!1}}window(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Waiting windows");try{const e=yield Windows.restore(),t=windows.uuid2win[e[0]];t&&(app_1.App.__userAgent=t.webContents.getUserAgent())}catch(e){console.error(e)}finally{this.ready.window=!0,this.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")})}manager(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Starting Manager"),yield Project.init(),e?User.skip():yield User.init();try{yield Metrics.init()}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),task_1.Task.removeSyncTask("Starting Manager")})}package(){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Starting Package");try{for(let e=0;e<preBuiltin.length;e++){const t=preBuiltin[e],i=ps.join(Editor.App.path,`./builtin/${t}`);try{task_1.Task.addSyncTask(`startup.${t}`,i18n_1.I18n.t("startup.load_package",{name:t})),yield Package.register(i),yield Package.enable(i),task_1.Task.removeSyncTask(`startup.${t}`)}catch(e){console.error(`[Package] Register error: ${i}`),console.error(e)}}yield Package.register(ps.join(Editor.App.path,"./modules/editor-extensions/extensions/device")),yield Package.register(ps.join(Editor.App.path,"./modules/editor-extensions/extensions/ui-kit")),yield Package.scan(ps.join(Editor.App.path,"./modules/engine-extensions/extensions"));for(let e=0;e<postBuiltin.length;e++){const t=ps.join(Editor.App.path,`./builtin/${postBuiltin[e]}`);try{yield Package.register(t)}catch(e){console.error(`[Package] Register error: ${t}`),console.error(e)}}let e;yield Package.scan(ps.join(Editor.App.path,"./modules/editor-extensions/extensions")),yield Package.scan(ps.join(Editor.App.path,"./modules/platform-extensions/extensions"));try{const t=ps.join(Editor.App.path,"../builtin.json");if((0,fs_extra_1.existsSync)(t)){const i=yield(0,fs_extra_1.readJSON)(t);if(e=i.disableBuiltin,Array.isArray(i.extensions))for(let e of i.extensions)(0,path_1.isAbsolute)(e)||(e=ps.join(Editor.App.path,"..",e)),yield Package.register(e)}}catch(e){console.error(e)}yield Package.scan(ps.join(Editor.App.path,"./extension")),yield Package.scan(ps.join(Editor.App.home,"extensions")),yield Package.scan(ps.join(setting.PATH.PROJECT,"extensions")),this.emit("package-scanned-ready"),ipc.broadcast("editor3d-lib-startup:emit","package-scanned"),Array.isArray(e)||(e=[]),yield Package.startup(e,function(e,t){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask(`startup.${e}`,i18n_1.I18n.t("startup.load_package",{name:e})),yield new Promise(e=>{setTimeout(e,20)}),yield Package.enable(t),task_1.Task.removeSyncTask(`startup.${e}`)})})}catch(e){console.error(e)}finally{this.ready.package=!0,this.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")})}build(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,r)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return r(e);i(t)})})})}test(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,r)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return r(e);i(t)})})})}}module.exports=new Startup,ipc.on("editor3d-lib-startup:ready",(e,t)=>module.exports.ready[t]);