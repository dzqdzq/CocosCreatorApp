"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(a,n){function s(e){try{c(r.next(e))}catch(e){n(e)}}function o(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(s,o)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),app_1=require("../../app"),task_1=require("../../task"),I18n=require("../../i18n/browser/index"),Package=require("../../package/browser/index"),Windows=require("../../windows/browser/index"),Menu=require("../../menu/browser/index"),path_1=require("path"),init_1=require("./init"),{EventEmitter:EventEmitter}=require("events"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Metrics=require("../../metrics/browser/index"),Project=require("../../project/browser/index"),User=require("../../user/browser/index"),preBuiltin=["menu","profile","project","messages","program","tester","preferences","engine","programming"],postBuiltin=["asset-db","scene","server","utils","preview","animator","builder","shortcuts","animation-graph"];class Startup extends EventEmitter{constructor(...e){super(...e),this.ready={window:!1,package:!1},this._builtinJSON=init_1.builtin}window(e){return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Waiting windows");try{const t=yield Windows.restore(e),i=windows.uuid2win[t[0]];i&&(app_1.App.__userAgent=i.webContents.getUserAgent())}catch(e){console.error(e)}finally{this.ready.window=!0,this.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")})}manager(e,t){var i;return __awaiter(this,void 0,void 0,function*(){task_1.Task.addSyncTask("Starting Manager"),yield Project.init(),e?User.skip():yield User.init(),(null===(i=this._builtinJSON.env)||void 0===i?void 0:i.LANGUAGE)&&I18n.select(this._builtinJSON.env.LANGUAGE),I18n.init();try{yield Metrics.init(t)}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100000:1}}),task_1.Task.removeSyncTask("Starting Manager")})}package(e){return __awaiter(this,void 0,void 0,function*(){let t;e=e||{},task_1.Task.addSyncTask("Starting Package");try{if(t=init_1.builtin.disableBuiltin,Array.isArray(init_1.builtin.extensions))for(let e of init_1.builtin.extensions)(0,path_1.isAbsolute)(e)||(e=ps.join(app_1.App.path,"..",e)),yield Package.register(e)}catch(e){console.error(e)}Array.isArray(t)||(t=[]);try{for(let e=0;e<preBuiltin.length;e++){const i=preBuiltin[e];if(t.includes(i))continue;const r=ps.join(app_1.App.path,`./builtin/${i}`);try{task_1.Task.addSyncTask(`startup.${i}`,I18n.t("startup.load_package",{name:i})),yield Package.register(r),yield Package.enable(r),task_1.Task.removeSyncTask(`startup.${i}`)}catch(e){console.error(`[Package] Register error: ${r}`),console.error(e)}}yield Package.register(ps.join(app_1.App.path,"./modules/editor-extensions/extensions/device")),yield Package.register(ps.join(app_1.App.path,"./modules/editor-extensions/extensions/ui-kit")),yield Package.scan(ps.join(app_1.App.path,"./modules/engine-extensions/extensions"));for(let e=0;e<postBuiltin.length;e++){const t=ps.join(app_1.App.path,`./builtin/${postBuiltin[e]}`);try{yield Package.register(t)}catch(e){console.error(`[Package] Register error: ${t}`),console.error(e)}}yield Package.scan(ps.join(app_1.App.path,"./modules/editor-extensions/extensions")),yield Package.scan(ps.join(app_1.App.path,"./modules/platform-extensions/extensions")),yield Package.scan(ps.join(app_1.App.path,"./extension")),yield Package.scan(ps.join(app_1.App.home,"extensions")),yield Package.scan(ps.join(setting.PATH.PROJECT,"extensions")),this.emit("package-scanned-ready"),ipc.broadcast("editor3d-lib-startup:emit","package-scanned"),Array.isArray(t)||(t=[]),yield Package.beforeStartup(e.disable||[]),yield Package.startup(t,function(t,i){return __awaiter(this,void 0,void 0,function*(){if(e.disable&&e.disable.includes(i))return;task_1.Task.addSyncTask(`startup.${t}`,I18n.t("startup.load_package",{name:t})),yield new Promise(e=>{setTimeout(e,20)});const r=(yield Package.enable(i)).json;r.creator&&r.creator.flags&&r.creator.flags.disableMainMenu&&Menu.disconnectMainMenu(),task_1.Task.removeSyncTask(`startup.${t}`)})})}catch(e){console.error(e)}finally{this.ready.package=!0,this.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")})}build(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,r)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return r(e);i(t)})})})}test(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((i,r)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return r(e);i(t)})})})}}module.exports=new Startup,ipc.on("editor3d-lib-startup:get",(e,t)=>module.exports[t]);