"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.once=exports.on=exports.test=exports.build=exports.startPackage=exports.manager=exports.window=exports.init=exports._builtinJSON=exports.ready=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),app_1=require("../../../app"),task_1=require("../../../task"),i18n_1=require("../../../i18n"),package_1=require("../../../package"),browser_1=require("../../../project/protected/browser"),windows_1=require("../../../windows"),layout_1=require("../../../layout"),path_2=require("path"),init_1=require("./init"),events_1=require("events"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Metrics=require("../../../metrics/protected/browser"),emitter=new events_1.EventEmitter;function init(e){return(0,init_1.init)(e)}async function window(e){task_1.Task.addSyncTask("Waiting windows");try{e.beforeOpen&&windows_1.Windows.__protected__.setBeforeOpenHook(e.beforeOpen),e.afterOpen&&windows_1.Windows.__protected__.setAfterOpenHook(e.afterOpen);var t=await windows_1.Windows.__protected__.startup(),r=windows.uuid2win[t[0]];r&&(app_1.App.__userAgent=r.webContents.getUserAgent())}catch(e){console.error(e)}finally{exports.ready.window=!0,emitter.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")}async function manager(e,t){if(task_1.Task.addSyncTask("Starting Manager"),await(0,browser_1.init)(),e?Editor.User.skip():await Editor.User.__protected__.init(),exports._builtinJSON.env?.LAYOUT)try{var r=(0,fs_extra_1.readJSONSync)(exports._builtinJSON.env.LAYOUT);layout_1.Layout.__protected__.init(r)}catch(e){console.warn(e)}exports._builtinJSON.env?.LANGUAGE&&i18n_1.I18n.select(exports._builtinJSON.env.LANGUAGE);try{await Metrics.init(t)}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100000:1}}),task_1.Task.removeSyncTask("Starting Manager")}async function startPackage(r={}){task_1.Task.addSyncTask("Starting Package");let a=init_1.builtin.disableBuiltin;try{if(Array.isArray(init_1.builtin.extensions))for(var e of init_1.builtin.extensions)(0,path_2.isAbsolute)(e)||(e=(0,path_1.join)(app_1.App.path,"..",e)),await package_1.Package.register(e)}catch(e){console.error(e)}Array.isArray(a)||(a=[]);try{r.preList=r.preList||[],r.list=r.list||[];for(let e=0;e<r.preList.length;e++){var t=r.preList[e],i=(0,path_1.basename)(t);if(!a.includes(i)){task_1.Task.addSyncTask("startup."+i,i18n_1.I18n.t("startup.load_package",{name:i}));try{await package_1.Package.register(t),await package_1.Package.enable(t)}catch(e){console.error("[Package] Register error: "+t),console.error(e)}task_1.Task.removeSyncTask("startup."+i)}}for(let e=0;e<r.list.length;e++){var n=r.list[e];try{await package_1.Package.register(n)}catch(e){console.error("[Package] Register error: "+n),console.error(e)}}task_1.Task.addSyncTask("startup.PckageManager","Scan Extensions"),await package_1.Package.__protected__.startup(async(e,t)=>{if(!r.preList.includes(t)&&!a.includes(e)){task_1.Task.addSyncTask("startup."+e,i18n_1.I18n.t("startup.load_package",{name:e}));try{await new Promise(e=>{setTimeout(e,20)}),await package_1.Package.enable(t)}catch(e){console.error("[Package] Enable error: "+t),console.error(e)}task_1.Task.removeSyncTask("startup."+e)}}),task_1.Task.removeSyncTask("startup.PckageManager")}catch(e){console.error(e)}finally{exports.ready.package=!0,emitter.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")}async function build(e,t){return new Promise((r,a)=>{pkg.exec("builder","command-build",e,t).callback((e,t)=>{if(e)return a(e);r(t)})})}async function test(e,t){return new Promise((r,a)=>{pkg.exec("tester","auto-test",e,t).callback((e,t)=>{if(e)return a(e);r(t)})})}function on(e,t){emitter.on(e,t)}function once(e,t){emitter.once(e,t)}function removeListener(e,t){emitter.removeListener(e,t)}exports.ready={window:!1,package:!1},exports._builtinJSON=init_1.builtin,exports.init=init,exports.window=window,exports.manager=manager,exports.startPackage=startPackage,exports.build=build,exports.test=test,exports.on=on,exports.once=once,exports.removeListener=removeListener,ipc.on("editor3d-lib-startup:get",(e,t)=>module.exports[t]);