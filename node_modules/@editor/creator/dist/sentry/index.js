"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setUserInfo=exports.init=exports.sentry=void 0;const setting=require("@editor/setting"),Sentry=require("@sentry/electron"),app_1=require("./../app"),fs_extra_1=require("fs-extra"),path_1=require("path"),v_stacks_1=require("v-stacks");class SentryManager{constructor(){this._hasInit=!1,this._scope=Sentry.getCurrentScope(),this.enable=!0,this.skipTags=["[PreviewInEditor]","[Scene]","[Programming]"]}init(){if(this._hasInit||!this.enable)return;try{const e=(0,fs_extra_1.readJSONSync)((0,path_1.join)(setting.PATH.HOME,"profiles/v2/packages/utils.json")),t=e&&e.features&&e.features.logger;if(t&&(this.enable=t.enabled||!0,this.skipTags=Array.isArray(t.skipTags)?t.skipTags:this.skipTags),!this.enable)return}catch(e){}let e,t="https://d1228c9c9d49468a9f6795d0f8f66df3@sentry.cocos.org/11";try{const s=require((0,path_1.join)(app_1.App.path,"package.json"));s.sentryDSN&&(t=s.sentryDSN)}catch(t){e=t}const s=require("@sentry/utils"),n=s.normalize;s.normalize=function(e,t=100,s=1/0){return 20===t&&2e3===s&&(t=5),n(e,t,s)},this._scope=Sentry.getCurrentScope(),Sentry.init({dsn:t,release:setting.version,debug:!!setting.dev,sampleRate:.5,environment:app_1.App.isPackaged?"production":"development"});try{if(app_1.App.isPackaged){const e=(0,fs_extra_1.readJSONSync)((0,path_1.join)(app_1.App.path,".HEAD"));this._scope.setExtras({"release-date":new Date(e.time).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),"editor-hash":e.editor,"engine-hash":e.engine})}}catch(e){Sentry.captureException(e)}if("browser"===process.type){function r(e){const t=e.split("\n")[1];return t&&t.includes("node_modules/@sentry")?(0,v_stacks_1.ignoreStack)(e,1):e}const e=this.skipTags,t=console.error.bind(console);console.error=function(s,...n){(null===(s="string"==typeof s?new Error(s):s)||void 0===s?void 0:s.message)&&e.filter(e=>s.message.startsWith(e)).length>0||Sentry.captureException(s),s&&s.stack&&(s.stack=r(s.stack)),t(s,...n)};const s=console.warn.bind(console);console.warn=function(e,...t){e&&e.stack&&(e.stack=r(e.stack)),s(e,...t)}}e&&Sentry.captureException(e),this._hasInit=!0,console.debug("init **** success")}setUserInfo(e){console.debug("start **** info"),e?this._scope.setUser({email:e.email,username:e.nickname,id:e.cocos_uid}):this._scope.setUser({email:"",username:"",id:""})}catchException(e){if(this.enable)return Sentry.captureException(e)}}function init(){exports.sentry.init()}function setUserInfo(e){exports.sentry.setUserInfo(e)}exports.sentry=new SentryManager,exports.init=init,exports.setUserInfo=setUserInfo;