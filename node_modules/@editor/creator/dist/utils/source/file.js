"use strict";var __awaiter=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(s,a)}c((r=r.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.copy=exports.unzip=exports.getName=void 0;const fs_extra_1=require("fs-extra"),child_process_1=require("child_process"),{existsSync:existsSync}=require("fs"),{basename:basename,dirname:dirname,extname:extname,join:join}=require("path");function getName(e){if(!existsSync(e))return e;const n=dirname(e),t=extname(e);let r=basename(e,t);do{/(\d+)$/.test(r)?r=r.replace(/(\d+)$/,(e,n)=>{let t=parseInt(n,10);return t=(t+=1).toString().padStart(n.length,"0")}):r+="-001",e=join(n,r)}while(existsSync(e+t));return e+t}exports.getName=getName;const unzipOfDarwin=function(e,n,t){const r=dirname(n);(0,fs_extra_1.ensureDirSync)(r);const o=(0,child_process_1.spawn)("unzip",[e,"-d",n]);let i="";o.stderr.on("data",e=>{i+=e});let s="";o.stdout.on("data",e=>{s+=e}),o.on("close",e=>{s&&console.log(s),i&&console.warn(i);let n=null;0!==e&&(n=new Error("The decompression has failed")),t(n)})},unzipOfWin32=function(e,n,t){const r=dirname(n);(0,fs_extra_1.ensureDirSync)(r);const o=(0,child_process_1.spawn)(join(Editor.App.path,"../tools/unzip.exe"),[e,"-d",n]);let i="";o.stderr.on("data",e=>{i+=e});let s="";o.stdout.on("data",e=>{s+=e}),o.on("close",e=>{s&&console.log(s),i&&console.warn(i);let n=null;0!==e&&(n=new Error("The decompression has failed")),t(n)})};function unzip(e,n,t={}){return __awaiter(this,void 0,void 0,function*(){let r;r="win32"===process.platform?unzipOfWin32:unzipOfDarwin;const o=join(Editor.Project.tmpDir,".utils_temp",basename(e,".zip"));if(yield(0,fs_extra_1.remove)(o),yield new Promise((n,t)=>{r(e,o,e=>{if(e)return t(e);n()})}),t.peel){const e=(0,fs_extra_1.readdirSync)(o);1===e.length?yield(0,fs_extra_1.copy)(join(o,e[0]),n):yield(0,fs_extra_1.copy)(o,n)}else yield(0,fs_extra_1.copy)(o,n);yield(0,fs_extra_1.remove)(o)})}function copy(e,n){!function e(n,t){if(!existsSync(n))return;if((0,fs_extra_1.statSync)(n).isDirectory()){(0,fs_extra_1.ensureDirSync)(t);const r=(0,fs_extra_1.readdirSync)(n);for(const o of r)e(join(n,o),join(t,o))}else(0,fs_extra_1.copySync)(n,t),(0,fs_extra_1.chmodSync)(t,511)}(e,n)}exports.unzip=unzip,exports.copy=copy;