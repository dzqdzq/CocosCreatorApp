"use strict";var __awaiter=this&&this.__awaiter||function(e,o,t,n){return new(t||(t=Promise))(function(i,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var o;e.done?i(e.value):(o=e.value,o instanceof t?o:new t(function(e){e(o)})).then(s,a)}l((n=n.apply(e,o||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getZoomLevel=exports.setZoomLevel=exports.getDefaultZoomLevel=exports.setDefaultZoomLevel=exports.close=exports.minimize=exports.maximize=exports.open=exports.startup=exports.queryMainTitle=exports.changeMainTitle=exports.openSimpleWindow=exports.openSubWindow=exports.generateBlank=exports.changeMinSize=exports.changeUserData=exports.queryUserData=exports.setAfterOpenHook=exports.setBeforeOpenHook=exports.hooks=void 0;const electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),panel=require("@editor/panel"),worker=require("@base/electron-worker"),setting=require("@editor/setting"),fs_extra_1=require("fs-extra"),path_1=require("path"),constant_1=require("../constant");function setBeforeOpenHook(e){return __awaiter(this,void 0,void 0,function*(){exports.hooks.beforeOpen=e})}function setAfterOpenHook(e){return __awaiter(this,void 0,void 0,function*(){exports.hooks.afterOpen=e})}function queryUserData(e){return __awaiter(this,void 0,void 0,function*(){return windows.uuid2info[e]})}function changeUserData(e,o){return __awaiter(this,void 0,void 0,function*(){let t=windows.uuid2info[o];t&&JSON.stringify(t.userData)!==JSON.stringify(e)&&(t.userData=e,windows.emit("change"))})}function changeMinSize(e,o,t){return __awaiter(this,void 0,void 0,function*(){console.warn("ChangeMinSize needs to be done in a window.")})}let cacheWinID;function generateBlank(){return __awaiter(this,void 0,void 0,function*(){cacheWinID=yield open(constant_1.BLANK_HTML,{show:!1},{})})}function openSubWindow(e,o){return __awaiter(this,void 0,void 0,function*(){const t=windows.normalizeURL(constant_1.SUB_HTML,cacheWinID),n=windows.uuid2win[cacheWinID];if(!n||n.isDestroyed())console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SUB_HTML,{width:e.width,height:e.height,center:!0},o);else{const i=windows.uuid2info[cacheWinID];i.userData=o,i.url=constant_1.SUB_HTML,n.setSize(e.width,e.height),n.once("ready-to-show",()=>{n.webContents.setZoomLevel(getDefaultZoomLevel()),n.show(),n.focus()}),n.loadURL(t)}yield generateBlank()})}function openSimpleWindow(e,o){var t;return __awaiter(this,void 0,void 0,function*(){const n=windows.normalizeURL(constant_1.SIMPLE_HTML,cacheWinID),i=windows.uuid2win[cacheWinID];if(!i||i.isDestroyed())console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SIMPLE_HTML,{minWidth:e["min-width"]||200,minHeight:e["min-height"]||200,width:e.width,height:e.height,resizable:null===(t=null===o||void 0===o?void 0:o.flags)||void 0===t?void 0:t.resizable,center:!0},o);else{const t=windows.uuid2info[cacheWinID];t.userData=o,t.url=constant_1.SIMPLE_HTML,i.setSize(e.width,e.height),i.once("ready-to-show",()=>{i.webContents.setZoomLevel(getDefaultZoomLevel()),i.show(),i.focus()}),i.loadURL(n)}generateBlank()})}function changeMainTitle(e){queryMainWin().title=e,Editor.Message.broadcast("editor-title-change",e)}function queryMainTitle(){return __awaiter(this,void 0,void 0,function*(){return queryMainWin().title})}function queryMainWin(){try{return windows.uuid2win[windows.uuids[0]]}catch(e){throw new Error("No main window found")}}function startup(){return __awaiter(this,void 0,void 0,function*(){let e=`Untitled - ${setting.title}`;"darwin"!==process.platform&&(e+=` - ${Editor.Project.name} ${Editor.App.version}`);const o={frame:!1,titleBarStyle:"hiddenInset",titleBarOverlay:48,title:e};if(!(0,fs_extra_1.existsSync)(constant_1.SAVE_FILE)){yield fillWindowOptions(o);const e={layout:yield Editor.Layout.query("default")};exports.hooks.beforeOpen&&exports.hooks.beforeOpen(o,e);const t=yield open(constant_1.MAIN_HTML,o,e);return windows.focus(t),exports.hooks.afterOpen&&exports.hooks.afterOpen(windows),yield generateBlank(),[t]}try{const e=yield(0,fs_extra_1.readJSON)(constant_1.SAVE_FILE);if(!e||!Array.isArray(e.windows)||0===e.windows.length)throw new Error("The window data is invalid.");const t=e.windows[0];t&&Object.assign(t.options,o,{autoHideMenuBar:!1,menuBarVisibility:!0});for(let o of e.windows)o&&(o.options.show=!0,o.options=o.options||{},o.options.webPreferences=o.options.webPreferences||{},o.userData=o.userData||{layout:yield Editor.Layout.query("default")},yield fillWindowOptions(o.options),exports.hooks.beforeOpen&&exports.hooks.beforeOpen(o.options,o.userData),o.url=(0,path_1.join)(__dirname,"../../../static/windows",(0,path_1.basename)(o.url)));const n=yield windows.restore(e);windows.focus(n[0]);try{exports.hooks.afterOpen&&(yield exports.hooks.afterOpen(windows))}catch(e){console.warn(e)}return yield generateBlank(),n}catch(e){console.warn("Recovery window failed."),console.warn(e),yield(0,fs_extra_1.copyFile)(constant_1.SAVE_FILE,constant_1.SAVE_FILE+".backup");const t=Object.create(null);Object.assign(t,o,{autoHideMenuBar:!1,menuBarVisibility:!0}),yield fillWindowOptions(t);const n={layout:yield Editor.Layout.query("default")};exports.hooks.beforeOpen&&exports.hooks.beforeOpen(t,n);const i=yield open(constant_1.MAIN_HTML,t,n);windows.focus(i);try{exports.hooks.afterOpen&&(yield exports.hooks.afterOpen(windows))}catch(e){console.warn(e)}return yield generateBlank(),[i]}})}function open(e,o={},t={}){return __awaiter(this,void 0,void 0,function*(){return fillWindowOptions(o),yield windows.open(e,o,t)})}function maximize(){console.warn("Maximization needs to be done in a window.")}function minimize(){console.warn("Minimization needs to be done in a window.")}function close(){console.warn("Close needs to be done in a window.")}function save(){return __awaiter(this,void 0,void 0,function*(){const e=JSON.parse(JSON.stringify(windows.dump()));for(let t=0;t<e.windows.length;t++){const n=e.windows[t];if(n.url=(0,path_1.basename)(n.url),cuttingWindowOptions(n.options),n.userData)if(n.userData.panel){const o=panel.queryInfo(n.userData.panel);o&&o.userData.flags&&o.userData.flags.save||(e.windows.splice(t,1),t--)}else n.userData.layout&&o(n.userData.layout.layout)||(e.windows.splice(t,1),t--);else e.windows.splice(t,1),t--;function o(e){if(e.panels){return e.panels.some(e=>{const o=panel.queryInfo(e);return!(!o||!o.userData.flags)&&!!o.userData.flags.save})}return e.children.some(e=>o(e))}}if(0!==e.windows.length)try{yield(0,fs_extra_1.outputJSON)(constant_1.SAVE_FILE,e,{spaces:2})}catch(e){}})}function fillOption(e,o,t,n){!n&&o in e||(e[o]=t)}function fillWindowOptions(e){return __awaiter(this,void 0,void 0,function*(){fillOption(e,"center",!0),fillOption(e,"width",1100),fillOption(e,"height",700),fillOption(e,"autoHideMenuBar",!0),fillOption(e,"menuBarVisibility",!1),fillOption(e,"transparent",!1),fillOption(e,"resizable",!0),fillOption(e,"show",!0),fillOption(e,"webPreferences",{}),fillOption(e.webPreferences,"nodeIntegration",!0,!0),fillOption(e.webPreferences,"webviewTag",!0,!0),fillOption(e.webPreferences,"enableRemoteModule",!0,!0),fillOption(e.webPreferences,"contextIsolation",!1,!0),fillOption(e.webPreferences,"backgroundThrottling",!1,!0)})}function setDefaultZoomLevel(e){windows.setDefaultZoomLevel(e);for(const o in windows.uuid2win){const t=windows.uuid2win[o];t&&t.webContents.setZoomLevel(e)}Editor.Message.broadcast("windows:zoom-level-change",e)}function getDefaultZoomLevel(){return windows.getDefaultZoomLevel()}function setZoomLevel(e,o){const t=windows.uuid2win[o]||electron_1.BrowserWindow.getFocusedWindow()||queryMainWin();t&&t.webContents.setZoomLevel(e)}function getZoomLevel(e){return new Promise((o,t)=>{try{o((windows.uuid2win[e]||electron_1.BrowserWindow.getFocusedWindow()||queryMainWin()).webContents.getZoomLevel())}catch(e){t(e)}})}function cuttingWindowOptions(e){return __awaiter(this,void 0,void 0,function*(){delete e.frame,delete e.transparent,delete e.resizable,delete e.minimizable,delete e.titleBarStyle,delete e.titleBarOverlay,delete e.fullscreen,delete e.show,delete e.autoHideMenuBar,e.menuBarVisibility=!0})}exports.hooks={beforeOpen:null,afterOpen:null},exports.setBeforeOpenHook=setBeforeOpenHook,exports.setAfterOpenHook=setAfterOpenHook,exports.queryUserData=queryUserData,exports.changeUserData=changeUserData,exports.changeMinSize=changeMinSize,exports.generateBlank=generateBlank,exports.openSubWindow=openSubWindow,exports.openSimpleWindow=openSimpleWindow,exports.changeMainTitle=changeMainTitle,exports.queryMainTitle=queryMainTitle,exports.startup=startup,exports.open=open,exports.maximize=maximize,exports.minimize=minimize,exports.close=close,windows.on("change",save),windows.on("close",save),exports.setDefaultZoomLevel=setDefaultZoomLevel,exports.getDefaultZoomLevel=getDefaultZoomLevel,exports.setZoomLevel=setZoomLevel,exports.getZoomLevel=getZoomLevel;const startUpTime=Date.now();let activeTime=startUpTime;setInterval(()=>{try{const e=Date.now();Editor.Metrics._trackEventWithTimer({category:"editor",id:"A100002",value:((e-activeTime)/1e3/60*100|0)/100}),activeTime=e}catch(e){}},6e4),windows.on("clear",()=>{const e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100001:1}}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),Editor.Metrics.__protected__._sendEventGroup(),Editor.Metrics.close(),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),ipc.on("editor-lib-windows:focus",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);if(o){o!==electron_1.BrowserWindow.getFocusedWindow()&&o.focus()}}),ipc.on("editor-lib-windows:maximize",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&(o.isMaximized()?o.unmaximize():o.maximize())}),ipc.on("editor-lib-windows:minimize",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&o.minimizable&&o.minimize()}),ipc.on("editor-lib-windows:isMaximized",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);return!(!o||!o.isMaximized())}),ipc.on("editor-lib-windows:open",(e,o,t,n)=>{open(o,t,n)}),ipc.on("editor-lib-windows:close",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);o&&o.closable&&o.close()}),ipc.on("editor-lib-windows:generateBlank",(e,o,t)=>{openSimpleWindow(o,t)}),ipc.on("editor-lib-windows:openSubWindow",(e,o,t)=>{openSubWindow(o,t)}),ipc.on("editor-lib-windows:openSimpleWindow",(e,o,t)=>{openSimpleWindow(o,t)}),ipc.on("editor-lib-windows:changeMainTitle",(e,o)=>{changeMainTitle(o)}),ipc.on("editor-lib-windows:queryMainTitle",e=>__awaiter(void 0,void 0,void 0,function*(){e.reply(null,yield queryMainTitle())})),ipc.on("editor-lib-windows:set-default-zoom-level",(e,o)=>{setDefaultZoomLevel(o)}),ipc.on("editor-lib-windows:get-default-zoom-level",e=>__awaiter(void 0,void 0,void 0,function*(){e.reply(null,getDefaultZoomLevel())})),ipc.on("editor-lib-windows:get-zoom-level",(e,o)=>{e.reply(null,getZoomLevel(o))}),ipc.on("editor-lib-windows:set-zoom-level",(e,o,t)=>{setZoomLevel(o,t)});