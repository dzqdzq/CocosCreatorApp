"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getZoomLevel=exports.setZoomLevel=exports.getDefaultZoomLevel=exports.setDefaultZoomLevel=exports.close=exports.minimize=exports.maximize=exports.open=exports.startup=exports.queryMainTitle=exports.changeMainTitle=exports.openSimpleWindow=exports.openSubWindow=exports.generateBlank=exports.changeMinSize=exports.changeUserData=exports.queryUserData=exports.setAfterOpenHook=exports.setBeforeOpenHook=exports.hooks=void 0;const electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),windows=require("@base/electron-windows"),panel=require("@editor/panel"),worker=require("@base/electron-worker"),setting=require("@editor/setting"),fs_extra_1=require("fs-extra"),path_1=require("path"),constant_1=require("../constant");async function setBeforeOpenHook(e){exports.hooks.beforeOpen=e}async function setAfterOpenHook(e){exports.hooks.afterOpen=e}async function queryUserData(e){return windows.uuid2info[e]}async function changeUserData(e,o){o=windows.uuid2info[o];o&&JSON.stringify(o.userData)!==JSON.stringify(e)&&(o.userData=e,windows.emit("change"))}async function changeMinSize(e,o,n){console.warn("ChangeMinSize needs to be done in a window.")}exports.hooks={beforeOpen:null,afterOpen:null},exports.setBeforeOpenHook=setBeforeOpenHook,exports.setAfterOpenHook=setAfterOpenHook,exports.queryUserData=queryUserData,exports.changeUserData=changeUserData,exports.changeMinSize=changeMinSize;let cacheWinID;async function generateBlank(){cacheWinID=await open(constant_1.BLANK_HTML,{show:!1},{})}async function openSubWindow(e,o){var n,t=windows.normalizeURL(constant_1.SUB_HTML,cacheWinID);const i=windows.uuid2win[cacheWinID];!i||i.isDestroyed()?(console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SUB_HTML,{width:e.width,height:e.height,center:!0},o)):((n=windows.uuid2info[cacheWinID]).userData=o,n.url=constant_1.SUB_HTML,i.setSize(e.width,e.height),i.once("ready-to-show",()=>{i.webContents.setZoomLevel(getDefaultZoomLevel()),i.show(),i.focus()}),i.loadURL(t)),await generateBlank()}async function openSimpleWindow(e,o){var n,t=windows.normalizeURL(constant_1.SIMPLE_HTML,cacheWinID);const i=windows.uuid2win[cacheWinID];!i||i.isDestroyed()?(console.warn("The cache window is destroyed. Try to reopen it"),open(constant_1.SIMPLE_HTML,{minWidth:e["min-width"]||200,minHeight:e["min-height"]||200,width:e.width,height:e.height,resizable:o?.flags?.resizable,center:!0},o)):((n=windows.uuid2info[cacheWinID]).userData=o,n.url=constant_1.SIMPLE_HTML,i.setSize(e.width,e.height),i.once("ready-to-show",()=>{i.webContents.setZoomLevel(getDefaultZoomLevel()),i.show(),i.focus()}),i.loadURL(t)),generateBlank()}function changeMainTitle(e){queryMainWin().title=e,Editor.Message.broadcast("editor-title-change",e)}async function queryMainTitle(){return queryMainWin().title}function queryMainWin(){try{return windows.uuid2win[windows.uuids[0]]}catch(e){throw new Error("No main window found")}}async function startup(){let e="Untitled - "+setting.title;"darwin"!==process.platform&&(e+=` - ${Editor.Project.name} `+Editor.App.version);var o={frame:!1,titleBarStyle:"hiddenInset",titleBarOverlay:48,title:e};if(!(0,fs_extra_1.existsSync)(constant_1.SAVE_FILE))return await fillWindowOptions(o),s={layout:await Editor.Layout.query("default")},exports.hooks.beforeOpen&&exports.hooks.beforeOpen(o,s),s=await open(constant_1.MAIN_HTML,o,s),windows.focus(s),exports.hooks.afterOpen&&exports.hooks.afterOpen(windows),await generateBlank(),[s];try{var n=await(0,fs_extra_1.readJSON)(constant_1.SAVE_FILE);if(!n||!Array.isArray(n.windows)||0===n.windows.length)throw new Error("The window data is invalid.");var t,i=n.windows[0];i&&Object.assign(i.options,o,{autoHideMenuBar:!1,menuBarVisibility:!0});for(t of n.windows)t&&(t.options.show=!0,t.options=t.options||{},t.options.webPreferences=t.options.webPreferences||{},t.userData=t.userData||{layout:await Editor.Layout.query("default")},await fillWindowOptions(t.options),exports.hooks.beforeOpen&&exports.hooks.beforeOpen(t.options,t.userData),t.url=(0,path_1.join)(__dirname,"../../../static/windows",(0,path_1.basename)(t.url)));var r=await windows.restore(n);windows.focus(r[0]);try{exports.hooks.afterOpen&&await exports.hooks.afterOpen(windows)}catch(e){console.warn(e)}return await generateBlank(),r}catch(e){console.warn("Recovery window failed."),console.warn(e),await(0,fs_extra_1.copyFile)(constant_1.SAVE_FILE,constant_1.SAVE_FILE+".backup");var s=Object.create(null),i=(Object.assign(s,o,{autoHideMenuBar:!1,menuBarVisibility:!0}),await fillWindowOptions(s),await Editor.Layout.query("default")),n={layout:i},r=(exports.hooks.beforeOpen&&exports.hooks.beforeOpen(s,n),await open(constant_1.MAIN_HTML,s,n));windows.focus(r);try{exports.hooks.afterOpen&&await exports.hooks.afterOpen(windows)}catch(e){console.warn(e)}return await generateBlank(),[r]}}async function open(e,o={},n={}){return fillWindowOptions(o),await windows.open(e,o,n)}function maximize(){console.warn("Maximization needs to be done in a window.")}function minimize(){console.warn("Minimization needs to be done in a window.")}function close(){console.warn("Close needs to be done in a window.")}async function save(){var o=JSON.parse(JSON.stringify(windows.dump()));for(let e=0;e<o.windows.length;e++){var n,t=o.windows[e];t.url=(0,path_1.basename)(t.url),cuttingWindowOptions(t.options),t.userData?t.userData.panel?(n=panel.queryInfo(t.userData.panel))&&n.userData.flags&&n.userData.flags.save||(o.windows.splice(e,1),e--):t.userData.layout&&function o(e){return e.panels?e.panels.some(e=>!(!(e=panel.queryInfo(e))||!e.userData.flags||!e.userData.flags.save)):e.children.some(e=>o(e))}(t.userData.layout.layout)||(o.windows.splice(e,1),e--):(o.windows.splice(e,1),e--)}if(0!==o.windows.length)try{await(0,fs_extra_1.outputJSON)(constant_1.SAVE_FILE,o,{spaces:2})}catch(e){}}function fillOption(e,o,n,t){!t&&o in e||(e[o]=n)}async function fillWindowOptions(e){fillOption(e,"center",!0),fillOption(e,"width",1100),fillOption(e,"height",700),fillOption(e,"autoHideMenuBar",!0),fillOption(e,"menuBarVisibility",!1),fillOption(e,"transparent",!1),fillOption(e,"resizable",!0),fillOption(e,"show",!0),fillOption(e,"webPreferences",{}),fillOption(e.webPreferences,"nodeIntegration",!0,!0),fillOption(e.webPreferences,"nodeIntegrationInWorker",!0,!0),fillOption(e.webPreferences,"webviewTag",!0,!0),fillOption(e.webPreferences,"enableRemoteModule",!0,!0),fillOption(e.webPreferences,"contextIsolation",!1,!0),fillOption(e.webPreferences,"backgroundThrottling",!1,!0)}function setDefaultZoomLevel(e){windows.setDefaultZoomLevel(e);for(const n in windows.uuid2win){var o=windows.uuid2win[n];o&&o.webContents.setZoomLevel(e)}Editor.Message.broadcast("windows:zoom-level-change",e)}function getDefaultZoomLevel(){return windows.getDefaultZoomLevel()}function setZoomLevel(e,o){o=windows.uuid2win[o]||electron_1.BrowserWindow.getFocusedWindow()||queryMainWin();o&&o.webContents.setZoomLevel(e)}function getZoomLevel(n){return new Promise((e,o)=>{try{e((windows.uuid2win[n]||electron_1.BrowserWindow.getFocusedWindow()||queryMainWin()).webContents.getZoomLevel())}catch(e){o(e)}})}async function cuttingWindowOptions(e){delete e.frame,delete e.transparent,delete e.resizable,delete e.minimizable,delete e.titleBarStyle,delete e.titleBarOverlay,delete e.fullscreen,delete e.show,delete e.autoHideMenuBar,delete e.title,e.menuBarVisibility=!0}exports.generateBlank=generateBlank,exports.openSubWindow=openSubWindow,exports.openSimpleWindow=openSimpleWindow,exports.changeMainTitle=changeMainTitle,exports.queryMainTitle=queryMainTitle,exports.startup=startup,exports.open=open,exports.maximize=maximize,exports.minimize=minimize,exports.close=close,windows.on("change",save),windows.on("close",save),exports.setDefaultZoomLevel=setDefaultZoomLevel,exports.getDefaultZoomLevel=getDefaultZoomLevel,exports.setZoomLevel=setZoomLevel,exports.getZoomLevel=getZoomLevel;const startUpTime=Date.now();let activeTime=startUpTime;setInterval(()=>{try{var e=Date.now();Editor.Metrics._trackEventWithTimer({category:"editor",id:"A100002",value:((e-activeTime)/1e3/60*100|0)/100}),activeTime=e}catch(e){}},6e4),windows.on("clear",()=>{var e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100001:1}}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),Editor.Metrics.__protected__._sendEventGroup(),Editor.Metrics.close(),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),ipc.on("editor-lib-windows:focus",e=>{e=electron_1.BrowserWindow.fromWebContents(e.sender);e&&e!==electron_1.BrowserWindow.getFocusedWindow()&&e.focus()}),ipc.on("editor-lib-windows:maximize",e=>{e=electron_1.BrowserWindow.fromWebContents(e.sender);e&&(e.isMaximized()?e.unmaximize():e.maximize())}),ipc.on("editor-lib-windows:minimize",e=>{e=electron_1.BrowserWindow.fromWebContents(e.sender);e&&e.minimizable&&e.minimize()}),ipc.on("editor-lib-windows:isMaximized",e=>{e=electron_1.BrowserWindow.fromWebContents(e.sender);return!(!e||!e.isMaximized())}),ipc.on("editor-lib-windows:open",(e,o,n,t)=>{open(o,n,t)}),ipc.on("editor-lib-windows:close",e=>{e=electron_1.BrowserWindow.fromWebContents(e.sender);e&&e.closable&&e.close()}),ipc.on("editor-lib-windows:generateBlank",(e,o,n)=>{openSimpleWindow(o,n)}),ipc.on("editor-lib-windows:openSubWindow",(e,o,n)=>{openSubWindow(o,n)}),ipc.on("editor-lib-windows:openSimpleWindow",(e,o,n)=>{openSimpleWindow(o,n)}),ipc.on("editor-lib-windows:changeMainTitle",(e,o)=>{changeMainTitle(o)}),ipc.on("editor-lib-windows:queryMainTitle",async e=>{e.reply(null,await queryMainTitle())}),ipc.on("editor-lib-windows:set-default-zoom-level",(e,o)=>{setDefaultZoomLevel(o)}),ipc.on("editor-lib-windows:get-default-zoom-level",async e=>{e.reply(null,getDefaultZoomLevel())}),ipc.on("editor-lib-windows:get-zoom-level",(e,o)=>{e.reply(null,getZoomLevel(o))}),ipc.on("editor-lib-windows:set-zoom-level",(e,o,n)=>{setZoomLevel(o,n)});