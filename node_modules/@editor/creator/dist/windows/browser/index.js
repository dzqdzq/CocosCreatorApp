"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(s,a)}l((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.restore=exports.open=exports.setNativizeCallback=void 0;const fs=require("fs"),fse=require("fs-extra"),ps=require("path"),electron_1=require("electron"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),Metrics=require("../../metrics/browser/index"),hideTitle="darwin"===process.platform,isWin32="win32"===process.platform,file=ps.join(setting.PATH.HOME,"editor/window.json"),mainHTML=ps.join(__dirname,"../../../static/windows/main.html"),startUpTime=Date.now();let activeTime=startUpTime;setInterval(()=>{try{const e=Date.now();Editor.Metrics._trackEventWithTimer({category:"editor",id:"A100002",value:((e-activeTime)/1e3/60*100|0)/100}),activeTime=e}catch(e){}},6e4);let saveLock=!1;const save=function(){if(saveLock)return;const e=windows.dump();e.windows=e.windows.filter(Boolean);const t=e.windows;t.forEach(e=>{e.url=ps.basename(e.url)});for(let e=0;e<t.length;e++){if(t[e].options&&(delete t[e].options.frame,delete t[e].options.transparent,delete t[e].options.resizable,delete t[e].options.minimizable,delete t[e].options.titleBarStyle,delete t[e].options.titleBarOverlay,delete t[e].options.fullscreen),t[e].userData.panel){const i=panel.queryInfo(t[e].userData.panel);i&&i.userData.flags&&i.userData.flags.save||(t.splice(e,1),e--);continue}if(!t[e].userData.layout){t.splice(e,1),e--;continue}function i(e){if(e.panels){return e.panels.some(e=>{const t=panel.queryInfo(e);return!(!t||!t.userData.flags)&&!!t.userData.flags.save})}return e.children.some(e=>i(e))}i(t[e].userData.layout.layout)||(t.splice(e,1),e--)}try{fse.outputJSONSync(file,e,{spaces:2})}catch(e){}};let isNative=!1,isNativeInited=!1;const isNativeScene=function(){return __awaiter(this,void 0,void 0,function*(){return isNativeInited?isNative:(isNative=yield Editor.Profile.getConfig("scene","scene.native"),isNativeInited=!0,isNative)})},getWindowParams=function(e){return __awaiter(this,void 0,void 0,function*(){const t={center:!0,width:1100,height:700,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}};return"frame"in(e=e||{})&&(t.frame=e.frame),"titleBarStyle"in e&&(t.titleBarStyle=e.titleBarStyle),"titleBarOverlay"in e&&(t.titleBarOverlay=e.titleBarOverlay),isWin32&&(yield isNativeScene())&&(t.transparent=isWin32,t.resizable=!isWin32),t})};let nativizeCallback;function setNativizeCallback(e){nativizeCallback=e}function open(){return __awaiter(this,void 0,void 0,function*(){saveLock=!0;const e={};hideTitle&&(e.frame=!0,e.titleBarStyle="hiddenInset",e.titleBarOverlay=48);const t=yield getWindowParams(e),i=yield windows.open(mainHTML,t,{});return saveLock=!1,(yield isNativeScene())&&nativizeCallback&&nativizeCallback(windows),windows.focus(i),i})}function restore(e){return __awaiter(this,void 0,void 0,function*(){if(!fs.existsSync(file)){let e;return saveLock=!0,e=yield open(),saveLock=!1,[e]}let t;setNativizeCallback(e);try{t=fse.readJSONSync(file);let e=!1;for(let i of t.windows)i.options||(i.options={}),i.options.webPreferences||(i.options.webPreferences={}),e||(e=!0,hideTitle&&(i.options.frame=!0,i.options.titleBarStyle="hiddenInset",i.options.titleBarOverlay=48)),yield getWindowParams(i.options)}catch(e){saveLock=!0,console.warn(`Recovery window failed: ${file} read error.`),console.warn(e),console.warn(fse.copyFileSync(file,file+".error"));let t=yield open();return windows.focus(t),saveLock=!1,[t]}let i=!0;if(t.windows.forEach((e,t)=>{i=!1,e.url=ps.join(__dirname,"../../../static/windows",ps.basename(e.url)),e.options||(e.options={}),e.options.webPreferences||(e.options.webPreferences={}),0===t&&hideTitle&&(e.options.frame=!0,e.options.titleBarStyle="hiddenInset",e.options.titleBarOverlay=48),e.options.webPreferences.nodeIntegration=!0,e.options.webPreferences.webviewTag=!0,e.options.webPreferences.enableRemoteModule=!0,e.options.webPreferences.contextIsolation=!1,e.options.webPreferences.backgroundThrottling=!1}),i){saveLock=!0;const e=yield open();return windows.focus(e),saveLock=!1,[e]}saveLock=!0;const n=yield windows.restore(t);return windows.focus(n[0]),saveLock=!1,(yield isNativeScene())&&nativizeCallback&&nativizeCallback(windows),n})}windows.on("change",save),windows.on("close",()=>{Metrics._sendEventGroup(),save()}),windows.on("clear",()=>{const e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"editor",value:{A100002:1}}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),exports.setNativizeCallback=setNativizeCallback,exports.open=open,exports.restore=restore,ipc.on("editor-lib-windows:focus",e=>{const t=electron_1.BrowserWindow.fromWebContents(e.sender);if(t){t!==electron_1.BrowserWindow.getFocusedWindow()&&t.focus()}}),ipc.on("editor-lib-windows:maximize",e=>{const t=electron_1.BrowserWindow.fromWebContents(e.sender);t&&(t.isMaximized()?t.unmaximize():t.maximize())});