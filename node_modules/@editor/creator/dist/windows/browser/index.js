"use strict";var __awaiter=this&&this.__awaiter||function(e,o,n,t){return new(n||(n=Promise))(function(r,s){function i(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n(function(e){e(o)})).then(i,a)}c((t=t.apply(e,o||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.restore=exports.open=void 0;const fs=require("fs"),fse=require("fs-extra"),ps=require("path"),electron_1=require("electron"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),file=ps.join(setting.PATH.HOME,"editor/window.json"),mainHTML=ps.join(__dirname,"../../../static/windows/main.html"),startUpTime=Date.now();let saveLock=!1;const save=function(){if(saveLock)return;const e=windows.dump();e.windows=e.windows.filter(Boolean);const o=e.windows;o.forEach(e=>{e.url=ps.basename(e.url)});for(let e=0;e<o.length;e++){if(o[e].options&&(delete o[e].options.frame,delete o[e].options.transparent,delete o[e].options.resizable),o[e].userData.panel){const n=panel.queryInfo(o[e].userData.panel);n&&n.userData.flags&&n.userData.flags.save||(o.splice(e,1),e--);continue}if(!o[e].userData.layout){o.splice(e,1),e--;continue}function n(e){if(e.panels){return e.panels.some(e=>{const o=panel.queryInfo(e);return!(!o||!o.userData.flags)&&!!o.userData.flags.save})}return e.children.some(e=>n(e))}n(o[e].userData.layout.layout)||(o.splice(e,1),e--)}try{fse.outputJSONSync(file,e,{spaces:2})}catch(e){}};function open(){return __awaiter(this,void 0,void 0,function*(){saveLock=!0;const e=windows.open(mainHTML,{center:!0,width:1100,height:700,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},{});return saveLock=!1,windows.focus(e),e})}function restore(){return __awaiter(this,void 0,void 0,function*(){if(!fs.existsSync(file)){saveLock=!0;const e=yield open();return saveLock=!1,[e]}let e;try{e=fse.readJSONSync(file);for(let o of e.windows)o.options||(o.options={}),o.options.webPreferences||(o.options.webPreferences={}),o.options.webPreferences.nodeIntegration=!0,o.options.webPreferences.webviewTag=!0,o.options.webPreferences.enableRemoteModule=!0,o.options.webPreferences.contextIsolation=!1,o.options.webPreferences.backgroundThrottling=!1}catch(e){saveLock=!0,console.warn(`Recovery window failed: ${file} read error.`),console.warn(e),console.warn(fse.copyFileSync(file,file+".error"));const o=yield open();return windows.focus(o),saveLock=!1,[o]}let o=!0;if(e.windows.forEach(e=>{o=!1,e.url=ps.join(__dirname,"../../../static/windows",ps.basename(e.url))}),o){saveLock=!0;const e=yield open();return windows.focus(e),saveLock=!1,[e]}saveLock=!0;const n=yield windows.restore(e);return windows.focus(n[0]),saveLock=!1,n})}windows.on("change",save),windows.on("close",save),windows.on("clear",()=>{const e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),exports.open=open,exports.restore=restore,ipc.on("editor-lib-windows:focus",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);if(o){o!==electron_1.BrowserWindow.getFocusedWindow()&&o.focus()}});