"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../utils"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")},MigrationType={global:"migrateGlobal",local:"migrateLocal",project:"migrateProject"};function getJsonPath(r,e){switch(r){case"local":return(0,path_1.join)(Editor.Project.path,"profiles","v2","packages",e+".json");case"project":return(0,path_1.join)(Editor.Project.path,"settings","v2","packages",e+".json");case"global":return(0,path_1.join)(Editor.App.home,"profiles","v2","packages",e+".json")}}async function profile(l){const c=l.info;let p=[];Array.isArray(c.migrations)&&(c.migrations.forEach(r=>{r.profile&&(r.profile=(0,path_1.join)(l.path,r.profile)),r.custom&&(r.custom=(0,path_1.join)(l.path,r.custom))}),c.migrations.sort((r,e)=>(0,utils_1.compareVersion)(r.version,e.version||"")),Editor.Profile.__protected__._registerMigration(l.name,c.migrations),p=c.migrations.filter(r=>r.version&&r.custom));var r=["global","local","project"].map(async e=>{var r=Editor.Profile.__protected__.ensureProfiles(l.name),o=r[e].get("__version__");if(l.version!==o&&r[e].set("__version__",l.version),Array.isArray(c.migrations)&&l.version!==o){var i=getJsonPath(e,l.name);if(i&&(0,fs_extra_1.existsSync)(i)){console.debug(`[Package] Profile Migrate ${e}: [${o} -> ${l.version}]: ${l.name}@${c.author}...`);var t=r[e].get("")||{};try{await Editor.Profile.__protected__[MigrationType[e]](l.name,o,t,l.version),r[e].set("",t)}catch(r){console.error(`[Package] Custom Migrate error [${o} -> ${l.version}] (${e} profile): ${l.name}@${c.author}(${l.version})`),console.error(r)}for(const n of p)if((0,utils_1.compareVersion)(n.version,l.version||"")<=0)try{console.debug(`[Package] Custom Migrate ${e} [${o} -> ${l.version}]: ${l.name}@${c.author}(${n.version})`);var a=require(n.custom);a[MigrationType[e]]&&await a[MigrationType[e]](l.name,o,t,l.version)}catch(r){return console.error(`[Package] Custom Migrate ${e} [${o} -> ${l.version}] error(${e}): ${l.name}@${c.author}(${n.version})`),void console.error(r)}}else{i=r[e].get("")||{};try{if(!c.migrations.find(r=>"0.0.0"===r.version))return;var s=await Editor.Profile.__protected__[MigrationType[e]](l.name,"0.0.0",i,l.version);r[e].set("",i),s&&r[e].save()}catch(r){console.error(`[Package] Custom Migrate error(${e} profile): ${l.name}@${c.author}(0.0.0)`),console.error(r)}}r[e].save()}});return Promise.all(r)}exports.profile=profile;