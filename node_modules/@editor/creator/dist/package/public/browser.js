"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPath=exports.disable=exports.enable=exports.unregister=exports.register=exports.getPackages=void 0;const electron_1=require("electron"),url_1=require("url"),path_1=require("path"),register_1=require("./register"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),protectedModule=require("../protected");function getPackages(a){a=a||{};const r=[];return Object.keys(packageManager.path2pkg).forEach(e=>{e=packageManager.path2pkg[e];"name"in a&&a.name!==e.name||"debug"in a&&a.debug!==e.debug||"path"in a&&a.path!==e.path||"enable"in a&&a.enable!==e.enabled||e.invalid||r.push(e.generateInfo())}),r}function register(a){if(a=protectedModule.adapter.normalizePath(a),packageManager.path2pkg[a])return!1;try{var e=packageManager.register(a);return"string"!=typeof e.name?(console.warn(`Invalid name: The extension name is not defined 
  ${a}.`),!1):(e.name=e.name.toLowerCase(),(0,register_1.profile)(e),!0)}catch(e){return console.error("[Extension] Register error: "+a),console.error(e),!1}}async function unregister(e){e=protectedModule.adapter.normalizePath(e);var a=packageManager.path2pkg[e];if(a){a.enabled&&await disable(e);try{await packageManager.unregister(e)}catch(e){console.error(e)}}}async function enable(a){a=protectedModule.adapter.normalizePath(a);var e=packageManager.path2pkg[a];if(e){if(!e.enabled)if(/\./.test(e.name))console.warn(`[Package] The extension name is invalid: ${e.name}
  `+a);else if(e.json.editor&&!protectedModule.adapter.checkVersion(e.json.editor))console.warn(`[Package] Skip ${e.json.name}: Require the editor version `+e.json.editor);else{if(e.json.package_version){if(2!==e.json.package_version)return void console.warn(`[Package] Skip ${e.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${e.json.name}: package_version is not defined`);protectedModule.adapter.checkReload(a)&&(await unregister(a),await register(a));try{await protectedModule.adapter.disableOther(a),await packageManager.enable(a),await protectedModule.adapter.removeDisableInfo(a)}catch(e){console.error("[Package] Enable error: "+a),console.error(e)}}}else console.warn(`[Package] Unknown and unable to start
  `+a)}async function disable(e,a={}){e=protectedModule.adapter.normalizePath(e);var r=packageManager.path2pkg[e];if(r){r.panels.forEach(e=>{Editor.Panel.close(e)});try{await packageManager.disable(e)}catch(e){console.error("[Package] Disable error: "+r.path),console.error(e)}protectedModule.adapter.addDisableInfo(e),!1!==a.replacement&&await protectedModule.adapter.enableOther(e)}}function getPath(e){e=this.getPackages({name:e,enable:!0});return e[0]?e[0].path:""}exports.getPackages=getPackages,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.getPath=getPath,electron_1.protocol.registerSchemesAsPrivileged([{scheme:"packages",privileges:{standard:!0,secure:!1}}]),electron_1.app.once("ready",()=>{electron_1.protocol.registerFileProtocol("packages",(e,a)=>{var e=(0,url_1.parse)(e.url),r=packageManager.find(e.host);a(r?(0,path_1.join)(r.path,e.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",async(a,e,...r)=>{try{var t=await module.exports[e](...r),n=JSON.stringify(t);return a.reply(null,n),n}catch(e){throw a.reply(e,null),e}});