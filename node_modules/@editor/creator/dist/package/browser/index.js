"use strict";var __awaiter=this&&this.__awaiter||function(e,a,r,t){return new(r||(r=Promise))(function(n,o){function i(e){try{c(t.next(e))}catch(e){o(e)}}function s(e){try{c(t.throw(e))}catch(e){o(e)}}function c(e){var a;e.done?n(e.value):(a=e.value,a instanceof r?a:new r(function(e){e(a)})).then(i,s)}c((t=t.apply(e,a||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.disable=exports.enable=exports.unregister=exports.register=exports.startup=exports.scan=exports.getPackages=void 0;const path_1=require("path"),url_1=require("url"),events_1=require("events"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../module/index"),register_1=require("./register"),Profile=require("@base/electron-profile"),semver_1=require("semver"),{app:app,protocol:protocol}=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),i18n=require("@base/electron-i18n"),profile={builtin:{get:()=>({}),set(){},save(){}},default:Profile.load("defaultPreferences://editor/packages.json"),local:Profile.load("local://editor/packages.json"),global:Profile.load("global://editor/packages.json")};profile.default.set("disable-packages",{}),packageManager.debugRely((0,path_1.join)(__dirname,"../renderer/debug.js"));const eventEmitter=new events_1.EventEmitter,nameMap={};function getPackages(e){e=e||{};const a=[];return Object.keys(packageManager.path2pkg).forEach(r=>{const t=packageManager.path2pkg[r];"name"in e&&e.name!==t.name||"debug"in e&&e.debug!==t.debug||"path"in e&&e.path!==t.path||"enable"in e&&e.enable!==t.enabled||t.invalid||a.push(t.generateInfo())}),a}function scan(e){return __awaiter(this,void 0,void 0,function*(){if(!(0,fs_extra_1.existsSync)(e))return[];if(!(0,fs_extra_1.statSync)(e).isDirectory())return[];const a=(0,fs_extra_1.readdirSync)(e),r=[];for(let t=0;t<a.length;t++){const n=a[t],o=(0,path_1.join)(e,n);try{if(!(0,fs_extra_1.statSync)(o).isDirectory()&&".asar"!==(0,path_1.extname)(o))continue}catch(e){continue}(0,fs_extra_1.existsSync)((0,path_1.join)(o,"./package.json"))&&(yield register(o)),r.push(o)}return r.filter(Boolean)})}function startup(e,a){return __awaiter(this,void 0,void 0,function*(){for(const r in nameMap){const t=nameMap[r];if(e.includes(r))continue;let n=!1;if(t.local)for(const e of t.local){if(!(profile.local.get("disable-packages")||{})[e.path]){try{yield a(e.name,e.path)}catch(e){console.error(e)}n=!0;break}}if(!1===n&&t.global)for(const e of t.global){if(!(profile.global.get("disable-packages")||{})[e.path]){try{yield a(e.name,e.path)}catch(e){console.error(e)}n=!0;break}}if(!1===n&&t.builtin)for(const e of t.builtin){try{yield a(e.name,e.path)}catch(e){console.error(e)}n=!0;break}if(!1===n&&t.other)for(const e of t.other){try{yield a(e.name,e.path)}catch(e){console.error(e)}n=!0;break}}})}function register(e){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=(0,utils_1.getPosition)(e);if(!a||packageManager.path2pkg[e])return!1;try{const r=packageManager.register(e);if("string"!=typeof r.name)return console.warn(`Invalid name: The extension name is not defined \n  ${e}.`),!1;r.name=r.name.toLowerCase();const t=packageManager.path2pkg[e];return(0,register_1.profile)(r),nameMap[r.name]=nameMap[r.name]||{builtin:[],global:[],local:[],other:[]},nameMap[r.name][a]=nameMap[r.name][a]||[],nameMap[r.name][a].push(t),!0}catch(a){return console.error(`[Extension] Register error: ${e}`),console.error(a),!1}}function unregister(e){return __awaiter(this,void 0,void 0,function*(){if("win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),!(0,utils_1.getPosition)(e))return;const a=packageManager.path2pkg[e];if(a){a.enabled&&(yield disable(e));try{yield packageManager.unregister(e)}catch(e){console.error(e)}if(!packageManager.path2pkg[e]){const r=(0,utils_1.getPosition)(e);r&&nameMap[a.name][r]&&nameMap[a.name][r].find((e,t)=>a===e&&(nameMap[a.name][r].splice(t,1),!0))}}})}function enable(e){return __awaiter(this,void 0,void 0,function*(){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=(0,utils_1.getPosition)(e),r=packageManager.path2pkg[e];if(!r)return void console.warn(`[Package] Unknown and unable to start\n  ${e}`);if(/\./.test(r.name))return void console.warn(`[Package] The extension name is invalid: ${r.name}\n  ${e}`);if(r.json.editor&&!(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(Editor.App.version)),r.json.editor))return void console.warn(`[Package] Skip ${r.json.name}: Require the editor version ${r.json.editor}`);if(r.json.package_version){if(2!==r.json.package_version)return void console.warn(`[Package] Skip ${r.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${r.json.name}: package_version is not defined`);const t=nameMap[r.name];function n(){return __awaiter(this,void 0,void 0,function*(){if(t&&t.builtin)for(const e of t.builtin)if(e.enabled){try{yield packageManager.disable(e.path)}catch(a){console.error(`[Package] Disable error: ${e.path}`),console.error(a)}e.panels.forEach(e=>{Editor.Panel.close(e)})}})}function o(e){return __awaiter(this,void 0,void 0,function*(){if(t&&t.global)for(const a of t.global){if(a.enabled){try{yield packageManager.disable(a.path)}catch(e){console.error(`[Package] Disable error: ${a.path}`),console.error(e)}a.panels.forEach(e=>{Editor.Panel.close(e)})}if(e){const e=profile.global.get("disable-packages")||{};e[a.path]||(e[a.path]={name:a.name,time:(new Date).getTime()},profile.global.set("disable-packages",e),profile.global.save())}}})}function i(e){return __awaiter(this,void 0,void 0,function*(){if(t&&t.local)for(const a of t.local){if(a.enabled){try{yield packageManager.disable(a.path)}catch(e){console.error(`[Package] Disable error: ${a.path}`),console.error(e)}a.panels.forEach(e=>{Editor.Panel.close(e)})}if(e){const e=profile.local.get("disable-packages")||{};e[a.path]||(e[a.path]={name:a.name,time:(new Date).getTime()},profile.local.set("disable-packages",e),profile.local.save())}}})}switch(a){case"builtin":yield i(!0),yield o(!0);break;case"global":yield i(!0),yield n();break;case"local":yield o(!0),yield n();break;default:yield i(!0),yield o(!0),yield n()}try{yield packageManager.enable(e)}catch(a){console.error(`[Package] Enable error: ${e}`),console.error(a)}if(profile[a]){const r=profile[a].get("disable-packages")||{};profile[a]&&r[e]&&(delete r[e],profile[a].set("disable-packages",r),profile[a].save())}})}function disable(e,a){return __awaiter(this,void 0,void 0,function*(){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),a=a||{};const r=(0,utils_1.getPosition)(e);if(!r)return;const t=packageManager.path2pkg[e];if(!t)return;t.panels.forEach(e=>{Editor.Panel.close(e)});try{yield packageManager.disable(e)}catch(e){console.error(`[Package] Disable error: ${t.path}`),console.error(e)}if(profile[r]){const a=profile[r].get("disable-packages")||{};a[e]={name:t.name,time:(new Date).getTime()},profile[r].set("disable-packages",a),profile[r].save()}if(!1===a.replacement)return;const n=nameMap[t.name];let o=!1;switch(r){case"local":if(!1===o&&n.global)for(const e of n.global){if(!(profile.global.get("disable-packages")||{})[e.path]){try{yield packageManager.enable(e.path)}catch(a){console.error(`[Package] Enable error: ${e.path}`),console.error(a)}o=!0;break}}case"global":if(!1===o&&n.builtin)for(const e of n.builtin){try{yield packageManager.enable(e.path)}catch(a){console.error(`[Package] Enable error: ${e.path}`),console.error(a)}o=!0;break}}})}function on(e,a){return eventEmitter.on(e,a)}function removeListener(e,a){return eventEmitter.removeListener(e,a)}exports.getPackages=getPackages,exports.scan=scan,exports.startup=startup,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.on=on,exports.removeListener=removeListener,packageManager.on("register",e=>{if(/^[a-z0-9][a-z0-9-_.]*$/.test(e.name)||console.warn(`The plug-in name is illegal: ${e.name}`),e.info.hooks){const a=e.info.hooks;if(a.register)try{const r=(0,path_1.join)(e.path,a.register||"");index_1.Module.requireFile(r).run(e.info)}catch(e){console.error(e)}}eventEmitter.emit("register",e)}),packageManager.on("unregister",e=>{eventEmitter.emit("unregister",e)}),packageManager.on("before-enable",e=>{try{const a=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(a))return;if(!(0,fs_extra_1.statSync)(a).isDirectory())return;(0,fs_extra_1.readdirSync)(a).forEach(r=>{try{const t=(0,path_1.join)(a,r),n=index_1.Module.requireFile(t),o={};o[e.name]=n,i18n.register(o,(0,path_1.basename)(r,".js"))}catch(e){console.warn(e)}})}catch(e){console.error(e)}}),packageManager.on("before-disable",e=>{}),packageManager.on("enable",e=>{console.log(`[Package] ${e.name}@${e.version} enable`),eventEmitter.emit("enable",e)}),packageManager.on("disable",e=>{console.log(`[Package] ${e.name}@${e.version} disable`),eventEmitter.emit("disable",e);try{const a=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(a))return;if(!(0,fs_extra_1.statSync)(a).isDirectory())return;(0,fs_extra_1.readdirSync)(a).forEach(r=>{const t=(0,path_1.join)(a,r),n=index_1.Module.requireFile(t),o={};o[e.name]=n,i18n.unregister(o,(0,path_1.basename)(r,".js")),index_1.Module.removeCache(t)})}catch(e){console.error(e)}}),app.once("ready",()=>{protocol.registerFileProtocol("packages",(e,a)=>{const r=(0,url_1.parse)(e.url),t=packageManager.find(r.host);a(t?(0,path_1.join)(t.path,r.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",(e,a,...r)=>__awaiter(void 0,void 0,void 0,function*(){try{const t=yield module.exports[a](...r),n=JSON.stringify(t);return e.reply(null,n),n}catch(a){throw e.reply(a,null),a}}));