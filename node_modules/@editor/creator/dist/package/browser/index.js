"use strict";var __awaiter=this&&this.__awaiter||function(e,a,r,t){return new(r||(r=Promise))(function(o,n){function i(e){try{l(t.next(e))}catch(e){n(e)}}function s(e){try{l(t.throw(e))}catch(e){n(e)}}function l(e){var a;e.done?o(e.value):(a=e.value,a instanceof r?a:new r(function(e){e(a)})).then(i,s)}l((t=t.apply(e,a||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.disable=exports.enable=exports.unregister=exports.register=exports.startup=exports.beforeStartup=exports.scan=exports.getPackages=exports.nameMap=void 0;const path_1=require("path"),url_1=require("url"),events_1=require("events"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../module/index"),register_1=require("./register"),Profile=require("@base/electron-profile"),semver_1=require("semver"),{app:app,protocol:protocol}=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),i18n=require("@base/electron-i18n"),_profile={default:Profile.load("defaultPreferences://editor/packages.json"),local:Profile.load("local://editor/packages.json")};_profile.default.set("disable-packages",{});let saveTimer=null;const _profileSave=function(){clearTimeout(saveTimer),saveTimer=setTimeout(()=>{_profile.local.save()},500)},profile={builtin:{get(e){let a=_profile.local.get(`disable-packages.${e}`);return a||null===a||(a=_profile.default.get(`disable-packages.${e}`)),a},add(e,a){_profile.local.set(`disable-packages.${e}`,a),_profileSave()},remove(e){_profile.local.set(`disable-packages.${e}`,null),_profileSave()}},local:{get(e){let a=_profile.local.get(`disable-packages.${e}`);return a||null===a||(a=_profile.default.get(`disable-packages.${e}`)),a},add(e,a){_profile.local.set(`disable-packages.${e}`,a),_profileSave()},remove(e){_profile.local.set(`disable-packages.${e}`,null),_profileSave()}},global:{get(e){let a=_profile.local.get(`disable-packages.${e}`);return a||null===a||(a=_profile.default.get(`disable-packages.${e}`)),a},add(e,a){_profile.local.set(`disable-packages.${e}`,a),_profileSave()},remove(e){_profile.local.set(`disable-packages.${e}`,null),_profileSave()}}};packageManager.debugRely((0,path_1.join)(__dirname,"../../../static/package/debug.js"));const eventEmitter=new events_1.EventEmitter;function getPackages(e){e=e||{};const a=[];return Object.keys(packageManager.path2pkg).forEach(r=>{const t=packageManager.path2pkg[r];"name"in e&&e.name!==t.name||"debug"in e&&e.debug!==t.debug||"path"in e&&e.path!==t.path||"enable"in e&&e.enable!==t.enabled||t.invalid||a.push(t.generateInfo())}),a}function scan(e){return __awaiter(this,void 0,void 0,function*(){if(!(0,fs_extra_1.existsSync)(e))return[];if(!(0,fs_extra_1.statSync)(e).isDirectory())return[];const a=(0,fs_extra_1.readdirSync)(e),r=[];for(let t=0;t<a.length;t++){const o=a[t],n=(0,path_1.join)(e,o);try{if(!(0,fs_extra_1.statSync)(n).isDirectory()&&".asar"!==(0,path_1.extname)(n))continue}catch(e){continue}(0,fs_extra_1.existsSync)((0,path_1.join)(n,"./package.json"))&&(yield register(n)),r.push(n)}return r.filter(Boolean)})}function beforeStartup(e){return __awaiter(this,void 0,void 0,function*(){for(const a in exports.nameMap){const r=exports.nameMap[a];e.includes(a)&&r.builtin.forEach(e=>{_profile.default.set(`disable-packages.${e.path}`,{path:e.path,time:Date.now()})})}})}function startup(e,a){return __awaiter(this,void 0,void 0,function*(){for(const r in exports.nameMap){const t=exports.nameMap[r];if(e.includes(r))continue;let o=!1;if(t.local)for(const e of t.local){if(!profile.local.get(e.path)){try{yield a(e.name,e.path)}catch(e){console.error(e)}o=!0;break}}if(!1===o&&t.global)for(const e of t.global){if(!profile.global.get(e.path)){try{yield a(e.name,e.path)}catch(e){console.error(e)}o=!0;break}}if(!1===o&&t.builtin)for(const e of t.builtin){if(!profile.builtin.get(e.path)){try{yield a(e.name,e.path)}catch(e){console.error(e)}o=!0;break}}if(!1===o&&t.other)for(const e of t.other){try{yield a(e.name,e.path)}catch(e){console.error(e)}o=!0;break}}})}function register(e){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=(0,utils_1.getPosition)(e);if(!a||packageManager.path2pkg[e])return!1;try{const r=packageManager.register(e);if("string"!=typeof r.name)return console.warn(`Invalid name: The extension name is not defined \n  ${e}.`),!1;r.name=r.name.toLowerCase();const t=packageManager.path2pkg[e];return(0,register_1.profile)(r),exports.nameMap[r.name]=exports.nameMap[r.name]||{builtin:[],global:[],local:[],other:[]},exports.nameMap[r.name][a]=exports.nameMap[r.name][a]||[],exports.nameMap[r.name][a].push(t),!0}catch(a){return console.error(`[Extension] Register error: ${e}`),console.error(a),!1}}function unregister(e){return __awaiter(this,void 0,void 0,function*(){if("win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),!(0,utils_1.getPosition)(e))return;const a=packageManager.path2pkg[e];if(a){a.enabled&&(yield disable(e));try{yield packageManager.unregister(e)}catch(e){console.error(e)}if(!packageManager.path2pkg[e]){const r=(0,utils_1.getPosition)(e);r&&exports.nameMap[a.name][r]&&exports.nameMap[a.name][r].find((e,t)=>a===e&&(exports.nameMap[a.name][r].splice(t,1),!0))}}})}function enable(e){return __awaiter(this,void 0,void 0,function*(){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=(0,utils_1.getPosition)(e),r=packageManager.path2pkg[e];if(!r)return void console.warn(`[Package] Unknown and unable to start\n  ${e}`);if(/\./.test(r.name))return void console.warn(`[Package] The extension name is invalid: ${r.name}\n  ${e}`);if(r.json.editor&&!(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(Editor.App.version)),r.json.editor))return void console.warn(`[Package] Skip ${r.json.name}: Require the editor version ${r.json.editor}`);if(r.json.package_version){if(2!==r.json.package_version)return void console.warn(`[Package] Skip ${r.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${r.json.name}: package_version is not defined`);const t=exports.nameMap[r.name];function o(){return __awaiter(this,void 0,void 0,function*(){if(t&&t.builtin)for(const e of t.builtin)if(e.enabled){try{yield packageManager.disable(e.path),console.error(`[Package] Close built-in plug-ins: ${e.name}`)}catch(a){console.error(`[Package] Disable error: ${e.path}`),console.error(a)}e.panels.forEach(e=>{Editor.Panel.close(e)})}})}function n(e){return __awaiter(this,void 0,void 0,function*(){if(t&&t.global)for(const a of t.global){if(a.enabled){try{yield packageManager.disable(a.path)}catch(e){console.error(`[Package] Disable error: ${a.path}`),console.error(e)}a.panels.forEach(e=>{Editor.Panel.close(e)})}if(e){const e={name:a.name,time:(new Date).getTime()};profile.global.add(a.path,e)}}})}function i(e){return __awaiter(this,void 0,void 0,function*(){if(t&&t.local)for(const a of t.local){if(a.enabled){try{yield packageManager.disable(a.path)}catch(e){console.error(`[Package] Disable error: ${a.path}`),console.error(e)}a.panels.forEach(e=>{Editor.Panel.close(e)})}if(e){const e={name:a.name,time:(new Date).getTime()};profile.local.add(a.path,e)}}})}switch(a){case"builtin":yield i(!0),yield n(!0);break;case"global":yield i(!0),yield o();break;case"local":yield n(!0),yield o();break;default:yield i(!0),yield n(!0),yield o()}try{yield packageManager.enable(e)}catch(a){console.error(`[Package] Enable error: ${e}`),console.error(a)}if(profile[a]){profile[a].get(e)&&profile[a].remove(e)}return r})}function disable(e,a){return __awaiter(this,void 0,void 0,function*(){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),a=a||{};const r=(0,utils_1.getPosition)(e);if(!r)return;const t=packageManager.path2pkg[e];if(!t)return;t.panels.forEach(e=>{Editor.Panel.close(e)});try{yield packageManager.disable(e)}catch(e){console.error(`[Package] Disable error: ${t.path}`),console.error(e)}if(profile[r]){const a={name:t.name,time:(new Date).getTime()};profile[r].add(e,a)}if(!1===a.replacement)return;const o=exports.nameMap[t.name];let n=!1;switch(r){case"local":if(!1===n&&o.global)for(const e of o.global){if(!profile.global.get(e.path)){try{yield packageManager.enable(e.path)}catch(a){console.error(`[Package] Enable error: ${e.path}`),console.error(a)}n=!0;break}}case"global":if(!1===n&&o.builtin)for(const e of o.builtin){try{yield packageManager.enable(e.path)}catch(a){console.error(`[Package] Enable error: ${e.path}`),console.error(a)}n=!0;break}}})}function on(e,a){return eventEmitter.on(e,a)}function removeListener(e,a){return eventEmitter.removeListener(e,a)}exports.nameMap={},exports.getPackages=getPackages,exports.scan=scan,exports.beforeStartup=beforeStartup,exports.startup=startup,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.on=on,exports.removeListener=removeListener,packageManager.on("register",e=>{if(/^[a-z0-9][a-z0-9-_.]*$/.test(e.name)||console.warn(`The plug-in name is illegal: ${e.name}`),e.info.hooks){const a=e.info.hooks;if(a.register)try{const r=(0,path_1.join)(e.path,a.register||"");index_1.Module.requireFile(r).run(e.info)}catch(e){console.error(e)}}eventEmitter.emit("register",e)}),packageManager.on("unregister",e=>{eventEmitter.emit("unregister",e)}),packageManager.on("before-enable",e=>{try{const a=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(a))return;if(!(0,fs_extra_1.statSync)(a).isDirectory())return;(0,fs_extra_1.readdirSync)(a).forEach(r=>{try{if(".js"!==(0,path_1.extname)(r))return;const t=(0,path_1.join)(a,r),o=index_1.Module.requireFile(t),n={};n[e.name]=o,i18n.register(n,(0,path_1.basename)(r,".js"))}catch(e){console.warn(e)}})}catch(e){console.error(e)}}),packageManager.on("before-disable",e=>{}),packageManager.on("enable",e=>{console.log(`[Package] ${e.name}@${e.version} enable`),eventEmitter.emit("enable",e)}),packageManager.on("disable",e=>{console.log(`[Package] ${e.name}@${e.version} disable`),eventEmitter.emit("disable",e);try{const a=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(a))return;if(!(0,fs_extra_1.statSync)(a).isDirectory())return;(0,fs_extra_1.readdirSync)(a).forEach(r=>{if(".js"!==(0,path_1.extname)(r))return;const t=(0,path_1.join)(a,r),o=index_1.Module.requireFile(t),n={};n[e.name]=o,i18n.unregister(n,(0,path_1.basename)(r,".js")),index_1.Module.removeCache(t)})}catch(e){console.warn(e)}}),app.once("ready",()=>{protocol.registerFileProtocol("packages",(e,a)=>{const r=(0,url_1.parse)(e.url),t=packageManager.find(r.host);a(t?(0,path_1.join)(t.path,r.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",(e,a,...r)=>__awaiter(void 0,void 0,void 0,function*(){try{const t=yield module.exports[a](...r),o=JSON.stringify(t);return e.reply(null,o),o}catch(a){throw e.reply(a,null),a}}));