"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,i){return new(o||(o=Promise))(function(t,a){function n(e){try{c(i.next(e))}catch(e){a(e)}}function s(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o(function(e){e(r)})).then(n,s)}c((i=i.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../profile/browser/index"),profileMigrationManager=require("./../../profile/browser/migration"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")},MigrationType={global:"migrateGlobal",local:"migrateLocal",project:"migrateProject"};function getJsonPath(e,r){switch(e){case"local":return(0,path_1.join)(Editor.Project.path,"profiles","v2","packages",r+".json");case"project":return(0,path_1.join)(Editor.Project.path,"settings","v2","packages",r+".json");case"global":return(0,path_1.join)(Editor.App.home,"profiles","v2","packages",r+".json")}}function profile(e){return __awaiter(this,void 0,void 0,function*(){const r=e.info;let o=[];Array.isArray(r.migrations)&&(r.migrations.forEach(r=>{r.profile&&(r.profile=(0,path_1.join)(e.path,r.profile)),r.custom&&(r.custom=(0,path_1.join)(e.path,r.custom))}),r.migrations.sort((e,r)=>(0,utils_1.compareVersion)(e.version,r.version||"")),profileMigrationManager._registerMigration(e.name,r.migrations),o=r.migrations.filter(e=>e.version&&e.custom));const i=["global","local","project"].map(i=>__awaiter(this,void 0,void 0,function*(){const t=(0,index_1.ensureProfiles)(e.name),a=t[i].get("__version__");if(e.version!==a){t[i].set("__version__",e.version);const r=getJsonPath(i,e.name);r&&(0,fs_extra_1.existsSync)(r)&&t[i].save()}if(Array.isArray(r.migrations)&&(a||r.migrations.find(e=>"0.0.0"===e.version))&&e.version!==a){if(!a&&r.migrations.find(e=>"0.0.0"===e.version)){console.debug(`[Package] Profile Migrate in version 0.0.0: ${e.name}@${r.author}...`);const o=t[i].get("")||{};try{const a=yield profileMigrationManager[MigrationType[i]](e.name,"0.0.0",o);t[i].set("",o),a&&t[i].save()}catch(o){console.error(`[Package] Custom Migrate error(${i} profile): ${e.name}@${r.author}(0.0.0)`),console.error(o)}return}console.debug(`[Package] Profile Migrate [${a} -> ${e.version}]: ${e.name}@${r.author}...`);const n=t[i].get("")||{};try{yield profileMigrationManager[MigrationType[i]](e.name,a,n),t[i].set("",n)}catch(o){console.error(`[Package] Custom Migrate error [${a} -> ${e.version}] (${i} profile): ${e.name}@${r.author}(${e.version})`),console.error(o)}for(const t of o){if((0,utils_1.compareVersion)(t.version,e.version||"")<=0)try{console.debug(`[Package] Custom Migrate [${a} -> ${e.version}]: ${e.name}@${r.author}(${t.version})`);const o=require(t.custom);o[MigrationType[i]]&&(yield o[MigrationType[i]]())}catch(o){return console.error(`[Package] Custom Migrate [${a} -> ${e.version}] error(${i}): ${e.name}@${r.author}(${t.version})`),void console.error(o)}}t[i].save()}}));return Promise.all(i)})}exports.profile=profile;