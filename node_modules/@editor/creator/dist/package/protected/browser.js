"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))(function(r,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(i,s)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkReload=exports.enableOther=exports.disableOther=exports.startup=exports.queryDisbaleInfo=exports.removeDisableInfo=exports.addDisableInfo=exports.removeListener=exports.emit=exports.once=exports.on=exports.normalizePath=exports.checkVersion=exports.checkType=exports.scan=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),events_1=require("events"),semver_1=require("semver"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),packageManager=require("@editor/package"),profileManager=require("@base/electron-profile"),index_1=require("../../module/index"),constant_1=require("../constant");packageManager.debugRely((0,path_1.join)(__dirname,"../../../static/package/debug.js"));const extensionMap={},profile={default:profileManager.load("defaultPreferences://editor/packages.json"),local:profileManager.load("local://editor/packages.json"),save(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.local.save()},1e3)}};profile.default.set("disable-packages",{});const eventEmitter=new events_1.EventEmitter;function scan(e){return __awaiter(this,void 0,void 0,function*(){if(!(0,fs_extra_1.existsSync)(e))return[];if(!(0,fs_extra_1.statSync)(e).isDirectory())return[];const t=yield(0,fs_extra_1.readdir)(e),a=[];for(let n=0;n<t.length;n++){const r=t[n],o=(0,path_1.join)(e,r);try{if(!(0,fs_extra_1.statSync)(o).isDirectory()&&".asar"!==(0,path_1.extname)(o))continue}catch(e){continue}const i=(0,path_1.join)(o,"./package.json");(0,fs_extra_1.existsSync)(i)&&a.push(o)}return a.filter(Boolean)})}function checkType(e){return Editor.Utils.Path.contains(constant_1.PATHS.BUILTIN,e)?"builtin":Editor.Utils.Path.contains(constant_1.PATHS.LOCAL,e)?"local":Editor.Utils.Path.contains(constant_1.PATHS.COVER,e)?"cover":Editor.Utils.Path.contains(constant_1.PATHS.GLOBAL,e)?"global":"other"}function checkVersion(e){return(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(Editor.App.version)),e)}function normalizePath(e){return e=(0,path_1.normalize)(e),"win32"!==process.platform?e:e.replace(/^([a-z]):/,(e,t)=>t.toUpperCase()+":")}function on(e,t){return eventEmitter.on(e,t)}function once(e,t){return eventEmitter.once(e,t)}function emit(e,...t){const a=eventEmitter.emit(e,...t);return ipc.broadcast("editor-lib-package-protected:emit",e,...t),a}function removeListener(e,t){return eventEmitter.removeListener(e,t)}function addDisableInfo(e){if("builtin"===checkType(e=normalizePath(e)))return;const t={name:(0,path_1.basename)(e),time:Date.now()};profile.local.set(`disable-packages.${e}`,t),profile.save()}function removeDisableInfo(e){e=normalizePath(e),profile.local.remove(`disable-packages.${e}`),profile.save()}function queryDisbaleInfo(e){return __awaiter(this,void 0,void 0,function*(){return e=normalizePath(e),profile.local.get(`disable-packages.${e}`)})}exports.scan=scan,exports.checkType=checkType,exports.checkVersion=checkVersion,exports.normalizePath=normalizePath,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,exports.addDisableInfo=addDisableInfo,exports.removeDisableInfo=removeDisableInfo,exports.queryDisbaleInfo=queryDisbaleInfo;const typeList=["other","local","global","cover","builtin"];function startup(e){return __awaiter(this,void 0,void 0,function*(){for(let t in extensionMap){const a=extensionMap[t];let n=!1;for(let t of typeList){const r=a[t];for(let t of r){if(!(yield queryDisbaleInfo(t.path))){try{yield e(t.name,t.path)}catch(e){console.error(e)}if(packageManager.path2pkg[t.path].enabled){n=!0;break}}}if(n)break}}})}function disableOther(e){return __awaiter(this,void 0,void 0,function*(){const t=checkType(e=normalizePath(e)),a=packageManager.path2pkg[e].name,n=extensionMap[a];if(!n)return;let r=!0;for(let a of typeList){const o=n[a];for(let t of o)t.path!==e&&(yield packageManager.disable(t.path),r&&addDisableInfo(t.path));a===t&&(r=!1)}})}function enableOther(e){return __awaiter(this,void 0,void 0,function*(){e=normalizePath(e);const t=packageManager.path2pkg[e],a=(checkType(e),extensionMap[t.name]);if(!a)return;let n=!1;for(let t of typeList){const r=a[t];for(let t of r){if(t.path===e)continue;try{yield packageManager.enable(t.path),removeDisableInfo(t.path)}catch(e){console.error(e)}if(packageManager.path2pkg[t.path].enabled){n=!0;break}}if(n)break}})}exports.startup=startup,exports.disableOther=disableOther,exports.enableOther=enableOther;const jsonMtimeMap=new Map;function checkReload(e){const t=(0,path_1.join)(e,"package.json");try{const a=(0,fs_extra_1.statSync)(t),n=jsonMtimeMap.get(e);return a.mtime.getTime()-n>1e4}catch(e){}}exports.checkReload=checkReload,ipc.on("editor-lib-package-protected:call",(e,t,...a)=>__awaiter(void 0,void 0,void 0,function*(){switch(t){case"scan":e.reply(null,yield scan(a[0]))}})),packageManager.on("register",e=>{const t=e.name,a=checkType(e.path=normalizePath(e.path));(extensionMap[t]=extensionMap[t]||{other:[],local:[],global:[],cover:[],builtin:[]})[a].push(e)}),packageManager.on("unregister",e=>{const t=e.name,a=checkType(e.path=normalizePath(e.path)),n=extensionMap[t];n&&n[a].find((t,r)=>t.path===e.path&&(n[a].splice(r,1),!0))}),packageManager.on("register",e=>{/^[a-z0-9][a-z0-9-_.]*$/.test(e.name)||console.warn(`The plug-in name is illegal: ${e.name}`);const t=(0,path_1.join)(e.path,"package.json");try{const a=(0,fs_extra_1.statSync)(t);jsonMtimeMap.set(e.path,a.mtime.getTime())}catch(e){}emit("register",e)}),packageManager.on("unregister",e=>{emit("unregister",e)}),packageManager.on("before-enable",e=>{try{const t=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(t))return;if(!(0,fs_extra_1.statSync)(t).isDirectory())return;(0,fs_extra_1.readdirSync)(t).forEach(a=>{try{if(".js"!==(0,path_1.extname)(a))return;const n=(0,path_1.join)(t,a),r=index_1.Module.requireFile(n),o={};o[e.name]=r,i18n.register(o,(0,path_1.basename)(a,".js"))}catch(e){console.warn(e)}})}catch(e){console.error(e)}}),packageManager.on("enable",e=>{const t=`[Package] ${e.name}@${e.version} enable`;console.debug(t),Editor.Logger.__protected__.record(t),emit("enable",e)}),packageManager.on("disable",e=>{const t=`[Package] ${e.name}@${e.version} disable`;console.debug(t),Editor.Logger.__protected__.record(t),emit("disable",e);try{const t=(0,path_1.join)(e.path,"i18n");if(!(0,fs_extra_1.existsSync)(t))return;if(!(0,fs_extra_1.statSync)(t).isDirectory())return;(0,fs_extra_1.readdirSync)(t).forEach(a=>{if(".js"!==(0,path_1.extname)(a))return;const n=(0,path_1.join)(t,a),r=index_1.Module.requireFile(n),o={};o[e.name]=r,i18n.unregister(o,(0,path_1.basename)(a,".js")),index_1.Module.removeCache(n)})}catch(e){console.warn(e)}});