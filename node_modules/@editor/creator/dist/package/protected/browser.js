"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkReload=exports.enableOther=exports.disableOther=exports.startup=exports.queryDisableInfo=exports.removeDisableInfo=exports.addDisableInfo=exports.removeListener=exports.emit=exports.once=exports.on=exports.normalizePath=exports.checkVersion=exports.checkType=exports.scan=exports.compareVersion=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),events_1=require("events"),semver_1=require("semver"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n"),packageManager=require("@editor/package"),profileManager=require("@base/electron-profile"),index_1=require("../../module/index"),constant_1=require("../constant");var utils_1=require("../utils");Object.defineProperty(exports,"compareVersion",{enumerable:!0,get:function(){return utils_1.compareVersion}}),packageManager.debugRely((0,path_1.join)(__dirname,"../../../static/package/debug.js"));const extensionMap={},profile={default:profileManager.load("defaultPreferences://editor/packages.json"),local:profileManager.load("local://editor/packages.json"),save(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.local.save()},1e3)}},eventEmitter=(profile.default.set("disable-packages",{}),new events_1.EventEmitter);async function scan(a){if(!(0,fs_extra_1.existsSync)(a))return[];const t=(0,fs_extra_1.statSync)(a);if(!t.isDirectory())return[];var r=await(0,fs_extra_1.readdir)(a),n=[];for(let e=0;e<r.length;e++){var o=r[e],o=(0,path_1.join)(a,o);try{const t=(0,fs_extra_1.statSync)(o);if(!t.isDirectory()&&".asar"!==(0,path_1.extname)(o))continue}catch(e){continue}var i=(0,path_1.join)(o,"./package.json");(0,fs_extra_1.existsSync)(i)&&n.push(o)}return n.filter(Boolean)}function checkType(e){let a=(0,path_1.relative)(constant_1.PATHS.BUILTIN,e);return a.startsWith("..")||a===e?(a=(0,path_1.relative)(constant_1.PATHS.LOCAL,e)).startsWith("..")||a===e?(a=(0,path_1.relative)(constant_1.PATHS.COVER,e)).startsWith("..")||a===e?(a=(0,path_1.relative)(constant_1.PATHS.GLOBAL,e)).startsWith("..")||a===e?"other":"global":"cover":"local":"builtin"}function checkVersion(e){return(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(Editor.App.version)),e)}function normalizePath(e){return e=(0,path_1.normalize)(e),"win32"!==process.platform?e:e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")}function on(e,a){return eventEmitter.on(e,a)}function once(e,a){return eventEmitter.once(e,a)}function emit(e,...a){var t=eventEmitter.emit(e,...a);return ipc.broadcast("editor-lib-package-protected:emit",e,...a),t}function removeListener(e,a){return eventEmitter.removeListener(e,a)}function addDisableInfo(e){var a;"builtin"!==checkType(e=normalizePath(e))&&(a={name:(0,path_1.basename)(e),time:Date.now()},profile.local.set("disable-packages."+e,a),profile.save())}function removeDisableInfo(e){e=normalizePath(e),profile.local.remove("disable-packages."+e),profile.save()}async function queryDisableInfo(e){return e=normalizePath(e),profile.local.get("disable-packages."+e)}exports.scan=scan,exports.checkType=checkType,exports.checkVersion=checkVersion,exports.normalizePath=normalizePath,exports.on=on,exports.once=once,exports.emit=emit,exports.removeListener=removeListener,exports.addDisableInfo=addDisableInfo,exports.removeDisableInfo=removeDisableInfo,exports.queryDisableInfo=queryDisableInfo;const typeList=["other","local","global","cover","builtin"];async function startup(t){for(var r in extensionMap){var n=extensionMap[r];let e=!1;var o,i,s,c=n.builtin[0];let a=!1;if(c){a=!0;for(var p of typeList)if("builtin"!==p)for(o of n[p])(0,semver_1.gt)(c.version,o.version)||(a=!1)}if(a){try{await t(c.name,c.path)}catch(e){console.error(e)}if(packageManager.path2pkg[c.path].enabled){e=!0;continue}}for(i of typeList){for(s of n[i]){var l=await queryDisableInfo(s.path);if("builtin"===i||!l){try{await t(s.name,s.path)}catch(e){console.error(e)}if(packageManager.path2pkg[s.path].enabled){e=!0;break}}}if(e)break}}}async function disableOther(a){var t,r=checkType(a=normalizePath(a)),n=packageManager.path2pkg[a],e=n.name,o=extensionMap[e];if(o){let e=!0;for(var i of typeList){for(t of o[i])t.path!==a&&(await packageManager.disable(t.path),n.panels.forEach(e=>{Editor.Panel.close(e)}),e)&&addDisableInfo(t.path);i===r&&(e=!1)}}}async function enableOther(a){a=normalizePath(a);const t=packageManager.path2pkg[a];checkType(a);var r,n=extensionMap[t.name];if(n){let e=!1;for(var o of typeList){for(r of n[o])if(r.path!==a){try{await packageManager.enable(r.path),removeDisableInfo(r.path)}catch(e){console.error(e)}const t=packageManager.path2pkg[r.path];if(t.enabled){e=!0;break}}if(e)break}}}exports.startup=startup,exports.disableOther=disableOther,exports.enableOther=enableOther;const jsonMtimeMap=new Map;function checkReload(e){var a=(0,path_1.join)(e,"package.json");try{var t=(0,fs_extra_1.statSync)(a),r=jsonMtimeMap.get(e);return 1e4<t.mtime.getTime()-r}catch(e){}}exports.checkReload=checkReload,ipc.on("editor-lib-package-protected:call",async(e,a,...t)=>{"scan"===a&&e.reply(null,await scan(t[0]))}),packageManager.on("register",e=>{var a=e.name,t=checkType(e.path=normalizePath(e.path));(extensionMap[a]=extensionMap[a]||{other:[],local:[],global:[],cover:[],builtin:[]})[t].push(e)}),packageManager.on("unregister",t=>{var e=t.name;const r=checkType(t.path=normalizePath(t.path)),n=extensionMap[e];n&&n[r].find((e,a)=>e.path===t.path&&(n[r].splice(a,1),!0))}),packageManager.on("register",e=>{/^[a-z0-9][a-z0-9-_.]*$/.test(e.name)||console.warn("The plug-in name is illegal: "+e.name);var a=(0,path_1.join)(e.path,"package.json");try{var t=(0,fs_extra_1.statSync)(a);jsonMtimeMap.set(e.path,t.mtime.getTime())}catch(e){}emit("register",e)}),packageManager.on("unregister",e=>{emit("unregister",e)}),packageManager.on("before-enable",n=>{try{const o=(0,path_1.join)(n.path,"i18n");(0,fs_extra_1.existsSync)(o)&&(0,fs_extra_1.statSync)(o).isDirectory()&&(0,fs_extra_1.readdirSync)(o).forEach(e=>{try{var a,t,r;".js"===(0,path_1.extname)(e)&&(a=(0,path_1.join)(o,e),t=index_1.Module.requireFile(a),(r={})[n.name]=t,i18n.register(r,(0,path_1.basename)(e,".js")))}catch(e){console.warn(e)}})}catch(e){console.error(e)}}),packageManager.on("enable",e=>{var a=`[Package] ${e.name}@${e.version} enable`;console.debug(a),Editor.Logger.__protected__.record(a),emit("enable",e)}),packageManager.on("disable",n=>{var e=`[Package] ${n.name}@${n.version} disable`;console.debug(e),Editor.Logger.__protected__.record(e),emit("disable",n);try{const o=(0,path_1.join)(n.path,"i18n");(0,fs_extra_1.existsSync)(o)&&(0,fs_extra_1.statSync)(o).isDirectory()&&(0,fs_extra_1.readdirSync)(o).forEach(e=>{var a,t,r;".js"===(0,path_1.extname)(e)&&(a=(0,path_1.join)(o,e),t=index_1.Module.requireFile(a),(r={})[n.name]=t,i18n.unregister(r,(0,path_1.basename)(e,".js")),index_1.Module.removeCache(a))})}catch(e){console.warn(e)}});