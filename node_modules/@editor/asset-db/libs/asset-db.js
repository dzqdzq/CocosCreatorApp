"use strict";"use stirct";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetDB=exports.version=exports.map=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),events_1=require("events"),node_uuid_1=require("node-uuid"),importer_1=require("./importer"),asset_1=require("./asset"),utils_1=require("./utils"),meta_1=require("./meta"),info_1=require("./info"),task_1=require("./task"),dependency_1=require("./dependency"),data_1=require("./data"),manager_1=require("./manager"),workflow_extra_1=require("workflow-extra"),fast_glob_1=__importDefault(require("fast-glob"));var manager_2=require("./manager");function getAsset(t){for(let e in manager_1.map){const s=manager_1.map[e].uuid2asset.get(t);if(s)return s}}Object.defineProperty(exports,"map",{enumerable:!0,get:function(){return manager_2.map}}),exports.version="2.0.0";class AssetDB extends events_1.EventEmitter{constructor(t){super(),this.flag={starting:!1,started:!1},this.path2asset=new Map,this.uuid2asset=new Map,this.importerManager=new importer_1.ImporterManager(this),this._lock=!1,this._waitLockHandler=[],t.target&&t.library?(t.target=(0,utils_1.absolutePath)(t.target),t.library=(0,utils_1.absolutePath)(t.library),t.temp||(t.temp=(0,path_1.join)(t.library,".temp")),t.temp=(0,utils_1.absolutePath)(t.temp)):console.error("The database cannot be created because there is no target or library definition"),(!("level"in t)||t.level>4||t.level<0)&&(t.level=4),t.ignoreFiles&&Array.isArray(t.ignoreFiles)||(t.ignoreFiles=[]),this.options=t,this.taskManager=new workflow_extra_1.ParallelQueue(async t=>{const e=await this.importerManager.find(t);if(!e||t.action!==asset_1.AssetActionEnum.delete&&e.name!==t.meta.importer&&"*"!==t.meta.importer&&t.imported)return t.init||(this.options.level>=1&&console.error(`Unable to import data, no suitable importer was found. {asset[${t instanceof asset_1.Asset?t.basename:""}](${t.uuid})}`),t.invalid=!0,t.init=!0),!1;switch(t.action){case asset_1.AssetActionEnum.add:case asset_1.AssetActionEnum.change:if(this.dataManaer.empty(t),await task_1.TASK_MAP.import.exec(this,t,e,!0)&&await t.save(),t instanceof asset_1.Asset){const e=(0,fs_extra_1.statSync)(t.source);this.infoManager.add(t.source,e.mtimeMs,t.uuid)}(0,manager_1.importAssociatedAssets)(this,t);break;case asset_1.AssetActionEnum.delete:if(this.dataManaer.empty(t),await task_1.TASK_MAP.destroy.exec(this,t),t instanceof asset_1.Asset){const e=t.source+".meta";this.metaManager.remove(e),this.infoManager.remove(t.source),this.infoManager.remove(e)}(0,manager_1.importAssociatedAssets)(this,t);break;case asset_1.AssetActionEnum.none:await task_1.TASK_MAP.import.exec(this,t,e,!1)&&await t.save()}return t.init=!0,t.action!==asset_1.AssetActionEnum.none&&this.dataManaer.save(),t.action=asset_1.AssetActionEnum.none,!0},5),this.metaManager=new meta_1.MetaManager,this.infoManager=new info_1.InfoManager,this.dependencyManager=new dependency_1.DependencyManager,this.dataManaer=new data_1.DataManager,this.importerManager.add(importer_1.DefaultImporter,["*"])}async lock(){return this._lock?await new Promise((t,e)=>{this._waitLockHandler.push(()=>{t(null)})}):this._lock=!0}unlock(){const t=this._waitLockHandler.shift();t?t():this._lock=!1}async start(t={}){if(!this.options.target||!this.options.library||!this.options.temp)return void(this.options.level>=1&&console.error("Parameter error, unable to start."));if(this.flag.started&&this.options.level>=2)return void console.warn(`The ${this.options.name} database is already started.`);this.flag.started=!0,this.flag.starting=!0,await this.metaManager.setBackupPath((0,path_1.join)(this.options.temp,"meta")),await this.metaManager.setRecordJSON((0,path_1.join)(this.options.library,`.${this.options.name}-meta.json`)),await this.infoManager.setRecordJSON((0,path_1.join)(this.options.library,`.${this.options.name}-info.json`)),await this.dataManaer.setRecordJSON((0,path_1.join)(this.options.library,`.${this.options.name}-data.json`)),await this.dependencyManager.setRecordJSON((0,path_1.join)(this.options.library,`.${this.options.name}-dependency.json`)),manager_1.map[this.options.name]=this;let e=await this.refresh(this.options.target,{ignoreSelf:!0,hooks:t.hooks}),s=!1;for(let t in this.infoManager.map)if(!this.path2asset.has(t)&&this.infoManager.map[t].uuid&&!this.infoManager.map[t].missing)try{const e=this.infoManager.map[t].uuid;if(getAsset(e))continue;const a=`${this.options.library}${path_1.sep}${e.substr(0,2)}`;if((0,fs_extra_1.existsSync)(a)){const t=await(0,fs_extra_1.readdir)(a);for(let s of t)s.startsWith(e)&&await(0,fs_extra_1.remove)((0,path_1.join)(a,s))}this.infoManager.map[t].missing=!0,s=!0}catch(t){console.warn(t)}return s&&this.infoManager.save(),new Promise(t=>{const s=()=>{setTimeout(()=>{if(!this.taskManager.busy())return this.flag.starting=!1,t(e);this.taskManager.waitQueue().then(()=>{s()})},10)};s()})}async stop(){this.uuid2asset.clear(),this.path2asset.clear(),this.flag.started=!1,this.metaManager.saveImmediate(),this.infoManager.saveImmediate(),this.dependencyManager.saveImmediate(),this.dataManaer.saveImmediate(),this.metaManager.destroy(),this.infoManager.destroy(),this.dependencyManager.destroy(),manager_1.map[this.options.name]===this&&delete manager_1.map[this.options.name]}pathToUuid(t){let e=this.path2asset.get(t);return e?e.uuid:null}uuidToPath(t){let e=this.uuid2asset.get(t);return e?e.source:null}getAsset(t){if(!t||"string"!=typeof t)return null;let e=t.split("@"),s=e.shift()||"",a=this.uuid2asset.get(s);if(!a)return null;for(let t=0;t<e.length;t++){let s=e[t];if(!(a=a.subAssets[s]))return null}return a||null}async reimport(t){const e=this.path2asset.get(t)||this.getAsset(t);if(!e)return!0;if(this.options.flags&&this.options.flags.reimportCheck&&!e._lock&&e.action!==asset_1.AssetActionEnum.none)return!0;if(await this.lock(),e instanceof asset_1.Asset){this.metaManager.read(e.source+".meta");const t=e.meta.importer;e.meta.importer="*";const s=await this.importerManager.find(e);if(!s)throw new Error(`Unable to import data, no suitable importer was found.\n  path: ${e.source}\n  uuid: ${e.uuid}`);t===s.name&&(e.meta.importer=s.name)}try{if(!e.init)return this.unlock(),!1;e.init=!1,e.action=asset_1.AssetActionEnum.change,e.task=this.taskManager.addTask(e)}catch(t){console.error(t)}this.unlock(),await this.taskManager.waitQueue()}async refresh(t,e={}){if(!(0,utils_1.absolutePath)(t))return 0;(t=(0,path_1.normalize)(t))===this.options.target&&(e.ignoreSelf=!0);let s,a=(0,path_1.dirname)(t);for(;(0,utils_1.isSubPath)(a,this.options.target)&&!this.path2asset.has(a);)t=a,a=(0,path_1.dirname)(a);if(!(0,utils_1.isSubPath)(t,this.options.target)&&t!==this.options.target)return 0;try{if((0,fs_extra_1.statSync)(t).isFile())s=[t];else{const e="win32"===process.platform?t.replace(/\\/g,"/"):t,a=["**/*","!**/*.meta"];this.options.ignoreGlob&&a.push(this.options.ignoreGlob),(s=fast_glob_1.default.sync(a,{onlyFiles:!1,cwd:e})).forEach((t,a)=>{s[a]=(0,path_1.join)(e,t)}),t!==this.options.target&&s.splice(0,0,t)}}catch(t){s=[]}const i=new Set,n=new Set,r=new Set;try{const e=[],a=[],o=[];if(this.preImporterHandler)for(let t of s)this.path2asset.has(t)||(this.preImporterHandler(t)?e.push(t):a.push(t),r.add(t)),i.add(t);else for(let t of s)this.path2asset.has(t)||(a.push(t),r.add(t)),i.add(t);this.path2asset.forEach((e,a)=>{0!==s.length&&i.has(a)||(a===t||(0,utils_1.isSubPath)(a,t))&&(o.push(a),n.add(a))}),this.taskManager.stop(),this._checkAssetsStatSync(e,o,n),this._checkAssetsStatSync(a,o,n),this.emit("refresh-uuid-ready",t),await this.lock();const h=[];for(let t of s)if(!r.has(t)&&!n.has(t)){const e=this.path2asset.get(t);e&&h.push(this._checkAssetStat(e))}await Promise.all(h)}catch(t){return console.error(t),this.unlock(),0}if(e.hooks&&e.hooks.afterGenerateMete)try{await e.hooks.afterGenerateMete()}catch(t){console.error(t)}this.taskManager.start();try{await this.taskManager.waitQueue()}catch(t){console.error(t)}this.unlock();const o=this.taskManager.total();if(this.taskManager.clear(),e.hooks&&e.hooks.afterRefresh)try{await e.hooks.afterRefresh()}catch(t){console.error(t)}return o}_replaceUUID(t,e){if(e!==t){const s=(0,node_uuid_1.v4)();if(this.options.level>=2){let a=JSON.stringify([t.source,e.source],null,2);console.warn(`The uuid is already pointing to another resource.\n${a}\nThe file uuid has been updated: ${t.source}\n    ${t.uuid} -> ${s}`)}t.meta.uuid=s}}_checkAssetsStatSync(t,e,s){for(let t of e){const e=this.path2asset.get(t);if(e){e.action=asset_1.AssetActionEnum.delete,e.task=this.taskManager.addTask(e),this.uuid2asset.delete(e.uuid),this.path2asset.delete(e.source);const t=e.source+".meta";this.metaManager.remove(t),this.infoManager.remove(e.source),this.infoManager.remove(t)}}for(let e of t){const t=e+".meta",a=this.metaManager.get(t),i=getAsset(a.json.uuid);if(i)if(s.has(i.source)||i.source!==e&&!(0,fs_extra_1.existsSync)(i.source)){const t=i;this.path2asset.delete(t.source),this.infoManager.remove(t.source),this.metaManager.remove(t.source+".meta"),this.infoManager.remove(t.source+".meta"),t._source=e,t.extname=(0,path_1.extname)(e).toLowerCase(),t.basename=(0,path_1.basename)(e,t.extname),t.updateUrl(),t.meta=a.json,this.path2asset.set(t.source,t),t.action=asset_1.AssetActionEnum.change,t.task=this.taskManager.addTask(t)}else{const t=new asset_1.Asset(e,a.json,this);this._replaceUUID(t,i),t.save(),t.action=asset_1.AssetActionEnum.add,t.task=this.taskManager.addTask(t),this.uuid2asset.set(t.uuid,t),this.path2asset.set(t.source,t)}else if(this.flag.starting){const s=(0,fs_extra_1.statSync)(e),i=new asset_1.Asset(e,a.json,this);if(this.infoManager.compare(e,s.mtimeMs)){const e=(0,fs_extra_1.statSync)(t);if(this.infoManager.compare(t,e.mtimeMs))this.dataManaer.has(i)?(i.action=asset_1.AssetActionEnum.none,i.task=this.taskManager.addTask(i)):(i.action=asset_1.AssetActionEnum.change,i.task=this.taskManager.addTask(i));else{this.emit("deleted",i),i.action=asset_1.AssetActionEnum.add;const s=i.uuid;this.metaManager.read(t),i.uuid!==s&&(this.uuid2asset.delete(s),this.uuid2asset.has(i.uuid)&&this._replaceUUID(i,getAsset(i.uuid)),this.uuid2asset.set(i.uuid,i)),this.infoManager.add(t,e.mtimeMs),i.task=this.taskManager.addTask(i)}}else i.action=asset_1.AssetActionEnum.add,this.infoManager.add(e,s.mtimeMs),i.task=this.taskManager.addTask(i);this.uuid2asset.set(i.uuid,i),this.path2asset.set(i.source,i)}else{const s=getAsset(a.json.uuid),i=new asset_1.Asset(e,a.json,this);s&&(this._replaceUUID(i,s),i.save());const n=(0,fs_extra_1.statSync)(t);if((!this.infoManager.get(t)||this.infoManager.get(e)&&this.infoManager.get(e).missing)&&this.infoManager.add(t,n.mtimeMs),this.infoManager.compare(t,n.mtimeMs))i.action=asset_1.AssetActionEnum.add,i.task=this.taskManager.addTask(i),this.uuid2asset.set(i.uuid,i),this.path2asset.set(i.source,i);else{this.emit("deleted",i),i.action=asset_1.AssetActionEnum.add;const e=i.uuid;this.metaManager.read(t),i.uuid!==e&&this.uuid2asset.delete(e),this.infoManager.add(t,n.mtimeMs),i.task=this.taskManager.addTask(i),this.uuid2asset.set(i.uuid,i),this.path2asset.set(i.source,i)}}}}async _checkAssetStat(t){const e=t.source,s=e+".meta",a=await(0,fs_extra_1.stat)(s);if(await this.infoManager.compare(s,a.mtimeMs)){const s=await(0,fs_extra_1.stat)(e);this.infoManager.compare(e,s.mtimeMs)?this.dataManaer.has(t)?(t.action=asset_1.AssetActionEnum.none,t.task=this.taskManager.addTask(t)):(t.action=asset_1.AssetActionEnum.change,t.task=this.taskManager.addTask(t)):(this.infoManager.add(e,s.mtimeMs,t.uuid),t.action=asset_1.AssetActionEnum.change,t.task=this.taskManager.addTask(t))}else{this.emit("deleted",t),t.action=asset_1.AssetActionEnum.add;const e=t.uuid;this.metaManager.read(s),t.uuid!==e&&(this.uuid2asset.delete(e),this.uuid2asset.has(t.uuid)&&this._replaceUUID(t,getAsset(t.uuid)),this.uuid2asset.set(t.uuid,t)),this.infoManager.add(s,a.mtimeMs),t.task=this.taskManager.addTask(t)}}}exports.AssetDB=AssetDB;