'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AssetDB = exports.version = exports.map = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const events_1 = require("events");
const node_uuid_1 = require("node-uuid");
const importer_1 = require("./importer");
const asset_1 = require("./asset");
const utils_1 = require("./utils");
const meta_1 = require("./meta");
const info_1 = require("./info");
const task_1 = require("./task");
const dependency_1 = require("./dependency");
const data_1 = require("./data");
const manager_1 = require("./manager");
const workflow_extra_1 = require("workflow-extra");
const fast_glob_1 = __importDefault(require("fast-glob"));
const console_1 = require("./console");
var manager_2 = require("./manager");
Object.defineProperty(exports, "map", { enumerable: true, get: function () { return manager_2.map; } });
function getAsset(uuid) {
    for (let name in manager_1.map) {
        const db = manager_1.map[name];
        const asset = db.uuid2asset.get(uuid);
        if (asset) {
            return asset;
        }
    }
    return undefined;
}
let deprecatedFlag = false;
exports.version = '2.0.0';
class AssetDB extends events_1.EventEmitter {
    /**
     * @deprecated AssetDB.dataManaer is deprecated, Please use AssetDB.dataManager instead.
     */
    get dataManaer() {
        if (!deprecatedFlag) {
            console.debug('AssetDB.dataManaer is deprecated, Please use AssetDB.dataManager instead.');
            deprecatedFlag = true;
        }
        // 兼容旧版本用法
        return this.dataManager;
    }
    ;
    get assetProgressInfo() {
        return {
            // @ts-ignore TODO taskManager 是否可以提供此字段
            current: this.taskManager._execID - this.taskManager._execThread,
            total: this.taskManager.total(),
            // @ts-ignore TODO taskManager 是否可以提供此字段
            wait: this.taskManager._waitQueue.size,
        };
    }
    /**
     * 锁定资源
     */
    async lock() {
        if (!this._lock) {
            return this._lock = true;
        }
        return await new Promise((resolve, reject) => {
            this._waitLockHandler.push(() => {
                resolve(null);
            });
        });
    }
    /**
     * 解锁资源
     */
    unlock() {
        const handle = this._waitLockHandler.shift();
        // 如果有等待的任务，则执行下一个
        if (handle) {
            handle();
            return;
        }
        // 已经没有在等待的任务了，还原标记
        this._lock = false;
    }
    /**
     * 实例化过程
     * @param options
     */
    constructor(options) {
        super();
        // 标记
        this.flag = {
            // 是否正在启动
            starting: false,
            // 是否已经启动的标记
            started: false,
        };
        // path 对应 asset 的 map
        this.path2asset = new Map;
        // uuid 对应 asset 的 map
        this.uuid2asset = new Map;
        this._lock = false;
        this._waitLockHandler = [];
        if (!options.target || !options.library) {
            console.error(`The database(${options.name}) cannot be created because there is no target or library definition`);
        }
        else {
            options.target = (0, utils_1.absolutePath)(options.target);
            options.library = (0, utils_1.absolutePath)(options.library);
            if (!options.temp) {
                options.temp = (0, path_1.join)(options.library, '.temp');
            }
            options.temp = (0, utils_1.absolutePath)(options.temp);
        }
        // 设置输出等级
        if (!('level' in options) || options.level > 4 || options.level < 0) {
            options.level = 4;
        }
        if (!options.ignoreFiles || !Array.isArray(options.ignoreFiles)) {
            options.ignoreFiles = [];
        }
        this.options = options;
        // 启动数据库内置的各个管理器管理器
        this.taskManager = new workflow_extra_1.ParallelQueue(async (asset) => {
            const importer = await this.importerManager.find(asset);
            if (!importer ||
                // 删除的时候很可能文件不存在，所以 importer 有一定概率是 *，这时候和原有的导入器肯定不匹配，所以不需要处理删除
                (asset.action !== asset_1.AssetActionEnum.delete &&
                    (importer.name !== asset.meta.importer && asset.meta.importer !== '*') &&
                    asset.imported)) {
                if (!asset.init) {
                    if (this.options.level >= 1) {
                        this.console.error(`Unable to import data, no suitable importer was found. {asset[${asset instanceof asset_1.Asset ? asset.basename : ''}](${asset.uuid})}`);
                    }
                    asset.invalid = true;
                    asset.init = true;
                }
                return false;
            }
            switch (asset.action) {
                case asset_1.AssetActionEnum.add: {
                    this.dataManager.empty(asset);
                    if (await task_1.TASK_MAP.import.exec(this, asset, importer, true)) {
                        await asset.save();
                    }
                    if (asset instanceof asset_1.Asset) {
                        const assetStats = (0, fs_extra_1.statSync)(asset.source);
                        this.infoManager.add(asset.source, assetStats.mtimeMs, asset.uuid);
                    }
                    (0, manager_1.importAssociatedAssets)(this, asset);
                    // this.emit('added', asset);
                    break;
                }
                case asset_1.AssetActionEnum.change: {
                    this.dataManager.empty(asset);
                    // await TASK_MAP.destroy.exec(this, asset);
                    if (await task_1.TASK_MAP.import.exec(this, asset, importer, true)) {
                        await asset.save();
                    }
                    if (asset instanceof asset_1.Asset) {
                        const assetStats = (0, fs_extra_1.statSync)(asset.source);
                        this.infoManager.add(asset.source, assetStats.mtimeMs, asset.uuid);
                    }
                    (0, manager_1.importAssociatedAssets)(this, asset);
                    // this.emit('changed', asset);
                    break;
                }
                case asset_1.AssetActionEnum.delete: {
                    this.dataManager.empty(asset);
                    await task_1.TASK_MAP.destroy.exec(this, asset);
                    if (asset instanceof asset_1.Asset) {
                        const metaFile = asset.source + '.meta';
                        this.metaManager.remove(metaFile);
                        this.infoManager.remove(asset.source);
                        this.infoManager.remove(metaFile);
                    }
                    (0, manager_1.importAssociatedAssets)(this, asset);
                    // this.emit('deleted', asset);
                    break;
                }
                case asset_1.AssetActionEnum.none: {
                    if (await task_1.TASK_MAP.import.exec(this, asset, importer, false)) {
                        await asset.save();
                    }
                    break;
                }
            }
            asset.init = true;
            if (asset.action !== asset_1.AssetActionEnum.none) {
                this.dataManager.save();
            }
            asset.action = asset_1.AssetActionEnum.none;
            return true;
        }, 5);
        // 全局可用的系统相关的管理器
        this.console = new console_1.CustomConsole(options.level);
        this.metaManager = new meta_1.MetaManager(this.console);
        this.infoManager = new info_1.InfoManager(this.console);
        this.dependencyManager = new dependency_1.DependencyManager(this.console);
        this.dataManager = new data_1.DataManager(this.console);
        this.importerManager = new importer_1.ImporterManager(this.console);
        // 注册默认的解析器
        this.importerManager.add(importer_1.DefaultImporter, ['*']);
    }
    /**
     * 启动资源数据库
     */
    async start(options = {}) {
        if (!this.options.target || !this.options.library || !this.options.temp) {
            if (this.options.level >= 1) {
                this.console.error(`Parameter error, unable to start asset-db(${this.options.name}) with option ${this.options}.`);
            }
            return;
        }
        if (this.flag.started && this.options.level >= 2) {
            this.console.warn(`The ${this.options.name} database is already started.`);
            return;
        }
        this.flag.started = true;
        this.flag.starting = true;
        await this.infoManager.setRecordJSON((0, path_1.join)(this.options.library, `.${this.options.name}-info.json`));
        await this.dataManager.setRecordJSON((0, path_1.join)(this.options.library, `.${this.options.name}-data.json`));
        await this.dependencyManager.setRecordJSON((0, path_1.join)(this.options.library, `.${this.options.name}-dependency.json`));
        // 要在资源刷新前加入缓存
        manager_1.map[this.options.name] = this;
        // 刷新资源数据库内的资源列表
        let num = await this.refresh(this.options.target, {
            ignoreSelf: true,
            hooks: options.hooks,
        });
        this.console.debug(`start asset-db(${this.options.name}) with asset: ${num}`);
        let infoDirty = false;
        // 删除已经不存在的资源
        // mtime 记录的都是之前存在的文件，所以循环 mtime 管理器里的数据进行校验
        await this.infoManager.forEach(async (path, info) => {
            if (!this.path2asset.has(path) && this.infoManager.get(path).uuid) {
                try {
                    const uuid = info.uuid;
                    if (getAsset(uuid)) {
                        return;
                    }
                    const dir = `${this.options.library}${path_1.sep}${uuid.substr(0, 2)}`;
                    if ((0, fs_extra_1.existsSync)(dir)) {
                        const list = await (0, fs_extra_1.readdir)(dir);
                        for (let name of list) {
                            if (name.startsWith(uuid)) {
                                await (0, fs_extra_1.remove)((0, path_1.join)(dir, name));
                            }
                        }
                    }
                    this.infoManager.remove(path);
                    infoDirty = true;
                }
                catch (error) {
                    this.console.warn(error);
                }
            }
        });
        infoDirty && this.infoManager.save();
        // await this.taskManager.waitQueue();
        // return num;
        return new Promise((resolve) => {
            const step = () => {
                setTimeout(async () => {
                    if (!this.taskManager.busy()) {
                        this.flag.starting = false;
                        if (options.hooks && options.hooks.afterStart) {
                            try {
                                await options.hooks.afterStart();
                            }
                            catch (error) {
                                this.console.error(error);
                            }
                        }
                        return resolve(num);
                    }
                    this.taskManager.waitQueue().then(() => {
                        step();
                    });
                }, 10);
            };
            step();
        });
    }
    /**
     * 停止资源数据库
     */
    async stop() {
        this.uuid2asset.clear();
        this.path2asset.clear();
        this.flag.started = false;
        this.infoManager.saveImmediate();
        this.dependencyManager.saveImmediate();
        this.dataManager.saveImmediate();
        this.metaManager.destroy();
        this.infoManager.destroy();
        this.dependencyManager.destroy();
        if (manager_1.map[this.options.name] === this) {
            delete manager_1.map[this.options.name];
        }
    }
    /**
     * 传入 path，返回 asset-db 内对应的 uuid
     * 不存在则返回 null
     * @param path
     */
    pathToUuid(path) {
        let asset = this.path2asset.get(path);
        if (!asset) {
            return null;
        }
        return asset.uuid;
    }
    /**
     * 传入 uuid，返回对应的资源的 path
     * @param uuid
     */
    uuidToPath(uuid) {
        let asset = this.uuid2asset.get(uuid);
        if (!asset) {
            return null;
        }
        return asset.source;
    }
    /**
     * 查询资源实例
     * @param uuid
     */
    getAsset(uuid) {
        if (!uuid || typeof uuid !== 'string') {
            return null;
        }
        let search = uuid.split('@');
        let id = search.shift() || '';
        let asset = this.uuid2asset.get(id);
        if (!asset) {
            return null;
        }
        for (let i = 0; i < search.length; i++) {
            let idOrName = search[i];
            asset = asset.subAssets[idOrName];
            if (!asset) {
                return null;
            }
        }
        return asset || null;
    }
    /**
     * 重新导入
     * @param fileOrUUID
     */
    async reimport(fileOrUUID) {
        const asset = this.path2asset.get(fileOrUUID) || this.getAsset(fileOrUUID);
        if (!asset) {
            return true;
        }
        // 暂时使用开关控制
        if (this.options.flags && this.options.flags.reimportCheck && !asset._lock && asset.action !== asset_1.AssetActionEnum.none) {
            return true;
        }
        // 需要先锁定，因为如果开始导入，init 还是 false，但资源已经被锁定，所以等待资源锁定状态结束，再开始导入
        await this.lock();
        // 强制重新触发查找 importer 的动作
        if (asset instanceof asset_1.Asset) {
            this.metaManager.read(asset.source + '.meta');
            const oldImporter = asset.meta.importer;
            asset.meta.importer = '*';
            const importer = await this.importerManager.find(asset);
            if (!importer) {
                throw new Error(`Unable to import data, no suitable importer was found.\n  path: ${asset.source}\n  uuid: ${asset.uuid}`);
            }
            else if (oldImporter === importer.name) {
                asset.meta.importer = importer.name;
            }
        }
        try {
            if (!asset.init) {
                this.unlock();
                return false;
            }
            asset.init = false;
            asset.action = asset_1.AssetActionEnum.change;
            asset.task = this.taskManager.addTask(asset);
        }
        catch (error) {
            this.console.error(error);
        }
        this.unlock();
        await this.taskManager.waitQueue();
    }
    /**
     * 刷新资源
     * 传入某一个文件或者文件夹，进行数据库刷新操作
     * 会优先同步扫描所有资源，然后等待其他 refresh 队列
     * 默认 refresh 是有队列的，多个 refresh 同时执行需要进入队列等待
     * @param path
     * @returns {number} 刷新的资源个数
     */
    async refresh(path, options = {}) {
        // 如果不是绝对路径，不刷新
        if (!(0, utils_1.absolutePath)(path)) {
            return 0;
        }
        path = (0, path_1.normalize)(path);
        // 如果是数据库文件夹，默认就忽略自己
        if (path === this.options.target) {
            options.ignoreSelf = true;
        }
        // 向上递归查询，查询自己的父级文件夹是否存在
        // 如果父文件夹不在 db 里，则自动加入
        let parentDir = (0, path_1.dirname)(path);
        while ((0, utils_1.isSubPath)(parentDir, this.options.target) && !this.path2asset.has(parentDir)) {
            path = parentDir;
            parentDir = (0, path_1.dirname)(parentDir);
        }
        // 检查是不是配置的 root 路径的子目录，如果不是子路径，则返回刷新 0 个资源
        if (!(0, utils_1.isSubPath)(path, this.options.target) && path !== this.options.target) {
            return 0;
        }
        let files = [];
        // 刷新路径不存在时可能是已被删除的资源需要更新数据库信息，不报错
        if ((0, fs_extra_1.existsSync)(path)) {
            try {
                const fileStat = (0, fs_extra_1.statSync)(path);
                if (fileStat.isFile()) {
                    files = [path];
                }
                else {
                    const globPath = process.platform === 'win32' ? path.replace(/\\/g, '/') : path;
                    // ! 要写绝对路径，否则可能在某些 win 机器上无法忽略文件
                    const search = options.globList || [
                        `**/*`,
                        `!**/*.meta`,
                    ];
                    if (this.options.ignoreGlob) {
                        search.push(this.options.ignoreGlob);
                    }
                    files = fast_glob_1.default.sync(search, {
                        onlyFiles: false,
                        // 如果将 path 传入 search 数组，卢经理带有 () 就无法正确识别了，所以需要使用 cwd
                        cwd: globPath,
                        // dot: true,
                    });
                    files.forEach((file, index) => {
                        files[index] = (0, path_1.join)(globPath, file);
                    });
                    // 当扫描的路径不是根目录的时候，把被扫描的路径也检查一次
                    if (path !== this.options.target) {
                        files.splice(0, 0, path);
                    }
                }
            }
            catch (error) {
                this.console.error(error);
                files = [];
            }
        }
        // 文件分组，如果有多个组，会在上一个组导入完成后，才开始下一个组的导入流程
        if (options.hooks && options.hooks.afterScan) {
            try {
                await options.hooks.afterScan(files);
            }
            catch (error) {
                this.console.error(error);
            }
        }
        // 扫描文件到的文件记录
        const fileSet = new Set();
        const deleteSet = new Set();
        const addSet = new Set();
        try {
            const preAddFiles = [];
            const addFiles = [];
            const deleteFiles = [];
            if (this.preImporterHandler) {
                for (let file of files) {
                    if (!this.path2asset.has(file)) {
                        if (this.preImporterHandler(file)) {
                            preAddFiles.push(file);
                        }
                        else {
                            addFiles.push(file);
                        }
                        addSet.add(file);
                    }
                    fileSet.add(file);
                }
            }
            else {
                for (let file of files) {
                    if (!this.path2asset.has(file)) {
                        addFiles.push(file);
                        addSet.add(file);
                    }
                    fileSet.add(file);
                }
            }
            this.path2asset.forEach((asset, file) => {
                if (files.length === 0 || !fileSet.has(file)) {
                    if (file === path || (0, utils_1.isSubPath)(file, path)) {
                        deleteFiles.push(file);
                        deleteSet.add(file);
                    }
                }
            });
            this.taskManager.stop();
            // 判断添加的资源和移动、删除的资源
            this._checkAssetsStatSync(preAddFiles, deleteFiles, deleteSet);
            if (options.hooks && options.hooks.afterPreImport) {
                try {
                    await options.hooks.afterPreImport();
                }
                catch (error) {
                    this.console.error(error);
                }
            }
            this._checkAssetsStatSync(addFiles, deleteFiles, deleteSet);
            this.emit('refresh-uuid-ready', path);
            // 锁定任务栈
            await this.lock();
            // 没有改动的数据
            const tasks = [];
            for (let file of files) {
                if (!addSet.has(file) && !deleteSet.has(file)) {
                    const asset = this.path2asset.get(file);
                    if (asset) {
                        tasks.push(this._checkAssetStat(asset));
                    }
                }
            }
            // 使用 Promise.all 会导致部分资源问题导致全部资源都无法刷新
            const result = await Promise.allSettled(tasks);
            result.forEach((res) => {
                // 失败的任务需要报错
                if (res.status === 'rejected') {
                    console.error(res.reason);
                }
            });
        }
        catch (error) {
            this.console.error(error);
            this.unlock();
            return 0;
        }
        if (options.hooks && options.hooks.afterGenerateMete) {
            try {
                await options.hooks.afterGenerateMete();
            }
            catch (error) {
                this.console.error(error);
            }
        }
        this.taskManager.start();
        try {
            await this.taskManager.waitQueue();
        }
        catch (error) {
            this.console.error(error);
        }
        this.unlock();
        // 返回所有文件的个数
        const num = this.taskManager.total();
        this.taskManager.clear();
        if (options.hooks && options.hooks.afterRefresh) {
            try {
                await options.hooks.afterRefresh();
            }
            catch (error) {
                this.console.error(error);
            }
        }
        return num;
    }
    _replaceUUID(asset, oAsset) {
        if (oAsset !== asset) {
            if (asset.source === oAsset.source) {
                console.trace(`_replaceUUID invalid in asset ${asset.source}`);
                return;
            }
            const newUUID = (0, node_uuid_1.v4)();
            // 提示两个文件 uuid 冲突
            if (this.options.level >= 2) {
                let info = JSON.stringify([
                    asset.source,
                    oAsset.source,
                ], null, 2);
                this.console.warn(`The uuid is already pointing to another resource.\n${info}\nThe file uuid has been updated: ${asset.source}\n    ${asset.uuid} -> ${newUUID}`);
            }
            asset.meta.uuid = newUUID;
        }
    }
    /**
     * 检查资源状态
     * 识别是新增、修改还是删除了资源
     * @param addFiles
     * @param deleteFiles
     */
    _checkAssetsStatSync(addFiles, deleteFiles, deleteSet) {
        for (let file of deleteFiles) {
            // 毋庸置疑的删除文件
            const asset = this.path2asset.get(file);
            if (asset) {
                asset.action = asset_1.AssetActionEnum.delete;
                asset.task = this.taskManager.addTask(asset);
                this.uuid2asset.delete(asset.uuid);
                this.path2asset.delete(asset.source);
                const metaFile = asset.source + '.meta';
                this.metaManager.remove(metaFile);
                this.infoManager.remove(asset.source);
                this.infoManager.remove(metaFile);
            }
        }
        for (let file of addFiles) {
            // 获取 meta，没有的话直接生成
            const metaFile = file + '.meta';
            const metaInfo = this.metaManager.get(metaFile);
            const uuidCacheAsset = getAsset(metaInfo.json.uuid);
            // uuid 指向的文件被删除了，就是移动文件
            if (uuidCacheAsset) {
                if (deleteSet.has(uuidCacheAsset.source) ||
                    (uuidCacheAsset.source !== file &&
                        !(0, fs_extra_1.existsSync)(uuidCacheAsset.source))) {
                    const asset = uuidCacheAsset;
                    this.path2asset.delete(asset.source);
                    this.infoManager.remove(asset.source);
                    this.metaManager.remove(asset.source + '.meta');
                    this.infoManager.remove(asset.source + '.meta');
                    asset._source = file;
                    asset.extname = (0, path_1.extname)(file).toLowerCase();
                    asset.basename = (0, path_1.basename)(file, asset.extname);
                    asset.updateUrl();
                    asset.meta = metaInfo.json;
                    this.path2asset.set(asset.source, asset);
                    asset.action = asset_1.AssetActionEnum.change;
                    asset.task = this.taskManager.addTask(asset);
                }
                // uuid 指向的文件没删除，识别为新建，但是 uuid 冲突了
                else {
                    const asset = new asset_1.Asset(file, metaInfo.json, this);
                    this._replaceUUID(asset, uuidCacheAsset);
                    asset.save();
                    asset.action = asset_1.AssetActionEnum.add;
                    asset.task = this.taskManager.addTask(asset);
                    this.uuid2asset.set(asset.uuid, asset);
                    this.path2asset.set(asset.source, asset);
                }
            }
            // 启动数据库，还原以前的资源
            else if (this.flag.starting) {
                const fileStat = (0, fs_extra_1.statSync)(file);
                const asset = new asset_1.Asset(file, metaInfo.json, this);
                if (this.infoManager.compare(file, fileStat.mtimeMs)) {
                    const metaStat = (0, fs_extra_1.statSync)(metaFile);
                    if (this.infoManager.compare(metaFile, metaStat.mtimeMs)) {
                        if (this.dataManager.has(asset)) {
                            asset.action = asset_1.AssetActionEnum.none;
                            asset.task = this.taskManager.addTask(asset);
                        }
                        else {
                            asset.action = asset_1.AssetActionEnum.change;
                            asset.task = this.taskManager.addTask(asset);
                        }
                    }
                    else {
                        // meta 被修改，就识别为先删后新增
                        this.emit('delete', asset);
                        this.emit('deleted', asset);
                        asset.action = asset_1.AssetActionEnum.add;
                        const uuid = asset.uuid;
                        this.metaManager.read(metaFile);
                        if (asset.uuid !== uuid) {
                            this.uuid2asset.delete(uuid);
                            if (this.uuid2asset.has(asset.uuid)) {
                                this._replaceUUID(asset, getAsset(asset.uuid));
                            }
                            this.uuid2asset.set(asset.uuid, asset);
                        }
                        this.infoManager.add(metaFile, metaStat.mtimeMs);
                        asset.task = this.taskManager.addTask(asset);
                    }
                }
                else {
                    asset.action = asset_1.AssetActionEnum.add;
                    this.infoManager.add(file, fileStat.mtimeMs);
                    asset.task = this.taskManager.addTask(asset);
                }
                this.uuid2asset.set(asset.uuid, asset);
                this.path2asset.set(asset.source, asset);
            }
            // 普通新增
            else {
                const oAsset = getAsset(metaInfo.json.uuid);
                const asset = new asset_1.Asset(file, metaInfo.json, this);
                if (oAsset) {
                    this._replaceUUID(asset, oAsset);
                    asset.save();
                }
                const metaStat = (0, fs_extra_1.statSync)(metaFile);
                // 如果 metaFile 的缓存不存在，则添加进缓存
                if (!this.infoManager.get(metaFile)) {
                    this.infoManager.add(metaFile, metaStat.mtimeMs);
                }
                // 如果 metaFile 的缓存不一致，则判断为被修改
                if (this.infoManager.compare(metaFile, metaStat.mtimeMs)) {
                    asset.action = asset_1.AssetActionEnum.add;
                    asset.task = this.taskManager.addTask(asset);
                    this.uuid2asset.set(asset.uuid, asset);
                    this.path2asset.set(asset.source, asset);
                }
                else {
                    // 这种情况下，meta 被修改，都识别为先删除后新增
                    this.emit('delete', asset);
                    this.emit('deleted', asset);
                    asset.action = asset_1.AssetActionEnum.add;
                    const uuid = asset.uuid;
                    this.metaManager.read(metaFile);
                    if (asset.uuid !== uuid) {
                        this.uuid2asset.delete(uuid);
                    }
                    this.infoManager.add(metaFile, metaStat.mtimeMs);
                    asset.task = this.taskManager.addTask(asset);
                    this.uuid2asset.set(asset.uuid, asset);
                    this.path2asset.set(asset.source, asset);
                }
            }
        }
    }
    async _checkAssetStat(asset) {
        const file = asset.source;
        const metaFile = file + '.meta';
        if (!(0, fs_extra_1.existsSync)(metaFile)) {
            console.error(`${metaFile} is not exist! will use cache meta.`);
            asset.save();
        }
        const metaStat = await (0, fs_extra_1.stat)(metaFile);
        if (!await this.infoManager.compare(metaFile, metaStat.mtimeMs)) {
            this.emit('delete', asset);
            this.emit('deleted', asset);
            asset.action = asset_1.AssetActionEnum.add;
            const uuid = asset.uuid;
            this.metaManager.read(metaFile);
            if (asset.uuid !== uuid) {
                this.uuid2asset.delete(uuid);
                if (this.uuid2asset.has(asset.uuid)) {
                    this._replaceUUID(asset, getAsset(asset.uuid));
                }
                this.uuid2asset.set(asset.uuid, asset);
            }
            this.infoManager.add(metaFile, metaStat.mtimeMs);
            asset.task = this.taskManager.addTask(asset);
        }
        else {
            const fileStat = await (0, fs_extra_1.stat)(file);
            if (this.infoManager.compare(file, fileStat.mtimeMs)) {
                if (this.dataManager.has(asset)) {
                    asset.action = asset_1.AssetActionEnum.none;
                    asset.task = this.taskManager.addTask(asset);
                }
                else {
                    asset.action = asset_1.AssetActionEnum.change;
                    asset.task = this.taskManager.addTask(asset);
                }
            }
            else {
                // 更新 mtime 记录
                this.infoManager.add(file, fileStat.mtimeMs, asset.uuid);
                asset.action = asset_1.AssetActionEnum.change;
                asset.task = this.taskManager.addTask(asset);
            }
        }
    }
}
exports.AssetDB = AssetDB;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvbGlicy9hc3NldC1kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxZQUFZLENBQUM7Ozs7OztBQUViLHVDQUE4RTtBQUM5RSwrQkFBd0U7QUFDeEUsbUNBQXNDO0FBQ3RDLHlDQUErQjtBQUUvQix5Q0FBOEQ7QUFDOUQsbUNBQStEO0FBQy9ELG1DQUFrRTtBQUNsRSxpQ0FBcUM7QUFDckMsaUNBQWlEO0FBQ2pELGlDQUFrQztBQUNsQyw2Q0FBaUQ7QUFDakQsaUNBQXFDO0FBQ3JDLHVDQUF3RDtBQUV4RCxtREFBK0M7QUFDL0MsMERBQTJCO0FBQzNCLHVDQUFvRDtBQUVwRCxxQ0FBZ0M7QUFBdkIsOEZBQUEsR0FBRyxPQUFBO0FBRVosU0FBUyxRQUFRLENBQUMsSUFBSTtJQUNsQixLQUFLLElBQUksSUFBSSxJQUFJLGFBQUcsRUFBRTtRQUNsQixNQUFNLEVBQUUsR0FBRyxhQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckIsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxLQUFLLEVBQUU7WUFDUCxPQUFPLEtBQUssQ0FBQztTQUNoQjtLQUNKO0lBQ0QsT0FBTyxTQUFTLENBQUM7QUFDckIsQ0FBQztBQXNFRCxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUM7QUFFZCxRQUFBLE9BQU8sR0FBRyxPQUFPLENBQUM7QUFFL0IsTUFBYSxPQUFRLFNBQVEscUJBQVk7SUEyQnJDOztPQUVHO0lBQ0gsSUFBSSxVQUFVO1FBQ1YsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLDJFQUEyRSxDQUFDLENBQUM7WUFDM0YsY0FBYyxHQUFHLElBQUksQ0FBQztTQUN6QjtRQUNELFVBQVU7UUFDVixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FB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dGF0U3luYywgZXhpc3RzU3luYywgcmVhZGRpciwgcmVtb3ZlIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgam9pbiwgbm9ybWFsaXplLCBkaXJuYW1lLCBzZXAsIGJhc2VuYW1lLCBleHRuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgdjQgfSBmcm9tICdub2RlLXV1aWQnO1xuXG5pbXBvcnQgeyBJbXBvcnRlck1hbmFnZXIsIERlZmF1bHRJbXBvcnRlciB9IGZyb20gJy4vaW1wb3J0ZXInO1xuaW1wb3J0IHsgQXNzZXQsIFZpcnR1YWxBc3NldCwgQXNzZXRBY3Rpb25FbnVtIH0gZnJvbSAnLi9hc3NldCc7XG5pbXBvcnQgeyBhYnNvbHV0ZVBhdGgsIGlzU3ViUGF0aCwgY29tcGFyZVZlcnNpb24gfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IE1ldGFNYW5hZ2VyIH0gZnJvbSAnLi9tZXRhJztcbmltcG9ydCB7IEluZm9NYW5hZ2VyLCBTaW1wbGVJbmZvIH0gZnJvbSAnLi9pbmZvJztcbmltcG9ydCB7IFRBU0tfTUFQIH0gZnJvbSAnLi90YXNrJztcbmltcG9ydCB7IERlcGVuZGVuY3lNYW5hZ2VyIH0gZnJvbSAnLi9kZXBlbmRlbmN5JztcbmltcG9ydCB7IERhdGFNYW5hZ2VyIH0gZnJvbSAnLi9kYXRhJztcbmltcG9ydCB7IGltcG9ydEFzc29jaWF0ZWRBc3NldHMsIG1hcCB9IGZyb20gJy4vbWFuYWdlcic7XG5cbmltcG9ydCB7IFBhcmFsbGVsUXVldWUgfSBmcm9tICd3b3JrZmxvdy1leHRyYSc7XG5pbXBvcnQgZmcgZnJvbSAnZmFzdC1nbG9iJztcbmltcG9ydCB7IEN1c3RvbUNvbnNvbGUsIExvZ0xldmVsIH0gZnJvbSAnLi9jb25zb2xlJztcblxuZXhwb3J0IHsgbWFwIH0gZnJvbSAnLi9tYW5hZ2VyJztcblxuZnVuY3Rpb24gZ2V0QXNzZXQodXVpZCkge1xuICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICBjb25zdCBhc3NldCA9IGRiLnV1aWQyYXNzZXQuZ2V0KHV1aWQpO1xuICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIHJldHVybiBhc3NldDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0REJTdGFydE9wdGlvbnMge1xuICAgIC8vIOaYr+WQpuW/veeVpeiHquW3se+8jOm7mOiupCBmYWxzZVxuICAgIGlnbm9yZVNlbGY/OiBib29sZWFuO1xuICAgIGdsb2JMaXN0Pzogc3RyaW5nW107XG4gICAgLy8g5omr5o+P5oiQ5Yqf5ZCO562J5b6F5a6M5oiQ5LiA5Lqb5pON5L2cXG4gICAgaG9va3M/OiB7XG4gICAgICAgIC8vIOeUn+aIkCDotYTmupAgbWV0YSDkuYvlkI5cbiAgICAgICAgYWZ0ZXJHZW5lcmF0ZU1ldGU/KCk6IHZvaWQ7XG4gICAgICAgIC8vIOaJq+aPj+i1hOa6kOS5i+WQjlxuICAgICAgICBhZnRlclNjYW4/KGZpbGVzOiBzdHJpbmdbXSk6IHZvaWQ7XG4gICAgICAgIGFmdGVyUHJlSW1wb3J0PygpOiB2b2lkO1xuICAgICAgICAvLyDlnKjmlbDmja7lupPlkK/liqjkuYvlkI5cbiAgICAgICAgYWZ0ZXJTdGFydD8oKTogdm9pZDtcbiAgICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0REJSZWZyZXNoT3B0aW9ucyB7XG4gICAgLy8g5piv5ZCm5b+955Wl6Ieq5bex77yM6buY6K6kIGZhbHNlXG4gICAgaWdub3JlU2VsZj86IGJvb2xlYW47XG4gICAgZ2xvYkxpc3Q/OiBzdHJpbmdbXTtcbiAgICAvLyDmiavmj4/miJDlip/lkI7nrYnlvoXlrozmiJDkuIDkupvmk43kvZxcbiAgICBob29rcz86IHtcbiAgICAgICAgLy8g55Sf5oiQIOi1hOa6kCBtZXRhIOS5i+WQjlxuICAgICAgICBhZnRlckdlbmVyYXRlTWV0ZT8oKTogdm9pZDtcbiAgICAgICAgLy8g5omr5o+P6LWE5rqQ5LmL5ZCOXG4gICAgICAgIGFmdGVyU2Nhbj8oZmlsZXM6IHN0cmluZ1tdKTogdm9pZDtcbiAgICAgICAgYWZ0ZXJQcmVJbXBvcnQ/KCk6IHZvaWQ7XG4gICAgICAgIC8vIFRPRE8g55Sx5LqOIHJlZnJlc2gg6L+H56iL5Lit5Y+v6IO957un57ut5re75Yqg5paw55qEIHJlZnJlc2gg5Lu75Yqh77yM5Zug6ICM5q2k6ZKp5a2Q5LiN5YeG56GuXG4gICAgICAgIGFmdGVyUmVmcmVzaD8oKTogdm9pZDtcbiAgICB9O1xufVxuXG4vKipcbiAqIOi1hOa6kOaVsOaNruW6k+WQr+WKqOWPguaVsFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0REJPcHRpb25zIHtcbiAgICAvLyDotYTmupDmlbDmja7lupPnmoTlkI3lrZdcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgLy8g6LWE5rqQ5pWw5o2u5bqT5Zyo56Gs55uY5LiK55qE57ud5a+56Lev5b6EXG4gICAgdGFyZ2V0OiBzdHJpbmc7XG4gICAgLy8g6LWE5rqQ5pWw5o2u5bqT5a+85YWl5ZCO55Sf5oiQ55qE5paH5Lu26Lev5b6EXG4gICAgbGlicmFyeTogc3RyaW5nO1xuICAgIC8vIOi1hOa6kOaVsOaNruW6k+eahOS4tOaXtuebruW9lVxuICAgIHRlbXA6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIDA6IOW/veeVpemUmeivr1xuICAgICAqIDE6IOS7heS7heaJk+WNsOmUmeivr1xuICAgICAqIDI6IOaJk+WNsOmUmeivr+OAgeitpuWRilxuICAgICAqIDM6IOaJk+WNsOmUmeivr+OAgeitpuWRiuOAgeaXpeW/l1xuICAgICAqIDQ6IOaJk+WNsOmUmeivr+OAgeitpuWRiuOAgeaXpeW/l+OAgeiwg+ivleS/oeaBr1xuICAgICAqL1xuICAgIGxldmVsOiBMb2dMZXZlbDtcblxuICAgIC8vIOW/veeVpeeahOaWh+S7tuWIl+ihqFxuICAgIGlnbm9yZUZpbGVzOiBzdHJpbmdbXSxcblxuICAgIC8vIOW/veeVpeWvvOWFpeeahCBnbG9iIOihqOi+vuW8j1xuICAgIGlnbm9yZUdsb2I/OiBzdHJpbmc7XG5cbiAgICAvLyDmmK/lkKblj6ror7vvvIzpu5jorqTmmK8gZmFsc2VcbiAgICByZWFkb25seTogYm9vbGVhbjtcblxuICAgIGZsYWdzPzoge1xuICAgICAgICByZWltcG9ydENoZWNrPzogYm9vbGVhbjtcbiAgICB9LFxufVxuXG5sZXQgZGVwcmVjYXRlZEZsYWcgPSBmYWxzZTtcblxuZXhwb3J0IGNvbnN0IHZlcnNpb24gPSAnMi4wLjAnO1xuXG5leHBvcnQgY2xhc3MgQXNzZXREQiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgICAvLyDkvKDlhaXnmoTphY3nva7kv6Hmga9cbiAgICBvcHRpb25zOiBBc3NldERCT3B0aW9ucztcblxuICAgIC8vIOagh+iusFxuICAgIGZsYWcgPSB7XG4gICAgICAgIC8vIOaYr+WQpuato+WcqOWQr+WKqFxuICAgICAgICBzdGFydGluZzogZmFsc2UsXG4gICAgICAgIC8vIOaYr+WQpuW3sue7j+WQr+WKqOeahOagh+iusFxuICAgICAgICBzdGFydGVkOiBmYWxzZSxcbiAgICB9O1xuXG4gICAgLy8gcGF0aCDlr7nlupQgYXNzZXQg55qEIG1hcFxuICAgIHBhdGgyYXNzZXQ6IE1hcDxzdHJpbmcsIEFzc2V0PiA9IG5ldyBNYXA7XG5cbiAgICAvLyB1dWlkIOWvueW6lCBhc3NldCDnmoQgbWFwXG4gICAgdXVpZDJhc3NldDogTWFwPHN0cmluZywgQXNzZXQ+ID0gbmV3IE1hcDtcblxuICAgIC8vIGltcG9ydGVyIOeuoeeQhuWZqFxuICAgIGltcG9ydGVyTWFuYWdlcjtcbiAgICBtZXRhTWFuYWdlcjogTWV0YU1hbmFnZXI7XG4gICAgY29uc29sZTogQ3VzdG9tQ29uc29sZTtcbiAgICBpbmZvTWFuYWdlcjogSW5mb01hbmFnZXI7XG4gICAgZGVwZW5kZW5jeU1hbmFnZXI6IERlcGVuZGVuY3lNYW5hZ2VyO1xuICAgIHRhc2tNYW5hZ2VyOiBQYXJhbGxlbFF1ZXVlPFZpcnR1YWxBc3NldCwgYm9vbGVhbj47XG4gICAgZGF0YU1hbmFnZXI6IERhdGFNYW5hZ2VyO1xuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIEFzc2V0REIuZGF0YU1hbmFlciBpcyBkZXByZWNhdGVkLCBQbGVhc2UgdXNlIEFzc2V0REIuZGF0YU1hbmFnZXIgaW5zdGVhZC5cbiAgICAgKi9cbiAgICBnZXQgZGF0YU1hbmFlcigpIHtcbiAgICAgICAgaWYgKCFkZXByZWNhdGVkRmxhZykge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnQXNzZXREQi5kYXRhTWFuYWVyIGlzIGRlcHJlY2F0ZWQsIFBsZWFzZSB1c2UgQXNzZXREQi5kYXRhTWFuYWdlciBpbnN0ZWFkLicpO1xuICAgICAgICAgICAgZGVwcmVjYXRlZEZsYWcgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIOWFvOWuueaXp+eJiOacrOeUqOazlVxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhTWFuYWdlcjtcbiAgICB9O1xuICAgIF9sb2NrOiBib29sZWFuID0gZmFsc2U7XG4gICAgX3dhaXRMb2NrSGFuZGxlcjogRnVuY3Rpb25bXSA9IFtdO1xuXG4gICAgZ2V0IGFzc2V0UHJvZ3Jlc3NJbmZvKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPIHRhc2tNYW5hZ2VyIOaYr+WQpuWPr+S7peaPkOS+m+atpOWtl+autVxuICAgICAgICAgICAgY3VycmVudDogdGhpcy50YXNrTWFuYWdlci5fZXhlY0lEIC0gdGhpcy50YXNrTWFuYWdlci5fZXhlY1RocmVhZCxcbiAgICAgICAgICAgIHRvdGFsOiB0aGlzLnRhc2tNYW5hZ2VyLnRvdGFsKCksXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIFRPRE8gdGFza01hbmFnZXIg5piv5ZCm5Y+v5Lul5o+Q5L6b5q2k5a2X5q61XG4gICAgICAgICAgICB3YWl0OiB0aGlzLnRhc2tNYW5hZ2VyLl93YWl0UXVldWUuc2l6ZSxcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmUgeWumui1hOa6kFxuICAgICAqL1xuICAgIHByaXZhdGUgYXN5bmMgbG9jaygpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9sb2NrKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9jayA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3dhaXRMb2NrSGFuZGxlci5wdXNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOino+mUgei1hOa6kFxuICAgICAqL1xuICAgIHByaXZhdGUgdW5sb2NrKCkge1xuICAgICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLl93YWl0TG9ja0hhbmRsZXIuc2hpZnQoKTtcbiAgICAgICAgLy8g5aaC5p6c5pyJ562J5b6F55qE5Lu75Yqh77yM5YiZ5omn6KGM5LiL5LiA5LiqXG4gICAgICAgIGlmIChoYW5kbGUpIHtcbiAgICAgICAgICAgIGhhbmRsZSgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5bey57uP5rKh5pyJ5Zyo562J5b6F55qE5Lu75Yqh5LqG77yM6L+Y5Y6f5qCH6K6wXG4gICAgICAgIHRoaXMuX2xvY2sgPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlrp7kvovljJbov4fnqItcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBBc3NldERCT3B0aW9ucykge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICBpZiAoIW9wdGlvbnMudGFyZ2V0IHx8ICFvcHRpb25zLmxpYnJhcnkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFRoZSBkYXRhYmFzZSgke29wdGlvbnMubmFtZX0pIGNhbm5vdCBiZSBjcmVhdGVkIGJlY2F1c2UgdGhlcmUgaXMgbm8gdGFyZ2V0IG9yIGxpYnJhcnkgZGVmaW5pdGlvbmApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3B0aW9ucy50YXJnZXQgPSBhYnNvbHV0ZVBhdGgob3B0aW9ucy50YXJnZXQpO1xuICAgICAgICAgICAgb3B0aW9ucy5saWJyYXJ5ID0gYWJzb2x1dGVQYXRoKG9wdGlvbnMubGlicmFyeSk7XG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMudGVtcCkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMudGVtcCA9IGpvaW4ob3B0aW9ucy5saWJyYXJ5LCAnLnRlbXAnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wdGlvbnMudGVtcCA9IGFic29sdXRlUGF0aChvcHRpb25zLnRlbXApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6K6+572u6L6T5Ye6562J57qnXG4gICAgICAgIGlmICghKCdsZXZlbCcgaW4gb3B0aW9ucykgfHwgb3B0aW9ucy5sZXZlbCA+IDQgfHwgb3B0aW9ucy5sZXZlbCA8IDApIHtcbiAgICAgICAgICAgIG9wdGlvbnMubGV2ZWwgPSA0O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFvcHRpb25zLmlnbm9yZUZpbGVzIHx8ICFBcnJheS5pc0FycmF5KG9wdGlvbnMuaWdub3JlRmlsZXMpKSB7XG4gICAgICAgICAgICBvcHRpb25zLmlnbm9yZUZpbGVzID0gW107XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgICAgIC8vIOWQr+WKqOaVsOaNruW6k+WGhee9rueahOWQhOS4queuoeeQhuWZqOeuoeeQhuWZqFxuICAgICAgICB0aGlzLnRhc2tNYW5hZ2VyID0gbmV3IFBhcmFsbGVsUXVldWUoYXN5bmMgKGFzc2V0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbXBvcnRlciA9IGF3YWl0IHRoaXMuaW1wb3J0ZXJNYW5hZ2VyLmZpbmQoYXNzZXQpO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFpbXBvcnRlciB8fFxuICAgICAgICAgICAgICAgIC8vIOWIoOmZpOeahOaXtuWAmeW+iOWPr+iDveaWh+S7tuS4jeWtmOWcqO+8jOaJgOS7pSBpbXBvcnRlciDmnInkuIDlrprmpoLnjofmmK8gKu+8jOi/meaXtuWAmeWSjOWOn+acieeahOWvvOWFpeWZqOiCr+WumuS4jeWMuemFje+8jOaJgOS7peS4jemcgOimgeWkhOeQhuWIoOmZpFxuICAgICAgICAgICAgICAgIChhc3NldC5hY3Rpb24gIT09IEFzc2V0QWN0aW9uRW51bS5kZWxldGUgJiZcbiAgICAgICAgICAgICAgICAgICAgKGltcG9ydGVyLm5hbWUgIT09IGFzc2V0Lm1ldGEuaW1wb3J0ZXIgJiYgYXNzZXQubWV0YS5pbXBvcnRlciAhPT0gJyonKSAmJlxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIGlmICghYXNzZXQuaW5pdCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihgVW5hYmxlIHRvIGltcG9ydCBkYXRhLCBubyBzdWl0YWJsZSBpbXBvcnRlciB3YXMgZm91bmQuIHthc3NldFske2Fzc2V0IGluc3RhbmNlb2YgQXNzZXQgPyBhc3NldC5iYXNlbmFtZSA6ICcnfV0oJHthc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmluaXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHN3aXRjaCAoYXNzZXQuYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBBc3NldEFjdGlvbkVudW0uYWRkOiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hbmFnZXIuZW1wdHkoYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXdhaXQgVEFTS19NQVAuaW1wb3J0LmV4ZWModGhpcywgYXNzZXQsIGltcG9ydGVyLCB0cnVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXNzZXQuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0U3RhdHMgPSBzdGF0U3luYyhhc3NldC5zb3VyY2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvTWFuYWdlci5hZGQoYXNzZXQuc291cmNlLCBhc3NldFN0YXRzLm10aW1lTXMsIGFzc2V0LnV1aWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGltcG9ydEFzc29jaWF0ZWRBc3NldHModGhpcywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmVtaXQoJ2FkZGVkJywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2FzZSBBc3NldEFjdGlvbkVudW0uY2hhbmdlOiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hbmFnZXIuZW1wdHkoYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAvLyBhd2FpdCBUQVNLX01BUC5kZXN0cm95LmV4ZWModGhpcywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXdhaXQgVEFTS19NQVAuaW1wb3J0LmV4ZWModGhpcywgYXNzZXQsIGltcG9ydGVyLCB0cnVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXNzZXQuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0U3RhdHMgPSBzdGF0U3luYyhhc3NldC5zb3VyY2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvTWFuYWdlci5hZGQoYXNzZXQuc291cmNlLCBhc3NldFN0YXRzLm10aW1lTXMsIGFzc2V0LnV1aWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGltcG9ydEFzc29jaWF0ZWRBc3NldHModGhpcywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmVtaXQoJ2NoYW5nZWQnLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXNlIEFzc2V0QWN0aW9uRW51bS5kZWxldGU6IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhTWFuYWdlci5lbXB0eShhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IFRBU0tfTUFQLmRlc3Ryb3kuZXhlYyh0aGlzLCBhc3NldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFGaWxlID0gYXNzZXQuc291cmNlICsgJy5tZXRhJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWV0YU1hbmFnZXIucmVtb3ZlKG1ldGFGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5mb01hbmFnZXIucmVtb3ZlKGFzc2V0LnNvdXJjZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLnJlbW92ZShtZXRhRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0QXNzb2NpYXRlZEFzc2V0cyh0aGlzLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuZW1pdCgnZGVsZXRlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgQXNzZXRBY3Rpb25FbnVtLm5vbmU6IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGF3YWl0IFRBU0tfTUFQLmltcG9ydC5leGVjKHRoaXMsIGFzc2V0LCBpbXBvcnRlciwgZmFsc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3NldC5zYXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXNzZXQuaW5pdCA9IHRydWU7XG4gICAgICAgICAgICBpZiAoYXNzZXQuYWN0aW9uICE9PSBBc3NldEFjdGlvbkVudW0ubm9uZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hbmFnZXIuc2F2ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLm5vbmU7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSwgNSk7XG5cbiAgICAgICAgLy8g5YWo5bGA5Y+v55So55qE57O757uf55u45YWz55qE566h55CG5ZmoXG4gICAgICAgIHRoaXMuY29uc29sZSA9IG5ldyBDdXN0b21Db25zb2xlKG9wdGlvbnMubGV2ZWwpO1xuICAgICAgICB0aGlzLm1ldGFNYW5hZ2VyID0gbmV3IE1ldGFNYW5hZ2VyKHRoaXMuY29uc29sZSk7XG4gICAgICAgIHRoaXMuaW5mb01hbmFnZXIgPSBuZXcgSW5mb01hbmFnZXIodGhpcy5jb25zb2xlKTtcbiAgICAgICAgdGhpcy5kZXBlbmRlbmN5TWFuYWdlciA9IG5ldyBEZXBlbmRlbmN5TWFuYWdlcih0aGlzLmNvbnNvbGUpO1xuICAgICAgICB0aGlzLmRhdGFNYW5hZ2VyID0gbmV3IERhdGFNYW5hZ2VyKHRoaXMuY29uc29sZSk7XG4gICAgICAgIHRoaXMuaW1wb3J0ZXJNYW5hZ2VyID0gbmV3IEltcG9ydGVyTWFuYWdlcih0aGlzLmNvbnNvbGUpO1xuXG4gICAgICAgIC8vIOazqOWGjOm7mOiupOeahOino+aekOWZqFxuICAgICAgICB0aGlzLmltcG9ydGVyTWFuYWdlci5hZGQoRGVmYXVsdEltcG9ydGVyLCBbJyonXSk7XG4gICAgfVxuXG4gICAgcHJlSW1wb3J0ZXJIYW5kbGVyPyhmaWxlOiBzdHJpbmcpOiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICog5ZCv5Yqo6LWE5rqQ5pWw5o2u5bqTXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnQob3B0aW9uczogQXNzZXREQlN0YXJ0T3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLnRhcmdldCB8fCAhdGhpcy5vcHRpb25zLmxpYnJhcnkgfHwgIXRoaXMub3B0aW9ucy50ZW1wKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUuZXJyb3IoYFBhcmFtZXRlciBlcnJvciwgdW5hYmxlIHRvIHN0YXJ0IGFzc2V0LWRiKCR7dGhpcy5vcHRpb25zLm5hbWV9KSB3aXRoIG9wdGlvbiAke3RoaXMub3B0aW9uc30uYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5mbGFnLnN0YXJ0ZWQgJiYgdGhpcy5vcHRpb25zLmxldmVsID49IDIpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGBUaGUgJHt0aGlzLm9wdGlvbnMubmFtZX0gZGF0YWJhc2UgaXMgYWxyZWFkeSBzdGFydGVkLmApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5mbGFnLnN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmZsYWcuc3RhcnRpbmcgPSB0cnVlO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuaW5mb01hbmFnZXIuc2V0UmVjb3JkSlNPTihqb2luKHRoaXMub3B0aW9ucy5saWJyYXJ5LCBgLiR7dGhpcy5vcHRpb25zLm5hbWV9LWluZm8uanNvbmApKTtcbiAgICAgICAgYXdhaXQgdGhpcy5kYXRhTWFuYWdlci5zZXRSZWNvcmRKU09OKGpvaW4odGhpcy5vcHRpb25zLmxpYnJhcnksIGAuJHt0aGlzLm9wdGlvbnMubmFtZX0tZGF0YS5qc29uYCkpO1xuICAgICAgICBhd2FpdCB0aGlzLmRlcGVuZGVuY3lNYW5hZ2VyLnNldFJlY29yZEpTT04oam9pbih0aGlzLm9wdGlvbnMubGlicmFyeSwgYC4ke3RoaXMub3B0aW9ucy5uYW1lfS1kZXBlbmRlbmN5Lmpzb25gKSk7XG5cbiAgICAgICAgLy8g6KaB5Zyo6LWE5rqQ5Yi35paw5YmN5Yqg5YWl57yT5a2YXG4gICAgICAgIG1hcFt0aGlzLm9wdGlvbnMubmFtZV0gPSB0aGlzO1xuXG4gICAgICAgIC8vIOWIt+aWsOi1hOa6kOaVsOaNruW6k+WGheeahOi1hOa6kOWIl+ihqFxuICAgICAgICBsZXQgbnVtID0gYXdhaXQgdGhpcy5yZWZyZXNoKHRoaXMub3B0aW9ucy50YXJnZXQsIHtcbiAgICAgICAgICAgIGlnbm9yZVNlbGY6IHRydWUsXG4gICAgICAgICAgICBob29rczogb3B0aW9ucy5ob29rcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb25zb2xlLmRlYnVnKGBzdGFydCBhc3NldC1kYigke3RoaXMub3B0aW9ucy5uYW1lfSkgd2l0aCBhc3NldDogJHtudW19YClcblxuICAgICAgICBsZXQgaW5mb0RpcnR5ID0gZmFsc2U7XG4gICAgICAgIC8vIOWIoOmZpOW3sue7j+S4jeWtmOWcqOeahOi1hOa6kFxuICAgICAgICAvLyBtdGltZSDorrDlvZXnmoTpg73mmK/kuYvliY3lrZjlnKjnmoTmlofku7bvvIzmiYDku6Xlvqrnjq8gbXRpbWUg566h55CG5Zmo6YeM55qE5pWw5o2u6L+b6KGM5qCh6aqMXG4gICAgICAgIGF3YWl0IHRoaXMuaW5mb01hbmFnZXIuZm9yRWFjaChhc3luYyAocGF0aDogc3RyaW5nLCBpbmZvOiBTaW1wbGVJbmZvKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMucGF0aDJhc3NldC5oYXMocGF0aCkgJiYgdGhpcy5pbmZvTWFuYWdlci5nZXQocGF0aCkudXVpZCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHV1aWQgPSBpbmZvLnV1aWQgYXMgc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0QXNzZXQodXVpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXIgPSBgJHt0aGlzLm9wdGlvbnMubGlicmFyeX0ke3NlcH0ke3V1aWQuc3Vic3RyKDAsIDIpfWA7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdHNTeW5jKGRpcikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBhd2FpdCByZWFkZGlyKGRpcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBuYW1lIG9mIGxpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZS5zdGFydHNXaXRoKHV1aWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHJlbW92ZShqb2luKGRpciwgbmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLnJlbW92ZShwYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgaW5mb0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUud2FybihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIGluZm9EaXJ0eSAmJiB0aGlzLmluZm9NYW5hZ2VyLnNhdmUoKTtcbiAgICAgICAgLy8gYXdhaXQgdGhpcy50YXNrTWFuYWdlci53YWl0UXVldWUoKTtcbiAgICAgICAgLy8gcmV0dXJuIG51bTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHN0ZXAgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy50YXNrTWFuYWdlci5idXN5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxhZy5zdGFydGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaG9va3MgJiYgb3B0aW9ucy5ob29rcy5hZnRlclN0YXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3B0aW9ucy5ob29rcy5hZnRlclN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShudW0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFza01hbmFnZXIud2FpdFF1ZXVlKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGVwKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sIDEwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBzdGVwKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWBnOatoui1hOa6kOaVsOaNruW6k1xuICAgICAqL1xuICAgIGFzeW5jIHN0b3AoKSB7XG4gICAgICAgIHRoaXMudXVpZDJhc3NldC5jbGVhcigpO1xuICAgICAgICB0aGlzLnBhdGgyYXNzZXQuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5mbGFnLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLnNhdmVJbW1lZGlhdGUoKTtcbiAgICAgICAgdGhpcy5kZXBlbmRlbmN5TWFuYWdlci5zYXZlSW1tZWRpYXRlKCk7XG4gICAgICAgIHRoaXMuZGF0YU1hbmFnZXIuc2F2ZUltbWVkaWF0ZSgpO1xuXG4gICAgICAgIHRoaXMubWV0YU1hbmFnZXIuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5kZXBlbmRlbmN5TWFuYWdlci5kZXN0cm95KCk7XG5cbiAgICAgICAgaWYgKG1hcFt0aGlzLm9wdGlvbnMubmFtZV0gPT09IHRoaXMpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBtYXBbdGhpcy5vcHRpb25zLm5hbWVdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5Lyg5YWlIHBhdGjvvIzov5Tlm54gYXNzZXQtZGIg5YaF5a+55bqU55qEIHV1aWRcbiAgICAgKiDkuI3lrZjlnKjliJnov5Tlm54gbnVsbFxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqL1xuICAgIHBhdGhUb1V1aWQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBhc3NldCA9IHRoaXMucGF0aDJhc3NldC5nZXQocGF0aCk7XG4gICAgICAgIGlmICghYXNzZXQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhc3NldC51dWlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOS8oOWFpSB1dWlk77yM6L+U5Zue5a+55bqU55qE6LWE5rqQ55qEIHBhdGhcbiAgICAgKiBAcGFyYW0gdXVpZCBcbiAgICAgKi9cbiAgICB1dWlkVG9QYXRoKHV1aWQ6IHN0cmluZykge1xuICAgICAgICBsZXQgYXNzZXQgPSB0aGlzLnV1aWQyYXNzZXQuZ2V0KHV1aWQpO1xuICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhc3NldC5zb3VyY2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5p+l6K+i6LWE5rqQ5a6e5L6LXG4gICAgICogQHBhcmFtIHV1aWRcbiAgICAgKi9cbiAgICBnZXRBc3NldCh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF1dWlkIHx8IHR5cGVvZiB1dWlkICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHNlYXJjaCA9IHV1aWQuc3BsaXQoJ0AnKTtcbiAgICAgICAgbGV0IGlkID0gc2VhcmNoLnNoaWZ0KCkgfHwgJyc7XG5cbiAgICAgICAgbGV0IGFzc2V0OiBWaXJ0dWFsQXNzZXQgfCBBc3NldCB8IHVuZGVmaW5lZCA9IHRoaXMudXVpZDJhc3NldC5nZXQoaWQpO1xuICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlYXJjaC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGlkT3JOYW1lID0gc2VhcmNoW2ldO1xuICAgICAgICAgICAgYXNzZXQgPSBhc3NldC5zdWJBc3NldHNbaWRPck5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhc3NldCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhc3NldCB8fCBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmHjeaWsOWvvOWFpVxuICAgICAqIEBwYXJhbSBmaWxlT3JVVUlEIFxuICAgICAqL1xuICAgIGFzeW5jIHJlaW1wb3J0KGZpbGVPclVVSUQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQgfCBudWxsID0gdGhpcy5wYXRoMmFzc2V0LmdldChmaWxlT3JVVUlEKSB8fCB0aGlzLmdldEFzc2V0KGZpbGVPclVVSUQpO1xuICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOaaguaXtuS9v+eUqOW8gOWFs+aOp+WItlxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmZsYWdzICYmIHRoaXMub3B0aW9ucy5mbGFncy5yZWltcG9ydENoZWNrICYmICFhc3NldC5fbG9jayAmJiBhc3NldC5hY3Rpb24gIT09IEFzc2V0QWN0aW9uRW51bS5ub25lKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICAvLyDpnIDopoHlhYjplIHlrprvvIzlm6DkuLrlpoLmnpzlvIDlp4vlr7zlhaXvvIxpbml0IOi/mOaYryBmYWxzZe+8jOS9hui1hOa6kOW3sue7j+iiq+mUgeWumu+8jOaJgOS7peetieW+hei1hOa6kOmUgeWumueKtuaAgee7k+adn++8jOWGjeW8gOWni+WvvOWFpVxuICAgICAgICBhd2FpdCB0aGlzLmxvY2soKTtcblxuICAgICAgICAvLyDlvLrliLbph43mlrDop6blj5Hmn6Xmib4gaW1wb3J0ZXIg55qE5Yqo5L2cXG4gICAgICAgIGlmIChhc3NldCBpbnN0YW5jZW9mIEFzc2V0KSB7XG4gICAgICAgICAgICB0aGlzLm1ldGFNYW5hZ2VyLnJlYWQoYXNzZXQuc291cmNlICsgJy5tZXRhJyk7XG4gICAgICAgICAgICBjb25zdCBvbGRJbXBvcnRlciA9IGFzc2V0Lm1ldGEuaW1wb3J0ZXI7XG4gICAgICAgICAgICBhc3NldC5tZXRhLmltcG9ydGVyID0gJyonO1xuICAgICAgICAgICAgY29uc3QgaW1wb3J0ZXIgPSBhd2FpdCB0aGlzLmltcG9ydGVyTWFuYWdlci5maW5kKGFzc2V0KTtcbiAgICAgICAgICAgIGlmICghaW1wb3J0ZXIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBpbXBvcnQgZGF0YSwgbm8gc3VpdGFibGUgaW1wb3J0ZXIgd2FzIGZvdW5kLlxcbiAgcGF0aDogJHthc3NldC5zb3VyY2V9XFxuICB1dWlkOiAke2Fzc2V0LnV1aWR9YCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9sZEltcG9ydGVyID09PSBpbXBvcnRlci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS5pbXBvcnRlciA9IGltcG9ydGVyLm5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKCFhc3NldC5pbml0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy51bmxvY2soKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhc3NldC5pbml0ID0gZmFsc2U7XG4gICAgICAgICAgICBhc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xuICAgICAgICAgICAgYXNzZXQudGFzayA9IHRoaXMudGFza01hbmFnZXIuYWRkVGFzayhhc3NldCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudW5sb2NrKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy50YXNrTWFuYWdlci53YWl0UXVldWUoKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWIt+aWsOi1hOa6kFxuICAgICAqIOS8oOWFpeafkOS4gOS4quaWh+S7tuaIluiAheaWh+S7tuWkue+8jOi/m+ihjOaVsOaNruW6k+WIt+aWsOaTjeS9nFxuICAgICAqIOS8muS8mOWFiOWQjOatpeaJq+aPj+aJgOaciei1hOa6kO+8jOeEtuWQjuetieW+heWFtuS7liByZWZyZXNoIOmYn+WIl1xuICAgICAqIOm7mOiupCByZWZyZXNoIOaYr+aciemYn+WIl+eahO+8jOWkmuS4qiByZWZyZXNoIOWQjOaXtuaJp+ihjOmcgOimgei/m+WFpemYn+WIl+etieW+hVxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IOWIt+aWsOeahOi1hOa6kOS4quaVsFxuICAgICAqL1xuICAgIGFzeW5jIHJlZnJlc2gocGF0aDogc3RyaW5nLCBvcHRpb25zOiBBc3NldERCUmVmcmVzaE9wdGlvbnMgPSB7fSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIC8vIOWmguaenOS4jeaYr+e7neWvuei3r+W+hO+8jOS4jeWIt+aWsFxuICAgICAgICBpZiAoIWFic29sdXRlUGF0aChwYXRoKSkge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICAgICAgcGF0aCA9IG5vcm1hbGl6ZShwYXRoKTtcblxuICAgICAgICAvLyDlpoLmnpzmmK/mlbDmja7lupPmlofku7blpLnvvIzpu5jorqTlsLHlv73nlaXoh6rlt7FcbiAgICAgICAgaWYgKHBhdGggPT09IHRoaXMub3B0aW9ucy50YXJnZXQpIHtcbiAgICAgICAgICAgIG9wdGlvbnMuaWdub3JlU2VsZiA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlkJHkuIrpgJLlvZLmn6Xor6LvvIzmn6Xor6Loh6rlt7HnmoTniLbnuqfmlofku7blpLnmmK/lkKblrZjlnKhcbiAgICAgICAgLy8g5aaC5p6c54i25paH5Lu25aS55LiN5ZyoIGRiIOmHjO+8jOWImeiHquWKqOWKoOWFpVxuICAgICAgICBsZXQgcGFyZW50RGlyID0gZGlybmFtZShwYXRoKTtcbiAgICAgICAgd2hpbGUgKGlzU3ViUGF0aChwYXJlbnREaXIsIHRoaXMub3B0aW9ucy50YXJnZXQpICYmICF0aGlzLnBhdGgyYXNzZXQuaGFzKHBhcmVudERpcikpIHtcbiAgICAgICAgICAgIHBhdGggPSBwYXJlbnREaXI7XG4gICAgICAgICAgICBwYXJlbnREaXIgPSBkaXJuYW1lKHBhcmVudERpcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDmo4Dmn6XmmK/kuI3mmK/phY3nva7nmoQgcm9vdCDot6/lvoTnmoTlrZDnm67lvZXvvIzlpoLmnpzkuI3mmK/lrZDot6/lvoTvvIzliJnov5Tlm57liLfmlrAgMCDkuKrotYTmupBcbiAgICAgICAgaWYgKCFpc1N1YlBhdGgocGF0aCwgdGhpcy5vcHRpb25zLnRhcmdldCkgJiYgcGF0aCAhPT0gdGhpcy5vcHRpb25zLnRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAvLyDliLfmlrDot6/lvoTkuI3lrZjlnKjml7blj6/og73mmK/lt7LooqvliKDpmaTnmoTotYTmupDpnIDopoHmm7TmlrDmlbDmja7lupPkv6Hmga/vvIzkuI3miqXplJlcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZVN0YXQgPSBzdGF0U3luYyhwYXRoKTtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZVN0YXQuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXMgPSBbcGF0aF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2xvYlBhdGggPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gcGF0aC5yZXBsYWNlKC9cXFxcL2csICcvJykgOiBwYXRoO1xuICAgICAgICAgICAgICAgICAgICAvLyAhIOimgeWGmee7neWvuei3r+W+hO+8jOWQpuWImeWPr+iDveWcqOafkOS6myB3aW4g5py65Zmo5LiK5peg5rOV5b+955Wl5paH5Lu2XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaCA9IG9wdGlvbnMuZ2xvYkxpc3QgfHwgW1xuICAgICAgICAgICAgICAgICAgICAgICAgYCoqLypgLFxuICAgICAgICAgICAgICAgICAgICAgICAgYCEqKi8qLm1ldGFgLFxuICAgICAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmlnbm9yZUdsb2IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaC5wdXNoKHRoaXMub3B0aW9ucy5pZ25vcmVHbG9iKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaWxlcyA9IGZnLnN5bmMoc2VhcmNoLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbmx5RmlsZXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5aaC5p6c5bCGIHBhdGgg5Lyg5YWlIHNlYXJjaCDmlbDnu4TvvIzljaLnu4/nkIbluKbmnIkgKCkg5bCx5peg5rOV5q2j56Gu6K+G5Yir5LqG77yM5omA5Lul6ZyA6KaB5L2/55SoIGN3ZFxuICAgICAgICAgICAgICAgICAgICAgICAgY3dkOiBnbG9iUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvdDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaCgoZmlsZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzW2luZGV4XSA9IGpvaW4oZ2xvYlBhdGgsIGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAvLyDlvZPmiavmj4/nmoTot6/lvoTkuI3mmK/moLnnm67lvZXnmoTml7blgJnvvIzmiorooqvmiavmj4/nmoTot6/lvoTkuZ/mo4Dmn6XkuIDmrKFcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhdGggIT09IHRoaXMub3B0aW9ucy50YXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzLnNwbGljZSgwLCAwLCBwYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICBmaWxlcyA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIOaWh+S7tuWIhue7hO+8jOWmguaenOacieWkmuS4que7hO+8jOS8muWcqOS4iuS4gOS4que7hOWvvOWFpeWujOaIkOWQju+8jOaJjeW8gOWni+S4i+S4gOS4que7hOeahOWvvOWFpea1geeoi1xuICAgICAgICBpZiAob3B0aW9ucy5ob29rcyAmJiBvcHRpb25zLmhvb2tzLmFmdGVyU2Nhbikge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvcHRpb25zLmhvb2tzLmFmdGVyU2NhbihmaWxlcyk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDmiavmj4/mlofku7bliLDnmoTmlofku7borrDlvZVcbiAgICAgICAgY29uc3QgZmlsZVNldDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gICAgICAgIGNvbnN0IGRlbGV0ZVNldDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gICAgICAgIGNvbnN0IGFkZFNldDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByZUFkZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgY29uc3QgYWRkRmlsZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICBjb25zdCBkZWxldGVGaWxlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgIGlmICh0aGlzLnByZUltcG9ydGVySGFuZGxlcikge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBhdGgyYXNzZXQuaGFzKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wcmVJbXBvcnRlckhhbmRsZXIoZmlsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVBZGRGaWxlcy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRGaWxlcy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkU2V0LmFkZChmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaWxlU2V0LmFkZChmaWxlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBhdGgyYXNzZXQuaGFzKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRGaWxlcy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWRkU2V0LmFkZChmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaWxlU2V0LmFkZChmaWxlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMucGF0aDJhc3NldC5mb3JFYWNoKChhc3NldCwgZmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPT09IDAgfHwgIWZpbGVTZXQuaGFzKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxlID09PSBwYXRoIHx8IGlzU3ViUGF0aChmaWxlLCBwYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlRmlsZXMucHVzaChmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZVNldC5hZGQoZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy50YXNrTWFuYWdlci5zdG9wKCk7XG5cbiAgICAgICAgICAgIC8vIOWIpOaWrea3u+WKoOeahOi1hOa6kOWSjOenu+WKqOOAgeWIoOmZpOeahOi1hOa6kFxuICAgICAgICAgICAgdGhpcy5fY2hlY2tBc3NldHNTdGF0U3luYyhwcmVBZGRGaWxlcywgZGVsZXRlRmlsZXMsIGRlbGV0ZVNldCk7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5ob29rcyAmJiBvcHRpb25zLmhvb2tzLmFmdGVyUHJlSW1wb3J0KSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3B0aW9ucy5ob29rcy5hZnRlclByZUltcG9ydCgpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fY2hlY2tBc3NldHNTdGF0U3luYyhhZGRGaWxlcywgZGVsZXRlRmlsZXMsIGRlbGV0ZVNldCk7XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgncmVmcmVzaC11dWlkLXJlYWR5JywgcGF0aCk7XG5cbiAgICAgICAgICAgIC8vIOmUgeWumuS7u+WKoeagiFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2NrKCk7XG5cbiAgICAgICAgICAgIC8vIOayoeacieaUueWKqOeahOaVsOaNrlxuICAgICAgICAgICAgY29uc3QgdGFza3M6IFByb21pc2U8YW55PltdID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhZGRTZXQuaGFzKGZpbGUpICYmICFkZWxldGVTZXQuaGFzKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gdGhpcy5wYXRoMmFzc2V0LmdldChmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXNrcy5wdXNoKHRoaXMuX2NoZWNrQXNzZXRTdGF0KGFzc2V0KSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDkvb/nlKggUHJvbWlzZS5hbGwg5Lya5a+86Ie06YOo5YiG6LWE5rqQ6Zeu6aKY5a+86Ie05YWo6YOo6LWE5rqQ6YO95peg5rOV5Yi35pawXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQodGFza3MpO1xuICAgICAgICAgICAgcmVzdWx0LmZvckVhY2goKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIC8vIOWksei0peeahOS7u+WKoemcgOimgeaKpemUmVxuICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSAncmVqZWN0ZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IocmVzLnJlYXNvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB0aGlzLnVubG9jaygpO1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5ob29rcyAmJiBvcHRpb25zLmhvb2tzLmFmdGVyR2VuZXJhdGVNZXRlKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9wdGlvbnMuaG9va3MuYWZ0ZXJHZW5lcmF0ZU1ldGUoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGFza01hbmFnZXIuc3RhcnQoKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy50YXNrTWFuYWdlci53YWl0UXVldWUoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVubG9jaygpO1xuXG4gICAgICAgIC8vIOi/lOWbnuaJgOacieaWh+S7tueahOS4quaVsFxuICAgICAgICBjb25zdCBudW0gPSB0aGlzLnRhc2tNYW5hZ2VyLnRvdGFsKCk7XG4gICAgICAgIHRoaXMudGFza01hbmFnZXIuY2xlYXIoKTtcblxuICAgICAgICBpZiAob3B0aW9ucy5ob29rcyAmJiBvcHRpb25zLmhvb2tzLmFmdGVyUmVmcmVzaCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvcHRpb25zLmhvb2tzLmFmdGVyUmVmcmVzaCgpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZXBsYWNlVVVJRChhc3NldDogQXNzZXQsIG9Bc3NldDogQXNzZXQpIHtcbiAgICAgICAgaWYgKG9Bc3NldCAhPT0gYXNzZXQpIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5zb3VyY2UgPT09IG9Bc3NldC5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLnRyYWNlKGBfcmVwbGFjZVVVSUQgaW52YWxpZCBpbiBhc3NldCAke2Fzc2V0LnNvdXJjZX1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBuZXdVVUlEID0gdjQoKTtcbiAgICAgICAgICAgIC8vIOaPkOekuuS4pOS4quaWh+S7tiB1dWlkIOWGsueqgVxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sZXZlbCA+PSAyKSB7XG4gICAgICAgICAgICAgICAgbGV0IGluZm8gPSBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LnNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgb0Fzc2V0LnNvdXJjZSxcbiAgICAgICAgICAgICAgICBdLCBudWxsLCAyKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUud2FybihgVGhlIHV1aWQgaXMgYWxyZWFkeSBwb2ludGluZyB0byBhbm90aGVyIHJlc291cmNlLlxcbiR7aW5mb31cXG5UaGUgZmlsZSB1dWlkIGhhcyBiZWVuIHVwZGF0ZWQ6ICR7YXNzZXQuc291cmNlfVxcbiAgICAke2Fzc2V0LnV1aWR9IC0+ICR7bmV3VVVJRH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFzc2V0Lm1ldGEudXVpZCA9IG5ld1VVSUQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmo4Dmn6XotYTmupDnirbmgIFcbiAgICAgKiDor4bliKvmmK/mlrDlop7jgIHkv67mlLnov5jmmK/liKDpmaTkuobotYTmupBcbiAgICAgKiBAcGFyYW0gYWRkRmlsZXNcbiAgICAgKiBAcGFyYW0gZGVsZXRlRmlsZXNcbiAgICAgKi9cbiAgICBwcml2YXRlIF9jaGVja0Fzc2V0c1N0YXRTeW5jKGFkZEZpbGVzOiBzdHJpbmdbXSwgZGVsZXRlRmlsZXM6IHN0cmluZ1tdLCBkZWxldGVTZXQ6IFNldDxzdHJpbmc+KSB7XG4gICAgICAgIGZvciAobGV0IGZpbGUgb2YgZGVsZXRlRmlsZXMpIHtcbiAgICAgICAgICAgIC8vIOavi+W6uOe9rueWkeeahOWIoOmZpOaWh+S7tlxuICAgICAgICAgICAgY29uc3QgYXNzZXQgPSB0aGlzLnBhdGgyYXNzZXQuZ2V0KGZpbGUpO1xuICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZTtcbiAgICAgICAgICAgICAgICBhc3NldC50YXNrID0gdGhpcy50YXNrTWFuYWdlci5hZGRUYXNrKGFzc2V0KTtcbiAgICAgICAgICAgICAgICB0aGlzLnV1aWQyYXNzZXQuZGVsZXRlKGFzc2V0LnV1aWQpO1xuICAgICAgICAgICAgICAgIHRoaXMucGF0aDJhc3NldC5kZWxldGUoYXNzZXQuc291cmNlKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFGaWxlID0gYXNzZXQuc291cmNlICsgJy5tZXRhJztcbiAgICAgICAgICAgICAgICB0aGlzLm1ldGFNYW5hZ2VyLnJlbW92ZShtZXRhRmlsZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5pbmZvTWFuYWdlci5yZW1vdmUoYXNzZXQuc291cmNlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLnJlbW92ZShtZXRhRmlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiBhZGRGaWxlcykge1xuICAgICAgICAgICAgLy8g6I635Y+WIG1ldGHvvIzmsqHmnInnmoTor53nm7TmjqXnlJ/miJBcbiAgICAgICAgICAgIGNvbnN0IG1ldGFGaWxlID0gZmlsZSArICcubWV0YSc7XG4gICAgICAgICAgICBjb25zdCBtZXRhSW5mbyA9IHRoaXMubWV0YU1hbmFnZXIuZ2V0KG1ldGFGaWxlKTtcbiAgICAgICAgICAgIGNvbnN0IHV1aWRDYWNoZUFzc2V0ID0gZ2V0QXNzZXQobWV0YUluZm8uanNvbi51dWlkKTtcbiAgICAgICAgICAgIC8vIHV1aWQg5oyH5ZCR55qE5paH5Lu26KKr5Yig6Zmk5LqG77yM5bCx5piv56e75Yqo5paH5Lu2XG4gICAgICAgICAgICBpZiAodXVpZENhY2hlQXNzZXQpIHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZVNldC5oYXModXVpZENhY2hlQXNzZXQuc291cmNlKSB8fFxuICAgICAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2FjaGVBc3NldC5zb3VyY2UgIT09IGZpbGUgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICFleGlzdHNTeW5jKHV1aWRDYWNoZUFzc2V0LnNvdXJjZSlcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhc3NldCA9IHV1aWRDYWNoZUFzc2V0O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdGgyYXNzZXQuZGVsZXRlKGFzc2V0LnNvdXJjZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5mb01hbmFnZXIucmVtb3ZlKGFzc2V0LnNvdXJjZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWV0YU1hbmFnZXIucmVtb3ZlKGFzc2V0LnNvdXJjZSArICcubWV0YScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLnJlbW92ZShhc3NldC5zb3VyY2UgKyAnLm1ldGEnKTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuX3NvdXJjZSA9IGZpbGU7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmV4dG5hbWUgPSBleHRuYW1lKGZpbGUpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmJhc2VuYW1lID0gYmFzZW5hbWUoZmlsZSwgYXNzZXQuZXh0bmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LnVwZGF0ZVVybCgpO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5tZXRhID0gbWV0YUluZm8uanNvbjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRoMmFzc2V0LnNldChhc3NldC5zb3VyY2UsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmNoYW5nZTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQudGFzayA9IHRoaXMudGFza01hbmFnZXIuYWRkVGFzayhhc3NldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHV1aWQg5oyH5ZCR55qE5paH5Lu25rKh5Yig6Zmk77yM6K+G5Yir5Li65paw5bu677yM5L2G5pivIHV1aWQg5Yay56qB5LqGXG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KGZpbGUsIG1ldGFJbmZvLmpzb24sIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXBsYWNlVVVJRChhc3NldCwgdXVpZENhY2hlQXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5zYXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5hZGQ7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnV1aWQyYXNzZXQuc2V0KGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRoMmFzc2V0LnNldChhc3NldC5zb3VyY2UsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDlkK/liqjmlbDmja7lupPvvIzov5jljp/ku6XliY3nmoTotYTmupBcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZmxhZy5zdGFydGluZykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVTdGF0ID0gc3RhdFN5bmMoZmlsZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQoZmlsZSwgbWV0YUluZm8uanNvbiwgdGhpcyk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbmZvTWFuYWdlci5jb21wYXJlKGZpbGUsIGZpbGVTdGF0Lm10aW1lTXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFTdGF0ID0gc3RhdFN5bmMobWV0YUZpbGUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbmZvTWFuYWdlci5jb21wYXJlKG1ldGFGaWxlLCBtZXRhU3RhdC5tdGltZU1zKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YU1hbmFnZXIuaGFzKGFzc2V0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWV0YSDooqvkv67mlLnvvIzlsLHor4bliKvkuLrlhYjliKDlkI7mlrDlop5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZGVsZXRlJywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdkZWxldGVkJywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmFkZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHV1aWQgPSBhc3NldC51dWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXRhTWFuYWdlci5yZWFkKG1ldGFGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhc3NldC51dWlkICE9PSB1dWlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51dWlkMmFzc2V0LmRlbGV0ZSh1dWlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy51dWlkMmFzc2V0Lmhhcyhhc3NldC51dWlkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXBsYWNlVVVJRChhc3NldCwgZ2V0QXNzZXQoYXNzZXQudXVpZCkhKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnV1aWQyYXNzZXQuc2V0KGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5mb01hbmFnZXIuYWRkKG1ldGFGaWxlLCBtZXRhU3RhdC5tdGltZU1zKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmFkZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvTWFuYWdlci5hZGQoZmlsZSwgZmlsZVN0YXQubXRpbWVNcyk7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnV1aWQyYXNzZXQuc2V0KGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhdGgyYXNzZXQuc2V0KGFzc2V0LnNvdXJjZSwgYXNzZXQpO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDmma7pgJrmlrDlop5cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9Bc3NldCA9IGdldEFzc2V0KG1ldGFJbmZvLmpzb24udXVpZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQoZmlsZSwgbWV0YUluZm8uanNvbiwgdGhpcyk7XG4gICAgICAgICAgICAgICAgaWYgKG9Bc3NldCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXBsYWNlVVVJRChhc3NldCwgb0Fzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuc2F2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBtZXRhU3RhdCA9IHN0YXRTeW5jKG1ldGFGaWxlKTtcblxuICAgICAgICAgICAgICAgIC8vIOWmguaenCBtZXRhRmlsZSDnmoTnvJPlrZjkuI3lrZjlnKjvvIzliJnmt7vliqDov5vnvJPlrZhcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5mb01hbmFnZXIuZ2V0KG1ldGFGaWxlKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLmFkZChtZXRhRmlsZSwgbWV0YVN0YXQubXRpbWVNcyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8g5aaC5p6cIG1ldGFGaWxlIOeahOe8k+WtmOS4jeS4gOiHtO+8jOWImeWIpOaWreS4uuiiq+S/ruaUuVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluZm9NYW5hZ2VyLmNvbXBhcmUobWV0YUZpbGUsIG1ldGFTdGF0Lm10aW1lTXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5hZGQ7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnV1aWQyYXNzZXQuc2V0KGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRoMmFzc2V0LnNldChhc3NldC5zb3VyY2UsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyDov5nnp43mg4XlhrXkuIvvvIxtZXRhIOiiq+S/ruaUue+8jOmDveivhuWIq+S4uuWFiOWIoOmZpOWQjuaWsOWinlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2RlbGV0ZScsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdkZWxldGVkJywgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uYWRkO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1dWlkID0gYXNzZXQudXVpZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXRhTWFuYWdlci5yZWFkKG1ldGFGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0LnV1aWQgIT09IHV1aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXVpZDJhc3NldC5kZWxldGUodXVpZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvTWFuYWdlci5hZGQobWV0YUZpbGUsIG1ldGFTdGF0Lm10aW1lTXMpO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC50YXNrID0gdGhpcy50YXNrTWFuYWdlci5hZGRUYXNrKGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51dWlkMmFzc2V0LnNldChhc3NldC51dWlkLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGF0aDJhc3NldC5zZXQoYXNzZXQuc291cmNlLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfY2hlY2tBc3NldFN0YXQoYXNzZXQ6IEFzc2V0KSB7XG5cbiAgICAgICAgY29uc3QgZmlsZSA9IGFzc2V0LnNvdXJjZTtcbiAgICAgICAgY29uc3QgbWV0YUZpbGUgPSBmaWxlICsgJy5tZXRhJztcbiAgICAgICAgaWYgKCFleGlzdHNTeW5jKG1ldGFGaWxlKSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgJHttZXRhRmlsZX0gaXMgbm90IGV4aXN0ISB3aWxsIHVzZSBjYWNoZSBtZXRhLmApO1xuICAgICAgICAgICAgYXNzZXQuc2F2ZSgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1ldGFTdGF0ID0gYXdhaXQgc3RhdChtZXRhRmlsZSk7XG5cbiAgICAgICAgaWYgKCFhd2FpdCB0aGlzLmluZm9NYW5hZ2VyLmNvbXBhcmUobWV0YUZpbGUsIG1ldGFTdGF0Lm10aW1lTXMpKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2RlbGV0ZScsIGFzc2V0KTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZGVsZXRlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5hZGQ7XG4gICAgICAgICAgICBjb25zdCB1dWlkID0gYXNzZXQudXVpZDtcbiAgICAgICAgICAgIHRoaXMubWV0YU1hbmFnZXIucmVhZChtZXRhRmlsZSk7XG4gICAgICAgICAgICBpZiAoYXNzZXQudXVpZCAhPT0gdXVpZCkge1xuICAgICAgICAgICAgICAgIHRoaXMudXVpZDJhc3NldC5kZWxldGUodXVpZCk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudXVpZDJhc3NldC5oYXMoYXNzZXQudXVpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVwbGFjZVVVSUQoYXNzZXQsIGdldEFzc2V0KGFzc2V0LnV1aWQpISlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy51dWlkMmFzc2V0LnNldChhc3NldC51dWlkLCBhc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLmFkZChtZXRhRmlsZSwgbWV0YVN0YXQubXRpbWVNcyk7XG4gICAgICAgICAgICBhc3NldC50YXNrID0gdGhpcy50YXNrTWFuYWdlci5hZGRUYXNrKGFzc2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVTdGF0ID0gYXdhaXQgc3RhdChmaWxlKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmluZm9NYW5hZ2VyLmNvbXBhcmUoZmlsZSwgZmlsZVN0YXQubXRpbWVNcykpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhTWFuYWdlci5oYXMoYXNzZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC50YXNrID0gdGhpcy50YXNrTWFuYWdlci5hZGRUYXNrKGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC50YXNrID0gdGhpcy50YXNrTWFuYWdlci5hZGRUYXNrKGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIOabtOaWsCBtdGltZSDorrDlvZVcbiAgICAgICAgICAgICAgICB0aGlzLmluZm9NYW5hZ2VyLmFkZChmaWxlLCBmaWxlU3RhdC5tdGltZU1zLCBhc3NldC51dWlkKTtcbiAgICAgICAgICAgICAgICBhc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xuICAgICAgICAgICAgICAgIGFzc2V0LnRhc2sgPSB0aGlzLnRhc2tNYW5hZ2VyLmFkZFRhc2soYXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19