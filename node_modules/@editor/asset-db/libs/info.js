'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.InfoManager = void 0;
const fs_extra_1 = require("fs-extra");
/**
 * 缓存所有文件的 mtimeMs 时间，用于比对是否修改
 * 这部分数据需要落地到文件系统
 */
class InfoManager {
    constructor() {
        // 列表
        this.map = {};
        // 保存使用的 timer
        this._saveTimer = null;
    }
    /**
     * 设置记录数据的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.map = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                console.error(error);
                this.map = {};
            }
        }
        else {
            this.map = {};
        }
    }
    /**
     * 销毁一个管理器实例
     * @param manager
     */
    destroy() {
        this.map = {};
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.map, { spaces: 2 });
    }
    /**
     * 更新一个缓存数据
     * @param path
     * @param mtimeMs
     * @param uuid
     */
    add(path, mtimeMs, uuid) {
        if (this.map[path]
            && this.map[path].uuid === uuid
            && this.map[path].time === mtimeMs) {
            return;
        }
        if (uuid) {
            this.map[path] = {
                time: mtimeMs,
                uuid: uuid,
                missing: false,
            };
        }
        else {
            this.map[path] = {
                time: mtimeMs,
            };
        }
        this.save();
    }
    /**
     * 删除缓存的一个 mtime 数据
     * @param path
     */
    remove(path) {
        if (!this.map[path]) {
            return;
        }
        delete this.map[path];
        this.save();
    }
    /**
     * 获取缓存的 stats 对象
     * @param path
     */
    get(path) {
        return this.map[path] || null;
    }
    /**
     * 对比现在文件和内存里缓存的 stats 是否有修改
     * 返回是否相等
     * @param path
     * @param stats
     */
    compare(path, mtimeMs) {
        // 如果缓存不存在，则认为修改了
        const target = this.map[path];
        if (!target) {
            return false;
        }
        // 如果 ms 记录相等，则认为没有修改
        if (target.time === mtimeMs) {
            return true;
        }
        return false;
    }
}
exports.InfoManager = InfoManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mby5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2luZm8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBb0U7QUFVcEU7OztHQUdHO0FBQ0gsTUFBYSxXQUFXO0lBQXhCO1FBS0ksS0FBSztRQUNMLFFBQUcsR0FBa0MsRUFBRSxDQUFDO1FBRXhDLGNBQWM7UUFDZCxlQUFVLEdBQVEsSUFBSSxDQUFDO0lBbUgzQixDQUFDO0lBakhHOzs7T0FHRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBWTtRQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsRUFBRTtZQUNsQixJQUFJO2dCQUNBLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBQSx1QkFBWSxFQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN0QztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO2FBQ2pCO1NBQ0o7YUFBTTtZQUNILElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1NBQ2pCO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNILE9BQU87UUFDSCxJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUFJO1FBQ0EsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3pCLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNaLENBQUM7SUFFRDs7T0FFRztJQUNILGFBQWE7UUFDVCxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxJQUFJLElBQUksSUFBQSx5QkFBYyxFQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEdBQUcsQ0FBQyxJQUFZLEVBQUUsT0FBZSxFQUFFLElBQWE7UUFDNUMsSUFDSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztlQUNYLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUk7ZUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUNwQztZQUNFLE9BQU87U0FDVjtRQUVELElBQUksSUFBSSxFQUFFO1lBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRztnQkFDYixJQUFJLEVBQUUsT0FBTztnQkFDYixJQUFJLEVBQUUsSUFBSTtnQkFDVixPQUFPLEVBQUUsS0FBSzthQUNqQixDQUFDO1NBQ0w7YUFBTTtZQUNILElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUc7Z0JBQ2IsSUFBSSxFQUFFLE9BQU87YUFDaEIsQ0FBQztTQUNMO1FBQ0QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsSUFBWTtRQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2pCLE9BQU87U0FDVjtRQUNELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILEdBQUcsQ0FBQyxJQUFZO1FBQ1osT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNsQyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxPQUFPLENBQUMsSUFBWSxFQUFFLE9BQWU7UUFDakMsaUJBQWlCO1FBQ2pCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQscUJBQXFCO1FBQ3JCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQTVIRCxrQ0E0SEMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5cbmludGVyZmFjZSBTaW1wbGVJbmZvIHtcbiAgICB0aW1lOiBudW1iZXI7XG5cbiAgICAvLyDotYTmupDmlofku7bmiY3kvJrmnInov5nkuKTkuKrmlbDmja5cbiAgICB1dWlkPzogc3RyaW5nO1xuICAgIG1pc3Npbmc/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIOe8k+WtmOaJgOacieaWh+S7tueahCBtdGltZU1zIOaXtumXtO+8jOeUqOS6juavlOWvueaYr+WQpuS/ruaUuVxuICog6L+Z6YOo5YiG5pWw5o2u6ZyA6KaB6JC95Zyw5Yiw5paH5Lu257O757ufXG4gKi9cbmV4cG9ydCBjbGFzcyBJbmZvTWFuYWdlciB7XG5cbiAgICAvLyDlm7rljJbmlbDmja7nmoTkv53lrZjot6/lvoRcbiAgICBmaWxlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAvLyDliJfooahcbiAgICBtYXA6IHtbaW5kZXg6IHN0cmluZ106IFNpbXBsZUluZm99ID0ge307XG5cbiAgICAvLyDkv53lrZjkvb/nlKjnmoQgdGltZXJcbiAgICBfc2F2ZVRpbWVyOiBhbnkgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICog6K6+572u6K6w5b2V5pWw5o2u55qEIGpzb24g5paH5Lu2XG4gICAgICogQHBhcmFtIGpzb24gXG4gICAgICovXG4gICAgYXN5bmMgc2V0UmVjb3JkSlNPTihqc29uOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWxlID0ganNvbjtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoanNvbikpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXAgPSByZWFkSlNPTlN5bmModGhpcy5maWxlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXAgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubWFwID0ge307XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDplIDmr4HkuIDkuKrnrqHnkIblmajlrp7kvotcbiAgICAgKiBAcGFyYW0gbWFuYWdlciBcbiAgICAgKi9cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLm1hcCA9IHt9O1xuICAgIH1cblxuICAgIC8qXG4gICAgICog5bu26L+f5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zYXZlSW1tZWRpYXRlKCk7XG4gICAgICAgIH0sIDQwMCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiDnq4vljbPkv53lrZjkvp3otZbmlofku7ZcbiAgICAgKi9cbiAgICBzYXZlSW1tZWRpYXRlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5maWxlICYmIG91dHB1dEpTT05TeW5jKHRoaXMuZmlsZSwgdGhpcy5tYXAsIHsgc3BhY2VzOiAyIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOabtOaWsOS4gOS4que8k+WtmOaVsOaNrlxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqIEBwYXJhbSBtdGltZU1zIFxuICAgICAqIEBwYXJhbSB1dWlkXG4gICAgICovXG4gICAgYWRkKHBhdGg6IHN0cmluZywgbXRpbWVNczogbnVtYmVyLCB1dWlkPzogc3RyaW5nKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHRoaXMubWFwW3BhdGhdXG4gICAgICAgICAgICAmJiB0aGlzLm1hcFtwYXRoXS51dWlkID09PSB1dWlkXG4gICAgICAgICAgICAmJiB0aGlzLm1hcFtwYXRoXS50aW1lID09PSBtdGltZU1zXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHV1aWQpIHtcbiAgICAgICAgICAgIHRoaXMubWFwW3BhdGhdID0ge1xuICAgICAgICAgICAgICAgIHRpbWU6IG10aW1lTXMsXG4gICAgICAgICAgICAgICAgdXVpZDogdXVpZCxcbiAgICAgICAgICAgICAgICBtaXNzaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm1hcFtwYXRoXSA9IHtcbiAgICAgICAgICAgICAgICB0aW1lOiBtdGltZU1zLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDliKDpmaTnvJPlrZjnmoTkuIDkuKogbXRpbWUg5pWw5o2uXG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICovXG4gICAgcmVtb3ZlKHBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAoIXRoaXMubWFwW3BhdGhdKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZGVsZXRlIHRoaXMubWFwW3BhdGhdO1xuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDojrflj5bnvJPlrZjnmoQgc3RhdHMg5a+56LGhXG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICovXG4gICAgZ2V0KHBhdGg6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5tYXBbcGF0aF0gfHwgbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlr7nmr5TnjrDlnKjmlofku7blkozlhoXlrZjph4znvJPlrZjnmoQgc3RhdHMg5piv5ZCm5pyJ5L+u5pS5XG4gICAgICog6L+U5Zue5piv5ZCm55u4562JXG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICogQHBhcmFtIHN0YXRzIFxuICAgICAqL1xuICAgIGNvbXBhcmUocGF0aDogc3RyaW5nLCBtdGltZU1zOiBudW1iZXIpIHtcbiAgICAgICAgLy8g5aaC5p6c57yT5a2Y5LiN5a2Y5Zyo77yM5YiZ6K6k5Li65L+u5pS55LqGXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMubWFwW3BhdGhdO1xuICAgICAgICBpZiAoIXRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5aaC5p6cIG1zIOiusOW9leebuOetie+8jOWImeiupOS4uuayoeacieS/ruaUuVxuICAgICAgICBpZiAodGFyZ2V0LnRpbWUgPT09IG10aW1lTXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn0iXX0=