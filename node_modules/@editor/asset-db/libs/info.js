'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.InfoManager = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const migrator_1 = require("./migrator");
const migrations = [{
        version: '1.0.0',
        migrate: async (json, manager) => {
            const recordInfo = {
                version: InfoManager.version,
                map: {},
                missing: {},
            };
            // 旧版本数据需要做一次整理，将 missing 数据整理出来
            Object.keys(json).forEach((path) => {
                const info = json[path];
                if (info.missing) {
                    delete info.missing;
                    info.uuid && (recordInfo.missing[info.uuid] = {
                        path,
                        time: info.time,
                        removeTime: Date.now(),
                    });
                }
                else {
                    delete info.missing;
                    recordInfo.map[path] = info;
                }
            });
            return recordInfo;
        },
    }, {
        version: '1.0.1',
        migrate: async (json, manager) => {
            const recordInfo = {
                version: InfoManager.version,
                map: {},
                missing: {},
            };
            Object.keys(json).forEach((path) => {
                const info = json[path];
                const relativePath = (0, path_1.relative)(manager.pathRoot, path);
                if (relativePath.startsWith('..')) {
                    // 不在目标目录下，移除作为 Missing 文件
                    recordInfo.missing[path] = info;
                }
                else {
                    recordInfo[relativePath] = info;
                }
            });
            return recordInfo;
        },
    }];
function getDefaultRecordInfo() {
    return {
        version: InfoManager.version,
        map: {},
        missing: {},
    };
}
/**
 * 缓存所有文件的 mtimeMs 时间，用于比对是否修改
 * 这部分数据需要落地到文件系统
 */
class InfoManager {
    constructor(customConsole, pathRoot) {
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
        this.pathRoot = pathRoot;
        this.recordInfo = getDefaultRecordInfo();
    }
    /**
     * 设置记录数据的 json 文件
     * @param path
     */
    async setRecordJSON(path) {
        this.file = path;
        try {
            await this._restoreCache(path);
        }
        catch (error) {
            this.console.warn(error);
        }
    }
    async _restoreCache(path) {
        const recordInfo = getDefaultRecordInfo();
        const storeRecordInfo = await this._readRecordInfo(path);
        if (!storeRecordInfo) {
            return;
        }
        Object.keys(storeRecordInfo.map).forEach((path) => {
            recordInfo.map[(0, path_1.join)(this.pathRoot, path)] = storeRecordInfo.map[path];
        });
        // missing 数据只记录绝对路径
        recordInfo.missing = storeRecordInfo.missing;
        this.recordInfo = recordInfo;
    }
    async _readRecordInfo(path) {
        // 兼容 1.0.0 版本的记录文件
        const oldPath = path.replace('.json', '1.0.0.json');
        const migrator = new migrator_1.Migrator(migrations, InfoManager.version, {
            onError: (error, stage, data, ...args) => {
                this.console.warn(`migrate error in infoManager: ${error}`);
                this.console.warn(error);
            }
        });
        if ((0, fs_extra_1.existsSync)(oldPath)) {
            try {
                const recordInfo = (0, fs_extra_1.readJSONSync)(oldPath);
                await (0, fs_extra_1.remove)(oldPath);
                return await migrator.run(recordInfo, '1.0.0', [this]);
            }
            catch (error) {
                this.console.warn(error);
            }
            return;
        }
        if ((0, fs_extra_1.existsSync)(path)) {
            try {
                const recordInfo = (0, fs_extra_1.readJSONSync)(path);
                return await migrator.run(recordInfo, InfoManager.version, [this]);
            }
            catch (error) {
                this.console.warn(error);
            }
        }
    }
    /**
     * 销毁一个管理器实例
     * @param manager
     */
    destroy() {
        this.recordInfo = getDefaultRecordInfo();
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        this._saveTimer && clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存记录文件
     */
    saveImmediate() {
        this._saveTimer && clearTimeout(this._saveTimer);
        if (this.file) {
            // 保存记录之前需要将绝对路径转换为相对路径
            const recordInfo = getDefaultRecordInfo();
            Object.keys(this.recordInfo.map).forEach((path) => {
                recordInfo.map[(0, path_1.relative)(this.pathRoot, path)] = this.recordInfo.map[path];
            });
            (0, fs_extra_1.outputJSONSync)(this.file, recordInfo, { spaces: 2 });
        }
    }
    /**
     * 更新一个缓存数据
     * @param path
     * @param mtimeMs
     * @param uuid
     */
    add(path, mtimeMs, uuid) {
        if (this.recordInfo.map[path]
            && this.recordInfo.map[path].uuid === uuid
            && this.recordInfo.map[path].time === mtimeMs) {
            return;
        }
        if (uuid) {
            this.recordInfo.map[path] = {
                time: mtimeMs,
                uuid: uuid,
            };
        }
        else {
            this.recordInfo.map[path] = {
                time: mtimeMs,
            };
        }
        this.save();
    }
    /**
     * 删除缓存的一个 mtime 数据
     * @param path
     */
    remove(path) {
        if (!this.recordInfo.map[path]) {
            return;
        }
        const info = this.recordInfo.map[path];
        this.addMissing(path, info);
        delete this.recordInfo.map[path];
        this.save();
    }
    /**
     * 获取缓存的 stats 对象
     * @param path
     */
    get(path) {
        return this.recordInfo.map[path] || null;
    }
    /**
     * 添加一个丢失的资源信息
     * @param path
     * @param info
     */
    addMissing(path, info) {
        info.uuid && (this.recordInfo.missing[info.uuid] = {
            path,
            time: info.time,
            removeTime: Date.now(),
        });
    }
    /**
     * 根据 uuid 获取丢失的资源信息
     * @param uuid
     * @returns
     */
    getMissingInfo(uuid) {
        return this.recordInfo.missing[uuid] || null;
    }
    /**
     * 对比现在文件和内存里缓存的 stats 是否有修改
     * 返回是否相等
     * @param path
     * @param stats
     */
    compare(path, mtimeMs) {
        // 如果缓存不存在，则认为修改了
        const target = this.recordInfo.map[path];
        if (!target) {
            return false;
        }
        // 如果 ms 记录相等，则认为没有修改
        if (target.time === mtimeMs) {
            return true;
        }
        return false;
    }
    async forEach(handler) {
        for (const path in this.recordInfo.map) {
            await handler(path, this.recordInfo.map[path]);
        }
    }
    ;
}
exports.InfoManager = InfoManager;
InfoManager.version = '1.0.1';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mby5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2luZm8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBd0Y7QUFFeEYsK0JBQXNDO0FBQ3RDLHlDQUErQztBQXFCL0MsTUFBTSxVQUFVLEdBQW1CLENBQUM7UUFDaEMsT0FBTyxFQUFFLE9BQU87UUFDaEIsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFTLEVBQUUsT0FBb0IsRUFBRSxFQUFFO1lBQy9DLE1BQU0sVUFBVSxHQUFHO2dCQUNmLE9BQU8sRUFBRSxXQUFXLENBQUMsT0FBTztnQkFDNUIsR0FBRyxFQUFFLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLEVBQUU7YUFDZCxDQUFDO1lBQ0YsZ0NBQWdDO1lBQ2hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDeEIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO29CQUNkLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDcEIsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHO3dCQUMxQyxJQUFJO3dCQUNKLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTt3QkFDZixVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtxQkFDekIsQ0FBQyxDQUFDO2lCQUNOO3FCQUFNO29CQUNILE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDcEIsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7aUJBQy9CO1lBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLFVBQVUsQ0FBQztRQUN0QixDQUFDO0tBQ0osRUFBRTtR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Q0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQy9DLElBQUk7WUFDSixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtTQUN6QixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGNBQWMsQ0FBQyxJQUFZO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ2pELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILE9BQU8sQ0FBQyxJQUFZLEVBQUUsT0FBZTtRQUNqQyxpQkFBaUI7UUFDakIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQscUJBQXFCO1FBQ3JCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQWlCO1FBQzNCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDcEMsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDbEQ7SUFDTCxDQUFDO0lBQUEsQ0FBQzs7QUE3TU4sa0NBOE1DO0FBN01VLG1CQUFPLEdBQUcsT0FBTyxBQUFWLENBQVciLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMsIHJlbW92ZSwgcmVtb3ZlU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IEN1c3RvbUNvbnNvbGUgfSBmcm9tICcuL2NvbnNvbGUnO1xuaW1wb3J0IHsgam9pbiwgcmVsYXRpdmUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IE1pZ3JhdGUsIE1pZ3JhdG9yIH0gZnJvbSAnLi9taWdyYXRvcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2ltcGxlSW5mbyB7XG4gICAgdGltZTogbnVtYmVyO1xuXG4gICAgLy8g6LWE5rqQ5paH5Lu25omN5Lya5pyJ6L+Z5Lik5Liq5pWw5o2uXG4gICAgdXVpZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBNaXNzaW5nQXNzZXRJbmZvIHtcbiAgICBwYXRoOiBzdHJpbmc7XG4gICAgdGltZTogbnVtYmVyO1xuICAgIHJlbW92ZVRpbWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWNvcmRJbmZvTWFwIHtcbiAgICB2ZXJzaW9uOiBzdHJpbmc7XG4gICAgbWFwOiB7IFtwYXRoOiBzdHJpbmddOiBTaW1wbGVJbmZvIH07XG4gICAgbWlzc2luZzogeyBbcGF0aDogc3RyaW5nXTogTWlzc2luZ0Fzc2V0SW5mbyB9O1xufVxuXG5jb25zdCBtaWdyYXRpb25zOiBNaWdyYXRlPGFueT5bXSA9IFt7XG4gICAgdmVyc2lvbjogJzEuMC4wJyxcbiAgICBtaWdyYXRlOiBhc3luYyAoanNvbjogYW55LCBtYW5hZ2VyOiBJbmZvTWFuYWdlcikgPT4ge1xuICAgICAgICBjb25zdCByZWNvcmRJbmZvID0ge1xuICAgICAgICAgICAgdmVyc2lvbjogSW5mb01hbmFnZXIudmVyc2lvbixcbiAgICAgICAgICAgIG1hcDoge30sXG4gICAgICAgICAgICBtaXNzaW5nOiB7fSxcbiAgICAgICAgfTtcbiAgICAgICAgLy8g5pen54mI5pys5pWw5o2u6ZyA6KaB5YGa5LiA5qyh5pW055CG77yM5bCGIG1pc3Npbmcg5pWw5o2u5pW055CG5Ye65p2lXG4gICAgICAgIE9iamVjdC5rZXlzKGpzb24pLmZvckVhY2goKHBhdGgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBqc29uW3BhdGhdO1xuICAgICAgICAgICAgaWYgKGluZm8ubWlzc2luZykge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBpbmZvLm1pc3Npbmc7XG4gICAgICAgICAgICAgICAgaW5mby51dWlkICYmIChyZWNvcmRJbmZvLm1pc3NpbmdbaW5mby51dWlkXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICAgICAgdGltZTogaW5mby50aW1lLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVUaW1lOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgaW5mby5taXNzaW5nO1xuICAgICAgICAgICAgICAgIHJlY29yZEluZm8ubWFwW3BhdGhdID0gaW5mbztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZWNvcmRJbmZvO1xuICAgIH0sXG59LCB7XG4gICAgdmVyc2lvbjogJzEuMC4xJyxcbiAgICBtaWdyYXRlOiBhc3luYyAoanNvbjogUmVjb3JkSW5mb01hcCwgbWFuYWdlcjogSW5mb01hbmFnZXIpID0+IHtcbiAgICAgICAgY29uc3QgcmVjb3JkSW5mbyA9IHtcbiAgICAgICAgICAgIHZlcnNpb246IEluZm9NYW5hZ2VyLnZlcnNpb24sXG4gICAgICAgICAgICBtYXA6IHt9LFxuICAgICAgICAgICAgbWlzc2luZzoge30sXG4gICAgICAgIH07XG4gICAgICAgIE9iamVjdC5rZXlzKGpzb24pLmZvckVhY2goKHBhdGgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBqc29uW3BhdGhdO1xuICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcmVsYXRpdmUobWFuYWdlci5wYXRoUm9vdCwgcGF0aCk7XG4gICAgICAgICAgICBpZiAocmVsYXRpdmVQYXRoLnN0YXJ0c1dpdGgoJy4uJykpIHtcbiAgICAgICAgICAgICAgICAvLyDkuI3lnKjnm67moIfnm67lvZXkuIvvvIznp7vpmaTkvZzkuLogTWlzc2luZyDmlofku7ZcbiAgICAgICAgICAgICAgICByZWNvcmRJbmZvLm1pc3NpbmdbcGF0aF0gPSBpbmZvO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWNvcmRJbmZvW3JlbGF0aXZlUGF0aF0gPSBpbmZvO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlY29yZEluZm9cbiAgICB9LFxufV1cbmZ1bmN0aW9uIGdldERlZmF1bHRSZWNvcmRJbmZvKCk6IFJlY29yZEluZm9NYXAge1xuICAgIHJldHVybiB7XG4gICAgICAgIHZlcnNpb246IEluZm9NYW5hZ2VyLnZlcnNpb24sXG4gICAgICAgIG1hcDoge30sXG4gICAgICAgIG1pc3Npbmc6IHt9LFxuICAgIH07XG59XG5cbi8qKlxuICog57yT5a2Y5omA5pyJ5paH5Lu255qEIG10aW1lTXMg5pe26Ze077yM55So5LqO5q+U5a+55piv5ZCm5L+u5pS5XG4gKiDov5npg6jliIbmlbDmja7pnIDopoHokL3lnLDliLDmlofku7bns7vnu59cbiAqL1xuZXhwb3J0IGNsYXNzIEluZm9NYW5hZ2VyIHtcbiAgICBzdGF0aWMgdmVyc2lvbiA9ICcxLjAuMSc7XG5cbiAgICAvLyDlm7rljJbmlbDmja7nmoTkv53lrZjot6/lvoRcbiAgICBwcml2YXRlIGZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwYXRoUm9vdDogc3RyaW5nO1xuICAgIHByaXZhdGUgcmVjb3JkSW5mbzogUmVjb3JkSW5mb01hcDtcbiAgICBwcml2YXRlIGNvbnNvbGU6IEN1c3RvbUNvbnNvbGU7XG4gICAgY29uc3RydWN0b3IoY3VzdG9tQ29uc29sZTogQ3VzdG9tQ29uc29sZSwgcGF0aFJvb3Q6IHN0cmluZykge1xuICAgICAgICB0aGlzLmNvbnNvbGUgPSBjdXN0b21Db25zb2xlIHx8IGNvbnNvbGU7XG4gICAgICAgIHRoaXMucGF0aFJvb3QgPSBwYXRoUm9vdDtcbiAgICAgICAgdGhpcy5yZWNvcmRJbmZvID0gZ2V0RGVmYXVsdFJlY29yZEluZm8oKTtcbiAgICB9XG5cbiAgICAvLyDkv53lrZjkvb/nlKjnmoQgdGltZXJcbiAgICBfc2F2ZVRpbWVyOiBudWxsIHwgTm9kZUpTLlRpbWVvdXQgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICog6K6+572u6K6w5b2V5pWw5o2u55qEIGpzb24g5paH5Lu2XG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICovXG4gICAgYXN5bmMgc2V0UmVjb3JkSlNPTihwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWxlID0gcGF0aDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3RvcmVDYWNoZShwYXRoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX3Jlc3RvcmVDYWNoZShwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgcmVjb3JkSW5mbyA9IGdldERlZmF1bHRSZWNvcmRJbmZvKCk7XG4gICAgICAgIGNvbnN0IHN0b3JlUmVjb3JkSW5mbyA9IGF3YWl0IHRoaXMuX3JlYWRSZWNvcmRJbmZvKHBhdGgpO1xuICAgICAgICBpZiAoIXN0b3JlUmVjb3JkSW5mbykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIE9iamVjdC5rZXlzKHN0b3JlUmVjb3JkSW5mby5tYXApLmZvckVhY2goKHBhdGgpID0+IHtcbiAgICAgICAgICAgIHJlY29yZEluZm8ubWFwW2pvaW4odGhpcy5wYXRoUm9vdCwgcGF0aCldID0gc3RvcmVSZWNvcmRJbmZvLm1hcFtwYXRoXTtcbiAgICAgICAgfSlcbiAgICAgICAgLy8gbWlzc2luZyDmlbDmja7lj6rorrDlvZXnu53lr7not6/lvoRcbiAgICAgICAgcmVjb3JkSW5mby5taXNzaW5nID0gc3RvcmVSZWNvcmRJbmZvLm1pc3Npbmc7XG4gICAgICAgIHRoaXMucmVjb3JkSW5mbyA9IHJlY29yZEluZm87XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfcmVhZFJlY29yZEluZm8ocGF0aDogc3RyaW5nKTogUHJvbWlzZTxSZWNvcmRJbmZvTWFwIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIC8vIOWFvOWuuSAxLjAuMCDniYjmnKznmoTorrDlvZXmlofku7ZcbiAgICAgICAgY29uc3Qgb2xkUGF0aCA9IHBhdGgucmVwbGFjZSgnLmpzb24nLCAnMS4wLjAuanNvbicpO1xuICAgICAgICBjb25zdCBtaWdyYXRvciA9IG5ldyBNaWdyYXRvcjxSZWNvcmRJbmZvTWFwPihtaWdyYXRpb25zLCBJbmZvTWFuYWdlci52ZXJzaW9uLCB7XG4gICAgICAgICAgICBvbkVycm9yOiAoZXJyb3IsIHN0YWdlLCBkYXRhLCAuLi5hcmdzKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLndhcm4oYG1pZ3JhdGUgZXJyb3IgaW4gaW5mb01hbmFnZXI6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLndhcm4oZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMob2xkUGF0aCkpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVjb3JkSW5mbyA9IHJlYWRKU09OU3luYyhvbGRQYXRoKTtcbiAgICAgICAgICAgICAgICBhd2FpdCByZW1vdmUob2xkUGF0aCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1pZ3JhdG9yLnJ1bihyZWNvcmRJbmZvLCAnMS4wLjAnLCBbdGhpc10pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUud2FybihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWNvcmRJbmZvID0gcmVhZEpTT05TeW5jKHBhdGgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBtaWdyYXRvci5ydW4ocmVjb3JkSW5mbywgSW5mb01hbmFnZXIudmVyc2lvbiwgW3RoaXNdKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLndhcm4oZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6ZSA5q+B5LiA5Liq566h55CG5Zmo5a6e5L6LXG4gICAgICogQHBhcmFtIG1hbmFnZXIgXG4gICAgICovXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5yZWNvcmRJbmZvID0gZ2V0RGVmYXVsdFJlY29yZEluZm8oKTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOW7tui/n+S/neWtmOS+nei1luaWh+S7tlxuICAgICAqL1xuICAgIHNhdmUoKSB7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciAmJiBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5fc2F2ZVRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNhdmVJbW1lZGlhdGUoKTtcbiAgICAgICAgfSwgNDAwKTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOeri+WNs+S/neWtmOiusOW9leaWh+S7tlxuICAgICAqL1xuICAgIHNhdmVJbW1lZGlhdGUoKSB7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciAmJiBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgaWYgKHRoaXMuZmlsZSkge1xuICAgICAgICAgICAgLy8g5L+d5a2Y6K6w5b2V5LmL5YmN6ZyA6KaB5bCG57ud5a+56Lev5b6E6L2s5o2i5Li655u45a+56Lev5b6EXG4gICAgICAgICAgICBjb25zdCByZWNvcmRJbmZvID0gZ2V0RGVmYXVsdFJlY29yZEluZm8oKVxuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5yZWNvcmRJbmZvLm1hcCkuZm9yRWFjaCgocGF0aCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlY29yZEluZm8ubWFwW3JlbGF0aXZlKHRoaXMucGF0aFJvb3QsIHBhdGgpXSA9IHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF07XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgb3V0cHV0SlNPTlN5bmModGhpcy5maWxlLCByZWNvcmRJbmZvLCB7IHNwYWNlczogMiB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOabtOaWsOS4gOS4que8k+WtmOaVsOaNrlxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqIEBwYXJhbSBtdGltZU1zIFxuICAgICAqIEBwYXJhbSB1dWlkXG4gICAgICovXG4gICAgYWRkKHBhdGg6IHN0cmluZywgbXRpbWVNczogbnVtYmVyLCB1dWlkPzogc3RyaW5nKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF1cbiAgICAgICAgICAgICYmIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0udXVpZCA9PT0gdXVpZFxuICAgICAgICAgICAgJiYgdGhpcy5yZWNvcmRJbmZvLm1hcFtwYXRoXS50aW1lID09PSBtdGltZU1zXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHV1aWQpIHtcbiAgICAgICAgICAgIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0gPSB7XG4gICAgICAgICAgICAgICAgdGltZTogbXRpbWVNcyxcbiAgICAgICAgICAgICAgICB1dWlkOiB1dWlkLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0gPSB7XG4gICAgICAgICAgICAgICAgdGltZTogbXRpbWVNcyxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5Yig6Zmk57yT5a2Y55qE5LiA5LiqIG10aW1lIOaVsOaNrlxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqL1xuICAgIHJlbW92ZShwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF07XG4gICAgICAgIHRoaXMuYWRkTWlzc2luZyhwYXRoLCBpbmZvKTtcblxuICAgICAgICBkZWxldGUgdGhpcy5yZWNvcmRJbmZvLm1hcFtwYXRoXTtcbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W57yT5a2Y55qEIHN0YXRzIOWvueixoVxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqL1xuICAgIGdldChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0gfHwgbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmt7vliqDkuIDkuKrkuKLlpLHnmoTotYTmupDkv6Hmga9cbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKiBAcGFyYW0gaW5mbyBcbiAgICAgKi9cbiAgICBwcml2YXRlIGFkZE1pc3NpbmcocGF0aDogc3RyaW5nLCBpbmZvOiBTaW1wbGVJbmZvKSB7XG4gICAgICAgIGluZm8udXVpZCAmJiAodGhpcy5yZWNvcmRJbmZvLm1pc3NpbmdbaW5mby51dWlkXSA9IHtcbiAgICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICB0aW1lOiBpbmZvLnRpbWUsXG4gICAgICAgICAgICByZW1vdmVUaW1lOiBEYXRlLm5vdygpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmoLnmja4gdXVpZCDojrflj5bkuKLlpLHnmoTotYTmupDkv6Hmga9cbiAgICAgKiBAcGFyYW0gdXVpZCBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBnZXRNaXNzaW5nSW5mbyh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVjb3JkSW5mby5taXNzaW5nW3V1aWRdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5a+55q+U546w5Zyo5paH5Lu25ZKM5YaF5a2Y6YeM57yT5a2Y55qEIHN0YXRzIOaYr+WQpuacieS/ruaUuVxuICAgICAqIOi/lOWbnuaYr+WQpuebuOetiVxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqIEBwYXJhbSBzdGF0cyBcbiAgICAgKi9cbiAgICBjb21wYXJlKHBhdGg6IHN0cmluZywgbXRpbWVNczogbnVtYmVyKSB7XG4gICAgICAgIC8vIOWmguaenOe8k+WtmOS4jeWtmOWcqO+8jOWImeiupOS4uuS/ruaUueS6hlxuICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdO1xuICAgICAgICBpZiAoIXRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5aaC5p6cIG1zIOiusOW9leebuOetie+8jOWImeiupOS4uuayoeacieS/ruaUuVxuICAgICAgICBpZiAodGFyZ2V0LnRpbWUgPT09IG10aW1lTXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGFzeW5jIGZvckVhY2goaGFuZGxlcjogRnVuY3Rpb24pIHtcbiAgICAgICAgZm9yIChjb25zdCBwYXRoIGluIHRoaXMucmVjb3JkSW5mby5tYXApIHtcbiAgICAgICAgICAgIGF3YWl0IGhhbmRsZXIocGF0aCwgdGhpcy5yZWNvcmRJbmZvLm1hcFtwYXRoXSk7XG4gICAgICAgIH1cbiAgICB9O1xufSJdfQ==