"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.InfoManager=void 0;const fs_extra_1=require("fs-extra");class InfoManager{constructor(){this.recordInfo={version:InfoManager.version,map:{},missing:{}},this._saveTimer=null}map(){return this.recordInfo.map}setRecordJSON(e){if(this.file=e.replace(".json",`${InfoManager.version}.json`),(0,fs_extra_1.existsSync)(this.file))try{const e=(0,fs_extra_1.readJSONSync)(this.file);this.loadRecordJson(e)}catch(e){console.error(e)}else if((0,fs_extra_1.existsSync)(e))try{const s=(0,fs_extra_1.readJSONSync)(e);this.loadRecordJson(s),(0,fs_extra_1.outputJSONSync)(this.file,this.recordInfo,{spaces:2})}catch(e){console.error(e)}}loadRecordJson(e){e.version?this.recordInfo=e:Object.keys(e).forEach(s=>{const r=e[s];r.missing?(delete r.missing,r.uuid&&(this.recordInfo.missing[r.uuid]={path:s,time:r.time,removeTime:Date.now()})):(delete r.missing,this.recordInfo.map[s]=r)})}destroy(){this.recordInfo.map={},this.recordInfo.missing={}}save(){this._saveTimer&&clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},400)}saveImmediate(){this._saveTimer&&clearTimeout(this._saveTimer),this.file&&(0,fs_extra_1.outputJSONSync)(this.file,this.recordInfo,{spaces:2})}add(e,s,r){this.recordInfo.map[e]&&this.recordInfo.map[e].uuid===r&&this.recordInfo.map[e].time===s||(this.recordInfo.map[e]=r?{time:s,uuid:r}:{time:s},this.save())}remove(e){if(!this.recordInfo.map[e])return;const s=this.recordInfo.map[e];this.addMissing(e,s),delete this.recordInfo.map[e],this.save()}get(e){return this.recordInfo.map[e]||null}addMissing(e,s){s.uuid&&(this.recordInfo.missing[s.uuid]={path:e,time:s.time,removeTime:Date.now()})}getMissingInfo(e){return this.recordInfo.missing[e]||null}compare(e,s){const r=this.recordInfo.map[e];return!!r&&r.time===s}async forEach(e){for(const s in this.recordInfo.map)await e(s,this.recordInfo.map[s])}}exports.InfoManager=InfoManager,InfoManager.version="1.0.0";