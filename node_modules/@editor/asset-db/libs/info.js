"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.InfoManager=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),migrator_1=require("./migrator"),migrations=[{version:"1.0.0",migrate:async(e,t)=>{const r={version:InfoManager.version,map:{},missing:{}};return Object.keys(e).forEach(t=>{const s=e[t];s.missing?(delete s.missing,s.uuid&&(r.missing[s.uuid]={path:t,time:s.time,removeTime:Date.now()})):(delete s.missing,r.map[t]=s)}),r}},{version:"1.0.1",migrate:async(e,t)=>{const r={version:InfoManager.version,map:{},missing:{}};return Object.keys(e).forEach(s=>{const i=e[s],o=(0,path_1.relative)(t.pathRoot,s);o.startsWith("..")?r.missing[s]=i:r[o]=i}),r}}];function getDefaultRecordInfo(){return{version:InfoManager.version,map:{},missing:{}}}class InfoManager{constructor(e,t){this._saveTimer=null,this.console=e||console,this.pathRoot=t,this.recordInfo=getDefaultRecordInfo()}async setRecordJSON(e){this.file=e;try{await this._restoreCache(e)}catch(e){this.console.warn(e)}}async _restoreCache(e){const t=getDefaultRecordInfo(),r=await this._readRecordInfo(e);r&&(Object.keys(r.map).forEach(e=>{t.map[(0,path_1.join)(this.pathRoot,e)]=r.map[e]}),t.missing=r.missing,this.recordInfo=t)}async _readRecordInfo(e){const t=e.replace(".json","1.0.0.json"),r=new migrator_1.Migrator(migrations,InfoManager.version,{onError:(e,t,r,...s)=>{this.console.warn(`migrate error in infoManager: ${e}`),this.console.warn(e)}});if((0,fs_extra_1.existsSync)(t))try{const e=(0,fs_extra_1.readJSONSync)(t);return await(0,fs_extra_1.remove)(t),await r.run(e,"1.0.0",[this])}catch(e){this.console.warn(e)}else if((0,fs_extra_1.existsSync)(e))try{const t=(0,fs_extra_1.readJSONSync)(e);return await r.run(t,InfoManager.version,[this])}catch(e){this.console.warn(e)}}destroy(){this.recordInfo=getDefaultRecordInfo()}save(){this._saveTimer&&clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},400)}saveImmediate(){if(this._saveTimer&&clearTimeout(this._saveTimer),this.file){const e=getDefaultRecordInfo();Object.keys(this.recordInfo.map).forEach(t=>{e.map[(0,path_1.relative)(this.pathRoot,t)]=this.recordInfo.map[t]}),(0,fs_extra_1.outputJSONSync)(this.file,e,{spaces:2})}}add(e,t,r){this.recordInfo.map[e]&&this.recordInfo.map[e].uuid===r&&this.recordInfo.map[e].time===t||(this.recordInfo.map[e]=r?{time:t,uuid:r}:{time:t},this.save())}remove(e){if(!this.recordInfo.map[e])return;const t=this.recordInfo.map[e];this.addMissing(e,t),delete this.recordInfo.map[e],this.save()}get(e){return this.recordInfo.map[e]||null}addMissing(e,t){t.uuid&&(this.recordInfo.missing[t.uuid]={path:e,time:t.time,removeTime:Date.now()})}getMissingInfo(e){return this.recordInfo.missing[e]||null}compare(e,t){const r=this.recordInfo.map[e];return!!r&&r.time===t}async forEach(e){for(const t in this.recordInfo.map)await e(t,this.recordInfo.map[t])}}exports.InfoManager=InfoManager,InfoManager.version="1.0.1";