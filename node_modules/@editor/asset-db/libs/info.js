'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.InfoManager = void 0;
const fs_extra_1 = require("fs-extra");
/**
 * 缓存所有文件的 mtimeMs 时间，用于比对是否修改
 * 这部分数据需要落地到文件系统
 */
class InfoManager {
    constructor(customConsole) {
        this.recordInfo = {
            version: InfoManager.version,
            map: {},
            missing: {},
        };
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
    }
    /**
     * 设置记录数据的 json 文件
     * @param json
     */
    setRecordJSON(json) {
        this.file = json.replace('.json', `${InfoManager.version}.json`);
        // 优先取当前版本号的配置数据
        if ((0, fs_extra_1.existsSync)(this.file)) {
            try {
                const recordInfo = (0, fs_extra_1.readJSONSync)(this.file);
                this.loadRecordJson(recordInfo);
            }
            catch (error) {
                this.console.error(error);
            }
            return;
        }
        // 兼容获取旧版本数据, 同时写入到新的数据文件内
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                const recordInfo = (0, fs_extra_1.readJSONSync)(json);
                this.loadRecordJson(recordInfo);
                (0, fs_extra_1.outputJSONSync)(this.file, this.recordInfo, { spaces: 2 });
            }
            catch (error) {
                this.console.error(error);
            }
        }
    }
    loadRecordJson(recordInfo) {
        if (!recordInfo.version) {
            // 旧版本数据需要做一次整理，将 missing 数据整理出来
            Object.keys(recordInfo).forEach((path) => {
                const info = recordInfo[path];
                if (info.missing) {
                    delete info.missing;
                    info.uuid && (this.recordInfo.missing[info.uuid] = {
                        path,
                        time: info.time,
                        removeTime: Date.now(),
                    });
                }
                else {
                    delete info.missing;
                    this.recordInfo.map[path] = info;
                }
            });
        }
        else {
            this.recordInfo = recordInfo;
        }
    }
    /**
     * 销毁一个管理器实例
     * @param manager
     */
    destroy() {
        this.recordInfo.map = {};
        this.recordInfo.missing = {};
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        this._saveTimer && clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存记录文件
     */
    saveImmediate() {
        this._saveTimer && clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.recordInfo, { spaces: 2 });
    }
    /**
     * 更新一个缓存数据
     * @param path
     * @param mtimeMs
     * @param uuid
     */
    add(path, mtimeMs, uuid) {
        if (this.recordInfo.map[path]
            && this.recordInfo.map[path].uuid === uuid
            && this.recordInfo.map[path].time === mtimeMs) {
            return;
        }
        if (uuid) {
            this.recordInfo.map[path] = {
                time: mtimeMs,
                uuid: uuid,
            };
        }
        else {
            this.recordInfo.map[path] = {
                time: mtimeMs,
            };
        }
        this.save();
    }
    /**
     * 删除缓存的一个 mtime 数据
     * @param path
     */
    remove(path) {
        if (!this.recordInfo.map[path]) {
            return;
        }
        const info = this.recordInfo.map[path];
        this.addMissing(path, info);
        delete this.recordInfo.map[path];
        this.save();
    }
    /**
     * 获取缓存的 stats 对象
     * @param path
     */
    get(path) {
        return this.recordInfo.map[path] || null;
    }
    /**
     * 添加一个丢失的资源信息
     * @param path
     * @param info
     */
    addMissing(path, info) {
        info.uuid && (this.recordInfo.missing[info.uuid] = {
            path,
            time: info.time,
            removeTime: Date.now(),
        });
    }
    /**
     * 根据 uuid 获取丢失的资源信息
     * @param uuid
     * @returns
     */
    getMissingInfo(uuid) {
        return this.recordInfo.missing[uuid] || null;
    }
    /**
     * 对比现在文件和内存里缓存的 stats 是否有修改
     * 返回是否相等
     * @param path
     * @param stats
     */
    compare(path, mtimeMs) {
        // 如果缓存不存在，则认为修改了
        const target = this.recordInfo.map[path];
        if (!target) {
            return false;
        }
        // 如果 ms 记录相等，则认为没有修改
        if (target.time === mtimeMs) {
            return true;
        }
        return false;
    }
    async forEach(handler) {
        for (const path in this.recordInfo.map) {
            await handler(path, this.recordInfo.map[path]);
        }
    }
    ;
}
exports.InfoManager = InfoManager;
InfoManager.version = '1.0.0';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mby5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2luZm8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBb0U7QUFzQnBFOzs7R0FHRztBQUNILE1BQWEsV0FBVztJQVdwQixZQUFZLGFBQTRCO1FBTmhDLGVBQVUsR0FBa0I7WUFDaEMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPO1lBQzVCLEdBQUcsRUFBRSxFQUFFO1lBQ1AsT0FBTyxFQUFFLEVBQUU7U0FDZCxDQUFDO1FBTUYsY0FBYztRQUNkLGVBQVUsR0FBMEIsSUFBSSxDQUFDO1FBSnJDLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxJQUFJLE9BQU8sQ0FBQztJQUM1QyxDQUFDO0lBS0Q7OztPQUdHO0lBQ0gsYUFBYSxDQUFDLElBQVk7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLFdBQVcsQ0FBQyxPQUFPLE9BQU8sQ0FBQyxDQUFDO1FBQ2pFLGdCQUFnQjtRQUNoQixJQUFJLElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkIsSUFBSTtnQkFDQSxNQUFNLFVBQVUsR0FBRyxJQUFBLHVCQUFZLEVBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ25DO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDN0I7WUFDRCxPQUFPO1NBQ1Y7UUFFRCwwQkFBMEI7UUFDMUIsSUFBSSxJQUFBLHFCQUFVLEVBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEIsSUFBSTtnQkFDQSxNQUFNLFVBQVUsR0FBRyxJQUFBLHVCQUFZLEVBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RD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LE9BQU8sQ0FBQyxJQUFZLEVBQUUsT0FBZTtRQUNqQyxpQkFBaUI7UUFDakIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQscUJBQXFCO1FBQ3JCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQWlCO1FBQzNCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDcEMsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDbEQ7SUFDTCxDQUFDO0lBQUEsQ0FBQzs7QUFsTU4sa0NBbU1DO0FBbE1VLG1CQUFPLEdBQUcsT0FBTyxBQUFWLENBQVciLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBDdXN0b21Db25zb2xlIH0gZnJvbSAnLi9jb25zb2xlJztcblxuZXhwb3J0IGludGVyZmFjZSBTaW1wbGVJbmZvIHtcbiAgICB0aW1lOiBudW1iZXI7XG5cbiAgICAvLyDotYTmupDmlofku7bmiY3kvJrmnInov5nkuKTkuKrmlbDmja5cbiAgICB1dWlkPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1pc3NpbmdBc3NldEluZm8ge1xuICAgIHBhdGg6IHN0cmluZztcbiAgICB0aW1lOiBudW1iZXI7XG4gICAgcmVtb3ZlVGltZTogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlY29yZEluZm9NYXAge1xuICAgIHZlcnNpb246IHN0cmluZztcbiAgICBtYXA6IHsgW3BhdGg6IHN0cmluZ106IFNpbXBsZUluZm8gfTtcbiAgICBtaXNzaW5nOiB7IFtwYXRoOiBzdHJpbmddOiBNaXNzaW5nQXNzZXRJbmZvIH07XG59XG5cbi8qKlxuICog57yT5a2Y5omA5pyJ5paH5Lu255qEIG10aW1lTXMg5pe26Ze077yM55So5LqO5q+U5a+55piv5ZCm5L+u5pS5XG4gKiDov5npg6jliIbmlbDmja7pnIDopoHokL3lnLDliLDmlofku7bns7vnu59cbiAqL1xuZXhwb3J0IGNsYXNzIEluZm9NYW5hZ2VyIHtcbiAgICBzdGF0aWMgdmVyc2lvbiA9ICcxLjAuMCc7XG5cbiAgICAvLyDlm7rljJbmlbDmja7nmoTkv53lrZjot6/lvoRcbiAgICBwcml2YXRlIGZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwcml2YXRlIHJlY29yZEluZm86IFJlY29yZEluZm9NYXAgPSB7XG4gICAgICAgIHZlcnNpb246IEluZm9NYW5hZ2VyLnZlcnNpb24sXG4gICAgICAgIG1hcDoge30sXG4gICAgICAgIG1pc3Npbmc6IHt9LFxuICAgIH07XG4gICAgcHJpdmF0ZSBjb25zb2xlOiBDdXN0b21Db25zb2xlO1xuICAgIGNvbnN0cnVjdG9yKGN1c3RvbUNvbnNvbGU6IEN1c3RvbUNvbnNvbGUpIHtcbiAgICAgICAgdGhpcy5jb25zb2xlID0gY3VzdG9tQ29uc29sZSB8fCBjb25zb2xlO1xuICAgIH1cblxuICAgIC8vIOS/neWtmOS9v+eUqOeahCB0aW1lclxuICAgIF9zYXZlVGltZXI6IG51bGwgfCBOb2RlSlMuVGltZW91dCA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiDorr7nva7orrDlvZXmlbDmja7nmoQganNvbiDmlofku7ZcbiAgICAgKiBAcGFyYW0ganNvbiBcbiAgICAgKi9cbiAgICBzZXRSZWNvcmRKU09OKGpzb246IHN0cmluZykge1xuICAgICAgICB0aGlzLmZpbGUgPSBqc29uLnJlcGxhY2UoJy5qc29uJywgYCR7SW5mb01hbmFnZXIudmVyc2lvbn0uanNvbmApO1xuICAgICAgICAvLyDkvJjlhYjlj5blvZPliY3niYjmnKzlj7fnmoTphY3nva7mlbDmja5cbiAgICAgICAgaWYgKGV4aXN0c1N5bmModGhpcy5maWxlKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWNvcmRJbmZvID0gcmVhZEpTT05TeW5jKHRoaXMuZmlsZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkUmVjb3JkSnNvbihyZWNvcmRJbmZvKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWFvOWuueiOt+WPluaXp+eJiOacrOaVsOaNriwg5ZCM5pe25YaZ5YWl5Yiw5paw55qE5pWw5o2u5paH5Lu25YaFXG4gICAgICAgIGlmIChleGlzdHNTeW5jKGpzb24pKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlY29yZEluZm8gPSByZWFkSlNPTlN5bmMoanNvbik7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkUmVjb3JkSnNvbihyZWNvcmRJbmZvKTtcbiAgICAgICAgICAgICAgICBvdXRwdXRKU09OU3luYyh0aGlzLmZpbGUsIHRoaXMucmVjb3JkSW5mbywgeyBzcGFjZXM6IDIgfSlcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgbG9hZFJlY29yZEpzb24ocmVjb3JkSW5mbzogYW55KSB7XG4gICAgICAgIGlmICghcmVjb3JkSW5mby52ZXJzaW9uKSB7XG4gICAgICAgICAgICAvLyDml6fniYjmnKzmlbDmja7pnIDopoHlgZrkuIDmrKHmlbTnkIbvvIzlsIYgbWlzc2luZyDmlbDmja7mlbTnkIblh7rmnaVcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlY29yZEluZm8pLmZvckVhY2goKHBhdGgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gcmVjb3JkSW5mb1twYXRoXTtcbiAgICAgICAgICAgICAgICBpZiAoaW5mby5taXNzaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBpbmZvLm1pc3Npbmc7XG4gICAgICAgICAgICAgICAgICAgIGluZm8udXVpZCAmJiAodGhpcy5yZWNvcmRJbmZvLm1pc3NpbmdbaW5mby51dWlkXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lOiBpbmZvLnRpbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVUaW1lOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW5mby5taXNzaW5nO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdID0gaW5mbztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWNvcmRJbmZvID0gcmVjb3JkSW5mbztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmUgOavgeS4gOS4queuoeeQhuWZqOWunuS+i1xuICAgICAqIEBwYXJhbSBtYW5hZ2VyIFxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMucmVjb3JkSW5mby5tYXAgPSB7fTtcbiAgICAgICAgdGhpcy5yZWNvcmRJbmZvLm1pc3NpbmcgPSB7fTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOW7tui/n+S/neWtmOS+nei1luaWh+S7tlxuICAgICAqL1xuICAgIHNhdmUoKSB7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciAmJiBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5fc2F2ZVRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNhdmVJbW1lZGlhdGUoKTtcbiAgICAgICAgfSwgNDAwKTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOeri+WNs+S/neWtmOiusOW9leaWh+S7tlxuICAgICAqL1xuICAgIHNhdmVJbW1lZGlhdGUoKSB7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciAmJiBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5maWxlICYmIG91dHB1dEpTT05TeW5jKHRoaXMuZmlsZSwgdGhpcy5yZWNvcmRJbmZvLCB7IHNwYWNlczogMiB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmm7TmlrDkuIDkuKrnvJPlrZjmlbDmja5cbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKiBAcGFyYW0gbXRpbWVNcyBcbiAgICAgKiBAcGFyYW0gdXVpZFxuICAgICAqL1xuICAgIGFkZChwYXRoOiBzdHJpbmcsIG10aW1lTXM6IG51bWJlciwgdXVpZD86IHN0cmluZykge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdXG4gICAgICAgICAgICAmJiB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdLnV1aWQgPT09IHV1aWRcbiAgICAgICAgICAgICYmIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0udGltZSA9PT0gbXRpbWVNc1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1dWlkKSB7XG4gICAgICAgICAgICB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdID0ge1xuICAgICAgICAgICAgICAgIHRpbWU6IG10aW1lTXMsXG4gICAgICAgICAgICAgICAgdXVpZDogdXVpZCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdID0ge1xuICAgICAgICAgICAgICAgIHRpbWU6IG10aW1lTXMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWIoOmZpOe8k+WtmOeahOS4gOS4qiBtdGltZSDmlbDmja5cbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKi9cbiAgICByZW1vdmUocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5yZWNvcmRJbmZvLm1hcFtwYXRoXSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGluZm8gPSB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdO1xuICAgICAgICB0aGlzLmFkZE1pc3NpbmcocGF0aCwgaW5mbyk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF07XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOiOt+WPlue8k+WtmOeahCBzdGF0cyDlr7nosaFcbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKi9cbiAgICBnZXQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlY29yZEluZm8ubWFwW3BhdGhdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5re75Yqg5LiA5Liq5Lii5aSx55qE6LWE5rqQ5L+h5oGvXG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICogQHBhcmFtIGluZm8gXG4gICAgICovXG4gICAgcHJpdmF0ZSBhZGRNaXNzaW5nKHBhdGg6IHN0cmluZywgaW5mbzogU2ltcGxlSW5mbykge1xuICAgICAgICBpbmZvLnV1aWQgJiYgKHRoaXMucmVjb3JkSW5mby5taXNzaW5nW2luZm8udXVpZF0gPSB7XG4gICAgICAgICAgICBwYXRoLFxuICAgICAgICAgICAgdGltZTogaW5mby50aW1lLFxuICAgICAgICAgICAgcmVtb3ZlVGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5qC55o2uIHV1aWQg6I635Y+W5Lii5aSx55qE6LWE5rqQ5L+h5oGvXG4gICAgICogQHBhcmFtIHV1aWQgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgZ2V0TWlzc2luZ0luZm8odXVpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlY29yZEluZm8ubWlzc2luZ1t1dWlkXSB8fCBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWvueavlOeOsOWcqOaWh+S7tuWSjOWGheWtmOmHjOe8k+WtmOeahCBzdGF0cyDmmK/lkKbmnInkv67mlLlcbiAgICAgKiDov5Tlm57mmK/lkKbnm7jnrYlcbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKiBAcGFyYW0gc3RhdHMgXG4gICAgICovXG4gICAgY29tcGFyZShwYXRoOiBzdHJpbmcsIG10aW1lTXM6IG51bWJlcikge1xuICAgICAgICAvLyDlpoLmnpznvJPlrZjkuI3lrZjlnKjvvIzliJnorqTkuLrkv67mlLnkuoZcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5yZWNvcmRJbmZvLm1hcFtwYXRoXTtcbiAgICAgICAgaWYgKCF0YXJnZXQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWmguaenCBtcyDorrDlvZXnm7jnrYnvvIzliJnorqTkuLrmsqHmnInkv67mlLlcbiAgICAgICAgaWYgKHRhcmdldC50aW1lID09PSBtdGltZU1zKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBhc3luYyBmb3JFYWNoKGhhbmRsZXI6IEZ1bmN0aW9uKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGF0aCBpbiB0aGlzLnJlY29yZEluZm8ubWFwKSB7XG4gICAgICAgICAgICBhd2FpdCBoYW5kbGVyKHBhdGgsIHRoaXMucmVjb3JkSW5mby5tYXBbcGF0aF0pO1xuICAgICAgICB9XG4gICAgfTtcbn0iXX0=