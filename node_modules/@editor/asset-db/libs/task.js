'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.TASK_MAP = exports.DestroyTask = exports.ImportTask = exports.Task = void 0;
const fs_extra_1 = require("fs-extra");
const asset_1 = require("./asset");
const utils_1 = require("./utils");
const default_meta_1 = require("./default-meta");
const manager_1 = require("./manager");
const TIMEOUT = 1000 * 60 * 8;
/**
 * 任务基础类型
 */
class Task {
    constructor() {
        // 事件列表
        this.event = {};
    }
    /*
     * 导入流程
     */
    // async exec() { }
    /**
     * 监听事件
     * @param name
     * @param func
     */
    on(name, func) {
        this.event[name] = func;
    }
    /**
     * 触发事件
     * @param name
     * @param args
     */
    emit(name, ...args) {
        if (this.event[name]) {
            this.event[name].call(this, ...args);
        }
    }
}
exports.Task = Task;
/**
 * 导入任务
 */
class ImportTask extends Task {
    /**
     * 实际的导入流程，允许传入实体资源以及虚拟资源
     * @param database
     * @param asset
     * @param importer
     * @param dirty
     */
    async exec(database, asset, importer, dirty) {
        const subAssetMap = new Map;
        for (let name in asset.subAssets) {
            subAssetMap.set(name, asset.subAssets[name]);
        }
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('add', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('change', asset);
            }
        }
        try {
            if (asset instanceof asset_1.Asset) {
                dirty = await this.importAsset(database, asset, importer, dirty);
            }
            else {
                dirty = await this.importVirtualAsset(database, asset, importer, dirty);
            }
        }
        catch (error) {
            console.error(error);
        }
        // 导入子资源
        let subDirty = dirty;
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                const importer = await database.importerManager.find(subAsset);
                if (!importer) {
                    throw new Error(`Unable to import data, no suitable importer was found.\n asset: {asset[${subAsset.source}](${subAsset.uuid})}`);
                }
                // 已导入完成的子资源才可以发 change 消息
                if (subAssetMap.has(name) && asset.action === asset_1.AssetActionEnum.change) {
                    subAsset.action = asset_1.AssetActionEnum.change;
                }
                else {
                    subAsset.action = asset_1.AssetActionEnum.add;
                }
                if (await this.exec(database, subAsset, importer, subDirty)) {
                    dirty = true;
                }
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                dirty = true;
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        // 导入子资源后的钩子函数
        try {
            importer.afterSubAssetsImport && (await importer.afterSubAssetsImport(asset));
        }
        catch (error) {
            console.error(`Exec afterSubAssetsImport hook failed: {asset[${asset.source}](${asset.uuid})}`);
            console.error(error);
        }
        subAssetMap.forEach((subAsset, name) => {
            if (!asset.subAssets[name]) {
                database.emit('delete', subAsset);
                database.emit('deleted', subAsset);
            }
        });
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('added', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('changed', asset);
            }
        }
        asset.action = asset_1.AssetActionEnum.none;
        return dirty;
    }
    /**
     * 导入实体资源的流程
     */
    async importAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || (importer.versionCode !== asset.versionCode && asset.invalid !== true)
            || (importer.version !== asset.meta.ver && asset.invalid !== true)
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            if (asset.meta.importer !== importer.name) {
                asset.meta.ver = '0.0.0';
            }
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // meta 版本号大于导入器版本号的时候，如果 init 已经成功，则跳过导入流程
                if (asset.init) {
                    return false;
                }
                // 允许强制重新导入，但会报警告
                // asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 资源本体即将开始导入，更新标记数据
            await asset.reset();
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    return dirty;
                }
            }
            if (database.options.level >= 4) {
                console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                asset.versionCode = importer.versionCode;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    // 超时控制
                    const timer = setTimeout(() => {
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
        }
        return dirty;
    }
    /**
     * 导入虚拟资源的流程
     * @param database
     * @param asset
     * @param dirty 是否被修改
     */
    async importVirtualAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || importer.version !== asset.meta.ver
            || importer.versionCode !== asset.versionCode
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // if (asset.init) {
                //     return false;
                // }
                asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 虚拟资源只能发送导入和删除
            // database.emit('add', asset.uuid, asset);
            // 虚拟资源 / 子资源不需要也无法判断是否更改
            // 资源本体即将开始导入，更新标记数据
            asset.imported = false;
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    // database.emit('added', asset.uuid, asset);
                    // database.eventManager.add(asset);
                    return false;
                }
            }
            if (database.options.level >= 4) {
                if (asset.action === asset_1.AssetActionEnum.add) {
                    console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
                else {
                    console.debug(`%cReImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                asset.versionCode = importer.versionCode;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    async function onTimer() {
                        // 如果资源在导入过程中被标记为能被唤醒，则重新计时
                        if (importer.checkAwake && (await importer.checkAwake(asset)) === true) {
                            clearTimeout(timer);
                            timer = setTimeout(onTimer, TIMEOUT);
                            return;
                        }
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }
                    // 超时控制
                    let timer = setTimeout(onTimer, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
                database.dataManager.update(asset);
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
            // 重新导入受影响的资源
            (0, manager_1.importAssociatedAssets)(database, asset);
            // database.emit('added', asset.uuid, asset);
            // database.eventManager.add(asset);
        }
        return dirty;
    }
    /**
     * 迁移资源
     * @param importer
     * @param database
     * @param asset
     */
    async migrateAsset(importer, database, asset) {
        let catchError = null;
        if (importer.migrationHook && importer.migrationHook.pre) {
            await importer.migrationHook.pre(asset);
        }
        let num = 0;
        let i = 0;
        for (i; i < importer.migrations.length; i++) {
            const task = importer.migrations[i];
            const index = (0, utils_1.compareVersion)(asset.meta.ver, task.version);
            if (index < 0) {
                try {
                    if (database.options.level >= 4) {
                        console.debug(`%cMigrate%c: ${asset.source}(${task.version})`, 'background: #fbe5b5; color: #000;', 'color: #000;');
                    }
                    task.migrate && await task.migrate(asset);
                    num++;
                    asset.meta.ver = task.version;
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(`Migrate error:  {asset[${asset.source}](${asset.uuid})} - ${task.version}`);
                    }
                    catchError = error;
                    break;
                }
            }
        }
        if (importer.migrationHook && importer.migrationHook.post) {
            await importer.migrationHook.post(asset, num);
        }
        if (catchError) {
            throw catchError;
        }
    }
}
exports.ImportTask = ImportTask;
class DestroyTask extends Task {
    /**
     * 销毁一个资源
     * @param database
     * @param asset
     */
    async exec(database, asset) {
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('delete', asset);
        }
        // 销毁子资源
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                subAsset.action = asset_1.AssetActionEnum.delete;
                await this.exec(database, subAsset);
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Destroy exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        let result = undefined;
        try {
            result = await this.destroyAsset(database, asset);
        }
        catch (error) {
            console.error(error);
        }
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('deleted', asset);
        }
        return result;
    }
    async destroyAsset(database, asset) {
        if (database.options.level >= 4) {
            console.debug(`%cDestroy%c: ${asset.source}`, 'background: #ffb8b8; color: #000;', 'color: #000;');
        }
        // if (!(asset instanceof Asset)) {
        //     // 虚拟资源只能发送导入和删除
        //     database.emit('delete', asset.uuid, asset);
        // }
        await asset.reset();
        // 文件夹为空需要另同步检查
        // 异步接口会造成检查为空后中间又被插入新的文件
        const libraryDir = asset.library;
        if ((0, fs_extra_1.existsSync)(libraryDir)) {
            let files = (0, fs_extra_1.readdirSync)(libraryDir);
            if (files.length === 0) {
                (0, fs_extra_1.removeSync)(libraryDir);
            }
        }
    }
}
exports.DestroyTask = DestroyTask;
/**
 * 任务缓存
 */
exports.TASK_MAP = {
    import: new ImportTask(),
    destroy: new DestroyTask(),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL3Rhc2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFJYix1Q0FBK0Q7QUFDL0QsbUNBQStEO0FBRS9ELG1DQUF5QztBQUV6QyxpREFBOEM7QUFDOUMsdUNBQW1EO0FBRW5ELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRTlCOztHQUVHO0FBQ0gsTUFBYSxJQUFJO0lBQWpCO1FBRUksT0FBTztRQUNDLFVBQUssR0FBNkIsRUFBRSxDQUFDO0lBMEJqRCxDQUFDO0lBeEJHOztPQUVHO0lBQ0gsbUJBQW1CO0lBRW5COzs7O09BSUc7SUFDSCxFQUFFLENBQUMsSUFBWSxFQUFFLElBQWM7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxJQUFJLENBQUMsSUFBWSxFQUFFLEdBQUcsSUFBVztRQUM3QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDeEM7SUFDTCxDQUFDO0NBQ0o7QUE3QkQsb0JBNkJDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFVBQVcsU0FBUSxJQUFJO0lBRWhDOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBaUIsRUFBRSxLQUEyQixFQUFFLFFBQWtCLEVBQUUsS0FBYztRQUV6RixNQUFNLFdBQVcsR0FBOEIsSUFBSSxHQUFHLENBQUM7UUFDdkQsS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQzlCLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUss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QyxDQUFDO2FBQzFCO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7QUFoRUQsa0NBZ0VDO0FBRUQ7O0dBRUc7QUFDVSxRQUFBLFFBQVEsR0FBRztJQUNwQixNQUFNLEVBQUUsSUFBSSxVQUFVLEVBQUU7SUFDeEIsT0FBTyxFQUFFLElBQUksV0FBVyxFQUFFO0NBQzdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB0eXBlIHsgQXNzZXREQiB9IGZyb20gJy4vYXNzZXQtZGInO1xuXG5pbXBvcnQgeyBleGlzdHNTeW5jLCByZWFkZGlyU3luYywgcmVtb3ZlU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IEFzc2V0QWN0aW9uRW51bSwgQXNzZXQsIFZpcnR1YWxBc3NldCB9IGZyb20gJy4vYXNzZXQnO1xuaW1wb3J0IHsgSW1wb3J0ZXIgfSBmcm9tICcuL2ltcG9ydGVyJztcbmltcG9ydCB7IGNvbXBhcmVWZXJzaW9uIH0gZnJvbSAnLi91dGlscyc7XG5cbmltcG9ydCB7IGZpbGxVc2VyRGF0YSB9IGZyb20gJy4vZGVmYXVsdC1tZXRhJztcbmltcG9ydCB7IGltcG9ydEFzc29jaWF0ZWRBc3NldHMgfSBmcm9tICcuL21hbmFnZXInO1xuXG5jb25zdCBUSU1FT1VUID0gMTAwMCAqIDYwICogODtcblxuLyoqXG4gKiDku7vliqHln7rnoYDnsbvlnotcbiAqL1xuZXhwb3J0IGNsYXNzIFRhc2sge1xuXG4gICAgLy8g5LqL5Lu25YiX6KGoXG4gICAgcHJpdmF0ZSBldmVudDogeyBbaW5kZXg6IHN0cmluZ106IGFueSB9ID0ge307XG5cbiAgICAvKlxuICAgICAqIOWvvOWFpea1geeoi1xuICAgICAqL1xuICAgIC8vIGFzeW5jIGV4ZWMoKSB7IH1cblxuICAgIC8qKlxuICAgICAqIOebkeWQrOS6i+S7tlxuICAgICAqIEBwYXJhbSBuYW1lIFxuICAgICAqIEBwYXJhbSBmdW5jIFxuICAgICAqL1xuICAgIG9uKG5hbWU6IHN0cmluZywgZnVuYzogRnVuY3Rpb24pIHtcbiAgICAgICAgdGhpcy5ldmVudFtuYW1lXSA9IGZ1bmM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6Kem5Y+R5LqL5Lu2XG4gICAgICogQHBhcmFtIG5hbWUgXG4gICAgICogQHBhcmFtIGFyZ3MgXG4gICAgICovXG4gICAgZW1pdChuYW1lOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgIGlmICh0aGlzLmV2ZW50W25hbWVdKSB7XG4gICAgICAgICAgICB0aGlzLmV2ZW50W25hbWVdLmNhbGwodGhpcywgLi4uYXJncyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICog5a+85YWl5Lu75YqhXG4gKi9cbmV4cG9ydCBjbGFzcyBJbXBvcnRUYXNrIGV4dGVuZHMgVGFzayB7XG5cbiAgICAvKipcbiAgICAgKiDlrp7pmYXnmoTlr7zlhaXmtYHnqIvvvIzlhYHorrjkvKDlhaXlrp7kvZPotYTmupDku6Xlj4romZrmi5/otYTmupBcbiAgICAgKiBAcGFyYW0gZGF0YWJhc2UgXG4gICAgICogQHBhcmFtIGFzc2V0IFxuICAgICAqIEBwYXJhbSBpbXBvcnRlciBcbiAgICAgKiBAcGFyYW0gZGlydHkgXG4gICAgICovXG4gICAgYXN5bmMgZXhlYyhkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0LCBpbXBvcnRlcjogSW1wb3J0ZXIsIGRpcnR5OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XG5cbiAgICAgICAgY29uc3Qgc3ViQXNzZXRNYXA6IE1hcDxzdHJpbmcsIFZpcnR1YWxBc3NldD4gPSBuZXcgTWFwO1xuICAgICAgICBmb3IgKGxldCBuYW1lIGluIGFzc2V0LnN1YkFzc2V0cykge1xuICAgICAgICAgICAgc3ViQXNzZXRNYXAuc2V0KG5hbWUsIGFzc2V0LnN1YkFzc2V0c1tuYW1lXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGlydHkpIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5hZGQpIHtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdhZGQnLCBhc3NldCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFzc2V0LmFjdGlvbiA9PT0gQXNzZXRBY3Rpb25FbnVtLmNoYW5nZSkge1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2NoYW5nZScsIGFzc2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoYXNzZXQgaW5zdGFuY2VvZiBBc3NldCkge1xuICAgICAgICAgICAgICAgIGRpcnR5ID0gYXdhaXQgdGhpcy5pbXBvcnRBc3NldChkYXRhYmFzZSwgYXNzZXQsIGltcG9ydGVyLCBkaXJ0eSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRpcnR5ID0gYXdhaXQgdGhpcy5pbXBvcnRWaXJ0dWFsQXNzZXQoZGF0YWJhc2UsIGFzc2V0LCBpbXBvcnRlciwgZGlydHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlr7zlhaXlrZDotYTmupBcbiAgICAgICAgbGV0IHN1YkRpcnR5ID0gZGlydHk7XG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gYXNzZXQuc3ViQXNzZXRzKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJBc3NldCA9IGFzc2V0LnN1YkFzc2V0c1tuYW1lXTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW1wb3J0ZXIgPSBhd2FpdCBkYXRhYmFzZS5pbXBvcnRlck1hbmFnZXIuZmluZChzdWJBc3NldCk7XG4gICAgICAgICAgICAgICAgaWYgKCFpbXBvcnRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBpbXBvcnQgZGF0YSwgbm8gc3VpdGFibGUgaW1wb3J0ZXIgd2FzIGZvdW5kLlxcbiBhc3NldDoge2Fzc2V0WyR7c3ViQXNzZXQuc291cmNlfV0oJHtzdWJBc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIOW3suWvvOWFpeWujOaIkOeahOWtkOi1hOa6kOaJjeWPr+S7peWPkSBjaGFuZ2Ug5raI5oGvXG4gICAgICAgICAgICAgICAgaWYgKHN1YkFzc2V0TWFwLmhhcyhuYW1lKSAmJiBhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5jaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViQXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmNoYW5nZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uYWRkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYXdhaXQgdGhpcy5leGVjKGRhdGFiYXNlLCBzdWJBc3NldCwgaW1wb3J0ZXIsIHN1YkRpcnR5KSkge1xuICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN1YkFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBJbXBvcnRlciBleGVjIGZhaWxlZDoge2Fzc2V0WyR7c3ViQXNzZXQuc291cmNlfV0oJHtzdWJBc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWvvOWFpeWtkOi1hOa6kOWQjueahOmSqeWtkOWHveaVsFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaW1wb3J0ZXIuYWZ0ZXJTdWJBc3NldHNJbXBvcnQgJiYgKGF3YWl0IGltcG9ydGVyLmFmdGVyU3ViQXNzZXRzSW1wb3J0KGFzc2V0KSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFeGVjIGFmdGVyU3ViQXNzZXRzSW1wb3J0IGhvb2sgZmFpbGVkOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX1gKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgc3ViQXNzZXRNYXAuZm9yRWFjaCgoc3ViQXNzZXQsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICghYXNzZXQuc3ViQXNzZXRzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnZGVsZXRlJywgc3ViQXNzZXQpO1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2RlbGV0ZWQnLCBzdWJBc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChkaXJ0eSkge1xuICAgICAgICAgICAgaWYgKGFzc2V0LmFjdGlvbiA9PT0gQXNzZXRBY3Rpb25FbnVtLmFkZCkge1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2FkZGVkJywgYXNzZXQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5jaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdjaGFuZ2VkJywgYXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLm5vbmU7XG5cbiAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWvvOWFpeWunuS9k+i1hOa6kOeahOa1geeoi1xuICAgICAqL1xuICAgIGFzeW5jIGltcG9ydEFzc2V0KGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQsIGltcG9ydGVyOiBJbXBvcnRlciwgZGlydHk6IGJvb2xlYW4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgLy8g5aaC5p6c6LWE5rqQ5a+85YWl6L+H77yM5LiU5paH5Lu25rKh5pyJ5L+u5pS577yM5YiZ6Lez6L+H5a+85YWl5rWB56iLXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIGRpcnR5XG4gICAgICAgICAgICB8fCAoaW1wb3J0ZXIudmVyc2lvbkNvZGUgIT09IGFzc2V0LnZlcnNpb25Db2RlICYmIGFzc2V0LmludmFsaWQgIT09IHRydWUpXG4gICAgICAgICAgICB8fCAoaW1wb3J0ZXIudmVyc2lvbiAhPT0gYXNzZXQubWV0YS52ZXIgJiYgYXNzZXQuaW52YWxpZCAhPT0gdHJ1ZSlcbiAgICAgICAgICAgIHx8IChhc3NldC5tZXRhLmltcG9ydGVkID09PSBmYWxzZSAmJiBhc3NldC5pbnZhbGlkICE9PSB0cnVlKVxuICAgICAgICAgICAgfHwgYXdhaXQgaW1wb3J0ZXIuZm9yY2UoYXNzZXQpXG4gICAgICAgICAgICAvLyBkaXJ0eSDmoIforrDotbDov4cgY2hlY2tEaXJ0eSDmlrnms5XvvIzlhbblrp7mo4Dmn6Xov4dcbiAgICAgICAgICAgIC8vIOS9huS7luS7rOaYr+W8guatpeeahO+8jOWPr+iDveS8muS4gOenjeaDheWGte+8jOajgOafpeeahOaXtuWAmei/mOWcqO+8jOi/memHjOaJp+ihjOeahOaXtuWAmeWwseS4jeingeS6hlxuICAgICAgICAgICAgLy8g6L+Z56eN5oOF5Ya15Y+v5Lul5pqC5pe25b+955Wl5aSE55CG77yM6L+Z6YeM6L+Y5rKh5pyJ6L+b6KGM5aSE55CG77yM5ZCO57ut5LiL6Z2i5Yeg6KGM5Y+v5Lul5rOo6YeK5o6JXG4gICAgICAgICAgICB8fCBhc3NldC5tZXRhLmZpbGVzLnNvbWUoKGV4dDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICFhc3NldC5leGlzdHNJbkxpYnJhcnkoZXh0KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICkge1xuICAgICAgICAgICAgaWYgKGFzc2V0Lm1ldGEuaW1wb3J0ZXIgIT09IGltcG9ydGVyLm5hbWUpIHtcbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnZlciA9ICcwLjAuMCc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25Db250cmFzdCA9IGNvbXBhcmVWZXJzaW9uKGFzc2V0Lm1ldGEudmVyLCBpbXBvcnRlci52ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmICh2ZXJzaW9uQ29udHJhc3QgPT09IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBtZXRhIOeJiOacrOWPt+Wkp+S6juWvvOWFpeWZqOeJiOacrOWPt+eahOaXtuWAme+8jOWmguaenCBpbml0IOW3sue7j+aIkOWKn++8jOWImei3s+i/h+WvvOWFpea1geeoi1xuICAgICAgICAgICAgICAgIGlmIChhc3NldC5pbml0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8g5YWB6K645by65Yi26YeN5paw5a+85YWl77yM5L2G5Lya5oql6K2m5ZGKXG4gICAgICAgICAgICAgICAgLy8gYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBJbXBvcnRlciBleGVjIHdhcm5pbmc6IHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfTogVGhlIGltcG9ydGVyIHZlcnNpb24gaXMgbG93ZXIgdGhhbiBhc3NldGApO1xuICAgICAgICAgICAgICAgIC8vIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuXG4gICAgICAgICAgICAvLyDotYTmupDmnKzkvZPljbPlsIblvIDlp4vlr7zlhaXvvIzmm7TmlrDmoIforrDmlbDmja5cbiAgICAgICAgICAgIGF3YWl0IGFzc2V0LnJlc2V0KCk7XG5cbiAgICAgICAgICAgIC8vIOi/mOaYr+S9v+eUqOS5i+WJjeeahOWvvOWFpeWZqO+8jOWwneivlei/geenu1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGltcG9ydGVyLm5hbWUgPT09IGFzc2V0Lm1ldGEuaW1wb3J0ZXJcbiAgICAgICAgICAgICAgICAmJiBhc3NldC5tZXRhLnZlciAhPT0gJzAuMC4wJ1xuICAgICAgICAgICAgICAgICYmIHZlcnNpb25Db250cmFzdCA9PT0gLTFcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMubWlncmF0ZUFzc2V0KGltcG9ydGVyLCBkYXRhYmFzZSwgYXNzZXQpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmltcG9ydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlydHk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSA0KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWNJbXBvcnQlYzogJHthc3NldC5zb3VyY2V9YCwgJ2JhY2tncm91bmQ6ICNhYWZmODU7IGNvbG9yOiAjMDAwOycsICdjb2xvcjogIzAwMDsnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g5a6e6ZmF5a+85YWl5rWB56iLXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIGlmICh2ZXJzaW9uQ29udHJhc3QgIT09IDEpIHtcbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnZlciA9IGltcG9ydGVyLnZlcnNpb247XG4gICAgICAgICAgICAgICAgYXNzZXQudmVyc2lvbkNvZGUgPSBpbXBvcnRlci52ZXJzaW9uQ29kZTtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgLy8g6LWE5rqQ5LuO5pyq5L2/55So5b2T5YmN5a+85YWl5Zmo5a+85YWl6L+HXG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS51c2VyRGF0YSA9IGFzc2V0Lm1ldGEudXNlckRhdGEgfHwge307XG4gICAgICAgICAgICAgICAgZmlsbFVzZXJEYXRhKGltcG9ydGVyLm5hbWUsIGFzc2V0Lm1ldGEudXNlckRhdGEpO1xuXG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS5pbXBvcnRlciA9IGltcG9ydGVyLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi2heaXtuaOp+WItlxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXQuX2Fzc2V0REIuZW1pdCgndW5yZXNwb25zaXZlJywgYXNzZXQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9LCBUSU1FT1VUKTtcblxuICAgICAgICAgICAgICAgICAgICBpbXBvcnRlci5pbXBvcnQoYXNzZXQpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyDlr7zlhaXmtYHnqIvpnIDopoHnoa7kv53ph4zpnaLnmoTmlofku7blrZjlgqjmraPluLjmiafooYxcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi1hOa6kOacrOS9k+WvvOWFpeWujOaIkO+8jOabtOaWsOagh+iusOaVsOaNrlxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEltcG9ydGVyIGV4ZWMgZmFpbGVkOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX1gKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWvvOWFpeiZmuaLn+i1hOa6kOeahOa1geeoi1xuICAgICAqIEBwYXJhbSBkYXRhYmFzZSBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICogQHBhcmFtIGRpcnR5IOaYr+WQpuiiq+S/ruaUuVxuICAgICAqL1xuICAgIGFzeW5jIGltcG9ydFZpcnR1YWxBc3NldChkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IFZpcnR1YWxBc3NldCwgaW1wb3J0ZXI6IEltcG9ydGVyLCBkaXJ0eTogYm9vbGVhbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICAvLyDlpoLmnpzotYTmupDlr7zlhaXov4fvvIzkuJTmlofku7bmsqHmnInkv67mlLnvvIzliJnot7Pov4flr7zlhaXmtYHnqItcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgZGlydHlcbiAgICAgICAgICAgIHx8IGltcG9ydGVyLnZlcnNpb24gIT09IGFzc2V0Lm1ldGEudmVyXG4gICAgICAgICAgICB8fCBpbXBvcnRlci52ZXJzaW9uQ29kZSAhPT0gYXNzZXQudmVyc2lvbkNvZGVcbiAgICAgICAgICAgIHx8IChhc3NldC5tZXRhLmltcG9ydGVkID09PSBmYWxzZSAmJiBhc3NldC5pbnZhbGlkICE9PSB0cnVlKVxuICAgICAgICAgICAgfHwgYXdhaXQgaW1wb3J0ZXIuZm9yY2UoYXNzZXQpXG4gICAgICAgICAgICAvLyBkaXJ0eSDmoIforrDotbDov4cgY2hlY2tEaXJ0eSDmlrnms5XvvIzlhbblrp7mo4Dmn6Xov4dcbiAgICAgICAgICAgIC8vIOS9huS7luS7rOaYr+W8guatpeeahO+8jOWPr+iDveS8muS4gOenjeaDheWGte+8jOajgOafpeeahOaXtuWAmei/mOWcqO+8jOi/memHjOaJp+ihjOeahOaXtuWAmeWwseS4jeingeS6hlxuICAgICAgICAgICAgLy8g6L+Z56eN5oOF5Ya15Y+v5Lul5pqC5pe25b+955Wl5aSE55CG77yM6L+Z6YeM6L+Y5rKh5pyJ6L+b6KGM5aSE55CG77yM5ZCO57ut5LiL6Z2i5Yeg6KGM5Y+v5Lul5rOo6YeK5o6JXG4gICAgICAgICAgICB8fCBhc3NldC5tZXRhLmZpbGVzLnNvbWUoKGV4dDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICFhc3NldC5leGlzdHNJbkxpYnJhcnkoZXh0KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgdmVyc2lvbkNvbnRyYXN0ID0gY29tcGFyZVZlcnNpb24oYXNzZXQubWV0YS52ZXIsIGltcG9ydGVyLnZlcnNpb24pO1xuICAgICAgICAgICAgaWYgKHZlcnNpb25Db250cmFzdCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIC8vIGlmIChhc3NldC5pbml0KSB7XG4gICAgICAgICAgICAgICAgLy8gICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBJbXBvcnRlciBleGVjIHdhcm5pbmc6IHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfTogVGhlIGltcG9ydGVyIHZlcnNpb24gaXMgbG93ZXIgdGhhbiBhc3NldGApO1xuICAgICAgICAgICAgICAgIC8vIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuXG4gICAgICAgICAgICAvLyDomZrmi5/otYTmupDlj6rog73lj5HpgIHlr7zlhaXlkozliKDpmaRcbiAgICAgICAgICAgIC8vIGRhdGFiYXNlLmVtaXQoJ2FkZCcsIGFzc2V0LnV1aWQsIGFzc2V0KTtcblxuICAgICAgICAgICAgLy8g6Jma5ouf6LWE5rqQIC8g5a2Q6LWE5rqQ5LiN6ZyA6KaB5Lmf5peg5rOV5Yik5pat5piv5ZCm5pu05pS5XG4gICAgICAgICAgICAvLyDotYTmupDmnKzkvZPljbPlsIblvIDlp4vlr7zlhaXvvIzmm7TmlrDmoIforrDmlbDmja5cbiAgICAgICAgICAgIGFzc2V0LmltcG9ydGVkID0gZmFsc2U7XG5cbiAgICAgICAgICAgIC8vIOi/mOaYr+S9v+eUqOS5i+WJjeeahOWvvOWFpeWZqO+8jOWwneivlei/geenu1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGltcG9ydGVyLm5hbWUgPT09IGFzc2V0Lm1ldGEuaW1wb3J0ZXJcbiAgICAgICAgICAgICAgICAmJiBhc3NldC5tZXRhLnZlciAhPT0gJzAuMC4wJ1xuICAgICAgICAgICAgICAgICYmIHZlcnNpb25Db250cmFzdCA9PT0gLTFcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMubWlncmF0ZUFzc2V0KGltcG9ydGVyLCBkYXRhYmFzZSwgYXNzZXQpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmltcG9ydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAvLyBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gZGF0YWJhc2UuZXZlbnRNYW5hZ2VyLmFkZChhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDQpIHtcbiAgICAgICAgICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uYWRkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjSW1wb3J0JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjYWFmZjg1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWNSZUltcG9ydCVjOiAke2Fzc2V0LnNvdXJjZX1gLCAnYmFja2dyb3VuZDogI2FhZmY4NTsgY29sb3I6ICMwMDA7JywgJ2NvbG9yOiAjMDAwOycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g5a6e6ZmF5a+85YWl5rWB56iLXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIGlmICh2ZXJzaW9uQ29udHJhc3QgIT09IDEpIHtcbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnZlciA9IGltcG9ydGVyLnZlcnNpb247XG4gICAgICAgICAgICAgICAgYXNzZXQudmVyc2lvbkNvZGUgPSBpbXBvcnRlci52ZXJzaW9uQ29kZTtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgLy8g6LWE5rqQ5LuO5pyq5L2/55So5b2T5YmN5a+85YWl5Zmo5a+85YWl6L+HXG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS51c2VyRGF0YSA9IGFzc2V0Lm1ldGEudXNlckRhdGEgfHwge307XG4gICAgICAgICAgICAgICAgZmlsbFVzZXJEYXRhKGltcG9ydGVyLm5hbWUsIGFzc2V0Lm1ldGEudXNlckRhdGEpO1xuXG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS5pbXBvcnRlciA9IGltcG9ydGVyLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFzeW5jIGZ1bmN0aW9uIG9uVGltZXIoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDlpoLmnpzotYTmupDlnKjlr7zlhaXov4fnqIvkuK3ooqvmoIforrDkuLrog73ooqvllKTphpLvvIzliJnph43mlrDorqHml7ZcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbXBvcnRlci5jaGVja0F3YWtlICYmIChhd2FpdCBpbXBvcnRlci5jaGVja0F3YWtlKGFzc2V0KSkgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChvblRpbWVyLCBUSU1FT1VUKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NldC5fYXNzZXREQi5lbWl0KCd1bnJlc3BvbnNpdmUnLCBhc3NldCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8g6LaF5pe25o6n5Yi2XG4gICAgICAgICAgICAgICAgICAgIGxldCB0aW1lciA9IHNldFRpbWVvdXQob25UaW1lciwgVElNRU9VVCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0ZXIuaW1wb3J0KGFzc2V0KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8g5a+85YWl5rWB56iL6ZyA6KaB56Gu5L+d6YeM6Z2i55qE5paH5Lu25a2Y5YKo5q2j5bi45omn6KGMXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAvLyDotYTmupDmnKzkvZPlr7zlhaXlrozmiJDvvIzmm7TmlrDmoIforrDmlbDmja5cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmRhdGFNYW5hZ2VyLnVwZGF0ZShhc3NldCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSW1wb3J0ZXIgZXhlYyBmYWlsZWQ6IHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOmHjeaWsOWvvOWFpeWPl+W9seWTjeeahOi1hOa6kFxuICAgICAgICAgICAgaW1wb3J0QXNzb2NpYXRlZEFzc2V0cyhkYXRhYmFzZSwgYXNzZXQpO1xuXG4gICAgICAgICAgICAvLyBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgIC8vIGRhdGFiYXNlLmV2ZW50TWFuYWdlci5hZGQoYXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOi/geenu+i1hOa6kFxuICAgICAqIEBwYXJhbSBpbXBvcnRlciBcbiAgICAgKiBAcGFyYW0gZGF0YWJhc2UgXG4gICAgICogQHBhcmFtIGFzc2V0IFxuICAgICAqL1xuICAgIGFzeW5jIG1pZ3JhdGVBc3NldChpbXBvcnRlcjogSW1wb3J0ZXIsIGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpIHtcbiAgICAgICAgbGV0IGNhdGNoRXJyb3I6IEVycm9yIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgaWYgKGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sgJiYgaW1wb3J0ZXIubWlncmF0aW9uSG9vay5wcmUpIHtcbiAgICAgICAgICAgIGF3YWl0IGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sucHJlKGFzc2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBudW0gPSAwO1xuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGZvciAoaTsgaSA8IGltcG9ydGVyLm1pZ3JhdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBpbXBvcnRlci5taWdyYXRpb25zW2ldO1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBjb21wYXJlVmVyc2lvbihhc3NldC5tZXRhLnZlciwgdGFzay52ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSA0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGAlY01pZ3JhdGUlYzogJHthc3NldC5zb3VyY2V9KCR7dGFzay52ZXJzaW9ufSlgLCAnYmFja2dyb3VuZDogI2ZiZTViNTsgY29sb3I6ICMwMDA7JywgJ2NvbG9yOiAjMDAwOycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRhc2subWlncmF0ZSAmJiBhd2FpdCB0YXNrLm1pZ3JhdGUoYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBudW0rKztcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQubWV0YS52ZXIgPSB0YXNrLnZlcnNpb247XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgTWlncmF0ZSBlcnJvcjogIHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfSAtICR7dGFzay52ZXJzaW9ufWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IgPSBlcnJvciBhcyBFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaW1wb3J0ZXIubWlncmF0aW9uSG9vayAmJiBpbXBvcnRlci5taWdyYXRpb25Ib29rLnBvc3QpIHtcbiAgICAgICAgICAgIGF3YWl0IGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sucG9zdChhc3NldCwgbnVtKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjYXRjaEVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBjYXRjaEVycm9yO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGVzdHJveVRhc2sgZXh0ZW5kcyBUYXNrIHtcblxuICAgIC8qKlxuICAgICAqIOmUgOavgeS4gOS4qui1hOa6kFxuICAgICAqIEBwYXJhbSBkYXRhYmFzZSBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgYXN5bmMgZXhlYyhkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0KSB7XG5cbiAgICAgICAgaWYgKGFzc2V0LmFjdGlvbiA9PT0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZSkge1xuICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnZGVsZXRlJywgYXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6ZSA5q+B5a2Q6LWE5rqQXG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gYXNzZXQuc3ViQXNzZXRzKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJBc3NldCA9IGFzc2V0LnN1YkFzc2V0c1tuYW1lXTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgc3ViQXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWMoZGF0YWJhc2UsIHN1YkFzc2V0KTtcbiAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0ubm9uZTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBEZXN0cm95IGV4ZWMgZmFpbGVkOiB7YXNzZXRbJHtzdWJBc3NldC5zb3VyY2V9XSgke3N1YkFzc2V0LnV1aWR9KX1gKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlc3VsdDogYW55ID0gdW5kZWZpbmVkO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgdGhpcy5kZXN0cm95QXNzZXQoZGF0YWJhc2UsIGFzc2V0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFzc2V0LmFjdGlvbiA9PT0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZSkge1xuICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnZGVsZXRlZCcsIGFzc2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgYXN5bmMgZGVzdHJveUFzc2V0KGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpIHtcbiAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gNCkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWNEZXN0cm95JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjZmZiOGI4OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpZiAoIShhc3NldCBpbnN0YW5jZW9mIEFzc2V0KSkge1xuICAgICAgICAvLyAgICAgLy8g6Jma5ouf6LWE5rqQ5Y+q6IO95Y+R6YCB5a+85YWl5ZKM5Yig6ZmkXG4gICAgICAgIC8vICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGUnLCBhc3NldC51dWlkLCBhc3NldCk7XG4gICAgICAgIC8vIH1cblxuICAgICAgICBhd2FpdCBhc3NldC5yZXNldCgpO1xuXG4gICAgICAgIC8vIOaWh+S7tuWkueS4uuepuumcgOimgeWPpuWQjOatpeajgOafpVxuICAgICAgICAvLyDlvILmraXmjqXlj6PkvJrpgKDmiJDmo4Dmn6XkuLrnqbrlkI7kuK3pl7Tlj4jooqvmj5LlhaXmlrDnmoTmlofku7ZcbiAgICAgICAgY29uc3QgbGlicmFyeURpciA9IGFzc2V0LmxpYnJhcnk7XG4gICAgICAgIGlmIChleGlzdHNTeW5jKGxpYnJhcnlEaXIpKSB7XG4gICAgICAgICAgICBsZXQgZmlsZXMgPSByZWFkZGlyU3luYyhsaWJyYXJ5RGlyKTtcbiAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZW1vdmVTeW5jKGxpYnJhcnlEaXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOS7u+WKoee8k+WtmFxuICovXG5leHBvcnQgY29uc3QgVEFTS19NQVAgPSB7XG4gICAgaW1wb3J0OiBuZXcgSW1wb3J0VGFzaygpLFxuICAgIGRlc3Ryb3k6IG5ldyBEZXN0cm95VGFzaygpLFxufTtcbiJdfQ==