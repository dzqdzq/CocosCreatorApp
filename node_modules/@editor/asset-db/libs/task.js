'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.TASK_MAP = exports.DestroyTask = exports.ImportTask = exports.Task = void 0;
const fs_extra_1 = require("fs-extra");
const asset_1 = require("./asset");
const utils_1 = require("./utils");
const default_meta_1 = require("./default-meta");
const manager_1 = require("./manager");
const TIMEOUT = 1000 * 60 * 8;
/**
 * 任务基础类型
 */
class Task {
    constructor() {
        // 事件列表
        this.event = {};
    }
    /*
     * 导入流程
     */
    // async exec() { }
    /**
     * 监听事件
     * @param name
     * @param func
     */
    on(name, func) {
        this.event[name] = func;
    }
    /**
     * 触发事件
     * @param name
     * @param args
     */
    emit(name, ...args) {
        if (this.event[name]) {
            this.event[name].call(this, ...args);
        }
    }
}
exports.Task = Task;
/**
 * 导入任务
 */
class ImportTask extends Task {
    /**
     * 实际的导入流程，允许传入实体资源以及虚拟资源
     * @param database
     * @param asset
     * @param importer
     * @param dirty
     */
    async exec(database, asset, importer, dirty) {
        const subAssetMap = new Map;
        for (let name in asset.subAssets) {
            subAssetMap.set(name, asset.subAssets[name]);
        }
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('add', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('change', asset);
            }
        }
        try {
            if (asset instanceof asset_1.Asset) {
                dirty = await this.importAsset(database, asset, importer, dirty);
            }
            else {
                dirty = await this.importVirtualAsset(database, asset, importer, dirty);
            }
        }
        catch (error) {
            console.error(error);
        }
        // 导入子资源
        let subDirty = dirty;
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                const importer = await database.importerManager.find(subAsset);
                if (!importer) {
                    throw new Error(`Unable to import data, no suitable importer was found.\n asset: {asset[${subAsset.source}](${subAsset.uuid})}`);
                }
                // 已导入完成的子资源才可以发 change 消息
                if (subAssetMap.has(name) && asset.action === asset_1.AssetActionEnum.change) {
                    subAsset.action = asset_1.AssetActionEnum.change;
                }
                else {
                    subAsset.action = asset_1.AssetActionEnum.add;
                }
                if (await this.exec(database, subAsset, importer, subDirty)) {
                    dirty = true;
                }
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                dirty = true;
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        // 导入子资源后的钩子函数
        try {
            importer.afterSubAssetsImport && (await importer.afterSubAssetsImport(asset));
        }
        catch (error) {
            console.error(`Exec afterSubAssetsImport hook failed: {asset[${asset.source}](${asset.uuid})}`);
            console.error(error);
        }
        subAssetMap.forEach((subAsset, name) => {
            if (!asset.subAssets[name]) {
                database.emit('delete', subAsset);
                database.emit('deleted', subAsset);
            }
        });
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('added', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('changed', asset);
            }
        }
        asset.action = asset_1.AssetActionEnum.none;
        return dirty;
    }
    /**
     * 导入实体资源的流程
     */
    async importAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || (importer.versionCode !== asset.versionCode && asset.invalid !== true)
            || (importer.version !== asset.meta.ver && asset.invalid !== true)
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            if (asset.meta.importer !== importer.name) {
                asset.meta.ver = '0.0.0';
            }
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // meta 版本号大于导入器版本号的时候，如果 init 已经成功，则跳过导入流程
                if (asset.init) {
                    return false;
                }
                // 允许强制重新导入，但会报警告
                // asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 资源本体即将开始导入，更新标记数据
            await asset.reset();
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    return dirty;
                }
            }
            if (database.options.level >= 4) {
                console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                asset.versionCode = importer.versionCode;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    // 超时控制
                    const timer = setTimeout(() => {
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
                database.dataManager.update(asset);
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
        }
        return dirty;
    }
    /**
     * 导入虚拟资源的流程
     * @param database
     * @param asset
     * @param dirty 是否被修改
     */
    async importVirtualAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || importer.version !== asset.meta.ver
            || importer.versionCode !== asset.versionCode
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // if (asset.init) {
                //     return false;
                // }
                asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 虚拟资源只能发送导入和删除
            // database.emit('add', asset.uuid, asset);
            // 虚拟资源 / 子资源不需要也无法判断是否更改
            // 资源本体即将开始导入，更新标记数据
            asset.imported = false;
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    // database.emit('added', asset.uuid, asset);
                    // database.eventManager.add(asset);
                    return false;
                }
            }
            if (database.options.level >= 4) {
                if (asset.action === asset_1.AssetActionEnum.add) {
                    console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
                else {
                    console.debug(`%cReImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                asset.versionCode = importer.versionCode;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    async function onTimer() {
                        // 如果资源在导入过程中被标记为能被唤醒，则重新计时
                        if (importer.checkAwake && (await importer.checkAwake(asset)) === true) {
                            clearTimeout(timer);
                            timer = setTimeout(onTimer, TIMEOUT);
                            return;
                        }
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }
                    // 超时控制
                    let timer = setTimeout(onTimer, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
                database.dataManager.update(asset);
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
            // 重新导入受影响的资源
            (0, manager_1.importAssociatedAssets)(database, asset);
            // database.emit('added', asset.uuid, asset);
            // database.eventManager.add(asset);
        }
        return dirty;
    }
    /**
     * 迁移资源
     * @param importer
     * @param database
     * @param asset
     */
    async migrateAsset(importer, database, asset) {
        let catchError = null;
        if (importer.migrationHook && importer.migrationHook.pre) {
            await importer.migrationHook.pre(asset);
        }
        let num = 0;
        let i = 0;
        for (i; i < importer.migrations.length; i++) {
            const task = importer.migrations[i];
            const index = (0, utils_1.compareVersion)(asset.meta.ver, task.version);
            if (index < 0) {
                try {
                    if (database.options.level >= 4) {
                        console.debug(`%cMigrate%c: ${asset.source}(${task.version})`, 'background: #fbe5b5; color: #000;', 'color: #000;');
                    }
                    task.migrate && await task.migrate(asset);
                    num++;
                    asset.meta.ver = task.version;
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(`Migrate error:  {asset[${asset.source}](${asset.uuid})} - ${task.version}`);
                    }
                    catchError = error;
                    break;
                }
            }
        }
        if (importer.migrationHook && importer.migrationHook.post) {
            await importer.migrationHook.post(asset, num);
        }
        if (catchError) {
            throw catchError;
        }
    }
}
exports.ImportTask = ImportTask;
class DestroyTask extends Task {
    /**
     * 销毁一个资源
     * @param database
     * @param asset
     */
    async exec(database, asset) {
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('delete', asset);
        }
        // 销毁子资源
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                subAsset.action = asset_1.AssetActionEnum.delete;
                await this.exec(database, subAsset);
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Destroy exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        let result = undefined;
        try {
            result = await this.destroyAsset(database, asset);
        }
        catch (error) {
            console.error(error);
        }
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('deleted', asset);
        }
        return result;
    }
    async destroyAsset(database, asset) {
        if (database.options.level >= 4) {
            console.debug(`%cDestroy%c: ${asset.source}`, 'background: #ffb8b8; color: #000;', 'color: #000;');
        }
        // if (!(asset instanceof Asset)) {
        //     // 虚拟资源只能发送导入和删除
        //     database.emit('delete', asset.uuid, asset);
        // }
        await asset.reset();
        // 文件夹为空需要另同步检查
        // 异步接口会造成检查为空后中间又被插入新的文件
        const libraryDir = asset.library;
        if ((0, fs_extra_1.existsSync)(libraryDir)) {
            let files = (0, fs_extra_1.readdirSync)(libraryDir);
            if (files.length === 0) {
                (0, fs_extra_1.removeSync)(libraryDir);
            }
        }
    }
}
exports.DestroyTask = DestroyTask;
/**
 * 任务缓存
 */
exports.TASK_MAP = {
    import: new ImportTask(),
    destroy: new DestroyTask(),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL3Rhc2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFJYix1Q0FBK0Q7QUFDL0QsbUNBQStEO0FBRS9ELG1DQUF5QztBQUV6QyxpREFBOEM7QUFDOUMsdUNBQW1EO0FBRW5ELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRTlCOztHQUVHO0FBQ0gsTUFBYSxJQUFJO0lBQWpCO1FBRUksT0FBTztRQUNDLFVBQUssR0FBNkIsRUFBRSxDQUFDO0lBMEJqRCxDQUFDO0lBeEJHOztPQUVHO0lBQ0gsbUJBQW1CO0lBRW5COzs7O09BSUc7SUFDSCxFQUFFLENBQUMsSUFBWSxFQUFFLElBQWM7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxJQUFJLENBQUMsSUFBWSxFQUFFLEdBQUcsSUFBVztRQUM3QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDeEM7SUFDTCxDQUFDO0NBQ0o7QUE3QkQsb0JBNkJDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFVBQVcsU0FBUSxJQUFJO0lBRWhDOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBaUIsRUFBRSxLQUEyQixFQUFFLFFBQWtCLEVBQUUsS0FBYztRQUV6RixNQUFNLFdBQVcsR0FBOEIsSUFBSSxHQUFHLENBQUM7UUFDdkQsS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQzlCLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUss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LE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3BCLElBQUEscUJBQVUsRUFBQyxVQUFVLENBQUMsQ0FBQzthQUMxQjtTQUNKO0lBQ0wsQ0FBQztDQUNKO0FBaEVELGtDQWdFQztBQUVEOztHQUVHO0FBQ1UsUUFBQSxRQUFRLEdBQUc7SUFDcEIsTUFBTSxFQUFFLElBQUksVUFBVSxFQUFFO0lBQ3hCLE9BQU8sRUFBRSxJQUFJLFdBQVcsRUFBRTtDQUM3QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgdHlwZSB7IEFzc2V0REIgfSBmcm9tICcuL2Fzc2V0LWRiJztcblxuaW1wb3J0IHsgZXhpc3RzU3luYywgcmVhZGRpclN5bmMsIHJlbW92ZVN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBBc3NldEFjdGlvbkVudW0sIEFzc2V0LCBWaXJ0dWFsQXNzZXQgfSBmcm9tICcuL2Fzc2V0JztcbmltcG9ydCB7IEltcG9ydGVyIH0gZnJvbSAnLi9pbXBvcnRlcic7XG5pbXBvcnQgeyBjb21wYXJlVmVyc2lvbiB9IGZyb20gJy4vdXRpbHMnO1xuXG5pbXBvcnQgeyBmaWxsVXNlckRhdGEgfSBmcm9tICcuL2RlZmF1bHQtbWV0YSc7XG5pbXBvcnQgeyBpbXBvcnRBc3NvY2lhdGVkQXNzZXRzIH0gZnJvbSAnLi9tYW5hZ2VyJztcblxuY29uc3QgVElNRU9VVCA9IDEwMDAgKiA2MCAqIDg7XG5cbi8qKlxuICog5Lu75Yqh5Z+656GA57G75Z6LXG4gKi9cbmV4cG9ydCBjbGFzcyBUYXNrIHtcblxuICAgIC8vIOS6i+S7tuWIl+ihqFxuICAgIHByaXZhdGUgZXZlbnQ6IHsgW2luZGV4OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuXG4gICAgLypcbiAgICAgKiDlr7zlhaXmtYHnqItcbiAgICAgKi9cbiAgICAvLyBhc3luYyBleGVjKCkgeyB9XG5cbiAgICAvKipcbiAgICAgKiDnm5HlkKzkuovku7ZcbiAgICAgKiBAcGFyYW0gbmFtZSBcbiAgICAgKiBAcGFyYW0gZnVuYyBcbiAgICAgKi9cbiAgICBvbihuYW1lOiBzdHJpbmcsIGZ1bmM6IEZ1bmN0aW9uKSB7XG4gICAgICAgIHRoaXMuZXZlbnRbbmFtZV0gPSBmdW5jO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOinpuWPkeS6i+S7tlxuICAgICAqIEBwYXJhbSBuYW1lIFxuICAgICAqIEBwYXJhbSBhcmdzIFxuICAgICAqL1xuICAgIGVtaXQobmFtZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICBpZiAodGhpcy5ldmVudFtuYW1lXSkge1xuICAgICAgICAgICAgdGhpcy5ldmVudFtuYW1lXS5jYWxsKHRoaXMsIC4uLmFyZ3MpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOWvvOWFpeS7u+WKoVxuICovXG5leHBvcnQgY2xhc3MgSW1wb3J0VGFzayBleHRlbmRzIFRhc2sge1xuXG4gICAgLyoqXG4gICAgICog5a6e6ZmF55qE5a+85YWl5rWB56iL77yM5YWB6K645Lyg5YWl5a6e5L2T6LWE5rqQ5Lul5Y+K6Jma5ouf6LWE5rqQXG4gICAgICogQHBhcmFtIGRhdGFiYXNlIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKiBAcGFyYW0gaW1wb3J0ZXIgXG4gICAgICogQHBhcmFtIGRpcnR5IFxuICAgICAqL1xuICAgIGFzeW5jIGV4ZWMoZGF0YWJhc2U6IEFzc2V0REIsIGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCwgaW1wb3J0ZXI6IEltcG9ydGVyLCBkaXJ0eTogYm9vbGVhbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuXG4gICAgICAgIGNvbnN0IHN1YkFzc2V0TWFwOiBNYXA8c3RyaW5nLCBWaXJ0dWFsQXNzZXQ+ID0gbmV3IE1hcDtcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBhc3NldC5zdWJBc3NldHMpIHtcbiAgICAgICAgICAgIHN1YkFzc2V0TWFwLnNldChuYW1lLCBhc3NldC5zdWJBc3NldHNbbmFtZV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRpcnR5KSB7XG4gICAgICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uYWRkKSB7XG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnYWRkJywgYXNzZXQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5jaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdjaGFuZ2UnLCBhc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpIHtcbiAgICAgICAgICAgICAgICBkaXJ0eSA9IGF3YWl0IHRoaXMuaW1wb3J0QXNzZXQoZGF0YWJhc2UsIGFzc2V0LCBpbXBvcnRlciwgZGlydHkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkaXJ0eSA9IGF3YWl0IHRoaXMuaW1wb3J0VmlydHVhbEFzc2V0KGRhdGFiYXNlLCBhc3NldCwgaW1wb3J0ZXIsIGRpcnR5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5a+85YWl5a2Q6LWE5rqQXG4gICAgICAgIGxldCBzdWJEaXJ0eSA9IGRpcnR5O1xuICAgICAgICBmb3IgKGxldCBuYW1lIGluIGFzc2V0LnN1YkFzc2V0cykge1xuICAgICAgICAgICAgY29uc3Qgc3ViQXNzZXQgPSBhc3NldC5zdWJBc3NldHNbbmFtZV07XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGltcG9ydGVyID0gYXdhaXQgZGF0YWJhc2UuaW1wb3J0ZXJNYW5hZ2VyLmZpbmQoc3ViQXNzZXQpO1xuICAgICAgICAgICAgICAgIGlmICghaW1wb3J0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gaW1wb3J0IGRhdGEsIG5vIHN1aXRhYmxlIGltcG9ydGVyIHdhcyBmb3VuZC5cXG4gYXNzZXQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyDlt7Llr7zlhaXlrozmiJDnmoTlrZDotYTmupDmiY3lj6/ku6Xlj5EgY2hhbmdlIOa2iOaBr1xuICAgICAgICAgICAgICAgIGlmIChzdWJBc3NldE1hcC5oYXMobmFtZSkgJiYgYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YkFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5jaGFuZ2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViQXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmFkZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMuZXhlYyhkYXRhYmFzZSwgc3ViQXNzZXQsIGltcG9ydGVyLCBzdWJEaXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0ubm9uZTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSW1wb3J0ZXIgZXhlYyBmYWlsZWQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlr7zlhaXlrZDotYTmupDlkI7nmoTpkqnlrZDlh73mlbBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGltcG9ydGVyLmFmdGVyU3ViQXNzZXRzSW1wb3J0ICYmIChhd2FpdCBpbXBvcnRlci5hZnRlclN1YkFzc2V0c0ltcG9ydChhc3NldCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXhlYyBhZnRlclN1YkFzc2V0c0ltcG9ydCBob29rIGZhaWxlZDoge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN1YkFzc2V0TWFwLmZvckVhY2goKHN1YkFzc2V0LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWFzc2V0LnN1YkFzc2V0c1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2RlbGV0ZScsIHN1YkFzc2V0KTtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGVkJywgc3ViQXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZGlydHkpIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5hZGQpIHtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnY2hhbmdlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuXG4gICAgICAgIHJldHVybiBkaXJ0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlr7zlhaXlrp7kvZPotYTmupDnmoTmtYHnqItcbiAgICAgKi9cbiAgICBhc3luYyBpbXBvcnRBc3NldChkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0LCBpbXBvcnRlcjogSW1wb3J0ZXIsIGRpcnR5OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIC8vIOWmguaenOi1hOa6kOWvvOWFpei/h++8jOS4lOaWh+S7tuayoeacieS/ruaUue+8jOWImei3s+i/h+WvvOWFpea1geeoi1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBkaXJ0eVxuICAgICAgICAgICAgfHwgKGltcG9ydGVyLnZlcnNpb25Db2RlICE9PSBhc3NldC52ZXJzaW9uQ29kZSAmJiBhc3NldC5pbnZhbGlkICE9PSB0cnVlKVxuICAgICAgICAgICAgfHwgKGltcG9ydGVyLnZlcnNpb24gIT09IGFzc2V0Lm1ldGEudmVyICYmIGFzc2V0LmludmFsaWQgIT09IHRydWUpXG4gICAgICAgICAgICB8fCAoYXNzZXQubWV0YS5pbXBvcnRlZCA9PT0gZmFsc2UgJiYgYXNzZXQuaW52YWxpZCAhPT0gdHJ1ZSlcbiAgICAgICAgICAgIHx8IGF3YWl0IGltcG9ydGVyLmZvcmNlKGFzc2V0KVxuICAgICAgICAgICAgLy8gZGlydHkg5qCH6K6w6LWw6L+HIGNoZWNrRGlydHkg5pa55rOV77yM5YW25a6e5qOA5p+l6L+HXG4gICAgICAgICAgICAvLyDkvYbku5bku6zmmK/lvILmraXnmoTvvIzlj6/og73kvJrkuIDnp43mg4XlhrXvvIzmo4Dmn6XnmoTml7blgJnov5jlnKjvvIzov5nph4zmiafooYznmoTml7blgJnlsLHkuI3op4HkuoZcbiAgICAgICAgICAgIC8vIOi/meenjeaDheWGteWPr+S7peaaguaXtuW/veeVpeWkhOeQhu+8jOi/memHjOi/mOayoeaciei/m+ihjOWkhOeQhu+8jOWQjue7reS4i+mdouWHoOihjOWPr+S7peazqOmHiuaOiVxuICAgICAgICAgICAgfHwgYXNzZXQubWV0YS5maWxlcy5zb21lKChleHQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAhYXNzZXQuZXhpc3RzSW5MaWJyYXJ5KGV4dCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5tZXRhLmltcG9ydGVyICE9PSBpbXBvcnRlci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS52ZXIgPSAnMC4wLjAnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB2ZXJzaW9uQ29udHJhc3QgPSBjb21wYXJlVmVyc2lvbihhc3NldC5tZXRhLnZlciwgaW1wb3J0ZXIudmVyc2lvbik7XG4gICAgICAgICAgICBpZiAodmVyc2lvbkNvbnRyYXN0ID09PSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gbWV0YSDniYjmnKzlj7flpKfkuo7lr7zlhaXlmajniYjmnKzlj7fnmoTml7blgJnvvIzlpoLmnpwgaW5pdCDlt7Lnu4/miJDlip/vvIzliJnot7Pov4flr7zlhaXmtYHnqItcbiAgICAgICAgICAgICAgICBpZiAoYXNzZXQuaW5pdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIOWFgeiuuOW8uuWItumHjeaWsOWvvOWFpe+8jOS9huS8muaKpeitpuWRilxuICAgICAgICAgICAgICAgIC8vIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgSW1wb3J0ZXIgZXhlYyB3YXJuaW5nOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX06IFRoZSBpbXBvcnRlciB2ZXJzaW9uIGlzIGxvd2VyIHRoYW4gYXNzZXRgKTtcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8g6LWE5rqQ5pys5L2T5Y2z5bCG5byA5aeL5a+85YWl77yM5pu05paw5qCH6K6w5pWw5o2uXG4gICAgICAgICAgICBhd2FpdCBhc3NldC5yZXNldCgpO1xuXG4gICAgICAgICAgICAvLyDov5jmmK/kvb/nlKjkuYvliY3nmoTlr7zlhaXlmajvvIzlsJ3or5Xov4Hnp7tcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09PSBhc3NldC5tZXRhLmltcG9ydGVyXG4gICAgICAgICAgICAgICAgJiYgYXNzZXQubWV0YS52ZXIgIT09ICcwLjAuMCdcbiAgICAgICAgICAgICAgICAmJiB2ZXJzaW9uQ29udHJhc3QgPT09IC0xXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLm1pZ3JhdGVBc3NldChpbXBvcnRlciwgZGF0YWJhc2UsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gNCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjSW1wb3J0JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjYWFmZjg1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOWunumZheWvvOWFpea1geeoi1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLyBpZiAodmVyc2lvbkNvbnRyYXN0ICE9PSAxKSB7XG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS52ZXIgPSBpbXBvcnRlci52ZXJzaW9uO1xuICAgICAgICAgICAgICAgIGFzc2V0LnZlcnNpb25Db2RlID0gaW1wb3J0ZXIudmVyc2lvbkNvZGU7XG4gICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIC8vIOi1hOa6kOS7juacquS9v+eUqOW9k+WJjeWvvOWFpeWZqOWvvOWFpei/h1xuICAgICAgICAgICAgICAgIGFzc2V0Lm1ldGEudXNlckRhdGEgPSBhc3NldC5tZXRhLnVzZXJEYXRhIHx8IHt9O1xuICAgICAgICAgICAgICAgIGZpbGxVc2VyRGF0YShpbXBvcnRlci5uYW1lLCBhc3NldC5tZXRhLnVzZXJEYXRhKTtcblxuICAgICAgICAgICAgICAgIGFzc2V0Lm1ldGEuaW1wb3J0ZXIgPSBpbXBvcnRlci5uYW1lO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyDotoXml7bmjqfliLZcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0Ll9hc3NldERCLmVtaXQoJ3VucmVzcG9uc2l2ZScsIGFzc2V0LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSwgVElNRU9VVCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0ZXIuaW1wb3J0KGFzc2V0KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8g5a+85YWl5rWB56iL6ZyA6KaB56Gu5L+d6YeM6Z2i55qE5paH5Lu25a2Y5YKo5q2j5bi45omn6KGMXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAvLyDotYTmupDmnKzkvZPlr7zlhaXlrozmiJDvvIzmm7TmlrDmoIforrDmlbDmja5cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5kYXRhTWFuYWdlci51cGRhdGUoYXNzZXQpO1xuXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSW1wb3J0ZXIgZXhlYyBmYWlsZWQ6IHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGlydHk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5a+85YWl6Jma5ouf6LWE5rqQ55qE5rWB56iLXG4gICAgICogQHBhcmFtIGRhdGFiYXNlIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKiBAcGFyYW0gZGlydHkg5piv5ZCm6KKr5L+u5pS5XG4gICAgICovXG4gICAgYXN5bmMgaW1wb3J0VmlydHVhbEFzc2V0KGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogVmlydHVhbEFzc2V0LCBpbXBvcnRlcjogSW1wb3J0ZXIsIGRpcnR5OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIC8vIOWmguaenOi1hOa6kOWvvOWFpei/h++8jOS4lOaWh+S7tuayoeacieS/ruaUue+8jOWImei3s+i/h+WvvOWFpea1geeoi1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBkaXJ0eVxuICAgICAgICAgICAgfHwgaW1wb3J0ZXIudmVyc2lvbiAhPT0gYXNzZXQubWV0YS52ZXJcbiAgICAgICAgICAgIHx8IGltcG9ydGVyLnZlcnNpb25Db2RlICE9PSBhc3NldC52ZXJzaW9uQ29kZVxuICAgICAgICAgICAgfHwgKGFzc2V0Lm1ldGEuaW1wb3J0ZWQgPT09IGZhbHNlICYmIGFzc2V0LmludmFsaWQgIT09IHRydWUpXG4gICAgICAgICAgICB8fCBhd2FpdCBpbXBvcnRlci5mb3JjZShhc3NldClcbiAgICAgICAgICAgIC8vIGRpcnR5IOagh+iusOi1sOi/hyBjaGVja0RpcnR5IOaWueazle+8jOWFtuWunuajgOafpei/h1xuICAgICAgICAgICAgLy8g5L2G5LuW5Lus5piv5byC5q2l55qE77yM5Y+v6IO95Lya5LiA56eN5oOF5Ya177yM5qOA5p+l55qE5pe25YCZ6L+Y5Zyo77yM6L+Z6YeM5omn6KGM55qE5pe25YCZ5bCx5LiN6KeB5LqGXG4gICAgICAgICAgICAvLyDov5nnp43mg4XlhrXlj6/ku6XmmoLml7blv73nlaXlpITnkIbvvIzov5nph4zov5jmsqHmnInov5vooYzlpITnkIbvvIzlkI7nu63kuIvpnaLlh6DooYzlj6/ku6Xms6jph4rmjolcbiAgICAgICAgICAgIHx8IGFzc2V0Lm1ldGEuZmlsZXMuc29tZSgoZXh0OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gIWFzc2V0LmV4aXN0c0luTGlicmFyeShleHQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBjb25zdCB2ZXJzaW9uQ29udHJhc3QgPSBjb21wYXJlVmVyc2lvbihhc3NldC5tZXRhLnZlciwgaW1wb3J0ZXIudmVyc2lvbik7XG4gICAgICAgICAgICBpZiAodmVyc2lvbkNvbnRyYXN0ID09PSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gaWYgKGFzc2V0LmluaXQpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEltcG9ydGVyIGV4ZWMgd2FybmluZzoge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9OiBUaGUgaW1wb3J0ZXIgdmVyc2lvbiBpcyBsb3dlciB0aGFuIGFzc2V0YCk7XG4gICAgICAgICAgICAgICAgLy8gcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkaXJ0eSA9IHRydWU7XG5cbiAgICAgICAgICAgIC8vIOiZmuaLn+i1hOa6kOWPquiDveWPkemAgeWvvOWFpeWSjOWIoOmZpFxuICAgICAgICAgICAgLy8gZGF0YWJhc2UuZW1pdCgnYWRkJywgYXNzZXQudXVpZCwgYXNzZXQpO1xuXG4gICAgICAgICAgICAvLyDomZrmi5/otYTmupAgLyDlrZDotYTmupDkuI3pnIDopoHkuZ/ml6Dms5XliKTmlq3mmK/lkKbmm7TmlLlcbiAgICAgICAgICAgIC8vIOi1hOa6kOacrOS9k+WNs+WwhuW8gOWni+WvvOWFpe+8jOabtOaWsOagh+iusOaVsOaNrlxuICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgLy8g6L+Y5piv5L2/55So5LmL5YmN55qE5a+85YWl5Zmo77yM5bCd6K+V6L+B56e7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgaW1wb3J0ZXIubmFtZSA9PT0gYXNzZXQubWV0YS5pbXBvcnRlclxuICAgICAgICAgICAgICAgICYmIGFzc2V0Lm1ldGEudmVyICE9PSAnMC4wLjAnXG4gICAgICAgICAgICAgICAgJiYgdmVyc2lvbkNvbnRyYXN0ID09PSAtMVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5taWdyYXRlQXNzZXQoaW1wb3J0ZXIsIGRhdGFiYXNlLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRhdGFiYXNlLmVtaXQoJ2FkZGVkJywgYXNzZXQudXVpZCwgYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAvLyBkYXRhYmFzZS5ldmVudE1hbmFnZXIuYWRkKGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gNCkge1xuICAgICAgICAgICAgICAgIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5hZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWNJbXBvcnQlYzogJHthc3NldC5zb3VyY2V9YCwgJ2JhY2tncm91bmQ6ICNhYWZmODU7IGNvbG9yOiAjMDAwOycsICdjb2xvcjogIzAwMDsnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGAlY1JlSW1wb3J0JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjYWFmZjg1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDlrp7pmYXlr7zlhaXmtYHnqItcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8gaWYgKHZlcnNpb25Db250cmFzdCAhPT0gMSkge1xuICAgICAgICAgICAgICAgIGFzc2V0Lm1ldGEudmVyID0gaW1wb3J0ZXIudmVyc2lvbjtcbiAgICAgICAgICAgICAgICBhc3NldC52ZXJzaW9uQ29kZSA9IGltcG9ydGVyLnZlcnNpb25Db2RlO1xuICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICAvLyDotYTmupDku47mnKrkvb/nlKjlvZPliY3lr7zlhaXlmajlr7zlhaXov4dcbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnVzZXJEYXRhID0gYXNzZXQubWV0YS51c2VyRGF0YSB8fCB7fTtcbiAgICAgICAgICAgICAgICBmaWxsVXNlckRhdGEoaW1wb3J0ZXIubmFtZSwgYXNzZXQubWV0YS51c2VyRGF0YSk7XG5cbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLmltcG9ydGVyID0gaW1wb3J0ZXIubmFtZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXN5bmMgZnVuY3Rpb24gb25UaW1lcigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOi1hOa6kOWcqOWvvOWFpei/h+eoi+S4reiiq+agh+iusOS4uuiDveiiq+WUpOmGku+8jOWImemHjeaWsOiuoeaXtlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltcG9ydGVyLmNoZWNrQXdha2UgJiYgKGF3YWl0IGltcG9ydGVyLmNoZWNrQXdha2UoYXNzZXQpKSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KG9uVGltZXIsIFRJTUVPVVQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0Ll9hc3NldERCLmVtaXQoJ3VucmVzcG9uc2l2ZScsIGFzc2V0LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyDotoXml7bmjqfliLZcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRpbWVyID0gc2V0VGltZW91dChvblRpbWVyLCBUSU1FT1VUKTtcblxuICAgICAgICAgICAgICAgICAgICBpbXBvcnRlci5pbXBvcnQoYXNzZXQpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyDlr7zlhaXmtYHnqIvpnIDopoHnoa7kv53ph4zpnaLnmoTmlofku7blrZjlgqjmraPluLjmiafooYxcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi1hOa6kOacrOS9k+WvvOWFpeWujOaIkO+8jOabtOaWsOagh+iusOaVsOaNrlxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZGF0YU1hbmFnZXIudXBkYXRlKGFzc2V0KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBJbXBvcnRlciBleGVjIGZhaWxlZDoge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g6YeN5paw5a+85YWl5Y+X5b2x5ZON55qE6LWE5rqQXG4gICAgICAgICAgICBpbXBvcnRBc3NvY2lhdGVkQXNzZXRzKGRhdGFiYXNlLCBhc3NldCk7XG5cbiAgICAgICAgICAgIC8vIGRhdGFiYXNlLmVtaXQoJ2FkZGVkJywgYXNzZXQudXVpZCwgYXNzZXQpO1xuICAgICAgICAgICAgLy8gZGF0YWJhc2UuZXZlbnRNYW5hZ2VyLmFkZChhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGlydHk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6L+B56e76LWE5rqQXG4gICAgICogQHBhcmFtIGltcG9ydGVyIFxuICAgICAqIEBwYXJhbSBkYXRhYmFzZSBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgYXN5bmMgbWlncmF0ZUFzc2V0KGltcG9ydGVyOiBJbXBvcnRlciwgZGF0YWJhc2U6IEFzc2V0REIsIGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCkge1xuICAgICAgICBsZXQgY2F0Y2hFcnJvcjogRXJyb3IgfCBudWxsID0gbnVsbDtcblxuICAgICAgICBpZiAoaW1wb3J0ZXIubWlncmF0aW9uSG9vayAmJiBpbXBvcnRlci5taWdyYXRpb25Ib29rLnByZSkge1xuICAgICAgICAgICAgYXdhaXQgaW1wb3J0ZXIubWlncmF0aW9uSG9vay5wcmUoYXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG51bSA9IDA7XG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgZm9yIChpOyBpIDwgaW1wb3J0ZXIubWlncmF0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgdGFzayA9IGltcG9ydGVyLm1pZ3JhdGlvbnNbaV07XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGNvbXBhcmVWZXJzaW9uKGFzc2V0Lm1ldGEudmVyLCB0YXNrLnZlcnNpb24pO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjTWlncmF0ZSVjOiAke2Fzc2V0LnNvdXJjZX0oJHt0YXNrLnZlcnNpb259KWAsICdiYWNrZ3JvdW5kOiAjZmJlNWI1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGFzay5taWdyYXRlICYmIGF3YWl0IHRhc2subWlncmF0ZShhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIG51bSsrO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnZlciA9IHRhc2sudmVyc2lvbjtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBNaWdyYXRlIGVycm9yOiAge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9IC0gJHt0YXNrLnZlcnNpb259YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvciA9IGVycm9yIGFzIEVycm9yO1xuICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbXBvcnRlci5taWdyYXRpb25Ib29rICYmIGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sucG9zdCkge1xuICAgICAgICAgICAgYXdhaXQgaW1wb3J0ZXIubWlncmF0aW9uSG9vay5wb3N0KGFzc2V0LCBudW0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNhdGNoRXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGNhdGNoRXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEZXN0cm95VGFzayBleHRlbmRzIFRhc2sge1xuXG4gICAgLyoqXG4gICAgICog6ZSA5q+B5LiA5Liq6LWE5rqQXG4gICAgICogQHBhcmFtIGRhdGFiYXNlIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBhc3luYyBleGVjKGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpIHtcblxuICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uZGVsZXRlKSB7XG4gICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGUnLCBhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDplIDmr4HlrZDotYTmupBcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBhc3NldC5zdWJBc3NldHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1YkFzc2V0ID0gYXNzZXQuc3ViQXNzZXRzW25hbWVdO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uZGVsZXRlO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZXhlYyhkYXRhYmFzZSwgc3ViQXNzZXQpO1xuICAgICAgICAgICAgICAgIHN1YkFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYERlc3Ryb3kgZXhlYyBmYWlsZWQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0OiBhbnkgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLmRlc3Ryb3lBc3NldChkYXRhYmFzZSwgYXNzZXQpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uZGVsZXRlKSB7XG4gICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGVkJywgYXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBhc3luYyBkZXN0cm95QXNzZXQoZGF0YWJhc2U6IEFzc2V0REIsIGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCkge1xuICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSA0KSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGAlY0Rlc3Ryb3klYzogJHthc3NldC5zb3VyY2V9YCwgJ2JhY2tncm91bmQ6ICNmZmI4Yjg7IGNvbG9yOiAjMDAwOycsICdjb2xvcjogIzAwMDsnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmICghKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpKSB7XG4gICAgICAgIC8vICAgICAvLyDomZrmi5/otYTmupDlj6rog73lj5HpgIHlr7zlhaXlkozliKDpmaRcbiAgICAgICAgLy8gICAgIGRhdGFiYXNlLmVtaXQoJ2RlbGV0ZScsIGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgLy8gfVxuXG4gICAgICAgIGF3YWl0IGFzc2V0LnJlc2V0KCk7XG5cbiAgICAgICAgLy8g5paH5Lu25aS55Li656m66ZyA6KaB5Y+m5ZCM5q2l5qOA5p+lXG4gICAgICAgIC8vIOW8guatpeaOpeWPo+S8mumAoOaIkOajgOafpeS4uuepuuWQjuS4remXtOWPiOiiq+aPkuWFpeaWsOeahOaWh+S7tlxuICAgICAgICBjb25zdCBsaWJyYXJ5RGlyID0gYXNzZXQubGlicmFyeTtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMobGlicmFyeURpcikpIHtcbiAgICAgICAgICAgIGxldCBmaWxlcyA9IHJlYWRkaXJTeW5jKGxpYnJhcnlEaXIpO1xuICAgICAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJlbW92ZVN5bmMobGlicmFyeURpcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICog5Lu75Yqh57yT5a2YXG4gKi9cbmV4cG9ydCBjb25zdCBUQVNLX01BUCA9IHtcbiAgICBpbXBvcnQ6IG5ldyBJbXBvcnRUYXNrKCksXG4gICAgZGVzdHJveTogbmV3IERlc3Ryb3lUYXNrKCksXG59O1xuIl19