'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.TASK_MAP = exports.DestroyTask = exports.ImportTask = exports.Task = void 0;
const fs_extra_1 = require("fs-extra");
const asset_1 = require("./asset");
const utils_1 = require("./utils");
const default_meta_1 = require("./default-meta");
const manager_1 = require("./manager");
const TIMEOUT = 1000 * 60 * 8;
/**
 * 任务基础类型
 */
class Task {
    constructor() {
        // 事件列表
        this.event = {};
    }
    /*
     * 导入流程
     */
    // async exec() { }
    /**
     * 监听事件
     * @param name
     * @param func
     */
    on(name, func) {
        this.event[name] = func;
    }
    /**
     * 触发事件
     * @param name
     * @param args
     */
    emit(name, ...args) {
        if (this.event[name]) {
            this.event[name].call(this, ...args);
        }
    }
}
exports.Task = Task;
/**
 * 导入任务
 */
class ImportTask extends Task {
    /**
     * 实际的导入流程，允许传入实体资源以及虚拟资源
     * @param database
     * @param asset
     * @param importer
     * @param dirty
     */
    async exec(database, asset, importer, dirty) {
        const subAssetMap = new Map;
        for (let name in asset.subAssets) {
            subAssetMap.set(name, asset.subAssets[name]);
        }
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('add', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('change', asset);
            }
        }
        try {
            if (asset instanceof asset_1.Asset) {
                dirty = await this.importAsset(database, asset, importer, dirty);
            }
            else {
                dirty = await this.importVirtualAsset(database, asset, importer, dirty);
            }
        }
        catch (error) {
            console.error(error);
        }
        // 导入子资源
        let subDirty = dirty;
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                const importer = await database.importerManager.find(subAsset);
                if (!importer) {
                    throw new Error(`Unable to import data, no suitable importer was found.\n asset: {asset[${subAsset.source}](${subAsset.uuid})}`);
                }
                // 已导入完成的子资源才可以发 change 消息
                if (subAssetMap.has(name) && asset.action === asset_1.AssetActionEnum.change) {
                    subAsset.action = asset_1.AssetActionEnum.change;
                }
                else {
                    subAsset.action = asset_1.AssetActionEnum.add;
                }
                if (await this.exec(database, subAsset, importer, subDirty)) {
                    dirty = true;
                }
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                dirty = true;
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        // 导入子资源后的钩子函数
        try {
            importer.afterSubAssetsImport && (await importer.afterSubAssetsImport(asset));
        }
        catch (error) {
            console.error(`Exec afterSubAssetsImport hook failed: {asset[${asset.source}](${asset.uuid})}`);
            console.error(error);
        }
        subAssetMap.forEach((subAsset, name) => {
            if (!asset.subAssets[name]) {
                database.emit('delete', subAsset);
                database.emit('deleted', subAsset);
            }
        });
        if (dirty) {
            if (asset.action === asset_1.AssetActionEnum.add) {
                database.emit('added', asset);
            }
            else if (asset.action === asset_1.AssetActionEnum.change) {
                database.emit('changed', asset);
            }
        }
        asset.action = asset_1.AssetActionEnum.none;
        return dirty;
    }
    /**
     * 导入实体资源的流程
     */
    async importAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || (importer.version !== asset.meta.ver && asset.invalid !== true)
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            if (asset.meta.importer !== importer.name) {
                asset.meta.ver = '0.0.0';
            }
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // meta 版本号大于导入器版本号的时候，如果 init 已经成功，则跳过导入流程
                if (asset.init) {
                    return false;
                }
                // 允许强制重新导入，但会报警告
                // asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 资源本体即将开始导入，更新标记数据
            await asset.reset();
            asset.imported = false;
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    return dirty;
                }
            }
            if (database.options.level >= 4) {
                console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    // 超时控制
                    const timer = setTimeout(() => {
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
        }
        return dirty;
    }
    /**
     * 导入虚拟资源的流程
     * @param database
     * @param asset
     * @param dirty 是否被修改
     */
    async importVirtualAsset(database, asset, importer, dirty) {
        // 如果资源导入过，且文件没有修改，则跳过导入流程
        if (dirty
            || importer.version !== asset.meta.ver
            || (asset.meta.imported === false && asset.invalid !== true)
            || await importer.force(asset)
            // dirty 标记走过 checkDirty 方法，其实检查过
            // 但他们是异步的，可能会一种情况，检查的时候还在，这里执行的时候就不见了
            // 这种情况可以暂时忽略处理，这里还没有进行处理，后续下面几行可以注释掉
            || asset.meta.files.some((ext) => {
                return !asset.existsInLibrary(ext);
            })) {
            const versionContrast = (0, utils_1.compareVersion)(asset.meta.ver, importer.version);
            if (versionContrast === 1) {
                // if (asset.init) {
                //     return false;
                // }
                asset.invalid = true;
                console.warn(`Importer exec warning: {asset[${asset.source}](${asset.uuid})}: The importer version is lower than asset`);
                // return false;
            }
            dirty = true;
            // 虚拟资源只能发送导入和删除
            // database.emit('add', asset.uuid, asset);
            // 虚拟资源 / 子资源不需要也无法判断是否更改
            // 资源本体即将开始导入，更新标记数据
            asset.imported = false;
            // 还是使用之前的导入器，尝试迁移
            if (importer.name === asset.meta.importer
                && asset.meta.ver !== '0.0.0'
                && versionContrast === -1) {
                try {
                    await this.migrateAsset(importer, database, asset);
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(error);
                    }
                    asset.imported = false;
                    asset.invalid = true;
                    // database.emit('added', asset.uuid, asset);
                    // database.eventManager.add(asset);
                    return false;
                }
            }
            if (database.options.level >= 4) {
                if (asset.action === asset_1.AssetActionEnum.add) {
                    console.debug(`%cImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
                else {
                    console.debug(`%cReImport%c: ${asset.source}`, 'background: #aaff85; color: #000;', 'color: #000;');
                }
            }
            // 实际导入流程
            try {
                // if (versionContrast !== 1) {
                asset.meta.ver = importer.version;
                // }
                // 资源从未使用当前导入器导入过
                asset.meta.userData = asset.meta.userData || {};
                (0, default_meta_1.fillUserData)(importer.name, asset.meta.userData);
                asset.meta.importer = importer.name;
                const result = await new Promise((resolve, reject) => {
                    // 超时控制
                    const timer = setTimeout(() => {
                        clearTimeout(timer);
                        asset._assetDB.emit('unresponsive', asset, {
                            resolve,
                            reject,
                        });
                    }, TIMEOUT);
                    importer.import(asset).then((result) => {
                        clearTimeout(timer);
                        resolve(result);
                    }).catch((error) => {
                        clearTimeout(timer);
                        reject(error);
                    });
                });
                // 导入流程需要确保里面的文件存储正常执行
                if (result === false) {
                    asset.invalid = true;
                }
                else {
                    asset.invalid = false;
                    // 资源本体导入完成，更新标记数据
                    asset.imported = true;
                }
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Importer exec failed: {asset[${asset.source}](${asset.uuid})}`);
                    console.error(error);
                }
                asset.invalid = true;
            }
            // 重新导入受影响的资源
            (0, manager_1.importAssociatedAssets)(database, asset);
            // database.emit('added', asset.uuid, asset);
            // database.eventManager.add(asset);
        }
        return dirty;
    }
    /**
     * 迁移资源
     * @param importer
     * @param database
     * @param asset
     */
    async migrateAsset(importer, database, asset) {
        let catchError = null;
        if (importer.migrationHook && importer.migrationHook.pre) {
            await importer.migrationHook.pre(asset);
        }
        let num = 0;
        let i = 0;
        for (i; i < importer.migrations.length; i++) {
            const task = importer.migrations[i];
            const index = (0, utils_1.compareVersion)(asset.meta.ver, task.version);
            if (index < 0) {
                try {
                    if (database.options.level >= 4) {
                        console.debug(`%cMigrate%c: ${asset.source}(${task.version})`, 'background: #fbe5b5; color: #000;', 'color: #000;');
                    }
                    task.migrate && await task.migrate(asset);
                    num++;
                    asset.meta.ver = task.version;
                }
                catch (error) {
                    if (database.options.level >= 1) {
                        console.error(`Migrate error:  {asset[${asset.source}](${asset.uuid})} - ${task.version}`);
                    }
                    catchError = error;
                    break;
                }
            }
        }
        if (importer.migrationHook && importer.migrationHook.post) {
            await importer.migrationHook.post(asset, num);
        }
        if (catchError) {
            throw catchError;
        }
    }
}
exports.ImportTask = ImportTask;
class DestroyTask extends Task {
    /**
     * 销毁一个资源
     * @param database
     * @param asset
     */
    async exec(database, asset) {
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('delete', asset);
        }
        // 销毁子资源
        for (let name in asset.subAssets) {
            const subAsset = asset.subAssets[name];
            try {
                subAsset.action = asset_1.AssetActionEnum.delete;
                await this.exec(database, subAsset);
                subAsset.action = asset_1.AssetActionEnum.none;
            }
            catch (error) {
                if (database.options.level >= 1) {
                    console.error(`Destroy exec failed: {asset[${subAsset.source}](${subAsset.uuid})}`);
                    console.error(error);
                }
            }
        }
        let result = undefined;
        try {
            result = await this.destroyAsset(database, asset);
        }
        catch (error) {
            console.error(error);
        }
        if (asset.action === asset_1.AssetActionEnum.delete) {
            database.emit('deleted', asset);
        }
        return result;
    }
    async destroyAsset(database, asset) {
        if (database.options.level >= 4) {
            console.debug(`%cDestroy%c: ${asset.source}`, 'background: #ffb8b8; color: #000;', 'color: #000;');
        }
        // if (!(asset instanceof Asset)) {
        //     // 虚拟资源只能发送导入和删除
        //     database.emit('delete', asset.uuid, asset);
        // }
        await asset.reset();
        asset.imported = false;
        asset.invalid = false;
        // 文件夹为空需要另同步检查
        // 异步接口会造成检查为空后中间又被插入新的文件
        const libraryDir = asset.library;
        if ((0, fs_extra_1.existsSync)(libraryDir)) {
            let files = (0, fs_extra_1.readdirSync)(libraryDir);
            if (files.length === 0) {
                (0, fs_extra_1.removeSync)(libraryDir);
            }
        }
    }
}
exports.DestroyTask = DestroyTask;
/**
 * 任务缓存
 */
exports.TASK_MAP = {
    import: new ImportTask(),
    destroy: new DestroyTask(),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL3Rhc2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFJYix1Q0FBK0Q7QUFDL0QsbUNBQStEO0FBRS9ELG1DQUF5QztBQUV6QyxpREFBOEM7QUFDOUMsdUNBQW1EO0FBRW5ELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRTlCOztHQUVHO0FBQ0gsTUFBYSxJQUFJO0lBQWpCO1FBRUksT0FBTztRQUNDLFVBQUssR0FBNkIsRUFBRSxDQUFDO0lBMEJqRCxDQUFDO0lBeEJHOztPQUVHO0lBQ0gsbUJBQW1CO0lBRW5COzs7O09BSUc7SUFDSCxFQUFFLENBQUMsSUFBWSxFQUFFLElBQWM7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxJQUFJLENBQUMsSUFBWSxFQUFFLEdBQUcsSUFBVztRQUM3QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDeEM7SUFDTCxDQUFDO0NBQ0o7QUE3QkQsb0JBNkJDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFVBQVcsU0FBUSxJQUFJO0lBRWhDOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBaUIsRUFBRSxLQUEyQixFQUFFLFFBQWtCLEVBQUUsS0FBYztRQUV6RixNQUFNLFdBQVcsR0FBOEIsSUFBSSxHQUFHLENBQUM7UUFDdkQsS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQzlCLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUss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QUMsUUFBaUIsRUFBRSxLQUEyQjtRQUM3RCxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsRUFBRTtZQUM3QixPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsbUNBQW1DLEVBQUUsY0FBYyxDQUFDLENBQUM7U0FDdEc7UUFFRCxtQ0FBbUM7UUFDbkMsdUJBQXVCO1FBQ3ZCLGtEQUFrRDtRQUNsRCxJQUFJO1FBRUosTUFBTSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDcEIsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDdkIsS0FBSyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFFdEIsZUFBZTtRQUNmLHlCQUF5QjtRQUN6QixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQ2pDLElBQUksSUFBQSxxQkFBVSxFQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3hCLElBQUksS0FBSyxHQUFHLElBQUEsc0JBQVcsRUFBQyxVQUFVLENBQUMsQ0FBQztZQUNwQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNwQixJQUFBLHFCQUFVLEVBQUMsVUFBVSxDQUFDLENBQUM7YUFDMUI7U0FDSjtJQUNMLENBQUM7Q0FDSjtBQWxFRCxrQ0FrRUM7QUFFRDs7R0FFRztBQUNVLFFBQUEsUUFBUSxHQUFHO0lBQ3BCLE1BQU0sRUFBRSxJQUFJLFVBQVUsRUFBRTtJQUN4QixPQUFPLEVBQUUsSUFBSSxXQUFXLEVBQUU7Q0FDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHR5cGUgeyBBc3NldERCIH0gZnJvbSAnLi9hc3NldC1kYic7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRkaXJTeW5jLCByZW1vdmVTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgQXNzZXRBY3Rpb25FbnVtLCBBc3NldCwgVmlydHVhbEFzc2V0IH0gZnJvbSAnLi9hc3NldCc7XG5pbXBvcnQgeyBJbXBvcnRlciB9IGZyb20gJy4vaW1wb3J0ZXInO1xuaW1wb3J0IHsgY29tcGFyZVZlcnNpb24gfSBmcm9tICcuL3V0aWxzJztcblxuaW1wb3J0IHsgZmlsbFVzZXJEYXRhIH0gZnJvbSAnLi9kZWZhdWx0LW1ldGEnO1xuaW1wb3J0IHsgaW1wb3J0QXNzb2NpYXRlZEFzc2V0cyB9IGZyb20gJy4vbWFuYWdlcic7XG5cbmNvbnN0IFRJTUVPVVQgPSAxMDAwICogNjAgKiA4O1xuXG4vKipcbiAqIOS7u+WKoeWfuuehgOexu+Wei1xuICovXG5leHBvcnQgY2xhc3MgVGFzayB7XG5cbiAgICAvLyDkuovku7bliJfooahcbiAgICBwcml2YXRlIGV2ZW50OiB7IFtpbmRleDogc3RyaW5nXTogYW55IH0gPSB7fTtcblxuICAgIC8qXG4gICAgICog5a+85YWl5rWB56iLXG4gICAgICovXG4gICAgLy8gYXN5bmMgZXhlYygpIHsgfVxuXG4gICAgLyoqXG4gICAgICog55uR5ZCs5LqL5Lu2XG4gICAgICogQHBhcmFtIG5hbWUgXG4gICAgICogQHBhcmFtIGZ1bmMgXG4gICAgICovXG4gICAgb24obmFtZTogc3RyaW5nLCBmdW5jOiBGdW5jdGlvbikge1xuICAgICAgICB0aGlzLmV2ZW50W25hbWVdID0gZnVuYztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDop6blj5Hkuovku7ZcbiAgICAgKiBAcGFyYW0gbmFtZSBcbiAgICAgKiBAcGFyYW0gYXJncyBcbiAgICAgKi9cbiAgICBlbWl0KG5hbWU6IHN0cmluZywgLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgaWYgKHRoaXMuZXZlbnRbbmFtZV0pIHtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRbbmFtZV0uY2FsbCh0aGlzLCAuLi5hcmdzKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiDlr7zlhaXku7vliqFcbiAqL1xuZXhwb3J0IGNsYXNzIEltcG9ydFRhc2sgZXh0ZW5kcyBUYXNrIHtcblxuICAgIC8qKlxuICAgICAqIOWunumZheeahOWvvOWFpea1geeoi++8jOWFgeiuuOS8oOWFpeWunuS9k+i1hOa6kOS7peWPiuiZmuaLn+i1hOa6kFxuICAgICAqIEBwYXJhbSBkYXRhYmFzZSBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICogQHBhcmFtIGltcG9ydGVyIFxuICAgICAqIEBwYXJhbSBkaXJ0eSBcbiAgICAgKi9cbiAgICBhc3luYyBleGVjKGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQsIGltcG9ydGVyOiBJbXBvcnRlciwgZGlydHk6IGJvb2xlYW4pOiBQcm9taXNlPGJvb2xlYW4+IHtcblxuICAgICAgICBjb25zdCBzdWJBc3NldE1hcDogTWFwPHN0cmluZywgVmlydHVhbEFzc2V0PiA9IG5ldyBNYXA7XG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gYXNzZXQuc3ViQXNzZXRzKSB7XG4gICAgICAgICAgICBzdWJBc3NldE1hcC5zZXQobmFtZSwgYXNzZXQuc3ViQXNzZXRzW25hbWVdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkaXJ0eSkge1xuICAgICAgICAgICAgaWYgKGFzc2V0LmFjdGlvbiA9PT0gQXNzZXRBY3Rpb25FbnVtLmFkZCkge1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2FkZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnY2hhbmdlJywgYXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChhc3NldCBpbnN0YW5jZW9mIEFzc2V0KSB7XG4gICAgICAgICAgICAgICAgZGlydHkgPSBhd2FpdCB0aGlzLmltcG9ydEFzc2V0KGRhdGFiYXNlLCBhc3NldCwgaW1wb3J0ZXIsIGRpcnR5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGlydHkgPSBhd2FpdCB0aGlzLmltcG9ydFZpcnR1YWxBc3NldChkYXRhYmFzZSwgYXNzZXQsIGltcG9ydGVyLCBkaXJ0eSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5a+85YWl5a2Q6LWE5rqQXG4gICAgICAgIGxldCBzdWJEaXJ0eSA9IGRpcnR5O1xuICAgICAgICBmb3IgKGxldCBuYW1lIGluIGFzc2V0LnN1YkFzc2V0cykge1xuICAgICAgICAgICAgY29uc3Qgc3ViQXNzZXQgPSBhc3NldC5zdWJBc3NldHNbbmFtZV07XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGltcG9ydGVyID0gYXdhaXQgZGF0YWJhc2UuaW1wb3J0ZXJNYW5hZ2VyLmZpbmQoc3ViQXNzZXQpO1xuICAgICAgICAgICAgICAgIGlmICghaW1wb3J0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gaW1wb3J0IGRhdGEsIG5vIHN1aXRhYmxlIGltcG9ydGVyIHdhcyBmb3VuZC5cXG4gYXNzZXQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyDlt7Llr7zlhaXlrozmiJDnmoTlrZDotYTmupDmiY3lj6/ku6Xlj5EgY2hhbmdlIOa2iOaBr1xuICAgICAgICAgICAgICAgIGlmIChzdWJBc3NldE1hcC5oYXMobmFtZSkgJiYgYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YkFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5jaGFuZ2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViQXNzZXQuYWN0aW9uID0gQXNzZXRBY3Rpb25FbnVtLmFkZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMuZXhlYyhkYXRhYmFzZSwgc3ViQXNzZXQsIGltcG9ydGVyLCBzdWJEaXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0ubm9uZTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSW1wb3J0ZXIgZXhlYyBmYWlsZWQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlr7zlhaXlrZDotYTmupDlkI7nmoTpkqnlrZDlh73mlbBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGltcG9ydGVyLmFmdGVyU3ViQXNzZXRzSW1wb3J0ICYmIChhd2FpdCBpbXBvcnRlci5hZnRlclN1YkFzc2V0c0ltcG9ydChhc3NldCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXhlYyBhZnRlclN1YkFzc2V0c0ltcG9ydCBob29rIGZhaWxlZDoge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN1YkFzc2V0TWFwLmZvckVhY2goKHN1YkFzc2V0LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWFzc2V0LnN1YkFzc2V0c1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2RlbGV0ZScsIHN1YkFzc2V0KTtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGVkJywgc3ViQXNzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZGlydHkpIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5hZGQpIHtcbiAgICAgICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgZGF0YWJhc2UuZW1pdCgnY2hhbmdlZCcsIGFzc2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuXG4gICAgICAgIHJldHVybiBkaXJ0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlr7zlhaXlrp7kvZPotYTmupDnmoTmtYHnqItcbiAgICAgKi9cbiAgICBhc3luYyBpbXBvcnRBc3NldChkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0LCBpbXBvcnRlcjogSW1wb3J0ZXIsIGRpcnR5OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIC8vIOWmguaenOi1hOa6kOWvvOWFpei/h++8jOS4lOaWh+S7tuayoeacieS/ruaUue+8jOWImei3s+i/h+WvvOWFpea1geeoi1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBkaXJ0eVxuICAgICAgICAgICAgfHwgKGltcG9ydGVyLnZlcnNpb24gIT09IGFzc2V0Lm1ldGEudmVyICYmIGFzc2V0LmludmFsaWQgIT09IHRydWUpXG4gICAgICAgICAgICB8fCAoYXNzZXQubWV0YS5pbXBvcnRlZCA9PT0gZmFsc2UgJiYgYXNzZXQuaW52YWxpZCAhPT0gdHJ1ZSlcbiAgICAgICAgICAgIHx8IGF3YWl0IGltcG9ydGVyLmZvcmNlKGFzc2V0KVxuICAgICAgICAgICAgLy8gZGlydHkg5qCH6K6w6LWw6L+HIGNoZWNrRGlydHkg5pa55rOV77yM5YW25a6e5qOA5p+l6L+HXG4gICAgICAgICAgICAvLyDkvYbku5bku6zmmK/lvILmraXnmoTvvIzlj6/og73kvJrkuIDnp43mg4XlhrXvvIzmo4Dmn6XnmoTml7blgJnov5jlnKjvvIzov5nph4zmiafooYznmoTml7blgJnlsLHkuI3op4HkuoZcbiAgICAgICAgICAgIC8vIOi/meenjeaDheWGteWPr+S7peaaguaXtuW/veeVpeWkhOeQhu+8jOi/memHjOi/mOayoeaciei/m+ihjOWkhOeQhu+8jOWQjue7reS4i+mdouWHoOihjOWPr+S7peazqOmHiuaOiVxuICAgICAgICAgICAgfHwgYXNzZXQubWV0YS5maWxlcy5zb21lKChleHQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAhYXNzZXQuZXhpc3RzSW5MaWJyYXJ5KGV4dCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChhc3NldC5tZXRhLmltcG9ydGVyICE9PSBpbXBvcnRlci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS52ZXIgPSAnMC4wLjAnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB2ZXJzaW9uQ29udHJhc3QgPSBjb21wYXJlVmVyc2lvbihhc3NldC5tZXRhLnZlciwgaW1wb3J0ZXIudmVyc2lvbik7XG4gICAgICAgICAgICBpZiAodmVyc2lvbkNvbnRyYXN0ID09PSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gbWV0YSDniYjmnKzlj7flpKfkuo7lr7zlhaXlmajniYjmnKzlj7fnmoTml7blgJnvvIzlpoLmnpwgaW5pdCDlt7Lnu4/miJDlip/vvIzliJnot7Pov4flr7zlhaXmtYHnqItcbiAgICAgICAgICAgICAgICBpZiAoYXNzZXQuaW5pdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIOWFgeiuuOW8uuWItumHjeaWsOWvvOWFpe+8jOS9huS8muaKpeitpuWRilxuICAgICAgICAgICAgICAgIC8vIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgSW1wb3J0ZXIgZXhlYyB3YXJuaW5nOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX06IFRoZSBpbXBvcnRlciB2ZXJzaW9uIGlzIGxvd2VyIHRoYW4gYXNzZXRgKTtcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8g6LWE5rqQ5pys5L2T5Y2z5bCG5byA5aeL5a+85YWl77yM5pu05paw5qCH6K6w5pWw5o2uXG4gICAgICAgICAgICBhd2FpdCBhc3NldC5yZXNldCgpO1xuICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgLy8g6L+Y5piv5L2/55So5LmL5YmN55qE5a+85YWl5Zmo77yM5bCd6K+V6L+B56e7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgaW1wb3J0ZXIubmFtZSA9PT0gYXNzZXQubWV0YS5pbXBvcnRlclxuICAgICAgICAgICAgICAgICYmIGFzc2V0Lm1ldGEudmVyICE9PSAnMC4wLjAnXG4gICAgICAgICAgICAgICAgJiYgdmVyc2lvbkNvbnRyYXN0ID09PSAtMVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5taWdyYXRlQXNzZXQoaW1wb3J0ZXIsIGRhdGFiYXNlLCBhc3NldCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRhdGFiYXNlLm9wdGlvbnMubGV2ZWwgPj0gNCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjSW1wb3J0JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjYWFmZjg1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOWunumZheWvvOWFpea1geeoi1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLyBpZiAodmVyc2lvbkNvbnRyYXN0ICE9PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0Lm1ldGEudmVyID0gaW1wb3J0ZXIudmVyc2lvbjtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgLy8g6LWE5rqQ5LuO5pyq5L2/55So5b2T5YmN5a+85YWl5Zmo5a+85YWl6L+HXG4gICAgICAgICAgICAgICAgYXNzZXQubWV0YS51c2VyRGF0YSA9IGFzc2V0Lm1ldGEudXNlckRhdGEgfHwge307XG4gICAgICAgICAgICAgICAgZmlsbFVzZXJEYXRhKGltcG9ydGVyLm5hbWUsIGFzc2V0Lm1ldGEudXNlckRhdGEpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGFzc2V0Lm1ldGEuaW1wb3J0ZXIgPSBpbXBvcnRlci5uYW1lO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyDotoXml7bmjqfliLZcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0Ll9hc3NldERCLmVtaXQoJ3VucmVzcG9uc2l2ZScsIGFzc2V0LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSwgVElNRU9VVCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0ZXIuaW1wb3J0KGFzc2V0KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8g5a+85YWl5rWB56iL6ZyA6KaB56Gu5L+d6YeM6Z2i55qE5paH5Lu25a2Y5YKo5q2j5bi45omn6KGMXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAvLyDotYTmupDmnKzkvZPlr7zlhaXlrozmiJDvvIzmm7TmlrDmoIforrDmlbDmja5cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2goZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEltcG9ydGVyIGV4ZWMgZmFpbGVkOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX1gKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRpcnR5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWvvOWFpeiZmuaLn+i1hOa6kOeahOa1geeoi1xuICAgICAqIEBwYXJhbSBkYXRhYmFzZSBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICogQHBhcmFtIGRpcnR5IOaYr+WQpuiiq+S/ruaUuVxuICAgICAqL1xuICAgIGFzeW5jIGltcG9ydFZpcnR1YWxBc3NldChkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IFZpcnR1YWxBc3NldCwgaW1wb3J0ZXI6IEltcG9ydGVyLCBkaXJ0eTogYm9vbGVhbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICAvLyDlpoLmnpzotYTmupDlr7zlhaXov4fvvIzkuJTmlofku7bmsqHmnInkv67mlLnvvIzliJnot7Pov4flr7zlhaXmtYHnqItcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgZGlydHlcbiAgICAgICAgICAgIHx8IGltcG9ydGVyLnZlcnNpb24gIT09IGFzc2V0Lm1ldGEudmVyXG4gICAgICAgICAgICB8fCAoYXNzZXQubWV0YS5pbXBvcnRlZCA9PT0gZmFsc2UgJiYgYXNzZXQuaW52YWxpZCAhPT0gdHJ1ZSlcbiAgICAgICAgICAgIHx8IGF3YWl0IGltcG9ydGVyLmZvcmNlKGFzc2V0KVxuICAgICAgICAgICAgLy8gZGlydHkg5qCH6K6w6LWw6L+HIGNoZWNrRGlydHkg5pa55rOV77yM5YW25a6e5qOA5p+l6L+HXG4gICAgICAgICAgICAvLyDkvYbku5bku6zmmK/lvILmraXnmoTvvIzlj6/og73kvJrkuIDnp43mg4XlhrXvvIzmo4Dmn6XnmoTml7blgJnov5jlnKjvvIzov5nph4zmiafooYznmoTml7blgJnlsLHkuI3op4HkuoZcbiAgICAgICAgICAgIC8vIOi/meenjeaDheWGteWPr+S7peaaguaXtuW/veeVpeWkhOeQhu+8jOi/memHjOi/mOayoeaciei/m+ihjOWkhOeQhu+8jOWQjue7reS4i+mdouWHoOihjOWPr+S7peazqOmHiuaOiVxuICAgICAgICAgICAgfHwgYXNzZXQubWV0YS5maWxlcy5zb21lKChleHQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAhYXNzZXQuZXhpc3RzSW5MaWJyYXJ5KGV4dCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25Db250cmFzdCA9IGNvbXBhcmVWZXJzaW9uKGFzc2V0Lm1ldGEudmVyLCBpbXBvcnRlci52ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmICh2ZXJzaW9uQ29udHJhc3QgPT09IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiAoYXNzZXQuaW5pdCkge1xuICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgSW1wb3J0ZXIgZXhlYyB3YXJuaW5nOiB7YXNzZXRbJHthc3NldC5zb3VyY2V9XSgke2Fzc2V0LnV1aWR9KX06IFRoZSBpbXBvcnRlciB2ZXJzaW9uIGlzIGxvd2VyIHRoYW4gYXNzZXRgKTtcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTtcblxuICAgICAgICAgICAgLy8g6Jma5ouf6LWE5rqQ5Y+q6IO95Y+R6YCB5a+85YWl5ZKM5Yig6ZmkXG4gICAgICAgICAgICAvLyBkYXRhYmFzZS5lbWl0KCdhZGQnLCBhc3NldC51dWlkLCBhc3NldCk7XG5cbiAgICAgICAgICAgIC8vIOiZmuaLn+i1hOa6kCAvIOWtkOi1hOa6kOS4jemcgOimgeS5n+aXoOazleWIpOaWreaYr+WQpuabtOaUuVxuICAgICAgICAgICAgLy8g6LWE5rqQ5pys5L2T5Y2z5bCG5byA5aeL5a+85YWl77yM5pu05paw5qCH6K6w5pWw5o2uXG4gICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IGZhbHNlO1xuXG4gICAgICAgICAgICAvLyDov5jmmK/kvb/nlKjkuYvliY3nmoTlr7zlhaXlmajvvIzlsJ3or5Xov4Hnp7tcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBpbXBvcnRlci5uYW1lID09PSBhc3NldC5tZXRhLmltcG9ydGVyXG4gICAgICAgICAgICAgICAgJiYgYXNzZXQubWV0YS52ZXIgIT09ICcwLjAuMCdcbiAgICAgICAgICAgICAgICAmJiB2ZXJzaW9uQ29udHJhc3QgPT09IC0xXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLm1pZ3JhdGVBc3NldChpbXBvcnRlciwgZGF0YWJhc2UsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmltcG9ydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0LmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAvLyBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gZGF0YWJhc2UuZXZlbnRNYW5hZ2VyLmFkZChhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDQpIHtcbiAgICAgICAgICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uYWRkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjSW1wb3J0JWM6ICR7YXNzZXQuc291cmNlfWAsICdiYWNrZ3JvdW5kOiAjYWFmZjg1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgJWNSZUltcG9ydCVjOiAke2Fzc2V0LnNvdXJjZX1gLCAnYmFja2dyb3VuZDogI2FhZmY4NTsgY29sb3I6ICMwMDA7JywgJ2NvbG9yOiAjMDAwOycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g5a6e6ZmF5a+85YWl5rWB56iLXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIGlmICh2ZXJzaW9uQ29udHJhc3QgIT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXQubWV0YS52ZXIgPSBpbXBvcnRlci52ZXJzaW9uO1xuICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICAvLyDotYTmupDku47mnKrkvb/nlKjlvZPliY3lr7zlhaXlmajlr7zlhaXov4dcbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnVzZXJEYXRhID0gYXNzZXQubWV0YS51c2VyRGF0YSB8fCB7fTtcbiAgICAgICAgICAgICAgICBmaWxsVXNlckRhdGEoaW1wb3J0ZXIubmFtZSwgYXNzZXQubWV0YS51c2VyRGF0YSk7XG5cbiAgICAgICAgICAgICAgICBhc3NldC5tZXRhLmltcG9ydGVyID0gaW1wb3J0ZXIubmFtZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8g6LaF5pe25o6n5Yi2XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXQuX2Fzc2V0REIuZW1pdCgndW5yZXNwb25zaXZlJywgYXNzZXQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9LCBUSU1FT1VUKTtcblxuICAgICAgICAgICAgICAgICAgICBpbXBvcnRlci5pbXBvcnQoYXNzZXQpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyDlr7zlhaXmtYHnqIvpnIDopoHnoa7kv53ph4zpnaLnmoTmlofku7blrZjlgqjmraPluLjmiafooYxcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbnZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi1hOa6kOacrOS9k+WvvOWFpeWujOaIkO+8jOabtOaWsOagh+iusOaVsOaNrlxuICAgICAgICAgICAgICAgICAgICBhc3NldC5pbXBvcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgSW1wb3J0ZXIgZXhlYyBmYWlsZWQ6IHthc3NldFske2Fzc2V0LnNvdXJjZX1dKCR7YXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXNzZXQuaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOmHjeaWsOWvvOWFpeWPl+W9seWTjeeahOi1hOa6kFxuICAgICAgICAgICAgaW1wb3J0QXNzb2NpYXRlZEFzc2V0cyhkYXRhYmFzZSwgYXNzZXQpO1xuXG4gICAgICAgICAgICAvLyBkYXRhYmFzZS5lbWl0KCdhZGRlZCcsIGFzc2V0LnV1aWQsIGFzc2V0KTtcbiAgICAgICAgICAgIC8vIGRhdGFiYXNlLmV2ZW50TWFuYWdlci5hZGQoYXNzZXQpO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIHJldHVybiBkaXJ0eTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDov4Hnp7votYTmupBcbiAgICAgKiBAcGFyYW0gaW1wb3J0ZXIgXG4gICAgICogQHBhcmFtIGRhdGFiYXNlIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBhc3luYyBtaWdyYXRlQXNzZXQoaW1wb3J0ZXI6IEltcG9ydGVyLCBkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0KSB7XG4gICAgICAgIGxldCBjYXRjaEVycm9yOiBFcnJvciB8IG51bGwgPSBudWxsO1xuXG4gICAgICAgIGlmIChpbXBvcnRlci5taWdyYXRpb25Ib29rICYmIGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sucHJlKSB7XG4gICAgICAgICAgICBhd2FpdCBpbXBvcnRlci5taWdyYXRpb25Ib29rLnByZShhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbnVtID0gMDtcbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICBmb3IgKGk7IGk8aW1wb3J0ZXIubWlncmF0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgdGFzayA9IGltcG9ydGVyLm1pZ3JhdGlvbnNbaV07XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGNvbXBhcmVWZXJzaW9uKGFzc2V0Lm1ldGEudmVyLCB0YXNrLnZlcnNpb24pO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjTWlncmF0ZSVjOiAke2Fzc2V0LnNvdXJjZX0oJHt0YXNrLnZlcnNpb259KWAsICdiYWNrZ3JvdW5kOiAjZmJlNWI1OyBjb2xvcjogIzAwMDsnLCAnY29sb3I6ICMwMDA7Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGFzay5taWdyYXRlICYmIGF3YWl0IHRhc2subWlncmF0ZShhc3NldCk7XG4gICAgICAgICAgICAgICAgICAgIG51bSsrO1xuICAgICAgICAgICAgICAgICAgICBhc3NldC5tZXRhLnZlciA9IHRhc2sudmVyc2lvbjtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBNaWdyYXRlIGVycm9yOiAge2Fzc2V0WyR7YXNzZXQuc291cmNlfV0oJHthc3NldC51dWlkfSl9IC0gJHt0YXNrLnZlcnNpb259YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvciA9IGVycm9yIGFzIEVycm9yO1xuICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbXBvcnRlci5taWdyYXRpb25Ib29rICYmIGltcG9ydGVyLm1pZ3JhdGlvbkhvb2sucG9zdCkge1xuICAgICAgICAgICAgYXdhaXQgaW1wb3J0ZXIubWlncmF0aW9uSG9vay5wb3N0KGFzc2V0LCBudW0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNhdGNoRXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGNhdGNoRXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEZXN0cm95VGFzayBleHRlbmRzIFRhc2sge1xuXG4gICAgLyoqXG4gICAgICog6ZSA5q+B5LiA5Liq6LWE5rqQXG4gICAgICogQHBhcmFtIGRhdGFiYXNlIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBhc3luYyBleGVjKGRhdGFiYXNlOiBBc3NldERCLCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpIHtcblxuICAgICAgICBpZiAoYXNzZXQuYWN0aW9uID09PSBBc3NldEFjdGlvbkVudW0uZGVsZXRlKSB7XG4gICAgICAgICAgICBkYXRhYmFzZS5lbWl0KCdkZWxldGUnLCBhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDplIDmr4HlrZDotYTmupBcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBhc3NldC5zdWJBc3NldHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1YkFzc2V0ID0gYXNzZXQuc3ViQXNzZXRzW25hbWVdO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBzdWJBc3NldC5hY3Rpb24gPSBBc3NldEFjdGlvbkVudW0uZGVsZXRlO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZXhlYyhkYXRhYmFzZSwgc3ViQXNzZXQpO1xuICAgICAgICAgICAgICAgIHN1YkFzc2V0LmFjdGlvbiA9IEFzc2V0QWN0aW9uRW51bS5ub25lO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YWJhc2Uub3B0aW9ucy5sZXZlbCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYERlc3Ryb3kgZXhlYyBmYWlsZWQ6IHthc3NldFske3N1YkFzc2V0LnNvdXJjZX1dKCR7c3ViQXNzZXQudXVpZH0pfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0OiBhbnkgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLmRlc3Ryb3lBc3NldChkYXRhYmFzZSwgYXNzZXQpO1xuICAgICAgICB9IGNhdGNoKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhc3NldC5hY3Rpb24gPT09IEFzc2V0QWN0aW9uRW51bS5kZWxldGUpIHtcbiAgICAgICAgICAgIGRhdGFiYXNlLmVtaXQoJ2RlbGV0ZWQnLCBhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGFzeW5jIGRlc3Ryb3lBc3NldChkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0KSB7XG4gICAgICAgIGlmIChkYXRhYmFzZS5vcHRpb25zLmxldmVsID49IDQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYCVjRGVzdHJveSVjOiAke2Fzc2V0LnNvdXJjZX1gLCAnYmFja2dyb3VuZDogI2ZmYjhiODsgY29sb3I6ICMwMDA7JywgJ2NvbG9yOiAjMDAwOycpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gaWYgKCEoYXNzZXQgaW5zdGFuY2VvZiBBc3NldCkpIHtcbiAgICAgICAgLy8gICAgIC8vIOiZmuaLn+i1hOa6kOWPquiDveWPkemAgeWvvOWFpeWSjOWIoOmZpFxuICAgICAgICAvLyAgICAgZGF0YWJhc2UuZW1pdCgnZGVsZXRlJywgYXNzZXQudXVpZCwgYXNzZXQpO1xuICAgICAgICAvLyB9XG5cbiAgICAgICAgYXdhaXQgYXNzZXQucmVzZXQoKTtcbiAgICAgICAgYXNzZXQuaW1wb3J0ZWQgPSBmYWxzZTtcbiAgICAgICAgYXNzZXQuaW52YWxpZCA9IGZhbHNlO1xuXG4gICAgICAgIC8vIOaWh+S7tuWkueS4uuepuumcgOimgeWPpuWQjOatpeajgOafpVxuICAgICAgICAvLyDlvILmraXmjqXlj6PkvJrpgKDmiJDmo4Dmn6XkuLrnqbrlkI7kuK3pl7Tlj4jooqvmj5LlhaXmlrDnmoTmlofku7ZcbiAgICAgICAgY29uc3QgbGlicmFyeURpciA9IGFzc2V0LmxpYnJhcnk7XG4gICAgICAgIGlmIChleGlzdHNTeW5jKGxpYnJhcnlEaXIpKSB7XG4gICAgICAgICAgICBsZXQgZmlsZXMgPSByZWFkZGlyU3luYyhsaWJyYXJ5RGlyKTtcbiAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZW1vdmVTeW5jKGxpYnJhcnlEaXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOS7u+WKoee8k+WtmFxuICovXG5leHBvcnQgY29uc3QgVEFTS19NQVAgPSB7XG4gICAgaW1wb3J0OiBuZXcgSW1wb3J0VGFzaygpLFxuICAgIGRlc3Ryb3k6IG5ldyBEZXN0cm95VGFzaygpLFxufTtcbiJdfQ==