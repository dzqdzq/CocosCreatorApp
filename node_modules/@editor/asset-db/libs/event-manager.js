"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventManager=void 0;const dependency_1=require("./dependency"),index_1=require("../index");class EventManager{constructor(e){this.parentMap={},this.assetMap={},this._assetDB=e}add(e){if(this.parentMap[e.uuid]&&(this.parentMap[e.uuid].forEach(async s=>{e.subAssets[s._id]||(importAssociatedAssets(s._assetDB,s),this._assetDB.emit("deleted",s),delete this.assetMap[s.uuid])}),this.parentMap[e.uuid].length=0),this.assetMap[e.uuid]){if(importAssociatedAssets(e._assetDB,e),this._assetDB.emit("changed",e),delete this.assetMap[e.uuid],e.parent&&this.parentMap[e.parent.uuid]){const s=this.parentMap[e.parent.uuid].indexOf(e);-1!==s&&this.parentMap[e.parent.uuid].splice(s,1)}}else importAssociatedAssets(e._assetDB,e),this._assetDB.emit("added",e)}change(e){this.parentMap[e.uuid]&&(this.parentMap[e.uuid].forEach(async s=>{e.subAssets[s._id]||(importAssociatedAssets(s._assetDB,s),this._assetDB.emit("deleted",s),delete this.assetMap[s.uuid])}),this.parentMap[e.uuid].length=0),importAssociatedAssets(e._assetDB,e),this._assetDB.emit("changed",e)}delete(e){if("basename"in e)return this.parentMap[e.uuid]&&(this.parentMap[e.uuid].forEach(async s=>{e.subAssets[s._id]||(importAssociatedAssets(s._assetDB,s),this._assetDB.emit("deleted",s),delete this.assetMap[s.uuid])}),this.parentMap[e.uuid].length=0),importAssociatedAssets(e._assetDB,e),void this._assetDB.emit("deleted",e);this.assetMap[e.uuid]=e,e.parent&&(this.parentMap[e.parent.uuid]=this.parentMap[e.parent.uuid]||[],this.parentMap[e.parent.uuid].push(e))}}function importAssociatedAssets(e,s){const t=[],a=e=>{-1===t.indexOf(e)&&t.push(e)};dependency_1.getAssociatedFiles(s.source).forEach(a),dependency_1.getAssociatedFiles(s.uuid).forEach(a),dependency_1.getAssociatedFiles(s.url).forEach(a),t.forEach(e=>{index_1.reimport(e)})}exports.EventManager=EventManager;