'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAssociatedFiles = exports.DependencyManager = void 0;
const fs_extra_1 = require("fs-extra");
// 关联性 map，一个资源更改后需要通知依赖这个资源的其他资源
// 这里记录的就是依赖某个资源的其他资源列表
const associatedMap = {};
/**
 * 资源关联以及依赖关系列表
 * 部分数据需要固化到硬盘上
 */
class DependencyManager {
    constructor() {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        // { uuid: { 'id': [] }, url: { 'db://test/1.json': [] }, path: { '/Users/xxx': [] } }
        this.dependMap = {};
        // 保存使用的 timer
        this._saveTimer = null;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.dependMap = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                console.error(error);
                this.dependMap = {};
            }
        }
        else {
            this.dependMap = {};
        }
        // 补全关联列表
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let path in typeMap) {
                const array = typeMap[path];
                array.forEach((urlOrPathOrUUID) => {
                    associatedMap[urlOrPathOrUUID] = associatedMap[urlOrPathOrUUID] || [];
                    if (associatedMap[urlOrPathOrUUID].indexOf(path) !== -1) {
                        return;
                    }
                    associatedMap[urlOrPathOrUUID].push(path);
                });
            }
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.dependMap, { spaces: 2 });
    }
    /**
     * 记录一个资源依赖的所有资源列表
     * 允许传入 url、uuid、path 三种依赖的格式
     * @param path
     * @param dependNames
     */
    add(type, key, depends) {
        const typeMap = this.dependMap[type] = this.dependMap[type] || {};
        const array = typeMap[key] = typeMap[key] || [];
        if (!Array.isArray(depends)) {
            depends = [depends];
        }
        depends.forEach((depend) => {
            if (depend && array.indexOf(depend) !== -1) {
                return;
            }
            // 记录到依赖列表
            array.push(depend);
            // 记录到关联列表
            const associated = associatedMap[depend] = associatedMap[depend] || [];
            if (associated.indexOf(key) === -1) {
                associated.push(key);
            }
        });
        this.save();
    }
    /**
     * 清空一个资源的依赖记录
     * @param name
     */
    remove(type, key) {
        if (!this.dependMap[type] || !this.dependMap[type][key]) {
            return;
        }
        // 删除依赖列表
        this.dependMap[type][key].forEach((str) => {
            const array = associatedMap[str];
            const index = array.indexOf(key);
            if (index !== -1) {
                array.splice(index, 1);
            }
            if (array.length === 0) {
                delete associatedMap[str];
            }
        });
        delete this.dependMap[type][key];
        this.save();
    }
    /**
     * 销毁一个依赖管理器实例
     * @param manager
     */
    destroy() {
        // 将管理器记录的所有数据从全局缓存内删除
        // 但不清除缓存 json，因为之后还可能需要使用
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let key in typeMap) {
                const array = typeMap[key];
                array.forEach((str) => {
                    if (!associatedMap[str]) {
                        return;
                    }
                    const index = associatedMap[str].indexOf(key);
                    if (index !== -1) {
                        associatedMap[str].splice(index, 1);
                    }
                    if (associatedMap[str].length === 0) {
                        delete associatedMap[str];
                    }
                });
            }
        }
    }
}
exports.DependencyManager = DependencyManager;
/**
 * 获取被影响的资源列表
 * @param urlOrPathOrUUID
 */
function getAssociatedFiles(urlOrPathOrUUID) {
    return associatedMap[urlOrPathOrUUID] || [];
}
exports.getAssociatedFiles = getAssociatedFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwZW5kZW5jeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RlcGVuZGVuY3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBb0U7QUFFcEUsaUNBQWlDO0FBQ2pDLHVCQUF1QjtBQUN2QixNQUFNLGFBQWEsR0FBZ0MsRUFBRSxDQUFDO0FBRXREOzs7R0FHRztBQUNILE1BQWEsaUJBQWlCO0lBQTlCO1FBS0ksd0JBQXdCO1FBQ3hCLHNGQUFzRjtRQUN0RixjQUFTLEdBQWtELEVBQUUsQ0FBQztRQUU5RCxjQUFjO1FBQ2QsZUFBVSxHQUFRLElBQUksQ0FBQztJQXdJM0IsQ0FBQztJQXRJRzs7O09BR0c7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLElBQVk7UUFDNUIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxJQUFBLHFCQUFVLEVBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEIsSUFBSTtnQkFDQSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUEsdUJBQVksRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDNUM7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQzthQUN2QjtTQUNKO2FBQU07WUFDSCxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztTQUN2QjtRQUVELFNBQVM7UUFDVCxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxLQUFLLElBQUksSUFBSSxJQUFJLE9BQU8sRUFBRTtnQkFDdEIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dC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QUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUM3QjtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNOO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7QUFsSkQsOENBa0pDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0Isa0JBQWtCLENBQUMsZUFBdUI7SUFDdEQsT0FBTyxhQUFhLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2hELENBQUM7QUFGRCxnREFFQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgZXhpc3RzU3luYywgcmVhZEpTT05TeW5jLCBvdXRwdXRKU09OU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcblxuLy8g5YWz6IGU5oCnIG1hcO+8jOS4gOS4qui1hOa6kOabtOaUueWQjumcgOimgemAmuefpeS+nei1lui/meS4qui1hOa6kOeahOWFtuS7lui1hOa6kFxuLy8g6L+Z6YeM6K6w5b2V55qE5bCx5piv5L6d6LWW5p+Q5Liq6LWE5rqQ55qE5YW25LuW6LWE5rqQ5YiX6KGoXG5jb25zdCBhc3NvY2lhdGVkTWFwOiB7W2luZGV4OiBzdHJpbmddOiBzdHJpbmdbXX0gPSB7fTtcblxuLyoqXG4gKiDotYTmupDlhbPogZTku6Xlj4rkvp3otZblhbPns7vliJfooahcbiAqIOmDqOWIhuaVsOaNrumcgOimgeWbuuWMluWIsOehrOebmOS4ilxuICovXG5leHBvcnQgY2xhc3MgRGVwZW5kZW5jeU1hbmFnZXIge1xuXG4gICAgLy8g5Zu65YyW5pWw5o2u55qE5L+d5a2Y6Lev5b6EXG4gICAgZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgLy8g5L6d6LWW5YiX6KGo77yM5LiA5Liq5a+56LGh5L6d6LWW55qE5omA5pyJ5a+56LGh55qE5ZCN5a2X5pWw57uEXG4gICAgLy8geyB1dWlkOiB7ICdpZCc6IFtdIH0sIHVybDogeyAnZGI6Ly90ZXN0LzEuanNvbic6IFtdIH0sIHBhdGg6IHsgJy9Vc2Vycy94eHgnOiBbXSB9IH1cbiAgICBkZXBlbmRNYXA6IHtbdHlwZTogc3RyaW5nXTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmdbXSB9fSA9IHt9O1xuXG4gICAgLy8g5L+d5a2Y5L2/55So55qEIHRpbWVyXG4gICAgX3NhdmVUaW1lcjogYW55ID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIOiuvue9rueUqOS6juiusOW9leeahCBqc29uIOaWh+S7tlxuICAgICAqIEBwYXJhbSBqc29uIFxuICAgICAqL1xuICAgIGFzeW5jIHNldFJlY29yZEpTT04oanNvbjogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZmlsZSA9IGpzb247XG4gICAgICAgIGlmIChleGlzdHNTeW5jKGpzb24pKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVwZW5kTWFwID0gcmVhZEpTT05TeW5jKHRoaXMuZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGVwZW5kTWFwID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmRlcGVuZE1hcCA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6KGl5YWo5YWz6IGU5YiX6KGoXG4gICAgICAgIGZvciAobGV0IHR5cGUgaW4gdGhpcy5kZXBlbmRNYXApIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGVNYXAgPSB0aGlzLmRlcGVuZE1hcFt0eXBlXTtcbiAgICAgICAgICAgIGZvciAobGV0IHBhdGggaW4gdHlwZU1hcCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFycmF5ID0gdHlwZU1hcFtwYXRoXTtcbiAgICAgICAgICAgICAgICBhcnJheS5mb3JFYWNoKCh1cmxPclBhdGhPclVVSUQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NpYXRlZE1hcFt1cmxPclBhdGhPclVVSURdID0gYXNzb2NpYXRlZE1hcFt1cmxPclBhdGhPclVVSURdIHx8IFtdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXNzb2NpYXRlZE1hcFt1cmxPclBhdGhPclVVSURdLmluZGV4T2YocGF0aCkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXNzb2NpYXRlZE1hcFt1cmxPclBhdGhPclVVSURdLnB1c2gocGF0aCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOW7tui/n+S/neWtmOS+nei1luaWh+S7tlxuICAgICAqL1xuICAgIHNhdmUoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9zYXZlVGltZXIpO1xuICAgICAgICB0aGlzLl9zYXZlVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZUltbWVkaWF0ZSgpO1xuICAgICAgICB9LCA0MDApO1xuICAgIH1cblxuICAgIC8qXG4gICAgICog56uL5Y2z5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZUltbWVkaWF0ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuZmlsZSAmJiBvdXRwdXRKU09OU3luYyh0aGlzLmZpbGUsIHRoaXMuZGVwZW5kTWFwLCB7IHNwYWNlczogMiB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDorrDlvZXkuIDkuKrotYTmupDkvp3otZbnmoTmiYDmnInotYTmupDliJfooahcbiAgICAgKiDlhYHorrjkvKDlhaUgdXJs44CBdXVpZOOAgXBhdGgg5LiJ56eN5L6d6LWW55qE5qC85byPXG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICogQHBhcmFtIGRlcGVuZE5hbWVzIFxuICAgICAqL1xuICAgIGFkZCh0eXBlOiBzdHJpbmcsIGtleTogc3RyaW5nLCBkZXBlbmRzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgICAgICBjb25zdCB0eXBlTWFwID0gdGhpcy5kZXBlbmRNYXBbdHlwZV0gPSB0aGlzLmRlcGVuZE1hcFt0eXBlXSB8fCB7fTtcblxuICAgICAgICBjb25zdCBhcnJheSA9IHR5cGVNYXBba2V5XSA9IHR5cGVNYXBba2V5XSB8fCBbXTtcblxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGVwZW5kcykpIHtcbiAgICAgICAgICAgIGRlcGVuZHMgPSBbZGVwZW5kc107XG4gICAgICAgIH1cbiAgICAgICAgZGVwZW5kcy5mb3JFYWNoKChkZXBlbmQpID0+IHtcbiAgICAgICAgICAgIGlmIChkZXBlbmQgJiYgYXJyYXkuaW5kZXhPZihkZXBlbmQpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g6K6w5b2V5Yiw5L6d6LWW5YiX6KGoXG4gICAgICAgICAgICBhcnJheS5wdXNoKGRlcGVuZCk7XG5cbiAgICAgICAgICAgIC8vIOiusOW9leWIsOWFs+iBlOWIl+ihqFxuICAgICAgICAgICAgY29uc3QgYXNzb2NpYXRlZCA9IGFzc29jaWF0ZWRNYXBbZGVwZW5kXSA9IGFzc29jaWF0ZWRNYXBbZGVwZW5kXSB8fCBbXTtcbiAgICAgICAgICAgIGlmIChhc3NvY2lhdGVkLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICBhc3NvY2lhdGVkLnB1c2goa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOa4heepuuS4gOS4qui1hOa6kOeahOS+nei1luiusOW9lVxuICAgICAqIEBwYXJhbSBuYW1lIFxuICAgICAqL1xuICAgIHJlbW92ZSh0eXBlOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5kZXBlbmRNYXBbdHlwZV0gfHwgIXRoaXMuZGVwZW5kTWFwW3R5cGVdW2tleV0pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWIoOmZpOS+nei1luWIl+ihqFxuICAgICAgICB0aGlzLmRlcGVuZE1hcFt0eXBlXVtrZXldLmZvckVhY2goKHN0cikgPT4ge1xuICAgICAgICAgICAgY29uc3QgYXJyYXkgPSBhc3NvY2lhdGVkTWFwW3N0cl07XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGFycmF5LmluZGV4T2Yoa2V5KTtcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBhc3NvY2lhdGVkTWFwW3N0cl07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmRlcGVuZE1hcFt0eXBlXVtrZXldO1xuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDplIDmr4HkuIDkuKrkvp3otZbnrqHnkIblmajlrp7kvotcbiAgICAgKiBAcGFyYW0gbWFuYWdlciBcbiAgICAgKi9cbiAgICBkZXN0cm95KCkge1xuICAgICAgICAvLyDlsIbnrqHnkIblmajorrDlvZXnmoTmiYDmnInmlbDmja7ku47lhajlsYDnvJPlrZjlhoXliKDpmaRcbiAgICAgICAgLy8g5L2G5LiN5riF6Zmk57yT5a2YIGpzb27vvIzlm6DkuLrkuYvlkI7ov5jlj6/og73pnIDopoHkvb/nlKhcbiAgICBcbiAgICAgICAgZm9yIChsZXQgdHlwZSBpbiB0aGlzLmRlcGVuZE1hcCkge1xuICAgICAgICAgICAgY29uc3QgdHlwZU1hcCA9IHRoaXMuZGVwZW5kTWFwW3R5cGVdO1xuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHR5cGVNYXApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJheSA9IHR5cGVNYXBba2V5XTtcbiAgICAgICAgICAgICAgICBhcnJheS5mb3JFYWNoKChzdHIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhc3NvY2lhdGVkTWFwW3N0cl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IGFzc29jaWF0ZWRNYXBbc3RyXS5pbmRleE9mKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc29jaWF0ZWRNYXBbc3RyXS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhc3NvY2lhdGVkTWFwW3N0cl0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgYXNzb2NpYXRlZE1hcFtzdHJdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICog6I635Y+W6KKr5b2x5ZON55qE6LWE5rqQ5YiX6KGoXG4gKiBAcGFyYW0gdXJsT3JQYXRoT3JVVUlEIFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXNzb2NpYXRlZEZpbGVzKHVybE9yUGF0aE9yVVVJRDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGFzc29jaWF0ZWRNYXBbdXJsT3JQYXRoT3JVVUlEXSB8fCBbXTtcbn0iXX0=