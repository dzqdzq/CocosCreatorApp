'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAssociatedFiles = exports.DependencyManager = void 0;
const fs_extra_1 = require("fs-extra");
// 关联性 map，一个资源更改后需要通知依赖这个资源的其他资源
// 这里记录的就是依赖某个资源的其他资源列表
const associatedMap = {};
/**
 * 资源关联以及依赖关系列表
 * 部分数据需要固化到硬盘上
 */
class DependencyManager {
    constructor(customConsole) {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        // { uuid: { 'id': [] }, url: { 'db://test/1.json': [] }, path: { '/Users/xxx': [] } }
        this.dependMap = {};
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.dependMap = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                this.console.error(error);
                this.dependMap = {};
            }
        }
        else {
            this.dependMap = {};
        }
        // 补全关联列表
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let path in typeMap) {
                const array = typeMap[path];
                array.forEach((urlOrPathOrUUID) => {
                    associatedMap[urlOrPathOrUUID] = associatedMap[urlOrPathOrUUID] || [];
                    if (associatedMap[urlOrPathOrUUID].indexOf(path) !== -1) {
                        return;
                    }
                    associatedMap[urlOrPathOrUUID].push(path);
                });
            }
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.dependMap, { spaces: 2 });
    }
    /**
     * 记录一个资源依赖的所有资源列表
     * 允许传入 url、uuid、path 三种依赖的格式
     * @param path
     * @param dependNames
     */
    add(type, key, depends) {
        const typeMap = this.dependMap[type] = this.dependMap[type] || {};
        const array = typeMap[key] = typeMap[key] || [];
        if (!Array.isArray(depends)) {
            depends = [depends];
        }
        depends.forEach((depend) => {
            if (depend && array.indexOf(depend) !== -1) {
                return;
            }
            // 记录到依赖列表
            array.push(depend);
            // 记录到关联列表
            const associated = associatedMap[depend] = associatedMap[depend] || [];
            if (associated.indexOf(key) === -1) {
                associated.push(key);
            }
        });
        this.save();
    }
    /**
     * 清空一个资源的依赖记录
     * @param name
     */
    remove(type, key) {
        if (!this.dependMap[type] || !this.dependMap[type][key]) {
            return;
        }
        // 删除依赖列表
        this.dependMap[type][key].forEach((str) => {
            const array = associatedMap[str];
            const index = array.indexOf(key);
            if (index !== -1) {
                array.splice(index, 1);
            }
            if (array.length === 0) {
                delete associatedMap[str];
            }
        });
        delete this.dependMap[type][key];
        this.save();
    }
    /**
     * 销毁一个依赖管理器实例
     * @param manager
     */
    destroy() {
        // 将管理器记录的所有数据从全局缓存内删除
        // 但不清除缓存 json，因为之后还可能需要使用
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let key in typeMap) {
                const array = typeMap[key];
                array.forEach((str) => {
                    if (!associatedMap[str]) {
                        return;
                    }
                    const index = associatedMap[str].indexOf(key);
                    if (index !== -1) {
                        associatedMap[str].splice(index, 1);
                    }
                    if (associatedMap[str].length === 0) {
                        delete associatedMap[str];
                    }
                });
            }
        }
    }
}
exports.DependencyManager = DependencyManager;
/**
 * 获取被影响的资源列表
 * @param urlOrPathOrUUID
 */
function getAssociatedFiles(urlOrPathOrUUID) {
    return associatedMap[urlOrPathOrUUID] || [];
}
exports.getAssociatedFiles = getAssociatedFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwZW5kZW5jeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RlcGVuZGVuY3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBb0U7QUFHcEUsaUNBQWlDO0FBQ2pDLHVCQUF1QjtBQUN2QixNQUFNLGFBQWEsR0FBa0MsRUFBRSxDQUFDO0FBRXhEOzs7R0FHRztBQUNILE1BQWEsaUJBQWlCO0lBWTFCLFlBQVksYUFBNEI7UUFQeEMsd0JBQXdCO1FBQ3hCLHNGQUFzRjtRQUN0RixjQUFTLEdBQW9ELEVBQUUsQ0FBQztRQUVoRSxjQUFjO1FBQ2QsZUFBVSxHQUFRLElBQUksQ0FBQztRQUduQixJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsSUFBSSxPQUFPLENBQUM7SUFDNUMsQ0FBQztJQUNEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBWTtRQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsRUFBRTtZQUNsQixJQUFJO2dCQUNBLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBQSx1QkFBWSxFQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM1QztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQzthQUN2QjtTQUNKO2FBQU07WUFDSCxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztTQUN2QjtRQUVELFNBQVM7UUFDVCxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxLQUFLLElBQUksSUFBSSxJQUFJLE9BQU8sRUFBRTtnQkFDdEIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM1QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQUU7b0JBQzlCLGFBQWEsQ0FBQyxlQUFlLENBQUMsR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUN0RSxJQUFJLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ3JELE9BQU87cUJBQ1Y7b0JBQ0QsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDOUMsQ0FBQyxDQUFDLENBQUM7YUFDTjtTQUNKO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNBLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUEseUJBQWMsRUFBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxHQUFHLENBQUMsSUFBWSxFQUFFLEdBQVcsRUFBRSxPQUEwQjtRQUNyRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWxFLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWhELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3pCLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3ZCO1FBQ0QsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ3ZCLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ3hDLE9BQU87YUFDVjtZQUVELFVBQVU7WUFDVixLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRW5CLFVBQVU7WUFDVixNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN2RSxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDeEI7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNyRCxPQUFPO1NBQ1Y7UUFFRCxTQUFTO1FBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN0QyxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqQyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDZCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQzthQUMxQjtZQUNELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3BCLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzdCO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxPQUFPO1FBQ0gsc0JBQXNCO1FBQ3RCLDBCQUEwQjtRQUUxQixLQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxLQUFLLElBQUksR0FBRyxJQUFJLE9BQU8sRUFBRTtnQkFDckIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMzQixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7b0JBQ2xCLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUU7d0JBQ3JCLE9BQU87cUJBQ1Y7b0JBQ0QsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDOUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ2QsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7cUJBQ3ZDO29CQUNELElBQUksYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7d0JBQ2pDLE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUM3QjtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNOO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7QUFySkQsOENBcUpDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0Isa0JBQWtCLENBQUMsZUFBdUI7SUFDdEQsT0FBTyxhQUFhLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2hELENBQUM7QUFGRCxnREFFQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgZXhpc3RzU3luYywgcmVhZEpTT05TeW5jLCBvdXRwdXRKU09OU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IEN1c3RvbUNvbnNvbGUgfSBmcm9tICcuL2NvbnNvbGUnO1xuXG4vLyDlhbPogZTmgKcgbWFw77yM5LiA5Liq6LWE5rqQ5pu05pS55ZCO6ZyA6KaB6YCa55+l5L6d6LWW6L+Z5Liq6LWE5rqQ55qE5YW25LuW6LWE5rqQXG4vLyDov5nph4zorrDlvZXnmoTlsLHmmK/kvp3otZbmn5DkuKrotYTmupDnmoTlhbbku5botYTmupDliJfooahcbmNvbnN0IGFzc29jaWF0ZWRNYXA6IHsgW2luZGV4OiBzdHJpbmddOiBzdHJpbmdbXSB9ID0ge307XG5cbi8qKlxuICog6LWE5rqQ5YWz6IGU5Lul5Y+K5L6d6LWW5YWz57O75YiX6KGoXG4gKiDpg6jliIbmlbDmja7pnIDopoHlm7rljJbliLDnoaznm5jkuIpcbiAqL1xuZXhwb3J0IGNsYXNzIERlcGVuZGVuY3lNYW5hZ2VyIHtcblxuICAgIC8vIOWbuuWMluaVsOaNrueahOS/neWtmOi3r+W+hFxuICAgIGZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIC8vIOS+nei1luWIl+ihqO+8jOS4gOS4quWvueixoeS+nei1lueahOaJgOacieWvueixoeeahOWQjeWtl+aVsOe7hFxuICAgIC8vIHsgdXVpZDogeyAnaWQnOiBbXSB9LCB1cmw6IHsgJ2RiOi8vdGVzdC8xLmpzb24nOiBbXSB9LCBwYXRoOiB7ICcvVXNlcnMveHh4JzogW10gfSB9XG4gICAgZGVwZW5kTWFwOiB7IFt0eXBlOiBzdHJpbmddOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ1tdIH0gfSA9IHt9O1xuXG4gICAgLy8g5L+d5a2Y5L2/55So55qEIHRpbWVyXG4gICAgX3NhdmVUaW1lcjogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIGNvbnNvbGU6IEN1c3RvbUNvbnNvbGU7XG4gICAgY29uc3RydWN0b3IoY3VzdG9tQ29uc29sZTogQ3VzdG9tQ29uc29sZSkge1xuICAgICAgICB0aGlzLmNvbnNvbGUgPSBjdXN0b21Db25zb2xlIHx8IGNvbnNvbGU7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOiuvue9rueUqOS6juiusOW9leeahCBqc29uIOaWh+S7tlxuICAgICAqIEBwYXJhbSBqc29uIFxuICAgICAqL1xuICAgIGFzeW5jIHNldFJlY29yZEpTT04oanNvbjogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZmlsZSA9IGpzb247XG4gICAgICAgIGlmIChleGlzdHNTeW5jKGpzb24pKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVwZW5kTWFwID0gcmVhZEpTT05TeW5jKHRoaXMuZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXBlbmRNYXAgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGVwZW5kTWFwID0ge307XG4gICAgICAgIH1cblxuICAgICAgICAvLyDooaXlhajlhbPogZTliJfooahcbiAgICAgICAgZm9yIChsZXQgdHlwZSBpbiB0aGlzLmRlcGVuZE1hcCkge1xuICAgICAgICAgICAgY29uc3QgdHlwZU1hcCA9IHRoaXMuZGVwZW5kTWFwW3R5cGVdO1xuICAgICAgICAgICAgZm9yIChsZXQgcGF0aCBpbiB0eXBlTWFwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyYXkgPSB0eXBlTWFwW3BhdGhdO1xuICAgICAgICAgICAgICAgIGFycmF5LmZvckVhY2goKHVybE9yUGF0aE9yVVVJRCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0gPSBhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0gfHwgW107XG4gICAgICAgICAgICAgICAgICAgIGlmIChhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0uaW5kZXhPZihwYXRoKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0ucHVzaChwYXRoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qXG4gICAgICog5bu26L+f5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zYXZlSW1tZWRpYXRlKCk7XG4gICAgICAgIH0sIDQwMCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiDnq4vljbPkv53lrZjkvp3otZbmlofku7ZcbiAgICAgKi9cbiAgICBzYXZlSW1tZWRpYXRlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5maWxlICYmIG91dHB1dEpTT05TeW5jKHRoaXMuZmlsZSwgdGhpcy5kZXBlbmRNYXAsIHsgc3BhY2VzOiAyIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOiusOW9leS4gOS4qui1hOa6kOS+nei1lueahOaJgOaciei1hOa6kOWIl+ihqFxuICAgICAqIOWFgeiuuOS8oOWFpSB1cmzjgIF1dWlk44CBcGF0aCDkuInnp43kvp3otZbnmoTmoLzlvI9cbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKiBAcGFyYW0gZGVwZW5kTmFtZXMgXG4gICAgICovXG4gICAgYWRkKHR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcsIGRlcGVuZHM6IHN0cmluZyB8IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IHR5cGVNYXAgPSB0aGlzLmRlcGVuZE1hcFt0eXBlXSA9IHRoaXMuZGVwZW5kTWFwW3R5cGVdIHx8IHt9O1xuXG4gICAgICAgIGNvbnN0IGFycmF5ID0gdHlwZU1hcFtrZXldID0gdHlwZU1hcFtrZXldIHx8IFtdO1xuXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkZXBlbmRzKSkge1xuICAgICAgICAgICAgZGVwZW5kcyA9IFtkZXBlbmRzXTtcbiAgICAgICAgfVxuICAgICAgICBkZXBlbmRzLmZvckVhY2goKGRlcGVuZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGRlcGVuZCAmJiBhcnJheS5pbmRleE9mKGRlcGVuZCkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDorrDlvZXliLDkvp3otZbliJfooahcbiAgICAgICAgICAgIGFycmF5LnB1c2goZGVwZW5kKTtcblxuICAgICAgICAgICAgLy8g6K6w5b2V5Yiw5YWz6IGU5YiX6KGoXG4gICAgICAgICAgICBjb25zdCBhc3NvY2lhdGVkID0gYXNzb2NpYXRlZE1hcFtkZXBlbmRdID0gYXNzb2NpYXRlZE1hcFtkZXBlbmRdIHx8IFtdO1xuICAgICAgICAgICAgaWYgKGFzc29jaWF0ZWQuaW5kZXhPZihrZXkpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIGFzc29jaWF0ZWQucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5riF56m65LiA5Liq6LWE5rqQ55qE5L6d6LWW6K6w5b2VXG4gICAgICogQHBhcmFtIG5hbWUgXG4gICAgICovXG4gICAgcmVtb3ZlKHR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLmRlcGVuZE1hcFt0eXBlXSB8fCAhdGhpcy5kZXBlbmRNYXBbdHlwZV1ba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5Yig6Zmk5L6d6LWW5YiX6KGoXG4gICAgICAgIHRoaXMuZGVwZW5kTWFwW3R5cGVdW2tleV0uZm9yRWFjaCgoc3RyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhcnJheSA9IGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gYXJyYXkuaW5kZXhPZihrZXkpO1xuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuZGVwZW5kTWFwW3R5cGVdW2tleV07XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmUgOavgeS4gOS4quS+nei1lueuoeeQhuWZqOWunuS+i1xuICAgICAqIEBwYXJhbSBtYW5hZ2VyIFxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIC8vIOWwhueuoeeQhuWZqOiusOW9leeahOaJgOacieaVsOaNruS7juWFqOWxgOe8k+WtmOWGheWIoOmZpFxuICAgICAgICAvLyDkvYbkuI3muIXpmaTnvJPlrZgganNvbu+8jOWboOS4uuS5i+WQjui/mOWPr+iDvemcgOimgeS9v+eUqFxuXG4gICAgICAgIGZvciAobGV0IHR5cGUgaW4gdGhpcy5kZXBlbmRNYXApIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGVNYXAgPSB0aGlzLmRlcGVuZE1hcFt0eXBlXTtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0eXBlTWFwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyYXkgPSB0eXBlTWFwW2tleV07XG4gICAgICAgICAgICAgICAgYXJyYXkuZm9yRWFjaCgoc3RyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYXNzb2NpYXRlZE1hcFtzdHJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBhc3NvY2lhdGVkTWFwW3N0cl0uaW5kZXhPZihrZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NvY2lhdGVkTWFwW3N0cl0uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYXNzb2NpYXRlZE1hcFtzdHJdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOiOt+WPluiiq+W9seWTjeeahOi1hOa6kOWIl+ihqFxuICogQHBhcmFtIHVybE9yUGF0aE9yVVVJRCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEFzc29jaWF0ZWRGaWxlcyh1cmxPclBhdGhPclVVSUQ6IHN0cmluZykge1xuICAgIHJldHVybiBhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0gfHwgW107XG59Il19