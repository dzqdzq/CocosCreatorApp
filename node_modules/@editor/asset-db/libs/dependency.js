'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAssociatedFiles = exports.DependencyManager = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const migrator_1 = require("./migrator");
const migrations = [{
        version: '1.0.0',
        migrate: async (cacheInfo, manager) => {
            const recordInfo = {
                data: {
                    path: {},
                    uuid: {},
                },
                version: DependencyManager.version,
            };
            Object.keys(cacheInfo.path).forEach((path) => {
                recordInfo.data.path[(0, path_1.relative)(manager.pathRoot, path)] = cacheInfo.path[path].map((subPath => (0, path_1.relative)(manager.pathRoot, subPath)));
            });
            Object.keys(cacheInfo.uuid).forEach((path) => {
                recordInfo.data.uuid[(0, path_1.relative)(manager.pathRoot, path)] = cacheInfo.uuid[path];
            });
            return recordInfo;
        }
    }];
function getDefaultRecordInfo() {
    return {
        data: {
            path: {},
            uuid: {},
        },
        version: DependencyManager.version,
    };
}
// 关联性 map，一个资源更改后需要通知依赖这个资源的其他资源
// 这里记录的就是依赖某个资源的其他资源列表
const associatedMap = {};
/**
 * 资源关联以及依赖关系列表，主要影响导入队列以及是否需要重新导入
 * 部分数据需要固化到硬盘上
 */
class DependencyManager {
    constructor(customConsole, pathRoot) {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        // { uuid: { 'id': [] }, url: { 'db://test/1.json': [] }, path: { '/Users/xxx': [] } }
        this.dependMap = getDefaultRecordInfo().data;
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
        this.pathRoot = pathRoot;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(path) {
        this.file = path;
        try {
            await this._restoreCache(path);
        }
        catch (error) {
            this.console.warn(error);
        }
    }
    async _restoreCache(path) {
        const cacheInfo = await this.readRecordJSON(path);
        if (!cacheInfo) {
            return;
        }
        // 处理缓存数据
        const { path: pathRecord, uuid: uuidRecord } = this.dependMap;
        Object.keys(cacheInfo.data.path).forEach((relativePath) => {
            pathRecord[(0, path_1.join)(this.pathRoot, relativePath)] = cacheInfo.data.path[relativePath].map((subPath => (0, path_1.join)(this.pathRoot, subPath)));
        });
        Object.keys(cacheInfo.data.uuid).forEach((relativePath) => {
            uuidRecord[(0, path_1.join)(this.pathRoot, relativePath)] = cacheInfo.data.uuid[relativePath];
        });
        // 补全关联列表
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let path in typeMap) {
                const array = typeMap[path];
                array.forEach((urlOrPathOrUUID) => {
                    associatedMap[urlOrPathOrUUID] = associatedMap[urlOrPathOrUUID] || [];
                    if (associatedMap[urlOrPathOrUUID].indexOf(path) !== -1) {
                        return;
                    }
                    associatedMap[urlOrPathOrUUID].push(path);
                });
            }
        }
    }
    async readRecordJSON(path) {
        if (!(0, fs_extra_1.existsSync)(path)) {
            return;
        }
        try {
            const cacheInfo = (0, fs_extra_1.readJSONSync)(path);
            const version = cacheInfo.version ? cacheInfo.version : '0.0.0';
            const migrator = new migrator_1.Migrator(migrations, version, {
                onError: (error, stage, data, ...args) => {
                    this.console.warn(`Migrate error in dependencyManager`);
                    this.console.warn(error);
                }
            });
            return await migrator.run(cacheInfo, DependencyManager.version, [this]);
        }
        catch (error) {
            this.console.error(error);
            return;
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        if (this.file) {
            const recordInfo = getDefaultRecordInfo();
            // 存储到文件系统里需要记录相对路径
            const { path: pathRecord, uuid: uuidRecord } = this.dependMap;
            Object.keys(pathRecord).forEach((path) => {
                recordInfo.data.path[(0, path_1.relative)(this.pathRoot, path)] = pathRecord[path].map((file) => (0, path_1.relative)(this.pathRoot, file));
            });
            Object.keys(uuidRecord).forEach((path) => {
                recordInfo.data.uuid[(0, path_1.relative)(this.pathRoot, path)] = uuidRecord[path];
            });
            (0, fs_extra_1.outputJSONSync)(this.file, recordInfo, { spaces: 2 });
        }
    }
    /**
     * 记录一个资源依赖的所有资源列表
     * 允许传入 url、uuid、path 三种依赖的格式
     * @param path
     * @param dependNames
     */
    add(type, key, depends) {
        const typeMap = this.dependMap[type] = this.dependMap[type] || {};
        const array = typeMap[key] = typeMap[key] || [];
        if (!Array.isArray(depends)) {
            depends = [depends];
        }
        depends.forEach((depend) => {
            if (depend && array.indexOf(depend) !== -1) {
                return;
            }
            // 记录到依赖列表
            array.push(depend);
            // 记录到关联列表
            const associated = associatedMap[depend] = associatedMap[depend] || [];
            if (associated.indexOf(key) === -1) {
                associated.push(key);
            }
        });
        this.save();
    }
    /**
     * 清空一个资源的依赖记录
     * @param name
     */
    remove(type, key) {
        if (!this.dependMap[type] || !this.dependMap[type][key]) {
            return;
        }
        // 删除依赖列表
        this.dependMap[type][key].forEach((str) => {
            const array = associatedMap[str];
            const index = array.indexOf(key);
            if (index !== -1) {
                array.splice(index, 1);
            }
            if (array.length === 0) {
                delete associatedMap[str];
            }
        });
        delete this.dependMap[type][key];
        this.save();
    }
    /**
     * 销毁一个依赖管理器实例
     * @param manager
     */
    destroy() {
        // 将管理器记录的所有数据从全局缓存内删除
        // 但不清除缓存 json，因为之后还可能需要使用
        for (let type in this.dependMap) {
            const typeMap = this.dependMap[type];
            for (let key in typeMap) {
                const array = typeMap[key];
                array.forEach((str) => {
                    if (!associatedMap[str]) {
                        return;
                    }
                    const index = associatedMap[str].indexOf(key);
                    if (index !== -1) {
                        associatedMap[str].splice(index, 1);
                    }
                    if (associatedMap[str].length === 0) {
                        delete associatedMap[str];
                    }
                });
            }
        }
    }
}
exports.DependencyManager = DependencyManager;
DependencyManager.version = '1.0.0';
/**
 * 获取被影响的资源列表
 * @param urlOrPathOrUUID
 */
function getAssociatedFiles(urlOrPathOrUUID) {
    return associatedMap[urlOrPathOrUUID] || [];
}
exports.getAssociatedFiles = getAssociatedFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwZW5kZW5jeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RlcGVuZGVuY3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBb0U7QUFDcEUsK0JBQXNDO0FBRXRDLHlDQUErQztBQVcvQyxNQUFNLFVBQVUsR0FBbUIsQ0FBQztRQUNoQyxPQUFPLEVBQUUsT0FBTztRQUNoQixPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQW9CLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDN0MsTUFBTSxVQUFVLEdBQUc7Z0JBQ2YsSUFBSSxFQUFFO29CQUNGLElBQUksRUFBRSxFQUFFO29CQUNSLElBQUksRUFBRSxFQUFFO2lCQUNYO2dCQUNELE9BQU8sRUFBRSxpQkFBaUIsQ0FBQyxPQUFPO2FBQ3JDLENBQUM7WUFDRixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDekMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBQSxlQUFRLEVBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFBLGVBQVEsRUFBQyxPQUFPLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4SSxDQUFDLENBQUMsQ0FBQTtZQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUN6QyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFBLGVBQVEsRUFBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcs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QUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzNCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtvQkFDbEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDckIsT0FBTztxQkFDVjtvQkFDRCxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUM5QyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTt3QkFDZCxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztxQkFDdkM7b0JBQ0QsSUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTt3QkFDakMsT0FBTyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQzdCO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2FBQ047U0FDSjtJQUNMLENBQUM7O0FBaE1MLDhDQWlNQztBQS9MVSx5QkFBTyxHQUFXLE9BQU8sQUFBbEIsQ0FBbUI7QUFpTXJDOzs7R0FHRztBQUNILFNBQWdCLGtCQUFrQixDQUFDLGVBQXVCO0lBQ3RELE9BQU8sYUFBYSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNoRCxDQUFDO0FBRkQsZ0RBRUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCByZWxhdGl2ZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQ3VzdG9tQ29uc29sZSB9IGZyb20gJy4vY29uc29sZSc7XG5pbXBvcnQgeyBNaWdyYXRlLCBNaWdyYXRvciB9IGZyb20gJy4vbWlncmF0b3InO1xuXG5pbnRlcmZhY2UgRGVwZW5kTWFwIHtcbiAgICBwYXRoOiB7IFtwYXRoOiBzdHJpbmddOiBzdHJpbmdbXSB9O1xuICAgIHV1aWQ6IHsgW3V1aWQ6IHN0cmluZ106IHN0cmluZ1tdIH07XG59XG5pbnRlcmZhY2UgUmVjb3JkSW5mb01hcCB7XG4gICAgZGF0YTogRGVwZW5kTWFwXG4gICAgdmVyc2lvbjogc3RyaW5nO1xufVxuXG5jb25zdCBtaWdyYXRpb25zOiBNaWdyYXRlPGFueT5bXSA9IFt7XG4gICAgdmVyc2lvbjogJzEuMC4wJyxcbiAgICBtaWdyYXRlOiBhc3luYyAoY2FjaGVJbmZvOiBEZXBlbmRNYXAsIG1hbmFnZXIpID0+IHtcbiAgICAgICAgY29uc3QgcmVjb3JkSW5mbyA9IHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBwYXRoOiB7fSxcbiAgICAgICAgICAgICAgICB1dWlkOiB7fSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB2ZXJzaW9uOiBEZXBlbmRlbmN5TWFuYWdlci52ZXJzaW9uLFxuICAgICAgICB9O1xuICAgICAgICBPYmplY3Qua2V5cyhjYWNoZUluZm8ucGF0aCkuZm9yRWFjaCgocGF0aCkgPT4ge1xuICAgICAgICAgICAgcmVjb3JkSW5mby5kYXRhLnBhdGhbcmVsYXRpdmUobWFuYWdlci5wYXRoUm9vdCwgcGF0aCldID0gY2FjaGVJbmZvLnBhdGhbcGF0aF0ubWFwKChzdWJQYXRoID0+IHJlbGF0aXZlKG1hbmFnZXIucGF0aFJvb3QsIHN1YlBhdGgpKSk7XG4gICAgICAgIH0pXG4gICAgICAgIE9iamVjdC5rZXlzKGNhY2hlSW5mby51dWlkKS5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICAgICAgICByZWNvcmRJbmZvLmRhdGEudXVpZFtyZWxhdGl2ZShtYW5hZ2VyLnBhdGhSb290LCBwYXRoKV0gPSBjYWNoZUluZm8udXVpZFtwYXRoXTtcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIHJlY29yZEluZm87XG4gICAgfVxufV07XG5mdW5jdGlvbiBnZXREZWZhdWx0UmVjb3JkSW5mbygpOiBSZWNvcmRJbmZvTWFwIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBwYXRoOiB7fSxcbiAgICAgICAgICAgIHV1aWQ6IHt9LFxuICAgICAgICB9LFxuICAgICAgICB2ZXJzaW9uOiBEZXBlbmRlbmN5TWFuYWdlci52ZXJzaW9uLFxuICAgIH07XG59XG5cbi8vIOWFs+iBlOaApyBtYXDvvIzkuIDkuKrotYTmupDmm7TmlLnlkI7pnIDopoHpgJrnn6Xkvp3otZbov5nkuKrotYTmupDnmoTlhbbku5botYTmupBcbi8vIOi/memHjOiusOW9leeahOWwseaYr+S+nei1luafkOS4qui1hOa6kOeahOWFtuS7lui1hOa6kOWIl+ihqFxuY29uc3QgYXNzb2NpYXRlZE1hcDogeyBbaW5kZXg6IHN0cmluZ106IHN0cmluZ1tdIH0gPSB7fTtcblxuLyoqXG4gKiDotYTmupDlhbPogZTku6Xlj4rkvp3otZblhbPns7vliJfooajvvIzkuLvopoHlvbHlk43lr7zlhaXpmJ/liJfku6Xlj4rmmK/lkKbpnIDopoHph43mlrDlr7zlhaVcbiAqIOmDqOWIhuaVsOaNrumcgOimgeWbuuWMluWIsOehrOebmOS4ilxuICovXG5leHBvcnQgY2xhc3MgRGVwZW5kZW5jeU1hbmFnZXIge1xuXG4gICAgc3RhdGljIHZlcnNpb246IHN0cmluZyA9ICcxLjAuMCc7XG5cbiAgICAvLyDlm7rljJbmlbDmja7nmoTkv53lrZjot6/lvoRcbiAgICBmaWxlPzogc3RyaW5nO1xuICAgIHBhdGhSb290OiBzdHJpbmc7XG5cbiAgICAvLyDkvp3otZbliJfooajvvIzkuIDkuKrlr7nosaHkvp3otZbnmoTmiYDmnInlr7nosaHnmoTlkI3lrZfmlbDnu4RcbiAgICAvLyB7IHV1aWQ6IHsgJ2lkJzogW10gfSwgdXJsOiB7ICdkYjovL3Rlc3QvMS5qc29uJzogW10gfSwgcGF0aDogeyAnL1VzZXJzL3h4eCc6IFtdIH0gfVxuICAgIGRlcGVuZE1hcDogRGVwZW5kTWFwID0gZ2V0RGVmYXVsdFJlY29yZEluZm8oKS5kYXRhO1xuXG4gICAgLy8g5L+d5a2Y5L2/55So55qEIHRpbWVyXG4gICAgX3NhdmVUaW1lcjogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIGNvbnNvbGU6IEN1c3RvbUNvbnNvbGU7XG4gICAgY29uc3RydWN0b3IoY3VzdG9tQ29uc29sZTogQ3VzdG9tQ29uc29sZSwgcGF0aFJvb3Q6IHN0cmluZykge1xuICAgICAgICB0aGlzLmNvbnNvbGUgPSBjdXN0b21Db25zb2xlIHx8IGNvbnNvbGU7XG4gICAgICAgIHRoaXMucGF0aFJvb3QgPSBwYXRoUm9vdDtcbiAgICB9XG4gICAgLyoqXG4gICAgICog6K6+572u55So5LqO6K6w5b2V55qEIGpzb24g5paH5Lu2XG4gICAgICogQHBhcmFtIGpzb24gXG4gICAgICovXG4gICAgYXN5bmMgc2V0UmVjb3JkSlNPTihwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWxlID0gcGF0aDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3RvcmVDYWNoZShwYXRoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX3Jlc3RvcmVDYWNoZShwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgY2FjaGVJbmZvID0gYXdhaXQgdGhpcy5yZWFkUmVjb3JkSlNPTihwYXRoKTtcbiAgICAgICAgaWYgKCFjYWNoZUluZm8pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyDlpITnkIbnvJPlrZjmlbDmja5cbiAgICAgICAgY29uc3QgeyBwYXRoOiBwYXRoUmVjb3JkLCB1dWlkOiB1dWlkUmVjb3JkIH0gPSB0aGlzLmRlcGVuZE1hcDtcbiAgICAgICAgT2JqZWN0LmtleXMoY2FjaGVJbmZvLmRhdGEucGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoKSA9PiB7XG4gICAgICAgICAgICBwYXRoUmVjb3JkW2pvaW4odGhpcy5wYXRoUm9vdCwgcmVsYXRpdmVQYXRoKV0gPSBjYWNoZUluZm8uZGF0YS5wYXRoW3JlbGF0aXZlUGF0aF0ubWFwKChzdWJQYXRoID0+IGpvaW4odGhpcy5wYXRoUm9vdCwgc3ViUGF0aCkpKTtcbiAgICAgICAgfSlcbiAgICAgICAgT2JqZWN0LmtleXMoY2FjaGVJbmZvLmRhdGEudXVpZCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoKSA9PiB7XG4gICAgICAgICAgICB1dWlkUmVjb3JkW2pvaW4odGhpcy5wYXRoUm9vdCwgcmVsYXRpdmVQYXRoKV0gPSBjYWNoZUluZm8uZGF0YS51dWlkW3JlbGF0aXZlUGF0aF07XG4gICAgICAgIH0pXG4gICAgICAgIC8vIOihpeWFqOWFs+iBlOWIl+ihqFxuICAgICAgICBmb3IgKGxldCB0eXBlIGluIHRoaXMuZGVwZW5kTWFwKSB7XG4gICAgICAgICAgICBjb25zdCB0eXBlTWFwID0gdGhpcy5kZXBlbmRNYXBbdHlwZV07XG4gICAgICAgICAgICBmb3IgKGxldCBwYXRoIGluIHR5cGVNYXApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJheSA9IHR5cGVNYXBbcGF0aF07XG4gICAgICAgICAgICAgICAgYXJyYXkuZm9yRWFjaCgodXJsT3JQYXRoT3JVVUlEKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFzc29jaWF0ZWRNYXBbdXJsT3JQYXRoT3JVVUlEXSA9IGFzc29jaWF0ZWRNYXBbdXJsT3JQYXRoT3JVVUlEXSB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc29jaWF0ZWRNYXBbdXJsT3JQYXRoT3JVVUlEXS5pbmRleE9mKHBhdGgpICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFzc29jaWF0ZWRNYXBbdXJsT3JQYXRoT3JVVUlEXS5wdXNoKHBhdGgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyByZWFkUmVjb3JkSlNPTihwYXRoOiBzdHJpbmcpOiBQcm9taXNlPFJlY29yZEluZm9NYXAgfCB1bmRlZmluZWQ+IHtcbiAgICAgICAgaWYgKCFleGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlSW5mbyA9IHJlYWRKU09OU3luYyhwYXRoKTtcbiAgICAgICAgICAgIGNvbnN0IHZlcnNpb24gPSBjYWNoZUluZm8udmVyc2lvbiA/IGNhY2hlSW5mby52ZXJzaW9uIDogJzAuMC4wJztcbiAgICAgICAgICAgIGNvbnN0IG1pZ3JhdG9yID0gbmV3IE1pZ3JhdG9yPFJlY29yZEluZm9NYXA+KG1pZ3JhdGlvbnMsIHZlcnNpb24sIHtcbiAgICAgICAgICAgICAgICBvbkVycm9yOiAoZXJyb3IsIHN0YWdlLCBkYXRhLCAuLi5hcmdzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGBNaWdyYXRlIGVycm9yIGluIGRlcGVuZGVuY3lNYW5hZ2VyYCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBtaWdyYXRvci5ydW4oY2FjaGVJbmZvLCBEZXBlbmRlbmN5TWFuYWdlci52ZXJzaW9uLCBbdGhpc10pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qXG4gICAgICog5bu26L+f5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zYXZlSW1tZWRpYXRlKCk7XG4gICAgICAgIH0sIDQwMCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiDnq4vljbPkv53lrZjkvp3otZbmlofku7ZcbiAgICAgKi9cbiAgICBzYXZlSW1tZWRpYXRlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgaWYgKHRoaXMuZmlsZSkge1xuICAgICAgICAgICAgY29uc3QgcmVjb3JkSW5mbyA9IGdldERlZmF1bHRSZWNvcmRJbmZvKCk7XG4gICAgICAgICAgICAvLyDlrZjlgqjliLDmlofku7bns7vnu5/ph4zpnIDopoHorrDlvZXnm7jlr7not6/lvoRcbiAgICAgICAgICAgIGNvbnN0IHsgcGF0aDogcGF0aFJlY29yZCwgdXVpZDogdXVpZFJlY29yZCB9ID0gdGhpcy5kZXBlbmRNYXA7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhwYXRoUmVjb3JkKS5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVjb3JkSW5mby5kYXRhLnBhdGhbcmVsYXRpdmUodGhpcy5wYXRoUm9vdCwgcGF0aCldID0gcGF0aFJlY29yZFtwYXRoXS5tYXAoKGZpbGUpID0+IHJlbGF0aXZlKHRoaXMucGF0aFJvb3QsIGZpbGUpKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBPYmplY3Qua2V5cyh1dWlkUmVjb3JkKS5mb3JFYWNoKChwYXRoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVjb3JkSW5mby5kYXRhLnV1aWRbcmVsYXRpdmUodGhpcy5wYXRoUm9vdCwgcGF0aCldID0gdXVpZFJlY29yZFtwYXRoXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb3V0cHV0SlNPTlN5bmModGhpcy5maWxlLCByZWNvcmRJbmZvLCB7IHNwYWNlczogMiB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOiusOW9leS4gOS4qui1hOa6kOS+nei1lueahOaJgOaciei1hOa6kOWIl+ihqFxuICAgICAqIOWFgeiuuOS8oOWFpSB1cmzjgIF1dWlk44CBcGF0aCDkuInnp43kvp3otZbnmoTmoLzlvI9cbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKiBAcGFyYW0gZGVwZW5kTmFtZXMgXG4gICAgICovXG4gICAgYWRkKHR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcsIGRlcGVuZHM6IHN0cmluZyB8IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IHR5cGVNYXAgPSB0aGlzLmRlcGVuZE1hcFt0eXBlXSA9IHRoaXMuZGVwZW5kTWFwW3R5cGVdIHx8IHt9O1xuXG4gICAgICAgIGNvbnN0IGFycmF5ID0gdHlwZU1hcFtrZXldID0gdHlwZU1hcFtrZXldIHx8IFtdO1xuXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkZXBlbmRzKSkge1xuICAgICAgICAgICAgZGVwZW5kcyA9IFtkZXBlbmRzXTtcbiAgICAgICAgfVxuICAgICAgICBkZXBlbmRzLmZvckVhY2goKGRlcGVuZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGRlcGVuZCAmJiBhcnJheS5pbmRleE9mKGRlcGVuZCkgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDorrDlvZXliLDkvp3otZbliJfooahcbiAgICAgICAgICAgIGFycmF5LnB1c2goZGVwZW5kKTtcblxuICAgICAgICAgICAgLy8g6K6w5b2V5Yiw5YWz6IGU5YiX6KGoXG4gICAgICAgICAgICBjb25zdCBhc3NvY2lhdGVkID0gYXNzb2NpYXRlZE1hcFtkZXBlbmRdID0gYXNzb2NpYXRlZE1hcFtkZXBlbmRdIHx8IFtdO1xuICAgICAgICAgICAgaWYgKGFzc29jaWF0ZWQuaW5kZXhPZihrZXkpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIGFzc29jaWF0ZWQucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5riF56m65LiA5Liq6LWE5rqQ55qE5L6d6LWW6K6w5b2VXG4gICAgICogQHBhcmFtIG5hbWUgXG4gICAgICovXG4gICAgcmVtb3ZlKHR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLmRlcGVuZE1hcFt0eXBlXSB8fCAhdGhpcy5kZXBlbmRNYXBbdHlwZV1ba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5Yig6Zmk5L6d6LWW5YiX6KGoXG4gICAgICAgIHRoaXMuZGVwZW5kTWFwW3R5cGVdW2tleV0uZm9yRWFjaCgoc3RyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhcnJheSA9IGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gYXJyYXkuaW5kZXhPZihrZXkpO1xuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuZGVwZW5kTWFwW3R5cGVdW2tleV07XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmUgOavgeS4gOS4quS+nei1lueuoeeQhuWZqOWunuS+i1xuICAgICAqIEBwYXJhbSBtYW5hZ2VyIFxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIC8vIOWwhueuoeeQhuWZqOiusOW9leeahOaJgOacieaVsOaNruS7juWFqOWxgOe8k+WtmOWGheWIoOmZpFxuICAgICAgICAvLyDkvYbkuI3muIXpmaTnvJPlrZgganNvbu+8jOWboOS4uuS5i+WQjui/mOWPr+iDvemcgOimgeS9v+eUqFxuXG4gICAgICAgIGZvciAobGV0IHR5cGUgaW4gdGhpcy5kZXBlbmRNYXApIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGVNYXAgPSB0aGlzLmRlcGVuZE1hcFt0eXBlXTtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiB0eXBlTWFwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyYXkgPSB0eXBlTWFwW2tleV07XG4gICAgICAgICAgICAgICAgYXJyYXkuZm9yRWFjaCgoc3RyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYXNzb2NpYXRlZE1hcFtzdHJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBhc3NvY2lhdGVkTWFwW3N0cl0uaW5kZXhPZihrZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NvY2lhdGVkTWFwW3N0cl0uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYXNzb2NpYXRlZE1hcFtzdHJdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGFzc29jaWF0ZWRNYXBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIOiOt+WPluiiq+W9seWTjeeahOi1hOa6kOWIl+ihqFxuICogQHBhcmFtIHVybE9yUGF0aE9yVVVJRCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEFzc29jaWF0ZWRGaWxlcyh1cmxPclBhdGhPclVVSUQ6IHN0cmluZykge1xuICAgIHJldHVybiBhc3NvY2lhdGVkTWFwW3VybE9yUGF0aE9yVVVJRF0gfHwgW107XG59Il19