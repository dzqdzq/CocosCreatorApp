"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAssociatedFiles=exports.DependencyManager=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),migrator_1=require("./migrator"),migrations=[{version:"1.0.0",migrate:async(e,a)=>{const t={data:{path:{},uuid:{}},version:DependencyManager.version};return Object.keys(e.path).forEach(s=>{t.data.path[(0,path_1.relative)(a.pathRoot,s)]=e.path[s].map(e=>(0,path_1.relative)(a.pathRoot,e))}),Object.keys(e.uuid).forEach(s=>{t.data.uuid[(0,path_1.relative)(a.pathRoot,s)]=e.uuid[s]}),t}}];function getDefaultRecordInfo(){return{data:{path:{},uuid:{}},version:DependencyManager.version}}const associatedMap={};class DependencyManager{constructor(e,a){this.dependMap=getDefaultRecordInfo().data,this._saveTimer=null,this.console=e||console,this.pathRoot=a}async setRecordJSON(e){this.file=e;try{await this._restoreCache(e)}catch(e){this.console.warn(e)}}async _restoreCache(e){const a=await this.readRecordJSON(e);if(!a)return;const{path:t,uuid:s}=this.dependMap;Object.keys(a.data.path).forEach(e=>{t[(0,path_1.join)(this.pathRoot,e)]=a.data.path[e].map(e=>(0,path_1.join)(this.pathRoot,e))}),Object.keys(a.data.uuid).forEach(e=>{s[(0,path_1.join)(this.pathRoot,e)]=a.data.uuid[e]});for(let e in this.dependMap){const a=this.dependMap[e];for(let e in a){a[e].forEach(a=>{associatedMap[a]=associatedMap[a]||[],-1===associatedMap[a].indexOf(e)&&associatedMap[a].push(e)})}}}async readRecordJSON(e){if((0,fs_extra_1.existsSync)(e))try{const a=(0,fs_extra_1.readJSONSync)(e),t=a.version?a.version:"0.0.0",s=new migrator_1.Migrator(migrations,t,{onError:(e,a,t,...s)=>{this.console.warn("Migrate error in dependencyManager"),this.console.warn(e)}});return await s.run(a,DependencyManager.version,[this])}catch(e){return void this.console.error(e)}}save(){clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},400)}saveImmediate(){if(clearTimeout(this._saveTimer),this.file){const e=getDefaultRecordInfo(),{path:a,uuid:t}=this.dependMap;Object.keys(a).forEach(t=>{e.data.path[(0,path_1.relative)(this.pathRoot,t)]=a[t].map(e=>(0,path_1.relative)(this.pathRoot,e))}),Object.keys(t).forEach(a=>{e.data.uuid[(0,path_1.relative)(this.pathRoot,a)]=t[a]}),(0,fs_extra_1.outputJSONSync)(this.file,e,{spaces:2})}}add(e,a,t){const s=this.dependMap[e]=this.dependMap[e]||{},i=s[a]=s[a]||[];Array.isArray(t)||(t=[t]),t.forEach(e=>{if(e&&-1!==i.indexOf(e))return;i.push(e);const t=associatedMap[e]=associatedMap[e]||[];-1===t.indexOf(a)&&t.push(a)}),this.save()}remove(e,a){this.dependMap[e]&&this.dependMap[e][a]&&(this.dependMap[e][a].forEach(e=>{const t=associatedMap[e],s=t.indexOf(a);-1!==s&&t.splice(s,1),0===t.length&&delete associatedMap[e]}),delete this.dependMap[e][a],this.save())}destroy(){for(let e in this.dependMap){const a=this.dependMap[e];for(let e in a){a[e].forEach(a=>{if(!associatedMap[a])return;const t=associatedMap[a].indexOf(e);-1!==t&&associatedMap[a].splice(t,1),0===associatedMap[a].length&&delete associatedMap[a]})}}}}function getAssociatedFiles(e){return associatedMap[e]||[]}exports.DependencyManager=DependencyManager,DependencyManager.version="1.0.0",exports.getAssociatedFiles=getAssociatedFiles;