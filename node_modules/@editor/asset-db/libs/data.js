'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataManager = void 0;
const fs_extra_1 = require("fs-extra");
/**
 * 资源关联以及依赖关系列表
 * 部分数据需要固化到硬盘上
 */
class DataManager {
    constructor(customConsole) {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        this.dataMap = {};
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.dataMap = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                this.console.error(error);
                this.dataMap = {};
            }
        }
        else {
            this.dataMap = {};
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.dataMap, { spaces: 2 });
    }
    /**
     * 检查资源是否有初始化过 data 数据
     * @param asset
     * @returns
     */
    has(asset) {
        return !!this.dataMap[asset.uuid];
    }
    /**
     *
     * @param asset
     */
    empty(asset) {
        this.dataMap[asset.uuid] = {
            url: asset.url,
            value: {},
            versionCode: asset.versionCode,
        };
        this.save();
    }
    /**
     * 根据 asset 信息更新数据
     * @param asset
     */
    update(asset) {
        if (!this.dataMap[asset.uuid]) {
            this.dataMap[asset.uuid] = {
                url: asset.url,
                value: {},
                versionCode: asset.versionCode,
            };
        }
        this.dataMap[asset.uuid].url = asset.url;
        this.dataMap[asset.uuid].versionCode = asset.versionCode;
    }
    /**
     * 设置 value 内存储数据
     * @param asset
     */
    setValue(asset, key, value) {
        this.update(asset);
        this.dataMap[asset.uuid].value[key] = value;
        this.save();
    }
    /**
     * 获取 value 内存储的某个数据
     * @param asset
     */
    getValue(asset, key) {
        return this.dataMap[asset.uuid].value[key];
    }
    /**
     * 获取一个 data 信息
     * @param uuid
     * @param source
     * @returns
     */
    get(asset, key = 'value') {
        if (!this.dataMap[asset.uuid]) {
            return null;
        }
        return this.dataMap[asset.uuid][key];
    }
}
exports.DataManager = DataManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYix1Q0FBb0U7QUFTcEU7OztHQUdHO0FBQ0gsTUFBYSxXQUFXO0lBV3BCLFlBQVksYUFBNEI7UUFOeEMsd0JBQXdCO1FBQ3hCLFlBQU8sR0FBOEIsRUFBRSxDQUFDO1FBRXhDLGNBQWM7UUFDZCxlQUFVLEdBQVEsSUFBSSxDQUFDO1FBR25CLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxJQUFJLE9BQU8sQ0FBQztJQUM1QyxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFZO1FBQzVCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksSUFBQSxxQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2xCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFBLHVCQUFZLEVBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzFDO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2FBQ3JCO1NBQ0o7YUFBTTtZQUNILElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNBLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUEseUJBQWMsRUFBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEdBQUcsQ0FBQyxLQUFtQjtRQUNuQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLEtBQW1CO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQ3ZCLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztZQUNkLEtBQUssRUFBRSxFQUFFO1lBQ1QsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO1NBQ2pDLENBQUM7UUFFRixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxLQUFtQjtRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUc7Z0JBQ3ZCLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztnQkFDZCxLQUFLLEVBQUUsRUFBRTtnQkFDVCxXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVc7YUFDakMsQ0FBQztTQUNMO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7T0FHRztJQUNILFFBQVEsQ0FBQyxLQUFtQixFQUFFLEdBQVcsRUFBRSxLQUFVO1FBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILFFBQVEsQ0FBQyxLQUFtQixFQUFFLEdBQVc7UUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsR0FBRyxDQUFDLEtBQW1CLEVBQUUsTUFBbUIsT0FBTztRQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsQ0FBQztDQUNKO0FBdkhELGtDQXVIQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHR5cGUgeyBWaXJ0dWFsQXNzZXQgfSBmcm9tICcuL2Fzc2V0JztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBDdXN0b21Db25zb2xlIH0gZnJvbSAnLi9jb25zb2xlJztcblxuZXhwb3J0IGludGVyZmFjZSBJRGF0YSB7XG4gICAgdXJsOiBzdHJpbmc7IC8vIOaWh+S7tueahOi3r+W+hFxuICAgIHZhbHVlOiB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuICAgIHZlcnNpb25Db2RlOiBudW1iZXI7IC8vIOe8k+WtmOeahOi1hOa6kOeJiOacrOWPt1xufVxuXG4vKipcbiAqIOi1hOa6kOWFs+iBlOS7peWPiuS+nei1luWFs+ezu+WIl+ihqFxuICog6YOo5YiG5pWw5o2u6ZyA6KaB5Zu65YyW5Yiw56Gs55uY5LiKXG4gKi9cbmV4cG9ydCBjbGFzcyBEYXRhTWFuYWdlciB7XG5cbiAgICAvLyDlm7rljJbmlbDmja7nmoTkv53lrZjot6/lvoRcbiAgICBmaWxlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAvLyDkvp3otZbliJfooajvvIzkuIDkuKrlr7nosaHkvp3otZbnmoTmiYDmnInlr7nosaHnmoTlkI3lrZfmlbDnu4RcbiAgICBkYXRhTWFwOiB7IFt1dWlkOiBzdHJpbmddOiBJRGF0YSB9ID0ge307XG5cbiAgICAvLyDkv53lrZjkvb/nlKjnmoQgdGltZXJcbiAgICBfc2F2ZVRpbWVyOiBhbnkgPSBudWxsO1xuICAgIHByaXZhdGUgY29uc29sZTogQ3VzdG9tQ29uc29sZTtcbiAgICBjb25zdHJ1Y3RvcihjdXN0b21Db25zb2xlOiBDdXN0b21Db25zb2xlKSB7XG4gICAgICAgIHRoaXMuY29uc29sZSA9IGN1c3RvbUNvbnNvbGUgfHwgY29uc29sZTtcbiAgICB9XG4gICAgLyoqXG4gICAgICog6K6+572u55So5LqO6K6w5b2V55qEIGpzb24g5paH5Lu2XG4gICAgICogQHBhcmFtIGpzb24gXG4gICAgICovXG4gICAgYXN5bmMgc2V0UmVjb3JkSlNPTihqc29uOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWxlID0ganNvbjtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoanNvbikpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhTWFwID0gcmVhZEpTT05TeW5jKHRoaXMuZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhTWFwID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmRhdGFNYXAgPSB7fTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qXG4gICAgICog5bu26L+f5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuX3NhdmVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zYXZlSW1tZWRpYXRlKCk7XG4gICAgICAgIH0sIDQwMCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiDnq4vljbPkv53lrZjkvp3otZbmlofku7ZcbiAgICAgKi9cbiAgICBzYXZlSW1tZWRpYXRlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5maWxlICYmIG91dHB1dEpTT05TeW5jKHRoaXMuZmlsZSwgdGhpcy5kYXRhTWFwLCB7IHNwYWNlczogMiB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmo4Dmn6XotYTmupDmmK/lkKbmnInliJ3lp4vljJbov4cgZGF0YSDmlbDmja5cbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgaGFzKGFzc2V0OiBWaXJ0dWFsQXNzZXQpIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBlbXB0eShhc3NldDogVmlydHVhbEFzc2V0KSB7XG4gICAgICAgIHRoaXMuZGF0YU1hcFthc3NldC51dWlkXSA9IHtcbiAgICAgICAgICAgIHVybDogYXNzZXQudXJsLFxuICAgICAgICAgICAgdmFsdWU6IHt9LFxuICAgICAgICAgICAgdmVyc2lvbkNvZGU6IGFzc2V0LnZlcnNpb25Db2RlLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOagueaNriBhc3NldCDkv6Hmga/mm7TmlrDmlbDmja5cbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgdXBkYXRlKGFzc2V0OiBWaXJ0dWFsQXNzZXQpIHtcbiAgICAgICAgaWYgKCF0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0pIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YU1hcFthc3NldC51dWlkXSA9IHtcbiAgICAgICAgICAgICAgICB1cmw6IGFzc2V0LnVybCxcbiAgICAgICAgICAgICAgICB2YWx1ZToge30sXG4gICAgICAgICAgICAgICAgdmVyc2lvbkNvZGU6IGFzc2V0LnZlcnNpb25Db2RlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udXJsID0gYXNzZXQudXJsO1xuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udmVyc2lvbkNvZGUgPSBhc3NldC52ZXJzaW9uQ29kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDorr7nva4gdmFsdWUg5YaF5a2Y5YKo5pWw5o2uXG4gICAgICogQHBhcmFtIGFzc2V0IFxuICAgICAqL1xuICAgIHNldFZhbHVlKGFzc2V0OiBWaXJ0dWFsQXNzZXQsIGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgICAgIHRoaXMudXBkYXRlKGFzc2V0KTtcbiAgICAgICAgdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdLnZhbHVlW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+WIHZhbHVlIOWGheWtmOWCqOeahOafkOS4quaVsOaNrlxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBnZXRWYWx1ZShhc3NldDogVmlydHVhbEFzc2V0LCBrZXk6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdLnZhbHVlW2tleV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W5LiA5LiqIGRhdGEg5L+h5oGvXG4gICAgICogQHBhcmFtIHV1aWQgXG4gICAgICogQHBhcmFtIHNvdXJjZSBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBnZXQoYXNzZXQ6IFZpcnR1YWxBc3NldCwga2V5OiBrZXlvZiBJRGF0YSA9ICd2YWx1ZScpOiBudWxsIHwgYW55IHtcbiAgICAgICAgaWYgKCF0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0pIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF1ba2V5XTtcbiAgICB9XG59XG4iXX0=