'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataManager = void 0;
const fs_extra_1 = require("fs-extra");
/**
 * 资源关联以及依赖关系列表
 * 部分数据需要固化到硬盘上
 */
class DataManager {
    constructor(customConsole) {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        this.dataMap = {};
        // 保存使用的 timer
        this._saveTimer = null;
        this.console = customConsole || console;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.dataMap = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                this.console.error(error);
                this.dataMap = {};
            }
        }
        else {
            this.dataMap = {};
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.dataMap, { spaces: 2 });
    }
    /**
     * 检查资源是否有初始化过 data 数据
     * @param asset
     * @returns
     */
    has(asset) {
        return !!this.dataMap[asset.uuid];
    }
    /**
     *
     * @param asset
     */
    empty(asset) {
        this.dataMap[asset.uuid] = {
            url: asset.url,
            value: {},
            versionCode: asset.versionCode,
        };
        this.save();
    }
    update(asset) {
        if (!this.dataMap[asset.uuid]) {
            this.dataMap[asset.uuid] = {
                url: asset.url,
                value: {},
                versionCode: asset.versionCode,
            };
        }
        this.dataMap[asset.uuid].url = asset.url;
        this.dataMap[asset.uuid].versionCode = asset.versionCode;
    }
    /**
     *
     * @param asset
     */
    set(asset, key, value) {
        this.update(asset);
        this.dataMap[asset.uuid].value[key] = value;
        this.save();
    }
    /**
     * 获取一个 data 信息
     * 需要传递 source，如果 source 信息不一致，会更新 source
     * @param uuid
     * @param source
     * @returns
     */
    get(asset) {
        if (!this.dataMap[asset.uuid]) {
            return {};
        }
        return this.dataMap[asset.uuid].value;
    }
}
exports.DataManager = DataManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYix1Q0FBb0U7QUFTcEU7OztHQUdHO0FBQ0gsTUFBYSxXQUFXO0lBV3BCLFlBQVksYUFBNEI7UUFOeEMsd0JBQXdCO1FBQ3hCLFlBQU8sR0FBOEIsRUFBRSxDQUFDO1FBRXhDLGNBQWM7UUFDZCxlQUFVLEdBQVEsSUFBSSxDQUFDO1FBR25CLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxJQUFJLE9BQU8sQ0FBQztJQUM1QyxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFZO1FBQzVCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksSUFBQSxxQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2xCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFBLHVCQUFZLEVBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzFDO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2FBQ3JCO1NBQ0o7YUFBTTtZQUNILElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNBLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUEseUJBQWMsRUFBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEdBQUcsQ0FBQyxLQUFtQjtRQUNuQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLEtBQW1CO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQ3ZCLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztZQUNkLEtBQUssRUFBRSxFQUFFO1lBQ1QsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO1NBQ2pDLENBQUM7UUFFRixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFtQjtRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUc7Z0JBQ3ZCLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztnQkFDZCxLQUFLLEVBQUUsRUFBRTtnQkFDVCxXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVc7YUFDakMsQ0FBQztTQUNMO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7T0FHRztJQUNILEdBQUcsQ0FBQyxLQUFtQixFQUFFLEdBQVcsRUFBRSxLQUFVO1FBQzVDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEdBQUcsQ0FBQyxLQUFtQjtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsT0FBTyxFQUFFLENBQUM7U0FDYjtRQUNELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQzFDLENBQUM7Q0FDSjtBQTVHRCxrQ0E0R0MiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB0eXBlIHsgVmlydHVhbEFzc2V0IH0gZnJvbSAnLi9hc3NldCc7XG5pbXBvcnQgeyBleGlzdHNTeW5jLCByZWFkSlNPTlN5bmMsIG91dHB1dEpTT05TeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgQ3VzdG9tQ29uc29sZSB9IGZyb20gJy4vY29uc29sZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURhdGEge1xuICAgIHVybDogc3RyaW5nOyAvLyDmlofku7bnmoTot6/lvoRcbiAgICB2YWx1ZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgICB2ZXJzaW9uQ29kZTogbnVtYmVyOyAvLyDnvJPlrZjnmoTotYTmupDniYjmnKzlj7dcbn1cblxuLyoqXG4gKiDotYTmupDlhbPogZTku6Xlj4rkvp3otZblhbPns7vliJfooahcbiAqIOmDqOWIhuaVsOaNrumcgOimgeWbuuWMluWIsOehrOebmOS4ilxuICovXG5leHBvcnQgY2xhc3MgRGF0YU1hbmFnZXIge1xuXG4gICAgLy8g5Zu65YyW5pWw5o2u55qE5L+d5a2Y6Lev5b6EXG4gICAgZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgLy8g5L6d6LWW5YiX6KGo77yM5LiA5Liq5a+56LGh5L6d6LWW55qE5omA5pyJ5a+56LGh55qE5ZCN5a2X5pWw57uEXG4gICAgZGF0YU1hcDogeyBbdXVpZDogc3RyaW5nXTogSURhdGEgfSA9IHt9O1xuXG4gICAgLy8g5L+d5a2Y5L2/55So55qEIHRpbWVyXG4gICAgX3NhdmVUaW1lcjogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIGNvbnNvbGU6IEN1c3RvbUNvbnNvbGU7XG4gICAgY29uc3RydWN0b3IoY3VzdG9tQ29uc29sZTogQ3VzdG9tQ29uc29sZSkge1xuICAgICAgICB0aGlzLmNvbnNvbGUgPSBjdXN0b21Db25zb2xlIHx8IGNvbnNvbGU7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOiuvue9rueUqOS6juiusOW9leeahCBqc29uIOaWh+S7tlxuICAgICAqIEBwYXJhbSBqc29uIFxuICAgICAqL1xuICAgIGFzeW5jIHNldFJlY29yZEpTT04oanNvbjogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZmlsZSA9IGpzb247XG4gICAgICAgIGlmIChleGlzdHNTeW5jKGpzb24pKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hcCA9IHJlYWRKU09OU3luYyh0aGlzLmZpbGUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hcCA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kYXRhTWFwID0ge307XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOW7tui/n+S/neWtmOS+nei1luaWh+S7tlxuICAgICAqL1xuICAgIHNhdmUoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9zYXZlVGltZXIpO1xuICAgICAgICB0aGlzLl9zYXZlVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZUltbWVkaWF0ZSgpO1xuICAgICAgICB9LCA0MDApO1xuICAgIH1cblxuICAgIC8qXG4gICAgICog56uL5Y2z5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZUltbWVkaWF0ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuZmlsZSAmJiBvdXRwdXRKU09OU3luYyh0aGlzLmZpbGUsIHRoaXMuZGF0YU1hcCwgeyBzcGFjZXM6IDIgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5qOA5p+l6LWE5rqQ5piv5ZCm5pyJ5Yid5aeL5YyW6L+HIGRhdGEg5pWw5o2uXG4gICAgICogQHBhcmFtIGFzc2V0IFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIGhhcyhhc3NldDogVmlydHVhbEFzc2V0KSB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuZGF0YU1hcFthc3NldC51dWlkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgZW1wdHkoYXNzZXQ6IFZpcnR1YWxBc3NldCkge1xuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0gPSB7XG4gICAgICAgICAgICB1cmw6IGFzc2V0LnVybCxcbiAgICAgICAgICAgIHZhbHVlOiB7fSxcbiAgICAgICAgICAgIHZlcnNpb25Db2RlOiBhc3NldC52ZXJzaW9uQ29kZSxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICB1cGRhdGUoYXNzZXQ6IFZpcnR1YWxBc3NldCkge1xuICAgICAgICBpZiAoIXRoaXMuZGF0YU1hcFthc3NldC51dWlkXSkge1xuICAgICAgICAgICAgdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdID0ge1xuICAgICAgICAgICAgICAgIHVybDogYXNzZXQudXJsLFxuICAgICAgICAgICAgICAgIHZhbHVlOiB7fSxcbiAgICAgICAgICAgICAgICB2ZXJzaW9uQ29kZTogYXNzZXQudmVyc2lvbkNvZGUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGF0YU1hcFthc3NldC51dWlkXS51cmwgPSBhc3NldC51cmw7XG4gICAgICAgIHRoaXMuZGF0YU1hcFthc3NldC51dWlkXS52ZXJzaW9uQ29kZSA9IGFzc2V0LnZlcnNpb25Db2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBhc3NldCBcbiAgICAgKi9cbiAgICBzZXQoYXNzZXQ6IFZpcnR1YWxBc3NldCwga2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICAgICAgdGhpcy51cGRhdGUoYXNzZXQpO1xuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udmFsdWVba2V5XSA9IHZhbHVlO1xuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDojrflj5bkuIDkuKogZGF0YSDkv6Hmga9cbiAgICAgKiDpnIDopoHkvKDpgJIgc291cmNl77yM5aaC5p6cIHNvdXJjZSDkv6Hmga/kuI3kuIDoh7TvvIzkvJrmm7TmlrAgc291cmNlXG4gICAgICogQHBhcmFtIHV1aWQgXG4gICAgICogQHBhcmFtIHNvdXJjZSBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBnZXQoYXNzZXQ6IFZpcnR1YWxBc3NldCk6IHsgW2tleTogc3RyaW5nXTogYW55IH0ge1xuICAgICAgICBpZiAoIXRoaXMuZGF0YU1hcFthc3NldC51dWlkXSkge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udmFsdWU7XG4gICAgfVxufVxuIl19