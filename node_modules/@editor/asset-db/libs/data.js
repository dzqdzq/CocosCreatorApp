'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataManager = void 0;
const fs_extra_1 = require("fs-extra");
/**
 * 资源关联以及依赖关系列表
 * 部分数据需要固化到硬盘上
 */
class DataManager {
    constructor() {
        // 依赖列表，一个对象依赖的所有对象的名字数组
        this.dataMap = {};
        // 保存使用的 timer
        this._saveTimer = null;
    }
    /**
     * 设置用于记录的 json 文件
     * @param json
     */
    async setRecordJSON(json) {
        this.file = json;
        if ((0, fs_extra_1.existsSync)(json)) {
            try {
                this.dataMap = (0, fs_extra_1.readJSONSync)(this.file);
            }
            catch (error) {
                console.error(error);
                this.dataMap = {};
            }
        }
        else {
            this.dataMap = {};
        }
    }
    /*
     * 延迟保存依赖文件
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 400);
    }
    /*
     * 立即保存依赖文件
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        this.file && (0, fs_extra_1.outputJSONSync)(this.file, this.dataMap, { spaces: 2 });
    }
    /**
     * 检查资源是否有初始化过 data 数据
     * @param asset
     * @returns
     */
    has(asset) {
        return !!this.dataMap[asset.uuid];
    }
    /**
     *
     * @param asset
     */
    empty(asset) {
        this.dataMap[asset.uuid] = {
            url: asset.url,
            value: {},
        };
        this.save();
    }
    /**
     *
     * @param asset
     */
    set(asset, key, value) {
        if (!this.dataMap[asset.uuid]) {
            this.dataMap[asset.uuid] = {
                url: asset.url,
                value: {},
            };
        }
        this.dataMap[asset.uuid].url = asset.url;
        this.dataMap[asset.uuid].value[key] = value;
        this.save();
    }
    /**
     * 获取一个 data 信息
     * 需要传递 source，如果 source 信息不一致，会更新 source
     * @param uuid
     * @param source
     * @returns
     */
    get(asset) {
        if (!this.dataMap[asset.uuid]) {
            return {};
        }
        return this.dataMap[asset.uuid].value;
    }
}
exports.DataManager = DataManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYix1Q0FBb0U7QUFPcEU7OztHQUdHO0FBQ0gsTUFBYSxXQUFXO0lBQXhCO1FBS0ksd0JBQXdCO1FBQ3hCLFlBQU8sR0FBNkIsRUFBRSxDQUFDO1FBRXZDLGNBQWM7UUFDZCxlQUFVLEdBQVEsSUFBSSxDQUFDO0lBMkYzQixDQUFDO0lBekZHOzs7T0FHRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBWTtRQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsRUFBRTtZQUNsQixJQUFJO2dCQUNBLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBQSx1QkFBWSxFQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxQztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2FBQ3JCO1NBQ0o7YUFBTTtZQUNILElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNBLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUEseUJBQWMsRUFBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEdBQUcsQ0FBQyxLQUFtQjtRQUNuQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLEtBQW1CO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO1lBQ3ZCLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztZQUNkLEtBQUssRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUVGLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsR0FBRyxDQUFDLEtBQW1CLEVBQUUsR0FBVyxFQUFFLEtBQVU7UUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO2dCQUN2QixHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7Z0JBQ2QsS0FBSyxFQUFFLEVBQUU7YUFDWixDQUFDO1NBQ0w7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBRTVDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVoQixDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsR0FBRyxDQUFDLEtBQW1CO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMzQixPQUFPLEVBQUUsQ0FBQztTQUNiO1FBQ0QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDMUMsQ0FBQztDQUNKO0FBcEdELGtDQW9HQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHR5cGUgeyBWaXJ0dWFsQXNzZXQgfSBmcm9tICcuL2Fzc2V0JztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRKU09OU3luYywgb3V0cHV0SlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURhdGEge1xuICAgIHVybDogc3RyaW5nOyAvLyDmlofku7bnmoTot6/lvoRcbiAgICB2YWx1ZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuLyoqXG4gKiDotYTmupDlhbPogZTku6Xlj4rkvp3otZblhbPns7vliJfooahcbiAqIOmDqOWIhuaVsOaNrumcgOimgeWbuuWMluWIsOehrOebmOS4ilxuICovXG5leHBvcnQgY2xhc3MgRGF0YU1hbmFnZXIge1xuXG4gICAgLy8g5Zu65YyW5pWw5o2u55qE5L+d5a2Y6Lev5b6EXG4gICAgZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgLy8g5L6d6LWW5YiX6KGo77yM5LiA5Liq5a+56LGh5L6d6LWW55qE5omA5pyJ5a+56LGh55qE5ZCN5a2X5pWw57uEXG4gICAgZGF0YU1hcDoge1t1dWlkOiBzdHJpbmddOiBJRGF0YSB9ID0ge307XG5cbiAgICAvLyDkv53lrZjkvb/nlKjnmoQgdGltZXJcbiAgICBfc2F2ZVRpbWVyOiBhbnkgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICog6K6+572u55So5LqO6K6w5b2V55qEIGpzb24g5paH5Lu2XG4gICAgICogQHBhcmFtIGpzb24gXG4gICAgICovXG4gICAgYXN5bmMgc2V0UmVjb3JkSlNPTihqc29uOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5maWxlID0ganNvbjtcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoanNvbikpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhTWFwID0gcmVhZEpTT05TeW5jKHRoaXMuZmlsZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YU1hcCA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kYXRhTWFwID0ge307XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKlxuICAgICAqIOW7tui/n+S/neWtmOS+nei1luaWh+S7tlxuICAgICAqL1xuICAgIHNhdmUoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9zYXZlVGltZXIpO1xuICAgICAgICB0aGlzLl9zYXZlVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZUltbWVkaWF0ZSgpO1xuICAgICAgICB9LCA0MDApO1xuICAgIH1cblxuICAgIC8qXG4gICAgICog56uL5Y2z5L+d5a2Y5L6d6LWW5paH5Lu2XG4gICAgICovXG4gICAgc2F2ZUltbWVkaWF0ZSgpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NhdmVUaW1lcik7XG4gICAgICAgIHRoaXMuZmlsZSAmJiBvdXRwdXRKU09OU3luYyh0aGlzLmZpbGUsIHRoaXMuZGF0YU1hcCwgeyBzcGFjZXM6IDIgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5qOA5p+l6LWE5rqQ5piv5ZCm5pyJ5Yid5aeL5YyW6L+HIGRhdGEg5pWw5o2uXG4gICAgICogQHBhcmFtIGFzc2V0IFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIGhhcyhhc3NldDogVmlydHVhbEFzc2V0KSB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuZGF0YU1hcFthc3NldC51dWlkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgZW1wdHkoYXNzZXQ6IFZpcnR1YWxBc3NldCkge1xuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0gPSB7XG4gICAgICAgICAgICB1cmw6IGFzc2V0LnVybCxcbiAgICAgICAgICAgIHZhbHVlOiB7fSxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gYXNzZXQgXG4gICAgICovXG4gICAgc2V0KGFzc2V0OiBWaXJ0dWFsQXNzZXQsIGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgICAgIGlmICghdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0gPSB7XG4gICAgICAgICAgICAgICAgdXJsOiBhc3NldC51cmwsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHt9LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udXJsID0gYXNzZXQudXJsO1xuICAgICAgICB0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0udmFsdWVba2V5XSA9IHZhbHVlO1xuXG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W5LiA5LiqIGRhdGEg5L+h5oGvXG4gICAgICog6ZyA6KaB5Lyg6YCSIHNvdXJjZe+8jOWmguaenCBzb3VyY2Ug5L+h5oGv5LiN5LiA6Ie077yM5Lya5pu05pawIHNvdXJjZVxuICAgICAqIEBwYXJhbSB1dWlkIFxuICAgICAqIEBwYXJhbSBzb3VyY2UgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgZ2V0KGFzc2V0OiBWaXJ0dWFsQXNzZXQpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHtcbiAgICAgICAgaWYgKCF0aGlzLmRhdGFNYXBbYXNzZXQudXVpZF0pIHtcbiAgICAgICAgICAgIHJldHVybiB7fTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhTWFwW2Fzc2V0LnV1aWRdLnZhbHVlO1xuICAgIH1cbn1cbiJdfQ==