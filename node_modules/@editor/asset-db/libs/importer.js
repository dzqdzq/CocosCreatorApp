'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.DefaultImporter = exports.Importer = exports.ImporterManager = void 0;
const path_1 = require("path");
const asset_1 = require("./asset");
/**
 * 导入器管理器
 */
class ImporterManager {
    constructor(assetDB) {
        // extname 与 importer 的 map
        this.extname2importer = {};
        // name 与 importer 的 map
        this.name2importer = {};
        this.assetDB = assetDB;
    }
    /**
     * 新增一个导入器
     * @param importer
     * @param extnames
     */
    add(importer, extnames) {
        const instance = new importer(this.assetDB);
        if (!(instance instanceof Importer)) {
            if (this.assetDB.options.level >= 2) {
                console.warn(`Cannot register the importer.`);
            }
            return;
        }
        // 如果已经存在同名的导入器则跳过
        if (instance.name !== '*' &&
            this.name2importer[instance.name] &&
            this.name2importer[instance.name] !== instance) {
            if (this.assetDB.options.level >= 2) {
                console.warn(`The importer[${importer.name}] is registered.`);
            }
            return;
        }
        // 将注册的扩展名放到导入器的扩展名列表里
        extnames && extnames.forEach((extname) => {
            extname = extname.toLowerCase();
            let array = this.extname2importer[extname] = this.extname2importer[extname] || [];
            if (array.indexOf(instance) === -1) {
                this.extname2importer[extname].push(instance);
                instance.extnames.push(extname);
            }
        });
        // 加入 name map
        this.name2importer[instance.name] = instance;
    }
    /**
     * 删除一个导入器
     * @param importer
     */
    remove(importer) {
        const instance = this.name2importer[importer.name];
        instance.extnames.forEach((extname) => {
            // 检查 extname map，并删除数据
            let array = this.extname2importer[extname];
            if (!array) {
                return true;
            }
            let index = array.indexOf(instance);
            if (index === -1) {
                return true;
            }
            array.splice(index, 1);
        });
        delete this.name2importer[importer.name];
        return true;
    }
    /**
     * 清空所有的 importer
     */
    clear() {
        this.name2importer = {};
        this.extname2importer = {};
    }
    /**
     * 查找可以导入某个扩展名的所有导入器
     */
    async find(asset) {
        // 如果 importer 不是通用导入器，则尝试使用标记的导入器
        if (asset.meta.importer && asset.meta.importer !== '*') {
            const importer = this.name2importer[asset.meta.importer];
            if (asset instanceof asset_1.Asset) {
                if (importer
                    && importer.extnames.indexOf(asset.extname) !== -1
                    && await importer.validate(asset)) {
                    return importer;
                }
            }
            else {
                if (importer
                    && await importer.validate(asset)) {
                    return importer;
                }
            }
        }
        // 如果不能使用记录的导入器，则尝试查找其他导入器
        if (asset instanceof asset_1.Asset) {
            const importerArray = this.extname2importer[asset.extname] || [];
            for (let i = importerArray.length - 1; i >= 0; i--) {
                try {
                    const validate = await importerArray[i].validate(asset);
                    if (validate) {
                        return importerArray[i];
                    }
                }
                catch (error) {
                    if (this.assetDB.options.level >= 1) {
                        console.error(`Importer validate failed: ${asset.uuid}`);
                    }
                    console.error(error);
                }
            }
        }
        // 如果还是没有找到匹配的导入器，则尝试使用通用导入器
        const importerArray = this.extname2importer['*'];
        for (let i = importerArray.length - 1; i >= 0; i--) {
            try {
                const validate = await importerArray[i].validate(asset);
                if (validate) {
                    return importerArray[i];
                }
            }
            catch (error) {
                if (this.assetDB.options.level >= 1) {
                    console.error(`Importer validate failed: ${asset.uuid}`);
                }
                console.error(error);
            }
        }
        // 如果连通用导入器都无能为力，那就返回 null
        return null;
    }
}
exports.ImporterManager = ImporterManager;
/**
 * 导入器
 * 需要负责检查文件是否使用该导入器导入资源
 * 资源导入的流程：
 *   1. 将 asset 当作 raw asset ，直接改名复制到 library 文件夹
 *   2. importer 作者自定义的
 */
class Importer {
    constructor(assetDB) {
        // 存储当前的 import 注册了多少个扩展名
        // 主要用于检索在 asset db 内的索引
        this.extnames = [];
        // 附加到 importer 上的标记
        this.flag = {};
        this.assetDB = assetDB;
    }
    // 版本号，导入前会判断
    // 如果不一致，则会删除导入的数据，强制重新执行导入
    get version() {
        return '0.0.1';
    }
    // 版本迁移队列
    get migrations() {
        return [];
    }
    // 数据迁移钩子函数
    get migrationHook() {
        return {
            pre() { },
            post() { },
        };
    }
    // importer 的名字
    get name() {
        return '*';
    }
    /**
     * 检查文件是否适用于这个 importer
     * @param asset
     */
    async validate(asset) {
        return !asset.isDirectory();
    }
    /**
     * 是否强制刷新
     * @param asset
     */
    async force(asset) {
        return false;
    }
    /**
     * 开始执行文件的导入操作
     *   1. 将文件复制到 library 内
     *
     * 返回是否导入成功的标记
     * 如果返回 false，则 imported 标记不会变成 true
     * 后续的一系列操作都不会执行
     *
     * @param asset
     */
    async import(asset) {
        // 如果是虚拟资源，直接返回 false
        if (!(asset instanceof asset_1.Asset)) {
            return true;
        }
        // 扩展名，如 .json
        let ext = (0, path_1.extname)(asset.source).toLowerCase(); // 注意，这里会把所有后缀统一改成小写
        // 复制 raw asset
        await asset.copyToLibrary(ext, asset.source);
        return true;
    }
}
exports.Importer = Importer;
class DefaultImporter extends Importer {
    /**
     * 检查文件是否适用于这个 importer
     * @param asset
     */
    async validate(asset) {
        return true;
    }
    /**
     * 开始执行文件的导入操作
     *   1. 将文件复制到 library 内
     *
     * 返回是否导入成功的标记
     * 如果返回 false，则 imported 标记不会变成 true
     * 后续的一系列操作都不会执行
     *
     * @param asset
     */
    async import(asset) {
        // 如果是虚拟资源，直接返回 false
        if (!(asset instanceof asset_1.Asset)) {
            return true;
        }
        // 扩展名，如 .json
        let ext = (0, path_1.extname)(asset.source);
        // 导入对象是文件夹，则直接跳过
        if (await asset.isDirectory()) {
            return true;
        }
        // 复制 raw asset
        await asset.copyToLibrary(ext, asset.source);
        return true;
    }
}
exports.DefaultImporter = DefaultImporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvbGlicy9pbXBvcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUViLCtCQUErQjtBQUMvQixtQ0FBOEM7QUFzQjlDOztHQUVHO0FBQ0gsTUFBYSxlQUFlO0lBV3hCLFlBQVksT0FBZ0I7UUFUNUIsMkJBQTJCO1FBQzNCLHFCQUFnQixHQUFvQyxFQUFFLENBQUM7UUFFdkQsd0JBQXdCO1FBQ3hCLGtCQUFhLEdBQWtDLEVBQUUsQ0FBQztRQU05QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEdBQUcsQ0FBQyxRQUF5QixFQUFFLFFBQWtCO1FBRTdDLE1BQU0sUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1QyxJQUFJLENBQUMsQ0FBQyxRQUFRLFlBQVksUUFBUSxDQUFDLEVBQUU7WUFDakMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksQ0FBQyxFQUFFO2dCQUNqQyxPQUFPLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUM7YUFDakQ7WUFDRCxPQUFPO1NBQ1Y7UUFFRCxrQkFBa0I7UUFDbEIsSUFDSSxRQUFRLENBQUMsSUFBSSxLQUFLLEdBQUc7WUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLFFBQVEsRUFDaEQ7WUFDRSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7Z0JBQ2pDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLFFBQVEsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLENBQUM7YUFDakU7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RUFBRTtZQUMzQixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsY0FBYztRQUNkLElBQUksR0FBRyxHQUFHLElBQUEsY0FBTyxFQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLG9CQUFvQjtRQUVuRSxlQUFlO1FBQ2YsTUFBTSxLQUFLLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0MsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUdKO0FBakZELDRCQWlGQztBQUVELE1BQWEsZUFBZ0IsU0FBUSxRQUFRO0lBRXpDOzs7T0FHRztJQUNILEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBMkI7UUFDdEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7Ozs7Ozs7T0FTRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBMkI7UUFDcEMscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxhQUFLLENBQUMsRUFBRTtZQUMzQixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsY0FBYztRQUNkLElBQUksR0FBRyxHQUFHLElBQUEsY0FBTyxFQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVoQyxpQkFBaUI7UUFDakIsSUFBSSxNQUFNLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUMzQixPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsZUFBZTtRQUNmLE1BQU0sS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXRDRCwwQ0FzQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4dG5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IFZpcnR1YWxBc3NldCwgQXNzZXQgfSBmcm9tICcuL2Fzc2V0JztcblxuaW1wb3J0IHsgQXNzZXREQiB9IGZyb20gJy4vYXNzZXQtZGInO1xuXG4vKipcbiAqIOi/geenu+mYn+WIl1xuICovXG5leHBvcnQgaW50ZXJmYWNlIE1pZ3JhdGUge1xuICAgIHZlcnNpb246IHN0cmluZztcbiAgICBtaWdyYXRlPzogRnVuY3Rpb247XG59XG5cbi8qKlxuICog5a+85YWl5Zmo5a+85YWl5rWB56iL55qE6ZKp5a2Q5Ye95pWwXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWlncmF0ZUhvb2sge1xuICAgIC8vIOi/geenu+S5i+WJjVxuICAgIHByZShhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpO1xuICAgIC8vIOi/geenu+S5i+WQjlxuICAgIHBvc3QoYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0LCBudW06IG51bWJlcik7XG59XG5cbi8qKlxuICog5a+85YWl5Zmo566h55CG5ZmoXG4gKi9cbmV4cG9ydCBjbGFzcyBJbXBvcnRlck1hbmFnZXIge1xuXG4gICAgLy8gZXh0bmFtZSDkuI4gaW1wb3J0ZXIg55qEIG1hcFxuICAgIGV4dG5hbWUyaW1wb3J0ZXI6IHsgW2luZGV4OiBzdHJpbmddOiBbSW1wb3J0ZXJdIH0gPSB7fTtcblxuICAgIC8vIG5hbWUg5LiOIGltcG9ydGVyIOeahCBtYXBcbiAgICBuYW1lMmltcG9ydGVyOiB7IFtpbmRleDogc3RyaW5nXTogSW1wb3J0ZXIgfSA9IHt9O1xuXG4gICAgLy8g5pWw5o2u5bqT5a+56LGhXG4gICAgYXNzZXREQjogQXNzZXREQjtcblxuICAgIGNvbnN0cnVjdG9yKGFzc2V0REI6IEFzc2V0REIpIHtcbiAgICAgICAgdGhpcy5hc3NldERCID0gYXNzZXREQjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmlrDlop7kuIDkuKrlr7zlhaXlmahcbiAgICAgKiBAcGFyYW0gaW1wb3J0ZXIgXG4gICAgICogQHBhcmFtIGV4dG5hbWVzIFxuICAgICAqL1xuICAgIGFkZChpbXBvcnRlcjogdHlwZW9mIEltcG9ydGVyLCBleHRuYW1lczogc3RyaW5nW10pIHtcblxuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBpbXBvcnRlcih0aGlzLmFzc2V0REIpO1xuXG4gICAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgSW1wb3J0ZXIpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5hc3NldERCLm9wdGlvbnMubGV2ZWwgPj0gMikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQ2Fubm90IHJlZ2lzdGVyIHRoZSBpbXBvcnRlci5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWmguaenOW3sue7j+WtmOWcqOWQjOWQjeeahOWvvOWFpeWZqOWImei3s+i/h1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBpbnN0YW5jZS5uYW1lICE9PSAnKicgJiZcbiAgICAgICAgICAgIHRoaXMubmFtZTJpbXBvcnRlcltpbnN0YW5jZS5uYW1lXSAmJlxuICAgICAgICAgICAgdGhpcy5uYW1lMmltcG9ydGVyW2luc3RhbmNlLm5hbWVdICE9PSBpbnN0YW5jZVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmFzc2V0REIub3B0aW9ucy5sZXZlbCA+PSAyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBUaGUgaW1wb3J0ZXJbJHtpbXBvcnRlci5uYW1lfV0gaXMgcmVnaXN0ZXJlZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWwhuazqOWGjOeahOaJqeWxleWQjeaUvuWIsOWvvOWFpeWZqOeahOaJqeWxleWQjeWIl+ihqOmHjFxuICAgICAgICBleHRuYW1lcyAmJiBleHRuYW1lcy5mb3JFYWNoKChleHRuYW1lKSA9PiB7XG4gICAgICAgICAgICBleHRuYW1lID0gZXh0bmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgbGV0IGFycmF5ID0gdGhpcy5leHRuYW1lMmltcG9ydGVyW2V4dG5hbWVdID0gdGhpcy5leHRuYW1lMmltcG9ydGVyW2V4dG5hbWVdIHx8IFtdO1xuICAgICAgICAgICAgaWYgKGFycmF5LmluZGV4T2YoaW5zdGFuY2UpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZXh0bmFtZTJpbXBvcnRlcltleHRuYW1lXS5wdXNoKGluc3RhbmNlKTtcbiAgICAgICAgICAgICAgICBpbnN0YW5jZS5leHRuYW1lcy5wdXNoKGV4dG5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyDliqDlhaUgbmFtZSBtYXBcbiAgICAgICAgdGhpcy5uYW1lMmltcG9ydGVyW2luc3RhbmNlLm5hbWVdID0gaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5Yig6Zmk5LiA5Liq5a+85YWl5ZmoXG4gICAgICogQHBhcmFtIGltcG9ydGVyIFxuICAgICAqL1xuICAgIHJlbW92ZShpbXBvcnRlcjogdHlwZW9mIEltcG9ydGVyKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5uYW1lMmltcG9ydGVyW2ltcG9ydGVyLm5hbWVdO1xuXG4gICAgICAgIGluc3RhbmNlLmV4dG5hbWVzLmZvckVhY2goKGV4dG5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vIOajgOafpSBleHRuYW1lIG1hcO+8jOW5tuWIoOmZpOaVsOaNrlxuICAgICAgICAgICAgbGV0IGFycmF5ID0gdGhpcy5leHRuYW1lMmltcG9ydGVyW2V4dG5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcnJheSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGluZGV4ID0gYXJyYXkuaW5kZXhPZihpbnN0YW5jZSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZWxldGUgdGhpcy5uYW1lMmltcG9ydGVyW2ltcG9ydGVyLm5hbWVdO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOa4heepuuaJgOacieeahCBpbXBvcnRlclxuICAgICAqL1xuICAgIGNsZWFyKCkge1xuICAgICAgICB0aGlzLm5hbWUyaW1wb3J0ZXIgPSB7fTtcbiAgICAgICAgdGhpcy5leHRuYW1lMmltcG9ydGVyID0ge307XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5p+l5om+5Y+v5Lul5a+85YWl5p+Q5Liq5omp5bGV5ZCN55qE5omA5pyJ5a+85YWl5ZmoXG4gICAgICovXG4gICAgYXN5bmMgZmluZChhc3NldDogVmlydHVhbEFzc2V0IHwgQXNzZXQpIHtcbiAgICAgICAgLy8g5aaC5p6cIGltcG9ydGVyIOS4jeaYr+mAmueUqOWvvOWFpeWZqO+8jOWImeWwneivleS9v+eUqOagh+iusOeahOWvvOWFpeWZqFxuICAgICAgICBpZiAoYXNzZXQubWV0YS5pbXBvcnRlciAmJiBhc3NldC5tZXRhLmltcG9ydGVyICE9PSAnKicpIHtcbiAgICAgICAgICAgIGNvbnN0IGltcG9ydGVyID0gdGhpcy5uYW1lMmltcG9ydGVyW2Fzc2V0Lm1ldGEuaW1wb3J0ZXJdO1xuICAgICAgICAgICAgaWYgKGFzc2V0IGluc3RhbmNlb2YgQXNzZXQpIHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGltcG9ydGVyXG4gICAgICAgICAgICAgICAgICAgICYmIGltcG9ydGVyLmV4dG5hbWVzLmluZGV4T2YoYXNzZXQuZXh0bmFtZSkgIT09IC0xXG4gICAgICAgICAgICAgICAgICAgICYmIGF3YWl0IGltcG9ydGVyLnZhbGlkYXRlKGFzc2V0KVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW1wb3J0ZXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGltcG9ydGVyXG4gICAgICAgICAgICAgICAgICAgICYmIGF3YWl0IGltcG9ydGVyLnZhbGlkYXRlKGFzc2V0KVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW1wb3J0ZXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8g5aaC5p6c5LiN6IO95L2/55So6K6w5b2V55qE5a+85YWl5Zmo77yM5YiZ5bCd6K+V5p+l5om+5YW25LuW5a+85YWl5ZmoXG4gICAgICAgIGlmIChhc3NldCBpbnN0YW5jZW9mIEFzc2V0KSB7XG4gICAgICAgICAgICBjb25zdCBpbXBvcnRlckFycmF5ID0gdGhpcy5leHRuYW1lMmltcG9ydGVyW2Fzc2V0LmV4dG5hbWVdIHx8IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGltcG9ydGVyQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0ZSA9IGF3YWl0IGltcG9ydGVyQXJyYXlbaV0udmFsaWRhdGUoYXNzZXQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbXBvcnRlckFycmF5W2ldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYXNzZXREQi5vcHRpb25zLmxldmVsID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEltcG9ydGVyIHZhbGlkYXRlIGZhaWxlZDogJHthc3NldC51dWlkfWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8g5aaC5p6c6L+Y5piv5rKh5pyJ5om+5Yiw5Yy56YWN55qE5a+85YWl5Zmo77yM5YiZ5bCd6K+V5L2/55So6YCa55So5a+85YWl5ZmoXG4gICAgICAgIGNvbnN0IGltcG9ydGVyQXJyYXkgPSB0aGlzLmV4dG5hbWUyaW1wb3J0ZXJbJyonXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IGltcG9ydGVyQXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGUgPSBhd2FpdCBpbXBvcnRlckFycmF5W2ldLnZhbGlkYXRlKGFzc2V0KTtcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGltcG9ydGVyQXJyYXlbaV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5hc3NldERCLm9wdGlvbnMubGV2ZWwgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBJbXBvcnRlciB2YWxpZGF0ZSBmYWlsZWQ6ICR7YXNzZXQudXVpZH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzov57pgJrnlKjlr7zlhaXlmajpg73ml6Dog73kuLrlipvvvIzpgqPlsLHov5Tlm54gbnVsbFxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG5cbi8qKlxuICog5a+85YWl5ZmoXG4gKiDpnIDopoHotJ/otKPmo4Dmn6Xmlofku7bmmK/lkKbkvb/nlKjor6Xlr7zlhaXlmajlr7zlhaXotYTmupBcbiAqIOi1hOa6kOWvvOWFpeeahOa1geeoi++8mlxuICogICAxLiDlsIYgYXNzZXQg5b2T5L2cIHJhdyBhc3NldCDvvIznm7TmjqXmlLnlkI3lpI3liLbliLAgbGlicmFyeSDmlofku7blpLlcbiAqICAgMi4gaW1wb3J0ZXIg5L2c6ICF6Ieq5a6a5LmJ55qEXG4gKi9cbmV4cG9ydCBjbGFzcyBJbXBvcnRlciB7XG5cbiAgICAvLyDmjILovb0gaW1wb3J0ZXIg55qEIGFzc2V0REIg5a6e5L6LXG4gICAgYXNzZXREQjogQXNzZXREQjtcblxuICAgIC8vIOWtmOWCqOW9k+WJjeeahCBpbXBvcnQg5rOo5YaM5LqG5aSa5bCR5Liq5omp5bGV5ZCNXG4gICAgLy8g5Li76KaB55So5LqO5qOA57Si5ZyoIGFzc2V0IGRiIOWGheeahOe0ouW8lVxuICAgIGV4dG5hbWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8g6ZmE5Yqg5YiwIGltcG9ydGVyIOS4iueahOagh+iusFxuICAgIGZsYWc6IHtbbmFtZTogc3RyaW5nXTogYm9vbGVhbn0gPSB7fTtcblxuICAgIC8vIOeJiOacrOWPt++8jOWvvOWFpeWJjeS8muWIpOaWrVxuICAgIC8vIOWmguaenOS4jeS4gOiHtO+8jOWImeS8muWIoOmZpOWvvOWFpeeahOaVsOaNru+8jOW8uuWItumHjeaWsOaJp+ihjOWvvOWFpVxuICAgIGdldCB2ZXJzaW9uKCkge1xuICAgICAgICByZXR1cm4gJzAuMC4xJztcbiAgICB9XG5cbiAgICAvLyDniYjmnKzov4Hnp7vpmJ/liJdcbiAgICBnZXQgbWlncmF0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIFtdIGFzIE1pZ3JhdGVbXTtcbiAgICB9XG5cbiAgICAvLyDmlbDmja7ov4Hnp7vpkqnlrZDlh73mlbBcbiAgICBnZXQgbWlncmF0aW9uSG9vaygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHByZSgpIHt9LFxuICAgICAgICAgICAgcG9zdCgpIHt9LFxuICAgICAgICB9IGFzIE1pZ3JhdGVIb29rO1xuICAgIH1cblxuICAgIC8vIGltcG9ydGVyIOeahOWQjeWtl1xuICAgIGdldCBuYW1lKCkge1xuICAgICAgICByZXR1cm4gJyonO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGFzc2V0REI6IEFzc2V0REIpIHtcbiAgICAgICAgdGhpcy5hc3NldERCID0gYXNzZXREQjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmo4Dmn6Xmlofku7bmmK/lkKbpgILnlKjkuo7ov5nkuKogaW1wb3J0ZXJcbiAgICAgKiBAcGFyYW0gYXNzZXRcbiAgICAgKi9cbiAgICBhc3luYyB2YWxpZGF0ZShhc3NldDogVmlydHVhbEFzc2V0IHwgQXNzZXQpIHtcbiAgICAgICAgcmV0dXJuICFhc3NldC5pc0RpcmVjdG9yeSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOaYr+WQpuW8uuWItuWIt+aWsFxuICAgICAqIEBwYXJhbSBhc3NldFxuICAgICAqL1xuICAgIGFzeW5jIGZvcmNlKGFzc2V0OiBWaXJ0dWFsQXNzZXQgfCBBc3NldCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5byA5aeL5omn6KGM5paH5Lu255qE5a+85YWl5pON5L2cXG4gICAgICogICAxLiDlsIbmlofku7blpI3liLbliLAgbGlicmFyeSDlhoVcbiAgICAgKiBcbiAgICAgKiDov5Tlm57mmK/lkKblr7zlhaXmiJDlip/nmoTmoIforrBcbiAgICAgKiDlpoLmnpzov5Tlm54gZmFsc2XvvIzliJkgaW1wb3J0ZWQg5qCH6K6w5LiN5Lya5Y+Y5oiQIHRydWVcbiAgICAgKiDlkI7nu63nmoTkuIDns7vliJfmk43kvZzpg73kuI3kvJrmiafooYxcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gYXNzZXRcbiAgICAgKi9cbiAgICBhc3luYyBpbXBvcnQoYXNzZXQ6IFZpcnR1YWxBc3NldCB8IEFzc2V0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIC8vIOWmguaenOaYr+iZmuaLn+i1hOa6kO+8jOebtOaOpei/lOWbniBmYWxzZVxuICAgICAgICBpZiAoIShhc3NldCBpbnN0YW5jZW9mIEFzc2V0KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDmianlsZXlkI3vvIzlpoIgLmpzb25cbiAgICAgICAgbGV0IGV4dCA9IGV4dG5hbWUoYXNzZXQuc291cmNlKS50b0xvd2VyQ2FzZSgpOyAvLyDms6jmhI/vvIzov5nph4zkvJrmiormiYDmnInlkI7nvIDnu5/kuIDmlLnmiJDlsI/lhplcblxuICAgICAgICAvLyDlpI3liLYgcmF3IGFzc2V0XG4gICAgICAgIGF3YWl0IGFzc2V0LmNvcHlUb0xpYnJhcnkoZXh0LCBhc3NldC5zb3VyY2UpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBhZnRlclN1YkFzc2V0c0ltcG9ydD8oYXNzZXQ6IFZpcnR1YWxBc3NldCB8IEFzc2V0KTpQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgY2xhc3MgRGVmYXVsdEltcG9ydGVyIGV4dGVuZHMgSW1wb3J0ZXIge1xuXG4gICAgLyoqXG4gICAgICog5qOA5p+l5paH5Lu25piv5ZCm6YCC55So5LqO6L+Z5LiqIGltcG9ydGVyXG4gICAgICogQHBhcmFtIGFzc2V0XG4gICAgICovXG4gICAgYXN5bmMgdmFsaWRhdGUoYXNzZXQ6IFZpcnR1YWxBc3NldCB8IEFzc2V0KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOW8gOWni+aJp+ihjOaWh+S7tueahOWvvOWFpeaTjeS9nFxuICAgICAqICAgMS4g5bCG5paH5Lu25aSN5Yi25YiwIGxpYnJhcnkg5YaFXG4gICAgICogXG4gICAgICog6L+U5Zue5piv5ZCm5a+85YWl5oiQ5Yqf55qE5qCH6K6wXG4gICAgICog5aaC5p6c6L+U5ZueIGZhbHNl77yM5YiZIGltcG9ydGVkIOagh+iusOS4jeS8muWPmOaIkCB0cnVlXG4gICAgICog5ZCO57ut55qE5LiA57O75YiX5pON5L2c6YO95LiN5Lya5omn6KGMXG4gICAgICogXG4gICAgICogQHBhcmFtIGFzc2V0XG4gICAgICovXG4gICAgYXN5bmMgaW1wb3J0KGFzc2V0OiBWaXJ0dWFsQXNzZXQgfCBBc3NldCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICAvLyDlpoLmnpzmmK/omZrmi5/otYTmupDvvIznm7TmjqXov5Tlm54gZmFsc2VcbiAgICAgICAgaWYgKCEoYXNzZXQgaW5zdGFuY2VvZiBBc3NldCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5omp5bGV5ZCN77yM5aaCIC5qc29uXG4gICAgICAgIGxldCBleHQgPSBleHRuYW1lKGFzc2V0LnNvdXJjZSk7XG5cbiAgICAgICAgLy8g5a+85YWl5a+56LGh5piv5paH5Lu25aS577yM5YiZ55u05o6l6Lez6L+HXG4gICAgICAgIGlmIChhd2FpdCBhc3NldC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWkjeWItiByYXcgYXNzZXRcbiAgICAgICAgYXdhaXQgYXNzZXQuY29weVRvTGlicmFyeShleHQsIGFzc2V0LnNvdXJjZSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cbiJdfQ==