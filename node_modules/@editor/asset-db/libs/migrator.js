"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Migrator = void 0;
const utils_1 = require("./utils");
class Migrator {
    constructor(migrations, lastedVersion, hook) {
        this.migrations = migrations;
        this.lastedVersion = lastedVersion;
        this.hook = hook;
        if (hook === null || hook === void 0 ? void 0 : hook.onError) {
            this.onError = hook.onError;
        }
    }
    async run(data, startVersion, extArgs) {
        if (startVersion === this.lastedVersion) {
            return data;
        }
        if (this.hook && this.hook.pre) {
            try {
                await this.hook.pre(data);
            }
            catch (error) {
                this.onError(error, 'preMigrate', data, ...(extArgs || []));
            }
        }
        let res = data;
        for (const task of this.migrations) {
            const index = (0, utils_1.compareVersion)(startVersion, task.version);
            if (index > 0) {
                continue;
            }
            // 迁移流程
            try {
                console.debug(`Migration: -> ${task.version}`);
                res = await task.migrate(res, ...(extArgs || []));
            }
            catch (error) {
                this.onError(error, 'migrate', res, ...(extArgs || []));
            }
        }
        if (this.hook && this.hook.post) {
            try {
                await this.hook.post(data);
            }
            catch (error) {
                this.onError(error, 'postMigrate', data, ...(extArgs || []));
            }
        }
        return res;
    }
    onError(error, stage, data, ...args) {
        console.error(`Migrate error in ${stage}`);
        console.error(error);
    }
}
exports.Migrator = Migrator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlncmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvbGlicy9taWdyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBeUM7QUFxQnpDLE1BQWEsUUFBUTtJQUlqQixZQUFZLFVBQXdCLEVBQUUsYUFBcUIsRUFBRSxJQUFxQjtRQUM5RSxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxPQUFPLEVBQUU7WUFDZixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDL0I7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFPLEVBQUUsWUFBb0IsRUFBRSxPQUFlO1FBQ3BELElBQUksWUFBWSxLQUFLLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUM1QixJQUFJO2dCQUNBLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDN0I7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTthQUM5RDtTQUNKO1FBRUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ2YsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2hDLE1BQU0sS0FBSyxHQUFHLElBQUEsc0JBQWMsRUFBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3pELElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtnQkFDWCxTQUFTO2FBQ1o7WUFFRCxPQUFPO1lBQ1AsSUFBSTtnQkFDQSxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtnQkFDOUMsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3JEO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUE7YUFDMUQ7U0FDSjtRQUVELElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUM3QixJQUFJO2dCQUNBLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDOUI7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTthQUMvRDtTQUNKO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDO0lBRU8sT0FBTyxDQUFDLEtBQVUsRUFBRSxLQUFtQixFQUFFLElBQU8sRUFBRSxHQUFHLElBQVc7UUFDcEUsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUMzQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLENBQUM7Q0FDSjtBQXpERCw0QkF5REMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb21wYXJlVmVyc2lvbiB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCB0eXBlIE1pZ3JhdGVTdGFnZSA9ICdtaWdyYXRlJyB8ICdwcmVNaWdyYXRlJyB8ICdwb3N0TWlncmF0ZSc7XG5cbi8qKlxuICog6L+B56e76Zif5YiXXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWlncmF0ZTxUPiB7XG4gICAgdmVyc2lvbjogc3RyaW5nO1xuICAgIG1pZ3JhdGU6IChkYXRhOiBULCAuLi5hcmdzOiBhbnlbXSkgPT4gUHJvbWlzZTxUPjtcbn1cblxuLyoqXG4gKiDpkqnlrZDlh73mlbBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBNaWdyYXRlSG9vazxUPiB7XG4gICAgcHJlPzogKGRhdGE6IFQsIC4uLmFyZ3M6IGFueVtdKSA9PiBQcm9taXNlPFQ+O1xuICAgIHBvc3Q/OiAoZGF0YTogVCwgLi4uYXJnczogYW55W10pID0+IFByb21pc2U8VD47XG4gICAgb25FcnJvcj86IChlcnJvcjogRXJyb3IsIHN0YWdlOiBNaWdyYXRlU3RhZ2UsIGRhdGE6IFQsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgTWlncmF0b3I8VD4ge1xuICAgIHByaXZhdGUgbWlncmF0aW9uczogTWlncmF0ZTxUPltdO1xuICAgIHByaXZhdGUgaG9vaz86IE1pZ3JhdGVIb29rPFQ+O1xuICAgIHByaXZhdGUgbGFzdGVkVmVyc2lvbjogc3RyaW5nO1xuICAgIGNvbnN0cnVjdG9yKG1pZ3JhdGlvbnM6IE1pZ3JhdGU8VD5bXSwgbGFzdGVkVmVyc2lvbjogc3RyaW5nLCBob29rPzogTWlncmF0ZUhvb2s8VD4pIHtcbiAgICAgICAgdGhpcy5taWdyYXRpb25zID0gbWlncmF0aW9ucztcbiAgICAgICAgdGhpcy5sYXN0ZWRWZXJzaW9uID0gbGFzdGVkVmVyc2lvbjtcbiAgICAgICAgdGhpcy5ob29rID0gaG9vaztcbiAgICAgICAgaWYgKGhvb2s/Lm9uRXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMub25FcnJvciA9IGhvb2sub25FcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHJ1bihkYXRhOiBULCBzdGFydFZlcnNpb246IHN0cmluZywgZXh0QXJncz86IGFueVtdKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGlmIChzdGFydFZlcnNpb24gPT09IHRoaXMubGFzdGVkVmVyc2lvbikge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ob29rICYmIHRoaXMuaG9vay5wcmUpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5ob29rLnByZShkYXRhKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yLCAncHJlTWlncmF0ZScsIGRhdGEsIC4uLihleHRBcmdzIHx8IFtdKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXMgPSBkYXRhO1xuICAgICAgICBmb3IgKGNvbnN0IHRhc2sgb2YgdGhpcy5taWdyYXRpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGNvbXBhcmVWZXJzaW9uKHN0YXJ0VmVyc2lvbiwgdGFzay52ZXJzaW9uKTtcbiAgICAgICAgICAgIGlmIChpbmRleCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g6L+B56e75rWB56iLXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYE1pZ3JhdGlvbjogLT4gJHt0YXNrLnZlcnNpb259YClcbiAgICAgICAgICAgICAgICByZXMgPSBhd2FpdCB0YXNrLm1pZ3JhdGUocmVzLCAuLi4oZXh0QXJncyB8fCBbXSkpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IsICdtaWdyYXRlJywgcmVzLCAuLi4oZXh0QXJncyB8fCBbXSkpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ob29rICYmIHRoaXMuaG9vay5wb3N0KSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuaG9vay5wb3N0KGRhdGEpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IsICdwb3N0TWlncmF0ZScsIGRhdGEsIC4uLihleHRBcmdzIHx8IFtdKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkVycm9yKGVycm9yOiBhbnksIHN0YWdlOiBNaWdyYXRlU3RhZ2UsIGRhdGE6IFQsIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYE1pZ3JhdGUgZXJyb3IgaW4gJHtzdGFnZX1gKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfVxufSJdfQ==