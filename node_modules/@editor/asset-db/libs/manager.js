'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryMissingInfo = exports.importAssociatedAssets = exports.recursiveCheckAssociatedAssets = exports.recursiveGetAssociatedAssets = exports.getAssociatedAssets = exports.refresh = exports.reimport = exports.queryUUID = exports.queryPath = exports.queryUrl = exports.queryAsset = exports.get = exports.map = void 0;
const utils_1 = require("./utils");
const dependency_1 = require("./dependency");
const path_1 = require("path");
const url_1 = require("url");
exports.map = {};
/**
 * 查找已经生成了的资源数据库
 * @param name
 */
function get(name) {
    return exports.map[name] || null;
}
exports.get = get;
/**
 * 给定一个 uuid 或者 url 或者绝对路径，查询一个资源对象
 * @param uuid
 */
function queryAsset(uuid_url_path) {
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const searcher = path.split('@');
            let asset = db.path2asset.get(searcher[0]);
            while (!asset && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                asset = db.path2asset.get(searcher[0]);
            }
            for (let i = 1; i < searcher.length; i++) {
                let sub = asset.subAssets[searcher[i]];
                if (!sub) {
                    return null;
                }
                asset = sub;
            }
            return asset || null;
        }
        return null;
    }
    // 绝对路径
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const searcher = uuid_url_path.split('@');
            const db = exports.map[name];
            let asset = db.path2asset.get(searcher[0]);
            while (!asset && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                asset = db.path2asset.get(searcher[0]);
            }
            if (asset) {
                let asset = db.path2asset.get(searcher[0]);
                for (let i = 1; i < searcher.length; i++) {
                    let sub = asset.subAssets[searcher[i]];
                    if (!sub) {
                        return null;
                    }
                    asset = sub;
                }
                return asset || null;
            }
        }
        return null;
    }
    // uuid
    // 数据库名字列表
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            return asset;
        }
    }
    return null;
}
exports.queryAsset = queryAsset;
/**
 * 查询一个 uuid、绝对路径对应的 url 路径
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_path
 */
function queryUrl(uuid_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_path, db.options.target)) {
                let pathname = (0, path_1.relative)(db.options.target, uuid_path);
                pathname = pathname.replace(/\\/g, '/');
                return `db://${name}/${pathname}`;
            }
        }
        return '';
    }
    // uuid
    const searcher = uuid_path.split('@');
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(searcher[0]);
        if (asset) {
            let url = asset.url;
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    url += `@${searcher[i]}`;
                }
            }
            return url;
        }
    }
    return '';
}
exports.queryUrl = queryUrl;
/**
 * 查询一个 uuid、url 对应的绝对路径地址
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url
 */
function queryPath(uuid_url) {
    // url
    if (uuid_url.startsWith('db://')) {
        uuid_url = encodeURI(uuid_url);
        const uri = (0, url_1.parse)(uuid_url);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            return (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
        }
        return '';
    }
    // uuid
    const searcher = uuid_url.split('@');
    for (let name in exports.map) {
        const db = exports.map[name];
        let path = db.uuidToPath(searcher[0]);
        if (path) {
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    path += `@${searcher[i]}`;
                }
            }
            return path;
        }
    }
    return '';
}
exports.queryPath = queryPath;
/**
 * 查询一个 url、绝对路径对应的 uuid
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url
 */
function queryUUID(url_path) {
    // url
    if (url_path.startsWith('db://')) {
        url_path = encodeURI(url_path);
        const uri = (0, url_1.parse)(url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const searcher = path.split('@');
            let uuid = db.pathToUuid(searcher[0]) || '';
            while (!uuid && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                uuid = db.pathToUuid(searcher[0]) || '';
            }
            if (uuid && searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    uuid += `@${searcher[i]}`;
                }
            }
            return uuid;
        }
        return '';
    }
    // path
    for (let name in exports.map) {
        const db = exports.map[name];
        const searcher = url_path.split('@');
        let uuid = db.pathToUuid(searcher[0]) || '';
        while (!uuid && searcher.length > 1) {
            searcher[0] += '@' + searcher[1];
            searcher.splice(1, 1);
            uuid = db.pathToUuid(searcher[0]) || '';
        }
        if (uuid) {
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    uuid += `@${searcher[i]}`;
                }
            }
            return uuid;
        }
    }
    return '';
}
exports.queryUUID = queryUUID;
/**
 * 重新导入一个资源
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url_path
 */
async function reimport(uuid_url_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_url_path, db.options.target)) {
                const asset = db.path2asset.get(uuid_url_path);
                if (asset) {
                    await db.reimport(uuid_url_path);
                }
                break;
            }
        }
        return;
    }
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const asset = db.path2asset.get(path);
            if (asset) {
                await db.reimport(path);
            }
        }
        return;
    }
    // uuid
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            await db.reimport(uuid_url_path);
            break;
        }
    }
    return;
}
exports.reimport = reimport;
/**
 * 刷新一个资源或者资源目录
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url_path
 */
async function refresh(uuid_url_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_url_path, db.options.target)) {
                await db.refresh(uuid_url_path);
                break;
            }
        }
        return;
    }
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            await db.refresh(path);
        }
        return;
    }
    // uuid
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            await db.refresh(asset.source);
            break;
        }
    }
    return;
}
exports.refresh = refresh;
/**
 * 查找受影响的资源
 * @param asset
 */
function getAssociatedAssets(asset) {
    const files = [];
    const push = (file) => {
        if (files.indexOf(file) !== -1) {
            return;
        }
        files.push(file);
    };
    (0, dependency_1.getAssociatedFiles)(asset.source).forEach(push);
    (0, dependency_1.getAssociatedFiles)(asset.uuid).forEach(push);
    (0, dependency_1.getAssociatedFiles)(asset.url).forEach(push);
    return files;
}
exports.getAssociatedAssets = getAssociatedAssets;
/**
 * 递归资源依赖的所有资源
 * @param asset
 * @param handle
 */
function recursiveGetAssociatedAssets(asset, handle) {
    handle(asset);
    const files = getAssociatedAssets(asset);
    const others = [];
    files.forEach((file) => {
        const asset = queryAsset(file);
        if (asset) {
            handle(asset);
            others.push(...recursiveGetAssociatedAssets(asset, handle));
        }
    });
    return [...files, ...others];
}
exports.recursiveGetAssociatedAssets = recursiveGetAssociatedAssets;
/**
 * 递归检查是否允许插入依赖
 * asset 依赖 fileOrUuidOrUrl
 * 检查是否有循环依赖出现
 * @param fileOrUuidOrUrl
 * @param asset
 */
function recursiveCheckAssociatedAssets(fileOrUuidOrUrl, asset) {
    let success = true;
    recursiveGetAssociatedAssets(asset, function (asset) {
        if (asset.source === fileOrUuidOrUrl &&
            asset.url === fileOrUuidOrUrl &&
            asset.uuid === fileOrUuidOrUrl) {
            success = false;
        }
    });
    return success;
}
exports.recursiveCheckAssociatedAssets = recursiveCheckAssociatedAssets;
/**
 * 重新导入受影响的资源
 * @param database
 * @param asset
 */
function importAssociatedAssets(database, asset) {
    // 触发依赖这个资源的额其他资源自动重新导入
    // 但是这个重新导入其他资源的流程就不需要等待勒
    const files = getAssociatedAssets(asset);
    files.forEach((file) => {
        reimport(file);
    });
}
exports.importAssociatedAssets = importAssociatedAssets;
function queryMissingInfo(uuid) {
    for (let name in exports.map) {
        const db = exports.map[name];
        const info = db.infoManager.getMissingInfo(uuid);
        if (info) {
            return info;
        }
    }
    return null;
}
exports.queryMissingInfo = queryMissingInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFLYixtQ0FBb0M7QUFDcEMsNkNBQWtEO0FBQ2xELCtCQUFrRDtBQUNsRCw2QkFBNEI7QUFFZixRQUFBLEdBQUcsR0FBaUMsRUFBRSxDQUFDO0FBRXBEOzs7R0FHRztBQUNILFNBQWdCLEdBQUcsQ0FBQyxJQUFZO0lBQzVCLE9BQU8sV0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztBQUM3QixDQUFDO0FBRkQsa0JBRUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixVQUFVLENBQUMsYUFBcUI7SUFDNUMsTUFBTTtJQUNOLElBQUksYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUNuQyxhQUFhLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sR0FBRyxHQUFHLElBQUEsV0FBSyxFQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2pDLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUEsV0FBSSxFQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFakMsSUFBSSxLQUFLLEdBQXFDLEVBQUUsQ0FBQyxVQUFV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QUNKO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQVRELDRDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgdHlwZSB7IEFzc2V0REIgfSBmcm9tICcuL2Fzc2V0LWRiJztcbmltcG9ydCB0eXBlIHsgQXNzZXQsIFZpcnR1YWxBc3NldCB9IGZyb20gJy4vYXNzZXQnO1xuXG5pbXBvcnQgeyBpc1N1YlBhdGggfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IGdldEFzc29jaWF0ZWRGaWxlcyB9IGZyb20gJy4vZGVwZW5kZW5jeSc7XG5pbXBvcnQgeyBpc0Fic29sdXRlLCByZWxhdGl2ZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcGFyc2UgfSBmcm9tICd1cmwnO1xuXG5leHBvcnQgY29uc3QgbWFwOiB7IFtpbmRleDogc3RyaW5nXTogQXNzZXREQiB9ID0ge307XG5cbi8qKlxuICog5p+l5om+5bey57uP55Sf5oiQ5LqG55qE6LWE5rqQ5pWw5o2u5bqTXG4gKiBAcGFyYW0gbmFtZSBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldChuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbWFwW25hbWVdIHx8IG51bGw7XG59XG5cbi8qKlxuICog57uZ5a6a5LiA5LiqIHV1aWQg5oiW6ICFIHVybCDmiJbogIXnu53lr7not6/lvoTvvIzmn6Xor6LkuIDkuKrotYTmupDlr7nosaFcbiAqIEBwYXJhbSB1dWlkIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlBc3NldCh1dWlkX3VybF9wYXRoOiBzdHJpbmcpOiBBc3NldCB8IFZpcnR1YWxBc3NldCB8IG51bGwge1xuICAgIC8vIHVybFxuICAgIGlmICh1dWlkX3VybF9wYXRoLnN0YXJ0c1dpdGgoJ2RiOi8vJykpIHtcbiAgICAgICAgdXVpZF91cmxfcGF0aCA9IGVuY29kZVVSSSh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgY29uc3QgdXJpID0gcGFyc2UodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGlmICh1cmkuaG9zdCAmJiBtYXBbdXJpLmhvc3RdKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFt1cmkuaG9zdCB8fCAnJ107XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gam9pbihkYi5vcHRpb25zLnRhcmdldCwgZGVjb2RlVVJJQ29tcG9uZW50KCh1cmkucGF0aCB8fCAnJykgKyAodXJpLmhhc2ggfHwgJycpKSk7XG4gICAgICAgICAgICBjb25zdCBzZWFyY2hlciA9IHBhdGguc3BsaXQoJ0AnKTtcblxuICAgICAgICAgICAgbGV0IGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCB8IHVuZGVmaW5lZCA9IGRiLnBhdGgyYXNzZXQuZ2V0KHNlYXJjaGVyWzBdKTtcblxuXG4gICAgICAgICAgICB3aGlsZSAoIWFzc2V0ICYmIHNlYXJjaGVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBzZWFyY2hlclswXSArPSAnQCcgKyBzZWFyY2hlclsxXTtcbiAgICAgICAgICAgICAgICBzZWFyY2hlci5zcGxpY2UoMSwgMSk7XG4gICAgICAgICAgICAgICAgYXNzZXQgPSBkYi5wYXRoMmFzc2V0LmdldChzZWFyY2hlclswXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgc3ViID0gYXNzZXQhLnN1YkFzc2V0c1tzZWFyY2hlcltpXV07XG4gICAgICAgICAgICAgICAgaWYgKCFzdWIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFzc2V0ID0gc3ViO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFzc2V0IHx8IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8g57ud5a+56Lev5b6EXG4gICAgaWYgKGlzQWJzb2x1dGUodXVpZF91cmxfcGF0aCkpIHtcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaGVyID0gdXVpZF91cmxfcGF0aC5zcGxpdCgnQCcpO1xuICAgICAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgICAgICBsZXQgYXNzZXQgPSBkYi5wYXRoMmFzc2V0LmdldChzZWFyY2hlclswXSk7XG5cbiAgICAgICAgICAgIHdoaWxlICghYXNzZXQgJiYgc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIHNlYXJjaGVyWzBdICs9ICdAJyArIHNlYXJjaGVyWzFdO1xuICAgICAgICAgICAgICAgIHNlYXJjaGVyLnNwbGljZSgxLCAxKTtcbiAgICAgICAgICAgICAgICBhc3NldCA9IGRiLnBhdGgyYXNzZXQuZ2V0KHNlYXJjaGVyWzBdKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCB8IHVuZGVmaW5lZCA9IGRiLnBhdGgyYXNzZXQuZ2V0KHNlYXJjaGVyWzBdKTtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YiA9IGFzc2V0IS5zdWJBc3NldHNbc2VhcmNoZXJbaV1dO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXN1Yikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXNzZXQgPSBzdWI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBhc3NldCB8fCBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIHV1aWRcbiAgICAvLyDmlbDmja7lupPlkI3lrZfliJfooahcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBkYi5nZXRBc3NldCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gYXNzZXQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiDmn6Xor6LkuIDkuKogdXVpZOOAgee7neWvuei3r+W+hOWvueW6lOeahCB1cmwg6Lev5b6EXG4gKiB1cmwg5qC85byP5Li6IGRiOi8vZGF0YWJhc2VfbmFtZS9zb3VyY2VfcGF0aEB4eHhcbiAqIOe7neWvuei3r+W+hOivt+S9v+eUqOezu+e7n+WIhumalOespu+8jOaWh+S7tuWkueacq+WwvuS4jemcgOimgeW4puWIhumalOespu+8iG1hY++8mi8gIHdpbu+8mlxcXFzvvIlcbiAqIEBwYXJhbSB1dWlkX3BhdGggXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeVVybCh1dWlkX3BhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gcGF0aFxuICAgIGlmIChpc0Fic29sdXRlKHV1aWRfcGF0aCkpIHtcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICAgICAgaWYgKGlzU3ViUGF0aCh1dWlkX3BhdGgsIGRiLm9wdGlvbnMudGFyZ2V0KSkge1xuICAgICAgICAgICAgICAgIGxldCBwYXRobmFtZSA9IHJlbGF0aXZlKGRiLm9wdGlvbnMudGFyZ2V0LCB1dWlkX3BhdGgpO1xuICAgICAgICAgICAgICAgIHBhdGhuYW1lID0gcGF0aG5hbWUucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBgZGI6Ly8ke25hbWV9LyR7cGF0aG5hbWV9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLy8gdXVpZFxuICAgIGNvbnN0IHNlYXJjaGVyID0gdXVpZF9wYXRoLnNwbGl0KCdAJyk7XG4gICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gZGIuZ2V0QXNzZXQoc2VhcmNoZXJbMF0pO1xuXG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgbGV0IHVybCA9IGFzc2V0LnVybDtcbiAgICAgICAgICAgIGlmIChzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzZWFyY2hlci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB1cmwgKz0gYEAke3NlYXJjaGVyW2ldfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVybDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gJyc7XG59XG5cbi8qKlxuICog5p+l6K+i5LiA5LiqIHV1aWTjgIF1cmwg5a+55bqU55qE57ud5a+56Lev5b6E5Zyw5Z2AXG4gKiB1cmwg5qC85byP5Li6IGRiOi8vZGF0YWJhc2VfbmFtZS9zb3VyY2VfcGF0aEB4eHhcbiAqIOe7neWvuei3r+W+hOivt+S9v+eUqOezu+e7n+WIhumalOespu+8jOaWh+S7tuWkueacq+WwvuS4jemcgOimgeW4puWIhumalOespu+8iG1hY++8mi8gIHdpbu+8mlxcXFzvvIlcbiAqIEBwYXJhbSB1dWlkX3VybCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5UGF0aCh1dWlkX3VybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyB1cmxcbiAgICBpZiAodXVpZF91cmwuc3RhcnRzV2l0aCgnZGI6Ly8nKSkge1xuICAgICAgICB1dWlkX3VybCA9IGVuY29kZVVSSSh1dWlkX3VybCk7XG4gICAgICAgIGNvbnN0IHVyaSA9IHBhcnNlKHV1aWRfdXJsKTtcbiAgICAgICAgaWYgKHVyaS5ob3N0ICYmIG1hcFt1cmkuaG9zdF0pIHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW3VyaS5ob3N0IHx8ICcnXTtcbiAgICAgICAgICAgIHJldHVybiBqb2luKGRiLm9wdGlvbnMudGFyZ2V0LCBkZWNvZGVVUklDb21wb25lbnQoKHVyaS5wYXRoIHx8ICcnKSArICh1cmkuaGFzaCB8fCAnJykpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLy8gdXVpZFxuICAgIGNvbnN0IHNlYXJjaGVyID0gdXVpZF91cmwuc3BsaXQoJ0AnKTtcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgbGV0IHBhdGggPSBkYi51dWlkVG9QYXRoKHNlYXJjaGVyWzBdKTtcbiAgICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgICAgIGlmIChzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzZWFyY2hlci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBwYXRoICs9IGBAJHtzZWFyY2hlcltpXX1gO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwYXRoO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuICcnO1xufVxuXG4vKipcbiAqIOafpeivouS4gOS4qiB1cmzjgIHnu53lr7not6/lvoTlr7nlupTnmoQgdXVpZFxuICogdXJsIOagvOW8j+S4uiBkYjovL2RhdGFiYXNlX25hbWUvc291cmNlX3BhdGhAeHh4XG4gKiDnu53lr7not6/lvoTor7fkvb/nlKjns7vnu5/liIbpmpTnrKbvvIzmlofku7blpLnmnKvlsL7kuI3pnIDopoHluKbliIbpmpTnrKbvvIhtYWPvvJovICB3aW7vvJpcXFxc77yJXG4gKiBAcGFyYW0gdXVpZF91cmwgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeVVVSUQodXJsX3BhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gdXJsXG4gICAgaWYgKHVybF9wYXRoLnN0YXJ0c1dpdGgoJ2RiOi8vJykpIHtcbiAgICAgICAgdXJsX3BhdGggPSBlbmNvZGVVUkkodXJsX3BhdGgpO1xuICAgICAgICBjb25zdCB1cmkgPSBwYXJzZSh1cmxfcGF0aCk7XG4gICAgICAgIGlmICh1cmkuaG9zdCAmJiBtYXBbdXJpLmhvc3RdKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFt1cmkuaG9zdCB8fCAnJ107XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gam9pbihkYi5vcHRpb25zLnRhcmdldCwgZGVjb2RlVVJJQ29tcG9uZW50KCh1cmkucGF0aCB8fCAnJykgKyAodXJpLmhhc2ggfHwgJycpKSk7XG4gICAgICAgICAgICBjb25zdCBzZWFyY2hlciA9IHBhdGguc3BsaXQoJ0AnKTtcbiAgICAgICAgICAgIGxldCB1dWlkID0gZGIucGF0aFRvVXVpZChzZWFyY2hlclswXSkgfHwgJyc7XG5cbiAgICAgICAgICAgIHdoaWxlICghdXVpZCAmJiBzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgc2VhcmNoZXJbMF0gKz0gJ0AnICsgc2VhcmNoZXJbMV07XG4gICAgICAgICAgICAgICAgc2VhcmNoZXIuc3BsaWNlKDEsIDEpO1xuICAgICAgICAgICAgICAgIHV1aWQgPSBkYi5wYXRoVG9VdWlkKHNlYXJjaGVyWzBdKSB8fCAnJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHV1aWQgJiYgc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdXVpZCArPSBgQCR7c2VhcmNoZXJbaV19YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdXVpZDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLy8gcGF0aFxuICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICBjb25zdCBzZWFyY2hlciA9IHVybF9wYXRoLnNwbGl0KCdAJyk7XG4gICAgICAgIGxldCB1dWlkID0gZGIucGF0aFRvVXVpZChzZWFyY2hlclswXSkgfHwgJyc7XG5cbiAgICAgICAgd2hpbGUgKCF1dWlkICYmIHNlYXJjaGVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHNlYXJjaGVyWzBdICs9ICdAJyArIHNlYXJjaGVyWzFdO1xuICAgICAgICAgICAgc2VhcmNoZXIuc3BsaWNlKDEsIDEpO1xuICAgICAgICAgICAgdXVpZCA9IGRiLnBhdGhUb1V1aWQoc2VhcmNoZXJbMF0pIHx8ICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHV1aWQpIHtcbiAgICAgICAgICAgIGlmIChzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzZWFyY2hlci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB1dWlkICs9IGBAJHtzZWFyY2hlcltpXX1gO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1dWlkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuICcnO1xufVxuXG4vKipcbiAqIOmHjeaWsOWvvOWFpeS4gOS4qui1hOa6kFxuICogdXJsIOagvOW8j+S4uiBkYjovL2RhdGFiYXNlX25hbWUvc291cmNlX3BhdGhAeHh4XG4gKiDnu53lr7not6/lvoTor7fkvb/nlKjns7vnu5/liIbpmpTnrKbvvIzmlofku7blpLnmnKvlsL7kuI3pnIDopoHluKbliIbpmpTnrKbvvIhtYWPvvJovICB3aW7vvJpcXFxc77yJXG4gKiBAcGFyYW0gdXVpZF91cmxfcGF0aCBcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlaW1wb3J0KHV1aWRfdXJsX3BhdGg6IHN0cmluZykge1xuICAgIC8vIHBhdGhcbiAgICBpZiAoaXNBYnNvbHV0ZSh1dWlkX3VybF9wYXRoKSkge1xuICAgICAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgICAgICBpZiAoaXNTdWJQYXRoKHV1aWRfdXJsX3BhdGgsIGRiLm9wdGlvbnMudGFyZ2V0KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gZGIucGF0aDJhc3NldC5nZXQodXVpZF91cmxfcGF0aCk7XG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRiLnJlaW1wb3J0KHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gdXJsXG4gICAgaWYgKHV1aWRfdXJsX3BhdGguc3RhcnRzV2l0aCgnZGI6Ly8nKSkge1xuICAgICAgICB1dWlkX3VybF9wYXRoID0gZW5jb2RlVVJJKHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICBjb25zdCB1cmkgPSBwYXJzZSh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgaWYgKHVyaS5ob3N0ICYmIG1hcFt1cmkuaG9zdF0pIHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW3VyaS5ob3N0IHx8ICcnXTtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBqb2luKGRiLm9wdGlvbnMudGFyZ2V0LCBkZWNvZGVVUklDb21wb25lbnQoKHVyaS5wYXRoIHx8ICcnKSArICh1cmkuaGFzaCB8fCAnJykpKTtcbiAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gZGIucGF0aDJhc3NldC5nZXQocGF0aCk7XG4gICAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBkYi5yZWltcG9ydChwYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gdXVpZFxuICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICBjb25zdCBhc3NldCA9IGRiLmdldEFzc2V0KHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGF3YWl0IGRiLnJlaW1wb3J0KHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuO1xufVxuXG4vKipcbiAqIOWIt+aWsOS4gOS4qui1hOa6kOaIluiAhei1hOa6kOebruW9lVxuICogdXJsIOagvOW8j+S4uiBkYjovL2RhdGFiYXNlX25hbWUvc291cmNlX3BhdGhAeHh4XG4gKiDnu53lr7not6/lvoTor7fkvb/nlKjns7vnu5/liIbpmpTnrKbvvIzmlofku7blpLnmnKvlsL7kuI3pnIDopoHluKbliIbpmpTnrKbvvIhtYWPvvJovICB3aW7vvJpcXFxc77yJXG4gKiBAcGFyYW0gdXVpZF91cmxfcGF0aCBcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlZnJlc2godXVpZF91cmxfcGF0aDogc3RyaW5nKSB7XG4gICAgLy8gcGF0aFxuICAgIGlmIChpc0Fic29sdXRlKHV1aWRfdXJsX3BhdGgpKSB7XG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgICAgIGlmIChpc1N1YlBhdGgodXVpZF91cmxfcGF0aCwgZGIub3B0aW9ucy50YXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZGIucmVmcmVzaCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gdXJsXG4gICAgaWYgKHV1aWRfdXJsX3BhdGguc3RhcnRzV2l0aCgnZGI6Ly8nKSkge1xuICAgICAgICB1dWlkX3VybF9wYXRoID0gZW5jb2RlVVJJKHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICBjb25zdCB1cmkgPSBwYXJzZSh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgaWYgKHVyaS5ob3N0ICYmIG1hcFt1cmkuaG9zdF0pIHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW3VyaS5ob3N0IHx8ICcnXTtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBqb2luKGRiLm9wdGlvbnMudGFyZ2V0LCBkZWNvZGVVUklDb21wb25lbnQoKHVyaS5wYXRoIHx8ICcnKSArICh1cmkuaGFzaCB8fCAnJykpKTtcbiAgICAgICAgICAgIGF3YWl0IGRiLnJlZnJlc2gocGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHV1aWRcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBkYi5nZXRBc3NldCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5yZWZyZXNoKGFzc2V0LnNvdXJjZSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm47XG59XG5cbi8qKlxuICog5p+l5om+5Y+X5b2x5ZON55qE6LWE5rqQXG4gKiBAcGFyYW0gYXNzZXQgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRBc3NvY2lhdGVkQXNzZXRzKGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCkge1xuICAgIGNvbnN0IGZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHB1c2ggPSAoZmlsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGlmIChmaWxlcy5pbmRleE9mKGZpbGUpICE9PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGZpbGVzLnB1c2goZmlsZSk7XG4gICAgfVxuICAgIGdldEFzc29jaWF0ZWRGaWxlcyhhc3NldC5zb3VyY2UpLmZvckVhY2gocHVzaCk7XG4gICAgZ2V0QXNzb2NpYXRlZEZpbGVzKGFzc2V0LnV1aWQpLmZvckVhY2gocHVzaCk7XG4gICAgZ2V0QXNzb2NpYXRlZEZpbGVzKGFzc2V0LnVybCkuZm9yRWFjaChwdXNoKTtcbiAgICByZXR1cm4gZmlsZXM7XG59XG5cbi8qKlxuICog6YCS5b2S6LWE5rqQ5L6d6LWW55qE5omA5pyJ6LWE5rqQXG4gKiBAcGFyYW0gYXNzZXQgXG4gKiBAcGFyYW0gaGFuZGxlIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVjdXJzaXZlR2V0QXNzb2NpYXRlZEFzc2V0cyhhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQsIGhhbmRsZTogRnVuY3Rpb24pIHtcbiAgICBoYW5kbGUoYXNzZXQpO1xuICAgIGNvbnN0IGZpbGVzID0gZ2V0QXNzb2NpYXRlZEFzc2V0cyhhc3NldCk7XG4gICAgY29uc3Qgb3RoZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBxdWVyeUFzc2V0KGZpbGUpO1xuICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGhhbmRsZShhc3NldCk7XG4gICAgICAgICAgICBvdGhlcnMucHVzaCguLi5yZWN1cnNpdmVHZXRBc3NvY2lhdGVkQXNzZXRzKGFzc2V0LCBoYW5kbGUpKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBbLi4uZmlsZXMsIC4uLm90aGVyc107XG59XG5cbi8qKlxuICog6YCS5b2S5qOA5p+l5piv5ZCm5YWB6K645o+S5YWl5L6d6LWWXG4gKiBhc3NldCDkvp3otZYgZmlsZU9yVXVpZE9yVXJsXG4gKiDmo4Dmn6XmmK/lkKbmnInlvqrnjq/kvp3otZblh7rnjrBcbiAqIEBwYXJhbSBmaWxlT3JVdWlkT3JVcmxcbiAqIEBwYXJhbSBhc3NldCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlY3Vyc2l2ZUNoZWNrQXNzb2NpYXRlZEFzc2V0cyhmaWxlT3JVdWlkT3JVcmw6IHN0cmluZywgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0KSB7XG4gICAgbGV0IHN1Y2Nlc3MgPSB0cnVlO1xuICAgIHJlY3Vyc2l2ZUdldEFzc29jaWF0ZWRBc3NldHMoYXNzZXQsIGZ1bmN0aW9uIChhc3NldCkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBhc3NldC5zb3VyY2UgPT09IGZpbGVPclV1aWRPclVybCAmJlxuICAgICAgICAgICAgYXNzZXQudXJsID09PSBmaWxlT3JVdWlkT3JVcmwgJiZcbiAgICAgICAgICAgIGFzc2V0LnV1aWQgPT09IGZpbGVPclV1aWRPclVybFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBzdWNjZXNzO1xufVxuXG4vKipcbiAqIOmHjeaWsOWvvOWFpeWPl+W9seWTjeeahOi1hOa6kFxuICogQHBhcmFtIGRhdGFiYXNlIFxuICogQHBhcmFtIGFzc2V0IFxuICovXG5leHBvcnQgZnVuY3Rpb24gaW1wb3J0QXNzb2NpYXRlZEFzc2V0cyhkYXRhYmFzZTogQXNzZXREQiwgYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0KSB7XG4gICAgLy8g6Kem5Y+R5L6d6LWW6L+Z5Liq6LWE5rqQ55qE6aKd5YW25LuW6LWE5rqQ6Ieq5Yqo6YeN5paw5a+85YWlXG4gICAgLy8g5L2G5piv6L+Z5Liq6YeN5paw5a+85YWl5YW25LuW6LWE5rqQ55qE5rWB56iL5bCx5LiN6ZyA6KaB562J5b6F5YuSXG4gICAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gZ2V0QXNzb2NpYXRlZEFzc2V0cyhhc3NldClcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgICAgIHJlaW1wb3J0KGZpbGUpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlNaXNzaW5nSW5mbyh1dWlkOiBzdHJpbmcpIHtcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgY29uc3QgaW5mbyA9IGRiLmluZm9NYW5hZ2VyLmdldE1pc3NpbmdJbmZvKHV1aWQpO1xuICAgICAgICBpZiAoaW5mbykge1xuICAgICAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59Il19