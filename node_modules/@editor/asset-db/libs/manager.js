'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryMissingInfo = exports.importAssociatedAssets = exports.recursiveCheckAssociatedAssets = exports.recursiveGetAssociatedAssets = exports.getAssociatedAssets = exports.refresh = exports.reimport = exports.queryUUID = exports.queryPath = exports.queryUrl = exports.queryAsset = exports.get = exports.map = void 0;
const utils_1 = require("./utils");
const dependency_1 = require("./dependency");
const path_1 = require("path");
const url_1 = require("url");
exports.map = {};
/**
 * 查找已经生成了的资源数据库
 * @param name
 */
function get(name) {
    return exports.map[name] || null;
}
exports.get = get;
/**
 * 给定一个 uuid 或者 url 或者绝对路径，查询一个资源对象
 * @param uuid
 */
function queryAsset(uuid_url_path) {
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const searcher = path.split('@');
            let asset = db.path2asset.get(searcher[0]);
            while (!asset && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                asset = db.path2asset.get(searcher[0]);
            }
            for (let i = 1; i < searcher.length; i++) {
                let sub = asset.subAssets[searcher[i]];
                if (!sub) {
                    return null;
                }
                asset = sub;
            }
            return asset || null;
        }
        return null;
    }
    // 绝对路径
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const searcher = uuid_url_path.split('@');
            const db = exports.map[name];
            let asset = db.path2asset.get(searcher[0]);
            while (!asset && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                asset = db.path2asset.get(searcher[0]);
            }
            if (asset) {
                let asset = db.path2asset.get(searcher[0]);
                for (let i = 1; i < searcher.length; i++) {
                    let sub = asset.subAssets[searcher[i]];
                    if (!sub) {
                        return null;
                    }
                    asset = sub;
                }
                return asset || null;
            }
        }
        return null;
    }
    // uuid
    // 数据库名字列表
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            return asset;
        }
    }
    return null;
}
exports.queryAsset = queryAsset;
/**
 * 查询一个 uuid、绝对路径对应的 url 路径
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_path
 */
function queryUrl(uuid_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_path, db.options.target)) {
                let pathname = (0, path_1.relative)(db.options.target, uuid_path);
                pathname = pathname.replace(/\\/g, '/');
                return `db://${name}/${pathname}`;
            }
        }
        return '';
    }
    // uuid
    const searcher = uuid_path.split('@');
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(searcher[0]);
        if (asset) {
            let url = asset.url;
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    url += `@${searcher[i]}`;
                }
            }
            return url;
        }
    }
    return '';
}
exports.queryUrl = queryUrl;
/**
 * 查询一个 uuid、url 对应的绝对路径地址
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url
 */
function queryPath(uuid_url) {
    // url
    if (uuid_url.startsWith('db://')) {
        uuid_url = encodeURI(uuid_url);
        const uri = (0, url_1.parse)(uuid_url);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            return (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
        }
        return '';
    }
    // uuid
    const searcher = uuid_url.split('@');
    for (let name in exports.map) {
        const db = exports.map[name];
        let path = db.uuidToPath(searcher[0]);
        if (path) {
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    path += `@${searcher[i]}`;
                }
            }
            return path;
        }
    }
    return '';
}
exports.queryPath = queryPath;
/**
 * 查询一个 url、绝对路径对应的 uuid
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url
 */
function queryUUID(url_path) {
    // url
    if (url_path.startsWith('db://')) {
        url_path = encodeURI(url_path);
        const uri = (0, url_1.parse)(url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const searcher = path.split('@');
            let uuid = db.pathToUuid(searcher[0]) || '';
            while (!uuid && searcher.length > 1) {
                searcher[0] += '@' + searcher[1];
                searcher.splice(1, 1);
                uuid = db.pathToUuid(searcher[0]) || '';
            }
            if (uuid && searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    uuid += `@${searcher[i]}`;
                }
            }
            return uuid;
        }
        return '';
    }
    // path
    for (let name in exports.map) {
        const db = exports.map[name];
        const searcher = url_path.split('@');
        let uuid = db.pathToUuid(searcher[0]) || '';
        while (!uuid && searcher.length > 1) {
            searcher[0] += '@' + searcher[1];
            searcher.splice(1, 1);
            uuid = db.pathToUuid(searcher[0]) || '';
        }
        if (uuid) {
            if (searcher.length > 1) {
                for (let i = 1; i < searcher.length; i++) {
                    uuid += `@${searcher[i]}`;
                }
            }
            return uuid;
        }
    }
    return '';
}
exports.queryUUID = queryUUID;
/**
 * 重新导入一个资源
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url_path
 */
async function reimport(uuid_url_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_url_path, db.options.target)) {
                const asset = db.path2asset.get(uuid_url_path);
                if (asset) {
                    await db.reimport(uuid_url_path);
                }
                break;
            }
        }
        return;
    }
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            const asset = db.path2asset.get(path);
            if (asset) {
                await db.reimport(path);
            }
        }
        return;
    }
    // uuid
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            await db.reimport(uuid_url_path);
            break;
        }
    }
    return;
}
exports.reimport = reimport;
/**
 * 刷新一个资源或者资源目录
 * url 格式为 db://database_name/source_path@xxx
 * 绝对路径请使用系统分隔符，文件夹末尾不需要带分隔符（mac：/  win：\\）
 * @param uuid_url_path
 */
async function refresh(uuid_url_path) {
    // path
    if ((0, path_1.isAbsolute)(uuid_url_path)) {
        for (let name in exports.map) {
            const db = exports.map[name];
            if ((0, utils_1.isSubPath)(uuid_url_path, db.options.target)) {
                await db.refresh(uuid_url_path);
                break;
            }
        }
        return;
    }
    // url
    if (uuid_url_path.startsWith('db://')) {
        uuid_url_path = encodeURI(uuid_url_path);
        const uri = (0, url_1.parse)(uuid_url_path);
        if (uri.host && exports.map[uri.host]) {
            const db = exports.map[uri.host || ''];
            const path = (0, path_1.join)(db.options.target, decodeURIComponent((uri.path || '') + (uri.hash || '')));
            await db.refresh(path);
        }
        return;
    }
    // uuid
    for (let name in exports.map) {
        const db = exports.map[name];
        const asset = db.getAsset(uuid_url_path);
        if (asset) {
            await db.refresh(asset.source);
            break;
        }
    }
    return;
}
exports.refresh = refresh;
/**
 * 查找受影响的资源
 * @param asset
 */
function getAssociatedAssets(asset) {
    const files = [];
    const push = (file) => {
        if (files.indexOf(file) !== -1) {
            return;
        }
        files.push(file);
    };
    (0, dependency_1.getAssociatedFiles)(asset.source).forEach(push);
    (0, dependency_1.getAssociatedFiles)(asset.uuid).forEach(push);
    (0, dependency_1.getAssociatedFiles)(asset.url).forEach(push);
    return files;
}
exports.getAssociatedAssets = getAssociatedAssets;
/**
 * 递归资源依赖的所有资源
 * @param asset
 * @param handle
 */
function recursiveGetAssociatedAssets(asset, handle) {
    handle(asset);
    const files = getAssociatedAssets(asset);
    const others = [];
    files.forEach((file) => {
        const asset = queryAsset(file);
        if (asset) {
            handle(asset);
            others.push(...recursiveGetAssociatedAssets(asset, handle));
        }
    });
    return [...files, ...others];
}
exports.recursiveGetAssociatedAssets = recursiveGetAssociatedAssets;
/**
 * 递归检查是否允许插入依赖
 * asset 依赖 fileOrUuidOrUrl
 * 检查是否有循环依赖出现
 * @param fileOrUuidOrUrl
 * @param asset
 */
function recursiveCheckAssociatedAssets(fileOrUuidOrUrl, asset) {
    let success = true;
    recursiveGetAssociatedAssets(asset, function (asset) {
        if (asset.source === fileOrUuidOrUrl &&
            asset.url === fileOrUuidOrUrl &&
            asset.uuid === fileOrUuidOrUrl) {
            success == false;
        }
    });
    return success;
}
exports.recursiveCheckAssociatedAssets = recursiveCheckAssociatedAssets;
/**
 * 重新导入受影响的资源
 * @param database
 * @param asset
 */
function importAssociatedAssets(database, asset) {
    // 触发依赖这个资源的额其他资源自动重新导入
    // 但是这个重新导入其他资源的流程就不需要等待勒
    const files = getAssociatedAssets(asset);
    files.forEach((file) => {
        reimport(file);
    });
}
exports.importAssociatedAssets = importAssociatedAssets;
function queryMissingInfo(uuid) {
    for (let name in exports.map) {
        const db = exports.map[name];
        const info = db.infoManager.getMissingInfo(uuid);
        if (info) {
            return info;
        }
    }
    return null;
}
exports.queryMissingInfo = queryMissingInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFLYixtQ0FBb0M7QUFDcEMsNkNBQWtEO0FBQ2xELCtCQUFrRDtBQUNsRCw2QkFBNEI7QUFFZixRQUFBLEdBQUcsR0FBK0IsRUFBRSxDQUFDO0FBRWxEOzs7R0FHRztBQUNILFNBQWdCLEdBQUcsQ0FBQyxJQUFZO0lBQzVCLE9BQU8sV0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztBQUM3QixDQUFDO0FBRkQsa0JBRUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixVQUFVLENBQUMsYUFBcUI7SUFDNUMsTUFBTTtJQUNOLElBQUksYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUNuQyxhQUFhLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sR0FBRyxHQUFHLElBQUEsV0FBSyxFQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2pDLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUEsV0FBSSxFQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFakMsSUFBSSxLQUFLLEdBQXFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRzdFLE9BQU8sQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2xDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdEIsS0FBSyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzFDO1lBRUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RDLElBQUksR0FBRyxHQUFHLEtBQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ04sT0FBTyxJQUFJLENBQUM7aUJBQ2Y7Z0JBQ0QsS0FBSyxHQUFHLEdBQUcsQ0FBQzthQUNmO1lBQ0QsT0FBTyxLQUFLLElBQUksSUFBSSxDQUFDO1NBQ3hCO1FBQ0QsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELE9BQU87SUFDUCxJQUFJLElBQUEsaUJBQVUsRUFBQyxhQUFhLENBQUMsRUFBRTtRQUMzQixLQUFLLElBQUksSUFBSSxJQUFJLFdBQUcsRUFBRTtZQUNsQixNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQixJQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUzQyxPQUFPLENBQUMsS0FBSyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEtBQUssR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxQztZQUVELElBQUksS0FBSyxFQUFFO2dCQUNQLElBQUksS0FBSyxHQUFxQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFN0UsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3RDLElBQUksR0FBRyxHQUFHLEtBQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3hDLElBQUksQ0FBQyxHQUFHLEVBQUU7d0JBQ04sT0FBTyxJQUFJLENBQUM7cUJBQ2Y7b0JBQ0QsS0FBSyxHQUFHLEdBQUcsQ0FBQztpQkFDZjtnQkFDRCxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUM7YUFDeEI7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFFRCxPQUFPO0lBQ1AsVUFBVTtJQUNWLEtBQUssSUFBSSxJQUFJLElBQUksV0FBRyxFQUFFO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyQixNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3pDLElBQUksS0FBSyxFQUFFO1lBQ1AsT0FBTyxLQUFLLENBQUM7U0FDaEI7S0FDSjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUF2RUQsZ0NBdUVDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixRQUFRLENBQUMsU0FBaUI7SUFDdEMsT0FBTztJQUNQLElBQUksSUFBQSxpQkFBVSxFQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQ3ZCLEtBQUssSUFBSSxJQUFJLElBQUksV0FBRyxFQUFFO1lBQ2xCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQixJQUFJLElBQUEsaUJBQVMsRUFBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDekMsSUFBSSxRQUFRLEdBQUcsSUFBQSxlQUFRLEVBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ3RELFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDeEMsT0FBTyxRQUFRLElBQUksSUFBSSxRQUFRLEVBQUUsQ0FBQzthQUNyQztTQUNKO1FBQ0QsT0FBTyxFQUFFLENBQUM7S0FDYjtJQUVELE9BQU87SUFDUCxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RDLEtBQUssSUFBSSxJQUFJLElBQUksV0FBRyxFQUFFO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyQixNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXZDLElBQUksS0FBSyxFQUFFO1lBQ1AsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUNwQixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDdEMsR0FBRyxJQUFJLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7aUJBQzVCO2FBQ0o7WUFDRCxPQUFPLEdBQUcsQ0FBQztTQUNkO0tBQ0o7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUEvQkQsNEJBK0JDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixTQUFTLENBQUMsUUFBZ0I7SUFDdEMsTUFBTTtJQUNOLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUM5QixRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sR0FBRyxHQUFHLElBQUEsV0FBSyxFQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVCLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLE9BQU8sSUFBQSxXQUFJLEVBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFDRCxPQUFPLEVBQUUsQ0FBQztLQUNiO0lBRUQsT0FBTztJQUNQLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckMsS0FBSyxJQUFJLElBQUksSUFBSSxXQUFHLEVBQUU7UUFDbEIsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JCLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEMsSUFBSSxJQUFJLEVBQUU7WUFDTixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDdEMsSUFBSSxJQUFJLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7aUJBQzdCO2FBQ0o7WUFDRCxPQUFPLElBQUksQ0FBQztTQUNmO0tBQ0o7SUFFRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUE1QkQsOEJBNEJDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixTQUFTLENBQUMsUUFBZ0I7SUFDdEMsTUFBTTtJQUNOLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUM5QixRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sR0FBRyxHQUFHLElBQUEsV0FBSyxFQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVCLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUEsV0FBSSxFQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFNUMsT0FBTyxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDakMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixJQUFJLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDM0M7WUFFRCxJQUFJLElBQUksSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDN0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3RDLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2lCQUM3QjthQUNKO1lBQ0QsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sRUFBRSxDQUFDO0tBQ2I7SUFFRCxPQUFPO0lBQ1AsS0FBSyxJQUFJLElBQUksSUFBSSxXQUFHLEVBQUU7UUFDbEIsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFNUMsT0FBTyxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNqQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN0QixJQUFJLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDM0M7UUFFRCxJQUFJLElBQUksRUFBRTtZQUNOLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0QyxJQUFJLElBQUksSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztpQkFDN0I7YUFDSjtZQUNELE9BQU8sSUFBSSxDQUFDO1NBQ2Y7S0FDSjtJQUVELE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQWxERCw4QkFrREM7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxRQUFRLENBQUMsYUFBcUI7SUFDaEQsT0FBTztJQUNQLElBQUksSUFBQSxpQkFBVSxFQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQzNCLEtBQUssSUFBSSxJQUFJLElBQUksV0FBRyxFQUFFO1lBQ2xCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQixJQUFJLElBQUEsaUJBQVMsRUFBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDN0MsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQy9DLElBQUksS0FBSyxFQUFFO29CQUNQLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDcEM7Z0JBQ0QsTUFBTTthQUNUO1NBQ0o7UUFDRCxPQUFPO0tBQ1Y7SUFFRCxNQUFNO0lBQ04sSUFBSSxhQUFhLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ25DLGFBQWEsR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekMsTUFBTSxHQUFHLEdBQUcsSUFBQSxXQUFLLEVBQUMsYUFBYSxDQUFDLENBQUM7UUFDakMsSUFBSSxHQUFHLENBQUMsSUFBSSxJQUFJLFdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7WUFDL0IsTUFBTSxJQUFJLEdBQUcsSUFBQSxXQUFJLEVBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUYsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEMsSUFBSSxLQUFLLEVBQUU7Z0JBQ1AsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzNCO1NBQ0o7UUFDRCxPQUFPO0tBQ1Y7SUFFRCxPQUFPO0lBQ1AsS0FBSyxJQUFJLElBQUksSUFBSSxXQUFHLEVBQUU7UUFDbEIsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekMsSUFBSSxLQUFLLEVBQUU7WUFDUCxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDakMsTUFBTTtTQUNUO0tBQ0o7SUFDRCxPQUFPO0FBQ1gsQ0FBQztBQXpDRCw0QkF5Q0M7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQUMsYUFBcUI7SUFDL0MsT0FBTztJQUNQLElBQUksSUFBQSxpQkFBVSxFQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQzNCLEtBQUssSUFBSSxJQUFJLElBQUksV0FBRyxFQUFFO1lBQ2xCLE1BQU0sRUFBRSxHQUFHLFdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQixJQUFJLElBQUEsaUJBQVMsRUFBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDN0MsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNO2FBQ1Q7U0FDSjtRQUNELE9BQU87S0FDVjtJQUVELE1BQU07SUFDTixJQUFJLGFBQWEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDbkMsYUFBYSxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN6QyxNQUFNLEdBQUcsR0FBRyxJQUFBLFdBQUssRUFBQyxhQUFhLENBQUMsQ0FBQztRQUNqQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksV0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMzQixNQUFNLEVBQUUsR0FBRyxXQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztZQUMvQixNQUFNLElBQUksR0FBRyxJQUFBLFdBQUksRUFBQyxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5RixNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDMUI7UUFDRCxPQUFPO0tBQ1Y7SUFFRCxPQUFPO0lBQ1AsS0FBSyxJQUFJLElBQUksSUFBSSxXQUFHLEVBQUU7UUFDbEIsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekMsSUFBSSxLQUFLLEVBQUU7WUFDUCxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLE1BQU07U0FDVDtLQUNKO0lBQ0QsT0FBTztBQUNYLENBQUM7QUFuQ0QsMEJBbUNDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0IsbUJBQW1CLENBQUMsS0FBMkI7SUFDM0QsTUFBTSxLQUFLLEdBQWEsRUFBRSxDQUFDO0lBQzNCLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUU7UUFDMUIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQzVCLE9BQU87U0FDVjtRQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckIsQ0FBQyxDQUFBO0lBQ0QsSUFBQSwrQkFBa0IsRUFBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLElBQUEsK0JBQWtCLEVBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxJQUFBLCtCQUFrQixFQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUMsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQVpELGtEQVlDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQWdCLDRCQUE0QixDQUFDLEtBQTJCLEVBQUUsTUFBZ0I7SUFDdEYsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2QsTUFBTSxLQUFLLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO0lBQzVCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUNuQixNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsSUFBSSxLQUFLLEVBQUU7WUFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsNEJBQTRCLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7U0FDL0Q7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sQ0FBQyxHQUFHLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUFaRCxvRUFZQztBQUVEOzs7Ozs7R0FNRztBQUNILFNBQWdCLDhCQUE4QixDQUFDLGVBQXVCLEVBQUUsS0FBMkI7SUFDL0YsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ25CLDRCQUE0QixDQUFDLEtBQUssRUFBRSxVQUFTLEtBQUs7UUFDOUMsSUFDSSxLQUFLLENBQUMsTUFBTSxLQUFLLGVBQWU7WUFDaEMsS0FBSyxDQUFDLEdBQUcsS0FBSyxlQUFlO1lBQzdCLEtBQUssQ0FBQyxJQUFJLEtBQUssZUFBZSxFQUNoQztZQUNFLE9BQU8sSUFBSSxLQUFLLENBQUM7U0FDcEI7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUM7QUFaRCx3RUFZQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixzQkFBc0IsQ0FBQyxRQUFpQixFQUFFLEtBQTJCO0lBQ2pGLHVCQUF1QjtJQUN2Qix5QkFBeUI7SUFDekIsTUFBTSxLQUFLLEdBQWEsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDbEQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ25CLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFQRCx3REFPQztBQUVELFNBQWdCLGdCQUFnQixDQUFDLElBQVk7SUFDekMsS0FBSyxJQUFJLElBQUksSUFBSSxXQUFHLEVBQUU7UUFDbEIsTUFBTSxFQUFFLEdBQUcsV0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELElBQUksSUFBSSxFQUFFO1lBQ04sT0FBTyxJQUFJLENBQUM7U0FDZjtLQUNKO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQVRELDRDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgdHlwZSB7IEFzc2V0REIgfSBmcm9tICcuL2Fzc2V0LWRiJztcbmltcG9ydCB0eXBlIHsgQXNzZXQsIFZpcnR1YWxBc3NldCB9IGZyb20gJy4vYXNzZXQnO1xuXG5pbXBvcnQgeyBpc1N1YlBhdGggfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IGdldEFzc29jaWF0ZWRGaWxlcyB9IGZyb20gJy4vZGVwZW5kZW5jeSc7XG5pbXBvcnQgeyBpc0Fic29sdXRlLCByZWxhdGl2ZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcGFyc2UgfSBmcm9tICd1cmwnO1xuXG5leHBvcnQgY29uc3QgbWFwOiB7W2luZGV4OiBzdHJpbmddOiBBc3NldERCfSA9IHt9O1xuXG4vKipcbiAqIOafpeaJvuW3sue7j+eUn+aIkOS6hueahOi1hOa6kOaVsOaNruW6k1xuICogQHBhcmFtIG5hbWUgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXQobmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG1hcFtuYW1lXSB8fCBudWxsO1xufVxuXG4vKipcbiAqIOe7meWumuS4gOS4qiB1dWlkIOaIluiAhSB1cmwg5oiW6ICF57ud5a+56Lev5b6E77yM5p+l6K+i5LiA5Liq6LWE5rqQ5a+56LGhXG4gKiBAcGFyYW0gdXVpZCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5QXNzZXQodXVpZF91cmxfcGF0aDogc3RyaW5nKTogQXNzZXQgfCBWaXJ0dWFsQXNzZXQgfCBudWxsIHtcbiAgICAvLyB1cmxcbiAgICBpZiAodXVpZF91cmxfcGF0aC5zdGFydHNXaXRoKCdkYjovLycpKSB7XG4gICAgICAgIHV1aWRfdXJsX3BhdGggPSBlbmNvZGVVUkkodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGNvbnN0IHVyaSA9IHBhcnNlKHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICBpZiAodXJpLmhvc3QgJiYgbWFwW3VyaS5ob3N0XSkge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBtYXBbdXJpLmhvc3QgfHwgJyddO1xuICAgICAgICAgICAgY29uc3QgcGF0aCA9IGpvaW4oZGIub3B0aW9ucy50YXJnZXQsIGRlY29kZVVSSUNvbXBvbmVudCgodXJpLnBhdGggfHwgJycpICsgKHVyaS5oYXNoIHx8ICcnKSkpO1xuICAgICAgICAgICAgY29uc3Qgc2VhcmNoZXIgPSBwYXRoLnNwbGl0KCdAJyk7XG5cbiAgICAgICAgICAgIGxldCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQgfCB1bmRlZmluZWQgPSBkYi5wYXRoMmFzc2V0LmdldChzZWFyY2hlclswXSk7XG5cblxuICAgICAgICAgICAgd2hpbGUgKCFhc3NldCAmJiBzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgc2VhcmNoZXJbMF0gKz0gJ0AnICsgc2VhcmNoZXJbMV07XG4gICAgICAgICAgICAgICAgc2VhcmNoZXIuc3BsaWNlKDEsIDEpO1xuICAgICAgICAgICAgICAgIGFzc2V0ID0gZGIucGF0aDJhc3NldC5nZXQoc2VhcmNoZXJbMF0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHNlYXJjaGVyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgbGV0IHN1YiA9IGFzc2V0IS5zdWJBc3NldHNbc2VhcmNoZXJbaV1dO1xuICAgICAgICAgICAgICAgIGlmICghc3ViKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhc3NldCA9IHN1YjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhc3NldCB8fCBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIOe7neWvuei3r+W+hFxuICAgIGlmIChpc0Fic29sdXRlKHV1aWRfdXJsX3BhdGgpKSB7XG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgICAgICBjb25zdCBzZWFyY2hlciA9IHV1aWRfdXJsX3BhdGguc3BsaXQoJ0AnKTtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICAgICAgbGV0IGFzc2V0ID0gZGIucGF0aDJhc3NldC5nZXQoc2VhcmNoZXJbMF0pO1xuXG4gICAgICAgICAgICB3aGlsZSAoIWFzc2V0ICYmIHNlYXJjaGVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBzZWFyY2hlclswXSArPSAnQCcgKyBzZWFyY2hlclsxXTtcbiAgICAgICAgICAgICAgICBzZWFyY2hlci5zcGxpY2UoMSwgMSk7XG4gICAgICAgICAgICAgICAgYXNzZXQgPSBkYi5wYXRoMmFzc2V0LmdldChzZWFyY2hlclswXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQgfCB1bmRlZmluZWQgPSBkYi5wYXRoMmFzc2V0LmdldChzZWFyY2hlclswXSk7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHNlYXJjaGVyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWIgPSBhc3NldCEuc3ViQXNzZXRzW3NlYXJjaGVyW2ldXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdWIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFzc2V0ID0gc3ViO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzZXQgfHwgbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyB1dWlkXG4gICAgLy8g5pWw5o2u5bqT5ZCN5a2X5YiX6KGoXG4gICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gZGIuZ2V0QXNzZXQodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgcmV0dXJuIGFzc2V0O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG59XG5cbi8qKlxuICog5p+l6K+i5LiA5LiqIHV1aWTjgIHnu53lr7not6/lvoTlr7nlupTnmoQgdXJsIOi3r+W+hFxuICogdXJsIOagvOW8j+S4uiBkYjovL2RhdGFiYXNlX25hbWUvc291cmNlX3BhdGhAeHh4XG4gKiDnu53lr7not6/lvoTor7fkvb/nlKjns7vnu5/liIbpmpTnrKbvvIzmlofku7blpLnmnKvlsL7kuI3pnIDopoHluKbliIbpmpTnrKbvvIhtYWPvvJovICB3aW7vvJpcXFxc77yJXG4gKiBAcGFyYW0gdXVpZF9wYXRoIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlVcmwodXVpZF9wYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHBhdGhcbiAgICBpZiAoaXNBYnNvbHV0ZSh1dWlkX3BhdGgpKSB7XG4gICAgICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgICAgIGlmIChpc1N1YlBhdGgodXVpZF9wYXRoLCBkYi5vcHRpb25zLnRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgcGF0aG5hbWUgPSByZWxhdGl2ZShkYi5vcHRpb25zLnRhcmdldCwgdXVpZF9wYXRoKTtcbiAgICAgICAgICAgICAgICBwYXRobmFtZSA9IHBhdGhuYW1lLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYGRiOi8vJHtuYW1lfS8ke3BhdGhuYW1lfWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIC8vIHV1aWRcbiAgICBjb25zdCBzZWFyY2hlciA9IHV1aWRfcGF0aC5zcGxpdCgnQCcpO1xuICAgIGZvciAobGV0IG5hbWUgaW4gbWFwKSB7XG4gICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICBjb25zdCBhc3NldCA9IGRiLmdldEFzc2V0KHNlYXJjaGVyWzBdKTtcblxuICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGxldCB1cmwgPSBhc3NldC51cmw7XG4gICAgICAgICAgICBpZiAoc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdXJsICs9IGBAJHtzZWFyY2hlcltpXX1gO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1cmw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuICcnO1xufVxuXG4vKipcbiAqIOafpeivouS4gOS4qiB1dWlk44CBdXJsIOWvueW6lOeahOe7neWvuei3r+W+hOWcsOWdgFxuICogdXJsIOagvOW8j+S4uiBkYjovL2RhdGFiYXNlX25hbWUvc291cmNlX3BhdGhAeHh4XG4gKiDnu53lr7not6/lvoTor7fkvb/nlKjns7vnu5/liIbpmpTnrKbvvIzmlofku7blpLnmnKvlsL7kuI3pnIDopoHluKbliIbpmpTnrKbvvIhtYWPvvJovICB3aW7vvJpcXFxc77yJXG4gKiBAcGFyYW0gdXVpZF91cmwgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeVBhdGgodXVpZF91cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gdXJsXG4gICAgaWYgKHV1aWRfdXJsLnN0YXJ0c1dpdGgoJ2RiOi8vJykpIHtcbiAgICAgICAgdXVpZF91cmwgPSBlbmNvZGVVUkkodXVpZF91cmwpO1xuICAgICAgICBjb25zdCB1cmkgPSBwYXJzZSh1dWlkX3VybCk7XG4gICAgICAgIGlmICh1cmkuaG9zdCAmJiBtYXBbdXJpLmhvc3RdKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFt1cmkuaG9zdCB8fCAnJ107XG4gICAgICAgICAgICByZXR1cm4gam9pbihkYi5vcHRpb25zLnRhcmdldCwgZGVjb2RlVVJJQ29tcG9uZW50KCh1cmkucGF0aCB8fCAnJykgKyAodXJpLmhhc2ggfHwgJycpKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIC8vIHV1aWRcbiAgICBjb25zdCBzZWFyY2hlciA9IHV1aWRfdXJsLnNwbGl0KCdAJyk7XG4gICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgIGxldCBwYXRoID0gZGIudXVpZFRvUGF0aChzZWFyY2hlclswXSk7XG4gICAgICAgIGlmIChwYXRoKSB7XG4gICAgICAgICAgICBpZiAoc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgcGF0aCArPSBgQCR7c2VhcmNoZXJbaV19YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcGF0aDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAnJztcbn1cblxuLyoqXG4gKiDmn6Xor6LkuIDkuKogdXJs44CB57ud5a+56Lev5b6E5a+55bqU55qEIHV1aWRcbiAqIHVybCDmoLzlvI/kuLogZGI6Ly9kYXRhYmFzZV9uYW1lL3NvdXJjZV9wYXRoQHh4eFxuICog57ud5a+56Lev5b6E6K+35L2/55So57O757uf5YiG6ZqU56ym77yM5paH5Lu25aS55pyr5bC+5LiN6ZyA6KaB5bim5YiG6ZqU56ym77yIbWFj77yaLyAgd2lu77yaXFxcXO+8iVxuICogQHBhcmFtIHV1aWRfdXJsIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlVVUlEKHVybF9wYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHVybFxuICAgIGlmICh1cmxfcGF0aC5zdGFydHNXaXRoKCdkYjovLycpKSB7XG4gICAgICAgIHVybF9wYXRoID0gZW5jb2RlVVJJKHVybF9wYXRoKTtcbiAgICAgICAgY29uc3QgdXJpID0gcGFyc2UodXJsX3BhdGgpO1xuICAgICAgICBpZiAodXJpLmhvc3QgJiYgbWFwW3VyaS5ob3N0XSkge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBtYXBbdXJpLmhvc3QgfHwgJyddO1xuICAgICAgICAgICAgY29uc3QgcGF0aCA9IGpvaW4oZGIub3B0aW9ucy50YXJnZXQsIGRlY29kZVVSSUNvbXBvbmVudCgodXJpLnBhdGggfHwgJycpICsgKHVyaS5oYXNoIHx8ICcnKSkpO1xuICAgICAgICAgICAgY29uc3Qgc2VhcmNoZXIgPSBwYXRoLnNwbGl0KCdAJyk7XG4gICAgICAgICAgICBsZXQgdXVpZCA9IGRiLnBhdGhUb1V1aWQoc2VhcmNoZXJbMF0pIHx8ICcnO1xuXG4gICAgICAgICAgICB3aGlsZSAoIXV1aWQgJiYgc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIHNlYXJjaGVyWzBdICs9ICdAJyArIHNlYXJjaGVyWzFdO1xuICAgICAgICAgICAgICAgIHNlYXJjaGVyLnNwbGljZSgxLCAxKTtcbiAgICAgICAgICAgICAgICB1dWlkID0gZGIucGF0aFRvVXVpZChzZWFyY2hlclswXSkgfHwgJyc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh1dWlkICYmIHNlYXJjaGVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHNlYXJjaGVyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHV1aWQgKz0gYEAke3NlYXJjaGVyW2ldfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHV1aWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIC8vIHBhdGhcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgY29uc3Qgc2VhcmNoZXIgPSB1cmxfcGF0aC5zcGxpdCgnQCcpO1xuICAgICAgICBsZXQgdXVpZCA9IGRiLnBhdGhUb1V1aWQoc2VhcmNoZXJbMF0pIHx8ICcnO1xuXG4gICAgICAgIHdoaWxlICghdXVpZCAmJiBzZWFyY2hlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBzZWFyY2hlclswXSArPSAnQCcgKyBzZWFyY2hlclsxXTtcbiAgICAgICAgICAgIHNlYXJjaGVyLnNwbGljZSgxLCAxKTtcbiAgICAgICAgICAgIHV1aWQgPSBkYi5wYXRoVG9VdWlkKHNlYXJjaGVyWzBdKSB8fCAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1dWlkKSB7XG4gICAgICAgICAgICBpZiAoc2VhcmNoZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgc2VhcmNoZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdXVpZCArPSBgQCR7c2VhcmNoZXJbaV19YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdXVpZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAnJztcbn1cblxuLyoqXG4gKiDph43mlrDlr7zlhaXkuIDkuKrotYTmupBcbiAqIHVybCDmoLzlvI/kuLogZGI6Ly9kYXRhYmFzZV9uYW1lL3NvdXJjZV9wYXRoQHh4eFxuICog57ud5a+56Lev5b6E6K+35L2/55So57O757uf5YiG6ZqU56ym77yM5paH5Lu25aS55pyr5bC+5LiN6ZyA6KaB5bim5YiG6ZqU56ym77yIbWFj77yaLyAgd2lu77yaXFxcXO+8iVxuICogQHBhcmFtIHV1aWRfdXJsX3BhdGggXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWltcG9ydCh1dWlkX3VybF9wYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBwYXRoXG4gICAgaWYgKGlzQWJzb2x1dGUodXVpZF91cmxfcGF0aCkpIHtcbiAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgICAgIGNvbnN0IGRiID0gbWFwW25hbWVdO1xuICAgICAgICAgICAgaWYgKGlzU3ViUGF0aCh1dWlkX3VybF9wYXRoLCBkYi5vcHRpb25zLnRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhc3NldCA9IGRiLnBhdGgyYXNzZXQuZ2V0KHV1aWRfdXJsX3BhdGgpO1xuICAgICAgICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYi5yZWltcG9ydCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHVybFxuICAgIGlmICh1dWlkX3VybF9wYXRoLnN0YXJ0c1dpdGgoJ2RiOi8vJykpIHtcbiAgICAgICAgdXVpZF91cmxfcGF0aCA9IGVuY29kZVVSSSh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgY29uc3QgdXJpID0gcGFyc2UodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGlmICh1cmkuaG9zdCAmJiBtYXBbdXJpLmhvc3RdKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFt1cmkuaG9zdCB8fCAnJ107XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gam9pbihkYi5vcHRpb25zLnRhcmdldCwgZGVjb2RlVVJJQ29tcG9uZW50KCh1cmkucGF0aCB8fCAnJykgKyAodXJpLmhhc2ggfHwgJycpKSk7XG4gICAgICAgICAgICBjb25zdCBhc3NldCA9IGRiLnBhdGgyYXNzZXQuZ2V0KHBhdGgpO1xuICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZGIucmVpbXBvcnQocGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHV1aWRcbiAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICBjb25zdCBkYiA9IG1hcFtuYW1lXTtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBkYi5nZXRBc3NldCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5yZWltcG9ydCh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybjtcbn1cblxuLyoqXG4gKiDliLfmlrDkuIDkuKrotYTmupDmiJbogIXotYTmupDnm67lvZVcbiAqIHVybCDmoLzlvI/kuLogZGI6Ly9kYXRhYmFzZV9uYW1lL3NvdXJjZV9wYXRoQHh4eFxuICog57ud5a+56Lev5b6E6K+35L2/55So57O757uf5YiG6ZqU56ym77yM5paH5Lu25aS55pyr5bC+5LiN6ZyA6KaB5bim5YiG6ZqU56ym77yIbWFj77yaLyAgd2lu77yaXFxcXO+8iVxuICogQHBhcmFtIHV1aWRfdXJsX3BhdGggXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWZyZXNoKHV1aWRfdXJsX3BhdGg6IHN0cmluZykge1xuICAgIC8vIHBhdGhcbiAgICBpZiAoaXNBYnNvbHV0ZSh1dWlkX3VybF9wYXRoKSkge1xuICAgICAgICBmb3IgKGxldCBuYW1lIGluIG1hcCkge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgICAgICBpZiAoaXNTdWJQYXRoKHV1aWRfdXJsX3BhdGgsIGRiLm9wdGlvbnMudGFyZ2V0KSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IGRiLnJlZnJlc2godXVpZF91cmxfcGF0aCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHVybFxuICAgIGlmICh1dWlkX3VybF9wYXRoLnN0YXJ0c1dpdGgoJ2RiOi8vJykpIHtcbiAgICAgICAgdXVpZF91cmxfcGF0aCA9IGVuY29kZVVSSSh1dWlkX3VybF9wYXRoKTtcbiAgICAgICAgY29uc3QgdXJpID0gcGFyc2UodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGlmICh1cmkuaG9zdCAmJiBtYXBbdXJpLmhvc3RdKSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IG1hcFt1cmkuaG9zdCB8fCAnJ107XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gam9pbihkYi5vcHRpb25zLnRhcmdldCwgZGVjb2RlVVJJQ29tcG9uZW50KCh1cmkucGF0aCB8fCAnJykgKyAodXJpLmhhc2ggfHwgJycpKSk7XG4gICAgICAgICAgICBhd2FpdCBkYi5yZWZyZXNoKHBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB1dWlkXG4gICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gZGIuZ2V0QXNzZXQodXVpZF91cmxfcGF0aCk7XG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgYXdhaXQgZGIucmVmcmVzaChhc3NldC5zb3VyY2UpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuO1xufVxuXG4vKipcbiAqIOafpeaJvuWPl+W9seWTjeeahOi1hOa6kFxuICogQHBhcmFtIGFzc2V0IFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXNzb2NpYXRlZEFzc2V0cyhhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQpIHtcbiAgICBjb25zdCBmaWxlczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBwdXNoID0gKGZpbGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAoZmlsZXMuaW5kZXhPZihmaWxlKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBmaWxlcy5wdXNoKGZpbGUpO1xuICAgIH1cbiAgICBnZXRBc3NvY2lhdGVkRmlsZXMoYXNzZXQuc291cmNlKS5mb3JFYWNoKHB1c2gpO1xuICAgIGdldEFzc29jaWF0ZWRGaWxlcyhhc3NldC51dWlkKS5mb3JFYWNoKHB1c2gpO1xuICAgIGdldEFzc29jaWF0ZWRGaWxlcyhhc3NldC51cmwpLmZvckVhY2gocHVzaCk7XG4gICAgcmV0dXJuIGZpbGVzO1xufVxuXG4vKipcbiAqIOmAkuW9kui1hOa6kOS+nei1lueahOaJgOaciei1hOa6kFxuICogQHBhcmFtIGFzc2V0IFxuICogQHBhcmFtIGhhbmRsZSBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlY3Vyc2l2ZUdldEFzc29jaWF0ZWRBc3NldHMoYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0LCBoYW5kbGU6IEZ1bmN0aW9uKSB7XG4gICAgaGFuZGxlKGFzc2V0KTtcbiAgICBjb25zdCBmaWxlcyA9IGdldEFzc29jaWF0ZWRBc3NldHMoYXNzZXQpO1xuICAgIGNvbnN0IG90aGVyczogc3RyaW5nW10gPSBbXTtcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gcXVlcnlBc3NldChmaWxlKTtcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICBoYW5kbGUoYXNzZXQpO1xuICAgICAgICAgICAgb3RoZXJzLnB1c2goLi4ucmVjdXJzaXZlR2V0QXNzb2NpYXRlZEFzc2V0cyhhc3NldCwgaGFuZGxlKSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gWy4uLmZpbGVzLCAuLi5vdGhlcnNdO1xufVxuXG4vKipcbiAqIOmAkuW9kuajgOafpeaYr+WQpuWFgeiuuOaPkuWFpeS+nei1llxuICogYXNzZXQg5L6d6LWWIGZpbGVPclV1aWRPclVybFxuICog5qOA5p+l5piv5ZCm5pyJ5b6q546v5L6d6LWW5Ye6546wXG4gKiBAcGFyYW0gZmlsZU9yVXVpZE9yVXJsXG4gKiBAcGFyYW0gYXNzZXQgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWN1cnNpdmVDaGVja0Fzc29jaWF0ZWRBc3NldHMoZmlsZU9yVXVpZE9yVXJsOiBzdHJpbmcsIGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCkge1xuICAgIGxldCBzdWNjZXNzID0gdHJ1ZTtcbiAgICByZWN1cnNpdmVHZXRBc3NvY2lhdGVkQXNzZXRzKGFzc2V0LCBmdW5jdGlvbihhc3NldCkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBhc3NldC5zb3VyY2UgPT09IGZpbGVPclV1aWRPclVybCAmJlxuICAgICAgICAgICAgYXNzZXQudXJsID09PSBmaWxlT3JVdWlkT3JVcmwgJiZcbiAgICAgICAgICAgIGFzc2V0LnV1aWQgPT09IGZpbGVPclV1aWRPclVybFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHN1Y2Nlc3MgPT0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gc3VjY2Vzcztcbn1cblxuLyoqXG4gKiDph43mlrDlr7zlhaXlj5flvbHlk43nmoTotYTmupBcbiAqIEBwYXJhbSBkYXRhYmFzZSBcbiAqIEBwYXJhbSBhc3NldCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydEFzc29jaWF0ZWRBc3NldHMoZGF0YWJhc2U6IEFzc2V0REIsIGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCkge1xuICAgIC8vIOinpuWPkeS+nei1lui/meS4qui1hOa6kOeahOmineWFtuS7lui1hOa6kOiHquWKqOmHjeaWsOWvvOWFpVxuICAgIC8vIOS9huaYr+i/meS4qumHjeaWsOWvvOWFpeWFtuS7lui1hOa6kOeahOa1geeoi+WwseS4jemcgOimgeetieW+heWLklxuICAgIGNvbnN0IGZpbGVzOiBzdHJpbmdbXSA9IGdldEFzc29jaWF0ZWRBc3NldHMoYXNzZXQpXG4gICAgZmlsZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICByZWltcG9ydChmaWxlKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5TWlzc2luZ0luZm8odXVpZDogc3RyaW5nKSB7XG4gICAgZm9yIChsZXQgbmFtZSBpbiBtYXApIHtcbiAgICAgICAgY29uc3QgZGIgPSBtYXBbbmFtZV07XG4gICAgICAgIGNvbnN0IGluZm8gPSBkYi5pbmZvTWFuYWdlci5nZXRNaXNzaW5nSW5mbyh1dWlkKTtcbiAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgIHJldHVybiBpbmZvO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufSJdfQ==