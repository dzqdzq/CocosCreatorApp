"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Asset=exports.VirtualAsset=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),meta_1=require("./meta"),utils_1=require("./utils"),extnameRex=/^\./;function isExtname(t){return""===t||extnameRex.test(t)}class VirtualAsset{constructor(t,e,s,i){this.invalid=!1,this.uuid2recycle={},this._init=!1,this._waitInitHandle=[],this._lock=!1,this._waitLockHandler=[],this._parent=null,this._swapSpace=null,this.meta=meta_1.completionMeta(t),this.imported=t.imported,this._name=t.name=e,this._id=t.id=s,this._assetDB=i,this.subAssets=Object.create(null),Object.keys(t.subMetas).forEach(e=>{let s=t.subMetas[e];if(!s.name)return;let a=new VirtualAsset(s,s.name,s.id,i);a._parent=this,this.subAssets[e]=a})}get init(){return this._init}set init(t){this._init=t;const e=Object.keys(this.subAssets);for(let s=0;s<e.length;s++){const i=e[s];this.subAssets[i].init=t}if(t)for(;this._waitInitHandle.length>0;){const t=this._waitInitHandle.shift();t&&t()}}get source(){return this._parent&&this._parent?this._parent.source+"@"+this._id:""}get url(){return this._parent&&this._parent?this._parent.url+"@"+this._id:""}get library(){let t=this._parent?this._id:this.meta.uuid,e=this._parent;for(;e;)t=e.parent?`${e._id}@${t}`:`${e.uuid}@${t}`,e=e.parent;return path_1.join(this._assetDB.options.library,this.meta.uuid.substr(0,2),t)}get temp(){let t=this._parent?this._id:this.meta.uuid,e=this._parent;for(;e;)t=e.parent?`${e._id}@${t}`:`${e.uuid}@${t}`,e=e.parent;return path_1.join(this._assetDB.options.temp,this.meta.uuid.substr(0,2),t)}get uuid(){return this.meta.uuid}get displayName(){return this.meta.displayName||""}set imported(t){this.meta.imported=t}get imported(){return!1!==this.init&&this.meta.imported}async waitInit(){this._init||(this.parent?await this.parent.waitInit():await new Promise((t,e)=>{this._waitInitHandle.push(()=>{t()})}))}async lock(){return this._lock?await new Promise((t,e)=>{this._waitLockHandler.push(()=>{t()})}):this._lock=!0}unlock(){const t=this._waitLockHandler.shift();t?t():this._lock=!1}get parent(){return this._parent}get userData(){return this.meta.userData}assignUserData(t,e=!1){const s=this.meta.userData;if(e)Object.assign(s,t);else for(let e in t)e in s||(s[e]=t[e])}async save(){if(this._parent)return await this._parent.save()}async reset(){if(fs_extra_1.existsSync(this.temp))try{fs_extra_1.removeSync(this.temp)}catch(t){console.error(`Failed to delete temporary cache: ${this.source}`),console.error(t)}for(let t=this.meta.files.length-1;t>=0;t--){let e=this.meta.files[t];await this.deleteFromLibrary(e)}this.meta.files=[];const t=Object.keys(this.subAssets);for(let e=0;e<t.length;e++){const s=t[e],i=this.subAssets[s];i&&i.reset&&(this.uuid2recycle[s]=i.meta,await i.reset(),i.imported=!1),delete this.meta.subMetas[s],delete this.subAssets[s]}return this.imported=!1,this._assetDB.dependencyManager.remove("uuid",this.uuid),this._assetDB.dependencyManager.remove("path",this.source),this._assetDB.dependencyManager.remove("url",this.url),!0}getFilePath(t){return isExtname(t)?`${this.library}${t}`:path_1.join(this.library,t)}async saveToLibrary(t,e){if(isExtname(t)){let s=`${this.library}${t}`;return-1===this.meta.files.indexOf(t)&&this.meta.files.push(t),void await fs_extra_1.outputFile(s,e)}await fs_extra_1.ensureDir(this.library);let s=path_1.join(this.library,t),i=path_1.relative(this.library,s);-1===this.meta.files.indexOf(i)&&this.meta.files.push(i),await fs_extra_1.outputFile(s,e)}async copyToLibrary(t,e){if(isExtname(t)){let s=`${this.library}${t}`;return-1===this.meta.files.indexOf(t)&&this.meta.files.push(t),fs_extra_1.existsSync(s)&&await fs_extra_1.remove(s),void await fs_extra_1.copy(e,s)}await fs_extra_1.ensureDir(this.library);let s=path_1.join(this.library,t),i=path_1.relative(this.library,s);-1===this.meta.files.indexOf(i)&&this.meta.files.push(i),fs_extra_1.existsSync(s)&&await fs_extra_1.remove(s),await fs_extra_1.copy(e,s)}async deleteFromLibrary(t){if(isExtname(t)){let e=`${this.library}${t}`;if(!fs_extra_1.existsSync(e))return!1;let s=this.meta.files.indexOf(t);return-1!==s&&this.meta.files.splice(s,1),void await fs_extra_1.remove(e)}await fs_extra_1.ensureDir(this.library);let e=path_1.join(this.library,t),s=path_1.relative(this.library,e),i=this.meta.files.indexOf(s);-1!==i&&this.meta.files.splice(i,1),await fs_extra_1.remove(e)}existsInLibrary(t){if(-1===this.meta.files.indexOf(t))return!1;let e;return e=isExtname(t)?`${this.library}${t}`:path_1.join(this.library,t),fs_extra_1.existsSync(e)}isDirectory(){return!1}async createSubAsset(t,e,s={displayName:""}){if(!t)throw"Failed to create subAsset: It must have a name";let i,a=utils_1.nameToId(t),r=1;for(;this.subAssets[a]&&this.subAssets[a].meta.name!==t;)if(a=utils_1.nameToId(t,r++),r>=26)throw new Error(`Cannot create a new subAsset: ${t}\n  Please try to change your asset name`);if(this.subAssets[t])i=this.subAssets[t];else{e=e||"*";let r=this.uuid2recycle[a];if(r&&r.importer===e)r.uuid=`${this.uuid}@${a}`,r.displayName=s.displayName||"";else{const i=this.meta.subMetas[a];r=meta_1.completionMeta({importer:e,uuid:`${this.uuid}@${a}`,displayName:s.displayName||"",id:a,name:t,userData:i&&i.userData||{}})}delete this.uuid2recycle[a],(i=new VirtualAsset(r,t,a,this._assetDB))._parent=this,this.meta.subMetas[a]=i.meta,this.subAssets[a]=i}return this.subAssets[a]}depend(t){path_1.isAbsolute(t)?this._assetDB.dependencyManager.add("path",this.source,t):t.startsWith("db://")?this._assetDB.dependencyManager.add("url",this.source,t):this._assetDB.dependencyManager.add("uuid",this.source,t)}getSwapSpace(){return this._swapSpace=this._swapSpace||{},this._swapSpace}}exports.VirtualAsset=VirtualAsset;class Asset extends VirtualAsset{constructor(t,e,s){let i=path_1.extname(t),a=path_1.basename(t,i);super(e,e.name,e.id,s),this._url=`db://${s.options.name}/${path_1.relative(s.options.target,t).replace(/\\/g,"/")}`,this._source=t,this.extname=i.toLowerCase(),this.basename=a}get source(){return this._source}get url(){return this._url}save(){if(!fs_extra_1.existsSync(this.source))return!1;const t=path_1.join(this.source+".meta");this._assetDB.metaManager.write(t);const e=fs_extra_1.statSync(t);return this._assetDB.infoManager.add(t,e.mtimeMs),!0}isDirectory(){if(void 0!==this._isDirectory)return this._isDirectory;const t=fs_extra_1.statSync(this.source);return!!t&&(this._isDirectory=t.isDirectory())}}exports.Asset=Asset;