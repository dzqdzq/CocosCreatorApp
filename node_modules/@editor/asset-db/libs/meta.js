'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetaManager = exports.completionMeta = exports.copyMeta = void 0;
const fs_extra_1 = require("fs-extra");
const node_uuid_1 = require("node-uuid");
/**
 * 复制一个 json 数据
 * @param json
 */
function generateJSON(json) {
    return JSON.parse(JSON.stringify(json));
}
/**
 * 复制 meta 数据，将 origin 上的数据复制到 target 上
 * @param target
 * @param origin
 */
function copyMeta(target, origin) {
    target.ver = origin.ver || target.ver || '0.0.0';
    target.importer = origin.importer || '*';
    target.imported = origin.imported || false;
    target.uuid = origin.uuid || (0, node_uuid_1.v4)();
    target.files = origin.files || [];
    target.subMetas = target.subMetas || {};
    origin.subMetas && Object.keys(origin.subMetas).forEach((id) => {
        const child = generateJSON(origin.subMetas[id]);
        if (!target.subMetas[id]) {
            target.subMetas[id] = child;
        }
        else {
            copyMeta(target.subMetas[id], child);
        }
    });
    target.userData = generateJSON(origin.userData || {});
    target.displayName = origin.displayName || '';
    target.id = origin.id || '';
    target.name = origin.name || '';
}
exports.copyMeta = copyMeta;
/**
 * 补全 meta 数据
 * @param meta
 */
function completionMeta(meta) {
    if (typeof meta.ver !== 'string') {
        meta.ver = '0.0.0';
    }
    else {
        meta.ver = meta.ver;
    }
    if (typeof meta.importer !== 'string') {
        meta.importer = '*';
    }
    else {
        meta.importer = meta.importer;
    }
    if (typeof meta.imported !== 'boolean') {
        meta.imported = false;
    }
    else {
        meta.imported = meta.imported;
    }
    if (typeof meta.uuid !== 'string' || meta.uuid.length < 36) {
        meta.uuid = (0, node_uuid_1.v4)();
    }
    else {
        meta.uuid = meta.uuid;
    }
    if (!Array.isArray(meta.files)) {
        meta.files = [];
    }
    if (typeof meta.subMetas !== 'object') {
        meta.subMetas = Object.create(null);
    }
    else {
        Object.keys(meta.subMetas).forEach((id) => {
            completionMeta(meta.subMetas[id]);
        });
    }
    if (typeof meta.userData !== 'object') {
        meta.userData = Object.create(null);
    }
    else {
        meta.userData = meta.userData;
    }
    if (typeof meta.displayName !== 'string') {
        meta.displayName = '';
    }
    else {
        meta.displayName = meta.displayName;
    }
    if (typeof meta.id !== 'string') {
        meta.id = '';
    }
    else {
        meta.id = meta.id;
    }
    if (typeof meta.name !== 'string') {
        meta.name = '';
    }
    else {
        meta.name = meta.name;
    }
    return meta;
}
exports.completionMeta = completionMeta;
class MetaManager {
    constructor() {
        // 资源与 meta 的映射列表
        this.path2meta = {};
    }
    /**
     * 设置备份目录
     * @param dirname
     */
    async setBackupPath(dirname) {
        this.backupDirname = dirname;
    }
    /**
     * 设置记录 json 的存放文件
     * @param json
     */
    async setRecordJSON(json) {
        this.backupJSONFile = json;
        // 启动 db 的时候，读取之前的记录
        try {
            // this.path2backup = existsSync(this.backupJSONFile) ? readJSONSync(this.backupJSONFile) : {};
        }
        catch (error) {
            // this.path2backup = {};
            console.error(error);
        }
    }
    /**
     * 销毁一个管理器实例
     * @param manager
     */
    destroy() {
        this.path2meta = {};
        // this.path2backup = {};
    }
    /**
     * 立即保存当前缓存的数据
     */
    saveImmediate() {
        clearTimeout(this._saveTimer);
        if (!this.backupJSONFile) {
            return;
        }
        // outputJSONSync(this.backupJSONFile, this.path2backup, {
        //     spaces: 2,
        //     EOL: '\n',
        // });
    }
    /**
     * 触发保存动作，会延迟并合并多个保存操作
     */
    save() {
        clearTimeout(this._saveTimer);
        this._saveTimer = setTimeout(() => {
            this.saveImmediate();
        }, 500);
    }
    /**
     * 从硬盘读取更新一个 meta 文件数据到内存里
     * @param path
     */
    read(path) {
        let metaInfo;
        let string;
        try {
            string = (0, fs_extra_1.readFileSync)(path, 'utf8');
        }
        catch (error) {
            return false;
        }
        try {
            if (this.path2meta[path]) {
                metaInfo = this.path2meta[path];
            }
            else {
                // 这里的 json 后续会填充
                metaInfo = this.path2meta[path] = { json: {}, backup: '', EOL: '\n' };
            }
            const json = JSON.parse(string);
            // 备份原始数据，需要重新序列化，去掉部分换行
            metaInfo.backup = JSON.stringify(json);
            // 如果更新的 meta 上的 uuid 变化，则需要发送资源变化的消息
            // 不需要处理
            // if (metaInfo.json.uuid && metaInfo.json.uuid !== json.uuid) {
            // }
            copyMeta(metaInfo.json, json);
            metaInfo.EOL = string ? (/\r\n/.test(string) ? '\r\n' : '\n') : '\n';
            // 如果备份存在，读取后就需要删除了
            // if (this.path2backup[path]) {
            //     delete this.path2backup[path];
            //     this.save();
            // }
            return true;
        }
        catch (error) {
            console.warn(error);
        }
        if (this.path2meta[path]) {
            completionMeta(this.path2meta[path].json);
        }
    }
    write(path) {
        const item = this.path2meta[path];
        if (!item) {
            return false;
        }
        // @ts-ignore
        delete item.json.displayName;
        // @ts-ignore
        delete item.json.id;
        // @ts-ignore
        delete item.json.name;
        const str = JSON.stringify(item.json);
        if (str === item.backup && (0, fs_extra_1.existsSync)(path)) {
            return;
        }
        (0, fs_extra_1.outputJSONSync)(path, this.path2meta[path].json, {
            spaces: 2,
            EOL: this.path2meta[path].EOL,
        });
        item.backup = str;
    }
    /**
     * 删除内存中的一个 MetaInfo 数据
     * 并放入 backup 文件夹
     * @param path
     */
    remove(path) {
        // 删除内存数据
        delete this.path2meta[path];
        if (this.backupDirname) {
            // 将 meta 文件放到备份目录
            // const dist = join(this.backupDirname, v1());
            try {
                (0, fs_extra_1.removeSync)(path);
                // moveSync(path, dist);
                // this.path2backup[path] = dist;
            }
            catch (error) { }
        }
        this.save();
    }
    /**
     * 从缓存里取一个 MetaInfo
     * 如果不存在，则取备份数据
     * 如果还不存在，则生成新的空 MetaInfo 和 meta 文件
     * @param path
     */
    get(path) {
        // 如果数据在内存， 直接返回
        if (this.path2meta[path]) {
            return this.path2meta[path];
        }
        // 如果文件存在，则更新到内存里
        if ((0, fs_extra_1.existsSync)(path)) {
            this.read(path);
            if (this.path2meta[path]) {
                return this.path2meta[path];
            }
        }
        // 如果都不存在，查询备份路径是否存在文件
        // if (this.path2backup[path]) {
        //     const backupFile = this.path2backup[path];
        //     delete this.path2backup[path];
        //     this.save();
        //     try {
        //         moveSync(backupFile, path);
        //         this.read(path);
        //         if (this.path2meta[path]) {
        //             return this.path2meta[path];
        //         }
        //     } catch (error) {
        //         console.warn(error);
        //     }
        // }
        const json = completionMeta({});
        this.path2meta[path] = {
            json,
            backup: JSON.stringify(json),
            EOL: '\n',
        };
        this.write(path);
        return this.path2meta[path];
    }
    move(pathA, pathB) {
        if (this.path2meta[pathB]) {
            const json = this.path2meta[pathB].json;
            this.path2meta[pathB].json = this.path2meta[pathA].json;
            copyMeta(this.path2meta[pathA].json, json);
        }
        else {
            this.path2meta[pathB] = this.path2meta[pathA];
        }
        delete this.path2meta[pathA];
    }
}
exports.MetaManager = MetaManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL21ldGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBd0c7QUFDeEcseUNBQW1DO0FBMEJuQzs7O0dBR0c7QUFDSCxTQUFTLFlBQVksQ0FBQyxJQUFTO0lBQzNCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixRQUFRLENBQUMsTUFBWSxFQUFFLE1BQVk7SUFDL0MsTUFBTSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDO0lBQ2pELE1BQU0sQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUM7SUFDekMsTUFBTSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQztJQUMzQyxNQUFNLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLElBQUksSUFBQSxjQUFFLEdBQUUsQ0FBQztJQUNsQyxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO0lBRWxDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7SUFDeEMsTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFVLEVBQUUsRUFBRTtRQUNuRSxNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUs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LCBvdXRwdXRKU09OU3luYywgcmVhZEpTT05TeW5jLCBtb3ZlU3luYywgcmVhZEZpbGVTeW5jLCByZW1vdmVTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgdjEsIHY0IH0gZnJvbSAnbm9kZS11dWlkJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcblxuLy8gTWV0YSBqc29uIOaWh+S7tueahOagvOW8j1xuZXhwb3J0IGludGVyZmFjZSBNZXRhIHtcbiAgICB2ZXI6IHN0cmluZzsgICAgICAgLy8g54mI5pys77yM5Y+q6KaB54mI5pys5Y+35LiN5ZCM77yM5bCx5bqU6K+l6YeN5paw5a+85YWlXG4gICAgaW1wb3J0ZXI6IHN0cmluZzsgIC8vIOino+aekOW9k+WJjeaWh+S7tueahOino+aekOWZqOWQjeWtl1xuICAgIGltcG9ydGVkOiBib29sZWFuOyAvLyDmmK/lkKblt7Lnu4/miJDlip/lr7zlhaXlrozmiJBcbiAgICB1dWlkOiBzdHJpbmc7ICAgICAgLy8g5b2T5YmN6LWE5rqQ55qEIHV1aWRcbiAgICBmaWxlczogc3RyaW5nW107ICAgLy8gYXNzZXQg5a+85YWl5LqG5Yeg5Liq5paH5Lu25YiwIGxpYnJhcnlcbiAgICBzdWJNZXRhczogeyBbaW5kZXg6IHN0cmluZ106IE1ldGEgfTsgIC8vIOW9k+WJjSBhc3NldCDnmoQgc3ViIGFzc2V0XG4gICAgdXNlckRhdGE6IHsgW2luZGV4OiBzdHJpbmddOiBhbnkgfTsgICAgIC8vIOS4gOS6myBpbXBvcnRlciDlhoXlrprkuYnnmoTmlbDmja5cblxuICAgIC8vIOWunuS9k+i1hOa6kOayoeaciei/meWHoOS4quWxnuaAp1xuICAgIGRpc3BsYXlOYW1lOiBzdHJpbmc7IC8vIOeUqOS6juaYvuekuueahOWQjeWtl1xuICAgIGlkOiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xufVxuXG4vLyBNZXRhIOWcqOeuoeeQhuWZqOmHjOWtmOaUvueahOaVsOaNruagvOW8j1xuZXhwb3J0IGludGVyZmFjZSBNZXRhSW5mbyB7XG4gICAganNvbjogTWV0YTtcbiAgICBiYWNrdXA6IHN0cmluZztcbiAgICBFT0w6ICdcXG4nIHwgJ1xcclxcbic7XG59XG5cbi8qKlxuICog5aSN5Yi25LiA5LiqIGpzb24g5pWw5o2uXG4gKiBAcGFyYW0ganNvbiBcbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVKU09OKGpzb246IGFueSkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGpzb24pKTtcbn1cblxuLyoqXG4gKiDlpI3liLYgbWV0YSDmlbDmja7vvIzlsIYgb3JpZ2luIOS4iueahOaVsOaNruWkjeWItuWIsCB0YXJnZXQg5LiKXG4gKiBAcGFyYW0gdGFyZ2V0IFxuICogQHBhcmFtIG9yaWdpbiBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvcHlNZXRhKHRhcmdldDogTWV0YSwgb3JpZ2luOiBNZXRhKSB7XG4gICAgdGFyZ2V0LnZlciA9IG9yaWdpbi52ZXIgfHwgdGFyZ2V0LnZlciB8fCAnMC4wLjAnO1xuICAgIHRhcmdldC5pbXBvcnRlciA9IG9yaWdpbi5pbXBvcnRlciB8fCAnKic7XG4gICAgdGFyZ2V0LmltcG9ydGVkID0gb3JpZ2luLmltcG9ydGVkIHx8IGZhbHNlO1xuICAgIHRhcmdldC51dWlkID0gb3JpZ2luLnV1aWQgfHwgdjQoKTtcbiAgICB0YXJnZXQuZmlsZXMgPSBvcmlnaW4uZmlsZXMgfHwgW107XG5cbiAgICB0YXJnZXQuc3ViTWV0YXMgPSB0YXJnZXQuc3ViTWV0YXMgfHwge307XG4gICAgb3JpZ2luLnN1Yk1ldGFzICYmIE9iamVjdC5rZXlzKG9yaWdpbi5zdWJNZXRhcykuZm9yRWFjaCgoaWQ6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjaGlsZCA9IGdlbmVyYXRlSlNPTihvcmlnaW4uc3ViTWV0YXNbaWRdKTtcbiAgICAgICAgaWYgKCF0YXJnZXQuc3ViTWV0YXNbaWRdKSB7XG4gICAgICAgICAgICB0YXJnZXQuc3ViTWV0YXNbaWRdID0gY2hpbGQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb3B5TWV0YSh0YXJnZXQuc3ViTWV0YXNbaWRdLCBjaGlsZCk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB0YXJnZXQudXNlckRhdGEgPSBnZW5lcmF0ZUpTT04ob3JpZ2luLnVzZXJEYXRhIHx8IHt9KTtcblxuICAgIHRhcmdldC5kaXNwbGF5TmFtZSA9IG9yaWdpbi5kaXNwbGF5TmFtZSB8fCAnJztcbiAgICB0YXJnZXQuaWQgPSBvcmlnaW4uaWQgfHwgJyc7XG4gICAgdGFyZ2V0Lm5hbWUgPSBvcmlnaW4ubmFtZSB8fCAnJztcbn1cblxuXG4vKipcbiAqIOihpeWFqCBtZXRhIOaVsOaNrlxuICogQHBhcmFtIG1ldGEgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wbGV0aW9uTWV0YShtZXRhOiBhbnkpOiBNZXRhIHtcbiAgICBpZiAodHlwZW9mIG1ldGEudmVyICE9PSAnc3RyaW5nJykge1xuICAgICAgICBtZXRhLnZlciA9ICcwLjAuMCc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS52ZXIgPSBtZXRhLnZlcjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIG1ldGEuaW1wb3J0ZXIgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG1ldGEuaW1wb3J0ZXIgPSAnKic7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS5pbXBvcnRlciA9IG1ldGEuaW1wb3J0ZXI7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRhLmltcG9ydGVkICE9PSAnYm9vbGVhbicpIHtcbiAgICAgICAgbWV0YS5pbXBvcnRlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEuaW1wb3J0ZWQgPSBtZXRhLmltcG9ydGVkO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS51dWlkICE9PSAnc3RyaW5nJyB8fCBtZXRhLnV1aWQubGVuZ3RoIDwgMzYpIHtcbiAgICAgICAgbWV0YS51dWlkID0gdjQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBtZXRhLnV1aWQgPSBtZXRhLnV1aWQ7XG4gICAgfVxuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KG1ldGEuZmlsZXMpKSB7XG4gICAgICAgIG1ldGEuZmlsZXMgPSBbXTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBtZXRhLnN1Yk1ldGFzICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBtZXRhLnN1Yk1ldGFzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3Qua2V5cyhtZXRhLnN1Yk1ldGFzKS5mb3JFYWNoKChpZDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBjb21wbGV0aW9uTWV0YShtZXRhLnN1Yk1ldGFzW2lkXSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS51c2VyRGF0YSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgbWV0YS51c2VyRGF0YSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS51c2VyRGF0YSA9IG1ldGEudXNlckRhdGE7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRhLmRpc3BsYXlOYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgICBtZXRhLmRpc3BsYXlOYW1lID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS5kaXNwbGF5TmFtZSA9IG1ldGEuZGlzcGxheU5hbWU7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRhLmlkICE9PSAnc3RyaW5nJykge1xuICAgICAgICBtZXRhLmlkID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS5pZCA9IG1ldGEuaWQ7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRhLm5hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG1ldGEubmFtZSA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEubmFtZSA9IG1ldGEubmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIG1ldGE7XG59XG5cbmV4cG9ydCBjbGFzcyBNZXRhTWFuYWdlciB7XG5cbiAgICAvLyDotYTmupDkuI4gbWV0YSDnmoTmmKDlsITliJfooahcbiAgICBwYXRoMm1ldGE6IHsgW2luZGV4OiBzdHJpbmddOiBNZXRhSW5mbyB9ID0ge307XG5cbiAgICAvLyDlpIfku73nmoQgbWV0YSDliJfooahcbiAgICAvLyBwYXRoMmJhY2t1cDogeyBbaW5kZXg6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbiAgICAvLyDlpIfku73lrZjlgqjmlbDmja7nmoTkvY3nva7vvIzov5nmmK/kuIDkuKoganNvbiDmlofku7bot6/lvoTvvIzkvovlpoIgeHh4L2Fzc2V0cy1tZXRhLWJhY2t1cC5qc29uXG4gICAgYmFja3VwSlNPTkZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIC8vIG1ldGEg5aSH5Lu95paH5Lu25a2Y5pS+55qE55uu5b2VXG4gICAgYmFja3VwRGlybmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgX3NhdmVUaW1lcjogYW55O1xuXG4gICAgLyoqXG4gICAgICog6K6+572u5aSH5Lu955uu5b2VXG4gICAgICogQHBhcmFtIGRpcm5hbWUgXG4gICAgICovXG4gICAgYXN5bmMgc2V0QmFja3VwUGF0aChkaXJuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5iYWNrdXBEaXJuYW1lID0gZGlybmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDorr7nva7orrDlvZUganNvbiDnmoTlrZjmlL7mlofku7ZcbiAgICAgKiBAcGFyYW0ganNvbiBcbiAgICAgKi9cbiAgICBhc3luYyBzZXRSZWNvcmRKU09OKGpzb246IHN0cmluZykge1xuICAgICAgICB0aGlzLmJhY2t1cEpTT05GaWxlID0ganNvbjtcblxuICAgICAgICAvLyDlkK/liqggZGIg55qE5pe25YCZ77yM6K+75Y+W5LmL5YmN55qE6K6w5b2VXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyB0aGlzLnBhdGgyYmFja3VwID0gZXhpc3RzU3luYyh0aGlzLmJhY2t1cEpTT05GaWxlKSA/IHJlYWRKU09OU3luYyh0aGlzLmJhY2t1cEpTT05GaWxlKSA6IHt9O1xuICAgICAgICB9IGNhdGNoKGVycm9yKSB7XG4gICAgICAgICAgICAvLyB0aGlzLnBhdGgyYmFja3VwID0ge307XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmUgOavgeS4gOS4queuoeeQhuWZqOWunuS+i1xuICAgICAqIEBwYXJhbSBtYW5hZ2VyIFxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMucGF0aDJtZXRhID0ge307XG4gICAgICAgIC8vIHRoaXMucGF0aDJiYWNrdXAgPSB7fTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDnq4vljbPkv53lrZjlvZPliY3nvJPlrZjnmoTmlbDmja5cbiAgICAgKi9cbiAgICBzYXZlSW1tZWRpYXRlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcblxuICAgICAgICBpZiAoIXRoaXMuYmFja3VwSlNPTkZpbGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBvdXRwdXRKU09OU3luYyh0aGlzLmJhY2t1cEpTT05GaWxlLCB0aGlzLnBhdGgyYmFja3VwLCB7XG4gICAgICAgIC8vICAgICBzcGFjZXM6IDIsXG4gICAgICAgIC8vICAgICBFT0w6ICdcXG4nLFxuICAgICAgICAvLyB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDop6blj5Hkv53lrZjliqjkvZzvvIzkvJrlu7bov5/lubblkIjlubblpJrkuKrkv53lrZjmk43kvZxcbiAgICAgKi9cbiAgICBzYXZlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2F2ZVRpbWVyKTtcbiAgICAgICAgdGhpcy5fc2F2ZVRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNhdmVJbW1lZGlhdGUoKTtcbiAgICAgICAgfSwgNTAwKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDku47noaznm5jor7vlj5bmm7TmlrDkuIDkuKogbWV0YSDmlofku7bmlbDmja7liLDlhoXlrZjph4xcbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKi9cbiAgICByZWFkKHBhdGg6IHN0cmluZykge1xuICAgICAgICBsZXQgbWV0YUluZm86IE1ldGFJbmZvO1xuICAgICAgICBsZXQgc3RyaW5nOiBzdHJpbmc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzdHJpbmcgPSByZWFkRmlsZVN5bmMocGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnBhdGgybWV0YVtwYXRoXSkge1xuICAgICAgICAgICAgICAgIG1ldGFJbmZvID0gdGhpcy5wYXRoMm1ldGFbcGF0aF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIOi/memHjOeahCBqc29uIOWQjue7reS8muWhq+WFhVxuICAgICAgICAgICAgICAgIG1ldGFJbmZvID0gdGhpcy5wYXRoMm1ldGFbcGF0aF0gPSB7IGpzb246IHt9IGFzIE1ldGEsIGJhY2t1cDogJycsIEVPTDogJ1xcbicgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2Uoc3RyaW5nKTtcbiAgICAgICAgICAgIC8vIOWkh+S7veWOn+Wni+aVsOaNru+8jOmcgOimgemHjeaWsOW6j+WIl+WMlu+8jOWOu+aOiemDqOWIhuaNouihjFxuICAgICAgICAgICAgbWV0YUluZm8uYmFja3VwID0gSlNPTi5zdHJpbmdpZnkoanNvbik7XG4gICAgXG4gICAgICAgICAgICAvLyDlpoLmnpzmm7TmlrDnmoQgbWV0YSDkuIrnmoQgdXVpZCDlj5jljJbvvIzliJnpnIDopoHlj5HpgIHotYTmupDlj5jljJbnmoTmtojmga9cbiAgICAgICAgICAgIC8vIOS4jemcgOimgeWkhOeQhlxuICAgICAgICAgICAgLy8gaWYgKG1ldGFJbmZvLmpzb24udXVpZCAmJiBtZXRhSW5mby5qc29uLnV1aWQgIT09IGpzb24udXVpZCkge1xuICAgICAgICAgICAgLy8gfVxuICAgIFxuICAgICAgICAgICAgY29weU1ldGEobWV0YUluZm8uanNvbiwganNvbik7XG4gICAgICAgICAgICBtZXRhSW5mby5FT0wgPSBzdHJpbmcgPyAoL1xcclxcbi8udGVzdChzdHJpbmcpID8gJ1xcclxcbicgOiAnXFxuJykgOiAnXFxuJztcbiAgICBcbiAgICAgICAgICAgIC8vIOWmguaenOWkh+S7veWtmOWcqO+8jOivu+WPluWQjuWwsemcgOimgeWIoOmZpOS6hlxuICAgICAgICAgICAgLy8gaWYgKHRoaXMucGF0aDJiYWNrdXBbcGF0aF0pIHtcbiAgICAgICAgICAgIC8vICAgICBkZWxldGUgdGhpcy5wYXRoMmJhY2t1cFtwYXRoXTtcbiAgICAgICAgICAgIC8vICAgICB0aGlzLnNhdmUoKTtcbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucGF0aDJtZXRhW3BhdGhdKSB7XG4gICAgICAgICAgICBjb21wbGV0aW9uTWV0YSh0aGlzLnBhdGgybWV0YVtwYXRoXS5qc29uKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHdyaXRlKHBhdGgpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuICAgICAgICBpZiAoIWl0ZW0pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZGVsZXRlIGl0ZW0uanNvbi5kaXNwbGF5TmFtZTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBkZWxldGUgaXRlbS5qc29uLmlkO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGRlbGV0ZSBpdGVtLmpzb24ubmFtZTtcblxuICAgICAgICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShpdGVtLmpzb24pO1xuICAgICAgICBpZiAoc3RyID09PSBpdGVtLmJhY2t1cCAmJiBleGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXRKU09OU3luYyhwYXRoLCB0aGlzLnBhdGgybWV0YVtwYXRoXS5qc29uLCB7XG4gICAgICAgICAgICBzcGFjZXM6IDIsXG4gICAgICAgICAgICBFT0w6IHRoaXMucGF0aDJtZXRhW3BhdGhdLkVPTCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXRlbS5iYWNrdXAgPSBzdHI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5Yig6Zmk5YaF5a2Y5Lit55qE5LiA5LiqIE1ldGFJbmZvIOaVsOaNrlxuICAgICAqIOW5tuaUvuWFpSBiYWNrdXAg5paH5Lu25aS5XG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICovXG4gICAgcmVtb3ZlKHBhdGg6IHN0cmluZykge1xuICAgICAgICAvLyDliKDpmaTlhoXlrZjmlbDmja5cbiAgICAgICAgZGVsZXRlIHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuXG4gICAgICAgIGlmICh0aGlzLmJhY2t1cERpcm5hbWUpIHtcbiAgICAgICAgICAgIC8vIOWwhiBtZXRhIOaWh+S7tuaUvuWIsOWkh+S7veebruW9lVxuICAgICAgICAgICAgLy8gY29uc3QgZGlzdCA9IGpvaW4odGhpcy5iYWNrdXBEaXJuYW1lLCB2MSgpKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlU3luYyhwYXRoKTtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlU3luYyhwYXRoLCBkaXN0KTtcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnBhdGgyYmFja3VwW3BhdGhdID0gZGlzdDtcbiAgICAgICAgICAgIH0gY2F0Y2goZXJyb3IpIHt9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDku47nvJPlrZjph4zlj5bkuIDkuKogTWV0YUluZm9cbiAgICAgKiDlpoLmnpzkuI3lrZjlnKjvvIzliJnlj5blpIfku73mlbDmja5cbiAgICAgKiDlpoLmnpzov5jkuI3lrZjlnKjvvIzliJnnlJ/miJDmlrDnmoTnqbogTWV0YUluZm8g5ZKMIG1ldGEg5paH5Lu2XG4gICAgICogQHBhcmFtIHBhdGggXG4gICAgICovXG4gICAgZ2V0KHBhdGg6IHN0cmluZyk6IE1ldGFJbmZvIHtcbiAgICAgICAgLy8g5aaC5p6c5pWw5o2u5Zyo5YaF5a2Y77yMIOebtOaOpei/lOWbnlxuICAgICAgICBpZiAodGhpcy5wYXRoMm1ldGFbcGF0aF0pIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgybWV0YVtwYXRoXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWmguaenOaWh+S7tuWtmOWcqO+8jOWImeabtOaWsOWIsOWGheWtmOmHjFxuICAgICAgICBpZiAoZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgICAgICAgdGhpcy5yZWFkKHBhdGgpO1xuICAgICAgICAgICAgaWYgKHRoaXMucGF0aDJtZXRhW3BhdGhdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8g5aaC5p6c6YO95LiN5a2Y5Zyo77yM5p+l6K+i5aSH5Lu96Lev5b6E5piv5ZCm5a2Y5Zyo5paH5Lu2XG4gICAgICAgIC8vIGlmICh0aGlzLnBhdGgyYmFja3VwW3BhdGhdKSB7XG4gICAgICAgIC8vICAgICBjb25zdCBiYWNrdXBGaWxlID0gdGhpcy5wYXRoMmJhY2t1cFtwYXRoXTtcbiAgICAgICAgLy8gICAgIGRlbGV0ZSB0aGlzLnBhdGgyYmFja3VwW3BhdGhdO1xuICAgICAgICAvLyAgICAgdGhpcy5zYXZlKCk7XG4gICAgICAgIC8vICAgICB0cnkge1xuICAgICAgICAvLyAgICAgICAgIG1vdmVTeW5jKGJhY2t1cEZpbGUsIHBhdGgpO1xuICAgICAgICAvLyAgICAgICAgIHRoaXMucmVhZChwYXRoKTtcbiAgICAgICAgLy8gICAgICAgICBpZiAodGhpcy5wYXRoMm1ldGFbcGF0aF0pIHtcbiAgICAgICAgLy8gICAgICAgICAgICAgcmV0dXJuIHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuICAgICAgICAvLyAgICAgICAgIH1cbiAgICAgICAgLy8gICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vICAgICAgICAgY29uc29sZS53YXJuKGVycm9yKTtcbiAgICAgICAgLy8gICAgIH1cbiAgICAgICAgLy8gfVxuXG4gICAgICAgIGNvbnN0IGpzb24gPSBjb21wbGV0aW9uTWV0YSh7fSk7XG4gICAgICAgIHRoaXMucGF0aDJtZXRhW3BhdGhdID0ge1xuICAgICAgICAgICAganNvbixcbiAgICAgICAgICAgIGJhY2t1cDogSlNPTi5zdHJpbmdpZnkoanNvbiksXG4gICAgICAgICAgICBFT0w6ICdcXG4nLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMud3JpdGUocGF0aCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuICAgIH1cblxuICAgIG1vdmUocGF0aEE6IHN0cmluZywgcGF0aEI6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5wYXRoMm1ldGFbcGF0aEJdKSB7XG4gICAgICAgICAgICBjb25zdCBqc29uID0gdGhpcy5wYXRoMm1ldGFbcGF0aEJdLmpzb247XG4gICAgICAgICAgICB0aGlzLnBhdGgybWV0YVtwYXRoQl0uanNvbiA9IHRoaXMucGF0aDJtZXRhW3BhdGhBXS5qc29uO1xuICAgICAgICAgICAgY29weU1ldGEodGhpcy5wYXRoMm1ldGFbcGF0aEFdLmpzb24sIGpzb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wYXRoMm1ldGFbcGF0aEJdID0gdGhpcy5wYXRoMm1ldGFbcGF0aEFdO1xuICAgICAgICB9XG4gICAgICAgIGRlbGV0ZSB0aGlzLnBhdGgybWV0YVtwYXRoQV07XG4gICAgfVxufSJdfQ==