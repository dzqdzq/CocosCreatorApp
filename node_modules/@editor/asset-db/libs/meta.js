"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MetaManager=exports.completionMeta=exports.copyMeta=void 0;const fs_extra_1=require("fs-extra"),node_uuid_1=require("node-uuid");function generateJSON(t){return JSON.parse(JSON.stringify(t))}function copyMeta(t,e){t.ver=e.ver||t.ver||"0.0.0",t.importer=e.importer||"*",t.imported=e.imported||!1,t.uuid=e.uuid||(0,node_uuid_1.v4)(),t.files=e.files||[],t.subMetas=t.subMetas||{},e.subMetas&&Object.keys(e.subMetas).forEach(a=>{const s=generateJSON(e.subMetas[a]);t.subMetas[a]?copyMeta(t.subMetas[a],s):t.subMetas[a]=s}),t.userData=generateJSON(e.userData||{}),t.displayName=e.displayName||"",t.id=e.id||"",t.name=e.name||""}function completionMeta(t){return"string"!=typeof t.ver?t.ver="0.0.0":t.ver=t.ver,"string"!=typeof t.importer?t.importer="*":t.importer=t.importer,"boolean"!=typeof t.imported?t.imported=!1:t.imported=t.imported,"string"!=typeof t.uuid||t.uuid.length<36?t.uuid=(0,node_uuid_1.v4)():t.uuid=t.uuid,Array.isArray(t.files)||(t.files=[]),"object"!=typeof t.subMetas?t.subMetas=Object.create(null):Object.keys(t.subMetas).forEach(e=>{completionMeta(t.subMetas[e])}),"object"!=typeof t.userData?t.userData=Object.create(null):t.userData=t.userData,"string"!=typeof t.displayName?t.displayName="":t.displayName=t.displayName,"string"!=typeof t.id?t.id="":t.id=t.id,"string"!=typeof t.name?t.name="":t.name=t.name,t}exports.copyMeta=copyMeta,exports.completionMeta=completionMeta;class MetaManager{constructor(){this.path2meta={}}destroy(){this.path2meta={}}read(t){let e,a;try{a=(0,fs_extra_1.readFileSync)(t,"utf8")}catch(t){return!1}try{e=this.path2meta[t]?this.path2meta[t]:this.path2meta[t]={json:{},backup:"",EOL:"\n"};const s=JSON.parse(a);return e.backup=JSON.stringify(s),copyMeta(e.json,s),e.EOL=a&&/\r\n/.test(a)?"\r\n":"\n",!0}catch(t){console.warn(t)}this.path2meta[t]&&completionMeta(this.path2meta[t].json)}write(t){const e=this.path2meta[t];if(!e)return!1;delete e.json.displayName,delete e.json.id,delete e.json.name;const a=JSON.stringify(e.json);a===e.backup&&(0,fs_extra_1.existsSync)(t)||((0,fs_extra_1.outputJSONSync)(t,this.path2meta[t].json,{spaces:2,EOL:this.path2meta[t].EOL}),e.backup=a)}remove(t){delete this.path2meta[t]}get(t){if(this.path2meta[t])return this.path2meta[t];if((0,fs_extra_1.existsSync)(t)&&(this.read(t),this.path2meta[t]))return this.path2meta[t];const e=completionMeta({});return this.path2meta[t]={json:e,backup:JSON.stringify(e),EOL:"\n"},this.write(t),this.path2meta[t]}move(t,e){if(this.path2meta[e]){const a=this.path2meta[e].json;this.path2meta[e].json=this.path2meta[t].json,copyMeta(this.path2meta[t].json,a)}else this.path2meta[e]=this.path2meta[t];delete this.path2meta[t]}}exports.MetaManager=MetaManager;