"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MetaManager=exports.completionMeta=exports.copyMeta=void 0;const fs_extra_1=require("fs-extra"),node_uuid_1=require("node-uuid"),path_1=require("path");function generateJSON(t){return JSON.parse(JSON.stringify(t))}function copyMeta(t,e){t.ver=e.ver||t.ver||"0.0.0",t.importer=e.importer||"*",t.imported=e.imported||!1,t.uuid=e.uuid||node_uuid_1.v4(),t.files=e.files||[],t.subMetas=t.subMetas||{},e.subMetas&&Object.keys(e.subMetas).forEach(a=>{const s=generateJSON(e.subMetas[a]);t.subMetas[a]?copyMeta(t.subMetas[a],s):t.subMetas[a]=s}),t.userData=generateJSON(e.userData||{}),t.displayName=e.displayName||"",t.id=e.id||"",t.name=e.name||""}function completionMeta(t){return"string"!=typeof t.ver?t.ver="0.0.0":t.ver=t.ver,"string"!=typeof t.importer?t.importer="*":t.importer=t.importer,"boolean"!=typeof t.imported?t.imported=!1:t.imported=t.imported,"string"!=typeof t.uuid||t.uuid.length<36?t.uuid=node_uuid_1.v4():t.uuid=t.uuid,Array.isArray(t.files)||(t.files=[]),"object"!=typeof t.subMetas?t.subMetas=Object.create(null):Object.keys(t.subMetas).forEach(e=>{completionMeta(t.subMetas[e])}),"object"!=typeof t.userData?t.userData=Object.create(null):t.userData=t.userData,"string"!=typeof t.displayName?t.displayName="":t.displayName=t.displayName,"string"!=typeof t.id?t.id="":t.id=t.id,"string"!=typeof t.name?t.name="":t.name=t.name,t}exports.copyMeta=copyMeta,exports.completionMeta=completionMeta;class MetaManager{constructor(){this.path2meta={},this.path2backup={}}async setBackupPath(t){this.backupDirname=t}async setRecordJSON(t){this.backupJSONFile=t;try{this.path2backup=fs_extra_1.existsSync(this.backupJSONFile)?fs_extra_1.readJSONSync(this.backupJSONFile):{}}catch(t){this.path2backup={},console.error(t)}}destroy(){this.path2meta={},this.path2backup={}}saveImmediate(){clearTimeout(this._saveTimer),this.backupJSONFile&&fs_extra_1.outputJSONSync(this.backupJSONFile,this.path2backup,{spaces:2,EOL:"\n"})}save(){clearTimeout(this._saveTimer),this._saveTimer=setTimeout(()=>{this.saveImmediate()},500)}read(t){try{if(!fs_extra_1.existsSync(t))return!1;const e=this.path2meta[t]=this.path2meta[t]||{json:{},backup:"",EOL:"\n"},a=fs_extra_1.readFileSync(t,"utf8"),s=JSON.parse(a);return e.backup=JSON.stringify(s),e.json.uuid&&(e.json.uuid,s.uuid),copyMeta(e.json,s),e.EOL=a&&/\r\n/.test(a)?"\r\n":"\n",this.path2backup[t]&&(delete this.path2backup[t],this.save()),!0}catch(t){console.warn(t)}this.path2meta[t]&&completionMeta(this.path2meta[t].json)}write(t){const e=this.path2meta[t];if(!e)return!1;delete e.json.displayName,delete e.json.id,delete e.json.name;const a=JSON.stringify(e.json);a===e.backup&&fs_extra_1.existsSync(t)||(fs_extra_1.outputJSONSync(t,this.path2meta[t].json,{spaces:2,EOL:this.path2meta[t].EOL}),e.backup=a)}remove(t){if(delete this.path2meta[t],fs_extra_1.existsSync(t)){if(this.backupDirname){const e=path_1.join(this.backupDirname,node_uuid_1.v1());this.path2backup[t]=e,fs_extra_1.moveSync(t,e)}this.save()}}get(t){if(this.path2meta[t])return this.path2meta[t];if(fs_extra_1.existsSync(t)&&(this.read(t),this.path2meta[t]))return this.path2meta[t];if(this.path2backup[t]){const e=this.path2backup[t];delete this.path2backup[t],this.save();try{if(fs_extra_1.moveSync(e,t),this.read(t),this.path2meta[t])return this.path2meta[t]}catch(t){console.warn(t)}}const e=completionMeta({});return this.path2meta[t]={json:e,backup:JSON.stringify(e),EOL:"\n"},this.write(t),this.path2meta[t]}}exports.MetaManager=MetaManager;