'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetaManager = exports.completionMeta = exports.copyMeta = void 0;
const fs_extra_1 = require("fs-extra");
const node_uuid_1 = require("node-uuid");
/**
 * 复制一个 json 数据
 * @param json
 */
function generateJSON(json) {
    return JSON.parse(JSON.stringify(json));
}
/**
 * 复制 meta 数据，将 origin 上的数据复制到 target 上
 * @param target
 * @param origin
 */
function copyMeta(target, origin) {
    target.ver = origin.ver || target.ver || '0.0.0';
    target.importer = origin.importer || '*';
    target.imported = origin.imported || false;
    target.uuid = origin.uuid || (0, node_uuid_1.v4)();
    target.files = origin.files || [];
    target.subMetas = target.subMetas || {};
    origin.subMetas && Object.keys(origin.subMetas).forEach((id) => {
        const child = generateJSON(origin.subMetas[id]);
        if (!target.subMetas[id]) {
            target.subMetas[id] = child;
        }
        else {
            copyMeta(target.subMetas[id], child);
        }
    });
    target.userData = generateJSON(origin.userData || {});
    target.displayName = origin.displayName || '';
    target.id = origin.id || '';
    target.name = origin.name || '';
}
exports.copyMeta = copyMeta;
/**
 * 补全 meta 数据
 * @param meta
 */
function completionMeta(meta) {
    if (typeof meta.ver !== 'string') {
        meta.ver = '0.0.0';
    }
    else {
        meta.ver = meta.ver;
    }
    if (typeof meta.importer !== 'string') {
        meta.importer = '*';
    }
    else {
        meta.importer = meta.importer;
    }
    if (typeof meta.imported !== 'boolean') {
        meta.imported = false;
    }
    else {
        meta.imported = meta.imported;
    }
    if (typeof meta.uuid !== 'string' || meta.uuid.length < 36) {
        meta.uuid = (0, node_uuid_1.v4)();
    }
    else {
        meta.uuid = meta.uuid;
    }
    if (!Array.isArray(meta.files)) {
        meta.files = [];
    }
    if (typeof meta.subMetas !== 'object') {
        meta.subMetas = Object.create(null);
    }
    else {
        Object.keys(meta.subMetas).forEach((id) => {
            completionMeta(meta.subMetas[id]);
        });
    }
    if (typeof meta.userData !== 'object') {
        meta.userData = Object.create(null);
    }
    else {
        meta.userData = meta.userData;
    }
    if (typeof meta.displayName !== 'string') {
        meta.displayName = '';
    }
    else {
        meta.displayName = meta.displayName;
    }
    if (typeof meta.id !== 'string') {
        meta.id = '';
    }
    else {
        meta.id = meta.id;
    }
    if (typeof meta.name !== 'string') {
        meta.name = '';
    }
    else {
        meta.name = meta.name;
    }
    return meta;
}
exports.completionMeta = completionMeta;
class MetaManager {
    constructor(customConsole) {
        // 资源与 meta 的映射列表
        this.path2meta = {};
        this.console = customConsole || console;
    }
    /**
     * 销毁一个管理器实例
     * @param manager
     */
    destroy() {
        this.path2meta = {};
    }
    /**
     * 从硬盘读取更新一个 meta 文件数据到内存里
     * @param path
     */
    read(path) {
        let metaInfo;
        let string;
        try {
            string = (0, fs_extra_1.readFileSync)(path, 'utf8');
        }
        catch (error) {
            this.console.debug(`read meta file failed: ${path}`);
            return false;
        }
        try {
            if (this.path2meta[path]) {
                metaInfo = this.path2meta[path];
            }
            else {
                // 这里的 json 后续会填充
                metaInfo = this.path2meta[path] = { json: {}, backup: '', EOL: '\n' };
            }
            const json = JSON.parse(string);
            // 备份原始数据，需要重新序列化，去掉部分换行
            metaInfo.backup = JSON.stringify(json);
            // 如果更新的 meta 上的 uuid 变化，则需要发送资源变化的消息
            // 不需要处理
            // if (metaInfo.json.uuid && metaInfo.json.uuid !== json.uuid) {
            // }
            copyMeta(metaInfo.json, json);
            metaInfo.EOL = string ? (/\r\n/.test(string) ? '\r\n' : '\n') : '\n';
            // 如果备份存在，读取后就需要删除了
            // if (this.path2backup[path]) {
            //     delete this.path2backup[path];
            //     this.save();
            // }
            return true;
        }
        catch (error) {
            this.console.warn(`Read meta in ${path} failed!`);
            this.console.warn(error);
        }
        if (this.path2meta[path]) {
            completionMeta(this.path2meta[path].json);
        }
    }
    write(path) {
        const item = this.path2meta[path];
        if (!item) {
            return false;
        }
        // @ts-ignore
        delete item.json.displayName;
        // @ts-ignore
        delete item.json.id;
        // @ts-ignore
        delete item.json.name;
        const str = JSON.stringify(item.json);
        if (str === item.backup && (0, fs_extra_1.existsSync)(path)) {
            return;
        }
        (0, fs_extra_1.outputJSONSync)(path, this.path2meta[path].json, {
            spaces: 2,
            EOL: this.path2meta[path].EOL,
        });
        item.backup = str;
    }
    /**
     * 删除内存中的一个 MetaInfo 数据
     * 并放入 backup 文件夹
     * @param path
     */
    remove(path) {
        delete this.path2meta[path];
        try {
            (0, fs_extra_1.removeSync)(path);
        }
        catch (error) {
            console.debug(path);
        }
    }
    /**
     * 从缓存里取一个 MetaInfo
     * 如果不存在，则取备份数据
     * 如果还不存在，则生成新的空 MetaInfo 和 meta 文件
     * @param path
     */
    get(path) {
        // 如果数据在内存， 直接返回
        if (this.path2meta[path]) {
            return this.path2meta[path];
        }
        // 如果文件存在，则更新到内存里
        if ((0, fs_extra_1.existsSync)(path)) {
            this.read(path);
            if (this.path2meta[path]) {
                return this.path2meta[path];
            }
        }
        // 如果都不存在，查询备份路径是否存在文件
        // if (this.path2backup[path]) {
        //     const backupFile = this.path2backup[path];
        //     delete this.path2backup[path];
        //     this.save();
        //     try {
        //         moveSync(backupFile, path);
        //         this.read(path);
        //         if (this.path2meta[path]) {
        //             return this.path2meta[path];
        //         }
        //     } catch (error) {
        //         console.warn(error);
        //     }
        // }
        const json = completionMeta({});
        this.path2meta[path] = {
            json,
            backup: JSON.stringify(json),
            EOL: '\n',
        };
        this.write(path);
        return this.path2meta[path];
    }
    move(pathA, pathB) {
        if (this.path2meta[pathB]) {
            const json = this.path2meta[pathB].json;
            this.path2meta[pathB].json = this.path2meta[pathA].json;
            copyMeta(this.path2meta[pathA].json, json);
        }
        else {
            this.path2meta[pathB] = this.path2meta[pathA];
        }
        delete this.path2meta[pathA];
    }
}
exports.MetaManager = MetaManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9saWJzL21ldGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBd0c7QUFDeEcseUNBQW1DO0FBMEJuQzs7O0dBR0c7QUFDSCxTQUFTLFlBQVksQ0FBQyxJQUFTO0lBQzNCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixRQUFRLENBQUMsTUFBWSxFQUFFLE1BQVk7SUFDL0MsTUFBTSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDO0lBQ2pELE1BQU0sQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUM7SUFDekMsTUFBTSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQztJQUMzQyxNQUFNLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLElBQUksSUFBQSxjQUFFLEdBQUUsQ0FBQztJQUNsQyxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO0lBRWxDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7SUFDeEMsTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFVLEVBQUUsRUFBRTtRQUNuRSxNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUs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Q0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3hELFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztTQUM5QzthQUFNO1lBQ0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2pEO1FBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FDSjtBQXJLRCxrQ0FxS0MiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMsIG91dHB1dEpTT05TeW5jLCByZWFkSlNPTlN5bmMsIG1vdmVTeW5jLCByZWFkRmlsZVN5bmMsIHJlbW92ZVN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyB2MSwgdjQgfSBmcm9tICdub2RlLXV1aWQnO1xuaW1wb3J0IHsgQ3VzdG9tQ29uc29sZSB9IGZyb20gJy4vY29uc29sZSc7XG5cbi8vIE1ldGEganNvbiDmlofku7bnmoTmoLzlvI9cbmV4cG9ydCBpbnRlcmZhY2UgTWV0YSB7XG4gICAgdmVyOiBzdHJpbmc7ICAgICAgIC8vIOeJiOacrO+8jOWPquimgeeJiOacrOWPt+S4jeWQjO+8jOWwseW6lOivpemHjeaWsOWvvOWFpVxuICAgIGltcG9ydGVyOiBzdHJpbmc7ICAvLyDop6PmnpDlvZPliY3mlofku7bnmoTop6PmnpDlmajlkI3lrZdcbiAgICBpbXBvcnRlZDogYm9vbGVhbjsgLy8g5piv5ZCm5bey57uP5oiQ5Yqf5a+85YWl5a6M5oiQXG4gICAgdXVpZDogc3RyaW5nOyAgICAgIC8vIOW9k+WJjei1hOa6kOeahCB1dWlkXG4gICAgZmlsZXM6IHN0cmluZ1tdOyAgIC8vIGFzc2V0IOWvvOWFpeS6huWHoOS4quaWh+S7tuWIsCBsaWJyYXJ5XG4gICAgc3ViTWV0YXM6IHsgW2luZGV4OiBzdHJpbmddOiBNZXRhIH07ICAvLyDlvZPliY0gYXNzZXQg55qEIHN1YiBhc3NldFxuICAgIHVzZXJEYXRhOiB7IFtpbmRleDogc3RyaW5nXTogYW55IH07ICAgICAvLyDkuIDkupsgaW1wb3J0ZXIg5YaF5a6a5LmJ55qE5pWw5o2uXG5cbiAgICAvLyDlrp7kvZPotYTmupDmsqHmnInov5nlh6DkuKrlsZ7mgKdcbiAgICBkaXNwbGF5TmFtZTogc3RyaW5nOyAvLyDnlKjkuo7mmL7npLrnmoTlkI3lrZdcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbn1cblxuLy8gTWV0YSDlnKjnrqHnkIblmajph4zlrZjmlL7nmoTmlbDmja7moLzlvI9cbmV4cG9ydCBpbnRlcmZhY2UgTWV0YUluZm8ge1xuICAgIGpzb246IE1ldGE7XG4gICAgYmFja3VwOiBzdHJpbmc7XG4gICAgRU9MOiAnXFxuJyB8ICdcXHJcXG4nO1xufVxuXG4vKipcbiAqIOWkjeWItuS4gOS4qiBqc29uIOaVsOaNrlxuICogQHBhcmFtIGpzb24gXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlSlNPTihqc29uOiBhbnkpIHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShqc29uKSk7XG59XG5cbi8qKlxuICog5aSN5Yi2IG1ldGEg5pWw5o2u77yM5bCGIG9yaWdpbiDkuIrnmoTmlbDmja7lpI3liLbliLAgdGFyZ2V0IOS4ilxuICogQHBhcmFtIHRhcmdldCBcbiAqIEBwYXJhbSBvcmlnaW4gXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb3B5TWV0YSh0YXJnZXQ6IE1ldGEsIG9yaWdpbjogTWV0YSkge1xuICAgIHRhcmdldC52ZXIgPSBvcmlnaW4udmVyIHx8IHRhcmdldC52ZXIgfHwgJzAuMC4wJztcbiAgICB0YXJnZXQuaW1wb3J0ZXIgPSBvcmlnaW4uaW1wb3J0ZXIgfHwgJyonO1xuICAgIHRhcmdldC5pbXBvcnRlZCA9IG9yaWdpbi5pbXBvcnRlZCB8fCBmYWxzZTtcbiAgICB0YXJnZXQudXVpZCA9IG9yaWdpbi51dWlkIHx8IHY0KCk7XG4gICAgdGFyZ2V0LmZpbGVzID0gb3JpZ2luLmZpbGVzIHx8IFtdO1xuXG4gICAgdGFyZ2V0LnN1Yk1ldGFzID0gdGFyZ2V0LnN1Yk1ldGFzIHx8IHt9O1xuICAgIG9yaWdpbi5zdWJNZXRhcyAmJiBPYmplY3Qua2V5cyhvcmlnaW4uc3ViTWV0YXMpLmZvckVhY2goKGlkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBnZW5lcmF0ZUpTT04ob3JpZ2luLnN1Yk1ldGFzW2lkXSk7XG4gICAgICAgIGlmICghdGFyZ2V0LnN1Yk1ldGFzW2lkXSkge1xuICAgICAgICAgICAgdGFyZ2V0LnN1Yk1ldGFzW2lkXSA9IGNoaWxkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29weU1ldGEodGFyZ2V0LnN1Yk1ldGFzW2lkXSwgY2hpbGQpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgdGFyZ2V0LnVzZXJEYXRhID0gZ2VuZXJhdGVKU09OKG9yaWdpbi51c2VyRGF0YSB8fCB7fSk7XG5cbiAgICB0YXJnZXQuZGlzcGxheU5hbWUgPSBvcmlnaW4uZGlzcGxheU5hbWUgfHwgJyc7XG4gICAgdGFyZ2V0LmlkID0gb3JpZ2luLmlkIHx8ICcnO1xuICAgIHRhcmdldC5uYW1lID0gb3JpZ2luLm5hbWUgfHwgJyc7XG59XG5cblxuLyoqXG4gKiDooaXlhaggbWV0YSDmlbDmja5cbiAqIEBwYXJhbSBtZXRhIFxuICovXG5leHBvcnQgZnVuY3Rpb24gY29tcGxldGlvbk1ldGEobWV0YTogYW55KTogTWV0YSB7XG4gICAgaWYgKHR5cGVvZiBtZXRhLnZlciAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgbWV0YS52ZXIgPSAnMC4wLjAnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEudmVyID0gbWV0YS52ZXI7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBtZXRhLmltcG9ydGVyICE9PSAnc3RyaW5nJykge1xuICAgICAgICBtZXRhLmltcG9ydGVyID0gJyonO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEuaW1wb3J0ZXIgPSBtZXRhLmltcG9ydGVyO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS5pbXBvcnRlZCAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgIG1ldGEuaW1wb3J0ZWQgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBtZXRhLmltcG9ydGVkID0gbWV0YS5pbXBvcnRlZDtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIG1ldGEudXVpZCAhPT0gJ3N0cmluZycgfHwgbWV0YS51dWlkLmxlbmd0aCA8IDM2KSB7XG4gICAgICAgIG1ldGEudXVpZCA9IHY0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbWV0YS51dWlkID0gbWV0YS51dWlkO1xuICAgIH1cblxuICAgIGlmICghQXJyYXkuaXNBcnJheShtZXRhLmZpbGVzKSkge1xuICAgICAgICBtZXRhLmZpbGVzID0gW107XG4gICAgfVxuICAgIGlmICh0eXBlb2YgbWV0YS5zdWJNZXRhcyAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgbWV0YS5zdWJNZXRhcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgT2JqZWN0LmtleXMobWV0YS5zdWJNZXRhcykuZm9yRWFjaCgoaWQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgY29tcGxldGlvbk1ldGEobWV0YS5zdWJNZXRhc1tpZF0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIG1ldGEudXNlckRhdGEgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIG1ldGEudXNlckRhdGEgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEudXNlckRhdGEgPSBtZXRhLnVzZXJEYXRhO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS5kaXNwbGF5TmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgbWV0YS5kaXNwbGF5TmFtZSA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEuZGlzcGxheU5hbWUgPSBtZXRhLmRpc3BsYXlOYW1lO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS5pZCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgbWV0YS5pZCA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG1ldGEuaWQgPSBtZXRhLmlkO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgbWV0YS5uYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgICBtZXRhLm5hbWUgPSAnJztcbiAgICB9IGVsc2Uge1xuICAgICAgICBtZXRhLm5hbWUgPSBtZXRhLm5hbWU7XG4gICAgfVxuICAgIHJldHVybiBtZXRhO1xufVxuXG5leHBvcnQgY2xhc3MgTWV0YU1hbmFnZXIge1xuXG4gICAgLy8g6LWE5rqQ5LiOIG1ldGEg55qE5pig5bCE5YiX6KGoXG4gICAgcGF0aDJtZXRhOiB7IFtpbmRleDogc3RyaW5nXTogTWV0YUluZm8gfSA9IHt9O1xuICAgIHByaXZhdGUgY29uc29sZTogQ3VzdG9tQ29uc29sZTtcbiAgICBjb25zdHJ1Y3RvcihjdXN0b21Db25zb2xlOiBDdXN0b21Db25zb2xlKSB7XG4gICAgICAgIHRoaXMuY29uc29sZSA9IGN1c3RvbUNvbnNvbGUgfHwgY29uc29sZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDplIDmr4HkuIDkuKrnrqHnkIblmajlrp7kvotcbiAgICAgKiBAcGFyYW0gbWFuYWdlciBcbiAgICAgKi9cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLnBhdGgybWV0YSA9IHt9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOS7juehrOebmOivu+WPluabtOaWsOS4gOS4qiBtZXRhIOaWh+S7tuaVsOaNruWIsOWGheWtmOmHjFxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqL1xuICAgIHJlYWQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBtZXRhSW5mbzogTWV0YUluZm87XG4gICAgICAgIGxldCBzdHJpbmc6IHN0cmluZztcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHN0cmluZyA9IHJlYWRGaWxlU3luYyhwYXRoLCAndXRmOCcpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhpcy5jb25zb2xlLmRlYnVnKGByZWFkIG1ldGEgZmlsZSBmYWlsZWQ6ICR7cGF0aH1gKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5wYXRoMm1ldGFbcGF0aF0pIHtcbiAgICAgICAgICAgICAgICBtZXRhSW5mbyA9IHRoaXMucGF0aDJtZXRhW3BhdGhdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyDov5nph4znmoQganNvbiDlkI7nu63kvJrloavlhYVcbiAgICAgICAgICAgICAgICBtZXRhSW5mbyA9IHRoaXMucGF0aDJtZXRhW3BhdGhdID0geyBqc29uOiB7fSBhcyBNZXRhLCBiYWNrdXA6ICcnLCBFT0w6ICdcXG4nIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHN0cmluZyk7XG4gICAgICAgICAgICAvLyDlpIfku73ljp/lp4vmlbDmja7vvIzpnIDopoHph43mlrDluo/liJfljJbvvIzljrvmjonpg6jliIbmjaLooYxcbiAgICAgICAgICAgIG1ldGFJbmZvLmJhY2t1cCA9IEpTT04uc3RyaW5naWZ5KGpzb24pO1xuXG4gICAgICAgICAgICAvLyDlpoLmnpzmm7TmlrDnmoQgbWV0YSDkuIrnmoQgdXVpZCDlj5jljJbvvIzliJnpnIDopoHlj5HpgIHotYTmupDlj5jljJbnmoTmtojmga9cbiAgICAgICAgICAgIC8vIOS4jemcgOimgeWkhOeQhlxuICAgICAgICAgICAgLy8gaWYgKG1ldGFJbmZvLmpzb24udXVpZCAmJiBtZXRhSW5mby5qc29uLnV1aWQgIT09IGpzb24udXVpZCkge1xuICAgICAgICAgICAgLy8gfVxuXG4gICAgICAgICAgICBjb3B5TWV0YShtZXRhSW5mby5qc29uLCBqc29uKTtcbiAgICAgICAgICAgIG1ldGFJbmZvLkVPTCA9IHN0cmluZyA/ICgvXFxyXFxuLy50ZXN0KHN0cmluZykgPyAnXFxyXFxuJyA6ICdcXG4nKSA6ICdcXG4nO1xuXG4gICAgICAgICAgICAvLyDlpoLmnpzlpIfku73lrZjlnKjvvIzor7vlj5blkI7lsLHpnIDopoHliKDpmaTkuoZcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLnBhdGgyYmFja3VwW3BhdGhdKSB7XG4gICAgICAgICAgICAvLyAgICAgZGVsZXRlIHRoaXMucGF0aDJiYWNrdXBbcGF0aF07XG4gICAgICAgICAgICAvLyAgICAgdGhpcy5zYXZlKCk7XG4gICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuY29uc29sZS53YXJuKGBSZWFkIG1ldGEgaW4gJHtwYXRofSBmYWlsZWQhYCk7XG4gICAgICAgICAgICB0aGlzLmNvbnNvbGUud2FybihlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5wYXRoMm1ldGFbcGF0aF0pIHtcbiAgICAgICAgICAgIGNvbXBsZXRpb25NZXRhKHRoaXMucGF0aDJtZXRhW3BhdGhdLmpzb24pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgd3JpdGUocGF0aCkge1xuICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5wYXRoMm1ldGFbcGF0aF07XG4gICAgICAgIGlmICghaXRlbSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBkZWxldGUgaXRlbS5qc29uLmRpc3BsYXlOYW1lO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGRlbGV0ZSBpdGVtLmpzb24uaWQ7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZGVsZXRlIGl0ZW0uanNvbi5uYW1lO1xuXG4gICAgICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGl0ZW0uanNvbik7XG4gICAgICAgIGlmIChzdHIgPT09IGl0ZW0uYmFja3VwICYmIGV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dEpTT05TeW5jKHBhdGgsIHRoaXMucGF0aDJtZXRhW3BhdGhdLmpzb24sIHtcbiAgICAgICAgICAgIHNwYWNlczogMixcbiAgICAgICAgICAgIEVPTDogdGhpcy5wYXRoMm1ldGFbcGF0aF0uRU9MLFxuICAgICAgICB9KTtcblxuICAgICAgICBpdGVtLmJhY2t1cCA9IHN0cjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDliKDpmaTlhoXlrZjkuK3nmoTkuIDkuKogTWV0YUluZm8g5pWw5o2uXG4gICAgICog5bm25pS+5YWlIGJhY2t1cCDmlofku7blpLlcbiAgICAgKiBAcGFyYW0gcGF0aCBcbiAgICAgKi9cbiAgICByZW1vdmUocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLnBhdGgybWV0YVtwYXRoXTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJlbW92ZVN5bmMocGF0aCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKHBhdGgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5LuO57yT5a2Y6YeM5Y+W5LiA5LiqIE1ldGFJbmZvXG4gICAgICog5aaC5p6c5LiN5a2Y5Zyo77yM5YiZ5Y+W5aSH5Lu95pWw5o2uXG4gICAgICog5aaC5p6c6L+Y5LiN5a2Y5Zyo77yM5YiZ55Sf5oiQ5paw55qE56m6IE1ldGFJbmZvIOWSjCBtZXRhIOaWh+S7tlxuICAgICAqIEBwYXJhbSBwYXRoIFxuICAgICAqL1xuICAgIGdldChwYXRoOiBzdHJpbmcpOiBNZXRhSW5mbyB7XG4gICAgICAgIC8vIOWmguaenOaVsOaNruWcqOWGheWtmO+8jCDnm7TmjqXov5Tlm55cbiAgICAgICAgaWYgKHRoaXMucGF0aDJtZXRhW3BhdGhdKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXRoMm1ldGFbcGF0aF07XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzmlofku7blrZjlnKjvvIzliJnmm7TmlrDliLDlhoXlrZjph4xcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICAgICAgICAgIHRoaXMucmVhZChwYXRoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnBhdGgybWV0YVtwYXRoXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgybWV0YVtwYXRoXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWmguaenOmDveS4jeWtmOWcqO+8jOafpeivouWkh+S7vei3r+W+hOaYr+WQpuWtmOWcqOaWh+S7tlxuICAgICAgICAvLyBpZiAodGhpcy5wYXRoMmJhY2t1cFtwYXRoXSkge1xuICAgICAgICAvLyAgICAgY29uc3QgYmFja3VwRmlsZSA9IHRoaXMucGF0aDJiYWNrdXBbcGF0aF07XG4gICAgICAgIC8vICAgICBkZWxldGUgdGhpcy5wYXRoMmJhY2t1cFtwYXRoXTtcbiAgICAgICAgLy8gICAgIHRoaXMuc2F2ZSgpO1xuICAgICAgICAvLyAgICAgdHJ5IHtcbiAgICAgICAgLy8gICAgICAgICBtb3ZlU3luYyhiYWNrdXBGaWxlLCBwYXRoKTtcbiAgICAgICAgLy8gICAgICAgICB0aGlzLnJlYWQocGF0aCk7XG4gICAgICAgIC8vICAgICAgICAgaWYgKHRoaXMucGF0aDJtZXRhW3BhdGhdKSB7XG4gICAgICAgIC8vICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgybWV0YVtwYXRoXTtcbiAgICAgICAgLy8gICAgICAgICB9XG4gICAgICAgIC8vICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUud2FybihlcnJvcik7XG4gICAgICAgIC8vICAgICB9XG4gICAgICAgIC8vIH1cblxuICAgICAgICBjb25zdCBqc29uID0gY29tcGxldGlvbk1ldGEoe30pO1xuICAgICAgICB0aGlzLnBhdGgybWV0YVtwYXRoXSA9IHtcbiAgICAgICAgICAgIGpzb24sXG4gICAgICAgICAgICBiYWNrdXA6IEpTT04uc3RyaW5naWZ5KGpzb24pLFxuICAgICAgICAgICAgRU9MOiAnXFxuJyxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLndyaXRlKHBhdGgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnBhdGgybWV0YVtwYXRoXTtcbiAgICB9XG5cbiAgICBtb3ZlKHBhdGhBOiBzdHJpbmcsIHBhdGhCOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMucGF0aDJtZXRhW3BhdGhCXSkge1xuICAgICAgICAgICAgY29uc3QganNvbiA9IHRoaXMucGF0aDJtZXRhW3BhdGhCXS5qc29uO1xuICAgICAgICAgICAgdGhpcy5wYXRoMm1ldGFbcGF0aEJdLmpzb24gPSB0aGlzLnBhdGgybWV0YVtwYXRoQV0uanNvbjtcbiAgICAgICAgICAgIGNvcHlNZXRhKHRoaXMucGF0aDJtZXRhW3BhdGhBXS5qc29uLCBqc29uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucGF0aDJtZXRhW3BhdGhCXSA9IHRoaXMucGF0aDJtZXRhW3BhdGhBXTtcbiAgICAgICAgfVxuICAgICAgICBkZWxldGUgdGhpcy5wYXRoMm1ldGFbcGF0aEFdO1xuICAgIH1cbn0iXX0=