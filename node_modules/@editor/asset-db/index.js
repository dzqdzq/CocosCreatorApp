"use strict";"use stirct";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Utils=exports.AssetDB=exports.VirtualAsset=exports.Asset=exports.Importer=exports.forEach=exports.refresh=exports.reimport=exports.queryUUID=exports.queryPath=exports.queryUrl=exports.queryAsset=exports.get=exports.create=void 0;const asset_db_1=require("./libs/asset-db"),utils_1=require("./libs/utils"),path_1=require("path"),url_1=require("url"),map={};function create(t){const e=new asset_db_1.AssetDB(t);return map[t.name]=e,e}function get(t){return map[t]||null}function queryAsset(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&map[e.host]){const t=map[e.host||""],r=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let s=t.path2asset[r[0]];for(;!s&&r.length>1;)r[0]+="@"+r[1],r.splice(1,1),s=t.path2asset[r[0]];for(let t=1;t<r.length;t++){let e=s.subAssets[r[t]];if(!e)return null;s=e}return s||null}return null}if(path_1.isAbsolute(t)){for(let e in map){const r=t.split("@"),s=map[e];let o=s.path2asset[r[0]];for(;!o&&r.length>1;)r[0]+="@"+r[1],r.splice(1,1),o=s.path2asset[r[0]];if(o){let t=s.path2asset[r[0]];for(let e=1;e<r.length;e++){let s=t.subAssets[r[e]];if(!s)return null;t=s}return t||null}}return null}for(let e in map){const r=map[e].getAsset(t);if(r)return r}return null}function queryUrl(t){if(path_1.isAbsolute(t)){for(let e in map){const r=map[e];if(utils_1.isSubPath(t,r.options.target)){let s=path_1.relative(r.options.target,t);return`db://${e}/${s=s.replace(/\\/g,"/")}`}}return""}const e=t.split("@");for(let t in map){const r=map[t].getAsset(e[0]);if(r){let t=r.url;if(e.length>1)for(let r=1;r<e.length;r++)t+=`@${e[r]}`;return t}}return""}function queryPath(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&map[e.host]){const t=map[e.host||""];return path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")))}return""}const e=t.split("@");for(let t in map){let r=map[t].uuidToPath(e[0]);if(r){if(e.length>1)for(let t=1;t<e.length;t++)r+=`@${e[t]}`;return r}}return""}function queryUUID(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&map[e.host]){const t=map[e.host||""],r=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let s=t.pathToUuid(r[0])||"";for(;!s&&r.length>1;)r[0]+="@"+r[1],r.splice(1,1),s=t.pathToUuid(r[0])||"";if(s&&r.length>1)for(let t=1;t<r.length;t++)s+=`@${r[t]}`;return s}return""}for(let e in map){const r=map[e],s=t.split("@");let o=r.pathToUuid(s[0])||"";for(;!o&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),o=r.pathToUuid(s[0])||"";if(o){if(s.length>1)for(let t=1;t<s.length;t++)o+=`@${s[t]}`;return o}}return""}async function reimport(t){if(path_1.isAbsolute(t))for(let e in map){const r=map[e];if(utils_1.isSubPath(t,r.options.target)){r.path2asset[t]&&await r.reimport(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&map[e.host]){const t=map[e.host||""],r=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));t.path2asset[r]&&await t.reimport(r)}}else for(let e in map){const r=map[e];if(r.getAsset(t)){await r.reimport(t);break}}}async function refresh(t){if(path_1.isAbsolute(t))for(let e in map){const r=map[e];if(utils_1.isSubPath(t,r.options.target)){await r.refresh(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&map[e.host]){const t=map[e.host||""],r=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));await t.refresh(r)}}else for(let e in map){const r=map[e],s=r.getAsset(t);if(s){await r.refresh(s.source);break}}}function forEach(t){Object.keys(map).forEach(e=>{t(map[e])})}exports.create=create,exports.get=get,exports.queryAsset=queryAsset,exports.queryUrl=queryUrl,exports.queryPath=queryPath,exports.queryUUID=queryUUID,exports.reimport=reimport,exports.refresh=refresh,exports.forEach=forEach;var importer_1=require("./libs/importer");Object.defineProperty(exports,"Importer",{enumerable:!0,get:function(){return importer_1.Importer}});var asset_1=require("./libs/asset");Object.defineProperty(exports,"Asset",{enumerable:!0,get:function(){return asset_1.Asset}}),Object.defineProperty(exports,"VirtualAsset",{enumerable:!0,get:function(){return asset_1.VirtualAsset}});var asset_db_2=require("./libs/asset-db");Object.defineProperty(exports,"AssetDB",{enumerable:!0,get:function(){return asset_db_2.AssetDB}}),exports.Utils={nameToId:utils_1.nameToId,isSubPath:utils_1.isSubPath};