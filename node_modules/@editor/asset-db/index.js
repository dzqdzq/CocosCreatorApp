"use strict";"use stirct";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Utils=exports.AssetDB=exports.VirtualAsset=exports.Asset=exports.Importer=exports.setDefaultUserData=exports.forEach=exports.refresh=exports.reimport=exports.queryUUID=exports.queryPath=exports.queryUrl=exports.queryAsset=exports.get=exports.create=void 0;const asset_db_1=require("./libs/asset-db"),utils_1=require("./libs/utils"),path_1=require("path"),url_1=require("url");function create(t){return new asset_db_1.AssetDB(t)}function get(t){return asset_db_1.map[t]||null}function queryAsset(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&asset_db_1.map[e.host]){const t=asset_db_1.map[e.host||""],s=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let r=t.path2asset[s[0]];for(;!r&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),r=t.path2asset[s[0]];for(let t=1;t<s.length;t++){let e=r.subAssets[s[t]];if(!e)return null;r=e}return r||null}return null}if(path_1.isAbsolute(t)){for(let e in asset_db_1.map){const s=t.split("@"),r=asset_db_1.map[e];let a=r.path2asset[s[0]];for(;!a&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),a=r.path2asset[s[0]];if(a){let t=r.path2asset[s[0]];for(let e=1;e<s.length;e++){let r=t.subAssets[s[e]];if(!r)return null;t=r}return t||null}}return null}for(let e in asset_db_1.map){const s=asset_db_1.map[e].getAsset(t);if(s)return s}return null}function queryUrl(t){if(path_1.isAbsolute(t)){for(let e in asset_db_1.map){const s=asset_db_1.map[e];if(utils_1.isSubPath(t,s.options.target)){let r=path_1.relative(s.options.target,t);return`db://${e}/${r=r.replace(/\\/g,"/")}`}}return""}const e=t.split("@");for(let t in asset_db_1.map){const s=asset_db_1.map[t].getAsset(e[0]);if(s){let t=s.url;if(e.length>1)for(let s=1;s<e.length;s++)t+=`@${e[s]}`;return t}}return""}function queryPath(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&asset_db_1.map[e.host]){const t=asset_db_1.map[e.host||""];return path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")))}return""}const e=t.split("@");for(let t in asset_db_1.map){let s=asset_db_1.map[t].uuidToPath(e[0]);if(s){if(e.length>1)for(let t=1;t<e.length;t++)s+=`@${e[t]}`;return s}}return""}function queryUUID(t){if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&asset_db_1.map[e.host]){const t=asset_db_1.map[e.host||""],s=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||""))).split("@");let r=t.pathToUuid(s[0])||"";for(;!r&&s.length>1;)s[0]+="@"+s[1],s.splice(1,1),r=t.pathToUuid(s[0])||"";if(r&&s.length>1)for(let t=1;t<s.length;t++)r+=`@${s[t]}`;return r}return""}for(let e in asset_db_1.map){const s=asset_db_1.map[e],r=t.split("@");let a=s.pathToUuid(r[0])||"";for(;!a&&r.length>1;)r[0]+="@"+r[1],r.splice(1,1),a=s.pathToUuid(r[0])||"";if(a){if(r.length>1)for(let t=1;t<r.length;t++)a+=`@${r[t]}`;return a}}return""}async function reimport(t){if(path_1.isAbsolute(t))for(let e in asset_db_1.map){const s=asset_db_1.map[e];if(utils_1.isSubPath(t,s.options.target)){s.path2asset[t]&&await s.reimport(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&asset_db_1.map[e.host]){const t=asset_db_1.map[e.host||""],s=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));t.path2asset[s]&&await t.reimport(s)}}else for(let e in asset_db_1.map){const s=asset_db_1.map[e];if(s.getAsset(t)){await s.reimport(t);break}}}async function refresh(t){if(path_1.isAbsolute(t))for(let e in asset_db_1.map){const s=asset_db_1.map[e];if(utils_1.isSubPath(t,s.options.target)){await s.refresh(t);break}}else if(t.startsWith("db://")){t=encodeURI(t);const e=url_1.parse(t);if(e.host&&asset_db_1.map[e.host]){const t=asset_db_1.map[e.host||""],s=path_1.join(t.options.target,decodeURIComponent((e.path||"")+(e.hash||"")));await t.refresh(s)}}else for(let e in asset_db_1.map){const s=asset_db_1.map[e],r=s.getAsset(t);if(r){await s.refresh(r.source);break}}}function forEach(t){Object.keys(asset_db_1.map).forEach(e=>{t(asset_db_1.map[e])})}exports.create=create,exports.get=get,exports.queryAsset=queryAsset,exports.queryUrl=queryUrl,exports.queryPath=queryPath,exports.queryUUID=queryUUID,exports.reimport=reimport,exports.refresh=refresh,exports.forEach=forEach;var default_meta_1=require("./libs/default-meta");Object.defineProperty(exports,"setDefaultUserData",{enumerable:!0,get:function(){return default_meta_1.setDefaultUserData}});var importer_1=require("./libs/importer");Object.defineProperty(exports,"Importer",{enumerable:!0,get:function(){return importer_1.Importer}});var asset_1=require("./libs/asset");Object.defineProperty(exports,"Asset",{enumerable:!0,get:function(){return asset_1.Asset}}),Object.defineProperty(exports,"VirtualAsset",{enumerable:!0,get:function(){return asset_1.VirtualAsset}});var asset_db_2=require("./libs/asset-db");Object.defineProperty(exports,"AssetDB",{enumerable:!0,get:function(){return asset_db_2.AssetDB}}),exports.Utils={nameToId:utils_1.nameToId,isSubPath:utils_1.isSubPath};