import { systemJSPrototype } from '../systemjs-source/src/system-core';
import { resolveImportMap, resolveIfNotPlainOrUrl, resolveAndComposeImportMap } from '../systemjs-source/src/common';
import { patchedBaseUrl } from './set-base-url';

const emptyImportMap = { imports: {}, scopes: {} };

let importMap = { imports: {}, scopes: {} };

export function setImportMap (json, location) {
    importMap = resolveAndComposeImportMap(json, location || patchedBaseUrl, emptyImportMap);
};

systemJSPrototype.resolve = function (id, parentUrl) {
    parentUrl = parentUrl || patchedBaseUrl;
    return resolveImportMap(importMap, resolveIfNotPlainOrUrl(id, parentUrl) || id, parentUrl) || throwUnresolved(id, parentUrl);
}

function throwUnresolved (id, parentUrl) {
    throw Error("Unable to resolve specifier '" + id + (parentUrl ? "' from " + parentUrl : "'"));
}