'use stirct';

const { basename } = require('path');
const { EventEmitter } = require('events');
const vStacks = require('v-stacks');

const ipc = require('@base/electron-base-ipc');
const logger = require('@base/electron-logger');

const pkg = require('../package.json');
const ipcFlag = `${pkg.name}@${pkg.version}`;

const $files = document.getElementById('files');

// 初始化 worker 一些参数
ipc.on(`${ipcFlag}:init`, (event, info) => {
    // 进程名字
    window.__name__ = info.name;

    // 初始化 logger 信息
    logger.setLevel(2);
    logger.setLogHandler((item) => {
        item.message = `[${__name__}] ${item.message}`;
        if (
            (item.type === 'warn' || item.type === 'error') &&
            item.stack.length === 0
        ) {
            // TODO 此处应由 vStacks.encode 实现
            const error = new Error(item.message);
            const logName = item.type[0].toLocaleUpperCase() + item.type.slice(1);
            error.stack = error.stack.replace(new RegExp('^' + error.name), logName);
            error.name = logName;
            item.stack = vStacks.ignoreStack(error.stack, 3);
        }
    });

    // 显示到界面上
    document.getElementById('name').innerHTML = info.name;

    // 更改进程窗口的标题
    document.title = `Worker - ${info.name}`;

    // 更改进程名字
    process.title = process.title.replace('(Renderer)', `(${info.name})`);

    // 加载需要使用的文件
    info.files.forEach((file) => {
        require(file);
        const $div = document.createElement('div');
        $div.setAttribute('title', file);
        $div.innerHTML = basename(file);
        $files.appendChild($div);
    });
});

// 加载文件
ipc.on(`${ipcFlag}:require`, (event, file) => {
    require(file);
    const $div = document.createElement('div');
    $div.setAttribute('title', file);
    $div.innerHTML = basename(file);
    $files.appendChild($div);
});


class Ipc extends EventEmitter {

    send(message, ...args) {
        return ipc.send(`${ipcFlag}:message`, window.__name__, message, args);
    }
}

window.Worker = {
    Ipc: new Ipc(),
    log: console.log.bind(console),
};

// 主进程发送的消息
ipc.on(`${ipcFlag}:message`, (event, message, args) => {
    // 如果没有监听事件，直接返回
    const count = window.Worker.Ipc.listenerCount(message);
    if (0 === count) {
        event.reply(new Error(`The message '${message}' is not registered with the '${window.__name__}' worker`));
        return;
    }
    window.Worker.Ipc.emit(message, event, ...args);
});

// require 指定文件
ipc.on(`${ipcFlag}:require`, (event, file) => {
    require(file);
});