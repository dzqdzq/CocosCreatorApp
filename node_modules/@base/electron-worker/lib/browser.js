"use strict";const ipc=require("@base/electron-base-ipc"),{EventEmitter:EventEmitter}=require("events"),{BrowserWindow:BrowserWindow}=require("electron"),{join:join}=require("path"),vStacks=require("v-stacks"),{enable:enable}=require("@electron/remote/main"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`,name2worker={};class Worker extends EventEmitter{get isReady(){return!!this.win}constructor(e){super(),this.name=e,this.files=[],this.ipc=new EventEmitter}async init(e){return this.win=new BrowserWindow({width:300,height:300,show:!1,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!0,nodeIntegrationInWorker:!0,contextIsolation:!1,preload:e.preload,enableRemoteModule:!0}}),enable(this.win.webContents),new Promise((e,n)=>{this.win.webContents.on("dom-ready",()=>{ipc.sendToWin(this.win,`${ipcFlag}:init`,{name:this.name,files:this.files}),e()});const i="file://"+join(__dirname,"../static/worker.html"),t=encodeURI(i).replace(/[!'()#\?*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)}).replace(/%5C/gi,"/");this.win.loadURL(t),this.win.webContents.on("did-start-loading",()=>{this.emit("refresh")}),this.win.webContents.on("render-process-gone",(e,n)=>{this.emit("render-process-gone",e,n)}),this.win.webContents.on("crashed",(e,n)=>{this.emit("crashed",-1)}),this.win.on("close",e=>{this._allowClose||(e.preventDefault(),this.win.hide())}),this.win.on("closed",()=>{this.win=null,this.emit("closed")})})}debug(e){e?(this.win.show(),this.win.openDevTools()):(this.win.hide(),this.win.closeDevTools())}async close(e=!1){let n=!1;const i=this.listeners("before-close");for(const e of i){!1===await e()&&(n=!0)}return!(!e&&n||!this.win)&&(this._allowClose=!0,this.win.close(),!0)}send(e,...n){return new Promise((i,t)=>{ipc.sendToWin(this.win,`${ipcFlag}:message`,e,n).callback((e,n)=>{if(e)return t(e);i(n)})})}require(e){this.files.push(e),ipc.sendToWin(this.win,`${ipcFlag}:require`,e)}}class Manager{create(e){return name2worker[e]=new Worker(e)}close(e,n=!1){let i=name2worker[e];delete name2worker[e],i&&i.close(n)}clear(e=!1){for(const n in name2worker)this.close(n,e)}query(e){return name2worker[e]||null}queryAll(){let e=[];for(const n in name2worker){const i=name2worker[n];i&&e.push(i)}return e}async forEach(e){for(let n in name2worker)await e(name2worker[n])}}module.exports=new Manager,ipc.on(`${ipcFlag}:message`,(e,n,i,t)=>{let r=module.exports.query(n);r&&r.ipc.emit(i,e,...t)});