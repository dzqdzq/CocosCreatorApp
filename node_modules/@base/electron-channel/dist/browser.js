"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.query=exports.clear=exports.unregister=exports.register=void 0;const electron_1=require("electron"),pkg=require("../package.json"),ipcFlag="".concat(pkg.name,"@").concat(pkg.version);let map={};function register(e){map[e]=map[e]||[],map[e].push(-1)}function unregister(e){let n=map[e];if(!n)return;let t=n.indexOf(-1);t>=0&&n.splice(t,1),0===n.length&&delete map[e],electron_1.BrowserWindow.getAllWindows().forEach(function(e){e.isDestroyed()||e.webContents.send("".concat(ipcFlag,":delete"),name,-1)})}function clear(e){delete map[e],electron_1.BrowserWindow.getAllWindows().forEach(function(e){e.isDestroyed()||e.webContents.send("".concat(ipcFlag,":clear"),name)})}function query(e){return map[e]||null}exports.register=register,exports.unregister=unregister,exports.clear=clear,exports.query=query;let listenerMap={},winBindSet=new Set,senderBindSet=new Set;electron_1.ipcMain.on("".concat(ipcFlag,":register"),function(e,n){let t=e.sender.id;if(map[n]=map[n]||[],map[n].push(t),listenerMap[t])return;listenerMap[t]=listenerMap[t]||[],listenerMap[t].push(n),senderBindSet.has(e.sender)||(senderBindSet.add(e.sender),e.sender.once("destroyed",function(){senderBindSet.delete(e.sender);let n=listenerMap[t];n.forEach(function(n){if(electron_1.ipcMain.emit("".concat(ipcFlag,":unregister"),e,n),map[n])for(let e=0;e<map[n].length;e++)map[n][e]===t&&map[n].splice(e--,1)}),n.length=0}));let r=electron_1.BrowserWindow.fromWebContents(e.sender);r&&!winBindSet.has(r)&&(winBindSet.add(r),r.once("closed",function(){winBindSet.delete(r);let n=listenerMap[t];n.forEach(function(n){if(electron_1.ipcMain.emit("".concat(ipcFlag,":unregister"),e,n),map[n])for(let e=0;e<map[n].length;e++)map[n][e]===t&&map[n].splice(e--,1)}),n.length=0}))}),electron_1.ipcMain.on("".concat(ipcFlag,":unregister"),function(e,n){let t=map[n];if(!t)return;let r=t.indexOf(e.sender.id);r>=0&&t.splice(r,1),0===t.length&&delete map[n],electron_1.BrowserWindow.getAllWindows().forEach(function(t){t.isDestroyed()||t.webContents.isDestroyed()||t.webContents.send("".concat(ipcFlag,":delete"),n,e.sender.id)})}),electron_1.ipcMain.on("".concat(ipcFlag,":clear"),function(e,n){delete map[n]}),electron_1.ipcMain.on("".concat(ipcFlag,":query"),function(e,n){e.returnValue=query(n)});