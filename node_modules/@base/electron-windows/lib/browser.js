"use strict";const ipc=require("@base/electron-base-ipc"),uuidV4=require("uuid/v4"),{EventEmitter:EventEmitter}=require("events"),{app:app,BrowserWindow:BrowserWindow,shell:shell}=require("electron"),{join:join,isAbsolute:isAbsolute,normalize:normalize}=require("path"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;function awaitAppReady(){if(!app.isReady())return new Promise(e=>{app.once("ready",e)})}class WindowManager extends EventEmitter{constructor(){super(),this._waitClosedWindows=Object.create(null),this._waitClosedMain=!1,this._allowClosedMain=!1,this.uuids=[],this.uuid2win=Object.create(null),this.uuid2info=Object.create(null),this._focusWindow=null}focus(e){const i=this.uuid2win[e];i&&i.focus()}_close(e){return new Promise(i=>{this._waitClosedWindows[e]=function(e){i(e)};let t=this.uuid2win[e],s=this.uuid2info[e];t&&!t.isDestroyed()?(s.options.fullscreen=t.isFullScreen(),t.close()):i()})}async _closedOthers(){let e=!0;for(let i=this.uuids.length-1;i>0;i--){const t=this.uuids[i];await this._close(t)||(e=!1)}return!1===e&&(this.uuids=this.uuids.filter(e=>{let i=this.uuid2win[e];return!(!i||i.isDestroyed())||(delete this.uuid2win[e],delete this.uuid2info[e],!1)})),e}async open(e,i,t,s={}){await awaitAppReady(),/^file\:\//.test(e)&&(e=e.substr(6)),isAbsolute(e)||(e=join(process.cwd(),e)),i=i||{},t=t||{};let n=uuidV4();i.show=!1;for(let e in i)e in s||(s[e]=i[e]);if(void 0!==s.x&&void 0!==s.y){let e=require("electron").screen,i=e.getAllDisplays(),t=!1;for(let e=0;e<i.length;e++){const n=i[e];if(n.bounds.x<=s.x&&n.bounds.x+n.bounds.width>=s.x&&n.bounds.y<=s.y&&n.bounds.y+n.bounds.height>=s.y){t=!0;break}}if(!t){let i=e.getPrimaryDisplay().bounds;s.x=i.x,s.y=i.y,s.width>i.width&&(s.width=i.width),s.height>i.height&&(s.height=i.height)}}let o=new BrowserWindow(s);o.webContents.on("will-navigate",(i,t)=>{t=(t=t.replace(/^file\:\/+/,"")).replace(/#.*/,""),t=normalize(t),"darwin"===process.platform&&(t=`/${t}`),e!==t&&(i.preventDefault(),shell.openExternal(t))}),!1===i.menuBarVisibility&&(o.setAutoHideMenuBar(!1),o.setMenuBarVisibility(!1));let u={uuid:n,url:e,userData:t,options:JSON.parse(JSON.stringify(i)),bounds:o.getBounds()};this.uuid2win[n]=o,this.uuid2info[n]=u,this.uuids.push(n);let r=null,a=()=>{null===r&&(r=setTimeout(()=>{r=null,o&&!o.isDestroyed()&&(u.bounds=o.getBounds(),this.emit("change"))},500))};o.on("move",()=>{a()}),o.on("resize",()=>{a()}),o.on("close",async e=>{if(0===this.uuids.indexOf(n))return this._allowClosedMain?void o.send(`${ipcFlag}:close`):(this._waitClosedMain=!0,e.preventDefault(),this._allowClosedMain=await this._closedOthers(),this._allowClosedMain?o.close():this._waitClosedMain=!1,void this.emit("change"));o.send(`${ipcFlag}:close`)});const l=()=>{let e=this.uuids.indexOf(n);if(this._waitClosedMain){if(0===e)try{this.emit("clear")}catch(e){console.error(e)}}else if(0!==e){delete this.uuid2info[n],delete this.uuid2win[n],-1!==e&&this.uuids.splice(e,1);try{this.emit("change")}catch(e){console.error(e)}}else try{this.emit("change")}catch(e){console.error(e)}};return o.on("destroy",l),o.on("closed",l),this.emit("change"),o.on("focus",()=>{null===this._focusWindow?(this._focusWindow=o,this.emit("focus")):this._focusWindow=o}),o.on("blur",()=>{setImmediate(()=>{this._focusWindow===o&&(this._focusWindow=null,this.emit("blur"))})}),new Promise(i=>{const t=encodeURI(e).replace(/[!'()#\?*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)}).replace(/%5C/gi,"/");o.loadURL(`file://${t}#${n}`);let s=!1;setTimeout(()=>{s||(s=!0,o.show(),i(n))},2e3),o.once("dom-ready",()=>{setTimeout(()=>{s||(s=!0,o.show(),i(n))},100)})})}async restore(e){await awaitAppReady();let i=e.windows;const t=[];for(let e=0;e<i.length;e++){let s=i[e];const n=await this.open(s.url,s.options,s.userData,{x:s.bounds.x,y:s.bounds.y,width:s.bounds.width,height:s.bounds.height});t.push(n)}return t}dump(){return{version:1,windows:this.uuids.map(e=>{return this.uuid2info[e]})}}async quit(){await this._close(this.uuids[0])}}let manager=module.exports=new WindowManager;ipc.on(`${ipcFlag}:query-user-data`,(e,i)=>{let t=manager.uuid2info[i];return t&&t.userData||{}}),ipc.on(`${ipcFlag}:sync-user-date`,(e,i,t)=>{let s=manager.uuid2info[i];s&&JSON.stringify(s.userData)!==JSON.stringify(t)&&(s.userData=t,manager.emit("change"))}),ipc.on(`${ipcFlag}:sync-closed`,(e,i,t)=>{let s=manager._waitClosedWindows[i];s&&s.call(manager,t)}),ipc.on(`${ipcFlag}:ask-win`,e=>{let i=BrowserWindow.fromWebContents(e.sender),t=manager.uuids.some(e=>i===manager.uuid2win[e]);e.reply(null,t)}),ipc.on(`${ipcFlag}:set-min-size`,(e,i,t)=>{i=Math.round(i),t=Math.round(t);let s=BrowserWindow.fromWebContents(e.sender);if(!s||s.isDestroyed())return;let n=s.getSize(),o=s.getContentSize();(i>o[0]||t>o[1])&&s.setContentSize(Math.max(o[0],i),Math.max(o[1],t));let u=s.getMinimumSize();t+=n[1]-o[1],u[0]===i&&u[1]===t||s.setMinimumSize(i,t)});