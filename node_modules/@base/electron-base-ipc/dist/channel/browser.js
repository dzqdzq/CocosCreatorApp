"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.channelBrowser=void 0;const electron_1=require("electron"),channel_manager_1=require("./channel-manager"),const_1=require("../const"),base_1=require("./base");let CHANNEL_IDX=100;const CHANNEL_SETUP_TIMEOUT=3e4;class ChannelBrowser extends base_1.ChannelBase{constructor(){super(),this.channelManager=new channel_manager_1.ChannelManager,this.setupList={}}init(){this.registerEvent()}async sendToChannel(e,n,r){const s=electron_1.webContents.fromId(e);if(!s)throw new Error(`channel ${e} not found`);const t=electron_1.BrowserWindow.fromWebContents(s);if(!t)throw new Error(`window ${e} not found`);t.webContents.send(n,r)}async setupChannel(e,n,r){return new Promise((s,t)=>{const o={id:CHANNEL_IDX++,key:channel_manager_1.SETUP_CHANNEL_STR,sourceWinId:e.id,destWinId:r};this.setupList[o.id]={id:o.id,resolve:s,reject:t},n.postMessage(o),e.postMessage("port",null,[n]),e.once("destroyed",()=>{exports.channelBrowser.channelManager.deleteRelated(e.id)})})}registerEvent(){electron_1.ipcMain.handle(`${const_1.ipcFlag}:setup-channel`,async(e,n)=>{const r=e.sender,s=electron_1.webContents.fromId(n);if(!r||!s)return!1;const{port1:t,port2:o}=new electron_1.MessageChannelMain,i=await Promise.all([this.setupChannel(r,t,s.id),this.setupChannel(s,o,r.id)]);return i.includes(!1)?console.error("setup channel error",i):(this.channelManager.push({wins:[r.id,s.id],ports:[t,o]}),!0)}),electron_1.ipcMain.on(`${const_1.ipcFlag}:query-cur-window-id`,e=>{e.returnValue=e.sender.id}),electron_1.ipcMain.handle(`${const_1.ipcFlag}:setup-channel-finish`,(e,n)=>{this.setupList[n.id]?(this.setupList[n.id].resolve(!0),delete this.setupList[n.id]):console.error("setup channel finish error",n)})}}exports.channelBrowser=new ChannelBrowser;