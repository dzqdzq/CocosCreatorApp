"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.channelRenderer=void 0;const const_1=require("../const"),electron_1=require("electron"),channel_manager_1=require("./channel-manager"),const_2=require("../const"),base_1=require("./base"),event_1=require("../event"),utils_1=require("../utils"),sender_1=require("../sender");class ChannelRenderer extends base_1.ChannelBase{constructor(){super(),this.channelMap={},this.curWindowId=-1}init(){this.queryCurWebContentsId(),this.registerEvent()}queryCurWebContentsId(){return-1!==this.curWindowId?this.curWindowId:(this.curWindowId=electron_1.ipcRenderer.sendSync(`${const_2.ipcFlag}:query-cur-window-id`),this.curWindowId)}async setupChannel(e){return new Promise(async(n,r)=>{try{if(!await electron_1.ipcRenderer.invoke(`${const_2.ipcFlag}:setup-channel`,e))return console.error("setup channel fail for target",e),r("setup channel fail");n(this.getChannelPort(e))}catch(n){console.error("setupChannel invoke fail for target",e),r(n)}})}async sendToChannel(e,n,r){if(e===this.curWindowId)return console.warn("send to cur web contents!"),this.handleEvent(new MessagePort,{message:n,options:r});let t=this.getChannelPort(e);t||(t=await this.setupChannel(e)),t.postMessage({message:n,options:r})}setupChannelMessage(e){e.onmessage=(n=>{const r=n.data;"object"==typeof r?r.type&&r.type===`${const_2.ipcFlag}:send-reply`?this.handleReply(e,r):this.handleEvent(e,r):console.warn("receive message",r)})}handleReply(e,n){const r=sender_1.MainSender.query(n.cid);if(r){if(clearTimeout(r._timer),r._callback){const e=r.options.original?n.params:(0,utils_1.decodeArgs)(n.params);r._callback((0,event_1.deserializeError)(n.error),...e)}sender_1.MainSender.remove(n.cid)}else n.error&&console.warn(n.error)}handleEvent(e,n){const r=n.options,t=new event_1.MessageEvent("renderer");r.needCallback&&(t.needCallback=!0,t.reply=function(n,...t){!n||n instanceof Error||console.warn(`${r.message} - The first parameter of event.reply must be 'Error'`);const s=r.original?t:(0,utils_1.encodeArgs)(t);e.postMessage({type:`${const_2.ipcFlag}:send-reply`,cid:r.cid,error:(0,event_1.serializeError)(n),params:s})}),const_1.eventBus.emit(r.message,t,...r.arguments)}getChannelPort(e){const n=this.getChannelKey(e);return this.channelMap[n]}getChannelKey(e){return this.queryCurWebContentsId()+"_"+e}registerEvent(){electron_1.ipcRenderer.on("port",async e=>{const[n]=e.ports;n.onmessage=(e=>{"object"==typeof e.data&&e.data.key===channel_manager_1.SETUP_CHANNEL_STR&&(this.channelMap[this.getChannelKey(e.data.sourceWinId)]=n,electron_1.ipcRenderer.invoke(`${const_2.ipcFlag}:setup-channel-finish`,e.data),this.setupChannelMessage(n))})})}}exports.channelRenderer=new ChannelRenderer;