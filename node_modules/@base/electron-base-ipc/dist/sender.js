"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WindowIDSender=exports.WindowSender=exports.EventSender=exports.MainSender=void 0;const electron_1=require("electron"),index_1=require("./channel/index"),const_1=require("./const"),_id2sender=Object.create(null);let _senderID=0;class Sender{static query(e){return _id2sender[e]}static remove(e){delete _id2sender[e]}constructor(e){this.id=_senderID++,e.cid=this.id,this.options=e}promise(){let e;return this.options.needCallback=!0,_id2sender[this.id]=this,this._callback=function(t,i){e={error:t,data:i}},new Promise((t,i)=>{if(e)return e.error?i(e.error):t(e.data);this._callback=function(e,s){return e?i(e):t(s)}})}callback(e){return"function"!=typeof e?this:(this.options.needCallback=!0,_id2sender[this.id]=this,this._callback=e,this)}timeout(e){return clearTimeout(this._timer),"number"!=typeof e||e<0?this:(this._timer=setTimeout(()=>{this._timer=setTimeout(()=>{this._callback&&this._callback(new Error("Message timeout")),delete _id2sender[this.id]},0)},e),this)}option(e){return this.options.original=e.original,this}immediately(){}}class MainSender extends Sender{constructor(e){super(e),this._send=!1,setImmediate(()=>{this.immediately()})}immediately(){if(!this._send){this._send=!0;try{electron_1.ipcRenderer.send(`${const_1.ipcFlag}:send`,this.options)}catch(e){electron_1.ipcRenderer.emit(`${const_1.ipcFlag}:send-reply`,null,this.options.cid,e,"[]")}}}}exports.MainSender=MainSender;class EventSender extends Sender{constructor(e,t){super(t),this._send=!1,this._events=e,setImmediate(()=>{this.immediately()})}immediately(){if(this._send)return;this._send=!0;let e=this._callback;const t={senderType:process.type,needCallback:this.options.needCallback,reply(...t){e&&e(...t),e=void 0}};EventSender.remove(this.id),this._events.forEach(e=>{e(t,...this.options.arguments)})}}exports.EventSender=EventSender;class WindowSender extends Sender{constructor(e,t){super(t),this._send=!1,this._win=e,setImmediate(()=>{this.immediately()})}immediately(){if(!this._send){this._send=!0;try{this._win.send(`${const_1.ipcFlag}:send`,this.options)}catch(e){electron_1.ipcMain.emit(`${const_1.ipcFlag}:send-reply`,null,this.options.cid,e,"[]")}}}}exports.WindowSender=WindowSender;class WindowIDSender extends Sender{constructor(e,t){super(t),this._send=!1,this._id=e,setImmediate(()=>{this.immediately()})}immediately(){this._send||(this._send=!0,-1===this._id?electron_1.ipcRenderer.send(`${const_1.ipcFlag}:send`,this.options):electron_1.ipcRenderer.sendTo?electron_1.ipcRenderer.sendTo(this._id,`${const_1.ipcFlag}:send`,this.options):index_1.channel.sendToChannel(this._id,`${const_1.ipcFlag}:send`,this.options))}}exports.WindowIDSender=WindowIDSender;