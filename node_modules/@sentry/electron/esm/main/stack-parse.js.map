{"version":3,"file":"stack-parse.js","sources":["../../src/main/stack-parse.ts"],"sourcesContent":["import { createStackParser, logger, nodeStackLineParser, StackFrame, StackParser } from '@sentry/core';\nimport { createGetModuleFromFilename } from '@sentry/node';\nimport { app, WebContents, WebFrameMain } from 'electron';\n\nimport { electronRendererStackParser } from '../renderer/stack-parse';\nimport { ELECTRON_MAJOR_VERSION } from './electron-normalize';\n\n// node.js stack parser but filename normalized before parsing the module\nexport const defaultStackParser: StackParser = createStackParser(\n  nodeStackLineParser(createGetModuleFromFilename(app.getAppPath())),\n);\n\ntype ElectronV34Frame = WebFrameMain & {\n  collectJavaScriptCallStack(): Promise<string> | Promise<void>;\n};\n\n/**\n * Captures stack frames from a renderer process\n *\n * Requires Electron >= 34 and throws an error on older versions\n *\n * @param webContents The WebContents to capture stack frames from\n * @returns A promise that resolves to an array of Sentry StackFrames\n */\nexport async function captureRendererStackFrames(webContents: WebContents): Promise<StackFrame[] | undefined> {\n  if (ELECTRON_MAJOR_VERSION < 34) {\n    throw new Error('Electron >= 34 required to capture stack frames via `frame.collectJavaScriptCallStack()`');\n  }\n\n  const frame = webContents.mainFrame as ElectronV34Frame;\n\n  const stack = await frame.collectJavaScriptCallStack();\n  if (!stack) {\n    return undefined;\n  }\n\n  if (stack.includes('Website owner has not opted in')) {\n    logger.warn(\n      \"Could not collect renderer stack frames.\\nA 'Document-Policy' header of 'include-js-call-stacks-in-crash-reports' must be set\",\n    );\n    return undefined;\n  }\n\n  return electronRendererStackParser(stack);\n}\n"],"names":[],"mappings":";;;;;;AAOA;AACa,MAAA,kBAAkB,GAAgB,iBAAiB,CAC9D,mBAAmB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC,CAAC;AAOpE;;;;;;;AAOG;AACI,eAAe,0BAA0B,CAAC,WAAwB,EAAA;IACvE,IAAI,sBAAsB,GAAG,EAAE,EAAE;AAC/B,QAAA,MAAM,IAAI,KAAK,CAAC,0FAA0F,CAAC;AAC5G;AAED,IAAA,MAAM,KAAK,GAAG,WAAW,CAAC,SAA6B;AAEvD,IAAA,MAAM,KAAK,GAAG,MAAM,KAAK,CAAC,0BAA0B,EAAE;IACtD,IAAI,CAAC,KAAK,EAAE;AACV,QAAA,OAAO,SAAS;AACjB;AAED,IAAA,IAAI,KAAK,CAAC,QAAQ,CAAC,gCAAgC,CAAC,EAAE;AACpD,QAAA,MAAM,CAAC,IAAI,CACT,+HAA+H,CAChI;AACD,QAAA,OAAO,SAAS;AACjB;AAED,IAAA,OAAO,2BAA2B,CAAC,KAAK,CAAC;AAC3C;;;;"}