{"version":3,"file":"electron-normalize.js","sources":["../../src/main/electron-normalize.ts"],"sourcesContent":["import { parseSemver } from '@sentry/core';\nimport { app, Session } from 'electron';\nimport { join } from 'path';\n\nimport { RENDERER_ID_HEADER } from '../common/ipc';\n\nconst parsed = parseSemver(process.versions.electron);\nconst version = { major: parsed.major || 0, minor: parsed.minor || 0, patch: parsed.patch || 0 };\n\nexport const ELECTRON_MAJOR_VERSION = version.major;\n\nexport const EXIT_REASONS = [\n  'clean-exit',\n  'abnormal-exit',\n  'killed',\n  'crashed',\n  'oom',\n  'launch-failed',\n  'integrity-failure',\n] as const;\nexport type ExitReason = (typeof EXIT_REASONS)[number];\nexport const CRASH_REASONS: Readonly<ExitReason[]> = ['crashed', 'oom'] as const;\n\n/** Gets the Sentry Cache path */\nexport function getSentryCachePath(): string {\n  return join(app.getPath('userData'), 'sentry');\n}\n\n/**\n * Electron >= 25 support `protocol.handle`\n */\nfunction supportsProtocolHandle(): boolean {\n  return version.major >= 25;\n}\n\ninterface InternalRequest {\n  windowId?: string;\n  url: string;\n  body?: Buffer;\n}\n\n/**\n * Registers a custom protocol to receive events from the renderer\n *\n * Uses `protocol.handle` if available, otherwise falls back to `protocol.registerStringProtocol`\n */\nexport function registerProtocol(\n  protocol: Electron.Protocol,\n  scheme: string,\n  callback: (request: InternalRequest) => void,\n): void {\n  if (supportsProtocolHandle()) {\n    protocol.handle(scheme, async (request) => {\n      callback({\n        windowId: request.headers.get(RENDERER_ID_HEADER) || undefined,\n        url: request.url,\n        body: Buffer.from(await request.arrayBuffer()),\n      });\n\n      return new Response('');\n    });\n  } else {\n    // eslint-disable-next-line deprecation/deprecation\n    protocol.registerStringProtocol(scheme, (request, complete) => {\n      callback({\n        windowId: request.headers[RENDERER_ID_HEADER],\n        url: request.url,\n        body: request.uploadData?.[0]?.bytes,\n      });\n\n      complete('');\n    });\n  }\n}\n\ntype PreloadScriptRegistration = {\n  // Context type where the preload script will be executed.\n  type: 'frame' | 'service-worker';\n  // Unique ID of preload script. Defaults to a random UUID.\n  id?: string;\n  // Path of the script file. Must be an absolute path.\n  filePath: string;\n};\n\ntype SessionMaybeSupportingRegisterPreloadScript = Session & {\n  registerPreloadScript?: (script: PreloadScriptRegistration) => void;\n};\n\n/**\n * Adds a preload script to the session.\n *\n * Electron >= v35 supports new `registerPreloadScript` method and `getPreloads` and `setPreloads` are deprecated.\n */\nexport function setPreload(sesh: SessionMaybeSupportingRegisterPreloadScript, path: string): void {\n  if (sesh.registerPreloadScript) {\n    sesh.registerPreloadScript({ type: 'frame', filePath: path });\n  } else {\n    const existing = sesh.getPreloads();\n    sesh.setPreloads([path, ...existing]);\n  }\n}\n"],"names":[],"mappings":";;;;;AAMA,MAAM,MAAM,GAAG,WAAW,CAAC,OAAO,CAAC,QAAQ,CAAC,QAAQ,CAAC;AACrD,MAAM,OAAO,GAAG,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,CAAC,EAAE;AAEnF,MAAA,sBAAsB,GAAG,OAAO,CAAC;AAEjC,MAAA,YAAY,GAAG;IAC1B,YAAY;IACZ,eAAe;IACf,QAAQ;IACR,SAAS;IACT,KAAK;IACL,eAAe;IACf,mBAAmB;;MAGR,aAAa,GAA2B,CAAC,SAAS,EAAE,KAAK;AAEtE;SACgB,kBAAkB,GAAA;IAChC,OAAO,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,QAAQ,CAAC;AAChD;AAEA;;AAEG;AACH,SAAS,sBAAsB,GAAA;AAC7B,IAAA,OAAO,OAAO,CAAC,KAAK,IAAI,EAAE;AAC5B;AAQA;;;;AAIG;SACa,gBAAgB,CAC9B,QAA2B,EAC3B,MAAc,EACd,QAA4C,EAAA;IAE5C,IAAI,sBAAsB,EAAE,EAAE;QAC5B,QAAQ,CAAC,MAAM,CAAC,MAAM,EAAE,OAAO,OAAO,KAAI;AACxC,YAAA,QAAQ,CAAC;gBACP,QAAQ,EAAE,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,IAAI,SAAS;gBAC9D,GAAG,EAAE,OAAO,CAAC,GAAG;gBAChB,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,MAAM,OAAO,CAAC,WAAW,EAAE,CAAC;AAC/C,aAAA,CAAC;AAEF,YAAA,OAAO,IAAI,QAAQ,CAAC,EAAE,CAAC;AACzB,SAAC,CAAC;AACH;AAAM,SAAA;;QAEL,QAAQ,CAAC,sBAAsB,CAAC,MAAM,EAAE,CAAC,OAAO,EAAE,QAAQ,KAAI;AAC5D,YAAA,QAAQ,CAAC;AACP,gBAAA,QAAQ,EAAE,OAAO,CAAC,OAAO,CAAC,kBAAkB,CAAC;gBAC7C,GAAG,EAAE,OAAO,CAAC,GAAG;gBAChB,IAAI,EAAE,OAAO,CAAC,UAAU,GAAG,CAAC,CAAC,EAAE,KAAK;AACrC,aAAA,CAAC;YAEF,QAAQ,CAAC,EAAE,CAAC;AACd,SAAC,CAAC;AACH;AACH;AAeA;;;;AAIG;AACa,SAAA,UAAU,CAAC,IAAiD,EAAE,IAAY,EAAA;IACxF,IAAI,IAAI,CAAC,qBAAqB,EAAE;AAC9B,QAAA,IAAI,CAAC,qBAAqB,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC;AAC9D;AAAM,SAAA;AACL,QAAA,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,EAAE;QACnC,IAAI,CAAC,WAAW,CAAC,CAAC,IAAI,EAAE,GAAG,QAAQ,CAAC,CAAC;AACtC;AACH;;;;"}