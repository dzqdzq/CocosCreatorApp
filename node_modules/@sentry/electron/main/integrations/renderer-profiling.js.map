{"version":3,"file":"renderer-profiling.js","sources":["../../src/src/main/integrations/renderer-profiling.ts"],"sourcesContent":["import { defineIntegration, Event, forEachEnvelopeItem, LRUMap, Profile } from '@sentry/core';\nimport { app } from 'electron';\n\nimport { getDefaultEnvironment, getDefaultReleaseName } from '../context';\nimport { addHeaderToSession } from '../header-injection';\nimport { normaliseProfile } from '../normalize';\nimport { ElectronMainOptionsInternal } from '../sdk';\n\n// A cache of renderer profiles which need attaching to events\nlet RENDERER_PROFILES: LRUMap<string, Profile> | undefined;\n\n/**\n * Caches a profile to later be re-attached to an event\n */\nexport function rendererProfileFromIpc(event: Event, profile: Profile): void {\n  if (!RENDERER_PROFILES) {\n    return;\n  }\n\n  const profile_id = profile.event_id;\n  RENDERER_PROFILES.set(profile_id, profile);\n\n  if (event) {\n    event.contexts = {\n      ...event.contexts,\n      // Re-add the profile context which we can later use to find the correct profile\n      profile: {\n        profile_id,\n      },\n    };\n  }\n}\n\n/**\n * Injects 'js-profiling' document policy headers and ensures that profiles get forwarded with transactions\n */\nexport const rendererProfilingIntegration = defineIntegration(() => {\n  return {\n    name: 'RendererProfiling',\n    setup(client) {\n      const options = client.getOptions() as ElectronMainOptionsInternal;\n      if (!options.enableRendererProfiling) {\n        return;\n      }\n\n      RENDERER_PROFILES = new LRUMap(10);\n\n      app.on('ready', () => {\n        // Ensure the correct headers are set to enable the browser profiler\n        options.getSessions().forEach((sesh) => addHeaderToSession(sesh, 'Document-Policy', 'js-profiling'));\n      });\n\n      // Copy the profiles back into the event envelopes\n      client.on?.('beforeEnvelope', (envelope) => {\n        let profile_id: string | undefined;\n\n        forEachEnvelopeItem(envelope, (item, type) => {\n          if (type !== 'transaction') {\n            return;\n          }\n\n          for (let j = 1; j < item.length; j++) {\n            const event = item[j] as Event;\n\n            if (event?.contexts?.profile?.profile_id) {\n              profile_id = event.contexts.profile.profile_id as string;\n              // This can be removed as it's no longer needed\n              delete event.contexts.profile;\n            }\n          }\n        });\n\n        if (!profile_id) {\n          return;\n        }\n\n        const profile = RENDERER_PROFILES?.remove(profile_id);\n\n        if (!profile) {\n          return;\n        }\n\n        normaliseProfile(profile, app.getAppPath());\n        profile.release = options.release || getDefaultReleaseName();\n        profile.environment = options.environment || getDefaultEnvironment();\n\n        // @ts-expect-error untyped envelope\n        envelope[1].push([{ type: 'profile' }, profile]);\n      });\n    },\n  };\n});\n"],"names":["defineIntegration","LRUMap","app","addHeaderToSession","forEachEnvelopeItem","normaliseProfile","getDefaultReleaseName","getDefaultEnvironment"],"mappings":";;;;;;AAQA;AACA,IAAI,iBAAsD;AAE1D;;AAEG;AACa,SAAA,sBAAsB,CAAC,KAAY,EAAE,OAAgB,EAAA;IACnE,IAAI,CAAC,iBAAiB,EAAE;QACtB;AACD;AAED,IAAA,MAAM,UAAU,GAAG,OAAO,CAAC,QAAQ;AACnC,IAAA,iBAAiB,CAAC,GAAG,CAAC,UAAU,EAAE,OAAO,CAAC;AAE1C,IAAA,IAAI,KAAK,EAAE;QACT,KAAK,CAAC,QAAQ,GAAG;YACf,GAAG,KAAK,CAAC,QAAQ;;AAEjB,YAAA,OAAO,EAAE;gBACP,UAAU;AACX,aAAA;SACF;AACF;AACH;AAEA;;AAEG;AACU,MAAA,4BAA4B,GAAGA,sBAAiB,CAAC,MAAK;IACjE,OAAO;AACL,QAAA,IAAI,EAAE,mBAAmB;AACzB,QAAA,KAAK,CAAC,MAAM,EAAA;AACV,YAAA,MAAM,OAAO,GAAG,MAAM,CAAC,UAAU,EAAiC;AAClE,YAAA,IAAI,CAAC,OAAO,CAAC,uBAAuB,EAAE;gBACpC;AACD;AAED,YAAA,iBAAiB,GAAG,IAAIC,WAAM,CAAC,EAAE,CAAC;AAElC,YAAAC,YAAG,CAAC,EAAE,CAAC,OAAO,EAAE,MAAK;;gBAEnB,OAAO,CAAC,WAAW,EAAE,CAAC,OAAO,CAAC,CAAC,IAAI,KAAKC,kCAAkB,CAAC,IAAI,EAAE,iBAAiB,EAAE,cAAc,CAAC,CAAC;AACtG,aAAC,CAAC;;YAGF,MAAM,CAAC,EAAE,GAAG,gBAAgB,EAAE,CAAC,QAAQ,KAAI;AACzC,gBAAA,IAAI,UAA8B;gBAElCC,wBAAmB,CAAC,QAAQ,EAAE,CAAC,IAAI,EAAE,IAAI,KAAI;oBAC3C,IAAI,IAAI,KAAK,aAAa,EAAE;wBAC1B;AACD;AAED,oBAAA,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACpC,wBAAA,MAAM,KAAK,GAAG,IAAI,CAAC,CAAC,CAAU;AAE9B,wBAAA,IAAI,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,UAAU,EAAE;4BACxC,UAAU,GAAG,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAoB;;AAExD,4BAAA,OAAO,KAAK,CAAC,QAAQ,CAAC,OAAO;AAC9B;AACF;AACH,iBAAC,CAAC;gBAEF,IAAI,CAAC,UAAU,EAAE;oBACf;AACD;gBAED,MAAM,OAAO,GAAG,iBAAiB,EAAE,MAAM,CAAC,UAAU,CAAC;gBAErD,IAAI,CAAC,OAAO,EAAE;oBACZ;AACD;gBAEDC,0BAAgB,CAAC,OAAO,EAAEH,YAAG,CAAC,UAAU,EAAE,CAAC;gBAC3C,OAAO,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,IAAII,6BAAqB,EAAE;gBAC5D,OAAO,CAAC,WAAW,GAAG,OAAO,CAAC,WAAW,IAAIC,6BAAqB,EAAE;;AAGpE,gBAAA,QAAQ,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,EAAE,OAAO,CAAC,CAAC;AAClD,aAAC,CAAC;SACH;KACF;AACH,CAAC;;;;;"}