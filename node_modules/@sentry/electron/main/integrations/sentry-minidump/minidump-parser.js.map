{"version":3,"file":"minidump-parser.js","sources":["../../../src/src/main/integrations/sentry-minidump/minidump-parser.ts"],"sourcesContent":["// This code takes a lot of inspiration and info from the rust-minidump crate at this point in time:\n// https://github.com/rust-minidump/rust-minidump/tree/760f84058b909ff0f980988bd09f3a0f0421d298\n//\n// rust-minidump has the following license:\n//\n// MIT License\n//\n// Copyright (c) 2015-2023 rust-minidump contributors\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n\nexport const MINIDUMP_MAGIC_SIGNATURE = 'MDMP';\n\n// https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/ns-minidumpapiset-minidump_header\ntype MinidumpHeader = {\n  /** This should be MDMP */\n  signature: string;\n  /** This should be 42899 */\n  version: number;\n  /** The number of streams contained in the stream directory. */\n  streamCount: number;\n  /**\n   * The offset to the stream directory within the minidump.\n   * This usually points to immediately after the header.\n   * The stream directory is an array containing `stream_count`\n   */\n  streamDirectoryRva: number;\n  checksum: number;\n  timeDateStamp: Date;\n  flags: bigint;\n};\n\nfunction readHeader(buf: Buffer): MinidumpHeader {\n  // pub struct MINIDUMP_HEADER {\n  return {\n    //   pub signature: u32,\n    signature: buf.subarray(0, 4).toString(),\n    //   pub version: u32,\n    version: buf.readUInt32LE(4),\n    //   pub stream_count: u32,\n    streamCount: buf.readUInt32LE(8),\n    //   pub stream_directory_rva: u32,\n    streamDirectoryRva: buf.readUInt32LE(12),\n    //   pub checksum: u32,\n    checksum: buf.readUInt32LE(16),\n    //   pub time_date_stamp: u32,\n    timeDateStamp: new Date(buf.readUInt32LE(20) * 1000),\n    //   pub flags: u64,\n    flags: buf.readBigUInt64LE(24),\n  };\n  // }\n}\n\ntype MinidumpLocation = {\n  /** The size of this data. */\n  dataSize: number;\n  /** The offset to this data within the minidump file. */\n  rva: number;\n};\n\n// https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/ns-minidumpapiset-minidump_location_descriptor\nfunction readLocationDescriptor(buf: Buffer, base: number): MinidumpLocation {\n  // pub struct MINIDUMP_LOCATION_DESCRIPTOR {\n  return {\n    //   pub data_size: u32,\n    dataSize: buf.readUInt32LE(base),\n    //   pub rva: u32,\n    rva: buf.readUInt32LE(base + 4),\n  };\n  // }\n}\n\ntype MinidumpStream = {\n  /** This is usually one of the values for known stream types,\n   * but user streams can have arbitrary values. */\n  streamType: number;\n  /** The location of the stream contents within the dump */\n  location: MinidumpLocation;\n};\n\n// https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/ns-minidumpapiset-minidump_directory\nfunction readDirectoryStream(buf: Buffer, rva: number): MinidumpStream {\n  // pub struct MINIDUMP_DIRECTORY {\n  return {\n    //   pub stream_type: u32,\n    streamType: buf.readUInt32LE(rva),\n    //   pub location: [u32, u32],\n    location: readLocationDescriptor(buf, rva + 4),\n  };\n  // }\n}\n\nfunction readCrashpadInfoBuffer(buf: Buffer, location: MinidumpLocation): Buffer {\n  return buf.subarray(location.rva, location.rva + location.dataSize);\n}\n\n// https://crashpad.chromium.org/doxygen/structcrashpad_1_1MinidumpModuleCrashpadInfo.html\nfunction readCrashpadModuleInfoAnnotationObjectsLocation(buf: Buffer, base: number): MinidumpLocation {\n  // pub struct MINIDUMP_MODULE_CRASHPAD_INFO {\n  //   pub version: u32,\n  //   pub list_annotations: [u32, u32],\n  //   pub simple_annotations: [u32, u32],\n  //   pub annotation_objects: [u32, u32],\n  const annotation_objects = readLocationDescriptor(buf, base + 20);\n  // }\n\n  return annotation_objects;\n}\n\nfunction readStringUtf8Unterminated(buf: Buffer, rva: number): string {\n  const length = buf.readUInt32LE(rva);\n  return buf.toString('utf8', rva + 4, rva + 4 + length);\n}\n\ntype AnnotationObject = {\n  /** MinidumpUTF8String containing the name of the annotation. */\n  name: string;\n  /** `MinidumpByteArray` to the data for the annotation. */\n  value: string;\n};\n\nfunction readAnnotationObject(buf: Buffer, all: Buffer, offset: number): AnnotationObject | undefined {\n  // pub struct MINIDUMP_ANNOTATION {\n  //   pub name: u32,\n  const name = buf.readUInt32LE(offset);\n  //   pub ty: u16,\n  const ty = buf.readUInt16LE(offset + 4);\n  //   pub _reserved: u16,\n  //   pub value: u32,\n  const value = buf.readUInt32LE(offset + 8);\n  // }\n\n  // Only consider string annotations\n  if (ty === 1) {\n    return { name: readStringUtf8Unterminated(all, name), value: readStringUtf8Unterminated(all, value) };\n  }\n\n  return undefined;\n}\n\nfunction readAnnotationObjects(buf: Buffer, location: MinidumpLocation): Record<string, string> {\n  const data = buf.subarray(location.rva, location.rva + location.dataSize);\n  if (data.length === 0) {\n    return {};\n  }\n\n  const annotationObjectsLocation = readCrashpadModuleInfoAnnotationObjectsLocation(data, 0);\n  const annotationObjectsData = buf.subarray(\n    annotationObjectsLocation.rva,\n    annotationObjectsLocation.rva + annotationObjectsLocation.dataSize,\n  );\n\n  const count = annotationObjectsData.readUInt32LE(0);\n  let offset = 4;\n\n  const annotationObjects: Record<string, string> = {};\n  for (let i = 0; i < count; i++) {\n    const annotation = readAnnotationObject(annotationObjectsData, buf, offset);\n    if (annotation) {\n      const { name, value } = annotation;\n      annotationObjects[name] = value;\n    }\n    offset += 12; // Each MINIDUMP_ANNOTATION is 12 bytes\n  }\n\n  return annotationObjects;\n}\n\nfunction readCrashpadModuleLinks(buf: Buffer, location: MinidumpLocation): Record<string, string> {\n  const data = buf.subarray(location.rva, location.rva + location.dataSize);\n\n  if (data.length === 0) {\n    return {};\n  }\n\n  const count = data.readUInt32LE(0);\n  let offset = 4;\n\n  let annotationObjects = {};\n  for (let i = 0; i < count; i++) {\n    const annotationObjectsLocation = readLocationDescriptor(data, offset + 4);\n    annotationObjects = { ...annotationObjects, ...readAnnotationObjects(buf, annotationObjectsLocation) };\n    offset += 12;\n  }\n\n  return annotationObjects;\n}\n\n// https://crashpad.chromium.org/doxygen/structcrashpad_1_1MinidumpCrashpadInfo.html\nfunction parseCrashpadInfo(buf: Buffer, info: Buffer): Record<string, string> {\n  // pub struct MINIDUMP_CRASHPAD_INFO {\n  //   pub version: u32,\n  //   pub report_id: GUID (16 bytes),\n  //   pub client_id: GUID (16 bytes),\n  //   pub simple_annotations: [u32, u32],\n  //   pub module_list: [u32, u32],\n  const module_list = readLocationDescriptor(info, 44);\n  // }\n\n  return readCrashpadModuleLinks(buf, module_list);\n}\n\ntype CrashpadAnnotations = {\n  process_type?: string;\n} & Record<string, string>;\n\nexport type MinidumpParseResult = {\n  header: MinidumpHeader;\n  crashpadAnnotations?: CrashpadAnnotations;\n};\n\n/**\n * Parses an Electron minidump and extracts the header and crashpad annotations\n */\nexport function parseMinidump(buf: Buffer): MinidumpParseResult {\n  // Don't even bother trying to parse minidumps that are less than 10KB because they cannot be valid Electron minidumps\n  // https://github.com/getsentry/sentry-electron/pull/748\n  if (buf.length < 10_000) {\n    throw new Error('Minidump was less than 10KB so likely incomplete.');\n  }\n\n  let header: MinidumpHeader | undefined;\n  try {\n    header = readHeader(buf);\n  } catch (_) {\n    throw new Error('Failed to parse minidump header');\n  }\n\n  if (header.signature !== MINIDUMP_MAGIC_SIGNATURE) {\n    throw new Error(`Minidump signature was not '${MINIDUMP_MAGIC_SIGNATURE}'`);\n  }\n\n  try {\n    for (let i = 0; i < header.streamCount; i++) {\n      const stream = readDirectoryStream(buf, header.streamDirectoryRva + i * 12);\n\n      // Crashpad specific stream in Electron minidump files\n      // https://crashpad.chromium.org/doxygen/structcrashpad_1_1MinidumpCrashpadInfo.html\n      if (stream.streamType === 1_129_316_353) {\n        const crashpadInfo = readCrashpadInfoBuffer(buf, stream.location);\n        const crashpadAnnotations = parseCrashpadInfo(buf, crashpadInfo);\n\n        return {\n          header,\n          crashpadAnnotations,\n        };\n      }\n    }\n  } catch (_) {\n    //\n  }\n\n  return { header };\n}\n"],"names":[],"mappings":"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"}