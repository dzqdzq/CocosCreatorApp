{"version":3,"file":"minidump-loader.js","sources":["../../../src/src/main/integrations/sentry-minidump/minidump-loader.ts"],"sourcesContent":["import { Attachment, logger } from '@sentry/core';\nimport { app } from 'electron';\nimport { promises as fs } from 'fs';\nimport { basename, join } from 'path';\n\nimport { Mutex } from '../../mutex';\nimport { MinidumpParseResult, parseMinidump } from './minidump-parser';\n\n/** Maximum number of days to keep a minidump before deleting it. */\nconst MAX_AGE_DAYS = 30;\nconst MS_PER_DAY = 24 * 3_600 * 1_000;\n/** Minimum number of milliseconds a minidump should not be modified for before we assume writing is complete */\nconst NOT_MODIFIED_MS = 1_000;\nconst MAX_RETRY_MS = 5_000;\nconst RETRY_DELAY_MS = 500;\nconst MAX_RETRIES = MAX_RETRY_MS / RETRY_DELAY_MS;\n\nfunction delay(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * A function that loads minidumps\n * @param deleteAll Whether to just delete all minidumps\n * @param callback A callback to call with the attachment ready to send\n */\nexport type MinidumpLoader = (\n  deleteAll: boolean,\n  callback: (minidump: MinidumpParseResult, attachment: Attachment) => Promise<void>,\n) => Promise<void>;\n\n/**\n * Creates a minidump loader\n * @param getMinidumpPaths A function that returns paths to minidumps\n * @param preProcessFile A function that pre-processes the minidump file\n * @returns A function to fetch minidumps\n */\nexport function createMinidumpLoader(getMinidumpPaths: () => Promise<string[]>): MinidumpLoader {\n  // The mutex protects against a whole host of reentrancy issues and race conditions.\n  const mutex = new Mutex();\n\n  return async (deleteAll, callback) => {\n    // any calls to this function will be queued and run exclusively\n    await mutex.runExclusive(async () => {\n      for (const path of await getMinidumpPaths()) {\n        try {\n          if (deleteAll) {\n            continue;\n          }\n\n          logger.log('Found minidump', path);\n\n          let stats = await fs.stat(path);\n\n          const thirtyDaysAgo = new Date().getTime() - MAX_AGE_DAYS * MS_PER_DAY;\n\n          if (stats.mtimeMs < thirtyDaysAgo) {\n            logger.log(`Ignoring minidump as it is over ${MAX_AGE_DAYS} days old`);\n            continue;\n          }\n\n          let retries = 0;\n\n          while (retries <= MAX_RETRIES) {\n            const twoSecondsAgo = new Date().getTime() - NOT_MODIFIED_MS;\n\n            if (stats.mtimeMs < twoSecondsAgo) {\n              const data = await fs.readFile(path);\n              try {\n                const parsedMinidump = parseMinidump(data);\n\n                logger.log('Sending minidump');\n\n                await callback(parsedMinidump, {\n                  attachmentType: 'event.minidump',\n                  filename: basename(path),\n                  data,\n                });\n              } catch (e) {\n                const message = e instanceof Error ? e.toString() : 'Unknown error';\n                logger.warn(`Dropping minidump:\\n${message}`);\n                break;\n              }\n\n              break;\n            }\n\n            logger.log(`Waiting. Minidump has been modified in the last ${NOT_MODIFIED_MS} milliseconds.`);\n            retries += 1;\n            await delay(RETRY_DELAY_MS);\n            // update the stats\n            stats = await fs.stat(path);\n          }\n\n          if (retries >= MAX_RETRIES) {\n            logger.warn('Timed out waiting for minidump to stop being modified');\n          }\n        } catch (e) {\n          logger.error('Failed to load minidump', e);\n        } finally {\n          // We always attempt to delete the minidump\n          try {\n            await fs.unlink(path);\n          } catch (e) {\n            logger.warn('Could not delete minidump', path);\n          }\n        }\n      }\n    });\n  };\n}\n\n/** Attempts to remove the metadata file so Crashpad doesn't output `failed to stat report` errors to the console */\nasync function deleteCrashpadMetadataFile(crashesDirectory: string, waitMs: number = 100): Promise<void> {\n  if (waitMs > 2_000) {\n    return;\n  }\n\n  const metadataPath = join(crashesDirectory, 'metadata');\n  try {\n    await fs.unlink(metadataPath);\n    logger.log('Deleted Crashpad metadata file', metadataPath);\n  } catch (e: any) {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n    if (e.code && e.code == 'EBUSY') {\n      // Since Crashpad probably still has the metadata file open, we make a few attempts to delete it, backing\n      // off and waiting longer each time.\n      setTimeout(async () => {\n        await deleteCrashpadMetadataFile(crashesDirectory, waitMs * 2);\n      }, waitMs);\n    }\n  }\n}\n\nasync function readDirsAsync(paths: string[]): Promise<string[]> {\n  const found: string[] = [];\n  for (const path of paths) {\n    try {\n      const files = await fs.readdir(path);\n      found.push(...files.map((file) => join(path, file)));\n    } catch (_) {\n      //\n    }\n  }\n  return found;\n}\n\n/**\n * Gets the crashpad minidump loader\n */\nexport function getMinidumpLoader(): MinidumpLoader {\n  const crashesDirectory: string = app.getPath('crashDumps');\n  const crashpadSubDirectory = process.platform === 'win32' ? 'reports' : 'completed';\n\n  const dumpDirectories = [join(crashesDirectory, crashpadSubDirectory)];\n\n  if (process.platform === 'darwin') {\n    dumpDirectories.push(join(crashesDirectory, 'pending'));\n  }\n\n  return createMinidumpLoader(async () => {\n    await deleteCrashpadMetadataFile(crashesDirectory).catch((error) => logger.error(error));\n    const files = await readDirsAsync(dumpDirectories);\n    return files.filter((file) => file.endsWith('.dmp'));\n  });\n}\n"],"names":["mutex","Mutex","path","logger","fs","parseMinidump","basename","join","app"],"mappings":"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"}