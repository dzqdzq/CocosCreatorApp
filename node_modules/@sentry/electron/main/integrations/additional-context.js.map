{"version":3,"file":"additional-context.js","sources":["../../src/src/main/integrations/additional-context.ts"],"sourcesContent":["import { defineIntegration, DeviceContext } from '@sentry/core';\nimport { app, screen as electronScreen } from 'electron';\nimport { exec } from 'node:child_process';\n\nimport { mergeEvents } from '../merge';\n\nexport interface AdditionalContextOptions {\n  /**\n   * Capture dimensions and resolution of the primary display\n   * @default true\n   */\n  screen: boolean;\n  /**\n   * Capture device model and manufacturer.\n   * No supported on Linux.\n   * @default false\n   */\n  deviceModelManufacturer: boolean;\n}\n\nconst DEFAULT_OPTIONS: AdditionalContextOptions = {\n  screen: true,\n  deviceModelManufacturer: false,\n};\n\n/** The Key properties we're looking for in the JSON we get back from the powershell command */\ntype CmiJson = {\n  Manufacturer?: string;\n  Model?: string;\n};\n\nfunction getWindowsDeviceModelManufacturer(): Promise<DeviceContext> {\n  return new Promise((resolve) => {\n    try {\n      exec(\n        'powershell -NoProfile \"Get-CimInstance -ClassName Win32_ComputerSystem | ConvertTo-Json\"',\n        (error, stdout) => {\n          if (error) {\n            resolve({});\n          }\n          try {\n            const details = JSON.parse(stdout) as CmiJson;\n            if (details.Manufacturer || details.Model) {\n              resolve({\n                manufacturer: details.Manufacturer,\n                model: details.Model,\n              });\n              return;\n            }\n          } catch (_) {\n            //\n          }\n          resolve({});\n        },\n      );\n    } catch (_) {\n      resolve({});\n    }\n  });\n}\n\ntype MacOSHwType = {\n  machine_model?: string;\n};\n\ntype MacOSJson = {\n  SPHardwareDataType?: MacOSHwType[];\n};\n\nfunction getMacOSDeviceModelManufacturer(): Promise<DeviceContext> {\n  return new Promise((resolve) => {\n    try {\n      exec('system_profiler SPHardwareDataType -json', (error, stdout) => {\n        if (error) {\n          resolve({});\n        }\n        try {\n          const details = JSON.parse(stdout.trim()) as MacOSJson;\n          if (details.SPHardwareDataType?.[0]?.machine_model) {\n            resolve({\n              manufacturer: 'Apple',\n              model: details.SPHardwareDataType[0].machine_model,\n            });\n            return;\n          }\n        } catch (_) {\n          //\n        }\n        resolve({});\n      });\n    } catch (_) {\n      resolve({});\n    }\n  });\n}\n\nfunction getDeviceModelManufacturer(): Promise<DeviceContext> {\n  if (process.platform === 'win32') {\n    return getWindowsDeviceModelManufacturer();\n  } else if (process.platform === 'darwin') {\n    return getMacOSDeviceModelManufacturer();\n  }\n\n  return Promise.resolve({});\n}\n\n/**\n * Adds additional Electron context to events\n */\nexport const additionalContextIntegration = defineIntegration((userOptions: Partial<AdditionalContextOptions> = {}) => {\n  const _lazyDeviceContext: DeviceContext = {};\n  let captureDeviceModelManufacturer = userOptions.deviceModelManufacturer;\n\n  const options = {\n    ...DEFAULT_OPTIONS,\n    ...userOptions,\n  };\n\n  function setPrimaryDisplayInfo(): void {\n    const display = electronScreen.getPrimaryDisplay();\n    const width = Math.floor(display.size.width * display.scaleFactor);\n    const height = Math.floor(display.size.height * display.scaleFactor);\n    _lazyDeviceContext.screen_density = display.scaleFactor;\n    _lazyDeviceContext.screen_resolution = `${width}x${height}`;\n  }\n\n  async function setDeviceModelManufacturer(): Promise<void> {\n    const { manufacturer, model } = await getDeviceModelManufacturer();\n\n    if (manufacturer || model) {\n      _lazyDeviceContext.manufacturer = manufacturer;\n      _lazyDeviceContext.model = model;\n    }\n  }\n\n  return {\n    name: 'AdditionalContext',\n    setup() {\n      if (!options.screen) {\n        return;\n      }\n\n      // Some metrics are only available after app ready so we lazily load them\n      app.whenReady().then(\n        () => {\n          setPrimaryDisplayInfo();\n          electronScreen.on('display-metrics-changed', () => {\n            setPrimaryDisplayInfo();\n          });\n        },\n        () => {\n          // ignore\n        },\n      );\n    },\n    processEvent: async (event) => {\n      if (captureDeviceModelManufacturer) {\n        // Ensure we only fetch this once per session\n        captureDeviceModelManufacturer = false;\n\n        await setDeviceModelManufacturer();\n      }\n\n      return mergeEvents(event, { contexts: { device: _lazyDeviceContext } });\n    },\n  };\n});\n"],"names":["exec","defineIntegration","electronScreen","app","mergeEvents"],"mappings":"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"}