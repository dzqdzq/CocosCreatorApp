'use strict';
// @ts-check
var __importDefault = (this && this.__importDefault) || function(mod) {
    return (mod && mod.__esModule) ? mod : { 'default': mod };
};
Object.defineProperty(exports, '__esModule', { value: true });
exports.loadDynamic = void 0;
const module_1 = __importDefault(require('module'));
const path_1 = __importDefault(require('path'));
let hasPreload = false;
let loader = null;
/**
 * 初始化引擎加载器。预先引擎模块，并将其映射为在编辑器内可用的 CommonJS 模块。
 * @param options 选项。
 */
async function preload(options) {
    var _a, _b;
    function isEngineModule(request) {
        return request === 'cc' || (request.startsWith('cc/') && !request.startsWith('cc/preload')) || request.startsWith('cce:/internal/');
    }
    try {
        if (hasPreload) {
            throw new Error('You can only preload engine once.');
        }
        hasPreload = true;
        const { requiredModules, editorExtensions = true, editorPath } = options;
        const root = (_a = options.root) !== null && _a !== void 0 ? _a : (await (async () => {
            const ipc = require('@base/electron-base-ipc');
            const info = ipc.sendSync('packages-engine:query-engine-info');
            return info.path;
        })());
        const dist = (_b = options.dist) !== null && _b !== void 0 ? _b : path_1.default.join(root, 'bin', '.cache', 'dev', 'editor');
        // 设置 CC_EDITOR 标记，引擎加载的时候会使用标记进行部分判断
        // @ts-ignore
        globalThis.CC_EDITOR = true;
        if (editorExtensions) {
            const ipc = require('@base/electron-base-ipc');
            // 向 engine 插件查询信息
            const info = ipc.sendSync('packages-engine:query-engine-info');
            // 加载编辑器扩展
            // @ts-ignore
            globalThis.EditorExtends = require(path_1.default.join(info.editor, './builtin/engine/dist/editor-extends'));
        }
        const engineModules = {};
        const loaderModule = require(path_1.default.resolve(dist, 'loader'));
        loader = loaderModule.default;
        for (const requiredModule of requiredModules) {
            engineModules[requiredModule] = await loader.import(requiredModule);
        }
        const ModuleInternal = module_1.default;
        const vendorResolveFilename = ModuleInternal._resolveFilename;
        ModuleInternal._resolveFilename = function(request) {
            if (isEngineModule(request)) {
                return request;
            }
            else {
                // @ts-ignore
                // eslint-disable-next-line prefer-rest-params
                return vendorResolveFilename.apply(this, arguments);
            }
        };
        const vendorLoad = ModuleInternal._load;
        ModuleInternal._load = function(request) {
            if (isEngineModule(request)) {
                const module = engineModules[request];
                if (module) {
                    return module;
                }
                else {
                    throw new Error(`Can not load engine module: ${request}. Valid engine modules are: ${Object.keys(engineModules).join(',')}`);
                }
            }
            else {
                // @ts-ignore
                // eslint-disable-next-line prefer-rest-params
                return vendorLoad.apply(this, arguments);
            }
        };
        if (requiredModules.includes('cc')) {
            postProcess(editorPath);
        }
    }
    catch (error) {
        // @ts-ignore
        Editor.Message.send('engine', 'import-engine-error', error.toString());
        throw error;
    }
}
exports.default = preload;
/**
 * 动态加载指定模块。应确保引擎加载器已经初始化过。
 * @param id 引擎模块 ID。
 * @returns 引擎模块。
 */
async function loadDynamic(id) {
    if (!loader) {
        throw new Error(`Failed to load engine module ${id}. ` + 'Loader has not been initialized. You should call preload() first.');
    }
    return await loader.import(id);
}
exports.loadDynamic = loadDynamic;
function postProcess(editorPath) {
    let info;
    if (!editorPath) {
        const ipc = require('@base/electron-base-ipc');
        info = ipc.sendSync('packages-engine:query-engine-info');
    }
    else {
        info = {
            editor: editorPath,
        };
    }
    const vStacks = require('v-stacks');
    if ('__MAIN__' in window) {
        const error = new Error('Try not to run the engine in the window process.');
        error.stack = vStacks.ignoreStack(error.stack, 1);
        console.warn(error);
    }
    const timeLabel = 'Import engine';
    console.time(timeLabel);
    let ccm;
    try {
        ccm = require('cc');
    }
    catch (error) {
        // @ts-ignore
        Editor.Message.send('engine', 'import-engine-error', error.toString());
        throw error;
    }
    console.timeEnd(timeLabel);
    // ---- 加载引擎主体 ----
    // @ts-ignore
    window.ccm = ccm;
    // ---- hack creator 使用的一些 engine 参数
    require('./polyfill/engine');
    // @ts-ignore
    globalThis.EditorExtends.init();
    const handle = require('./overwrite');
    handle(ccm, info);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlbG9hZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInByZWxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVk7Ozs7OztBQUVaLG9EQUE0QjtBQUM1QixnREFBc0I7QUFZdEIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO0FBRXZCLElBQUksTUFBTSxHQUF3QixJQUFJLENBQUM7QUFFdkM7OztHQUdHO0FBQ0gsS0FBSyxVQUFVLE9BQU8sQ0FBQyxPQXVCdEI7O0lBQ0csU0FBUyxjQUFjLENBQUMsT0FBZTtRQUNuQyxPQUFPLE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN4SSxDQUFDO0lBRUQsSUFBSTtRQUNBLElBQUksVUFBVSxFQUFFO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1NBQ3hEO1FBQ0QsVUFBVSxHQUFHLElBQUksQ0FBQztRQUVsQixNQUFNLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixHQUFHLElBQUksRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFFekUsTUFBTSxJQUFJLEdBQ04sTUFBQSxPQUFPLENBQUMsSUFBSSxtQ0FDWixDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNmLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsbUNBQW1DLENBQUMsQ0FBQztZQUMvRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDckIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRVYsTUFBTSxJQUFJLEdBQUcsTUFBQSxPQUFPLENBQUMsSUFBSSxtQ0FB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QixtQkFBbUI7SUFDbkIsYUFBYTtJQUNiLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO0lBRWpCLG9DQUFvQztJQUNwQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUU3QixhQUFhO0lBQ2IsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVoQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWNoZWNrXHJcblxyXG5pbXBvcnQgTW9kdWxlIGZyb20gJ21vZHVsZSc7XHJcbmltcG9ydCBwcyBmcm9tICdwYXRoJztcclxuXHJcbi8vIGRlY2xhcmUgbW9kdWxlIFwibW9kdWxlXCIge1xyXG4vLyAgICAgbmFtZXNwYWNlIE1vZHVsZSB7XHJcbi8vICAgICAgICAgZXhwb3J0IGZ1bmN0aW9uIF9yZXNvbHZlRmlsZW5hbWUocmVxdWVzdDogc3RyaW5nKTogdm9pZDtcclxuLy8gICAgIH1cclxuLy8gfVxyXG5cclxuaW50ZXJmYWNlIEVuZ2luZUxvYWRlciB7XHJcbiAgICBpbXBvcnQoaWQ6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj47XHJcbn1cclxuXHJcbmxldCBoYXNQcmVsb2FkID0gZmFsc2U7XHJcblxyXG5sZXQgbG9hZGVyOiBFbmdpbmVMb2FkZXIgfCBudWxsID0gbnVsbDtcclxuXHJcbi8qKlxyXG4gKiDliJ3lp4vljJblvJXmk47liqDovb3lmajjgILpooTlhYjlvJXmk47mqKHlnZfvvIzlubblsIblhbbmmKDlsITkuLrlnKjnvJbovpHlmajlhoXlj6/nlKjnmoQgQ29tbW9uSlMg5qih5Z2X44CCXHJcbiAqIEBwYXJhbSBvcHRpb25zIOmAiemhueOAglxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcHJlbG9hZChvcHRpb25zOiB7XHJcbiAgICAvKipcclxuICAgICAqIOW8leaTjuagueebruW9leOAguWmguaenOacquaMh+WumuWImeeUqCBJUEMg5raI5oGv5p+l6K+i5b2T5YmN5L2/55So55qE44CCXHJcbiAgICAgKi9cclxuICAgIHJvb3Q/OiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlvJXmk47liIblj5Hnm67lvZXvvIjlvJXmk47nvJbor5HlkI7nmoTnm67lvZXvvInjgIJcclxuICAgICAqL1xyXG4gICAgZGlzdD86IHN0cmluZztcclxuXHJcbiAgICBlZGl0b3JQYXRoPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5piv5ZCm6KaB5rOo5YWl5YWo5bGA5Y+Y6YePIGBFZGl0b3JFeHRlbmRzYOOAguS4u+i/m+eoi+S4jeWPr+S9v+eUqOOAglxyXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxyXG4gICAgICovXHJcbiAgICBlZGl0b3JFeHRlbnNpb25zPzogYm9vbGVhbjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOmcgOimgemihOWKoOi9veeahOaooeWdl+OAglxyXG4gICAgICovXHJcbiAgICByZXF1aXJlZE1vZHVsZXM6IHN0cmluZ1tdO1xyXG59KSB7XHJcbiAgICBmdW5jdGlvbiBpc0VuZ2luZU1vZHVsZShyZXF1ZXN0OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gcmVxdWVzdCA9PT0gJ2NjJyB8fCAocmVxdWVzdC5zdGFydHNXaXRoKCdjYy8nKSAmJiAhcmVxdWVzdC5zdGFydHNXaXRoKCdjYy9wcmVsb2FkJykpIHx8IHJlcXVlc3Quc3RhcnRzV2l0aCgnY2NlOi9pbnRlcm5hbC8nKTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGlmIChoYXNQcmVsb2FkKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignWW91IGNhbiBvbmx5IHByZWxvYWQgZW5naW5lIG9uY2UuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGhhc1ByZWxvYWQgPSB0cnVlO1xyXG4gICAgXHJcbiAgICAgICAgY29uc3QgeyByZXF1aXJlZE1vZHVsZXMsIGVkaXRvckV4dGVuc2lvbnMgPSB0cnVlLCBlZGl0b3JQYXRoIH0gPSBvcHRpb25zO1xyXG4gICAgXHJcbiAgICAgICAgY29uc3Qgcm9vdCA9XHJcbiAgICAgICAgICAgIG9wdGlvbnMucm9vdCA/P1xyXG4gICAgICAgICAgICAoYXdhaXQgKGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlwYyA9IHJlcXVpcmUoJ0BiYXNlL2VsZWN0cm9uLWJhc2UtaXBjJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gaXBjLnNlbmRTeW5jKCdwYWNrYWdlcy1lbmdpbmU6cXVlcnktZW5naW5lLWluZm8nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbmZvLnBhdGg7XHJcbiAgICAgICAgICAgIH0pKCkpO1xyXG4gICAgXHJcbiAgICAgICAgY29uc3QgZGlzdCA9IG9wdGlvbnMuZGlzdCA/PyBwcy5qb2luKHJvb3QsICdiaW4nLCAnLmNhY2hlJywgJ2RldicsICdlZGl0b3InKTtcclxuICAgIFxyXG4gICAgICAgIC8vIOiuvue9riBDQ19FRElUT1Ig5qCH6K6w77yM5byV5pOO5Yqg6L2955qE5pe25YCZ5Lya5L2/55So5qCH6K6w6L+b6KGM6YOo5YiG5Yik5patXHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIGdsb2JhbFRoaXMuQ0NfRURJVE9SID0gdHJ1ZTtcclxuICAgIFxyXG4gICAgICAgIGlmIChlZGl0b3JFeHRlbnNpb25zKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlwYyA9IHJlcXVpcmUoJ0BiYXNlL2VsZWN0cm9uLWJhc2UtaXBjJyk7XHJcbiAgICBcclxuICAgICAgICAgICAgLy8g5ZCRIGVuZ2luZSDmj5Lku7bmn6Xor6Lkv6Hmga9cclxuICAgICAgICAgICAgY29uc3QgaW5mbyA9IGlwYy5zZW5kU3luYygncGFja2FnZXMtZW5naW5lOnF1ZXJ5LWVuZ2luZS1pbmZvJyk7XHJcbiAgICBcclxuICAgICAgICAgICAgLy8g5Yqg6L2957yW6L6R5Zmo5omp5bGVXHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgZ2xvYmFsVGhpcy5FZGl0b3JFeHRlbmRzID0gcmVxdWlyZShwcy5qb2luKGluZm8uZWRpdG9yLCAnLi9idWlsdGluL2VuZ2luZS9kaXN0L2VkaXRvci1leHRlbmRzJykpO1xyXG4gICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgIGNvbnN0IGVuZ2luZU1vZHVsZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge307XHJcbiAgICBcclxuICAgICAgICBjb25zdCBsb2FkZXJNb2R1bGUgPSByZXF1aXJlKHBzLnJlc29sdmUoZGlzdCwgJ2xvYWRlcicpKSBhcyB7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6IEVuZ2luZUxvYWRlcjtcclxuICAgICAgICB9O1xyXG4gICAgXHJcbiAgICAgICAgbG9hZGVyID0gbG9hZGVyTW9kdWxlLmRlZmF1bHQ7XHJcbiAgICBcclxuICAgICAgICBmb3IgKGNvbnN0IHJlcXVpcmVkTW9kdWxlIG9mIHJlcXVpcmVkTW9kdWxlcykge1xyXG4gICAgICAgICAgICBlbmdpbmVNb2R1bGVzW3JlcXVpcmVkTW9kdWxlXSA9IGF3YWl0IGxvYWRlci5pbXBvcnQocmVxdWlyZWRNb2R1bGUpO1xyXG4gICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgIGNvbnN0IE1vZHVsZUludGVybmFsID0gTW9kdWxlIGFzIHR5cGVvZiBNb2R1bGUgJiB7XHJcbiAgICAgICAgICAgIF9yZXNvbHZlRmlsZW5hbWUodGhpczogTW9kdWxlLCByZXF1ZXN0OiBzdHJpbmcpOiB2b2lkO1xyXG4gICAgICAgICAgICBfbG9hZCh0aGlzOiBNb2R1bGUsIHJlcXVlc3Q6IHN0cmluZyk6IHZvaWQ7XHJcbiAgICAgICAgfTtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IHZlbmRvclJlc29sdmVGaWxlbmFtZSA9IE1vZHVsZUludGVybmFsLl9yZXNvbHZlRmlsZW5hbWU7XHJcbiAgICAgICAgTW9kdWxlSW50ZXJuYWwuX3Jlc29sdmVGaWxlbmFtZSA9IGZ1bmN0aW9uKHJlcXVlc3Q6IHN0cmluZykge1xyXG4gICAgICAgICAgICBpZiAoaXNFbmdpbmVNb2R1bGUocmVxdWVzdCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXF1ZXN0O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1yZXN0LXBhcmFtc1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZlbmRvclJlc29sdmVGaWxlbmFtZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IHZlbmRvckxvYWQgPSBNb2R1bGVJbnRlcm5hbC5fbG9hZDtcclxuICAgICAgICBNb2R1bGVJbnRlcm5hbC5fbG9hZCA9IGZ1bmN0aW9uKHJlcXVlc3Q6IHN0cmluZykge1xyXG4gICAgICAgICAgICBpZiAoaXNFbmdpbmVNb2R1bGUocmVxdWVzdCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZSA9IGVuZ2luZU1vZHVsZXNbcmVxdWVzdF07XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kdWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBgQ2FuIG5vdCBsb2FkIGVuZ2luZSBtb2R1bGU6ICR7cmVxdWVzdH0uIFZhbGlkIGVuZ2luZSBtb2R1bGVzIGFyZTogJHtPYmplY3Qua2V5cyhlbmdpbmVNb2R1bGVzKS5qb2luKCcsJyl9YCxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1yZXN0LXBhcmFtc1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZlbmRvckxvYWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICBcclxuICAgICAgICBpZiAocmVxdWlyZWRNb2R1bGVzLmluY2x1ZGVzKCdjYycpKSB7XHJcbiAgICAgICAgICAgIHBvc3RQcm9jZXNzKGVkaXRvclBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIEVkaXRvci5NZXNzYWdlLnNlbmQoJ2VuZ2luZScsICdpbXBvcnQtZW5naW5lLWVycm9yJywgZXJyb3IudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IHByZWxvYWQ7XHJcblxyXG4vKipcclxuICog5Yqo5oCB5Yqg6L295oyH5a6a5qih5Z2X44CC5bqU56Gu5L+d5byV5pOO5Yqg6L295Zmo5bey57uP5Yid5aeL5YyW6L+H44CCXHJcbiAqIEBwYXJhbSBpZCDlvJXmk47mqKHlnZcgSUTjgIJcclxuICogQHJldHVybnMg5byV5pOO5qih5Z2X44CCXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZER5bmFtaWMoaWQ6IHN0cmluZykge1xyXG4gICAgaWYgKCFsb2FkZXIpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2FkIGVuZ2luZSBtb2R1bGUgJHtpZH0uIGAgKyAnTG9hZGVyIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZC4gWW91IHNob3VsZCBjYWxsIHByZWxvYWQoKSBmaXJzdC4nKTtcclxuICAgIH1cclxuICAgIHJldHVybiBhd2FpdCBsb2FkZXIuaW1wb3J0KGlkKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcG9zdFByb2Nlc3MoZWRpdG9yUGF0aD86IHN0cmluZykge1xyXG4gICAgbGV0IGluZm87XHJcblxyXG4gICAgaWYgKCFlZGl0b3JQYXRoKSB7XHJcbiAgICAgICAgY29uc3QgaXBjID0gcmVxdWlyZSgnQGJhc2UvZWxlY3Ryb24tYmFzZS1pcGMnKTtcclxuXHJcbiAgICAgICAgaW5mbyA9IGlwYy5zZW5kU3luYygncGFja2FnZXMtZW5naW5lOnF1ZXJ5LWVuZ2luZS1pbmZvJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGluZm8gPSB7XHJcbiAgICAgICAgICAgIGVkaXRvcjogZWRpdG9yUGF0aCxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHZTdGFja3MgPSByZXF1aXJlKCd2LXN0YWNrcycpO1xyXG4gICAgaWYgKCdfX01BSU5fXycgaW4gd2luZG93KSB7XHJcbiAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1RyeSBub3QgdG8gcnVuIHRoZSBlbmdpbmUgaW4gdGhlIHdpbmRvdyBwcm9jZXNzLicpO1xyXG4gICAgICAgIGVycm9yLnN0YWNrID0gdlN0YWNrcy5pZ25vcmVTdGFjayhlcnJvci5zdGFjaywgMSk7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGVycm9yKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0aW1lTGFiZWwgPSAnSW1wb3J0IGVuZ2luZSc7XHJcbiAgICBjb25zb2xlLnRpbWUodGltZUxhYmVsKTtcclxuXHJcbiAgICBsZXQgY2NtO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjY20gPSByZXF1aXJlKCdjYycpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnZW5naW5lJywgJ2ltcG9ydC1lbmdpbmUtZXJyb3InLCBlcnJvci50b1N0cmluZygpKTtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLnRpbWVFbmQodGltZUxhYmVsKTtcclxuXHJcbiAgICAvLyAtLS0tIOWKoOi9veW8leaTjuS4u+S9kyAtLS0tXHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICB3aW5kb3cuY2NtID0gY2NtO1xyXG5cclxuICAgIC8vIC0tLS0gaGFjayBjcmVhdG9yIOS9v+eUqOeahOS4gOS6myBlbmdpbmUg5Y+C5pWwXHJcbiAgICByZXF1aXJlKCcuL3BvbHlmaWxsL2VuZ2luZScpO1xyXG5cclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIGdsb2JhbFRoaXMuRWRpdG9yRXh0ZW5kcy5pbml0KCk7XHJcblxyXG4gICAgY29uc3QgaGFuZGxlID0gcmVxdWlyZSgnLi9vdmVyd3JpdGUnKTtcclxuICAgIGhhbmRsZShjY20sIGluZm8pO1xyXG59XHJcbiJdfQ==