'use strict';

const ps = require('path');
const ipc = require('@base/electron-base-ipc');
const vStacks = require('v-stacks');
const modsMgr = require('./mods-mgr');

if ('__MAIN__' in window) {
    const error = new Error(`Try not to run the engine in the window process.`);
    error.stack = vStacks.ignoreStack(error.stack, 1);
    console.warn(error);
}

// 向 engine 插件查询信息
const info = ipc.sendSync('packages-engine:query-engine-info');

// 设置 CC_EDITOR 标记，引擎加载的时候会使用标记进行部分判断
window.CC_EDITOR = true;

// 加载编辑器扩展
window.EditorExtends = require(ps.join(info.editor, './builtin/engine/dist/editor-extends'));

const timeLabel = 'Import engine';
console.time(timeLabel);

let ccm;
try {
    ccm = modsMgr.syncImport('cc');
} catch(error) {
    Editor.Message.send('engine', 'import-engine-error');
    throw error;
}


console.timeEnd(timeLabel);

// ---- 加载引擎主体 ----
window.ccm = ccm;

ccm.assetManager.init({
    importBase: 'import://',
    nativeBase: 'import://',
});

// ---- hack creator 使用的一些 engine 参数
require('./polyfill/engine');

module.exports = ccm;

EditorExtends.init();

const handle = require('./overwrite');
handle(ccm, info);
