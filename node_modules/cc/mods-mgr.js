'use strict';

const { join } = require('path');

const createModsMgr = (() => {
    const ps = require('path');
    const { pathToFileURL } = require('url');
    const { EmbeddedCommonJs } = require('@editor/lib-programming/dist/embedded-commonjs');
    return (baseDistDir) => {
        const labelSetupModsMgr = 'Setup mods mgr.';
        console.time(labelSetupModsMgr);

        // 设置 import map
        const importMapPath = ps.join(baseDistDir, 'import-map.json');
        const importMapUrl = pathToFileURL(importMapPath).href;
        const importMap = require(importMapPath);
        const modsMgr = new EmbeddedCommonJs({ importMap, importMapUrl });
        const namedWrappers = require(ps.join(baseDistDir, 'bundled', 'index.js'));
        modsMgr.addNamedWrappers(namedWrappers);

        console.timeEnd(labelSetupModsMgr);

        return modsMgr;
    };
})();

let enginePath;
enginePath = require('./location').get();
if (!enginePath) {
    // 向 engine 插件查询信息
    const ipc = require('@base/electron-base-ipc');
    const info = ipc.sendSync('packages-engine:query-engine-info');
    require('./location').set(info.path);
    enginePath = require('./location').get();
}

console.debug(`Engine location: ${enginePath}`);
module.exports = createModsMgr(enginePath);
