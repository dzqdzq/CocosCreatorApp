"use strict";const e=require("iconv-lite"),t=require("fire-path"),r=require("fire-fs"),o=require("del"),i=require("child_process").spawn,n=require("tree-kill"),a=require("async"),s=require("electron"),l=require("globby"),c=require("xxtea-node"),d=require("zlib"),p=require("lodash"),u=Editor.require("app://share/engine-utils"),f=Editor.Profile.load("global://settings.json");let g=t.join(Editor.App.home,"logs/native.log"),m=f.get("show-console-log");let E,h,y,S,j,w,_,O,v,C,x,b,P,I,$,A,R,k,D=-1,T=-1,F="",L=Editor.url("unpack://utils/Python27/python");function N(){let e=Editor.Profile.load("local://settings.json");return!1!==e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json")),e.get("use-default-cpp-engine")?Editor.builtinCocosRoot:e.get("cpp-engine-path")}function M(e,r){var o;let n=K();if(n)return[n,o];e=[S].concat(e);try{if("darwin"===process.platform)o=i("sh",e,r);else{let n=e.indexOf("--env"),a="COCOS_PYTHON_HOME="+t.dirname(L);n>=0?n===e.length-1?e.push(a):e[n+1]+=";"+a:(e.push("--env"),e.push(a)),o=i(L,e,r)}}catch(e){n=e}return{error:n,child:o}}function K(){return y=N(),console.log("Cocos2dx root: "+y),-1!==y.indexOf(" ")?new Error(`Cocos2dx root [${y}] can't include space.`):(h=t.join(y,"tools/cocos2d-console/bin"),S="darwin"===process.platform?t.join(h,"cocos"):t.join(h,"cocos.py"),null)}function B(e,o){if(_=e.platform,!(P=e.template))return o&&o(new Error("Template is empty, please select a template.")),void 0;O=e.buildPath,v=e.dest,C=e.projectName||e.title||t.basename(e.project),x=e[_].packageName||"com.fireball."+C,b=e.debug,I=e.useDebugKeystore,$=I?Editor.url("unpack://static/build-templates/native/debug.keystore"):e.keystorePath,"win32"===process.platform&&($=$.replace(/\\/g,"/")),A=I?123456:e.keystorePassword,R=I?"debug_keystore":e.keystoreAlias,k=I?123456:e.keystoreAliasPassword;let n=function(e){e=e||{},m=f.get("show-console-log");let o=K();if(o)return o;let i=e.ndkRoot||f.get("ndk-root"),n=e.androidSDKRoot||f.get("android-sdk-root"),a=e.openharmonySDK||f.get("openharmony-sdk")||"";j={COCOS_FRAMEWORKS:t.join(y,"../"),COCOS_X_ROOT:y,COCOS_CONSOLE_ROOT:h,NDK_ROOT:i,ANDROID_SDK_ROOT:n,OPENHARMONY_SDK_ROOT:a},w="";for(let e in j)""!==w&&(w+=";"),w+=`${e}=${j[e]}`;function s(e,t){return t?r.existsSync(t)?null:new Error(`Can't find [${e}] path: ${t}`):new Error(`[${e}] is empty, please set [${e}] in Preferences.`)}if(console.log(`native environment string : ${w}`),o=s("Cocos Console Root",h))return o;if(!r.existsSync(S))return new Error(`Can't find Cocos Console Bin: ${S}`);if("android"===_||"android-instant"===_){if(o=s("NDK Root",i))return o;if(o=s("Android SDK Root",n))return o;if(!("win32"!==process.platform||process.env.JAVA_HOME&&r.existsSync(process.env.JAVA_HOME)))return new Error("Please make sure java is installed and JAVA_HOME is in your environment")}else if("openharmony"===_&&(o=s("OpenHarmony SDK Root",a)))return o;return null}(e);return n?(o&&o(n),void 0):(n=function(){if(-1===_.indexOf("android")||I)return null;if(!$)return new Error("Keystore Path is empty, please set Keystore path");if(!r.existsSync($))return new Error(`Keystore Path [${$}] is not exists, please check Keystore path`);if(!A)return new Error("Keystore Password is empty, please set Keystore Password");if(!R)return new Error("Keystore Alias is empty, please set Keystore Alias");if(!k)return new Error("Keystore Alias Password is empty, please set Keystore Alias Password");return null}())?(o&&o(n),void 0):(a.series([e=>{if("win32"===process.platform)return e(),void 0;try{let t,r=i("python",["-V"]);r.stderr.on("data",function(e){let t=e.toString();"3"===(t=t.replace("Python ","").replace("\n",""))[0]?Editor.warn(`Checked Python Version [${t}], please use python 2.x.x version. Recommend [2.7.5] version`):Editor.log(`Checked Python Version [${t}]`)}),r.on("error",async function(r){if(t=new Error(`Can\\'t find python, please install python or check your environment, The installation of python manual: ${Editor.T("BUILDER.python27.help_url")}, detail info: ${r}`),"string"!=typeof Editor._buildCommand&&"string"!=typeof Editor._compileCommand){0===await Editor.Dialog.messageBox({type:"error",buttons:[Editor.T("BUILDER.python27.link_manual"),Editor.T("MESSAGE.sure")],message:Editor.T("BUILDER.python27.message"),detail:Editor.T("BUILDER.python27.detail",{err:r.stack}),defaultId:0,noLink:!0})&&await s.shell.openExternal(Editor.T("BUILDER.python27.help_url"))}e(t)}),r.on("exit",function(){e(t)})}catch(t){e(new Error("Can't find python, please install python or check your environment"))}},e=>{let t=M(["-v"]);if(t.error)return e(t.error);let r=t.child;r.stdout.on("data",function(e){E=e.toString()}),r.stderr.on("data",function(e){Editor.failed(e.toString())}),r.on("exit",function(){e()}),r.on("error",function(t){e(t)})},e=>{let o=t.join(h,"../../../"),i=t.join(o,"version"),n=t.join(o,"cocos/cocos2d.cpp"),a=t.join(o,"frameworks/js-bindings/bindings/manual/ScriptingCore.h");if(r.existsSync(i))F=r.readFileSync(i,"utf8");else{let e=null,t=null;if(r.existsSync(n)?(e=n,t='.*return[ \t]+"(.*)";'):r.existsSync(a)&&(e=a,t='.*#define[ \t]+ENGINE_VERSION[ \t]+"(.*)"'),e){let o=r.readFileSync(e,"utf8").match(t);o&&(F=o[1])}}if(F){let e=F.match("([0-9]+)[.]([0-9]+)");e&&(D=parseInt(e[1]),T=parseInt(e[2]))}e()}],e=>{o&&o(e)}),void 0)}function U(e,o){let i=require("ini"),n=t.join(e,"cocos2d.ini");if(!r.existsSync(n))return Editor.failed(`Can't find ${n}`),null;let a=i.parse(r.readFileSync(n,"utf-8"));a.paths.templates||(a.paths.templates="../../../templates"),a.engineMode=a.global.cocos2d_x_mode,a.templatesPath=t.join(e,a.paths.templates);let s=t.join(a.templatesPath,"js-template-*");a.templates=[],l(s,(e,r)=>{r.forEach(e=>{e=t.normalize(e);let r=t.basename(e);r=r.replace("js-template-",""),a.templates.push(r)}),o&&o(a)})}const W=26;const H=26;function V(e){let t="utf-8",o=r.readFileSync(Editor.url("unpack://utils/locale-encoding.py"));try{let r;try{r="darwin"===process.platform?i("python",["-c",o]):i(L,["-c",o])}catch(t){return e&&e(t),void 0}r.stdout.on("data",function(e){let r=e.toString();r&&(t=r)}),r.stderr.on("data",function(e){Editor.failed(e.toString())}),r.on("exit",function(){e&&e(null,t)}),r.on("error",function(t){e&&(t&&"spawn python ENOENT"===t.message&&(t=new Error(Editor.T("BUILDER.python27.no_found",{help_url:Editor.T("BUILDER.python27.help_url"),err:t}))),e(t))})}catch(r){Editor.log("Get locale encoding failed, use utf-8 encoding"),e&&e(null,t)}}function J(t,o,i){let n="utf-8",a={logFilePath:g,disableEditorLog:!m,useSystemEncoding:!0,prefix:""};function s(){let a;o.logFilePath&&(r.ensureFileSync(o.logFilePath),a=r.createWriteStream(o.logFilePath,{defaultEncoding:n})),t.stdout.on("data",t=>{if(a&&a.write(t),o.disableEditorLog)return;let r;(r="win32"===process.platform?e.decode(t,n):t.toString()).length>1&&(r=r.replace(/\n*$/g,"")),r.split("\n").forEach(e=>{o.prefix&&(e=o.prefix+" : "+e),Editor.log(e)})}),t.stderr.on("data",t=>{if(a&&a.write(t),o.disableEditorLog)return;let r;r="win32"===process.platform?e.decode(t,n):t.toString(),o.prefix&&(r=o.prefix+" : "+r),-1!==r.toLowerCase().indexOf("warning")?Editor.warn(r):Editor.failed(r)}),t.on("exit",(e,r)=>{a&&a.close(),i.call(t,null,e,r)}),t.on("error",function(e){i.call(t,e)})}if("function"==typeof o?(i=o,o=a):o=Object.assign(a,o),o.useSystemEncoding)return V((e,t)=>{n=t,s()}),void 0;s()}function q(){if("binary"!==P)return null;let e=t.join(y,"prebuilt",_);return r.existsSync(e)?null:new Error(`Can't find prebuilt libs for platform [${_}]. Please compile prebuilt libs first`)}function z(e){if(-1===_.indexOf("android"))return;I&&($=Editor.url("unpack://static/build-templates/native/debug.keystore")),"win32"===process.platform&&($=$.replace(/\\/g,"/"));let o=t.join(v,"frameworks/runtime-src/proj.android-studio/gradle.properties");if(r.existsSync(o)){let i=r.readFileSync(o,"utf-8");i=(i=(i=(i=(i=(i=i.replace(/RELEASE_STORE_FILE=.*/,`RELEASE_STORE_FILE=${$}`)).replace(/RELEASE_STORE_PASSWORD=.*/,`RELEASE_STORE_PASSWORD=${A}`)).replace(/RELEASE_KEY_ALIAS=.*/,`RELEASE_KEY_ALIAS=${R}`)).replace(/RELEASE_KEY_PASSWORD=.*/,`RELEASE_KEY_PASSWORD=${k}`)).replace(/PROP_TARGET_SDK_VERSION=.*/,`PROP_TARGET_SDK_VERSION=${Y(e.apiLevel)}`)).replace(/PROP_COMPILE_SDK_VERSION=.*/,`PROP_COMPILE_SDK_VERSION=${Y(e.apiLevel)}`);let n=e.appABIs&&e.appABIs.length>0?e.appABIs.join(":"):"armeabi-v7a";i=i.replace(/PROP_APP_ABI=.*/g,`PROP_APP_ABI=${n}`),r.writeFileSync(o,i),i="",i+=`ndk.dir=${j.NDK_ROOT}\n`,i+=`sdk.dir=${j.ANDROID_SDK_ROOT}`,"win32"===process.platform&&(i=(i=i.replace(/\\/g,"\\\\")).replace(/:/g,"\\:")),r.writeFileSync(t.join(t.dirname(o),"local.properties"),i)}}function G(){let e=t.join(v,".cocos-project.json");if(!r.existsSync(e))return Editor.error(`Can't find project json [${e}]`),void 0;let o=JSON.parse(r.readFileSync(e,"utf8")),i=o.projectName,n=o.packageName,a=i!==C,s=n!==x;if(!a&&!s)return;let l=t.join(v,"cocos-project-template.json");if(!r.existsSync(l))return Editor.error(`Can't find template json [${l}]`),void 0;let c,d=JSON.parse(r.readFileSync(l,"utf8")).do_add_native_support;s&&(c=(c=(c=d.project_replace_package_name.files).concat(d.project_replace_mac_bundleid.files)).concat(d.project_replace_ios_bundleid.files)).forEach(function(e){let o=t.join(v,e);if(!r.existsSync(o))return Editor.error(`Can't not find file [${e}], replace package name failed`),void 0;let i=r.readFileSync(o,"utf8");i=i.replace(new RegExp(n,"gm"),x),r.writeFileSync(o,i)}),a&&((c=d.project_replace_project_name.files).forEach(e=>{let o=t.join(v,e.replace("PROJECT_NAME",i));if(!r.existsSync(o))return Editor.error(`Can't not find file [${o}], replace project name failed`),void 0;let n=r.readFileSync(o,"utf8");n=n.replace(new RegExp(i,"gm"),C),r.writeFileSync(o,n)}),(c=d.project_rename.files).forEach(e=>{let o=t.join(v,e.replace("PROJECT_NAME",i));if(!r.existsSync(o))return Editor.error(`Can't not find file [${o}], replace project name failed`),void 0;let n=t.join(v,e.replace("PROJECT_NAME",C));r.renameSync(o,n)})),o.projectName=C,o.packageName=x,r.writeFileSync(e,JSON.stringify(o,null,2))}function Z(e,o){const i=require("plist");let n=t.join(v,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist");if(r.existsSync(n)){let t=r.readFileSync(n,"utf8"),o=i.parse(t),a=[];e.landscapeRight&&a.push("UIInterfaceOrientationLandscapeRight"),e.landscapeLeft&&a.push("UIInterfaceOrientationLandscapeLeft"),e.portrait&&a.push("UIInterfaceOrientationPortrait"),e.upsideDown&&a.push("UIInterfaceOrientationPortraitUpsideDown"),o.UISupportedInterfaceOrientations=a,t=i.build(o),r.writeFileSync(n,t)}let a=[t.join(v,"frameworks/runtime-src/proj.android-studio/app/AndroidManifest.xml"),t.join(v,"frameworks/runtime-src/proj.android-studio/instantapp/AndroidManifest.xml")].filter(e=>r.existsSync(e));for(let t=0,i=a.length;t<i;t++){let i=a[t],n=i.indexOf("proj.android-studio")>=0,s=/android:screenOrientation=\"[^"]*\"/,l='android:screenOrientation="unspecified"';if(e.landscapeRight&&e.landscapeLeft&&e.portrait&&e.upsideDown)l='android:screenOrientation="fullSensor"';else if(e.landscapeRight&&!e.landscapeLeft)l='android:screenOrientation="landscape"';else if(!e.landscapeRight&&e.landscapeLeft)l='android:screenOrientation="reverseLandscape"';else if(e.landscapeRight&&e.landscapeLeft)l='android:screenOrientation="sensorLandscape"';else if(e.portrait&&!e.upsideDown)l='android:screenOrientation="portrait"';else if(!e.portrait&&e.upsideDown){let e="reversePortrait";o<16&&!n&&(e="reversePortait"),l=`android:screenOrientation="${e}"`}else if(e.portrait&&e.upsideDown){let e="sensorPortrait";o<16&&!n&&(e="sensorPortait"),l=`android:screenOrientation="${e}"`}let c=r.readFileSync(i,"utf8");c=c.replace(s,l),r.writeFileSync(i,c)}}function Y(e){let t=e.match("android-([0-9]+)$"),r=-1;return t&&(r=parseInt(t[1])),r}var X=[["USE_VIDEO","VideoPlayer"],["USE_WEB_VIEW","WebView"],["USE_EDIT_BOX","EditBox"],["USE_AUDIO","Audio"],["USE_SPINE","Spine Skeleton"],["USE_DRAGONBONES","DragonBones"],["USE_SOCKET","Native Socket"]];const Q="CC_IOS_FORCE_DISABLE_JIT";function ee(e){let o=e.platform.toLowerCase();if("mac"===o){te("link"===e.template?t.join(N(),"cocos/platform/mac/CCModuleConfigMac.debug.xcconfig"):t.join(v,"frameworks/cocos2d-x/cocos/platform/mac/CCModuleConfigMac.debug.xcconfig"),e),te("link"===e.template?t.join(N(),"cocos/platform/mac/CCModuleConfigMac.release.xcconfig"):t.join(v,"frameworks/cocos2d-x/cocos/platform/mac/CCModuleConfigMac.release.xcconfig"),e)}else if("ios"===o){te("link"===e.template?t.join(N(),"cocos/platform/ios/CCModuleConfigIOS.debug.xcconfig"):t.join(v,"frameworks/cocos2d-x/cocos/platform/ios/CCModuleConfigIOS.debug.xcconfig"),e),te("link"===e.template?t.join(N(),"cocos/platform/ios/CCModuleConfigIOS.release.xcconfig"):t.join(v,"frameworks/cocos2d-x/cocos/platform/ios/CCModuleConfigIOS.release.xcconfig"),e)}else"android"===o||"android-instant"===o?function(e){let o=t.join(v,"frameworks/runtime-src/proj.android-studio/jni/CocosApplication.mk");if(!r.existsSync(o))return Editor.failed(`Can not find file ${o}`),void 0;let i=r.readFileSync(o,"utf8"),n=i;X.forEach(t=>{(function(t){let r=-1!==e.excludedModules.indexOf(t[1]);-1===i.indexOf(t[0])?i+=`${t[0]} := ${r?0:1}\n`:i=i.replace(new RegExp(`${t[0]}\\s*:=\\s*(0|1)`,"g"),`${t[0]} := ${r?0:1}`)})(t)}),n!==i&&r.writeFileSync(o,i)}(e):"win32"===o&&function(e){}()}function te(e,t){if(!r.existsSync(e))return Editor.failed(`Can not find file ${e}`),void 0;let o=r.readFileSync(e,"utf8");X.forEach(e=>{(function(e){let r=-1!==t.excludedModules.indexOf(e[1]);o=-1===o.indexOf(e[0])?o.replace(/\$\(inherited\)/,t=>t+` ${e[0]}=${r?0:1}`):o.replace(new RegExp(`${e[0]}=(0|1)`),`${e[0]}=${r?0:1}`)})(e)});let i=1;const n=Editor.Profile.load("global://features.json");n&&!n.get("iOSForceDisableJit")&&(i=t.ios.ios_enable_jit?0:1),o=-1===o.indexOf(Q)?o.replace(/\$\(inherited\)/,e=>e+` ${Q}=${i}`):o.replace(new RegExp(`${Q}=(0|1)`),`${Q}=${i}`),r.writeFileSync(e,o)}function re(e){if("mac"===_||"win32"===_){let o=t.join(e.dest,"frameworks/runtime-src/Classes/NativeConfig.h");if(!r.existsSync(o))return Editor.error("can not find NativeConfig.h at path",o),void 0;let i=r.readFileSync(o,"utf8");"mac"===_?i=(i=i.replace(/MACOS_WIN_SIZE_WIDTH \s*[0-9]+/,"MACOS_WIN_SIZE_WIDTH "+e.mac.width)).replace(/MACOS_WIN_SIZE_HEIGHT \s*[0-9]+/,"MACOS_WIN_SIZE_HEIGHT "+e.mac.height):"win32"===_&&(i=(i=i.replace(/WINDOWS_WIN_SIZE_WIDTH \s*[0-9]+/,"WINDOWS_WIN_SIZE_WIDTH "+e.win32.width)).replace(/WINDOWS_WIN_SIZE_HEIGHT \s*[0-9]+/,"WINDOWS_WIN_SIZE_HEIGHT "+e.win32.height)),r.writeFileSync(o,i,"utf8")}}let oe,ie,ne,ae,se;function le(){oe&&(ie=!0,n(oe.pid,"SIGTERM",()=>{ie=!1}),oe=null)}function ce(e){let o=!1;if("ios"===_){o=r.readdirSync(t.join(e.dest,"frameworks/runtime-src/proj.ios_mac/")).some(e=>e.endsWith(".xcworkspace"))}return o}function de(e){Editor.log("Begin generate Android App Bundle...");let o="android-instant"===_,n=o?":instantapp:bundle":"bundle",a=t.join(v,"frameworks/runtime-src/proj.android-studio"),s="win32"===process.platform?".\\gradlew.bat":"./gradlew",l=i(s,[`${n}${b?"Debug":"Release"}`],{cwd:a});l.on("exit",i=>{if(0===i){let e,i=`${C}-${b?"debug":"release"}.aab`;try{e=t.join(a,`app/build/outputs/bundle/${b?"debug":"release"}/${C}.aab`),r.accessSync(e)}catch(r){e=t.join(a,`app/build/outputs/bundle/${b?"debug":"release"}/${i}`)}o&&(e=t.join(a,`instantapp/build/outputs/bundle/${b?"debug":"release"}/instantapp-${b?"debug":"release"}.aab`)),r.copySync(e,t.join(v,b?"simulator":"publish","android",`${C}-${b?"debug":"release"}.aab`))}else Editor.warn("generate Android App Bundle fail");e&&e()}),l.stdout.on("data",e=>{Editor.log(`stdout: ${e}`)}),l.stderr.on("data",e=>{Editor.error(`stderr: ${e}`)})}function pe(){ne&&(n(ne.pid),ne=null)}function ue(){ae&&(n(ae.pid),ae=null,Editor.Panel.close("simulator-debugger"))}let fe,ge=p.throttle(function(n){ue(),function(){try{let e=Editor.Profile.load("local://settings.json");e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json"));let o=e.get("use-default-cpp-engine")?void 0:e.get("cpp-engine-path"),i=u.getSimulatorConfigAt(o),n=i.init_cfg;const a=Editor.Profile.load("project://project.json");if(a.get("use-project-simulator-setting")){let e=a.get("simulator-resolution");n.width=e.width,n.height=e.height,n.isLandscape=a.get("simulator-orientation"),se=a.get("clear-simulator-cache")}else{let t=e.get("simulator-resolution"),r=i.simulator_screen_size[t]||e.get("simulator-customsize-resolution");n.width=r.width,n.height=r.height,n.isLandscape=e.get("simulator-orientation"),se=e.get("clear-simulator-cache")}se="boolean"!=typeof se||se;let s=u.getSimulatorConfigPath(o);r.existsSync(t.dirname(s))&&r.writeJsonSync(s,i,"utf-8")}catch(e){Editor.error(e)}}();let s,l,c,d=Editor.Profile.load("global://settings.json");d&&d.get("simulator-debugger")&&Editor.Panel.open("simulator-debugger");let p=Editor.url("unpack://static/simulator/"),f="utf-8";"darwin"===process.platform?(c=Editor.url("unpack://simulator/mac/Simulator.app"),s=t.join(c,"Contents/MacOS/Simulator"),l=t.join(c,"Contents/Resources")):"win32"===process.platform&&(c=Editor.url("unpack://simulator/win32"),s=t.join(c,"Simulator.exe"),l=c);let g=Editor.url("unpack://engine/bin");[{src:t.join(g,"cocos2d-jsb-for-preview.js"),dst:t.join(l,"src/cocos2d-jsb.js")},{src:t.join(p,"asset-record-pipe.js"),dst:t.join(l,"src/asset-record-pipe.js")},{src:t.join(p,"simulator-config.js"),dst:t.join(l,"src/simulator-config.js")},{src:Editor.url("packages://jsb-adapter/bin"),dst:t.join(l,"jsb-adapter")}].forEach(e=>{r.copySync(e.src,e.dst)}),o.sync(t.join(l,"assets").replace(/\\/g,"/"),{force:!0}),se&&o.sync(t.join(l,"gamecaches").replace(/\\/g,"/"),{force:!0}),a.series([e=>{if(n){r.ensureDirSync(n.recordPath),r.emptyDirSync(n.recordPath),"win32"===process.platform&&(n.recordPath=n.recordPath.replace(/\\/g,"/"));let e=r.readFileSync(t.join(p,"simulator-config.js"),"utf-8");e=(e=e.replace(/CC_SIMULATOR_RECORD_MODE\s=\sfalse/g,"CC_SIMULATOR_RECORD_MODE = true")).replace(/CC_SIMULATOR_RECORD_PATH\s=\s""/g,`CC_SIMULATOR_RECORD_PATH = "${n.recordPath}"`),r.writeFileSync(t.join(l,"src/simulator-config.js"),e)}e()},e=>{let o=r.readFileSync(t.join(p,"main.js"),"utf-8"),i=t.join(Editor.Project.path,"library/imports"),n=Editor.Project.path,a=Editor.ProjectCompiler.DEST_PATH;"win32"===process.platform&&(i=i.replace(/\\/g,"/"),n=n.replace(/\\/g,"/"),a=a.replace(/\\/g,"/")),o=(o=(o=(o=o.replace(/{importPath}/g,`'${i}/'`)).replace(/{nativePath}/g,`'${i}/'`)).replace(/{scriptPath}/g,`'${n}/'`)).replace(/{tempScriptsPath}/g,`'${a}/'`);let s=u.getSimulatorConfigAt();s&&s.init_cfg.waitForConnect&&(o="debugger\n"+o),r.writeFileSync(t.join(l,"main.js"),o),e()},e=>{var o=Editor.isWin32?"win32":"mac";Editor.PreviewServer.query("settings.js",o,(o,i)=>{if(o)return e(o),void 0;r.writeFileSync(t.join(l,"src/settings.js"),i),e()})},e=>{(async()=>{const o=require("../share/bundle-utils");let i=await o.queryBundleFolders();i.push({name:"main"}),a.eachSeries(i,(e,o)=>{r.outputFileSync(t.join(l,`assets/${e.name}/index.js`)," "),Editor.PreviewServer.query(`${e.name}/config.json`,Editor.isWin32?"win32":"mac",(i,n)=>{if(i)return o(i),void 0;r.outputFileSync(t.join(l,`assets/${e.name}/config.json`),n),o()})},t=>{e(t)})})()},e=>{let o=t.join(l,"preview-scene.json");Editor.PreviewServer.getPreviewScene(function(t){e(t)},function(t){r.writeFile(o,t,e)},function(t){r.copy(t,o,e)})},e=>{V((t,r)=>{f=r,e(t)})}],t=>{if(t)return Editor.failed(t),void 0;let r=["-workdir",l,"-writable-path",l,"-console","false","--env",w];try{ae=i(s,r)}catch(t){return Editor.error(t),void 0}finally{ge.cancel()}let o=(e,t)=>{if(e)return Editor.error(e),void 0;0===t&&(ae=null)};ae.stderr.on("data",t=>{let r;(r="win32"===process.platform?e.decode(t,f):t.toString()).length>1&&(r=r.replace(/\n*$/g,""));let o="error";-1!==r.toLowerCase().indexOf("warning")&&(o="warn"),Editor.Ipc.sendToPanel("scene","scene:print-simulator-log",r,o)}),ae.stdout.on("data",t=>{let r;(r="win32"===process.platform?e.decode(t,f):t.toString()).length>1&&(r=r.replace(/\n*$/g,""));let o=r.split("\n");o.forEach(e=>{Editor.Ipc.sendToPanel("scene","scene:print-simulator-log",e)})}),ae.on("close",(e,t)=>{o.call(ae,null,e,t),Editor.Panel.close("simulator-debugger")}),ae.on("error",function(e){o.call(ae,e),Editor.Panel.close("simulator-debugger")})})},2e3,{trailing:!1});module.exports={build:function(e,i){B(e,n=>{if(n=n||q())return i&&i(n),void 0;let a=Y(e.apiLevel);if(a=a>0?a:W,!r.existsSync(v)){Editor.log("Creating native cocos project to ",v);let s="tempCocosProject",l=t.join(O,s);if(r.existsSync(l))try{o.sync(l.replace(/\\/g,"/"),{force:!0})}catch(n){return i&&i(n),void 0}Editor.Ipc.sendToMain("builder:state-changed","creating native project",.05);let c=M(["new",s,"-l","js","-d",O,"-t",P,"--env",w]);return c.error?(i&&i(c.error),void 0):(J(c.child,(n,c)=>n?(i&&i(n),void 0):0!==c?(i&&i(new Error("Failed to create project with exitCode : "+c)),void 0):(r.rename(l,v,n=>{if(n)return i&&i(n),void 0;U(h,n=>{let l=t.join(n.templatesPath,"js-template-"+P),c=t.join(l,"cocos-project-template.json"),d=t.join(v,"cocos-project-template.json");r.copySync(c,d);try{(function(e,o){let i=t.join(v,".cocos-project.json"),n=JSON.parse(r.readFileSync(i,"utf8"));n.projectName=e,n.packageName=o,r.writeFileSync(i,JSON.stringify(n,null,2))})(s,"org.cocos2dx."+s),void("win32"!==process.platform&&[t.join(v,"frameworks/runtime-src/proj.android-studio/app/jni/Application.mk")].forEach(e=>{let t=r.readFileSync(e,"utf8").split("\n");for(let e=0;e<t.length;e++){let r=t[e];r.match(/\bAPP_SHORT_COMMANDS\b.*:=.*true/)&&(t[e]="#"+r)}r.writeFileSync(e,t.join("\n"))})),G(),function(){if("android-instant"!==P){let e=t.join(v,`frameworks/runtime-src/proj.ios_mac/${C}.xcodeproj/project.pbxproj`);if(r.existsSync(e)){let o=r.readFileSync(e,"utf8");o=o.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,t.resolve(y)),r.writeFileSync(e,o)}else Editor.warn(`Can't find path [${e}]. Replacing project file failed`)}let e=[t.join(v,"frameworks/runtime-src/proj.android-studio/build-cfg.json"),t.join(v,"frameworks/runtime-src/proj.android-studio/settings.gradle"),t.join(v,"frameworks/runtime-src/proj.android-studio/app/build.gradle"),t.join(v,"frameworks/runtime-src/proj.android-studio/instantapp/build.gradle")];"android-instant"!==P&&(e.push(t.join(v,"frameworks/runtime-src/proj.win32/build-cfg.json")),e.push(t.join(v,`frameworks/runtime-src/proj.win32/${C}.vcxproj`)),e.push(t.join(v,`frameworks/runtime-src/proj.win32/${C}.sln`))),"link"===P&&(e.push(t.join(v,"frameworks/runtime-src/proj.ios_mac/ios/UserConfigIOS.debug.xcconfig")),e.push(t.join(v,"frameworks/runtime-src/proj.ios_mac/ios/UserConfigIOS.release.xcconfig")),e.push(t.join(v,"frameworks/runtime-src/proj.ios_mac/mac/UserConfigMac.debug.xcconfig")),e.push(t.join(v,"frameworks/runtime-src/proj.ios_mac/mac/UserConfigMac.release.xcconfig"))),e.forEach(e=>{if(!r.existsSync(e))return Editor.warn(`Replace file [${e}] not find.`),void 0;let o=r.readFileSync(e,"utf8"),i=t.resolve(y),n=t.basename(e);"build-cfg.json"!==n&&"settings.gradle"!==n&&"build.gradle"!==n||(i=i.replace(/\\/g,"/")),o=(o=o.replace(/\$\{COCOS_X_ROOT\}/g,i)).replace(/\$\(COCOS_X_ROOT\)/g,i),r.writeFileSync(e,o)})}(),function(){try{o.sync(t.join(v,"asset").replace(/\\/g,"/"),{force:!0}),o.sync(t.join(v,"src").replace(/\\/g,"/"),{force:!0})}catch(e){Editor.error(e)}}(),z(e),Z(e.orientation,a),ee(e),re(e)}catch(e){return i&&i(e),void 0}i&&i()})}),void 0)),void 0)}try{G(),z(e),Z(e.orientation,a),function(){let e=t.join(v,".cocos-project.json");if(!r.existsSync(e))return Editor.failed(`Can't find project json [${e}]`),void 0;let o=JSON.parse(r.readFileSync(e,"utf8")).engine_version;o!==F&&Editor.failed(`Project version [${o}] not match cocos2d-x-lite version [${F}]. Please delete your build path, then rebuild project.`)}(),ee(e),re(e)}catch(n){return i&&i(n),void 0}i&&i()})},compile:function(e,t){Editor.Ipc.sendToMain("builder:state-changed","init settings",0),B(e,o=>{if(o=o||q())return t&&t(o),void 0;if(!r.existsSync(v))return t&&t(new Error(`Can't find ${v}, please first build project`)),void 0;Editor.Ipc.sendToMain("builder:state-changed","compile native",.1),Editor.log("Start to compile native project. Please wait..."),Editor.log(`The log file path [ ${g} ]`);let i=["compile","-p","android-instant"===_?"android":_,"-m",b?"debug":"release","--compile-script",0,"--env",w],n={cwd:v};"android-instant"===_&&i.push("--instant-game"),ce(e)&&i.push("--xcworkspace");let a=W;if("android"===_||"android-instant"===_){if(i.push("--android-studio"),e.apiLevel){let t=Y(e.apiLevel);t>0&&(i.push("--ap"),i.push(e.apiLevel),a=t)}e.appABIs&&e.appABIs.length>0&&(i.push("--app-abi"),i.push(e.appABIs.join(":")))}if("win32"===_){let t="";t="auto"===e.vsVersion?"2015":e.vsVersion,i.push("--vs"),i.push(t)}Z(e.orientation,a);let s=M(i,n);if(s.error)return t&&t(s.error),void 0;let l=.1;function c(){(l+=5e-4)>.9&&(l=.9),Editor.Ipc.sendToMain("builder:state-changed","compile native",l)}(oe=s.child).stdout.on("data",()=>{c()}),oe.stderr.on("data",()=>{c()}),J(oe,async(r,o,i)=>{if(r)return t&&t(r),void 0;if(oe=null,0===o){if(e.appBundle&&("android-instant"===_||"android"===_)){const{promisify:e}=require("util");await e(de)()}Editor.Ipc.sendToMain("builder:state-changed","finish",1),Editor.log("Compile native project successfully.")}else{if(!ie&&"SIGTERM"!==i)return t&&t(new Error(`Compile failed. The log file path [ ${g} ]`)),void 0;Editor.log("Compile native project exited normal")}t&&t()})})},encryptJsFiles:function(e,i,n){B(e,a=>{if(a)return n&&n(a),void 0;if(!r.existsSync(v))return n&&n(new Error(`Can't find ${v}, please first build project`)),void 0;if(!e.xxteaKey)return n&&n(new Error("xxtea key is empty.")),void 0;(function(e){let o=t.join(v,"frameworks/runtime-src/Classes/AppDelegate.cpp");if(!r.existsSync(o))return Editor.warn(`Can't find path [${o}]`),void 0;let i=r.readFileSync(o,"utf8").split("\n");for(let t=0;t<i.length;t++)-1!==i[t].indexOf("jsb_set_xxtea_key")&&(i[t]=`    jsb_set_xxtea_key("${e.xxteaKey}");`);r.writeFileSync(o,i.join("\n"))})(e);let s=[t.join(v,"src","**/*.js")].concat(i.map(e=>t.join(e,"**/*.js")));l(s,(i,a)=>{if(i)return n&&n(i),void 0;a.forEach(i=>{i=t.normalize(i);try{let n=r.readFileSync(i,"utf8");e.zipCompressJs?(n=d.gzipSync(n),n=c.encrypt(n,c.toBytes(e.xxteaKey))):n=c.encrypt(c.toBytes(n),c.toBytes(e.xxteaKey)),r.writeFileSync(t.join(t.dirname(i),t.basenameNoExt(i))+".jsc",n),o.sync(i.replace(/\\/g,"/"),{force:!0})}catch(e){Editor.warn(e)}}),n&&n()})})},run:function(e,o){pe(),Editor.log("Start to run project"),B(e,n=>{if(n)return o&&o(n),void 0;if(!r.existsSync(v))return o&&o(new Error(`Can't find ${v}, please first build project`)),void 0;Editor.log("Start to run project. Please wait..."),Editor.log(`The log file path [ ${g} ]`);let a=["run","-p","android-instant"===_?"android":_,"-m",b?"debug":"release","--env",w,"--compile-script",0],s={cwd:v};if("android-instant"===_){let t=e["android-instant"];a.push("--instant-game"),t.scheme&&t.host&&t.pathPattern&&(a.push("--launch-url"),a.push(`${t.scheme}://${t.host}${t.pathPattern}`))}ce(e)&&a.push("--xcworkspace");let l=W;if("android"===_||"android-instant"===_){if(a.push("--android-studio"),e.apiLevel){let t=Y(e.apiLevel);t>0&&(a.push("--ap"),a.push(e.apiLevel),l=t)}e.appABIs&&e.appABIs.length>0&&(a.push("--app-abi"),a.push(e.appABIs.join(":")))}if("win32"===_&&"auto"!==e.vsVersion&&(a.push("--vs"),a.push(e.vsVersion)),Z(e.orientation,l),"win32"===process.platform&&"win32"===_){let e;e=b?t.join(v,"simulator/win32",C+".exe"):t.join(v,"publish/win32",C+".exe");try{ne=i(e,{},s)}catch(n){return o&&o(n),void 0}}else{let e=M(a,s);if(e.error)return o&&o(e.error),void 0;ne=e.child}J(ne,(e,t)=>e?(o&&o(e),void 0):0!==t?(o&&o(new Error(`Failed to run project. The log file path [ ${g} ]`)),void 0):(o&&o(),void 0))})},runSimulator:ge,saveKeystore:function(e,n){let a="keytool";if("win32"===process.platform){if(!process.env.JAVA_HOME||!r.existsSync(process.env.JAVA_HOME))return n&&n(new Error("Please make sure java is installed and JAVA_HOME is in your environment")),void 0;if(a=t.join(process.env.JAVA_HOME,"bin/keytool.exe"),!r.existsSync(a))return n&&n(new Error(`Can't find path [${a}]. Please make sure JAVA_HOME is in your environment and exists`)),void 0}let s=e.dest;r.existsSync(s)&&o.sync(s.replace(/\\/g,"/"),{force:!0});let l=[];e.commonName&&l.push(`CN=${e.commonName}`),e.organizationalUnit&&l.push(`OU=${e.organizationalUnit}`),e.organization&&l.push(`O=${e.organization}`),e.locality&&l.push(`L=${e.locality}`),e.state&&l.push(`S=${e.state}`),e.country&&l.push(`C=${e.country}`),l=l.join(",");let c=["-genkey","-keyalg","RSA","-keysize","1024","-validity",e.validity,"-keystore",t.basename(s),"-storepass",e.password,"-alias",e.alias,"-keypass",e.aliasPassword,"-dname",l];Editor.log("Creating keystore : ",c.join(" "));let d,p={cwd:t.dirname(s)};try{d=i(a,c,p)}catch(e){return n&&n(e),void 0}J(d,(e,t)=>e?(n&&n(e),void 0):0!==t?(n&&n(new Error("Failed to create keystore, please check the log information")),void 0):(n(),void 0))},openNativeLogFile:function(){r.ensureFileSync(g),s.shell.openPath(g)},stopCompile:le,getCocosTemplates:function(e){let r=Editor.Profile.load("local://settings.json");!1!==r.get("use-global-engine-setting")&&(r=Editor.Profile.load("global://settings.json")),r.get("use-default-cpp-engine")?(y=Editor.builtinCocosRoot,Editor.dev&&!y&&Editor.error("Can not find builtin cocos2d-x, please run 'gulp update-externs'.")):(y=r.get("cpp-engine-path"))||Editor.error("Can not find cocos engine."),U(t.join(y,"tools","cocos2d-console","bin"),t=>{e&&e(null,t.templates)})},getAndroidAPILevels:function(e){let o=f.get("android-sdk-root");if(!r.isDirSync(o))return e(null,[]),void 0;let i=t.join(o,"platforms","android-*");l(i,(o,i)=>{let n=[];i.forEach(e=>{e=t.normalize(e);let o=t.basename(e);Y(o)>=W&&r.isDirSync(e)&&n.push(o)}),e&&e(null,n)})},getAndroidInstantAPILevels:function(e){let o=f.get("android-sdk-root");if(!r.isDirSync(o))return e(null,[]),void 0;let i=t.join(o,"platforms","android-*");l(i,(o,i)=>{let n=[];i.forEach(e=>{e=t.normalize(e);let o=t.basename(e);Y(o)>=H&&r.isDirSync(e)&&n.push(o)}),e&&e(null,n)})},stop:function(){le(),pe(),ue(),fe&&(n(fe.pid),fe=null)},showLogInConsole:m,getCocosSpawnProcess:M,getCocosRoot:N};