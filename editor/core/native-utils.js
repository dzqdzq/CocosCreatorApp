"use strict";const e=require("iconv-lite"),t=require("fire-path"),i=require("fire-fs"),r=require("del"),o=require("child_process").spawn,n=require("tree-kill"),a=require("async"),s=require("electron"),l=require("globby"),c=require("xxtea-node"),d=require("zlib"),p=require("lodash"),u=Editor.require("app://share/engine-utils"),f=Editor.Profile.load("global://settings.json");let g=t.join(Editor.App.home,"logs/native.log"),m=f.get("show-console-log");let E,j,S,h,y,w,_,v,O,C,x,b,P,$,I,A,k,R,F=-1,D=-1,N="",T=Editor.url("unpack://utils/Python27/python");function M(){let e=Editor.Profile.load("local://settings.json");return!1!==e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json")),e.get("use-default-cpp-engine")?Editor.builtinCocosRoot:e.get("cpp-engine-path")}function L(e,i){var r;let n=K();if(n)return[n,r];e=[h].concat(e);try{if("darwin"===process.platform)r=o("sh",e,i);else{let n=e.indexOf("--env"),a="COCOS_PYTHON_HOME="+t.dirname(T);n>=0?n===e.length-1?e.push(a):e[n+1]+=";"+a:(e.push("--env"),e.push(a)),r=o(T,e,i)}}catch(e){n=e}return{error:n,child:r}}function K(){return S=M(),console.log("Cocos2dx root: "+S),-1!==S.indexOf(" ")?new Error(`Cocos2dx root [${S}] can't include space.`):(j=t.join(S,"tools/cocos2d-console/bin"),h="darwin"===process.platform?t.join(j,"cocos"):t.join(j,"cocos.py"),null)}function W(e,r){if(_=e.platform,!(P=e.template))return r&&r(new Error("Template is empty, please select a template.")),void 0;v=e.buildPath,O=e.dest,C=e.projectName||e.title||t.basename(e.project),x=e[_].packageName||"com.fireball."+C,b=e.debug,$=e.useDebugKeystore,I=$?Editor.url("unpack://static/build-templates/native/debug.keystore"):e.keystorePath,"win32"===process.platform&&(I=I.replace(/\\/g,"/")),A=$?123456:e.keystorePassword,k=$?"debug_keystore":e.keystoreAlias,R=$?123456:e.keystoreAliasPassword;let n=function(e){e=e||{},m=f.get("show-console-log");let r=K();if(r)return r;let o=e.ndkRoot||f.get("ndk-root"),n=e.androidSDKRoot||f.get("android-sdk-root");y={COCOS_FRAMEWORKS:t.join(S,"../"),COCOS_X_ROOT:S,COCOS_CONSOLE_ROOT:j,NDK_ROOT:o,ANDROID_SDK_ROOT:n},w="";for(let e in y)""!==w&&(w+=";"),w+=`${e}=${y[e]}`;function a(e,t){return t?i.existsSync(t)?null:new Error(`Can't find [${e}] path: ${t}`):new Error(`[${e}] is empty, please set [${e}] in Preferences.`)}if(console.log(`native environment string : ${w}`),r=a("Cocos Console Root",j))return r;if(!i.existsSync(h))return new Error(`Can't find Cocos Console Bin: ${h}`);if("android"===_||"android-instant"===_){if(r=a("NDK Root",o))return r;if(r=a("Android SDK Root",n))return r;if(!("win32"!==process.platform||process.env.JAVA_HOME&&i.existsSync(process.env.JAVA_HOME)))return new Error("Please make sure java is installed and JAVA_HOME is in your environment")}return null}(e);return n?(r&&r(n),void 0):(n=function(){if(-1===_.indexOf("android")||$)return null;if(!I)return new Error("Keystore Path is empty, please set Keystore path");if(!i.existsSync(I))return new Error(`Keystore Path [${I}] is not exists, please check Keystore path`);if(!A)return new Error("Keystore Password is empty, please set Keystore Password");if(!k)return new Error("Keystore Alias is empty, please set Keystore Alias");if(!R)return new Error("Keystore Alias Password is empty, please set Keystore Alias Password");return null}())?(r&&r(n),void 0):(a.series([e=>{if("win32"===process.platform)return e(),void 0;try{let t,i=o("python",["-V"]);i.stderr.on("data",function(e){let t=e.toString();"3"===(t=t.replace("Python ","").replace("\n",""))[0]?Editor.warn(`Checked Python Version [${t}], please use python 2.x.x version. Recommend [2.7.5] version`):Editor.log(`Checked Python Version [${t}]`)}),i.on("error",function(){t=new Error("Can't find python, please install python or check your environment")}),i.on("exit",function(){e(t)})}catch(t){e(new Error("Can't find python, please install python or check your environment"))}},e=>{let t=L(["-v"]);if(t.error)return e(t.error);let i=t.child;i.stdout.on("data",function(e){E=e.toString()}),i.stderr.on("data",function(e){Editor.failed(e.toString())}),i.on("exit",function(){e()}),i.on("error",function(t){e(t)})},e=>{let r=t.join(j,"../../../"),o=t.join(r,"version"),n=t.join(r,"cocos/cocos2d.cpp"),a=t.join(r,"frameworks/js-bindings/bindings/manual/ScriptingCore.h");if(i.existsSync(o))N=i.readFileSync(o,"utf8");else{let e=null,t=null;if(i.existsSync(n)?(e=n,t='.*return[ \t]+"(.*)";'):i.existsSync(a)&&(e=a,t='.*#define[ \t]+ENGINE_VERSION[ \t]+"(.*)"'),e){let r=i.readFileSync(e,"utf8").match(t);r&&(N=r[1])}}if(N){let e=N.match("([0-9]+)[.]([0-9]+)");e&&(F=parseInt(e[1]),D=parseInt(e[2]))}e()}],e=>{r&&r(e)}),void 0)}function B(e,r){let o=require("ini"),n=t.join(e,"cocos2d.ini");if(!i.existsSync(n))return Editor.failed(`Can't find ${n}`),null;let a=o.parse(i.readFileSync(n,"utf-8"));a.paths.templates||(a.paths.templates="../../../templates"),a.engineMode=a.global.cocos2d_x_mode,a.templatesPath=t.join(e,a.paths.templates);let s=t.join(a.templatesPath,"js-template-*");a.templates=[],l(s,(e,i)=>{i.forEach(e=>{e=t.normalize(e);let i=t.basename(e);i=i.replace("js-template-",""),a.templates.push(i)}),r&&r(a)})}const H=26;const U=26;function V(e){let t="utf-8",r=i.readFileSync(Editor.url("unpack://utils/locale-encoding.py"));try{let i;try{i="darwin"===process.platform?o("python",["-c",r]):o(T,["-c",r])}catch(t){return e&&e(t),void 0}i.stdout.on("data",function(e){let i=e.toString();i&&(t=i)}),i.stderr.on("data",function(e){Editor.failed(e.toString())}),i.on("exit",function(){e&&e(null,t)}),i.on("error",function(t){e&&e(t)})}catch(i){Editor.log("Get locale encoding failed, use utf-8 encoding"),e&&e(null,t)}}function J(t,r,o){let n="utf-8",a={logFilePath:g,disableEditorLog:!m,useSystemEncoding:!0,prefix:""};function s(){let a;r.logFilePath&&(i.ensureFileSync(r.logFilePath),a=i.createWriteStream(r.logFilePath,{defaultEncoding:n})),t.stdout.on("data",t=>{if(a&&a.write(t),r.disableEditorLog)return;let i;(i="win32"===process.platform?e.decode(t,n):t.toString()).length>1&&(i=i.replace(/\n*$/g,"")),i.split("\n").forEach(e=>{r.prefix&&(e=r.prefix+" : "+e),Editor.log(e)})}),t.stderr.on("data",t=>{if(a&&a.write(t),r.disableEditorLog)return;let i;i="win32"===process.platform?e.decode(t,n):t.toString(),r.prefix&&(i=r.prefix+" : "+i),-1!==i.toLowerCase().indexOf("warning")?Editor.warn(i):Editor.failed(i)}),t.on("exit",(e,i)=>{a&&a.close(),o.call(t,null,e,i)}),t.on("error",function(e){o.call(t,e)})}if("function"==typeof r?(o=r,r=a):r=Object.assign(a,r),r.useSystemEncoding)return V((e,t)=>{n=t,s()}),void 0;s()}function q(){if("binary"!==P)return null;let e=t.join(S,"prebuilt",_);return i.existsSync(e)?null:new Error(`Can't find prebuilt libs for platform [${_}]. Please compile prebuilt libs first`)}function z(e){if(-1===_.indexOf("android"))return;$&&(I=Editor.url("unpack://static/build-templates/native/debug.keystore")),"win32"===process.platform&&(I=I.replace(/\\/g,"/"));let r=t.join(O,"frameworks/runtime-src/proj.android-studio/gradle.properties");if(i.existsSync(r)){let o=i.readFileSync(r,"utf-8");o=(o=(o=(o=(o=(o=o.replace(/RELEASE_STORE_FILE=.*/,`RELEASE_STORE_FILE=${I}`)).replace(/RELEASE_STORE_PASSWORD=.*/,`RELEASE_STORE_PASSWORD=${A}`)).replace(/RELEASE_KEY_ALIAS=.*/,`RELEASE_KEY_ALIAS=${k}`)).replace(/RELEASE_KEY_PASSWORD=.*/,`RELEASE_KEY_PASSWORD=${R}`)).replace(/PROP_TARGET_SDK_VERSION=.*/,`PROP_TARGET_SDK_VERSION=${Y(e.apiLevel)}`)).replace(/PROP_COMPILE_SDK_VERSION=.*/,`PROP_COMPILE_SDK_VERSION=${Y(e.apiLevel)}`);let n=e.appABIs&&e.appABIs.length>0?e.appABIs.join(":"):"armeabi-v7a";o=o.replace(/PROP_APP_ABI=.*/g,`PROP_APP_ABI=${n}`),i.writeFileSync(r,o),o="",o+=`ndk.dir=${y.NDK_ROOT}\n`,o+=`sdk.dir=${y.ANDROID_SDK_ROOT}`,"win32"===process.platform&&(o=(o=o.replace(/\\/g,"\\\\")).replace(/:/g,"\\:")),i.writeFileSync(t.join(t.dirname(r),"local.properties"),o)}}function G(){let e=t.join(O,".cocos-project.json");if(!i.existsSync(e))return Editor.error(`Can't find project json [${e}]`),void 0;let r=JSON.parse(i.readFileSync(e,"utf8")),o=r.projectName,n=r.packageName,a=o!==C,s=n!==x;if(!a&&!s)return;let l=t.join(O,"cocos-project-template.json");if(!i.existsSync(l))return Editor.error(`Can't find template json [${l}]`),void 0;let c,d=JSON.parse(i.readFileSync(l,"utf8")).do_add_native_support;s&&(c=(c=(c=d.project_replace_package_name.files).concat(d.project_replace_mac_bundleid.files)).concat(d.project_replace_ios_bundleid.files)).forEach(function(e){let r=t.join(O,e);if(!i.existsSync(r))return Editor.error(`Can't not find file [${e}], replace package name failed`),void 0;let o=i.readFileSync(r,"utf8");o=o.replace(new RegExp(n,"gm"),x),i.writeFileSync(r,o)}),a&&((c=d.project_replace_project_name.files).forEach(e=>{let r=t.join(O,e.replace("PROJECT_NAME",o));if(!i.existsSync(r))return Editor.error(`Can't not find file [${r}], replace project name failed`),void 0;let n=i.readFileSync(r,"utf8");n=n.replace(new RegExp(o,"gm"),C),i.writeFileSync(r,n)}),(c=d.project_rename.files).forEach(e=>{let r=t.join(O,e.replace("PROJECT_NAME",o));if(!i.existsSync(r))return Editor.error(`Can't not find file [${r}], replace project name failed`),void 0;let n=t.join(O,e.replace("PROJECT_NAME",C));i.renameSync(r,n)})),r.projectName=C,r.packageName=x,i.writeFileSync(e,JSON.stringify(r,null,2))}function Z(e,r){const o=require("plist");let n=t.join(O,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist");if(i.existsSync(n)){let t=i.readFileSync(n,"utf8"),r=o.parse(t),a=[];e.landscapeRight&&a.push("UIInterfaceOrientationLandscapeRight"),e.landscapeLeft&&a.push("UIInterfaceOrientationLandscapeLeft"),e.portrait&&a.push("UIInterfaceOrientationPortrait"),e.upsideDown&&a.push("UIInterfaceOrientationPortraitUpsideDown"),r.UISupportedInterfaceOrientations=a,t=o.build(r),i.writeFileSync(n,t)}let a=[t.join(O,"frameworks/runtime-src/proj.android-studio/app/AndroidManifest.xml"),t.join(O,"frameworks/runtime-src/proj.android-studio/instantapp/AndroidManifest.xml")].filter(e=>i.existsSync(e));for(let t=0,o=a.length;t<o;t++){let o=a[t],n=o.indexOf("proj.android-studio")>=0,s=/android:screenOrientation=\"[^"]*\"/,l='android:screenOrientation="unspecified"';if(e.landscapeRight&&e.landscapeLeft&&e.portrait&&e.upsideDown)l='android:screenOrientation="fullSensor"';else if(e.landscapeRight&&!e.landscapeLeft)l='android:screenOrientation="landscape"';else if(!e.landscapeRight&&e.landscapeLeft)l='android:screenOrientation="reverseLandscape"';else if(e.landscapeRight&&e.landscapeLeft)l='android:screenOrientation="sensorLandscape"';else if(e.portrait&&!e.upsideDown)l='android:screenOrientation="portrait"';else if(!e.portrait&&e.upsideDown){let e="reversePortrait";r<16&&!n&&(e="reversePortait"),l=`android:screenOrientation="${e}"`}else if(e.portrait&&e.upsideDown){let e="sensorPortrait";r<16&&!n&&(e="sensorPortait"),l=`android:screenOrientation="${e}"`}let c=i.readFileSync(o,"utf8");c=c.replace(s,l),i.writeFileSync(o,c)}}function Y(e){let t=e.match("android-([0-9]+)$"),i=-1;return t&&(i=parseInt(t[1])),i}var X=[["USE_VIDEO","VideoPlayer"],["USE_WEB_VIEW","WebView"],["USE_EDIT_BOX","EditBox"],["USE_AUDIO","Audio"],["USE_SPINE","Spine Skeleton"],["USE_DRAGONBONES","DragonBones"],["USE_SOCKET","Native Socket"]];const Q="CC_IOS_FORCE_DISABLE_JIT";function ee(e){let r=e.platform.toLowerCase();if("mac"===r){te("link"===e.template?t.join(M(),"cocos/platform/mac/CCModuleConfigMac.debug.xcconfig"):t.join(O,"frameworks/cocos2d-x/cocos/platform/mac/CCModuleConfigMac.debug.xcconfig"),e),te("link"===e.template?t.join(M(),"cocos/platform/mac/CCModuleConfigMac.release.xcconfig"):t.join(O,"frameworks/cocos2d-x/cocos/platform/mac/CCModuleConfigMac.release.xcconfig"),e)}else if("ios"===r){te("link"===e.template?t.join(M(),"cocos/platform/ios/CCModuleConfigIOS.debug.xcconfig"):t.join(O,"frameworks/cocos2d-x/cocos/platform/ios/CCModuleConfigIOS.debug.xcconfig"),e),te("link"===e.template?t.join(M(),"cocos/platform/ios/CCModuleConfigIOS.release.xcconfig"):t.join(O,"frameworks/cocos2d-x/cocos/platform/ios/CCModuleConfigIOS.release.xcconfig"),e)}else"android"===r||"android-instant"===r?function(e){let r=t.join(O,"frameworks/runtime-src/proj.android-studio/jni/CocosApplication.mk");if(!i.existsSync(r))return Editor.failed(`Can not find file ${r}`),void 0;let o=i.readFileSync(r,"utf8"),n=o;X.forEach(t=>{(function(t){let i=-1!==e.excludedModules.indexOf(t[1]);-1===o.indexOf(t[0])?o+=`${t[0]} := ${i?0:1}\n`:o=o.replace(new RegExp(`${t[0]}\\s*:=\\s*(0|1)`,"g"),`${t[0]} := ${i?0:1}`)})(t)}),n!==o&&i.writeFileSync(r,o)}(e):"win32"===r&&function(e){}()}function te(e,t){if(!i.existsSync(e))return Editor.failed(`Can not find file ${e}`),void 0;let r=i.readFileSync(e,"utf8");X.forEach(e=>{(function(e){let i=-1!==t.excludedModules.indexOf(e[1]);r=-1===r.indexOf(e[0])?r.replace(/\$\(inherited\)/,t=>t+` ${e[0]}=${i?0:1}`):r.replace(new RegExp(`${e[0]}=(0|1)`),`${e[0]}=${i?0:1}`)})(e)});let o=1;const n=Editor.Profile.load("global://features.json");n&&!n.get("iOSForceDisableJit")&&(o=t.ios.ios_enable_jit?0:1),r=-1===r.indexOf(Q)?r.replace(/\$\(inherited\)/,e=>e+` ${Q}=${o}`):r.replace(new RegExp(`${Q}=(0|1)`),`${Q}=${o}`),i.writeFileSync(e,r)}function ie(e){if("mac"===_||"win32"===_){let r=t.join(e.dest,"frameworks/runtime-src/Classes/NativeConfig.h");if(!i.existsSync(r))return Editor.error("can not find NativeConfig.h at path",r),void 0;let o=i.readFileSync(r,"utf8");"mac"===_?o=(o=o.replace(/MACOS_WIN_SIZE_WIDTH \s*[0-9]+/,"MACOS_WIN_SIZE_WIDTH "+e.mac.width)).replace(/MACOS_WIN_SIZE_HEIGHT \s*[0-9]+/,"MACOS_WIN_SIZE_HEIGHT "+e.mac.height):"win32"===_&&(o=(o=o.replace(/WINDOWS_WIN_SIZE_WIDTH \s*[0-9]+/,"WINDOWS_WIN_SIZE_WIDTH "+e.win32.width)).replace(/WINDOWS_WIN_SIZE_HEIGHT \s*[0-9]+/,"WINDOWS_WIN_SIZE_HEIGHT "+e.win32.height)),i.writeFileSync(r,o,"utf8")}}let re,oe,ne,ae,se;function le(){re&&(oe=!0,n(re.pid,"SIGTERM",()=>{oe=!1}),re=null)}function ce(e){let r=!1;if("ios"===_){r=i.readdirSync(t.join(e.dest,"frameworks/runtime-src/proj.ios_mac/")).some(e=>e.endsWith(".xcworkspace"))}return r}function de(e){Editor.log("Begin generate Android App Bundle...");let r="android-instant"===_,n=r?":instantapp:bundle":"bundle",a=t.join(O,"frameworks/runtime-src/proj.android-studio"),s="win32"===process.platform?".\\gradlew.bat":"./gradlew",l=o(s,[`${n}${b?"Debug":"Release"}`],{cwd:a});l.on("exit",o=>{if(0===o){let e,o=`${C}-${b?"debug":"release"}.aab`;try{e=t.join(a,`app/build/outputs/bundle/${b?"debug":"release"}/${C}.aab`),i.accessSync(e)}catch(i){e=t.join(a,`app/build/outputs/bundle/${b?"debug":"release"}/${o}`)}r&&(e=t.join(a,`instantapp/build/outputs/bundle/${b?"debug":"release"}/instantapp-${b?"debug":"release"}.aab`)),i.copySync(e,t.join(O,b?"simulator":"publish","android",`${C}-${b?"debug":"release"}.aab`))}else Editor.warn("generate Android App Bundle fail");e&&e()}),l.stdout.on("data",e=>{Editor.log(`stdout: ${e}`)}),l.stderr.on("data",e=>{Editor.error(`stderr: ${e}`)})}function pe(){ne&&(n(ne.pid),ne=null)}function ue(){ae&&(n(ae.pid),ae=null,Editor.Panel.close("simulator-debugger"))}let fe,ge=p.throttle(function(n){ue(),function(){try{let e=Editor.Profile.load("local://settings.json");e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json"));let r=e.get("use-default-cpp-engine")?void 0:e.get("cpp-engine-path"),o=u.getSimulatorConfigAt(r),n=o.init_cfg;const a=Editor.Profile.load("project://project.json");if(a.get("use-project-simulator-setting")){let e=a.get("simulator-resolution");n.width=e.width,n.height=e.height,n.isLandscape=a.get("simulator-orientation"),se=a.get("clear-simulator-cache")}else{let t=e.get("simulator-resolution"),i=o.simulator_screen_size[t]||e.get("simulator-customsize-resolution");n.width=i.width,n.height=i.height,n.isLandscape=e.get("simulator-orientation"),se=e.get("clear-simulator-cache")}se="boolean"!=typeof se||se;let s=u.getSimulatorConfigPath(r);i.existsSync(t.dirname(s))&&i.writeJsonSync(s,o,"utf-8")}catch(e){Editor.error(e)}}();let s,l,c,d=Editor.Profile.load("global://settings.json");d&&d.get("simulator-debugger")&&Editor.Panel.open("simulator-debugger");let p=Editor.url("unpack://static/simulator/"),f="utf-8";"darwin"===process.platform?(c=Editor.url("unpack://simulator/mac/Simulator.app"),s=t.join(c,"Contents/MacOS/Simulator"),l=t.join(c,"Contents/Resources")):"win32"===process.platform&&(c=Editor.url("unpack://simulator/win32"),s=t.join(c,"Simulator.exe"),l=c);let g=Editor.url("unpack://engine/bin");[{src:t.join(g,"cocos2d-jsb-for-preview.js"),dst:t.join(l,"src/cocos2d-jsb.js")},{src:t.join(p,"asset-record-pipe.js"),dst:t.join(l,"src/asset-record-pipe.js")},{src:t.join(p,"simulator-config.js"),dst:t.join(l,"src/simulator-config.js")},{src:Editor.url("packages://jsb-adapter/bin"),dst:t.join(l,"jsb-adapter")}].forEach(e=>{i.copySync(e.src,e.dst)}),r.sync(t.join(l,"assets").replace(/\\/g,"/"),{force:!0}),se&&r.sync(t.join(l,"gamecaches").replace(/\\/g,"/"),{force:!0}),a.series([e=>{if(n){i.ensureDirSync(n.recordPath),i.emptyDirSync(n.recordPath),"win32"===process.platform&&(n.recordPath=n.recordPath.replace(/\\/g,"/"));let e=i.readFileSync(t.join(p,"simulator-config.js"),"utf-8");e=(e=e.replace(/CC_SIMULATOR_RECORD_MODE\s=\sfalse/g,"CC_SIMULATOR_RECORD_MODE = true")).replace(/CC_SIMULATOR_RECORD_PATH\s=\s""/g,`CC_SIMULATOR_RECORD_PATH = "${n.recordPath}"`),i.writeFileSync(t.join(l,"src/simulator-config.js"),e)}e()},e=>{let r=i.readFileSync(t.join(p,"main.js"),"utf-8"),o=t.join(Editor.Project.path,"library/imports"),n=Editor.Project.path,a=Editor.ProjectCompiler.DEST_PATH;"win32"===process.platform&&(o=o.replace(/\\/g,"/"),n=n.replace(/\\/g,"/"),a=a.replace(/\\/g,"/")),r=(r=(r=(r=r.replace(/{importPath}/g,`'${o}/'`)).replace(/{nativePath}/g,`'${o}/'`)).replace(/{scriptPath}/g,`'${n}/'`)).replace(/{tempScriptsPath}/g,`'${a}/'`);let s=u.getSimulatorConfigAt();s&&s.init_cfg.waitForConnect&&(r="debugger\n"+r),i.writeFileSync(t.join(l,"main.js"),r),e()},e=>{var r=Editor.isWin32?"win32":"mac";Editor.PreviewServer.query("settings.js",r,(r,o)=>{if(r)return e(r),void 0;i.writeFileSync(t.join(l,"src/settings.js"),o),e()})},e=>{(async()=>{const r=require("../share/bundle-utils");let o=await r.queryBundleFolders();o.push({name:"main"}),a.eachSeries(o,(e,r)=>{i.outputFileSync(t.join(l,`assets/${e.name}/index.js`)," "),Editor.PreviewServer.query(`${e.name}/config.json`,Editor.isWin32?"win32":"mac",(o,n)=>{if(o)return r(o),void 0;i.outputFileSync(t.join(l,`assets/${e.name}/config.json`),n),r()})},t=>{e(t)})})()},e=>{let r=t.join(l,"preview-scene.json");Editor.PreviewServer.getPreviewScene(function(t){e(t)},function(t){i.writeFile(r,t,e)},function(t){i.copy(t,r,e)})},e=>{V((t,i)=>{f=i,e(t)})}],t=>{if(t)return Editor.failed(t),void 0;let i=["-workdir",l,"-writable-path",l,"-console","false","--env",w];try{ae=o(s,i)}catch(t){return Editor.error(t),void 0}finally{ge.cancel()}let r=(e,t)=>{if(e)return Editor.error(e),void 0;0===t&&(ae=null)};ae.stderr.on("data",t=>{let i;(i="win32"===process.platform?e.decode(t,f):t.toString()).length>1&&(i=i.replace(/\n*$/g,""));let r="error";-1!==i.toLowerCase().indexOf("warning")&&(r="warn"),Editor.Ipc.sendToPanel("scene","scene:print-simulator-log",i,r)}),ae.stdout.on("data",t=>{let i;(i="win32"===process.platform?e.decode(t,f):t.toString()).length>1&&(i=i.replace(/\n*$/g,""));let r=i.split("\n");r.forEach(e=>{Editor.Ipc.sendToPanel("scene","scene:print-simulator-log",e)})}),ae.on("close",(e,t)=>{r.call(ae,null,e,t),Editor.Panel.close("simulator-debugger")}),ae.on("error",function(e){r.call(ae,e),Editor.Panel.close("simulator-debugger")})})},2e3,{trailing:!1});module.exports={build:function(e,o){W(e,n=>{if(n=n||q())return o&&o(n),void 0;let a=Y(e.apiLevel);if(a=a>0?a:H,!i.existsSync(O)){Editor.log("Creating native cocos project to ",O);let s="tempCocosProject",l=t.join(v,s);if(i.existsSync(l))try{r.sync(l.replace(/\\/g,"/"),{force:!0})}catch(n){return o&&o(n),void 0}Editor.Ipc.sendToMain("builder:state-changed","creating native project",.05);let c=L(["new",s,"-l","js","-d",v,"-t",P,"--env",w]);return c.error?(o&&o(c.error),void 0):(J(c.child,(n,c)=>n?(o&&o(n),void 0):0!==c?(o&&o(new Error("Failed to create project with exitCode : "+c)),void 0):(i.rename(l,O,n=>{if(n)return o&&o(n),void 0;B(j,n=>{let l=t.join(n.templatesPath,"js-template-"+P),c=t.join(l,"cocos-project-template.json"),d=t.join(O,"cocos-project-template.json");i.copySync(c,d);try{(function(e,r){let o=t.join(O,".cocos-project.json"),n=JSON.parse(i.readFileSync(o,"utf8"));n.projectName=e,n.packageName=r,i.writeFileSync(o,JSON.stringify(n,null,2))})(s,"org.cocos2dx."+s),void("win32"!==process.platform&&[t.join(O,"frameworks/runtime-src/proj.android-studio/app/jni/Application.mk")].forEach(e=>{let t=i.readFileSync(e,"utf8").split("\n");for(let e=0;e<t.length;e++){let i=t[e];i.match(/\bAPP_SHORT_COMMANDS\b.*:=.*true/)&&(t[e]="#"+i)}i.writeFileSync(e,t.join("\n"))})),G(),function(){if("android-instant"!==P){let e=t.join(O,`frameworks/runtime-src/proj.ios_mac/${C}.xcodeproj/project.pbxproj`);if(i.existsSync(e)){let r=i.readFileSync(e,"utf8");r=r.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,t.resolve(S)),i.writeFileSync(e,r)}else Editor.warn(`Can't find path [${e}]. Replacing project file failed`)}let e=[t.join(O,"frameworks/runtime-src/proj.android-studio/build-cfg.json"),t.join(O,"frameworks/runtime-src/proj.android-studio/settings.gradle"),t.join(O,"frameworks/runtime-src/proj.android-studio/app/build.gradle"),t.join(O,"frameworks/runtime-src/proj.android-studio/instantapp/build.gradle")];"android-instant"!==P&&(e.push(t.join(O,"frameworks/runtime-src/proj.win32/build-cfg.json")),e.push(t.join(O,`frameworks/runtime-src/proj.win32/${C}.vcxproj`)),e.push(t.join(O,`frameworks/runtime-src/proj.win32/${C}.sln`))),"link"===P&&(e.push(t.join(O,"frameworks/runtime-src/proj.ios_mac/ios/UserConfigIOS.debug.xcconfig")),e.push(t.join(O,"frameworks/runtime-src/proj.ios_mac/ios/UserConfigIOS.release.xcconfig")),e.push(t.join(O,"frameworks/runtime-src/proj.ios_mac/mac/UserConfigMac.debug.xcconfig")),e.push(t.join(O,"frameworks/runtime-src/proj.ios_mac/mac/UserConfigMac.release.xcconfig"))),e.forEach(e=>{if(!i.existsSync(e))return Editor.warn(`Replace file [${e}] not find.`),void 0;let r=i.readFileSync(e,"utf8"),o=t.resolve(S),n=t.basename(e);"build-cfg.json"!==n&&"settings.gradle"!==n&&"build.gradle"!==n||(o=o.replace(/\\/g,"/")),r=(r=r.replace(/\$\{COCOS_X_ROOT\}/g,o)).replace(/\$\(COCOS_X_ROOT\)/g,o),i.writeFileSync(e,r)})}(),function(){try{r.sync(t.join(O,"asset").replace(/\\/g,"/"),{force:!0}),r.sync(t.join(O,"src").replace(/\\/g,"/"),{force:!0})}catch(e){Editor.error(e)}}(),z(e),Z(e.orientation,a),ee(e),ie(e)}catch(e){return o&&o(e),void 0}o&&o()})}),void 0)),void 0)}try{G(),z(e),Z(e.orientation,a),function(){let e=t.join(O,".cocos-project.json");if(!i.existsSync(e))return Editor.failed(`Can't find project json [${e}]`),void 0;let r=JSON.parse(i.readFileSync(e,"utf8")).engine_version;r!==N&&Editor.failed(`Project version [${r}] not match cocos2d-x-lite version [${N}]. Please delete your build path, then rebuild project.`)}(),ee(e),ie(e)}catch(n){return o&&o(n),void 0}o&&o()})},compile:function(e,t){Editor.Ipc.sendToMain("builder:state-changed","init settings",0),W(e,r=>{if(r=r||q())return t&&t(r),void 0;if(!i.existsSync(O))return t&&t(new Error(`Can't find ${O}, please first build project`)),void 0;Editor.Ipc.sendToMain("builder:state-changed","compile native",.1),Editor.log("Start to compile native project. Please wait..."),Editor.log(`The log file path [ ${g} ]`);let o=["compile","-p","android-instant"===_?"android":_,"-m",b?"debug":"release","--compile-script",0,"--env",w],n={cwd:O};"android-instant"===_&&o.push("--instant-game"),ce(e)&&o.push("--xcworkspace");let a=H;if("android"===_||"android-instant"===_){if(o.push("--android-studio"),e.apiLevel){let t=Y(e.apiLevel);t>0&&(o.push("--ap"),o.push(e.apiLevel),a=t)}e.appABIs&&e.appABIs.length>0&&(o.push("--app-abi"),o.push(e.appABIs.join(":")))}if("win32"===_){let t="";t="auto"===e.vsVersion?"2015":e.vsVersion,o.push("--vs"),o.push(t)}Z(e.orientation,a);let s=L(o,n);if(s.error)return t&&t(s.error),void 0;let l=.1;function c(){(l+=5e-4)>.9&&(l=.9),Editor.Ipc.sendToMain("builder:state-changed","compile native",l)}(re=s.child).stdout.on("data",()=>{c()}),re.stderr.on("data",()=>{c()}),J(re,async(i,r,o)=>{if(i)return t&&t(i),void 0;if(re=null,0===r){if(e.appBundle&&("android-instant"===_||"android"===_)){const{promisify:e}=require("util");await e(de)()}Editor.Ipc.sendToMain("builder:state-changed","finish",1),Editor.log("Compile native project successfully.")}else{if(!oe&&"SIGTERM"!==o)return t&&t(new Error(`Compile failed. The log file path [ ${g} ]`)),void 0;Editor.log("Compile native project exited normal")}t&&t()})})},encryptJsFiles:function(e,o,n){W(e,a=>{if(a)return n&&n(a),void 0;if(!i.existsSync(O))return n&&n(new Error(`Can't find ${O}, please first build project`)),void 0;if(!e.xxteaKey)return n&&n(new Error("xxtea key is empty.")),void 0;(function(e){let r=t.join(O,"frameworks/runtime-src/Classes/AppDelegate.cpp");if(!i.existsSync(r))return Editor.warn(`Can't find path [${r}]`),void 0;let o=i.readFileSync(r,"utf8").split("\n");for(let t=0;t<o.length;t++)-1!==o[t].indexOf("jsb_set_xxtea_key")&&(o[t]=`    jsb_set_xxtea_key("${e.xxteaKey}");`);i.writeFileSync(r,o.join("\n"))})(e);let s=[t.join(O,"src","**/*.js")].concat(o.map(e=>t.join(e,"**/*.js")));l(s,(o,a)=>{if(o)return n&&n(o),void 0;a.forEach(o=>{o=t.normalize(o);try{let n=i.readFileSync(o,"utf8");e.zipCompressJs?(n=d.gzipSync(n),n=c.encrypt(n,c.toBytes(e.xxteaKey))):n=c.encrypt(c.toBytes(n),c.toBytes(e.xxteaKey)),i.writeFileSync(t.join(t.dirname(o),t.basenameNoExt(o))+".jsc",n),r.sync(o.replace(/\\/g,"/"),{force:!0})}catch(e){Editor.warn(e)}}),n&&n()})})},run:function(e,r){pe(),Editor.log("Start to run project"),W(e,n=>{if(n)return r&&r(n),void 0;if(!i.existsSync(O))return r&&r(new Error(`Can't find ${O}, please first build project`)),void 0;Editor.log("Start to run project. Please wait..."),Editor.log(`The log file path [ ${g} ]`);let a=["run","-p","android-instant"===_?"android":_,"-m",b?"debug":"release","--env",w,"--compile-script",0],s={cwd:O};if("android-instant"===_){let t=e["android-instant"];a.push("--instant-game"),t.scheme&&t.host&&t.pathPattern&&(a.push("--launch-url"),a.push(`${t.scheme}://${t.host}${t.pathPattern}`))}ce(e)&&a.push("--xcworkspace");let l=H;if("android"===_||"android-instant"===_){if(a.push("--android-studio"),e.apiLevel){let t=Y(e.apiLevel);t>0&&(a.push("--ap"),a.push(e.apiLevel),l=t)}e.appABIs&&e.appABIs.length>0&&(a.push("--app-abi"),a.push(e.appABIs.join(":")))}if("win32"===_&&"auto"!==e.vsVersion&&(a.push("--vs"),a.push(e.vsVersion)),Z(e.orientation,l),"win32"===process.platform&&"win32"===_){let e;e=b?t.join(O,"simulator/win32",C+".exe"):t.join(O,"publish/win32",C+".exe");try{ne=o(e,{},s)}catch(n){return r&&r(n),void 0}}else{let e=L(a,s);if(e.error)return r&&r(e.error),void 0;ne=e.child}J(ne,(e,t)=>e?(r&&r(e),void 0):0!==t?(r&&r(new Error(`Failed to run project. The log file path [ ${g} ]`)),void 0):(r&&r(),void 0))})},runSimulator:ge,saveKeystore:function(e,n){let a="keytool";if("win32"===process.platform){if(!process.env.JAVA_HOME||!i.existsSync(process.env.JAVA_HOME))return n&&n(new Error("Please make sure java is installed and JAVA_HOME is in your environment")),void 0;if(a=t.join(process.env.JAVA_HOME,"bin/keytool.exe"),!i.existsSync(a))return n&&n(new Error(`Can't find path [${a}]. Please make sure JAVA_HOME is in your environment and exists`)),void 0}let s=e.dest;i.existsSync(s)&&r.sync(s.replace(/\\/g,"/"),{force:!0});let l=[];e.commonName&&l.push(`CN=${e.commonName}`),e.organizationalUnit&&l.push(`OU=${e.organizationalUnit}`),e.organization&&l.push(`O=${e.organization}`),e.locality&&l.push(`L=${e.locality}`),e.state&&l.push(`S=${e.state}`),e.country&&l.push(`C=${e.country}`),l=l.join(",");let c=["-genkey","-keyalg","RSA","-keysize","1024","-validity",e.validity,"-keystore",t.basename(s),"-storepass",e.password,"-alias",e.alias,"-keypass",e.aliasPassword,"-dname",l];Editor.log("Creating keystore : ",c.join(" "));let d,p={cwd:t.dirname(s)};try{d=o(a,c,p)}catch(e){return n&&n(e),void 0}J(d,(e,t)=>e?(n&&n(e),void 0):0!==t?(n&&n(new Error("Failed to create keystore, please check the log information")),void 0):(n(),void 0))},openNativeLogFile:function(){i.ensureFileSync(g),s.shell.openPath(g)},stopCompile:le,getCocosTemplates:function(e){let i=Editor.Profile.load("local://settings.json");!1!==i.get("use-global-engine-setting")&&(i=Editor.Profile.load("global://settings.json")),i.get("use-default-cpp-engine")?(S=Editor.builtinCocosRoot,Editor.dev&&!S&&Editor.error("Can not find builtin cocos2d-x, please run 'gulp update-externs'.")):(S=i.get("cpp-engine-path"))||Editor.error("Can not find cocos engine."),B(t.join(S,"tools","cocos2d-console","bin"),t=>{e&&e(null,t.templates)})},getAndroidAPILevels:function(e){let r=f.get("android-sdk-root");if(!i.isDirSync(r))return e(null,[]),void 0;let o=t.join(r,"platforms","android-*");l(o,(r,o)=>{let n=[];o.forEach(e=>{e=t.normalize(e);let r=t.basename(e);Y(r)>=H&&i.isDirSync(e)&&n.push(r)}),e&&e(null,n)})},getAndroidInstantAPILevels:function(e){let r=f.get("android-sdk-root");if(!i.isDirSync(r))return e(null,[]),void 0;let o=t.join(r,"platforms","android-*");l(o,(r,o)=>{let n=[];o.forEach(e=>{e=t.normalize(e);let r=t.basename(e);Y(r)>=U&&i.isDirSync(e)&&n.push(r)}),e&&e(null,n)})},stop:function(){le(),pe(),ue(),fe&&(n(fe.pid),fe=null)},showLogInConsole:m,getCocosSpawnProcess:L,getCocosRoot:M};