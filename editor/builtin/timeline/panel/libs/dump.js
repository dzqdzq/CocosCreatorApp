"use strict";const e=require("jsondiffpatch"),{promisify:t}=require("util");let r=e.create({objectHash:(e,t)=>e.uuid?e.uuid:e.name&&e.attrs?e.name:`$$index:${t}`,arrays:{detectMove:!0}}),n="",o={},i=!1,l=function(e,t,r,n){if(!(n=n||o[e]))throw"timeline 找不到指定的节点数据，无法获取关键帧";if(t){let e=t,o=r;for(let r in n.types){if(n.types[r].name===t){e=r;break}}let i=null;for(let t in n.value.__comps__){let r=n.value.__comps__[t];if(r.type===e){i=r.value;break}}let l=cc.js._getClassById(e);if(!l)return i[o]?i[o].value:null;let c=cc.Class.attr(l,o);if(!c.ctor)return i[o]?i[o].value:null;if(cc.js.isChildClassOf(c.ctor,cc.Asset)){let e=i[o].value;return e.uuid?Editor.serialize.asAsset(e.uuid):null}let a=new c.ctor,s=n.types[a.__cid__];if(s&&s.properties){let e=s.properties;for(let t in e){let e=i[o].value[t];"object"==typeof e&&void 0!==e.value&&"object"!=typeof e.value?a[t]=e.value:a[t]=e}}return a}"x"===r?r="positionX":"y"===r?r="positionY":"z"===r&&(r="positionZ");let i=r,l=null,a=i.substr(0,i.length-1);n.value[a]&&(l=i[i.length-1].toLocaleLowerCase(),i=a),"width"!==i&&"height"!==i||(l=i,i="size");let s=n.value[i],u=s?c[s.type]:null;if(!u)throw`The timeline replication attribute has an error: ${s.type}`;let p=u(s.value);return"position"===r?void 0!==p.z?[p.x,p.y,p.z]:[p.x,p.y]:l?p[l]:p},c={"cc.Vec2"(e){var t=new cc.Vec2;return t.x=e.x,t.y=e.y,t},"cc.Vec3"(e){var t=new cc.Vec3;return t.x=e.x,t.y=e.y,t.z=e.z,t},"cc.Color"(e){var t=new cc.Color;return t.r=e.r,t.g=e.g,t.b=e.b,t},"cc.Size"(e){var t=new cc.Size;return t.width=e.width,t.height=e.height,t},String:e=>e,Float:e=>e,Boolean:e=>e,Integer:e=>e};module.exports={update:async function(e){clearTimeout(i),i=setTimeout(()=>{(async function(e){let r=Editor.Selection.curSelection("node");n&&-1===r.indexOf(n)&&r.push(n);for(let e=0;e<r.length;e++){let n=r[e],i=await t(Editor.Ipc.sendToPanel)("scene","scene:query-node",n);o[n]=JSON.parse(i)}Object.keys(o).forEach(e=>{-1===r.indexOf(e)&&delete o[e]}),e&&e()})(e)},100)},diff:function(e,t){let n=[],i=o[e];if(!i)return Editor.warn("The cached node data cannot be found."),n;let c=r.diff(i.value,t.value);if(!c)return n;let a=c,s=c&&c.__comps__||{};return delete c.__comps__,Object.keys(a).forEach(r=>{let o=l(e,null,r,t);n.push({component:null,property:r,value:o});let i=Object.keys(a[r].value);i&&i.forEach(e=>{let t,i=r+e[0].toUpperCase()+e.substr(1);switch(i){case"positionX":i="x",t=o[0];break;case"positionY":i="y",t=o[1];break;case"positionZ":i="z",t=o[2];break;case"sizeWidth":i="width",t=o.width;break;case"sizeHeight":i="height",t=o.height;break;default:t=o[e]}n.push({component:null,property:i,value:t})})}),Object.keys(s).forEach(r=>{if(!t.value.__comps__[r])return;let o=t.value.__comps__[r].type,i=s[r].value;o&&i&&Object.keys(i).forEach(r=>{let i=l(e,o,r,t);n.push({component:o,property:r,value:i})})}),o[e]=t,n.forEach(e=>{if(!e.component||e.component.startsWith("cc."))return;const t=i.types[e.component];t&&(e.component=t.name)}),n},getProperty:l,get root(){return n},set root(e){n=e},hasAnimaiton:function(e){let t=o[e];if(!t)return!1;for(let e in t.types){let r=t.types[e];if("cc.Animation"===e)return!0;let n=r.extends;if(n)for(let e=0;e<n.length;e++)if("cc.Animation"===n[e])return!0}}},window.abc=o;