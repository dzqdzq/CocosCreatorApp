const e=Editor.require("app://editor/share/adapters-build-utils"),t=(Editor.require("app://editor/share/build-utils"),"project://taobao-creativeapp.json"),r=Editor.require("app://editor/share/3d-physics-build-utils"),i=require("fs"),o=require("path"),a=require("globby");const n={"app.js":function(e,t){let i=e.contents.toString(),o=t.debug?"require('cocos2d-js.js')":"require('cocos2d-js-min.js')";i=i.replace("require('cocos2d-js-path')",o);let a=t.debug?"require('adapter.js')":"require('adapter-min.js')";i=i.replace("require('adapter-js-path')",a),i=r.updateMinigameRequire(t,i),e.contents=new Buffer(i)}};module.exports={name:Editor.T("taobao-creativeapp.platform_name"),platform:"taobao",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){let r=Editor.Profile.load(t);e.startSceneAssetBundle=r.get("startSceneAssetBundle")||!1},compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e){let t=e.dest;return[o.join(t,"**/*"),`!${o.join(t,"game.json")}`]},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(r,i){let o=null;try{(function(){if(!Editor.Profile.load(t))throw new Error("config file not found")})(),i.settings.server=Editor.Profile.load(t).get("remoteUrl"),await e.buildAdapter(i,null),await e.copyRes(i,"global-variables.js",n),function(){let e=Editor.Profile.load(t);Editor.Metrics.trackEvent("Project","BetaPlatforms","taobao-creativeapp",{orientation:e.get("deviceOrientation")})}()}catch(e){o=e}r.reply(o)},"build-finished":function(e,r){(function(e){const t=e.dest,r=/require\('(?=\w)/g,a=["app.js","ccRequire.js"];for(let e of a){const a=o.join(t,e);let n=i.readFileSync(a,"utf8");n=n.replace(r,"require('./"),i.writeFileSync(a,n)}})(r),function(e){const t=e.dest,r=a.sync(o.join(t,"**/*.js")),n=Editor.url("packages://adapters/platforms/taobao/res/global-variables.js");let l=i.readFileSync(n,"utf8");l=l.replace(/\n/g,"");for(let e of r){let t=i.readFileSync(e,"utf8");t=l+"\n"+t,i.writeFileSync(e,t,"utf8")}}(r);let n=Editor.Profile.load(t),l={resUrl:n.get("remoteUrl"),orientation:n.get("deviceOrientation")};Editor.Ipc.sendToMain("builder:notify-build-result",r,l),e.reply()}},settings:Editor.url("packages://taobao-creativeapp/build-ui.js")};