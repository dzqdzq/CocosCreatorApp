let e=require("path"),i=require("fs-extra");const{exec:t,execSync:n}=require("child_process");let r=require("./adapter-util.js"),a=require("./subpackage-util.js"),o=require("./tinypack-util.js"),c=require("./separate-engine-util.js"),s={};module.exports={async gatherInfo(t,n){if(s.customConfig=Editor.Profile.load("project://honor-minigame.json").getSelfData(),!1===this.checkData(s,t,n))return!1;s.md5Cache=n.md5Cache;let l=s.customConfig;s.isTinyPackage=""!==l.tinyPackageServer,s.projectPath=n.project,s.buildPath=n.dest,s.options=n,s.title=n.title,s.rpkPath=e.join(s.buildPath,"dist"),s.buildResults=n.buildResults,s.startScene=n.startScene,s.bundleVers=n.settings.bundleVers,s.privatePath=l.privatePath||"",s.certificatePath=l.certificatePath||"",s.useDebugKey=l.useDebugKey,i.emptyDirSync(e.join(s.buildPath,"dist")),s.icon=l.icon||"";let p=s.icon.trim();if(s.icon&&!i.existsSync(s.icon)){let e="";e+=s.icon+Editor.T("honor-minigame.icon_not_exist"),t.reply(new Error(e))}s.gameConfig={package:l.package,name:l.name,icon:`/image/${e.parse(p).base}`,versionName:l.versionName,versionCode:l.versionCode,minPlatformVersion:l.minPlatformVersion,orientation:l.deviceOrientation,config:{logLevel:l.logLevel}},await r.gatherInfo(s),await a.gatherInfo(s),await o.gatherInfo(s),await c.gatherInfo(s)},checkData:(t,n,r)=>(0,i.existsSync(e.join(r.dest,"remote"))&&""===t.customConfig.tinyPackageServer&&Editor.warn(Editor.T("honor-minigame.had_set_remote_without_tiny_mode")),!0),initHonorProject(t){let r=Editor.url("packages://runtime-adapters/honor-pack-tools"),a=t.dest;i.ensureDirSync(a),i.copyFileSync(e.join(r,"package.json"),e.join(a,"package.json"));let o="win32"===process.platform?"npm.cmd":"npm";Editor.log(Editor.T("honor-minigame.begin_install_npm"));try{return n(`${o} install --no-package-lock`,{env:process.env,cwd:a}),Editor.log(Editor.T("honor-minigame.npm_installed_success")),!0}catch(e){return e&&Editor.error("npm install error! "+e),!1}},async organizeResources(t){let n=s.buildPath;if(s.useDebugKey){let t=e.join(n,"sign","debug");i.emptyDirSync(t);let r=Editor.url("packages://runtime-adapters/common/res");i.copySync(e.join(r,"certificate.pem"),e.join(t,"certificate.pem")),i.copySync(e.join(r,"private.pem"),e.join(t,"private.pem"))}else{let t=e.join(n,"sign","release");i.emptyDirSync(t),i.copySync(s.privatePath,e.join(t,"private.pem")),i.copySync(s.certificatePath,e.join(t,"certificate.pem"))}if(!1===await r.organizeResources(t))return!1;await a.organizeResources(),await c.organizeResources(),i.writeJSONSync(e.join(n,"manifest.json"),s.gameConfig);let o=e.join(n,"main.js");if(i.existsSync(o)&&i.unlinkSync(o),s.icon){let t=s.icon.trim(),r=e.join(n,"image");i.emptyDirSync(r),i.copySync(s.icon,e.join(r,e.parse(t).base))}return this.handleMainJS(),!0},handleMainJS(){let t=Editor.url("packages://honor-minigame/static"),n=e.join(t,"game.js"),r=e.join(s.buildPath,"game.js");if(i.copySync(n,r),s.customConfig.separateEngineMode){let e=i.readFileSync(r,"utf-8"),t="require('src/cocos2d-runtime.js')",n="if (typeof requirePlugin === 'function') {\n\trequirePlugin('cocos');\n} else {\n\trequire('"+(s.gameConfig.plugins.cocos.path+"/cocos2d-runtime.js")+"');\n}";e=e.replace(t,n),i.writeFileSync(r,e)}},async pack(e){let i=s.buildPath;await r.pack(),await a.pack(),await o.pack(),await c.pack();let n="win32"===process.platform?"npm.cmd":"npm",l=s.useDebugKey?"build":"release";t(`${n} run ${l}`,{env:process.env,cwd:i},i=>{i&&Editor.error("npm run error! "+i),e.reply()})}};