let e=require("../lib/jszip.min.js"),i=require("path"),t=require("fs-extra"),n=require("./worker-util.js"),a=require("./adapter-util.js"),r=require("./subpackage-util.js"),o=require("./tinypack-util.js"),s=require("./separate-engine-util.js"),c={};e.prototype.directory=function(e,n){if(!t.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;t.readdirSync(e).forEach(function(e){let n=this.zip,a=i.join(this.srcPath,e),r=t.statSync(a);r.isDirectory()?n.directory(a,e):r.isFile()?n.file(e,t.readFileSync(a)):Editor.error(a+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(n)}))},e.prototype.append=function(e,i){if(!t.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(i,t.readFileSync(e))},module.exports={async gatherInfo(u,p){if(c.customConfig=Editor.Profile.load("project://migu-runtime.json").getSelfData(),!1===this.checkData(c,u,p))return!1;c.md5Cache=p.md5Cache;let g=c.customConfig;c.isTinyPackage=""!==g.tinyPackageServer,c.projectPath=p.project,c.buildPath=p.dest,c.options=p,c.title=p.title,c.rpkName=p.title+".rpk",c.rpkPath=i.join(c.buildPath,"dist"),c.buildResults=p.buildResults,c.startScene=p.startScene,c.bundleVers=p.settings.bundleVers,t.emptyDirSync(i.join(c.buildPath,"dist")),c.icon=g.icon||"";let l=c.icon.trim();if(c.icon&&!t.existsSync(c.icon)){let e="";e+=c.icon+Editor.T("migu-runtime.icon_not_exist"),u.reply(new Error(e))}c.gameConfig={package:g.package,name:g.name,icon:`/image/${i.parse(l).base}`,versionName:g.versionName,versionCode:g.versionCode,minPlatformVersion:g.minPlatformVersion,orientation:g.deviceOrientation,type:"game",appId:g.appid,appKey:g.appkey,config:{logLevel:g.logLevel}},c.JsZip=e,c.mainRpk=new e,await n.gatherInfo(c),await a.gatherInfo(c),await r.gatherInfo(c),await o.gatherInfo(c),await s.gatherInfo(c)},checkData:(e,n,a)=>(0,t.existsSync(i.join(a.dest,"remote"))&&""===e.customConfig.tinyPackageServer&&Editor.warn(Editor.T("migu-runtime.had_set_remote_without_tiny_mode")),!0),async organizeResources(e){let o=c.buildPath;if(await n.organizeResources(),!1===await a.organizeResources(e))return!1;await r.organizeResources(),await s.organizeResources(),t.writeJSONSync(i.join(o,"manifest.json"),c.gameConfig);let u=i.join(o,"main.js");if(t.existsSync(u)&&t.unlinkSync(u),c.icon){let e=c.icon.trim(),n=i.join(o,"image");t.emptyDirSync(n),t.copySync(c.icon,i.join(n,i.parse(e).base))}return this.handleMainJS(),c.gameConfig.subpackages&&c.gameConfig.subpackages.length>0?c.customConfig.isSubPackage=!0:c.customConfig.isSubPackage=!1,!0},handleMainJS(){let e=Editor.url("packages://migu-runtime/static"),n=i.join(e,"game.js"),a=i.join(c.buildPath,"game.js");if(t.copySync(n,a),c.customConfig.separateEngineMode){let e=t.readFileSync(a,"utf-8"),i="require('src/cocos2d-runtime.js')",n="if (typeof requirePlugin === 'function') {\n\trequirePlugin('cocos');\n} else {\n\trequire('"+(c.gameConfig.plugins.cocos.path+"/cocos2d-runtime.js")+"');\n}";e=e.replace(i,n),t.writeFileSync(a,e)}},async pack(u){let p=c.mainRpk,g=c.buildPath,l=c.rpkPath,d=i.join(g,"main.rpk");await n.pack(),await a.pack(),await r.pack(),await o.pack(),await s.pack(),p.directory(i.join(g,"src"),"src"),p.directory(i.join(g,"assets"),"assets"),p.directory(i.join(g,"image"),"image"),p.append(i.join(g,"game.js"),"game.js"),p.append(i.join(g,"manifest.json"),"manifest.json");const m=await p.generateAsync({type:"nodebuffer",base64:!1,compression:"DEFLATE"});t.writeFileSync(d,m);let f=new e;f.append(d,"main.rpk"),t.removeSync(d),c.gameConfig.subpackages&&c.gameConfig.subpackages.forEach(function(e){let n=e.name+".rpk",a=i.join(g,n);t.existsSync(a)?(f.append(a,n),t.removeSync(i.join(g,n))):Editor.error("sub package not found "+a)}),f.generateAsync({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).then(function(e){t.writeFileSync(i.join(l,c.rpkName),e),u.reply()})}};