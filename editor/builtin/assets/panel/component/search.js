"use strict";const t=require("fs"),e=require("fire-path"),i=require("async"),{promisify:s}=require("util"),r=require("../utils/cache"),o=require("../utils/operation"),h=require("../utils/event"),l=require("../utils/utils"),{filterNodes:d}=require("../utils/cache");exports.template=t.readFileSync(e.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter","length"],exports.data=function(){return{nodes:r.queryNodes(),filterNodes:[],type:null,text:"",uuids:[],uh:{height:0},showList:[],start:0}},exports.watch={start(){this.reset()},length(){this.reset()},filterNodes(){this.reset()},nodes(){this.filter&&l.emptyFilter()},filter(){let t=this.filter;if(!t)return r.filterNodes=[],void 0;let l=[],d="",u="";if(/^t:.*/.test(t)||/^u:.*/.test(t)||/^used:.*/.test(t)){let e=t.split("|");t="";for(let i=0,s=e.length;i<s;i++){let s=e[i];if(s)if(/^t:.*/.test(s)){let t=s.substring(2).split(",").map(t=>t.trim());l=l.concat(t)}else/^u:.*/.test(s)?d=s.substring(2):/^used:.*/.test(s)?u=s.substring(5):t=s}}clearTimeout(this._searchID),h.emit("start-loading",100),this.uuids=[],this._searchID=null;let n=setTimeout(async()=>{if(h.emit("finish-loading"),l.includes("asset-bundle")){let t=[];try{t=await s(Editor.assetdb.queryAssets)(null,"folder")}catch(t){return Editor.error(t),void 0}t.forEach(t=>{Editor.remote.assetdb.loadMeta(t.url).isBundle&&this.uuids.push(t.uuid)}),l=l.filter(t=>"asset-bundle"!==t)}let a=[];try{(l.length>0||d||u||t)&&(a=await s(Editor.assetdb.queryAssets)(null,l))}catch(t){return Editor.error(t),void 0}n===this._searchID&&(this.text=t.toLowerCase(),d=d.toLowerCase(),u=u.toLowerCase(),i.waterfall([t=>{if(!u||!Editor.Utils.UuidUtils.isUuid(u))return t(),void 0;Editor.assetdb.queryInfoByUuid(u,(e,i)=>{e?Editor.error(e):i&&this.isScript(i.type)&&(u=Editor.Utils.UuidUtils.compressUuid(u)),t()})},t=>{a.forEach(t=>{if(t.hidden)return;let i=e.basenameNoExt(t.path);e.extname(t.path);this.validate(i,this.text)&&this.validate(t.uuid,d)&&this.findUsages(t,u)&&this.uuids.push(t.uuid)}),t()},t=>{this.filterNodes=this.nodes.filter(t=>{if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(this.text){let e=t.name.toLowerCase();if(this.text=this.text.toLowerCase(),-1===e.indexOf(this.text))return!1}return!0}),t()}],()=>{r.filterNodes=this.filterNodes,Editor.Selection.curSelection("asset").forEach(t=>{o.select(t,!0)})}))},200);this._searchID=n}},exports.methods={isScript:t=>"javascript"===t||"typescript"===t,reset(){this._updateLock||(this._updateLock=!0,requestAnimationFrame(()=>{this._updateLock=!1,this.showNodeFilter()}))},sortShowNode(){r.sortAssetsTree(this.filterNodes)},showNodeFilter:function(){this.uh.height=0,this.showList=[];let t=this.filterNodes,e=this.start+Math.ceil(this.length);e=e>t.length?t.length:e;for(let i=this.start;i<e;i++)this.showList.push(t[i]);this.uh.height=t.length*r.lineHeight+4},scrollIfNeeded(t){let e=r.queryNode(t);if(!e)return;let i=this.filterNodes.indexOf(e);if(-1===i)return;let s=i*r.lineHeight,o=this.$el.scrollTop+this.$el.clientHeight-r.lineHeight-2;s<this.$el.scrollTop-2?this.$el.scrollTop-=this.$el.scrollTop-2-s:s>=o&&(this.$el.scrollTop+=s-o)},validate:(t,e)=>t.toLowerCase().indexOf(e.toLowerCase())>-1,addShowList(t){-1===this.showList.indexOf(t)&&this.showList.push(t)},removeShowList(t){let e=this.showList.indexOf(t);-1!==e&&this.showList.splice(e,1)},findUsages(e,i){if(!i)return!0;if(i===e.uuid)return!1;if(!e.destPath)return!1;return t.readFileSync(e.destPath).indexOf(i)>=0},onUpdateFilter(t,e){if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(e){let i=t.name.toLowerCase();e=e.toLowerCase();let s=-1!==i.indexOf(e);return s?this.addShowList(t):this.removeShowList(t),s}return this.addShowList(t),!0},onScroll(t){let e=t.target.scrollTop;this.start=e/r.lineHeight|0},onDragStart:l.onDragStart,onDragOver:l.onDragOver,onDragEnd:l.onDragEnd},exports.created=function(){h.on("search:sort",this.sortShowNode)};