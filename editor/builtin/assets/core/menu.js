"use strict";const e=require("electron"),t=require("fire-fs"),r=require("fire-path"),s=require("async"),a=require("fire-url"),i=require("./create-menu"),l=require("./search"),o=require("./sort"),n=require("./refresh"),d=require("../package.json");function c(){let e=Editor.Selection.contexts("asset");return e.length>0?e[0]:""}function u(e){let r=Editor.assetdb.loadMetaByUuid(e);if(!r)return Editor.info(e+" does not exists in library"),{};if(r.useRawfile())return Editor.info("This asset does not contain in the library"),{};let s=r.dests(Editor.assetdb);return 0!==s.length&&t.existsSync(s[0])?{path:s[0],type:r.assetType()}:(Editor.failed("The asset %s is not exists in library",Editor.assetdb.uuidToUrl(e)),{})}function E(e,t,r){let s=i();s.forEach(t=>{t.params&&t.params.push(e)});let a=[{label:Editor.T("ASSETS.folder"),message:"assets:new-asset",params:[{name:"New Folder"},e]}];return a.push({type:"separator"}),a.concat(s)}module.exports={getContextTemplate:function(i){const{assetType:l,allowAssign:o,id:n,copyEnable:p,isSubAsset:T,selected:S,allowPaste:b}=i;var f=[{label:Editor.T("ASSETS.create"),enabled:!T,submenu:E(!0)},{type:"separator"},{label:Editor.T("ASSETS.copy"),enabled:!!p&&"mount"!==l,click(){let e=c();e&&Editor.Ipc.sendToPanel("assets","assets:copy",e)}},{label:Editor.T("ASSETS.paste"),enabled:!!p&&b,click(){let e=c();e&&Editor.Ipc.sendToPanel("assets","assets:paste",e)}},{type:"separator"},{label:Editor.T("ASSETS.rename"),enabled:"mount"!==l&&!T,click(){let e=c();e&&Editor.Ipc.sendToPanel(d.name,"assets:rename",e)}},{label:Editor.T("ASSETS.delete"),enabled:"mount"!==l&&!T,click(){let e=Editor.Selection.contexts("asset");e.length>0&&Editor.Ipc.sendToPanel(d.name,"assets:delete",e)}}];let h=Editor.assetdb.getAssetBackupPath(Editor.assetdb.uuidToFspath(n));return h&&t.existsSync(h)&&!function(e){let t=Editor.assetdb.uuidToUrl(e);try{let e=t.split(r.sep);return 3===e.length.length||4===e.length&&""===e[3]}catch(e){return!1}}(n)&&f.push({label:Editor.T("ASSETS.rollback"),click(){let e=Editor.assetdb.uuidToUrl(n);1===Editor.Dialog.messageBox({type:"warning",buttons:["Cancel","OK"],title:"Rollback Asset",message:Editor.T("ASSETS.sure_rollback",{url:e}),defaultId:1,cancelId:0,noLink:!0})&&s.waterfall([function(r){t.readFile(h,(t,s)=>{if(t)return r(t);Editor.assetdb.saveExists(e,s,t=>{if(t)return Editor.error(`Rollback ${e} failed: ${t.stack}`),void 0;Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:"Rollback Asset",message:Editor.T("ASSETS.rollback_tip",{url:e}),defaultId:0,cancelId:0,noLink:!0})})})}],function(e){e&&Editor.warn(Editor.T("ERROR.assets.rollback"))})}}),f=f.concat([{type:"separator"},{label:Editor.T("ASSETS.find_usages"),enabled:"mount"!==l,click(){let e=c();e&&Editor.Ipc.sendToPanel(d.name,"assets:find-usages",e)}},{label:Editor.isDarwin?Editor.T("ASSETS.reveal_mac"):Editor.T("ASSETS.reveal_win"),enabled:!T,click(){let r=c();if(r){let s=Editor.assetdb.uuidToFspath(r);t.existsSync(s)?e.shell.showItemInFolder(s):Editor.failed("Can not found the asset %s",Editor.assetdb.uuidToUrl(r))}}},{type:"separator"},{label:Editor.T("ASSETS.open_in_library"),click(){let e=c();if(e){let{path:t}=u(e);t&&Editor.Ipc.sendToMain("assets:open-text-file-by-path",t)}}},{label:Editor.T("ASSETS.reveal_library"),click(){let t=c();if(t){let{path:r}=u(t);r&&e.shell.showItemInFolder(r)}}},{label:Editor.T("ASSETS.reveal_hierarchy"),visible:"javascript"===l||"typescript"===l,click(){let e=c();if(e){let t=Editor.assetdb.uuidToUrl(e);Editor.Ipc.sendToPanel("hierarchy","filter",`t:${a.basenameNoExt(t)}`)}}},{label:Editor.T("ASSETS.show_uuid"),click(){let e=c();if(e){let t=Editor.assetdb.uuidToUrl(e),r=Editor.Utils.UuidUtils.compressUuid(e,!0);Editor.info(`${e} (${r}), ${t}`)}}}])},getCreateTemplate:E,getSearchTemplate:function(){return l()},getSortTemplate:function(){return o()},getRefreshTemplate:()=>n()};