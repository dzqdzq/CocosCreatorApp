const e="project://huawei-runtime.json",i="manifest.json",n="cocos-library",t="cocos2d-runtime.js",r="physics.js",a=1091;var o=require("path"),s=require("fs-extra"),c=require("fix-path");const l=require("crypto"),{execSync:u}=require("child_process"),p=require("http");var m,d,g,h,f,y,E,_,w,S,j,k="game.js",b="win32"===process.platform,v={},P=!1;let T={cannon:{rpkUrl:"",rpkFileName:"",rpkLocalPath:"",signUrl:"",signFileName:"",signLocalPath:""},builtin:{rpkUrl:"",rpkFileName:"",rpkLocalPath:"",signUrl:"",signFileName:"",signLocalPath:""},currentSelection:""};function $(e){let i=Editor.url("packages://runtime-adapters/platforms/huawei");return void 0===e||""===e?i:o.join(i,e)}function N(e){let i=Editor.url("packages://runtime-adapters/common/res");return void 0===e||""===e?i:o.join(i,e)}function x(){return Editor.url("packages://runtime-adapters/package")}function F(e,t){s.emptyDirSync(t);var r=o.join(e.dest,"assets"),a=o.join(e.dest,"remote"),c=o.join(e.dest,"src"),u=o.join(e.dest,"jsb-adapter"),p=o.join(e.dest,"subpackages"),d=o.join(t,"jsb-adapter"),f=o.join(t,"assets"),y=o.join(t,"remote"),E=o.join(t,"src"),w=o.join(t,"subpackages");s.copySync(u,d),!1===(""!==m.tinyPackageServer)&&s.existsSync(a)&&s.copySync(a,y),s.copySync(r,f),s.copySync(c,E),s.existsSync(p)&&s.copySync(p,w),function(e){var i=o.join(e,"image");s.ensureDirSync(i),s.writeFileSync(o.join(i,o.parse(g).base),s.readFileSync(g))}(t),function(e){s.copySync(o.join(j.dest,"main.js"),o.join(e,k))}(t),function(e){var t=o.join(e,i),r=m.package,a=m.name,c=m.versionName,u=m.versionCode,p=m.minPlatformVersion,d=m.deviceOrientation,f=m.logLevel,y={package:r,appType:"fastgame",name:a,versionName:c,versionCode:u,icon:`/image/${o.parse(g).base}`,minPlatformVersion:p,permissions:[{origin:"*"}],router:{}};if(h&&(y.subpackages=h),s.existsSync(_)){var E;try{E=s.readJsonSync(_),Editor.log(Editor.T("huawei-runtime.custom_manifest_data"),JSON.stringify(E))}catch(e){Editor.log(Editor.T("huawei-runtime.custom_manifest_data_error"))}if(E)for(var w in E)"package"!==w&&"appType"!==w&&"name"!==w&&"versionName"!==w&&"versionCode"!==w&&"icon"!==w&&"minPlatformVersion"!==w&&"permissions"!==w&&"plugins"!==w&&(y[w]=E[w])}var S={},j={};if(y.config&&(S=y.config),y.display&&(j=y.display),S.logLevel=f,j.orientation=d,j.fullScreen=m.fullScreen,y.display=j,m.separateEngineMode){let e="",i=T[T.currentSelection].rpkLocalPath;if(s.existsSync(i)){let n=l.createHash("sha256");n.update(s.readFileSync(i)),e=n.digest("hex")}else{let e=Editor.T("huawei-runtime.file_not_exist").replace("{fileName}",T[T.currentSelection].rpkFileName);Editor.warn(e)}let t="",r=T[T.currentSelection].signLocalPath;if(s.existsSync(r))t=s.readFileSync(r,"utf8");else{let e=Editor.T("huawei-runtime.file_not_exist").replace("{fileName}",T[T.currentSelection].signFileName);Editor.warn(e)}y.plugins={},y.plugins[n]={provider:e,signature:t,version:CocosEngine,path:n}}var k=JSON.stringify(y);s.writeFileSync(t,k)}(t),m.separateEngineMode&&s.copySync(o.join(e.dest,n),o.join(t,n))}function L(e,i){Editor.log("Checking config file "+i.dest),m.npmPath?(P=!1,Editor.log(Editor.T("huawei-runtime.custom_npm_path_config"),m.npmPath),b?v.Path=m.npmPath:v.PATH=m.npmPath):(S&&Editor.log(Editor.T("huawei-runtime.custom_npm_path_not_config")),P||(P=!0,c()),v=process.env),function(e){let i=b?"npm.cmd":"npm";try{return u(`${i} -v`,{env:v}),!0}catch(i){return m.npmPath?(e.reply(new Error(Editor.T("huawei-runtime.custom_npm_path_config_error"))),!1):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),b?(e.reply(new Error(Editor.T("huawei-runtime.window_default_npm_path_error"))),!1):(e.reply(new Error(Editor.T("huawei-runtime.mac_default_npm_path_error"))),!1))}}(e)&&function(e){let i=x();if(s.existsSync(o.join(i,"node_modules")))return!0;let n=b?"npm.cmd":"npm";Editor.log(Editor.T("huawei-runtime.begin_install_npm"));try{return u(`${n} install`,{env:process.env,cwd:i}),Editor.log(Editor.T("huawei-runtime.npm_installed_success")),!0}catch(i){return e.reply(new Error(Editor.T("huawei-runtime.npm_install_fail")+i.message)),!1}}(e)&&(function(e){let i=e.excludedModules,n=!1,t=!1;for(let e=0,r=i.length;e<r;++e)"3D Physics/Builtin"===i[e]?t=!0:"3D Physics/cannon.js"===i[e]&&(n=!0);T.currentSelection=n&&t?"cannon":n&&!t?"builtin":(!n&&t,"cannon");let r=`http://runtime-res.cocos.org/engine-plugin/${CocosEngine}/`,a=new Date(Editor.__info__.time),c=`${a.getFullYear()}.${a.getMonth()}.${a.getDate()}`;T.cannon.rpkFileName=`cocos-library-cannon.${c}.rpk`,T.cannon.rpkUrl=`${r}${T.cannon.rpkFileName}`,T.cannon.signFileName=`cocos-library-cannon.${c}.sign`,T.cannon.signUrl=`${r}${T.cannon.signFileName}`,T.builtin.rpkFileName=`cocos-library-builtin.${c}.rpk`,T.builtin.rpkUrl=`${r}${T.builtin.rpkFileName}`,T.builtin.signFileName=`cocos-library-builtin.${c}.sign`,T.builtin.signUrl=`${r}${T.builtin.signFileName}`;let l=o.join(Editor.App.home,"local","huawei",CocosEngine);s.ensureDirSync(l),T.cannon.rpkLocalPath=o.join(l,T.cannon.rpkFileName),T.cannon.signLocalPath=o.join(l,T.cannon.signFileName),T.builtin.rpkLocalPath=o.join(l,T.builtin.rpkFileName),T.builtin.signLocalPath=o.join(l,T.builtin.signFileName)}(i),async function(e){s.existsSync(T.cannon.rpkLocalPath)&&s.existsSync(T.cannon.signLocalPath)&&s.existsSync(T.builtin.rpkLocalPath)&&s.existsSync(T.builtin.signLocalPath)||(s.removeSync(T.cannon.rpkLocalPath),s.removeSync(T.cannon.signLocalPath),s.removeSync(T.builtin.rpkLocalPath),s.removeSync(T.builtin.signLocalPath),await D(T.cannon.rpkUrl,T.cannon.rpkLocalPath,T.cannon.rpkFileName),await D(T.cannon.signUrl,T.cannon.signLocalPath,T.cannon.signFileName),await D(T.builtin.rpkUrl,T.builtin.rpkLocalPath,T.builtin.rpkFileName),await D(T.builtin.signUrl,T.builtin.signLocalPath,T.builtin.signFileName));e&&e()}(function(){d=i.dest,function(e){let i=o.join(d,"build");h=[];let n=[];for(var t=0,r=e.bundles.length;t<r;t++){var a=e.bundles[t];if("subpackage"!==a.compressionType)continue;let r=a.name,c=o.join(i,"assets",r);if(n.includes(c))continue;n.push(c);let l=o.join(a.scriptDest,"index.js");s.existsSync(l)&&s.renameSync(l,o.join(a.scriptDest,"game.js")),h.push({name:r,resource:"subpackages/"+r})}}(i),m.separateEngineMode&&function(e){Editor.info(Editor.T("huawei-runtime.separate_engine_begin_hint"));let i=o.join(e,n);s.emptyDirSync(i);let a=o.join(i,t),c=o.join(e,"src",t);s.moveSync(c,a),c=o.join(e,"src",r),s.existsSync(c)&&(a=o.join(i,r),s.moveSync(c,a));let l=o.join(i,"plugin.json");s.writeJSONSync(l,{});let u=o.join(e,"main.js"),p=s.readFileSync(u,"utf-8"),m=`require('src/${t}');`;if(p.indexOf(m)>-1){let e=`${n}/${t}`,i=`if (window.requirePlugin) {\n    requirePlugin('${e}');\n} else {\n    require('${e}');\n}`;p=p.replace(m,i),m=`require('src/${r}');`,p.indexOf(m)>-1&&(i=`if (window.requirePlugin) {\n        requirePlugin('${e=`${n}/${r}`}');\n    } else {\n        require('${e}');\n    }`,p=p.replace(m,i)),s.writeFileSync(u,p)}Editor.info(Editor.T("huawei-runtime.separate_engine_end_hint"))}(d),async function(e){let i=require("./build-jsb-adapter"),n=o.join($("engine"),"index.js"),t=o.join(d,"jsb-adapter","engine","index.js");await i.build({rootPath:n,dstPath:t,isDebug:j.debug}),e&&e()}(function(){(function(e,i){let t=o.join(d,"build");s.emptyDirSync(t);let r=o.join(d,"dist");if(s.emptyDirSync(r),F(i,t),m.separateEngineMode){let i=T[T.currentSelection].rpkLocalPath;if(s.existsSync(i)){let a=o.join(d,"temp");if(s.emptyDirSync(a),s.writeFileSync(o.join(a,n+".rpk"),s.readFileSync(i)),q(e,t,a,m.package)&&q(e,a,r,m.package)){let i=o.join(r,m.package+".rpk"),n=o.join(r,m.package+".rpks");s.renameSync(i,n),s.removeSync(a),U(),e.reply()}}else{let i=Editor.T("huawei-runtime.file_not_exist").replace("{fileName}",T[T.currentSelection].rpkFileName);e.reply(new Error(i))}}else q(e,t,r,m.package)&&(U(),e.reply())})(e,i)})}))}async function D(e,i,n){let t=new Promise(function(i,n){let t=[];p.get(e,{timeout:1e4},function(e){200!==e.statusCode?(error=new Error(`Request Failed.\nStatus Code: ${e.statusCode}`),n(error)):(e.on("data",function(e){t.push(e)}),e.on("end",function(){i(t)}))}).on("error",function(e){n(e.message)})});try{let e=await t;s.writeFileSync(i,Buffer.concat(e))}catch(e){let i=Editor.T("huawei-runtime.download_file_fail").replace("{fileName}",n);Editor.warn(i)}}function q(e,i,n,t){let r=E?N("private.pem"):f,a=E?N("certificate.pem"):y,s=`node ${o.join(x(),"index.js")} ${i} ${n} ${t} ${r} ${a}`;Editor.log(Editor.T("huawei-runtime.rpk_installing"));try{return u(`${s}`,{env:v,cwd:d}),Editor.log(Editor.T("huawei-runtime.rpk_install_success")),!0}catch(i){return e.reply(new Error(Editor.T("huawei-runtime.rpk_install_fail")+i.message)),!1}}function U(){let e={resUrl:m.tinyPackageServer,orientation:m.deviceOrientation,projectName:m.name};Editor.Ipc.sendToMain("builder:notify-build-result",j,e),!0===m.useDebugKey||m.package.indexOf("test")>-1||m.name.indexOf("test")>-1||!0===w||Editor.Metrics.trackEvent("Project","BetaPlatforms","huawei-runtime",{packageName:m.package,appName:m.name,version:m.versionName,orientation:m.deviceOrientation})}module.exports={name:Editor.T("huawei-runtime.platform_name"),platform:"huawei",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"script-build-finished":function(i,n){let t=Editor.Profile.load(e);n.settings.server=t.get("tinyPackageServer")||"",i.reply()},"build-finished":function(i,n){j=n;var t=(m=Editor.Profile.load(e).getSelfData()).package,r=m.name,c=m.icon,l=m.versionName,u=m.versionCode,p=m.minPlatformVersion;S=m.showNpmPath,f=m.privatePath,y=m.certificatePath,E=m.useDebugKey,g=c||"",_=m.manifestPath,w=n.debug,sendStatisticsSourceMaps=n.sourceMaps,_||Editor.log(Editor.T("huawei-runtime.not_manifest_data"));var d=!0,h=[],k="";[{name:Editor.T("huawei-runtime.package"),value:t},{name:Editor.T("huawei-runtime.name"),value:r},{name:Editor.T("huawei-runtime.desktop_icon"),value:c},{name:Editor.T("huawei-runtime.version_name"),value:l},{name:Editor.T("huawei-runtime.version_number"),value:u},{name:Editor.T("huawei-runtime.support_min_platform"),value:p}].forEach(function(e){e.value||(d=!1,h.push(e.name))}),d||(k+=h.join("„ÄÅ")+Editor.T("huawei-runtime.not_empty")),c&&(s.existsSync(g)||(d=!1,k+=c+Editor.T("huawei-runtime.icon_not_exist"))),E||(""===f?(d=!1,k+=Editor.T("huawei-runtime.private_pem_path_error")):s.existsSync(f)||(d=!1,k+=`${f}`+Editor.T("huawei-runtime.signature_not_exist")),""===y?(d=!1,k+=Editor.T("huawei-runtime.certificate_pem_path_error")):s.existsSync(y)||(d=!1,k+=`${y} `+Editor.T("huawei-runtime.signature_not_exist")));let b=p.match(/^[0-9]*$/);if(b){let e=Number(b[0]);m.separateEngineMode&&e<a&&(d=!1,k+=Editor.T("huawei-runtime.support_min_platform_limit")+`${a}`)}else d=!1,k+=Editor.T("huawei-runtime.support_min_platform")+Editor.T("huawei-runtime.must_be_numeric");if(!d)return i.reply(new Error(k)),void 0;s.existsSync(o.join(n.dest,"remote"))&&""===m.tinyPackageServer&&Editor.warn(Editor.T("huawei-runtime.had_set_remote_without_tiny_mode")),L(i,n)},play:(e,i)=>{Editor.Panel.open("runtime-dev-tools",i)}},md5:{globalIgnore:function(){return[/.*/]}},beforeFinish:function(e){s.copySync(o.join($("res"),"main.js"),o.join(e.dest,"main.js"))},buildStart:function(i){let n=Editor.Profile.load(e);i.startSceneAssetBundle=n.get("packFirstScreenRes")||!1,i.separateEngineMode=n.get("separateEngineMode")||!1},delPattern:function(e){let i=e.dest;return[o.join(i,"**/*")]},settings:Editor.url("packages://huawei-runtime/build-ui.js")};