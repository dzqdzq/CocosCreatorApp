const e=Editor.require("app://editor/share/adapters-build-utils"),t=Editor.require("app://editor/share/build-utils"),i="project://taobao-minigame.json",n=Editor.require("app://editor/share/3d-physics-build-utils"),o=require("fs"),r=require("path"),a=require("globby"),s=require("crypto");const l={"game.js":function(e,t){let i=e.contents.toString(),o=t.debug?"require('cocos/cocos2d-js.js')":"require('cocos/cocos2d-js-min.js')";t.separateEngineMode&&(o="requirePlugin('cocos/cocos2d-js-min.js')"),i=i.replace("require('cocos2d-js-path')",o);let r=t.debug?"require('adapter.js')":"require('adapter-min.js')";i=i.replace("require('adapter-js-path')",r),i=n.updateMinigameRequire(t,i),e.contents=new Buffer(i)},"game.json":function(e,n){let a=Editor.Profile.load(i),s=JSON.parse(e.contents.toString());if(t.combineDestJson(n,s,r.basename(e.path)),s.deviceOrientation=a.get("deviceOrientation"),n.separateEngineMode){let e=s.plugins.cocos;const t=Editor.url("app://editor/builtin/taobao-minigame/package.json"),i=o.readFileSync(t,"utf8"),n=JSON.parse(i);e.pluginVersion=n.profiles.project["plugin-version"],e.pluginVersion||(e.pluginVersion=a.get("plugin-version"))}else delete s.plugins;let l=[];for(var u=0,c=n.bundles.length;u<c;u++){var d=n.bundles[u];"subpackage"===d.compressionType&&l.push({name:d.name,root:"subpackages/"+d.name})}s.subpackages=l,t.combineBuildTemplateJson(n,s,r.basename(e.path)),e.contents=new Buffer(JSON.stringify(s,null,4))},"signature.json":function(e,t){if(!t.separateEngineMode)return e.contents=null,void 0;let i=JSON.parse(e.contents.toString());const n=o.readFileSync(r.join(t.dest,"cocos/cocos2d-js-min.js"));i.signature[0].md5=s.createHash("md5").update(n).digest("hex"),e.contents=new Buffer(JSON.stringify(i,null,4))},"plugin.json":function(e,t){t.separateEngineMode||(e.contents=null)}};module.exports={name:Editor.T("taobao-minigame.platform_name"),platform:"taobao-minigame",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){let t=Editor.Profile.load(i);e.startSceneAssetBundle=t.get("startSceneAssetBundle")||!1,e.separateEngineMode=!e.debug&&t.get("separate_engine"),e.globalVariable=t.get("globalVariable")},compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e){let t=e.dest;return[r.join(t,"**/*"),`!${r.join(t,"game.json")}`,`!${r.join(t,"mini.project.json")}`]},engineBuildPath:function(e){return r.join(e.dest,"cocos")},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(t,n){let o=null;try{(function(){if(!Editor.Profile.load(i))throw new Error("config file not found")})(),n.settings.server=Editor.Profile.load(i).get("remoteUrl"),await e.buildAdapter(n,null),await e.copyRes(n,"global-variables.js",l),function(){let e=Editor.Profile.load(i);Editor.Metrics.trackEvent("Project","BetaPlatforms","taobao-minigame",{orientation:e.get("deviceOrientation")})}()}catch(e){o=e}t.reply(o)},"build-finished":function(e,t){(function(e){const t=e.dest,i=/require\('(?=\w)/g,n=["game.js","ccRequire.js"];for(let e of n){const n=r.join(t,e);let a=o.readFileSync(n,"utf8");a=a.replace(i,"require('./"),o.writeFileSync(n,a)}})(t),function(e){const t=e.debug?"\n":"",i=e.dest,n=a.sync(r.join(i,"**/*.js")),s=Editor.url("packages://adapters/platforms/taobao-minigame/res/global-variables.js");let l=o.readFileSync(s,"utf8");l=l.replace(/\n/g,"");const u=e.globalVariable;u&&u.split(",").map(e=>e.trim()).forEach(e=>{l+=`var ${e} = window.${e};${t}`});for(let e of n){let t=o.readFileSync(e,"utf8");t=l+"\n"+t,o.writeFileSync(e,t,"utf8")}}(t);let n=null;try{(function(e){for(var t=0,i=e.bundles.length;t<i;t++){var n=e.bundles[t];if("subpackage"!==n.compressionType)continue;let i=r.join(n.scriptDest,"index.js");o.existsSync(i)&&o.renameSync(i,r.join(n.scriptDest,"game.js"))}})(t)}catch(e){n=e}let s=Editor.Profile.load(i),l={resUrl:s.get("remoteUrl"),orientation:s.get("deviceOrientation")};Editor.Ipc.sendToMain("builder:notify-build-result",t,l),e.reply(n)}},settings:Editor.url("packages://taobao-minigame/build-ui.js")};