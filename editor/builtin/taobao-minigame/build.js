const e=Editor.require("app://editor/share/adapters-build-utils"),t=Editor.require("app://editor/share/build-utils"),n="project://taobao-minigame.json",i=Editor.require("app://editor/share/3d-physics-build-utils"),o=require("fs"),r=require("path"),a=require("globby"),s=require("crypto");const l={"game.js":function(e,t){let n=e.contents.toString(),o=t.debug?"require('cocos/cocos2d-js.js')":"require('cocos/cocos2d-js-min.js')";t.separateEngineMode&&(o="requirePlugin('cocos/cocos2d-js-min.js')"),n=n.replace("require('cocos2d-js-path')",o);let r=t.debug?"require('adapter.js')":"require('adapter-min.js')";n=n.replace("require('adapter-js-path')",r),n=i.updateMinigameRequire(t,n),e.contents=new Buffer(n)},"game.json":function(e,i){let o=Editor.Profile.load(n),a=JSON.parse(e.contents.toString());if(t.combineDestJson(i,a,r.basename(e.path)),a.deviceOrientation=o.get("deviceOrientation"),i.separateEngineMode){let e=a.plugins.cocos;e.pluginVersion||(e.pluginVersion=o.get("plugin-version"))}else delete a.plugins;let s=[];for(var l=0,u=i.bundles.length;l<u;l++){var c=i.bundles[l];"subpackage"===c.compressionType&&s.push({name:c.name,root:"subpackages/"+c.name})}a.subpackages=s,t.combineBuildTemplateJson(i,a,r.basename(e.path)),e.contents=new Buffer(JSON.stringify(a,null,4))},"signature.json":function(e,t){if(!t.separateEngineMode)return e.contents=null,void 0;let n=JSON.parse(e.contents.toString());const i=o.readFileSync(r.join(t.dest,"cocos/cocos2d-js-min.js"));n.signature[0].md5=s.createHash("md5").update(i).digest("hex"),e.contents=new Buffer(JSON.stringify(n,null,4))},"plugin.json":function(e,t){t.separateEngineMode||(e.contents=null)}};module.exports={name:Editor.T("taobao-minigame.platform_name"),platform:"taobao-minigame",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){let t=Editor.Profile.load(n);e.startSceneAssetBundle=t.get("startSceneAssetBundle")||!1,e.separateEngineMode=!e.debug&&t.get("separate_engine"),e.globalVariable=t.get("globalVariable")},compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e){let t=e.dest;return[r.join(t,"**/*"),`!${r.join(t,"game.json")}`,`!${r.join(t,"mini.project.json")}`]},engineBuildPath:function(e){return r.join(e.dest,"cocos")},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(t,i){let o=null;try{(function(){if(!Editor.Profile.load(n))throw new Error("config file not found")})(),i.settings.server=Editor.Profile.load(n).get("remoteUrl"),await e.buildAdapter(i,null),await e.copyRes(i,"global-variables.js",l),function(){let e=Editor.Profile.load(n);Editor.Metrics.trackEvent("Project","BetaPlatforms","taobao-minigame",{orientation:e.get("deviceOrientation")})}()}catch(e){o=e}t.reply(o)},"build-finished":function(e,t){(function(e){const t=e.dest,n=/require\('(?=\w)/g,i=["game.js","ccRequire.js"];for(let e of i){const i=r.join(t,e);let a=o.readFileSync(i,"utf8");a=a.replace(n,"require('./"),o.writeFileSync(i,a)}})(t),function(e){const t=e.debug?"\n":"",n=e.dest,i=a.sync(r.join(n,"**/*.js")),s=Editor.url("packages://adapters/platforms/taobao-minigame/res/global-variables.js");let l=o.readFileSync(s,"utf8");l=l.replace(/\n/g,"");const u=e.globalVariable;u&&u.split(",").map(e=>e.trim()).forEach(e=>{l+=`var ${e} = window.${e};${t}`});for(let e of i){let t=o.readFileSync(e,"utf8");t=l+"\n"+t,o.writeFileSync(e,t,"utf8")}}(t);let i=null;try{(function(e){for(var t=0,n=e.bundles.length;t<n;t++){var i=e.bundles[t];if("subpackage"!==i.compressionType)continue;let n=r.join(i.scriptDest,"index.js");o.existsSync(n)&&o.renameSync(n,r.join(i.scriptDest,"game.js"))}})(t)}catch(e){i=e}let s=Editor.Profile.load(n),l={resUrl:s.get("remoteUrl"),orientation:s.get("deviceOrientation")};Editor.Ipc.sendToMain("builder:notify-build-result",t,l),e.reply(i)}},settings:Editor.url("packages://taobao-minigame/build-ui.js")};