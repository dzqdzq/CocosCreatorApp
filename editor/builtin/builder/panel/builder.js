"use strict";const e=require("fire-fs"),t=require("fire-path"),a=require("electron"),r=require("node-uuid"),i=Editor.require("app://editor/share/build-platforms"),o=require(Editor.url("packages://builder/utils/event")),s=require(Editor.url("packages://builder/utils/module-events")),l=require(Editor.url("app://editor/share/build-utils")),n=require(Editor.url("packages://builder/utils/network")),d=require(Editor.url("packages://builder/panel/platform/android")),c=require(Editor.url("packages://builder/panel/platform/web-desktop")),u=require(Editor.url("packages://builder/panel/platform/web-mobile")),p=require(Editor.url("packages://builder/panel/platform/fb-instant-games")),m=require(Editor.url("packages://builder/panel/platform/android-instant")),h=require(Editor.url("packages://builder/panel/platform/windows")),f=require(Editor.url("packages://builder/panel/platform/ios")),g=require(Editor.url("packages://builder/panel/platform/mac")),b=require("@electron/remote").dialog,{promisify:E}=require("util"),v=Editor.remote.Profile.load("global://settings.json"),P=Editor.remote.Profile.load("global://features.json"),_=Editor.require("app://editor/share/bundle-utils"),k={local:null,project:null,anysdk:null};let T=P.get("xiaomi-runtime")||!1,y=P.get("alipay-minigame")||!1,w=P.get("qtt-runtime")||!1,x=P.get("huawei-agc")||!1,j=P.get("link-sure")||!1,B=P.get("bytedance-minigame")||!1;const D=`https://creator-api.cocos.com/api/account/get_agreements?lang=${Editor.lang}`;Editor.Panel.extend({style:e.readFileSync(Editor.url("packages://builder/panel/builder.css")),template:e.readFileSync(Editor.url("packages://builder/panel/builder.html")),messages:{"builder:state-changed":function(e,t,a){if(this._vm){if(this._vm.setSystemBarProgress("error"===t||"finish"===t?-1:a),a*=100,"error"===t)return this._vm.buildProgress=a,this._vm.buildState="failed",this._vm.task="",void 0;if("finish"===t)return this._vm.buildProgress=100,this._vm.buildState="completed",this._vm.task="",void 0;this._vm.buildProgress=a,this._vm.buildState=t}},"builder:events":function(e,t,...a){o.emit(t,...a)},"keystore:created":function(e,t){this._vm.local.keystorePath=t.path,this._vm.local.keystorePassword=t.password,this._vm.local.keystoreAlias=t.alias,this._vm.local.keystoreAliasPassword=t.aliasPassword},"asset-db:assets-deleted":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"asset-db:assets-moved":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"asset-db:assets-created":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"inspector:bundle-updated":async function(e,t){await this.updateSceneData()}},async ready(){let o=this.profiles.local,E=this.profiles.project;o.get("actualPlatform")||o.set("actualPlatform",o.get("platform")),function(e){let t=e.get("platform"),a=Object.keys(i),r=a.includes(t);if(r)return;let o=Editor.remote.Builder.simpleBuildTargets[t];t=o&&o.extends||t,(r=a.includes(t))||(t="web-mobile",e.set("actualPlatform","web-mobile")),e.set("platform",t)}(o),function(e){let t=e.get("packageName");if(!t)return;const a=["android","android-instant","ios","mac"];for(let r of a){let a=e.get(r);a&&!a.packageName&&(a.packageName=t,e.set(r,a))}}(E);let P={},_=[u,d,m,c,p,h,f,g],S=Editor.remote.Builder.simpleBuildTargets;for(let e in S){let t=S[e];if(t.settings){let e=require(t.settings);!e.name&&(e.name=t.platform),_.push(e)}else Editor.warn("Can not load package",t.name)}_.forEach(e=>{e.props||(e.props={});for(let t in k)!e.props[t]&&(e.props[t]=k[t]);P[e.name]=e});let I={platforms:await async function(e){let t=["web-mobile","web-desktop","fb-instant-games","android",x?"huawei-agc":"HIDDEN","android-instant","ios",y?"alipay":"HIDDEN",w?"qtt-game":"HIDDEN",B?"bytedance":"HIDDEN",B?"bytedance-subcontext":"HIDDEN","jkw-game","huawei","quickgame","qgame",T?"xiaomi":"HIDDEN",j?"link-sure":"HIDDEN","baidugame","baidugame-subcontext","wechatgame","wechatgame-subcontext","cocos-runtime","qqplay","mac","win32"],a=[];a.push({value:"web-mobile",text:Editor.T("BUILDER.platforms.web-mobile")}),a.push({value:"web-desktop",text:Editor.T("BUILDER.platforms.web-desktop")}),a.push({value:"fb-instant-games",text:Editor.T("BUILDER.platforms.fb-instant-games")}),a.push({value:"android",text:Editor.T("BUILDER.platforms.android")}),a.push({value:"android-instant",text:Editor.T("BUILDER.platforms.android-instant")}),"darwin"===process.platform&&(a.push({value:"ios",text:Editor.T("BUILDER.platforms.ios")}),a.push({value:"mac",text:Editor.T("BUILDER.platforms.mac")})),"win32"===process.platform&&a.push({value:"win32",text:Editor.T("BUILDER.platforms.win32")});let r=Editor.remote.Builder.simpleBuildTargets,i=[];for(let e in r){let t=r[e];t.settings&&i.push({value:t.platform,text:t.name})}return a=a.concat(i),t.map(e=>{if("string"==typeof e)return a.find(t=>t.value===e);{let t=e[Editor.lang];return a.find(e=>e.text.replace(/\s/g,"").toLowerCase()===t.replace(/\s/g,"").toLowerCase())}}).filter(Boolean)}(),scenes:[],all:!1,task:"",record:"",buildState:"idle",buildProgress:0,anysdk:"zh"===Editor.lang,local:o.getSelfData(),project:E.getSelfData(),agreements:[],compressionTypes:[{value:"none",text:Editor.T("INSPECTOR.folder.none"),title:Editor.T("INSPECTOR.folder.none_tooltip")},{value:"default",text:Editor.T("INSPECTOR.folder.default"),title:Editor.T("INSPECTOR.folder.default_tooltip")},{value:"merge_all_json",text:Editor.T("INSPECTOR.folder.merge_all_json"),title:Editor.T("INSPECTOR.folder.merge_all_json_tooltip")},{value:"subpackage",text:Editor.T("INSPECTOR.folder.subpackage"),title:Editor.T("INSPECTOR.folder.subpackage_tooltip")},{value:"zip",text:Editor.T("INSPECTOR.folder.zip"),title:Editor.T("INSPECTOR.folder.zip_tooltip")}]};var R=this._vm=new window.Vue({el:this.shadowRoot,data:I,computed:{scenesInList(){return this.scenes.filter(e=>!e.hidden)},actualPlatform:{get(){return this.local.actualPlatform},set(e){this.local.platform=this._actualPlatform2Platform(e),this.local.actualPlatform=e,this.isCompressionTypeVisible(this.project.mainCompressionType)||(this.project.mainCompressionType="default")}},isNative(){return i[this.local.platform].isNative},isRuntime(){return"runtime"===this.local.platform},supportSubpackage(){return l.supportSubpackage(this.actualPlatform)},supportZip(){return l.supportZip(this.actualPlatform)},supportRemoteMain(){return i[this.local.platform].supportRemoteMain&&l.supportRemote(this.actualPlatform)},isRemoteBundleReadonly(){return"zip"===this.project.mainCompressionType||"subpackage"===this.project.mainCompressionType},needPlayBtn(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return!(!t||!t.buttons||"object"!=typeof t.buttons[1])||(!t||!t.buttons||t.buttons.includes(e.DefaultButtons.Play))},needCompile(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return t&&t.buttons?t.buttons.includes(e.DefaultButtons.Compile):i[this.local.platform].isNative},needUpload(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return!(!t||!t.buttons)&&t.buttons.includes(e.DefaultButtons.Upload)},supportCocosAnalytics(){return"windows"!==this.local.platform&&"mac"!==this.local.platform&&"bytedance-subcontext"!==this.local.actualPlatform&&"wechatgame-subcontext"!==this.local.actualPlatform&&"baidugame-subcontext"!==this.local.actualPlatform},argumentsLoaded(){return this.agreements.length>0},licenseAgreement:{get:function(){return this.agreements.length>0&&!this.agreements.find(e=>!this.project.agreements||!this.project.agreements[e.version])},set:function(e){this.agreements.forEach(t=>{Vue.set(this.project.agreements,t.version,e)})}}},watch:{local:{handler(e){this.saveLocalData()},deep:!0},project:{handler(e){this.saveProjectData()},deep:!0},licenseAgreement:{handler(e){Editor.Ipc.sendToMain("cocos-services:open-service","analytics",e,(e,t)=>{},-1)}},scenes:{handler(e){var t=this.project.startScene,a=!1;for(let i=0;i<e.length;i++){let o=e[i];if(o.text.startsWith("db://assets/resources/")||t===o.value)a=!0;else{var r=this.project.excludeScenes.indexOf(o.value);o.checked||-1!==r?o.checked&&-1!==r&&this.project.excludeScenes.splice(r,1):this.project.excludeScenes.push(o.value)}}e.length>0&&!a&&(this.project.startScene=e[0].value),this.all=this.scenes.every(function(e){return e.checked})},deep:!0}},async created(){this.fetchAgreements(),this.fetchTaobaoLicense()},components:P,methods:{async fetchAgreements(){try{let e=await n.getAsync(D);0===(e=JSON.parse(e)).status&&R.$set("agreements",e.data)}catch(e){}},async fetchTaobaoLicense(){if(await Editor.User.hasLicense("taobao-creativeapp")){let e=S.taobao;this.platforms.unshift({value:e.platform,text:e.name})}else"taobao"===this.local.actualPlatform&&(this.actualPlatform=this.platforms[0].value)},jumpClick(e){a.shell.openExternal(e)},_mainCompressionTypeChanged(){this.supportRemoteMain?this.isRemoteBundleReadonly&&("subpackage"===this.project.mainCompressionType?this.project.mainIsRemote=!1:"zip"===this.project.mainCompressionType&&(this.project.mainIsRemote=!0)):this.project.mainIsRemote=!1},isCompressionTypeVisible(e){return"subpackage"===e?this.supportSubpackage:"zip"!==e||this.supportZip},setSystemBarProgress(e){Editor.Ipc.sendToMain("builder:update-system-progress",e)},saveLocalData(){Object.keys(this.local).forEach(e=>{o.set(e,this.local[e])}),o.save()},saveProjectData(){Object.keys(this.project).forEach(e=>{E.set(e,this.project[e])}),E.save()},t:e=>Editor.T(e),_actualPlatform2Platform(e){let t=Editor.remote.Builder.simpleBuildTargets[e];return t&&t.extends||e},_onOpenCompileLogFile(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:open-cocos-console-log")},_onChooseDistPathClick(e){e.stopPropagation();let a=Editor.Dialog.openFile({defaultPath:l.getAbsoluteBuildPath(this.local.buildPath),properties:["openDirectory"]});a&&a[0]&&(t.contains(Editor.Project.path,a[0])?(this.local.buildPath=t.relative(Editor.Project.path,a[0]).replace(/\\/g,"/"),""===this.local.buildPath&&(this.local.buildPath="./")):this.local.buildPath=a[0])},_onShowInFinderClick(t){t.stopPropagation();let r=l.getAbsoluteBuildPath(this.local.buildPath);if(!e.existsSync(r))return Editor.warn("%s not exists!",r),void 0;a.shell.showItemInFolder(r),a.shell.beep()},_onSelectAllCheckedChanged(e){if(!this.scenes)return;let t=this.project.startScene;for(let r=0;r<this.scenes.length;r++){let i=this.scenes[r];if(!i.text.startsWith("db://assets/resources/")&&t!==i.value){i.checked=e.detail.value;var a=this.project.excludeScenes.indexOf(i.value);i.checked||-1!==a?i.checked&&-1!==a&&this.project.excludeScenes.splice(a,1):this.project.excludeScenes.push(i.value)}}},startTask(e,t){this.task=e;let a=Editor.Profile.load("project://project.json");t.excludedModules=a.get("excluded-modules"),Editor.Ipc.sendToMain("builder:start-task",e,t)},_onBuildClick(e){e.stopPropagation(),Editor.Ipc.sendToPanel("scene","scene:query-dirty-state",(e,t)=>{if(t.dirty)return Editor.error(t.name+" "+Editor.T("BUILDER.error.dirty_info")),void 0;this._build()})},async _build(){this.saveLocalData();var a=l.getAbsoluteBuildPath(this.local.buildPath),r=t.win32.dirname(a),n=this.local.platform;let d=i[n].isNative;if(!e.existsSync(r))return b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_dir_not_exists",{buildDir:r})),void 0;if(-1!==a.indexOf(" "))return b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_space")),void 0;if(/.*[\u4e00-\u9fa5]+.*$/.test(a))return b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_chinese")),void 0;if(!/^[a-zA-Z0-9_-]*$/.test(this.project.title))return b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.project_name_not_legal")),void 0;let c=l.getOptions(E,o);c.separateEngineMode=!1;let u=this.$children[0];if(!u||!u.checkParams||await u.checkParams(c)){Editor.Ipc.sendToAll("builder:state-changed","ready",0);var p=this.scenes.filter(function(e){return e.checked}).map(function(e){return e.value});if(p.length>0){c.actualPlatform=this.local.actualPlatform,c.scenes=p;let e=c.platform;e&&(d&&"android-instant"!==e&&(c.inlineSpriteFrames=c.inlineSpriteFrames_native),c.embedWebDebugger=("web-mobile"===e||"fb-instant-games"===e)&&c.embedWebDebugger),this.startTask("build",c),Editor.Ipc.sendToMain("metrics:track-event",{category:"Project",action:"Build",label:c.actualPlatform||e}),s.trackModuleEvent()}else b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.select_scenes_to_build"))}},_onCompileClick(e){e.stopPropagation(),this.startTask("compile",l.getOptions(E,o))},_onStopCompileClick:function(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:stop-compile")},_onPreviewClick(a){if(a.stopPropagation(),"android-instant"===this.local.platform&&!e.existsSync(t.join(v.get("android-sdk-root"),"extras/google/instantapps/ia")))return b.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.instant_utils_not_found")),void 0;var r=l.getOptions(E,o),i=Editor.remote.Builder,s=i.simpleBuildTargets[this.local.actualPlatform];if(s&&s.buttons){let e="object"==typeof s.buttons[1];if(e||s.buttons.includes(i.DefaultButtons.Play))if(e){let e=s.buttons[1].message;Editor.Ipc.sendToMain(`${s.package}:${e}`,r)}else Editor.Ipc.sendToMain(`${s.package}:play`,r)}else Editor.Ipc.sendToMain("app:run-project",r)},_onUploadClick(e){e.stopPropagation();let t=Editor.remote.Builder,a=t.simpleBuildTargets[this.local.actualPlatform];a&&a.buttons&&a.buttons.includes(t.DefaultButtons.Upload)&&Editor.Ipc.sendToMain(`${a.package}:upload`,l.getOptions(E,o))},_openExternal(e,t){e.stopPropagation(),a.shell.openExternal(`${t}?_t=${Date.now()}`)},_onRecordClick(e){let a=function(e){return["FullYear","Month","Date","Hours","Minutes","Seconds"].map(t=>{let a=e[`get${t}`]();return"Month"===t&&a++,a<10&&(a="0"+a),a}).join("")}(new Date),r=t.join(Editor.Project.path,`/temp/android-instant-games/profiles/${a}`);Editor.Ipc.sendToMain("app:play-on-device",{platform:"simulator",recordPath:r})},_onRefactorClick(e){Editor.Panel.open("google-instant-games")}}});R.project.title||(R.project.title=Editor.Project.name),R.project.xxteaKey||(R.project.xxteaKey=r.v4().substr(0,16)),R.local.buildPath||(R.local.buildPath="./build"),Editor.Ipc.sendToMain("builder:query-current-state",(e,t)=>{if(e)return Editor.warn(e);R.task=t.task,Editor.Ipc.sendToAll("builder:state-changed",t.state,t.progress)}),await this.updateSceneData()},async updateSceneData(){let e=await _.queryBundlesWithScenes(),t=this._udpateExcludeScenes(e);this._updateSceneList(e),this._updateStartSceneList(),t&&this._vm.project.save()},_udpateExcludeScenes(e){let t=this._vm.project.excludeScenes,a=[];for(let t in e)a.push(...e[t]);let r=!1;for(let e=0;e<t.length;e++){let i=t[e];a.some(e=>e.uuid===i)||(r=!0,t.splice(e--,1))}return r},_updateSceneList(e){let t=this._vm.project.excludeScenes,a=this._vm.scenes;a.length=0;let r=[];for(let t in e)r.push(...e[t]);let i=[];["main","resources"].forEach(t=>{let a=e[t];a&&i.push(...a)}),i=i.map(e=>e.uuid),r.forEach(e=>{let o=i.includes(e.uuid);a.push({value:e.uuid,text:e.url,checked:!o||1===r.length||!t.includes(e.uuid),hidden:!o})})},_updateStartSceneList(){let e=this._vm.project,t=this._vm.scenes,a=e.startScene,r=!!t.find(function(e){return e.value===a&&!e.hidden});a&&r||((t=t.filter(e=>!e.hidden)).length>0?e.startScene=t[0].value:e.startScene="")}});