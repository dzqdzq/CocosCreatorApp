const e=require("fire-fs"),t=require("fire-path"),n=require("json5"),i=Editor.require("app://editor/share/3d-physics-build-utils"),s=require("ejs"),r="frameworks/runtime-src/proj.harmonyos-next/entry/src/main/ets/cocos",o="frameworks/runtime-src/proj.harmonyos-next/entry/src/main/resources/rawfile";function a(t,i){try{const s=e.readFileSync(t,"utf8");let r="";r=t.endsWith(".json5")?n.stringify(i(n.parse(s)),null,2):JSON.stringify(i(JSON.parse(s)),null,2),e.writeFileSync(t,r.replace(/'/g,'"'))}catch(e){Editor.error(t,e)}}function l(e,t,n){const i=new RegExp(`set\\(${t}\\s+(OFF|ON)\\)`);return e.replace(i,`set(${t} ${n})`)}const c=[{jsEngine:"V8",macro:"CC_USE_SE_V8"},{jsEngine:"Ark",macro:"CC_USE_SE_NAPI"},{jsEngine:"JSVM",macro:"CC_USE_SE_JSVM"}];module.exports={name:Editor.T("harmonyos-next.title"),platform:"harmonyos-next",ui:{md5Cache:!1,sourceMap:!1,cocosAnalytics:!1},buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){},compileFlags:()=>({support_jit:!1,force_setting_support_jit:!1}),delPattern:e=>{let n=[t.join(e.dest,o,"assets/**/*"),t.join(e.dest,r,"assets/**/*"),t.join(e.dest,r,"src/**/*")];return e.buildScriptsOnly&&(n.push("!"+t.join(e.dest,o,"assets/**/*")),n.push("!"+t.join(e.dest,r,"assets/**/*"))),n},messages:{"build-finished":async function(n,r){try{const o=t.join(r.dest,"frameworks/runtime-src/proj.harmonyos-next"),p=r["harmonyos-next"],u=t.join(o,"CMakeLists.txt"),d=p.jsEngine,m="V8"===d||"JSVM"===d;let j=e.readFileSync(u,"utf8");c.forEach(e=>{j=e.jsEngine===d?l(j,e.macro,"ON"):l(j,e.macro,"OFF")}),e.writeFileSync(u,j,{encoding:"utf8"});const g=t.join(o,"entry/src/main/ets/workers/cocos_worker.ts"),y=await s.renderFile(g,{useV8:m});e.writeFileSync(g,y,{encoding:"utf8"});const f=t.join(o,"entry/src/main/ets/cocos");if(m)e.removeSync(t.join(f,"index.js")),e.removeSync(t.join(f,"game.ts"));else{let n="";r.bundles.forEach(e=>{const i=t.relative(f,t.join(e.scriptDest,"index.js")).replace(/\\/g,"/");n+=`    '${i}': () => { require('./${i}'); },\n`});const s="const commonJSModuleMap = {\n"+n+"};",o=t.join(f,"index.js");let a=e.readFileSync(o,"utf8");i.getPhysicsModule(r.excludedModules)||(a=a.replace("require('./src/physics.js');","")),a=a.replace("<%commonJSModuleMap%>",s),e.writeFileSync(o,a,"utf8")}a(t.join(o,"oh-package.json5"),e=>(e.name=r.title,e)),a(t.join(o,"entry/src/main/resources/base/element/string.json"),e=>(e.string=e.string.map(e=>("MainAbility_label"===e.name&&(e.value=r.title),e)),e)),a(t.join(o,"AppScope/resources/base/element/string.json"),e=>(e.string=e.string.map(e=>("app_name"===e.name&&(e.value=r.title),e)),e)),a(t.join(o,"AppScope/app.json5"),e=>(e.app&&(e.app.bundleName=p.packageName),e)),a(t.join(o,"entry/src/main/module.json5"),e=>{if(e.module&&e.module.abilities[0]){let t="portrait";const{landscapeLeft:n,landscapeRight:i,portrait:s,upsideDown:o}=r.orientation;n&&i&&s?t="auto_rotation":i&&!n?t="landscape_inverted":!i&&n?t="landscape":i&&n?t="auto_rotation_landscape":!s&&o?t="portrait_inverted":s&&(t="portrait"),e.module.abilities[0].orientation=t}return e}),a(t.join(o,"entry/build-profile.json5"),e=>{if(e.buildOption&&e.buildOption.externalNativeOptions){e.buildOption.externalNativeOptions.abiFilters=r.appABIs;const n=t.resolve(function(){let e=Editor.Profile.load("local://settings.json");return!1!==e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json")),e.get("use-default-cpp-engine")?Editor.builtinCocosRoot:e.get("cpp-engine-path")}());e.buildOption.externalNativeOptions.arguments=e.buildOption.externalNativeOptions.arguments.replace(/\${COCOS_X_PATH}/g,n)}return e}),n.reply()}catch(e){n.reply(e)}}},settings:Editor.url("packages://harmonyos-next/ui/index.js")};