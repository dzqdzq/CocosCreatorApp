var{exec:n,execSync:t}=require("child_process"),e=require("path"),i=require("fire-fs"),o=require("fix-path"),r=require("net");function s(n){var t=new r.Socket,e=!1;t.connect("443","www.google-analytics.com",()=>{t.end(),!1===e&&(e=!0,n(!0))}),setTimeout(function(){t.end(),!1===e&&(e=!0,n(!1))},1e3)}let a={init:function(n,t,e){this.options=n,this.initEnvironmentPath(t,e)},initVivoProject:function(t){Editor.log(Editor.T("vivo-runtime.installing_npm_network")),n("mg init qgame --force",{env:this.environmentPath,cwd:e.join(this.options.dest,"..")},n=>{t(n)})},initEnvironmentPath:function(n,t){this.environmentPath={},n?(Editor.log(Editor.T("vivo-runtime.custom_npm_path_config"),n),"win32"===process.platform?this.environmentPath.Path=n:(this.environmentPath.PATH=n,this.environmentPath.PATH+=":/usr/bin:/bin:/usr/sbin:/sbin")):(t&&Editor.log(Editor.T("vivo-runtime.custom_npm_path_not_config")),o(),this.environmentPath=process.env)},isInitVivoProject:function(){return!(!i.existsSync(e.join(this.options.dest,"node_modules"))||i.existsSync(e.join(this.options.dest,"node_modules",".staging")))},isInstallVivoMinigameTool:function(){try{result=t("mg -v",{env:this.environmentPath})}catch(n){return!1}return!0},isCliProject:function(){return!!i.existsSync(e.join(this.options.dest,"node_modules","@vivo-minigame"))},getEnvirommentPath:function(){return this.environmentPath},isInstallNodeJs:function(n,e){try{t("node -v",{env:this.environmentPath})}catch(t){return e?(n.reply(new Error(Editor.T("vivo-runtime.custom_npm_path_config_error"))),void 0):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),n.reply(),"win32"===process.platform?Editor.log(Editor.T("vivo-runtime.not_install_nodejs_windows_error")):Editor.log(Editor.T("vivo-runtime.not_install_nodejs_mac_error")),!1)}return!0},isInstallQGameAdapter:function(){return!!i.existsSync(this.getQGameAdapterPath())},installQGameAdapter:function(t){var e=this;s(function(i){if(!1===i)return t("no internet"),void 0;var o="win32"===process.platform?"npm.cmd":"npm";n(`${o} i -S @qgame/adapter@latest`,{env:e.environmentPath,cwd:e.options.dest},n=>{t(n)})})},isLatestVersion:function(t){let o=this;s(function(r){if(!1===r)return t(!1),void 0;if(!o.isInstallQGameAdapter())return t(!1),void 0;var s=e.join(o.options.dest,"node_modules","@qgame","adapter","package.json"),a=i.readJsonSync(s,{throws:!1});if(null===a)return t(!1),void 0;Editor.log("the current version @qgame/adapter is:",a.version);var d="win32"===process.platform?"npm.cmd":"npm";n(`${d} view @qgame/adapter@latest version`,{env:o.environmentPath,cwd:o.options.dest},(n,e)=>{if(n)return t&&t(o.isInstallQGameAdapter(),n),void 0;let i=e.toString().trim();if(Editor.log("the latest version of @qgame/adapter is:",i),a&&a.version===i)return t(!0),void 0;t(!1)})})},getQGameAdapterPath:function(){return e.join(this.options.dest,"node_modules","@qgame","adapter","dist","main.js")},isSupportSeparateEngine:function(n){var t=e.join(this.options.dest,"package.json"),o=i.readJsonSync(t,{throws:!1}).devDependencies["@vivo-minigame/cli-service"];return parseInt(o.replace(/[^\d]/g,""))>=parseInt("1.3.0".replace(/[^\d]/g,""))},installDepend:function(t){var e="win32"===process.platform?"npm.cmd":"npm";n(`${e} i`,{env:this.environmentPath,cwd:this.options.dest},n=>{t(n)})}};module.exports=a;