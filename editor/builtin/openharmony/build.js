const e=require("fire-fs"),t=require("fire-path"),n=require("json5"),i=Editor.require("app://editor/share/3d-physics-build-utils"),r="frameworks/runtime-src/proj.openharmony/entry/src/main/ets/cocos";function o(t,i){try{const r=e.readFileSync(t,"utf8");let o="";o=t.endsWith(".json5")?n.stringify(i(n.parse(r)),null,2):JSON.stringify(i(JSON.parse(r)),null,2),e.writeFileSync(t,o.replace(/'/g,'"'))}catch(e){Editor.error(t,e)}}module.exports={name:Editor.T("openharmony.title"),platform:"openharmony",ui:{md5Cache:!1,sourceMap:!1,cocosAnalytics:!1},buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){},compileFlags:()=>({support_jit:!1,force_setting_support_jit:!1}),delPattern:e=>{let n=[t.join(e.dest,"frameworks/runtime-src/proj.openharmony/entry/src/main/resources/rawfile","assets/**/*"),t.join(e.dest,r,"assets/**/*"),t.join(e.dest,r,"src/**/*")];return e.buildScriptsOnly&&(n.push("!"+t.join(e.dest,"frameworks/runtime-src/proj.openharmony/entry/src/main/resources/rawfile","assets/**/*")),n.push("!"+t.join(e.dest,r,"assets/**/*"))),n},messages:{"build-finished":function(n,r){const s=t.join(r.dest,"frameworks/runtime-src/proj.openharmony"),a=t.join(s,"entry/src/main/ets/cocos");let l="";r.bundles.forEach(e=>{const n=t.relative(a,t.join(e.scriptDest,"index.js")).replace(/\\/g,"/");l+=`    '${n}': () => { require('./${n}'); },\n`});const p="const commonJSModuleMap = {\n"+l+"};",c=t.join(a,"index.js");let u=e.readFileSync(c,"utf8");i.getPhysicsModule(r.excludedModules)||(u=u.replace("require('./src/physics.js');","")),u=u.replace("<%commonJSModuleMap%>",p),e.writeFileSync(c,u,"utf8"),o(t.join(s,"oh-package.json5"),e=>(e.name=r.title,e)),o(t.join(s,"entry/src/main/resources/base/element/string.json"),e=>(e.string=e.string.map(e=>("MainAbility_label"===e.name&&(e.value=r.title),e)),e)),o(t.join(s,"AppScope/resources/base/element/string.json"),e=>(e.string=e.string.map(e=>("app_name"===e.name&&(e.value=r.title),e)),e)),o(t.join(s,"AppScope/app.json5"),e=>(e.app&&(e.app.bundleName=r.openharmony.packageName),e)),o(t.join(s,"build-profile.json5"),e=>(e.app&&(e.app.compileSdkVersion=parseInt(r.apiLevel),e.app.compatibleSdkVersion=parseInt(r.apiLevel)),e)),o(t.join(s,"entry/src/main/module.json5"),e=>{if(e.module&&e.module.abilities[0]){let t="portrait";const{landscapeLeft:n,landscapeRight:i,portrait:o,upsideDown:s}=r.orientation;n&&i&&o?t="auto_rotation":i&&!n?t="landscape":!i&&n?t="landscape_inverted":i&&n?t="auto_rotation_landscape":!o&&s?t="portrait_inverted":o&&(t="portrait"),e.module.abilities[0].orientation=t}return e}),o(t.join(s,"entry/build-profile.json5"),e=>{if(e.buildOption&&e.buildOption.externalNativeOptions){e.buildOption.externalNativeOptions.abiFilters=r.appABIs;const n=t.resolve(function(){let e=Editor.Profile.load("local://settings.json");return!1!==e.get("use-global-engine-setting")&&(e=Editor.Profile.load("global://settings.json")),e.get("use-default-cpp-engine")?Editor.builtinCocosRoot:e.get("cpp-engine-path")}());e.buildOption.externalNativeOptions.arguments=e.buildOption.externalNativeOptions.arguments.replace(/\${COCOS_X_PATH}/g,n)}return e}),n.reply()}},settings:Editor.url("packages://openharmony/ui/index.js")};