const e=require("browserify"),i=require("babelify"),r=require("vinyl-source-stream"),s=require("vinyl-buffer"),n=require("path"),t=require("gulp"),u=require("./build-platforms"),l={"3D Physics/Builtin":"physics_builtin","3D Physics/cannon.js":"physics_cannon"},o={},c=[[require("@babel/preset-env"),{loose:!0}],{plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}]]},[require("@babel/preset-typescript"),{allowDeclareFields:!0}]],p=[[require("babel-plugin-const-enum"),{transform:"constObject"}],[require("babel-plugin-add-module-exports")]];o.getPhysicsModule=function(e,i){let r=Object.keys(l);return 0===(r=r.filter(i=>!e.includes(i))).length?null:r.length>1?(i&&i(),"3D Physics/cannon.js"):r[0]},o.getPhysicsEntries=function(e){let i=Editor.require("unpack://engine/modules.json"),r=Editor.url("unpack://engine"),s=i.find(e=>"3D Physics Framework"===e.name);if(!s)throw new Error("can't find physics framework module");let t=s.entries,u=i.find(i=>i.name===e);if(!u)throw new Error(`can't find physics moduel '${e}'`);return t=(t=t.concat(u.entries)).map(e=>n.join(r,e))},o.getPhysicsBuildFlags=function(e){let i={};return Object.keys(l).forEach(e=>{i[l[e]]=!1}),e&&(i[l[e]]=!0),i},o.build=function({dest:l,excludedModules:o,debug:a,platform:d}){return new Promise((h,y)=>{let g=this.getPhysicsModule(o,()=>{Editor.warn(Editor.T("BUILDER.physics_module_undefined"))});if(!g)return h();Editor.log("Building 3D physics modules...");let m=this.getPhysicsEntries(g),b=this.getPhysicsBuildFlags(g),f=u[d].isNative,j="runtime"===d,q="openharmony"===d,E={jsb:f&&!j,runtime:j,minigame:"mini-game"===d,debug:a};b&&Object.assign(E,b);let w=new e({extensions:[".js",".ts"],entries:m});const P=Editor.require("unpack://engine/gulp/util/utils"),k=Editor.require("unpack://engine/gulp/util/handleErrors.js");let D=f?n.join(l,"src"):l;q&&(D=n.join(l,"frameworks/runtime-src/proj.openharmony/entry/src/main/ets/cocos","src"));let x=w.transform(i,{extensions:[".js",".ts"],presets:c,plugins:p}).bundle().on("error",k.handler).pipe(k()).pipe(r(f?"physics.js":a?"physics.js":"physics-min.js")).pipe(s()).pipe(P.uglify("build",E)).pipe(t.dest(D));x.once("error",y),x.on("end",h)})},o.updateMinigameRequire=function({debug:e,excludedModules:i},r,s){if(this.getPhysicsModule(i)){let i=s||(e?"require('physics.js');":"require('physics-min.js');");r=r.replace("require('physics-js-path');",i)}else r=r.replace("require('physics-js-path');","");return r},module.exports=o;