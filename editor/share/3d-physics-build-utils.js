const e=require("browserify"),r=require("babelify"),s=require("vinyl-source-stream"),i=require("vinyl-buffer"),n=require("path"),t=require("gulp"),o=require("./build-platforms"),u={"3D Physics/Builtin":"physics_builtin","3D Physics/cannon.js":"physics_cannon"},l={},c=[[require("@babel/preset-env"),{loose:!0}],{plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}]]},[require("@babel/preset-typescript"),{allowDeclareFields:!0}]],a=[[require("babel-plugin-const-enum"),{transform:"constObject"}],[require("babel-plugin-add-module-exports")]];l.getPhysicsModule=function(e,r){let s=Object.keys(u);return 0===(s=s.filter(r=>!e.includes(r))).length?null:s.length>1?(r&&r(),"3D Physics/cannon.js"):s[0]},l.getPhysicsEntries=function(e){let r=Editor.require("unpack://engine/modules.json"),s=Editor.url("unpack://engine"),i=r.find(e=>"3D Physics Framework"===e.name);if(!i)throw new Error("can't find physics framework module");let t=i.entries,o=r.find(r=>r.name===e);if(!o)throw new Error(`can't find physics moduel '${e}'`);return t=(t=t.concat(o.entries)).map(e=>n.join(s,e))},l.getPhysicsBuildFlags=function(e){let r={};return Object.keys(u).forEach(e=>{r[u[e]]=!1}),e&&(r[u[e]]=!0),r},l.build=function(u){const{dest:l,excludedModules:p,debug:d,platform:h}=u;return new Promise((y,m)=>{let g=this.getPhysicsModule(p,()=>{Editor.warn(Editor.T("BUILDER.physics_module_undefined"))});if(!g)return y();Editor.log("Building 3D physics modules...");let b=this.getPhysicsEntries(g),f=this.getPhysicsBuildFlags(g),j=o[h].isNative,q="runtime"===h,E="mini-game"===h,w="harmonyos-next"===h;const P=u["harmonyos-next"],k=w&&"V8"===P.jsEngine||"JSVM"===P.jsEngine;let x={jsb:j&&!q,runtime:q,minigame:E,debug:d};f&&Object.assign(x,f);let D=new e({extensions:[".js",".ts"],entries:b});const M=Editor.require("unpack://engine/gulp/util/utils"),B=Editor.require("unpack://engine/gulp/util/handleErrors.js");let v=j?n.join(l,"src"):l;w&&(v=k?n.join(l,"frameworks/runtime-src/proj.harmonyos-next/entry/src/main/resources/rawfile","src"):n.join(l,"frameworks/runtime-src/proj.harmonyos-next/entry/src/main/ets/cocos","src"));let F=D.transform(r,{extensions:[".js",".ts"],presets:c,plugins:a}).bundle().on("error",B.handler).pipe(B()).pipe(s(j?"physics.js":d?"physics.js":"physics-min.js")).pipe(i()).pipe(M.uglify("build",x)).pipe(t.dest(v));F.once("error",m),F.on("end",y)})},l.updateMinigameRequire=function({debug:e,excludedModules:r},s,i){if(this.getPhysicsModule(r)){let r=i||(e?"require('physics.js');":"require('physics-min.js');");s=s.replace("require('physics-js-path');",r)}else s=s.replace("require('physics-js-path');","");return s},module.exports=l;