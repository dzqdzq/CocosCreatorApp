"use strict";const t=require("path"),e=require("../../../asset-db");Editor.metaBackupPath="temp/RemovedMetas",Editor.assetBackupPath="temp/BackupAssets",Editor.log("Initializing Asset Database");const a=new e({cwd:t.join(Editor.Project.path),library:"library",dev:Editor.dev,cachePath:t.join(Editor.Project.path,"temp/general-asset-caches"),metaBackupPath:t.join(Editor.Project.path,Editor.metaBackupPath),assetBackupPath:t.join(Editor.Project.path,Editor.assetBackupPath)});Editor.libraryPath=a.library,Editor.importPath=a._importPath,Editor.externalMounts=function(e){if(!e||!Array.isArray(e))return null;for(var a=[],i=["assets","internal"],n=0,r=e.length;n<r;n++){let r=e[n];if(r=t.isAbsolute(r)?t.normalize(r):t.normalize(t.join(Editor.Project.path,r)),!_checkMountValid(r)){Editor.warn(`${r} is not a valid mount path.`);continue}let o=_getUniqueName(t.basename(r),i);i.push(o),a.push({path:r,name:o})}return a}(Editor.argv.mount),Editor.mountsWritable=Editor.argv.writable;const i=["asset-db:watch-state-changed","asset-db:state-changed"];let n;a.setEventCallback((t,e)=>{i.indexOf(t)>=0?Editor.Window.main&&Editor.Ipc.sendToMainWin(t,e):Editor.Ipc.sendToAll(t,e)});let r=!0;module.exports=new class{get loading(){return!!this.loadingWin}set loading(t){t=!!t;let e=Editor.Window.main;t&&e&&e.nativeWin.webContents.send("update-loading-tips",Editor.T("MESSAGE.assets.import_waiting"))}constructor(t){this.assetdb=t}async mountInternal(){return new Promise((t,e)=>{Editor.assetdb.mount(Editor.url("unpack://static/default-assets/"),"internal",{hidden:!Editor.showInternalMount,readonly:!Editor.dev},a=>{a?e(a):t()})})}async mountExternal(){if(Editor.externalMounts&&0!==Editor.externalMounts.length)return Promise.all(Editor.externalMounts.map(t=>new Promise((e,a)=>{Editor.assetdb.mount(t.path,t.name,{readonly:!Editor.mountsWritable},t=>{t?a(t):e()})})))}async mountMain(){return new Promise((e,a)=>{Editor.assetdb.mount(t.join(Editor.Project.path,"assets"),"assets",t=>{t?a(t):e()})})}async init(){return new Promise((t,e)=>{Editor.assetdb.init((e,a)=>{Editor.assetdbInited=!0,t()})})}runDBWatch(t){if(n||(n=Editor.Profile.load("global://settings.json"),r=n.get("watch-file"),n.on("changed",()=>{r=n.get("watch-file")})),r)switch(t){case"off":this.assetdb.watchOFF();break;case"on":this.assetdb.watchON()}}}(a);