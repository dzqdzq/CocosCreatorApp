"use strict";const{ipcMain:e}=require("electron"),t=require("path");var i,r,n,s,o,a=!1;function c(){var e=Editor.require("app://asset-db/lib/meta").get(Editor.assetdb,Editor.currentSceneUuid),t=Editor.stashedScene.sceneJson;if(e){var i=JSON.parse(t),r=Editor.serialize.findRootObject(i,"cc.SceneAsset");r?r.asyncLoadAssets=e.asyncLoadAssets:Editor.warn("Can not find cc.SceneAsset in stashed scene");var n=Editor.serialize.findRootObject(i,"cc.Scene");return n?n.autoReleaseAssets=e.autoReleaseAssets:Editor.warn("Can not find cc.Scene in stashed scene"),JSON.stringify(i)}return t}let d={userMiddlewares:[],_previewPort:7456,_listenByPort(e,t){n?(n.close(),function e(t,i,r){function n(){t.removeListener("error",s),r(null,i)}function s(s){if(t.removeListener("listening",n),"EADDRINUSE"!==s.code&&"EACCES"!==s.code)return r(s);Editor.warn(`The current '${i}' preview port is already occupied, the port is automatically incremented`),e(t,++i,r)}t.once("error",s),t.once("listening",n),t.listen(i)}(n,e,(e,i)=>{if(e)return Editor.warn(e),t&&t(e),void 0;this._previewPort=i,Editor.success(`preview server running at http://localhost:${i}`),Editor.Ipc.sendToAll("preview-server:preview-port-changed",i),t&&t()})):t&&t()},start:function(t,a){var d=require("fire-fs"),u=require("fire-path"),l=require("os"),p=require("del"),f=require("express"),g=require("http"),v=require("mobile-detect"),h=require("async");const m=require("compression");var j=this;this._validateStashedScene=t;var E=u.join(l.tmpdir(),"fireball-game-builds");p.sync(u.join(E,"**/*").replace(/\\/g,"/"),{force:!0}),(r=f()).use(m());let w=u.join(Editor.Project.path,"preview-templates");d.existsSync(w)||(w=Editor.url("unpack://static/preview-templates")),r.set("views",w),r.set("view engine","jade");const b=require("ejs");function S(e,t){var i=e.params[1];if(Editor.stashedScene&&Editor.currentSceneUuid&&u.basenameNoExt(i)===Editor.currentSceneUuid)return t.send(c()),void 0;i=u.join(Editor.importPath,i),t.sendFile(i)}r.engine("html",b.renderFile),r.engine("ejs",b.renderFile),r.locals.basedir=r.get("views"),r.use(function(e,t,i){var r=j.userMiddlewares;Array.isArray(r)&&r.length>0?h.eachSeries(r,(i,r)=>{if(!i)return Editor.warn("Web Preview: Invalid element in userMiddlewares, please check your editor packages."),r(null);i(e,t,r)},i):i()}),r.use("/build",function(e,t,i){s?s(e,t,i):t.send("Please build your game project first!")}),r.use("/preview-android-instant",function(e,t,i){o?o(e,t,i):t.send("Please build your android instant project first!")}),r.get("/",function(e,t){var i=e.headers["user-agent"],r=new v(i),n=d.existsSync(u.join(Editor.Project.path,"library","bundle.project.js")),s=-1!==i.indexOf("MicroMessenger");let o=Editor.require("app://editor/share/quick-compile/check-auto-build-engine")()?".cache/dev/__quick_compile__.js":"cocos2d-js-for-preview.js",a=!0,c=!1,l=Editor.Profile.load("project://project.json").get("excluded-modules");l&&(a=!l.includes("3D Physics/cannon.js"),c=!l.includes("3D Physics/Builtin"));let p={title:"CocosCreator | "+Editor.Project.name,cocos2d:o,hasProjectScript:n,tip_sceneIsEmpty:Editor.T("PREVIEW.scene_is_empty"),enableDebugger:!!r.mobile()||s,enableCannonPhysics:a,enableBuiltinPhysics:c};try{Object.assign(p,d.readJsonSync(u.join(w,"configs/options.json")))}catch(e){}t.render(d.existsSync(u.join(w,"index.html"))?"index.html":d.existsSync(u.join(w,"index.ejs"))?"index.ejs":"index",p)}),r.get("/compile",function(e,t){Editor.Compiler.compileScripts(!1,(e,i)=>{i||(e?(t.send("Compiling script successful!"),Editor.Compiler.reload()):t.send("Compile failed!"))})}),r.get("/update-db",function(e,t){Editor.assetdb.submitChanges(),t.send("Changes submitted")}),r.get(["/app/engine/*","/engine/*"],function(e,t){var i=u.join(Editor.url("unpack://engine"),e.params[0]);t.sendFile(i)}),r.get("/engine-dev/*",function(e,t){var i=u.join(Editor.url("unpack://engine-dev"),e.params[0]);t.sendFile(i)}),r.get("/app/editor/static/*",function(e,t){var i=Editor.url("unpack://static/"+e.params[0]);t.sendFile(i)}),r.get("/app/*",function(e,t){var i=Editor.url("app://"+e.params[0]);t.sendFile(i)}),r.get("/project/*",function(e,t){var i=u.join(Editor.Project.path,e.params[0]);t.sendFile(i)}),r.get("/preview-scripts/*",function(e,t){let i=Editor.ProjectCompiler.DEST_PATH;var r=u.join(i,e.params[0]);t.sendFile(r)}),r.get("/plugins/*",function(e,t){var i=e.params[0];i=Editor.assetdb._fspath("db://"+i),t.sendFile(i)}),r.get("/assets/*/import/*",S),r.get("/assets/*/native/*",S),r.get("/assets/*/config.json",function(e,t){j.query(`${e.params[0]}/config.json`,function(e,i){if(e)return t.status(404).send({error:e.message});t.send(i)})}),r.get("/assets/*/index.js",function(e,t){t.send("")}),r.get("/settings.js",function(e,t){j.query("settings.js",function(e,i){if(e)return a(e);t.send(i)})}),r.get("/preview-scene.json",function(e,t){j.getPreviewScene(function(e){return a(e)},function(e){t.send(e)},function(e){t.sendFile(e)})}),r.get("/*",function(e,t,i){return f.static(w)(e,t,i)}),r.use(function(e,t,i,r){console.error(e.stack),r(e)}),r.use(function(e,t,i,r){t.xhr?i.status(e.status||500).send({error:e.message}):r(e)}),r.use(function(e,t){t.status(404).send({error:"404 Error."})}),n=g.createServer(r);let y=Editor.Profile.load("project://project.json");this._listenByPort(y&&y.get("preview-port")||this._previewPort,a),function(e){var t=0;(i=require("socket.io")(e)).on("connection",function(e){e.emit("connected"),t+=1,Editor.Ipc.sendToMainWin("preview-server:connects-changed",t),e.on("disconnect",function(){t-=1,Editor.Ipc.sendToMainWin("preview-server:connects-changed",t)})})}(n),e.removeAllListeners("preview-server:use-new-preview-port"),e.on("preview-server:use-new-preview-port",(e,t)=>{this._previewPort!==t&&this._listenByPort(t)})},query:async function(e,i,r){const n=require("../../core/gulp-build"),s=require("../../share/bundle-utils");if(this._validateStashedScene)switch(void 0===r&&(r=i,i="web-desktop"),e){case"settings.js":this._validateStashedScene(async()=>{let e=Editor.Profile.load("project://project.json");var t=await s.queryBundleFolders();let o={designWidth:Editor.stashedScene.designWidth,designHeight:Editor.stashedScene.designHeight,groupList:e.get("group-list"),collisionMatrix:e.get("collision-matrix"),platform:i,scripts:Editor.ProjectCompiler.scripts,hasResourcesBundle:!!t.find(e=>"resources"===e.name)};n.buildSettings({customSettings:o,launchScene:Editor.sceneList[0],debug:!0,preview:!0},r)});break;case"stashed-scene.json":this._validateStashedScene(()=>{r&&r(null,c())});break;case"main/config.json":case"internal/config.json":case"resources/config.json":default:var o=t.dirname(e),a=await s.queryBundlesWithScenes(),d=await s.queryBundleFolders();d.push({name:cc.AssetManager.BuiltinBundleName.MAIN,url:""});var u=d.find(e=>e.name===o);if(!u)return r(new Error("Bundle does not exist!"));n.buildConfig({name:o,importBase:"web-desktop"!==i?"":"import",nativeBase:"web-desktop"!==i?"":"native",root:u.url,sceneList:a[o]?a[o].map(e=>e.uuid):[],debug:!0,preview:!0},r)}},getPreviewScene(e,t,i){let r=Editor._projectProfile.get("start-scene");if("current"!==r&&r!==Editor.currentSceneUuid&&Editor.assetdb.existsByUuid(r)){i(Editor.assetdb._uuidToImportPathNoExt(r)+".json")}else this.query("stashed-scene.json",(i,r)=>{if(i)return e(i);t(r)})},stop:function(){n&&n.close(function(){Editor.info("shutdown preview server"),n=null})},browserReload:function(){a||(a=setTimeout(function(){i.emit("browser:reload"),clearTimeout(a),a=!1},50))},setPreviewBuildPath:function(e){var t=require("express");s=t.static(e)},setPreviewAndroidInstantPath:function(e){var t=require("express");Editor.log("express path is ",e),o=t.static(e)},_validateStashedScene:null};Object.defineProperty(d,"previewPort",{get(){return this._previewPort},set(e){this._previewPort=e,this._listenByPort(e)}}),module.exports=d;