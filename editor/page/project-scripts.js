const e=require("fire-path"),t=require("globby"),r=require("async"),i=require("fire-url"),o=require("lodash"),n=Editor.remote.ProjectCompiler.DEST_PATH,l=e.join(Editor.remote.Project.path,"node_modules"),a=Editor.remote.ProjectCompiler.INDEX_FILE_PATH;let d=Object.create(null),s=[];let c=Editor.Profile.load("global://features.json").get("show-circular-import-warning")||!1,u=require("module"),p=0,m=[];function f(t){let r=require.cache[t];if(r&&r.parent){let e=r.parent.children.indexOf(r);-1!==e&&r.parent.children.splice(e,1)}delete require.cache[t];let i=e.basenameNoExt(t);delete d[i]}cc.require=function(t,r){let i;r=r||require,p++;try{i=r(t)}catch(e){Editor.failed(`load script [${t}] failed : ${e.stack}`)}let o=m[p-1];if(o&&c){let t=m.indexOf(o);if(t!==p-1){let r=[];for(let i=t;i<m.length;i++)r.push("  "+e.relative(n,m[i]));Editor.warn("Circular import modules => \n"+r.join("\n"))}}return p--,i},u._resolveFilenameVendor=u._resolveFilename,u._resolveFilename=function(t,r,i){if(p>0){let i=e.basename(t);i.endsWith(".js")&&(i=i.slice(0,-3));let o=d[i];if(!function(e){return-1!==e.replace(/\\/g,"/").indexOf("/node_modules/")}(r.filename)&&o)return m[p-1]=o.path,o.path}return r.paths.includes(l)||r.paths.push(l),u._resolveFilenameVendor(t,r,i)};let h=[];module.exports={getPluginScriptUuidByPath:e=>h[e],load:function(e){r.series([this.loadPlugins.bind(this),this.loadCommon.bind(this)],e)},loadScript:function(e,t){var r=document.createElement("script");r.onload=function(){r.remove(),t()},r.onerror=function(){r.remove(),Editor.error("Failed to load %s",e),t(new Error("Failed to load "+e))},r.setAttribute("type","text/javascript"),r.setAttribute("charset","utf-8");let o=Editor.remote.assetdb.fspathToUuid(e.replace("disable-commonjs://",""));e=i.addRandomQuery(e),h[e]=o,r.setAttribute("src",e),document.head.appendChild(r)},loadPlugins:function(t){console.time("query plugin scripts"),Editor.Ipc.sendToMain("app:query-plugin-scripts","editor",(i,o)=>{if(console.timeEnd("query plugin scripts"),i)return t(i);s=o.map(t=>e.stripSep(t)),h.length=0,r.eachSeries(o,(e,t)=>{this.loadScript("disable-commonjs://"+e,t)},t)},6e5)},loadCommon:function(r){for(let e in d){f(d[e].path)}d={};let i=[e.join(n,"/**/*.js"),"!"+e.join(n,"__node_modules/**")];t(i,(t,i)=>{(i=o(i).map(t=>e.stripSep(t)).filter(e=>-1===s.indexOf(e)).sortBy().value()).forEach(t=>{(function(t,r){r=r||e.basenameNoExt(t);let i=d[r];return i||(i=d[r]={name:r,path:t,children:[]}),i})(t)}),function(e){m.length=0,p++;try{require(e)}catch(t){Editor.failed(`load script [${e}] failed : ${t.stack}`)}p--}(a),r&&r()})}};