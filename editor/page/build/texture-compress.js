const t=require(Editor.url("app://editor/share/sharp")),e=require("child_process").spawn,r=require("child_process").spawnSync,n=require("fire-fs"),a=require("fire-path"),o=require("async"),c=require("./texture-compress-cache"),i=Editor.remote.Project.path,s=a.join(i,"temp/TexturePacker/build");function l(t,r,n,a){let o=e(t,r,n);o.stdout.on("data",function(t){t.toString().split("\n").forEach(t=>{Editor.log(t)})}),o.stderr.on("data",function(t){t.toString().split("\n").forEach(t=>{Editor.info(t)})}),o.on("close",function(){a&&a(null)}),o.on("error",function(t){a&&a(t)})}function _(t,e){return a.join(a.dirname(t),a.basenameNoExt(t)+e)}function u(t){let e=cc.Texture2D.PixelFormat;if(t.name.startsWith("pvrtc_")){let r=e.RGBA_PVRTC_4BPPV1;return"pvrtc_2bits"===t.name?r=e.RGBA_PVRTC_2BPPV1:"pvrtc_4bits_rgb"===t.name?r=e.RGB_PVRTC_4BPPV1:"pvrtc_2bits_rgb"===t.name?r=e.RGB_PVRTC_2BPPV1:"pvrtc_4bits_rgb_a"===t.name?r=e.RGB_A_PVRTC_4BPPV1:"pvrtc_2bits_rgb_a"===t.name&&(r=e.RGB_A_PVRTC_2BPPV1),`.pvr@${r}`}if(t.name.startsWith("etc")){let r=e.RGB_ETC1;return"etc1"===t.name?r=e.RGBA_ETC1:"etc2"===t.name?r=e.RGBA_ETC2:"etc2_rgb"===t.name&&(r=e.RGB_ETC2),`.pkm@${r}`}if(t.name.startsWith("astc_")){let r=e.RGBA_ASTC_4x4;return"astc_5x5"===t.name?r=e.RGBA_ASTC_5x5:"astc_6x6"===t.name?r=e.RGBA_ASTC_6x6:"astc_8x8"===t.name?r=e.RGBA_ASTC_8x8:"astc_10x5"===t.name?r=e.RGBA_ASTC_10x5:"astc_10x10"===t.name?r=e.RGBA_ASTC_10x10:"astc_12x12"===t.name&&(r=e.RGBA_ASTC_12x12),`.astc@${r}`}return"."+t.name}function m(e,r,n,a){let o=t(e),c=".png";if("webp"===n.name)o=o.webp({quality:n.quality}),c=".webp";else if("jpg"===n.name)o=o.jpeg({quality:n.quality}),c=".jpg";else if("png"===n.name){let t=n.quality/10|0;o=o.png({compressionLevel:t})}r=_(r,c),o.toFile(r,t=>{a(t)})}function p(t){if("number"!=typeof t)return;let e=2;for(;t>e;)e*=2;return e}function f(e,r,o){let c=new t(e);c.metadata().then(e=>{const i=e.width,s=e.height;let l=p(i),_=p(s);_<l/2&&(_=l/2);let u=e.channels,m=4===u;c.raw().toBuffer((e,c)=>{if(e)return o(e);const l=2*i*_*3;let p,f,d=Buffer.alloc(l,0);for(let t=0;t<s;t++)for(let e=0;e<i;e++){let r=t*i+e,n=r*u;d[p=3*r]=c[n],d[p+1]=c[n+1],d[p+2]=c[n+2],f=3*((t+_)*i+e);let a=c[n+3];m||(a=255),d[f]=a,d[f+1]=a,d[f+2]=a}const x={raw:{width:i,height:2*_,channels:3}};n.ensureDirSync(a.dirname(r)),t(d,x).toFile(r,t=>{o(t)})})})}function d(t,e,r,n){let o=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/OSX_x86/PVRTexToolCLI");"win32"===process.platform&&(o=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/Windows_x86_64/PVRTexToolCLI.exe"));let c=!1,u="PVRTC1_4";function m(){e=_(e,".pvr");let a="pvrtc"+r.quality,c=["-i",t,"-o",e,"-squarecanvas","+","-potcanvas","+","-q",a,"-f",`${u},UBN,lRGB`];console.log(`pvrtc compress command :  ${o} ${c.join(" ")}`),l(o,c,{},n)}if("pvrtc_4bits"===r.name?u="PVRTC1_4":"pvrtc_4bits_rgb"===r.name?u="PVRTC1_4_RGB":"pvrtc_2bits"===r.name?u="PVRTC1_2":"pvrtc_2bits_rgb"===r.name?u="PVRTC1_2_RGB":"pvrtc_4bits_rgb_a"===r.name?(u="PVRTC1_4_RGB",c=!0):"pvrtc_2bits_rgb_a"===r.name&&(u="PVRTC1_2_RGB",c=!0),c){let e=a.relative(i,t),r=a.join(s,"pvr_alpha",e);return f(t,r,e=>{if(e)return n(e);t=r,setTimeout(()=>{m()},10)}),void 0}m()}function x(t,e,n,o){let c=Editor.url("unpack://static/tools/texture-compress/mali/OSX_x86/etcpack");"win32"===process.platform&&(c=Editor.url("unpack://static/tools/texture-compress/mali/Windows_64/etcpack.exe"));let l=a.dirname(c);c="."+a.sep+a.basename(c);let _="etc1",u="RGB";"etc1"===n.name?(_="etc1",u="RGBA"):"etc1_rgb"===n.name?_="etc1":"etc2"===n.name?(_="etc2",u="RGBA"):"etc2_rgb"===n.name&&(_="etc2");let m=!1;function p(){let i=[a.normalize(t),a.dirname(e),"-c",_,"-s",n.quality],s=l,m=Object.assign({},process.env);m.PATH=l+":"+m.PATH;let p={cwd:s,env:m};"etc2"===_&&i.push("-f",u),console.log(`etc compress command :  ${c} ${i.join(" ")}`),function(t,e,n,a){let o=r(t,e,n);o.stdout.length>0&&o.stdout.toString().split("\n").forEach(t=>{Editor.log(t)}),o.stderr.length>0&&o.stderr.toString().split("\n").forEach(t=>{Editor.error(t)}),a(o.error)}(c,i,p,o)}if("etc1"===_&&"RGBA"===u&&(m=!0),m){let e=a.relative(i,t),r=a.join(s,"etc_alpha",e);return f(t,r,e=>{if(e)return o(e);t=r,setTimeout(()=>{p()},10)}),void 0}p()}function R(t,e,r,n){let a=Editor.url("unpack://static/tools/texture-compress/mali/OSX_x86/astcenc");"win32"===process.platform&&(a=Editor.url("unpack://static/tools/texture-compress/mali/Windows_64/astcenc.exe"));const o=["-cl",t,e=_(e,".astc"),{astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[r.name],`-${r.quality}`];console.log(`astc compress command :  ${a} ${o.join(" ")}`),l(a,o,{},n)}module.exports=function(t,e){let r=t.uuid,i=t.src,s=t.dst,l=t.platform,p=t.actualPlatform,f=t.compressOption,T=!!r,b="wechatgame-subcontext"!==p&&"baidugame-subcontext"!==p;"web-mobile"===p||"web-desktop"===p?p="web":"mac"===p||"win32"===p?p="native":"mini-game"!==l&&"runtime"!==l||(p="minigame");let g=[],h=f[p];function B(){return g.map(u)}if(h&&h.formats.length>0&&b?g=h.formats:f.default&&(g=f.default.formats),n.ensureDirSync(a.dirname(s)),0===g.length)return n.copy(i,s,t=>{t&&Editor.error("Failed to copy native asset file %s to %s",i,s),e(t,B(),[s])}),void 0;o.each(g,(t,e)=>{let n=m;t.name.startsWith("pvrtc_")?n=d:t.name.startsWith("etc")?n=x:t.name.startsWith("astc_")&&(n=R);let a=u(t);a=a.replace(/@.*/,"");let o=_(s,a);if(T&&c.exportTo(r,t,a,o))return e(),void 0;n(i,s,t,n=>{T&&!n&&c.add(r,t,a,o),e(n)})},t=>{let r=B(),n=r.map(t=>_(s,t.replace(/@.*/,"")));e(t,r,n)})};