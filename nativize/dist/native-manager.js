"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};let nativeManager;Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativizeConstants=exports.Nativize=void 0;const path=__importStar(require("path")),addonRoot=path.join(Editor.App.path,"../tools/native-scene");nativeManager="win32"===process.platform?require(path.join(addonRoot,"addon")).NativeEngineManager:"arm64"===process.arch?require(path.join(addonRoot,"addon_arm64")).NativeEngineManager:require(path.join(addonRoot,"addon_x86")).NativeEngineManager;const editorServer=require("./server"),ipc=require("@base/electron-base-ipc"),SceneWindow=require("./scene-window"),constants_1=require("./constants");Object.defineProperty(exports,"NativizeConstants",{enumerable:!0,get:function(){return constants_1.NativizeConstants}});const child_process_1=require("child_process");let nodeInspectPort,nodeInspectID,id=1,restartable=!0;ipc.on("editor-lib-nativize:inspect-info",e=>{e.reply(0,{id:nodeInspectID,port:nodeInspectPort})});class Nativize{constructor(){this.port=0,this.appConnect=!1,this.appStarting=!1,this.manager=new nativeManager,this.server=new editorServer,this.server.on("connect",()=>{console.log("native app connected"),this.appConnect=!0,this.restartAppTimes=0,id=1,this.onFuncMaps.connect&&this.onFuncMaps.connect(!0),this.appStarting=!1}),this.server.on("close",()=>{console.log("server close"),this.appConnect=!1,this.nativeAPPConnectTimeout(),Editor.Message.send("scene","native-ipc","close")}),this.onFuncMaps={},this.restartAppTimes=0}onWindowCallback(e,t,n){const i=this.onFuncMaps[e];i&&i(t,n)}init(e,t,n){this.server.startServer(this.port),this.parentWindow=this.manager.init(e,t,n),this.parentWindow?this.parentWindow.setWindowCallback(this.onWindowCallback.bind(this)):console.error("editorNative init fail")}setMinWindowSize(e,t){this.manager.setMinWindowSize(e,t)}setMainWindowSize(e,t){this.mainSceneWidth=e,this.mainSceneHeight=t}on(e,t){this.onFuncMaps[e]=t}nativeAPPConnectTimeout(){this.connectTimeoutID&&clearTimeout(this.connectTimeoutID),this.connectTimeoutID=setTimeout(()=>{this.appConnect||(console.log("native app failed to connect editor in 5s,restart now",new Date),this.restartNativeApp()),this.connectTimeoutID=null},5e3)}getAppPath(){const e="darwin"===process.platform,t=path.join(Editor.App.path,"../tools/node");return path.join(t,e?"bin/node":"node.exe")}restartNativeApp(){restartable&&(this.nativeApp&&(this.nativeApp.removeAllListeners(),this.nativeApp.kill(),this.nativeApp=null),this.restartAppTimes<10?(console.log(`restartNativeApp at ${this.restartAppTimes} times`),this.startNativeApp([])):console.error("try too much times for start native process"),this.restartAppTimes++)}startNativeApp(e){var t,n;this.appStarting=!0,this.nativeAPPConnectTimeout();const i=this.getAppPath(),s="darwin"===process.platform;let o=path.join(i,"../../../resources/3d/editor-native-scene/build");o=s?path.join(i,"../../../../resources/3d/editor-native-scene/build"):o,console.log("appPath",i,o);const r=e||["--inspect"];r.push("./index.js"),r.push(`port=${this.server.getPort()}`),this.nativeApp=child_process_1.execFile(i,r,{cwd:o}),null===(t=this.nativeApp)||void 0===t||t.stdout.on("data",e=>{console.log(`[native stdout]: ${e}`)}),null===(n=this.nativeApp)||void 0===n||n.stderr.on("data",e=>{if(e.includes("Debugger listening on")){const t=e.indexOf("\n"),n=e.slice(22,t);nodeInspectPort=n.slice(15,19),nodeInspectID=n.slice(20)}console.error(`[native stderr]: ${e}`)}),this.nativeApp.on("error",e=>{console.error("nativeApp on error",e.message),this.nativeApp=null,this.restartNativeApp()}),this.nativeApp.on("exit",(e,t)=>{console.error("nativeApp on exit",e,t),this.nativeApp=null,this.appStarting=!1,this.restartNativeApp()})}createWindow(e,t){return new Promise((n,i)=>{this.request({type:constants_1.NativizeConstants.Type.newWindow,data:{w:480,h:320}}).then(s=>{setTimeout(()=>{console.log("send new window resolve",s.windowID);try{const o=this.manager.createWindow(e,t,s.windowID),r=new SceneWindow(o,s.windowID);n(r)}catch(e){i(e)}},2e3)})})}send(e){return e.id=id,id+=2,this.server.send(e)}request(e){return e.id=id,id+=2,this.server.request(e)}setTitle(e){this.parentWindow&&this.parentWindow.setTitle(e)}setRestartable(e){restartable=e}setPort(e){this.port=e}}const instance=new Nativize;exports.Nativize=instance;