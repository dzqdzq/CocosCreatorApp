"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativizeConstants=exports.Nativize=void 0;let nativeManager;const path=__importStar(require("path")),addonRoot=path.join(Editor.App.path,"../tools/native-scene"),editorServer=(nativeManager=("win32"===process.platform?require(path.join(addonRoot,"addon")):"arm64"===process.arch?require(path.join(addonRoot,"addon_arm64")):require(path.join(addonRoot,"addon_x86"))).NativeEngineManager,require("./server")),ipc=require("@base/electron-base-ipc"),SceneWindow=require("./scene-window"),constants_1=require("./constants"),child_process_1=(Object.defineProperty(exports,"NativizeConstants",{enumerable:!0,get:function(){return constants_1.NativizeConstants}}),require("child_process"));let id=1,restartable=!0,nodeInspectPort,nodeInspectID;ipc.on("editor-lib-nativize:inspect-info",e=>{e.reply(0,{id:nodeInspectID,port:nodeInspectPort})});class Nativize{constructor(){this.port=0,this.appConnect=!1,this.appStarting=!1,this.manager=new nativeManager,this.server=new editorServer,this.server.on("connect",()=>{console.log("native app connected"),this.appConnect=!0,this.restartAppTimes=0,id=1,this.onFuncMaps.connect&&this.onFuncMaps.connect(!0),this.appStarting=!1}),this.server.on("close",()=>{console.log("server close"),this.appConnect=!1,this.nativeAPPConnectTimeout(),Editor.Message.send("scene","native-ipc","close")}),this.onFuncMaps={},this.restartAppTimes=0}onWindowCallback(e,t,i){e=this.onFuncMaps[e];e&&e(t,i)}init(e,t,i){this.server.startServer(this.port),this.parentWindow=this.manager.init(e,t,i),this.parentWindow?this.parentWindow.setWindowCallback(this.onWindowCallback.bind(this)):console.error("editorNative init fail")}setMinWindowSize(e,t){this.manager.setMinWindowSize(e,t)}setMainWindowSize(e,t){this.mainSceneWidth=e,this.mainSceneHeight=t}on(e,t){this.onFuncMaps[e]=t}nativeAPPConnectTimeout(){this.connectTimeoutID&&clearTimeout(this.connectTimeoutID),this.connectTimeoutID=setTimeout(()=>{this.appConnect||(console.log("native app failed to connect editor in 5s,restart now",new Date),this.restartNativeApp()),this.connectTimeoutID=null},5e3)}getAppPath(){var e="darwin"===process.platform,t=path.join(Editor.App.path,"../tools/node");return path.join(t,e?"bin/node":"node.exe")}restartNativeApp(){restartable&&(this.nativeApp&&(this.nativeApp.removeAllListeners(),this.nativeApp.kill(),this.nativeApp=null),this.restartAppTimes<10?(console.log(`restartNativeApp at ${this.restartAppTimes} times`),this.startNativeApp([])):console.error("try too much times for start native process"),this.restartAppTimes++)}startNativeApp(e){this.appStarting=!0,this.nativeAPPConnectTimeout();var t=this.getAppPath(),i="darwin"===process.platform,n=path.join(t,"../../../resources/3d/editor-native-scene/build"),n=i?path.join(t,"../../../../resources/3d/editor-native-scene/build"):n,i=(console.log("appPath",t,n),e||["--inspect"]);i.push("./index.js"),i.push("port="+this.server.getPort()),this.nativeApp=child_process_1.execFile(t,i,{cwd:n}),null!=(e=this.nativeApp)&&e.stdout.on("data",e=>{console.log("[native stdout]: "+e)}),null!=(t=this.nativeApp)&&t.stderr.on("data",e=>{var t;e.includes("Debugger listening on")&&(t=e.indexOf("\n"),t=e.slice(22,t),nodeInspectPort=t.slice(15,19),nodeInspectID=t.slice(20)),console.error("[native stderr]: "+e)}),this.nativeApp.on("error",e=>{console.error("nativeApp on error",e.message),this.nativeApp=null,this.restartNativeApp()}),this.nativeApp.on("exit",(e,t)=>{console.error("nativeApp on exit",e,t),this.nativeApp=null,this.appStarting=!1,this.restartNativeApp()})}createWindow(o,r){return new Promise((n,s)=>{this.request({type:constants_1.NativizeConstants.Type.newWindow,data:{w:480,h:320}}).then(i=>{setTimeout(()=>{console.log("send new window resolve",i.windowID);try{var e=this.manager.createWindow(o,r,i.windowID),t=new SceneWindow(e,i.windowID);n(t)}catch(e){s(e)}},2e3)})})}send(e){return e.id=id,id+=2,this.server.send(e)}request(e){return e.id=id,id+=2,this.server.request(e)}setTitle(e){this.parentWindow&&this.parentWindow.setTitle(e)}setRestartable(e){restartable=e}setPort(e){this.port=e}}const instance=new Nativize;exports.Nativize=instance;