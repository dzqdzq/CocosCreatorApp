"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativizeConstants=exports.Nativize=exports.initNativize=void 0;const electron_1=require("electron"),native_manager_1=require("./native-manager"),ipc=(Object.defineProperty(exports,"Nativize",{enumerable:!0,get:function(){return native_manager_1.Nativize}}),Object.defineProperty(exports,"NativizeConstants",{enumerable:!0,get:function(){return native_manager_1.NativizeConstants}}),require("@base/electron-base-ipc"));let initLimitTimes=5,mainWindow=null,sceneWindow=null,isEngineViewReady=!1,isNativeWindowReady=!1;const isWin32="win32"===process.platform;let redrawHandle=null;function onNativize(){native_manager_1.Nativize.on("resize",(e,i)=>{isWin32?mainWindow.setBounds({x:0,y:0,width:e,height:i}):mainWindow.setBounds({width:e,height:i})}),native_manager_1.Nativize.on("close",()=>{mainWindow.close()}),native_manager_1.Nativize.on("focus",()=>{mainWindow.focus()}),native_manager_1.Nativize.on("redraw",()=>{redrawHandle&&(clearTimeout(redrawHandle),redrawHandle=null),redrawHandle=setTimeout(()=>{sceneWindow&&(sceneWindow.resize({w:native_manager_1.Nativize.mainSceneWidth-1,h:native_manager_1.Nativize.mainSceneHeight-1}),sceneWindow.resize({w:native_manager_1.Nativize.mainSceneWidth,h:native_manager_1.Nativize.mainSceneHeight}))},30)}),native_manager_1.Nativize.on("connect",e=>{console.log("native app suc connected, first time:"+e),e&&(initSceneWindow(),setNativeWindowReady(!0))})}function initMainWindow(){var{width:e,height:i}=mainWindow.getBounds();native_manager_1.Nativize.init(mainWindow.getNativeWindowHandle(),e,i),native_manager_1.Nativize.setMinWindowSize(960,680),mainWindow.focus()}async function prepareNativeEngine(n){return new Promise((i,e)=>{native_manager_1.Nativize.request({type:"prepareNativeEngine",data:{editorPath:n}}).then(e=>{i(!0)})})}function initSceneWindow(){native_manager_1.Nativize.createWindow(480,320).then(e=>{console.log("scene-resize","createWindow"),sceneWindow=e})}function setEngineViewReady(e){(isEngineViewReady=e)&&isNativeWindowReady&&prepareNativeEngine(Editor.App.path)}function setNativeWindowReady(e){isNativeWindowReady=e,isEngineViewReady&&isNativeWindowReady&&prepareNativeEngine(Editor.App.path).then(()=>{0!==native_manager_1.Nativize.mainSceneWidth&&sceneWindow&&(console.log("prepareNativeEngine  scene-resize",native_manager_1.Nativize.mainSceneWidth,native_manager_1.Nativize.mainSceneHeight),sceneWindow.resize({w:native_manager_1.Nativize.mainSceneWidth,h:native_manager_1.Nativize.mainSceneHeight}))})}async function initNativize(e){(mainWindow=e.uuid2win[e.uuids[0]])?(initMainWindow(),onNativize(),ipc.on("engine-view:ready",(e,i)=>{setEngineViewReady(i)}),ipc.on("editor-lib-windows:scene-resize",(e,i)=>{i&&i.width&&(electron_1.BrowserWindow.fromWebContents(e.sender)&&sceneWindow&&(e=mainWindow.getContentSize(),sceneWindow.resize({x:i.left,y:isWin32?i.top:e[1]-i.bottom,w:i.width,h:i.height})),native_manager_1.Nativize.setMainWindowSize(i.width,i.height))}),Editor.Message.addBroadcastListener("editor-title-change",e=>{native_manager_1.Nativize.setTitle(e)})):0<initLimitTimes&&setTimeout(()=>{initLimitTimes--,initNativize(e)},1e3)}exports.initNativize=initNativize;