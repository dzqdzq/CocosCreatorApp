"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.launch=void 0;const __StartTime__=Date.now(),readJSONSync=require("fs-extra")["readJSONSync"],join=require("path")["join"],{app,crashReporter}=require("electron");async function launch(){const t=require("@editor/setting");console.debug("Arguments:"),Object.keys(t.args).forEach(e=>{console.debug(`  ${e}: `+t.args[e])}),console.debug(" ");var{editorProcessManager:e,ProcessMainManager:i}=require("@editor/process-message");if(e("DASHBOARD_STORE_EXTENSION_INSTALL",new i(process)),t.PATH.PROJECT&&(e=join(t.PATH.PROJECT,"temp/crash"),app.setPath("crashDumps",e),crashReporter.start({uploadToServer:!1})),t.PATH.PROJECT){try{await require("./../../dashboard/script/util").installProjectDepend(t.PATH.PROJECT)}catch(e){console.error(e)}i=require("./inject")["inject"];if(await i(),t.args.build){await Editor.Startup.__protected__.manager(!0,!!t.args.metric);const r=await scanPrePackage(),s=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:r,list:s});var e=t.args.build.split(";");const o={};e.forEach(e=>{e&&(e=e.split("="),o[e[0].trim()]=e[1])});i=await Editor.Startup.__protected__.build(o,t.args.dev);app.exit(i),process.exit(i)}const n=await useNativeScene(t);let a=!1;await Promise.all([Editor.Startup.__protected__.manager(!!t.args.test||!!t.args.nologin,!!t.args.metric),Editor.Startup.__protected__.window({async beforeOpen(e,t){var i=checkLayout(t.layout);a||(a=!0,n?("win32"===process.platform&&(e.transparent=!0,e.resizable=!0,e.frame=!1),i||(t.layout=readJSONSync(join(__dirname,"./../../static/layout-native.json")))):i&&(t.layout=readJSONSync(join(__dirname,"./../../static/layout-web.json"))))},async afterOpen(e){Editor.Metrics.trackTimeEnd("main-window:start-up",{value:Date.now()-__StartTime__})}})]);const r=await scanPrePackage(),s=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:r,list:s}),await runTest(t)}else app.requestSingleInstanceLock()||(app.quit(),process.exit(0)),await(e=require("./../../dashboard/startup")).app(),await e.validation(t.dev)}exports.launch=launch;let nativeSceneOriConfig=!1;async function useNativeScene(e){return void 0!==e.args.testScene?(nativeSceneOriConfig=await Editor.Profile.getConfig("scene","scene.native-engine","global"),e="native"===e.args.testScene,await Editor.Profile.setConfig("scene","scene.native-engine",e,"global"),!0):void 0!==(e=await Editor.Profile.getConfig("scene","scene.native-engine","global"))&&e}async function runTest(e){var t,i;if(void 0!==e.args.testScene)return Editor.Dialog.__protected__.setMode("command"),t={useNative:"native"===e.args.testScene},t=await Editor.Startup.__protected__.test(t,e.args.dev),await Editor.Profile.setConfig("scene","scene.native-engine",!!nativeSceneOriConfig,"global"),console.log("测试结果",t),e.args.dev?void 0:void("success"===t?app.exit(1):app.exit(-1));e.args.test&&(Editor.Dialog.__protected__.setMode("command"),t="string"==typeof e.args.test?function(e){const t={};return e.forEach(e=>{e&&(e=e.split("="),t[e[0].trim()]=["true","false"].includes(e[1])?JSON.parse(e[1]):e[1])}),t}(e.args.test.split(";")):{},process.env.EDITOR_AUTO_TEST&&(i=JSON.parse(process.env.EDITOR_AUTO_TEST),Object.assign(t,i)),i=await Editor.Startup.__protected__.test(t,e.args.dev),app.exit(i))}function checkLayout(e){let i=!1;return e&&function e(t){if(t.panels&&t.panels.includes("scene.preview"))return i=!0;t.children&&t.children.some(e)}(e.layout),i}async function scanPrePackage(){const t=[];return["./builtin/metrics","./builtin/menu","./builtin/profile","./builtin/project","./builtin/messages","./builtin/utils","./builtin/program","./builtin/tester","./builtin/information","./builtin/preferences","./builtin/engine","./builtin/programming","./builtin/window","./modules/editor-extensions/extensions/device","./modules/editor-extensions/extensions/ui-kit"].forEach(e=>{t.push(join(Editor.App.path,e))}),t}async function scanPackage(){var e={editor:join(Editor.App.path,"./modules/editor-extensions/extensions"),engine:join(Editor.App.path,"./modules/engine-extensions/extensions"),platform:join(Editor.App.path,"./modules/platform-extensions/extensions"),builtinOthers:join(Editor.App.path,"./extension"),globalBuiltin:join(Editor.App.home,"./builtin-extensions/"+Editor.App.version),project:join(Editor.Project.path,"extensions")};const t=[];["./builtin/asset-db","./builtin/scene","./builtin/server","./builtin/preview","./builtin/animator","./builtin/builder","./builtin/shortcuts","./builtin/animation-graph"].forEach(e=>{t.push(join(Editor.App.path,e))});for(const a in e){var i=e[a],i=await Editor.Package.__protected__.scan(i);t.push(...i)}return t.push(join(Editor.App.path,"./builtin/placeholder")),t}