"use strict";const e=require("electron").protocol,r=require("fire-url"),t=require("fire-fs"),o=require("querystring");function i(e){let r=e.hostname;return Editor.assetdb.uuidToFspath(r)}function s(e){return Editor.assetdb._fspath(e.href)}let d=e.registerFileProtocol("uuid",(e,t)=>{let o=decodeURIComponent(e.url);t({path:i(r.parse(o))})});d?Editor.success("protocol uuid registerred"):Editor.failed("Failed to register protocol uuid"),Editor.Protocol.register("uuid",i),(d=e.registerFileProtocol("db",(e,r)=>{r({path:s(decodeURIComponent(e.url))})}))?Editor.success("protocol db registerred"):Editor.failed("Failed to register protocol uuid"),Editor.Protocol.register("db",s),(d=e.registerBufferProtocol("thumbnail",(e,s)=>{let d,u,a=decodeURIComponent(e.url),l=r.parse(a),n=i(l);if(!t.existsSync(n))return s(-6),void 0;const c=l.query&&l.query.split("*");let p;2===c.length?(d=parseInt(c[0]),u=parseInt(c[1])):d=u=parseInt(l.query)||32,p=Editor.dev?"sharp":Editor.url("unpack://utils/sharp");const h=require(p);var g=/\.jpg$/.test(n);g&&h.cache(!1);let f=h(n),m=o.parse(l.query);if(m){let e=function(e){return e&&void 0!==e.x&&void 0!==e.y&&void 0!==e.w&&void 0!==e.h?{left:parseInt(e.x),top:parseInt(e.y),width:parseInt(e.w),height:parseInt(e.h)}:null}(m);e&&f.extract(e),m.rotate&&f.rotate(parseInt(m.rotate))}f.resize({width:d,height:u,background:{r:255,g:255,b:255,alpha:0}}).toFormat(h.format.png).toBuffer((e,r)=>{if(g&&h.cache(!0),e)return s(-6),void 0;s({mimeType:"image/png",data:r})})}))?Editor.success("protocol thumbnail registerred"):Editor.failed("Failed to register protocol thumbnail");