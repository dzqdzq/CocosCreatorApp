"use strict";const{existsSync:existsSync,outputFileSync:outputFileSync,readJsonSync:readJsonSync,readFileSync:readFileSync,removeSync:removeSync}=require("fs-extra"),{join:join,extname:extname,basename:basename}=require("path"),{parse:parse}=require("url");function attach(t,e){const i=require(e);Editor.UI.register("ui-"+t,i.element)}exports.load=function(){const t=[];function e(e){if(e.info.contributions&&e.info.contributions["ui-kit"]){if(e.info.contributions["ui-kit"].element)for(let i in e.info.contributions["ui-kit"].element){if(!e.info.contributions["ui-kit"].element[i])continue;const r=join(e.path,e.info.contributions["ui-kit"].element[i]),n=require(r);n.load&&n.load();const s="ui-"+i;t.includes(s)||(Editor.UI.register(s,n.element),t.push(s))}if(e.info.contributions["ui-kit"]["ui-prop"]){const t=e.info.contributions["ui-kit"]["ui-prop"];for(let i in t.render)if(t.render[i])try{const r=require(join(e.path,t.render[i]));Editor.UI.Prop.registerRender(i,r)}catch(t){console.error(t)}}}}Editor.Package.getPackages({enable:!0}).forEach(e),Editor.Package.on("enable",e),Image.init(),Editor.UI.Link.setLinkHandle(async function(t,e){if(!e)return!1;switch(t=t.trim(),e){case"assetUrl":return t=await Editor.Message.request("asset-db","query-uuid",t),Editor.Utils.UUID.isUUID(t)&&Editor.Message.send("assets","twinkle",t),!0;case"assetUuid":return Editor.Utils.UUID.isUUID(t)&&Editor.Message.send("assets","twinkle",t),!0;case"nodeUuid":return Editor.Utils.UUID.isUUID(t)&&Editor.Message.send("hierarchy","twinkle",t),!0}})},exports.unload=function(){Editor.UI.Image.setNameTranslator(null)};const Image={dbInfos:{},init(){Editor.UI.Image.setSrcTranslator(async function(t){if(!t)return"";t.startsWith("db://")&&(t=await Editor.Message.request("asset-db","query-uuid",t));const e=t.split("@").shift();if(Editor.Utils.UUID.isUUID(e)){const e=await Editor.Message.request("asset-db","query-asset-info",t);return e?-1!==t.indexOf("@")?await Image.subImage(e,this.size):await Image.image(e,this.size):""}return t}),Editor.UI.Image.prototype._onConnected=function(){this.addEventListener("click",Image.bindClick)},Editor.UI.Image.prototype._onDisconnected=function(){this.removeEventListener("click",Image.bindClick)}},bindClick(){Editor.Message.send("assets","twinkle",this.value.trim())},async getThumbnail(t,e){const i=parse(t.path);let r=this.dbInfos[i.host];r||(r=await Editor.Message.request("asset-db","query-db-info",i.host),this.dbInfos[i.host]=r);const n=t.uuid.substr(0,2),s=join(r.temp,n,t.uuid,e);if(existsSync(s)){return readFileSync(s,"utf8")}return s},async setThumbnail(t,e,i={}){const r=document.createElement("img");if(r.src=t.replace("#","%23"),!1===await new Promise(t=>{r.addEventListener("load",()=>{t(r)}),r.addEventListener("error",()=>{t(!1)})}))return"";const n=basename(e).split(","),s=Number(n[0])||r.width,a=Number(n[1])||r.height;let o=i.width||r.width,u=i.height||r.height;const c=o/s,d=u/a,l=document.createElement("canvas");l.width=s,l.height=a;const h=l.getContext("2d");if(i.rotated){const t=l.width/2,e=l.height/2;h.translate(t,e),h.rotate(-90*Math.PI/180),h.translate(-t,-e),o=i.height,u=i.width}h.drawImage(r,i.trimX||0,i.trimY||0,o,u,(s-o/c)/2,(a-u/d)/2,o/c,u/d);const m=l.toDataURL("image/png");return outputFileSync(e,m),m},async image(t,e){let i=extname(t.name).toLowerCase();if(!e)return[".tga",".hdr",".bmp"].includes(i)&&(i=".png"),t.library[i]?`${t.library[i]}?${Date.now()}`:"";const r=await this.getThumbnail(t,e);if(!r||r.startsWith("data:image"))return r;const n=this.getLibraryImageSrc(t.library,i),s=await this.setThumbnail(`${n}?${Date.now()}`,r);return!1===s&&console.warn(`Load thumbnail failed: ${t.url}`),s},async subImage(t,e){const i=await Editor.Message.request("asset-db","query-asset-meta",t.uuid);if(!i||!i.userData)return"";const{userData:r}=i,n=(r.imageUuidOrDatabaseUri||i.uuid).split("@");n.length>1&&n.pop();const s=n.join("@"),a=await Editor.Message.request("asset-db","query-asset-info",s);if(!a)return"";const o=extname(a.name).toLocaleLowerCase(),u=this.getLibraryImageSrc(a.library,o);if(!u){const t=await Editor.Message.request("asset-db","query-asset-info",i.uuid);if(!t||!t.library)return"";const e=[".png",".jpg",".jpge"];for(const i of e)if(i in t.library)return`${t.library[i]}?${Date.now()}`;return""}if(!e&&u&&(!i.userData.width||!i.userData.height))return`${u}?${Date.now()}`;const c=await this.getThumbnail(t,e||`${i.userData.width},${i.userData.height}`);return!c||c.startsWith("data:image")?c:await this.setThumbnail(`${u}?${t.refreshTime}`,c,i.userData)},getLibraryImageSrc(t,e){let i=t[e];if(!i){i=t[Object.keys(t).find(t=>".json"!==t)||""]}return i}};