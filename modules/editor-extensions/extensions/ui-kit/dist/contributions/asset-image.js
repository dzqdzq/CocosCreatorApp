"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetImage=void 0;const preview_image_manager_1=require("./preview-image-manager");class AssetImage extends HTMLElement{static init(){preview_image_manager_1.previewImageManager.init(),preview_image_manager_1.previewImageManager.on("ready",()=>{AssetImage._waitingRefreshInstance.length&&(AssetImage._waitingRefreshInstance.forEach(e=>{e.resolveValue(e._value)}),AssetImage._waitingRefreshInstance.length=0)})}constructor(){super(),this._value=null,this._importer="",this._iconInfo=null,this._retryCount=0,this._size="small";this.attachShadow({mode:"open"});this.shadowRoot.innerHTML=`<style></style>
                                    <div style="width: 100%; height: 100%;">
                                        <ui-loading style="display: none;"></ui-loading>
                                        <ui-image style="width: 100%; height: 100%; line-height: 100%;" hidden></ui-image>
                                        <ui-icon color="true" style="width: 100%; height: 100%;" class="icon" hidden></ui-icon>
                                     </div>`,this.$uiImage=this.shadowRoot?.querySelector("ui-image"),this.$uiIcon=this.shadowRoot?.querySelector("ui-icon"),this.$uiLoading=this.shadowRoot?.querySelector("ui-loading")}get value(){return this._value}set value(e){(this._value=e)&&this.setAttribute("value",e)}get importer(){return this._importer}set importer(e){(this._importer=e)&&this.setAttribute("importer",e)}get size(){return this._size}disconnectedCallback(){}static get observedAttributes(){return["value","importer","size"]}attributeChangedCallback(e,t,i){switch(e){case"value":requestAnimationFrame(()=>{this.resolveValue(i)});break;case"importer":this._importer=i;break;case"size":["large","small","origin","middle"].includes(i)&&(this._size=i)}}async resolveValue(e){e&&(preview_image_manager_1.previewImageManager.ready?(this._iconInfo=await preview_image_manager_1.previewImageManager.get(e,this.size,this._importer),"icon"===this._iconInfo.type?this._showIcon(this._iconInfo.value):(this._retryCount=0,this._showImage(this._iconInfo.value,this._iconInfo.timestamp))):(AssetImage._waitingRefreshInstance.push(this),this._showLoading()))}_showLoading(){this.$uiLoading.style.display="inline-block"}_showIcon(e){this.$uiIcon.setAttribute("value",e),this.$uiIcon.removeAttribute("hidden"),this.$uiIcon.style.fontSize=this.getBoundingClientRect().width-4+"px",this.$uiImage.setAttribute("hidden",""),this.$uiLoading.style.display="none"}_showImage(e,t){this.$uiImage.setAttribute("value",e+"?"+t),this.$uiImage.removeAttribute("hidden"),this.$uiIcon.setAttribute("hidden","");t=this.$uiImage.$img;t.onload=()=>{this.$uiLoading.style.display="none"},t.onerror=()=>{this._handleImageError(e)}}_handleImageError(e){this._retryCount>=AssetImage.MAX_RETRY?(console.warn(`AssetImage: image load ${e} failed, retry count: `,this._retryCount),this._showIcon("image")):setTimeout(()=>{this._retryCount++,this._showImage(e,(new Date).getTime())},AssetImage.RETRY_DELAY)}}(exports.AssetImage=AssetImage).previewImageManager=preview_image_manager_1.previewImageManager,AssetImage._waitingRefreshInstance=[],AssetImage.MAX_RETRY=3,AssetImage.RETRY_DELAY=100;