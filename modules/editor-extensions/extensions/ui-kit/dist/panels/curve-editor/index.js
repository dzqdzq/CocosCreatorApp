"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),Vue=require("vue/dist/vue.js"),defaultPresets=fs_extra_1.readJSONSync(path_1.join(__dirname,"../../../static/curve-editor/preset.json"));let panel,vm;async function ready(...e){panel=this,await exports.methods.init()}async function beforeClose(){}async function close(){}function initVue(){let e=null;vm=new Vue({el:panel.$.presets,data:()=>({maxValue:{x:5,y:5},showSettings:!1,presets:{default:{},custom:{}},presetConfig:{negative:!0,tab:"default"},newPreset:{name:""},value:panel.option&&panel.option.value,config:{showPreWrapMode:panel.option.config&&panel.option.config.showPreWrapMode||0,showPostWrapMode:panel.option.config&&panel.option.config.showPostWrapMode||0},label:panel.option.label}),mounted(){panel.$.editor=this.$refs["curve-editor"],this.init()},methods:{onRemovePreset(e){this.$set(this.presets.custom,e,null),delete this.presets.custom[e],Editor.Profile.setConfig("ui-kit","curve-editor.customPresets",this.presets.custom,"global")},showPopup(){clearTimeout(e),e=setTimeout(()=>{vm.showSettings=!0},200)},hidePopup(){clearTimeout(e),e=setTimeout(()=>{vm.showSettings=!1},200)},async init(){const e=await Editor.Profile.getConfig("ui-kit","curve-editor.customPresets");this.presets.custom=e||{},this.presets.default=defaultPresets.default.map(e=>({keys:e})),panel.$.editor.clear(),panel.$.editor.config=Object.assign(panel.$.editor.config,panel.option.config),panel.$.editor.initCurveCtrl(),panel.$.editor.value=transValueToCurves(this.value,this.label)},onCurveSettings(e){const t=parseInt(e.target.value),n=e.target.getAttribute("name"),o=this;switch(n){case"postWrapMode":case"preWrapMode":panel.$.editor.curveCtrl.updateCurveWrapMode(n,t),o.value[n]=t,panel.$.editor.value=transValueToCurves(o.value,o.label),o.emit("change"),o.emit("confirm");break;case"spacingFrame":panel.$.editor.curveCtrl.config.spacingFrame=t}},async onPreset(e){const t=e.target.getAttribute("index");if(!t)return;const n=this.presets[this.presetConfig.tab][t];if(n&&n.keys.length){if(patchMultiToKeys(JSON.parse(JSON.stringify(n.keys))).find(e=>e.point.y!==Editor.Utils.Math.clamp(e.point.y,panel.option.config.yRange[0],panel.option.config.yRange[1]))){Editor.Panel._kitControl.hold();const e=await Editor.Dialog.warn(Editor.I18n.t("ui-kit.curve_editor.presetOutRange"),{cancel:0,buttons:["cancel","confirm"],default:0});if(Editor.Panel._kitControl.hold(),0===e.response)return}vm.value.keys=patchMultiToKeys(n.keys),panel.$.editor.value=transValueToCurves(this.value,this.label),this.emit("change"),this.emit("confirm")}},onResetScale(){panel.$.editor.curveCtrl.resetScale()},onNewPreset(){this.$set(this.presets.custom,this.newPreset.name,{...this.value,keys:unpatchMultiToKeys(this.value.keys)}),Editor.Profile.setConfig("ui-kit","curve-editor.customPresets",this.presets.custom,"global")},emit(e,t){console.debug("emit",e),t&&(vm.value.keys=transCurvesToKeys(t,vm.label));const n=unpatchMultiToKeys(vm.value.keys);checkValueOutRange(n,[0,1],vm.config.yRange)?console.debug("[Curve Editor] keys out of range"):Editor.Panel._kitControl.emit(e,panel.timestamp,{...vm.value,keys:n})},onMulti(e){const t=e.target.value;if(this.value.multiplier===t||t<0||!t)return;const n=t/this.value.multiplier;this.value.keys=patchMultiToKeys(this.value.keys,n),panel.$.editor.config.yRange=panel.$.editor.config.yRange.map(e=>e*n),this.value.multiplier=t,panel.$.editor.initCurveCtrl(),panel.$.editor.value=transValueToCurves(this.value,this.label),this.emit("change")},onMultiConfirm(e){const t=e.target.value,n=e.target;!t||t<=0?requestAnimationFrame(()=>{n.value=panel&&panel.option&&panel.option.value.multiplier||1}):this.emit("confirm")}}})}function checkValueOutRange(e,t,n){return!(!t&&!n)&&e.find(e=>{const{x:o,y:i}=e.point;return!!(t&&"number"==typeof t[0]&&o<t[0]||t&&"number"==typeof t[1]&&o>t[1])||!!(n&&"number"==typeof n[0]&&i<n[0]||n&&"number"==typeof n[1]&&i>n[1])})}function patchMultiToKeys(e,t=panel.option.value.multiplier){return e.map(e=>({tangentWeightMode:e.tangentWeightMode,interpMode:e.interpMode,inTangentWeight:e.inTangentWeight*t,outTangentWeight:e.outTangentWeight*t,point:{x:e.point.x,y:e.point.y*t},inTangent:e.inTangent*t,outTangent:e.inTangent*t}))}function unpatchMultiToKeys(e,t=panel.option.value.multiplier||1){return e.map(e=>{return{tangentWeightMode:e.tangentWeightMode,interpMode:e.interpMode,inTangentWeight:e.inTangentWeight/t,outTangentWeight:e.outTangentWeight/t,point:{x:e.point.x,y:e.point.y/t},inTangent:e.inTangent/t,outTangent:e.inTangent/t}})}function transValueToCurves(e,t){return{duration:1,wrapMode:1,curveInfos:{[t]:{preWrapMode:e.preWrapMode,postWrapMode:e.postWrapMode,keys:e.keys,color:"red"}}}}function transCurvesToKeys(e,t){return e.curveInfos[t].keys}exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static/curve-editor/index.html"),"utf8"),exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../curve-editor.css"),"utf8"),exports.$={editor:".editor",presets:".curve-editor"},exports.methods={async init(){const e=await Editor.Panel._kitControl.getOptionsCache();e&&(panel.option=e,panel.timestamp=e.timestamp,e.config||(console.warn(`Get config of curve (${e.label}) failed!`),e.config={}),e.value.multiplier?(e.value.keys=patchMultiToKeys(e.value.keys,e.value.multiplier),e.config.yRange?e.config.yRange=e.config.yRange.map(t=>t*e.value.multiplier):e.config.yRange=[0,1]):(e.value.multiplier=1,e.config.yRange=e.config.yRange||[0,1]),vm?(vm.value=e.value,vm.label=e.label,vm.config.showPreWrapMode=!!e.config.showPreWrapMode,vm.config.showPostWrapMode=!!e.config.showPostWrapMode,e.config.spacingFrame=await Editor.Profile.getConfig("ui-kit","curve-editor.spacingFrame")||.1,vm.config.negative=!(e.config.yRange&&e.config.yRange[0]>=0),panel.$.editor.curveCtrl.clear(),panel.$.editor.config=Object.assign(panel.$.editor.config,e.config),panel.$.editor.initCurveCtrl(),panel.$.editor.value=transValueToCurves(e.value,e.label)):initVue())},reset(){console.debug("reset"),exports.methods.init()},clear(){},deleteSelectedKeys(){panel.$.editor.curveCtrl&&panel.$.editor.curveCtrl.delSelectedKeys()},copySelectedKeys(){panel.$.editor.curveCtrl&&panel.$.editor.curveCtrl.copySelectedKeys()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;