"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),section=__importStar(require("./comps/section")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static","/template/panels/searcher.html"),"utf8"),exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../../dist/searcher.css"),"utf8");const minimatch=require("minimatch");let vm=null,panel=null;const allowCreateAssetTypes=["cc.Script","cc.RenderPipeline","cc.AnimationClip","cc.EffectAsset","cc.Material","cc.PhysicsMaterial","cc.RenderTexture","cc.SceneAsset","cc.SpriteAtlas","cc.TerrainAsset","cc.TextureCube"];let DataDumpCache=[];const maxLinesNumber=50;exports.$={content:".searcher"};const recordPreview={method:"",id:"",info:{}};async function ready(){vm=new Vue({el:(panel=this).$.content,components:{"comps-section":section},data:{loading:!0,search:"",selected:null,type:"",ccType:"",assetFilter:null,dataDump:null,dataDumpShowNumber:maxLinesNumber},computed:{expand(){return!!this.search}},watch:{selected(){const e=this.$refs.main.querySelector(".line[selected]");if(e&&e.removeAttribute("selected"),!this.selected)return;const t=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');t&&(t.setAttribute("selected",!0),t.scrollIntoViewIfNeeded(),t.parentNode&&!t.parentNode.expand&&(t.parentNode.expand=!0))}},mounted(){this.$refs.container.addEventListener("scroll",()=>{const{scrollHeight:e,clientHeight:t,scrollTop:s}=this.$refs.container;e-t-s<100&&this.dataDump&&this.dataDumpShowNumber<this.dataDump.length&&(this.dataDumpShowNumber+=maxLinesNumber)})},methods:{t:e=>Editor.I18n.t(`ui-kit.searcher.${e}`),async updateData(e,t,s){const a=this;switch(a.$refs.searchInput.value="",a.type!==e&&(a.dataDump=null,a.dataDumpShowNumber=maxLinesNumber),a.type=e,a.ccType=t,a.type){case"add-component":await a.addComponentsInit();break;case"node":await a.searchNodeInit(s.filterOptions);break;case"component":a.ccType=await getExtendsClass(t),await a.searchComponentsInit();break;case"asset":a.ccType=await getExtendsClass(t),a.assetFilter=s.assetFilter,await a.searchAssetsInit();break;case"script":await a.searchScriptInit()}},async addComponentsInit(){(DataDumpCache=await Editor.Message.request("scene","query-components")).sort((e,t)=>{const s=e.path.match(/\//g),a=t.path.match(/\//g),r=s?s.length:0,n=a?a.length:0;return r===n?e.path.localeCompare(t.path):r-n}),this.dataDump=sortCompDump(DataDumpCache)},async searchComponentsInit(){const e=await Editor.Message.request("scene","query-node-tree");(DataDumpCache=sortNodeCompDump(e,this.ccType.split(","))).sort((e,t)=>e.name.localeCompare(t.name)),this.dataDump=DataDumpCache,this.selected=null},async searchAssetsInit(){const e=this,t=[];if(e.ccType){const s=e.ccType.split(",");for(const e of s){const s=await Editor.Message.request("asset-db","query-assets",{ccType:e.trim()});for(let e=0;e<s.length;e++)t.push(s[e])}}else if(e.assetFilter){const s=await Editor.Message.request("asset-db","query-assets",e.assetFilter);for(let e=0;e<s.length;e++)t.push(s[e])}DataDumpCache=[];for(const e of t){const t=await getAssetIconInfo(e),s=e.displayName||e.name,a={type:e.type,name:s,uuid:e.uuid,path:e.url,sort:s+e.url,iconInfo:t};DataDumpCache.push(a)}DataDumpCache.sort((e,t)=>e.sort.localeCompare(t.sort)),e.dataDump=DataDumpCache,e.dataDumpShowNumber=maxLinesNumber},async searchNodeInit(e){const t=await Editor.Message.request("scene","query-node-tree");DataDumpCache=sortNodeDump(t,e),this.dataDump=DataDumpCache,this.dataDumpShowNumber=maxLinesNumber},async searchScriptInit(){const e=this,t={excludeSelf:!0,extends:e.ccType};e.ccType&&"string"==typeof e.ccType&&(t.extends=[e.ccType]),(DataDumpCache=await Editor.Message.request("scene","query-classes",t)).sort((e,t)=>e.name.localeCompare(t.name)),e.dataDump=sortScriptDump(DataDumpCache)},onSearch(e){const t=this,s=e.target.value.trim();if(t.search===s)return;t.search=s;let a=DataDumpCache;try{if(t.search){const e=new RegExp(t.search,"i");a=DataDumpCache.filter(t=>{let s=!1;return t.name&&(s=-1!==t.name.search(e)),!s&&t.path&&(s=-1!==t.path.search(e)),s})}}catch(e){}"add-component"===t.type?t.dataDump=sortCompDump(a):("script"===t.type?t.dataDump=sortScriptDump(a):t.dataDump=a,t.dataDumpShowNumber=maxLinesNumber,t.$refs.container.scrollTop=0),window.requestIdleCallback(()=>{a&&a.length&&t.search?t.selected=a[0].name:t.selected=null})},searchKeydown(e){e.target.blur();const t=this.getValues();t.length&&(vm.selected=t[0])},getValues(){const e=[];return this.$refs.main.querySelectorAll(".line").forEach(t=>{const s=t.getAttribute("value");s&&e.push(s)}),e},upDownSelect(e){const t=this.getValues();let s=t.indexOf(this.selected)+e;s===t.length&&(s=0),s<=-1&&(s=t.length-1),this.selected=t[s]},enterSelect(){const e=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');e&&e.click()},onSelect(e,t){"string"==typeof e&&(vm.selected=e,vm.search="",recordPreview.method="",Editor.Panel._kitControl.emit("change",vm.timestamp,e,t),Editor.Panel._kitControl.emit("confirm",vm.timestamp,e,t),Editor.Panel._kitControl.hide())},twinkle(e){"asset"===this.type?Editor.Message.send("assets","twinkle",e.uuid):"node"===this.type?Editor.Message.send("hierarchy","twinkle",e.uuid):"component"===this.type&&Editor.Message.send("hierarchy","twinkle",e.nodeUuid)},checkAllowCreate:e=>allowCreateAssetTypes.includes(e),async createAsset(){const e=this;Editor.Panel._kitControl.hold();const t=await Editor.Message.request("asset-db","create-asset-dialog",e.ccType);if(t){const s=await Editor.Message.request("asset-db","query-asset-info",t);if(s)return void e.onSelect(t,s)}Editor.Panel._kitControl.hide()},preview(e,t,s){recordPreview.method=e,recordPreview.id=t,recordPreview.info=s,Editor.Panel._kitControl.emit("preview",vm.timestamp,e,t,s)}}}),exports.methods.init()}async function beforeClose(){}async function close(){}exports.methods={reset(){exports.methods.init()},clear:async()=>("confirm"===recordPreview.method&&(recordPreview.method="",Editor.Panel._kitControl.emit("preview",vm.timestamp,"cancel",recordPreview.id,recordPreview.info)),vm.loading=!0,new Promise(e=>{setTimeout(()=>{e(void 0)},0)})),async init(){vm.loading=!0;const e=await Editor.Panel._kitControl.getOptionsCache();e&&(await vm.updateData(e.type,e.droppable,e),vm.selected=e.value,vm.timestamp=e.timestamp,vm.loading=!1,requestAnimationFrame(()=>{vm.$refs.searchInput.focus()}))},up(){vm.upDownSelect(-1)},down(){vm.upDownSelect(1)},enter(){vm.enterSelect()},esc(){vm.$refs.searchInput.focus()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;const imageImporter=["image","texture","sprite-frame","gltf-mesh"];async function getAssetIconInfo(e){const t={type:"icon",value:"file"};if(!e)return t;if(imageImporter.includes(e.importer)){if(!e.source&&e.fatherInfo){const s=path_1.extname(e.fatherInfo.source).toLowerCase();let a=getLibraryImageSrc(e.fatherInfo.library,s);if(!a&&"texture"===e.importer){t.value=e.importer;const s=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!s||!s.userData||!s.userData.imageUuidOrDatabaseUri)return t;const r=await Editor.Message.request("asset-db","query-asset-info",s.userData.imageUuidOrDatabaseUri);if(!r)return t;const n=path_1.extname(r.name).toLowerCase();a=getLibraryImageSrc(r.library,n)}t.value=a}else{const s=path_1.extname(e.source);t.value=e.library[s]}return t.type="image",t}const s=e.importer;return s?(t.value=s,t):t}function getLibraryImageSrc(e,t){let s=e[t];if(!s){s=e[Object.keys(e).find(e=>".json"!==e)||""]}return s}function sortNodeDump(e,t,s=[]){return e?0===e.children.length?s:(e.children.forEach(e=>{(!t||t&&t.pathPattern&&minimatch(e.path,t.pathPattern))&&s.push({name:e.name,type:e.type,uuid:e.uuid,path:e.path}),e.children.length>0&&sortNodeDump(e,t,s)}),s):s}function sortNodeCompDump(e,t,s=[],a){if(!e)return s;if(0===e.children.length)return s;for(const r of t)e.children.forEach(e=>{let t=a||"";t+=` / ${e.name}`;const n=e.components.find(e=>e.type===r);n&&s.push({name:e.name,uuid:n.value,path:t,nodeUuid:e.uuid,iconName:r}),e.children.length>0&&sortNodeCompDump(e,[r],s,t)});return s}function sortCompDump(e){const t={};for(const s of e){if(s.path.startsWith("hidden:"))continue;const e=s.path.split("/");let a=t;e.forEach((t,r)=>{t.startsWith("i18n:")&&(t=Editor.I18n.t("ENGINE."+t.substr(5))||t),r===e.length-1?(s.cid&&(t=s.cid),a[t]={iconName:s.name||"component",...s}):a[t]||(a[t]={}),a=a[t]})}return t}function sortScriptDump(e){const t={};for(const s of e)t[s.name]={iconName:"component",...s};return t}async function getExtendsClass(e){if(!e)return"";const t=e.split(","),s=[];for(const e of t){if(!e)continue;const t=await Editor.Message.request("scene","query-classes",{extends:e});if(Array.isArray(t)&&t.length)for(const e of t)s.includes(e.name)||s.push(e.name)}return s.join(",")}