"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),section=__importStar(require("./comps/section")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static","/template/panels/searcher.html"),"utf8"),exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../../dist/searcher.css"),"utf8");const minimatch=require("minimatch");let vm=null,panel=null;const allowCreateAssetTypes=["cc.Script","cc.RenderPipeline","cc.AnimationClip","cc.EffectAsset","cc.Material","cc.PhysicsMaterial","cc.RenderTexture","cc.SceneAsset","cc.SpriteAtlas","cc.TerrainAsset","cc.TextureCube"];let DataDumpCache=[];const maxLinesNumber=50;async function ready(){vm=new Vue({el:(panel=this).$.content,components:{"comps-section":section},data:{loading:!0,search:"",selected:null,type:"",ccType:"",assetFilter:null,dataDump:null,dataDumpShowNumber:maxLinesNumber},computed:{expand(){return!!this.search}},watch:{selected(){const e=this.$refs.main.querySelector(".line[selected]");if(e&&e.removeAttribute("selected"),!this.selected)return;const t=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');t&&(t.setAttribute("selected",!0),t.scrollIntoViewIfNeeded(),t.parentNode&&!t.parentNode.expand&&(t.parentNode.expand=!0))}},mounted(){this.$refs.container.addEventListener("scroll",()=>{const{scrollHeight:e,clientHeight:t,scrollTop:a}=this.$refs.container;e-t-a<100&&this.dataDump&&this.dataDumpShowNumber<this.dataDump.length&&(this.dataDumpShowNumber+=maxLinesNumber)})},methods:{t:e=>Editor.I18n.t(`ui-kit.searcher.${e}`),async updateData(e,t,a){const s=this;switch(s.$refs.searchInput.value="",s.type!==e&&(s.dataDump=null,s.dataDumpShowNumber=maxLinesNumber),s.type=e,s.ccType=t,s.type){case"add-component":await s.addComponentsInit();break;case"node":await s.searchNodeInit(a.filterOptions);break;case"component":s.ccType=await getExtendsClass(t),await s.searchComponentsInit();break;case"asset":s.ccType=await getExtendsClass(t),s.assetFilter=a.assetFilter,await s.searchAssetsInit();break;case"script":await s.searchScriptInit()}},async addComponentsInit(){(DataDumpCache=await Editor.Message.request("scene","query-components")).sort((e,t)=>{const a=e.path.match(/\//g),s=t.path.match(/\//g),r=a?a.length:0,n=s?s.length:0;return r===n?e.path.localeCompare(t.path):r-n}),this.dataDump=sortCompDump(DataDumpCache)},async searchComponentsInit(){const e=await Editor.Message.request("scene","query-node-tree");(DataDumpCache=sortNodeCompDump(e,this.ccType.split(","))).sort((e,t)=>e.name.localeCompare(t.name)),this.dataDump=DataDumpCache,this.selected=null},async searchAssetsInit(){const e=this,t=[];if(e.ccType){const a=e.ccType.split(",");for(const e of a){const a=await Editor.Message.request("asset-db","query-assets",{ccType:e.trim()});for(let e=0;e<a.length;e++)t.push(a[e])}}else if(e.assetFilter){const a=await Editor.Message.request("asset-db","query-assets",e.assetFilter);for(let e=0;e<a.length;e++)t.push(a[e])}DataDumpCache=[];for(const e of t){const t=await getAssetIconInfo(e),a=e.displayName||e.name,s={type:e.type,name:a,uuid:e.uuid,path:e.url,sort:a+e.url,iconInfo:t};DataDumpCache.push(s)}DataDumpCache.sort((e,t)=>e.sort.localeCompare(t.sort)),e.dataDump=DataDumpCache,e.dataDumpShowNumber=maxLinesNumber},async searchNodeInit(e){const t=await Editor.Message.request("scene","query-node-tree");DataDumpCache=sortNodeDump(t,e),this.dataDump=DataDumpCache,this.dataDumpShowNumber=maxLinesNumber},async searchScriptInit(){const e=this,t={excludeSelf:!0,extends:e.ccType};e.ccType&&"string"==typeof e.ccType&&(t.extends=[e.ccType]),(DataDumpCache=await Editor.Message.request("scene","query-classes",t)).sort((e,t)=>e.name.localeCompare(t.name)),e.dataDump=sortScriptDump(DataDumpCache)},onSearch(e){const t=this,a=e.target.value.trim();if(t.search===a)return;t.search=a;let s=DataDumpCache;try{if(t.search){const e=new RegExp(t.search,"i");s=DataDumpCache.filter(t=>{let a=!1;return t.name&&(a=-1!==t.name.search(e)),!a&&t.path&&(a=-1!==t.path.search(e)),a})}}catch(e){}"add-component"===t.type?t.dataDump=sortCompDump(s):("script"===t.type?t.dataDump=sortScriptDump(s):t.dataDump=s,t.dataDumpShowNumber=maxLinesNumber,t.$refs.container.scrollTop=0),window.requestIdleCallback(()=>{s&&s.length&&t.search?t.selected=s[0].name:t.selected=null})},searchKeydown(e){e.target.blur();const t=this.getValues();t.length&&(vm.selected=t[0])},getValues(){const e=[];return this.$refs.main.querySelectorAll(".line").forEach(t=>{const a=t.getAttribute("value");a&&e.push(a)}),e},upDownSelect(e){const t=this.getValues();let a=t.indexOf(this.selected)+e;a===t.length&&(a=0),a<=-1&&(a=t.length-1),this.selected=t[a]},enterSelect(){const e=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');e&&e.click()},onSelect(e,t){"string"==typeof e&&(vm.selected=e,vm.search="",Editor.Panel._kitControl.emit("change",vm.timestamp,e,t),Editor.Panel._kitControl.emit("confirm",vm.timestamp,e,t),Editor.Panel._kitControl.hide())},twinkle(e){"asset"===this.type?Editor.Message.send("assets","twinkle",e.uuid):"node"===this.type?Editor.Message.send("hierarchy","twinkle",e.uuid):"component"===this.type&&Editor.Message.send("hierarchy","twinkle",e.nodeUuid)},checkAllowCreate:e=>allowCreateAssetTypes.includes(e),async createAsset(){const e=this;Editor.Panel._kitControl.hold();const t=await Editor.Message.request("asset-db","create-asset-dialog",e.ccType);if(t){const a=await Editor.Message.request("asset-db","query-asset-info",t);if(a)return void e.onSelect(t,a)}Editor.Panel._kitControl.hide()},preview(e,t,a){Editor.Panel._kitControl.emit("preview",vm.timestamp,e,t,a)}}}),exports.methods.init()}async function beforeClose(){}async function close(){}exports.$={content:".searcher"},exports.methods={reset(){exports.methods.init()},clear(){vm.loading=!0},async init(){vm.loading=!0;const e=await Editor.Panel._kitControl.getOptionsCache();e&&(await vm.updateData(e.type,e.droppable,e),vm.selected=e.value,vm.timestamp=e.timestamp,vm.loading=!1,requestAnimationFrame(()=>{vm.$refs.searchInput.focus()}))},up(){vm.upDownSelect(-1)},down(){vm.upDownSelect(1)},enter(){vm.enterSelect()},esc(){vm.$refs.searchInput.focus()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;const imageImporter=["image","texture","sprite-frame","gltf-mesh"];async function getAssetIconInfo(e){const t={type:"icon",value:"file"};if(!e)return t;if(imageImporter.includes(e.importer)){if(!e.source&&e.fatherInfo){const a=path_1.extname(e.fatherInfo.source).toLowerCase();let s=getLibraryImageSrc(e.fatherInfo.library,a);if(!s&&"texture"===e.importer){t.value=e.importer;const a=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!a||!a.userData||!a.userData.imageUuidOrDatabaseUri)return t;const r=await Editor.Message.request("asset-db","query-asset-info",a.userData.imageUuidOrDatabaseUri);if(!r)return t;const n=path_1.extname(r.name).toLowerCase();s=getLibraryImageSrc(r.library,n)}t.value=s}else{const a=path_1.extname(e.source);t.value=e.library[a]}return t.type="image",t}const a=e.importer;return a?(t.value=a,t):t}function getLibraryImageSrc(e,t){let a=e[t];if(!a){a=e[Object.keys(e).find(e=>".json"!==e)||""]}return a}function sortNodeDump(e,t,a=[]){return e?0===e.children.length?a:(e.children.forEach(e=>{(!t||t&&t.pathPattern&&minimatch(e.path,t.pathPattern))&&a.push({name:e.name,type:e.type,uuid:e.uuid,path:e.path}),e.children.length>0&&sortNodeDump(e,t,a)}),a):a}function sortNodeCompDump(e,t,a=[],s){if(!e)return a;if(0===e.children.length)return a;for(const r of t)e.children.forEach(e=>{let t=s||"";t+=` / ${e.name}`;const n=e.components.find(e=>e.type===r);n&&a.push({name:e.name,uuid:n.value,path:t,nodeUuid:e.uuid,iconName:r}),e.children.length>0&&sortNodeCompDump(e,[r],a,t)});return a}function sortCompDump(e){const t={};for(const a of e){if(a.path.startsWith("hidden:"))continue;const e=a.path.split("/");let s=t;e.forEach((t,r)=>{t.startsWith("i18n:")&&(t=Editor.I18n.t("ENGINE."+t.substr(5))||t),r===e.length-1?(a.cid&&(t=a.cid),s[t]={iconName:a.name||"component",...a}):s[t]||(s[t]={}),s=s[t]})}return t}function sortScriptDump(e){const t={};for(const a of e)t[a.name]={iconName:"component",...a};return t}async function getExtendsClass(e){if(!e)return"";const t=e.split(","),a=[];for(const e of t){if(!e)continue;const t=await Editor.Message.request("scene","query-classes",{extends:e});if(Array.isArray(t)&&t.length)for(const e of t)a.includes(e.name)||a.push(e.name)}return a.join(",")}