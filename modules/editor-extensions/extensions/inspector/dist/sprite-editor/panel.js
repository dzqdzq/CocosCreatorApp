"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),Vue=require("vue/dist/vue.js"),SVG=require("svg.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;async function ready(t){vm=new Vue({el:(panel=this).$.content,data:{uuid:null,userData:null,svg:null,image:null,svgColor:"#5c5",svgColorBright:"#8fef8f",dotSize:6,borderLeft:0,borderRight:0,borderBottom:0,borderTop:0,width:0,height:0,leftPos:0,rightPos:0,topPos:0,bottomPos:0,startLeftPos:0,startRightPos:0,startTopPos:0,startBottomPos:0,scale:100,minScale:5,maxScale:500,horizontal:"center",changed:!1},computed:{topPosMax(){const t=this.height-this.bottomPos;return t||!1},bottomPosMax(){const t=this.height-this.topPos;return t||!1},leftPosMax(){const t=this.width-this.rightPos;return t||!1},rightPosMax(){const t=this.width-this.leftPos;return t||!1}},watch:{async userData(){if(vm.userData.imageUuidOrDatabaseUri){await vm.openSprite();const t=vm.userData.rawWidth||vm.userData.width,e=vm.userData.rawHeight||vm.userData.height,o=window.screen.width*window.devicePixelRatio*2,r=window.screen.height*window.devicePixelRatio*2;if(t>o||e>r){vm.minScale=1,vm.maxScale=200;const o=parseInt(vm.$refs.canvas.parentNode.clientWidth/t*100,10),r=parseInt(vm.$refs.canvas.parentNode.clientHeight/e*100,10);vm.scale=Math.min(o,r)||vm.minScale}vm.refreshScaleSlider()}},scale(){vm.resize()},leftPos(){vm.leftPosChanged()},rightPos(){vm.rightPosChanged()},topPos(){vm.topPosChanged()},bottomPos(){vm.bottomPosChanged()}},mounted(){this.svg=SVG(this.$refs.svg),this.svg.spof(),this.refreshScaleSlider()},methods:{t:t=>Editor.I18n.t(`inspector.sprite_editor.${t}`),resize(){if(!vm.image&&!vm.userData)return;const t=vm.userData.width*vm.scale/100,e=vm.userData.height*vm.scale/100;vm.userData.rotated&&(vm._scalingSize={width:Math.ceil(e),height:Math.ceil(t)}),vm.$refs.canvas.width=t,vm.$refs.canvas.height=e;const o=vm.$refs.canvas.parentNode.clientWidth;vm.horizontal=o>t?"center":"left",vm.repaint()},refreshScaleSlider(){const t=this,e=t.$refs.scale;e.min=t.minScale,e.max=t.maxScale,e.value=t.scale,t.$refs.content.onmousewheel=(o=>{let r=1;o.deltaY<0&&(r=-1),e.value-=r,t.scale=e.value,o.preventDefault()})},scaleChange(){vm.image&&vm.userData&&(vm.scale=vm.$refs.scale.value)},async openSprite(){vm.width=vm.userData.width,vm.height=vm.userData.height,vm.leftPos=vm.userData.borderLeft,vm.rightPos=vm.userData.borderRight,vm.topPos=vm.userData.borderTop,vm.bottomPos=vm.userData.borderBottom;const t=await Editor.Message.request("asset-db","query-asset-info",vm.userData.imageUuidOrDatabaseUri.split("@")[0]);if(!t)return"";const e=Object.keys(t.library).find(t=>".json"!==t);if(!e)return"";vm.image=new Image,vm.image.src=t.library[e].replace("#","%23"),vm.image.onload=(()=>{vm.resize()})},repaint(){const t=vm.$refs.canvas.getContext("2d"),e=vm.$refs.canvas.width,o=vm.$refs.canvas.height;let r,s,m,a,v,i;if(vm.userData.rotated){const n=e/2,d=o/2;t.translate(n,d),t.rotate(-90*Math.PI/180),t.translate(-n,-d),m=n-vm._scalingSize.width/2,a=d-vm._scalingSize.height/2,r=vm.userData.height,s=vm.userData.width,v=o,i=e}else m=0,a=0,r=vm.userData.width,s=vm.userData.height,v=e,i=o;t.drawImage(vm.image,vm.userData.trimX,vm.userData.trimY,r,s,m,a,v,i),vm.$nextTick(()=>{vm.drawEditElements()})},drawEditElements(){if(!vm.image)return;vm.svg.clear();const t=vm.getCanvasRect();vm.updateBorderPos(t),vm.lineLeft=vm.drawLine(vm.borderLeft,t.bottom,vm.borderLeft,t.top,"l"),vm.lineRight=vm.drawLine(vm.borderRight,t.bottom,vm.borderRight,t.top,"r"),vm.lineTop=vm.drawLine(t.left,vm.borderTop,t.right,vm.borderTop,"t"),vm.lineBottom=vm.drawLine(t.left,vm.borderBottom,t.right,vm.borderBottom,"b"),vm.dotLB=vm.drawDot(vm.borderLeft,vm.borderBottom,"lb"),vm.dotLT=vm.drawDot(vm.borderLeft,vm.borderTop,"lt"),vm.dotRB=vm.drawDot(vm.borderRight,vm.borderBottom,"rb"),vm.dotRT=vm.drawDot(vm.borderRight,vm.borderTop,"rt"),vm.dotL=vm.drawDot(vm.borderLeft,t.bottom-t.height/2,"l"),vm.dotR=vm.drawDot(vm.borderRight,t.bottom-t.height/2,"r"),vm.dotB=vm.drawDot(t.left+t.width/2,vm.borderBottom,"b"),vm.dotT=vm.drawDot(t.left+t.width/2,vm.borderTop,"t")},getCanvasRect(){const t={};return t.top=vm.$refs.canvas.offsetTop,t.left=vm.$refs.canvas.offsetLeft,t.bottom=vm.$refs.canvas.offsetTop+vm.$refs.canvas.height,t.right=vm.$refs.canvas.offsetLeft+vm.$refs.canvas.width,t.width=vm.$refs.canvas.width,t.height=vm.$refs.canvas.height,t},updateBorderPos(t){vm.borderLeft=t.left+vm.leftPos*(vm.scale/100),vm.borderRight=t.right-vm.rightPos*(vm.scale/100),vm.borderTop=t.top+vm.topPos*(vm.scale/100),vm.borderBottom=t.bottom-vm.bottomPos*(vm.scale/100)},drawLine(t,e,o,r,s){const m={x:t,y:e},a={x:o,y:r},v=lineTool(vm.svg,m,a,vm.svgColor,"default",vm.svgCallbacks(s));return"l"===s||"r"===s?v.style("cursor","col-resize"):"t"!==s&&"b"!==s||v.style("cursor","row-resize"),v},drawDot(t,e,o){const r={color:vm.svgColor},s=circleTool(vm.svg,vm.dotSize,r,r,vm.svgCallbacks(o));return"l"===o||"r"===o||"t"===o||"b"===o?s.style("cursor","pointer"):"lb"===o||"rt"===o?s.style("cursor","nesw-resize"):"rb"!==o&&"lt"!==o||s.style("cursor","nwse-resize"),vm.moveDotTo(s,t,e),s},moveDotTo(t,e,o){t&&t.move(e,o)},svgCallbacks(t){const e={start:()=>{vm.startLeftPos=vm.leftPos,vm.startRightPos=vm.rightPos,vm.startTopPos=vm.topPos,vm.startBottomPos=vm.bottomPos},update:(e,o)=>{vm.svgElementMoved(t,e,o)}};return e},svgElementMoved(t,e,o){let r=e/(vm.scale/100),s=o/(vm.scale/100);if(r=r>0?Math.floor(r):Math.ceil(r),s=s>0?Math.floor(s):Math.ceil(s),Math.abs(r)>0){if(t.indexOf("l")>=0){const t=vm.startLeftPos+r,e=vm.userData.width||vm.image.width;vm.leftPos=vm.correctPosValue(t,0,e-vm.rightPos)}if(t.indexOf("r")>=0){const t=vm.startRightPos-r,e=vm.userData.width||vm.image.width;vm.rightPos=vm.correctPosValue(t,0,e-vm.leftPos)}}if(Math.abs(s)>0){if(t.indexOf("t")>=0){const t=vm.startTopPos+s,e=vm.userData.height||vm.image.height;vm.topPos=vm.correctPosValue(t,0,e-vm.bottomPos)}if(t.indexOf("b")>=0){const t=vm.startBottomPos-s,e=vm.userData.height||vm.image.height;vm.bottomPos=vm.correctPosValue(t,0,e-vm.topPos)}}},correctPosValue:(t,e,o)=>t<e?e:t>o?o:t,checkState(){const t=vm.leftPos!==vm.userData.borderLeft,e=vm.rightPos!==vm.userData.borderRight,o=vm.topPos!==vm.userData.borderTop,r=vm.bottomPos!==vm.userData.borderBottom;vm.changed=t||e||o||r,vm.save()},leftPosChanged(){if(!vm.image)return;const t=vm.getCanvasRect();vm.updateBorderPos(t),vm.moveDotTo(vm.dotL,vm.borderLeft,t.bottom-t.height/2),vm.moveDotTo(vm.dotLB,vm.borderLeft,vm.borderBottom),vm.moveDotTo(vm.dotLT,vm.borderLeft,vm.borderTop),vm.lineLeft&&vm.lineLeft.plot(vm.borderLeft,t.bottom,vm.borderLeft,t.top),vm.checkState()},rightPosChanged(){if(!vm.image)return;const t=vm.getCanvasRect();vm.updateBorderPos(t),vm.moveDotTo(vm.dotR,vm.borderRight,t.bottom-t.height/2),vm.moveDotTo(vm.dotRB,vm.borderRight,vm.borderBottom),vm.moveDotTo(vm.dotRT,vm.borderRight,vm.borderTop),vm.lineRight&&vm.lineRight.plot(vm.borderRight,t.bottom,vm.borderRight,t.top),this.checkState()},topPosChanged(){if(!vm.image)return;const t=vm.getCanvasRect();vm.updateBorderPos(t),vm.moveDotTo(vm.dotT,t.left+t.width/2,vm.borderTop),vm.moveDotTo(vm.dotLT,vm.borderLeft,vm.borderTop),vm.moveDotTo(vm.dotRT,vm.borderRight,vm.borderTop),vm.lineTop&&vm.lineTop.plot(t.left,vm.borderTop,t.right,vm.borderTop),vm.checkState()},bottomPosChanged(){if(!vm.image)return;const t=vm.getCanvasRect();vm.updateBorderPos(t),vm.moveDotTo(vm.dotB,t.left+t.width/2,vm.borderBottom),vm.moveDotTo(vm.dotLB,vm.borderLeft,vm.borderBottom),vm.moveDotTo(vm.dotRB,vm.borderRight,vm.borderBottom),vm.lineBottom&&vm.lineBottom.plot(t.left,vm.borderBottom,t.right,vm.borderBottom),vm.checkState()},positionChange(t,e){vm[e]=t.target.value},save(){Editor.Message.send("inspector","sprite-change",{borderTop:vm.topPos,borderBottom:vm.bottomPos,borderLeft:vm.leftPos,borderRight:vm.rightPos}),Editor.Message.broadcast("sprite-editor:changed",{uuid:vm.uuid,userData:{borderTop:vm.topPos,borderBottom:vm.bottomPos,borderLeft:vm.leftPos,borderRight:vm.rightPos}})}}}),t&&panel.currentKeys(t.meta),Editor.Message.send("inspector","sprite-state",!0)}async function beforeClose(){}async function close(){Editor.Message.send("inspector","sprite-state",!1)}function circleTool(t,e,o,r,s,m){"string"!=typeof s&&(m=s,s="default");const a=t.group().style("cursor",s).fill(o||"none").stroke(r||"none"),v=a.circle().radius(e/2);let i;r&&(i=a.circle().stroke({width:8}).fill("none").style("stroke-opacity",0).radius(e/2));let n=!1;return a.style("pointer-events","bounding-box"),a.on("mouseover",()=>{o&&a.fill({color:vm.svgColorBright}),r&&a.stroke({color:vm.svgColorBright})}),a.on("mouseout",t=>{t.stopPropagation(),n||(o&&a.fill(o),r&&a.stroke(r))}),addMoveHandles(a,{cursor:s},{start(t,e,s){n=!0,o&&a.fill({color:vm.svgColorBright}),r&&a.stroke({color:vm.svgColorBright}),m.start&&m.start(t,e,s)},update(t,e,o){m.update&&m.update(t,e,o)},end(t){n=!1,o&&a.fill(o),r&&a.stroke(r),m.end&&m.end(t)}}),a.radius=function(t){return v.radius(t),i&&i.radius(t),this},a.cx=function(t){return this.x(t)},a.cy=function(t){return this.y(t)},a}function lineTool(t,e,o,r,s,m){const a=t.group().style("cursor",s).stroke({color:r}),v=a.line(e.x,e.y,o.x,o.y).style("stroke-width",1),i=a.line(e.x,e.y,o.x,o.y).style("stroke-width",8).style("stroke-opacity",0);let n=!1;return a.on("mouseover",()=>{a.stroke({color:vm.svgColorBright})}),a.on("mouseout",t=>{t.stopPropagation(),n||a.stroke({color:r})}),addMoveHandles(a,{cursor:s},{start(t,e,o){n=!0,a.stroke({color:vm.svgColorBright}),m.start&&m.start(t,e,o)},update(t,e,o){m.update&&m.update(t,e,o)},end(t){n=!1,a.stroke({color:r}),m.end&&m.end(t)}}),a.plot=function(...t){return v.plot(...t),i.plot(...t),this},a}function addMoveHandles(t,e,o){let r=0,s=0;function m(e){e.stopPropagation();const m=e.clientX-r,a=e.clientY-s;o.update&&o.update.call(t,m,a,e)}function a(e){document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",a),o.end&&o.end.call(t,e),e.stopPropagation()}2===arguments.length&&(o=e,e={}),t.on("mousedown",e=>{1===e.which&&(r=e.clientX,s=e.clientY,document.addEventListener("mousemove",m),document.addEventListener("mouseup",a),o.start&&o.start.call(t,e.offsetX,e.offsetY,e)),e.stopPropagation()})}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/sprite-editor.html"),"utf8"),exports.fonts=[{name:"inspector"}],exports.$={content:".sprite-editor"},exports.methods={currentKeys(t){vm&&t&&(vm.uuid!==t.uuid&&(vm.uuid=t.uuid,vm.scale=100),vm.userData=t.userData)}},exports.listeners={resize(){vm&&(vm.resize(),vm.refreshScaleSlider())}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;