"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.unload=exports.load=void 0;const electron_1=require("electron"),child_process_1=require("child_process"),path_1=require("path"),fs_extra_1=require("fs-extra"),cc_1=require("cc");function load(){}function unload(){}exports.load=load,exports.unload=unload,exports.methods={queryNodeWorldTransform(e){const t=cce.Node.query(e);return t?{worldPosition:[t.worldPosition.x,t.worldPosition.y,t.worldPosition.z],worldRotation:[t.worldRotation.x,t.worldRotation.y,t.worldRotation.z,t.worldRotation.w],worldScale:[t.worldScale.x,t.worldScale.y,t.worldScale.z]}:null},setNodeWorldTransform(e,t){const r=cce.Node.query(e);r&&(r.setWorldPosition(...t.worldPosition),r.setWorldRotation(...t.worldRotation),r.setWorldScale(...t.worldScale))},async generateVector(e){const t=await Editor.Message.request("asset-db","query-path",e.replace(/@[^@]+$/,""));if(!t)return;const r=await Editor.Message.request("asset-db","query-asset-meta",e),s=r.userData.isRGBE?"rgbm":"bgra8",a=path_1.extname(t),o=path_1.basename(t,a),c=path_1.join(Editor.Project.tmpDir,"inspector",`${o}_diffusion`),i=c+".txt";if(fs_extra_1.existsSync(i))try{await electron_1.shell.trashItem(i)}catch(e){}if(fs_extra_1.existsSync(i))try{await fs_extra_1.remove(i)}catch(e){console.error(e)}try{let e;const a=["--hemispherelightingcoef","--filter","irradiance","--dstFaceSize","32","--output0params","png,"+s+",latlong","--input",t,"--output0",c];r.userData.isRGB&&a.splice(0,0,"--rgbm "),fs_extra_1.ensureDirSync(path_1.dirname(c)),e="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),a):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),a),await new Promise((t,r)=>{e.on("close",()=>{t(void 0)})});let o=["",""];if(fs_extra_1.existsSync(i))o=fs_extra_1.readFileSync(i,"utf8").split(/\n/).map(e=>e.trim());else if("texture-cube"===r.importer)return void console.warn(Editor.I18n.t("inspector.scene.recommendErpTextureCube"));o[0]||(o[0]=""),o[1]||(o[1]="");const n=o[0].split(",").map(e=>parseFloat(e.trim())),l=o[1].split(",").map(e=>parseFloat(e.trim()));cc.director._scene._globals.ambient.skyColor=new cc_1.Vec4(n[0],n[1],n[2],0),cc.director._scene._globals.ambient.groundAlbedo=new cc_1.Vec4(l[0],l[1],l[2],0),Editor.Message.broadcast("scene:change-node",cc.director._scene.uuid)}catch(e){console.error(e)}},async generateDiffuseMap(e){const t=await Editor.Message.request("asset-db","query-path",e.replace(/@[^@]+$/,""));if(!t)return null;const r=await Editor.Message.request("asset-db","query-asset-meta",e),s=r.userData.isRGBE?"rgbm":"bgra8",a=path_1.extname(t),o=path_1.basename(t,a),c=path_1.join(path_1.dirname(t),`${o}_diffusion`),i=c+".png";if(fs_extra_1.existsSync(i))try{await electron_1.shell.trashItem(i)}catch(e){}if(fs_extra_1.existsSync(i))try{await fs_extra_1.remove(i)}catch(e){console.error(e)}try{let e;const a=["--filter","irradiance","--dstFaceSize","32","--output0params","png,"+s+",latlong","--input",t,"--output0",c];r.userData.isRGB&&a.splice(0,0,"--rgbm "),e="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),a):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),a),await new Promise((t,r)=>{e.on("close",()=>{t(void 0)})});const o=i+".meta";if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);e.userData.type="texture cube",fs_extra_1.outputJSONSync(o,e,{spaces:2})}else fs_extra_1.outputJSONSync(o,{ver:"0.0.0",importer:"*",userData:{type:"texture cube",isRGBE:r.userData.isRGBE}},{spaces:2});if(await Editor.Message.request("asset-db","refresh-asset",i),i){const e=await Editor.Message.request("asset-db","query-uuid",i);if(e){const t=await new Promise(t=>{cc.assetManager.loadAny(`${e}@b47c0`,(r,s)=>{r?(console.error(`asset can't be load:${e}`),t(null)):t(s)})});t&&(cc.director._scene._globals.skybox.diffuseMap=t,Editor.Message.broadcast("scene:change-node",cc.director._scene.uuid))}}}catch(e){console.error(e)}}};