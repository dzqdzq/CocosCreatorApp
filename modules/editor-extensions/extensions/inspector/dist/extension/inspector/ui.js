/**
 * UI 绑定
 *
 * 虚拟元素到实际的 UI 元素，需要一层绑定
 * 因为每一个 UI 上，数据操作后发送的事件、数据更新方式都可能有差异
 * 通用处理监听 change，confirm
 * 如果有特殊处理，可以继承 class 重写相关的方法
 */
'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.InspectorElement = exports.register = exports.createElement = void 0;
const elementHandleMap = new Map();
const HTMLElementMap = new WeakMap();
/**
 * 创建一个 html 元素
 * @param tag
 * @returns
 */
function createElement(vElem) {
    let handle = elementHandleMap.get(vElem.tag);
    if (!handle) {
        handle = elementHandleMap.get('*');
    }
    const elem = handle.create(vElem);
    handle.init(vElem, elem);
    return elem;
}
exports.createElement = createElement;
/**
 * 注册一个 ui 元素的处理方法
 * @param name
 * @param ui
 */
function register(name, ui) {
    elementHandleMap.set(name, new ui);
}
exports.register = register;
class InspectorElement {
    /**
     * 创建资源
     * @returns
     */
    create(vElem) {
        const elem = document.createElement(vElem.tag);
        HTMLElementMap.set(vElem, elem);
        // 同步 attrs
        for (const key in vElem.attrs) {
            elem.setAttribute(key, vElem.attrs[key]);
        }
        // 同步 text
        if (vElem.text.trim()) {
            elem.innerHTML = vElem.text;
        }
        // 同步 events
        const eventTemp = elem.__handle__ = elem.__handle__ || {};
        vElem.events.forEach((eventName) => {
            eventTemp[eventName] = function () {
                const root = vElem.getRoot();
                root?.dispatch('elem-change', vElem, eventName);
            };
            elem.addEventListener(eventName, eventTemp[eventName]);
        });
        // 同步 children
        vElem.children.forEach((child, index) => {
            const childElem = createElement(child);
            const pElem = elem.children[index];
            if (!pElem) {
                elem.appendChild(childElem);
            }
            else if (pElem !== childElem) {
                elem.insertBefore(childElem, pElem);
            }
        });
        return elem;
    }
    /**
     * 初始化元素，并绑定一些事件
     * @param elem
     * @param vElement
     */
    init(vElement, elem) {
        this.bind(vElement, elem);
    }
    /**
     * 绑定元素变化的事件
     * 随时准备同步数据
     */
    bind(vElement, elem) {
        vElement.setChangeCallback(() => {
            // 同步 events
            const eventTemp = elem.__handle__ = elem.__handle__ || {};
            vElement.events.forEach((eventName) => {
                if (eventTemp[eventName]) {
                    return;
                }
                eventTemp[eventName] = function () {
                    const root = vElement.getRoot();
                    root?.dispatch('elem-change', vElement, eventName);
                };
                elem.addEventListener(eventName, eventTemp[eventName]);
            });
            for (const key in eventTemp) {
                if (!vElement.events.includes(key)) {
                    elem.removeEventListener(key, eventTemp[key]);
                    delete eventTemp[key];
                }
            }
            // 同步 attrs
            for (const key in vElement.attrs) {
                elem.setAttribute(key, vElement.attrs[key]);
            }
            // 同步 text
            if (vElement.text.trim()) {
                elem.innerHTML = vElement.text;
            }
            // 在 VirtualElement 上监听 children 修改，并同步到 HTMLElement 上
            vElement.children.forEach((vChild, index) => {
                const childElem = HTMLElementMap.get(vChild) || createElement(vChild);
                const pElem = elem.children[index];
                if (childElem.parentElement !== elem) {
                    childElem.remove();
                    if (!pElem) {
                        elem.appendChild(childElem);
                    }
                    else if (pElem !== childElem) {
                        elem.insertBefore(childElem, pElem);
                    }
                }
                else if (pElem !== childElem) {
                    elem.insertBefore(childElem, pElem);
                }
            });
            for (let i = vElement.children.length; i < elem.children.length; i++) {
                elem.children[i].remove();
            }
        });
    }
}
exports.InspectorElement = InspectorElement;
// 默认的处理方法
register('*', InspectorElement);
class UIBase extends InspectorElement {
    init(vElement, elem) {
        // input 数据变化的时候触发更新数据
        elem.addEventListener('change', () => {
            vElement.setAttribute('value', elem.value);
        });
        super.init(vElement, elem);
    }
}
register('ui-asset', UIBase);
register('ui-checkbox', UIBase);
register('ui-component', UIBase);
// register('ui-curve', UIBase);
register('ui-file', UIBase);
// register('ui-gradient', UIBase);
register('ui-input', UIBase);
register('ui-node', UIBase);
register('ui-num-input', UIBase);
register('ui-slider', UIBase);
register('ui-select', UIBase);
register('ui-textarea', UIBase);
register('ui-tab', UIBase);
class UIColor extends InspectorElement {
    init(vElement, elem) {
        // input 数据变化的时候触发更新数据
        elem.addEventListener('change', () => {
            vElement.setAttribute('value', JSON.stringify(elem.value));
        });
        super.init(vElement, elem);
    }
}
register('ui-color', UIColor);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvZXh0ZW5zaW9uL2luc3BlY3Rvci91aS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBRUgsWUFBWSxDQUFDOzs7QUFJYixNQUFNLGdCQUFnQixHQUFrQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2xFLE1BQU0sY0FBYyxHQUF5QyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBRTNFOzs7O0dBSUc7QUFDSCxTQUFnQixhQUFhLENBQUMsS0FBcUI7SUFDL0MsSUFBSSxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM3QyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1QsTUFBTSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUN0QztJQUNELE1BQU0sSUFBSSxHQUFHLE1BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsTUFBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUIsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQVJELHNDQVFDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQWdCLFFBQVEsQ0FBQyxJQUFZLEVBQUUsRUFBMkI7SUFDOUQsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFGRCw0QkFFQztBQUVELE1BQWEsZ0JBQWdCO0lBQ3pCOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxLQUFxQjtRQUN4QixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQyxjQUFjLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoQyxXQUFXO1FBQ1gsS0FB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LFFBQVEsQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDaEMsUUFBUSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUUzQixNQUFNLE9BQVEsU0FBUSxnQkFBZ0I7SUFDbEMsSUFBSSxDQUFDLFFBQXdCLEVBQUUsSUFBc0I7UUFDakQsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQ2pDLFFBQVEsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBQ0o7QUFDRCxRQUFRLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVSSDnu5HlrppcbiAqIFxuICog6Jma5ouf5YWD57Sg5Yiw5a6e6ZmF55qEIFVJIOWFg+e0oO+8jOmcgOimgeS4gOWxgue7keWumlxuICog5Zug5Li65q+P5LiA5LiqIFVJIOS4iu+8jOaVsOaNruaTjeS9nOWQjuWPkemAgeeahOS6i+S7tuOAgeaVsOaNruabtOaWsOaWueW8j+mDveWPr+iDveacieW3ruW8glxuICog6YCa55So5aSE55CG55uR5ZCsIGNoYW5nZe+8jGNvbmZpcm1cbiAqIOWmguaenOacieeJueauiuWkhOeQhu+8jOWPr+S7pee7p+aJvyBjbGFzcyDph43lhpnnm7jlhbPnmoTmlrnms5VcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmltcG9ydCB0eXBlIHsgVmlydHVhbEVsZW1lbnQgfSBmcm9tICcuLi9lbGVtZW50JztcblxuY29uc3QgZWxlbWVudEhhbmRsZU1hcDogTWFwPHN0cmluZywgSW5zcGVjdG9yRWxlbWVudD4gPSBuZXcgTWFwKCk7XG5jb25zdCBIVE1MRWxlbWVudE1hcDogV2Vha01hcDxWaXJ0dWFsRWxlbWVudCwgSFRNTEVsZW1lbnQ+ID0gbmV3IFdlYWtNYXAoKTtcblxuLyoqXG4gKiDliJvlu7rkuIDkuKogaHRtbCDlhYPntKBcbiAqIEBwYXJhbSB0YWcgXG4gKiBAcmV0dXJucyBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodkVsZW06IFZpcnR1YWxFbGVtZW50KSB7XG4gICAgbGV0IGhhbmRsZSA9IGVsZW1lbnRIYW5kbGVNYXAuZ2V0KHZFbGVtLnRhZyk7XG4gICAgaWYgKCFoYW5kbGUpIHtcbiAgICAgICAgaGFuZGxlID0gZWxlbWVudEhhbmRsZU1hcC5nZXQoJyonKTtcbiAgICB9XG4gICAgY29uc3QgZWxlbSA9IGhhbmRsZSEuY3JlYXRlKHZFbGVtKTtcbiAgICBoYW5kbGUhLmluaXQodkVsZW0sIGVsZW0pO1xuICAgIHJldHVybiBlbGVtO1xufVxuXG4vKipcbiAqIOazqOWGjOS4gOS4qiB1aSDlhYPntKDnmoTlpITnkIbmlrnms5VcbiAqIEBwYXJhbSBuYW1lIFxuICogQHBhcmFtIHVpIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZTogc3RyaW5nLCB1aTogdHlwZW9mIEluc3BlY3RvckVsZW1lbnQpIHtcbiAgICBlbGVtZW50SGFuZGxlTWFwLnNldChuYW1lLCBuZXcgdWkpO1xufVxuXG5leHBvcnQgY2xhc3MgSW5zcGVjdG9yRWxlbWVudCB7XG4gICAgLyoqXG4gICAgICog5Yib5bu66LWE5rqQXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgY3JlYXRlKHZFbGVtOiBWaXJ0dWFsRWxlbWVudCkge1xuICAgICAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh2RWxlbS50YWcpO1xuICAgICAgICBIVE1MRWxlbWVudE1hcC5zZXQodkVsZW0sIGVsZW0pO1xuXG4gICAgICAgIC8vIOWQjOatpSBhdHRyc1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB2RWxlbS5hdHRycykge1xuICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoa2V5LCB2RWxlbS5hdHRyc1trZXldKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWQjOatpSB0ZXh0XG4gICAgICAgIGlmICh2RWxlbS50ZXh0LnRyaW0oKSkge1xuICAgICAgICAgICAgZWxlbS5pbm5lckhUTUwgPSB2RWxlbS50ZXh0O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5ZCM5q2lIGV2ZW50c1xuICAgICAgICBjb25zdCBldmVudFRlbXA6IHsgW2tleTogc3RyaW5nXTogKCkgPT4gdm9pZCB9ID0gKGVsZW0gYXMgYW55KS5fX2hhbmRsZV9fID0gKGVsZW0gYXMgYW55KS5fX2hhbmRsZV9fIHx8IHt9O1xuICAgICAgICB2RWxlbS5ldmVudHMuZm9yRWFjaCgoZXZlbnROYW1lKSA9PiB7XG4gICAgICAgICAgICBldmVudFRlbXBbZXZlbnROYW1lXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvb3QgPSB2RWxlbS5nZXRSb290KCk7XG4gICAgICAgICAgICAgICAgcm9vdD8uZGlzcGF0Y2goJ2VsZW0tY2hhbmdlJywgdkVsZW0sIGV2ZW50TmFtZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZXZlbnRUZW1wW2V2ZW50TmFtZV0pO1xuICAgICAgICAgICAgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOWQjOatpSBjaGlsZHJlblxuICAgICAgICB2RWxlbS5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkRWxlbSA9IGNyZWF0ZUVsZW1lbnQoY2hpbGQpO1xuICAgICAgICAgICAgY29uc3QgcEVsZW0gPSBlbGVtLmNoaWxkcmVuW2luZGV4XTtcbiAgICAgICAgICAgIGlmICghcEVsZW0pIHtcbiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGNoaWxkRWxlbSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHBFbGVtICE9PSBjaGlsZEVsZW0pIHtcbiAgICAgICAgICAgICAgICBlbGVtLmluc2VydEJlZm9yZShjaGlsZEVsZW0sIHBFbGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGVsZW07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5Yid5aeL5YyW5YWD57Sg77yM5bm257uR5a6a5LiA5Lqb5LqL5Lu2XG4gICAgICogQHBhcmFtIGVsZW0gXG4gICAgICogQHBhcmFtIHZFbGVtZW50IFxuICAgICAqL1xuICAgIGluaXQodkVsZW1lbnQ6IFZpcnR1YWxFbGVtZW50LCBlbGVtOiBIVE1MRWxlbWVudCkge1xuICAgICAgICB0aGlzLmJpbmQodkVsZW1lbnQsIGVsZW0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOe7keWumuWFg+e0oOWPmOWMlueahOS6i+S7tlxuICAgICAqIOmaj+aXtuWHhuWkh+WQjOatpeaVsOaNrlxuICAgICAqL1xuICAgIGJpbmQodkVsZW1lbnQ6IFZpcnR1YWxFbGVtZW50LCBlbGVtOiBIVE1MRWxlbWVudCkge1xuICAgICAgICB2RWxlbWVudC5zZXRDaGFuZ2VDYWxsYmFjaygoKSA9PiB7XG4gICAgICAgICAgICAvLyDlkIzmraUgZXZlbnRzXG4gICAgICAgICAgICBjb25zdCBldmVudFRlbXA6IHsgW2tleTogc3RyaW5nXTogKCkgPT4gdm9pZCB9ID0gKGVsZW0gYXMgYW55KS5fX2hhbmRsZV9fID0gKGVsZW0gYXMgYW55KS5fX2hhbmRsZV9fIHx8IHt9O1xuICAgICAgICAgICAgdkVsZW1lbnQuZXZlbnRzLmZvckVhY2goKGV2ZW50TmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudFRlbXBbZXZlbnROYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGV2ZW50VGVtcFtldmVudE5hbWVdID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvb3QgPSB2RWxlbWVudC5nZXRSb290KCk7XG4gICAgICAgICAgICAgICAgICAgIHJvb3Q/LmRpc3BhdGNoKCdlbGVtLWNoYW5nZScsIHZFbGVtZW50LCBldmVudE5hbWUpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZXZlbnRUZW1wW2V2ZW50TmFtZV0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBldmVudFRlbXApIHtcbiAgICAgICAgICAgICAgICBpZiAoIXZFbGVtZW50LmV2ZW50cy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcihrZXksIGV2ZW50VGVtcFtrZXldKTtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50VGVtcFtrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8g5ZCM5q2lIGF0dHJzXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB2RWxlbWVudC5hdHRycykge1xuICAgICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKGtleSwgdkVsZW1lbnQuYXR0cnNba2V5XSk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICAvLyDlkIzmraUgdGV4dFxuICAgICAgICAgICAgaWYgKHZFbGVtZW50LnRleHQudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgZWxlbS5pbm5lckhUTUwgPSB2RWxlbWVudC50ZXh0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDlnKggVmlydHVhbEVsZW1lbnQg5LiK55uR5ZCsIGNoaWxkcmVuIOS/ruaUue+8jOW5tuWQjOatpeWIsCBIVE1MRWxlbWVudCDkuIpcbiAgICAgICAgICAgIHZFbGVtZW50LmNoaWxkcmVuLmZvckVhY2goKHZDaGlsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZEVsZW0gPSBIVE1MRWxlbWVudE1hcC5nZXQodkNoaWxkKSB8fCBjcmVhdGVFbGVtZW50KHZDaGlsZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcEVsZW0gPSBlbGVtLmNoaWxkcmVuW2luZGV4XTtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGRFbGVtLnBhcmVudEVsZW1lbnQgIT09IGVsZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRFbGVtLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXBFbGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGNoaWxkRWxlbSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocEVsZW0gIT09IGNoaWxkRWxlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5pbnNlcnRCZWZvcmUoY2hpbGRFbGVtLCBwRWxlbSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBFbGVtICE9PSBjaGlsZEVsZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgZWxlbS5pbnNlcnRCZWZvcmUoY2hpbGRFbGVtLCBwRWxlbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdkVsZW1lbnQuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgZWxlbS5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGVsZW0uY2hpbGRyZW5baV0ucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbi8vIOm7mOiupOeahOWkhOeQhuaWueazlVxucmVnaXN0ZXIoJyonLCBJbnNwZWN0b3JFbGVtZW50KTtcblxuY2xhc3MgVUlCYXNlIGV4dGVuZHMgSW5zcGVjdG9yRWxlbWVudCB7XG4gICAgaW5pdCh2RWxlbWVudDogVmlydHVhbEVsZW1lbnQsIGVsZW06IEhUTUxJbnB1dEVsZW1lbnQpIHtcbiAgICAgICAgLy8gaW5wdXQg5pWw5o2u5Y+Y5YyW55qE5pe25YCZ6Kem5Y+R5pu05paw5pWw5o2uXG4gICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgdkVsZW1lbnQuc2V0QXR0cmlidXRlKCd2YWx1ZScsIGVsZW0udmFsdWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgc3VwZXIuaW5pdCh2RWxlbWVudCwgZWxlbSk7XG4gICAgfVxufVxucmVnaXN0ZXIoJ3VpLWFzc2V0JywgVUlCYXNlKTtcbnJlZ2lzdGVyKCd1aS1jaGVja2JveCcsIFVJQmFzZSk7XG5yZWdpc3RlcigndWktY29tcG9uZW50JywgVUlCYXNlKTtcbi8vIHJlZ2lzdGVyKCd1aS1jdXJ2ZScsIFVJQmFzZSk7XG5yZWdpc3RlcigndWktZmlsZScsIFVJQmFzZSk7XG4vLyByZWdpc3RlcigndWktZ3JhZGllbnQnLCBVSUJhc2UpO1xucmVnaXN0ZXIoJ3VpLWlucHV0JywgVUlCYXNlKTtcbnJlZ2lzdGVyKCd1aS1ub2RlJywgVUlCYXNlKTtcbnJlZ2lzdGVyKCd1aS1udW0taW5wdXQnLCBVSUJhc2UpO1xucmVnaXN0ZXIoJ3VpLXNsaWRlcicsIFVJQmFzZSk7XG5yZWdpc3RlcigndWktc2VsZWN0JywgVUlCYXNlKTtcbnJlZ2lzdGVyKCd1aS10ZXh0YXJlYScsIFVJQmFzZSk7XG5yZWdpc3RlcigndWktdGFiJywgVUlCYXNlKTtcblxuY2xhc3MgVUlDb2xvciBleHRlbmRzIEluc3BlY3RvckVsZW1lbnQge1xuICAgIGluaXQodkVsZW1lbnQ6IFZpcnR1YWxFbGVtZW50LCBlbGVtOiBIVE1MSW5wdXRFbGVtZW50KSB7XG4gICAgICAgIC8vIGlucHV0IOaVsOaNruWPmOWMlueahOaXtuWAmeinpuWPkeabtOaWsOaVsOaNrlxuICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpID0+IHtcbiAgICAgICAgICAgIHZFbGVtZW50LnNldEF0dHJpYnV0ZSgndmFsdWUnLCBKU09OLnN0cmluZ2lmeShlbGVtLnZhbHVlKSk7XG4gICAgICAgIH0pO1xuICAgICAgICBzdXBlci5pbml0KHZFbGVtZW50LCBlbGVtKTtcbiAgICB9XG59XG5yZWdpc3RlcigndWktY29sb3InLCBVSUNvbG9yKTtcbiJdfQ==