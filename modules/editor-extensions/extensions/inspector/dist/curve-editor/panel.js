'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.ready = exports.listeners = exports.methods = exports.$ = exports.template = exports.style = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const curve_control_1 = __importDefault(require("./curve-control"));
const grid_1 = __importDefault(require("./grid"));
const { drawHermite, DEFAULT_KEYFRAMES } = require('./utils');
const Vue = require('vue/dist/vue.js');
Vue.config.productionTip = false;
Vue.config.devtools = false;
let panel = null;
let vm = null;
const AXIS_MARGIN = 40; // 坐标轴距离画布的距离
const vueTemplate = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../../static', '/template/curve-editor.html'), 'utf8');
const InspectorCurveEditorVM = Vue.extend({
    name: 'InspectorCurveEditorVM',
    data() {
        return {
            scale: 1,
            showPresets: false,
            showMulti: false,
            grid: null,
            curveControl: null,
            currentPoint: null,
            mainCtx: null,
            gridCtx: null,
            ctrlCxt: null,
            dump: {
                key: '',
                name: '',
                keyFrames: DEFAULT_KEYFRAMES[0],
                negative: false,
                radian: false,
                multiplier: 1,
            },
            // 坐标设置相关信息
            axis: {
                piece: 10,
                rangeX: 1,
                rangeY: 1, // y 轴数据范围（最大值）
            },
            ctrlConfig: {
                // 控制点的相关配置
                fillColor: 'red',
                strokeStyle: 'white',
                radius: 2,
                lineWidth: 1,
                handlerSize: 40,
                focusColor: 'rgba(245, 240, 32, 0.44)', // 曲线选中高亮颜色
            },
            curveConfig: {
                strokeStyle: 'red',
                lineWidth: 0.1, // 线宽
            },
            // 工具栏显示的默认参数（固定）
            defaultKeyFrames: DEFAULT_KEYFRAMES,
            toolCanvas: [],
            isReady: false,
            toolCanvasSize: {
                w: 30,
                h: 30,
            },
        };
    },
    computed: {
        multiplier() {
            if (!this.dump.multiplier) {
                return 1;
            }
            if (this.dump.radian) {
                return Number(((this.dump.multiplier * 180) / Math.PI).toFixed(2));
            }
            return this.dump.multiplier;
        },
    },
    async mounted() {
        this.init();
    },
    methods: {
        T(key) {
            return Editor.I18n.t(key);
        },
        updateToolCanvasSize() {
            if (!this.mainCtx) {
                return;
            }
            this.toolCanvasSize = { w: this.mainCtx.canvas.width / 10, h: this.mainCtx.canvas.height / 5 };
        },
        // 重新绘制
        rePaint() {
            this.initCanvas();
            this.curveControl.rePaint();
            this.drawThumb(this.$refs.tools, this.defaultKeyFrames);
        },
        init() {
            if (!panel.clientWidth || !panel.clientHeight) {
                return;
            }
            this.initCanvas();
            this.drawGrid();
            this.drawCurve();
            this.isReady = true;
        },
        onMulti(event) {
            let value = event.target.value;
            if (event.target.value !== 0) {
                this.grid.multiplier = value;
                if (this.dump.radian) {
                    value = (value / 180) * Math.PI;
                }
                this.dump.multiplier = value;
                Editor.Message.send('inspector', 'curve-change', this.dump);
            }
        },
        /**
         * 响应 tools 点击事件
         * @param event
         */
        onTools(event) {
            const index = event.target.getAttribute('index');
            if (!index) {
                return;
            }
            this.dump.keyFrames = this.defaultKeyFrames[index];
            this.curveControl.update(this.dump.keyFrames, this.dump.negative);
            Editor.Message.send('inspector', 'curve-change', this.dump);
        },
        /**
         * 显示预设
         */
        onShowPresets(event) {
            this.showPresets = true;
            // TODO
            const { offsetX, offsetY } = event.target;
            // 小缩略图的尺寸
            this.drawThumb(this.$refs.presets, this.defaultKeyFrames);
        },
        /**
         * 检查与初始化数据
         * @param dump
         */
        checkAndUpdate(dump) {
            if (!dump) {
                return;
            }
            if (!Array.isArray(dump.value.keyFrames) || dump.value.keyFrames.length < 1) {
                !dump && (dump = {});
                dump.keyFrames = DEFAULT_KEYFRAMES[0];
            }
            this.dump = dump.value;
            this.dump.key = dump.key;
            this.dump.name = dump.name;
            this.dump.negative = dump.negative;
            this.dump.radian = dump.radian;
            if (typeof dump.multiplier !== 'number') {
                this.dump.multiplier = 1;
            }
            else {
                this.dump.multiplier = dump.multiplier;
                this.showMulti = true;
            }
            this.grid.multiplier = this.multiplier;
            this.curveControl.update(this.dump.keyFrames, dump.negative);
            this.drawThumb(this.$refs.tools, this.defaultKeyFrames);
        },
        /**
         * 绘制缩略图
         * @param father 父节点
         * @param keyFrames 关键帧数据
         * @param size canvas 尺寸
         */
        drawThumb(father, keyFrames) {
            keyFrames.map((item, index) => {
                let $canvas;
                // @ts-ignore
                if (this.toolCanvas.length !== keyFrames.length) {
                    $canvas = document.createElement('canvas');
                    $canvas.setAttribute('index', String(index));
                    father.append($canvas);
                    // @ts-ignore
                    this.toolCanvas.push($canvas);
                }
                else {
                    // @ts-ignore
                    $canvas = this.toolCanvas[index];
                }
                // @ts-ignore
                this.resizeCanvas([$canvas], this.toolCanvasSize);
                const ctx = $canvas.getContext('2d');
                ctx.strokeStyle = 'white';
                // @ts-ignore
                drawHermite(item, ctx, this.dump.negative);
            });
        },
        /**
         * 初始化画布设置
         */
        initCanvas() {
            const gridCanvas = this.$refs.gridCanvas;
            const mainCanvas = this.$refs.mainCanvas;
            const controlCanvas = this.$refs.controlCanvas;
            if (!gridCanvas || !mainCanvas || !controlCanvas) {
                return;
            }
            // 绘制网格背景的 canvas 对象
            this.gridCtx = gridCanvas.getContext('2d');
            // 获取绘图点信息
            this.mainCtx = mainCanvas.getContext('2d');
            this.ctrlCxt = controlCanvas.getContext('2d');
            // 更新画布的宽高
            this.resizeCanvas([this.gridCtx.canvas, this.mainCtx.canvas, this.ctrlCxt.canvas], {
                w: panel.clientWidth,
                h: panel.clientHeight * 0.8 - 40,
            });
            this.updateToolCanvasSize();
        },
        // 重新调节 canvas 的宽高
        resizeCanvas(canvasArr, size) {
            for (const $canvas of canvasArr) {
                $canvas.width = size.w;
                $canvas.height = size.h;
            }
        },
        /**
         * 绘制曲线
         */
        drawCurve() {
            this.curveControl = new curve_control_1.default({
                context: this.ctrlCxt,
                mainCtx: this.mainCtx,
                grid: this.grid,
                ctrlConfig: this.ctrlConfig,
                curveConfig: this.curveConfig,
            });
            this.curveControl.on('change', (data) => {
                this.dump.keyFrames = data.keyFrames;
                Editor.Message.send('inspector', 'curve-change', this.dump);
            });
        },
        /**
         * 更新循环模式
         * @param event
         */
        onWrapMode(event) {
            const target = event.target;
            const name = target.getAttribute('name');
            if (!name) {
                return;
            }
            this.dump[name] = parseInt(target.value);
            Editor.Message.send('inspector', 'curve-change', this.dump);
        },
        /**
         * 绘制网格画布
         */
        drawGrid() {
            const options = {
                context: this.gridCtx,
                axisMargin: AXIS_MARGIN,
                lineWidth: 1,
                axis: this.axis,
                multiplier: this.multiplier,
            };
            this.grid = new grid_1.default(options);
            this.grid.draw();
        },
        // 滚动滚轮，更改缩放参数
        onMouseWheel(event) {
            event.stopPropagation();
            const { wheelDelta } = event;
            const scale = (this.scale / 100) * Math.pow(2, 0.002 * wheelDelta);
            this.scale = Math.ceil(scale * 100);
        },
    },
    template: vueTemplate,
});
exports.style = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../index.css'), 'utf8');
exports.template = '<div class="container"></div>';
exports.$ = {
    container: '.container',
};
exports.methods = {
    currentKeys(dump) {
        if (!vm) {
            return;
        }
        if (!vm.isReady) {
            vm.init();
        }
        if (vm.isReady) {
            vm.checkAndUpdate(dump);
            localStorage.setItem('curve-dump', dump);
        }
    },
};
exports.listeners = {
    resize() {
        if (vm) {
            if (!vm.isReady) {
                vm.init();
            }
            if (vm.isReady) {
                vm.rePaint();
            }
        }
    },
    show() {
        if (vm && !vm.isReady) {
            vm.init();
        }
    },
};
function ready(cacheDump) {
    // @ts-ignore
    panel = this;
    vm?.$destroy();
    vm = new InspectorCurveEditorVM();
    vm.$mount(panel.$.container);
    Editor.Message.send('inspector', 'curve-state', true);
    const data = localStorage.getItem('curve-dump');
    if (data && cacheDump) {
        cacheDump.name += '(disconnect)';
        vm.checkAndUpdate(cacheDump);
    }
}
exports.ready = ready;
function close() {
    Editor.Message.send('inspector', 'curve-state', false);
    vm?.$destroy();
    vm = null;
    panel = null;
}
exports.close = close;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvY3VydmUtZWRpdG9yL3BhbmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7Ozs7O0FBRWIsMkJBQWtDO0FBQ2xDLCtCQUE0QjtBQUM1QixvRUFBMkM7QUFDM0Msa0RBQTBCO0FBRTFCLE1BQU0sRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFHOUQsTUFBTSxHQUFHLEdBQW1CLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3ZELEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztBQUNqQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7QUFFNUIsSUFBSSxLQUFLLEdBQVEsSUFBSSxDQUFDO0FBQ3RCLElBQUksRUFBRSxHQUFRLElBQUksQ0FBQztBQUVuQixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO0FBRXJDLE1BQU0sV0FBVyxHQUFHLElBQUEsaUJBQVksRUFBQyxJQUFBLFdBQUksRUFBQyxTQUFTLEVBQUUsY0FBYyxFQUFFLDZCQUE2QixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFekcsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO0lBQ3RDLElBQUksRUFBRSx3QkFBd0I7SUFDOUIsSUFBSTtRQUNBLE9BQU87WUFDSCxLQUFLLEVBQUUsQ0FBQztZQUNSLFdBQVcsRUFBRSxLQUFLO1lBQ2xCLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLElBQUksRUFBRSxJQUFXO1lBQ2pCLFlBQVksRUFBRSxJQUFXO1lBQ3pCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLE9BQU8sRUFBRSxJQUFXO1lBQ3BCLE9BQU8sRUFBRSxJQUFXO1lBQ3BCLE9BQU8sRUFBRSxJQUFXO1lBQ3BCLElBQUksRUFBRTtnQkFD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RCxNQUFNLElBQUksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ2hELElBQUksSUFBSSxJQUFJLFNBQVMsRUFBRTtRQUNuQixTQUFTLENBQUMsSUFBSSxJQUFJLGNBQWMsQ0FBQztRQUNqQyxFQUFFLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ2hDO0FBQ0wsQ0FBQztBQWZELHNCQWVDO0FBRUQsU0FBZ0IsS0FBSztJQUNqQixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3ZELEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQztJQUNmLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDVixLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLENBQUM7QUFMRCxzQkFLQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IEN1cnZlQ29udHJvbCBmcm9tICcuL2N1cnZlLWNvbnRyb2wnO1xuaW1wb3J0IEdyaWQgZnJvbSAnLi9ncmlkJztcblxuY29uc3QgeyBkcmF3SGVybWl0ZSwgREVGQVVMVF9LRVlGUkFNRVMgfSA9IHJlcXVpcmUoJy4vdXRpbHMnKTtcblxuaW1wb3J0IHR5cGUgeyBWdWVDb25zdHJ1Y3RvciB9IGZyb20gJ3Z1ZSc7XG5jb25zdCBWdWU6IFZ1ZUNvbnN0cnVjdG9yID0gcmVxdWlyZSgndnVlL2Rpc3QvdnVlLmpzJyk7XG5WdWUuY29uZmlnLnByb2R1Y3Rpb25UaXAgPSBmYWxzZTtcblZ1ZS5jb25maWcuZGV2dG9vbHMgPSBmYWxzZTtcblxubGV0IHBhbmVsOiBhbnkgPSBudWxsO1xubGV0IHZtOiBhbnkgPSBudWxsO1xuXG5jb25zdCBBWElTX01BUkdJTiA9IDQwOyAvLyDlnZDmoIfovbTot53nprvnlLvluIPnmoTot53nprtcblxuY29uc3QgdnVlVGVtcGxhdGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWMnLCAnL3RlbXBsYXRlL2N1cnZlLWVkaXRvci5odG1sJyksICd1dGY4Jyk7XG5cbmNvbnN0IEluc3BlY3RvckN1cnZlRWRpdG9yVk0gPSBWdWUuZXh0ZW5kKHtcbiAgICBuYW1lOiAnSW5zcGVjdG9yQ3VydmVFZGl0b3JWTScsXG4gICAgZGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHNjYWxlOiAxLFxuICAgICAgICAgICAgc2hvd1ByZXNldHM6IGZhbHNlLFxuICAgICAgICAgICAgc2hvd011bHRpOiBmYWxzZSxcbiAgICAgICAgICAgIGdyaWQ6IG51bGwgYXMgYW55LFxuICAgICAgICAgICAgY3VydmVDb250cm9sOiBudWxsIGFzIGFueSxcbiAgICAgICAgICAgIGN1cnJlbnRQb2ludDogbnVsbCxcbiAgICAgICAgICAgIG1haW5DdHg6IG51bGwgYXMgYW55LCAvLyDnlLvnrJRcbiAgICAgICAgICAgIGdyaWRDdHg6IG51bGwgYXMgYW55LCAvLyDnlLvnrJRcbiAgICAgICAgICAgIGN0cmxDeHQ6IG51bGwgYXMgYW55LCAvLyDnlLvnrJRcbiAgICAgICAgICAgIGR1bXA6IHtcbiAgICAgICAgICAgICAgICBrZXk6ICcnLFxuICAgICAgICAgICAgICAgIG5hbWU6ICcnLFxuICAgICAgICAgICAgICAgIGtleUZyYW1lczogREVGQVVMVF9LRVlGUkFNRVNbMF0sXG4gICAgICAgICAgICAgICAgbmVnYXRpdmU6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJhZGlhbjogZmFsc2UsXG4gICAgICAgICAgICAgICAgbXVsdGlwbGllcjogMSxcbiAgICAgICAgICAgIH0gYXMgUmVjb3JkPHN0cmluZywgYW55PixcbiAgICAgICAgICAgIC8vIOWdkOagh+iuvue9ruebuOWFs+S/oeaBr1xuICAgICAgICAgICAgYXhpczoge1xuICAgICAgICAgICAgICAgIHBpZWNlOiAxMCwgLy8g5qiq57q15Z2Q5qCH55qE5Yi75bqm5YiH5YiG5pWwXG4gICAgICAgICAgICAgICAgcmFuZ2VYOiAxLCAvLyB4IOi9tOaVsOaNruiMg+WbtO+8iOacgOWkp+WAvO+8iVxuICAgICAgICAgICAgICAgIHJhbmdlWTogMSwgLy8geSDovbTmlbDmja7ojIPlm7TvvIjmnIDlpKflgLzvvIlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjdHJsQ29uZmlnOiB7XG4gICAgICAgICAgICAvLyDmjqfliLbngrnnmoTnm7jlhbPphY3nva5cbiAgICAgICAgICAgICAgICBmaWxsQ29sb3I6ICdyZWQnLCAvLyDmjqfliLbngrnlnIblv4PloavlhYXpopzoibJcbiAgICAgICAgICAgICAgICBzdHJva2VTdHlsZTogJ3doaXRlJywgLy8g5o6n5Yi25p+E55qE6aKc6ImyXG4gICAgICAgICAgICAgICAgcmFkaXVzOiAyLCAvLyDmjqfliLbngrnlnIblv4PljYrlvoRcbiAgICAgICAgICAgICAgICBsaW5lV2lkdGg6IDEsIC8vIOaJi+afhOe6v+WuvVxuICAgICAgICAgICAgICAgIGhhbmRsZXJTaXplOiA0MCwgLy8g5o6n5Yi25p+E55qE5YOP57Sg6ZW/5bqmXG4gICAgICAgICAgICAgICAgZm9jdXNDb2xvcjogJ3JnYmEoMjQ1LCAyNDAsIDMyLCAwLjQ0KScsIC8vIOabsue6v+mAieS4remrmOS6ruminOiJslxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGN1cnZlQ29uZmlnOiB7XG4gICAgICAgICAgICAgICAgc3Ryb2tlU3R5bGU6ICdyZWQnLFxuICAgICAgICAgICAgICAgIGxpbmVXaWR0aDogMC4xLCAvLyDnur/lrr1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyDlt6XlhbfmoI/mmL7npLrnmoTpu5jorqTlj4LmlbDvvIjlm7rlrprvvIlcbiAgICAgICAgICAgIGRlZmF1bHRLZXlGcmFtZXM6IERFRkFVTFRfS0VZRlJBTUVTLFxuICAgICAgICAgICAgdG9vbENhbnZhczogW10sIC8vIOe8k+WtmOe7mOWItuWcqOW6lemDqOiPnOWNlemhueeahOmihOWItiBjYW52YXNcbiAgICAgICAgICAgIGlzUmVhZHk6IGZhbHNlLFxuICAgICAgICAgICAgdG9vbENhbnZhc1NpemU6IHtcbiAgICAgICAgICAgICAgICB3OiAzMCxcbiAgICAgICAgICAgICAgICBoOiAzMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgfSxcbiAgICBjb21wdXRlZDoge1xuICAgICAgICBtdWx0aXBsaWVyKCk6IG51bWJlciB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZHVtcC5tdWx0aXBsaWVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5kdW1wLnJhZGlhbikge1xuICAgICAgICAgICAgICAgIHJldHVybiBOdW1iZXIoKCh0aGlzLmR1bXAubXVsdGlwbGllciAqIDE4MCkgLyBNYXRoLlBJKS50b0ZpeGVkKDIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmR1bXAubXVsdGlwbGllcjtcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIGFzeW5jIG1vdW50ZWQoKSB7XG4gICAgICAgIHRoaXMuaW5pdCgpO1xuICAgIH0sXG4gICAgbWV0aG9kczoge1xuICAgICAgICBUKGtleTogc3RyaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gRWRpdG9yLkkxOG4udChrZXkpO1xuICAgICAgICB9LFxuICAgICAgICB1cGRhdGVUb29sQ2FudmFzU2l6ZSgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5tYWluQ3R4KXtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnRvb2xDYW52YXNTaXplID0geyB3OiB0aGlzLm1haW5DdHguY2FudmFzLndpZHRoIC8gMTAsIGg6IHRoaXMubWFpbkN0eC5jYW52YXMuaGVpZ2h0IC8gNSB9O1xuICAgICAgICB9LFxuICAgICAgICAvLyDph43mlrDnu5jliLZcbiAgICAgICAgcmVQYWludCgpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdENhbnZhcygpO1xuICAgICAgICAgICAgdGhpcy5jdXJ2ZUNvbnRyb2wucmVQYWludCgpO1xuICAgICAgICAgICAgdGhpcy5kcmF3VGh1bWIodGhpcy4kcmVmcy50b29scywgdGhpcy5kZWZhdWx0S2V5RnJhbWVzKTtcbiAgICAgICAgfSxcbiAgICAgICAgaW5pdCgpIHtcbiAgICAgICAgICAgIGlmICghcGFuZWwuY2xpZW50V2lkdGggfHwgIXBhbmVsLmNsaWVudEhlaWdodCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuaW5pdENhbnZhcygpO1xuICAgICAgICAgICAgdGhpcy5kcmF3R3JpZCgpO1xuICAgICAgICAgICAgdGhpcy5kcmF3Q3VydmUoKTtcbiAgICAgICAgICAgIHRoaXMuaXNSZWFkeSA9IHRydWU7XG4gICAgICAgIH0sXG4gICAgICAgIG9uTXVsdGkoZXZlbnQ6IGFueSkge1xuICAgICAgICAgICAgbGV0IHZhbHVlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC52YWx1ZSAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZ3JpZC5tdWx0aXBsaWVyID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZHVtcC5yYWRpYW4pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAodmFsdWUgLyAxODApICogTWF0aC5QSTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5kdW1wLm11bHRpcGxpZXIgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKCdpbnNwZWN0b3InLCAnY3VydmUtY2hhbmdlJywgdGhpcy5kdW1wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWTjeW6lCB0b29scyDngrnlh7vkuovku7ZcbiAgICAgICAgICogQHBhcmFtIGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBvblRvb2xzKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnaW5kZXgnKTtcbiAgICAgICAgICAgIGlmICghaW5kZXgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmR1bXAua2V5RnJhbWVzID0gdGhpcy5kZWZhdWx0S2V5RnJhbWVzW2luZGV4XTtcbiAgICAgICAgICAgIHRoaXMuY3VydmVDb250cm9sLnVwZGF0ZSh0aGlzLmR1bXAua2V5RnJhbWVzLCB0aGlzLmR1bXAubmVnYXRpdmUpO1xuICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnaW5zcGVjdG9yJywgJ2N1cnZlLWNoYW5nZScsIHRoaXMuZHVtcCk7XG4gICAgICAgIH0sXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmmL7npLrpooTorr5cbiAgICAgICAgICovXG4gICAgICAgIG9uU2hvd1ByZXNldHMoZXZlbnQ6IGFueSkge1xuICAgICAgICAgICAgdGhpcy5zaG93UHJlc2V0cyA9IHRydWU7XG4gICAgICAgICAgICAvLyBUT0RPXG4gICAgICAgICAgICBjb25zdCB7IG9mZnNldFgsIG9mZnNldFkgfSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgIC8vIOWwj+e8qeeVpeWbvueahOWwuuWvuFxuICAgICAgICAgICAgdGhpcy5kcmF3VGh1bWIodGhpcy4kcmVmcy5wcmVzZXRzLCB0aGlzLmRlZmF1bHRLZXlGcmFtZXMpO1xuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog5qOA5p+l5LiO5Yid5aeL5YyW5pWw5o2uXG4gICAgICAgICAqIEBwYXJhbSBkdW1wXG4gICAgICAgICAqL1xuICAgICAgICBjaGVja0FuZFVwZGF0ZShkdW1wOiBhbnkpIHtcbiAgICAgICAgICAgIGlmICghZHVtcCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkdW1wLnZhbHVlLmtleUZyYW1lcykgfHwgZHVtcC52YWx1ZS5rZXlGcmFtZXMubGVuZ3RoIDwgMSkge1xuICAgICAgICAgICAgICAgICFkdW1wICYmIChkdW1wID0ge30pO1xuICAgICAgICAgICAgICAgIGR1bXAua2V5RnJhbWVzID0gREVGQVVMVF9LRVlGUkFNRVNbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmR1bXAgPSBkdW1wLnZhbHVlO1xuICAgICAgICAgICAgdGhpcy5kdW1wLmtleSA9IGR1bXAua2V5O1xuICAgICAgICAgICAgdGhpcy5kdW1wLm5hbWUgPSBkdW1wLm5hbWU7XG4gICAgICAgICAgICB0aGlzLmR1bXAubmVnYXRpdmUgPSBkdW1wLm5lZ2F0aXZlO1xuICAgICAgICAgICAgdGhpcy5kdW1wLnJhZGlhbiA9IGR1bXAucmFkaWFuO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBkdW1wLm11bHRpcGxpZXIgIT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kdW1wLm11bHRpcGxpZXIgPSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmR1bXAubXVsdGlwbGllciA9IGR1bXAubXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dNdWx0aSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmdyaWQubXVsdGlwbGllciA9IHRoaXMubXVsdGlwbGllcjtcbiAgICAgICAgICAgIHRoaXMuY3VydmVDb250cm9sLnVwZGF0ZSh0aGlzLmR1bXAua2V5RnJhbWVzLCBkdW1wLm5lZ2F0aXZlKTtcbiAgICAgICAgICAgIHRoaXMuZHJhd1RodW1iKHRoaXMuJHJlZnMudG9vbHMsIHRoaXMuZGVmYXVsdEtleUZyYW1lcyk7XG4gICAgICAgIH0sXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDnu5jliLbnvKnnlaXlm75cbiAgICAgICAgICogQHBhcmFtIGZhdGhlciDniLboioLngrlcbiAgICAgICAgICogQHBhcmFtIGtleUZyYW1lcyDlhbPplK7luKfmlbDmja5cbiAgICAgICAgICogQHBhcmFtIHNpemUgY2FudmFzIOWwuuWvuFxuICAgICAgICAgKi9cbiAgICAgICAgZHJhd1RodW1iKGZhdGhlcjogYW55LCBrZXlGcmFtZXM6IGFueSkge1xuICAgICAgICAgICAga2V5RnJhbWVzLm1hcCgoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0ICRjYW52YXM7XG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnRvb2xDYW52YXMubGVuZ3RoICE9PSBrZXlGcmFtZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICRjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgICAgICAgICAgICAgJGNhbnZhcy5zZXRBdHRyaWJ1dGUoJ2luZGV4JywgU3RyaW5nKGluZGV4KSk7XG4gICAgICAgICAgICAgICAgICAgIGZhdGhlci5hcHBlbmQoJGNhbnZhcyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b29sQ2FudmFzLnB1c2goJGNhbnZhcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAkY2FudmFzID0gdGhpcy50b29sQ2FudmFzW2luZGV4XTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNpemVDYW52YXMoWyRjYW52YXNdLCB0aGlzLnRvb2xDYW52YXNTaXplKTtcbiAgICAgICAgICAgICAgICBjb25zdCBjdHg6IGFueSA9ICRjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnd2hpdGUnO1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBkcmF3SGVybWl0ZShpdGVtLCBjdHgsIHRoaXMuZHVtcC5uZWdhdGl2ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWIneWni+WMlueUu+W4g+iuvue9rlxuICAgICAgICAgKi9cbiAgICAgICAgaW5pdENhbnZhcygpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyaWRDYW52YXMgPSB0aGlzLiRyZWZzLmdyaWRDYW52YXMgYXMgYW55O1xuICAgICAgICAgICAgY29uc3QgbWFpbkNhbnZhcyA9IHRoaXMuJHJlZnMubWFpbkNhbnZhcyBhcyBhbnk7XG4gICAgICAgICAgICBjb25zdCBjb250cm9sQ2FudmFzID0gdGhpcy4kcmVmcy5jb250cm9sQ2FudmFzIGFzIGFueTtcbiAgICAgICAgICAgIGlmICghZ3JpZENhbnZhcyB8fCAhbWFpbkNhbnZhcyB8fCAhY29udHJvbENhbnZhcyl7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyDnu5jliLbnvZHmoLzog4zmma/nmoQgY2FudmFzIOWvueixoVxuICAgICAgICAgICAgdGhpcy5ncmlkQ3R4ID0gZ3JpZENhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgICAgICAgICAgLy8g6I635Y+W57uY5Zu+54K55L+h5oGvXG4gICAgICAgICAgICB0aGlzLm1haW5DdHggPSBtYWluQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgICAgICB0aGlzLmN0cmxDeHQgPSBjb250cm9sQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgICAgICAvLyDmm7TmlrDnlLvluIPnmoTlrr3pq5hcbiAgICAgICAgICAgIHRoaXMucmVzaXplQ2FudmFzKFt0aGlzLmdyaWRDdHguY2FudmFzLCB0aGlzLm1haW5DdHguY2FudmFzLCB0aGlzLmN0cmxDeHQuY2FudmFzXSwge1xuICAgICAgICAgICAgICAgIHc6IHBhbmVsLmNsaWVudFdpZHRoLFxuICAgICAgICAgICAgICAgIGg6IHBhbmVsLmNsaWVudEhlaWdodCAqIDAuOCAtIDQwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVRvb2xDYW52YXNTaXplKCk7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIOmHjeaWsOiwg+iKgiBjYW52YXMg55qE5a696auYXG4gICAgICAgIHJlc2l6ZUNhbnZhcyhjYW52YXNBcnI6IGFueVtdLCBzaXplOiBhbnkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgJGNhbnZhcyBvZiBjYW52YXNBcnIpIHtcbiAgICAgICAgICAgICAgICAkY2FudmFzLndpZHRoID0gc2l6ZS53O1xuICAgICAgICAgICAgICAgICRjYW52YXMuaGVpZ2h0ID0gc2l6ZS5oO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog57uY5Yi25puy57q/XG4gICAgICAgICAqL1xuICAgICAgICBkcmF3Q3VydmUoKSB7XG4gICAgICAgICAgICB0aGlzLmN1cnZlQ29udHJvbCA9IG5ldyBDdXJ2ZUNvbnRyb2woe1xuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMuY3RybEN4dCxcbiAgICAgICAgICAgICAgICBtYWluQ3R4OiB0aGlzLm1haW5DdHgsXG4gICAgICAgICAgICAgICAgZ3JpZDogdGhpcy5ncmlkLFxuICAgICAgICAgICAgICAgIGN0cmxDb25maWc6IHRoaXMuY3RybENvbmZpZyxcbiAgICAgICAgICAgICAgICBjdXJ2ZUNvbmZpZzogdGhpcy5jdXJ2ZUNvbmZpZyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5jdXJ2ZUNvbnRyb2wub24oJ2NoYW5nZScsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmR1bXAua2V5RnJhbWVzID0gZGF0YS5rZXlGcmFtZXM7XG4gICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnaW5zcGVjdG9yJywgJ2N1cnZlLWNoYW5nZScsIHRoaXMuZHVtcCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOabtOaWsOW+queOr+aooeW8j1xuICAgICAgICAgKiBAcGFyYW0gZXZlbnQgXG4gICAgICAgICAqL1xuICAgICAgICBvbldyYXBNb2RlKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQgYXMgRWRpdG9yLlVJLkhUTUxDdXN0b21FbGVtZW50O1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ25hbWUnKSBhcyBhbnk7XG4gICAgICAgICAgICBpZiAoIW5hbWUpe1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZHVtcFtuYW1lXSA9IHBhcnNlSW50KHRhcmdldC52YWx1ZSk7XG4gICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKCdpbnNwZWN0b3InLCAnY3VydmUtY2hhbmdlJywgdGhpcy5kdW1wKTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOe7mOWItue9keagvOeUu+W4g1xuICAgICAgICAgKi9cbiAgICAgICAgZHJhd0dyaWQoKSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMuZ3JpZEN0eCxcbiAgICAgICAgICAgICAgICBheGlzTWFyZ2luOiBBWElTX01BUkdJTixcbiAgICAgICAgICAgICAgICBsaW5lV2lkdGg6IDEsXG4gICAgICAgICAgICAgICAgYXhpczogdGhpcy5heGlzLFxuICAgICAgICAgICAgICAgIG11bHRpcGxpZXI6IHRoaXMubXVsdGlwbGllcixcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmdyaWQgPSBuZXcgR3JpZChvcHRpb25zKTtcbiAgICAgICAgICAgIHRoaXMuZ3JpZC5kcmF3KCk7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIOa7muWKqOa7mui9ru+8jOabtOaUuee8qeaUvuWPguaVsFxuICAgICAgICBvbk1vdXNlV2hlZWwoZXZlbnQ6IGFueSkge1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBjb25zdCB7IHdoZWVsRGVsdGEgfSA9IGV2ZW50O1xuICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAodGhpcy5zY2FsZSAvIDEwMCkgKiBNYXRoLnBvdygyLCAwLjAwMiAqIHdoZWVsRGVsdGEpO1xuXG4gICAgICAgICAgICB0aGlzLnNjYWxlID0gTWF0aC5jZWlsKHNjYWxlICogMTAwKTtcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIHRlbXBsYXRlOiB2dWVUZW1wbGF0ZSxcbn0pO1xuXG5leHBvcnQgY29uc3Qgc3R5bGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi9pbmRleC5jc3MnKSwgJ3V0ZjgnKTtcblxuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gJzxkaXYgY2xhc3M9XCJjb250YWluZXJcIj48L2Rpdj4nO1xuXG5leHBvcnQgY29uc3QgJCA9IHtcbiAgICBjb250YWluZXI6ICcuY29udGFpbmVyJyxcbn07XG5cbmV4cG9ydCBjb25zdCBtZXRob2RzID0ge1xuICAgIGN1cnJlbnRLZXlzKGR1bXA6IGFueSkge1xuICAgICAgICBpZiAoIXZtKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF2bS5pc1JlYWR5KSB7XG4gICAgICAgICAgICB2bS5pbml0KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZtLmlzUmVhZHkpIHtcbiAgICAgICAgICAgIHZtLmNoZWNrQW5kVXBkYXRlKGR1bXApO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2N1cnZlLWR1bXAnLCBkdW1wKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgbGlzdGVuZXJzID0ge1xuICAgIHJlc2l6ZSgpIHtcbiAgICAgICAgaWYgKHZtKSB7XG4gICAgICAgICAgICBpZiAoIXZtLmlzUmVhZHkpIHtcbiAgICAgICAgICAgICAgICB2bS5pbml0KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh2bS5pc1JlYWR5KSB7XG4gICAgICAgICAgICAgICAgdm0ucmVQYWludCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICBzaG93KCkge1xuICAgICAgICBpZiAodm0gJiYgIXZtLmlzUmVhZHkpIHtcbiAgICAgICAgICAgIHZtLmluaXQoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gcmVhZHkoY2FjaGVEdW1wOiBhbnkpIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcGFuZWwgPSB0aGlzO1xuXG4gICAgdm0/LiRkZXN0cm95KCk7XG4gICAgdm0gPSBuZXcgSW5zcGVjdG9yQ3VydmVFZGl0b3JWTSgpO1xuICAgIHZtLiRtb3VudChwYW5lbC4kLmNvbnRhaW5lcik7XG5cbiAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKCdpbnNwZWN0b3InLCAnY3VydmUtc3RhdGUnLCB0cnVlKTtcblxuICAgIGNvbnN0IGRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY3VydmUtZHVtcCcpO1xuICAgIGlmIChkYXRhICYmIGNhY2hlRHVtcCkge1xuICAgICAgICBjYWNoZUR1bXAubmFtZSArPSAnKGRpc2Nvbm5lY3QpJztcbiAgICAgICAgdm0uY2hlY2tBbmRVcGRhdGUoY2FjaGVEdW1wKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbG9zZSgpIHtcbiAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKCdpbnNwZWN0b3InLCAnY3VydmUtc3RhdGUnLCBmYWxzZSk7XG4gICAgdm0/LiRkZXN0cm95KCk7XG4gICAgdm0gPSBudWxsO1xuICAgIHBhbmVsID0gbnVsbDtcbn1cbiJdfQ==