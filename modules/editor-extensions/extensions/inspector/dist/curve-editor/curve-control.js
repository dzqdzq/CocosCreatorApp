"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),hermite_1=__importDefault(require("./hermite")),PIXEL_RANGE=20,UINT8_COLOR_DEFAULT=Array(4*PIXEL_RANGE*PIXEL_RANGE).fill(0).toString(),DEFAULT_CTRL_COLOR="rgba(255, 0, 0, 0.1)",CLICK_RANGE=5,{Point:Point}=require("./utils"),mouseDownPoint={startX:0,startY:0};class CurveControl extends events_1.EventEmitter{constructor(t){super(),this.changeType="",this.isShowCtrl=!1,this.isShowPoint=!1,this.isShowAuxin=!1,this.isBindHandle=!1,this.negative=!1,this.flags={flag:!1,tanDrag:!1,curveDrag:!1,keyDrag:!1},this.grid=t.grid,this.ctrlConfig=t.ctrlConfig,this.cxt2D=t.context,this.canvas=t.context.canvas,this.hermite=new hermite_1.default({context:t.mainCtx,ctrlConfig:t.ctrlConfig,grid:t.grid,curveConfig:t.curveConfig,range:t.range});const{top:i,left:e}=this.canvas.getBoundingClientRect();this.position={top:i,left:e}}get ctrlKey(){return this.hermite.ctrlKey}rePaint(){this.clear(),this.grid.rePaint(),this.hermite.rePaint(),this.initControl()}update(t,i){this.negative=i,this.hermite.negative=i,this.grid.negative=i,this.clear(),this.hermite.clear();for(const i of t)i.inTangent="number"==typeof i.inTangent?i.inTangent:Number.POSITIVE_INFINITY,i.outTangent="number"==typeof i.outTangent?i.outTangent:Number.POSITIVE_INFINITY;this.draw(t)}draw(t){this.cxt2D.strokeStyle=DEFAULT_CTRL_COLOR,this.hermite.draw(t),this.hermite.update(this.cxt2D),this.initControl()}initControl(){const{radius:t,fillColor:i,strokeStyle:e}=this.ctrlConfig;this.cxt2D.fillStyle=i,this.cxt2D.strokeStyle=e;for(const i of this.ctrlKey){const e=this.grid.axisToCanvas(i.point);this.cxt2D.beginPath(),this.cxt2D.arc(e.x,e.y,t,0,2*Math.PI),this.cxt2D.closePath(),this.cxt2D.stroke(),this.cxt2D.fill()}!this.isBindHandle&&this.bindHandler()}resetCtrl(t){(this.isShowCtrl||this.isShowAuxin)&&(this.isShowAuxin=!1,this.isShowCtrl=!1,this.cxt2D.clearRect(0,0,this.canvas.width,this.canvas.height),this.cxt2D.strokeStyle=DEFAULT_CTRL_COLOR,this.hermite.update(this.cxt2D),this.initControl(),t&&(this.ctrlPoints=null))}bindHandler(){this.isBindHandle=!0,this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t))}onMouseDown(t){this.flags.flag=!1;const{radius:i}=this.ctrlConfig,{offsetX:e,offsetY:s}=t,r=this.cxt2D.getImageData(e-PIXEL_RANGE/2,s-PIXEL_RANGE/2,PIXEL_RANGE,PIXEL_RANGE);mouseDownPoint.startX=t.x,mouseDownPoint.startY=t.y;for(const r of this.ctrlKey){const{x:n,y:h}=r.point.canvas;if(Math.abs(e-n)<2*CLICK_RANGE+i&&Math.abs(s-h)<2*CLICK_RANGE+i){if(2===t.button){const i=this;return void Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:[{label:"Delete Key",click(){i.delKeyFrame(r.index)}}]})}return this.flags.flag=!0,this.flags.keyDrag=!0,this.canvas.style.cursor="move",this.showCtrl(r),void this.showPoint(this.hermite.keyFrames[r.index],r.point.canvas)}}if(this.isShowCtrl&&this.ctrlPoints)for(const t of Object.keys(this.ctrlPoints)){const r=this.ctrlPoints[t];if(!r.canvas||"point"===t)continue;const{x:n,y:h}=r.canvas;if(Math.abs(e-n)<CLICK_RANGE+i&&Math.abs(s-h)<CLICK_RANGE+i)return this.flags.tanDrag=!0,this.flags.flag=!0,void(this.ctrlPoints.type=t)}if(r.data.toString()!==UINT8_COLOR_DEFAULT)if(this.flags.flag=!0,2===t.button){const i=this;Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:[{label:"Add Key",click(){i.addKeyFrame(e)}}]})}else this.lightCurve(),this.canvas.style.cursor="ns-resize",!this.flags.tanDrag&&!this.flags.keyDrag&&(this.flags.curveDrag=!0);this.flags.flag||this.resetCtrl("hideCtrl")}onMouseMove(t){const{curveDrag:i,tanDrag:e,keyDrag:s}=this.flags;if(!e&&!i&&!s)return;const{offsetX:r,offsetY:n,movementY:h,x:a,y:o}=t;if(!(Math.abs(a-mouseDownPoint.startX)<.5||Math.abs(o-mouseDownPoint.startY)<.5)){if(e)return this.changeType="tangent",this.updateTan(r,n),void this.emitChange();if(s)return this.moveKey(r,n),void this.emitChange();if(i&&0!==h){if(!this.hermite.moveY(-h))return;this.changeType="curve",this.emitChange(),this.hermite.clear(),this.hermite.update(),this.resetCtrl(),this.lightCurve()}}}onMouseUp(t){this.flags.tanDrag=!1,this.flags.curveDrag=!1,this.flags.keyDrag=!1,this.isShowPoint=!1,this.canvas.style.cursor="default",this.changeType&&(this.emitChange(),this.emitConfirm(),this.changeType="")}moveKey(t,i){t-=this.position.left,this.changeType="keyframe";const e=this.hermite.moveKey(t,i,this.ctrlPoints.index);this.ctrlPoints.index=e,this.refreshRender()}delKeyFrame(t){this.hermite.delKeyFrame(t),this.ctrlPoints=null,this.refreshRender(),this.clear(),this.initControl()}addKeyFrame(t){const i=this.hermite.addKeyFrame(t);if(null===i)return void console.warn("添加点无效",t);this.emitChange(),this.emitConfirm();const e=this.ctrlKey[i];this.initControl(),this.drawCtrl(e)}updateTan(t,i){const{index:e,type:s}=this.ctrlPoints,{point:r,isBroken:n}=this.ctrlKey[e];let h=0;(h=Math.abs(t-r.canvas.x)-10<0?Number.POSITIVE_INFINITY:-(i-r.canvas.y)/(t-r.canvas.x))!==Number.NEGATIVE_INFINITY&&h!==Number.POSITIVE_INFINITY&&(n?this.hermite.updateTan(e,h,s):(this.hermite.updateTan(e,h,"inTangent"),this.hermite.updateTan(e,h,"outTangent")),this.refreshRender(),this.drawCtrl(this.ctrlKey[e]))}refreshRender(){if(this.hermite.clear(),this.hermite.update(),this.resetCtrl(),this.lightCurve(),this.ctrlPoints){const{index:t}=this.ctrlPoints;this.ctrlPoints=this.ctrlKey[t],this.drawCtrl(this.ctrlPoints),this.isShowPoint&&this.showPoint(this.hermite.keyFrames[t],this.ctrlPoints.point.canvas)}}clear(){const{x:t,y:i,w:e,h:s}=this.grid.location;this.cxt2D.clearRect(0,0,e+2*t,s+2*i)}lightCurve(){const{focusColor:t}=this.ctrlConfig;this.cxt2D.strokeStyle=t,this.hermite.update(this.cxt2D),this.isShowAuxin=!0}showCtrl(t){this.ctrlPoints&&this.ctrlPoints.index===t.index||(this.ctrlPoints&&(this.resetCtrl(),this.lightCurve()),this.drawCtrl(t))}showPoint(t,i){if(!t)return;this.isShowPoint=!0;const{x:e,y:s}=i;this.cxt2D.save(),this.cxt2D.fillStyle="black",this.cxt2D.fillRect(e-30,s-28,50,18),this.cxt2D.fillStyle="white",this.cxt2D.fillText(`${t.time},${t.value}`,e-25,s-15),this.cxt2D.restore()}drawCtrl(t,i=this.cxt2D){this.isShowCtrl=!0,this.ctrlPoints=t;const{point:e,inPoint:s,outPoint:r}=t,{radius:n,fillColor:h}=this.ctrlConfig;i.save(),i.fillColor=h,i.strokeStyle="white",s&&(s.type="outTangent",this.drawLine(e.canvas,s.canvas),this.drawArc(s.canvas,n),this.ctrlPoints.inPoint=s),r&&(r.type="inTangent",this.drawLine(e.canvas,r.canvas),this.drawArc(r.canvas,n),this.ctrlPoints.outPoint=r),i.restore()}drawLine(t,i,e=this.cxt2D){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.closePath(),e.stroke()}drawArc(t,i,e=this.cxt2D){e.beginPath(),e.moveTo(t.x,t.y),e.arc(t.x,t.y,i,0,2*Math.PI),e.closePath(),e.stroke(),e.fill()}emitConfirm(){this.emit("confirm",{keyFrames:Array.from(this.hermite.keyFrames),multiplier:this.grid.multiplier})}emitChange(){this.emit("change",{keyFrames:Array.from(this.hermite.keyFrames),multiplier:this.grid.multiplier})}}exports.default=CurveControl;