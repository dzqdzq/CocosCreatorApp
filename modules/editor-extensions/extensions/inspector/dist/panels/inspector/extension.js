'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.end = exports.start = exports.queryDropConfig = exports.queryRendererMap = exports.queryType = exports.detach = exports.attach = void 0;
const path_1 = require("path");
let started = false;
const slots = ['header', 'section', 'footer'];
let inspectorConfig = {};
const pluginsGroup = {};
function typeInit(type, file) {
    inspectorConfig[type] = {
        panel: file ?? '',
        slot: {
            header: {},
            section: {},
            footer: {},
        },
        drop: {},
    };
}
function mergeConfig() {
    inspectorConfig = {};
    Object.values(pluginsGroup).forEach((pkg) => {
        const contribution = pkg.info.contributions.inspector;
        Object.entries(contribution.type ?? []).forEach(([type, file]) => {
            file = path_1.isAbsolute(file) ? file : path_1.join(pkg.path, file);
            // node require 支持的路径格式都要支持，不能直接判断路径是否存在至少要 resolve 路径一下，并且加密后后缀会变，在 require 的地方容错即可
            // if (existsSync(file)) {
            if (inspectorConfig[type]) {
                if (inspectorConfig[type]['panel']) {
                    console.warn(Editor.I18n.t('inspector.extension.overwritten', { oldPanel: inspectorConfig[type]['panel'], plugin: pkg.name, panel: file }));
                }
                inspectorConfig[type]['panel'] = file;
            }
            else {
                typeInit(type, file);
            }
            // } else {
            //     console.warn(Editor.I18n.t('inspector.extension.invalid', { file }));
            // }
        });
        slots.forEach((slot) => {
            const config = contribution[slot];
            if (!config) {
                return;
            }
            Object.entries(config).forEach(([type, renderMap]) => {
                Object.entries(renderMap).forEach(([name, renderFile]) => {
                    renderFile = path_1.isAbsolute(renderFile) ? renderFile : path_1.join(pkg.path, renderFile);
                    // node require 支持的路径格式都要支持，不能直接判断路径是否存在至少要 resolve 路径一下，并且加密后后缀会变，在 require 的地方容错即可
                    // if (existsSync(renderFile)) {
                    if (!inspectorConfig[type]) {
                        typeInit(type);
                    }
                    if (!Array.isArray(inspectorConfig[type]['slot'][slot][name])) {
                        inspectorConfig[type]['slot'][slot][name] = [renderFile];
                    }
                    else if (inspectorConfig[type]['slot'][slot][name].indexOf(renderFile) === -1) {
                        inspectorConfig[type]['slot'][slot][name].push(renderFile);
                    }
                    // } else {
                    //     console.warn(Editor.I18n.t('inspector.extension.invalid', { file: renderFile }));
                    // }
                });
            });
        });
        // 拖拽部分的配置
        if (contribution.drop) {
            Object.entries(contribution.drop).forEach(([type, dropItems]) => {
                if (Array.isArray(dropItems)) {
                    if (!inspectorConfig[type]) {
                        typeInit(type);
                    }
                    dropItems.forEach(dropItem => {
                        const { type: ccType, message } = dropItem;
                        inspectorConfig[type]['drop'][ccType] = {
                            package: pkg.name,
                            message,
                        };
                    });
                }
            });
        }
    });
}
function attach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (!pluginsGroup[pkg.name]) {
        pluginsGroup[pkg.name] = pkg;
        mergeConfig();
    }
}
exports.attach = attach;
function detach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (pluginsGroup[pkg.name]) {
        delete pluginsGroup[pkg.name];
        mergeConfig();
        deleteRequireCache(pkg);
    }
}
exports.detach = detach;
function queryType(type) {
    return type
        ? inspectorConfig[type]?.panel ?? ''
        : Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config?.panel ?? '';
            return result;
        }, {});
}
exports.queryType = queryType;
function queryRendererMap(type) {
    if (!type) {
        return Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config.slot;
            return result;
        }, {});
    }
    return inspectorConfig[type] ? inspectorConfig[type]['slot'] : {};
}
exports.queryRendererMap = queryRendererMap;
function queryDropConfig(type) {
    return inspectorConfig[type] && inspectorConfig[type]['drop'];
}
exports.queryDropConfig = queryDropConfig;
function start() {
    if (started) {
        return;
    }
    started = true;
    const list = Editor.Package.getPackages({ enable: true });
    list.forEach(attach);
    Editor.Package.on('enable', attach);
    Editor.Package.on('disable', detach);
}
exports.start = start;
function end() { }
exports.end = end;
function deleteRequireCache(pkg) {
    const contribution = pkg.info.contributions.inspector;
    slots.forEach((slot) => {
        const config = contribution[slot];
        if (!config) {
            return;
        }
        Object.entries(config).forEach(([_, renderMap]) => {
            Object.entries(renderMap).forEach(([_, renderFile]) => {
                renderFile = path_1.isAbsolute(renderFile) ? renderFile : path_1.join(pkg.path, renderFile);
                delete require.cache[renderFile];
            });
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL3BhbmVscy9pbnNwZWN0b3IvZXh0ZW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBR2IsK0JBQXdDO0FBR3hDLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNwQixNQUFNLEtBQUssR0FBZ0IsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBRTNELElBQUksZUFBZSxHQUFxQixFQUFFLENBQUM7QUFFM0MsTUFBTSxZQUFZLEdBQW9ELEVBQUUsQ0FBQztBQUV6RSxTQUFTLFFBQVEsQ0FBQyxJQUFZLEVBQUUsSUFBYTtJQUN6QyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUc7UUFDcEIsS0FBSyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ2pCLElBQUksRUFBRTtZQUNGLE1BQU0sRUFBRSxFQUFFO1lBQ1YsT0FBTyxFQUFFLEVBQUU7WUFDWCxNQUFNLEVBQUUsRUFBRTtTQUNiO1FBQ0QsSUFBSSxFQUFFLEVBQUU7S0FDWCxDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsV0FBVztJQUNoQixlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBaUMsRUFBRSxFQUFFO1FBQ3RFLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYyxDQUFDLFNBQTJCLENBQUM7UUFFekUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDN0QsSUFBSSxHQUFHLGlCQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsV0FB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QUFVLENBQUMsQ0FBQztZQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBleGlzdHNTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgam9pbiwgaXNBYnNvbHV0ZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgSUNvbnRyaWJ1dGlvbnMsIElJbnNwZWN0b3JSZW5kZXIsIElTbG90VHlwZSwgSVN1YkNvbmZpZywgSVR5cGVDYWNoZSwgSVNsb3RDb25maWcgfSBmcm9tICcuLi8uLi8uLi9AdHlwZXMvcHJpdmF0ZSc7XG5cbmxldCBzdGFydGVkID0gZmFsc2U7XG5jb25zdCBzbG90czogSVNsb3RUeXBlW10gPSBbJ2hlYWRlcicsICdzZWN0aW9uJywgJ2Zvb3RlciddO1xuXG5sZXQgaW5zcGVjdG9yQ29uZmlnOiBJSW5zcGVjdG9yUmVuZGVyID0ge307XG5cbmNvbnN0IHBsdWdpbnNHcm91cDogeyBba2V5OiBzdHJpbmddOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvIH0gPSB7fTtcblxuZnVuY3Rpb24gdHlwZUluaXQodHlwZTogc3RyaW5nLCBmaWxlPzogc3RyaW5nKSB7XG4gICAgaW5zcGVjdG9yQ29uZmlnW3R5cGVdID0ge1xuICAgICAgICBwYW5lbDogZmlsZSA/PyAnJyxcbiAgICAgICAgc2xvdDoge1xuICAgICAgICAgICAgaGVhZGVyOiB7fSxcbiAgICAgICAgICAgIHNlY3Rpb246IHt9LFxuICAgICAgICAgICAgZm9vdGVyOiB7fSxcbiAgICAgICAgfSxcbiAgICAgICAgZHJvcDoge30sXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gbWVyZ2VDb25maWcoKSB7XG4gICAgaW5zcGVjdG9yQ29uZmlnID0ge307XG4gICAgT2JqZWN0LnZhbHVlcyhwbHVnaW5zR3JvdXApLmZvckVhY2goKHBrZzogRWRpdG9yLkludGVyZmFjZS5QYWNrYWdlSW5mbykgPT4ge1xuICAgICAgICBjb25zdCBjb250cmlidXRpb24gPSBwa2cuaW5mby5jb250cmlidXRpb25zIS5pbnNwZWN0b3IgYXMgSUNvbnRyaWJ1dGlvbnM7XG5cbiAgICAgICAgT2JqZWN0LmVudHJpZXMoY29udHJpYnV0aW9uLnR5cGUgPz8gW10pLmZvckVhY2goKFt0eXBlLCBmaWxlXSkgPT4ge1xuICAgICAgICAgICAgZmlsZSA9IGlzQWJzb2x1dGUoZmlsZSkgPyBmaWxlIDogam9pbihwa2cucGF0aCwgZmlsZSk7XG4gICAgICAgICAgICAvLyBub2RlIHJlcXVpcmUg5pSv5oyB55qE6Lev5b6E5qC85byP6YO96KaB5pSv5oyB77yM5LiN6IO955u05o6l5Yik5pat6Lev5b6E5piv5ZCm5a2Y5Zyo6Iez5bCR6KaBIHJlc29sdmUg6Lev5b6E5LiA5LiL77yM5bm25LiU5Yqg5a+G5ZCO5ZCO57yA5Lya5Y+Y77yM5ZyoIHJlcXVpcmUg55qE5Zyw5pa55a656ZSZ5Y2z5Y+vXG4gICAgICAgICAgICAvLyBpZiAoZXhpc3RzU3luYyhmaWxlKSkge1xuICAgICAgICAgICAgaWYgKGluc3BlY3RvckNvbmZpZ1t0eXBlXSkge1xuICAgICAgICAgICAgICAgIGlmIChpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3BhbmVsJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKEVkaXRvci5JMThuLnQoJ2luc3BlY3Rvci5leHRlbnNpb24ub3ZlcndyaXR0ZW4nLCB7IG9sZFBhbmVsOiBpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3BhbmVsJ10sIHBsdWdpbjogcGtnLm5hbWUsIHBhbmVsOiBmaWxlIH0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydwYW5lbCddID0gZmlsZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdHlwZUluaXQodHlwZSwgZmlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUud2FybihFZGl0b3IuSTE4bi50KCdpbnNwZWN0b3IuZXh0ZW5zaW9uLmludmFsaWQnLCB7IGZpbGUgfSkpO1xuICAgICAgICAgICAgLy8gfVxuICAgICAgICB9KTtcblxuICAgICAgICBzbG90cy5mb3JFYWNoKChzbG90KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25maWc6IElTdWJDb25maWcgPSBjb250cmlidXRpb25bc2xvdF07XG4gICAgICAgICAgICBpZiAoIWNvbmZpZykgeyByZXR1cm47IH1cbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KGNvbmZpZykuZm9yRWFjaCgoW3R5cGUsIHJlbmRlck1hcF0pID0+IHtcbiAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZW5kZXJNYXApLmZvckVhY2goKFtuYW1lLCByZW5kZXJGaWxlXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZW5kZXJGaWxlID0gaXNBYnNvbHV0ZShyZW5kZXJGaWxlKSA/IHJlbmRlckZpbGUgOiBqb2luKHBrZy5wYXRoLCByZW5kZXJGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gbm9kZSByZXF1aXJlIOaUr+aMgeeahOi3r+W+hOagvOW8j+mDveimgeaUr+aMge+8jOS4jeiDveebtOaOpeWIpOaWrei3r+W+hOaYr+WQpuWtmOWcqOiHs+WwkeimgSByZXNvbHZlIOi3r+W+hOS4gOS4i++8jOW5tuS4lOWKoOWvhuWQjuWQjue8gOS8muWPmO+8jOWcqCByZXF1aXJlIOeahOWcsOaWueWuuemUmeWNs+WPr1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiAoZXhpc3RzU3luYyhyZW5kZXJGaWxlKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWluc3BlY3RvckNvbmZpZ1t0eXBlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUluaXQodHlwZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddW3Nsb3RdW25hbWVdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydzbG90J11bc2xvdF1bbmFtZV0gPSBbcmVuZGVyRmlsZV07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydzbG90J11bc2xvdF1bbmFtZV0uaW5kZXhPZihyZW5kZXJGaWxlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddW3Nsb3RdW25hbWVdLnB1c2gocmVuZGVyRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUud2FybihFZGl0b3IuSTE4bi50KCdpbnNwZWN0b3IuZXh0ZW5zaW9uLmludmFsaWQnLCB7IGZpbGU6IHJlbmRlckZpbGUgfSkpO1xuICAgICAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8g5ouW5ou96YOo5YiG55qE6YWN572uXG4gICAgICAgIGlmIChjb250cmlidXRpb24uZHJvcCkge1xuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoY29udHJpYnV0aW9uLmRyb3ApLmZvckVhY2goKFt0eXBlLCBkcm9wSXRlbXNdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZHJvcEl0ZW1zKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWluc3BlY3RvckNvbmZpZ1t0eXBlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUluaXQodHlwZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZHJvcEl0ZW1zLmZvckVhY2goZHJvcEl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyB0eXBlOiBjY1R5cGUsIG1lc3NhZ2UgfSA9IGRyb3BJdGVtO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydkcm9wJ11bY2NUeXBlXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlOiBwa2cubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoKHBrZzogRWRpdG9yLkludGVyZmFjZS5QYWNrYWdlSW5mbykge1xuICAgIGlmICghcGtnLmluZm8uY29udHJpYnV0aW9ucz8uaW5zcGVjdG9yKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXBsdWdpbnNHcm91cFtwa2cubmFtZV0pIHtcbiAgICAgICAgcGx1Z2luc0dyb3VwW3BrZy5uYW1lXSA9IHBrZztcbiAgICAgICAgbWVyZ2VDb25maWcoKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXRhY2gocGtnOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSB7XG4gICAgaWYgKCFwa2cuaW5mby5jb250cmlidXRpb25zPy5pbnNwZWN0b3IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocGx1Z2luc0dyb3VwW3BrZy5uYW1lXSkge1xuICAgICAgICBkZWxldGUgcGx1Z2luc0dyb3VwW3BrZy5uYW1lXTtcbiAgICAgICAgbWVyZ2VDb25maWcoKTtcbiAgICAgICAgZGVsZXRlUmVxdWlyZUNhY2hlKHBrZyk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlUeXBlKHR5cGU/OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdHlwZVxuICAgICAgICA/IGluc3BlY3RvckNvbmZpZ1t0eXBlXT8ucGFuZWwgPz8gJydcbiAgICAgICAgOiBPYmplY3QuZW50cmllcyhpbnNwZWN0b3JDb25maWcpLnJlZHVjZTxJVHlwZUNhY2hlPigocmVzdWx0LCBbdHlwZSwgY29uZmlnXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W3R5cGVdID0gY29uZmlnPy5wYW5lbCA/PyAnJztcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0sIHt9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5UmVuZGVyZXJNYXAodHlwZT86IHN0cmluZykge1xuICAgIGlmICghdHlwZSkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoaW5zcGVjdG9yQ29uZmlnKS5yZWR1Y2U8UmVjb3JkPHN0cmluZywgSVNsb3RDb25maWc+PigocmVzdWx0LCBbdHlwZSwgY29uZmlnXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W3R5cGVdID0gY29uZmlnLnNsb3Q7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9LCB7fSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3BlY3RvckNvbmZpZ1t0eXBlXSA/IGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddIDoge307XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeURyb3BDb25maWcodHlwZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGluc3BlY3RvckNvbmZpZ1t0eXBlXSAmJiBpbnNwZWN0b3JDb25maWdbdHlwZV1bJ2Ryb3AnXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0YXJ0KCkge1xuICAgIGlmIChzdGFydGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc3RhcnRlZCA9IHRydWU7XG4gICAgY29uc3QgbGlzdCA9IEVkaXRvci5QYWNrYWdlLmdldFBhY2thZ2VzKHsgZW5hYmxlOiB0cnVlIH0pO1xuICAgIGxpc3QuZm9yRWFjaChhdHRhY2gpO1xuXG4gICAgRWRpdG9yLlBhY2thZ2Uub24oJ2VuYWJsZScsIGF0dGFjaCk7XG4gICAgRWRpdG9yLlBhY2thZ2Uub24oJ2Rpc2FibGUnLCBkZXRhY2gpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5kKCkgeyB9XG5cbmZ1bmN0aW9uIGRlbGV0ZVJlcXVpcmVDYWNoZShwa2c6IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8pIHtcbiAgICBjb25zdCBjb250cmlidXRpb24gPSBwa2cuaW5mby5jb250cmlidXRpb25zIS5pbnNwZWN0b3IgYXMgSUNvbnRyaWJ1dGlvbnM7XG5cbiAgICBzbG90cy5mb3JFYWNoKChzbG90KSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZzogSVN1YkNvbmZpZyA9IGNvbnRyaWJ1dGlvbltzbG90XTtcbiAgICAgICAgaWYgKCFjb25maWcpIHsgcmV0dXJuOyB9XG4gICAgICAgIE9iamVjdC5lbnRyaWVzPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KGNvbmZpZykuZm9yRWFjaCgoW18sIHJlbmRlck1hcF0pID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlbmRlck1hcCkuZm9yRWFjaCgoW18sIHJlbmRlckZpbGVdKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVuZGVyRmlsZSA9IGlzQWJzb2x1dGUocmVuZGVyRmlsZSkgPyByZW5kZXJGaWxlIDogam9pbihwa2cucGF0aCwgcmVuZGVyRmlsZSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVuZGVyRmlsZV07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG4iXX0=