'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.end = exports.start = exports.queryDropConfig = exports.queryRendererMap = exports.queryType = exports.detach = exports.attach = void 0;
const path_1 = require("path");
let started = false;
const slots = ['header', 'section', 'footer'];
let inspectorConfig = {};
const pluginsGroup = {};
function typeInit(type, file) {
    inspectorConfig[type] = {
        panel: file ?? '',
        slot: {
            header: {},
            section: {},
            footer: {},
        },
        drop: {},
    };
}
function mergeConfig() {
    inspectorConfig = {};
    Object.values(pluginsGroup).forEach((pkg) => {
        const contribution = pkg.info.contributions.inspector;
        Object.entries(contribution.type ?? []).forEach(([type, file]) => {
            file = path_1.isAbsolute(file) ? file : path_1.join(pkg.path, file);
            // node require 支持的路径格式都要支持，不能直接判断路径是否存在至少要 resolve 路径一下，并且加密后后缀会变，在 require 的地方容错即可
            // if (existsSync(file)) {
            if (inspectorConfig[type]) {
                if (inspectorConfig[type]['panel']) {
                    console.warn(Editor.I18n.t('inspector.extension.overwritten', { oldPanel: inspectorConfig[type]['panel'], plugin: pkg.name, panel: file }));
                }
                inspectorConfig[type]['panel'] = file;
            }
            else {
                typeInit(type, file);
            }
            // } else {
            //     console.warn(Editor.I18n.t('inspector.extension.invalid', { file }));
            // }
        });
        slots.forEach((slot) => {
            const config = contribution[slot];
            if (!config) {
                return;
            }
            Object.entries(config).forEach(([type, renderMap]) => {
                Object.entries(renderMap).forEach(([name, renderFile]) => {
                    renderFile = path_1.isAbsolute(renderFile) ? renderFile : path_1.join(pkg.path, renderFile);
                    // node require 支持的路径格式都要支持，不能直接判断路径是否存在至少要 resolve 路径一下，并且加密后后缀会变，在 require 的地方容错即可
                    // if (existsSync(renderFile)) {
                    if (!inspectorConfig[type]) {
                        typeInit(type);
                    }
                    if (!Array.isArray(inspectorConfig[type]['slot'][slot][name])) {
                        inspectorConfig[type]['slot'][slot][name] = [renderFile];
                    }
                    else if (inspectorConfig[type]['slot'][slot][name].indexOf(renderFile) === -1) {
                        inspectorConfig[type]['slot'][slot][name].push(renderFile);
                    }
                    // } else {
                    //     console.warn(Editor.I18n.t('inspector.extension.invalid', { file: renderFile }));
                    // }
                });
            });
        });
        // 拖拽部分的配置
        if (contribution.drop) {
            Object.entries(contribution.drop).forEach(([type, dropItems]) => {
                if (Array.isArray(dropItems)) {
                    if (!inspectorConfig[type]) {
                        typeInit(type);
                    }
                    dropItems.forEach(dropItem => {
                        const { type: ccType, message } = dropItem;
                        inspectorConfig[type]['drop'][ccType] = {
                            package: pkg.name,
                            message,
                        };
                    });
                }
            });
        }
    });
}
function attach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (!pluginsGroup[pkg.name]) {
        pluginsGroup[pkg.name] = pkg;
        mergeConfig();
    }
}
exports.attach = attach;
function detach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (pluginsGroup[pkg.name]) {
        delete pluginsGroup[pkg.name];
        mergeConfig();
        deleteRequireCache(pkg);
    }
}
exports.detach = detach;
function queryType(type) {
    return type
        ? inspectorConfig[type]?.panel ?? ''
        : Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config?.panel ?? '';
            return result;
        }, {});
}
exports.queryType = queryType;
function queryRendererMap(type) {
    if (!type) {
        return Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config.slot;
            return result;
        }, {});
    }
    return inspectorConfig[type] ? inspectorConfig[type]['slot'] : {};
}
exports.queryRendererMap = queryRendererMap;
function queryDropConfig(type) {
    return inspectorConfig[type] && inspectorConfig[type]['drop'];
}
exports.queryDropConfig = queryDropConfig;
function start() {
    if (started) {
        return;
    }
    started = true;
    const list = Editor.Package.getPackages({ enable: true });
    list.forEach(attach);
    Editor.Package.__protected__.on('enable', attach);
    Editor.Package.__protected__.on('disable', detach);
}
exports.start = start;
function end() { }
exports.end = end;
function deleteRequireCache(pkg) {
    const contribution = pkg.info.contributions.inspector;
    slots.forEach((slot) => {
        const config = contribution[slot];
        if (!config) {
            return;
        }
        Object.entries(config).forEach(([_, renderMap]) => {
            Object.entries(renderMap).forEach(([_, renderFile]) => {
                renderFile = path_1.isAbsolute(renderFile) ? renderFile : path_1.join(pkg.path, renderFile);
                delete require.cache[renderFile];
            });
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL3BhbmVscy9pbnNwZWN0b3IvZXh0ZW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBR2IsK0JBQXdDO0FBR3hDLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNwQixNQUFNLEtBQUssR0FBZ0IsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBRTNELElBQUksZUFBZSxHQUFxQixFQUFFLENBQUM7QUFFM0MsTUFBTSxZQUFZLEdBQW9ELEVBQUUsQ0FBQztBQUV6RSxTQUFTLFFBQVEsQ0FBQyxJQUFZLEVBQUUsSUFBYTtJQUN6QyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUc7UUFDcEIsS0FBSyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ2pCLElBQUksRUFBRTtZQUNGLE1BQU0sRUFBRSxFQUFFO1lBQ1YsT0FBTyxFQUFFLEVBQUU7WUFDWCxNQUFNLEVBQUUsRUFBRTtTQUNiO1FBQ0QsSUFBSSxFQUFFLEVBQUU7S0FDWCxDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsV0FBVztJQUNoQixlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBaUMsRUFBRSxFQUFFO1FBQ3RFLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYyxDQUFDLFNBQTJCLENBQUM7UUFFekUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDN0QsSUFBSSxHQUFHLGlCQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsV0FB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QUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCBpc0Fic29sdXRlIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBJQ29udHJpYnV0aW9ucywgSUluc3BlY3RvclJlbmRlciwgSVNsb3RUeXBlLCBJU3ViQ29uZmlnLCBJVHlwZUNhY2hlLCBJU2xvdENvbmZpZyB9IGZyb20gJy4uLy4uLy4uL0B0eXBlcy9wcml2YXRlJztcblxubGV0IHN0YXJ0ZWQgPSBmYWxzZTtcbmNvbnN0IHNsb3RzOiBJU2xvdFR5cGVbXSA9IFsnaGVhZGVyJywgJ3NlY3Rpb24nLCAnZm9vdGVyJ107XG5cbmxldCBpbnNwZWN0b3JDb25maWc6IElJbnNwZWN0b3JSZW5kZXIgPSB7fTtcblxuY29uc3QgcGx1Z2luc0dyb3VwOiB7IFtrZXk6IHN0cmluZ106IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8gfSA9IHt9O1xuXG5mdW5jdGlvbiB0eXBlSW5pdCh0eXBlOiBzdHJpbmcsIGZpbGU/OiBzdHJpbmcpIHtcbiAgICBpbnNwZWN0b3JDb25maWdbdHlwZV0gPSB7XG4gICAgICAgIHBhbmVsOiBmaWxlID8/ICcnLFxuICAgICAgICBzbG90OiB7XG4gICAgICAgICAgICBoZWFkZXI6IHt9LFxuICAgICAgICAgICAgc2VjdGlvbjoge30sXG4gICAgICAgICAgICBmb290ZXI6IHt9LFxuICAgICAgICB9LFxuICAgICAgICBkcm9wOiB7fSxcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBtZXJnZUNvbmZpZygpIHtcbiAgICBpbnNwZWN0b3JDb25maWcgPSB7fTtcbiAgICBPYmplY3QudmFsdWVzKHBsdWdpbnNHcm91cCkuZm9yRWFjaCgocGtnOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRyaWJ1dGlvbiA9IHBrZy5pbmZvLmNvbnRyaWJ1dGlvbnMhLmluc3BlY3RvciBhcyBJQ29udHJpYnV0aW9ucztcblxuICAgICAgICBPYmplY3QuZW50cmllcyhjb250cmlidXRpb24udHlwZSA/PyBbXSkuZm9yRWFjaCgoW3R5cGUsIGZpbGVdKSA9PiB7XG4gICAgICAgICAgICBmaWxlID0gaXNBYnNvbHV0ZShmaWxlKSA/IGZpbGUgOiBqb2luKHBrZy5wYXRoLCBmaWxlKTtcbiAgICAgICAgICAgIC8vIG5vZGUgcmVxdWlyZSDmlK/mjIHnmoTot6/lvoTmoLzlvI/pg73opoHmlK/mjIHvvIzkuI3og73nm7TmjqXliKTmlq3ot6/lvoTmmK/lkKblrZjlnKjoh7PlsJHopoEgcmVzb2x2ZSDot6/lvoTkuIDkuIvvvIzlubbkuJTliqDlr4blkI7lkI7nvIDkvJrlj5jvvIzlnKggcmVxdWlyZSDnmoTlnLDmlrnlrrnplJnljbPlj69cbiAgICAgICAgICAgIC8vIGlmIChleGlzdHNTeW5jKGZpbGUpKSB7XG4gICAgICAgICAgICBpZiAoaW5zcGVjdG9yQ29uZmlnW3R5cGVdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluc3BlY3RvckNvbmZpZ1t0eXBlXVsncGFuZWwnXSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oRWRpdG9yLkkxOG4udCgnaW5zcGVjdG9yLmV4dGVuc2lvbi5vdmVyd3JpdHRlbicsIHsgb2xkUGFuZWw6IGluc3BlY3RvckNvbmZpZ1t0eXBlXVsncGFuZWwnXSwgcGx1Z2luOiBwa2cubmFtZSwgcGFuZWw6IGZpbGUgfSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3BhbmVsJ10gPSBmaWxlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0eXBlSW5pdCh0eXBlLCBmaWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyAgICAgY29uc29sZS53YXJuKEVkaXRvci5JMThuLnQoJ2luc3BlY3Rvci5leHRlbnNpb24uaW52YWxpZCcsIHsgZmlsZSB9KSk7XG4gICAgICAgICAgICAvLyB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNsb3RzLmZvckVhY2goKHNsb3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZzogSVN1YkNvbmZpZyA9IGNvbnRyaWJ1dGlvbltzbG90XTtcbiAgICAgICAgICAgIGlmICghY29uZmlnKSB7IHJldHVybjsgfVxuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXM8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4oY29uZmlnKS5mb3JFYWNoKChbdHlwZSwgcmVuZGVyTWFwXSkgPT4ge1xuICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlbmRlck1hcCkuZm9yRWFjaCgoW25hbWUsIHJlbmRlckZpbGVdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlbmRlckZpbGUgPSBpc0Fic29sdXRlKHJlbmRlckZpbGUpID8gcmVuZGVyRmlsZSA6IGpvaW4ocGtnLnBhdGgsIHJlbmRlckZpbGUpO1xuICAgICAgICAgICAgICAgICAgICAvLyBub2RlIHJlcXVpcmUg5pSv5oyB55qE6Lev5b6E5qC85byP6YO96KaB5pSv5oyB77yM5LiN6IO955u05o6l5Yik5pat6Lev5b6E5piv5ZCm5a2Y5Zyo6Iez5bCR6KaBIHJlc29sdmUg6Lev5b6E5LiA5LiL77yM5bm25LiU5Yqg5a+G5ZCO5ZCO57yA5Lya5Y+Y77yM5ZyoIHJlcXVpcmUg55qE5Zyw5pa55a656ZSZ5Y2z5Y+vXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIChleGlzdHNTeW5jKHJlbmRlckZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaW5zcGVjdG9yQ29uZmlnW3R5cGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlSW5pdCh0eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydzbG90J11bc2xvdF1bbmFtZV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3Nsb3QnXVtzbG90XVtuYW1lXSA9IFtyZW5kZXJGaWxlXTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3Nsb3QnXVtzbG90XVtuYW1lXS5pbmRleE9mKHJlbmRlckZpbGUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydzbG90J11bc2xvdF1bbmFtZV0ucHVzaChyZW5kZXJGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgY29uc29sZS53YXJuKEVkaXRvci5JMThuLnQoJ2luc3BlY3Rvci5leHRlbnNpb24uaW52YWxpZCcsIHsgZmlsZTogcmVuZGVyRmlsZSB9KSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyDmi5bmi73pg6jliIbnmoTphY3nva5cbiAgICAgICAgaWYgKGNvbnRyaWJ1dGlvbi5kcm9wKSB7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhjb250cmlidXRpb24uZHJvcCkuZm9yRWFjaCgoW3R5cGUsIGRyb3BJdGVtc10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkcm9wSXRlbXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaW5zcGVjdG9yQ29uZmlnW3R5cGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlSW5pdCh0eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBkcm9wSXRlbXMuZm9yRWFjaChkcm9wSXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHR5cGU6IGNjVHlwZSwgbWVzc2FnZSB9ID0gZHJvcEl0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNwZWN0b3JDb25maWdbdHlwZV1bJ2Ryb3AnXVtjY1R5cGVdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhY2thZ2U6IHBrZy5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2gocGtnOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSB7XG4gICAgaWYgKCFwa2cuaW5mby5jb250cmlidXRpb25zPy5pbnNwZWN0b3IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghcGx1Z2luc0dyb3VwW3BrZy5uYW1lXSkge1xuICAgICAgICBwbHVnaW5zR3JvdXBbcGtnLm5hbWVdID0gcGtnO1xuICAgICAgICBtZXJnZUNvbmZpZygpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRldGFjaChwa2c6IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8pIHtcbiAgICBpZiAoIXBrZy5pbmZvLmNvbnRyaWJ1dGlvbnM/Lmluc3BlY3Rvcikge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChwbHVnaW5zR3JvdXBbcGtnLm5hbWVdKSB7XG4gICAgICAgIGRlbGV0ZSBwbHVnaW5zR3JvdXBbcGtnLm5hbWVdO1xuICAgICAgICBtZXJnZUNvbmZpZygpO1xuICAgICAgICBkZWxldGVSZXF1aXJlQ2FjaGUocGtnKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeVR5cGUodHlwZT86IHN0cmluZykge1xuICAgIHJldHVybiB0eXBlXG4gICAgICAgID8gaW5zcGVjdG9yQ29uZmlnW3R5cGVdPy5wYW5lbCA/PyAnJ1xuICAgICAgICA6IE9iamVjdC5lbnRyaWVzKGluc3BlY3RvckNvbmZpZykucmVkdWNlPElUeXBlQ2FjaGU+KChyZXN1bHQsIFt0eXBlLCBjb25maWddKSA9PiB7XG4gICAgICAgICAgICByZXN1bHRbdHlwZV0gPSBjb25maWc/LnBhbmVsID8/ICcnO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSwge30pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlSZW5kZXJlck1hcCh0eXBlPzogc3RyaW5nKSB7XG4gICAgaWYgKCF0eXBlKSB7XG4gICAgICAgIHJldHVybiBPYmplY3QuZW50cmllcyhpbnNwZWN0b3JDb25maWcpLnJlZHVjZTxSZWNvcmQ8c3RyaW5nLCBJU2xvdENvbmZpZz4+KChyZXN1bHQsIFt0eXBlLCBjb25maWddKSA9PiB7XG4gICAgICAgICAgICByZXN1bHRbdHlwZV0gPSBjb25maWcuc2xvdDtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0sIHt9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW5zcGVjdG9yQ29uZmlnW3R5cGVdID8gaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydzbG90J10gOiB7fTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5RHJvcENvbmZpZyh0eXBlOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gaW5zcGVjdG9yQ29uZmlnW3R5cGVdICYmIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnZHJvcCddO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnQoKSB7XG4gICAgaWYgKHN0YXJ0ZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzdGFydGVkID0gdHJ1ZTtcbiAgICBjb25zdCBsaXN0ID0gRWRpdG9yLlBhY2thZ2UuZ2V0UGFja2FnZXMoeyBlbmFibGU6IHRydWUgfSk7XG4gICAgbGlzdC5mb3JFYWNoKGF0dGFjaCk7XG5cbiAgICBFZGl0b3IuUGFja2FnZS5fX3Byb3RlY3RlZF9fLm9uKCdlbmFibGUnLCBhdHRhY2gpO1xuICAgIEVkaXRvci5QYWNrYWdlLl9fcHJvdGVjdGVkX18ub24oJ2Rpc2FibGUnLCBkZXRhY2gpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5kKCkgeyB9XG5cbmZ1bmN0aW9uIGRlbGV0ZVJlcXVpcmVDYWNoZShwa2c6IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8pIHtcbiAgICBjb25zdCBjb250cmlidXRpb24gPSBwa2cuaW5mby5jb250cmlidXRpb25zIS5pbnNwZWN0b3IgYXMgSUNvbnRyaWJ1dGlvbnM7XG5cbiAgICBzbG90cy5mb3JFYWNoKChzbG90KSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZzogSVN1YkNvbmZpZyA9IGNvbnRyaWJ1dGlvbltzbG90XTtcbiAgICAgICAgaWYgKCFjb25maWcpIHsgcmV0dXJuOyB9XG4gICAgICAgIE9iamVjdC5lbnRyaWVzPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KGNvbmZpZykuZm9yRWFjaCgoW18sIHJlbmRlck1hcF0pID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlbmRlck1hcCkuZm9yRWFjaCgoW18sIHJlbmRlckZpbGVdKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVuZGVyRmlsZSA9IGlzQWJzb2x1dGUocmVuZGVyRmlsZSkgPyByZW5kZXJGaWxlIDogam9pbihwa2cucGF0aCwgcmVuZGVyRmlsZSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVuZGVyRmlsZV07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG4iXX0=