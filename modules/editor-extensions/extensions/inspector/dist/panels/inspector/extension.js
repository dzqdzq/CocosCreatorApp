'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.end = exports.start = exports.queryDropConfig = exports.queryRendererMap = exports.queryType = exports.detach = exports.attach = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
let started = false;
const slots = ['header', 'section', 'footer'];
let inspectorConfig = {};
const pluginsGroup = {};
function typeInit(type, file) {
    inspectorConfig[type] = {
        panel: file ?? '',
        slot: {
            header: {},
            section: {},
            footer: {},
        },
        drop: {},
    };
}
function mergeConfig() {
    inspectorConfig = {};
    Object.values(pluginsGroup).forEach((pkg) => {
        const contribution = pkg.info.contributions.inspector;
        Object.entries(contribution.type ?? []).forEach(([type, file]) => {
            file = path_1.isAbsolute(file) ? file : path_1.join(pkg.path, file);
            if (fs_extra_1.existsSync(file)) {
                if (inspectorConfig[type]) {
                    if (inspectorConfig[type]['panel']) {
                        console.warn(Editor.I18n.t('inspector.extension.overwritten', { oldPanel: inspectorConfig[type]['panel'], plugin: pkg.name, panel: file }));
                    }
                    inspectorConfig[type]['panel'] = file;
                }
                else {
                    typeInit(type, file);
                }
            }
            else {
                console.warn(Editor.I18n.t('inspector.extension.invalid', { file }));
            }
        });
        slots.forEach((slot) => {
            const config = contribution[slot];
            if (!config) {
                return;
            }
            Object.entries(config).forEach(([type, renderMap]) => {
                Object.entries(renderMap).forEach(([name, renderFile]) => {
                    renderFile = path_1.isAbsolute(renderFile) ? renderFile : path_1.join(pkg.path, renderFile);
                    if (fs_extra_1.existsSync(renderFile)) {
                        if (!inspectorConfig[type]) {
                            typeInit(type);
                        }
                        if (!Array.isArray(inspectorConfig[type]['slot'][slot][name])) {
                            inspectorConfig[type]['slot'][slot][name] = [renderFile];
                        }
                        else if (inspectorConfig[type]['slot'][slot][name].indexOf(renderFile) === -1) {
                            inspectorConfig[type]['slot'][slot][name].push(renderFile);
                        }
                    }
                    else {
                        console.warn(Editor.I18n.t('inspector.extension.invalid', { file: renderFile }));
                    }
                });
            });
        });
        // 拖拽部分的配置
        if (contribution.drop) {
            Object.entries(contribution.drop).forEach(([type, dropItems]) => {
                if (Array.isArray(dropItems)) {
                    if (!inspectorConfig[type]) {
                        typeInit(type);
                    }
                    dropItems.forEach(dropItem => {
                        const { type: ccType, message } = dropItem;
                        inspectorConfig[type]['drop'][ccType] = {
                            package: pkg.name,
                            message,
                        };
                    });
                }
            });
        }
    });
}
function attach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (!pluginsGroup[pkg.name]) {
        pluginsGroup[pkg.name] = pkg;
        mergeConfig();
    }
}
exports.attach = attach;
function detach(pkg) {
    if (!pkg.info.contributions?.inspector) {
        return;
    }
    if (pluginsGroup[pkg.name]) {
        delete pluginsGroup[pkg.name];
        mergeConfig();
    }
}
exports.detach = detach;
function queryType(type) {
    return type
        ? inspectorConfig[type]?.panel ?? ''
        : Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config?.panel ?? '';
            return result;
        }, {});
}
exports.queryType = queryType;
function queryRendererMap(type) {
    if (!type) {
        return Object.entries(inspectorConfig).reduce((result, [type, config]) => {
            result[type] = config.slot;
            return result;
        }, {});
    }
    return inspectorConfig[type] ? inspectorConfig[type]['slot'] : {};
}
exports.queryRendererMap = queryRendererMap;
function queryDropConfig(type) {
    return inspectorConfig[type]['drop'];
}
exports.queryDropConfig = queryDropConfig;
function start() {
    if (started) {
        return;
    }
    started = true;
    const list = Editor.Package.getPackages({ enable: true });
    list.forEach(attach);
    Editor.Package.on('enable', attach);
    Editor.Package.on('disable', detach);
}
exports.start = start;
function end() { }
exports.end = end;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL3BhbmVscy9pbnNwZWN0b3IvZXh0ZW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsdUNBQXNDO0FBQ3RDLCtCQUF3QztBQUd4QyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDcEIsTUFBTSxLQUFLLEdBQWdCLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUUzRCxJQUFJLGVBQWUsR0FBcUIsRUFBRSxDQUFDO0FBRTNDLE1BQU0sWUFBWSxHQUFvRCxFQUFFLENBQUM7QUFFekUsU0FBUyxRQUFRLENBQUMsSUFBWSxFQUFFLElBQWE7SUFDekMsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHO1FBQ3BCLEtBQUssRUFBRSxJQUFJLElBQUksRUFBRTtRQUNqQixJQUFJLEVBQUU7WUFDRixNQUFNLEVBQUUsRUFBRTtZQUNWLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDYjtRQUNELElBQUksRUFBRSxFQUFFO0tBQ1gsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLFdBQVc7SUFDaEIsZUFBZSxHQUFHLEVBQUUsQ0FBQztJQUNyQixNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQWlDLEVBQUUsRUFBRTtRQUN0RSxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWMsQ0FBQyxTQUEyQixDQUFDO1FBRXpFLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQzdELElBQUksR0FBRyxpQkFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMs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QVRELDRDQVNDO0FBRUQsU0FBZ0IsZUFBZSxDQUFDLElBQVk7SUFDeEMsT0FBTyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDekMsQ0FBQztBQUZELDBDQUVDO0FBRUQsU0FBZ0IsS0FBSztJQUNqQixJQUFJLE9BQU8sRUFBRTtRQUNULE9BQU87S0FDVjtJQUNELE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDZixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzFELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFckIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBVkQsc0JBVUM7QUFFRCxTQUFnQixHQUFHLEtBQUssQ0FBQztBQUF6QixrQkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGV4aXN0c1N5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCBpc0Fic29sdXRlIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBJQ29udHJpYnV0aW9ucywgSUluc3BlY3RvclJlbmRlciwgSVNsb3RUeXBlLCBJU3ViQ29uZmlnLCBJVHlwZUNhY2hlLCBJU2xvdENvbmZpZyB9IGZyb20gJy4uLy4uLy4uL0B0eXBlcy9wcml2YXRlJztcblxubGV0IHN0YXJ0ZWQgPSBmYWxzZTtcbmNvbnN0IHNsb3RzOiBJU2xvdFR5cGVbXSA9IFsnaGVhZGVyJywgJ3NlY3Rpb24nLCAnZm9vdGVyJ107XG5cbmxldCBpbnNwZWN0b3JDb25maWc6IElJbnNwZWN0b3JSZW5kZXIgPSB7fTtcblxuY29uc3QgcGx1Z2luc0dyb3VwOiB7IFtrZXk6IHN0cmluZ106IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8gfSA9IHt9O1xuXG5mdW5jdGlvbiB0eXBlSW5pdCh0eXBlOiBzdHJpbmcsIGZpbGU/OiBzdHJpbmcpIHtcbiAgICBpbnNwZWN0b3JDb25maWdbdHlwZV0gPSB7XG4gICAgICAgIHBhbmVsOiBmaWxlID8/ICcnLFxuICAgICAgICBzbG90OiB7XG4gICAgICAgICAgICBoZWFkZXI6IHt9LFxuICAgICAgICAgICAgc2VjdGlvbjoge30sXG4gICAgICAgICAgICBmb290ZXI6IHt9LFxuICAgICAgICB9LFxuICAgICAgICBkcm9wOiB7fSxcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBtZXJnZUNvbmZpZygpIHtcbiAgICBpbnNwZWN0b3JDb25maWcgPSB7fTtcbiAgICBPYmplY3QudmFsdWVzKHBsdWdpbnNHcm91cCkuZm9yRWFjaCgocGtnOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRyaWJ1dGlvbiA9IHBrZy5pbmZvLmNvbnRyaWJ1dGlvbnMhLmluc3BlY3RvciBhcyBJQ29udHJpYnV0aW9ucztcblxuICAgICAgICBPYmplY3QuZW50cmllcyhjb250cmlidXRpb24udHlwZSA/PyBbXSkuZm9yRWFjaCgoW3R5cGUsIGZpbGVdKSA9PiB7XG4gICAgICAgICAgICBmaWxlID0gaXNBYnNvbHV0ZShmaWxlKSA/IGZpbGUgOiBqb2luKHBrZy5wYXRoLCBmaWxlKTtcbiAgICAgICAgICAgIGlmIChleGlzdHNTeW5jKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluc3BlY3RvckNvbmZpZ1t0eXBlXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5zcGVjdG9yQ29uZmlnW3R5cGVdWydwYW5lbCddKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oRWRpdG9yLkkxOG4udCgnaW5zcGVjdG9yLmV4dGVuc2lvbi5vdmVyd3JpdHRlbicsIHsgb2xkUGFuZWw6IGluc3BlY3RvckNvbmZpZ1t0eXBlXVsncGFuZWwnXSwgcGx1Z2luOiBwa2cubmFtZSwgcGFuZWw6IGZpbGUgfSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsncGFuZWwnXSA9IGZpbGU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluaXQodHlwZSwgZmlsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oRWRpdG9yLkkxOG4udCgnaW5zcGVjdG9yLmV4dGVuc2lvbi5pbnZhbGlkJywgeyBmaWxlIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgc2xvdHMuZm9yRWFjaCgoc2xvdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnOiBJU3ViQ29uZmlnID0gY29udHJpYnV0aW9uW3Nsb3RdO1xuICAgICAgICAgICAgaWYgKCFjb25maWcpIHsgcmV0dXJuOyB9XG4gICAgICAgICAgICBPYmplY3QuZW50cmllczxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+Pihjb25maWcpLmZvckVhY2goKFt0eXBlLCByZW5kZXJNYXBdKSA9PiB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVuZGVyTWFwKS5mb3JFYWNoKChbbmFtZSwgcmVuZGVyRmlsZV0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVuZGVyRmlsZSA9IGlzQWJzb2x1dGUocmVuZGVyRmlsZSkgPyByZW5kZXJGaWxlIDogam9pbihwa2cucGF0aCwgcmVuZGVyRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdHNTeW5jKHJlbmRlckZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWluc3BlY3RvckNvbmZpZ1t0eXBlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVJbml0KHR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddW3Nsb3RdW25hbWVdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddW3Nsb3RdW25hbWVdID0gW3JlbmRlckZpbGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnNwZWN0b3JDb25maWdbdHlwZV1bJ3Nsb3QnXVtzbG90XVtuYW1lXS5pbmRleE9mKHJlbmRlckZpbGUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddW3Nsb3RdW25hbWVdLnB1c2gocmVuZGVyRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oRWRpdG9yLkkxOG4udCgnaW5zcGVjdG9yLmV4dGVuc2lvbi5pbnZhbGlkJywgeyBmaWxlOiByZW5kZXJGaWxlIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOaLluaLvemDqOWIhueahOmFjee9rlxuICAgICAgICBpZiAoY29udHJpYnV0aW9uLmRyb3ApIHtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKGNvbnRyaWJ1dGlvbi5kcm9wKS5mb3JFYWNoKChbdHlwZSwgZHJvcEl0ZW1zXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRyb3BJdGVtcykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnNwZWN0b3JDb25maWdbdHlwZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVJbml0KHR5cGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGRyb3BJdGVtcy5mb3JFYWNoKGRyb3BJdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgdHlwZTogY2NUeXBlLCBtZXNzYWdlIH0gPSBkcm9wSXRlbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnZHJvcCddW2NjVHlwZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZTogcGtnLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaChwa2c6IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8pIHtcbiAgICBpZiAoIXBrZy5pbmZvLmNvbnRyaWJ1dGlvbnM/Lmluc3BlY3Rvcikge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFwbHVnaW5zR3JvdXBbcGtnLm5hbWVdKSB7XG4gICAgICAgIHBsdWdpbnNHcm91cFtwa2cubmFtZV0gPSBwa2c7XG4gICAgICAgIG1lcmdlQ29uZmlnKCk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGV0YWNoKHBrZzogRWRpdG9yLkludGVyZmFjZS5QYWNrYWdlSW5mbykge1xuICAgIGlmICghcGtnLmluZm8uY29udHJpYnV0aW9ucz8uaW5zcGVjdG9yKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHBsdWdpbnNHcm91cFtwa2cubmFtZV0pIHtcbiAgICAgICAgZGVsZXRlIHBsdWdpbnNHcm91cFtwa2cubmFtZV07XG4gICAgICAgIG1lcmdlQ29uZmlnKCk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlUeXBlKHR5cGU/OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdHlwZVxuICAgICAgICA/IGluc3BlY3RvckNvbmZpZ1t0eXBlXT8ucGFuZWwgPz8gJydcbiAgICAgICAgOiBPYmplY3QuZW50cmllcyhpbnNwZWN0b3JDb25maWcpLnJlZHVjZTxJVHlwZUNhY2hlPigocmVzdWx0LCBbdHlwZSwgY29uZmlnXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W3R5cGVdID0gY29uZmlnPy5wYW5lbCA/PyAnJztcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0sIHt9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHF1ZXJ5UmVuZGVyZXJNYXAodHlwZT86IHN0cmluZykge1xuICAgIGlmICghdHlwZSkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoaW5zcGVjdG9yQ29uZmlnKS5yZWR1Y2U8UmVjb3JkPHN0cmluZywgSVNsb3RDb25maWc+PigocmVzdWx0LCBbdHlwZSwgY29uZmlnXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W3R5cGVdID0gY29uZmlnLnNsb3Q7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9LCB7fSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3BlY3RvckNvbmZpZ1t0eXBlXSA/IGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnc2xvdCddIDoge307XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBxdWVyeURyb3BDb25maWcodHlwZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGluc3BlY3RvckNvbmZpZ1t0eXBlXVsnZHJvcCddO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnQoKSB7XG4gICAgaWYgKHN0YXJ0ZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzdGFydGVkID0gdHJ1ZTtcbiAgICBjb25zdCBsaXN0ID0gRWRpdG9yLlBhY2thZ2UuZ2V0UGFja2FnZXMoeyBlbmFibGU6IHRydWUgfSk7XG4gICAgbGlzdC5mb3JFYWNoKGF0dGFjaCk7XG5cbiAgICBFZGl0b3IuUGFja2FnZS5vbignZW5hYmxlJywgYXR0YWNoKTtcbiAgICBFZGl0b3IuUGFja2FnZS5vbignZGlzYWJsZScsIGRldGFjaCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmQoKSB7IH1cbiJdfQ==