"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.template=exports.style=exports.$=void 0;const extension_1=require("./extension");async function ready(){const e=this;Object.assign(e,{isLocked:!1,history:new History(e)}),extension_1.start(),e.sceneIsReady?e.sceneReady():await Editor.Message.request("scene","query-is-ready")&&e.sceneReady(),e.$.lock.addEventListener("click",()=>{e.setLocked(!e.isLocked,!0)})}function close(){}exports.$={content:".content",backward:".backward",forward:".forward",lock:".lock"},exports.style='\n:host {\n    display: flex;\n    flex-direction: column;\n}\n:host > .header {\n    height: 28px;\n    line-height: 28px;\n}\n:host > .header > ui-icon {\n    margin: 0 4px;\n    cursor: pointer;\n    transition: background-color 0.15s, color 0.15s;\n    color: var(--color-default-contrast-emphasis);\n}\n\n:host > .header > .triangle {\n    font-size: 16px;\n    pointer-events: none;\n    color: var(--color-normal-fill-weakest);\n    border-radius: calc(var(--size-small-radius) * 1px);\n}\n:host > .header > .triangle:hover {\n    background: var(--color-active-fill-emphasis);\n}\n:host > .header > .triangle[enable] {\n    pointer-events: auto;\n    color: var(--color-default-contrast-emphasis);\n}\n:host > .header > .triangle.backward {\n    transform: rotate(90deg);\n}\n:host > .header > .triangle.forward {\n    transform: rotate(-90deg);\n}\n:host > .header > .lock {\n    float: right;\n}\n:host > .header > .lock:hover {\n    color: var(--color-warn-fill);\n}\n:host > .header > .lock[value="pin"] {\n    color: var(--color-warn-fill);\n}\n:host > .content {\n    flex: 1;\n}\n',exports.template='\n<header class="header">\n    <ui-icon class="triangle backward" value="arrow-triangle" tooltip="i18n:inspector.backward_selection"></ui-icon>\n    <ui-icon class="triangle forward"  value="arrow-triangle" tooltip="i18n:inspector.forward_selection"></ui-icon>\n    <ui-icon class="lock" value="unpin" tooltip="i18n:inspector.lock_unlock"></ui-icon>\n</header>\n<ui-panel class="content"></ui-panel>\n',exports.methods={selected(){this.isLocked||this.update()},unselected(){this.isLocked||this.update()},async update(){const e=this;if(e.__update_lock__)return;e.__update_lock__=!0,await new Promise(e=>{setTimeout(e,100)});const t=Editor.Selection.getLastSelectedType(),s=Editor.Selection.getSelected(t);if(t!==e.type||JSON.stringify(s)!==JSON.stringify(e.uuids)){try{!1!==await e.$.content.canClose()&&(e.type=t,e.uuids=s,e.type||0!==e.uuids.length?(e.$.content.setAttribute("src",extension_1.queryType(e.type)||""),e.$.content.setAttribute("type",e.type),e.$.content.setAttribute("sub-type",""),e.$.content.update(e.uuids,extension_1.queryRendererMap(e.type),extension_1.queryDropConfig(e.type),extension_1.queryType(),extension_1.queryRendererMap()),e.history.record()):e.$.content.setAttribute("src",""))}catch(e){console.error(e)}e.__update_lock__=!1}else e.__update_lock__=!1},sceneClose(){this.isLocked&&"node"!==this.type||(this.uuids=[],this.$.content.setAttribute("src",""))},sceneReady(){this.sceneIsReady=!0,this.isLocked&&"node"!==this.type||this.setLocked(!1,!0)},setLocked(e,t=!1){const s=this;s.isLocked=e;const n=s.isLocked?"pin":"unpin";s.$.lock.setAttribute("value",n),!s.isLocked&&t&&s.update()},isFocused(){const e=this;try{return e.$.content.getRootNode().host.hasAttribute("focused")}catch(e){return console.error(e),!1}},undo(){this.__update_lock__||this.isFocused()&&this.$.content.callMethod("undo")},redo(){this.__update_lock__||this.isFocused()&&this.$.content.callMethod("redo")}},exports.ready=ready,exports.close=close;class History{constructor(e){this.allow=["node","asset"],this.current={type:"",uuids:[]},this.forwards=[],this.backwards=[],this.panel=null,this.panel=e,e.$.forward.addEventListener("click",()=>{this.forward(),this.updateState()}),e.$.backward.addEventListener("click",()=>{this.backward(),this.updateState()})}record(){const{panel:e,allow:t,forwards:s,backwards:n,current:r}=this,{type:o,uuids:i}=e;if(0===i.length)return;if(!t.includes(o))return;const a=JSON.stringify(i);r&&o===r.type&&a===JSON.stringify(r.uuids)||(n.unshift(r),s.length=0,this.current={type:o,uuids:i},n.length>30&&n.pop(),this.updateState())}forward(){const{forwards:e,backwards:t,current:s}=this;t.unshift(s);const n=e.shift();n&&(this.current=n,this.reselect("forward")),this.updateState()}backward(){const{forwards:e,backwards:t,current:s}=this;e.unshift(s);const n=t.shift();n&&(this.current=n,this.reselect("backward")),this.updateState()}async reselect(e){const{type:t}=this.current;if(!t)return Editor.Selection.clear("node"),void Editor.Selection.clear("asset");if("node"===t){const t=[];for(const e of this.current.uuids){const s=await Editor.Message.request("scene","query-node",e);s&&(s.isScene||s.parent&&s.parent.value.uuid)&&t.push(e)}if(0===t.length)return void this[e]();this.current.uuids=t}const{uuids:s}=this.current;Editor.Selection.clear(t),Editor.Selection.select(t,s)}rebase(){const{forwards:e,backwards:t}=this;e.length=0,t.length=0}updateState(){const{forwards:e,backwards:t,panel:s}=this;e.length?s.$.forward.setAttribute("enable",""):s.$.forward.removeAttribute("enable"),t.length?s.$.backward.setAttribute("enable",""):s.$.backward.removeAttribute("enable")}}