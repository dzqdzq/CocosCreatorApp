"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.template=exports.style=exports.$=void 0;const extension_1=require("./extension");async function ready(){const e=this;Object.assign(e,{isLocked:!1,history:new History(e)}),extension_1.start(),e.sceneIsReady?e.sceneReady():await Editor.Message.request("scene","query-is-ready")&&e.sceneReady(),e.$.lock.addEventListener("click",()=>{e.setLocked(!e.isLocked,!0)}),e.alignProp=new AlignProp(e.$.content,e.$.alignStyle)}function close(){this.alignProp.close()}require("../../extension"),exports.$={alignStyle:"#align-style",content:".content",backward:".backward",forward:".forward",lock:".lock"},exports.style='\n:host {\n    display: flex;\n    flex-direction: column;\n}\n:host > .header {\n    height: 28px;\n    line-height: 28px;\n    border-bottom: solid 1px var(--color-normal-border);\n}\n:host > .header > ui-icon {\n    margin: 0 4px;\n    cursor: pointer;\n    transition: background-color 0.15s, color 0.15s;\n    color: var(--color-default-contrast-emphasis);\n}\n\n:host > .header > .triangle {\n    font-size: 16px;\n    pointer-events: none;\n    color: var(--color-normal-fill-weakest);\n    border-radius: calc(var(--size-small-radius) * 1px);\n}\n:host > .header > .triangle:hover {\n    background: var(--color-active-fill-emphasis);\n}\n:host > .header > .triangle[enable] {\n    pointer-events: auto;\n    color: var(--color-default-contrast-emphasis);\n}\n:host > .header > .triangle.backward {\n    transform: rotate(90deg);\n}\n:host > .header > .triangle.forward {\n    transform: rotate(-90deg);\n}\n:host > .header > .lock {\n    float: right;\n}\n:host > .header > .lock:hover {\n    color: var(--color-warn-fill);\n}\n:host > .header > .lock[value="pin"] {\n    color: var(--color-warn-fill);\n}\n:host > .content {\n    flex: 1;\n}\n',exports.template='\n<style id="align-style"></style>\n<header class="header">\n    <ui-icon class="triangle backward" value="arrow-triangle" tooltip="i18n:inspector.backward_selection"></ui-icon>\n    <ui-icon class="triangle forward"  value="arrow-triangle" tooltip="i18n:inspector.forward_selection"></ui-icon>\n    <ui-icon class="lock" hidden value="unpin"></ui-icon>\n</header>\n<ui-panel class="content"></ui-panel>\n',exports.methods={selected(){this.isLocked||this.update()},unselected(){this.isLocked||this.update()},async update(){const e=this;if(e.__update_lock__)return;e.__update_lock__=!0,await new Promise(e=>{setTimeout(e,100)});const t=Editor.Selection.getLastSelectedType(),n=Editor.Selection.getSelected(t);if(t!==e.type||JSON.stringify(n)!==JSON.stringify(e.uuids)){try{!1!==await e.$.content.canClose()&&(e.type=t,e.uuids=n,e.type||0!==e.uuids.length?(e.$.lock.removeAttribute("hidden"),e.$.content.setAttribute("src",extension_1.queryType(e.type)||""),e.$.content.setAttribute("type",e.type),e.$.content.setAttribute("sub-type",""),e.$.content.update(e.uuids,extension_1.queryRendererMap(e.type),extension_1.queryDropConfig(e.type),extension_1.queryType(),extension_1.queryRendererMap()),e.history.record()):(e.$.lock.setAttribute("hidden",""),e.$.content.setAttribute("src","")))}catch(e){console.error(e)}e.__update_lock__=!1}else e.__update_lock__=!1},sceneClose(){this.isLocked&&"node"!==this.type||(this.uuids=[],this.$.content.setAttribute("src",""))},sceneReady(){this.sceneIsReady=!0,this.isLocked&&"node"!==this.type||this.setLocked(!1,!0)},setLocked(e,t=!1){const n=this;n.isLocked=e;const i=n.isLocked?"pin":"unpin";n.$.lock.setAttribute("value",i);const s=n.isLocked?"i18n:inspector.unpin":"i18n:inspector.pin";n.$.lock.setAttribute("tooltip",s),!n.isLocked&&t&&n.update()},isFocused(){const e=this;try{return e.$.content.getRootNode().host.hasAttribute("focused")}catch(e){return console.error(e),!1}},undo(){this.__update_lock__||this.isFocused()&&this.$.content.callMethod("undo")},redo(){this.__update_lock__||this.isFocused()&&this.$.content.callMethod("redo")}},exports.ready=ready,exports.close=close;class History{constructor(e){this.allow=["node","asset"],this.current={type:"",uuids:[]},this.forwards=[],this.backwards=[],this.panel=null,this.panel=e,e.$.forward.addEventListener("click",()=>{this.forward(),this.updateState()}),e.$.backward.addEventListener("click",()=>{this.backward(),this.updateState()})}record(){const{panel:e,allow:t,forwards:n,backwards:i,current:s}=this,{type:r,uuids:o}=e;if(0===o.length)return;if(!t.includes(r))return;const a=JSON.stringify(o);s&&r===s.type&&a===JSON.stringify(s.uuids)||(i.unshift(s),n.length=0,this.current={type:r,uuids:o},i.length>30&&i.pop(),this.updateState())}forward(){const{forwards:e,backwards:t,current:n}=this;t.unshift(n);const i=e.shift();i&&(this.current=i,this.reselect("forward")),this.updateState()}backward(){const{forwards:e,backwards:t,current:n}=this;e.unshift(n);const i=t.shift();i&&(this.current=i,this.reselect("backward")),this.updateState()}async reselect(e){const{type:t}=this.current;if(!t)return Editor.Selection.clear("node"),void Editor.Selection.clear("asset");if("node"===t){const t=[];for(const e of this.current.uuids){const n=await Editor.Message.request("scene","query-node",e);n&&(n.isScene||n.parent&&n.parent.value.uuid)&&t.push(e)}if(0===t.length)return void this[e]();this.current.uuids=t}const{uuids:n}=this.current;Editor.Selection.clear(t),Editor.Selection.select(t,n)}rebase(){const{forwards:e,backwards:t}=this;e.length=0,t.length=0}updateState(){const{forwards:e,backwards:t,panel:n}=this;e.length?n.$.forward.setAttribute("enable",""):n.$.forward.removeAttribute("enable"),t.length?n.$.backward.setAttribute("enable",""):n.$.backward.removeAttribute("enable")}}class AlignProp{constructor(e,t){this.contentWidthRatio=.618,this.adjustPaddingLeft=18,this.$container=e,this.$style=t,this.resizeObserver=new window.ResizeObserver(()=>{this.update()}),this.resizeObserver.observe(this.$container),this.uiPropResizeWidthBind=this.uiPropResizeWidth.bind(this),this.$container.addEventListener("ui-kit:resize-prop-width",this.uiPropResizeWidthBind)}get contentWidth(){return(this.$container.clientWidth-this.adjustPaddingLeft)*this.contentWidthRatio}set contentWidth(e){this.contentWidthRatio=e/this.$container.clientWidth,this.update()}update(){this.$style.innerHTML=`\n        :host { \n            --ui-prop-margin-left: 20px; \n            --ui-prop-margin-right: 20px; \n            --ui-prop-label-width-min: 60px;\n            --ui-prop-content-width: ${this.contentWidth}px;\n            --left-width: calc(100% - var(--ui-prop-content-width)); \n        }`}uiPropResizeWidth(e){e.stopPropagation(),e.detail&&(this.contentWidth=e.detail.contentWidth)}close(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=void 0),this.$container.removeEventListener("ui-kit:resize-prop-width",this.uiPropResizeWidthBind)}}