"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),d3=require("d3"),Vue=require("vue/dist/vue.js"),{cloneDeep:cloneDeep}=require("lodash");Vue.config.productionTip=!1,Vue.config.devtools=!1;let cache,panel=null,vm=null;function mergeStops(t,e,r){const o=t.concat(e).map(t=>t.time).sort((t,e)=>t-e),i=[...new Set(o)].reduce((r,o)=>{const i=t.find(t=>!t.hide&&t.time===o)||{},a=e.find(t=>!t.hide&&t.time===o)||{};return void 0===i.time&&void 0===a.time||r.push({...i,...a}),r},[]);cache.colorKeys=t,cache.alphaKeys=e.map(t=>{const e=Object.assign(t);return e.alpha=Number((255*t.alpha).toFixed()),e}),cache.mode=r,Editor.Message.send("inspector","gradient-change",cache);for(const[t,e]of i.entries()){const{time:o,color:a,alpha:s}=e;void 0===a&&(e.color=getValByType(t,o,i,"color",r)),void 0===s&&(e.alpha=getValByType(t,o,i,"alpha",r))}if(1===r){const t=[];for(const[e,r]of i.entries()){const{time:o}=r;if(t.push(r),e<i.length-1){const r=i[e+1];t.push({...r,time:o})}}return t}return i}function getValByType(t,e,r,o,i){let a,s;for(let e=t+1;e<r.length;e++){const t=r[e];if(void 0!==t[o]){a=t;break}}for(let e=t-1;e>=0;e--){const t=r[e];if(void 0!==t[o]){s=t;break}}if(s||(s=a),a||(a=s),1===i)return a[o];s||(s={color:[255,255,255],time:0}),a||(a={color:[255,255,255],time:1});let n=s[o];return s!==a&&(n=interpolateStopProperty(s,a,e,o)),n}function interpolateStopProperty(t,e,r,o){const{time:i}=t,{time:a}=e,s=(r-i)/(a-i),n=1-s;return"color"===o?[0,1,2].map(r=>Math.round(t.color[r]*n+e.color[r]*s)):Math.round(100*t.alpha*n+100*e.alpha*s)/100}async function ready(){vm=new Vue({el:(panel=this).$.content,data:{enumList:[{name:"Blend",value:0},{name:"Fixed",value:1}],gradient:{mode:0,alphaKeys:[{time:0,alpha:0,hide:!1},{time:1,alpha:1,hide:!1}],colorKeys:[{time:.5,color:[249,49,83],hide:!1},{time:1,color:[255,255,255],hide:!1}]},margin:{top:15,bottom:15,left:5,right:5},config:{anchorWidth:10,anchorHeight:15,width:0,height:75,defaultColor:[255,255,255],defaultAlpha:1,colorLength:8,alphaLength:8},selectedItem:null},async mounted(){},methods:{init(t){t.colorKeys.map(t=>t.type="color"),t.alphaKeys.map(t=>{t.type="alpha",t.alpha=t.alpha/255}),this.gradient=t,this.selectedItem=null,this.resize()},getVal(t){if(this.selectedItem)switch(t){case"color":return JSON.stringify([...this.selectedItem.color,255]);case"time":return`${(100*this.selectedItem.time).toFixed()}`;case"alpha":return`${(255*this.selectedItem.alpha).toFixed()}`;default:return this.selectedItem[t]}},confirm(t,e){const{value:r}=e.target;this.update({operation:"assign",data:{value:r,type:t}})},getAnchors(){const{gradient:{alphaKeys:t,colorKeys:e}}=this,r=e.map((t,e)=>({...t,index:e})),o=t.map((t,e)=>({...t,index:e}));return r.concat(o).sort((t,e)=>{if(t.time===e.time){if(t.active)return!0;if(e.active)return!1}return t.time-e.time})},getStops(){const{gradient:{alphaKeys:t,colorKeys:e,mode:r}}=this;return mergeStops(cloneDeep(e).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),cloneDeep(t).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),r)},drawStops(t,e){const r=this.getStops(t,e),o=this._grad.selectAll("stop").data(r,(t,e)=>{const{color:r,alpha:o,time:i}=t;return`${i}${o}${r}${e}`});o.exit().remove(),o.enter().append("stop").merge(o).attr("offset",t=>100*t.time+"%").style("stop-color",t=>d3.rgb(...t.color)).style("stop-opacity",t=>void 0!==t.alpha?t.alpha:1)},drawAnchors(t){const e=this.getAnchors(),{config:{width:r},margin:o}=this,i=r-o.left-o.right,a=this,s=this._svg.selectAll("path").data(e,(t,e)=>{const{color:r,alpha:o,time:i,type:a}=t;return`${a}${i}${o}${r}${e}`});s.exit().remove();let n=!1;s.enter().append("path").merge(s).attr("class",t=>["hide","add","active"].filter(e=>t[e]).concat(["anchor"]).join(" ")).attr("index",t=>t.index).attr("type",t=>t.type).attr("d",t=>this.drawAnchor(t)).attr("transform",t=>`translate(${t.time*i}, 0)`).attr("fill",t=>"color"===t.type?d3.rgb(...t.color):d3.rgb(...Array.from({length:3},()=>255*t.alpha))).order().call(d3.drag().filter(["dragstart","drag"]).on("start",function(){const t=d3.select(this).datum();a.update({data:t,operation:"active"})}).on("drag",function(){(d3.event.dx||d3.event.dy)&&(n=!0,a.update({operation:"move"}))}).on("end",function(){n&&(n=!1,a.update({operation:"drop"}))}))},update(t){const{config:{width:e,height:r},margin:o}=this,{data:i,operation:a}=t;switch(a){case"active":{this.gradient.colorKeys.map(t=>{t.active=!1}),this.gradient.alphaKeys.map(t=>{t.active=!1});const{type:t,index:e}=i,r=this.gradient[`${t}Keys`][e];r.active=!0,this.selectedItem=r,this.drawAnchors();break}case"move":{const{type:t,index:i}=this._svg.select(".anchor.active").datum(),a=this.gradient[`${t}Keys`],s=a[i],[n,c]=d3.mouse(this._svg.node()),h="color"===t?c<r-o.bottom||c>r:c>o.top||c<0,d=Math.round((n-o.left)/(e-o.left-o.right)*100)/100,l=Math.max(Math.min(d,1),0);if(s.time=l,s.hide&&h)return;s.hide=a.length>1&&h,this.drawAnchors(),this.drawStops();break}case"drop":{const{type:t,index:i}=this._svg.select(".anchor.active").datum(),a=this.gradient[`${t}Keys`],s=a[i],[n,c]=d3.mouse(this._svg.node()),h="color"===t?c<r-o.bottom||c>r:c>o.top||c<0,d=Math.round((n-o.left)/(e-o.left-o.right)*100)/100,l=Math.max(Math.min(d,1),0);if(s.time=l,s.hide=a.length>1&&h,s.hide)a.splice(i,1),this.selectedItem=null;else{const t=[...new Set(a.map(t=>t.time))];if(a.length>t.length){let t;for(const[e,r]of a.entries())if(r.time===l&&e!==i){t=e;break}a.splice(t,1)}}this.drawAnchors(),this.drawStops();break}case"create":{const[t,i]=d3.mouse(this._svg.node());if(i>o.top&&i<r-o.bottom)return!1;const a=i>o.top?"color":"alpha",s=this.gradient[`${a}Keys`],n=s.length;if(n>=this.config[`${a}Length`])return!1;const c=Math.round((t-o.left)/(e-o.left-o.right)*100)/100,h={time:Math.max(Math.min(c,1),0),type:a,[a]:"color"===a?[...this.config.defaultColor]:this.config.defaultAlpha,index:n};return s.push(h),this.drawStops(),this.update({data:h,operation:"active"}),!0}case"assign":{const{type:t,value:e}=i;if("mode"===t)return this.gradient.mode=parseInt(e,10),this.drawStops();if(this.selectedItem){switch(t){case"time":this.selectedItem.time=e/100;break;case"alpha":this.selectedItem.alpha=Math.floor(100*e/255)/100;break;case"color":this.selectedItem.color=e.slice(0,-1)}this.drawAnchors(),this.drawStops()}break}}},resize(){const t=this,e=this.$el.querySelector(".gradient");this.config.width=e.clientWidth;const{config:{width:r,height:o},margin:i}=this,a=r-i.left-i.right,s=o-i.top-i.bottom;this._svg?(this._svg.attr("width",r),this._rect.attr("width",a).attr("height",s).attr("fill","url(#grad)")):(this._svg=d3.select(e).append("svg").attr("width",r).attr("height",o),this._grad=this._svg.append("defs").append("linearGradient").attr("id","grad").attr("x1","0").attr("x2","100%").attr("y1","0").attr("y2",0),this._rect=this._svg.append("rect").attr("class","canvas").attr("x",i.left).attr("y",i.top).attr("width",a).attr("height",s).attr("fill","url(#grad)"));let n=!1;this._svg.call(d3.drag().on("start",function(){n=t.update({operation:"create"})}).on("drag",function(){n&&t.update({operation:"move"})}).on("end",function(){n&&(n=!1,t.update({operation:"drop"}))})),this.drawStops(),this.drawAnchors()},drawAnchor(t){const{margin:e,config:{height:r,anchorWidth:o,anchorHeight:i}}=this,{type:a}=t,s="color"===a,n=e.left,c=s?r-e.bottom:e.top,h=s?1:-1;return`M${n} ${c}\n                    L${n-o/2} ${c+i/3*h}\n                    ${n-o/2} ${c+i*h}\n                    ${n+o/2} ${c+i*h}\n                    ${n+o/2} ${c+i/3*h}z`}}}),Editor.Message.send("inspector","gradient-state",!0)}async function beforeClose(){}async function close(){Editor.Message.send("inspector","gradient-state",!1)}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/gradient-editor.html"),"utf8"),exports.fonts=[{name:"inspector"}],exports.$={content:".gradient-editor"},exports.methods={data(t){t&&(cache=t,vm.init({colorKeys:t.colorKeys,alphaKeys:t.alphaKeys,mode:t.mode}))}},exports.listeners={resize(){vm&&vm.resize()}},window.addEventListener("resize",()=>{vm.resize()}),exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;