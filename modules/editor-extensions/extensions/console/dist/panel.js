'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.ready = exports.listeners = exports.methods = exports.$ = exports.template = exports.style = void 0;
const electron_1 = require("electron");
const fs_1 = require("fs");
const path_1 = require("path");
const extension_1 = require("./extension");
const Vue = require('vue/dist/vue.js');
Vue.config.productionTip = false;
Vue.config.devtools = false;
const Manager = require('./manager');
const allLogTypes = ['log', 'warn', 'error', 'info'];
let panel = null;
let vm = null;
const vueTemplate = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../static', '/template/index.html'), 'utf8');
const ConsolePanelVM = Vue.extend({
    components: {
        'console-list': require('./components/list'),
    },
    data() {
        return {
            updateAnimationId: null,
            tabbar: {
                displayDate: '',
                fontSize: 12,
                lineHeight: 24,
                filterTypes: [...allLogTypes],
                filterRegex: false,
            },
            extendsList: [],
            logTypes: [{
                    label: 'Log',
                    value: 'log',
                },
                {
                    label: 'Info',
                    value: 'info',
                },
                {
                    label: 'Warning',
                    value: 'warn',
                },
                {
                    label: 'Error',
                    value: 'error',
                },
            ],
        };
    },
    mounted() {
        this.init();
    },
    methods: {
        async onHeaderChange(type, event) {
            const target = event.target;
            const value = target.value ?? '';
            switch (type) {
                case 'clear':
                    Editor.Logger.clear();
                    Manager.clear();
                    break;
                case 'filterRegex':
                    Manager.setFilterRegex(value);
                    break;
                case 'filterText':
                    Manager.setFilterText(value);
                    break;
                case 'filterType': {
                    const currentType = target.dataset.value;
                    if (value) {
                        if (currentType && !this.tabbar.filterTypes.includes(currentType)) {
                            this.tabbar.filterTypes.push(currentType);
                        }
                    }
                    else {
                        const index = this.tabbar.filterTypes.findIndex((v) => v === currentType);
                        if (index !== -1) {
                            this.tabbar.filterTypes.splice(index, 1);
                        }
                    }
                    Manager.setFilterType(this.tabbar.filterTypes);
                    await Editor.Profile.setConfig('console', 'panel.filterTypes', this.tabbar.filterTypes);
                    break;
                }
                case 'filterTypeAll':
                    if (value) {
                        this.tabbar.filterTypes = [...allLogTypes];
                    }
                    else {
                        this.tabbar.filterTypes = [];
                    }
                    Manager.setFilterType(this.tabbar.filterTypes);
                    await Editor.Profile.setConfig('console', 'panel.filterTypes', this.tabbar.filterTypes);
                    break;
                case 'openLog': {
                    const url = (0, path_1.join)(Editor.Project.path, './temp/logs/project.log');
                    // 优先使用偏好设置里的默认脚本编辑器打开
                    const res = await Editor.Message.request('program', 'open-program', 'scriptEditor', {
                        _args: [url],
                    });
                    if (!res) {
                        electron_1.shell.openPath(url);
                    }
                    break;
                }
            }
        },
        update(...rest) {
            window.cancelAnimationFrame(this.updateAnimationId);
            this.updateAnimationId = window.requestAnimationFrame(() => {
                const list = this.$refs.list;
                if (list) {
                    list.renderList(...rest);
                }
            });
        },
        /**
         * 翻译
         */
        t(key) {
            const name = `console.${key}`;
            return Editor.I18n.t(name);
        },
        async init() {
            /**
             * refresh 需要放在以下两个之前，
             * 因为 record 也会有输出，
             * 如果 refresh 放后面会导致初始数据输出两次
             */
            await this.refresh();
            Manager.setUpdateFn(this.update.bind(this));
            Editor.Logger.__protected__.on('record', exports.methods.record);
            Editor.Logger.__protected__.on('clear', exports.methods.refresh);
        },
        async refresh() {
            // 获取数据
            const list = await Editor.Logger.query();
            const config = await Editor.Profile.getConfig('console', 'panel');
            // 旧数据处理: v3.7新增了 filterTypes 配置， v3.9 看到这段代码可以将 oldTypeConfig 这段处理删除
            const oldTypeConfig = config.filterType ? (config.filterType === 'all' ? [...allLogTypes] : [config.filterType]) : null;
            const size = config.fontSize - 0 || 12;
            this.tabbar.displayDate = config.displayDate;
            this.tabbar.filterTypes = config.filterTypes || oldTypeConfig;
            this.tabbar.fontSize = size;
            this.tabbar.lineHeight = size * 2;
            Manager.reset(list);
            Manager.setFilterType(this.tabbar.filterTypes);
            Manager.showDate(this.tabbar.displayDate);
            Manager.setLineHeight(this.tabbar.lineHeight);
        },
        onClearChange(item, event) {
            // 能够被点击，说明都是在显示状态下，所以这边 show 直接传 true，无需从配置里获取
            Editor.Profile.setConfig(item.name, item.key, { value: event.target.value, show: true }, 'global');
        },
    },
    template: vueTemplate,
});
exports.style = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../dist/index.css'), 'utf8');
exports.template = '<div class="container"></div>';
exports.$ = {
    container: '.container',
};
exports.methods = {
    /**
     * 刷新显示面板
     * 查询对应选中的对象的信息
     */
    record(log) {
        Manager.addItem(log);
        Manager.update();
    },
    async refresh(type) {
        if (type) {
            await Editor.Profile.setConfig('console', 'panel.filterType', type);
        }
        if (!vm) {
            return;
        }
        await vm.refresh();
    },
    async updateExtensionVisible() {
        if (!vm) {
            return;
        }
        vm.extendsList = await (0, extension_1.getConfig)();
    },
};
exports.listeners = {
    /**
     * 窗口缩放时调用更新
     */
    resize() {
        Manager?.update?.(true);
    },
    /**
     * 窗口显示时调用更新
     */
    show() {
        Manager.update();
    },
};
async function ready(initType) {
    // @ts-ignore
    panel = this;
    if (initType) {
        await Editor.Profile.setConfig('console', 'panel.filterTypes', [initType]);
    }
    vm?.$destroy();
    vm = new ConsolePanelVM();
    vm.$mount(panel.$.container);
    // 拓展配置
    Editor.Package.__protected__.on('enable', async (pkg) => {
        (0, extension_1.attach)(pkg);
        panel.updateExtensionVisible();
    });
    Editor.Package.__protected__.on('disable', async (pkg) => {
        (0, extension_1.detach)(pkg);
        panel.updateExtensionVisible();
    });
    (0, extension_1.init)();
    panel.updateExtensionVisible();
}
exports.ready = ready;
async function close() {
    // 取消之前监听的日志处理事件
    Manager.setUpdateFn(null);
    Editor.Logger.__protected__.removeListener('record', exports.methods.record);
    Editor.Logger.__protected__.removeListener('clear', exports.methods.refresh);
    vm?.$destroy();
    vm = null;
    panel = null;
}
exports.close = close;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2UvcGFuZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYix1Q0FBaUM7QUFDakMsMkJBQWtDO0FBQ2xDLCtCQUE0QjtBQUU1QiwyQ0FBOEU7QUFHOUUsTUFBTSxHQUFHLEdBQW1CLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3ZELEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztBQUNqQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7QUFFNUIsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRXJDLE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFckQsSUFBSSxLQUFLLEdBQVEsSUFBSSxDQUFDO0FBQ3RCLElBQUksRUFBRSxHQUFRLElBQUksQ0FBQztBQUVuQixNQUFNLFdBQVcsR0FBRyxJQUFBLGlCQUFZLEVBQUMsSUFBQSxXQUFJLEVBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxzQkFBc0IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRS9GLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDOUIsVUFBVSxFQUFFO1FBQ1IsY0FBYyxFQUFFLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztLQUMvQztJQUNELElBQUk7UUFDQSxPQUFPO1lBQ0gsaUJBQWlCLEVBQUUsSUFBVztZQUM5QixNQUFNLEVBQUU7Z0JBQ0osV0FBVyxFQUFFLEVBQUU7Z0JBQ2YsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsV0FBVyxFQUFFLENBQUMsR0FBRyxXQUFXLENBQUM7Z0JBQzdCLFdBQVcsRUFBRSxLQUFLO2FBQ3JCO1lBQ0QsV0FBVyxFQUFFLEVBQUU7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bkYsSUFBQSxrQkFBTSxFQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1osS0FBSyxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFDSCxJQUFBLGdCQUFjLEdBQUUsQ0FBQztJQUNqQixLQUFLLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztBQUNuQyxDQUFDO0FBdkJELHNCQXVCQztBQUVNLEtBQUssVUFBVSxLQUFLO0lBQ3ZCLGdCQUFnQjtJQUNoQixPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsZUFBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JFLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsZUFBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXJFLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQztJQUNmLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDVixLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLENBQUM7QUFURCxzQkFTQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgc2hlbGwgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBsb2dUeXBlLCBJQ29uc29sZUV4dGVuc2lvbiB9IGZyb20gJy4uL0B0eXBlcy9wcml2YXRlJztcbmltcG9ydCB7YXR0YWNoLCBkZXRhY2gsIGluaXQgYXMgaW5pdEV4dGVuc2lvbnMsIGdldENvbmZpZ30gZnJvbSAnLi9leHRlbnNpb24nO1xuXG5pbXBvcnQgdHlwZSB7IFZ1ZUNvbnN0cnVjdG9yIH0gZnJvbSAndnVlJztcbmNvbnN0IFZ1ZTogVnVlQ29uc3RydWN0b3IgPSByZXF1aXJlKCd2dWUvZGlzdC92dWUuanMnKTtcblZ1ZS5jb25maWcucHJvZHVjdGlvblRpcCA9IGZhbHNlO1xuVnVlLmNvbmZpZy5kZXZ0b29scyA9IGZhbHNlO1xuXG5jb25zdCBNYW5hZ2VyID0gcmVxdWlyZSgnLi9tYW5hZ2VyJyk7XG5cbmNvbnN0IGFsbExvZ1R5cGVzID0gWydsb2cnLCAnd2FybicsICdlcnJvcicsICdpbmZvJ107XG5cbmxldCBwYW5lbDogYW55ID0gbnVsbDtcbmxldCB2bTogYW55ID0gbnVsbDtcblxuY29uc3QgdnVlVGVtcGxhdGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi9zdGF0aWMnLCAnL3RlbXBsYXRlL2luZGV4Lmh0bWwnKSwgJ3V0ZjgnKTtcblxuY29uc3QgQ29uc29sZVBhbmVsVk0gPSBWdWUuZXh0ZW5kKHtcbiAgICBjb21wb25lbnRzOiB7XG4gICAgICAgICdjb25zb2xlLWxpc3QnOiByZXF1aXJlKCcuL2NvbXBvbmVudHMvbGlzdCcpLFxuICAgIH0sXG4gICAgZGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVwZGF0ZUFuaW1hdGlvbklkOiBudWxsIGFzIGFueSxcbiAgICAgICAgICAgIHRhYmJhcjoge1xuICAgICAgICAgICAgICAgIGRpc3BsYXlEYXRlOiAnJyxcbiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTIsXG4gICAgICAgICAgICAgICAgbGluZUhlaWdodDogMjQsXG4gICAgICAgICAgICAgICAgZmlsdGVyVHlwZXM6IFsuLi5hbGxMb2dUeXBlc10sXG4gICAgICAgICAgICAgICAgZmlsdGVyUmVnZXg6IGZhbHNlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGV4dGVuZHNMaXN0OiBbXSxcbiAgICAgICAgICAgIGxvZ1R5cGVzOiBbe1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnTG9nJyxcbiAgICAgICAgICAgICAgICB2YWx1ZTogJ2xvZycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnSW5mbycsXG4gICAgICAgICAgICAgICAgdmFsdWU6ICdpbmZvJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdXYXJuaW5nJyxcbiAgICAgICAgICAgICAgICB2YWx1ZTogJ3dhcm4nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsYWJlbDogJ0Vycm9yJyxcbiAgICAgICAgICAgICAgICB2YWx1ZTogJ2Vycm9yJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgIH0sXG4gICAgbW91bnRlZCgpIHtcbiAgICAgICAgdGhpcy5pbml0KCk7XG4gICAgfSxcbiAgICBtZXRob2RzOiB7XG4gICAgICAgIGFzeW5jIG9uSGVhZGVyQ2hhbmdlKHR5cGU6IHN0cmluZywgZXZlbnQ6IEN1c3RvbUV2ZW50KSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQgYXMgRWRpdG9yLlVJLkhUTUxDdXN0b21FbGVtZW50O1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0YXJnZXQudmFsdWUgPz8gJyc7XG5cbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ2NsZWFyJzpcbiAgICAgICAgICAgICAgICAgICAgRWRpdG9yLkxvZ2dlci5jbGVhcigpO1xuICAgICAgICAgICAgICAgICAgICBNYW5hZ2VyLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2ZpbHRlclJlZ2V4JzpcbiAgICAgICAgICAgICAgICAgICAgTWFuYWdlci5zZXRGaWx0ZXJSZWdleCh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2ZpbHRlclRleHQnOlxuICAgICAgICAgICAgICAgICAgICBNYW5hZ2VyLnNldEZpbHRlclRleHQodmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdmaWx0ZXJUeXBlJzp7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRUeXBlID0gdGFyZ2V0LmRhdGFzZXQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUeXBlICYmICF0aGlzLnRhYmJhci5maWx0ZXJUeXBlcy5pbmNsdWRlcyhjdXJyZW50VHlwZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmJhci5maWx0ZXJUeXBlcy5wdXNoKGN1cnJlbnRUeXBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy50YWJiYXIuZmlsdGVyVHlwZXMuZmluZEluZGV4KCh2KSA9PiB2ID09PSBjdXJyZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJiYXIuZmlsdGVyVHlwZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBNYW5hZ2VyLnNldEZpbHRlclR5cGUodGhpcy50YWJiYXIuZmlsdGVyVHlwZXMpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBFZGl0b3IuUHJvZmlsZS5zZXRDb25maWcoJ2NvbnNvbGUnLCAncGFuZWwuZmlsdGVyVHlwZXMnLCB0aGlzLnRhYmJhci5maWx0ZXJUeXBlcyk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXNlICdmaWx0ZXJUeXBlQWxsJzpcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmJhci5maWx0ZXJUeXBlcyA9IFsuLi5hbGxMb2dUeXBlc107XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmJhci5maWx0ZXJUeXBlcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIE1hbmFnZXIuc2V0RmlsdGVyVHlwZSh0aGlzLnRhYmJhci5maWx0ZXJUeXBlcyk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IEVkaXRvci5Qcm9maWxlLnNldENvbmZpZygnY29uc29sZScsICdwYW5lbC5maWx0ZXJUeXBlcycsIHRoaXMudGFiYmFyLmZpbHRlclR5cGVzKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnb3BlbkxvZyc6IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsID0gam9pbihFZGl0b3IuUHJvamVjdC5wYXRoLCAnLi90ZW1wL2xvZ3MvcHJvamVjdC5sb2cnKTtcbiAgICAgICAgICAgICAgICAgICAgLy8g5LyY5YWI5L2/55So5YGP5aW96K6+572u6YeM55qE6buY6K6k6ISa5pys57yW6L6R5Zmo5omT5byAXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3Byb2dyYW0nLCAnb3Blbi1wcm9ncmFtJywgJ3NjcmlwdEVkaXRvcicsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hcmdzOiBbdXJsXSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaGVsbC5vcGVuUGF0aCh1cmwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZSguLi5yZXN0OiBhbnkpIHtcbiAgICAgICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLnVwZGF0ZUFuaW1hdGlvbklkKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQW5pbWF0aW9uSWQgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaXN0ID0gdGhpcy4kcmVmcy5saXN0IGFzIGFueTtcbiAgICAgICAgICAgICAgICBpZiAobGlzdCl7XG4gICAgICAgICAgICAgICAgICAgIGxpc3QucmVuZGVyTGlzdCguLi5yZXN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOe/u+ivkVxuICAgICAgICAgKi9cbiAgICAgICAgdChrZXk6IHN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGBjb25zb2xlLiR7a2V5fWA7XG4gICAgICAgICAgICByZXR1cm4gRWRpdG9yLkkxOG4udChuYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgYXN5bmMgaW5pdCgpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogcmVmcmVzaCDpnIDopoHmlL7lnKjku6XkuIvkuKTkuKrkuYvliY3vvIxcbiAgICAgICAgICAgICAqIOWboOS4uiByZWNvcmQg5Lmf5Lya5pyJ6L6T5Ye677yMXG4gICAgICAgICAgICAgKiDlpoLmnpwgcmVmcmVzaCDmlL7lkI7pnaLkvJrlr7zoh7TliJ3lp4vmlbDmja7ovpPlh7rkuKTmrKFcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZWZyZXNoKCk7XG5cbiAgICAgICAgICAgIE1hbmFnZXIuc2V0VXBkYXRlRm4odGhpcy51cGRhdGUuYmluZCh0aGlzKSk7XG4gICAgICAgICAgICBFZGl0b3IuTG9nZ2VyLl9fcHJvdGVjdGVkX18ub24oJ3JlY29yZCcsIG1ldGhvZHMucmVjb3JkKTtcbiAgICAgICAgICAgIEVkaXRvci5Mb2dnZXIuX19wcm90ZWN0ZWRfXy5vbignY2xlYXInLCBtZXRob2RzLnJlZnJlc2gpO1xuICAgICAgICB9LFxuICAgICAgICBhc3luYyByZWZyZXNoKCkge1xuICAgICAgICAgICAgLy8g6I635Y+W5pWw5o2uXG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gYXdhaXQgRWRpdG9yLkxvZ2dlci5xdWVyeSgpO1xuXG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ2NvbnNvbGUnLCAncGFuZWwnKTtcblxuICAgICAgICAgICAgLy8g5pen5pWw5o2u5aSE55CGOiB2My435paw5aKe5LqGIGZpbHRlclR5cGVzIOmFjee9ru+8jCB2My45IOeci+WIsOi/meauteS7o+eggeWPr+S7peWwhiBvbGRUeXBlQ29uZmlnIOi/meauteWkhOeQhuWIoOmZpFxuICAgICAgICAgICAgY29uc3Qgb2xkVHlwZUNvbmZpZyA9IGNvbmZpZy5maWx0ZXJUeXBlID8gKGNvbmZpZy5maWx0ZXJUeXBlID09PSAnYWxsJyA/IFsuLi5hbGxMb2dUeXBlc10gOiBbY29uZmlnLmZpbHRlclR5cGVdKSA6IG51bGw7XG4gICAgICAgICAgICBjb25zdCBzaXplID0gY29uZmlnLmZvbnRTaXplIC0gMCB8fCAxMjtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy50YWJiYXIuZGlzcGxheURhdGUgPSBjb25maWcuZGlzcGxheURhdGU7XG4gICAgICAgICAgICB0aGlzLnRhYmJhci5maWx0ZXJUeXBlcyA9IGNvbmZpZy5maWx0ZXJUeXBlcyB8fCBvbGRUeXBlQ29uZmlnO1xuICAgICAgICAgICAgdGhpcy50YWJiYXIuZm9udFNpemUgPSBzaXplO1xuICAgICAgICAgICAgdGhpcy50YWJiYXIubGluZUhlaWdodCA9IHNpemUgKiAyO1xuXG4gICAgICAgICAgICBNYW5hZ2VyLnJlc2V0KGxpc3QpO1xuICAgICAgICAgICAgTWFuYWdlci5zZXRGaWx0ZXJUeXBlKHRoaXMudGFiYmFyLmZpbHRlclR5cGVzKTtcbiAgICAgICAgICAgIE1hbmFnZXIuc2hvd0RhdGUodGhpcy50YWJiYXIuZGlzcGxheURhdGUpO1xuICAgICAgICAgICAgTWFuYWdlci5zZXRMaW5lSGVpZ2h0KHRoaXMudGFiYmFyLmxpbmVIZWlnaHQpO1xuICAgICAgICB9LFxuICAgICAgICBvbkNsZWFyQ2hhbmdlKGl0ZW06IElDb25zb2xlRXh0ZW5zaW9uLCBldmVudDogYW55KSB7XG4gICAgICAgICAgICAvLyDog73lpJ/ooqvngrnlh7vvvIzor7TmmI7pg73mmK/lnKjmmL7npLrnirbmgIHkuIvvvIzmiYDku6Xov5novrkgc2hvdyDnm7TmjqXkvKAgdHJ1Ze+8jOaXoOmcgOS7jumFjee9rumHjOiOt+WPllxuICAgICAgICAgICAgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKGl0ZW0ubmFtZSwgaXRlbS5rZXksIHt2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlLCBzaG93OiB0cnVlfSwgJ2dsb2JhbCcgKTtcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIHRlbXBsYXRlOiB2dWVUZW1wbGF0ZSxcbn0pO1xuXG5leHBvcnQgY29uc3Qgc3R5bGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi9kaXN0L2luZGV4LmNzcycpLCAndXRmOCcpO1xuXG5leHBvcnQgY29uc3QgdGVtcGxhdGUgPSAnPGRpdiBjbGFzcz1cImNvbnRhaW5lclwiPjwvZGl2Pic7XG5cbmV4cG9ydCBjb25zdCAkID0ge1xuICAgIGNvbnRhaW5lcjogJy5jb250YWluZXInLFxufTtcblxuZXhwb3J0IGNvbnN0IG1ldGhvZHMgPSB7XG4gICAgLyoqXG4gICAgICog5Yi35paw5pi+56S66Z2i5p2/XG4gICAgICog5p+l6K+i5a+55bqU6YCJ5Lit55qE5a+56LGh55qE5L+h5oGvXG4gICAgICovXG4gICAgcmVjb3JkKGxvZzogc3RyaW5nKSB7XG4gICAgICAgIE1hbmFnZXIuYWRkSXRlbShsb2cpO1xuICAgICAgICBNYW5hZ2VyLnVwZGF0ZSgpO1xuICAgIH0sXG4gICAgYXN5bmMgcmVmcmVzaCh0eXBlPzogbG9nVHlwZSkge1xuICAgICAgICBpZiAodHlwZSkge1xuICAgICAgICAgICAgYXdhaXQgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKCdjb25zb2xlJywgJ3BhbmVsLmZpbHRlclR5cGUnLCB0eXBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdm0pIHsgXG4gICAgICAgICAgICByZXR1cm47IFxuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHZtLnJlZnJlc2goKTtcbiAgICB9LFxuICAgIGFzeW5jIHVwZGF0ZUV4dGVuc2lvblZpc2libGUoKSB7XG4gICAgICAgIGlmICghdm0pIHsgXG4gICAgICAgICAgICByZXR1cm47IFxuICAgICAgICB9XG4gICAgICAgIHZtLmV4dGVuZHNMaXN0ID0gYXdhaXQgZ2V0Q29uZmlnKCk7XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBsaXN0ZW5lcnMgPSB7XG4gICAgLyoqXG4gICAgICog56qX5Y+j57yp5pS+5pe26LCD55So5pu05pawXG4gICAgICovXG4gICAgcmVzaXplKCkge1xuICAgICAgICBNYW5hZ2VyPy51cGRhdGU/Lih0cnVlKTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOeql+WPo+aYvuekuuaXtuiwg+eUqOabtOaWsFxuICAgICAqL1xuICAgIHNob3coKSB7XG4gICAgICAgIE1hbmFnZXIudXBkYXRlKCk7XG4gICAgfSxcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWFkeShpbml0VHlwZTogbG9nVHlwZSkge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBwYW5lbCA9IHRoaXM7XG5cbiAgICBpZiAoaW5pdFR5cGUpIHtcbiAgICAgICAgYXdhaXQgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKCdjb25zb2xlJywgJ3BhbmVsLmZpbHRlclR5cGVzJywgW2luaXRUeXBlXSk7XG4gICAgfVxuXG4gICAgdm0/LiRkZXN0cm95KCk7XG4gICAgdm0gPSBuZXcgQ29uc29sZVBhbmVsVk0oKTtcbiAgICB2bS4kbW91bnQocGFuZWwuJC5jb250YWluZXIpO1xuXG4gICAgLy8g5ouT5bGV6YWN572uXG4gICAgRWRpdG9yLlBhY2thZ2UuX19wcm90ZWN0ZWRfXy5vbignZW5hYmxlJywgYXN5bmMgKHBrZzogRWRpdG9yLkludGVyZmFjZS5QYWNrYWdlSW5mbykgPT4ge1xuICAgICAgICBhdHRhY2gocGtnKTtcbiAgICAgICAgcGFuZWwudXBkYXRlRXh0ZW5zaW9uVmlzaWJsZSgpO1xuICAgIH0pO1xuICAgIEVkaXRvci5QYWNrYWdlLl9fcHJvdGVjdGVkX18ub24oJ2Rpc2FibGUnLCBhc3luYyAocGtnOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSA9PiB7XG4gICAgICAgIGRldGFjaChwa2cpO1xuICAgICAgICBwYW5lbC51cGRhdGVFeHRlbnNpb25WaXNpYmxlKCk7XG4gICAgfSk7XG4gICAgaW5pdEV4dGVuc2lvbnMoKTtcbiAgICBwYW5lbC51cGRhdGVFeHRlbnNpb25WaXNpYmxlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbG9zZSgpIHtcbiAgICAvLyDlj5bmtojkuYvliY3nm5HlkKznmoTml6Xlv5flpITnkIbkuovku7ZcbiAgICBNYW5hZ2VyLnNldFVwZGF0ZUZuKG51bGwpO1xuICAgIEVkaXRvci5Mb2dnZXIuX19wcm90ZWN0ZWRfXy5yZW1vdmVMaXN0ZW5lcigncmVjb3JkJywgbWV0aG9kcy5yZWNvcmQpO1xuICAgIEVkaXRvci5Mb2dnZXIuX19wcm90ZWN0ZWRfXy5yZW1vdmVMaXN0ZW5lcignY2xlYXInLCBtZXRob2RzLnJlZnJlc2gpO1xuXG4gICAgdm0/LiRkZXN0cm95KCk7XG4gICAgdm0gPSBudWxsO1xuICAgIHBhbmVsID0gbnVsbDtcbn1cbiJdfQ==