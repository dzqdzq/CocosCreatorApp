'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
// 维护一份渲染的类型列表
const renderTypes = {
    link(text, url) {
        url = url.replace(/:\d+/g, '');
        return `<ui-link value="${url}">${text || url}</ui-link>`;
    },
    asset(text, url) {
        const type = url.startsWith('db://') ? 'assetUrl' : 'assetUuid';
        return `<ui-link type="${type}" value="${url}">${text || url}</ui-link>`;
    },
    node(text, uuid) {
        return `<ui-link type="nodeUuid" value="${uuid}">${text || uuid}</ui-link>`;
    },
    image(text, url) {
        return `
        <ui-link value="${url}">
            <ui-image value="${url}" max-height>${text || url}</ui-image>
        </ui-link>
        `;
    },
    i18n(text, key) {
        return Editor.I18n.t(key);
    },
    hidden() {
        return '';
    },
};
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update(true);
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList(noScroll2bottom = false) {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList(noScroll2bottom);
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部 & 点击展开 收起不能自动滚动到底部
        if ((isAtBottom || !isOperating) && !noScroll2bottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - this.$el.clientHeight + 8; // pading-bottom:8px
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            if (selection.type === 'Range') {
                // 避免将 input 输入的的 focus 取消
                selection.removeAllRanges();
            }
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        let info = item.title;
        if (item.rows > 1) {
            item.content.forEach((str) => {
                info += `${str} \n`;
            });
            item.stack?.forEach?.((str) => {
                info += `${str} \n`;
            });
        }
        Editor.Menu.popup({
            x: event.pageX,
            y: event.pageY,
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
        //     const path = fileURLToPath(p1);
        //     return `{link[${path}](${path})}`;
        // });
        text = utils_1.replaceHttpAndLocalPath2UILink(text);
        text = text.replace(/\{([\w]+)(?:\[([^[]*)\])?(?:\(([^()]*)\))\}/gi, (matcher, type, text, url) => {
            const lowerType = type.toLowerCase();
            if (renderTypes[lowerType]) {
                return renderTypes[lowerType](text, url);
            }
            return matcher;
        });
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBQzVCLG9DQUEwRDtBQUUxRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQWtCLElBQUksQ0FBQztBQUMxQyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7QUFFNUMsY0FBYztBQUNkLE1BQU0sV0FBVyxHQUFRO0lBQ3JCLElBQUksQ0FBQyxJQUFZLEVBQUUsR0FBVztRQUMxQixHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0IsT0FBTyxtQkFBbUIsR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLFlBQVksQ0FBQztJQUM5RCxDQUFDO0lBQ0QsS0FBSyxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzNCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO1FBQ2hFLE9BQU8sa0JBQWtCLElBQUksWUFBWSxHQUFHLEtBQUssSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDO0lBQzdFLENBQUM7SUFDRCxJQUFJLENBQUMsSUFBWSxFQUFFLElBQVk7UUFDM0IsT0FBTyxtQ0FBbUMsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLFlBQVksQ0FBQztJQUNoRixDQUFDO0lBQ0QsS0FBSyxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzNCLE9BQU87MEJBQ1csR0FBRzsrQkFD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QyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgSU1lc3NhZ2VJdGVtIH0gZnJvbSAnLi4vLi4vQHR5cGVzL3ByaXRhdGUnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBtYW5hZ2VyID0gcmVxdWlyZSgnLi4vbWFuYWdlcicpO1xuY29uc3Qgb3V0cHV0TGlzdCA9IG1hbmFnZXIub3V0cHV0TGlzdDtcbmxldCBpc09wZXJhdGluZyA9IGZhbHNlO1xubGV0IHJlbmRlckxpc3RUaW1lcjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5sZXQgc2Nyb2xsVG9wY2FjaGUgPSAwOyAvLyDnlKjkuo7liKTmlq3lvZPliY3mmK/mqKrlkJHmu5rliqjov5jmmK/lnoLnm7Tmu5rliqhcblxuLy8g57u05oqk5LiA5Lu95riy5p+T55qE57G75Z6L5YiX6KGoXG5jb25zdCByZW5kZXJUeXBlczogYW55ID0ge1xuICAgIGxpbmsodGV4dDogc3RyaW5nLCB1cmw6IHN0cmluZykge1xuICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvOlxcZCsvZywgJycpO1xuICAgICAgICByZXR1cm4gYDx1aS1saW5rIHZhbHVlPVwiJHt1cmx9XCI+JHt0ZXh0IHx8IHVybH08L3VpLWxpbms+YDtcbiAgICB9LFxuICAgIGFzc2V0KHRleHQ6IHN0cmluZywgdXJsOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdHlwZSA9IHVybC5zdGFydHNXaXRoKCdkYjovLycpID8gJ2Fzc2V0VXJsJyA6ICdhc3NldFV1aWQnO1xuICAgICAgICByZXR1cm4gYDx1aS1saW5rIHR5cGU9XCIke3R5cGV9XCIgdmFsdWU9XCIke3VybH1cIj4ke3RleHQgfHwgdXJsfTwvdWktbGluaz5gO1xuICAgIH0sXG4gICAgbm9kZSh0ZXh0OiBzdHJpbmcsIHV1aWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gYDx1aS1saW5rIHR5cGU9XCJub2RlVXVpZFwiIHZhbHVlPVwiJHt1dWlkfVwiPiR7dGV4dCB8fCB1dWlkfTwvdWktbGluaz5gO1xuICAgIH0sXG4gICAgaW1hZ2UodGV4dDogc3RyaW5nLCB1cmw6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gYFxuICAgICAgICA8dWktbGluayB2YWx1ZT1cIiR7dXJsfVwiPlxuICAgICAgICAgICAgPHVpLWltYWdlIHZhbHVlPVwiJHt1cmx9XCIgbWF4LWhlaWdodD4ke3RleHQgfHwgdXJsfTwvdWktaW1hZ2U+XG4gICAgICAgIDwvdWktbGluaz5cbiAgICAgICAgYDtcbiAgICB9LFxuICAgIGkxOG4odGV4dDogc3RyaW5nLCBrZXk6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gRWRpdG9yLkkxOG4udChrZXkpO1xuICAgIH0sXG4gICAgaGlkZGVuKCkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCB0ZW1wbGF0ZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uLy4uL3N0YXRpYycsICcvdGVtcGxhdGUvbGlzdC5odG1sJyksICd1dGY4Jyk7XG5cbmV4cG9ydCBjb25zdCBuYW1lID0gJ2NvbnNvbGUtbGlzdCc7XG5cbmV4cG9ydCBjb25zdCBwcm9wcyA9IHtcbiAgICBmb250U2l6ZTogeyB0eXBlOiBOdW1iZXIgfSxcbiAgICBsaW5lSGVpZ2h0OiB7IHR5cGU6IE51bWJlciB9LFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdGltZXI6IG51bGwsXG4gICAgICAgIGNhY2hlTGlzdExlbmd0aDogMCxcbiAgICAgICAgc2hvd0xpc3Q6IFtdLFxuICAgICAgICB3cmFwcGVyU3R5bGU6IHsgaGVpZ2h0OiAwIH0sXG4gICAgICAgIGlzUmVuZGluZzogZmFsc2UsXG4gICAgICAgIGxpc3RUcmFuc2Zvcm1ZOiAwLFxuICAgICAgICByZXBsYWNlVGV4dFRpbWVyOiBudWxsLFxuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBjb21wdXRlZDogYW55ID0ge1xuICAgIGxpc3RTdHlsZSgpIHtcbiAgICAgICAgY29uc3QgeyBsaXN0VHJhbnNmb3JtWSwgZm9udFNpemUsIGxpbmVIZWlnaHQgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAndHJhbnNmb3JtJzogYHRyYW5zbGF0ZVkoJHtsaXN0VHJhbnNmb3JtWX1weClgLFxuICAgICAgICAgICAgJy0tZm9udC1zaXplJzogYCR7Zm9udFNpemV9cHhgLFxuICAgICAgICAgICAgJy0tbGluZS1oZWlnaHQnOiBgJHtsaW5lSGVpZ2h0fXB4YCxcbiAgICAgICAgfTtcbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHdhdGNoOiBhbnkgPSB7XG4gICAgbGluZUhlaWdodCh2YWw6IG51bWJlcikge1xuICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckxpc3QoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgbWV0aG9kczogYW55ID0ge1xuICAgIC8qKlxuICAgICAqIOWIh+aNoua2iOaBr+WFt+S9k+WGheWuueaYvuekulxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0cmFuc2xhdGVZXG4gICAgICovXG4gICAgdG9nZ2xlQ29udGVudCh0cmFuc2xhdGVZOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IG91dHB1dExpc3QuZmluZCgoaXRlbTogSU1lc3NhZ2VJdGVtKSA9PiBpdGVtLnRyYW5zbGF0ZVkgPT09IHRyYW5zbGF0ZVkpO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgaXRlbS5mb2xkID0gIWl0ZW0uZm9sZDtcbiAgICAgICAgICAgIG1hbmFnZXIudXBkYXRlKHRydWUpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBjcmVhdGVJdGVtKCk6IElNZXNzYWdlSXRlbSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb250ZW50OiBbXSxcbiAgICAgICAgICAgIHJvd3M6IDAsXG4gICAgICAgICAgICBtZXNzYWdlOiAnJyxcbiAgICAgICAgICAgIHR5cGU6ICdsb2cnLFxuICAgICAgICAgICAgdGl0bGU6ICcnLFxuICAgICAgICAgICAgdGV4dHVyZTogJycsXG4gICAgICAgICAgICBjb3VudDogMSxcbiAgICAgICAgICAgIGZvbGQ6IHRydWUsXG4gICAgICAgICAgICBzaG93OiBmYWxzZSxcbiAgICAgICAgICAgIHN0YWNrOiBbXSxcbiAgICAgICAgICAgIHRyYW5zbGF0ZVk6IC0xMDAwLFxuICAgICAgICB9O1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog6K6h566X5omA5pyJ5raI5oGv5YaF5a656auY5bqmXG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBnZXRIZWlnaHQoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGhlaWdodCA9IDA7XG4gICAgICAgIG91dHB1dExpc3QuZm9yRWFjaCgoaXRlbTogSU1lc3NhZ2VJdGVtKSA9PiB7XG4gICAgICAgICAgICBpdGVtLmZvbGQgPyAoaGVpZ2h0ICs9IHRoaXMubGluZUhlaWdodCkgOiAoaGVpZ2h0ICs9IGl0ZW0ucm93cyAqIHRoaXMubGluZUhlaWdodCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gaGVpZ2h0O1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog6I635Y+W5rua5Yqo5L2N572u5a+55bqU55qE5raI5oGvaW5kZXhcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc2Nyb2xsVG9wXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbmVIZWlnaHRcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICAgIGdldFNjcm9sbFBvc2l0aW9uKHNjcm9sbFRvcDogbnVtYmVyLCBsaW5lSGVpZ2h0OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBsZXQgaGVpZ2h0ID0gMDtcbiAgICAgICAgbGV0IGluZGV4ID0gMDtcbiAgICAgICAgb3V0cHV0TGlzdC5zb21lKChpdGVtOiBJTWVzc2FnZUl0ZW0sIGk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgaWYgKGl0ZW0uZm9sZCkge1xuICAgICAgICAgICAgICAgIGhlaWdodCArPSBsaW5lSGVpZ2h0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgKz0gaXRlbS5yb3dzICogbGluZUhlaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChoZWlnaHQgPiBzY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICBpbmRleCA9IGkgLSAxO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGluZGV4LCAwKTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOa4suafk+WPr+ingea2iOaBr+WIl+ihqFxuICAgICAqL1xuICAgIHJlbmRlckxpc3Qobm9TY3JvbGwyYm90dG9tID0gZmFsc2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSZW5kaW5nKSB7XG4gICAgICAgICAgICBpZiAocmVuZGVyTGlzdFRpbWVyKSB7XG4gICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChyZW5kZXJMaXN0VGltZXIpO1xuICAgICAgICAgICAgICAgIHJlbmRlckxpc3RUaW1lciA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZW5kZXJMaXN0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0KG5vU2Nyb2xsMmJvdHRvbSk7XG4gICAgICAgICAgICB9LCAyMDApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaXNSZW5kaW5nID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5nZXRIZWlnaHQoKTtcbiAgICAgICAgdGhpcy53cmFwcGVyU3R5bGUuaGVpZ2h0ID0gYCR7aGVpZ2h0fXB4YDtcblxuICAgICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0O1xuICAgICAgICBjb25zdCBjbGllbnRIZWlnaHQgPSB0aGlzLiRlbC5jbGllbnRIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGl0ZW1Db3VudDogbnVtYmVyID0gTWF0aC5jZWlsKGNsaWVudEhlaWdodCAvIGxpbmVIZWlnaHQpICsgMztcbiAgICAgICAgdGhpcy5zaG93TGlzdC5zcGxpY2UoaXRlbUNvdW50KTtcblxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLiRlbC5zY3JvbGxUb3A7XG5cbiAgICAgICAgY29uc3QgZGVsdGEgPSBvdXRwdXRMaXN0Lmxlbmd0aCAtIHRoaXMuY2FjaGVMaXN0TGVuZ3RoO1xuICAgICAgICBjb25zdCBpc0F0Qm90dG9tID0gaGVpZ2h0IC0gY2xpZW50SGVpZ2h0IC0gc2Nyb2xsVG9wIDw9IGRlbHRhICogbGluZUhlaWdodDtcbiAgICAgICAgdGhpcy5jYWNoZUxpc3RMZW5ndGggPSBvdXRwdXRMaXN0Lmxlbmd0aDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1Db3VudDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zaG93TGlzdFtpXTtcbiAgICAgICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgLy8g6YG/5YWN6Zeq54OBXG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gLTEwMDA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xpc3QucHVzaCh0aGlzLmNyZWF0ZUl0ZW0oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDmnKrmu5rliqjmiJbogIXlnKjlupXpg6jpnIDopoHmu5rliqjliLDlupXpg6ggJiDngrnlh7vlsZXlvIAg5pS26LW35LiN6IO96Ieq5Yqo5rua5Yqo5Yiw5bqV6YOoXG4gICAgICAgIGlmICgoaXNBdEJvdHRvbSB8fCAhaXNPcGVyYXRpbmcpICYmICFub1Njcm9sbDJib3R0b20pIHtcbiAgICAgICAgICAgIC8vIOS4iuS4gOatpeiuvue9ruS6hiBoZWlnaHTvvIzlrp7pmYXov5jmnKrnlJ/mlYjvvIzlnKjmnKrnlJ/mlYjliY3orr7nva4gc2Nyb2xsVG9wIOS8muWksei0pVxuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLiRlbC5zY3JvbGxUb3AgPSBoZWlnaHQgLSB0aGlzLiRlbC5jbGllbnRIZWlnaHQgKyA4OyAvLyBwYWRpbmctYm90dG9tOjhweFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9uU2Nyb2xsKCk7XG4gICAgICAgIHRoaXMuaXNSZW5kaW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmu5rliqjkuovku7ZcbiAgICAgKi9cbiAgICBvblNjcm9sbChldmVudDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoaXNPcGVyYXRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlzT3BlcmF0aW5nID0gdHJ1ZTtcblxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLiRlbC5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IGlzVmVydGljYWxTY3JvbGwgPSBNYXRoLmFicyhzY3JvbGxUb3AgLSBzY3JvbGxUb3BjYWNoZSkgPiAyOy8vIOW/veeVpeaoquWQkea7muWKqOeahOaXtuWAmemAoOaIkOi9u+W+rueahOWeguebtOa7muWKqFxuICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQudGFyZ2V0ICYmIGlzVmVydGljYWxTY3JvbGwpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBldmVudC50YXJnZXQuZ2V0Um9vdE5vZGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHJvb3QuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnR5cGUgPT09ICdSYW5nZScpIHtcbiAgICAgICAgICAgICAgICAvLyDpgb/lhY3lsIYgaW5wdXQg6L6T5YWl55qE55qEIGZvY3VzIOWPlua2iFxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNjcm9sbFRvcGNhY2hlID0gc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0O1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24oc2Nyb2xsVG9wLCBsaW5lSGVpZ2h0KTtcbiAgICAgICAgdGhpcy5saXN0VHJhbnNmb3JtWSA9IG91dHB1dExpc3RbaW5kZXhdPy50cmFuc2xhdGVZID8/IDA7XG5cbiAgICAgICAgLy8g6YGN5Y6G5LiL6KaB5pi+56S655qE5YiX6KGo5YWD57Sg5a+55a2Y5Zyo55qEaXRlbei/m+ihjOaVsOaNruWhq+WFhVxuICAgICAgICB0aGlzLnNob3dMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSwgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvdXRwdXRJdGVtID0gb3V0cHV0TGlzdFtpbmRleCArIGldO1xuICAgICAgICAgICAgaWYgKCFvdXRwdXRJdGVtKSB7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gLTEwMDA7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGl0ZW0uZGF0ZSA9IG91dHB1dEl0ZW0uZGF0ZTtcbiAgICAgICAgICAgICAgICBpdGVtLnR5cGUgPSBvdXRwdXRJdGVtLnR5cGU7XG4gICAgICAgICAgICAgICAgaXRlbS5yb3dzID0gb3V0cHV0SXRlbS5yb3dzO1xuICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUgPSBvdXRwdXRJdGVtLnRpdGxlO1xuICAgICAgICAgICAgICAgIGl0ZW0uY29udGVudCA9IG91dHB1dEl0ZW0uY29udGVudDtcbiAgICAgICAgICAgICAgICBpdGVtLmNvdW50ID0gb3V0cHV0SXRlbS5jb3VudDtcbiAgICAgICAgICAgICAgICBpdGVtLmZvbGQgPSBvdXRwdXRJdGVtLmZvbGQ7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gb3V0cHV0SXRlbS50cmFuc2xhdGVZO1xuICAgICAgICAgICAgICAgIGl0ZW0udGV4dHVyZSA9IChpbmRleCArIGkpICUgMiA9PT0gMCA/ICdkYXJrJyA6ICdsaWdodCc7XG4gICAgICAgICAgICAgICAgaXRlbS5zdGFjayA9IG91dHB1dEl0ZW0uc3RhY2s7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXNPcGVyYXRpbmcgPSBmYWxzZTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOaYvuekuuWkjeWItuiPnOWNlVxuICAgICAqIEBwYXJhbSB7Kn0gZXZlbnRcbiAgICAgKiBAcGFyYW0geyp9IGl0ZW1cbiAgICAgKi9cbiAgICBzaG93TWVudVBhc3QoZXZlbnQ6IGFueSwgaXRlbTogYW55KSB7XG4gICAgICAgIGxldCBpbmZvID0gaXRlbS50aXRsZTtcbiAgICAgICAgaWYgKGl0ZW0ucm93cyA+IDEpIHtcbiAgICAgICAgICAgIGl0ZW0uY29udGVudC5mb3JFYWNoKChzdHI6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIGluZm8gKz0gYCR7c3RyfSBcXG5gO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpdGVtLnN0YWNrPy5mb3JFYWNoPy4oKHN0cjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgaW5mbyArPSBgJHtzdHJ9IFxcbmA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBFZGl0b3IuTWVudS5wb3B1cCh7XG4gICAgICAgICAgICB4OiBldmVudC5wYWdlWCxcbiAgICAgICAgICAgIHk6IGV2ZW50LnBhZ2VZLFxuICAgICAgICAgICAgbWVudTogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2NvbnNvbGUuY29weScpLFxuICAgICAgICAgICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIEVkaXRvci5DbGlwYm9hcmQud3JpdGUoJ3RleHQnLCBpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmoLzlvI/ljJYgdGV4dCDph4zpnaLlj6/og73mnInnmoTohJrmnKzot6/lvoRcbiAgICAgKiDpnIDopoHpq5jkuq7ot6/lvoRcbiAgICAgKiBAcGFyYW0gdGV4dFxuICAgICAqL1xuICAgIHJlbmRlclRleHQodGV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDovazkuYkgaHRtbCDmoIfnrb7nmoTlsJbmi6zlj7dcbiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKTtcblxuICAgICAgICAvLyB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cXCgoZmlsZTpcXC9cXC9cXC9bXildKylcXCkvZywgKG1hdGNoZXIsIHAxKSA9PiB7XG4gICAgICAgIC8vICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aChwMSk7XG4gICAgICAgIC8vICAgICByZXR1cm4gYHtsaW5rWyR7cGF0aH1dKCR7cGF0aH0pfWA7XG4gICAgICAgIC8vIH0pO1xuICAgICAgICB0ZXh0ID0gcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rKHRleHQpO1xuXG4gICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1xceyhbXFx3XSspKD86XFxbKFteW10qKVxcXSk/KD86XFwoKFteKCldKilcXCkpXFx9L2dpLCAobWF0Y2hlciwgdHlwZSwgdGV4dCwgdXJsKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsb3dlclR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICBpZiAocmVuZGVyVHlwZXNbbG93ZXJUeXBlXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZW5kZXJUeXBlc1tsb3dlclR5cGVdKHRleHQsIHVybCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBtYXRjaGVyO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICog54K55Ye75paH5pys55qE5pe25YCZ6Kem5Y+RXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgb25UZXh0Q2xpY2soZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIWV2ZW50LnRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdidWJibGUnKSA9PT0gbnVsbCAmJiB0aGlzLiRlbCAhPT0gZXZlbnQudGFyZ2V0KSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzmnInpgInkuK3vvIzkuI3op6blj5Hmipjlj6Av5bGV5byAXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGV2ZW50LnRhcmdldC5nZXRSb290Tm9kZSgpLmdldFNlbGVjdGlvbigpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5iYXNlT2Zmc2V0ICE9PSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19