'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
// 维护一份渲染的类型列表
const renderTypes = {
    link(text, url) {
        url = url.replace(/:\d+/g, '');
        return `<ui-link value="${url}">${text || url}</ui-link>`;
    },
    asset(text, url) {
        const type = url.startsWith('db://') ? 'assetUrl' : 'assetUuid';
        return `<ui-link type="${type}" value="${url}">${text || url}</ui-link>`;
    },
    node(text, uuid) {
        return `<ui-link type="nodeUuid" value="${uuid}">${text || uuid}</ui-link>`;
    },
    image(text, url) {
        return `
        <ui-link value="${url}">
            <ui-image value="${url}" max-height>${text || url}</ui-image>
        </ui-link>
        `;
    },
    i18n(text, key) {
        return Editor.I18n.t(key);
    },
    hidden() {
        return '';
    },
};
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update(true);
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList(noScroll2bottom = false) {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList(noScroll2bottom);
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部 & 点击展开 收起不能自动滚动到底部
        if ((isAtBottom || !isOperating) && !noScroll2bottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - this.$el.clientHeight;
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            if (selection.type === 'Range') {
                // 避免将 input 输入的的 focus 取消
                selection.removeAllRanges();
            }
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        let info = item.title;
        if (item.rows > 1) {
            item.content.forEach((str) => {
                info += `${str} \n`;
            });
            item.stack?.forEach?.((str) => {
                info += `${str} \n`;
            });
        }
        Editor.Menu.popup({
            x: event.pageX,
            y: event.pageY,
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
        //     const path = fileURLToPath(p1);
        //     return `{link[${path}](${path})}`;
        // });
        text = utils_1.replaceHttpAndLocalPath2UILink(text);
        text = text.replace(/\{([\w]+)(?:\[([^[]*)\])?(?:\(([^()]*)\))\}/gi, (matcher, type, text, url) => {
            const lowerType = type.toLowerCase();
            if (renderTypes[lowerType]) {
                return renderTypes[lowerType](text, url);
            }
            return matcher;
        });
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBRTVCLG9DQUEwRDtBQUUxRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQWtCLElBQUksQ0FBQztBQUMxQyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7QUFFNUMsY0FBYztBQUNkLE1BQU0sV0FBVyxHQUFRO0lBQ3JCLElBQUksQ0FBQyxJQUFZLEVBQUUsR0FBVztRQUMxQixHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0IsT0FBTyxtQkFBbUIsR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLFlBQVksQ0FBQztJQUM5RCxDQUFDO0lBQ0QsS0FBSyxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzNCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO1FBQ2hFLE9BQU8sa0JBQWtCLElBQUksWUFBWSxHQUFHLEtBQUssSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDO0lBQzdFLENBQUM7SUFDRCxJQUFJLENBQUMsSUFBWSxFQUFFLElBQVk7UUFDM0IsT0FBTyxtQ0FBbUMsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLFlBQVksQ0FBQztJQUNoRixDQUFDO0lBQ0QsS0FBSyxDQUFDLElBQVksRUFBRSxHQUFXO1FBQzNCLE9BQU87MEJBQ1csR0FBRzsrQkFD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J3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBJTWVzc2FnZUl0ZW0gfSBmcm9tICcuLi8uLi9AdHlwZXMvcHJpdGF0ZSc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IHJlcGxhY2VIdHRwQW5kTG9jYWxQYXRoMlVJTGluayB9IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgbWFuYWdlciA9IHJlcXVpcmUoJy4uL21hbmFnZXInKTtcbmNvbnN0IG91dHB1dExpc3QgPSBtYW5hZ2VyLm91dHB1dExpc3Q7XG5sZXQgaXNPcGVyYXRpbmcgPSBmYWxzZTtcbmxldCByZW5kZXJMaXN0VGltZXI6IG51bWJlciB8IG51bGwgPSBudWxsO1xubGV0IHNjcm9sbFRvcGNhY2hlID0gMDsgLy8g55So5LqO5Yik5pat5b2T5YmN5piv5qiq5ZCR5rua5Yqo6L+Y5piv5Z6C55u05rua5YqoXG5cbi8vIOe7tOaKpOS4gOS7vea4suafk+eahOexu+Wei+WIl+ihqFxuY29uc3QgcmVuZGVyVHlwZXM6IGFueSA9IHtcbiAgICBsaW5rKHRleHQ6IHN0cmluZywgdXJsOiBzdHJpbmcpIHtcbiAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoLzpcXGQrL2csICcnKTtcbiAgICAgICAgcmV0dXJuIGA8dWktbGluayB2YWx1ZT1cIiR7dXJsfVwiPiR7dGV4dCB8fCB1cmx9PC91aS1saW5rPmA7XG4gICAgfSxcbiAgICBhc3NldCh0ZXh0OiBzdHJpbmcsIHVybDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSB1cmwuc3RhcnRzV2l0aCgnZGI6Ly8nKSA/ICdhc3NldFVybCcgOiAnYXNzZXRVdWlkJztcbiAgICAgICAgcmV0dXJuIGA8dWktbGluayB0eXBlPVwiJHt0eXBlfVwiIHZhbHVlPVwiJHt1cmx9XCI+JHt0ZXh0IHx8IHVybH08L3VpLWxpbms+YDtcbiAgICB9LFxuICAgIG5vZGUodGV4dDogc3RyaW5nLCB1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGA8dWktbGluayB0eXBlPVwibm9kZVV1aWRcIiB2YWx1ZT1cIiR7dXVpZH1cIj4ke3RleHQgfHwgdXVpZH08L3VpLWxpbms+YDtcbiAgICB9LFxuICAgIGltYWdlKHRleHQ6IHN0cmluZywgdXJsOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGBcbiAgICAgICAgPHVpLWxpbmsgdmFsdWU9XCIke3VybH1cIj5cbiAgICAgICAgICAgIDx1aS1pbWFnZSB2YWx1ZT1cIiR7dXJsfVwiIG1heC1oZWlnaHQ+JHt0ZXh0IHx8IHVybH08L3VpLWltYWdlPlxuICAgICAgICA8L3VpLWxpbms+XG4gICAgICAgIGA7XG4gICAgfSxcbiAgICBpMThuKHRleHQ6IHN0cmluZywga2V5OiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIEVkaXRvci5JMThuLnQoa2V5KTtcbiAgICB9LFxuICAgIGhpZGRlbigpIHtcbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgdGVtcGxhdGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWMnLCAnL3RlbXBsYXRlL2xpc3QuaHRtbCcpLCAndXRmOCcpO1xuXG5leHBvcnQgY29uc3QgbmFtZSA9ICdjb25zb2xlLWxpc3QnO1xuXG5leHBvcnQgY29uc3QgcHJvcHMgPSB7XG4gICAgZm9udFNpemU6IHsgdHlwZTogTnVtYmVyIH0sXG4gICAgbGluZUhlaWdodDogeyB0eXBlOiBOdW1iZXIgfSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICAgIHRpbWVyOiBudWxsLFxuICAgICAgICBjYWNoZUxpc3RMZW5ndGg6IDAsXG4gICAgICAgIHNob3dMaXN0OiBbXSxcbiAgICAgICAgd3JhcHBlclN0eWxlOiB7IGhlaWdodDogMCB9LFxuICAgICAgICBpc1JlbmRpbmc6IGZhbHNlLFxuICAgICAgICBsaXN0VHJhbnNmb3JtWTogMCxcbiAgICAgICAgcmVwbGFjZVRleHRUaW1lcjogbnVsbCxcbiAgICB9O1xufVxuXG5leHBvcnQgY29uc3QgY29tcHV0ZWQ6IGFueSA9IHtcbiAgICBsaXN0U3R5bGUoKSB7XG4gICAgICAgIGNvbnN0IHsgbGlzdFRyYW5zZm9ybVksIGZvbnRTaXplLCBsaW5lSGVpZ2h0IH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGB0cmFuc2xhdGVZKCR7bGlzdFRyYW5zZm9ybVl9cHgpYCxcbiAgICAgICAgICAgICctLWZvbnQtc2l6ZSc6IGAke2ZvbnRTaXplfXB4YCxcbiAgICAgICAgICAgICctLWxpbmUtaGVpZ2h0JzogYCR7bGluZUhlaWdodH1weGAsXG4gICAgICAgIH07XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCB3YXRjaDogYW55ID0ge1xuICAgIGxpbmVIZWlnaHQodmFsOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0KCk7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IG1ldGhvZHM6IGFueSA9IHtcbiAgICAvKipcbiAgICAgKiDliIfmjaLmtojmga/lhbfkvZPlhoXlrrnmmL7npLpcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWVxuICAgICAqL1xuICAgIHRvZ2dsZUNvbnRlbnQodHJhbnNsYXRlWTogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBvdXRwdXRMaXN0LmZpbmQoKGl0ZW06IElNZXNzYWdlSXRlbSkgPT4gaXRlbS50cmFuc2xhdGVZID09PSB0cmFuc2xhdGVZKTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW0uZm9sZCA9ICFpdGVtLmZvbGQ7XG4gICAgICAgICAgICBtYW5hZ2VyLnVwZGF0ZSh0cnVlKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgY3JlYXRlSXRlbSgpOiBJTWVzc2FnZUl0ZW0ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVudDogW10sXG4gICAgICAgICAgICByb3dzOiAwLFxuICAgICAgICAgICAgbWVzc2FnZTogJycsXG4gICAgICAgICAgICB0eXBlOiAnbG9nJyxcbiAgICAgICAgICAgIHRpdGxlOiAnJyxcbiAgICAgICAgICAgIHRleHR1cmU6ICcnLFxuICAgICAgICAgICAgY291bnQ6IDEsXG4gICAgICAgICAgICBmb2xkOiB0cnVlLFxuICAgICAgICAgICAgc2hvdzogZmFsc2UsXG4gICAgICAgICAgICBzdGFjazogW10sXG4gICAgICAgICAgICB0cmFuc2xhdGVZOiAtMTAwMCxcbiAgICAgICAgfTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiuoeeul+aJgOaciea2iOaBr+WGheWuuemrmOW6plxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0SGVpZ2h0KCk6IG51bWJlciB7XG4gICAgICAgIGxldCBoZWlnaHQgPSAwO1xuICAgICAgICBvdXRwdXRMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSkgPT4ge1xuICAgICAgICAgICAgaXRlbS5mb2xkID8gKGhlaWdodCArPSB0aGlzLmxpbmVIZWlnaHQpIDogKGhlaWdodCArPSBpdGVtLnJvd3MgKiB0aGlzLmxpbmVIZWlnaHQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGhlaWdodDtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiOt+WPlua7muWKqOS9jee9ruWvueW6lOeahOa2iOaBr2luZGV4XG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHNjcm9sbFRvcFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lSGVpZ2h0XG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBnZXRTY3JvbGxQb3NpdGlvbihzY3JvbGxUb3A6IG51bWJlciwgbGluZUhlaWdodDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGhlaWdodCA9IDA7XG4gICAgICAgIGxldCBpbmRleCA9IDA7XG4gICAgICAgIG91dHB1dExpc3Quc29tZSgoaXRlbTogSU1lc3NhZ2VJdGVtLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLmZvbGQpIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgKz0gbGluZUhlaWdodDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ICs9IGl0ZW0ucm93cyAqIGxpbmVIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaGVpZ2h0ID4gc2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgaW5kZXggPSBpIC0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBNYXRoLm1heChpbmRleCwgMCk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmuLLmn5Plj6/op4Hmtojmga/liJfooahcbiAgICAgKi9cbiAgICByZW5kZXJMaXN0KG5vU2Nyb2xsMmJvdHRvbSA9IGZhbHNlKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzUmVuZGluZykge1xuICAgICAgICAgICAgaWYgKHJlbmRlckxpc3RUaW1lcikge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQocmVuZGVyTGlzdFRpbWVyKTtcbiAgICAgICAgICAgICAgICByZW5kZXJMaXN0VGltZXIgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVuZGVyTGlzdFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdChub1Njcm9sbDJib3R0b20pO1xuICAgICAgICAgICAgfSwgMjAwKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzUmVuZGluZyA9IHRydWU7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuZ2V0SGVpZ2h0KCk7XG4gICAgICAgIHRoaXMud3JhcHBlclN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG5cbiAgICAgICAgY29uc3QgbGluZUhlaWdodCA9IHRoaXMubGluZUhlaWdodDtcbiAgICAgICAgY29uc3QgY2xpZW50SGVpZ2h0ID0gdGhpcy4kZWwuY2xpZW50SGVpZ2h0O1xuICAgICAgICBjb25zdCBpdGVtQ291bnQ6IG51bWJlciA9IE1hdGguY2VpbChjbGllbnRIZWlnaHQgLyBsaW5lSGVpZ2h0KSArIDM7XG4gICAgICAgIHRoaXMuc2hvd0xpc3Quc3BsaWNlKGl0ZW1Db3VudCk7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy4kZWwuc2Nyb2xsVG9wO1xuXG4gICAgICAgIGNvbnN0IGRlbHRhID0gb3V0cHV0TGlzdC5sZW5ndGggLSB0aGlzLmNhY2hlTGlzdExlbmd0aDtcbiAgICAgICAgY29uc3QgaXNBdEJvdHRvbSA9IGhlaWdodCAtIGNsaWVudEhlaWdodCAtIHNjcm9sbFRvcCA8PSBkZWx0YSAqIGxpbmVIZWlnaHQ7XG4gICAgICAgIHRoaXMuY2FjaGVMaXN0TGVuZ3RoID0gb3V0cHV0TGlzdC5sZW5ndGg7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuc2hvd0xpc3RbaV07XG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIC8vIOmBv+WFjemXqueDgVxuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IC0xMDAwO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dMaXN0LnB1c2godGhpcy5jcmVhdGVJdGVtKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8g5pyq5rua5Yqo5oiW6ICF5Zyo5bqV6YOo6ZyA6KaB5rua5Yqo5Yiw5bqV6YOoICYg54K55Ye75bGV5byAIOaUtui1t+S4jeiDveiHquWKqOa7muWKqOWIsOW6lemDqFxuICAgICAgICBpZiAoKGlzQXRCb3R0b20gfHwgIWlzT3BlcmF0aW5nKSAmJiAhbm9TY3JvbGwyYm90dG9tKSB7XG4gICAgICAgICAgICAvLyDkuIrkuIDmraXorr7nva7kuoYgaGVpZ2h077yM5a6e6ZmF6L+Y5pyq55Sf5pWI77yM5Zyo5pyq55Sf5pWI5YmN6K6+572uIHNjcm9sbFRvcCDkvJrlpLHotKVcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kZWwuc2Nyb2xsVG9wID0gaGVpZ2h0IC0gdGhpcy4kZWwuY2xpZW50SGVpZ2h0O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9uU2Nyb2xsKCk7XG4gICAgICAgIHRoaXMuaXNSZW5kaW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmu5rliqjkuovku7ZcbiAgICAgKi9cbiAgICBvblNjcm9sbChldmVudDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoaXNPcGVyYXRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlzT3BlcmF0aW5nID0gdHJ1ZTtcblxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLiRlbC5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IGlzVmVydGljYWxTY3JvbGwgPSBNYXRoLmFicyhzY3JvbGxUb3AgLSBzY3JvbGxUb3BjYWNoZSkgPiAyOy8vIOW/veeVpeaoquWQkea7muWKqOeahOaXtuWAmemAoOaIkOi9u+W+rueahOWeguebtOa7muWKqFxuICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQudGFyZ2V0ICYmIGlzVmVydGljYWxTY3JvbGwpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBldmVudC50YXJnZXQuZ2V0Um9vdE5vZGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHJvb3QuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnR5cGUgPT09ICdSYW5nZScpIHtcbiAgICAgICAgICAgICAgICAvLyDpgb/lhY3lsIYgaW5wdXQg6L6T5YWl55qE55qEIGZvY3VzIOWPlua2iFxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNjcm9sbFRvcGNhY2hlID0gc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0O1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24oc2Nyb2xsVG9wLCBsaW5lSGVpZ2h0KTtcbiAgICAgICAgdGhpcy5saXN0VHJhbnNmb3JtWSA9IG91dHB1dExpc3RbaW5kZXhdPy50cmFuc2xhdGVZID8/IDA7XG5cbiAgICAgICAgLy8g6YGN5Y6G5LiL6KaB5pi+56S655qE5YiX6KGo5YWD57Sg5a+55a2Y5Zyo55qEaXRlbei/m+ihjOaVsOaNruWhq+WFhVxuICAgICAgICB0aGlzLnNob3dMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSwgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvdXRwdXRJdGVtID0gb3V0cHV0TGlzdFtpbmRleCArIGldO1xuICAgICAgICAgICAgaWYgKCFvdXRwdXRJdGVtKSB7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gLTEwMDA7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGl0ZW0uZGF0ZSA9IG91dHB1dEl0ZW0uZGF0ZTtcbiAgICAgICAgICAgICAgICBpdGVtLnR5cGUgPSBvdXRwdXRJdGVtLnR5cGU7XG4gICAgICAgICAgICAgICAgaXRlbS5yb3dzID0gb3V0cHV0SXRlbS5yb3dzO1xuICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUgPSBvdXRwdXRJdGVtLnRpdGxlO1xuICAgICAgICAgICAgICAgIGl0ZW0uY29udGVudCA9IG91dHB1dEl0ZW0uY29udGVudDtcbiAgICAgICAgICAgICAgICBpdGVtLmNvdW50ID0gb3V0cHV0SXRlbS5jb3VudDtcbiAgICAgICAgICAgICAgICBpdGVtLmZvbGQgPSBvdXRwdXRJdGVtLmZvbGQ7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gb3V0cHV0SXRlbS50cmFuc2xhdGVZO1xuICAgICAgICAgICAgICAgIGl0ZW0udGV4dHVyZSA9IChpbmRleCArIGkpICUgMiA9PT0gMCA/ICdkYXJrJyA6ICdsaWdodCc7XG4gICAgICAgICAgICAgICAgaXRlbS5zdGFjayA9IG91dHB1dEl0ZW0uc3RhY2s7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXNPcGVyYXRpbmcgPSBmYWxzZTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOaYvuekuuWkjeWItuiPnOWNlVxuICAgICAqIEBwYXJhbSB7Kn0gZXZlbnRcbiAgICAgKiBAcGFyYW0geyp9IGl0ZW1cbiAgICAgKi9cbiAgICBzaG93TWVudVBhc3QoZXZlbnQ6IGFueSwgaXRlbTogYW55KSB7XG4gICAgICAgIGxldCBpbmZvID0gaXRlbS50aXRsZTtcbiAgICAgICAgaWYgKGl0ZW0ucm93cyA+IDEpIHtcbiAgICAgICAgICAgIGl0ZW0uY29udGVudC5mb3JFYWNoKChzdHI6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIGluZm8gKz0gYCR7c3RyfSBcXG5gO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpdGVtLnN0YWNrPy5mb3JFYWNoPy4oKHN0cjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgaW5mbyArPSBgJHtzdHJ9IFxcbmA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBFZGl0b3IuTWVudS5wb3B1cCh7XG4gICAgICAgICAgICB4OiBldmVudC5wYWdlWCxcbiAgICAgICAgICAgIHk6IGV2ZW50LnBhZ2VZLFxuICAgICAgICAgICAgbWVudTogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2NvbnNvbGUuY29weScpLFxuICAgICAgICAgICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIEVkaXRvci5DbGlwYm9hcmQud3JpdGUoJ3RleHQnLCBpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmoLzlvI/ljJYgdGV4dCDph4zpnaLlj6/og73mnInnmoTohJrmnKzot6/lvoRcbiAgICAgKiDpnIDopoHpq5jkuq7ot6/lvoRcbiAgICAgKiBAcGFyYW0gdGV4dFxuICAgICAqL1xuICAgIHJlbmRlclRleHQodGV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDovazkuYkgaHRtbCDmoIfnrb7nmoTlsJbmi6zlj7dcbiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKTtcblxuICAgICAgICAvLyB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cXCgoZmlsZTpcXC9cXC9cXC9bXildKylcXCkvZywgKG1hdGNoZXIsIHAxKSA9PiB7XG4gICAgICAgIC8vICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aChwMSk7XG4gICAgICAgIC8vICAgICByZXR1cm4gYHtsaW5rWyR7cGF0aH1dKCR7cGF0aH0pfWA7XG4gICAgICAgIC8vIH0pO1xuICAgICAgICB0ZXh0ID0gcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rKHRleHQpO1xuXG4gICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1xceyhbXFx3XSspKD86XFxbKFteW10qKVxcXSk/KD86XFwoKFteKCldKilcXCkpXFx9L2dpLCAobWF0Y2hlciwgdHlwZSwgdGV4dCwgdXJsKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsb3dlclR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICBpZiAocmVuZGVyVHlwZXNbbG93ZXJUeXBlXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZW5kZXJUeXBlc1tsb3dlclR5cGVdKHRleHQsIHVybCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBtYXRjaGVyO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICog54K55Ye75paH5pys55qE5pe25YCZ6Kem5Y+RXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgb25UZXh0Q2xpY2soZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIWV2ZW50LnRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdidWJibGUnKSA9PT0gbnVsbCAmJiB0aGlzLiRlbCAhPT0gZXZlbnQudGFyZ2V0KSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzmnInpgInkuK3vvIzkuI3op6blj5Hmipjlj6Av5bGV5byAXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGV2ZW50LnRhcmdldC5nZXRSb290Tm9kZSgpLmdldFNlbGVjdGlvbigpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5iYXNlT2Zmc2V0ICE9PSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19