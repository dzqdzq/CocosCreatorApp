'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
exports.template = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update(true);
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList(noScroll2bottom = false) {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList(noScroll2bottom);
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部 & 点击展开 收起不能自动滚动到底部
        // 如果当前不是在底部，用户可能需要复制日志或者点击 ui-link 等，自动滚动到底部会影响用户的操作，所以需要禁止。
        if (isAtBottom && !isOperating && !noScroll2bottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - this.$el.clientHeight + 8; // pading-bottom:8px
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            if (selection.type === 'Range') {
                // 避免将 input 输入的的 focus 取消
                selection.removeAllRanges();
            }
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        event.preventDefault();
        let info = '';
        const selection = document.getSelection();
        if (selection?.type === 'Range') {
            info = selection.toString();
        }
        else {
            info += `${item.title} \n`;
            if (item.rows > 1) {
                item.content.forEach((str) => {
                    info += `${str} \n`;
                });
                item.stack?.forEach?.((str) => {
                    info += `${str} \n`;
                });
            }
        }
        Editor.Menu.popup({
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
        //     const path = fileURLToPath(p1);
        //     return `{link[${path}](${path})}`;
        // });
        text = (0, utils_1.replaceHttpAndLocalPath2UILink)(text);
        text = (0, utils_1.transformText)(text);
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBQzVCLG9DQUF5RTtBQUV6RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQWtCLElBQUksQ0FBQztBQUMxQyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7QUFFL0IsUUFBQSxRQUFRLEdBQUcsSUFBQSxpQkFBWSxFQUFDLElBQUEsV0FBSSxFQUFDLFNBQVMsRUFBRSxjQUFjLEVBQUUscUJBQXFCLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUV4RixRQUFBLElBQUksR0FBRyxjQUFjLENBQUM7QUFFdEIsUUFBQSxLQUFLLEdBQUc7SUFDakIsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtJQUMxQixVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0NBQy9CLENBQUM7QUFFRixTQUFnQixJQUFJO0lBQ2hCLE9BQU87UUFDSCxLQUFLLEVBQUUsSUFBSTtRQUNYLGVBQWUsRUFBRSxDQUFDO1FBQ2xCLFFBQVEsRUFBRSxFQUFFO1FBQ1osWUFBWSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRTtRQUMzQixTQUFTLEVBQUUsS0FBSztRQUNoQixjQUFjLEVBQUUsQ0FBQztRQUNqQixnQkFBZ0IsRUFBRSxJQUFJO0tBQ3pCLENBQUM7QUFDTixDQUFDO0FBVkQsb0JBVUM7QUFFWSxRQUFBLFFBQVEsR0FBUTtJQUN6QixTQUFTO1FBQ0wsTUFBTSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVB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V0FBVyxFQUFFO1lBQzdELEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN4QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDMUI7SUFDTCxDQUFDO0NBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgSU1lc3NhZ2VJdGVtIH0gZnJvbSAnLi4vLi4vQHR5cGVzL3ByaXZhdGUnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rLCB0cmFuc2Zvcm1UZXh0IH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBtYW5hZ2VyID0gcmVxdWlyZSgnLi4vbWFuYWdlcicpO1xuY29uc3Qgb3V0cHV0TGlzdCA9IG1hbmFnZXIub3V0cHV0TGlzdDtcbmxldCBpc09wZXJhdGluZyA9IGZhbHNlO1xubGV0IHJlbmRlckxpc3RUaW1lcjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5sZXQgc2Nyb2xsVG9wY2FjaGUgPSAwOyAvLyDnlKjkuo7liKTmlq3lvZPliY3mmK/mqKrlkJHmu5rliqjov5jmmK/lnoLnm7Tmu5rliqhcblxuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi4vLi4vc3RhdGljJywgJy90ZW1wbGF0ZS9saXN0Lmh0bWwnKSwgJ3V0ZjgnKTtcblxuZXhwb3J0IGNvbnN0IG5hbWUgPSAnY29uc29sZS1saXN0JztcblxuZXhwb3J0IGNvbnN0IHByb3BzID0ge1xuICAgIGZvbnRTaXplOiB7IHR5cGU6IE51bWJlciB9LFxuICAgIGxpbmVIZWlnaHQ6IHsgdHlwZTogTnVtYmVyIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB0aW1lcjogbnVsbCxcbiAgICAgICAgY2FjaGVMaXN0TGVuZ3RoOiAwLFxuICAgICAgICBzaG93TGlzdDogW10sXG4gICAgICAgIHdyYXBwZXJTdHlsZTogeyBoZWlnaHQ6IDAgfSxcbiAgICAgICAgaXNSZW5kaW5nOiBmYWxzZSxcbiAgICAgICAgbGlzdFRyYW5zZm9ybVk6IDAsXG4gICAgICAgIHJlcGxhY2VUZXh0VGltZXI6IG51bGwsXG4gICAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGNvbXB1dGVkOiBhbnkgPSB7XG4gICAgbGlzdFN0eWxlKCkge1xuICAgICAgICBjb25zdCB7IGxpc3RUcmFuc2Zvcm1ZLCBmb250U2l6ZSwgbGluZUhlaWdodCB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiBgdHJhbnNsYXRlWSgke2xpc3RUcmFuc2Zvcm1ZfXB4KWAsXG4gICAgICAgICAgICAnLS1mb250LXNpemUnOiBgJHtmb250U2l6ZX1weGAsXG4gICAgICAgICAgICAnLS1saW5lLWhlaWdodCc6IGAke2xpbmVIZWlnaHR9cHhgLFxuICAgICAgICB9O1xuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3Qgd2F0Y2g6IGFueSA9IHtcbiAgICBsaW5lSGVpZ2h0KHZhbDogbnVtYmVyKSB7XG4gICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdCgpO1xuICAgICAgICB9XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBtZXRob2RzOiBhbnkgPSB7XG4gICAgLyoqXG4gICAgICog5YiH5o2i5raI5oGv5YW35L2T5YaF5a655pi+56S6XG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHRyYW5zbGF0ZVlcbiAgICAgKi9cbiAgICB0b2dnbGVDb250ZW50KHRyYW5zbGF0ZVk6IG51bWJlcikge1xuICAgICAgICBjb25zdCBpdGVtID0gb3V0cHV0TGlzdC5maW5kKChpdGVtOiBJTWVzc2FnZUl0ZW0pID0+IGl0ZW0udHJhbnNsYXRlWSA9PT0gdHJhbnNsYXRlWSk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICBpdGVtLmZvbGQgPSAhaXRlbS5mb2xkO1xuICAgICAgICAgICAgbWFuYWdlci51cGRhdGUodHJ1ZSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGNyZWF0ZUl0ZW0oKTogSU1lc3NhZ2VJdGVtIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbnRlbnQ6IFtdLFxuICAgICAgICAgICAgcm93czogMCxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICcnLFxuICAgICAgICAgICAgdHlwZTogJ2xvZycsXG4gICAgICAgICAgICB0aXRsZTogJycsXG4gICAgICAgICAgICB0ZXh0dXJlOiAnJyxcbiAgICAgICAgICAgIGNvdW50OiAxLFxuICAgICAgICAgICAgZm9sZDogdHJ1ZSxcbiAgICAgICAgICAgIHNob3c6IGZhbHNlLFxuICAgICAgICAgICAgc3RhY2s6IFtdLFxuICAgICAgICAgICAgdHJhbnNsYXRlWTogLTEwMDAsXG4gICAgICAgIH07XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDorqHnrpfmiYDmnInmtojmga/lhoXlrrnpq5jluqZcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICAgIGdldEhlaWdodCgpOiBudW1iZXIge1xuICAgICAgICBsZXQgaGVpZ2h0ID0gMDtcbiAgICAgICAgb3V0cHV0TGlzdC5mb3JFYWNoKChpdGVtOiBJTWVzc2FnZUl0ZW0pID0+IHtcbiAgICAgICAgICAgIGl0ZW0uZm9sZCA/IChoZWlnaHQgKz0gdGhpcy5saW5lSGVpZ2h0KSA6IChoZWlnaHQgKz0gaXRlbS5yb3dzICogdGhpcy5saW5lSGVpZ2h0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBoZWlnaHQ7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDojrflj5bmu5rliqjkvY3nva7lr7nlupTnmoTmtojmga9pbmRleFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzY3JvbGxUb3BcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGluZUhlaWdodFxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0U2Nyb2xsUG9zaXRpb24oc2Nyb2xsVG9wOiBudW1iZXIsIGxpbmVIZWlnaHQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgICAgIGxldCBoZWlnaHQgPSAwO1xuICAgICAgICBsZXQgaW5kZXggPSAwO1xuICAgICAgICBvdXRwdXRMaXN0LnNvbWUoKGl0ZW06IElNZXNzYWdlSXRlbSwgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBpZiAoaXRlbS5mb2xkKSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ICs9IGxpbmVIZWlnaHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhlaWdodCArPSBpdGVtLnJvd3MgKiBsaW5lSGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGhlaWdodCA+IHNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgIGluZGV4ID0gaSAtIDE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gTWF0aC5tYXgoaW5kZXgsIDApO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5riy5p+T5Y+v6KeB5raI5oGv5YiX6KGoXG4gICAgICovXG4gICAgcmVuZGVyTGlzdChub1Njcm9sbDJib3R0b20gPSBmYWxzZSk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pc1JlbmRpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZW5kZXJMaXN0VGltZXIpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHJlbmRlckxpc3RUaW1lcik7XG4gICAgICAgICAgICAgICAgcmVuZGVyTGlzdFRpbWVyID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlbmRlckxpc3RUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckxpc3Qobm9TY3JvbGwyYm90dG9tKTtcbiAgICAgICAgICAgIH0sIDIwMCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc1JlbmRpbmcgPSB0cnVlO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmdldEhlaWdodCgpO1xuICAgICAgICB0aGlzLndyYXBwZXJTdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xuXG4gICAgICAgIGNvbnN0IGxpbmVIZWlnaHQgPSB0aGlzLmxpbmVIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGNsaWVudEhlaWdodCA9IHRoaXMuJGVsLmNsaWVudEhlaWdodDtcbiAgICAgICAgY29uc3QgaXRlbUNvdW50OiBudW1iZXIgPSBNYXRoLmNlaWwoY2xpZW50SGVpZ2h0IC8gbGluZUhlaWdodCkgKyAzO1xuICAgICAgICB0aGlzLnNob3dMaXN0LnNwbGljZShpdGVtQ291bnQpO1xuXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IHRoaXMuJGVsLnNjcm9sbFRvcDtcblxuICAgICAgICBjb25zdCBkZWx0YSA9IG91dHB1dExpc3QubGVuZ3RoIC0gdGhpcy5jYWNoZUxpc3RMZW5ndGg7XG4gICAgICAgIGNvbnN0IGlzQXRCb3R0b20gPSBoZWlnaHQgLSBjbGllbnRIZWlnaHQgLSBzY3JvbGxUb3AgPD0gZGVsdGEgKiBsaW5lSGVpZ2h0O1xuICAgICAgICB0aGlzLmNhY2hlTGlzdExlbmd0aCA9IG91dHB1dExpc3QubGVuZ3RoO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbUNvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnNob3dMaXN0W2ldO1xuICAgICAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAvLyDpgb/lhY3pl6rng4FcbiAgICAgICAgICAgICAgICBpdGVtLnNob3cgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpdGVtLnRyYW5zbGF0ZVkgPSAtMTAwMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TGlzdC5wdXNoKHRoaXMuY3JlYXRlSXRlbSgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOacqua7muWKqOaIluiAheWcqOW6lemDqOmcgOimgea7muWKqOWIsOW6lemDqCAmIOeCueWHu+WxleW8gCDmlLbotbfkuI3og73oh6rliqjmu5rliqjliLDlupXpg6hcbiAgICAgICAgLy8g5aaC5p6c5b2T5YmN5LiN5piv5Zyo5bqV6YOo77yM55So5oi35Y+v6IO96ZyA6KaB5aSN5Yi25pel5b+X5oiW6ICF54K55Ye7IHVpLWxpbmsg562J77yM6Ieq5Yqo5rua5Yqo5Yiw5bqV6YOo5Lya5b2x5ZON55So5oi355qE5pON5L2c77yM5omA5Lul6ZyA6KaB56aB5q2i44CCXG4gICAgICAgIGlmIChpc0F0Qm90dG9tICYmICFpc09wZXJhdGluZyAmJiAhbm9TY3JvbGwyYm90dG9tKSB7XG4gICAgICAgICAgICAvLyDkuIrkuIDmraXorr7nva7kuoYgaGVpZ2h077yM5a6e6ZmF6L+Y5pyq55Sf5pWI77yM5Zyo5pyq55Sf5pWI5YmN6K6+572uIHNjcm9sbFRvcCDkvJrlpLHotKVcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kZWwuc2Nyb2xsVG9wID0gaGVpZ2h0IC0gdGhpcy4kZWwuY2xpZW50SGVpZ2h0ICsgODsgLy8gcGFkaW5nLWJvdHRvbTo4cHhcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5vblNjcm9sbCgpO1xuICAgICAgICB0aGlzLmlzUmVuZGluZyA9IGZhbHNlO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5rua5Yqo5LqL5Lu2XG4gICAgICovXG4gICAgb25TY3JvbGwoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgaWYgKGlzT3BlcmF0aW5nKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpc09wZXJhdGluZyA9IHRydWU7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy4kZWwuc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBpc1ZlcnRpY2FsU2Nyb2xsID0gTWF0aC5hYnMoc2Nyb2xsVG9wIC0gc2Nyb2xsVG9wY2FjaGUpID4gMjsvLyDlv73nlaXmqKrlkJHmu5rliqjnmoTml7blgJnpgKDmiJDovbvlvq7nmoTlnoLnm7Tmu5rliqhcbiAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnRhcmdldCAmJiBpc1ZlcnRpY2FsU2Nyb2xsKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBjb25zdCByb290ID0gZXZlbnQudGFyZ2V0LmdldFJvb3ROb2RlKCk7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSByb290LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi50eXBlID09PSAnUmFuZ2UnKSB7XG4gICAgICAgICAgICAgICAgLy8g6YG/5YWN5bCGIGlucHV0IOi+k+WFpeeahOeahCBmb2N1cyDlj5bmtohcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzY3JvbGxUb3BjYWNoZSA9IHNjcm9sbFRvcDtcbiAgICAgICAgY29uc3QgbGluZUhlaWdodCA9IHRoaXMubGluZUhlaWdodDtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmdldFNjcm9sbFBvc2l0aW9uKHNjcm9sbFRvcCwgbGluZUhlaWdodCk7XG4gICAgICAgIHRoaXMubGlzdFRyYW5zZm9ybVkgPSBvdXRwdXRMaXN0W2luZGV4XT8udHJhbnNsYXRlWSA/PyAwO1xuXG4gICAgICAgIC8vIOmBjeWOhuS4i+imgeaYvuekuueahOWIl+ihqOWFg+e0oOWvueWtmOWcqOeahGl0ZW3ov5vooYzmlbDmja7loavlhYVcbiAgICAgICAgdGhpcy5zaG93TGlzdC5mb3JFYWNoKChpdGVtOiBJTWVzc2FnZUl0ZW0sIGk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0SXRlbSA9IG91dHB1dExpc3RbaW5kZXggKyBpXTtcbiAgICAgICAgICAgIGlmICghb3V0cHV0SXRlbSkge1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IC0xMDAwO1xuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpdGVtLmRhdGUgPSBvdXRwdXRJdGVtLmRhdGU7XG4gICAgICAgICAgICAgICAgaXRlbS50eXBlID0gb3V0cHV0SXRlbS50eXBlO1xuICAgICAgICAgICAgICAgIGl0ZW0ucm93cyA9IG91dHB1dEl0ZW0ucm93cztcbiAgICAgICAgICAgICAgICBpdGVtLnRpdGxlID0gb3V0cHV0SXRlbS50aXRsZTtcbiAgICAgICAgICAgICAgICBpdGVtLmNvbnRlbnQgPSBvdXRwdXRJdGVtLmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgaXRlbS5jb3VudCA9IG91dHB1dEl0ZW0uY291bnQ7XG4gICAgICAgICAgICAgICAgaXRlbS5mb2xkID0gb3V0cHV0SXRlbS5mb2xkO1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IG91dHB1dEl0ZW0udHJhbnNsYXRlWTtcbiAgICAgICAgICAgICAgICBpdGVtLnRleHR1cmUgPSAoaW5kZXggKyBpKSAlIDIgPT09IDAgPyAnZGFyaycgOiAnbGlnaHQnO1xuICAgICAgICAgICAgICAgIGl0ZW0uc3RhY2sgPSBvdXRwdXRJdGVtLnN0YWNrO1xuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlzT3BlcmF0aW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmmL7npLrlpI3liLboj5zljZVcbiAgICAgKiBAcGFyYW0geyp9IGV2ZW50XG4gICAgICogQHBhcmFtIHsqfSBpdGVtXG4gICAgICovXG4gICAgc2hvd01lbnVQYXN0KGV2ZW50OiBhbnksIGl0ZW06IGFueSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBsZXQgaW5mbyA9ICcnO1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uPy50eXBlID09PSAnUmFuZ2UnKSB7XG4gICAgICAgICAgICBpbmZvID0gc2VsZWN0aW9uLnRvU3RyaW5nKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbmZvICs9IGAke2l0ZW0udGl0bGV9IFxcbmA7XG4gICAgICAgICAgICBpZiAoaXRlbS5yb3dzID4gMSkge1xuICAgICAgICAgICAgICAgIGl0ZW0uY29udGVudC5mb3JFYWNoKChzdHI6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpbmZvICs9IGAke3N0cn0gXFxuYDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpdGVtLnN0YWNrPy5mb3JFYWNoPy4oKHN0cjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGluZm8gKz0gYCR7c3RyfSBcXG5gO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIEVkaXRvci5NZW51LnBvcHVwKHtcbiAgICAgICAgICAgIG1lbnU6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdjb25zb2xlLmNvcHknKSxcbiAgICAgICAgICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBFZGl0b3IuQ2xpcGJvYXJkLndyaXRlKCd0ZXh0JywgaW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5qC85byP5YyWIHRleHQg6YeM6Z2i5Y+v6IO95pyJ55qE6ISa5pys6Lev5b6EXG4gICAgICog6ZyA6KaB6auY5Lqu6Lev5b6EXG4gICAgICogQHBhcmFtIHRleHRcbiAgICAgKi9cbiAgICByZW5kZXJUZXh0KHRleHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6L2s5LmJIGh0bWwg5qCH562+55qE5bCW5ous5Y+3XG4gICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7Jyk7XG5cbiAgICAgICAgLy8gdGV4dCA9IHRleHQucmVwbGFjZSgvXFwoKGZpbGU6XFwvXFwvXFwvW14pXSspXFwpL2csIChtYXRjaGVyLCBwMSkgPT4ge1xuICAgICAgICAvLyAgICAgY29uc3QgcGF0aCA9IGZpbGVVUkxUb1BhdGgocDEpO1xuICAgICAgICAvLyAgICAgcmV0dXJuIGB7bGlua1ske3BhdGh9XSgke3BhdGh9KX1gO1xuICAgICAgICAvLyB9KTtcbiAgICAgICAgdGV4dCA9IHJlcGxhY2VIdHRwQW5kTG9jYWxQYXRoMlVJTGluayh0ZXh0KTtcblxuICAgICAgICB0ZXh0ID0gdHJhbnNmb3JtVGV4dCh0ZXh0KTtcblxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICog54K55Ye75paH5pys55qE5pe25YCZ6Kem5Y+RXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgb25UZXh0Q2xpY2soZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIWV2ZW50LnRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdidWJibGUnKSA9PT0gbnVsbCAmJiB0aGlzLiRlbCAhPT0gZXZlbnQudGFyZ2V0KSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzmnInpgInkuK3vvIzkuI3op6blj5Hmipjlj6Av5bGV5byAXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGV2ZW50LnRhcmdldC5nZXRSb290Tm9kZSgpLmdldFNlbGVjdGlvbigpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5iYXNlT2Zmc2V0ICE9PSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19