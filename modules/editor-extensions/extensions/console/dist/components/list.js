'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update(true);
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList(noScroll2bottom = false) {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList(noScroll2bottom);
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部 & 点击展开 收起不能自动滚动到底部
        if ((isAtBottom || !isOperating) && !noScroll2bottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - this.$el.clientHeight + 8; // pading-bottom:8px
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            if (selection.type === 'Range') {
                // 避免将 input 输入的的 focus 取消
                selection.removeAllRanges();
            }
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        event.preventDefault();
        let info = '';
        const selection = document.getSelection();
        if (selection?.type === 'Range') {
            info = selection.toString();
        }
        else {
            info += `${item.title} \n`;
            if (item.rows > 1) {
                item.content.forEach((str) => {
                    info += `${str} \n`;
                });
                item.stack?.forEach?.((str) => {
                    info += `${str} \n`;
                });
            }
        }
        Editor.Menu.popup({
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
        //     const path = fileURLToPath(p1);
        //     return `{link[${path}](${path})}`;
        // });
        text = utils_1.replaceHttpAndLocalPath2UILink(text);
        text = utils_1.transformText(text);
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBQzVCLG9DQUF5RTtBQUV6RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQWtCLElBQUksQ0FBQztBQUMxQyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7QUFFL0IsUUFBQSxRQUFRLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLGNBQWMsRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRXhGLFFBQUEsSUFBSSxHQUFHLGNBQWMsQ0FBQztBQUV0QixRQUFBLEtBQUssR0FBRztJQUNqQixRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQzFCLFVBQVUsRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7Q0FDL0IsQ0FBQztBQUVGLFNBQWdCLElBQUk7SUFDaEIsT0FBTztRQUNILEtBQUssRUFBRSxJQUFJO1FBQ1gsZUFBZSxFQUFFLENBQUM7UUFDbEIsUUFBUSxFQUFFLEVBQUU7UUFDWixZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFO1FBQzNCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLGNBQWMsRUFBRSxDQUFDO1FBQ2pCLGdCQUFnQixFQUFFLElBQUk7S0FDekIsQ0FBQztBQUNOLENBQUM7QUFWRCxvQkFVQztBQUVZLFFBQUEsUUFBUSxHQUFRO0lBQ3pCLFNBQVM7UUFDTCxNQUFNLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVB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QUMsZUFBZSxFQUFFLENBQUM7WUFDeEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQzFCO0lBQ0wsQ0FBQztDQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IElNZXNzYWdlSXRlbSB9IGZyb20gJy4uLy4uL0B0eXBlcy9wcml0YXRlJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJlcGxhY2VIdHRwQW5kTG9jYWxQYXRoMlVJTGluaywgdHJhbnNmb3JtVGV4dCB9IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgbWFuYWdlciA9IHJlcXVpcmUoJy4uL21hbmFnZXInKTtcbmNvbnN0IG91dHB1dExpc3QgPSBtYW5hZ2VyLm91dHB1dExpc3Q7XG5sZXQgaXNPcGVyYXRpbmcgPSBmYWxzZTtcbmxldCByZW5kZXJMaXN0VGltZXI6IG51bWJlciB8IG51bGwgPSBudWxsO1xubGV0IHNjcm9sbFRvcGNhY2hlID0gMDsgLy8g55So5LqO5Yik5pat5b2T5YmN5piv5qiq5ZCR5rua5Yqo6L+Y5piv5Z6C55u05rua5YqoXG5cbmV4cG9ydCBjb25zdCB0ZW1wbGF0ZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uLy4uL3N0YXRpYycsICcvdGVtcGxhdGUvbGlzdC5odG1sJyksICd1dGY4Jyk7XG5cbmV4cG9ydCBjb25zdCBuYW1lID0gJ2NvbnNvbGUtbGlzdCc7XG5cbmV4cG9ydCBjb25zdCBwcm9wcyA9IHtcbiAgICBmb250U2l6ZTogeyB0eXBlOiBOdW1iZXIgfSxcbiAgICBsaW5lSGVpZ2h0OiB7IHR5cGU6IE51bWJlciB9LFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRhdGEoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdGltZXI6IG51bGwsXG4gICAgICAgIGNhY2hlTGlzdExlbmd0aDogMCxcbiAgICAgICAgc2hvd0xpc3Q6IFtdLFxuICAgICAgICB3cmFwcGVyU3R5bGU6IHsgaGVpZ2h0OiAwIH0sXG4gICAgICAgIGlzUmVuZGluZzogZmFsc2UsXG4gICAgICAgIGxpc3RUcmFuc2Zvcm1ZOiAwLFxuICAgICAgICByZXBsYWNlVGV4dFRpbWVyOiBudWxsLFxuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBjb21wdXRlZDogYW55ID0ge1xuICAgIGxpc3RTdHlsZSgpIHtcbiAgICAgICAgY29uc3QgeyBsaXN0VHJhbnNmb3JtWSwgZm9udFNpemUsIGxpbmVIZWlnaHQgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAndHJhbnNmb3JtJzogYHRyYW5zbGF0ZVkoJHtsaXN0VHJhbnNmb3JtWX1weClgLFxuICAgICAgICAgICAgJy0tZm9udC1zaXplJzogYCR7Zm9udFNpemV9cHhgLFxuICAgICAgICAgICAgJy0tbGluZS1oZWlnaHQnOiBgJHtsaW5lSGVpZ2h0fXB4YCxcbiAgICAgICAgfTtcbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHdhdGNoOiBhbnkgPSB7XG4gICAgbGluZUhlaWdodCh2YWw6IG51bWJlcikge1xuICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckxpc3QoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgbWV0aG9kczogYW55ID0ge1xuICAgIC8qKlxuICAgICAqIOWIh+aNoua2iOaBr+WFt+S9k+WGheWuueaYvuekulxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0cmFuc2xhdGVZXG4gICAgICovXG4gICAgdG9nZ2xlQ29udGVudCh0cmFuc2xhdGVZOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IG91dHB1dExpc3QuZmluZCgoaXRlbTogSU1lc3NhZ2VJdGVtKSA9PiBpdGVtLnRyYW5zbGF0ZVkgPT09IHRyYW5zbGF0ZVkpO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgaXRlbS5mb2xkID0gIWl0ZW0uZm9sZDtcbiAgICAgICAgICAgIG1hbmFnZXIudXBkYXRlKHRydWUpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBjcmVhdGVJdGVtKCk6IElNZXNzYWdlSXRlbSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb250ZW50OiBbXSxcbiAgICAgICAgICAgIHJvd3M6IDAsXG4gICAgICAgICAgICBtZXNzYWdlOiAnJyxcbiAgICAgICAgICAgIHR5cGU6ICdsb2cnLFxuICAgICAgICAgICAgdGl0bGU6ICcnLFxuICAgICAgICAgICAgdGV4dHVyZTogJycsXG4gICAgICAgICAgICBjb3VudDogMSxcbiAgICAgICAgICAgIGZvbGQ6IHRydWUsXG4gICAgICAgICAgICBzaG93OiBmYWxzZSxcbiAgICAgICAgICAgIHN0YWNrOiBbXSxcbiAgICAgICAgICAgIHRyYW5zbGF0ZVk6IC0xMDAwLFxuICAgICAgICB9O1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog6K6h566X5omA5pyJ5raI5oGv5YaF5a656auY5bqmXG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBnZXRIZWlnaHQoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGhlaWdodCA9IDA7XG4gICAgICAgIG91dHB1dExpc3QuZm9yRWFjaCgoaXRlbTogSU1lc3NhZ2VJdGVtKSA9PiB7XG4gICAgICAgICAgICBpdGVtLmZvbGQgPyAoaGVpZ2h0ICs9IHRoaXMubGluZUhlaWdodCkgOiAoaGVpZ2h0ICs9IGl0ZW0ucm93cyAqIHRoaXMubGluZUhlaWdodCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gaGVpZ2h0O1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog6I635Y+W5rua5Yqo5L2N572u5a+55bqU55qE5raI5oGvaW5kZXhcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc2Nyb2xsVG9wXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbmVIZWlnaHRcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICAgIGdldFNjcm9sbFBvc2l0aW9uKHNjcm9sbFRvcDogbnVtYmVyLCBsaW5lSGVpZ2h0OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBsZXQgaGVpZ2h0ID0gMDtcbiAgICAgICAgbGV0IGluZGV4ID0gMDtcbiAgICAgICAgb3V0cHV0TGlzdC5zb21lKChpdGVtOiBJTWVzc2FnZUl0ZW0sIGk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgaWYgKGl0ZW0uZm9sZCkge1xuICAgICAgICAgICAgICAgIGhlaWdodCArPSBsaW5lSGVpZ2h0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgKz0gaXRlbS5yb3dzICogbGluZUhlaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChoZWlnaHQgPiBzY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICBpbmRleCA9IGkgLSAxO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGluZGV4LCAwKTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOa4suafk+WPr+ingea2iOaBr+WIl+ihqFxuICAgICAqL1xuICAgIHJlbmRlckxpc3Qobm9TY3JvbGwyYm90dG9tID0gZmFsc2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSZW5kaW5nKSB7XG4gICAgICAgICAgICBpZiAocmVuZGVyTGlzdFRpbWVyKSB7XG4gICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChyZW5kZXJMaXN0VGltZXIpO1xuICAgICAgICAgICAgICAgIHJlbmRlckxpc3RUaW1lciA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZW5kZXJMaXN0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0KG5vU2Nyb2xsMmJvdHRvbSk7XG4gICAgICAgICAgICB9LCAyMDApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaXNSZW5kaW5nID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5nZXRIZWlnaHQoKTtcbiAgICAgICAgdGhpcy53cmFwcGVyU3R5bGUuaGVpZ2h0ID0gYCR7aGVpZ2h0fXB4YDtcblxuICAgICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0O1xuICAgICAgICBjb25zdCBjbGllbnRIZWlnaHQgPSB0aGlzLiRlbC5jbGllbnRIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGl0ZW1Db3VudDogbnVtYmVyID0gTWF0aC5jZWlsKGNsaWVudEhlaWdodCAvIGxpbmVIZWlnaHQpICsgMztcbiAgICAgICAgdGhpcy5zaG93TGlzdC5zcGxpY2UoaXRlbUNvdW50KTtcblxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLiRlbC5zY3JvbGxUb3A7XG5cbiAgICAgICAgY29uc3QgZGVsdGEgPSBvdXRwdXRMaXN0Lmxlbmd0aCAtIHRoaXMuY2FjaGVMaXN0TGVuZ3RoO1xuICAgICAgICBjb25zdCBpc0F0Qm90dG9tID0gaGVpZ2h0IC0gY2xpZW50SGVpZ2h0IC0gc2Nyb2xsVG9wIDw9IGRlbHRhICogbGluZUhlaWdodDtcbiAgICAgICAgdGhpcy5jYWNoZUxpc3RMZW5ndGggPSBvdXRwdXRMaXN0Lmxlbmd0aDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1Db3VudDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zaG93TGlzdFtpXTtcbiAgICAgICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgLy8g6YG/5YWN6Zeq54OBXG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gLTEwMDA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0xpc3QucHVzaCh0aGlzLmNyZWF0ZUl0ZW0oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDmnKrmu5rliqjmiJbogIXlnKjlupXpg6jpnIDopoHmu5rliqjliLDlupXpg6ggJiDngrnlh7vlsZXlvIAg5pS26LW35LiN6IO96Ieq5Yqo5rua5Yqo5Yiw5bqV6YOoXG4gICAgICAgIGlmICgoaXNBdEJvdHRvbSB8fCAhaXNPcGVyYXRpbmcpICYmICFub1Njcm9sbDJib3R0b20pIHtcbiAgICAgICAgICAgIC8vIOS4iuS4gOatpeiuvue9ruS6hiBoZWlnaHTvvIzlrp7pmYXov5jmnKrnlJ/mlYjvvIzlnKjmnKrnlJ/mlYjliY3orr7nva4gc2Nyb2xsVG9wIOS8muWksei0pVxuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLiRlbC5zY3JvbGxUb3AgPSBoZWlnaHQgLSB0aGlzLiRlbC5jbGllbnRIZWlnaHQgKyA4OyAvLyBwYWRpbmctYm90dG9tOjhweFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9uU2Nyb2xsKCk7XG4gICAgICAgIHRoaXMuaXNSZW5kaW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmu5rliqjkuovku7ZcbiAgICAgKi9cbiAgICBvblNjcm9sbChldmVudDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoaXNPcGVyYXRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlzT3BlcmF0aW5nID0gdHJ1ZTtcblxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLiRlbC5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IGlzVmVydGljYWxTY3JvbGwgPSBNYXRoLmFicyhzY3JvbGxUb3AgLSBzY3JvbGxUb3BjYWNoZSkgPiAyOy8vIOW/veeVpeaoquWQkea7muWKqOeahOaXtuWAmemAoOaIkOi9u+W+rueahOWeguebtOa7muWKqFxuICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQudGFyZ2V0ICYmIGlzVmVydGljYWxTY3JvbGwpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBldmVudC50YXJnZXQuZ2V0Um9vdE5vZGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHJvb3QuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnR5cGUgPT09ICdSYW5nZScpIHtcbiAgICAgICAgICAgICAgICAvLyDpgb/lhY3lsIYgaW5wdXQg6L6T5YWl55qE55qEIGZvY3VzIOWPlua2iFxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNjcm9sbFRvcGNhY2hlID0gc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0O1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24oc2Nyb2xsVG9wLCBsaW5lSGVpZ2h0KTtcbiAgICAgICAgdGhpcy5saXN0VHJhbnNmb3JtWSA9IG91dHB1dExpc3RbaW5kZXhdPy50cmFuc2xhdGVZID8/IDA7XG5cbiAgICAgICAgLy8g6YGN5Y6G5LiL6KaB5pi+56S655qE5YiX6KGo5YWD57Sg5a+55a2Y5Zyo55qEaXRlbei/m+ihjOaVsOaNruWhq+WFhVxuICAgICAgICB0aGlzLnNob3dMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSwgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvdXRwdXRJdGVtID0gb3V0cHV0TGlzdFtpbmRleCArIGldO1xuICAgICAgICAgICAgaWYgKCFvdXRwdXRJdGVtKSB7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gLTEwMDA7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGl0ZW0uZGF0ZSA9IG91dHB1dEl0ZW0uZGF0ZTtcbiAgICAgICAgICAgICAgICBpdGVtLnR5cGUgPSBvdXRwdXRJdGVtLnR5cGU7XG4gICAgICAgICAgICAgICAgaXRlbS5yb3dzID0gb3V0cHV0SXRlbS5yb3dzO1xuICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUgPSBvdXRwdXRJdGVtLnRpdGxlO1xuICAgICAgICAgICAgICAgIGl0ZW0uY29udGVudCA9IG91dHB1dEl0ZW0uY29udGVudDtcbiAgICAgICAgICAgICAgICBpdGVtLmNvdW50ID0gb3V0cHV0SXRlbS5jb3VudDtcbiAgICAgICAgICAgICAgICBpdGVtLmZvbGQgPSBvdXRwdXRJdGVtLmZvbGQ7XG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2xhdGVZID0gb3V0cHV0SXRlbS50cmFuc2xhdGVZO1xuICAgICAgICAgICAgICAgIGl0ZW0udGV4dHVyZSA9IChpbmRleCArIGkpICUgMiA9PT0gMCA/ICdkYXJrJyA6ICdsaWdodCc7XG4gICAgICAgICAgICAgICAgaXRlbS5zdGFjayA9IG91dHB1dEl0ZW0uc3RhY2s7XG4gICAgICAgICAgICAgICAgaXRlbS5zaG93ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXNPcGVyYXRpbmcgPSBmYWxzZTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOaYvuekuuWkjeWItuiPnOWNlVxuICAgICAqIEBwYXJhbSB7Kn0gZXZlbnRcbiAgICAgKiBAcGFyYW0geyp9IGl0ZW1cbiAgICAgKi9cbiAgICBzaG93TWVudVBhc3QoZXZlbnQ6IGFueSwgaXRlbTogYW55KSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGxldCBpbmZvID0gJyc7XG5cbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgIGlmIChzZWxlY3Rpb24/LnR5cGUgPT09ICdSYW5nZScpIHtcbiAgICAgICAgICAgIGluZm8gPSBzZWxlY3Rpb24udG9TdHJpbmcoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGluZm8gKz0gYCR7aXRlbS50aXRsZX0gXFxuYDtcbiAgICAgICAgICAgIGlmIChpdGVtLnJvd3MgPiAxKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5jb250ZW50LmZvckVhY2goKHN0cjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGluZm8gKz0gYCR7c3RyfSBcXG5gO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGl0ZW0uc3RhY2s/LmZvckVhY2g/Ligoc3RyOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSBgJHtzdHJ9IFxcbmA7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgRWRpdG9yLk1lbnUucG9wdXAoe1xuICAgICAgICAgICAgbWVudTogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2NvbnNvbGUuY29weScpLFxuICAgICAgICAgICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIEVkaXRvci5DbGlwYm9hcmQud3JpdGUoJ3RleHQnLCBpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmoLzlvI/ljJYgdGV4dCDph4zpnaLlj6/og73mnInnmoTohJrmnKzot6/lvoRcbiAgICAgKiDpnIDopoHpq5jkuq7ot6/lvoRcbiAgICAgKiBAcGFyYW0gdGV4dFxuICAgICAqL1xuICAgIHJlbmRlclRleHQodGV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDovazkuYkgaHRtbCDmoIfnrb7nmoTlsJbmi6zlj7dcbiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKTtcblxuICAgICAgICAvLyB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cXCgoZmlsZTpcXC9cXC9cXC9bXildKylcXCkvZywgKG1hdGNoZXIsIHAxKSA9PiB7XG4gICAgICAgIC8vICAgICBjb25zdCBwYXRoID0gZmlsZVVSTFRvUGF0aChwMSk7XG4gICAgICAgIC8vICAgICByZXR1cm4gYHtsaW5rWyR7cGF0aH1dKCR7cGF0aH0pfWA7XG4gICAgICAgIC8vIH0pO1xuICAgICAgICB0ZXh0ID0gcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rKHRleHQpO1xuXG4gICAgICAgIHRleHQgPSB0cmFuc2Zvcm1UZXh0KHRleHQpO1xuXG4gICAgICAgIHJldHVybiB0ZXh0O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiDngrnlh7vmlofmnKznmoTml7blgJnop6blj5FcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBvblRleHRDbGljayhldmVudDogYW55KSB7XG4gICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2J1YmJsZScpID09PSBudWxsICYmIHRoaXMuJGVsICE9PSBldmVudC50YXJnZXQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOWmguaenOaciemAieS4re+8jOS4jeinpuWPkeaKmOWPoC/lsZXlvIBcbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gZXZlbnQudGFyZ2V0LmdldFJvb3ROb2RlKCkuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgIGlmIChzZWxlY3Rpb24gJiYgc2VsZWN0aW9uLmJhc2VPZmZzZXQgIT09IHNlbGVjdGlvbi5mb2N1c09mZnNldCkge1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9XG4gICAgfSxcbn07XG4iXX0=