'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update(true);
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList(noScroll2bottom = false) {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList(noScroll2bottom);
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部 & 点击展开 收起不能自动滚动到底部
        if ((isAtBottom || !isOperating) && !noScroll2bottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - this.$el.clientHeight + 8; // pading-bottom:8px
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            if (selection.type === 'Range') {
                // 避免将 input 输入的的 focus 取消
                selection.removeAllRanges();
            }
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        let info = `${item.title} \n`;
        if (item.rows > 1) {
            item.content.forEach((str) => {
                info += `${str} \n`;
            });
            item.stack?.forEach?.((str) => {
                info += `${str} \n`;
            });
        }
        Editor.Menu.popup({
            x: event.pageX,
            y: event.pageY,
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
        //     const path = fileURLToPath(p1);
        //     return `{link[${path}](${path})}`;
        // });
        text = utils_1.replaceHttpAndLocalPath2UILink(text);
        text = utils_1.transformText(text);
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBQzVCLG9DQUF5RTtBQUV6RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUN0QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSSxlQUFlLEdBQWtCLElBQUksQ0FBQztBQUMxQyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7QUFFL0IsUUFBQSxRQUFRLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLGNBQWMsRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRXhGLFFBQUEsSUFBSSxHQUFHLGNBQWMsQ0FBQztBQUV0QixRQUFBLEtBQUssR0FBRztJQUNqQixRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQzFCLFVBQVUsRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7Q0FDL0IsQ0FBQztBQUVGLFNBQWdCLElBQUk7SUFDaEIsT0FBTztRQUNILEtBQUssRUFBRSxJQUFJO1FBQ1gsZUFBZSxFQUFFLENBQUM7UUFDbEIsUUFBUSxFQUFFLEVBQUU7UUFDWixZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFO1FBQzNCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLGNBQWMsRUFBRSxDQUFDO1FBQ2pCLGdCQUFnQixFQUFFLElBQUk7S0FDekIsQ0FBQztBQUNOLENBQUM7QUFWRCxvQkFVQztBQUVZLFFBQUEsUUFBUSxHQUFRO0lBQ3pCLFNBQVM7UUFDTCxNQUFNLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVB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QUNILFVBQVUsQ0FBQyxJQUFZO1FBQ25CLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDUCxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsaUJBQWlCO1FBQ2pCLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXhELG9FQUFvRTtRQUNwRSxzQ0FBc0M7UUFDdEMseUNBQXlDO1FBQ3pDLE1BQU07UUFDTixJQUFJLEdBQUcsc0NBQThCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFNUMsSUFBSSxHQUFHLHFCQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFM0IsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILFdBQVcsQ0FBQyxLQUFVO1FBQ2xCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ2YsT0FBTztTQUNWO1FBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQzNFLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN4QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDMUI7UUFFRCxpQkFBaUI7UUFDakIsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM1RCxJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDN0QsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3hCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUMxQjtJQUNMLENBQUM7Q0FDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBJTWVzc2FnZUl0ZW0gfSBmcm9tICcuLi8uLi9AdHlwZXMvcHJpdGF0ZSc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZXBsYWNlSHR0cEFuZExvY2FsUGF0aDJVSUxpbmssIHRyYW5zZm9ybVRleHQgfSBmcm9tICcuLi91dGlscyc7XG5cbmNvbnN0IG1hbmFnZXIgPSByZXF1aXJlKCcuLi9tYW5hZ2VyJyk7XG5jb25zdCBvdXRwdXRMaXN0ID0gbWFuYWdlci5vdXRwdXRMaXN0O1xubGV0IGlzT3BlcmF0aW5nID0gZmFsc2U7XG5sZXQgcmVuZGVyTGlzdFRpbWVyOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbmxldCBzY3JvbGxUb3BjYWNoZSA9IDA7IC8vIOeUqOS6juWIpOaWreW9k+WJjeaYr+aoquWQkea7muWKqOi/mOaYr+WeguebtOa7muWKqFxuXG5leHBvcnQgY29uc3QgdGVtcGxhdGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWMnLCAnL3RlbXBsYXRlL2xpc3QuaHRtbCcpLCAndXRmOCcpO1xuXG5leHBvcnQgY29uc3QgbmFtZSA9ICdjb25zb2xlLWxpc3QnO1xuXG5leHBvcnQgY29uc3QgcHJvcHMgPSB7XG4gICAgZm9udFNpemU6IHsgdHlwZTogTnVtYmVyIH0sXG4gICAgbGluZUhlaWdodDogeyB0eXBlOiBOdW1iZXIgfSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBkYXRhKCkge1xuICAgIHJldHVybiB7XG4gICAgICAgIHRpbWVyOiBudWxsLFxuICAgICAgICBjYWNoZUxpc3RMZW5ndGg6IDAsXG4gICAgICAgIHNob3dMaXN0OiBbXSxcbiAgICAgICAgd3JhcHBlclN0eWxlOiB7IGhlaWdodDogMCB9LFxuICAgICAgICBpc1JlbmRpbmc6IGZhbHNlLFxuICAgICAgICBsaXN0VHJhbnNmb3JtWTogMCxcbiAgICAgICAgcmVwbGFjZVRleHRUaW1lcjogbnVsbCxcbiAgICB9O1xufVxuXG5leHBvcnQgY29uc3QgY29tcHV0ZWQ6IGFueSA9IHtcbiAgICBsaXN0U3R5bGUoKSB7XG4gICAgICAgIGNvbnN0IHsgbGlzdFRyYW5zZm9ybVksIGZvbnRTaXplLCBsaW5lSGVpZ2h0IH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGB0cmFuc2xhdGVZKCR7bGlzdFRyYW5zZm9ybVl9cHgpYCxcbiAgICAgICAgICAgICctLWZvbnQtc2l6ZSc6IGAke2ZvbnRTaXplfXB4YCxcbiAgICAgICAgICAgICctLWxpbmUtaGVpZ2h0JzogYCR7bGluZUhlaWdodH1weGAsXG4gICAgICAgIH07XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCB3YXRjaDogYW55ID0ge1xuICAgIGxpbmVIZWlnaHQodmFsOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0KCk7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IG1ldGhvZHM6IGFueSA9IHtcbiAgICAvKipcbiAgICAgKiDliIfmjaLmtojmga/lhbfkvZPlhoXlrrnmmL7npLpcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWVxuICAgICAqL1xuICAgIHRvZ2dsZUNvbnRlbnQodHJhbnNsYXRlWTogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBvdXRwdXRMaXN0LmZpbmQoKGl0ZW06IElNZXNzYWdlSXRlbSkgPT4gaXRlbS50cmFuc2xhdGVZID09PSB0cmFuc2xhdGVZKTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW0uZm9sZCA9ICFpdGVtLmZvbGQ7XG4gICAgICAgICAgICBtYW5hZ2VyLnVwZGF0ZSh0cnVlKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgY3JlYXRlSXRlbSgpOiBJTWVzc2FnZUl0ZW0ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVudDogW10sXG4gICAgICAgICAgICByb3dzOiAwLFxuICAgICAgICAgICAgbWVzc2FnZTogJycsXG4gICAgICAgICAgICB0eXBlOiAnbG9nJyxcbiAgICAgICAgICAgIHRpdGxlOiAnJyxcbiAgICAgICAgICAgIHRleHR1cmU6ICcnLFxuICAgICAgICAgICAgY291bnQ6IDEsXG4gICAgICAgICAgICBmb2xkOiB0cnVlLFxuICAgICAgICAgICAgc2hvdzogZmFsc2UsXG4gICAgICAgICAgICBzdGFjazogW10sXG4gICAgICAgICAgICB0cmFuc2xhdGVZOiAtMTAwMCxcbiAgICAgICAgfTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiuoeeul+aJgOaciea2iOaBr+WGheWuuemrmOW6plxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0SGVpZ2h0KCk6IG51bWJlciB7XG4gICAgICAgIGxldCBoZWlnaHQgPSAwO1xuICAgICAgICBvdXRwdXRMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSkgPT4ge1xuICAgICAgICAgICAgaXRlbS5mb2xkID8gKGhlaWdodCArPSB0aGlzLmxpbmVIZWlnaHQpIDogKGhlaWdodCArPSBpdGVtLnJvd3MgKiB0aGlzLmxpbmVIZWlnaHQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGhlaWdodDtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiOt+WPlua7muWKqOS9jee9ruWvueW6lOeahOa2iOaBr2luZGV4XG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHNjcm9sbFRvcFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lSGVpZ2h0XG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBnZXRTY3JvbGxQb3NpdGlvbihzY3JvbGxUb3A6IG51bWJlciwgbGluZUhlaWdodDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGhlaWdodCA9IDA7XG4gICAgICAgIGxldCBpbmRleCA9IDA7XG4gICAgICAgIG91dHB1dExpc3Quc29tZSgoaXRlbTogSU1lc3NhZ2VJdGVtLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLmZvbGQpIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgKz0gbGluZUhlaWdodDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ICs9IGl0ZW0ucm93cyAqIGxpbmVIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaGVpZ2h0ID4gc2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgaW5kZXggPSBpIC0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBNYXRoLm1heChpbmRleCwgMCk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmuLLmn5Plj6/op4Hmtojmga/liJfooahcbiAgICAgKi9cbiAgICByZW5kZXJMaXN0KG5vU2Nyb2xsMmJvdHRvbSA9IGZhbHNlKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzUmVuZGluZykge1xuICAgICAgICAgICAgaWYgKHJlbmRlckxpc3RUaW1lcikge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQocmVuZGVyTGlzdFRpbWVyKTtcbiAgICAgICAgICAgICAgICByZW5kZXJMaXN0VGltZXIgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVuZGVyTGlzdFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdChub1Njcm9sbDJib3R0b20pO1xuICAgICAgICAgICAgfSwgMjAwKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzUmVuZGluZyA9IHRydWU7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuZ2V0SGVpZ2h0KCk7XG4gICAgICAgIHRoaXMud3JhcHBlclN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG5cbiAgICAgICAgY29uc3QgbGluZUhlaWdodCA9IHRoaXMubGluZUhlaWdodDtcbiAgICAgICAgY29uc3QgY2xpZW50SGVpZ2h0ID0gdGhpcy4kZWwuY2xpZW50SGVpZ2h0O1xuICAgICAgICBjb25zdCBpdGVtQ291bnQ6IG51bWJlciA9IE1hdGguY2VpbChjbGllbnRIZWlnaHQgLyBsaW5lSGVpZ2h0KSArIDM7XG4gICAgICAgIHRoaXMuc2hvd0xpc3Quc3BsaWNlKGl0ZW1Db3VudCk7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy4kZWwuc2Nyb2xsVG9wO1xuXG4gICAgICAgIGNvbnN0IGRlbHRhID0gb3V0cHV0TGlzdC5sZW5ndGggLSB0aGlzLmNhY2hlTGlzdExlbmd0aDtcbiAgICAgICAgY29uc3QgaXNBdEJvdHRvbSA9IGhlaWdodCAtIGNsaWVudEhlaWdodCAtIHNjcm9sbFRvcCA8PSBkZWx0YSAqIGxpbmVIZWlnaHQ7XG4gICAgICAgIHRoaXMuY2FjaGVMaXN0TGVuZ3RoID0gb3V0cHV0TGlzdC5sZW5ndGg7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuc2hvd0xpc3RbaV07XG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIC8vIOmBv+WFjemXqueDgVxuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IC0xMDAwO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dMaXN0LnB1c2godGhpcy5jcmVhdGVJdGVtKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8g5pyq5rua5Yqo5oiW6ICF5Zyo5bqV6YOo6ZyA6KaB5rua5Yqo5Yiw5bqV6YOoICYg54K55Ye75bGV5byAIOaUtui1t+S4jeiDveiHquWKqOa7muWKqOWIsOW6lemDqFxuICAgICAgICBpZiAoKGlzQXRCb3R0b20gfHwgIWlzT3BlcmF0aW5nKSAmJiAhbm9TY3JvbGwyYm90dG9tKSB7XG4gICAgICAgICAgICAvLyDkuIrkuIDmraXorr7nva7kuoYgaGVpZ2h077yM5a6e6ZmF6L+Y5pyq55Sf5pWI77yM5Zyo5pyq55Sf5pWI5YmN6K6+572uIHNjcm9sbFRvcCDkvJrlpLHotKVcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kZWwuc2Nyb2xsVG9wID0gaGVpZ2h0IC0gdGhpcy4kZWwuY2xpZW50SGVpZ2h0ICsgODsgLy8gcGFkaW5nLWJvdHRvbTo4cHhcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5vblNjcm9sbCgpO1xuICAgICAgICB0aGlzLmlzUmVuZGluZyA9IGZhbHNlO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5rua5Yqo5LqL5Lu2XG4gICAgICovXG4gICAgb25TY3JvbGwoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgaWYgKGlzT3BlcmF0aW5nKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpc09wZXJhdGluZyA9IHRydWU7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy4kZWwuc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBpc1ZlcnRpY2FsU2Nyb2xsID0gTWF0aC5hYnMoc2Nyb2xsVG9wIC0gc2Nyb2xsVG9wY2FjaGUpID4gMjsvLyDlv73nlaXmqKrlkJHmu5rliqjnmoTml7blgJnpgKDmiJDovbvlvq7nmoTlnoLnm7Tmu5rliqhcbiAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnRhcmdldCAmJiBpc1ZlcnRpY2FsU2Nyb2xsKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBjb25zdCByb290ID0gZXZlbnQudGFyZ2V0LmdldFJvb3ROb2RlKCk7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSByb290LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi50eXBlID09PSAnUmFuZ2UnKSB7XG4gICAgICAgICAgICAgICAgLy8g6YG/5YWN5bCGIGlucHV0IOi+k+WFpeeahOeahCBmb2N1cyDlj5bmtohcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzY3JvbGxUb3BjYWNoZSA9IHNjcm9sbFRvcDtcbiAgICAgICAgY29uc3QgbGluZUhlaWdodCA9IHRoaXMubGluZUhlaWdodDtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmdldFNjcm9sbFBvc2l0aW9uKHNjcm9sbFRvcCwgbGluZUhlaWdodCk7XG4gICAgICAgIHRoaXMubGlzdFRyYW5zZm9ybVkgPSBvdXRwdXRMaXN0W2luZGV4XT8udHJhbnNsYXRlWSA/PyAwO1xuXG4gICAgICAgIC8vIOmBjeWOhuS4i+imgeaYvuekuueahOWIl+ihqOWFg+e0oOWvueWtmOWcqOeahGl0ZW3ov5vooYzmlbDmja7loavlhYVcbiAgICAgICAgdGhpcy5zaG93TGlzdC5mb3JFYWNoKChpdGVtOiBJTWVzc2FnZUl0ZW0sIGk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0SXRlbSA9IG91dHB1dExpc3RbaW5kZXggKyBpXTtcbiAgICAgICAgICAgIGlmICghb3V0cHV0SXRlbSkge1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IC0xMDAwO1xuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpdGVtLmRhdGUgPSBvdXRwdXRJdGVtLmRhdGU7XG4gICAgICAgICAgICAgICAgaXRlbS50eXBlID0gb3V0cHV0SXRlbS50eXBlO1xuICAgICAgICAgICAgICAgIGl0ZW0ucm93cyA9IG91dHB1dEl0ZW0ucm93cztcbiAgICAgICAgICAgICAgICBpdGVtLnRpdGxlID0gb3V0cHV0SXRlbS50aXRsZTtcbiAgICAgICAgICAgICAgICBpdGVtLmNvbnRlbnQgPSBvdXRwdXRJdGVtLmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgaXRlbS5jb3VudCA9IG91dHB1dEl0ZW0uY291bnQ7XG4gICAgICAgICAgICAgICAgaXRlbS5mb2xkID0gb3V0cHV0SXRlbS5mb2xkO1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNsYXRlWSA9IG91dHB1dEl0ZW0udHJhbnNsYXRlWTtcbiAgICAgICAgICAgICAgICBpdGVtLnRleHR1cmUgPSAoaW5kZXggKyBpKSAlIDIgPT09IDAgPyAnZGFyaycgOiAnbGlnaHQnO1xuICAgICAgICAgICAgICAgIGl0ZW0uc3RhY2sgPSBvdXRwdXRJdGVtLnN0YWNrO1xuICAgICAgICAgICAgICAgIGl0ZW0uc2hvdyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlzT3BlcmF0aW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmmL7npLrlpI3liLboj5zljZVcbiAgICAgKiBAcGFyYW0geyp9IGV2ZW50XG4gICAgICogQHBhcmFtIHsqfSBpdGVtXG4gICAgICovXG4gICAgc2hvd01lbnVQYXN0KGV2ZW50OiBhbnksIGl0ZW06IGFueSkge1xuICAgICAgICBsZXQgaW5mbyA9IGAke2l0ZW0udGl0bGV9IFxcbmA7XG4gICAgICAgIGlmIChpdGVtLnJvd3MgPiAxKSB7XG4gICAgICAgICAgICBpdGVtLmNvbnRlbnQuZm9yRWFjaCgoc3RyOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBpbmZvICs9IGAke3N0cn0gXFxuYDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaXRlbS5zdGFjaz8uZm9yRWFjaD8uKChzdHI6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIGluZm8gKz0gYCR7c3RyfSBcXG5gO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgRWRpdG9yLk1lbnUucG9wdXAoe1xuICAgICAgICAgICAgeDogZXZlbnQucGFnZVgsXG4gICAgICAgICAgICB5OiBldmVudC5wYWdlWSxcbiAgICAgICAgICAgIG1lbnU6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdjb25zb2xlLmNvcHknKSxcbiAgICAgICAgICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBFZGl0b3IuQ2xpcGJvYXJkLndyaXRlKCd0ZXh0JywgaW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5qC85byP5YyWIHRleHQg6YeM6Z2i5Y+v6IO95pyJ55qE6ISa5pys6Lev5b6EXG4gICAgICog6ZyA6KaB6auY5Lqu6Lev5b6EXG4gICAgICogQHBhcmFtIHRleHRcbiAgICAgKi9cbiAgICByZW5kZXJUZXh0KHRleHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6L2s5LmJIGh0bWwg5qCH562+55qE5bCW5ous5Y+3XG4gICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7Jyk7XG5cbiAgICAgICAgLy8gdGV4dCA9IHRleHQucmVwbGFjZSgvXFwoKGZpbGU6XFwvXFwvXFwvW14pXSspXFwpL2csIChtYXRjaGVyLCBwMSkgPT4ge1xuICAgICAgICAvLyAgICAgY29uc3QgcGF0aCA9IGZpbGVVUkxUb1BhdGgocDEpO1xuICAgICAgICAvLyAgICAgcmV0dXJuIGB7bGlua1ske3BhdGh9XSgke3BhdGh9KX1gO1xuICAgICAgICAvLyB9KTtcbiAgICAgICAgdGV4dCA9IHJlcGxhY2VIdHRwQW5kTG9jYWxQYXRoMlVJTGluayh0ZXh0KTtcblxuICAgICAgICB0ZXh0ID0gdHJhbnNmb3JtVGV4dCh0ZXh0KTtcblxuICAgICAgICByZXR1cm4gdGV4dDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICog54K55Ye75paH5pys55qE5pe25YCZ6Kem5Y+RXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgb25UZXh0Q2xpY2soZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIWV2ZW50LnRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdidWJibGUnKSA9PT0gbnVsbCAmJiB0aGlzLiRlbCAhPT0gZXZlbnQudGFyZ2V0KSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDlpoLmnpzmnInpgInkuK3vvIzkuI3op6blj5Hmipjlj6Av5bGV5byAXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IGV2ZW50LnRhcmdldC5nZXRSb290Tm9kZSgpLmdldFNlbGVjdGlvbigpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5iYXNlT2Zmc2V0ICE9PSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19