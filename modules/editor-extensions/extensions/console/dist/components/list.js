'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.methods = exports.watch = exports.computed = exports.data = exports.props = exports.name = exports.template = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const url_1 = require("url");
const utils_1 = require("../utils");
const manager = require('../manager');
const outputList = manager.outputList;
let isOperating = false;
let renderListTimer = null;
let scrollTopcache = 0; // 用于判断当前是横向滚动还是垂直滚动
// 维护一份渲染的类型列表
const renderTypes = {
    link(text, url) {
        url = url.replace(/:\d+/g, '');
        return `<ui-link value="${url}">${text || url}</ui-link>`;
    },
    asset(text, url) {
        const type = url.startsWith('db://') ? 'assetUrl' : 'assetUuid';
        return `<ui-link type="${type}" value="${url}">${text || url}</ui-link>`;
    },
    node(text, uuid) {
        return `<ui-link type="nodeUuid" value="${uuid}">${text || uuid}</ui-link>`;
    },
    image(text, url) {
        return `
        <ui-link value="${url}">
            <ui-image value="${url}" max-height>${text || url}</ui-image>
        </ui-link>
        `;
    },
    i18n(text, key) {
        return Editor.I18n.t(key);
    },
    hidden() {
        return '';
    },
};
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../static', '/template/list.html'), 'utf8');
exports.name = 'console-list';
exports.props = {
    fontSize: { type: Number },
    lineHeight: { type: Number },
};
function data() {
    return {
        timer: null,
        cacheListLength: 0,
        showList: [],
        wrapperStyle: { height: 0 },
        isRending: false,
        listTransformY: 0,
        replaceTextTimer: null,
    };
}
exports.data = data;
exports.computed = {
    listStyle() {
        const { listTransformY, fontSize, lineHeight } = this;
        return {
            'transform': `translateY(${listTransformY}px)`,
            '--font-size': `${fontSize}px`,
            '--line-height': `${lineHeight}px`,
        };
    },
};
exports.watch = {
    lineHeight(val) {
        if (val) {
            this.renderList();
        }
    },
};
exports.methods = {
    /**
     * 切换消息具体内容显示
     * @param {number} translateY
     */
    toggleContent(translateY) {
        const item = outputList.find((item) => item.translateY === translateY);
        if (item) {
            item.fold = !item.fold;
            manager.update();
        }
    },
    createItem() {
        return {
            content: [],
            rows: 0,
            message: '',
            type: 'log',
            title: '',
            texture: '',
            count: 1,
            fold: true,
            show: false,
            stack: [],
            translateY: -1000,
        };
    },
    /**
     * 计算所有消息内容高度
     * @returns {number}
     */
    getHeight() {
        let height = 0;
        outputList.forEach((item) => {
            item.fold ? (height += this.lineHeight) : (height += item.rows * this.lineHeight);
        });
        return height;
    },
    /**
     * 获取滚动位置对应的消息index
     * @param {number} scrollTop
     * @param {number} lineHeight
     * @returns {number}
     */
    getScrollPosition(scrollTop, lineHeight) {
        let height = 0;
        let index = 0;
        outputList.some((item, i) => {
            if (item.fold) {
                height += lineHeight;
            }
            else {
                height += item.rows * lineHeight;
            }
            if (height > scrollTop) {
                index = i - 1;
                return true;
            }
            return false;
        });
        return Math.max(index, 0);
    },
    /**
     * 渲染可见消息列表
     */
    renderList() {
        if (this.isRending) {
            if (renderListTimer) {
                window.clearTimeout(renderListTimer);
                renderListTimer = null;
            }
            renderListTimer = window.setTimeout(() => {
                this.renderList();
            }, 200);
            return;
        }
        this.isRending = true;
        const height = this.getHeight();
        this.wrapperStyle.height = `${height}px`;
        const lineHeight = this.lineHeight;
        const clientHeight = this.$el.clientHeight;
        const itemCount = Math.ceil(clientHeight / lineHeight) + 3;
        this.showList.splice(itemCount);
        const scrollTop = this.$el.scrollTop;
        const delta = outputList.length - this.cacheListLength;
        const isAtBottom = height - clientHeight - scrollTop <= delta * lineHeight;
        this.cacheListLength = outputList.length;
        for (let i = 0; i < itemCount; i++) {
            const item = this.showList[i];
            if (item) {
                // 避免闪烁
                item.show = false;
                item.translateY = -1000;
            }
            else {
                this.showList.push(this.createItem());
            }
        }
        // 未滚动或者在底部需要滚动到底部
        if (isAtBottom) {
            // 上一步设置了 height，实际还未生效，在未生效前设置 scrollTop 会失败
            requestAnimationFrame(() => {
                this.$el.scrollTop = height - clientHeight;
            });
        }
        this.onScroll();
        this.isRending = false;
    },
    /**
     * 滚动事件
     */
    onScroll(event) {
        if (isOperating) {
            return;
        }
        isOperating = true;
        const scrollTop = this.$el.scrollTop;
        const isVerticalScroll = Math.abs(scrollTop - scrollTopcache) > 2; // 忽略横向滚动的时候造成轻微的垂直滚动
        if (event && event.target && isVerticalScroll) {
            // @ts-ignore
            const root = event.target.getRootNode();
            const selection = root.getSelection();
            selection.removeAllRanges();
        }
        scrollTopcache = scrollTop;
        const lineHeight = this.lineHeight;
        const index = this.getScrollPosition(scrollTop, lineHeight);
        this.listTransformY = outputList[index]?.translateY ?? 0;
        // 遍历下要显示的列表元素对存在的item进行数据填充
        this.showList.forEach((item, i) => {
            const outputItem = outputList[index + i];
            if (!outputItem) {
                item.translateY = -1000;
                item.show = false;
            }
            else {
                item.date = outputItem.date;
                item.type = outputItem.type;
                item.rows = outputItem.rows;
                item.title = outputItem.title;
                item.content = outputItem.content;
                item.count = outputItem.count;
                item.fold = outputItem.fold;
                item.translateY = outputItem.translateY;
                item.texture = (index + i) % 2 === 0 ? 'dark' : 'light';
                item.stack = outputItem.stack;
                item.show = true;
            }
        });
        isOperating = false;
    },
    /**
     * 显示复制菜单
     * @param {*} event
     * @param {*} item
     */
    showMenuPast(event, item) {
        let info = item.title;
        if (item.rows > 1) {
            item.content.forEach((str) => {
                info += `${str} \n`;
            });
            item.stack?.forEach?.((str) => {
                info += `${str} \n`;
            });
        }
        Editor.Menu.popup({
            x: event.pageX,
            y: event.pageY,
            menu: [
                {
                    label: Editor.I18n.t('console.copy'),
                    click() {
                        Editor.Clipboard.write('text', info);
                    },
                },
            ],
        });
    },
    /**
     * 格式化 text 里面可能有的脚本路径
     * 需要高亮路径
     * @param text
     */
    renderText(text) {
        if (!text) {
            return text;
        }
        // 转义 html 标签的尖括号
        text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        text = text.replace(/\((file:\/\/\/[^)]+)\)/g, (matcher, p1) => {
            const path = url_1.fileURLToPath(p1);
            return `{link[${path}](${path})}`;
        });
        text = text.replace(/\{([\w]+)(?:\[([^[]*)\])?(?:\(([^()]*)\))\}/gi, (matcher, type, text, url) => {
            const lowerType = type.toLowerCase();
            if (renderTypes[lowerType]) {
                return renderTypes[lowerType](text, url);
            }
            return matcher;
        });
        text = utils_1.replaceHttpAndLocalPath2UILink(text);
        return text;
    },
    /**
     * 点击文本的时候触发
     * @param event
     */
    onTextClick(event) {
        if (!event.target) {
            return;
        }
        if (event.target.getAttribute('bubble') === null && this.$el !== event.target) {
            event.stopPropagation();
            event.preventDefault();
        }
        // 如果有选中，不触发折叠/展开
        const selection = event.target.getRootNode().getSelection();
        if (selection && selection.baseOffset !== selection.focusOffset) {
            event.stopPropagation();
            event.preventDefault();
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFHYiwyQkFBa0M7QUFDbEMsK0JBQTRCO0FBQzVCLDZCQUFvQztBQUNwQyxvQ0FBMEQ7QUFFMUQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDdEMsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0FBQ3hCLElBQUksZUFBZSxHQUFrQixJQUFJLENBQUM7QUFDMUMsSUFBSSxjQUFjLEdBQVcsQ0FBQyxDQUFDLENBQUMsb0JBQW9CO0FBRXBELGNBQWM7QUFDZCxNQUFNLFdBQVcsR0FBUTtJQUNyQixJQUFJLENBQUMsSUFBWSxFQUFFLEdBQVc7UUFDMUIsR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sbUJBQW1CLEdBQUcsS0FBSyxJQUFJLElBQUksR0FBRyxZQUFZLENBQUM7SUFDOUQsQ0FBQztJQUNELEtBQUssQ0FBQyxJQUFZLEVBQUUsR0FBVztRQUMzQixNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUNoRSxPQUFPLGtCQUFrQixJQUFJLFlBQVksR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLFlBQVksQ0FBQztJQUM3RSxDQUFDO0lBQ0QsSUFBSSxDQUFDLElBQVksRUFBRSxJQUFZO1FBQzNCLE9BQU8sbUNBQW1DLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxZQUFZLENBQUM7SUFDaEYsQ0FBQztJQUNELEtBQUssQ0FBQyxJQUFZLEVBQUUsR0FBVztRQUMzQixPQUFPOzBC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XG5cbmltcG9ydCB7IElNZXNzYWdlSXRlbSB9IGZyb20gJy4uLy4uL0B0eXBlcy9wcml0YXRlJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgcmVwbGFjZUh0dHBBbmRMb2NhbFBhdGgyVUlMaW5rIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBtYW5hZ2VyID0gcmVxdWlyZSgnLi4vbWFuYWdlcicpO1xuY29uc3Qgb3V0cHV0TGlzdCA9IG1hbmFnZXIub3V0cHV0TGlzdDtcbmxldCBpc09wZXJhdGluZyA9IGZhbHNlO1xubGV0IHJlbmRlckxpc3RUaW1lcjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5sZXQgc2Nyb2xsVG9wY2FjaGU6IG51bWJlciA9IDA7IC8vIOeUqOS6juWIpOaWreW9k+WJjeaYr+aoquWQkea7muWKqOi/mOaYr+WeguebtOa7muWKqFxuXG4vLyDnu7TmiqTkuIDku73muLLmn5PnmoTnsbvlnovliJfooahcbmNvbnN0IHJlbmRlclR5cGVzOiBhbnkgPSB7XG4gICAgbGluayh0ZXh0OiBzdHJpbmcsIHVybDogc3RyaW5nKSB7XG4gICAgICAgIHVybCA9IHVybC5yZXBsYWNlKC86XFxkKy9nLCAnJyk7XG4gICAgICAgIHJldHVybiBgPHVpLWxpbmsgdmFsdWU9XCIke3VybH1cIj4ke3RleHQgfHwgdXJsfTwvdWktbGluaz5gO1xuICAgIH0sXG4gICAgYXNzZXQodGV4dDogc3RyaW5nLCB1cmw6IHN0cmluZykge1xuICAgICAgICBjb25zdCB0eXBlID0gdXJsLnN0YXJ0c1dpdGgoJ2RiOi8vJykgPyAnYXNzZXRVcmwnIDogJ2Fzc2V0VXVpZCc7XG4gICAgICAgIHJldHVybiBgPHVpLWxpbmsgdHlwZT1cIiR7dHlwZX1cIiB2YWx1ZT1cIiR7dXJsfVwiPiR7dGV4dCB8fCB1cmx9PC91aS1saW5rPmA7XG4gICAgfSxcbiAgICBub2RlKHRleHQ6IHN0cmluZywgdXVpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBgPHVpLWxpbmsgdHlwZT1cIm5vZGVVdWlkXCIgdmFsdWU9XCIke3V1aWR9XCI+JHt0ZXh0IHx8IHV1aWR9PC91aS1saW5rPmA7XG4gICAgfSxcbiAgICBpbWFnZSh0ZXh0OiBzdHJpbmcsIHVybDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBgXG4gICAgICAgIDx1aS1saW5rIHZhbHVlPVwiJHt1cmx9XCI+XG4gICAgICAgICAgICA8dWktaW1hZ2UgdmFsdWU9XCIke3VybH1cIiBtYXgtaGVpZ2h0PiR7dGV4dCB8fCB1cmx9PC91aS1pbWFnZT5cbiAgICAgICAgPC91aS1saW5rPlxuICAgICAgICBgO1xuICAgIH0sXG4gICAgaTE4bih0ZXh0OiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBFZGl0b3IuSTE4bi50KGtleSk7XG4gICAgfSxcbiAgICBoaWRkZW4oKSB7XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi4vLi4vc3RhdGljJywgJy90ZW1wbGF0ZS9saXN0Lmh0bWwnKSwgJ3V0ZjgnKTtcblxuZXhwb3J0IGNvbnN0IG5hbWUgPSAnY29uc29sZS1saXN0JztcblxuZXhwb3J0IGNvbnN0IHByb3BzID0ge1xuICAgIGZvbnRTaXplOiB7IHR5cGU6IE51bWJlciB9LFxuICAgIGxpbmVIZWlnaHQ6IHsgdHlwZTogTnVtYmVyIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZGF0YSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB0aW1lcjogbnVsbCxcbiAgICAgICAgY2FjaGVMaXN0TGVuZ3RoOiAwLFxuICAgICAgICBzaG93TGlzdDogW10sXG4gICAgICAgIHdyYXBwZXJTdHlsZTogeyBoZWlnaHQ6IDAgfSxcbiAgICAgICAgaXNSZW5kaW5nOiBmYWxzZSxcbiAgICAgICAgbGlzdFRyYW5zZm9ybVk6IDAsXG4gICAgICAgIHJlcGxhY2VUZXh0VGltZXI6IG51bGwsXG4gICAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGNvbXB1dGVkOiBhbnkgPSB7XG4gICAgbGlzdFN0eWxlKCkge1xuICAgICAgICBjb25zdCB7IGxpc3RUcmFuc2Zvcm1ZLCBmb250U2l6ZSwgbGluZUhlaWdodCB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiBgdHJhbnNsYXRlWSgke2xpc3RUcmFuc2Zvcm1ZfXB4KWAsXG4gICAgICAgICAgICAnLS1mb250LXNpemUnOiBgJHtmb250U2l6ZX1weGAsXG4gICAgICAgICAgICAnLS1saW5lLWhlaWdodCc6IGAke2xpbmVIZWlnaHR9cHhgLFxuICAgICAgICB9O1xuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3Qgd2F0Y2g6IGFueSA9IHtcbiAgICBsaW5lSGVpZ2h0KHZhbDogbnVtYmVyKSB7XG4gICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdCgpO1xuICAgICAgICB9XG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBtZXRob2RzOiBhbnkgPSB7XG4gICAgLyoqXG4gICAgICog5YiH5o2i5raI5oGv5YW35L2T5YaF5a655pi+56S6XG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHRyYW5zbGF0ZVlcbiAgICAgKi9cbiAgICB0b2dnbGVDb250ZW50KHRyYW5zbGF0ZVk6IG51bWJlcikge1xuICAgICAgICBjb25zdCBpdGVtID0gb3V0cHV0TGlzdC5maW5kKChpdGVtOiBJTWVzc2FnZUl0ZW0pID0+IGl0ZW0udHJhbnNsYXRlWSA9PT0gdHJhbnNsYXRlWSk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICBpdGVtLmZvbGQgPSAhaXRlbS5mb2xkO1xuICAgICAgICAgICAgbWFuYWdlci51cGRhdGUoKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgY3JlYXRlSXRlbSgpOiBJTWVzc2FnZUl0ZW0ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVudDogW10sXG4gICAgICAgICAgICByb3dzOiAwLFxuICAgICAgICAgICAgbWVzc2FnZTogJycsXG4gICAgICAgICAgICB0eXBlOiAnbG9nJyxcbiAgICAgICAgICAgIHRpdGxlOiAnJyxcbiAgICAgICAgICAgIHRleHR1cmU6ICcnLFxuICAgICAgICAgICAgY291bnQ6IDEsXG4gICAgICAgICAgICBmb2xkOiB0cnVlLFxuICAgICAgICAgICAgc2hvdzogZmFsc2UsXG4gICAgICAgICAgICBzdGFjazogW10sXG4gICAgICAgICAgICB0cmFuc2xhdGVZOiAtMTAwMCxcbiAgICAgICAgfTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiuoeeul+aJgOaciea2iOaBr+WGheWuuemrmOW6plxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0SGVpZ2h0KCk6IG51bWJlciB7XG4gICAgICAgIGxldCBoZWlnaHQgPSAwO1xuICAgICAgICBvdXRwdXRMaXN0LmZvckVhY2goKGl0ZW06IElNZXNzYWdlSXRlbSkgPT4ge1xuICAgICAgICAgICAgaXRlbS5mb2xkID8gKGhlaWdodCArPSB0aGlzLmxpbmVIZWlnaHQpIDogKGhlaWdodCArPSBpdGVtLnJvd3MgKiB0aGlzLmxpbmVIZWlnaHQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGhlaWdodDtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOiOt+WPlua7muWKqOS9jee9ruWvueW6lOeahOa2iOaBr2luZGV4XG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHNjcm9sbFRvcFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsaW5lSGVpZ2h0XG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBnZXRTY3JvbGxQb3NpdGlvbihzY3JvbGxUb3A6IG51bWJlciwgbGluZUhlaWdodDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGhlaWdodCA9IDA7XG4gICAgICAgIGxldCBpbmRleCA9IDA7XG4gICAgICAgIG91dHB1dExpc3Quc29tZSgoaXRlbTogSU1lc3NhZ2VJdGVtLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLmZvbGQpIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgKz0gbGluZUhlaWdodDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ICs9IGl0ZW0ucm93cyAqIGxpbmVIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaGVpZ2h0ID4gc2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgaW5kZXggPSBpIC0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBNYXRoLm1heChpbmRleCwgMCk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDmuLLmn5Plj6/op4Hmtojmga/liJfooahcbiAgICAgKi9cbiAgICByZW5kZXJMaXN0KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pc1JlbmRpbmcpIHtcbiAgICAgICAgICAgIGlmIChyZW5kZXJMaXN0VGltZXIpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHJlbmRlckxpc3RUaW1lcik7XG4gICAgICAgICAgICAgICAgcmVuZGVyTGlzdFRpbWVyID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlbmRlckxpc3RUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckxpc3QoKTtcbiAgICAgICAgICAgIH0sIDIwMCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc1JlbmRpbmcgPSB0cnVlO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmdldEhlaWdodCgpO1xuICAgICAgICB0aGlzLndyYXBwZXJTdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xuXG4gICAgICAgIGNvbnN0IGxpbmVIZWlnaHQgPSB0aGlzLmxpbmVIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGNsaWVudEhlaWdodCA9IHRoaXMuJGVsLmNsaWVudEhlaWdodDtcbiAgICAgICAgY29uc3QgaXRlbUNvdW50OiBudW1iZXIgPSBNYXRoLmNlaWwoY2xpZW50SGVpZ2h0IC8gbGluZUhlaWdodCkgKyAzO1xuICAgICAgICB0aGlzLnNob3dMaXN0LnNwbGljZShpdGVtQ291bnQpO1xuXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IHRoaXMuJGVsLnNjcm9sbFRvcDtcblxuICAgICAgICBjb25zdCBkZWx0YSA9IG91dHB1dExpc3QubGVuZ3RoIC0gdGhpcy5jYWNoZUxpc3RMZW5ndGg7XG4gICAgICAgIGNvbnN0IGlzQXRCb3R0b20gPSBoZWlnaHQgLSBjbGllbnRIZWlnaHQgLSBzY3JvbGxUb3AgPD0gZGVsdGEgKiBsaW5lSGVpZ2h0O1xuICAgICAgICB0aGlzLmNhY2hlTGlzdExlbmd0aCA9IG91dHB1dExpc3QubGVuZ3RoO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbUNvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnNob3dMaXN0W2ldO1xuICAgICAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAvLyDpgb/lhY3pl6rng4FcbiAgICAgICAgICAgICAgICBpdGVtLnNob3cgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpdGVtLnRyYW5zbGF0ZVkgPSAtMTAwMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TGlzdC5wdXNoKHRoaXMuY3JlYXRlSXRlbSgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOacqua7muWKqOaIluiAheWcqOW6lemDqOmcgOimgea7muWKqOWIsOW6lemDqFxuICAgICAgICBpZiAoaXNBdEJvdHRvbSkge1xuICAgICAgICAgICAgLy8g5LiK5LiA5q2l6K6+572u5LqGIGhlaWdodO+8jOWunumZhei/mOacqueUn+aViO+8jOWcqOacqueUn+aViOWJjeiuvue9riBzY3JvbGxUb3Ag5Lya5aSx6LSlXG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuJGVsLnNjcm9sbFRvcCA9IGhlaWdodCAtIGNsaWVudEhlaWdodDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5vblNjcm9sbCgpO1xuICAgICAgICB0aGlzLmlzUmVuZGluZyA9IGZhbHNlO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5rua5Yqo5LqL5Lu2XG4gICAgICovXG4gICAgb25TY3JvbGwoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgaWYgKGlzT3BlcmF0aW5nKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpc09wZXJhdGluZyA9IHRydWU7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy4kZWwuc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCBpc1ZlcnRpY2FsU2Nyb2xsID0gTWF0aC5hYnMoc2Nyb2xsVG9wIC0gc2Nyb2xsVG9wY2FjaGUpID4gMjsvLyDlv73nlaXmqKrlkJHmu5rliqjnmoTml7blgJnpgKDmiJDovbvlvq7nmoTlnoLnm7Tmu5rliqhcbiAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnRhcmdldCAmJiBpc1ZlcnRpY2FsU2Nyb2xsKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBjb25zdCByb290ID0gZXZlbnQudGFyZ2V0LmdldFJvb3ROb2RlKCk7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSByb290LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xuICAgICAgICB9XG5cbiAgICAgICAgc2Nyb2xsVG9wY2FjaGUgPSBzY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IGxpbmVIZWlnaHQgPSB0aGlzLmxpbmVIZWlnaHQ7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5nZXRTY3JvbGxQb3NpdGlvbihzY3JvbGxUb3AsIGxpbmVIZWlnaHQpO1xuICAgICAgICB0aGlzLmxpc3RUcmFuc2Zvcm1ZID0gb3V0cHV0TGlzdFtpbmRleF0/LnRyYW5zbGF0ZVkgPz8gMDtcblxuICAgICAgICAvLyDpgY3ljobkuIvopoHmmL7npLrnmoTliJfooajlhYPntKDlr7nlrZjlnKjnmoRpdGVt6L+b6KGM5pWw5o2u5aGr5YWFXG4gICAgICAgIHRoaXMuc2hvd0xpc3QuZm9yRWFjaCgoaXRlbTogSU1lc3NhZ2VJdGVtLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dEl0ZW0gPSBvdXRwdXRMaXN0W2luZGV4ICsgaV07XG4gICAgICAgICAgICBpZiAoIW91dHB1dEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpdGVtLnRyYW5zbGF0ZVkgPSAtMTAwMDtcbiAgICAgICAgICAgICAgICBpdGVtLnNob3cgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaXRlbS5kYXRlID0gb3V0cHV0SXRlbS5kYXRlO1xuICAgICAgICAgICAgICAgIGl0ZW0udHlwZSA9IG91dHB1dEl0ZW0udHlwZTtcbiAgICAgICAgICAgICAgICBpdGVtLnJvd3MgPSBvdXRwdXRJdGVtLnJvd3M7XG4gICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IG91dHB1dEl0ZW0udGl0bGU7XG4gICAgICAgICAgICAgICAgaXRlbS5jb250ZW50ID0gb3V0cHV0SXRlbS5jb250ZW50O1xuICAgICAgICAgICAgICAgIGl0ZW0uY291bnQgPSBvdXRwdXRJdGVtLmNvdW50O1xuICAgICAgICAgICAgICAgIGl0ZW0uZm9sZCA9IG91dHB1dEl0ZW0uZm9sZDtcbiAgICAgICAgICAgICAgICBpdGVtLnRyYW5zbGF0ZVkgPSBvdXRwdXRJdGVtLnRyYW5zbGF0ZVk7XG4gICAgICAgICAgICAgICAgaXRlbS50ZXh0dXJlID0gKGluZGV4ICsgaSkgJSAyID09PSAwID8gJ2RhcmsnIDogJ2xpZ2h0JztcbiAgICAgICAgICAgICAgICBpdGVtLnN0YWNrID0gb3V0cHV0SXRlbS5zdGFjaztcbiAgICAgICAgICAgICAgICBpdGVtLnNob3cgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpc09wZXJhdGluZyA9IGZhbHNlO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICog5pi+56S65aSN5Yi26I+c5Y2VXG4gICAgICogQHBhcmFtIHsqfSBldmVudFxuICAgICAqIEBwYXJhbSB7Kn0gaXRlbVxuICAgICAqL1xuICAgIHNob3dNZW51UGFzdChldmVudDogYW55LCBpdGVtOiBhbnkpIHtcbiAgICAgICAgbGV0IGluZm8gPSBpdGVtLnRpdGxlO1xuICAgICAgICBpZiAoaXRlbS5yb3dzID4gMSkge1xuICAgICAgICAgICAgaXRlbS5jb250ZW50LmZvckVhY2goKHN0cjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgaW5mbyArPSBgJHtzdHJ9IFxcbmA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGl0ZW0uc3RhY2s/LmZvckVhY2g/Ligoc3RyOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBpbmZvICs9IGAke3N0cn0gXFxuYDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIEVkaXRvci5NZW51LnBvcHVwKHtcbiAgICAgICAgICAgIHg6IGV2ZW50LnBhZ2VYLFxuICAgICAgICAgICAgeTogZXZlbnQucGFnZVksXG4gICAgICAgICAgICBtZW51OiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnY29uc29sZS5jb3B5JyksXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgRWRpdG9yLkNsaXBib2FyZC53cml0ZSgndGV4dCcsIGluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIOagvOW8j+WMliB0ZXh0IOmHjOmdouWPr+iDveacieeahOiEmuacrOi3r+W+hFxuICAgICAqIOmcgOimgemrmOS6rui3r+W+hFxuICAgICAqIEBwYXJhbSB0ZXh0XG4gICAgICovXG4gICAgcmVuZGVyVGV4dCh0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgICAgICByZXR1cm4gdGV4dDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOi9rOS5iSBodG1sIOagh+etvueahOWwluaLrOWPt1xuICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpO1xuXG4gICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1xcKChmaWxlOlxcL1xcL1xcL1teKV0rKVxcKS9nLCAobWF0Y2hlciwgcDEpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBmaWxlVVJMVG9QYXRoKHAxKTtcbiAgICAgICAgICAgIHJldHVybiBge2xpbmtbJHtwYXRofV0oJHtwYXRofSl9YDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXFx7KFtcXHddKykoPzpcXFsoW15bXSopXFxdKT8oPzpcXCgoW14oKV0qKVxcKSlcXH0vZ2ksIChtYXRjaGVyLCB0eXBlLCB0ZXh0LCB1cmwpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGxvd2VyVHlwZSA9IHR5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGlmIChyZW5kZXJUeXBlc1tsb3dlclR5cGVdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlclR5cGVzW2xvd2VyVHlwZV0odGV4dCwgdXJsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXI7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRleHQgPSByZXBsYWNlSHR0cEFuZExvY2FsUGF0aDJVSUxpbmsodGV4dCk7XG5cbiAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIOeCueWHu+aWh+acrOeahOaXtuWAmeinpuWPkVxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIG9uVGV4dENsaWNrKGV2ZW50OiBhbnkpIHtcbiAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnYnViYmxlJykgPT09IG51bGwgJiYgdGhpcy4kZWwgIT09IGV2ZW50LnRhcmdldCkge1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5aaC5p6c5pyJ6YCJ5Lit77yM5LiN6Kem5Y+R5oqY5Y+gL+WxleW8gFxuICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSBldmVudC50YXJnZXQuZ2V0Um9vdE5vZGUoKS5nZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBzZWxlY3Rpb24uYmFzZU9mZnNldCAhPT0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0KSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuIl19