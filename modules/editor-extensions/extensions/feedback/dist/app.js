"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),util_image_1=require("./util-image"),render_1=require("@editor/sentry/render"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.default=Vue.extend({name:"FeedbackPanel",data(){return{imageList:[],maxImageLength:3,uploading:!1,text:"",maxTextLength:8192,isPosting:!1,isPostSuccess:!1,needShowTip:!1}},computed:{disableSubmit(){return this.isPosting||this.text.length<20}},methods:{onChange(e){this.text=e,this.text=this.text.slice(0,this.maxTextLength)},onConfirm(e){this.text=e,this.text=this.text.slice(0,this.maxTextLength)},async onFileChange(e){const t=e.target;e=Array.from(t.files||[]);this.uploading||(this.uploading=!0,await this.addImages(e),this.$nextTick(()=>{t.value="",this.uploading=!1}))},async addImages(e){for(const t of e){if(this.imageList.length===this.maxImageLength)return void console.log("Image limit reached");await(0,util_image_1.compressImage)(t,2097152).then(e=>{this.imageList.push({url:URL.createObjectURL(e),file:t})}).catch(console.error)}},deleteImage(e){var t=this.imageList[e];t&&(URL.revokeObjectURL(t.url),this.imageList.splice(e,1))},async onPaste(e){var t=e.clipboardData?.files;t?.length&&(e.preventDefault(),this.uploading||(this.uploading=!0,e=Array.from(t).filter(e=>e.type.startsWith("image/")),await this.addImages(e),this.uploading=!1))},async submit(){this.isPosting=!0;var e=await Promise.all(this.imageList.map(async e=>{var t=await(0,util_image_1.blobToUint8Array)(e.file);return{filename:e.file.name,data:t}}));let t={nickname:"",email:""};try{t=await Editor.User.getData()}catch(e){console.error(e)}e=render_1.sentry.captureFeedback({name:t?.nickname,email:t?.email,message:this.text},{attachments:e});this.isPostSuccess=Boolean(e),this.showTip(),this.$nextTick(()=>{this.isPostSuccess&&this.clear()}),this.isPosting=!1},showTip(){this.needShowTip=!0,setTimeout(()=>{this.needShowTip=!1},2e3)},clear(){this.text="",this.imageList.forEach(e=>{URL.revokeObjectURL(e.url)}),this.imageList=[]}},template:(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../static/panel.html"),"utf8")});