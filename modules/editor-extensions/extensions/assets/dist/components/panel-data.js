"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extension=exports.config=exports.act=exports.clear=exports.$=void 0;const path_1=require("path");function clear(){exports.$.panel=null,exports.$.searchInput=null,exports.$.toggleExpandIcon=null,exports.$.viewBox=null,exports.$.tree=null}exports.$={panel:null,searchInput:null,toggleExpandIcon:null,viewBox:null,tree:null},exports.clear=clear,exports.act={selects:[],twinkles:{},twinkleQueue:[]},exports.config={protocol:"db://",assetHeight:20,iconWidth:16,nodeLeft:6,assetTypes(){return this.buildinTypes.concat(this.extendDrop.types)},buildinTypes:[],extendMenu:{packages:{},show(e,t){const o=[],s=this.packages;let n;t&&(n={displayName:t.displayName,extends:t.extends,importer:t.importer,isDirectory:t.isDirectory,instantiation:t.instantiation,imported:t.imported,invalid:t.invalid,name:t.name,file:t.file,redirect:t.redirect,readonly:t.readonly,type:t.type,url:t.url,uuid:t.uuid});for(const t in s){const r=s[t];if(!r)continue;const a=r[e];if(!a||!r.methods[a])continue;const i=r.methods[a](n);Array.isArray(i)&&i.length&&(o.push({type:"separator"}),o.push(...i))}return o},attach(e,t){exports.config.extendMenu.packages[e]=t},detach(e){delete exports.config.extendMenu.packages[e]}},extendDrop:{types:[],callbacks:{},attach(e,t){t.forEach(t=>{const o=t.type;o&&!this.types.includes(o)&&(this.types.push(o),this.callbacks[o]||(this.callbacks[o]={}),this.callbacks[o][e]=((o,s)=>{Editor.Message.send(e,t.message,o,s)}))})},detach(e,t){t.forEach(t=>{const o=t.type;o&&this.types.includes(o)&&(this.types=this.types.filter(e=>e!==o),this.callbacks[o]&&delete this.callbacks[o][e])})}},extendSearch:{packages:{},show(e,t){const o={},s=this.packages;for(const n in s){const r=s[n];if(!r)continue;const a=r[e];if(!a||!r.methods[a])continue;const i=r.methods[a](t);Array.isArray(i)&&i.length&&(o[n]=i)}return o},attach(e,t){exports.config.extendSearch.packages[e]=t},detach(e){delete exports.config.extendSearch.packages[e]}},async update(){this.buildinTypes=await Editor.Message.request("asset-db","query-all-asset-types")}};const localFileMap={};function generateLocalFileExtend(){exports.$.panel.localFileExtend=Object.values(localFileMap).flat()}exports.extension={attach(e){if(e.invalid)return;if(!e.info.contributions||!e.info.contributions.assets)return;try{const t=e.info.contributions.assets;if(Array.isArray(t.drop)&&exports.config.extendDrop.attach(e.name,t.drop),t.menu&&"string"==typeof t.menu.methods){const o=(0,path_1.join)(e.path,t.menu.methods);Editor.Module.__protected__.removeCache(o);const s=o.replace(/^\w:/,e=>e.toLocaleUpperCase());Editor.Module.__protected__.removeCache(s),t.menu.methods=Editor.Module.__protected__.requireFile(o),exports.config.extendMenu.attach(e.name,t.menu)}if(t.search&&"string"==typeof t.search.methods){const o=(0,path_1.join)(e.path,t.search.methods);Editor.Module.__protected__.removeCache(o);const s=o.replace(/^\w:/,e=>e.toLocaleUpperCase());Editor.Module.__protected__.removeCache(s),t.search.methods=Editor.Module.__protected__.requireFile(o),exports.config.extendSearch.attach(e.name,t.search)}exports.$.tree.update()}catch(e){console.error(e)}const t=e.info.contributions.assets.localFile;Array.isArray(t)&&(localFileMap[e.name]=t.map(t=>{const o=(0,path_1.join)("extension"===t.type?e.path:Editor.Project.path,t.path);return t.path=o,t})),generateLocalFileExtend()},detach(e){if(e.invalid)return;if(!e.info.contributions||!e.info.contributions.assets)return;try{const t=e.info.contributions.assets;Array.isArray(t.drop)&&exports.config.extendDrop.detach(e.name,t.drop),t.menu&&exports.config.extendMenu.detach(e.name),t.search&&exports.config.extendSearch.detach(e.name),exports.$.tree.update()}catch(e){console.error(e)}const t=e.info.contributions.assets.localFile;Array.isArray(t)&&delete localFileMap[e.name],generateLocalFileExtend()}};