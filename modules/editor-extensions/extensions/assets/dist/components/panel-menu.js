"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,n){void 0===n&&(n=a),e[n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.popupContextMenu=exports.popupSortMenu=exports.popupSearchMenu=exports.popupPanelMenu=exports.popupCreateMenu=void 0;const electron_1=require("electron"),path_1=require("path"),fs_extra_1=require("fs-extra"),panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils"));function createTypeScriptMenu(e,t){const a={label:"NewComponent",click(){e({type:"ts",fileName:"NewComponent",importer:"typescript"})}};let n={label:Editor.I18n.t("assets.menu.newTypeScript"),submenu:[a]};const r=path_1.join(Editor.Project.path,".creator/asset-template/typescript");fs_extra_1.ensureDirSync(r);const s="Custom Script Template Help Documentation.url",l=path_1.join(r,s);if(!fs_extra_1.existsSync(l)){const e="[InternetShortcut]\nURL=https://docs.cocos.com/creator/manual/en/scripting/setup.html#custom-script-template";fs_extra_1.outputFileSync(l,e)}if(fs_extra_1.existsSync(r)){fs_extra_1.readdirSync(r).forEach(t=>{const a=path_1.join(r,t);fs_extra_1.statSync(a).isDirectory()||t!==s&&n.submenu.push({label:t,click(){const n=fs_extra_1.readFileSync(a,"utf-8");e({type:"ts",content:n,fileName:path_1.basename(t,path_1.extname(t)),importer:"typescript"})}})})}return n.submenu.push({label:Editor.I18n.t("assets.menu.setCustomTypeScript"),click(){electron_1.shell.showItemInFolder(l)}}),n}function prependCancelSearchMenu(e){utils.isSearchingMode()&&e.unshift({label:Editor.I18n.t("assets.menu.cancelSearch"),click(){panelData.$.panel.clearSearch()}},{type:"separator"})}function createMenu(e,t){return mergeMenu([{label:Editor.I18n.t("assets.menu.newFolder"),click(){e({type:"directory",fileName:"folder",importer:"directory"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newScene"),async click(){const t={type:"scene",fileName:"scene",importer:"scene",template:"scene"},a=await Editor.Profile.getProject("engine","modules.includeModules");a&&!a.includes("3d")&&(t.template=t.fileName="scene-2d"),e(t)}},{label:Editor.I18n.t("assets.menu.newPrefab"),click(){e({type:"prefab",fileName:"Node",importer:"prefab"})}},{type:"separator"},createTypeScriptMenu(e,t),{type:"separator"},{label:Editor.I18n.t("assets.menu.newMaterial"),click(){e({type:"mtl",fileName:"material",importer:"material"})}},{label:Editor.I18n.t("assets.menu.newPhysicsMaterial"),click(){e({type:"pmtl",fileName:"physics-material",importer:"physics-material"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newCubeMap"),click(){e({type:"cubemap",fileName:"cubemap",importer:"texture-cube"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newRenderTexture"),click(){e({type:"rt",fileName:"render-texture",importer:"render-texture"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newEffect"),click(){e({type:"effect",fileName:"effect",importer:"effect"})}},{label:Editor.I18n.t("assets.menu.newChunk"),click(){e({type:"chunk",fileName:"chunk",importer:"effect-header"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newAnimation"),click(){e({type:"anim",fileName:"animation",importer:"animation-clip"})}},{label:Editor.I18n.t("assets.menu.newAnimationGraph"),click(){e({type:"animgraph",fileName:"Animation Graph",importer:"animation-graph"})}},{label:Editor.I18n.t("assets.menu.newAnimationMask"),click(){e({type:"animask",fileName:"Animation Mask",importer:"animation-mask",content:""})}},{label:Editor.I18n.t("assets.menu.newAnimationGraphTS"),click(){e({type:"ts",fileName:"AnimationGraphComponent",importer:"typescript",template:"ts-animation-graph"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newPac"),click(){e({type:"pac",fileName:"auto-atlas",importer:"auto-atlas"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.newLabelAtlas"),click(){e({type:"labelatlas",fileName:"label-atlas",importer:"label-atlas"})}},{type:"separator"},{label:Editor.I18n.t("assets.menu.renderPipeline"),sublabel:Editor.I18n.t("assets.menu.experimental"),submenu:[{label:Editor.I18n.t("assets.menu.renderPipelineAsset"),click(){e({type:"rpp",fileName:"custom-render-pipeline",importer:"render-pipeline"})}},{label:Editor.I18n.t("assets.menu.forwardPipelineAsset"),click(){e({type:"rpp",fileName:"custom-forward-pipeline",importer:"render-pipeline",template:"forward-pipeline"})}},{label:Editor.I18n.t("assets.menu.renderPipelineTS"),click(){e({type:"ts",fileName:"custom-render-pipeline",importer:"typescript",template:"ts-render-pipeline"})}},{label:Editor.I18n.t("assets.menu.RenderFlowTS"),click(){e({type:"ts",fileName:"custom-render-flow",importer:"typescript",template:"ts-render-flow"})}},{label:Editor.I18n.t("assets.menu.RenderStageTS"),click(){e({type:"ts",fileName:"custom-render-stage",importer:"typescript",template:"ts-render-stage"})}}]},{type:"separator"},{label:Editor.I18n.t("assets.menu.newTerrain"),click(){e({type:"terrain",fileName:"terrain",importer:"terrain"})}},{type:"extend-menu"}],"createMenu",t)}async function popupCreateMenu(){await panelData.config.update(),Editor.Menu.popup({menu:createMenu(e=>{panelData.$.tree.addTo(e)})})}function panelMenu(){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),submenu:createMenu(e=>{panelData.$.tree.addTo(e)})},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:!utils.isEmptyToPaste(),click(){panelData.$.tree.paste()}},{type:"extend-menu"}],"panelMenu")}async function popupPanelMenu(){await panelData.config.update();const e=panelMenu();prependCancelSearchMenu(e),Editor.Menu.popup({menu:e})}function searchMenu(){const{searchAssetTypes:e,searchType:t}=panelData.$.panel,a=[{label:Editor.I18n.t("assets.menu.searchTypeAll"),type:"checkbox",checked:0===e.length,click(){panelData.$.panel.searchAssetTypes=[]}}],n=panelData.config.assetTypes(),r=panelData.config.extendSearch.show("typeMenu");for(const e in r){r[e].forEach(e=>{-1===n.indexOf(e)&&n.push(e)})}n&&n.length&&n.forEach(t=>{const n=e.includes(t),r={label:t,type:"checkbox",checked:n,click(){if(n){const a=e.filter(e=>e!==t);panelData.$.panel.searchAssetTypes=a}else panelData.$.panel.searchAssetTypes.push(t)}};a.push(r)});const s=[{label:Editor.I18n.t("assets.menu.searchType"),submenu:a},{label:Editor.I18n.t("assets.menu.searchName"),type:"radio",checked:"name"===t,click(){panelData.$.panel.searchType="name"}},{label:Editor.I18n.t("assets.menu.searchUuid"),type:"radio",checked:"uuid"===t,click(){panelData.$.panel.searchType="uuid",panelData.$.panel.searchTypeLabel=Editor.I18n.t("assets.menu.searchUuid")}},{label:Editor.I18n.t("assets.menu.searchUrl"),type:"radio",checked:"url"===t,click(){panelData.$.panel.searchType="url",panelData.$.panel.searchTypeLabel=Editor.I18n.t("assets.menu.searchUrl")}},{label:Editor.I18n.t("assets.menu.searchUsages"),type:"radio",checked:"usages"===t,click(){panelData.$.panel.searchType="usages",panelData.$.panel.searchTypeLabel=Editor.I18n.t("assets.menu.searchUsages")}},{label:Editor.I18n.t("assets.menu.searchFails"),type:"radio",checked:"fails"===t,click(){panelData.$.panel.searchType="fails",panelData.$.panel.searchTypeLabel=Editor.I18n.t("assets.menu.searchFails")}}],l=panelData.config.extendSearch.show("searchMenu");for(const e in l){l[e].forEach(a=>{const n=`${e}-${a.key}`;s.push({label:a.label,type:"radio",checked:t===n,click(){panelData.$.panel.searchType=n,panelData.$.panel.searchTypeLabel=a.label,panelData.$.panel.extendSearchFunc[n]=a.handler}})})}return s}async function popupSearchMenu(){await panelData.config.update(),Editor.Menu.popup({menu:searchMenu()})}function sortMenu(){const{sortType:e}=panelData.$.panel;return[{label:Editor.I18n.t("assets.menu.sortName"),type:"radio",checked:"name"===e,click(){panelData.$.panel.sortType="name"}},{label:Editor.I18n.t("assets.menu.sortType"),type:"radio",checked:"type"===e,click(){panelData.$.panel.sortType="type"}}]}function popupSortMenu(){Editor.Menu.popup({menu:sortMenu()})}function consoleMenu(e){return[{type:"separator"},{label:Editor.I18n.t("assets.menu.showUuidTitle"),submenu:[{label:Editor.I18n.t("assets.menu.showUuid"),click(){Editor.Clipboard.write("text",e.uuid);const t=["UUID ",Editor.I18n.t("assets.menu.doneCopied"),"  ",e.uuid];if(!e.isDB){const a=Editor.Utils.UUID.compressUUID(e.uuid,"cc.Script"!==e.type);t.push(" , ",Editor.I18n.t("assets.menu.compressedUuid"),"  ",a)}console.info(...t)}},{label:Editor.I18n.t("assets.menu.showURL"),click(){Editor.Clipboard.write("text",e.url),console.info("URL ",Editor.I18n.t("assets.menu.doneCopied"),"  ",e.url)}},{label:Editor.I18n.t("assets.menu.showPath"),enabled:!!e.file,click(){Editor.Clipboard.write("text",e.file),console.info("FilePath ",Editor.I18n.t("assets.menu.doneCopied"),"  ",e.file)}},{label:Editor.I18n.t("assets.menu.showName"),click(){Editor.Clipboard.write("text",e.name),console.info("Name ",Editor.I18n.t("assets.menu.doneCopied"),"  ",e.name)}}]}]}function dbMenu(e){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),enabled:!utils.canNotCreate(e),submenu:createMenu(t=>{t.uuid=e.uuid,panelData.$.tree.addTo(t)},e)},{type:"separator"},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:!utils.canNotPaste(e),click(){panelData.$.tree.paste(e.uuid)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.searchInFolder"),click(){panelData.$.panel.searchInFolder=utils.getDirectory(e.uuid)}},{type:"extend-menu"},{type:"separator"},{label:Editor.I18n.t(`assets.menu.${"darwin"===process.platform?"revealInFinder":"revealInExplorer"}`),enabled:!utils.canNotRevealInExplorer(e),click(){electron_1.shell.showItemInFolder(e.file)}},...consoleMenu(e)],"dbMenu",e)}function assetMenu(e){return mergeMenu([{label:Editor.I18n.t("assets.menu.new"),enabled:e&&!e.readonly,submenu:createMenu(t=>{t.uuid=e.uuid,panelData.$.tree.addTo(t)},e)},{type:"separator"},{label:Editor.I18n.t("assets.menu.copy"),accelerator:"CmdOrCtrl+C",enabled:!utils.canNotCopy(e),click(){panelData.$.tree.copy(e.uuid)}},{label:Editor.I18n.t("assets.menu.duplicate"),accelerator:"CmdOrCtrl+D",enabled:!utils.canNotDuplicate(e),click(){const{selects:t}=panelData.act;let a=[e.uuid];Array.isArray(t)&&t.includes(e.uuid)&&(a=t.slice()),panelData.$.tree.duplicate(a)}},{label:Editor.I18n.t("assets.menu.cut"),accelerator:"CmdOrCtrl+X",enabled:!utils.canNotCut(e),click(){panelData.$.tree.cut(e.uuid)}},{label:Editor.I18n.t("assets.menu.paste"),accelerator:"CmdOrCtrl+V",enabled:e&&!e.readonly&&!utils.isEmptyToPaste(),click(){panelData.$.tree.paste(e.uuid)}},{label:Editor.I18n.t("assets.menu.rename"),accelerator:"Enter",enabled:!utils.canNotRename(e),click(){panelData.$.tree.renameUrl=e.url}},{type:"separator"},{label:Editor.I18n.t("assets.menu.delete"),accelerator:"Delete",enabled:!utils.canNotDelete(e),click(){panelData.$.tree.delete(e.uuid)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.selectAll"),accelerator:"CmdOrCtrl+A",click(){panelData.$.tree.selectAll(e.uuid)}},{label:Editor.I18n.t("assets.menu.searchInFolder"),click(){panelData.$.panel.searchInFolder=utils.getDirectory(e.uuid)}},{label:Editor.I18n.t("assets.menu.searchUsages"),click(){panelData.$.panel.searchType="usages",panelData.$.panel.searchTypeLabel=Editor.I18n.t("assets.menu.searchUsages"),panelData.$.panel.searchValue=e.uuid}},{type:"extend-menu"},{type:"separator"},{label:Editor.I18n.t(`assets.menu.${"darwin"===process.platform?"revealInFinder":"revealInExplorer"}`),enabled:!utils.canNotRevealInExplorer(e),click(){electron_1.shell.showItemInFolder(e.file)}},{type:"separator"},{label:Editor.I18n.t("assets.menu.reimport"),visible:!utils.canNotReimport(e),click(){panelData.$.tree.reimport(e.uuid)}},{label:Editor.I18n.t("assets.menu.revealInlibrary"),enabled:!utils.canNotRevealInLibrary(e),click(){const t=Object.keys(e.library);if(0===t.length)return;const a=e.library[t[0]];a&&electron_1.shell.showItemInFolder(a)}},...consoleMenu(e)],"assetMenu",e)}async function popupContextMenu(e){await panelData.config.update();const t=e.isDB?dbMenu(e):assetMenu(e);prependCancelSearchMenu(t),Editor.Menu.popup({menu:t})}function mergeMenu(e,t,a){const n=panelData.config.extendMenu.show(t,a),r=e.findIndex(e=>"extend-menu"===e.type),s=e.slice();return s.splice(r,1,...n),s}exports.popupCreateMenu=popupCreateMenu,exports.popupPanelMenu=popupPanelMenu,exports.popupSearchMenu=popupSearchMenu,exports.popupSortMenu=popupSortMenu,exports.popupContextMenu=popupContextMenu;