"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.thumbnail=exports.twinkle=exports.closestWhichCanCreate=exports.scrollIntoView=exports.isAIncludeB=exports.getChildrenUuid=exports.getDirectory=exports.getSibling=exports.getParent=exports.getChildrenForPreview=exports.getAssetForPreview=exports.getAsset=exports.scriptName=exports.isSearchingMode=exports.canNotReimport=exports.canNotRevealInLibrary=exports.canNotRevealInExplorer=exports.canNotDrop=exports.isEmptyToPaste=exports.canNotPaste=exports.canNotDrag=exports.canNotRename=exports.canNotCut=exports.canNotDuplicate=exports.canNotCopy=exports.canNotCreate=exports.canNotDelete=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),url_1=require("url"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function canNotDelete(e){return!e||e.isDB||e.readonly||e.isSubAsset}function canNotCreate(e){return!e||e.isSubAsset||e.readonly||!e.isDirectory}function canNotCopy(e){return!e||e.isDB||e.isSubAsset}function canNotDuplicate(e){if(!e||!e.uuid)return!0;const t=treeData.uuidToParentUuid[e.uuid];return t&&canNotCreate(treeData.uuidToAsset[t])}function canNotCut(e){return canNotDelete(e)}function canNotRename(e){return canNotDelete(e)}function canNotDrag(e){return!e||e.isDB}function canNotPaste(e){return!e||e.isSubAsset||e.readonly||!e.isDirectory}function isEmptyToPaste(){const e=Editor.Clipboard.read("assets-copied-info"),t=!e||!e.assetInfo.length,a=Editor.Clipboard.read("assets-cut-info"),r=!a||!a.assetInfo.length||Editor.Project.path!==a.projectPath;return t&&r}function canNotDrop(e){return!e||e.readonly}function canNotRevealInExplorer(e){return!e||!e.file||e.isSubAsset}function canNotRevealInLibrary(e){return!e||0===Object.keys(e.library).length}function canNotReimport(e){return!e||e.isDB}function isSearchingMode(){const e=panelData.$.panel;if(!e)return!1;const{searchValue:t,searchType:a,searchInFolder:r,searchAssetTypes:s}=e;return""!==t||"fails"===a||r||!!s.length}function getAsset(e){return e?treeData.uuidToAsset[e]:null}async function getAssetForPreview(e,t){if(!e||t)return null;const a=treeData.uuidToAsset[e];return a||await Editor.Message.request("assets","query-asset",e,!0)}async function getChildrenForPreview(e,t){if(!e||t)return null;const a=treeData.uuidToChildren[e];return a&&a.length?a.map(e=>treeData.uuidToAsset[e]).filter(Boolean):await Editor.Message.request("assets","query-children",e,!0)}function getParent(e){if(!e)return null;return getAsset(treeData.uuidToParentUuid[e])}function getSibling(e){const{displayArray:t,uuidToAsset:a}=treeData,r=t.indexOf(e),s=t.length-1;let i=r-1,n=r+1;return 0===r&&(i=s),r===t.length-1&&(n=0),[a[e],a[t[i]],a[t[n]]]}function getDirectory(e){const t=getAsset(e);return!!t&&(t.isDirectory?t:getDirectory(treeData.uuidToParentUuid[e]))}function getChildrenUuid(e,t,a=!1,r=!1){const s=treeData.uuidToChildren[e];if(!s)return;if(a&&!treeData.uuidToExpand[e])return;const i=s.length;for(let e=0;e<i;e++){const i=s[e],n=getAsset(i);if(n&&(t.push(i),n.isParent)){if(r&&!n.isDirectory)continue;getChildrenUuid(i,t,a,r)}}}function isAIncludeB(e,t){const a=treeData.uuidToAsset[e],r=treeData.uuidToAsset[t];return!(!a||!r)&&r.url.startsWith(`${a.url}/`)}function scrollIntoView(e,t=!1){const a=getAsset(e);if(!a)return;treeData.pointExpand(e);const r=panelData.$.tree.scrollTop,s=panelData.$.tree.scrollTop+panelData.$.viewBox.clientHeight-panelData.config.assetHeight-4,i=panelData.$.viewBox.offsetWidth,n=panelData.$.viewBox.scrollWidth;let o=panelData.$.viewBox.scrollLeft,c=panelData.$.viewBox.scrollTop;const l=o>a.left,u=i<n&&.3*i<a.left-o;(l||u)&&(o=a.left-2*panelData.config.iconWidth);const p=treeData.displayArray.indexOf(e)*panelData.config.assetHeight;t?c=p-panelData.$.viewBox.clientHeight/2:p<=r?c=p:p>=s&&(c=p-panelData.$.viewBox.clientHeight+panelData.config.assetHeight+4,setTimeout(()=>{c=p-panelData.$.viewBox.clientHeight+panelData.config.assetHeight+4,panelData.$.viewBox.scrollWidth!==panelData.$.viewBox.clientWidth&&(c+=10),panelData.$.viewBox.scrollTo(o,c)},100)),panelData.$.tree.$nextTick(()=>{panelData.$.viewBox.scrollTo(o,c)})}function closestWhichCanCreate(e){const t=getAsset(e);return t?canNotCreate(t)?closestWhichCanCreate(treeData.uuidToParentUuid[e]):t:null}exports.canNotDelete=canNotDelete,exports.canNotCreate=canNotCreate,exports.canNotCopy=canNotCopy,exports.canNotDuplicate=canNotDuplicate,exports.canNotCut=canNotCut,exports.canNotRename=canNotRename,exports.canNotDrag=canNotDrag,exports.canNotPaste=canNotPaste,exports.isEmptyToPaste=isEmptyToPaste,exports.canNotDrop=canNotDrop,exports.canNotRevealInExplorer=canNotRevealInExplorer,exports.canNotRevealInLibrary=canNotRevealInLibrary,exports.canNotReimport=canNotReimport,exports.isSearchingMode=isSearchingMode,exports.scriptName={allScripts:null,allClassNames:[],timer:0,fileName:"",className:"",classNameStringFormat:"",requiredCamelCaseClassName:!1,async isValid(e){let t="";if(this.requiredCamelCaseClassName){const a=this.getValidCamelCaseClassName(e);t=this.classNameStringFormat.replace("<%CamelCaseClassName%>",a).trim()||a}else{const a=this.getValidClassName(e);t=this.classNameStringFormat.replace("<%UnderscoreCaseClassName%>",a).trim()||a}if(!t)return{state:"errorScriptClassName"};return await Editor.Message.request("scene","query-component-has-script",t)?{state:"errorScriptClassNameExist",message:t}:{state:""}},async getValidFileName(e){(e=e.trim().replace(/[^a-zA-Z0-9_-]/g,""))&&!isFinite(e)||(e="NewComponent");const t=e;let a=0;for(;(await this.isValid(e)).state;){if(a>1e3)return e;e=`${t}${`-${(++a).toString().padStart(3,"0")}`}`}return e},getValidClassName(e){const t=(e=e.trim().replace(/^[^a-zA-Z_]+/g,"")).match(/[a-zA-Z0-9_]+/g);return t?t.join("_"):""},getValidCamelCaseClassName(e){const t=(e=e.trim().replace(/^[^a-zA-Z]+/g,"")).match(/[a-zA-Z0-9]+/g);return t?t.filter(Boolean).map(e=>e[0].toLocaleUpperCase()+e.substr(1)).join(""):""}},exports.getAsset=getAsset,exports.getAssetForPreview=getAssetForPreview,exports.getChildrenForPreview=getChildrenForPreview,exports.getParent=getParent,exports.getSibling=getSibling,exports.getDirectory=getDirectory,exports.getChildrenUuid=getChildrenUuid,exports.isAIncludeB=isAIncludeB,exports.scrollIntoView=scrollIntoView,exports.closestWhichCanCreate=closestWhichCanCreate,exports.twinkle={requestAnimationId:0,watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="shake"){this.watch&&(panelData.act.twinkles[e]=t,setTimeout(()=>{panelData.act.twinkles[e]=void 0,delete panelData.act.twinkles[e],window.cancelAnimationFrame(this.requestAnimationId),this.requestAnimationId=requestAnimationFrame(()=>{panelData.$.tree.render()})},1e3))}},exports.thumbnail={dbInfos:{},emptyMark:"none",async get(e){const t=url_1.parse(e.path);let a=this.dbInfos[t.host];if(!a){a=await Editor.Message.request("asset-db","query-db-info",t.host),this.dbInfos[t.host]=a;const e=path_1.join(a.temp,"thumbnail");fs_extra_1.existsSync(e)&&fs_extra_1.removeSync(e)}const r=e.uuid.split("@")[0],s=path_1.join(a.temp,"thumbnail",r,e.uuid);if(fs_extra_1.existsSync(s)){return fs_extra_1.readFileSync(s,"utf8")}return s},async set(e,t,a={}){if(e===this.emptyMark)return fs_extra_1.outputFileSync(t,e),e;const r=document.createElement("img");r.src=e.replace("#","%23");const s=await new Promise(e=>{r.addEventListener("load",()=>{e(r)}),r.addEventListener("error",()=>{e(!1)})});if(!1===s)return s;let i=a.width||r.width,n=a.height||r.height;const o=Math.max(i,n)/32,c=document.createElement("canvas");c.width=32,c.height=32;const l=c.getContext("2d");if(a.rotated){const e=c.width/2,t=c.height/2;l.translate(e,t),l.rotate(-90*Math.PI/180),l.translate(-e,-t),i=a.height,n=a.width}l.drawImage(r,a.trimX||0,a.trimY||0,i,n,(32-i/o)/2,(32-n/o)/2,i/o,n/o);const u=c.toDataURL("image/*");return fs_extra_1.outputFileSync(t,u),u},delete(e){const t=getAsset(e);if(!t)return;const a=url_1.parse(t.path),r=this.dbInfos[a.host];if(!r)return;const s=path_1.join(r.temp,"thumbnail",t.uuid);if(fs_extra_1.existsSync(s)){fs_extra_1.removeSync(s);const t=treeData.uuidToChildren[e];if(t){const e=t.length;for(let a=0;a<e;a++)this.delete(t[a])}}},async image(e,t=""){let a=path_1.extname(e.name).toLowerCase();if(t)return[".tga",".hdr",".bmp"].includes(a)&&(a=".png"),e.library[a];const r=await this.get(e);if(!r||r===this.emptyMark||r.startsWith("data:image"))return r;const s=this.getLibraryImageSrc(e.library,a),i=await this.set(`${s}?${e.refreshTime}`,r);return!1===i&&console.warn(`Load thumbnail failed: ${e.url}`),i},async subImage(e,t=""){if(t)return await this.subImageOrigin(e);const a=await this.get(e);if(!a||a===this.emptyMark||a.startsWith("data:image"))return a;const r=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!r||!r.userData)return this.set(this.emptyMark,a);let s=r.userData.imageUuidOrDatabaseUri;if("gltf-embeded-image"===r.importer?s=r.uuid:"texture-cube-face"===r.importer?s=r.uuid:"sprite-frame"===r.importer&&(s=r.userData.imageUuidOrDatabaseUri.split("@")[0]),!s)return this.set(this.emptyMark,a);const i=getAsset(s);if(!i)return this.set(this.emptyMark,a);const n=path_1.extname(i.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(i.library,n);return await this.set(`${o}?${e.refreshTime}`,a,r.userData)},async subImageOrigin(e){const t=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!t||!t.userData)return this.emptyMark;const{userData:a}=t,r=(a.imageUuidOrDatabaseUri||t.uuid).split("@");r.length>1&&r.pop();const s=r.join("@"),i=await getAssetForPreview(s);if(!i)return this.emptyMark;const n=path_1.extname(i.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(i.library,n);if(!o){const e=await getAssetForPreview(t.uuid);if(!e||!e.library)return"none";const a=[".png",".jpg",".jpge"];for(const t of a)if(t in e.library)return e.library[t];return"none"}const c=document.createElement("img");if(c.src=`${o.replace("#","%23")}?${e.refreshTime}`,!1===await new Promise(e=>{c.addEventListener("load",()=>{e(c)}),c.addEventListener("error",()=>{e(!1)})}))return this.emptyMark;let l=a.width||c.width,u=a.height||c.height;const p=document.createElement("canvas"),d=p.getContext("2d");if(p.width=l,p.height=u,a.rotated){const e=p.width/2,t=p.height/2;d.translate(e,t),d.rotate(-90*Math.PI/180),d.translate(-e,-t),l=a.height,u=a.width}return d.drawImage(c,a.trimX||0,a.trimY||0,l,u,0,0,l,u),p.toDataURL("image/png")},getLibraryImageSrc(e,t){let a=e[t];if(!a){a=e[Object.keys(e).find(e=>".json"!==e)||""]}return a}};