"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.pointExpand=exports.toggleExpand=exports.loopExpand=exports.outputDisplay=exports.resort=exports.renderImmediately=exports.render=exports.unFreeze=exports.deleted=exports.added=exports.changed=exports.clear=exports.reset=exports.uuidToExpand=exports.uuidToIndex=exports.uuidToDepth=exports.displayArray=exports.uuidToChildrenSorted=exports.uuidToChildren=exports.uuidToParentUuid=exports.uuidToState=exports.fileToUuid=exports.urlToUuid=exports.uuidToAsset=exports.dbInternal=exports.dbAssets=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils"));let refreshTime,renderAnimationId;async function reset(){const e=await Editor.Message.request("asset-db","query-assets");e?(clear(),e.sort((e,t)=>{const r=e.url.startsWith(exports.dbAssets),o=e.url.startsWith(exports.dbInternal),s=t.url.startsWith(exports.dbAssets),i=t.url.startsWith(exports.dbInternal);return!r&&!o||s||i?r||o||!s&&!i?collator.compare(e.url,t.url):1:-1}),exports.uuidToChildrenSorted[panelData.config.protocol]=!0,buildTree(e),render()):console.error("The data requested from asset-db is empty.")}function clear(){exports.uuidToAsset={},exports.urlToUuid={},exports.fileToUuid={},exports.uuidToChildren={},exports.uuidToChildrenSorted={},exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToParentUuid={},exports.uuidToState={},exports.displayArray=[],exports.uuidToIndex={length:0},refreshTime=Date.now()}function changed(e,t){if(e.includes("@")){const t=exports.uuidToParentUuid[e];return void(t&&unFreeze(t)&&render())}refreshTime=Date.now();const r=exports.uuidToAsset[e],o=exports.uuidToParentUuid[e];if(!r)return void console.error(`Can not change the asset "${t.url}", because the original asset is not exist. Maybe it is a new asset.`);if(delete exports.urlToUuid[r.url],delete exports.fileToUuid[r.file],r.isParent&&!r.isDirectory){const r=exports.uuidToChildren[e];for(const e of r)loopDeleteSelf(e);delete exports.uuidToChildren[e],delete exports.uuidToChildrenSorted[e];const o=Object.keys(t.subAssets);if(o.length){const r={children:{},uuid:e};for(const e of o)r.children[e]={children:{}},buildTreeData(t.subAssets[e],r.children[e],r)}}exports.uuidToAsset[e]=t,exports.urlToUuid[t.url]=e,t.file&&(exports.fileToUuid[t.file]=e),exports.uuidToState[e]="";const s=path_1.dirname(t.url),i=exports.urlToUuid[s];if(i){if(i&&i!==o){const t=exports.uuidToChildren[o];if(t){-1!==t.indexOf(e)&&t.splice(t.indexOf(e),1)}exports.uuidToChildren[i]||(exports.uuidToChildren[i]=[],unFreeze(i)),exports.uuidToChildren[i].includes(e)||exports.uuidToChildren[i].push(e),exports.uuidToParentUuid[e]=i,exports.uuidToChildrenSorted[i]=!1,exports.uuidToState[i]=""}unFreezeDirectory(e),render()}}function added(e,t){const r=path_1.dirname(t.url),o=exports.urlToUuid[r];if(!o)return;refreshTime=Date.now(),exports.uuidToAsset[e]=t,exports.urlToUuid[t.url]=e,t.file&&(exports.fileToUuid[t.file]=e);const s=Object.keys(t.subAssets);if(s.length){const r={children:{},uuid:e};for(const e of s)r.children[e]={children:{}},buildTreeData(t.subAssets[e],r.children[e],r)}exports.uuidToChildren[o]||(exports.uuidToChildren[o]=[],unFreeze(o)),exports.uuidToChildren[o].includes(e)||exports.uuidToChildren[o].push(e),exports.uuidToParentUuid[e]=o,exports.uuidToState[o]="",exports.uuidToChildrenSorted[o]=!1,updateRootAsset(o),unFreezeDirectory(o),render()}function deleted(e,t){loopDeleteSelf(e);const r=exports.uuidToParentUuid[e];if(r){unFreeze(r);const t=exports.uuidToChildren[r];if(t&&t.length){const r=t.indexOf(e);-1!==r&&t.splice(r,1)}}updateRootAsset(r),render()}function loopDeleteSelf(e){const t=exports.uuidToChildren[e];if(t&&t.length)for(const e of t)loopDeleteSelf(e);const r=exports.uuidToAsset[e];r&&(delete exports.urlToUuid[r.url],delete exports.fileToUuid[r.file]),delete exports.uuidToAsset[e],delete exports.uuidToChildren[e],delete exports.uuidToChildrenSorted[e],delete exports.uuidToExpand[e],delete exports.uuidToDepth[e],delete exports.uuidToIndex[e],delete exports.uuidToState[e]}function updateRootAsset(e){exports.uuidToParentUuid[e]===panelData.config.protocol&&unFreeze(e)}function unFreezeDirectory(e){const t=exports.uuidToAsset[e];if(t&&t.isDirectory){unFreeze(e);const t=exports.uuidToChildren[e];if(Array.isArray(t))for(const e of t)unFreeze(e)}}function unFreeze(e){return void 0===exports.uuidToAsset[e]||!(!exports.uuidToAsset[e]||!Object.isFrozen(exports.uuidToAsset[e]))&&(exports.uuidToAsset[e]=JSON.parse(JSON.stringify(exports.uuidToAsset[e])),!0)}function render(){cancelAnimationFrame(renderAnimationId),renderAnimationId=requestAnimationFrame(()=>{renderImmediately()})}async function renderImmediately(){exports.displayArray=[],exports.uuidToExpand[panelData.config.protocol]=!0,exports.uuidToIndex={length:0},utils.isSearchingMode()?await searchData(exports.displayArray):(renderData(panelData.config.protocol,-1),getAllExpands(panelData.config.protocol,exports.displayArray)),panelData.$.tree.render()}function resort(){exports.uuidToChildrenSorted={},render()}function outputDisplay(e,t){const r=[];if(exports.displayArray.length)for(let o=e;o<t;o++){const e=displayData(exports.displayArray[o]);e&&r.push(e)}return Object.freeze(r),r}function loopExpand(e,t){function r(e,t){const o=exports.uuidToChildren[e];if(o){const e=o.length;for(let s=0;s<e;s++){const e=o[s];exports.uuidToExpand[e]=t,r(e,t)}}}void 0===t&&(t=!exports.uuidToExpand[e]),t?(r(e,t),toggleExpand(e,t)):(toggleExpand(e,t),r(e,t),render())}function toggleExpand(e,t){void 0===t&&(t=!exports.uuidToExpand[e]),exports.uuidToExpand[e]!==t&&(exports.uuidToExpand[e]=t,render())}async function pointExpand(e){let t=e,r=exports.displayArray.includes(t);for(;t&&!r;)t=exports.uuidToParentUuid[t],exports.uuidToExpand[t]=!0,r=exports.displayArray.includes(t);await renderImmediately()}function buildTree(e){const t={children:{},uuid:panelData.config.protocol},r=t.uuid.length;for(const o of e){if(!o.url)return;const e=o.url.substr(r).split("/");let s=t,i=t;for(const t of e)t&&(i.children[t]||(i.children[t]={children:{},uuid:""}),s=i,i=i.children[t]);buildTreeData(o,i,s)}}function buildTreeData(e,t,r){if(e.uuid){t.uuid=e.uuid,e.isDirectory&&!exports.uuidToChildren[e.uuid]&&(exports.uuidToChildren[e.uuid]=[]),exports.uuidToAsset[e.uuid]=e,exports.urlToUuid[e.url]=e.uuid,e.file&&(exports.fileToUuid[e.file]=e.uuid),exports.uuidToChildren[r.uuid]||(exports.uuidToChildren[r.uuid]=[]),exports.uuidToChildren[r.uuid].includes(e.uuid)||exports.uuidToChildren[r.uuid].push(e.uuid),exports.uuidToParentUuid[e.uuid]=r.uuid;for(const r in e.subAssets)t.children[r]={children:{}},buildTreeData(e.subAssets[r],t.children[r],t)}}function renderData(e,t){exports.uuidToDepth[e]=t,exports.uuidToIndex[e]=exports.uuidToIndex.length,exports.uuidToIndex.length++;const r=exports.uuidToChildren[e];if(!r||!r.length)return;const o=r.length;exports.uuidToChildrenSorted[e]||(sortTree(r),exports.uuidToChildrenSorted[e]=!0),t++;for(let e=0;e<o;e++)renderData(r[e],t)}function displayData(e){const t=exports.uuidToAsset[e];if(!t||Object.isFrozen(t))return t;const r=exports.uuidToDepth[e],o=0===r,s=path_1.extname(t.name);t.isDB=o,t.isDirectory=!!o||t.isDirectory,t.isParent=exports.uuidToChildren[e]&&exports.uuidToChildren[e].length,t.isSubAsset=!!e.includes("@"),t.fileExt=t.isDirectory?"":s.toLocaleLowerCase(),t.fileName=t.isDirectory?t.name:t.name.substr(0,t.name.lastIndexOf(s)),t.depth=r;const{iconWidth:i,iconWidthMinus:u,nodeLeft:n}=panelData.config;t.left=(t.isParent?r:r+1)*i+n,t.isParent||(t.left+=u),t.refreshTime=refreshTime;const d=[];if(t.redirect){d.push({type:t.redirect.type,value:t.redirect.uuid,name:t.name});const e=exports.uuidToAsset[t.redirect.uuid];e&&e.extends&&e.extends.length>0&&e.extends.forEach(r=>{d.push({type:r,value:e.uuid,name:t.name})})}t.extends&&t.extends.length>0&&t.extends.forEach(e=>{d.push({type:e,value:t.uuid,name:t.name})});for(const e in t.subAssets){const r=t.subAssets[e];t.redirect&&t.redirect.uuid===r.uuid||(d.push({type:r.type,value:r.uuid,name:t.name}),r.extends&&r.extends.length>0&&r.extends.forEach(e=>{d.push({type:e,value:r.uuid,name:r.name})}))}return t.additional=d,Object.freeze(t),t}async function searchData(e){let{searchValue:t}=panelData.$.panel;const{searchType:r,searchAssetTypes:o,searchInFolder:s,extendSearchFunc:i}=panelData.$.panel;let u=t;"name"!==r&&"uuid"!==r||!Editor.Utils.UUID.isUUID(t)||(u=Editor.Utils.UUID.decompressUUID(t));let n=t;if("usages"===r){const e=Editor.Utils.UUID.decompressUUID(t),r=exports.uuidToAsset[e];r&&"cc.Script"!==r.type?t=e:n=Editor.Utils.UUID.compressUUID(t,!1)}panelData.$.panel.refreshLock=!0;for(const e of exports.uuidToChildren[panelData.config.protocol]){const t=exports.uuidToChildren[e];if(t&&t.length)for(const e of t)await d(e)}async function d(l){const a=exports.uuidToAsset[l];if(!a||!1===a.visible)return;const{name:p,displayName:x,uuid:c,url:f,type:T,file:h}=a;let y=!0;if(s&&(f!==s.url&&f.startsWith(`${s.url}/`)||(y=!1)),o.length&&!o.includes(T)&&(y=!1),"fails"===r&&a.imported&&(y=!1),y){let o=!0;if(t)if(o=!1,"name"===r||"fails"===r){const e=t.toLocaleLowerCase();(`${p}${x}`.toLocaleLowerCase().includes(e)||c.includes(u))&&(o=!0)}else if("uuid"===r&&c.includes(u))o=!0;else if("url"===r&&f.includes(t))o=!0;else if("usages"===r){if(fs_extra_1.existsSync(h)){if(fs_extra_1.statSync(h).isFile()){const e=fs_extra_1.readFileSync(h);e.includes(t)?o=!0:t!==n&&e.includes(n)&&(o=!0)}}}else i[r]&&(o=await i[r](t,a));o&&(exports.uuidToIndex[c]=exports.uuidToIndex.length,exports.uuidToIndex.length++,e.push(c))}const m=exports.uuidToChildren[c];if(!m||!m.length)return;const D=m.length;for(let e=0;e<D;e++)await d(m[e])}sortTree(e,!0),panelData.$.panel.refreshLock=!1}function getAllExpands(e,t){const r=exports.uuidToChildren[e];if(r){const e=r.length;for(let o=0;o<e;o++){const e=r[o],s=exports.uuidToAsset[e];s&&!1!==s.visible&&(t.push(e),exports.uuidToExpand[e]&&getAllExpands(e,t))}}}exports.dbAssets="db://assets",exports.dbInternal="db://internal",exports.uuidToAsset={},exports.urlToUuid={},exports.fileToUuid={},exports.uuidToState={},exports.uuidToParentUuid={},exports.uuidToChildren={},exports.uuidToChildrenSorted={},exports.displayArray=[],exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToExpand={},exports.reset=reset,exports.clear=clear,exports.changed=changed,exports.added=added,exports.deleted=deleted,exports.unFreeze=unFreeze,exports.render=render,exports.renderImmediately=renderImmediately,exports.resort=resort,exports.outputDisplay=outputDisplay,exports.loopExpand=loopExpand,exports.toggleExpand=toggleExpand,exports.pointExpand=pointExpand;const collator=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});function sortTree(e,t){e.sort((e,r)=>{const o=exports.uuidToAsset[e],s=exports.uuidToAsset[r];return!0!==o.isDirectory||s.isDirectory?o.isDirectory||!0!==s.isDirectory?"type"===panelData.$.panel.sortType&&o.importer!==s.importer?collator.compare(o.importer,s.importer):t?collator.compare(`${o.displayName}${o.name}`,`${s.displayName}${s.name}`):collator.compare(o.path,s.path):1:-1})}