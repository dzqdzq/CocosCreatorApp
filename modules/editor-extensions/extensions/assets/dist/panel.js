"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),panel_menu_1=require("./components/panel-menu"),panelData=__importStar(require("./components/panel-data")),treeData=__importStar(require("./components/tree-data")),utils=__importStar(require("./components/utils")),util_1=require("./util"),Vue=require("vue/dist/vue.js");let panel,vm;async function ready(){(vm=new Vue({el:(panel=this).$.content,components:{tree:require("./components/tree"),SepareteBox:require("./components/separete-box").default},data:{refocus:!1,dbReady:!1,warnCase:"",operateLock:!1,refreshLock:!1,isOperating:!1,refreshing:{type:"",name:""},droppableTypes:["file","cc.Node"],allExpand:null,viewWidth:0,viewHeight:0,treeHeight:0,dropBoxStyle:{},searchValue:"",searchInFolder:null,searchAssetTypes:[],searchType:"name",searchTypeLabel:"",extendSearchFunc:{},sortType:"name",localFileExtend:[]},computed:{searchPlaceholder(){let e=this.searchType;return["name","fails"].includes(e)&&(e="name"),`i18n:assets.menu.search${e.toLocaleUpperCase().substr(0,1)+e.substr(1)}`},hasLocalFileExtend(){return!!this.localFileExtend.length}},watch:{searchValue(){panelData.$.searchInput.value=vm.searchValue,panelData.$.tree.search()},searchAssetTypes(){panelData.$.searchInput.focus(),panelData.$.tree.search()},searchType(){"usages"===vm.searchType?vm.searchAssetTypes=["cc.SceneAsset","cc.Prefab","cc.Material","cc.AnimationClip"]:(panelData.$.searchInput.focus(),panelData.$.tree.search())},searchInFolder(){panelData.$.searchInput.focus(),panelData.$.tree.search()},sortType(){panelData.$.tree.sort()},async localFileExtend(){await panelData.$.panel.initLocalFileTree()}},async mounted(){panelData.$.panel=this,panelData.$.searchInput=this.$refs.searchInput,panelData.$.toggleExpandIcon=this.$refs.toggleExpandIcon,panelData.$.viewBox=this.$refs.viewBox,panelData.$.tree=this.$refs.tree,this.$refs.viewBox.addEventListener("scroll",e=>{vm.treeHeight>vm.viewHeight&&vm.treeHeight<vm.viewHeight+e.target.scrollTop?panelData.$.tree.scrollTop=vm.treeHeight-vm.viewHeight:panelData.$.tree.scrollTop=e.target.scrollTop},!1),this.resize()},methods:{t:e=>Editor.I18n.t(`assets.${e}`),async refresh(){try{vm.dbReady=!1,await panelData.config.update(),panelData.$.tree.update(),vm.isOperating=!0,await treeData.reset(),vm.isOperating=!1}catch(e){console.error(e)}finally{vm.dbReady=!0}},async refreshDB(){await Editor.Profile.getConfig("asset-db","autoScan")?this.refresh():(vm.refreshLock=!0,Editor.Message.send("asset-db","refresh-all-database"))},warnShow(e){vm.warnCase=e,vm.operateLock=!0},warnHide(){vm.warnCase="",vm.operateLock=!1,this.refresh()},clear(){vm.dbReady=!1,panelData.$.tree.clear()},allToggle(){panelData.$.tree.allToggle()},searchChange(){vm.searchValue=panelData.$.searchInput.value.trim()},searchArrowDown(e,t){e.target.blur(),vm.searchValue?panelData.$.tree.ipcSelectFirstChild():panelData.$.tree.upDownLeftRight(t)},cancelSearchType(){vm.searchType="name",vm.searchTypeLabel=""},cancelSearchInFolder(){vm.searchInFolder=null},cancelSearchAssetTypes(){vm.searchAssetTypes=[]},clearSearch(){vm.searchInFolder=null,vm.searchValue="",vm.searchAssetTypes=[],"fails"===vm.searchType&&(vm.searchType="name")},popupCreateMenu:panel_menu_1.popupCreateMenu,popupSearchMenu:panel_menu_1.popupSearchMenu,popupSortMenu:panel_menu_1.popupSortMenu,popupPanelMenu:panel_menu_1.popupPanelMenu,resize(){vm&&panelData.$.viewBox&&(vm.viewWidth=panel.clientWidth,vm.viewHeight=panelData.$.viewBox.offsetHeight,panelData.$.tree.filterAssets())},focusWindow(){require("@electron/remote").getCurrentWindow().focus()},isSearchingMode:()=>utils.isSearchingMode(),async initLocalFileTree(){const e=this;if(!e.localFileExtend.length)return;const t=await Promise.all(e.localFileExtend.map(async e=>util_1.getPackageFileExtend(e.path)));e.$refs.localFile.tree=t,e.$refs.localFile.setTemplate("text",'<span class="name"></span>'),e.$refs.localFile.setTemplateInit("text",e=>{e.$name=e.querySelector(".name")}),e.$refs.localFile.setRender("text",(e,t)=>{e.$name.innerHTML=t.detail.value}),e.$refs.localFile.setTemplateInit("item",t=>{const a=e.$refs.localFile;t.addEventListener("dblclick",e=>{t.data.isDirectory||util_1.openFile(t.data.filePath,t.data.root),a.render()})}),e.$refs.localFile.setRender("item",(e,t)=>{t.detail.disabled?e.setAttribute("disabled",""):e.removeAttribute("disabled")})}}})).dbReady=await Editor.Message.request("asset-db","query-ready"),vm.dbReady&&(Editor.Metrics.trackTimeStart("assets:render-tree"),await exports.methods.unstaging(),await vm.refresh(),panelData.$.tree.resetSelected(),Editor.Metrics.trackTimeEnd("assets:render-tree",{output:!0})),new IntersectionObserver(e=>{e.forEach(e=>{0!==e.intersectionRatio&&vm.resize()})},{root:vm.$el,rootMargin:"0px",threshold:.1}).observe(panelData.$.viewBox),Editor.Package.getPackages({enable:!0}).forEach(panelData.extension.attach),Editor.Package.__protected__.on("enable",panelData.extension.attach),Editor.Package.__protected__.on("disable",panelData.extension.detach)}async function beforeClose(){vm&&await exports.methods.staging()}async function close(){vm&&(vm.dbReady=!1,panelData.clear(),treeData.clear()),Editor.Package.__protected__.removeListener("enable",panelData.extension.attach),Editor.Package.__protected__.removeListener("disable",panelData.extension.detach)}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=fs_1.readFileSync(path_1.join(__dirname,"../dist/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../static/template/index.html"),"utf8"),exports.fonts=[{name:"assets"}],exports.$={content:".assets"},exports.methods={async staging(){const e=[];for(const t in treeData.uuidToExpand)treeData.uuidToAsset[t]&&!0===treeData.uuidToExpand[t]&&e.push(t);await Editor.Message.request("assets","staging",{expandUuids:e,sortType:vm.sortType})},async unstaging(){const e=await Editor.Message.request("assets","unstaging");if(!e)return;const{expandUuids:t,sortType:a}=e;Array.isArray(t)&&t.forEach(e=>{treeData.uuidToExpand[e]=!0}),a&&(vm.sortType=a)},find(){panelData.$.searchInput.focus()},copy(){panelData.$.tree.copy()},paste(){if(!vm.isOperating)try{panelData.$.tree.paste(),vm.isOperating=!0}catch(e){console.error(e)}finally{setTimeout(()=>{vm.isOperating=!1},200)}},cut(){panelData.$.tree.cut()},duplicate(){if(!vm.isOperating)try{panelData.$.tree.duplicate(),vm.isOperating=!0}catch(e){console.error(e)}finally{setTimeout(()=>{vm.isOperating=!1},200)}},delete(){panelData.$.tree.delete()},up(){panelData.$.tree.upDownLeftRight("up")},down(){panelData.$.tree.upDownLeftRight("down")},left(){panelData.$.tree.upDownLeftRight("left")},right(){panelData.$.tree.upDownLeftRight("right")},shiftUp(){panelData.$.tree.shiftUpDown("up")},shiftDown(){panelData.$.tree.shiftUpDown("down")},rename(){panelData.$.tree.keyboardRename()},selectAll(){panelData.$.tree.selectAll()},selectClear(){panelData.$.tree.selectClear()},async ready(){Editor.Metrics.trackTimeStart("assets:render-tree"),await exports.methods.unstaging(),await vm.refresh(),panelData.$.tree.resetSelected(),Editor.Metrics.trackTimeEnd("assets:render-tree",{output:!0})},refreshFinish(){vm.refreshLock=!1},close(){vm.clear()},dbReady(){vm.dbReady&&vm.refresh()},dbClose(){vm.dbReady&&vm.refresh()},dbPause(e){vm.dbReady&&vm.warnShow(e)},dbResume(){vm.dbReady&&vm.warnHide()},async added(e,t){vm.dbReady&&await panelData.$.tree.added(e,t)},async deleted(e,t){vm.dbReady&&await panelData.$.tree.deleted(e,t)},async changed(e,t){vm.dbReady&&await panelData.$.tree.changed(e,t)},selected(e,t){vm.dbReady&&"asset"===e&&panelData.$.tree.selected(t)},unselected(e,t){vm.dbReady&&"asset"===e&&panelData.$.tree.unselected(t)},async twinkle(e,t="shake"){if(!e)return;const a=treeData.urlToUuid[e]||treeData.fileToUuid[e];a&&(e=a),utils.twinkle.add(e,t),await utils.scrollIntoView(e,!0)},queryAsset:async(e,t)=>await utils.getAssetForPreview(e,t),queryChildren:async(e,t)=>await utils.getChildrenForPreview(e,t)},exports.listeners={resize(){vm&&vm.resize()},show(){vm&&vm.resize()},focus(){vm&&(vm.refocus=!0,setTimeout(()=>{vm.refocus=!1},300))}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;