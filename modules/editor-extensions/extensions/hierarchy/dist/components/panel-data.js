"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extension=exports.config=exports.ready=exports.act=exports.$=void 0;const path_1=require("path"),Profile=require("@base/electron-profile");async function queryMessageProtocolScene(){try{const e=await Editor.Profile.getConfig("hierarchy","message-protocol");e&&Object.assign(exports.act.messageProtocol,e)}catch(e){console.error(e),exports.act.messageProtocol.scene="scene"}}async function onMessageProtocolChange(e,t,o){"defaultPreferences"===e&&"packages/hierarchy.json"===t&&"message-protocol"===o&&(await queryMessageProtocolScene(),exports.$.panel.$el.isConnected?await exports.$.panel.refresh():Profile.removeListener("change",onMessageProtocolChange))}async function ready(e){if(Profile.removeListener("change",onMessageProtocolChange),Profile.on("change",onMessageProtocolChange),queryMessageProtocolScene(),await exports.config.update(),exports.act.assetUuid=e.assetUuid,exports.act.expandLevels=e.expandLevels,e.animationUuid){if("animation"===await Editor.Message.request(exports.act.messageProtocol.scene,"query-scene-mode"))return void(exports.act.animationUuid=e.animationUuid);exports.act.animationUuid=""}exports.act.assetInfo=await Editor.Message.request("asset-db","query-asset-info",exports.act.assetUuid),exports.act.selects.length=0,exports.$.tree.clear()}exports.$={panel:null,searchInput:null,toggleExpandIcon:null,viewBox:null,tree:null},exports.act={assetUuid:"",assetInfo:{},messageProtocol:{scene:"scene"},animationUuid:"",expandLevels:[],selects:[],twinkleQueues:[]},exports.ready=ready,exports.config={nodeHeight:20,iconWidth:16,padding:4,creatableTypes:[],extendMenu:{packages:{},async show(e,t){const o=[],s=this.packages;let a=void 0;if(t){const{active:e,isScene:o,name:s,parent:r,type:n,uuid:c,components:i,isPrefabRoot:p,readonly:l,prefab:d}=t;a={active:e,isScene:o,name:s,parent:r,type:n,uuid:c,components:i,isPrefabRoot:p,readonly:l,prefab:d}}for(const t in s){const r=s[t];if(!r)continue;const n=r[e];if(!n||!r.methods[n])continue;const c=await r.methods[n](a);Array.isArray(c)&&c.length&&(o.push({type:"separator"}),o.push(...c))}return o},attach(e,t){exports.config.extendMenu.packages[e]=t},detach(e){delete exports.config.extendMenu.packages[e]}},extendDrop:{types:[],callbacks:{},attach(e,t){t.forEach(t=>{const o=t.type;o&&!this.types.includes(o)&&(this.types.push(o),this.callbacks[o]||(this.callbacks[o]={}),this.callbacks[o][e]=((o,s)=>{Editor.Message.send(e,t.message,o,s)}))})},detach(e,t){t.forEach(t=>{const o=t.type;o&&this.types.includes(o)&&(this.types=this.types.filter(e=>e!==o),this.callbacks[o]&&delete this.callbacks[o][e])})}},async update(){this.creatableTypes=await Editor.Message.request(exports.act.messageProtocol.scene,"query-creatable-asset-types")}},exports.extension={attach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.hierarchy)try{const t=e.info.contributions.hierarchy;if(Array.isArray(t.drop)&&exports.config.extendDrop.attach(e.name,t.drop),t.menu&&"string"==typeof t.menu.methods){const o=(0,path_1.join)(e.path,t.menu.methods);Editor.Module.__protected__.removeCache(o);const s=o.replace(/^\w:/,e=>e.toLocaleUpperCase());Editor.Module.__protected__.removeCache(s),t.menu.methods=Editor.Module.__protected__.requireFile(o),exports.config.extendMenu.attach(e.name,t.menu)}exports.$.tree.update()}catch(e){console.error(e)}},detach(e){if(!e.invalid&&e.info.contributions&&e.info.contributions.hierarchy)try{const t=e.info.contributions.hierarchy;Array.isArray(t.drop)&&exports.config.extendDrop.detach(e.name,t.drop),t.menu&&exports.config.extendMenu.detach(e.name),exports.$.tree.update()}catch(e){console.error(e)}}};