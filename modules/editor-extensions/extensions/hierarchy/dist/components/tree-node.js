"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,n)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,a=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[a.length]=t);return a})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a=n(e),r=0;r<a.length;r++)"default"!==a[r]&&__createBinding(t,e,a[r]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.inject=exports.methods=exports.watch=exports.computed=exports.props=exports.template=exports.name=void 0,exports.data=data,exports.mounted=mounted;const path_1=require("path"),fs_1=require("fs"),treeData=__importStar(require("./tree-data")),panelData=__importStar(require("./panel-data")),panel_menu_1=require("./panel-menu"),utils=__importStar(require("./utils"));let renameTimeId;function data(){return{renameValue:"",renameInputState:"",addValue:"",addInputState:"",addInputStyle:{},editPrefabIconStyle:{left:0},assetIcon:{type:"icon",value:"scene"}}}async function mounted(){this.assetIcon=await this.queryAssetIcon()}exports.name="tree-node",exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.props=["node","renameUuid","addNode"],exports.computed={state(){var e=this,t=e.node;return t?e.renameUuid===t.uuid?"rename":e.addNode.sibling===t.uuid?"add":e.addNode.parent===t.uuid?"creating":treeData.uuidToState[t.uuid]||"":""},draggable(){var e=this.node;return""!==this.state||utils.canNotDragNode(e)?"false":"true"},style(){return{paddingLeft:utils.getDisplayNodeLeft(this.node)+"px"}},showEditPrefabIcon(){var e=this.node,t=e.prefab&&e.prefab.state&&3!==e.prefab.state;if(t&&!e.prefab.assetUuid.includes("@"))return e.prefab.assetUuid!==panelData.act.assetUuid;return!1},showCustomComponent(){return this.node.components.some(e=>e.isCustom&&!Editor.UI.__protected__.Icon.Map.component[e.type])&&this.profile.showCustomScriptIcon},componentIcon(){var e=this.node.components.sort(utils.sortComponents);return e.length?e[0].type:null}},exports.watch={state:{handler(){const e=this;var t=e.node;if("rename"===e.state)e.renameValue=t.name,e.renameInputState="",window.setTimeout(()=>{e.$refs.renameInput&&e.$refs.renameInput.focusInput()});else if("add"===e.state){const{name:n,parent:i}=e.addNode;var{iconWidth:t,padding:a}=panelData.config,r=(e.addValue=n,e.addInputState="",utils.getNode(i));e.addInputStyle={paddingLeft:(r.depth+2)*t+a+"px"},window.setTimeout(()=>{e.$refs.addInput&&(e.$refs.addInput.focus({preventScroll:!0}),e.$refs.addInput.setSelectionRange(0,n.length))})}},immediate:!0}},exports.methods={t(e){return panelData.$.panel.t(e)},popupMenu(e){(0,panel_menu_1.popupContextMenu)(e)},click(e,t){t.shiftKey?panelData.$.tree.shiftClick(e.uuid):t.ctrlKey||t.metaKey?panelData.$.tree.ctrlClick(e.uuid):panelData.$.tree.ipcSelect(e.uuid)},dblclick(e){clearTimeout(renameTimeId),Editor.Message.send(panelData.act.messageProtocol.scene,"focus-camera",[e.uuid])},rename(e,t){panelData.$.tree.renameUuid=e.uuid,t.preventDefault(),t.stopPropagation()},canRename(e){return!utils.canNotRename(e)},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panelData.$.tree.toggle(e.uuid,void 0,t.altKey)},renameChange(e){this.renameValue=e.detail.value.trim(),this.renameInputState=""},renameSubmit(e){let t=e.detail.value.trim();""!==this.renameInputState&&(t=null),panelData.$.tree.rename(this.renameUuid||this.node.uuid,t)},renameCancel(){this.renameInputState="cancel",panelData.$.tree.rename(this.renameUuid||this.node.uuid,null)},addChange(){var e=this["addNode"];e.name=this.$refs.addInput.value.trim()},addSubmit(){var e,t;"add"===this.state&&(e=Object.assign({},this.addNode),t=this.$refs.addInput.value.trim(),e.name=t,panelData.$.tree.addConfirm(e))},addCancel(){this.$refs.addInput.value="",panelData.$.tree.addConfirm(null)},dragStart(e,t){const a=this;let r=[];panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{e=utils.getNode(e);e&&(r=a.mergeAdditional(r,e))}):r=a.mergeAdditional(r,e),t.dataTransfer&&(t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(r)),t.dataTransfer.setData("types",r.map(e=>e.type).join()),(e=new Image).src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(e,0,0))},dragOver(e,t){t.preventDefault();var a=t.currentTarget,r=a.getBoundingClientRect();let n="inside";t.clientY-r.top<=4?n="before":r.bottom-t.clientY<=7&&(n="after"),a.setAttribute("drag","over"),panelData.$.tree.dragOver(e.uuid,n,t.clientX,t.clientY,a)},dragEnter(e){e.stopPropagation(),e.preventDefault()},dragLeave(e,t){t=t.currentTarget;t.removeAttribute("insert"),t.removeAttribute("drag")},drop(e,t){var a,r,n,i;t.preventDefault(),e.readonly||(r=(a=t.currentTarget).getAttribute("insert"),a.removeAttribute("insert"),a.removeAttribute("drag"),panelData.$.tree.$el.hasAttribute("hoving")&&(t.stopPropagation(),panelData.$.tree.$el.removeAttribute("hoving"),n=JSON.parse(JSON.stringify(Editor.UI.__protected__.DragArea.currentDragInfo))||{},i=a.getAttribute(utils.ATTRIBUTE_TO_NODE)||"",a.removeAttribute(utils.ATTRIBUTE_TO_NODE),n.to=i||e.uuid,n.insert=r,n.copy=t.ctrlKey||"darwin"===process.platform&&t.altKey,n.keepWorldTransform=!t.shiftKey,panelData.$.tree.ipcDrop(n)))},mergeAdditional(e,t){let a=[{type:t.type,value:t.uuid}];return(a=Array.isArray(t.additional)&&t.additional.length?a.concat(t.additional):a).forEach(t=>{e.some(e=>e.type===t.type&&e.value===t.value)||e.push(t)}),e},toggleLock(e,t){const a=!e.locked,r=!t.altKey;panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{Editor.Message.send(panelData.act.messageProtocol.scene,"change-node-lock",e,a,r)}):Editor.Message.send(panelData.act.messageProtocol.scene,"change-node-lock",e.uuid,a,r)},showInsideLock(e){return function e(t){if(Array.isArray(treeData.uuidToChildren[t]))for(const r of treeData.uuidToChildren[t]){var a=utils.getNode(r);if(a){if(a.locked)return!0;if(e(r))return!0}}return!1}(e.uuid)},editPrefab(e){e.prefab&&e.prefab.assetUuid&&Editor.Message.request("asset-db","open-asset",e.prefab.assetUuid)},calcEditPrefabIconStyle(){var e=panelData.$.viewBox.clientWidth+panelData.$.viewBox.scrollLeft-26;this.editPrefabIconStyle.left=e+"px"},twinkle(e){utils.twinkle.asset(e)},async queryAssetIcon(){var e=this.node;if(!e.isPrefabRoot&&!e.isScene)return null;var t=e.isScene?e.uuid:e.prefab.assetUuid;if(!t)return null;e=e.isScene?{type:"icon",value:"scene"}:{type:"icon",value:"prefab"};try{var a=await Editor.UI.AssetImage.previewImageManager.get(t);if(a&&"file"!==a.value)return{type:"asset",value:t}}catch(e){console.debug(e)}return e}},exports.inject=["profile"];