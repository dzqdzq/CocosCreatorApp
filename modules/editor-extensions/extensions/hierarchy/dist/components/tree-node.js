"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.data=exports.methods=exports.watch=exports.computed=exports.props=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),treeData=__importStar(require("./tree-data")),panelData=__importStar(require("./panel-data")),panel_menu_1=require("./panel-menu"),utils=__importStar(require("./utils"));let renameTimeId;function data(){return{renameValue:"",renameInputState:"",addValue:"",addInputState:"",addInputStyle:{},editPrefabIconStyle:{left:0}}}exports.name="tree-node",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.props=["node","renameUuid","addNode"],exports.computed={state(){const e=this.node;return e?this.renameUuid===e.uuid?"rename":this.addNode.sibling===e.uuid?"add":this.addNode.parent===e.uuid?"loading":treeData.uuidToState[e.uuid]||"":""},draggable(){const e=this.node;return""!==this.state||utils.canNotDragNode(e)?"false":"true"},style(){return{paddingLeft:utils.getDisplayNodeLeft(this.node)+"px"}},showEditPrefabIcon(){const e=this.node;if(e.prefab&&e.prefab.state&&3!==e.prefab.state){if(!e.prefab.assetUuid.includes("@"))return e.prefab.assetUuid!==panelData.act.assetUuid}return!1}},exports.watch={state(){const e=this,t=e.node;if("rename"===e.state)e.renameValue=t.name,e.renameInputState="",window.setTimeout(()=>{e.$refs.renameInput&&(e.$refs.renameInput.focus({preventScroll:!0}),e.$refs.renameInput.setSelectionRange(0,t.name.length))});else if("add"===e.state){const{name:t,parent:a}=e.addNode,{iconWidth:r,padding:n}=panelData.config;e.addValue=t,e.addInputState="";const i=utils.getNode(a);e.addInputStyle={paddingLeft:(i.depth+2)*r+n+"px"},window.setTimeout(()=>{e.$refs.addInput&&(e.$refs.addInput.focus({preventScroll:!0}),e.$refs.addInput.setSelectionRange(0,t.length))})}}},exports.methods={t:e=>panelData.$.panel.t(e),popupMenu(e){panel_menu_1.popupContextMenu(e)},click(e,t){t.shiftKey?panelData.$.tree.shiftClick(e.uuid):t.ctrlKey||t.metaKey?panelData.$.tree.ctrlClick(e.uuid):panelData.$.tree.ipcSelect(e.uuid)},dblclick(e){clearTimeout(renameTimeId),Editor.Message.send("scene","focus-camera",[e.uuid])},rename(e,t){if(panelData.$.panel.refocus)return;const a=panelData.act.selects;utils.canNotRename(e)||t.ctrlKey||t.metaKey||1!==a.length||!a.includes(e.uuid)||(clearTimeout(renameTimeId),renameTimeId=setTimeout(()=>{panelData.$.tree.renameUuid=e.uuid},300),t.preventDefault(),t.stopPropagation())},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panelData.$.tree.toggle(e.uuid,void 0,t.altKey)},renameChange(){this.renameValue=this.$refs.renameInput.value.trim(),this.renameInputState=""},renameSubmit(){let e=this.$refs.renameInput.value.trim();""!==this.renameInputState&&(e=null),panelData.$.tree.rename(this.renameUuid||this.node.uuid,e)},renameCancel(){this.renameInputState="cancel",panelData.$.tree.rename(this.renameUuid||this.node.uuid,null)},addChange(){const{addNode:e}=this;e.name=this.$refs.addInput.value.trim()},addSubmit(){if("add"!==this.state)return;const e=Object.assign({},this.addNode),t=this.$refs.addInput.value.trim();e.name=t,panelData.$.tree.addConfirm(e)},addCancel(){this.$refs.addInput.value="",panelData.$.tree.addConfirm(null)},dragStart(e,t){const a=this;Editor.Message.send("scene","snapshot");let r=[];panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{const t=utils.getNode(e);t&&(r=a.mergeAdditional(r,t))}):r=a.mergeAdditional(r,e),t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(r));const n=new Image;n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(n,0,0)},dragOver(e,t){t.preventDefault();const a=t.currentTarget,r=a.getBoundingClientRect();let n="inside";t.clientY-r.top<=4?n="before":r.bottom-t.clientY<=4&&(n="after"),a.setAttribute("drag","over"),a.setAttribute("insert",n),panelData.$.tree.dragOver(e.uuid,n)},dragEnter(e){e.stopPropagation(),e.preventDefault()},dragLeave(e,t){const a=t.currentTarget;a.removeAttribute("insert"),a.removeAttribute("drag")},drop(e,t){if(t.preventDefault(),e.readonly)return;const a=t.currentTarget,r=a.getAttribute("insert");if(a.removeAttribute("insert"),a.removeAttribute("drag"),!panelData.$.tree.$el.hasAttribute("hoving"))return;t.stopPropagation(),panelData.$.tree.$el.removeAttribute("hoving");const n=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};n.to=e.uuid,n.insert=r,n.copy=t.ctrlKey,n.keepWorldTransform=!t.shiftKey,panelData.$.tree.ipcDrop(n)},mergeAdditional:(e,t)=>(e.push({type:t.type,value:t.uuid}),Array.isArray(t.additional)&&t.additional.length&&(e=e.concat(t.additional)),e),toggleLock(e,t){const a=!e.locked,r=!t.altKey;panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{Editor.Message.send("scene","change-node-lock",e,a,r)}):Editor.Message.send("scene","change-node-lock",e.uuid,a,r)},showInsideLock(e){return function e(t){for(const a of treeData.uuidToChildren[t]){const t=utils.getNode(a);if(t){if(t.locked)return!0;if(e(a))return!0}}return!1}(e.uuid)},editPrefab(e){e.prefab&&e.prefab.assetUuid&&Editor.Message.request("asset-db","open-asset",e.prefab.assetUuid)},calcEditPrefabIconStyle(){const e=panelData.$.viewBox.clientWidth+panelData.$.viewBox.scrollLeft-26;this.editPrefabIconStyle.left=`${e}px`}},exports.data=data;