'use strict';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.popupContextMenu = exports.popupSearchMenu = exports.popupPanelMenu = exports.popupCreateMenu = void 0;
const panelData = __importStar(require("./panel-data"));
const utils = __importStar(require("./utils"));
function prependCancelSearchMenu(buildInMenu) {
    if (utils.isSearching()) {
        buildInMenu.unshift({
            label: Editor.I18n.t('hierarchy.menu.cancelSearch'),
            click() {
                panelData.$.panel.clearSearch();
            },
        }, {
            type: 'separator',
        });
    }
    return buildInMenu;
}
/**
 * 生成一份创建节点的菜单
 * 用 function 来不断生成数据是为了文案都能有翻译，下同
 * @param callback 增加此层是为了把这里的固定参数传出去，接收方再增加参数
 */
async function createMenu(callback) {
    const data = await Editor.Menu.__protected__.queryMain();
    if (!data || !data['i18n:menu.node']) {
        return [];
    }
    // 过滤出 create 的菜单
    // 这里 submenu 类型就是对象，只是现在 queryMain 定义的 type 是错误的，后续会在底层 queryMain 的 type
    const submenu = data['i18n:menu.node'].submenu;
    if (submenu) {
        for (const key in submenu) {
            const config = submenu[key];
            if (config.group !== 'create') {
                delete submenu[key];
            }
        }
    }
    const menus = suitSubmenu(data['i18n:menu.node'], callback)['submenu'];
    menus.push({
        type: 'extend-menu',
    });
    const result = await mergeMenu(menus, 'createMenu');
    return result;
}
function suitSubmenu(obj, callback) {
    if (obj.submenu) {
        // 数据源是对象结构，但是在弹出menu 的地方 需要数组的结构
        obj.submenu = Object.values(obj.submenu).reduce((result, next) => {
            next.click = () => {
                callback(next.params?.[0]);
            };
            suitSubmenu(next, callback);
            result.push(next);
            return result;
        }, []);
    }
    return obj;
}
/**
 * 弹出创建节点菜单
 */
async function popupCreateMenu() {
    if (!utils.enableContextMenu()) {
        return;
    }
    Editor.Menu.popup({
        menu: await createMenu((addNode) => {
            panelData.$.tree.addTo(addNode);
        }),
    });
}
exports.popupCreateMenu = popupCreateMenu;
/**
 * 生成一份面板空白区域的右击菜单
 */
async function createPanelMenu() {
    const menu = [
        {
            label: Editor.I18n.t('hierarchy.menu.newNode'),
            enabled: utils.enableContextMenu(),
            submenu: await createMenu((addNode) => {
                panelData.$.tree.addTo(addNode);
            }),
        },
        {
            label: Editor.I18n.t('hierarchy.menu.paste'),
            accelerator: 'CmdOrCtrl+V',
            enabled: !utils.isNoneCopyOrCut() && utils.enableContextMenu(),
            click() {
                panelData.$.tree.paste();
            },
        },
        {
            // @ts-ignore
            type: 'extend-menu',
        },
    ];
    const result = await mergeMenu(menu, 'panelMenu');
    return result;
}
/**
 * 弹出面板空白位置上右击菜单
 */
async function popupPanelMenu() {
    const buildInMenu = await createPanelMenu();
    prependCancelSearchMenu(buildInMenu);
    Editor.Menu.popup({
        menu: buildInMenu,
    });
}
exports.popupPanelMenu = popupPanelMenu;
/**
 * 生成一份面板搜索类型的菜单
 */
function createSearchMenu() {
    const { searchType } = panelData.$.panel;
    return [
        {
            label: Editor.I18n.t('hierarchy.menu.searchName'),
            type: 'radio',
            checked: searchType === 'name',
            click() {
                panelData.$.panel.searchType = 'name';
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.searchUuid'),
            type: 'radio',
            checked: searchType === 'uuid',
            click() {
                panelData.$.panel.searchType = 'uuid';
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.searchPath'),
            type: 'radio',
            checked: searchType === 'path',
            click() {
                panelData.$.panel.searchType = 'path';
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.searchComponent'),
            type: 'radio',
            checked: searchType === 'component',
            click() {
                panelData.$.panel.searchType = 'component';
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.searchAsset'),
            type: 'radio',
            checked: searchType === 'asset',
            click() {
                panelData.$.panel.searchType = 'asset';
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.searchMissAsset'),
            type: 'radio',
            checked: searchType === 'missAsset',
            click() {
                panelData.$.panel.searchType = 'missAsset';
            },
        },
    ];
}
/**
 * 弹出面板搜索菜单
 */
async function popupSearchMenu() {
    Editor.Menu.popup({
        menu: createSearchMenu(),
    });
}
exports.popupSearchMenu = popupSearchMenu;
/**
 * 生成一份复制并打印 uuid path 等数据的菜单
 * @param node 当前操作的节点
 */
function createConsoleMenu(node) {
    return [
        { type: 'separator' },
        {
            label: Editor.I18n.t('hierarchy.menu.showUuid'),
            click() {
                Editor.Clipboard.write('text', node.uuid);
                console.log('UUID ', Editor.I18n.t('hierarchy.menu.doneCopied'), ' ', node.uuid);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.showPath'),
            click() {
                Editor.Clipboard.write('text', node.path);
                console.log('PATH ', Editor.I18n.t('hierarchy.menu.doneCopied'), ' ', node.path);
            },
        },
    ];
}
function createEditPrefab(node) {
    const isPrefab = node.prefab && node.prefab.state && node.prefab.state !== 3;
    if (!isPrefab || node.prefab.assetUuid.includes('@') || node.prefab.assetUuid === panelData.act.assetUuid) {
        return [];
    }
    return [
        {
            label: Editor.I18n.t('hierarchy.menu.edit_prefab'),
            enabled: node.prefab && !!node.prefab.assetUuid,
            click() {
                Editor.Message.request('asset-db', 'open-asset', node.prefab.assetUuid);
            },
        },
        {
            type: 'separator',
        },
    ];
}
function createLocateAsset(node) {
    if (!node.isScene && node.prefab && !node.prefab.state) {
        return [];
    }
    return [
        {
            type: 'separator',
        },
        {
            label: Editor.I18n.t('hierarchy.menu.locateAsset'),
            enabled: utils.isExistedAsset(),
            click() {
                utils.twinkle.asset(node);
            },
        },
    ];
}
/**
 * 针对场景根节点的右击菜单
 * @param node 当前操作的节点
 */
async function createRootMenu(node) {
    const menu = [
        {
            label: Editor.I18n.t('hierarchy.menu.newNode'),
            enabled: !utils.canNotCreateNode(node) && utils.enableContextMenu(),
            submenu: await createMenu((addNode) => {
                addNode.parent = node.uuid;
                panelData.$.tree.addTo(addNode);
            }),
        },
        {
            label: Editor.I18n.t('hierarchy.menu.paste'),
            accelerator: 'CmdOrCtrl+V',
            enabled: !utils.canNotPasteNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.paste(node.uuid);
            },
        },
        ...createLocateAsset(node),
        {
            type: 'extend-menu',
        },
        ...createConsoleMenu(node),
    ];
    const result = await mergeMenu(menu, 'rootMenu', node);
    return result;
}
/**
 * 针对场景里普通节点的右击菜单
 * @param node 当前操作的节点
 */
async function createNodeMenu(node) {
    const menu = [
        ...createEditPrefab(node),
        {
            label: Editor.I18n.t('hierarchy.menu.newNode'),
            enabled: !utils.canNotCreateNode(node) && utils.enableContextMenu(),
            submenu: await createMenu((addNode) => {
                addNode.parent = node.uuid;
                panelData.$.tree.addTo(addNode);
            }),
        },
        {
            type: 'separator',
        },
        {
            label: Editor.I18n.t('hierarchy.menu.copy'),
            accelerator: 'CmdOrCtrl+C',
            enabled: !utils.canNotCopyNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.copy(node.uuid);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.duplicate'),
            accelerator: 'CmdOrCtrl+D',
            enabled: !utils.canNotCopyNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.duplicate(node.uuid);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.cut'),
            accelerator: 'CmdOrCtrl+X',
            enabled: !utils.canNotCutNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.cut(node.uuid);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.paste'),
            accelerator: 'CmdOrCtrl+V',
            enabled: !utils.canNotPasteNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.paste(node.uuid);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.pasteAsChild'),
            accelerator: `CmdOrCtrl+${process.platform === 'win32' ? 'Alt' : 'Option'}+V`,
            enabled: !utils.canNotPasteNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.paste(node.uuid, false, true);
            },
        },
        {
            label: Editor.I18n.t('hierarchy.menu.rename'),
            accelerator: 'Enter',
            enabled: !utils.canNotRename(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.renameUuid = node.uuid;
            },
        },
        ...createLocateAsset(node),
        {
            type: 'extend-menu',
        },
        { type: 'separator' },
        {
            label: Editor.I18n.t('hierarchy.menu.selectAll'),
            accelerator: 'CmdOrCtrl+A',
            click() {
                panelData.$.tree.selectAll(node.uuid);
            },
        },
        { type: 'separator' },
        {
            label: Editor.I18n.t('hierarchy.menu.delete'),
            accelerator: 'Delete',
            enabled: !utils.canNotDeleteNode(node) && utils.enableContextMenu(),
            click() {
                panelData.$.tree.delete(node.uuid);
            },
        },
        ...createConsoleMenu(node),
    ];
    const result = await mergeMenu(menu, 'nodeMenu', node);
    return result;
}
/**
 * 弹出节点的右击菜单
 * @param node 当前操作的节点
 */
async function popupContextMenu(node) {
    const buildInMenu = node.isScene || node.isPrefabRoot ? await createRootMenu(node) : await createNodeMenu(node);
    prependCancelSearchMenu(buildInMenu);
    Editor.Menu.popup({
        menu: buildInMenu,
    });
}
exports.popupContextMenu = popupContextMenu;
/**
 * 合并外部扩展菜单
 */
async function mergeMenu(buildInMenu, where, node) {
    const extendMenu = await panelData.config.extendMenu.show(where, node);
    const extendIndex = buildInMenu.findIndex((item) => item.type === 'extend-menu');
    const menus = buildInMenu.slice();
    menus.splice(extendIndex, 1, ...extendMenu);
    return menus;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZWwtbWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL3BhbmVsLW1lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSWIsd0RBQTBDO0FBQzFDLCtDQUFpQztBQUVqQyxTQUFTLHVCQUF1QixDQUFDLFdBQTBDO0lBQ3ZFLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQ3JCLFdBQVcsQ0FBQyxPQUFPLENBQ2Y7WUFDSSxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsNkJBQTZCLENBQUM7WUFDbkQsS0FBSztnQkFDRCxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNwQyxDQUFDO1NBQ0osRUFDRDtZQUNJLElBQUksRUFBRSxXQUFXO1NBQ3BCLENBQ0osQ0FBQztLQUNMO0lBQ0QsT0FBTyxXQUFXLENBQUM7QUFDdkIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxLQUFLLFVBQVUsVUFBVSxDQUFDLFFBQWtCO0lBQ3hDLE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDekQsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1FBQUUsT0FBTyxFQUFFLENBQUM7S0FBRTtJQUVwRCxpQkFBaUI7SUFDakIseUVBQXlFO0lBQ3pFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUMvQyxJQUFJLE9BQU8sRUFBRTtRQUNULEtBQUssTUFBTSxHQUFHLElBQUksT0FBTyxFQUFFO1lBQ3ZCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM1QixJQUFJLE1BQU0sQ0FBQyxLQUFL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RztBQUNILEtBQUssVUFBVSxTQUFTLENBQUMsV0FBMEMsRUFBRSxLQUEwQixFQUFFLElBQWU7SUFDNUcsTUFBTSxVQUFVLEdBQWtDLE1BQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0RyxNQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBaUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQWUsS0FBSyxhQUFhLENBQUMsQ0FBQztJQUN6SCxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbEMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUM7SUFDNUMsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgQWRkTm9kZSwgVHJlZU5vZGUsIE1lbnVFeHRlbnNpb24gfSBmcm9tICcuLi8uLi9AdHlwZXMvcHJpdmF0ZSc7XG5cbmltcG9ydCAqIGFzIHBhbmVsRGF0YSBmcm9tICcuL3BhbmVsLWRhdGEnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5cbmZ1bmN0aW9uIHByZXBlbmRDYW5jZWxTZWFyY2hNZW51KGJ1aWxkSW5NZW51OiBFZGl0b3IuTWVudS5Db250ZXh0TWVudUl0ZW1bXSkge1xuICAgIGlmICh1dGlscy5pc1NlYXJjaGluZygpKSB7XG4gICAgICAgIGJ1aWxkSW5NZW51LnVuc2hpZnQoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2hpZXJhcmNoeS5tZW51LmNhbmNlbFNlYXJjaCcpLFxuICAgICAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC5wYW5lbC5jbGVhclNlYXJjaCgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdzZXBhcmF0b3InLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGJ1aWxkSW5NZW51O1xufVxuXG4vKipcbiAqIOeUn+aIkOS4gOS7veWIm+W7uuiKgueCueeahOiPnOWNlVxuICog55SoIGZ1bmN0aW9uIOadpeS4jeaWreeUn+aIkOaVsOaNruaYr+S4uuS6huaWh+ahiOmDveiDveaciee/u+ivke+8jOS4i+WQjFxuICogQHBhcmFtIGNhbGxiYWNrIOWinuWKoOatpOWxguaYr+S4uuS6huaKiui/memHjOeahOWbuuWumuWPguaVsOS8oOWHuuWOu++8jOaOpeaUtuaWueWGjeWinuWKoOWPguaVsFxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVNZW51KGNhbGxiYWNrOiBGdW5jdGlvbik6IFByb21pc2U8RWRpdG9yLk1lbnUuQ29udGV4dE1lbnVJdGVtW10+IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgRWRpdG9yLk1lbnUuX19wcm90ZWN0ZWRfXy5xdWVyeU1haW4oKTtcbiAgICBpZiAoIWRhdGEgfHwgIWRhdGFbJ2kxOG46bWVudS5ub2RlJ10pIHsgcmV0dXJuIFtdOyB9XG5cbiAgICAvLyDov4fmu6Tlh7ogY3JlYXRlIOeahOiPnOWNlVxuICAgIC8vIOi/memHjCBzdWJtZW51IOexu+Wei+WwseaYr+Wvueixoe+8jOWPquaYr+eOsOWcqCBxdWVyeU1haW4g5a6a5LmJ55qEIHR5cGUg5piv6ZSZ6K+v55qE77yM5ZCO57ut5Lya5Zyo5bqV5bGCIHF1ZXJ5TWFpbiDnmoQgdHlwZVxuICAgIGNvbnN0IHN1Ym1lbnUgPSBkYXRhWydpMThuOm1lbnUubm9kZSddLnN1Ym1lbnU7XG4gICAgaWYgKHN1Ym1lbnUpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gc3VibWVudSkge1xuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gc3VibWVudVtrZXldO1xuICAgICAgICAgICAgaWYgKGNvbmZpZy5ncm91cCAhPT0gJ2NyZWF0ZScpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgc3VibWVudVtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbWVudXMgPSBzdWl0U3VibWVudShkYXRhWydpMThuOm1lbnUubm9kZSddLCBjYWxsYmFjaylbJ3N1Ym1lbnUnXSBhcyBFZGl0b3IuTWVudS5Db250ZXh0TWVudUl0ZW1bXTtcbiAgICBtZW51cy5wdXNoKHtcbiAgICAgICAgdHlwZTogJ2V4dGVuZC1tZW51JyBhcyB1bmtub3duIGFzICdzZXBhcmF0b3InLFxuICAgIH0pO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1lcmdlTWVudShtZW51cywgJ2NyZWF0ZU1lbnUnKTtcbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBzdWl0U3VibWVudShvYmo6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSB7XG4gICAgaWYgKG9iai5zdWJtZW51KSB7XG4gICAgICAgIC8vIOaVsOaNrua6kOaYr+Wvueixoee7k+aehO+8jOS9huaYr+WcqOW8ueWHum1lbnUg55qE5Zyw5pa5IOmcgOimgeaVsOe7hOeahOe7k+aehFxuICAgICAgICBvYmouc3VibWVudSA9IE9iamVjdC52YWx1ZXM8RWRpdG9yLk1lbnUuQ29udGV4dE1lbnVJdGVtPihvYmouc3VibWVudSkucmVkdWNlKChyZXN1bHQ6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBuZXh0LmNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5leHQucGFyYW1zPy5bMF0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHN1aXRTdWJtZW51KG5leHQsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5leHQpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSwgW10pO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuXG4vKipcbiAqIOW8ueWHuuWIm+W7uuiKgueCueiPnOWNlVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcG9wdXBDcmVhdGVNZW51KCkge1xuICAgIGlmICghdXRpbHMuZW5hYmxlQ29udGV4dE1lbnUoKSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgRWRpdG9yLk1lbnUucG9wdXAoe1xuICAgICAgICBtZW51OiBhd2FpdCBjcmVhdGVNZW51KChhZGROb2RlOiBBZGROb2RlKSA9PiB7XG4gICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLmFkZFRvKGFkZE5vZGUpO1xuICAgICAgICB9KSxcbiAgICB9KTtcbn1cblxuLyoqXG4gKiDnlJ/miJDkuIDku73pnaLmnb/nqbrnmb3ljLrln5/nmoTlj7Plh7voj5zljZVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUGFuZWxNZW51KCkge1xuICAgIGNvbnN0IG1lbnU6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdID0gW1xuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUubmV3Tm9kZScpLFxuICAgICAgICAgICAgZW5hYmxlZDogdXRpbHMuZW5hYmxlQ29udGV4dE1lbnUoKSxcbiAgICAgICAgICAgIHN1Ym1lbnU6IGF3YWl0IGNyZWF0ZU1lbnUoKGFkZE5vZGU6IEFkZE5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLmFkZFRvKGFkZE5vZGUpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5wYXN0ZScpLFxuICAgICAgICAgICAgYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrVicsXG4gICAgICAgICAgICBlbmFibGVkOiAhdXRpbHMuaXNOb25lQ29weU9yQ3V0KCkgJiYgdXRpbHMuZW5hYmxlQ29udGV4dE1lbnUoKSxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnRyZWUucGFzdGUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHR5cGU6ICdleHRlbmQtbWVudScsXG4gICAgICAgIH0sXG4gICAgXTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBtZXJnZU1lbnUobWVudSwgJ3BhbmVsTWVudScpO1xuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICog5by55Ye66Z2i5p2/56m655m95L2N572u5LiK5Y+z5Ye76I+c5Y2VXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwb3B1cFBhbmVsTWVudSgpIHtcbiAgICBjb25zdCBidWlsZEluTWVudSA9IGF3YWl0IGNyZWF0ZVBhbmVsTWVudSgpO1xuICAgIHByZXBlbmRDYW5jZWxTZWFyY2hNZW51KGJ1aWxkSW5NZW51KTtcblxuICAgIEVkaXRvci5NZW51LnBvcHVwKHtcbiAgICAgICAgbWVudTogYnVpbGRJbk1lbnUsXG4gICAgfSk7XG59XG5cbi8qKlxuICog55Sf5oiQ5LiA5Lu96Z2i5p2/5pCc57Si57G75Z6L55qE6I+c5Y2VXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVNlYXJjaE1lbnUoKTogRWRpdG9yLk1lbnUuQ29udGV4dE1lbnVJdGVtW10ge1xuICAgIGNvbnN0IHsgc2VhcmNoVHlwZSB9ID0gcGFuZWxEYXRhLiQucGFuZWw7XG5cbiAgICByZXR1cm4gW1xuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoTmFtZScpLFxuICAgICAgICAgICAgdHlwZTogJ3JhZGlvJyxcbiAgICAgICAgICAgIGNoZWNrZWQ6IHNlYXJjaFR5cGUgPT09ICduYW1lJyxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnBhbmVsLnNlYXJjaFR5cGUgPSAnbmFtZSc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoVXVpZCcpLFxuICAgICAgICAgICAgdHlwZTogJ3JhZGlvJyxcbiAgICAgICAgICAgIGNoZWNrZWQ6IHNlYXJjaFR5cGUgPT09ICd1dWlkJyxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnBhbmVsLnNlYXJjaFR5cGUgPSAndXVpZCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoUGF0aCcpLFxuICAgICAgICAgICAgdHlwZTogJ3JhZGlvJyxcbiAgICAgICAgICAgIGNoZWNrZWQ6IHNlYXJjaFR5cGUgPT09ICdwYXRoJyxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnBhbmVsLnNlYXJjaFR5cGUgPSAncGF0aCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoQ29tcG9uZW50JyksXG4gICAgICAgICAgICB0eXBlOiAncmFkaW8nLFxuICAgICAgICAgICAgY2hlY2tlZDogc2VhcmNoVHlwZSA9PT0gJ2NvbXBvbmVudCcsXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC5wYW5lbC5zZWFyY2hUeXBlID0gJ2NvbXBvbmVudCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoQXNzZXQnKSxcbiAgICAgICAgICAgIHR5cGU6ICdyYWRpbycsXG4gICAgICAgICAgICBjaGVja2VkOiBzZWFyY2hUeXBlID09PSAnYXNzZXQnLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgcGFuZWxEYXRhLiQucGFuZWwuc2VhcmNoVHlwZSA9ICdhc3NldCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VhcmNoTWlzc0Fzc2V0JyksXG4gICAgICAgICAgICB0eXBlOiAncmFkaW8nLFxuICAgICAgICAgICAgY2hlY2tlZDogc2VhcmNoVHlwZSA9PT0gJ21pc3NBc3NldCcsXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC5wYW5lbC5zZWFyY2hUeXBlID0gJ21pc3NBc3NldCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgIF07XG59XG5cbi8qKlxuICog5by55Ye66Z2i5p2/5pCc57Si6I+c5Y2VXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwb3B1cFNlYXJjaE1lbnUoKSB7XG4gICAgRWRpdG9yLk1lbnUucG9wdXAoe1xuICAgICAgICBtZW51OiBjcmVhdGVTZWFyY2hNZW51KCksXG4gICAgfSk7XG59XG5cbi8qKlxuICog55Sf5oiQ5LiA5Lu95aSN5Yi25bm25omT5Y2wIHV1aWQgcGF0aCDnrYnmlbDmja7nmoToj5zljZVcbiAqIEBwYXJhbSBub2RlIOW9k+WJjeaTjeS9nOeahOiKgueCuVxuICovXG5mdW5jdGlvbiBjcmVhdGVDb25zb2xlTWVudShub2RlOiBUcmVlTm9kZSk6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdIHtcbiAgICByZXR1cm4gW1xuICAgICAgICB7IHR5cGU6ICdzZXBhcmF0b3InIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5zaG93VXVpZCcpLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgRWRpdG9yLkNsaXBib2FyZC53cml0ZSgndGV4dCcsIG5vZGUudXVpZCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VVSUQgJywgRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuZG9uZUNvcGllZCcpLCAnICcsIG5vZGUudXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2hvd1BhdGgnKSxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIEVkaXRvci5DbGlwYm9hcmQud3JpdGUoJ3RleHQnLCBub2RlLnBhdGgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQQVRIICcsIEVkaXRvci5JMThuLnQoJ2hpZXJhcmNoeS5tZW51LmRvbmVDb3BpZWQnKSwgJyAnLCBub2RlLnBhdGgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICBdO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVFZGl0UHJlZmFiKG5vZGU6IFRyZWVOb2RlKTogRWRpdG9yLk1lbnUuQ29udGV4dE1lbnVJdGVtW10ge1xuICAgIGNvbnN0IGlzUHJlZmFiID0gbm9kZS5wcmVmYWIgJiYgbm9kZS5wcmVmYWIuc3RhdGUgJiYgbm9kZS5wcmVmYWIuc3RhdGUgIT09IDM7XG4gICAgaWYgKCFpc1ByZWZhYiB8fCBub2RlLnByZWZhYi5hc3NldFV1aWQuaW5jbHVkZXMoJ0AnKSB8fCBub2RlLnByZWZhYi5hc3NldFV1aWQgPT09IHBhbmVsRGF0YS5hY3QuYXNzZXRVdWlkKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW1xuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuZWRpdF9wcmVmYWInKSxcbiAgICAgICAgICAgIGVuYWJsZWQ6IG5vZGUucHJlZmFiICYmICEhbm9kZS5wcmVmYWIuYXNzZXRVdWlkLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnYXNzZXQtZGInLCAnb3Blbi1hc3NldCcsIG5vZGUucHJlZmFiLmFzc2V0VXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiAnc2VwYXJhdG9yJyxcbiAgICAgICAgfSxcbiAgICBdO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVMb2NhdGVBc3NldChub2RlOiBUcmVlTm9kZSk6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdIHtcbiAgICBpZiAoIW5vZGUuaXNTY2VuZSAmJiBub2RlLnByZWZhYiAmJiAhbm9kZS5wcmVmYWIuc3RhdGUpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6ICdzZXBhcmF0b3InLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUubG9jYXRlQXNzZXQnKSxcbiAgICAgICAgICAgIGVuYWJsZWQ6IHV0aWxzLmlzRXhpc3RlZEFzc2V0KCksXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICB1dGlscy50d2lua2xlLmFzc2V0KG5vZGUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICBdO1xufVxuXG4vKipcbiAqIOmSiOWvueWcuuaZr+agueiKgueCueeahOWPs+WHu+iPnOWNlVxuICogQHBhcmFtIG5vZGUg5b2T5YmN5pON5L2c55qE6IqC54K5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVJvb3RNZW51KG5vZGU6IFRyZWVOb2RlKTogUHJvbWlzZTxFZGl0b3IuTWVudS5Db250ZXh0TWVudUl0ZW1bXT4ge1xuICAgIGNvbnN0IG1lbnU6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdID0gW1xuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUubmV3Tm9kZScpLFxuICAgICAgICAgICAgZW5hYmxlZDogIXV0aWxzLmNhbk5vdENyZWF0ZU5vZGUobm9kZSkgJiYgdXRpbHMuZW5hYmxlQ29udGV4dE1lbnUoKSxcbiAgICAgICAgICAgIHN1Ym1lbnU6IGF3YWl0IGNyZWF0ZU1lbnUoKGFkZE5vZGU6IEFkZE5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICBhZGROb2RlLnBhcmVudCA9IG5vZGUudXVpZDtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLmFkZFRvKGFkZE5vZGUpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5wYXN0ZScpLFxuICAgICAgICAgICAgYWNjZWxlcmF0b3I6ICdDbWRPckN0cmwrVicsXG4gICAgICAgICAgICBlbmFibGVkOiAhdXRpbHMuY2FuTm90UGFzdGVOb2RlKG5vZGUpICYmIHV0aWxzLmVuYWJsZUNvbnRleHRNZW51KCksXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLnBhc3RlKG5vZGUudXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICAuLi5jcmVhdGVMb2NhdGVBc3NldChub2RlKSxcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ2V4dGVuZC1tZW51JyBhcyB1bmtub3duIGFzICdzZXBhcmF0b3InLFxuICAgICAgICB9LFxuICAgICAgICAuLi5jcmVhdGVDb25zb2xlTWVudShub2RlKSxcbiAgICBdO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1lcmdlTWVudShtZW51LCAncm9vdE1lbnUnLCBub2RlKTtcbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIOmSiOWvueWcuuaZr+mHjOaZrumAmuiKgueCueeahOWPs+WHu+iPnOWNlVxuICogQHBhcmFtIG5vZGUg5b2T5YmN5pON5L2c55qE6IqC54K5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZU5vZGVNZW51KG5vZGU6IFRyZWVOb2RlKTogUHJvbWlzZTxFZGl0b3IuTWVudS5Db250ZXh0TWVudUl0ZW1bXT4ge1xuICAgIGNvbnN0IG1lbnUgPSBbXG4gICAgICAgIC4uLmNyZWF0ZUVkaXRQcmVmYWIobm9kZSksXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5uZXdOb2RlJyksXG4gICAgICAgICAgICBlbmFibGVkOiAhdXRpbHMuY2FuTm90Q3JlYXRlTm9kZShub2RlKSAmJiB1dGlscy5lbmFibGVDb250ZXh0TWVudSgpLFxuICAgICAgICAgICAgc3VibWVudTogYXdhaXQgY3JlYXRlTWVudSgoYWRkTm9kZTogQWRkTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGFkZE5vZGUucGFyZW50ID0gbm9kZS51dWlkO1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnRyZWUuYWRkVG8oYWRkTm9kZSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ3NlcGFyYXRvcicsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5jb3B5JyksXG4gICAgICAgICAgICBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtDJyxcbiAgICAgICAgICAgIGVuYWJsZWQ6ICF1dGlscy5jYW5Ob3RDb3B5Tm9kZShub2RlKSAmJiB1dGlscy5lbmFibGVDb250ZXh0TWVudSgpLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgcGFuZWxEYXRhLiQudHJlZS5jb3B5KG5vZGUudXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuZHVwbGljYXRlJyksXG4gICAgICAgICAgICBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtEJyxcbiAgICAgICAgICAgIGVuYWJsZWQ6ICF1dGlscy5jYW5Ob3RDb3B5Tm9kZShub2RlKSAmJiB1dGlscy5lbmFibGVDb250ZXh0TWVudSgpLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgcGFuZWxEYXRhLiQudHJlZS5kdXBsaWNhdGUobm9kZS51dWlkKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5jdXQnKSxcbiAgICAgICAgICAgIGFjY2VsZXJhdG9yOiAnQ21kT3JDdHJsK1gnLFxuICAgICAgICAgICAgZW5hYmxlZDogIXV0aWxzLmNhbk5vdEN1dE5vZGUobm9kZSkgJiYgdXRpbHMuZW5hYmxlQ29udGV4dE1lbnUoKSxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnRyZWUuY3V0KG5vZGUudXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUucGFzdGUnKSxcbiAgICAgICAgICAgIGFjY2VsZXJhdG9yOiAnQ21kT3JDdHJsK1YnLFxuICAgICAgICAgICAgZW5hYmxlZDogIXV0aWxzLmNhbk5vdFBhc3RlTm9kZShub2RlKSAmJiB1dGlscy5lbmFibGVDb250ZXh0TWVudSgpLFxuICAgICAgICAgICAgY2xpY2soKSB7XG4gICAgICAgICAgICAgICAgcGFuZWxEYXRhLiQudHJlZS5wYXN0ZShub2RlLnV1aWQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2hpZXJhcmNoeS5tZW51LnBhc3RlQXNDaGlsZCcpLFxuICAgICAgICAgICAgYWNjZWxlcmF0b3I6IGBDbWRPckN0cmwrJHtwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJ0FsdCcgOiAnT3B0aW9uJ30rVmAsXG4gICAgICAgICAgICBlbmFibGVkOiAhdXRpbHMuY2FuTm90UGFzdGVOb2RlKG5vZGUpICYmIHV0aWxzLmVuYWJsZUNvbnRleHRNZW51KCksXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLnBhc3RlKG5vZGUudXVpZCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgbGFiZWw6IEVkaXRvci5JMThuLnQoJ2hpZXJhcmNoeS5tZW51LnJlbmFtZScpLFxuICAgICAgICAgICAgYWNjZWxlcmF0b3I6ICdFbnRlcicsXG4gICAgICAgICAgICBlbmFibGVkOiAhdXRpbHMuY2FuTm90UmVuYW1lKG5vZGUpICYmIHV0aWxzLmVuYWJsZUNvbnRleHRNZW51KCksXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLnJlbmFtZVV1aWQgPSBub2RlLnV1aWQ7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICAuLi5jcmVhdGVMb2NhdGVBc3NldChub2RlKSxcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ2V4dGVuZC1tZW51JyxcbiAgICAgICAgfSxcbiAgICAgICAgeyB0eXBlOiAnc2VwYXJhdG9yJyB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBsYWJlbDogRWRpdG9yLkkxOG4udCgnaGllcmFyY2h5Lm1lbnUuc2VsZWN0QWxsJyksXG4gICAgICAgICAgICBhY2NlbGVyYXRvcjogJ0NtZE9yQ3RybCtBJyxcbiAgICAgICAgICAgIGNsaWNrKCkge1xuICAgICAgICAgICAgICAgIHBhbmVsRGF0YS4kLnRyZWUuc2VsZWN0QWxsKG5vZGUudXVpZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7IHR5cGU6ICdzZXBhcmF0b3InIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBFZGl0b3IuSTE4bi50KCdoaWVyYXJjaHkubWVudS5kZWxldGUnKSxcbiAgICAgICAgICAgIGFjY2VsZXJhdG9yOiAnRGVsZXRlJyxcbiAgICAgICAgICAgIGVuYWJsZWQ6ICF1dGlscy5jYW5Ob3REZWxldGVOb2RlKG5vZGUpICYmIHV0aWxzLmVuYWJsZUNvbnRleHRNZW51KCksXG4gICAgICAgICAgICBjbGljaygpIHtcbiAgICAgICAgICAgICAgICBwYW5lbERhdGEuJC50cmVlLmRlbGV0ZShub2RlLnV1aWQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgLi4uY3JlYXRlQ29uc29sZU1lbnUobm9kZSksXG4gICAgXSBhcyBFZGl0b3IuTWVudS5Db250ZXh0TWVudUl0ZW1bXTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBtZXJnZU1lbnUobWVudSwgJ25vZGVNZW51Jywgbm9kZSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiDlvLnlh7roioLngrnnmoTlj7Plh7voj5zljZVcbiAqIEBwYXJhbSBub2RlIOW9k+WJjeaTjeS9nOeahOiKgueCuVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcG9wdXBDb250ZXh0TWVudShub2RlOiBUcmVlTm9kZSkge1xuXG4gICAgY29uc3QgYnVpbGRJbk1lbnU6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdID0gbm9kZS5pc1NjZW5lIHx8IG5vZGUuaXNQcmVmYWJSb290ID8gYXdhaXQgY3JlYXRlUm9vdE1lbnUobm9kZSkgOiBhd2FpdCBjcmVhdGVOb2RlTWVudShub2RlKTtcbiAgICBwcmVwZW5kQ2FuY2VsU2VhcmNoTWVudShidWlsZEluTWVudSk7XG5cbiAgICBFZGl0b3IuTWVudS5wb3B1cCh7XG4gICAgICAgIG1lbnU6IGJ1aWxkSW5NZW51LFxuICAgIH0pO1xufVxuXG4vKipcbiAqIOWQiOW5tuWklumDqOaJqeWxleiPnOWNlVxuICovXG5hc3luYyBmdW5jdGlvbiBtZXJnZU1lbnUoYnVpbGRJbk1lbnU6IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbVtdLCB3aGVyZToga2V5b2YgTWVudUV4dGVuc2lvbiwgbm9kZT86IFRyZWVOb2RlKSB7XG4gICAgY29uc3QgZXh0ZW5kTWVudTogRWRpdG9yLk1lbnUuQ29udGV4dE1lbnVJdGVtW10gPSBhd2FpdCBwYW5lbERhdGEuY29uZmlnLmV4dGVuZE1lbnUuc2hvdyh3aGVyZSwgbm9kZSk7XG4gICAgY29uc3QgZXh0ZW5kSW5kZXggPSBidWlsZEluTWVudS5maW5kSW5kZXgoKGl0ZW06IEVkaXRvci5NZW51LkNvbnRleHRNZW51SXRlbSkgPT4gaXRlbS50eXBlIGFzIHVua25vd24gPT09ICdleHRlbmQtbWVudScpO1xuICAgIGNvbnN0IG1lbnVzID0gYnVpbGRJbk1lbnUuc2xpY2UoKTtcbiAgICBtZW51cy5zcGxpY2UoZXh0ZW5kSW5kZXgsIDEsIC4uLmV4dGVuZE1lbnUpO1xuICAgIHJldHVybiBtZW51cztcbn1cbiJdfQ==