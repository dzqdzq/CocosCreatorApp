"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.twinkle=exports.calcScrollPosition=exports.scrollIntoView=exports.getChildrenUuids=exports.isAIncludeB=exports.filterChildren=exports.inDisplayArray=exports.getDisplayNodeTop=exports.getDisplayNodeLeft=exports.getParentWhenAddNode=exports.geLastExpandChildUuid=exports.getLastChildUuid=exports.getSibling=exports.getParent=exports.getNode=exports.isSelected=exports.isAnimating=exports.isParent=exports.isExpand=exports.isActive=exports.isAllExpand=exports.isSearching=exports.isExistedAsset=exports.isNoneCopyOrCut=exports.canNotPasteNode=exports.canNotDragNode=exports.canNotRename=exports.canNotCutNode=exports.canNotCopyNode=exports.canNotCreateNode=exports.canNotDeleteNode=exports.enableContextMenu=exports.forbidOperate=void 0;const panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function forbidOperate(){return panelData.act.animationUuid||panelData.$.panel.isOperating}function enableContextMenu(){return!forbidOperate()}function canNotDeleteNode(e){return!e||e.readonly||e.isScene||e.isPrefabRoot}function canNotCreateNode(e){return!e||e.readonly}function canNotCopyNode(e){return canNotDeleteNode(e)}function canNotCutNode(e){return canNotDeleteNode(e)}function canNotRename(e){return canNotDeleteNode(e)||forbidOperate()}function canNotDragNode(e){return canNotDeleteNode(e)}function canNotPasteNode(e){return!e||e.readonly||isNoneCopyOrCut()}function isNoneCopyOrCut(){const e=Editor.Clipboard.read("nodes-info");return!e||!e.uuids.length||e.projectPath!==Editor.Project.path}function isExistedAsset(){return!!panelData.act.assetUuid}function isSearching(){if(!panelData.$.panel)return!1;const{searchValue:e,searchType:t}=panelData.$.panel;return""!==e||"missAsset"===t}function isAllExpand(){let e=!0;if(!treeData.nodeTree)return e;let t=treeData.uuidToChildren[treeData.nodeTree.uuid];if(panelData.act.selects.length&&(t=panelData.act.selects),!t||!t.length)return e;const n=t.length;for(let a=0;a<n;a++){let n=t[a];treeData.uuidToNode[n];if(isParent(n)||(n=treeData.uuidToParentUuid[n]),treeData.uuidToExpand[n]){e=!1;break}}return!e}function isActive(e){let t=!0;const n=treeData.uuidToNode[e];if(n&&(t=!!n.active)){const n=treeData.uuidToParentUuid[e];n&&(t=isActive(n))}return t}function isExpand(e){return!!treeData.uuidToExpand[e]}function isParent(e){return treeData.uuidToChildren[e]&&treeData.uuidToChildren[e].length>0}function isAnimating(e){return!!treeData.uuidToAnimating[e]}function isSelected(e){return-1!==panelData.act.selects.indexOf(e)}function getNode(e=""){return e?treeData.uuidToNode[e]:null}function getParent(e){if(!e)return null;return getNode(treeData.uuidToParentUuid[e])}function getSibling(e){const{displayArray:t,uuidToNode:n}=treeData,a=t.indexOf(e),o=t.length-1;let r=a-1,i=a+1;return 0===a&&(r=o),a===t.length-1&&(i=0),[n[e],n[t[r]],n[t[i]]]}function getLastChildUuid(e){if(treeData.uuidToExpand[e]&&0!==treeData.uuidToChildren[e].length){const t=treeData.uuidToChildren[e].length-1;e=treeData.uuidToChildren[e][t]}return e}function geLastExpandChildUuid(e){const t=getLastChildUuid(e);return t!==e&&(e=geLastExpandChildUuid(t)),e}function getParentWhenAddNode(e){if(!e.parent)return null;const t=getNode(e.parent);if(!t)return null;if(canNotCreateNode(t))return null;if(e.canvasRequired){if(hasCanvasComponent(t))return t;for(let e=treeData.uuidToChildren[t.uuid].length-1;e>=0;e--){const n=getNode(treeData.uuidToChildren[t.uuid][e]);if(n&&n.active&&hasCanvasComponent(n))return n}}return t}function getDisplayNodeLeft(e){return e.depth*panelData.config.iconWidth+panelData.config.padding}function getDisplayNodeTop(e){return treeData.displayArray.indexOf(e.uuid)*panelData.config.nodeHeight}function inDisplayArray(e){return treeData.displayArray.includes(e)}function filterChildren(e){if(!e||!e.length)return[];let t=[];return e.forEach(e=>{(t=t.filter(t=>!isAIncludeB(e,t))).some(t=>isAIncludeB(t,e))||t.push(e)}),t}function isAIncludeB(e,t){if(e===t)return!0;const n=treeData.uuidToChildren[e];if(Array.isArray(n))for(const e of n)if(isAIncludeB(e,t))return!0;return!1}function getChildrenUuids(e,t=!1){const n=[],a=treeData.uuidToChildren[e];for(const e of a)if(n.push(e),treeData.uuidToParentUuid[e]){if(!t&&!treeData.uuidToExpand[e])continue;n.push(...getChildrenUuids(e,t))}return n}async function scrollIntoView(e){return new Promise(t=>{const n=getNode(e);if(!n)return void t(!1);inDisplayArray(e)||treeData.pointExpand(e);const a=calcScrollPosition(n);panelData.$.tree.scrollTop=a.top,window.setTimeout(()=>{panelData.$.viewBox.scrollTo(a.left,a.top),t(!0)})})}function calcScrollPosition(e){const t=panelData.$.viewBox.clientWidth;panelData.$.viewBox.scrollWidth;let n=panelData.$.viewBox.scrollLeft,a=panelData.$.viewBox.scrollTop;const o=a,r=a+panelData.$.panel.viewHeight-panelData.config.nodeHeight-4,i=getDisplayNodeLeft(e),s=getDisplayNodeTop(e);return(n>i||n+.3*t<i)&&(n=i-2*panelData.config.iconWidth),s<=o?a=s:s>=r&&(a=s-panelData.$.panel.viewHeight+2*panelData.config.nodeHeight),{left:n,top:a}}function hasCanvasComponent(e){return e&&e.components.some(e=>"cc.Canvas"===e.type)}exports.forbidOperate=forbidOperate,exports.enableContextMenu=enableContextMenu,exports.canNotDeleteNode=canNotDeleteNode,exports.canNotCreateNode=canNotCreateNode,exports.canNotCopyNode=canNotCopyNode,exports.canNotCutNode=canNotCutNode,exports.canNotRename=canNotRename,exports.canNotDragNode=canNotDragNode,exports.canNotPasteNode=canNotPasteNode,exports.isNoneCopyOrCut=isNoneCopyOrCut,exports.isExistedAsset=isExistedAsset,exports.isSearching=isSearching,exports.isAllExpand=isAllExpand,exports.isActive=isActive,exports.isExpand=isExpand,exports.isParent=isParent,exports.isAnimating=isAnimating,exports.isSelected=isSelected,exports.getNode=getNode,exports.getParent=getParent,exports.getSibling=getSibling,exports.getLastChildUuid=getLastChildUuid,exports.geLastExpandChildUuid=geLastExpandChildUuid,exports.getParentWhenAddNode=getParentWhenAddNode,exports.getDisplayNodeLeft=getDisplayNodeLeft,exports.getDisplayNodeTop=getDisplayNodeTop,exports.inDisplayArray=inDisplayArray,exports.filterChildren=filterChildren,exports.isAIncludeB=isAIncludeB,exports.getChildrenUuids=getChildrenUuids,exports.scrollIntoView=scrollIntoView,exports.calcScrollPosition=calcScrollPosition,exports.twinkle={watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="shake"){this.watch&&(panelData.$.tree.$set(panelData.$.tree.twinkles,e,t),setTimeout(()=>{panelData.$.tree.twinkles[e]=void 0,delete panelData.$.tree.twinkles[e]},1e3))},asset(e){e.isScene?Editor.Message.send("assets","twinkle",panelData.act.assetUuid):e.prefab&&e.prefab.state&&Editor.Message.send("assets","twinkle",e.prefab.assetUuid)}};