"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a);var o=Object.getOwnPropertyDescriptor(t,a);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,n,o)}:function(e,t,a,n){e[n=void 0===n?a:n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.twinkle=exports.calcScrollPosition=exports.scrollIntoView=exports.getChildrenUuids=exports.isAIncludeB=exports.filterChildren=exports.getDisplayNodeChildrenUuids=exports.inDisplayArray=exports.getDisplayNodeBottom=exports.getDisplayNodeTop=exports.getDisplayParentNodeTop=exports.getDisplayNodeBottomOfParent=exports.getDisplayNodeTopOfParent=exports.getDisplayNodeLeft=exports.getNextDisplayNode=exports.getParentWhenAddNode=exports.getLastExpandChildUuid=exports.getLastChildUuid=exports.getSibling=exports.getParent=exports.getNode=exports.isSelected=exports.isAnimating=exports.isParent=exports.isLastChild=exports.isExpand=exports.getCanInsideDisplayNode=exports.isActive=exports.isAllExpand=exports.isSearching=exports.isExistedAsset=exports.isNoneCopyOrCut=exports.canNotPasteNode=exports.canNotDragNode=exports.canNotRename=exports.canNotCutNode=exports.canNotCopyNode=exports.canNotCreateNode=exports.canNotDeleteNode=exports.enableContextMenu=exports.forbidOperate=exports.ATTRIBUTE_TO_NODE=void 0;const panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function forbidOperate(){return panelData.act.animationUuid||panelData.$.panel.isOperating}function enableContextMenu(){return!forbidOperate()}function canNotDeleteNode(e){return!e||e.readonly||e.isScene||e.isPrefabRoot}function canNotCreateNode(e){return!e||e.readonly}function canNotCopyNode(e){return canNotDeleteNode(e)}function canNotCutNode(e){return canNotDeleteNode(e)}function canNotRename(e){return canNotDeleteNode(e)||forbidOperate()}function canNotDragNode(e){return canNotDeleteNode(e)}function canNotPasteNode(e){return!e||e.readonly||isNoneCopyOrCut()}function isNoneCopyOrCut(){var e=Editor.Clipboard.read("nodes-info");return!e||!e.uuids.length||e.projectPath!==Editor.Project.path}function isExistedAsset(){return!!panelData.act.assetUuid}function isSearching(){var e,t;return!!panelData.$.panel&&({searchValue:e,searchType:t}=panelData.$.panel,""!==e||"missAsset"===t)}function isAllExpand(){let a=!0;if(!treeData.nodeTree)return a;let n=treeData.uuidToChildren[treeData.nodeTree.uuid];var e=panelData.act.selects.length;if(!(n=e?panelData.act.selects:n)||!n.length)return a;var o=n.length;for(let t=0;t<o;t++){let e=n[t];treeData.uuidToNode[e];if(isParent(e)||(e=treeData.uuidToParentUuid[e]),treeData.uuidToExpand[e]){a=!1;break}}return!a}function isActive(e){let t=!0;var a=treeData.uuidToNode[e];return t=a&&(t=!!a.active)&&(a=treeData.uuidToParentUuid[e])?isActive(a):t}function getCanInsideDisplayNode(a,e){var t=getNode(e);if(!t||!isLastChild(t))return null;var n=[e];let o=t;for(;o&&(!(o=getNode(o.parent))||(n.push(o.uuid),isLastChild(o))););if(0===n.length)return null;var r=[];for(const d of panelData.$.tree.$children){var i=d.$el.getBoundingClientRect(),s=d.$options.propsData.node;n.includes(s.uuid)&&r.push({node:s,rect:i,left:getDisplayNodeLeft(s,!0)})}return 0===r.length?null:(r.sort((e,t)=>e.left-t.left),r.reduce((e,t)=>Math.abs(t.left-a)<Math.abs(e.left-a)?t:e).node)}function isExpand(e){return!!treeData.uuidToExpand[e]}function isLastChild(e){return getLastChildUuid(e.parent)===e.uuid}function isParent(e){return treeData.uuidToChildren[e]&&0<treeData.uuidToChildren[e].length}function isAnimating(e){return!!treeData.uuidToAnimating[e]}function isSelected(e){return-1!==panelData.act.selects.indexOf(e)}function getNode(e=""){return e?treeData.uuidToNode[e]:null}function getParent(e){return e?getNode(treeData.uuidToParentUuid[e]):null}function getSibling(e){var{displayArray:t,uuidToNode:a}=treeData,n=t.indexOf(e),o=t.length-1;let r=n-1,i=n+1;return 0===n&&(r=o),n===t.length-1&&(i=0),[a[e],a[t[r]],a[t[i]]]}function getLastChildUuid(e){var t;return treeData.uuidToExpand[e]&&0!==treeData.uuidToChildren[e].length&&(t=treeData.uuidToChildren[e].length-1,e=treeData.uuidToChildren[e][t]),e}function getLastExpandChildUuid(e){var t=getLastChildUuid(e);return e=t!==e?getLastExpandChildUuid(t):e}function getParentWhenAddNode(e){if(!e.parent)return null;var t=getNode(e.parent);if(!t)return null;if(canNotCreateNode(t))return null;if(e.canvasRequired){if(hasCanvasComponent(t))return t;for(let e=treeData.uuidToChildren[t.uuid].length-1;0<=e;e--){var a=getNode(treeData.uuidToChildren[t.uuid][e]);if(a&&a.active&&hasCanvasComponent(a))return a}}return t}function getUuid(e){return"string"==typeof e?e:e.uuid}function getNextDisplayNode(e){e=treeData.displayArray.indexOf(e.uuid)-1;return getNode(treeData.displayArray[e])}function getDisplayNodeLeft(e,t=!1){let a=e.depth*panelData.config.iconWidth+panelData.config.padding;return t&&(a+=panelData.config.iconWidth),a}function getDisplayNodeTopOfParent(e){return e.parent?getDisplayNodeChildrenUuids(e.parent).indexOf(e.uuid)*panelData.config.nodeHeight:getDisplayNodeTop(e)}function getDisplayNodeBottomOfParent(e){return getDisplayNodeTopOfParent(e)+(getDisplayNodeChildrenUuids(e.uuid).length+1)*panelData.config.nodeHeight}function getDisplayParentNodeTop(e){return treeData.displayArray.indexOf(e.parent)*panelData.config.nodeHeight+panelData.config.padding}function getDisplayNodeTop(e){e=getUuid(e);return treeData.displayArray.indexOf(e)*panelData.config.nodeHeight+panelData.config.padding}function getDisplayNodeBottom(e){return getDisplayNodeTop(e)+panelData.config.nodeHeight}function inDisplayArray(e){return treeData.displayArray.includes(e)}function getDisplayNodeChildrenUuids(e,t=!1){if(!t&&!treeData.uuidToExpand[e])return[];var a=[];for(const n of treeData.uuidToChildren[e])a.push(n),(t||treeData.uuidToExpand[n])&&a.push(...getChildrenUuids(n,t));return a}function filterChildren(e){if(!e||!e.length)return[];let a=[];return e.forEach(t=>{(a=a.filter(e=>!isAIncludeB(t,e))).some(e=>isAIncludeB(e,t))||a.push(t)}),a}function isAIncludeB(e,t){if(e===t)return!0;e=treeData.uuidToChildren[e];if(Array.isArray(e))for(const a of e)if(isAIncludeB(a,t))return!0;return!1}function getChildrenUuids(e,t=!1){var a=[];for(const n of treeData.uuidToChildren[e])a.push(n),treeData.uuidToParentUuid[n]&&(t||treeData.uuidToExpand[n])&&a.push(...getChildrenUuids(n,t));return a}async function scrollIntoView(n){return new Promise(e=>{var t=getNode(n);if(t){inDisplayArray(n)||treeData.pointExpand(n);const a=calcScrollPosition(t);window.setTimeout(()=>{panelData.$.viewBox.scrollTo(a.left,a.top),e(!0)})}else e(!1)})}function calcScrollPosition(e){var t=panelData.$.viewBox.clientHeight,a=panelData.$.viewBox.offsetWidth,n=panelData.$.viewBox.scrollWidth;let o=panelData.$.viewBox.scrollLeft,r=panelData.$.viewBox.scrollTop;var i=panelData.config.nodeHeight,s=panelData.config.iconWidth,d=panelData.$.tree.scrollTop,l=d+t-i-4,p=getDisplayNodeLeft(e),e=getDisplayNodeTop(e);return(o>p||a<n&&.3*a<p)&&(o=p-2*s),e<=d?r=e:l<=e&&(r=e-t+2*i),{left:o,top:r}}function hasCanvasComponent(e){return e&&e.components.some(e=>"cc.Canvas"===e.type)}exports.ATTRIBUTE_TO_NODE="to-node",exports.forbidOperate=forbidOperate,exports.enableContextMenu=enableContextMenu,exports.canNotDeleteNode=canNotDeleteNode,exports.canNotCreateNode=canNotCreateNode,exports.canNotCopyNode=canNotCopyNode,exports.canNotCutNode=canNotCutNode,exports.canNotRename=canNotRename,exports.canNotDragNode=canNotDragNode,exports.canNotPasteNode=canNotPasteNode,exports.isNoneCopyOrCut=isNoneCopyOrCut,exports.isExistedAsset=isExistedAsset,exports.isSearching=isSearching,exports.isAllExpand=isAllExpand,exports.isActive=isActive,exports.getCanInsideDisplayNode=getCanInsideDisplayNode,exports.isExpand=isExpand,exports.isLastChild=isLastChild,exports.isParent=isParent,exports.isAnimating=isAnimating,exports.isSelected=isSelected,exports.getNode=getNode,exports.getParent=getParent,exports.getSibling=getSibling,exports.getLastChildUuid=getLastChildUuid,exports.getLastExpandChildUuid=getLastExpandChildUuid,exports.getParentWhenAddNode=getParentWhenAddNode,exports.getNextDisplayNode=getNextDisplayNode,exports.getDisplayNodeLeft=getDisplayNodeLeft,exports.getDisplayNodeTopOfParent=getDisplayNodeTopOfParent,exports.getDisplayNodeBottomOfParent=getDisplayNodeBottomOfParent,exports.getDisplayParentNodeTop=getDisplayParentNodeTop,exports.getDisplayNodeTop=getDisplayNodeTop,exports.getDisplayNodeBottom=getDisplayNodeBottom,exports.inDisplayArray=inDisplayArray,exports.getDisplayNodeChildrenUuids=getDisplayNodeChildrenUuids,exports.filterChildren=filterChildren,exports.isAIncludeB=isAIncludeB,exports.getChildrenUuids=getChildrenUuids,exports.scrollIntoView=scrollIntoView,exports.calcScrollPosition=calcScrollPosition,exports.twinkle={watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="hint"){this.watch&&(panelData.$.tree.$set(panelData.$.tree.twinkles,e,t),setTimeout(()=>{panelData.$.tree.twinkles[e]=void 0,delete panelData.$.tree.twinkles[e]},1e3))},asset(e){e.isScene?Editor.Message.send("assets","twinkle",panelData.act.assetUuid):e.prefab&&e.prefab.state&&Editor.Message.send("assets","twinkle",e.prefab.assetUuid)}};