"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),path_1=require("path"),utlis_1=require("../common/utlis");exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../css/index.css"),"utf8");const{I18n:I18n,Message:Message}=Editor;exports.listeners={resize(){this.$.tree.render(!0)}},exports.template='\n    <header>\n        <h1>\n            <ui-label value="i18n:package-asset.import.title"></ui-label>\n        </h1>\n        <ui-progress></ui-progress>\n        <ui-label class="info"></ui-label>\n    </header>\n    <section>\n        <ui-tree></ui-tree>\n        <ui-loading class="loading"></ui-loading> \n    </section>\n        \n    <footer>\n        <ui-button class="import">\n            <ui-label value="i18n:package-asset.import.button"></ui-label>\n        </ui-button>\n    </footer>\n',exports.$={tree:"ui-tree",select:".select",progress:"ui-progress",btnImport:".import",loading:".loading",info:".info"};let _state=0;exports.methods={setState(t,e=0,s=""){switch(_state=t,t){case utlis_1.STATE.WAIT:this.$.progress.value=0,this.$.info.setAttribute("value",I18n.t("package-asset.import.message.wait"));break;case utlis_1.STATE.IDLE:this.$.progress.value=0,this.$.info.setAttribute("value",I18n.t("package-asset.import.message.idle",{total:this.total}));break;case utlis_1.STATE.LOADING:this.$.info.setAttribute("value",I18n.t("package-asset.import.message.loading",{name:s,current:e.toString(),total:this.total})),this.$.progress.value=e/this.total*100}},async scanAssets(t){this.setState(utlis_1.STATE.WAIT);try{this.zipAssets=await utlis_1.getImportAssets(t);const e=await utlis_1.analyticalContent(this.zipAssets);this.$.loading.style.display="none",this.$.tree.tree=e,this.updateTotal()}catch(t){console.error(t),await Editor.Dialog.error(I18n.t("package-asset.import.message.failure"),{buttons:[Editor.I18n.t("package-asset.script.confirm")]}),Editor.Panel.close("package-asset.import")}},updateTotal(){this.list=[];const t=e=>{e.forEach(e=>{if(e.detail.checked){if(!e.detail.legal)return;let s=e.detail.asset.name;s.endsWith("/")&&(s=s.substring(s.length-1,0)),this.zipAssets[s+".meta"]?(this.list.push(e.detail.asset),this.list.push(this.zipAssets[s+".meta"]),t(e.children)):console.warn(I18n.t("package-asset.import.message.meta_missing",{name:s}))}})};t(this.$.tree.tree),this.total=this.list.length/2,this.setState(utlis_1.STATE.IDLE),this.total>0?this.$.btnImport.removeAttribute("disabled"):this.$.btnImport.setAttribute("disabled","")},async importAssets(){this.updateTotal(),this.$.btnImport.setAttribute("disabled","");let t=I18n.t("package-asset.import.message.normal_asset");if(0!==utlis_1.importOverrideTipMarker.length){let e="";utlis_1.importOverrideTipMarker.forEach(t=>{e+=t+"\n"}),t=I18n.t("package-asset.import.message.conflict_asset",{list:e})}1!==(await Editor.Dialog.info(t,{buttons:[I18n.t("package-asset.script.confirm"),I18n.t("package-asset.script.cancel")],default:0,cancel:1})).response?(await utlis_1.doImportAssets(this.list,async(t,e)=>{this.setState(utlis_1.STATE.LOADING,e,t)}),this.$.btnImport.removeAttribute("disabled"),Editor.Panel.close("package-asset.import")):this.$.btnImport.removeAttribute("disabled")}},exports.ready=async function(t){utlis_1.initTemplate(this),Message.addBroadcastListener("i18n:change",()=>{this.setState(_state)}),this.$.btnImport.addEventListener("confirm",async()=>{await this.importAssets()}),await this.scanAssets(t)},exports.beforeClose=utlis_1.beforeClose,exports.close=utlis_1.close;