"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),path_1=require("path"),electron_1=require("electron"),utlis_1=require("../common/utlis"),JSZip=require("../../lib/jszip.min");exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../css/index.css"),"utf8");const{I18n:I18n,Message:Message}=Editor;exports.listeners={resize(){this.$.tree.render(!0)}},exports.template='\n    <header>\n        <h1>\n            <ui-label value="i18n:package-asset.export.title"></ui-label>\n        </h1>\n        <ui-progress></ui-progress>\n    </header>\n    \n    <section>\n        <ui-tree></ui-tree>\n        <ui-loading class="loading"></ui-loading>\n    </section>\n    \n    <footer>\n        <ui-checkbox class="btn_depend">\n            <ui-label value="i18n:package-asset.export.btn_depend"></ui-label>\n        </ui-checkbox>\n        <ui-button class="export">\n            <ui-label value="i18n:package-asset.export.button"></ui-label>\n        </ui-button>\n    </footer>\n',exports.$={tree:"ui-tree",select:".select",progress:"ui-progress",btnExport:".export",btnDepend:".btn_depend",loading:".loading"};let _state=0;exports.methods={onRefresh(e){},setState(e,t=0,s=""){switch(_state=e,e){case utlis_1.STATE.WAIT:this.$.progress.value=0,this.$.progress.message=I18n.t("package-asset.export.message.wait");break;case utlis_1.STATE.IDLE:this.$.progress.value=0,this.$.progress.message=I18n.t("package-asset.export.message.idle",{total:this.total});break;case utlis_1.STATE.LOADING:this.$.progress.message=Editor.I18n.t("package-asset.export.message.loading",{name:s,current:t.toString(),total:this.total}),this.$.progress.value=t/this.total*100;break;case utlis_1.STATE.COMPLETED:this.$.progress.message=I18n.t("package-asset.export.message.complete")}},async scanAssets(e){this.uuids=Editor.Selection.getSelected("asset"),0===this.uuids.length&&(this.uuids=[e.uuid]),this.setState(utlis_1.STATE.WAIT);const t=await Message.request("scene","execute-scene-script",{name:"package-asset",method:"getExportAssets",args:[{uuids:this.uuids,includeDepe:this.$.btnDepend.value}]});this.$.loading.style.display="none",this.$.tree.tree=t,this.updateTotal()},updateTotal(){this.list=[];const e=t=>{t.forEach(t=>{if(t.detail.checked){if(!t.detail.legal)return;this.list.push(t.detail.asset),e(t.children)}})};e(this.$.tree.tree),this.total=this.list.length,this.setState(utlis_1.STATE.IDLE),this.total>0?this.$.btnExport.removeAttribute("disabled"):this.$.btnExport.setAttribute("disabled","")},async exportAssets(){const e=this.$.tree.tree;if(0===e.length)return;const t=(await Editor.Dialog.save({path:await Editor.Profile.getConfig("package-asset","export-path")||Editor.Project.path,title:I18n.t("package-asset.export.title"),filters:[{name:"Package",extensions:["zip"]}]})).filePath||"";if(!utlis_1.isPath(t,!0))return;await Editor.Profile.setConfig("package-asset","export-path",t);const s=new JSZip;let i=0;const a=(e,t)=>{const a=e.detail,n=a.asset;if(!a.checked||!a.legal)return;i++,this.setState(utlis_1.STATE.LOADING,i,n.name);const o=n.isDirectory||"database"===n.importer,l=t||s;if(o){const t=l.folder(n.name);l.file(n.name+".meta",fs_1.readFileSync(n.file+".meta")),r(e.children,t)}else l.file(n.name,fs_1.readFileSync(n.file)),l.file(n.name+".meta",fs_1.readFileSync(n.file+".meta"))};function r(e,t){for(const s of e)a(s,t)}r(e,null),s.generateNodeStream({type:"nodebuffer"}).pipe(fs_1.createWriteStream(t)).on("finish",()=>{electron_1.shell.showItemInFolder(t),Editor.Panel.close("package-asset.export")})}},exports.ready=function(e){utlis_1.initTemplate(this),Message.addBroadcastListener("i18n:change",()=>{this.setState(_state)}),this.$.btnExport.addEventListener("confirm",()=>{this.exportAssets()}),this.$.btnDepend.value=!0,this.$.btnDepend.addEventListener("confirm",async()=>{this.$.loading.style.display="",this.$.tree.tree=await Message.request("scene","execute-scene-script",{name:"package-asset",method:"getExportAssets",args:[{uuids:this.uuids,includeDepe:this.$.btnDepend.value}]}),this.$.loading.style.display="none",this.updateTotal(),this.$.tree.render(!0)}),this.scanAssets(e)},exports.beforeClose=utlis_1.beforeClose,exports.close=utlis_1.close;