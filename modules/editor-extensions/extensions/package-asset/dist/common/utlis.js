"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPath=exports.trimDependUuid=exports.doImportAssets=exports.writeAssets=exports.checkMetaUUid=exports.analyticalContent=exports.initScript=exports.sameScriptList=exports.getImportAssets=exports.getDependScriptUuid=exports.readWriteFileByLineWithProcess=exports.initTemplate=exports.close=exports.beforeClose=exports.isReresh=exports.STATE=exports.PATH_REGEXP=void 0;const resolve_1=__importDefault(require("resolve")),path_1=require("path"),fs_1=require("fs"),readline_1=require("readline"),node_uuid_1=require("node-uuid"),JSZip=require("../../lib/jszip.min"),JSZipUtils=require("../../lib/jszip-utils.min");function onReresh(e){exports.isReresh=(e.metaKey||e.ctrlKey)&&"r"===e.key}function beforeClose(){return!exports.isReresh||(exports.isReresh=!1,!1)}function close(){window.removeEventListener("keydown",onReresh)}function initTemplate(e){window.addEventListener("keydown",onReresh);const t=path_1.join(__dirname,"../../icon/new.png");e.$.tree.css=fs_1.readFileSync(path_1.join(__dirname,"../../css/tree.css"),"utf8"),e.$.tree.setTemplateInit("item",e=>{e.addEventListener("dblclick",()=>{Editor.Message.send("assets","twinkle",e.data.detail.asset.uuid)})}),e.$.tree.setTemplate("text",'<ui-checkbox></ui-checkbox><ui-icon></ui-icon><span class="name"></span><image class="new" ></image>'),e.$.tree.setTemplateInit("text",s=>{s.$checkbox=s.querySelector("ui-checkbox"),s.$icon=s.querySelector("ui-icon"),s.$name=s.querySelector(".name"),s.$new=s.querySelector(".new"),s.$new.style.display="none",s.$new.src=t.replace("#","%23"),s.$checkbox.addEventListener("confirm",()=>{const t=s.data;t.detail.checked=!t.detail.checked,function e(t,s){t.detail.checked=s,t.children&&t.children.forEach(t=>{e(t,s)})}(t,t.detail.checked),function e(t){if(!t)return;const s=t.children.some(e=>e.detail.checked);s!==t.detail.checked&&(t.detail.checked=s,e(t.parent))}(t.parent),e.$.tree.render(!0),e.updateTotal()})}),e.$.tree.setRender("text",(e,t)=>{e.$checkbox.value=t.detail.checked,e.$name.innerHTML=t.detail.value,t.detail.isDirectory?e.$icon.setAttribute("value","folder"):e.$icon.setAttribute("value","file"),e.$new.style.display=t.detail.isNew?"":"none"}),e.$.tree.setRender("item",e=>{e.data.detail.legal?e.removeAttribute("disabled"):e.setAttribute("disabled","")})}async function readWriteFileByLineWithProcess(e,t){await new Promise(s=>{const i=fs_1.createReadStream(e),n=readline_1.createInterface({input:i});n.on("line",e=>{t(e)}),n.on("close",()=>{s()})})}async function getDependScriptUuid(e){let t="";await readWriteFileByLineWithProcess(e.file,e=>{!e.startsWith("import")||e.includes("./")||e.includes("../")?t+=e+"\n":t+="//"+e+"\n"});const s=require("@babel/core"),i=await s.parseAsync(t,{parserOpts:{plugins:["typescript","classProperties","decorators-legacy","dynamicImport","importMeta","logicalAssignment","nullishCoalescingOperator","optionalChaining"]}}),n=[];s.traverse(i,{ImportDeclaration:({node:e})=>{n.push(e.source.value)}});const a=[];return await Promise.all(n.map(t=>new Promise((s,i)=>{resolve_1.default(t,{basedir:path_1.dirname(e.file),extensions:[".ts",".js",".mjs",".cjs"]},async(e,t)=>{if(e)i(e);else{if(t){const e=await Editor.Message.request("asset-db","query-uuid",t);e&&a.push(e)}s()}})}))),a}async function getImportAssets(e){return await new Promise((t,s)=>{JSZipUtils.getBinaryContent(e,(e,i)=>{e?s(e):JSZip.loadAsync(i).then(async e=>{await initScript(e.files),t(e.files)}).catch(e=>{s(e)})})})}async function initScript(e){exports.sameScriptList.length=0;const t=Object.keys(e).map(t=>{if(e[t].name.includes(".ts")&&!e[t].name.endsWith(".meta"))return e[t]}).filter(Boolean);if(t.length>0){const e=[],s=await Editor.Message.request("asset-db","query-assets",{type:"scripts"});for(const t of s){const s=fs_1.readFileSync(t.file,"utf8").match(/@ccclass\(['|"](.*)['|"]\)/);let i;i=s?s&&s[1]:path_1.basename(t.file,path_1.extname(t.file)),e.includes(i)||e.push(i)}for(const s of t)if(s.name.includes(".ts")){const t=(await getContentByFile(s)).match(/@ccclass\(['|"](.*)['|"]\)/);let i;(i=t?t&&t[1]:path_1.basename(s.name,path_1.extname(s.name)))&&e.includes(i)&&!exports.sameScriptList.includes(s.name)&&exports.sameScriptList.push(s.name)}}}function createItem(e){const t=e.name.endsWith("/")?e.name.substring(e.name.length-1,0):e.name,s=!exports.sameScriptList.includes(e.name);return{detail:{value:path_1.basename(t),url:t,file:t,checked:!0,extname:path_1.extname(t),isDirectory:e.dir,legal:s,asset:e,isNew:!fs_1.existsSync(path_1.join(Editor.Project.path,"assets",t))&&s},showArrow:e.dir,children:[]}}exports.PATH_REGEXP=/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im,exports.STATE={WAIT:0,IDLE:1,LOADING:2,COMPLETED:3},exports.isReresh=!1,exports.beforeClose=beforeClose,exports.close=close,exports.initTemplate=initTemplate,exports.readWriteFileByLineWithProcess=readWriteFileByLineWithProcess,exports.getDependScriptUuid=getDependScriptUuid,exports.getImportAssets=getImportAssets,exports.sameScriptList=[],exports.initScript=initScript;const _tree=[],_flattenedTree=[];function addAssetToTree(e){const t=e.name.split("/").filter(Boolean);let s,i="";for(let n=0;n<t.length;++n)if(n>0&&(i+="/"),i+=t[n],!(s=_flattenedTree.find(e=>e.detail.url===i))){s=createItem(e);const t=path_1.dirname(i),n=_flattenedTree.find(e=>e.detail.url===t);n?n.children.push(s):_tree.push(s),_flattenedTree.push(s)}}async function analyticalContent(e){_tree.length=0,_flattenedTree.length=0;for(const t in e)t.endsWith(".meta")||addAssetToTree(e[t]);return exports.sameScriptList.length>0&&await Editor.Dialog.warn(Editor.I18n.t("package-asset.script.message"),{title:Editor.I18n.t("package-asset.script.title"),buttons:[Editor.I18n.t("package-asset.script.confirm")],default:0}),_tree}exports.analyticalContent=analyticalContent;const uuidsMap=new Map;async function checkMetaUUid(e){const t=await getContentByFile(e),s=JSON.parse(t),i=await Editor.Message.request("asset-db","query-path",s.uuid);if(i){path_1.join(Editor.Project.path,"assets",path_1.basename(e.name,path_1.extname(e.name)))!==i&&uuidsMap.set(s.uuid,node_uuid_1.v4())}}async function getContentByFile(e){return new Promise(t=>{e.async("string").then(e=>{t(e)})})}async function writeAssets(e,t){return new Promise(s=>{t.nodeStream().pipe(fs_1.createWriteStream(e)).on("finish",()=>{s()})})}exports.checkMetaUUid=checkMetaUUid,exports.writeAssets=writeAssets;const skipExtname=[".jpg",".png",".jpeg",".webp",".tga",".effect",".dbbin",".bin",".atlas",".glb",".terrain",".mp3",".wav",".ogg",".aac",".pcm","m4a",".mp4",".labelatlas",".js",".ts",".tmx",".tsx",".fbx"],assetList=[];async function doImportAssets(e,t){uuidsMap.clear(),assetList.length=0;for(const t of e){const e=t.name,s=path_1.join(Editor.Project.path,"assets",e);fs_1.existsSync(s)||e.endsWith(".meta")&&await checkMetaUUid(t)}let s=1;for(let i=0;i<e.length;++i){const n=e[i],a=n.name,r=path_1.join(Editor.Project.path,"assets",a);if(i%2==0&&t(path_1.basename(a),s++),!fs_1.existsSync(r))if(n.dir)fs_1.mkdirSync(r);else{if(!skipExtname.includes(path_1.extname(n.name))){let e=!1,t=await getContentByFile(n);if(uuidsMap.forEach((s,i)=>{const n=new RegExp(i,"g");t.match(n)&&(t=t.replace(n,s),e=!0)}),e){fs_1.writeFileSync(r,t);continue}}await writeAssets(r,n)}}await Editor.Message.request("asset-db","refresh")}function trimDependUuid(e){return e.split("@")[0]}function isPath(e,t=!1){let s;if(e){const i=e.match(exports.PATH_REGEXP);if(i){let e;e=t?"package-asset.export.message.name_contains_symbol":"package-asset.import.message.path_contains_symbol",s=Editor.I18n.t(e,{symbol:i[1]})}}else s=Editor.I18n.t("package-asset.path_empty");return!s||(Editor.Dialog.error(s,{buttons:[Editor.I18n.t("package-asset.script.confirm")]}),!1)}exports.doImportAssets=doImportAssets,exports.trimDependUuid=trimDependUuid,exports.isPath=isPath;