"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPath=exports.trimDependUuid=exports.doImportAssets=exports.writeAssets=exports.checkMetaUUid=exports.analyticalContent=exports.initScript=exports.sameScriptList=exports.getImportAssets=exports.getDependScriptUuid=exports.readWriteFileByLineWithProcess=exports.initTemplate=exports.close=exports.beforeClose=exports.isRefresh=exports.STATE=exports.PATH_REGEXP=exports.importOverrideTipMarker=void 0;const path_1=require("path"),fs_1=require("fs");module.paths.push(path_1.join(Editor.App.path,"node_modules"));const resolve_1=__importDefault(require("resolve")),fs_extra_1=require("fs-extra"),readline_1=require("readline"),node_uuid_1=require("node-uuid"),crypto_1=require("crypto"),JSZip=require("../../lib/jszip.min"),JSZipUtils=require("../../lib/jszip-utils.min");function onRefresh(e){exports.isRefresh=(e.metaKey||e.ctrlKey)&&"r"===e.key}function beforeClose(){return!exports.isRefresh||(exports.isRefresh=!1,!1)}function close(){window.removeEventListener("keydown",onRefresh)}function initTemplate(e){window.addEventListener("keydown",onRefresh);const t=path_1.join(__dirname,"../../icon/new.png");e.$.tree.css=fs_1.readFileSync(path_1.join(__dirname,"../../css/tree.css"),"utf8"),e.$.tree.$content.style.overflowX="auto",e.$.tree.setTemplate("text",'\n        <ui-checkbox></ui-checkbox>\n        <ui-icon color ></ui-icon>\n        <span class="name"></span>\n        <image class="new" ></image>\n        <ui-icon color class="conflict" value="warn-triangle"\n            tooltip="i18n:package-asset.import.conflict_text"\n        ></ui-icon>\n        <ui-icon color class="select" value="select"></ui-icon>\n        \n    '),e.$.tree.setTemplateInit("text",s=>{s.$checkbox=s.querySelector("ui-checkbox"),s.$icon=s.querySelector("ui-icon"),s.$name=s.querySelector(".name"),s.$new=s.querySelector(".new"),s.$new.style.display="none",s.$new.src=t.replace("#","%23"),s.$conflict=s.querySelector(".conflict"),s.$conflict.style.display="none",s.$select=s.querySelector(".select"),s.$select.style.display="none",s.$select.addEventListener("click",async()=>{const e=s.data.detail;let t=e.asset.uuid;if(!t){const s="db://"+path_1.join("assets",e.url);t=await Editor.Message.request("asset-db","query-uuid",s)}Editor.Message.request("assets","twinkle",t)}),s.$checkbox.addEventListener("confirm",()=>{const t=s.data;t.detail.checked=!t.detail.checked,function e(t,s){t.detail.checked=s,t.children&&t.children.forEach(t=>{e(t,s)})}(t,t.detail.checked),function e(t){if(!t)return;const s=t.children.some(e=>e.detail.checked);s!==t.detail.checked&&(t.detail.checked=s,e(t.parent))}(t.parent),e.$.tree.render(!0),e.updateTotal()})}),e.$.tree.setRender("text",(e,t)=>{const s=t.detail;e.$checkbox.value=s.checked,e.$name.innerHTML=s.value,e.$icon.setAttribute("value",s.icon),e.$new.style.display=s.isNew?"":"none",e.$conflict.style.display=s.isConflict?"":"none",e.$select.style.display=!s.isNew||s.isConflict?"":"none"}),e.$.tree.setRender("item",e=>{e.data.detail.legal?e.removeAttribute("disabled"):e.setAttribute("disabled","")})}async function readWriteFileByLineWithProcess(e,t){await new Promise(s=>{const i=fs_1.createReadStream(e),n=readline_1.createInterface({input:i});n.on("line",e=>{t(e)}),n.on("close",()=>{s()})})}async function getDependScriptUuid(e){let t="";await readWriteFileByLineWithProcess(e.file,e=>{!e.startsWith("import")||e.includes("./")||e.includes("../")?t+=e+"\n":t+="//"+e+"\n"});const s=require("@babel/core"),i=await s.parseAsync(t,{parserOpts:{plugins:["typescript","classProperties","decorators-legacy","dynamicImport","importMeta","logicalAssignment","nullishCoalescingOperator","optionalChaining"]}}),n=[];s.traverse(i,{ImportDeclaration:({node:e})=>{n.push(e.source.value)}});const r=[];return await Promise.all(n.map(t=>new Promise((s,i)=>{resolve_1.default(t,{basedir:path_1.dirname(e.file),extensions:[".ts",".js",".mjs",".cjs"]},async(e,t)=>{if(e)i(e);else{if(t){const e=await Editor.Message.request("asset-db","query-uuid",t);e&&r.push(e)}s()}})}))),r}async function getImportAssets(e){return await new Promise((t,s)=>{JSZipUtils.getBinaryContent(e,(e,i)=>{e?s(e):JSZip.loadAsync(i).then(async e=>{await initScript(e.files),t(e.files)}).catch(e=>{s(e)})})})}async function initScript(e){exports.sameScriptList.length=0;const t=Object.keys(e).map(t=>{if(e[t].name.includes(".ts")&&!e[t].name.endsWith(".meta"))return e[t]}).filter(Boolean);if(t.length>0){const e=[],s=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Script"});for(const t of s){const s=fs_1.readFileSync(t.file,"utf8").match(/@ccclass\(['|"](.*)['|"]\)/);let i;i=s?s&&s[1]:path_1.basename(t.file,path_1.extname(t.file)),e.includes(i)||e.push(i)}for(const s of t)if(s.name.includes(".ts")){const t=(await getContentByFile(s)).match(/@ccclass\(['|"](.*)['|"]\)/);let i;(i=t?t&&t[1]:path_1.basename(s.name,path_1.extname(s.name)))&&e.includes(i)&&!exports.sameScriptList.includes(s.name)&&exports.sameScriptList.push(s.name)}}}function checkIsNew(e){try{return!fs_1.existsSync(e)}catch(e){return!0}}function checkIsConflict(e,t){try{if(fs_1.statSync(e).isFile()){const s=fs_1.readFileSync(e,"utf8"),i=crypto_1.createHash("md5").update(s).digest("hex")!==crypto_1.createHash("md5").update(t).digest("hex");return i&&exports.importOverrideTipMarker.push(e),i}return!1}catch(e){return!1}}function getIcon(e){try{return _metas.get(e+".meta").importer}catch(e){return"unknow"}}async function createItem(e,t){let s=t||e.name;s=s.endsWith("/")?s.substring(e.name.length-1,0):s;const i=!exports.sameScriptList.includes(s),n=path_1.join(Editor.Project.path,"assets",s);return{detail:{value:path_1.basename(s),url:s,file:s,checked:!0,extname:path_1.extname(s),isDirectory:e.dir,legal:i,asset:e,icon:getIcon(s),isConflict:checkIsConflict(n,await getContentByFile(e)),isNew:checkIsNew(n)&&i},showArrow:e.dir,children:[]}}exports.importOverrideTipMarker=[],exports.PATH_REGEXP=/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im,exports.STATE={WAIT:0,IDLE:1,LOADING:2,COMPLETED:3},exports.isRefresh=!1,exports.beforeClose=beforeClose,exports.close=close,exports.initTemplate=initTemplate,exports.readWriteFileByLineWithProcess=readWriteFileByLineWithProcess,exports.getDependScriptUuid=getDependScriptUuid,exports.getImportAssets=getImportAssets,exports.sameScriptList=[],exports.initScript=initScript;const _tree=[],_flattenedTree=[],_metas=new Map;async function addAssetToTree(e){const t=e.name.split("/").filter(Boolean);let s,i="";for(let n=0;n<t.length;++n)if(n>0&&(i+="/"),i+=t[n],!(s=_flattenedTree.find(e=>e.detail.url===i))){s=await createItem(e,i);const t=path_1.dirname(i),n=_flattenedTree.find(e=>e.detail.url===t);n?n.children.push(s):_tree.push(s),_flattenedTree.push(s)}}async function analyticalContent(e){exports.importOverrideTipMarker.length=0,_tree.length=0,_flattenedTree.length=0,_metas.clear();const t=[];for(const s in e){const i=e[s];if(i.name.endsWith(".meta")){const e=await getContentByFile(i),t=JSON.parse(e);_metas.set(i.name,t)}else t.push(i)}for(let e=0;e<t.length;e++)await addAssetToTree(t[e]);return exports.sameScriptList.length>0&&await Editor.Dialog.warn(Editor.I18n.t("package-asset.script.message"),{title:Editor.I18n.t("package-asset.script.title"),buttons:[Editor.I18n.t("package-asset.script.confirm")],default:0}),_tree}exports.analyticalContent=analyticalContent;const uuidsMap=new Map;async function checkMetaUUid(e){let t=_metas.get(e.name);t||(t=JSON.parse(await getContentByFile(e)));const s=await Editor.Message.request("asset-db","query-path",t.uuid);if(s){path_1.join(Editor.Project.path,"assets",path_1.basename(e.name,path_1.extname(e.name)))!==s&&uuidsMap.set(t.uuid,node_uuid_1.v4())}}async function getContentByFile(e){return new Promise(t=>{e.async("string").then(e=>{t(e)}).catch(()=>{t("")})})}async function writeAssets(e,t){return new Promise(s=>{t.nodeStream().pipe(fs_1.createWriteStream(e)).on("finish",()=>{s()})})}exports.checkMetaUUid=checkMetaUUid,exports.writeAssets=writeAssets;const skipExtname=[".jpg",".png",".jpeg",".webp",".tga",".effect",".dbbin",".bin",".atlas",".glb",".terrain",".mp3",".wav",".ogg",".aac",".pcm","m4a",".mp4",".labelatlas",".js",".ts",".tmx",".tsx",".fbx"],assetList=[];async function doImportAssets(e,t){uuidsMap.clear(),assetList.length=0;for(const t of e){const e=t.name,s=path_1.join(Editor.Project.path,"assets",e);fs_1.existsSync(s)||e.endsWith(".meta")&&await checkMetaUUid(t)}let s=1;for(let i=0;i<e.length;++i){const n=e[i],r=n.name,a=path_1.join(Editor.Project.path,"assets",r);if(i%2==0&&t(path_1.basename(r),s++),n.dir){if(fs_1.existsSync(a))continue;fs_extra_1.ensureDirSync(a)}else{if(!skipExtname.includes(path_1.extname(n.name))){let e=!1,t=await getContentByFile(n);if(!checkIsNew(a)&&!checkIsConflict(a,t))continue;if(uuidsMap.forEach((s,i)=>{const n=new RegExp(i,"g");t.match(n)&&(t=t.replace(n,s),e=!0)}),e){fs_1.writeFileSync(a,t);continue}}await writeAssets(a,n)}}}function trimDependUuid(e){return e.split("@")[0]}function isPath(e,t=!1){let s;if(e){const i=e.match(exports.PATH_REGEXP);if(i){let e;e=t?"package-asset.export.message.name_contains_symbol":"package-asset.import.message.path_contains_symbol",s=Editor.I18n.t(e,{symbol:i[1]})}}else s=Editor.I18n.t("package-asset.path_empty");return!s||(Editor.Dialog.error(s,{buttons:[Editor.I18n.t("package-asset.script.confirm")]}),!1)}exports.doImportAssets=doImportAssets,exports.trimDependUuid=trimDependUuid,exports.isPath=isPath;