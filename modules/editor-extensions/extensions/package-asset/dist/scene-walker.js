"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),path_1=require("path"),utlis_1=require("./common/utlis");module.paths.push((0,path_1.join)(Editor.App.path,"node_modules"));const fs_extra_1=require("fs-extra"),collator=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});exports.methods={_dependMap:[],_assetsMap:[],_depends:[],_tree:[],_flattenedTree:[],_databaseAssets:[],_includeDepend:!1,getUuid(e){const t=e.split("@");return t.length>1&&(e=t[0]),e},async getExportAssets(e){this._includeDepend=e.includeDepend;const t=e.uuids;await this._reset();for(const e of t)await this._step(e);const s=await Editor.Message.request("assets","unstaging");let i="type";s&&(i=s.sortType);for(let e=0;e<this._tree.length;++e){const t=this._tree[e];await this.pruningTree(e,t,this._tree)}return await this.sortTree(this._tree,i),this._tree},async pruningTree(e,t,s){if(!t.detail.isDirectory)return;const i=[];for(let e=0;e<t.children.length;++e){const s=t.children[e];s.detail.isDirectory&&(0===s.children.length?i.push(e):this.pruningTree(e,s,t))}for(const e of i)t.children.splice(e,1);0===t.children.length&&(Array.isArray(s)?s.splice(e,1):s.children.splice(e,1))},async sortTree(e,t){e.sort((e,s)=>{const i=e.detail.asset,r=s.detail.asset;return!0!==i.isDirectory||r.isDirectory?i.isDirectory||!0!==r.isDirectory?"type"===t&&i.importer!==r.importer?collator.compare(i.importer,r.importer):collator.compare(i.path,r.path):1:-1});for(const s of e)this.sortTree(s.children,t)},async _reset(){this._tree.length=0,this._flattenedTree.length=0,this._assetsMap.length=0,this._dependMap=await this._getDependMap(),this._depends.length=0,this._databaseAssets.length=0},async createItem(e){const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return console.log(`can not found asset info by url: ${e}`),null;const s=t.isDirectory||"database"===t.importer,i=this._depends.includes(t.uuid),r=!t.url.startsWith("db://internal");return{detail:{value:t.name,url:t.url,file:t.file,checked:!0,extname:(0,path_1.extname)(t.file),isDirectory:s,legal:r,asset:t,depend:i,icon:t.importer},showArrow:s,children:[]}},_getDependMap:async()=>Editor.Message.request("asset-db","execute-script",{name:"package-asset",method:"getDependMap"}),async _addAssetTree(e){if(this._assetsMap.push(e.uuid),this._flattenedTree.find(t=>t.detail.url===e.url))return;const t=e.url.slice("db://".length).split("/");let s,i,r=e.url,a="";for(;0!==t.length;){if(t.pop(),"db://assets"===r&&a){s=this._flattenedTree.find(e=>e.detail.url===a),this._tree.find(e=>e.detail.url===s.detail.url)||this._tree.push(s);break}if(s=this._flattenedTree.find(e=>e.detail.url===r)){if(!s.children.find(e=>e.detail.url===a)&&i&&(s.children.push(i),s.detail.isDirectory))break}else{if(!(s=await this.createItem(r)))continue;if(!this._includeDepend&&s.detail.depend)break;this._flattenedTree.push(s),i&&s.children.push(i)}i=s,a=r,r=(0,path_1.dirname)(r)}},hasNeedToDepend(e){for(const t of this._databaseAssets)if(e.includes(t.file))return!1;return!0},_addDepend(e){const t=[];for(let s of e)s=(0,utlis_1.trimDependUuid)(s),t.includes(s)||t.push(s),this._depends.includes(s)||this._depends.push(s);return t},async _depend(e){if(!this.hasNeedToDepend(e))return;let t=[];const s=(this._dependMap.path||[])[e]||[];for(const e of s){const s=await Editor.Message.request("asset-db","query-uuid",e);s&&t.push(s)}const i=(this._dependMap.uuid||[])[e]||[];t=t.concat(i),t=this._addDepend(t);for(const e of t)await this._step(e)},async getSourceAsset(e){return e=this.getUuid(e),await Editor.Message.request("asset-db","query-asset-info",e)},async _step(e){try{const t=await this.getSourceAsset(e);if(!t||t.url.startsWith("db://internal")||this._assetsMap.includes(e))return;if("database"===t.importer&&this._databaseAssets.push(t),await this._addAssetTree(t),t.isDirectory||"database"===t.importer){const e=(0,fs_1.readdirSync)(t.file);for(const s of e){if(s.endsWith(".meta")||s.endsWith(".DS_Store"))continue;const e=t.path+"/"+s,i=await Editor.Message.request("asset-db","query-uuid",e);await this._depend(t.file),i&&await this._step(i)}}else"cc.Script"===t.type?await this._dependTypescript(t):await this._dependUuid(t),await this._depend(t.file)}catch(e){console.log(e)}},async _dependUuid(e){let t="",s=[];switch(e.importer){case"terrain":t=(0,fs_1.readFileSync)(e.library[".json"],"utf8");break;case"fbx":case"gltf":{const t=await this._dependGltfUuid(e);s=s.concat(t);break}default:t=(0,fs_1.readFileSync)(e.file,"utf-8")}s=(s=s.concat(t.match(/(?<=__uuid__": ")(.*)(?=")/g)||[])).concat(t.match(/(?<=uuid": ")(.*)(?=")/g)||[]);let i=[];i=i.concat(t.match(/(?<=__type__": ")(.*)(?=")/g)||[]);for(const e of i){const t=Editor.Utils.UUID.decompressUUID(e);t.startsWith("cc.")||s.push(t)}s=this._addDepend(s);for(const e of s)await this._step(e)},async _dependGltfUuid(e){const t=[],s=e.file+".meta",i=(0,fs_extra_1.readJSONSync)(s).userData;if(!i)return[];const r=i.assetFinder&&i.assetFinder.materials||[];for(const e of r)t.includes(e)||t.push(e);const a=i.imageMetas||[];for(const e of a){let s;(s=e.uri.includes("/")?await Editor.Message.request("asset-db","query-uuid",e.uri):e.uri.split("@")[0])?t.includes(s)||t.push(s):console.log(`can not find uuid: ${s} by image uri: ${e.uri}`)}return t},async _dependTypescript(e){let t=await(0,utlis_1.getDependScriptUuid)(e);t=this._addDepend(t);for(const e of t)await this._step(e)}};