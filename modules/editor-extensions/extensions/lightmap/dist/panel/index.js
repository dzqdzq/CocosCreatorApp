"use strict";var fs=require("fs"),ps=require("path"),Vue=require("vue"),image=require("../image-47066dad.js");function _interopDefaultLegacy(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var fs__default=_interopDefaultLegacy(fs),Vue__default=_interopDefaultLegacy(Vue);Vue__default.default.config.productionTip=!1,Vue__default.default.config.devtools=!1;const Chroma=require("chroma-js");var Modes;!function(t){t[t.SCENE=0]="SCENE",t[t.BAKED=1]="BAKED"}(Modes||(Modes={}));var manager=Vue__default.default.extend({name:"App",data:()=>({mode:Modes.SCENE,progress:0,logInfos:[],picInfos:[],selectInfos:{},isGenerate:!1,msaa:4,path:"",size:1024,giScale:.5,giSamples:25,giPathLength:4,aoLevel:0,aoStrength:.5,aoRadius:1,aoColor:"#888",tab:0,r:!0,g:!0,b:!0,a:!1}),computed:{channel(){return(this.r?"r":"")+(this.g?"g":"")+(this.b?"b":"")+(this.a?"a":"")||void 0}},async mounted(){const t=await Editor.Message.request("lightmap","unstaging");t.isStart&&!t.isEnd&&(this.isGenerate=!0,this.progress=t.progress),this.setLogs(t.logInfos),t.isEnd&&(fs__default.default.existsSync(ps.join(t.currPath,"output"))?this.picInfos=await image.readImageList(ps.join(t.currPath,"output")):this.picInfos=[],this.saveEdit())},methods:{changeColor(t){this.aoColor=Chroma(t.target.value).hex(),this.saveEdit()},saveEdit(){Editor.Profile.setConfig("lightmap","lightmap",{msaa:this.msaa,size:this.size,giScale:this.giScale,giSamples:this.giSamples,giPathLength:this.giPathLength,aoLevel:this.aoLevel,aoStrength:this.aoStrength,aoRadius:this.aoRadius,aoColor:this.aoColor}),this.onItemClick(0)},t(t){const e=`lightmap.${t}`;return Editor.I18n.t(e)},clickTab(t,e){this[t]=e,"a"===t?e&&(this.r=this.g=this.b=!1):e&&(this.a=!1)},changeMode(t){this.mode=t},async onClear(){const t=await Editor.Message.request("lightmap","unstaging");""===t.currPath||this.isGenerate||(delDir(t.currPath),this.selectInfos={},this.picInfos=[],this.logInfos=[],await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"clear",args:[]}),await Editor.Message.request("lightmap","clear"),await Editor.Message.request("asset-db","refresh-asset","db://assets"))},async onCancel(){this.isGenerate=!1,this.logInfos=[],await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"cancel",args:[]})},async onBakerEnd(){this.isGenerate=!1;const t=await Editor.Message.request("lightmap","unstaging");this.picInfos=await image.readImageList(ps.join(t.currPath,"output")),this.saveEdit()},pushLog(t){this.logInfos.push(t)},setLogs(t){this.logInfos=[];for(let e=0;e<t.length;e++)this.logInfos.push(t[e])},onItemClick(t){this.selectInfos={};for(const e in this.picInfos[t])"path"!==e&&"uuid"!==e&&(this.selectInfos[e]=this.picInfos[t][e])},async onConfirm(){this.r=this.g=this.b=!0,this.progress=0,this.logInfos=[];const t=await Editor.Dialog.select({type:"directory",title:this.t("title"),path:ps.join(Editor.Project.path,"assets"),multi:!1,filters:[{name:"Lightmap",extensions:["png"]}]});let e=t.filePaths?t.filePaths[0]:[];if(Array.isArray(e)&&(e=e[0]),!e)return!1;e=`${e}/LightFX`,this.path=e,await new Promise(t=>{setTimeout(t,500)}),await Editor.Message.request("lightmap","savePicPath",e),fs__default.default.existsSync(e)&&(delDir(e),await Editor.Message.request("asset-db","refresh-asset",e)),this.logInfos.push(this.t("start")+"\n"),this.isGenerate=!0;try{await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"apply",args:[this.$data,Editor.App.path]})}catch(t){console.error(t),await this.onCancel(),this.logInfos.push(this.t("fail")+"\n")}}}});function delDir(t,e=!1){let n=[];fs__default.default.existsSync(t)&&(n=fs__default.default.readdirSync(t)).forEach((e,n)=>{const a=t+"/"+e;e.endsWith(".meta")||(fs__default.default.statSync(a).isDirectory()?delDir(a,!0):fs__default.default.unlinkSync(a))})}function normalizeComponent(t,e,n,a,i,s,o,l,r,c){"boolean"!=typeof o&&(r=l,l=o,o=!1);const p="function"==typeof n?n.options:n;let u;if(t&&t.render&&(p.render=t.render,p.staticRenderFns=t.staticRenderFns,p._compiled=!0,i&&(p.functional=!0)),a&&(p._scopeId=a),s?(u=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),e&&e.call(this,r(t)),t&&t._registeredComponents&&t._registeredComponents.add(s)},p._ssrRegister=u):e&&(u=o?function(t){const n=this.$root.$el&&this.$root.$el.parentNode||this.$root.$options.el&&this.$root.$options.el.parentNode;e.call(this,c(t,n))}:function(t){e.call(this,l(t))}),u)if(p.functional){const t=p.render;p.render=function(e,n){return u.call(n),t(e,n)}}else{const t=p.beforeCreate;p.beforeCreate=t?[].concat(t,u):[u]}return n}var normalizeComponent_1=normalizeComponent;const styles={},isOldIE="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());var styleInjector=function(t,e){return function(t,n){const a=isOldIE?n.media||"default":t,i=styles[a]||(styles[a]={ids:new Set,styles:[]});if(!i.ids.has(t)){i.ids.add(t);let a=n.source;if(n.map&&(a+="\n/*# sourceURL="+n.map.sources[0]+" */",a+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n.map))))+" */"),i.element||(i.element=document.createElement("style"),i.element.type="text/css",n.media&&i.element.setAttribute("media",n.media),void 0===e&&(e=document.shadowRoot||document.getElementsByTagName("shadowRoot")[0]),e.appendChild(i.element)),"styleSheet"in i.element)i.styles.push(a),i.element.styleSheet.cssText=i.styles.filter(Boolean).join("\n");else{const t=i.ids.size-1,e=document.createTextNode(a),n=i.element.childNodes;n[t]&&i.element.removeChild(n[t]),n.length?i.element.insertBefore(e,n[t]):i.element.appendChild(e)}}}};const __vue_script__=manager;var __vue_render__=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"lightmap"},[n("header",[n("ui-tab",{staticClass:"button_tab",attrs:{value:t.mode},on:{confirm:function(e){return t.changeMode(e.target.value)}}},[n("ui-button",[t._v("Scene")]),t._v(" "),n("ui-button",[t._v("Baked")])],1)],1),t._v(" "),n("section",{directives:[{name:"show",rawName:"v-show",value:0===t.mode,expression:"mode === 0"}]},[n("div",{staticClass:"properties"},[n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"MSAA"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-select",{attrs:{value:t.msaa},on:{confirm:function(e){e.stopPropagation(),t.msaa=e.target.value,t.saveEdit()}}},[n("option",{attrs:{value:"1"}},[t._v("\n              1\n            ")]),t._v(" "),n("option",{attrs:{value:"2"}},[t._v("\n              2\n            ")]),t._v(" "),n("option",{attrs:{value:"4"}},[t._v("\n              4\n            ")]),t._v(" "),n("option",{attrs:{value:"8"}},[t._v("\n              8\n            ")])])],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"Resolution"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-select",{attrs:{value:t.size},on:{confirm:function(e){e.stopPropagation(),t.size=e.target.value,t.saveEdit()}}},[n("option",{attrs:{value:"128"}},[t._v("\n              128\n            ")]),t._v(" "),n("option",{attrs:{value:"256"}},[t._v("\n              256\n            ")]),t._v(" "),n("option",{attrs:{value:"512"}},[t._v("\n              512\n            ")]),t._v(" "),n("option",{attrs:{value:"1024"}},[t._v("\n              1024\n            ")]),t._v(" "),n("option",{attrs:{value:"2048"}},[t._v("\n              2048\n            ")])])],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"GIScale"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-num-input",{attrs:{value:t.giScale,state:"",preci:"2",step:"0.1"},on:{change:function(e){t.giScale=e.target.value,t.saveEdit()}}})],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"GISamples"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-num-input",{attrs:{value:t.giSamples},on:{change:function(e){t.giSamples=e.target.value,t.saveEdit()}}})],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"Bounces"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-select",{attrs:{value:t.giPathLength},on:{confirm:function(e){e.stopPropagation(),t.giPathLength=e.target.value,t.saveEdit()}}},[n("option",{attrs:{value:"1"}},[t._v("\n              1\n            ")]),t._v(" "),n("option",{attrs:{value:"2"}},[t._v("\n              2\n            ")]),t._v(" "),n("option",{attrs:{value:"3"}},[t._v("\n              3\n            ")]),t._v(" "),n("option",{attrs:{value:"4"}},[t._v("\n              4\n            ")])])],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOLevel"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-select",{attrs:{value:t.aoLevel},on:{confirm:function(e){e.stopPropagation(),t.aoLevel=e.target.value,t.saveEdit()}}},[n("option",{attrs:{value:"0"}},[t._v("\n              0\n            ")]),t._v(" "),n("option",{attrs:{value:"1"}},[t._v("\n              1\n            ")]),t._v(" "),n("option",{attrs:{value:"2"}},[t._v("\n              2\n            ")])])],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOStrength"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-num-input",{attrs:{value:t.aoStrength,state:"",preci:"2",step:"0.1"},on:{change:function(e){t.aoStrength=e.target.value,t.saveEdit()}}})],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AORadius"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-num-input",{attrs:{value:t.aoRadius,state:"",preci:"2",step:"0.1"},on:{change:function(e){t.aoRadius=e.target.value,t.saveEdit()}}})],1)],1),t._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOColor"},slot:"label"}),t._v(" "),n("div",{attrs:{slot:"content"},slot:"content"},[n("ui-color",{attrs:{value:t.aoColor},on:{confirm:function(e){return e.stopPropagation(),t.changeColor(e)}}})],1)],1)],1),t._v(" "),n("ui-button",{staticClass:"generate",on:{click:function(e){t.isGenerate?t.onCancel():t.onConfirm()}}},[n("ui-label",{staticClass:"label",attrs:{value:t.isGenerate?"i18n:lightmap.cancel":"i18n:lightmap.generate"}})],1),t._v(" "),n("ui-progress",{directives:[{name:"show",rawName:"v-show",value:t.isGenerate,expression:"isGenerate"}],staticClass:"progress",attrs:{value:t.progress}}),t._v(" "),n("div",{staticClass:"output"},t._l(t.logInfos,function(e,a){return n("div",{key:a},[n("div",[t._v(t._s(e))])])}),0)],1),t._v(" "),n("section",{directives:[{name:"show",rawName:"v-show",value:1===t.mode,expression:"mode === 1"}]},[n("div",{staticClass:"properties result"},[n("ui-label",{attrs:{value:"i18n:lightmap.bakedResult"}}),t._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:t.picInfos.length>0,expression:"picInfos.length > 0"}],staticClass:"channels"},[n("ui-label",{class:{select:t.r},on:{click:function(e){return t.clickTab("r",!t.r)}}},[t._v("\n          R\n        ")]),t._v(" "),n("ui-label",{class:{select:t.g},on:{click:function(e){return t.clickTab("g",!t.g)}}},[t._v("\n          G\n        ")]),t._v(" "),n("ui-label",{class:{select:t.b},on:{click:function(e){return t.clickTab("b",!t.b)}}},[t._v("\n          B\n        ")]),t._v(" "),n("ui-label",{class:{select:t.a},on:{click:function(e){return t.clickTab("a",!t.a)}}},[t._v("\n          A\n        ")])],1),t._v(" "),n("div",{staticClass:"image-content"},t._l(t.picInfos,function(e,a){return n("ui-image",{key:a,ref:"images",refInFor:!0,attrs:{"show-alpha":"",channel:t.channel,value:e.path+"?"+e.birthtime},on:{click:function(e){return t.onItemClick(a)}}})}),1)],1),t._v(" "),n("ui-button",{staticClass:"clear",on:{click:function(e){return t.onClear()}}},[n("ui-label",{staticClass:"label",attrs:{i18n:"",value:"lightmap.clear"}})],1),t._v(" "),n("div",{staticClass:"output"},t._l(t.selectInfos,function(e,a){return n("div",{key:a},[n("ui-label",{staticClass:"label",attrs:{i18n:"",value:"lightmap."+a}}),t._v(" "),n("ui-label",{staticClass:"data",attrs:{value:e}})],1)}),0)],1)])},__vue_staticRenderFns__=[];__vue_render__._withStripped=!0;const __vue_inject_styles__=function(t){t&&t("data-v-7f2ac41a_0",{source:".lightmap[data-v-7f2ac41a] {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n}\n.lightmap > header[data-v-7f2ac41a] {\n  margin-top: 14px;\n  text-align: center;\n}\n.lightmap section[data-v-7f2ac41a] {\n  flex: 1;\n  display: flex;\n  overflow: hidden;\n  flex-direction: column;\n  height: 100%;\n}\n.lightmap section .properties[data-v-7f2ac41a] {\n  padding: 8px 14px;\n}\n.lightmap section .properties ui-prop > div[slot='content'][data-v-7f2ac41a] {\n  width: 100%;\n}\n.lightmap section .properties ui-prop > div[slot='content'][data-v-7f2ac41a] > :first-child {\n  width: 100%;\n  margin-bottom: 5px;\n}\n.lightmap section .properties.result[data-v-7f2ac41a] {\n  width: 340px;\n  margin: auto;\n}\n.lightmap section .generate[data-v-7f2ac41a],\n.lightmap section .clear[data-v-7f2ac41a] {\n  margin: 14px auto;\n}\n.lightmap section .progress[data-v-7f2ac41a] {\n  height: 6px;\n  margin: 10px 14px;\n  width: inherit;\n}\n.lightmap section .output[data-v-7f2ac41a] {\n  flex: 1;\n  min-height: 120px;\n  background-color: var(--color-normal-fill-emphasis);\n  overflow: auto;\n  margin: 0 14px 14px 14px;\n  padding: 7px 14px;\n  border-radius: 4px;\n}\n.lightmap section .output .label[data-v-7f2ac41a] {\n  width: 100px;\n  display: inline-block;\n}\n.lightmap section .output .data[data-v-7f2ac41a] {\n  display: inline-block;\n}\n.lightmap section .channels[data-v-7f2ac41a] {\n  min-height: 20px;\n  margin-top: 14px;\n  margin-bottom: 4px;\n  display: flex;\n  user-select: none;\n  justify-content: center;\n}\n.lightmap section .channels > ui-label[data-v-7f2ac41a] {\n  height: 20px;\n  width: 42px;\n  text-align: center;\n  line-height: 20px;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-normal-border);\n  background-color: var(--color-default-fill);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .channels > ui-label[data-v-7f2ac41a]:nth-child(2) {\n  margin-left: 5px;\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label[data-v-7f2ac41a]:nth-child(3) {\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label.select[data-v-7f2ac41a] {\n  background-color: var(--color-default-fill-emphasis);\n}\n.lightmap section .image-content[data-v-7f2ac41a] {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  min-height: 200px;\n  max-height: 300px;\n  overflow: auto;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-primary-contrast-weaker);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .image-content ui-image[data-v-7f2ac41a] {\n  width: 150px;\n  height: 150px;\n  min-height: 150px;\n  background-color: var(--color-normal-fill-emphasis);\n  margin-top: 5px;\n}\n",map:{version:3,sources:["App.vue"],names:[],mappings:"AAAA;EACE,aAAa;EACb,sBAAsB;EACtB,YAAY;AACd;AACA;EACE,gBAAgB;EAChB,kBAAkB;AACpB;AACA;EACE,OAAO;EACP,aAAa;EACb,gBAAgB;EAChB,sBAAsB;EACtB,YAAY;AACd;AACA;EACE,iBAAiB;AACnB;AACA;EACE,WAAW;AACb;AACA;EACE,WAAW;EACX,kBAAkB;AACpB;AACA;EACE,YAAY;EACZ,YAAY;AACd;AACA;;EAEE,iBAAiB;AACnB;AACA;EACE,WAAW;EACX,iBAAiB;EACjB,cAAc;AAChB;AACA;EACE,OAAO;EACP,iBAAiB;EACjB,mDAAmD;EACnD,cAAc;EACd,wBAAwB;EACxB,iBAAiB;EACjB,kBAAkB;AACpB;AACA;EACE,YAAY;EACZ,qBAAqB;AACvB;AACA;EACE,qBAAqB;AACvB;AACA;EACE,gBAAgB;EAChB,gBAAgB;EAChB,kBAAkB;EAClB,aAAa;EACb,iBAAiB;EACjB,uBAAuB;AACzB;AACA;EACE,YAAY;EACZ,WAAW;EACX,kBAAkB;EAClB,iBAAiB;EACjB,8EAA8E;EAC9E,2CAA2C;EAC3C,oDAAoD;AACtD;AACA;EACE,gBAAgB;EAChB,iBAAiB;AACnB;AACA;EACE,iBAAiB;AACnB;AACA;EACE,oDAAoD;AACtD;AACA;EACE,aAAa;EACb,sBAAsB;EACtB,mBAAmB;EACnB,iBAAiB;EACjB,iBAAiB;EACjB,cAAc;EACd,wFAAwF;EACxF,oDAAoD;AACtD;AACA;EACE,YAAY;EACZ,aAAa;EACb,iBAAiB;EACjB,mDAAmD;EACnD,eAAe;AACjB",file:"App.vue",sourcesContent:[".lightmap {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n}\n.lightmap > header {\n  margin-top: 14px;\n  text-align: center;\n}\n.lightmap section {\n  flex: 1;\n  display: flex;\n  overflow: hidden;\n  flex-direction: column;\n  height: 100%;\n}\n.lightmap section .properties {\n  padding: 8px 14px;\n}\n.lightmap section .properties ui-prop > div[slot='content'] {\n  width: 100%;\n}\n.lightmap section .properties ui-prop > div[slot='content'] > :first-child {\n  width: 100%;\n  margin-bottom: 5px;\n}\n.lightmap section .properties.result {\n  width: 340px;\n  margin: auto;\n}\n.lightmap section .generate,\n.lightmap section .clear {\n  margin: 14px auto;\n}\n.lightmap section .progress {\n  height: 6px;\n  margin: 10px 14px;\n  width: inherit;\n}\n.lightmap section .output {\n  flex: 1;\n  min-height: 120px;\n  background-color: var(--color-normal-fill-emphasis);\n  overflow: auto;\n  margin: 0 14px 14px 14px;\n  padding: 7px 14px;\n  border-radius: 4px;\n}\n.lightmap section .output .label {\n  width: 100px;\n  display: inline-block;\n}\n.lightmap section .output .data {\n  display: inline-block;\n}\n.lightmap section .channels {\n  min-height: 20px;\n  margin-top: 14px;\n  margin-bottom: 4px;\n  display: flex;\n  user-select: none;\n  justify-content: center;\n}\n.lightmap section .channels > ui-label {\n  height: 20px;\n  width: 42px;\n  text-align: center;\n  line-height: 20px;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-normal-border);\n  background-color: var(--color-default-fill);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .channels > ui-label:nth-child(2) {\n  margin-left: 5px;\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label:nth-child(3) {\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label.select {\n  background-color: var(--color-default-fill-emphasis);\n}\n.lightmap section .image-content {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  min-height: 200px;\n  max-height: 300px;\n  overflow: auto;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-primary-contrast-weaker);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .image-content ui-image {\n  width: 150px;\n  height: 150px;\n  min-height: 150px;\n  background-color: var(--color-normal-fill-emphasis);\n  margin-top: 5px;\n}\n"]},media:void 0})},__vue_scope_id__="data-v-7f2ac41a",__vue_module_identifier__=void 0,__vue_is_functional_template__=!1,__vue_component__=normalizeComponent_1({render:__vue_render__,staticRenderFns:__vue_staticRenderFns__},__vue_inject_styles__,__vue_script__,__vue_scope_id__,!1,void 0,!0,void 0,void 0,styleInjector);let $vm;async function applyLogsAndProgress(){const t=await Editor.Message.request("lightmap","unstaging");$vm.setLogs(t.logInfos),$vm.progress=t.progress}module.exports=Editor.Panel.define({template:'<div id="app"></div>',$:{app:"#app"},methods:{async start(){applyLogsAndProgress()},cancel(){},log(){applyLogsAndProgress()},progress(){applyLogsAndProgress()},finished(){applyLogsAndProgress()},async end(){applyLogsAndProgress(),$vm.progress=100,await $vm.onBakerEnd()}},async ready(){$vm=new __vue_component__({el:this.$.app});const t=await Editor.Profile.getConfig("lightmap","lightmap");if(t)for(const e in t)$vm.$data[e]=t[e]}});