"use strict";var fs=require("fs"),ps=require("path"),Vue=require("vue"),image=require("../image-91ee442d.js");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var fs__default=_interopDefaultLegacy(fs),Vue__default=_interopDefaultLegacy(Vue);Vue__default.default.config.productionTip=!1,Vue__default.default.config.devtools=!1;const Chroma=require("chroma-js");var Modes;!function(e){e[e.SCENE=0]="SCENE",e[e.BAKED=1]="BAKED"}(Modes||(Modes={}));var manager=Vue__default.default.extend({name:"App",data:()=>({mode:Modes.SCENE,progress:0,logInfos:[],picInfos:[],selectInfo:null,isGenerate:!1,msaa:4,path:"",size:1024,giScale:1,giSamples:25,giPathLength:2,aoLevel:1,aoStrength:1,aoRadius:1,aoColor:[136,136,136,255],tab:0,r:!0,g:!0,b:!0,a:!1,sceneUUID:""}),computed:{channel(){return(this.r?"r":"")+(this.g?"g":"")+(this.b?"b":"")+(this.a?"a":"")||void 0}},async mounted(){const e=await Editor.Message.request("lightmap","unstaging");e.isStart&&!e.isEnd&&(this.isGenerate=!0,this.progress=e.progress),this.setLogs(e.logInfos)},methods:{async onSceneReady(e){this.sceneUUID=e;const t=await image.Profile.getLatestLightmapResults(e);this.picInfos=(await Promise.all(t.map(e=>image.getImageInfo(e)))).filter(Boolean),this.$set(this.logInfos,"length",0),this.onItemClick(0)},changeColor(e){this.aoColor=e.target.value,this.saveEdit()},saveEdit(){Editor.Profile.setConfig("lightmap","lightmap",{msaa:this.msaa,size:this.size,giScale:this.giScale,giSamples:this.giSamples,giPathLength:this.giPathLength,aoLevel:this.aoLevel,aoStrength:this.aoStrength,aoRadius:this.aoRadius,aoColor:this.aoColor}),this.onItemClick(0)},t(e){const t=`lightmap.${e}`;return Editor.I18n.t(t)},clickTab(e,t){this[e]=t,"a"===e?t&&(this.r=this.g=this.b=!1):t&&(this.a=!1)},changeMode(e){this.mode=e},async onClear(){const e=await Editor.Message.request("lightmap","unstaging");this.sceneUUID=await Editor.Message.request("scene","query-current-scene");const t=e.currPath||await image.Profile.getLatestLightmapResultDir(this.sceneUUID);if(t&&!this.isGenerate){const e=delDir(t);await image.Profile.setLatestLightmapResults(this.sceneUUID,[]),this.selectInfo=null,this.picInfos=[],this.logInfos=[],e&&(await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"clear",args:[]}),await Editor.Message.request("lightmap","clear"),await Editor.Message.request("asset-db","refresh-asset","db://assets"))}},async onCancel(){this.isGenerate=!1,this.logInfos=[],await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"cancel",args:[]})},async onBakerEnd(){this.isGenerate=!1;const e=await Editor.Message.request("lightmap","unstaging");this.picInfos=await image.readImageList(ps.join(e.currPath,"output")),this.saveEdit()},pushLog(e){this.logInfos.push(e)},setLogs(e){this.logInfos=[];for(let t=0;t<e.length;t++)this.logInfos.push(e[t])},onItemClick(e){if(this.picInfos[e]){this.selectInfo={};for(const t in this.picInfos[e])"path"!==t&&"uuid"!==t&&(this.selectInfo[t]=this.picInfos[e][t])}else this.selectInfo=null},async onConfirm(){let e;this.r=this.g=this.b=!0,this.progress=0,this.logInfos=[];const t=await image.Profile.getLatestLightmapResultDir(this.sceneUUID);t&&(e=ps.join(t,"../"));const n=await Editor.Dialog.select({type:"directory",title:this.t("title"),path:e||ps.join(Editor.Project.path,"assets"),multi:!1,filters:[{name:"Lightmap",extensions:["png"]}]});let a=n.filePaths?n.filePaths[0]:[];if(Array.isArray(a)&&(a=a[0]),!a)return!1;a=`${a}/LightFX`,this.path=a,await new Promise(e=>{setTimeout(e,500)}),await Editor.Message.request("lightmap","savePicPath",a),fs__default.default.existsSync(a)&&(delDir(a),await Editor.Message.request("asset-db","refresh-asset",a)),this.logInfos.push(this.t("start")+"\n"),this.isGenerate=!0;try{await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"apply",args:[this.$data,Editor.App.path]})}catch(e){console.error(e),await this.onCancel(),this.logInfos.push(this.t("fail")+"\n")}Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"bakingSystem",value:{A100003:1}})}}});function delDir(e,t=!1){let n=[],a=!1;return fs__default.default.existsSync(e)&&(n=fs__default.default.readdirSync(e)).forEach((t,n)=>{const i=e+"/"+t;if(!t.endsWith(".meta"))if(fs__default.default.statSync(i).isDirectory()){const e=delDir(i,!0);a||(a=e)}else fs__default.default.unlinkSync(i),a=!0}),a}function normalizeComponent(e,t,n,a,i,s,o,l,r,c){"boolean"!=typeof o&&(r=l,l=o,o=!1);const p="function"==typeof n?n.options:n;let u;if(e&&e.render&&(p.render=e.render,p.staticRenderFns=e.staticRenderFns,p._compiled=!0,i&&(p.functional=!0)),a&&(p._scopeId=a),s?(u=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,r(e)),e&&e._registeredComponents&&e._registeredComponents.add(s)},p._ssrRegister=u):t&&(u=o?function(e){const n=this.$root.$el&&this.$root.$el.parentNode||this.$root.$options.el&&this.$root.$options.el.parentNode;t.call(this,c(e,n))}:function(e){t.call(this,l(e))}),u)if(p.functional){const e=p.render;p.render=function(t,n){return u.call(n),e(t,n)}}else{const e=p.beforeCreate;p.beforeCreate=e?[].concat(e,u):[u]}return n}var normalizeComponent_1=normalizeComponent;const styles={},isOldIE="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());var styleInjector=function(e,t){return function(e,n){const a=isOldIE?n.media||"default":e,i=styles[a]||(styles[a]={ids:new Set,styles:[]});if(!i.ids.has(e)){i.ids.add(e);let a=n.source;if(n.map&&(a+="\n/*# sourceURL="+n.map.sources[0]+" */",a+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n.map))))+" */"),i.element||(i.element=document.createElement("style"),i.element.type="text/css",n.media&&i.element.setAttribute("media",n.media),void 0===t&&(t=document.shadowRoot||document.getElementsByTagName("shadowRoot")[0]),t.appendChild(i.element)),"styleSheet"in i.element)i.styles.push(a),i.element.styleSheet.cssText=i.styles.filter(Boolean).join("\n");else{const e=i.ids.size-1,t=document.createTextNode(a),n=i.element.childNodes;n[e]&&i.element.removeChild(n[e]),n.length?i.element.insertBefore(t,n[e]):i.element.appendChild(t)}}}};const __vue_script__=manager;var __vue_render__=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"lightmap"},[n("header",[n("ui-tab",{staticClass:"button_tab",attrs:{value:e.mode},on:{confirm:function(t){return e.changeMode(t.target.value)}}},[n("ui-button",[e._v("Scene")]),e._v(" "),n("ui-button",[e._v("Baked")])],1)],1),e._v(" "),n("section",{directives:[{name:"show",rawName:"v-show",value:0===e.mode,expression:"mode === 0"}]},[n("div",{staticClass:"properties"},[n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"MSAA"},slot:"label"}),e._v(" "),n("ui-select",{attrs:{slot:"content",value:e.msaa},on:{confirm:function(t){t.stopPropagation(),e.msaa=t.target.value,e.saveEdit()}},slot:"content"},[n("option",{attrs:{value:"1"}},[e._v("\n                        1\n                    ")]),e._v(" "),n("option",{attrs:{value:"2"}},[e._v("\n                        2\n                    ")]),e._v(" "),n("option",{attrs:{value:"4"}},[e._v("\n                        4\n                    ")]),e._v(" "),n("option",{attrs:{value:"8"}},[e._v("\n                        8\n                    ")])])],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"Resolution"},slot:"label"}),e._v(" "),n("ui-select",{attrs:{slot:"content",value:e.size},on:{confirm:function(t){t.stopPropagation(),e.size=t.target.value,e.saveEdit()}},slot:"content"},[n("option",{attrs:{value:"128"}},[e._v("\n                        128\n                    ")]),e._v(" "),n("option",{attrs:{value:"256"}},[e._v("\n                        256\n                    ")]),e._v(" "),n("option",{attrs:{value:"512"}},[e._v("\n                        512\n                    ")]),e._v(" "),n("option",{attrs:{value:"1024"}},[e._v("\n                        1024\n                    ")]),e._v(" "),n("option",{attrs:{value:"2048"}},[e._v("\n                        2048\n                    ")])])],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"GIScale"},slot:"label"}),e._v(" "),n("ui-num-input",{attrs:{slot:"content",value:e.giScale,state:"",preci:"2",step:"0.1"},on:{change:function(t){e.giScale=t.target.value,e.saveEdit()}},slot:"content"})],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"GISamples"},slot:"label"}),e._v(" "),n("ui-num-input",{attrs:{slot:"content",value:e.giSamples},on:{change:function(t){e.giSamples=t.target.value,e.saveEdit()}},slot:"content"})],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"Bounces"},slot:"label"}),e._v(" "),n("ui-select",{attrs:{slot:"content",value:e.giPathLength},on:{confirm:function(t){t.stopPropagation(),e.giPathLength=t.target.value,e.saveEdit()}},slot:"content"},[n("option",{attrs:{value:"1"}},[e._v("\n                        1\n                    ")]),e._v(" "),n("option",{attrs:{value:"2"}},[e._v("\n                        2\n                    ")]),e._v(" "),n("option",{attrs:{value:"3"}},[e._v("\n                        3\n                    ")]),e._v(" "),n("option",{attrs:{value:"4"}},[e._v("\n                        4\n                    ")])])],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOLevel"},slot:"label"}),e._v(" "),n("ui-select",{attrs:{slot:"content",value:e.aoLevel},on:{confirm:function(t){t.stopPropagation(),e.aoLevel=t.target.value,e.saveEdit()}},slot:"content"},[n("option",{attrs:{value:"0"}},[e._v("\n                        0\n                    ")]),e._v(" "),n("option",{attrs:{value:"1"}},[e._v("\n                        1\n                    ")]),e._v(" "),n("option",{attrs:{value:"2"}},[e._v("\n                        2\n                    ")])])],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOStrength"},slot:"label"}),e._v(" "),n("ui-num-input",{attrs:{slot:"content",value:e.aoStrength,state:"",preci:"2",step:"0.1"},on:{change:function(t){e.aoStrength=t.target.value,e.saveEdit()}},slot:"content"})],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AORadius"},slot:"label"}),e._v(" "),n("ui-num-input",{attrs:{slot:"content",value:e.aoRadius,state:"",preci:"2",step:"0.1"},on:{change:function(t){e.aoRadius=t.target.value,e.saveEdit()}},slot:"content"})],1),e._v(" "),n("ui-prop",[n("ui-label",{attrs:{slot:"label",value:"AOColor"},slot:"label"}),e._v(" "),n("ui-color",{attrs:{slot:"content",value:JSON.stringify(e.aoColor)},on:{confirm:function(t){return t.stopPropagation(),e.changeColor(t)}},slot:"content"})],1)],1),e._v(" "),n("ui-button",{staticClass:"generate",class:e.isGenerate?"red":"blue",on:{click:function(t){e.isGenerate?e.onCancel():e.onConfirm()}}},[n("ui-label",{attrs:{value:e.isGenerate?"i18n:lightmap.cancel":"i18n:lightmap.generate"}})],1),e._v(" "),n("ui-progress",{directives:[{name:"show",rawName:"v-show",value:e.isGenerate,expression:"isGenerate"}],staticClass:"progress",attrs:{value:e.progress}}),e._v(" "),n("div",{staticClass:"output"},e._l(e.logInfos,function(t,a){return n("div",{key:a},[n("div",[e._v(e._s(t))])])}),0)],1),e._v(" "),n("section",{directives:[{name:"show",rawName:"v-show",value:1===e.mode,expression:"mode === 1"}]},[n("div",{staticClass:"properties result"},[n("ui-label",{attrs:{value:"i18n:lightmap.bakedResult"}}),e._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:e.picInfos.length>0,expression:"picInfos.length > 0"}],staticClass:"channels"},[n("ui-label",{class:{select:e.r},on:{click:function(t){return e.clickTab("r",!e.r)}}},[e._v("\n                    R\n                ")]),e._v(" "),n("ui-label",{class:{select:e.g},on:{click:function(t){return e.clickTab("g",!e.g)}}},[e._v("\n                    G\n                ")]),e._v(" "),n("ui-label",{class:{select:e.b},on:{click:function(t){return e.clickTab("b",!e.b)}}},[e._v("\n                    B\n                ")]),e._v(" "),n("ui-label",{class:{select:e.a},on:{click:function(t){return e.clickTab("a",!e.a)}}},[e._v("\n                    A\n                ")])],1),e._v(" "),n("div",{staticClass:"image-content"},e._l(e.picInfos,function(t,a){return n("ui-image",{key:a,ref:"images",refInFor:!0,attrs:{"show-alpha":"",channel:e.channel,value:t.path+"?"+t.birthtime},on:{click:function(t){return e.onItemClick(a)}}})}),1)],1),e._v(" "),n("ui-button",{staticClass:"blue clear",on:{click:function(t){return e.onClear()}}},[n("ui-label",{attrs:{value:"i18n:lightmap.clear"}})],1),e._v(" "),n("div",{staticClass:"output"},e._l(e.selectInfo,function(t,a){return n("div",{key:a},[n("ui-label",{staticClass:"label",attrs:{value:"i18n:lightmap."+a}}),e._v(" "),n("ui-label",{staticClass:"data",attrs:{value:t}})],1)}),0)],1)])},__vue_staticRenderFns__=[];__vue_render__._withStripped=!0;const __vue_inject_styles__=function(e){e&&e("data-v-1ca1fd9b_0",{source:".lightmap[data-v-1ca1fd9b] {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  overflow: auto;\n}\n.lightmap > header[data-v-1ca1fd9b] {\n  margin-top: 8px;\n  text-align: center;\n}\n.lightmap section[data-v-1ca1fd9b] {\n  flex: 1;\n  display: flex;\n  overflow: hidden;\n  flex-direction: column;\n  height: 100%;\n  min-height: 560px;\n}\n.lightmap section .properties[data-v-1ca1fd9b] {\n  padding: 8px;\n}\n.lightmap section .properties ui-prop[data-v-1ca1fd9b] {\n  margin-bottom: 6px;\n}\n.lightmap section .properties.result[data-v-1ca1fd9b] {\n  width: 340px;\n  margin: auto;\n}\n.lightmap section .generate[data-v-1ca1fd9b],\n.lightmap section .clear[data-v-1ca1fd9b] {\n  margin: 14px auto;\n  min-width: 200px;\n}\n.lightmap section .progress[data-v-1ca1fd9b] {\n  height: 6px;\n  margin: 10px 14px;\n  width: inherit;\n}\n.lightmap section .output[data-v-1ca1fd9b] {\n  flex: 1;\n  min-height: 120px;\n  background-color: var(--color-normal-fill-emphasis);\n  overflow: auto;\n  margin: 0 14px 14px 14px;\n  padding: 7px 14px;\n  border-radius: 4px;\n}\n.lightmap section .output .label[data-v-1ca1fd9b] {\n  width: 100px;\n  display: inline-block;\n}\n.lightmap section .output .data[data-v-1ca1fd9b] {\n  display: inline-block;\n}\n.lightmap section .channels[data-v-1ca1fd9b] {\n  min-height: 20px;\n  margin-top: 14px;\n  margin-bottom: 4px;\n  display: flex;\n  user-select: none;\n  justify-content: center;\n}\n.lightmap section .channels > ui-label[data-v-1ca1fd9b] {\n  height: 20px;\n  width: 42px;\n  text-align: center;\n  line-height: 20px;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-normal-border);\n  background-color: var(--color-default-fill);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .channels > ui-label[data-v-1ca1fd9b]:nth-child(2) {\n  margin-left: 5px;\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label[data-v-1ca1fd9b]:nth-child(3) {\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label.select[data-v-1ca1fd9b] {\n  background-color: var(--color-default-fill-emphasis);\n}\n.lightmap section .image-content[data-v-1ca1fd9b] {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  height: 200px;\n  overflow: auto;\n}\n.lightmap section .image-content ui-image[data-v-1ca1fd9b] {\n  width: 200px;\n  height: 200px;\n  background-color: var(--color-normal-fill-emphasis);\n}\n",map:{version:3,sources:["App.vue"],names:[],mappings:"AAAA;EACE,aAAa;EACb,sBAAsB;EACtB,YAAY;EACZ,cAAc;AAChB;AACA;EACE,eAAe;EACf,kBAAkB;AACpB;AACA;EACE,OAAO;EACP,aAAa;EACb,gBAAgB;EAChB,sBAAsB;EACtB,YAAY;EACZ,iBAAiB;AACnB;AACA;EACE,YAAY;AACd;AACA;EACE,kBAAkB;AACpB;AACA;EACE,YAAY;EACZ,YAAY;AACd;AACA;;EAEE,iBAAiB;EACjB,gBAAgB;AAClB;AACA;EACE,WAAW;EACX,iBAAiB;EACjB,cAAc;AAChB;AACA;EACE,OAAO;EACP,iBAAiB;EACjB,mDAAmD;EACnD,cAAc;EACd,wBAAwB;EACxB,iBAAiB;EACjB,kBAAkB;AACpB;AACA;EACE,YAAY;EACZ,qBAAqB;AACvB;AACA;EACE,qBAAqB;AACvB;AACA;EACE,gBAAgB;EAChB,gBAAgB;EAChB,kBAAkB;EAClB,aAAa;EACb,iBAAiB;EACjB,uBAAuB;AACzB;AACA;EACE,YAAY;EACZ,WAAW;EACX,kBAAkB;EAClB,iBAAiB;EACjB,8EAA8E;EAC9E,2CAA2C;EAC3C,oDAAoD;AACtD;AACA;EACE,gBAAgB;EAChB,iBAAiB;AACnB;AACA;EACE,iBAAiB;AACnB;AACA;EACE,oDAAoD;AACtD;AACA;EACE,aAAa;EACb,sBAAsB;EACtB,mBAAmB;EACnB,aAAa;EACb,cAAc;AAChB;AACA;EACE,YAAY;EACZ,aAAa;EACb,mDAAmD;AACrD",file:"App.vue",sourcesContent:[".lightmap {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  overflow: auto;\n}\n.lightmap > header {\n  margin-top: 8px;\n  text-align: center;\n}\n.lightmap section {\n  flex: 1;\n  display: flex;\n  overflow: hidden;\n  flex-direction: column;\n  height: 100%;\n  min-height: 560px;\n}\n.lightmap section .properties {\n  padding: 8px;\n}\n.lightmap section .properties ui-prop {\n  margin-bottom: 6px;\n}\n.lightmap section .properties.result {\n  width: 340px;\n  margin: auto;\n}\n.lightmap section .generate,\n.lightmap section .clear {\n  margin: 14px auto;\n  min-width: 200px;\n}\n.lightmap section .progress {\n  height: 6px;\n  margin: 10px 14px;\n  width: inherit;\n}\n.lightmap section .output {\n  flex: 1;\n  min-height: 120px;\n  background-color: var(--color-normal-fill-emphasis);\n  overflow: auto;\n  margin: 0 14px 14px 14px;\n  padding: 7px 14px;\n  border-radius: 4px;\n}\n.lightmap section .output .label {\n  width: 100px;\n  display: inline-block;\n}\n.lightmap section .output .data {\n  display: inline-block;\n}\n.lightmap section .channels {\n  min-height: 20px;\n  margin-top: 14px;\n  margin-bottom: 4px;\n  display: flex;\n  user-select: none;\n  justify-content: center;\n}\n.lightmap section .channels > ui-label {\n  height: 20px;\n  width: 42px;\n  text-align: center;\n  line-height: 20px;\n  border: calc(var(--size-normal-border) * 1px) solid var(--color-normal-border);\n  background-color: var(--color-default-fill);\n  border-radius: calc(var(--size-normal-radius) * 1px);\n}\n.lightmap section .channels > ui-label:nth-child(2) {\n  margin-left: 5px;\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label:nth-child(3) {\n  margin-right: 5px;\n}\n.lightmap section .channels > ui-label.select {\n  background-color: var(--color-default-fill-emphasis);\n}\n.lightmap section .image-content {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  height: 200px;\n  overflow: auto;\n}\n.lightmap section .image-content ui-image {\n  width: 200px;\n  height: 200px;\n  background-color: var(--color-normal-fill-emphasis);\n}\n"]},media:void 0})},__vue_scope_id__="data-v-1ca1fd9b",__vue_module_identifier__=void 0,__vue_is_functional_template__=!1,__vue_component__=normalizeComponent_1({render:__vue_render__,staticRenderFns:__vue_staticRenderFns__},__vue_inject_styles__,__vue_script__,__vue_scope_id__,!1,void 0,!0,void 0,void 0,styleInjector);let $vm;async function applyLogsAndProgress(){const e=await Editor.Message.request("lightmap","unstaging");$vm.setLogs(e.logInfos),$vm.progress=e.progress}module.exports=Editor.Panel.define({template:'<div id="app"></div>',$:{app:"#app"},methods:{async start(){applyLogsAndProgress()},cancel(){},log(){applyLogsAndProgress()},progress(){applyLogsAndProgress()},finished(){applyLogsAndProgress()},async end(){applyLogsAndProgress(),$vm.progress=100,await $vm.onBakerEnd()},onSceneReady(e){$vm.onSceneReady(e)}},async ready(){const e=await Editor.Message.request("scene","query-current-scene");($vm=new __vue_component__({el:this.$.app})).onSceneReady(e);const t=await Editor.Message.request("lightmap","getConfig");if(t)for(const e in t)$vm.$data[e]=t[e]}});