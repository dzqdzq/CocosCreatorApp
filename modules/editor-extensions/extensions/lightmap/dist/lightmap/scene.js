{const{join:t}=require("path"),e=t(Editor.App.path,"node_modules");module.paths.push(e)}Object.defineProperty(exports,"__esModule",{value:!0});var fs$1=require("fs"),ps=require("path"),image=require("../image-47066dad.js"),cc=require("cc"),exec=require("child_process"),EventEmitter=require("events"),fe=require("fs-extra");function _interopDefaultLegacy(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var fs__default=_interopDefaultLegacy(fs$1),ps__default=_interopDefaultLegacy(ps),cc__default=_interopDefaultLegacy(cc),exec__default=_interopDefaultLegacy(exec),EventEmitter__default=_interopDefaultLegacy(EventEmitter),fe__default=_interopDefaultLegacy(fe);class LFX_Settings{constructor(){this.MSAA=4,this.Size=1024,this.Gamma=2.2,this.SkyRadiance=[0,0,0],this.GIScale=.5,this.GISamples=25,this.GIPathLength=4,this.AOLevel=0,this.AOStrength=.5,this.AORadius=1,this.AOColor=[.5,.5,.5],this.Threads=1}}class LFX_Vertex{constructor(){this.Position=[0,0,0],this.Normal=[0,0,0],this.UV=[0,0],this.LUV=[0,0]}}class LFX_Triangle{constructor(){this.Index=[0,0,0],this.MaterialId=0}}class LFX_Material{constructor(){this.Diffuse=[1,1,1],this.Texture=""}}class LFX_Mesh{constructor(){this.CastShadow=!1,this.ReceiveShadow=!1,this.LightMapSize=0,this.VertexBuffer=new Array,this.TriangleBuffer=new Array,this.MaterialBuffer=new Array}}class LFX_Terrain{constructor(){this.Position=[0,0,0],this.TileSize=0,this.BlockCount=[0,0],this.HeightField=new Uint16Array,this.LightMapSize=0}}class LFX_Light{constructor(){this.Type=LFX_Light.POINT,this.Position=[0,0,0],this.Direction=[0,0,0],this.Color=[0,0,0],this.Illuminance=1,this.Size=0,this.Range=0,this.AttenFallOff=1,this.SpotInner=1,this.SpotOuter=.7071,this.SpotFallOff=1,this.DirectScale=1,this.IndirectScale=1,this.GIEnable=!1,this.CastShadow=!1}}LFX_Light.POINT=0,LFX_Light.SPOT=1,LFX_Light.DIRECTION=2;class LFX_Buffer{constructor(){this.Length=0,this.Buffer=new Uint8Array(2048),this._dview=new DataView(this.Buffer.buffer),this._seekPos=0}Reserve(t){if(this.Buffer.byteLength>t)return;let e=this.Buffer.byteLength;for(;e<t;)e+=e;const s=new Uint8Array(e);for(let t=0;t<this.Length;++t)s[t]=this.Buffer[t];this.Buffer=s,this._dview=new DataView(this.Buffer.buffer)}Assign(t){this.Buffer=t,this.Length=t.length,this._seekPos=t.byteOffset,this._dview=new DataView(t.buffer)}WriteInt8(t){this.Reserve(this.Length+1),this._dview.setInt8(this.Length,t),this.Length+=1}WriteInt16(t){this.Reserve(this.Length+2),this._dview.setInt16(this.Length,t,!0),this.Length+=2}WriteInt32(t){this.Reserve(this.Length+4),this._dview.setInt32(this.Length,t,!0),this.Length+=4}WriteHeightField(t){this.Reserve(this.Length+2*t.length);for(let e=0;e<t.length;++e)this._dview.setUint16(this.Length+2*e,t[e],!0);this.Length+=2*t.length}WriteIntArray(t){this.Reserve(this.Length+4*t.length);for(let e=0;e<t.length;++e)this._dview.setInt32(this.Length+4*e,t[e],!0);this.Length+=4*t.length}WriteFloat(t){this.Reserve(this.Length+4),this._dview.setFloat32(this.Length,t,!0),this.Length+=4}WriteFloatArray(t){this.Reserve(this.Length+4*t.length);for(let e=0;e<t.length;++e)this._dview.setFloat32(this.Length+4*e,t[e],!0);this.Length+=4*t.length}WriteString(t){this.Reserve(this.Length+t.length+4),this._dview.setInt32(this.Length,t.length,!0);for(let e=0;e<t.length;++e)this._dview.setInt8(this.Length+4+e,t.charCodeAt(e));this.Length+=t.length+4}ReadInt8(){const t=this._dview.getInt8(this._seekPos);return this._seekPos+=1,t}ReadInt16(){const t=this._dview.getInt16(this._seekPos,!0);return this._seekPos+=2,t}ReadInt(){const t=this._dview.getInt32(this._seekPos,!0);return this._seekPos+=4,t}ReadIntArray(t){for(let e=0;e<t.length;++e)t[e]=this._dview.getInt32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t}ReadFloat(){const t=this._dview.getFloat32(this._seekPos,!0);return this._seekPos+=4,t}ReadFloatArray(t){for(let e=0;e<t.length;++e)t[e]=this._dview.getFloat32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t}ReadString(){const t=this.ReadInt();let e="";for(let s=0;s<t;++s)e+=String.fromCharCode(this.ReadInt8());return e}}class LFX_World{constructor(){this.Name="",this.Settings=new LFX_Settings,this.Textures=new Array,this.Terrains=new Array,this.Meshes=new Array,this.Lights=new Array}AddUniqueTexture(t){if(t.length>0){for(const e of this.Textures)if(e===t)return t;this.Textures.push(t)}return t}}class LFX_TerrainLightMapInfo{constructor(){this.Id=0,this.BlockId=0,this.Index=0,this.Offset=[0,0],this.Scale=[0,0]}}class LFX_MeshLightMapInfo{constructor(){this.Id=0,this.Index=0,this.Offset=[0,0],this.Scale=[0,0]}}class LFX_File{constructor(){this.Verison=0,this.MeshInfos=new Array,this.TerrainInfos=new Array}}const io=require("socket.io"),LFX_FILE_VERSION=8192,LFX_FILE_TERRAIN=1,LFX_FILE_MESH=2,LFX_FILE_LIGHT=3,LFX_FILE_EOF=0;class LFX_Baker extends EventEmitter__default.default{constructor(){super(),this.World=new LFX_World,this.Started=!1,this.Finished=!1,this.Error=!1,this._server=null,this._client=null,this._path=null,this._lfxpath=null,LFX_Baker.Instance=this}get lfxpath(){return this._lfxpath||ps__default.default.resolve("tools/lightmap-tools")}set lfxpath(t){this._lfxpath=t}get closed(){return null==this._server}get connected(){return null!=this._client}get client(){return this._client}Launch(t=0){return this.Started=!1,this.Finished=!1,this.Error=!1,this._server=io.listen(t),this._server.on("connection",t=>{t.on("Login",e=>{this._client=t,this.emit("login",this._client)}),t.on("Log",t=>{this.emit("log",t)}),t.on("Progress",t=>{this.emit("progress",t)}),t.on("Finished",t=>{this.Finished=!0,this.emit("fineshed",t)})}),t}Close(){null!=this._server&&this._server.close(),this._server=null,this._client=null}Upload(t){this._path=t;const e=new LFX_Buffer,s=t+"/tmp";fs__default.default.existsSync(s)||fs__default.default.mkdirSync(s),e.WriteInt32(LFX_FILE_VERSION),e.WriteString(this.World.Name);e.WriteFloatArray([0,0,0]),e.WriteFloatArray(this.World.Settings.SkyRadiance),e.WriteInt32(this.World.Settings.MSAA),e.WriteInt32(this.World.Settings.Size),e.WriteFloat(this.World.Settings.Gamma),e.WriteFloat(this.World.Settings.GIScale),e.WriteInt32(this.World.Settings.GISamples),e.WriteInt32(this.World.Settings.GIPathLength),e.WriteInt32(this.World.Settings.AOLevel),e.WriteFloat(this.World.Settings.AOStrength),e.WriteFloat(this.World.Settings.AORadius),e.WriteFloatArray(this.World.Settings.AOColor),e.WriteInt32(this.World.Settings.Threads);for(const t of this.World.Terrains)e.WriteInt32(LFX_FILE_TERRAIN),e.WriteFloatArray(t.Position),e.WriteFloat(t.TileSize),e.WriteIntArray(t.BlockCount),e.WriteInt32(t.LightMapSize),e.WriteHeightField(t.HeightField);for(const t of this.World.Meshes){e.WriteInt32(LFX_FILE_MESH),e.WriteInt8(t.CastShadow?1:0),e.WriteInt8(t.ReceiveShadow?1:0),e.WriteInt32(t.LightMapSize),e.WriteInt32(t.VertexBuffer.length),e.WriteInt32(t.TriangleBuffer.length),e.WriteInt32(t.MaterialBuffer.length);for(const s of t.VertexBuffer)e.WriteFloatArray(s.Position),e.WriteFloatArray(s.Normal),e.WriteFloatArray(s.UV),e.WriteFloatArray(s.LUV);for(const s of t.TriangleBuffer)e.WriteIntArray(s.Index),e.WriteInt32(s.MaterialId);for(const s of t.MaterialBuffer)e.WriteFloatArray(s.Diffuse),e.WriteString(s.Texture)}for(const t of this.World.Lights)e.WriteInt32(LFX_FILE_LIGHT),e.WriteInt32(t.Type),e.WriteFloatArray(t.Position),e.WriteFloatArray(t.Direction),e.WriteFloatArray(t.Color),e.WriteFloat(t.Size),e.WriteFloat(t.Range),e.WriteFloat(t.AttenFallOff),e.WriteFloat(t.SpotInner),e.WriteFloat(t.SpotOuter),e.WriteFloat(t.SpotFallOff),e.WriteFloat(t.DirectScale),e.WriteFloat(t.IndirectScale),e.WriteInt8(t.GIEnable?1:0),e.WriteInt8(t.CastShadow?1:0);e.WriteInt32(LFX_FILE_EOF),fs__default.default.writeFileSync(s+"/lfx.i",e.Buffer);for(const e of this.World.Textures){const i=fs__default.default.readFileSync(t+"/"+e),r=e.replace("/","$");fs__default.default.writeFileSync(s+"/"+r,i)}}Download(){const t=new LFX_File,e=this._path+"/output/lfx.o",s=fs__default.default.readFileSync(e);if(null!=s){const e=new LFX_Buffer;for(e.Assign(s),t.Verison=e.ReadInt();;){const s=e.ReadInt();if(s===LFX_FILE_EOF)break;if(s===LFX_FILE_TERRAIN){const s=e.ReadInt(),i=e.ReadInt();for(let r=0;r<i;++r){const i=new LFX_TerrainLightMapInfo;i.Id=s,i.BlockId=e.ReadInt(),i.Index=e.ReadInt(),i.Offset[0]=e.ReadFloat(),i.Offset[1]=e.ReadFloat(),i.Scale[0]=e.ReadFloat(),i.Scale[1]=e.ReadFloat(),t.TerrainInfos.push(i)}}else if(s===LFX_FILE_MESH){const s=e.ReadInt();for(let i=0;i<s;++i){const s=new LFX_MeshLightMapInfo;s.Id=e.ReadInt(),s.Index=e.ReadInt(),s.Offset[0]=e.ReadFloat(),s.Offset[1]=e.ReadFloat(),s.Scale[0]=e.ReadFloat(),s.Scale[1]=e.ReadFloat(),t.MeshInfos.push(s)}}else console.log("LightFX unknown chunk "+s)}}return t}Start(){this._client&&this._client.emit("Start"),this.Started=!0}Stop(){this._client&&this._client.emit("Stop")}}var NodeEventType,NodeOperationType,EventSourceType;!function(t){t.TRANSFORM_CHANGED="transform-changed",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.CHILD_CHANGED="child-changed",t.COMPONENT_CHANGED="component-changed",t.ACTIVE_IN_HIERARCHY_CHANGE="active-in-hierarchy-changed",t.PREFAB_INFO_CHANGED="prefab-info-changed"}(NodeEventType||(NodeEventType={})),function(t){t.SET_PROPERTY="set-property",t.MOVE_ARRAY_ELEMENT="move-array-element",t.REMOVE_ARRAY_ELEMENT="remove-array-element",t.CREATE_COMPONENT="create-component",t.RESET_COMPONENT="reset-component"}(NodeOperationType||(NodeOperationType={})),function(t){t.EDITOR="editor",t.UNDO="undo",t.ENGINE="engine"}(EventSourceType||(EventSourceType={}));const fs=require("fs"),os=require("os"),net=require("net"),path=require("path"),_async=require("async"),debug=require("debug"),mkdirp=require("mkdirp").mkdirp,debugTestPort=debug("portfinder:testPort"),debugGetPort=debug("portfinder:getPort"),debugDefaultHosts=debug("portfinder:defaultHosts"),internals={testPort:function(t,e){function s(){debugTestPort("done w/ testPort(): OK",t.host,"port",t.port),t.server.removeListener("error",i),t.server.close(),e(null,t.port)}function i(i){if(debugTestPort("done w/ testPort(): failed",t.host,"w/ port",t.port,"with error",i.code),t.server.removeListener("listening",s),"EADDRINUSE"!=i.code&&"EACCES"!=i.code)return e(i);const r=nextPort(t.port);if(r>highestPort)return e(new Error("No open ports available"));internals.testPort({port:r,host:t.host,server:t.server},e)}e||(e=t,t={}),t.server=t.server||net.createServer(function(){}),debugTestPort("entered testPort(): trying",t.host,"port",t.port),t.server.once("error",i),t.server.once("listening",s),t.host?t.server.listen(t.port,t.host):t.server.listen(t.port)}},basePort=8e3,highestPort=65535;function getPort(t,e){if(e||(e=t,t={}),t.port=Number(t.port)||Number(basePort),t.host=t.host||null,t.stopPort=Number(t.stopPort)||Number(highestPort),!t.startPort){if(t.startPort=Number(t.port),t.startPort<0)throw Error("Provided options.startPort("+t.startPort+") is less than 0, which are cannot be bound.");if(t.stopPort<t.startPort)throw Error("Provided options.stopPort("+t.stopPort+"is less than options.startPort ("+t.startPort+")")}if(t.host){let e;for(let s=0;s<_defaultHosts.length;s++)if(_defaultHosts[s]===t.host){e=!0;break}e||_defaultHosts.push(t.host)}const s=[];let i;return _async.eachSeries(_defaultHosts,function(e,r){return debugGetPort("in eachSeries() iteration callback: host is",e),internals.testPort({host:e,port:t.port},function(t,n){return t?(debugGetPort("in eachSeries() iteration callback testPort() callback","with an err:",t.code),i=e,r(t)):(debugGetPort("in eachSeries() iteration callback testPort() callback","with a success for port",n),s.push(n),r())})},function(r){if(r){if(debugGetPort("in eachSeries() result callback: err is",r),"EADDRNOTAVAIL"===r.code||"EINVAL"===r.code){if(t.host===i){const s="Provided host "+t.host+" could NOT be bound. Please provide a different host address or hostname";return e(Error(s))}{const s=_defaultHosts.indexOf(i);return _defaultHosts.splice(s,1),getPort(t,e)}}return e(r)}if(s.sort(function(t,e){return t-e}),debugGetPort("in eachSeries() result callback: openPorts is",s),s[0]===s[s.length-1]){if(s[0]<=t.stopPort)return e(null,s[0]);{const s="No open ports found in between "+t.startPort+" and "+t.stopPort;return e(Error(s))}}return getPort({port:s.pop(),host:t.host,startPort:t.startPort,stopPort:t.stopPort},e)})}function nextPort(t){return t+1}const _defaultHosts=function(){let t={};try{t=os.networkInterfaces()}catch(t){if(!t||"uv_interface_addresses"!==t.syscall)throw t}const e=Object.keys(t),s=["0.0.0.0"];for(let i=0;i<e.length;i++){const r=t[e[i]];for(let t=0;t<r.length;t++){const e=r[t];s.push(e.address)}}return s.push(null),debugDefaultHosts("exports._defaultHosts is: %o",s),s}(),nodeMgr=cce.Node;function clamp(t,e,s){if(e>s){const t=e;e=s,s=t}return t<e?e:t>s?s:t}let filesList;async function readImageList(t,e=!1,s){e||(filesList={});const i=fs__default.default.readdirSync(t);return await Editor.Message.request("asset-db","refresh-asset",t),await Promise.all(i.map(async e=>{const s=ps.join(t,e),i=fs__default.default.statSync(s);if(i.isDirectory())await readImageList(s,!0);else if(e.endsWith(".png")){const r=await Editor.Message.request("asset-db","query-url",s);let n=null;r&&(n=await Editor.Message.request("asset-db","query-uuid",r));const o=s+".meta";if(fs$1.existsSync(o))try{const t=fe__default.default.readJSONSync(o),e=t.userData;t.userData||(t.userData={}),e.fixAlphaTransparencyArtifacts=!1,fe__default.default.writeJsonSync(o,t,{encoding:"utf8",spaces:2}),await Editor.Message.request("asset-db","refresh-asset",s)}catch(t){console.error("change meta failed",s),console.error(t)}const a={path:t,filename:e,size:image.formatBytes(i.size),uuid:n};filesList[a.filename]=a,await new Promise((t,e)=>{cc.assetManager.loadAny(a.uuid+"@6c48a",(s,i)=>{s?e(s):(a.texture=i,t())})})}})),s&&s(filesList),filesList}class LFX_App{constructor(){this.Baker=new LFX_Baker,this.Scene=null,this.Models=[],this.Lights=[],this.Terrains=[],this.MainCamera=null,this._currentTicks=0,this._lastTicks=0,this._uploadPath="",this._process=null,this._timer=null}static Reset(t){const e=t.getComponent(cc.Terrain);if(null!=e&&e.enabled)for(let t=0;t<e.getBlocks().length;++t)e._updateLightmap(t,null,0,0,0,0);const s=t.getComponents(cc.MeshRenderer);for(const t of s)if(t._updateLightmap(null,0,0,0,0),t.node){const e=t.node.components.indexOf(t);nodeMgr.emit("change",t.node,{type:NodeOperationType.SET_PROPERTY,propPath:`__comps__.${e}.lightmapSettings`})}const i=t.getComponents(cc.Light);for(const t of i)t.baked=!1;for(const e of t.children)e.active&&(1024&e._objFlags||this.Reset(e))}static DirtyBaked(t){const e=t.getComponents(cc.Light);for(const t of e)t.baked=!0;for(const e of t.children)e.active&&(1024&e._objFlags||this.DirtyBaked(e))}Init(t={}){this.Baker.World=new LFX_World,this.Scene=null,this.Models=[],this.Lights=[],this.Terrains=[],this.MainCamera=null,this._currentTicks=0,this._lastTicks=0,this.Baker.World.Name=t.name||"Test",this.Baker.World.Settings.SkyRadiance=t.skyRadiance||[.5,.5,.5],this.Baker.World.Settings.MSAA=t.msaa||4,this.Baker.World.Settings.Size=t.size||1024,this.Baker.World.Settings.Gamma=2.2,this.Baker.World.Settings.GIScale=t.giScale||0,this.Baker.World.Settings.GISamples=t.giSamples||10,this.Baker.World.Settings.AOLevel=t.aoLevel||0,this.Baker.World.Settings.GIPathLength=t.giPathLength||4,this.Baker.World.Settings.Threads=t.threads||1,this._uploadPath=t.path||""}Index2Str(t){let e="";return t<1e3&&(e+="0"),t<100&&(e+="0"),t<10&&(e+="0"),e+=t}Cancel(){this._timer&&(clearInterval(this._timer),this.Baker.Stop(),this.Baker.Close(),this._timer=null,this.Baker.emit("cancel",!0),null!==this._process&&(this._process.kill("SIGKILL"),this._process=null))}async Bake(t){this.Scene=t,this._export(t);for(const t of this.Baker.World.Meshes)for(const e of t.MaterialBuffer){if(0===e.Texture.length)continue;const t=e.Texture;if(-1===t.search("@")){const s=await Editor.Message.request("asset-db","query-path",t);e.Texture=null!==s?s:""}else e.Texture=ps.join(Editor.Project.path,"library",t.substr(0,2),t);0===e.Texture.length&&console.warn("query-path texture "+t+" failed")}if(cc.director.root.pipeline.pipelineSceneData.isHDR){const t=cc.renderer.scene.Camera.standardExposureValue;for(const e of this.Baker.World.Lights)e.Color[0]*=e.Illuminance*t,e.Color[1]*=e.Illuminance*t,e.Color[2]*=e.Illuminance*t}this.Baker.Upload(this._uploadPath),this._run()}async _export(t){this._exportImp(t)}_exportImp(t){t instanceof cc.Scene||this._exportNode(t);for(const e of t.children)e.active&&(1024&e._objFlags||this._exportImp(e))}_exportNode(t){const e=t.getComponent(cc.Terrain);null!=e&&e.enabled&&this._exportTerrain(e);const s=t.getComponents(cc.MeshRenderer);for(const t of s)t.enabled&&this._exportModel(t);const i=t.getComponents(cc.Light);for(const t of i)t.enabled&&this._exportLight(t)}_exportTerrain(t){const e=new LFX_Terrain;e.Position[0]=t.node.getWorldPosition().x,e.Position[1]=t.node.getWorldPosition().y,e.Position[2]=t.node.getWorldPosition().z,e.TileSize=t.info.tileSize,e.BlockCount[0]=t.info.blockCount[0],e.BlockCount[1]=t.info.blockCount[1],e.LightMapSize=t.info.lightMapSize,e.HeightField=t.getHeightField(),this.Baker.World.Terrains.push(e),this.Terrains.push(t)}_exportModel(t){const e=t.mesh;if(null==e)return!1;if(!t.lightmapSettings.bakeable&&!t.lightmapSettings.castShadow)return!1;const s=new LFX_Mesh;s.CastShadow=t.lightmapSettings.castShadow,s.ReceiveShadow=t.lightmapSettings.receiveShadow,t.lightmapSettings.bakeable&&(s.LightMapSize=t.lightmapSettings.lightmapSize);const i=t.node.getWorldMatrix();for(let r=0;r<e.struct.primitives.length;++r){const n=e.readAttribute(r,cc.gfx.AttributeName.ATTR_POSITION),o=e.readAttribute(r,cc.gfx.AttributeName.ATTR_NORMAL),a=e.readAttribute(r,cc.gfx.AttributeName.ATTR_TEX_COORD),l=e.readAttribute(r,cc.gfx.AttributeName.ATTR_TEX_COORD1),h=e.readIndices(r);if(!n||!o||!h)return!1;if(n.length!==o.length)return!1;if(null!=a&&n.length/3!=a.length/2)return!1;if(null!=l&&n.length/3!=l.length/2)return!1;null==l&&(s.ReceiveShadow=!1);for(let t=0;t<n.length/3;++t){const e=new cc.Vec3;e.x=n[3*t+0],e.y=n[3*t+1],e.z=n[3*t+2],cc.Vec3.transformMat4(e,e,i);const r=new cc.Vec3;r.x=o[3*t+0],r.y=o[3*t+1],r.z=o[3*t+2],cc.Vec3.transformMat4Normal(r,r,i),r.normalize();const h=new LFX_Vertex;h.Position[0]=e.x,h.Position[1]=e.y,h.Position[2]=e.z,h.Normal[0]=r.x,h.Normal[1]=r.y,h.Normal[2]=r.z,null!=a&&(h.UV[0]=a[2*t+0],h.UV[1]=a[2*t+1]),null!=l&&(h.LUV[0]=l[2*t+0],h.LUV[1]=l[2*t+1]),s.VertexBuffer.push(h)}for(let e=0;e<h.length/3;++e){const i=new LFX_Triangle;h.length<256?(i.Index[0]=h[3*e+0],i.Index[1]=h[3*e+1],i.Index[2]=h[3*e+2]):(h.length,i.Index[0]=h[3*e+0],i.Index[1]=h[3*e+1],i.Index[2]=h[3*e+2]),t.materials.length>0?i.MaterialId=clamp(r,0,t.materials.length-1):i.MaterialId=0,s.TriangleBuffer.push(i)}}if(t.materials.length>0){const e=cc.Texture2D.PixelFormat;for(let i=0;i<t.materials.length;++i){const r=new LFX_Material;r.Diffuse[0]=1,r.Diffuse[1]=1,r.Diffuse[2]=1;const n=t.materials[i];if(null!==n){let t=n.getProperty("mainTexture",0);if(null==t&&(t=n.getProperty("albedoMap",0)),null!==t&&t.getPixelFormat()===e.RGBA8888){const e=t.mipmaps[0];null!==e&&(-1!==e._uuid.search("@")?r.Texture=e._uuid+e._native:r.Texture=e._uuid)}}s.MaterialBuffer.push(r)}}else{const t=new LFX_Material;t.Diffuse[0]=1,t.Diffuse[1]=1,t.Diffuse[2]=1,s.MaterialBuffer.push(t)}this.Baker.World.Meshes.push(s),this.Models.push(t)}_exportLight(t){if(!t.staticSettings.bakeable)return;const e=new LFX_Light;e.Type=LFX_Light.DIRECTION,e.GIEnable=!1,e.CastShadow=t.staticSettings.castShadow,e.Position[0]=t.node.getWorldPosition().x,e.Position[1]=t.node.getWorldPosition().y,e.Position[2]=t.node.getWorldPosition().z;const s=new cc.Vec3(0,0,-1);cc.Vec3.transformQuat(s,s,t.node.getWorldRotation()),e.Direction[0]=s.x,e.Direction[1]=s.y,e.Direction[2]=s.z,e.Color[0]=t.color.x,e.Color[1]=t.color.y,e.Color[2]=t.color.z;if(t instanceof cc.DirectionalLight){const s=t;e.Type=LFX_Light.DIRECTION,e.Illuminance=s.illuminance}else if(t instanceof cc.SphereLight){const s=t;e.Type=LFX_Light.POINT,e.Size=s.size,e.Range=s.range,e.AttenFallOff=1,e.Illuminance=1e4*s.luminance}else{if(!(t instanceof cc.SpotLight))return;{const s=t;e.Type=LFX_Light.SPOT,e.Size=s.size,e.Range=s.range,e.AttenFallOff=1,e.SpotInner=Math.cos(s.spotAngle/4*(Math.PI/180)),e.SpotOuter=Math.cos(s.spotAngle/2*(Math.PI/180)),e.SpotFallOff=1,e.Illuminance=1e4*s.luminance}}e.DirectScale=1,e.IndirectScale=1,this.Baker.World.Lights.push(e),this.Lights.push(t)}_exportCamera(t){null===this.MainCamera?this.MainCamera=t:"MainCamera"===t.node.name&&(this.MainCamera=t)}_run(){let t=!1,e=3e3;e=0,getPort((t,s)=>{t?(e=-1,console.log("Configure port failed")):e=s}),this._timer=setInterval(()=>{if(t)if(this.Baker.closed)clearInterval(this._timer);else{if(this.Baker.Started){if(this.Baker.Finished){console.log("End");let t=null;try{t=this.Baker.Download()}catch(e){console.error("LightFX get result file failed."),t=null}if(null!==t)for(let e=0;e<t.MeshInfos.length;++e){const s=t.MeshInfos[e],i="Mesh "+s.Id+": Index("+s.Index+")  Offset("+s.Offset[0]+", "+s.Offset[1]+")  Scale("+s.Scale[0]+", "+s.Scale[1]+")";this.Baker.emit("log",i)}this.Baker.Stop(),clearInterval(this._timer),this.Baker.Close(),this._timer=null,this.Baker.emit("end",!0),null!==this._process&&(this._process.kill("SIGKILL"),this._process=null),null!=this.Scene&&LFX_App.DirtyBaked(this.Scene);for(const t of this.Terrains)t.lightMapSize>0&&t._resetLightmap(!0);null!==t&&readImageList(ps.join(this._uploadPath,"output"),!1,e=>{for(const s of t.TerrainInfos){const t=this.Terrains[s.Id],i=e["LFX_Terrain_"+this.Index2Str(s.Index)+".png"];if(i){if(null!==i.texture){const e=i.texture;t._updateLightmap(s.BlockId,e,s.Offset[0],s.Offset[1],s.Scale[0],s.Scale[1])}else t._updateLightmap(s.BlockId,null,s.Offset[0],s.Offset[1],s.Scale[0],s.Scale[1]);Editor.Message.broadcast("scene:change-node",t.node.uuid)}}for(const s of t.MeshInfos){const t=this.Models[s.Id],i=e["LFX_Mesh_"+this.Index2Str(s.Index)+".png"];if(i){if(null!==i.texture){const e=i.texture;t._updateLightmap(e,s.Offset[0],s.Offset[1],s.Scale[0],s.Scale[1]),t.node._dirtyFlags=1}else t._updateLightmap(null,s.Offset[0],s.Offset[1],s.Scale[0],s.Scale[1]);if(t.node){const e=t.node.components.indexOf(t);nodeMgr.emit("change",t.node,{type:NodeOperationType.SET_PROPERTY,propPath:`__comps__.${e}.lightmapSettings`})}}}cce.Engine.repaintInEditMode()})}}else this.Baker.connected&&(this.Baker.Start(),this.Baker.client.on("Tick",t=>{this._lastTicks=this._currentTicks}));this._currentTicks+=100}else if(e>0){this.Baker.Launch(e);{const t="http://127.0.0.1:"+e,s=this.Baker.lfxpath+"/LightFX";console.log("Launching "+s),this._process=exec__default.default.execFile(s,[t],{cwd:this._uploadPath},(t,e,s)=>{t&&"SIGKILL"!==t.signal&&(this.Baker.Error=!0,console.error(t),console.error("If it's aborted with an exception, try to lower the number of Resolution or MSAA."),this.Baker.Stop(),clearInterval(this._timer),this.Baker.Close(),this._timer=null,this.Baker.emit("end",!0),this._process.kill("SIGKILL"))}),this._process||(console.log("Launching lightfx failed."),clearInterval(this._timer))}t=!0}else e<0&&clearInterval(this._timer)},100)}}const Chroma=require("chroma-js");class Lightmap{constructor(){this.scene=null,this.renderScene=null}init(){this.lfxApp=new LFX_App,this.lfxApp.Baker.on("login",t=>{console.debug("lightMap output info: login",t),Editor.Message.broadcast("scene:lightmap-start")}),this.lfxApp.Baker.on("log",t=>{console.debug("lightMap output info: log",t),Editor.Message.broadcast("scene:lightmap-log",t)}),this.lfxApp.Baker.on("progress",t=>{console.debug("lightMap output info: progress",t),Editor.Message.broadcast("scene:lightmap-progress",t)}),this.lfxApp.Baker.on("fineshed",t=>{console.debug("lightMap output info: fineshed",t),Editor.Message.broadcast("scene:lightmap-finished")}),this.lfxApp.Baker.on("end",t=>{console.debug("lightMap output info: end",t),Editor.Message.broadcast("scene:lightmap-end",t)}),this.lfxApp.Baker.on("cancel",t=>{console.debug("lightMap output info: cancel",t),Editor.Message.broadcast("scene:lightmap-cancel",t)}),this.scene=cc__default.default.director.getScene(),cce.Scene.on("open",this.onLoadScene.bind(this)),cce.Scene.on("reload",this.onLoadScene.bind(this))}onLoadScene(t){this.scene=t,this.renderScene=this.scene._renderScene}async apply(t,e){fs__default.default.existsSync(t.path)||fs__default.default.mkdirSync(t.path),e&&(this.lfxApp.Baker.lfxpath=ps__default.default.join(e,"../tools/lightmap-tools")),t.aoColor=Chroma(t.aoColor).rgb(),this.lfxApp.Init(t),await this.bake()}clear(){LFX_App.Reset(this.scene)}async bake(){await this.lfxApp.Bake(this.scene)}cancel(){this.lfxApp.Cancel()}}var lightMap=new Lightmap;function load(){lightMap.init()}function unload(){}const methods={async apply(t,e){await lightMap.apply(t,e)},cancel(){lightMap.cancel()},clear(){lightMap.clear()}};exports.load=load,exports.methods=methods,exports.unload=unload;