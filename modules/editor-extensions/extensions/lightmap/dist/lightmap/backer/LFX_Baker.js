"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LFX_Baker=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),io=require("socket.io"),LFX_Types_1=require("./LFX_Types"),events_1=__importDefault(require("events")),LFX_FILE_VERSION=8192,LFX_FILE_TERRAIN=1,LFX_FILE_MESH=2,LFX_FILE_LIGHT=3,LFX_FILE_EOF=0;class LFX_Baker extends events_1.default{constructor(){super(),this.World=new LFX_Types_1.LFX_World,this.Started=!1,this.Finished=!1,this.Error=!1,this._server=null,this._client=null,this._path=null,this._lfxpath=null,LFX_Baker.Instance=this}get lfxpath(){return this._lfxpath||path_1.default.resolve("tools/lightmap-tools")}set lfxpath(t){this._lfxpath=t}get closed(){return null==this._server}get connected(){return null!=this._client}get client(){return this._client}Launch(t=0){return this.Started=!1,this.Finished=!1,this.Error=!1,this._server=io.listen(t),this._server.on("connection",t=>{t.on("Login",e=>{this._client=t,this.emit("login",this._client)}),t.on("Log",t=>{this.emit("log",t)}),t.on("Progress",t=>{this.emit("progress",t)}),t.on("Finished",t=>{this.Finished=!0,this.emit("fineshed",t)})}),t}Close(){null!=this._server&&this._server.close(),this._server=null,this._client=null}Upload(t){this._path=t;const e=new LFX_Types_1.LFX_Buffer,r=t+"/tmp";fs_1.default.existsSync(r)||fs_1.default.mkdirSync(r),e.WriteInt32(LFX_FILE_VERSION),e.WriteString(this.World.Name);e.WriteFloatArray([0,0,0]),e.WriteFloatArray(this.World.Settings.SkyRadiance),e.WriteInt32(this.World.Settings.MSAA),e.WriteInt32(this.World.Settings.Size),e.WriteFloat(this.World.Settings.Gamma),e.WriteFloat(this.World.Settings.GIScale),e.WriteInt32(this.World.Settings.GISamples),e.WriteInt32(this.World.Settings.GIPathLength),e.WriteInt32(this.World.Settings.AOLevel),e.WriteFloat(this.World.Settings.AOStrength),e.WriteFloat(this.World.Settings.AORadius),e.WriteFloatArray(this.World.Settings.AOColor),e.WriteInt32(this.World.Settings.Threads);for(const t of this.World.Terrains)e.WriteInt32(LFX_FILE_TERRAIN),e.WriteFloatArray(t.Position),e.WriteFloat(t.TileSize),e.WriteIntArray(t.BlockCount),e.WriteInt32(t.LightMapSize),e.WriteHeightField(t.HeightField);for(const t of this.World.Meshes){e.WriteInt32(LFX_FILE_MESH),e.WriteInt8(t.CastShadow?1:0),e.WriteInt8(t.ReceiveShadow?1:0),e.WriteInt32(t.LightMapSize),e.WriteInt32(t.VertexBuffer.length),e.WriteInt32(t.TriangleBuffer.length),e.WriteInt32(t.MaterialBuffer.length);for(const r of t.VertexBuffer)e.WriteFloatArray(r.Position),e.WriteFloatArray(r.Normal),e.WriteFloatArray(r.UV),e.WriteFloatArray(r.LUV);for(const r of t.TriangleBuffer)e.WriteIntArray(r.Index),e.WriteInt32(r.MaterialId);for(const r of t.MaterialBuffer)e.WriteFloatArray(r.Diffuse),e.WriteString(r.Texture)}for(const t of this.World.Lights)e.WriteInt32(LFX_FILE_LIGHT),e.WriteInt32(t.Type),e.WriteFloatArray(t.Position),e.WriteFloatArray(t.Direction),e.WriteFloatArray(t.Color),e.WriteFloat(t.AttenStart),e.WriteFloat(t.AttenEnd),e.WriteFloat(t.AttenFallOff),e.WriteFloat(t.SpotInner),e.WriteFloat(t.SpotOuter),e.WriteFloat(t.SpotFallOff),e.WriteFloat(t.DirectScale),e.WriteFloat(t.IndirectScale),e.WriteInt8(t.GIEnable?1:0),e.WriteInt8(t.CastShadow?1:0);e.WriteInt32(LFX_FILE_EOF),fs_1.default.writeFileSync(r+"/lfx.i",e.Buffer);for(const e of this.World.Textures){const i=fs_1.default.readFileSync(t+"/"+e),s=e.replace("/","$");fs_1.default.writeFileSync(r+"/"+s,i)}}Download(){const t=new LFX_Types_1.LFX_File,e=this._path+"/output/lfx.o",r=fs_1.default.readFileSync(e);if(null!=r){const e=new LFX_Types_1.LFX_Buffer;for(e.Assign(r),t.Verison=e.ReadInt();;){const r=e.ReadInt();if(r===LFX_FILE_EOF)break;if(r===LFX_FILE_TERRAIN){const r=e.ReadInt(),i=e.ReadInt();for(let s=0;s<i;++s){const i=new LFX_Types_1.LFX_TerrainLightMapInfo;i.Id=r,i.BlockId=e.ReadInt(),i.Index=e.ReadInt(),i.Offset[0]=e.ReadFloat(),i.Offset[1]=e.ReadFloat(),i.Scale[0]=e.ReadFloat(),i.Scale[1]=e.ReadFloat(),t.TerrainInfos.push(i)}}else if(r===LFX_FILE_MESH){const r=e.ReadInt();for(let i=0;i<r;++i){const r=new LFX_Types_1.LFX_MeshLightMapInfo;r.Id=e.ReadInt(),r.Index=e.ReadInt(),r.Offset[0]=e.ReadFloat(),r.Offset[1]=e.ReadFloat(),r.Scale[0]=e.ReadFloat(),r.Scale[1]=e.ReadFloat(),t.MeshInfos.push(r)}}else console.log("LightFX unknown chunk "+r)}}return t}Start(){this._client&&this._client.emit("Start"),this.Started=!0}Stop(){this._client&&this._client.emit("Stop")}}exports.LFX_Baker=LFX_Baker;