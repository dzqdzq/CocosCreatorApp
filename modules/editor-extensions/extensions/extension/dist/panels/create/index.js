"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const path_1 = require("path");
const vue_js_1 = __importDefault(require("vue/dist/vue.js"));
const DistVue = require('vue/dist/vue.js');
DistVue.config.productionTip = false;
DistVue.config.devtools = false;
const panelDataMap = new WeakMap();
const app_1 = require("./app");
module.exports = Editor.Panel.define({
    template: '<div id="app"></div>',
    style: fs_1.readFileSync(path_1.join(__dirname, '../../create.css'), 'utf8'),
    $: {
        app: '#app',
    },
    async ready(startupArgs) {
        const extensionInfoMap = (await Editor.Message.request('extension', 'get-extension-info-map'));
        const author = (await Editor.Profile.getTemp('extension', app_1.TempProfileKeys.author)) || 'Cocos Creator';
        const tempShowInManager = await Editor.Profile.getTemp('extension', app_1.TempProfileKeys.showInManager);
        const showInManager = tempShowInManager === null ? true : Boolean(tempShowInManager);
        const tempShowInFolder = await Editor.Profile.getTemp('extension', app_1.TempProfileKeys.showInFolder);
        const showInFolder = tempShowInFolder === null ? true : Boolean(tempShowInFolder);
        const vm = new vue_js_1.default({
            extends: app_1.ExtensionCreation,
            propsData: {
                showInFolder,
                showInManager,
                author,
                preloadExtensionInfo: extensionInfoMap,
            },
        });
        vm.$mount(this.$.app);
        if (startupArgs?.selectedTemplate) {
            const { packageName, templatePath } = startupArgs.selectedTemplate;
            const templateFound = vm.getAvailableTemplate(packageName, templatePath);
            if (templateFound) {
                vm.selectTemplate(packageName, templateFound);
            }
        }
        vm.loadAllCreatorModule({ force: true });
        function onExtensionEnable(info) {
            vm.onPluginEnable(info);
        }
        function onExtensionDisable(info) {
            vm.onPluginDisable(info);
        }
        Editor.Package.__protected__.on('enable', onExtensionEnable);
        Editor.Package.__protected__.on('disable', onExtensionDisable);
        panelDataMap.set(this, {
            onExtensionDisable,
            onExtensionEnable,
            async releaseAllCreatorModule() {
                return vm.unloadAllCreatorModule({ force: true });
            },
        });
    },
    async close() {
        const info = panelDataMap.get(this);
        if (!info)
            return;
        await info.releaseAllCreatorModule();
        Editor.Package.__protected__.removeListener('enable', info.onExtensionEnable);
        Editor.Package.__protected__.removeListener('disable', info.onExtensionDisable);
        panelDataMap.delete(this);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvcGFuZWxzL2NyZWF0ZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLDJCQUE4QztBQUM5QywrQkFBNEI7QUFFNUIsNkRBQWtDO0FBR2xDLE1BQU0sT0FBTyxHQUFlLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3ZELE9BQU8sQ0FBQyxNQUFNLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztBQUNyQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7QUFDaEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxPQUFPLEVBTzdCLENBQUM7QUFFSiwrQkFBMkQ7QUFFM0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUNqQyxRQUFRLEVBQUUsc0JBQXNCO0lBQ2hDLEtBQUssRUFBRSxpQkFBWSxDQUFDLFdBQUksQ0FBQyxTQUFTLEVBQUUsa0JBQWtCLENBQUMsRUFBRSxNQUFNLENBQUM7SUFDaEUsQ0FBQyxFQUFFO1FBQ0MsR0FBRyxFQUFFLE1BQU07S0FDZDtJQUVELEtBQUssQ0FBQyxLQUFLLENBQUMsV0FBaUM7UUFDekMsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLHdCQUF3QixDQUFDLENBQWdCLENBQUM7UUFDOUcsTUFBTSxNQUFNLEdBQUcsQ0FBQyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxxQkFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksZUFBZSxDQUFDO1FBQ3RHLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUscUJBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNuRyxNQUFNLGFBQWEsR0FBRyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDckYsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxxQkFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pHLE1BQU0sWUFBWSxHQUFHLGdCQUFnQixLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVsRixNQUFNLEVBQUUsR0FBRyxJQUFJLGdCQUFHLENBQUM7WUFDZixPQUFPLEVBQUUsdUJBQWlCO1lBQzFCLFNBQVMsRUFBRTtnQkFDUCxZQUFZO2dCQUNaLGFBQWE7Z0JBQ2IsTUFBTTtnQkFDTixvQkFBb0IsRUFBRSxnQkFBZ0I7YUFDekM7U0FDSixDQUFDLENBQUM7UUFDSCxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBa0IsQ0FBQyxDQUFDO1FBRXJDLElBQUksV0FBVyxFQUFFLGdCQUFnQixFQUFFO1lBQy9CLE1BQU0sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDO1lBQ25FLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDekUsSUFBSSxhQUFhLEVBQUU7Z0JBQ2YsRUFBRSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7YUFDakQ7U0FDSjtRQUVELEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXpDLFNBQVMsaUJBQWlCLENBQUMsSUFBa0M7WUFDekQsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDO1FBQ0QsU0FBUyxrQkFBa0IsQ0FBQyxJQUFrQztZQUMxRCxFQUFFLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFDRCxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDN0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBQy9ELFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFO1lBQ25CLGtCQUFrQjtZQUNsQixpQkFBaUI7WUFDakIsS0FBSyxDQUFDLHVCQUF1QjtnQkFDekIsT0FBTyxFQUFFLENBQUMsc0JBQXNCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN0RCxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELEtBQUssQ0FBQyxLQUFLO1FBQ1AsTUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsSUFBSTtZQUFFLE9BQU87UUFDbEIsTUFBTSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUNyQyxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzlFLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDaEYsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QixDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2hlbGwgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgeyBleGlzdHNTeW5jLCByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBjb2VyY2UsIHNhdGlzZmllcywgdmFsaWQgfSBmcm9tICdzZW12ZXInO1xuaW1wb3J0IFZ1ZSBmcm9tICd2dWUvZGlzdC92dWUuanMnO1xuaW1wb3J0IHsgRXh0ZW5zaW9uQ3JlYXRvciwgVGVtcGxhdGVNYXAsIENyZWF0aW9uU3RhcnR1cEFyZ3MgfSBmcm9tICcuLi8uLi9wdWJsaWMvaW50ZXJmYWNlJztcblxuY29uc3QgRGlzdFZ1ZTogdHlwZW9mIFZ1ZSA9IHJlcXVpcmUoJ3Z1ZS9kaXN0L3Z1ZS5qcycpO1xuRGlzdFZ1ZS5jb25maWcucHJvZHVjdGlvblRpcCA9IGZhbHNlO1xuRGlzdFZ1ZS5jb25maWcuZGV2dG9vbHMgPSBmYWxzZTtcbmNvbnN0IHBhbmVsRGF0YU1hcCA9IG5ldyBXZWFrTWFwPFxuICAgIGFueSxcbiAgICB7XG4gICAgICAgIG9uRXh0ZW5zaW9uRW5hYmxlOiAocGFja2FnZUluZm86IEVkaXRvci5JbnRlcmZhY2UuUGFja2FnZUluZm8pID0+IHZvaWQ7XG4gICAgICAgIG9uRXh0ZW5zaW9uRGlzYWJsZTogKHBhY2thZ2VJbmZvOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSA9PiB2b2lkO1xuICAgICAgICByZWxlYXNlQWxsQ3JlYXRvck1vZHVsZTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgICB9XG4+KCk7XG5cbmltcG9ydCB7IEV4dGVuc2lvbkNyZWF0aW9uLCBUZW1wUHJvZmlsZUtleXMgfSBmcm9tICcuL2FwcCc7XG5cbm1vZHVsZS5leHBvcnRzID0gRWRpdG9yLlBhbmVsLmRlZmluZSh7XG4gICAgdGVtcGxhdGU6ICc8ZGl2IGlkPVwiYXBwXCI+PC9kaXY+JyxcbiAgICBzdHlsZTogcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi4vLi4vY3JlYXRlLmNzcycpLCAndXRmOCcpLFxuICAgICQ6IHtcbiAgICAgICAgYXBwOiAnI2FwcCcsXG4gICAgfSxcblxuICAgIGFzeW5jIHJlYWR5KHN0YXJ0dXBBcmdzPzogQ3JlYXRpb25TdGFydHVwQXJncykge1xuICAgICAgICBjb25zdCBleHRlbnNpb25JbmZvTWFwID0gKGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2V4dGVuc2lvbicsICdnZXQtZXh0ZW5zaW9uLWluZm8tbWFwJykpIGFzIFRlbXBsYXRlTWFwO1xuICAgICAgICBjb25zdCBhdXRob3IgPSAoYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0VGVtcCgnZXh0ZW5zaW9uJywgVGVtcFByb2ZpbGVLZXlzLmF1dGhvcikpIHx8ICdDb2NvcyBDcmVhdG9yJztcbiAgICAgICAgY29uc3QgdGVtcFNob3dJbk1hbmFnZXIgPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRUZW1wKCdleHRlbnNpb24nLCBUZW1wUHJvZmlsZUtleXMuc2hvd0luTWFuYWdlcik7XG4gICAgICAgIGNvbnN0IHNob3dJbk1hbmFnZXIgPSB0ZW1wU2hvd0luTWFuYWdlciA9PT0gbnVsbCA/IHRydWUgOiBCb29sZWFuKHRlbXBTaG93SW5NYW5hZ2VyKTtcbiAgICAgICAgY29uc3QgdGVtcFNob3dJbkZvbGRlciA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldFRlbXAoJ2V4dGVuc2lvbicsIFRlbXBQcm9maWxlS2V5cy5zaG93SW5Gb2xkZXIpO1xuICAgICAgICBjb25zdCBzaG93SW5Gb2xkZXIgPSB0ZW1wU2hvd0luRm9sZGVyID09PSBudWxsID8gdHJ1ZSA6IEJvb2xlYW4odGVtcFNob3dJbkZvbGRlcik7XG5cbiAgICAgICAgY29uc3Qgdm0gPSBuZXcgVnVlKHtcbiAgICAgICAgICAgIGV4dGVuZHM6IEV4dGVuc2lvbkNyZWF0aW9uLFxuICAgICAgICAgICAgcHJvcHNEYXRhOiB7XG4gICAgICAgICAgICAgICAgc2hvd0luRm9sZGVyLFxuICAgICAgICAgICAgICAgIHNob3dJbk1hbmFnZXIsXG4gICAgICAgICAgICAgICAgYXV0aG9yLFxuICAgICAgICAgICAgICAgIHByZWxvYWRFeHRlbnNpb25JbmZvOiBleHRlbnNpb25JbmZvTWFwLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIHZtLiRtb3VudCh0aGlzLiQuYXBwIGFzIEhUTUxFbGVtZW50KTtcblxuICAgICAgICBpZiAoc3RhcnR1cEFyZ3M/LnNlbGVjdGVkVGVtcGxhdGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcGFja2FnZU5hbWUsIHRlbXBsYXRlUGF0aCB9ID0gc3RhcnR1cEFyZ3Muc2VsZWN0ZWRUZW1wbGF0ZTtcbiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlRm91bmQgPSB2bS5nZXRBdmFpbGFibGVUZW1wbGF0ZShwYWNrYWdlTmFtZSwgdGVtcGxhdGVQYXRoKTtcbiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZUZvdW5kKSB7XG4gICAgICAgICAgICAgICAgdm0uc2VsZWN0VGVtcGxhdGUocGFja2FnZU5hbWUsIHRlbXBsYXRlRm91bmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdm0ubG9hZEFsbENyZWF0b3JNb2R1bGUoeyBmb3JjZTogdHJ1ZSB9KTtcblxuICAgICAgICBmdW5jdGlvbiBvbkV4dGVuc2lvbkVuYWJsZShpbmZvOiBFZGl0b3IuSW50ZXJmYWNlLlBhY2thZ2VJbmZvKSB7XG4gICAgICAgICAgICB2bS5vblBsdWdpbkVuYWJsZShpbmZvKTtcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBvbkV4dGVuc2lvbkRpc2FibGUoaW5mbzogRWRpdG9yLkludGVyZmFjZS5QYWNrYWdlSW5mbykge1xuICAgICAgICAgICAgdm0ub25QbHVnaW5EaXNhYmxlKGluZm8pO1xuICAgICAgICB9XG4gICAgICAgIEVkaXRvci5QYWNrYWdlLl9fcHJvdGVjdGVkX18ub24oJ2VuYWJsZScsIG9uRXh0ZW5zaW9uRW5hYmxlKTtcbiAgICAgICAgRWRpdG9yLlBhY2thZ2UuX19wcm90ZWN0ZWRfXy5vbignZGlzYWJsZScsIG9uRXh0ZW5zaW9uRGlzYWJsZSk7XG4gICAgICAgIHBhbmVsRGF0YU1hcC5zZXQodGhpcywge1xuICAgICAgICAgICAgb25FeHRlbnNpb25EaXNhYmxlLFxuICAgICAgICAgICAgb25FeHRlbnNpb25FbmFibGUsXG4gICAgICAgICAgICBhc3luYyByZWxlYXNlQWxsQ3JlYXRvck1vZHVsZSgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdm0udW5sb2FkQWxsQ3JlYXRvck1vZHVsZSh7IGZvcmNlOiB0cnVlIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBhc3luYyBjbG9zZSgpIHtcbiAgICAgICAgY29uc3QgaW5mbyA9IHBhbmVsRGF0YU1hcC5nZXQodGhpcyk7XG4gICAgICAgIGlmICghaW5mbykgcmV0dXJuO1xuICAgICAgICBhd2FpdCBpbmZvLnJlbGVhc2VBbGxDcmVhdG9yTW9kdWxlKCk7XG4gICAgICAgIEVkaXRvci5QYWNrYWdlLl9fcHJvdGVjdGVkX18ucmVtb3ZlTGlzdGVuZXIoJ2VuYWJsZScsIGluZm8ub25FeHRlbnNpb25FbmFibGUpO1xuICAgICAgICBFZGl0b3IuUGFja2FnZS5fX3Byb3RlY3RlZF9fLnJlbW92ZUxpc3RlbmVyKCdkaXNhYmxlJywgaW5mby5vbkV4dGVuc2lvbkRpc2FibGUpO1xuICAgICAgICBwYW5lbERhdGFNYXAuZGVsZXRlKHRoaXMpO1xuICAgIH0sXG59KTtcbiJdfQ==