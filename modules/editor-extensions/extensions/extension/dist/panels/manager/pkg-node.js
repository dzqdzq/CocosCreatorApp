'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const fs_1 = require("fs");
const path_1 = require("path");
const vue_1 = __importDefault(require("vue/dist/vue"));
const utils_1 = require("../../public/utils");
exports.default = vue_1.default.extend({
    name: 'PkgNode',
    template: fs_1.readFileSync(path_1.join(__dirname, '../../../static/template/manager/pkg-node.html'), 'utf8'),
    props: {
        pkg: {
            type: Object,
        },
    },
    data() {
        return {
            dev: Editor.App.dev,
            description: '',
            languageMTime: 0,
            onScroll: null,
            busy: false,
        };
    },
    mounted() {
        this.updateDescription();
        this.onScroll = () => {
            if (this.busy) {
                return;
            }
            this.busy = true;
            setTimeout(() => {
                this.busy = false;
                this.updateDescription.call(this);
            }, (400));
        };
        this.$on('scroll', this.onScroll);
    },
    destroyed() {
        this.$off('scroll', this.onScroll);
    },
    methods: {
        getObjectByKey(target, key) {
            let params = [];
            if (typeof key === 'string') {
                params = key.split('.');
            }
            else if (key instanceof Array) {
                params = key;
            }
            if (params.length > 0) {
                const value = params.shift();
                return this.getObjectByKey(target[value], params);
            }
            else {
                return target;
            }
        },
        updateDescription() {
            const i18nMark = `i18n:${this.pkg.info.name}.`;
            if (!this.pkg.enable && this.pkg.info.description?.startsWith(i18nMark)) {
                try {
                    const key = this.pkg.info.description.slice(i18nMark.length);
                    // HACK 如果没开启插件，通过读取 i18n 模块来拿到描述
                    const currentLanguage = Editor.I18n.getLanguage();
                    const modulePath = path_1.join(this.pkg.path, 'i18n', `${currentLanguage}.js`);
                    if (fs_1.existsSync(modulePath)) {
                        const stat = fs_1.statSync(modulePath);
                        const mtime = stat.mtime.getTime();
                        if (this.languageMTime !== mtime) {
                            this.languageMTime = mtime;
                            require.cache[modulePath] = undefined;
                            const languageModule = require(modulePath);
                            this.description = this.getObjectByKey(languageModule, key);
                        }
                    }
                }
                catch (error) {
                    console.error(error);
                    this.description = 'Nothing';
                }
            }
            else {
                if (this.pkg.info.description?.startsWith('i18n:')) {
                    this.description = Editor.I18n.t((this.pkg.info.description || '').replace(/^i18n:/, '')) || 'Nothing';
                }
                else {
                    this.description = this.pkg.info.description || 'Nothing';
                }
            }
        },
        /**
         * 重启插件
         */
        async reload() {
            const { path } = this.pkg;
            await Editor.Message.request('extension', 'reload', path);
            this.updateDescription();
        },
        /**
         * 切换插件的启动状态
         */
        async toggleEnable() {
            const { enable, path } = this.pkg;
            await Editor.Message.request('extension', 'enable', path, !enable);
            if (!enable) {
                this.updateDescription();
            }
            this.$parent.refresh();
        },
        /**
         * 打开插件所在的文件夹
         */
        openFolder() {
            electron_1.shell.showItemInFolder(this.pkg.path);
        },
        /**
         * 删除一个插件
         */
        async remove() {
            const vm = this;
            const { info, path } = this.pkg;
            const type = utils_1.getPackageType(path);
            const result = await Editor.Dialog.info(`${Editor.I18n.t('extension.menu.removeConfirm').replace('$name', info.name)}`, {
                title: Editor.I18n.t('extension.menu.confirm'),
                default: 0,
                cancel: 1,
                detail: type === 'develop' ? Editor.I18n.t('extension.menu.notDelete') : '',
                buttons: [
                    Editor.I18n.t('extension.store.confirm'),
                    Editor.I18n.t('extension.store.cancel'),
                ],
            });
            if (result.response === 1) {
                return;
            }
            const done = await Editor.Message.request('extension', 'remove', path);
            if (!done) {
                return;
            }
            Editor.Task.addNotice({
                title: Editor.I18n.t('extension.menu.remove'),
                message: `${info.name} ${Editor.I18n.t('extension.menu.removeSuccess')}`,
                type: 'success',
                timeout: 5000,
            });
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnLW5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvcGFuZWxzL21hbmFnZXIvcGtnLW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7OztBQUViLHVDQUFpQztBQUNqQywyQkFBd0Q7QUFDeEQsK0JBQTRCO0FBQzVCLHVEQUErQjtBQUcvQiw4Q0FBb0Q7QUFFcEQsa0JBQWUsYUFBRyxDQUFDLE1BQU0sQ0FBQztJQUN0QixJQUFJLEVBQUUsU0FBUztJQUNmLFFBQVEsRUFBRSxpQkFBWSxDQUFDLFdBQUksQ0FBQyxTQUFTLEVBQUUsZ0RBQWdELENBQUMsRUFBRSxNQUFNLENBQUM7SUFDakcsS0FBSyxFQUFFO1FBQ0gsR0FBRyxFQUFFO1lBQ0QsSUFBSSxFQUFFLE1BQU07U0FDZTtLQUNsQztJQUNELElBQUk7UUFDQSxPQUFPO1lBQ0gsR0FBRyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRztZQUNuQixXQUFXLEVBQUUsRUFBWTtZQUN6QixhQUFhLEVBQUUsQ0FBQztZQUNoQixRQUFRLEVBQUUsSUFBNEM7WUFDdEQsSUFBSSxFQUFFLEtBQUs7U0FDZCxDQUFDO0lBQ04sQ0FBQztJQUNELE9BQU87UUFDSCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsRUFBRTtZQUNqQixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ1gsT0FBTzthQUNWO1lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFDakIsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztnQkFDbEIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2QsQ0FBQyxDQUFDO1FB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LFNBQVM7Z0JBQ2YsT0FBTyxFQUFFLElBQUk7YUFDaEIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBzaGVsbCB9IGZyb20gJ2VsZWN0cm9uJztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRGaWxlU3luYywgc3RhdFN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgVnVlIGZyb20gJ3Z1ZS9kaXN0L3Z1ZSc7XG5pbXBvcnQgeyBQcm9wVmFsaWRhdG9yIH0gZnJvbSAndnVlL3R5cGVzL29wdGlvbnMnO1xuaW1wb3J0IHsgUGFja2FnZUluZm8gfSBmcm9tICcuLi8uLi9wdWJsaWMvaW50ZXJmYWNlJztcbmltcG9ydCB7IGdldFBhY2thZ2VUeXBlIH0gZnJvbSAnLi4vLi4vcHVibGljL3V0aWxzJztcbmltcG9ydCB0eXBlIHsgY29tcG9uZW50IH0gZnJvbSAnLi9pbmRleCc7XG5leHBvcnQgZGVmYXVsdCBWdWUuZXh0ZW5kKHtcbiAgICBuYW1lOiAnUGtnTm9kZScsXG4gICAgdGVtcGxhdGU6IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uLy4uLy4uL3N0YXRpYy90ZW1wbGF0ZS9tYW5hZ2VyL3BrZy1ub2RlLmh0bWwnKSwgJ3V0ZjgnKSxcbiAgICBwcm9wczoge1xuICAgICAgICBwa2c6IHtcbiAgICAgICAgICAgIHR5cGU6IE9iamVjdCxcbiAgICAgICAgfSBhcyBQcm9wVmFsaWRhdG9yPFBhY2thZ2VJbmZvPixcbiAgICB9LFxuICAgIGRhdGEoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkZXY6IEVkaXRvci5BcHAuZGV2LFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnIGFzIHN0cmluZyxcbiAgICAgICAgICAgIGxhbmd1YWdlTVRpbWU6IDAsXG4gICAgICAgICAgICBvblNjcm9sbDogbnVsbCEgYXMgKCh0aGlzOiBXaW5kb3csIGVudjogRXZlbnQpID0+IGFueSksXG4gICAgICAgICAgICBidXN5OiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9LFxuICAgIG1vdW50ZWQoKSB7XG4gICAgICAgIHRoaXMudXBkYXRlRGVzY3JpcHRpb24oKTtcbiAgICAgICAgdGhpcy5vblNjcm9sbCA9ICgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmJ1c3kpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmJ1c3kgPSB0cnVlO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5idXN5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVEZXNjcmlwdGlvbi5jYWxsKHRoaXMpO1xuICAgICAgICAgICAgfSwgKDQwMCkpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLiRvbignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCk7XG4gICAgfSxcbiAgICBkZXN0cm95ZWQoKSB7XG4gICAgICAgIHRoaXMuJG9mZignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCk7XG4gICAgfSxcbiAgICBtZXRob2RzOiB7XG4gICAgICAgIGdldE9iamVjdEJ5S2V5KHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IEFycmF5PHN0cmluZz4pOiBhbnkge1xuICAgICAgICAgICAgbGV0IHBhcmFtczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IGtleS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IGtleTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gcGFyYW1zLnNoaWZ0KCkgYXMga2V5b2YgdHlwZW9mIHRhcmdldDtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRPYmplY3RCeUtleSh0YXJnZXRbdmFsdWVdLCBwYXJhbXMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB1cGRhdGVEZXNjcmlwdGlvbigpIHtcbiAgICAgICAgICAgIGNvbnN0IGkxOG5NYXJrID0gYGkxOG46JHt0aGlzLnBrZy5pbmZvLm5hbWV9LmA7XG4gICAgICAgICAgICBpZiAoIXRoaXMucGtnLmVuYWJsZSAmJiB0aGlzLnBrZy5pbmZvLmRlc2NyaXB0aW9uPy5zdGFydHNXaXRoKGkxOG5NYXJrKSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IHRoaXMucGtnLmluZm8uZGVzY3JpcHRpb24hLnNsaWNlKGkxOG5NYXJrLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIEhBQ0sg5aaC5p6c5rKh5byA5ZCv5o+S5Lu277yM6YCa6L+H6K+75Y+WIGkxOG4g5qih5Z2X5p2l5ou/5Yiw5o+P6L+wXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMYW5ndWFnZSA9IEVkaXRvci5JMThuLmdldExhbmd1YWdlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZVBhdGggPSBqb2luKHRoaXMucGtnLnBhdGgsICdpMThuJywgYCR7Y3VycmVudExhbmd1YWdlfS5qc2ApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RzU3luYyhtb2R1bGVQYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdCA9IHN0YXRTeW5jKG1vZHVsZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbXRpbWUgPSBzdGF0Lm10aW1lLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhbmd1YWdlTVRpbWUgIT09IG10aW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYW5ndWFnZU1UaW1lID0gbXRpbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZS5jYWNoZVttb2R1bGVQYXRoXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYW5ndWFnZU1vZHVsZSA9IHJlcXVpcmUobW9kdWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9IHRoaXMuZ2V0T2JqZWN0QnlLZXkobGFuZ3VhZ2VNb2R1bGUsIGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9ICdOb3RoaW5nJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGtnLmluZm8uZGVzY3JpcHRpb24/LnN0YXJ0c1dpdGgoJ2kxOG46JykpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXNjcmlwdGlvbiA9IEVkaXRvci5JMThuLnQoKHRoaXMucGtnLmluZm8uZGVzY3JpcHRpb24gfHwgJycpLnJlcGxhY2UoL15pMThuOi8sICcnKSkgfHwgJ05vdGhpbmcnO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSB0aGlzLnBrZy5pbmZvLmRlc2NyaXB0aW9uIHx8ICdOb3RoaW5nJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOmHjeWQr+aPkuS7tlxuICAgICAgICAgKi9cbiAgICAgICAgYXN5bmMgcmVsb2FkKCkge1xuICAgICAgICAgICAgY29uc3QgeyBwYXRoIH0gPSB0aGlzLnBrZztcbiAgICAgICAgICAgIGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2V4dGVuc2lvbicsICdyZWxvYWQnLCBwYXRoKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlRGVzY3JpcHRpb24oKTtcbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICog5YiH5o2i5o+S5Lu255qE5ZCv5Yqo54q25oCBXG4gICAgICAgICAqL1xuICAgICAgICBhc3luYyB0b2dnbGVFbmFibGUoKSB7XG4gICAgICAgICAgICBjb25zdCB7IGVuYWJsZSwgcGF0aCB9ID0gdGhpcy5wa2c7XG4gICAgICAgICAgICBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdleHRlbnNpb24nLCAnZW5hYmxlJywgcGF0aCwgIWVuYWJsZSk7XG4gICAgICAgICAgICBpZiAoIWVuYWJsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRGVzY3JpcHRpb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICh0aGlzLiRwYXJlbnQgYXMgSW5zdGFuY2VUeXBlPHR5cGVvZiBjb21wb25lbnQ+KS5yZWZyZXNoKCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOaJk+W8gOaPkuS7tuaJgOWcqOeahOaWh+S7tuWkuVxuICAgICAgICAgKi9cbiAgICAgICAgb3BlbkZvbGRlcigpIHtcbiAgICAgICAgICAgIHNoZWxsLnNob3dJdGVtSW5Gb2xkZXIodGhpcy5wa2cucGF0aCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWIoOmZpOS4gOS4quaPkuS7tlxuICAgICAgICAgKi9cbiAgICAgICAgYXN5bmMgcmVtb3ZlKCkge1xuICAgICAgICAgICAgY29uc3Qgdm0gPSB0aGlzO1xuICAgICAgICAgICAgY29uc3QgeyBpbmZvLCBwYXRoIH0gPSB0aGlzLnBrZztcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBnZXRQYWNrYWdlVHlwZShwYXRoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEVkaXRvci5EaWFsb2cuaW5mbyhgJHtFZGl0b3IuSTE4bi50KCdleHRlbnNpb24ubWVudS5yZW1vdmVDb25maXJtJykucmVwbGFjZSgnJG5hbWUnLCBpbmZvLm5hbWUpfWAsIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUuY29uZmlybScpLFxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IDAsXG4gICAgICAgICAgICAgICAgY2FuY2VsOiAxLFxuICAgICAgICAgICAgICAgIGRldGFpbDogdHlwZSA9PT0gJ2RldmVsb3AnID8gRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUubm90RGVsZXRlJykgOiAnJyxcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgICAgIEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5jb25maXJtJyksXG4gICAgICAgICAgICAgICAgICAgIEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5jYW5jZWwnKSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChyZXN1bHQucmVzcG9uc2UgPT09IDEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRvbmU6IGJvb2xlYW4gPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdleHRlbnNpb24nLCAncmVtb3ZlJywgcGF0aCk7XG5cbiAgICAgICAgICAgIGlmICghZG9uZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgRWRpdG9yLlRhc2suYWRkTm90aWNlKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUucmVtb3ZlJyksXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYCR7aW5mby5uYW1lfSAke0VkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5tZW51LnJlbW92ZVN1Y2Nlc3MnKX1gLFxuICAgICAgICAgICAgICAgIHR5cGU6ICdzdWNjZXNzJyxcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiA1MDAwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgfSxcbn0pO1xuIl19