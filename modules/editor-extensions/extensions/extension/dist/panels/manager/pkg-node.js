"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),fs_1=require("fs"),path_1=require("path"),vue_js_1=__importDefault(require("vue/dist/vue.js")),semver_1=require("semver"),sdk_1=require("./sdk"),interface_1=require("../../public/interface"),utils_1=require("../../public/utils"),custom_select_1=__importDefault(require("../components/custom-select")),custom_option_1=__importDefault(require("../components/custom-option"));exports.default=vue_js_1.default.extend({name:"PkgNode",components:{"custom-select":custom_select_1.default,"custom-option":custom_option_1.default},inject:{...sdk_1.injectSdk()},props:{pkg:{type:Object,required:!0},label:{type:String,default:""},choosed:{type:Boolean,default:!1}},data:()=>({dev:Editor.App.dev,rank:Math.random(),selectPackageVersion:"",packageVersionOptions:[],queryHistoryLoading:!1,page:0,pageSize:8,total:0,errorMessage:""}),computed:{isInstalled(){return this.pkg.isInstalled},isInstalling(){return"installing"===this.pkg.state},isUninstalling(){return"uninstalling"===this.pkg.state},progress(){return this.pkg.progress},enable(){return this.pkg.enable},isCocosSource(){return this.label===interface_1.ExtensionManagerTab.Cocos||this.label===interface_1.ExtensionManagerTab.BuiltIn||this.pkg.isCocosSource},isPurchasedList(){return this.label===interface_1.ExtensionManagerTab.Purchased},isBuiltinList(){return this.label===interface_1.ExtensionManagerTab.BuiltIn||this.pkg.isBuiltIn},isCocosList(){return this.label===interface_1.ExtensionManagerTab.Cocos},isInstalledList(){return this.label===interface_1.ExtensionManagerTab.Installed},isBaseVersion(){return"string"==typeof this.pkg.builtInVersion&&semver_1.eq(this.pkg.version,this.pkg.builtInVersion)},isShowUninstall(){return this.pkg.isInstalled&&!this.pkg.isBuiltIn},showVersionOptions(){return this.isInstalled&&!this.isInstalledList&&this.packageVersionOptions.length>1&&!this.isInstalling&&!this.isUninstalling},canFetchVersionOptions(){return utils_1.isOnlineExtension(this.pkg)},updateDisabled(){return this.pkg.version===this.selectPackageVersion}},mounted(){this.refreshOptions()},destroyed(){},methods:{t:e=>Editor.I18n.t(`extension.manager.${e}`),toggleEnable(){this.isBuiltinList||this.$emit("toggle-enable",this.pkg.name,this.pkg.enable,this.pkg.path)},refreshOptions(){this.page=1,this.updateVersionList(!0)},openFolder(){electron_1.shell.showItemInFolder(this.pkg.path)},choose(){this.$emit("choose",this.pkg)},async updatePackage(){let e="";if(this.isInstalled?e=this.selectPackageVersion:utils_1.isOnlineExtension(this.pkg)&&(e=this.pkg.latest_version),""===e)throw new Error(`Cannot update(or install) package, version “${e}” is invalid.`);this.$emit("update-package",this.pkg.name,e,this.pkg)},onUpdatePackageClick(e){this.updateDisabled||this.updatePackage()},toggleOptions(e){0===this.page&&e&&(this.page=1,this.updateVersionList(!0))},removePackage(){this.$emit("remove-package",this.pkg.name)},uninstallPackage(){this.$emit("uninstall-package",this.pkg.name,this.pkg,this.label)},updateVersionList(e){if(this.queryHistoryLoading)return;if(this.queryHistoryLoading=!0,this.errorMessage="",e&&(this.packageVersionOptions=[]),!this.canFetchVersionOptions)return;const t={name:this.pkg.name,e:Editor.App.version,page:this.page,pageSize:this.pageSize,lang:Editor.I18n.getLanguage()};this.sdk.getExtensionVersionList(t).then(t=>{this.total=t.count;const i=t.versions.map(e=>({name:e.name,version:e.version,description:e.updateLog})),s=this.pkg.builtInVersion;if(e&&this.pkg.isBuiltIn&&s){i.find(e=>semver_1.eq(e.version,s))||i.push({name:this.pkg.name,version:s,description:this.pkg.description})}this.packageVersionOptions.push(...i),e&&utils_1.isOnlineExtension(this.pkg)&&(this.selectPackageVersion=this.pkg.latest_version)}).catch(e=>{throw this.packageVersionOptions=[],this.errorMessage=this.t("network_error_tip"),e}).finally(()=>{this.queryHistoryLoading=!1})},handleSelect(){},scrollToBottom(){this.queryHistoryLoading||(this.page+=1,this.updateVersionList())}},template:fs_1.readFileSync(path_1.join(__dirname,"../../../static/template/manager/pkg-node.html"),"utf8")});