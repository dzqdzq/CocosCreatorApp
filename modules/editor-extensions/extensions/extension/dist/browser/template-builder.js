"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createExtensionTemplate=void 0;const electron_1=require("electron"),contribution_1=require("./contribution"),utils_build_1=require("../public/utils-build"),path_1=require("path"),fs_extra_1=require("fs-extra"),template_from_cli_create_1=require("./template-from-cli-create"),createExtensionTemplate=async(e,t)=>{const{type:s,templateId:i}=e;var r=(0,contribution_1.getExtensionInfoMap)();const a={success:!1,msg:"",stack:""};if(!Reflect.has(r,s)||!r[s]?.templates)return a.success=!1,a.msg=`template type ${s} is not found`,a;r=r[s].templates?.find(e=>e.id===i);if(!r||!r.creator)return a.success=!1,a.msg=`template ${r?.name} is not valid`,a;var o=e.author||await(0,utils_build_1.getAuthor)()||"Cocos Creator Developer",n=e.name||(0,utils_build_1.getFallbackExtensionName)();if((0,utils_build_1.isExtensionNameError)(n))return a.success=!1,a.msg=`name ${n} is not valid`,a;var c=e.editorVersion||(0,utils_build_1.getEditorVersion)();if((0,utils_build_1.isEditorVersionError)(c))return a.success=!1,a.msg=`editor version limit ${c} is not valid`,a;try{var l={baseTemplate:(0,path_1.join)(__dirname,"../../static/extension-template/template"),dist:e.dist||(0,utils_build_1.getExtensionDist)(n)};if(r.isFromCLI)await(0,template_from_cli_create_1.createFromCli)({author:o,name:n,dist:l.dist,editorVersion:c,template:r}).then(()=>{a.success=!0}).catch(e=>{a.success=!1,a.msg=e.message}),a.success&&(t&&Editor.Package.register(l.dist),e.showInFolder)&&e.dist&&electron_1.shell.showItemInFolder(e.dist);else{var d=(0,path_1.normalize)(r.creator),p=!!require.cache[d],u=require(d);!p&&u.load&&u.load(),await Editor.Utils.File.copy(l.baseTemplate,l.dist),await Editor.Utils.File.copy(r.path,l.dist);try{var m,_=(0,path_1.join)(l.dist,"package.json"),h=await(0,fs_extra_1.readJSON)(_);const f={$schema:"./@types/schema/package/index.json",package_version:2,name:n,version:"1.0.0",author:o,editor:c,scripts:{preinstall:"node ./scripts/preinstall.js",build:"npx tsc"}};for(const E in h)f[E]=f[E]||h[E];if(h.scripts)for(const v in h.scripts)f.scripts[v]=h.scripts[v];if(!r.path)throw m=Editor.I18n.t("extension.create_package.no_path_warning",{template:r.name}),new Error(m);await u.methods.create({author:o,name:n,dist:l.dist,editorVersion:c,template:r},f);const x=f.devDependencies||{};x["@cocos/creator-types"]="^"+Editor.App.version,x["@types/node"]="^18.17.1",x.typescript="^5.8.2",f.devDependencies={},Object.keys(x).sort().forEach(e=>{f.devDependencies[e]=x[e]}),await(0,fs_extra_1.outputJSON)(_,f,{spaces:4});var g=(0,path_1.join)(l.dist,"node_modules");await(0,fs_extra_1.ensureDir)(g),await Editor.Message.request("utils","export-dts",g,!1),a.success=!0}catch(e){return a.success=!1,e instanceof Error?(a.msg=e.message,a.stack=e.stack||""):a.msg="create extension template fail",a}a.success?(t&&await Editor.Package.register(l.dist),e.showInFolder&&e.dist&&electron_1.shell.showItemInFolder(e.dist)):a.msg="create extension template fail"}return a}catch(e){return e instanceof Error?(a.msg=e.message,a.stack=e.stack||""):a.msg="create extension template fail",a.success=!1,a}};exports.createExtensionTemplate=createExtensionTemplate;