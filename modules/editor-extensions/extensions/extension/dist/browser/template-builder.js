"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createExtensionTemplate = void 0;
const electron_1 = require("electron");
const contribution_1 = require("./contribution");
const utils_build_1 = require("../public/utils-build");
const path_1 = require("path");
const fs_extra_1 = require("fs-extra");
/**
 * 根据类型和信息创建模板
 * @param type 目前有builder | extension
 * @param info
 */
const createExtensionTemplate = async (createInfo, isLoad) => {
    const { type, templateId } = createInfo;
    const extensionMap = (0, contribution_1.getExtensionInfoMap)();
    const response = {
        success: false,
        msg: '',
        stack: '',
    };
    // 判断该类型扩展是否存在
    if (!Reflect.has(extensionMap, type) || !extensionMap[type]?.templates) {
        response.success = false;
        response.msg = `template type ${type} is not found`;
        return response;
    }
    // 根据模板id查找指定模板
    const template = extensionMap[type].templates?.find(item => item.id === templateId);
    if (!template || !template.creator) {
        response.success = false;
        response.msg = `template ${templateId} is not valid`;
        return response;
    }
    // 验证基本信息
    const author = createInfo.author || await (0, utils_build_1.getAuthor)();
    const name = createInfo.name || (0, utils_build_1.getFallbackExtensionName)();
    if ((0, utils_build_1.isExtensionNameError)(name)) {
        response.success = false;
        response.msg = `name ${name} is not valid`;
        return response;
    }
    const editorVersion = createInfo.editorVersion || (0, utils_build_1.getEditorVersion)();
    if ((0, utils_build_1.isEditorVersionError)(editorVersion)) {
        response.success = false;
        response.msg = `editor version limit ${editorVersion} is not valid`;
        return response;
    }
    try {
        // 加载指定的模块的创建方法
        const path = (0, path_1.normalize)(template.creator);
        const hasCache = !!require.cache[path];
        const buildModule = require(path);
        if (!hasCache && buildModule.load) {
            buildModule.load();
        }
        const PATH = {
            // 模版所在位置
            baseTemplate: (0, path_1.join)(__dirname, '../../static/extension-template/template'),
            // 目标插件位置
            dist: createInfo.dist || (0, utils_build_1.getExtensionDist)(name),
        };
        // 拷贝基础模版, 基础模版优先级高
        await Editor.Utils.File.copy(PATH.baseTemplate, PATH.dist);
        // 复制注册的模版
        await Editor.Utils.File.copy(template.path, PATH.dist);
        try {
            // 读取 package.json
            const templatePackagePath = (0, path_1.join)(PATH.dist, 'package.json');
            const templatePackageJSON = await (0, fs_extra_1.readJSON)(templatePackagePath);
            const packageJSON = {
                $schema: './@types/schema/package/index.json',
                package_version: 2,
                name: name,
                version: '1.0.0',
                author: author || 'Cocos Creator Developer',
                editor: editorVersion,
                scripts: {
                    preinstall: 'node ./scripts/preinstall.js',
                    build: 'tsc',
                },
            };
            for (const key in templatePackageJSON) {
                packageJSON[key] = packageJSON[key] || templatePackageJSON[key];
            }
            if (templatePackageJSON.scripts) {
                for (const key in templatePackageJSON.scripts) {
                    packageJSON.scripts[key] = templatePackageJSON.scripts[key];
                }
            }
            if (!template.path) {
                const errorMessage = Editor.I18n.t('extension.create_package.no_path_warning', {
                    template: template.name,
                });
                throw new Error(errorMessage);
            }
            // 执行钩子
            await buildModule.methods.create({
                author, name, dist: PATH.dist, editorVersion, template,
            }, packageJSON);
            const devDependencies = packageJSON.devDependencies || {};
            devDependencies['@cocos/creator-types'] = `^${Editor.App.version}`;
            devDependencies['@types/node'] = '^18.17.1';
            // 重新排序
            packageJSON.devDependencies = {};
            Object.keys(devDependencies).sort().forEach(key => {
                packageJSON.devDependencies[key] = devDependencies[key];
            });
            // 如果数据变化，重新写入文件
            await (0, fs_extra_1.outputJSON)(templatePackagePath, packageJSON, { spaces: 4 });
            // generate typescript types
            const tsPath = (0, path_1.join)(PATH.dist, 'node_modules');
            await (0, fs_extra_1.ensureDir)(tsPath);
            await Editor.Message.request('utils', 'export-dts', tsPath, false);
            response.success = true;
        }
        catch (error) {
            response.success = false;
            if (error instanceof Error) {
                response.msg = error.message;
                response['stack'] = error.stack || '';
            }
            else {
                response.msg = 'create extension template fail';
            }
            return response;
        }
        if (response.success) {
            if (isLoad) {
                await Editor.Package.register(PATH.dist);
            }
            if (createInfo.showInFolder && createInfo.dist) {
                electron_1.shell.showItemInFolder(createInfo.dist);
            }
            return response;
        }
        response.msg = 'create extension template fail';
        return response;
    }
    catch (error) {
        if (error instanceof Error) {
            response.msg = error.message;
            response['stack'] = error.stack || '';
        }
        else {
            response.msg = 'create extension template fail';
        }
        response.success = false;
        return response;
    }
};
exports.createExtensionTemplate = createExtensionTemplate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGUtYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9icm93c2VyL3RlbXBsYXRlLWJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQWlDO0FBQ2pDLGlEQUFxRDtBQUVyRCx1REFPK0I7QUFDL0IsK0JBQXVDO0FBQ3ZDLHVDQUFpRTtBQVFqRTs7OztHQUlHO0FBQ0ksTUFBTSx1QkFBdUIsR0FBRyxLQUFLLEVBQUUsVUFBZ0MsRUFBRSxNQUFlLEVBQXFDLEVBQUU7SUFDbEksTUFBTSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsR0FBRyxVQUFVLENBQUM7SUFDeEMsTUFBTSxZQUFZLEdBQUcsSUFBQSxrQ0FBbUIsR0FBRSxDQUFDO0lBRTNDLE1BQU0sUUFBUSxHQUE2QjtRQUN2QyxPQUFPLEVBQUUsS0FBSztRQUNkLEdBQUcsRUFBRSxFQUFFO1FBQ1AsS0FBSyxFQUFFLEVBQUU7S0FDWixDQUFDO0lBRUYsY0FBYztJQUNkLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUU7UUFDcEUsUUFBUSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDekIsUUFBUSxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsSUFBSSxlQUFlLENBQUM7UUFDcEQsT0FBTyxRQUFRLENBQUM7S0FDbkI7SUFFRCxlQUFlO0lBQ2YsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLFVBQVUsQ0FBQyxDQUFDO0lBRXBGLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO1FBQ2hDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFD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Q0FBQztLQUNuQjtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ1osSUFBSSxLQUFLLFlBQVksS0FBSyxFQUFFO1lBQ3hCLFFBQVEsQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUM3QixRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7U0FDekM7YUFBTTtZQUNILFFBQVEsQ0FBQyxHQUFHLEdBQUcsZ0NBQWdDLENBQUM7U0FDbkQ7UUFFRCxRQUFRLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUN6QixPQUFPLFFBQVEsQ0FBQztLQUNuQjtBQUNMLENBQUMsQ0FBQztBQWxLVyxRQUFBLHVCQUF1QiwyQkFrS2xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2hlbGwgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgeyBnZXRFeHRlbnNpb25JbmZvTWFwIH0gZnJvbSAnLi9jb250cmlidXRpb24nO1xuaW1wb3J0IHsgRXh0ZW5zaW9uQ3JlYXRvciB9IGZyb20gJy4uL3B1YmxpYy9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgXG4gICAgZ2V0QXV0aG9yLCBcbiAgICBnZXRFZGl0b3JWZXJzaW9uLCBcbiAgICBnZXRFeHRlbnNpb25EaXN0LFxuICAgIGlzRXh0ZW5zaW9uTmFtZUVycm9yLCBcbiAgICBpc0VkaXRvclZlcnNpb25FcnJvciwgXG4gICAgZ2V0RmFsbGJhY2tFeHRlbnNpb25OYW1lLCBcbn0gZnJvbSAnLi4vcHVibGljL3V0aWxzLWJ1aWxkJztcbmltcG9ydCB7IG5vcm1hbGl6ZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgY29weSwgb3V0cHV0SlNPTiwgcmVhZEpTT04sIGVuc3VyZURpciB9IGZyb20gJ2ZzLWV4dHJhJztcblxuaW1wb3J0IHR5cGUge1xuICAgIElDcmVhdGVFeHRlbnNpb25SZXNwb25zZSxcbiAgICBJQ3JlYXRlVGVtcGxhdGVQYXJhbSxcbn0gZnJvbSAnLi4vLi4vQHR5cGVzL3B1YmxpYyc7XG5pbXBvcnQgeyBjcmVhdGUgfSBmcm9tICdsb2Rhc2gnO1xuXG4vKipcbiAqIOagueaNruexu+Wei+WSjOS/oeaBr+WIm+W7uuaooeadv1xuICogQHBhcmFtIHR5cGUg55uu5YmN5pyJYnVpbGRlciB8IGV4dGVuc2lvblxuICogQHBhcmFtIGluZm8gXG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVFeHRlbnNpb25UZW1wbGF0ZSA9IGFzeW5jIChjcmVhdGVJbmZvOiBJQ3JlYXRlVGVtcGxhdGVQYXJhbSwgaXNMb2FkOiBib29sZWFuKTogUHJvbWlzZTxJQ3JlYXRlRXh0ZW5zaW9uUmVzcG9uc2U+ID0+IHtcbiAgICBjb25zdCB7IHR5cGUsIHRlbXBsYXRlSWQgfSA9IGNyZWF0ZUluZm87XG4gICAgY29uc3QgZXh0ZW5zaW9uTWFwID0gZ2V0RXh0ZW5zaW9uSW5mb01hcCgpO1xuXG4gICAgY29uc3QgcmVzcG9uc2U6IElDcmVhdGVFeHRlbnNpb25SZXNwb25zZSA9IHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIG1zZzogJycsXG4gICAgICAgIHN0YWNrOiAnJyxcbiAgICB9O1xuXG4gICAgLy8g5Yik5pat6K+l57G75Z6L5omp5bGV5piv5ZCm5a2Y5ZyoXG4gICAgaWYgKCFSZWZsZWN0LmhhcyhleHRlbnNpb25NYXAsIHR5cGUpIHx8ICFleHRlbnNpb25NYXBbdHlwZV0/LnRlbXBsYXRlcykge1xuICAgICAgICByZXNwb25zZS5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIHJlc3BvbnNlLm1zZyA9IGB0ZW1wbGF0ZSB0eXBlICR7dHlwZX0gaXMgbm90IGZvdW5kYDtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIC8vIOagueaNruaooeadv2lk5p+l5om+5oyH5a6a5qih5p2/XG4gICAgY29uc3QgdGVtcGxhdGUgPSBleHRlbnNpb25NYXBbdHlwZV0udGVtcGxhdGVzPy5maW5kKGl0ZW0gPT4gaXRlbS5pZCA9PT0gdGVtcGxhdGVJZCk7XG5cbiAgICBpZiAoIXRlbXBsYXRlIHx8ICF0ZW1wbGF0ZS5jcmVhdG9yKSB7XG4gICAgICAgIHJlc3BvbnNlLnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgICAgcmVzcG9uc2UubXNnID0gYHRlbXBsYXRlICR7dGVtcGxhdGVJZH0gaXMgbm90IHZhbGlkYDtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIC8vIOmqjOivgeWfuuacrOS/oeaBr1xuICAgIGNvbnN0IGF1dGhvciA9IGNyZWF0ZUluZm8uYXV0aG9yIHx8IGF3YWl0IGdldEF1dGhvcigpO1xuXG4gICAgY29uc3QgbmFtZSA9IGNyZWF0ZUluZm8ubmFtZSB8fCBnZXRGYWxsYmFja0V4dGVuc2lvbk5hbWUoKTtcbiAgICBpZiAoaXNFeHRlbnNpb25OYW1lRXJyb3IobmFtZSkpIHtcbiAgICAgICAgcmVzcG9uc2Uuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICByZXNwb25zZS5tc2cgPSBgbmFtZSAke25hbWV9IGlzIG5vdCB2YWxpZGA7XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG5cbiAgICBjb25zdCBlZGl0b3JWZXJzaW9uID0gY3JlYXRlSW5mby5lZGl0b3JWZXJzaW9uIHx8IGdldEVkaXRvclZlcnNpb24oKTtcbiAgICBpZiAoaXNFZGl0b3JWZXJzaW9uRXJyb3IoZWRpdG9yVmVyc2lvbikpIHtcbiAgICAgICAgcmVzcG9uc2Uuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICByZXNwb25zZS5tc2cgPSBgZWRpdG9yIHZlcnNpb24gbGltaXQgJHtlZGl0b3JWZXJzaW9ufSBpcyBub3QgdmFsaWRgO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8g5Yqg6L295oyH5a6a55qE5qih5Z2X55qE5Yib5bu65pa55rOVXG4gICAgICAgIGNvbnN0IHBhdGggPSBub3JtYWxpemUodGVtcGxhdGUuY3JlYXRvcik7XG4gICAgICAgIGNvbnN0IGhhc0NhY2hlID0gISFyZXF1aXJlLmNhY2hlW3BhdGhdO1xuICAgICAgICBjb25zdCBidWlsZE1vZHVsZSA9IHJlcXVpcmUocGF0aCkgYXMgdW5rbm93biBhcyBFeHRlbnNpb25DcmVhdG9yO1xuICAgICAgICBpZiAoIWhhc0NhY2hlICYmIGJ1aWxkTW9kdWxlLmxvYWQpIHtcbiAgICAgICAgICAgIGJ1aWxkTW9kdWxlLmxvYWQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IFBBVEggPSB7XG4gICAgICAgICAgICAvLyDmqKHniYjmiYDlnKjkvY3nva5cbiAgICAgICAgICAgIGJhc2VUZW1wbGF0ZTogam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWMvZXh0ZW5zaW9uLXRlbXBsYXRlL3RlbXBsYXRlJyksXG4gICAgICAgICAgICAvLyDnm67moIfmj5Lku7bkvY3nva5cbiAgICAgICAgICAgIGRpc3Q6IGNyZWF0ZUluZm8uZGlzdCB8fCBnZXRFeHRlbnNpb25EaXN0KG5hbWUpLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIOaLt+i0neWfuuehgOaooeeJiCwg5Z+656GA5qih54mI5LyY5YWI57qn6auYXG4gICAgICAgIGF3YWl0IEVkaXRvci5VdGlscy5GaWxlLmNvcHkoUEFUSC5iYXNlVGVtcGxhdGUsIFBBVEguZGlzdCk7XG5cbiAgICAgICAgLy8g5aSN5Yi25rOo5YaM55qE5qih54mIXG4gICAgICAgIGF3YWl0IEVkaXRvci5VdGlscy5GaWxlLmNvcHkodGVtcGxhdGUucGF0aCwgUEFUSC5kaXN0KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8g6K+75Y+WIHBhY2thZ2UuanNvblxuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGVQYWNrYWdlUGF0aCA9IGpvaW4oUEFUSC5kaXN0LCAncGFja2FnZS5qc29uJyk7XG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZVBhY2thZ2VKU09OID0gYXdhaXQgcmVhZEpTT04odGVtcGxhdGVQYWNrYWdlUGF0aCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKU09OOiB7XG4gICAgICAgICAgICAgICAgW2tleTogc3RyaW5nXTogYW55O1xuICAgICAgICAgICAgfSA9IHtcbiAgICAgICAgICAgICAgICAkc2NoZW1hOiAnLi9AdHlwZXMvc2NoZW1hL3BhY2thZ2UvaW5kZXguanNvbicsXG4gICAgICAgICAgICAgICAgcGFja2FnZV92ZXJzaW9uOiAyLFxuICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgdmVyc2lvbjogJzEuMC4wJyxcbiAgICAgICAgICAgICAgICBhdXRob3I6IGF1dGhvciB8fCAnQ29jb3MgQ3JlYXRvciBEZXZlbG9wZXInLFxuICAgICAgICAgICAgICAgIGVkaXRvcjogZWRpdG9yVmVyc2lvbixcbiAgICAgICAgICAgICAgICBzY3JpcHRzOiB7XG4gICAgICAgICAgICAgICAgICAgIHByZWluc3RhbGw6ICdub2RlIC4vc2NyaXB0cy9wcmVpbnN0YWxsLmpzJyxcbiAgICAgICAgICAgICAgICAgICAgYnVpbGQ6ICd0c2MnLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0ZW1wbGF0ZVBhY2thZ2VKU09OKSB7XG4gICAgICAgICAgICAgICAgcGFja2FnZUpTT05ba2V5XSA9IHBhY2thZ2VKU09OW2tleV0gfHwgdGVtcGxhdGVQYWNrYWdlSlNPTltrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRlbXBsYXRlUGFja2FnZUpTT04uc2NyaXB0cykge1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRlbXBsYXRlUGFja2FnZUpTT04uc2NyaXB0cykge1xuICAgICAgICAgICAgICAgICAgICBwYWNrYWdlSlNPTi5zY3JpcHRzW2tleV0gPSB0ZW1wbGF0ZVBhY2thZ2VKU09OLnNjcmlwdHNba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghdGVtcGxhdGUucGF0aCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5jcmVhdGVfcGFja2FnZS5ub19wYXRoX3dhcm5pbmcnLCB7XG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZS5uYW1lLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDmiafooYzpkqnlrZBcbiAgICAgICAgICAgIGF3YWl0IGJ1aWxkTW9kdWxlLm1ldGhvZHMuY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBhdXRob3IsIG5hbWUsIGRpc3Q6IFBBVEguZGlzdCwgZWRpdG9yVmVyc2lvbiwgdGVtcGxhdGUsXG4gICAgICAgICAgICB9LCBwYWNrYWdlSlNPTik7XG5cbiAgICAgICAgICAgIGNvbnN0IGRldkRlcGVuZGVuY2llcyA9IHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcyB8fCB7fTtcbiAgICAgICAgICAgIGRldkRlcGVuZGVuY2llc1snQGNvY29zL2NyZWF0b3ItdHlwZXMnXSA9IGBeJHtFZGl0b3IuQXBwLnZlcnNpb259YDtcbiAgICAgICAgICAgIGRldkRlcGVuZGVuY2llc1snQHR5cGVzL25vZGUnXSA9ICdeMTguMTcuMSc7XG5cbiAgICAgICAgICAgIC8vIOmHjeaWsOaOkuW6j1xuICAgICAgICAgICAgcGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzID0ge307XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkZXZEZXBlbmRlbmNpZXMpLnNvcnQoKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgICAgcGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzW2tleV0gPSBkZXZEZXBlbmRlbmNpZXNba2V5XTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyDlpoLmnpzmlbDmja7lj5jljJbvvIzph43mlrDlhpnlhaXmlofku7ZcbiAgICAgICAgICAgIGF3YWl0IG91dHB1dEpTT04odGVtcGxhdGVQYWNrYWdlUGF0aCwgcGFja2FnZUpTT04sIHsgc3BhY2VzOiA0IH0pO1xuXG4gICAgICAgICAgICAvLyBnZW5lcmF0ZSB0eXBlc2NyaXB0IHR5cGVzXG4gICAgICAgICAgICBjb25zdCB0c1BhdGggPSBqb2luKFBBVEguZGlzdCwgJ25vZGVfbW9kdWxlcycpO1xuICAgICAgICAgICAgYXdhaXQgZW5zdXJlRGlyKHRzUGF0aCk7XG4gICAgICAgICAgICBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCd1dGlscycsICdleHBvcnQtZHRzJywgdHNQYXRoLCBmYWxzZSk7XG5cbiAgICAgICAgICAgIHJlc3BvbnNlLnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmVzcG9uc2Uuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5tc2cgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlWydzdGFjayddID0gZXJyb3Iuc3RhY2sgfHwgJyc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLm1zZyA9ICdjcmVhdGUgZXh0ZW5zaW9uIHRlbXBsYXRlIGZhaWwnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgICAgaWYgKGlzTG9hZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IEVkaXRvci5QYWNrYWdlLnJlZ2lzdGVyKFBBVEguZGlzdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjcmVhdGVJbmZvLnNob3dJbkZvbGRlciAmJiBjcmVhdGVJbmZvLmRpc3QpIHtcbiAgICAgICAgICAgICAgICBzaGVsbC5zaG93SXRlbUluRm9sZGVyKGNyZWF0ZUluZm8uZGlzdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfVxuICAgICAgICByZXNwb25zZS5tc2cgPSAnY3JlYXRlIGV4dGVuc2lvbiB0ZW1wbGF0ZSBmYWlsJztcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLm1zZyA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgICByZXNwb25zZVsnc3RhY2snXSA9IGVycm9yLnN0YWNrIHx8ICcnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzcG9uc2UubXNnID0gJ2NyZWF0ZSBleHRlbnNpb24gdGVtcGxhdGUgZmFpbCc7XG4gICAgICAgIH1cblxuICAgICAgICByZXNwb25zZS5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG59O1xuXG4iXX0=