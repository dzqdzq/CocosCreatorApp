"use strict";
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const packages = {
    methods: {
        async create(info) {
            if (!info.template.path) {
                console.warn(Editor.I18n.t('extension.create_package.no_path_warning').replace('${info.template.name}', info.template.name));
                return {
                    success: false,
                };
            }
            const tempPath = path_1.join(Editor.Project.tmpDir, 'extension/create', info.name);
            try {
                if (fs_extra_1.existsSync(tempPath)) {
                    fs_extra_1.removeSync(tempPath);
                }
                fs_extra_1.ensureDirSync(tempPath);
                Editor.Utils.File.copy(info.template.path, tempPath);
                const distPath = info.dist;
                // #region 处理package json 添加内容 以及替换 {name} 为插件名
                const tempPackageJsonPath = path_1.join(tempPath, 'package.json');
                const packageJSONString = await fs_extra_1.readFile(tempPackageJsonPath, { 'encoding': 'utf-8' });
                const packageJSON = JSON.parse(packageJSONString.replace(/{name}/g, info.name));
                const target = {
                    name: info.name,
                    package_version: 2,
                    version: '1.0.0',
                    author: info.author,
                    editor: info.editorVersion,
                };
                if (!packageJSON.scripts) {
                    target.scripts = {
                        build: 'tsc -b',
                        watch: 'tsc -w',
                    };
                }
                if (packageJSON.devDependencies?.typescript === undefined) {
                    packageJSON.devDependencies.typescript = '^4.3.4';
                }
                Object.assign(packageJSON, target);
                await fs_extra_1.writeJSON(tempPackageJsonPath, packageJSON, {
                    spaces: 4,
                });
                // #endregion
                // #region 处理readme 替换 {name} 为插件名
                const readMeCNPath = path_1.join(tempPath, 'README.zh-CN.md');
                const readMeENPath = path_1.join(tempPath, 'README.md');
                if (fs_extra_1.existsSync(readMeCNPath)) {
                    const file = await fs_extra_1.readFile(readMeCNPath, { 'encoding': 'utf-8' });
                    await fs_extra_1.writeFile(readMeCNPath, file.replace(/{name}/g, info.name));
                }
                if (fs_extra_1.existsSync(readMeENPath)) {
                    const file = await fs_extra_1.readFile(readMeENPath, { 'encoding': 'utf-8' });
                    await fs_extra_1.writeFile(readMeENPath, file.replace(/{name}/g, info.name));
                }
                // #endregion
                const mainFile = path_1.join(tempPath, packageJSON.main);
                if (!fs_extra_1.existsSync(mainFile)) {
                    const mainCode = `exports.load = function(){\n\tconsole.warn("${info.name} is not compiled yet.")\n}`;
                    await fs_extra_1.ensureDir(path_1.dirname(mainFile));
                    await fs_extra_1.writeFile(mainFile, mainCode);
                }
                await fs_extra_1.move(tempPath, distPath);
                // generate typescript types
                await Editor.Message.request('utils', 'export-dts', distPath, false);
                let fileDisplayedToFolder = '';
                const readmePath = path_1.join(distPath, 'README.md');
                const packageJsonPath = path_1.join(distPath, 'package.json');
                if (fs_extra_1.existsSync(readmePath)) {
                    fileDisplayedToFolder = readmePath;
                }
                else {
                    fileDisplayedToFolder = packageJsonPath;
                }
                return {
                    fileDisplayedToFolder,
                    success: true,
                };
            }
            catch (error) {
                return {
                    success: false,
                    error: (error instanceof Error) ? error : undefined,
                };
            }
            finally {
                try {
                    if (fs_extra_1.existsSync(tempPath)) {
                        await fs_extra_1.remove(tempPath);
                    }
                }
                catch (error) {
                    console.error(error);
                }
            }
        },
    },
};
module.exports = packages;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1leHRlbnNpb24tY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9icm93c2VyL2RlZmF1bHQtZXh0ZW5zaW9uLWNyZWF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHVDQUEwSDtBQUMxSCwrQkFBcUM7QUFHckMsTUFBTSxRQUFRLEdBQXFCO0lBQy9CLE9BQU8sRUFBRTtRQUNMLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSTtZQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBQztnQkFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQzdILE9BQU87b0JBQ0gsT0FBTyxFQUFFLEtBQUs7aUJBQ2pCLENBQUM7YUFDTDtZQUNELE1BQU0sUUFBUSxHQUFHLFdBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFNUUsSUFBSTtnQkFDQSxJQUFJLHFCQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQ3RCLHFCQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7aUJBQ3hCO2dCQUNELHdCQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBRXhCLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDckQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDM0IsK0NBQStDO2dCQUMvQyxNQUFNLG1CQUFtQixHQUFHLFdBQUksQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENB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SSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDL0MsTUFBTSxlQUFlLEdBQUcsV0FBSSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFDdkQsSUFBSSxxQkFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFO29CQUN4QixxQkFBcUIsR0FBRyxVQUFVLENBQUM7aUJBQ3RDO3FCQUFNO29CQUNILHFCQUFxQixHQUFHLGVBQWUsQ0FBQztpQkFDM0M7Z0JBQ0QsT0FBTztvQkFDSCxxQkFBcUI7b0JBQ3JCLE9BQU8sRUFBRSxJQUFJO2lCQUNoQixDQUFDO2FBQ0w7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixPQUFPO29CQUNILE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxDQUFDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTO2lCQUN0RCxDQUFDO2FBQ0w7b0JBQVM7Z0JBQ04sSUFBSTtvQkFDQSxJQUFJLHFCQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7d0JBQ3RCLE1BQU0saUJBQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztxQkFDMUI7aUJBQ0o7Z0JBQUMsT0FBTyxLQUFLLEVBQUU7b0JBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDeEI7YUFDSjtRQUNMLENBQUM7S0FDSjtDQUNKLENBQUM7QUFFRixpQkFBUyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbnN1cmVEaXIsIGVuc3VyZURpclN5bmMsIGV4aXN0c1N5bmMsIG1vdmUsIHJlYWRGaWxlLCByZW1vdmUsIHJlbW92ZVN5bmMsIHdyaXRlRmlsZSwgd3JpdGVKU09OIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgZGlybmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRXh0ZW5zaW9uQ3JlYXRvciB9IGZyb20gJy4uL3B1YmxpYy9pbnRlcmZhY2UnO1xuXG5jb25zdCBwYWNrYWdlczogRXh0ZW5zaW9uQ3JlYXRvciA9IHtcbiAgICBtZXRob2RzOiB7XG4gICAgICAgIGFzeW5jIGNyZWF0ZShpbmZvKSB7XG4gICAgICAgICAgICBpZiAoIWluZm8udGVtcGxhdGUucGF0aCl7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5jcmVhdGVfcGFja2FnZS5ub19wYXRoX3dhcm5pbmcnKS5yZXBsYWNlKCcke2luZm8udGVtcGxhdGUubmFtZX0nLCBpbmZvLnRlbXBsYXRlLm5hbWUpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdGVtcFBhdGggPSBqb2luKEVkaXRvci5Qcm9qZWN0LnRtcERpciwgJ2V4dGVuc2lvbi9jcmVhdGUnLCBpbmZvLm5hbWUpO1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmIChleGlzdHNTeW5jKHRlbXBQYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVTeW5jKHRlbXBQYXRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZW5zdXJlRGlyU3luYyh0ZW1wUGF0aCk7XG5cbiAgICAgICAgICAgICAgICBFZGl0b3IuVXRpbHMuRmlsZS5jb3B5KGluZm8udGVtcGxhdGUucGF0aCwgdGVtcFBhdGgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RQYXRoID0gaW5mby5kaXN0O1xuICAgICAgICAgICAgICAgIC8vICNyZWdpb24g5aSE55CGcGFja2FnZSBqc29uIOa3u+WKoOWGheWuuSDku6Xlj4rmm7/mjaIge25hbWV9IOS4uuaPkuS7tuWQjVxuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBQYWNrYWdlSnNvblBhdGggPSBqb2luKHRlbXBQYXRoLCAncGFja2FnZS5qc29uJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZUpTT05TdHJpbmcgPSBhd2FpdCByZWFkRmlsZSh0ZW1wUGFja2FnZUpzb25QYXRoLCB7ICdlbmNvZGluZyc6ICd1dGYtOCcgfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZUpTT04gPSBKU09OLnBhcnNlKHBhY2thZ2VKU09OU3RyaW5nLnJlcGxhY2UoL3tuYW1lfS9nLCBpbmZvLm5hbWUpKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQ6IGFueSA9IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogaW5mby5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBwYWNrYWdlX3ZlcnNpb246IDIsXG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb246ICcxLjAuMCcsIC8vIOiusOW9leaPkuS7tueahOeJiOacrOWPt1xuICAgICAgICAgICAgICAgICAgICBhdXRob3I6IGluZm8uYXV0aG9yLFxuICAgICAgICAgICAgICAgICAgICBlZGl0b3I6IGluZm8uZWRpdG9yVmVyc2lvbixcblxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgaWYgKCFwYWNrYWdlSlNPTi5zY3JpcHRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldC5zY3JpcHRzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnVpbGQ6ICd0c2MgLWInLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2g6ICd0c2MgLXcnLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzPy50eXBlc2NyaXB0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzLnR5cGVzY3JpcHQgPSAnXjQuMy40JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihwYWNrYWdlSlNPTiwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICBhd2FpdCB3cml0ZUpTT04odGVtcFBhY2thZ2VKc29uUGF0aCwgcGFja2FnZUpTT04sIHtcbiAgICAgICAgICAgICAgICAgICAgc3BhY2VzOiA0LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vICNlbmRyZWdpb25cbiAgICAgICAgICAgICAgICAvLyAjcmVnaW9uIOWkhOeQhnJlYWRtZSDmm7/mjaIge25hbWV9IOS4uuaPkuS7tuWQjVxuICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRNZUNOUGF0aCA9IGpvaW4odGVtcFBhdGgsICdSRUFETUUuemgtQ04ubWQnKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZWFkTWVFTlBhdGggPSBqb2luKHRlbXBQYXRoLCAnUkVBRE1FLm1kJyk7XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0c1N5bmMocmVhZE1lQ05QYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgcmVhZEZpbGUocmVhZE1lQ05QYXRoLCB7ICdlbmNvZGluZyc6ICd1dGYtOCcgfSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHdyaXRlRmlsZShyZWFkTWVDTlBhdGgsIGZpbGUucmVwbGFjZSgve25hbWV9L2csIGluZm8ubmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RzU3luYyhyZWFkTWVFTlBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCByZWFkRmlsZShyZWFkTWVFTlBhdGgsIHsgJ2VuY29kaW5nJzogJ3V0Zi04JyB9KTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgd3JpdGVGaWxlKHJlYWRNZUVOUGF0aCwgZmlsZS5yZXBsYWNlKC97bmFtZX0vZywgaW5mby5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vICNlbmRyZWdpb25cbiAgICAgICAgICAgICAgICBjb25zdCBtYWluRmlsZSA9IGpvaW4odGVtcFBhdGgsIHBhY2thZ2VKU09OLm1haW4pO1xuICAgICAgICAgICAgICAgIGlmICghZXhpc3RzU3luYyhtYWluRmlsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWFpbkNvZGUgPSBgZXhwb3J0cy5sb2FkID0gZnVuY3Rpb24oKXtcXG5cXHRjb25zb2xlLndhcm4oXCIke2luZm8ubmFtZX0gaXMgbm90IGNvbXBpbGVkIHlldC5cIilcXG59YDtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZW5zdXJlRGlyKGRpcm5hbWUobWFpbkZpbGUpKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgd3JpdGVGaWxlKG1haW5GaWxlLCBtYWluQ29kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGF3YWl0IG1vdmUodGVtcFBhdGgsIGRpc3RQYXRoKTtcblxuICAgICAgICAgICAgICAgIC8vIGdlbmVyYXRlIHR5cGVzY3JpcHQgdHlwZXNcbiAgICAgICAgICAgICAgICBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCd1dGlscycsICdleHBvcnQtZHRzJywgZGlzdFBhdGgsIGZhbHNlKTtcblxuICAgICAgICAgICAgICAgIGxldCBmaWxlRGlzcGxheWVkVG9Gb2xkZXIgPSAnJztcbiAgICAgICAgICAgICAgICBjb25zdCByZWFkbWVQYXRoID0gam9pbihkaXN0UGF0aCwgJ1JFQURNRS5tZCcpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKc29uUGF0aCA9IGpvaW4oZGlzdFBhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RzU3luYyhyZWFkbWVQYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICBmaWxlRGlzcGxheWVkVG9Gb2xkZXIgPSByZWFkbWVQYXRoO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVEaXNwbGF5ZWRUb0ZvbGRlciA9IHBhY2thZ2VKc29uUGF0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZURpc3BsYXllZFRvRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpID8gZXJyb3IgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0c1N5bmModGVtcFBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByZW1vdmUodGVtcFBhdGgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgIH0sXG59O1xuXG5leHBvcnQgPSBwYWNrYWdlczsiXX0=