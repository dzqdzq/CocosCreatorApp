"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.updateCliTemplatePackageJson=updateCliTemplatePackageJson,exports.createFromCli=createFromCli;const node_fs_1=require("node:fs"),node_path_1=require("node:path"),fs_extra_1=require("fs-extra"),node_child_process_1=require("node:child_process");function updateCliTemplatePackageJson(a){return new Promise((e,t)=>{try{var n=(0,node_path_1.join)(a.dist,"package.json"),o=JSON.parse((0,node_fs_1.readFileSync)(n,"utf-8"));o.author=a.author,(0,fs_extra_1.writeJSON)(n,o,{spaces:4}).then(e).catch(t)}catch(e){t(e)}})}function createFromCli(r){return new Promise((t,n)=>{if(!r.template.cliTemplateName)return n(new Error("template is not valid"));(0,fs_extra_1.ensureDirSync)((0,node_path_1.dirname)(r.dist));const o="win32"===process.platform?"npm.cmd":"npm";console.log("extension:",Editor.I18n.t("extension.create_npm_template.fetch"));var e=(0,node_child_process_1.spawn)(o,["create","cocos-plugin@latest",(0,node_path_1.basename)(r.dist),"--yes","--","--template",r.template.cliTemplateName],{shell:!0,cwd:(0,node_path_1.dirname)(r.dist)});let a="";e.stdout.on("data",e=>{a+=e.toString()}),e.on("close",async e=>{if(0!==e)return n(new Error("create cli template failed, code: "+e));a.includes("Scaffolding project in")?(console.log("extension:",Editor.I18n.t("extension.create_npm_template.install")),(0,node_child_process_1.spawn)(o,["install"],{shell:!0,cwd:r.dist}).on("close",e=>{if(0!==e)return n(new Error("install cli template failed, code: "+e));(0,node_child_process_1.spawn)(o,["run","build"],{shell:!0,cwd:r.dist}).on("close",e=>{if(0!==e)return n(new Error("build cli template failed, code: "+e));console.log("extension:",Editor.I18n.t("extension.create_npm_template.done")),updateCliTemplatePackageJson(r).then(t).catch(n)})})):n(new Error("create cli template failed, stdout: "+a))})})}