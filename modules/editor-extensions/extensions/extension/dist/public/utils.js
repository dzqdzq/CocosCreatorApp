'use strict';
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CancelError = exports.hasOwn = exports.isOnlineExtension = exports.sleep = exports.checkPackagePathType = exports.throttle = exports.formatDate = exports.recursive = exports.getPackageType = exports.handleUnexpectedImportError = exports.handleManualInstall = exports.handleInvalidPath = exports.handleCancelImport = exports.handleDecompressFail = exports.matchInternalName = exports.FAKE_AUTHOR_ID = exports.INTERNAL_EXTENSION_NAME = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
// FIXME: 使用 import 时需要额外配置 tsconfig。配置后使用 tsc 编译时， package.json 会被同步复制到 dist 目录，这一点不符合预期
// 暂时只能用 require
const packageJson = require('../../package.json');
/**
 * extension 插件自身的名称
 */
exports.INTERNAL_EXTENSION_NAME = packageJson.name;
exports.FAKE_AUTHOR_ID = -1;
/**
 * 判断指定包名是与扩展管理器的包名相同
 */
function matchInternalName(packageName) {
    return packageName === exports.INTERNAL_EXTENSION_NAME;
}
exports.matchInternalName = matchInternalName;
/**
 *
 * @param zipPath
 * @param extensionName
 * @param handleError 是否自己采用默认方法处理错误，否的话就会向上抛出
 */
async function handleDecompressFail(zipPath, extensionName, handleError) {
    // 自动安装失败
    const infoResult = await Editor.Dialog.info(Editor.I18n.t('extension.menu.decompressFail'), {
        cancel: 0,
        buttons: [Editor.I18n.t('extension.store.cancel'), Editor.I18n.t('extension.store.confirm')],
    });
    if (infoResult.response) {
        const saveResult = await Editor.Dialog.select({
            title: Editor.I18n.t('extension.menu.copyPackageTitle', { extensionName: extensionName + '.zip' }),
            type: 'directory',
        });
        if (saveResult.canceled) {
            if (handleError) {
                handleCancelImport();
            }
            else {
                throw new Error('cancel');
            }
        }
        else if (saveResult.filePaths[0]) {
            const targetPath = (0, path_1.join)(saveResult.filePaths[0], extensionName + '.zip');
            await Editor.Utils.File.copy(zipPath, targetPath);
            console.log(`[extension] copy ${extensionName}.zip to ${targetPath}`);
            if (handleError) {
                handleManualInstall();
            }
            else {
                throw new Error('manual install');
            }
        }
    }
    else {
        if (handleError) {
            handleCancelImport();
        }
        else {
            throw new Error('cancel');
        }
    }
}
exports.handleDecompressFail = handleDecompressFail;
function handleCancelImport() {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_cancel'),
        type: 'log',
        source: 'extension',
        timeout: 8000,
    });
}
exports.handleCancelImport = handleCancelImport;
function handleInvalidPath(path) {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.menu.invalidPath', { path }),
        type: 'error',
        source: 'extension',
        timeout: 8000,
    });
}
exports.handleInvalidPath = handleInvalidPath;
function handleManualInstall() {
    console.log(Editor.I18n.t('extension.store.install_manual_guide', { url: Editor.App.urls.manual }));
    // 用户在自动安装失败的时候选择了自己手动安装
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_manual_title'),
        message: Editor.I18n.t('extension.store.install_manual_content'),
        source: 'extension',
        type: 'warn',
    });
}
exports.handleManualInstall = handleManualInstall;
function handleUnexpectedImportError(error) {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_fail'),
        message: error?.message,
        type: 'error',
        source: 'extension',
        timeout: 10000,
    });
}
exports.handleUnexpectedImportError = handleUnexpectedImportError;
function getPackageType(path) {
    let type;
    if (Editor.Utils.Path.contains(Editor.App.path, path)) {
        type = 'internal';
    }
    else if (Editor.Utils.Path.contains(Editor.Project.path, path)) {
        type = 'project';
    }
    else if (Editor.Utils.Path.contains(Editor.App.home, path)) {
        type = 'global';
    }
    else {
        type = 'develop';
    }
    return type;
}
exports.getPackageType = getPackageType;
/**
 * 递归某个文件夹
 * @param dir
 * @param handle
 */
function recursive(dir, handle) {
    function step(file) {
        if (!(0, fs_extra_1.existsSync)(file)) {
            return;
        }
        const stat = (0, fs_extra_1.statSync)(file);
        if (stat.isDirectory()) {
            (0, fs_extra_1.readdirSync)(file).forEach((name) => {
                const child = (0, path_1.join)(file, name);
                step(child);
            });
        }
        else {
            handle(file);
        }
    }
    step(dir);
}
exports.recursive = recursive;
/**
 * 格式化时间， 默认将时间戳处理成yyyy-MM-dd
 * @param str 时间戳或者时间格式字符串
 * @param strFormat 返回的格式，支持 yyyy-MM-dd HH:mm:ss
 * @returns
 */
function formatDate(str, strFormat) {
    if (!str)
        return;
    if (!strFormat)
        strFormat = 'yyyy-MM-dd';
    switch (typeof str) {
        case 'string':
            str = new Date(str.replace(/-/g, '/'));
            break;
        case 'number':
            str = new Date(str);
            break;
    }
    if (str instanceof Date) {
        const dict = {
            yyyy: str.getFullYear(),
            M: str.getMonth() + 1,
            d: str.getDate(),
            H: str.getHours,
            m: str.getMinutes(),
            s: str.getSeconds(),
            MM: ('' + (str.getMonth() + 101)).substr(1),
            dd: ('' + (str.getDate() + 100)).substr(1),
            HH: ('' + (str.getHours() + 100)).substr(1),
            mm: ('' + (str.getMinutes() + 100)).substr(1),
            ss: ('' + (str.getSeconds() + 100)).substr(1),
        };
        return strFormat.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g, function (...args) {
            return dict[args[0]];
        });
    }
}
exports.formatDate = formatDate;
/**
 * 节流
 * @param func 要执行的函数
 * @param time 间隔时间 毫秒
 * @param immediate 是否要立即执行
 * @returns
 */
const throttle = (func, time, immediate = false) => {
    if (immediate) {
        let prevTime = 0;
        return (...args) => {
            const nowTime = Date.now();
            if (nowTime - prevTime >= time) {
                func.apply(this, args);
                prevTime = nowTime;
            }
        };
    }
    else {
        let timer = null;
        return (...args) => {
            if (!timer) {
                func.apply(this, args);
                timer = window.setTimeout(() => {
                    if (timer) {
                        clearTimeout(timer);
                    }
                    timer = null;
                }, time);
            }
        };
    }
};
exports.throttle = throttle;
function checkPackagePathType(path) {
    //@ts-ignore
    return Editor.Package.__protected__.checkType(path);
}
exports.checkPackagePathType = checkPackagePathType;
const sleep = (ms = 100) => {
    let abort = () => { };
    const p = new Promise((resovle, reject) => {
        const handle = window.setTimeout(() => {
            resovle();
        }, ms);
        abort = () => {
            window.clearTimeout(handle);
            reject(new Error('cancel'));
        };
    });
    p.abort = abort;
    return p;
};
exports.sleep = sleep;
/**
 * 判断一个插件是不是服务端插件（在服务端存在数据）
 */
function isOnlineExtension(item) {
    // 存在 latest_version 数据，判断是服务端存在的插件
    const keyLatestVersion = 'latest_version';
    return keyLatestVersion in item;
}
exports.isOnlineExtension = isOnlineExtension;
function hasOwn(thisArg, key) {
    return Object.prototype.hasOwnProperty.call(thisArg, key);
}
exports.hasOwn = hasOwn;
const cancelSymbol = Symbol.for('cancel');
class CancelError extends Error {
    constructor() {
        super(...arguments);
        this[_a] = true;
    }
    static isCancel(err) {
        return err instanceof Error && err[cancelSymbol] === true;
    }
}
exports.CancelError = CancelError;
_a = cancelSymbol;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvcHVibGljL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7OztBQUNiLHVDQUE2RDtBQUM3RCwrQkFBNEI7QUFHNUIseUZBQXlGO0FBQ3pGLGdCQUFnQjtBQUNoQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUVsRDs7R0FFRztBQUNVLFFBQUEsdUJBQXVCLEdBQVcsV0FBVyxDQUFDLElBQUksQ0FBQztBQUVuRCxRQUFBLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUVqQzs7R0FFRztBQUNILFNBQWdCLGlCQUFpQixDQUFDLFdBQW1CO0lBQ2pELE9BQU8sV0FBVyxLQUFLLCtCQUF1QixDQUFDO0FBQ25ELENBQUM7QUFGRCw4Q0FFQztBQUVEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLG9CQUFvQixDQUFDLE9BQWUsRUFBRSxhQUFxQixFQUFFLFdBQW9CO0lBQ25HLFNBQVM7SUFDVCxNQUFNLFVBQVUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEVBQUU7UUFDeEYsTUFBTSxFQUFFLENBQUM7UUFDVCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLENBQUM7S0FDL0YsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxVQUFVLENBQUMsUUFBUSxFQUFFO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDMUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGlDQUFpQyxFQUFFLEVBQUUsYUFBYSxFQUFFLGFBQWEsR0FBRyxNQUFNLEVBQUUsQ0FBQztZQUNsRyxJQUFJLEVBQUUsV0FBVztTQUNwQixDQUFDLENBQUM7UUFDSCxJQUFJLFVBQVUsQ0FBQyxRQUFRLEVBQUU7WUFDckIsSUFBSSxXQUFXLEVBQUU7Z0JBQ2Isa0JBQWtCLEVBQUUsQ0FBQzthQUN4QjtpQkFBTTtnQkFDSCxNQUFNLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzdCO1NBQ0o7YUFBTSxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDaEMsTUFBTSxVQUFVLEdBQUcsSUFBQSxXQUFJLEVBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxhQUFhLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFDekUsTUFBTSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ2xELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLGFBQWEsV0FBVyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLElBQUksV0FBVyxFQUFFO2dCQUNiLG1CQUFtQixFQUFFLENBQUM7YUFDekI7aUJBQU07Z0JBQ0gsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2FBQ3JDO1NBQ0o7S0FDSjtTQUFNO1FBQ0gsSUFBSSxXQUFXLEVBQUU7WUFDYixrQkFBa0IsRUFBRSxDQUFDO1NBQ3hCO2FBQU07WUFDSCxNQUFNLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzdCO0tBQ0o7QUFDTCxDQUFDO0FBbENELG9EQWtDQztBQUVELFNBQWdCLGtCQUFrQjtJQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNsQixLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsZ0NBQWdDLENBQUM7UUFDdEQsSUFBSSxFQUFFLEtBQUs7UUFDWCxNQUFNLEVBQUUsV0FBVztRQUNuQixPQUFPLEVBQUUsSUFBSTtLQUNoQixDQUFDLENBQUM7QUFDUCxDQUFDO0FBUEQsZ0RBT0M7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxJQUFZO0lBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ2xCLEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyw0QkFBNEIsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQzVELElBQUksRUFBRSxPQUFPO1FBQ2IsTUFBTSxFQUFFLFdBQVc7UUFDbkIsT0FBTyxFQUFFLElBQUk7S0FDaEIsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQVBELDhDQU9DO0FBRUQsU0FBZ0IsbUJBQW1CO0lBQy9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsc0NBQXNDLEVBQUUsRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BHLHdCQUF3QjtJQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNsQixLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsc0NBQXNDLENBQUM7UUFDNUQsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLHdDQUF3QyxDQUFDO1FBQ2hFLE1BQU0sRUFBRSxXQUFXO1FBQ25CLElBQUksRUFBRSxNQUFNO0tBQ2YsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQVRELGtEQVNDO0FBRUQsU0FBZ0IsMkJBQTJCLENBQUMsS0FBYTtJQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNsQixLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsOEJBQThCLENBQUM7UUFDcEQsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPO1FBQ3ZCLElBQUksRUFBRSxPQUFPO1FBQ2IsTUFBTSxFQUFFLFdBQVc7UUFDbkIsT0FBTyxFQUFFLEtBQUs7S0FDakIsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQVJELGtFQVFDO0FBQ0QsU0FBZ0IsY0FBYyxDQUFDLElBQVk7SUFDdkMsSUFBSSxJQUF5QixDQUFDO0lBQzlCLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFO1FBQ25ELElBQUksR0FBRyxVQUFVLENBQUM7S0FDckI7U0FBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRTtRQUM5RCxJQUFJLEdBQUcsU0FBUyxDQUFDO0tBQ3BCO1NBQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUU7UUFDMUQsSUFBSSxHQUFHLFFBQVEsQ0FBQztLQUNuQjtTQUFNO1FBQ0gsSUFBSSxHQUFHLFNBQVMsQ0FBQztLQUNwQjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFaRCx3Q0FZQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixTQUFTLENBQUMsR0FBVyxFQUFFLE1BQWdCO0lBQ25ELFNBQVMsSUFBSSxDQUFDLElBQVk7UUFDdEIsSUFBSSxDQUFDLElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsRUFBRTtZQUNuQixPQUFPO1NBQ1Y7UUFDRCxNQUFNLElBQUksR0FBRyxJQUFBLG1CQUFRLEVBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDcEIsSUFBQSxzQkFBVyxFQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVksRUFBRSxFQUFFO2dCQUN2QyxNQUFNLEtBQUssR0FBRyxJQUFBLFdBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztTQUNOO2FBQU07WUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEI7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsQ0FBQztBQWpCRCw4QkFpQkM7QUFFRDs7Ozs7R0FLRztBQUNILFNBQWdCLFVBQVUsQ0FBQyxHQUFRLEVBQUUsU0FBZTtJQUNoRCxJQUFJLENBQUMsR0FBRztRQUFFLE9BQU87SUFDakIsSUFBSSxDQUFDLFNBQVM7UUFBRSxTQUFTLEdBQUcsWUFBWSxDQUFDO0lBQ3pDLFFBQVEsT0FBTyxHQUFHLEVBQUU7UUFDaEIsS0FBSyxRQUFRO1lBQ1QsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkMsTUFBTTtRQUNWLEtBQUssUUFBUTtZQUNULEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQixNQUFNO0tBQ2I7SUFDRCxJQUFJLEdBQUcsWUFBWSxJQUFJLEVBQUU7UUFDckIsTUFBTSxJQUFJLEdBQVE7WUFDZCxJQUFJLEVBQUUsR0FBRyxDQUFDLFdBQVcsRUFBRTtZQUN2QixDQUFDLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUM7WUFDckIsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUU7WUFDaEIsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxRQUFRO1lBQ2YsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUU7WUFDbkIsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUU7WUFDbkIsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMzQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDM0MsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUM3QyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQ2hELENBQUM7UUFDRixPQUFPLFNBQVMsQ0FBQyxPQUFPLENBQUMsNkJBQTZCLEVBQUUsVUFBUyxHQUFHLElBQVc7WUFDM0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7S0FDTjtBQUNMLENBQUM7QUE3QkQsZ0NBNkJDO0FBRUQ7Ozs7OztHQU1HO0FBQ0ksTUFBTSxRQUFRLEdBQUcsQ0FBQyxJQUEyQixFQUFFLElBQVksRUFBRSxTQUFTLEdBQUcsS0FBSyxFQUFFLEVBQUU7SUFDckYsSUFBSSxTQUFTLEVBQUU7UUFDWCxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDakIsT0FBTyxDQUFDLEdBQUcsSUFBUyxFQUFFLEVBQUU7WUFDcEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLElBQUksT0FBTyxHQUFHLFFBQVEsSUFBSSxJQUFJLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN2QixRQUFRLEdBQUcsT0FBTyxDQUFDO2FBQ3RCO1FBQ0wsQ0FBQyxDQUFDO0tBQ0w7U0FBTTtRQUNILElBQUksS0FBSyxHQUFrQixJQUFJLENBQUM7UUFDaEMsT0FBTyxDQUFDLEdBQUcsSUFBUyxFQUFFLEVBQUU7WUFDcEIsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDUixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDdkIsS0FBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO29CQUMzQixJQUFJLEtBQUssRUFBRTt3QkFDUCxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7cUJBQ3ZCO29CQUNELEtBQUssR0FBRyxJQUFJLENBQUM7Z0JBQ2pCLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUNaO1FBQ0wsQ0FBQyxDQUFDO0tBQ0w7QUFDTCxDQUFDLENBQUM7QUF4QlcsUUFBQSxRQUFRLFlBd0JuQjtBQUVGLFNBQWdCLG9CQUFvQixDQUFDLElBQVk7SUFDN0MsWUFBWTtJQUNaLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFIRCxvREFHQztBQUVNLE1BQU0sS0FBSyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsRUFBRSxFQUFFO0lBQzlCLElBQUksS0FBSyxHQUFHLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQztJQUVyQixNQUFNLENBQUMsR0FBRyxJQUFJLE9BQU8sQ0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM1QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNsQyxPQUFPLEVBQUUsQ0FBQztRQUNkLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNQLEtBQUssR0FBRyxHQUFHLEVBQUU7WUFDVCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQztJQUNOLENBQUMsQ0FLQSxDQUFDO0lBRUYsQ0FBQyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFFaEIsT0FBTyxDQUFDLENBQUM7QUFDYixDQUFDLENBQUM7QUFyQlcsUUFBQSxLQUFLLFNBcUJoQjtBQUVGOztHQUVHO0FBQ0gsU0FBZ0IsaUJBQWlCLENBQUMsSUFBbUI7SUFDakQsbUNBQW1DO0lBQ25DLE1BQU0sZ0JBQWdCLEdBQThCLGdCQUFnQixDQUFDO0lBRXJFLE9BQU8sZ0JBQWdCLElBQUksSUFBSSxDQUFDO0FBQ3BDLENBQUM7QUFMRCw4Q0FLQztBQUVELFNBQWdCLE1BQU0sQ0FBQyxPQUFnQixFQUFFLEdBQWdCO0lBQ3JELE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztBQUM5RCxDQUFDO0FBRkQsd0JBRUM7QUFFRCxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFDLE1BQWEsV0FBWSxTQUFRLEtBQUs7SUFBdEM7O1FBSUksUUFBYyxHQUFHLElBQUksQ0FBQztJQUMxQixDQUFDO0lBSkcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFZO1FBQ3hCLE9BQU8sR0FBRyxZQUFZLEtBQUssSUFBSyxHQUFXLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxDQUFDO0lBQ3ZFLENBQUM7Q0FFSjtBQUxELGtDQUtDO0tBREksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRkaXJTeW5jLCBzdGF0U3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBhY2thZ2VJbmZvLCBQYWNrYWdlUGF0aFR5cGUsIEV4dGVuc2lvbkl0ZW1PbmxpbmUsIEV4dGVuc2lvbkl0ZW0gfSBmcm9tICcuL2ludGVyZmFjZSc7XG5cbi8vIEZJWE1FOiDkvb/nlKggaW1wb3J0IOaXtumcgOimgemineWklumFjee9riB0c2NvbmZpZ+OAgumFjee9ruWQjuS9v+eUqCB0c2Mg57yW6K+R5pe277yMIHBhY2thZ2UuanNvbiDkvJrooqvlkIzmraXlpI3liLbliLAgZGlzdCDnm67lvZXvvIzov5nkuIDngrnkuI3nrKblkIjpooTmnJ9cbi8vIOaaguaXtuWPquiDveeUqCByZXF1aXJlXG5jb25zdCBwYWNrYWdlSnNvbiA9IHJlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpO1xuXG4vKipcbiAqIGV4dGVuc2lvbiDmj5Lku7boh6rouqvnmoTlkI3np7BcbiAqL1xuZXhwb3J0IGNvbnN0IElOVEVSTkFMX0VYVEVOU0lPTl9OQU1FOiBzdHJpbmcgPSBwYWNrYWdlSnNvbi5uYW1lO1xuXG5leHBvcnQgY29uc3QgRkFLRV9BVVRIT1JfSUQgPSAtMTtcblxuLyoqXG4gKiDliKTmlq3mjIflrprljIXlkI3mmK/kuI7mianlsZXnrqHnkIblmajnmoTljIXlkI3nm7jlkIxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoSW50ZXJuYWxOYW1lKHBhY2thZ2VOYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGFja2FnZU5hbWUgPT09IElOVEVSTkFMX0VYVEVOU0lPTl9OQU1FO1xufVxuXG4vKipcbiAqXG4gKiBAcGFyYW0gemlwUGF0aFxuICogQHBhcmFtIGV4dGVuc2lvbk5hbWVcbiAqIEBwYXJhbSBoYW5kbGVFcnJvciDmmK/lkKboh6rlt7Hph4fnlKjpu5jorqTmlrnms5XlpITnkIbplJnor6/vvIzlkKbnmoTor53lsLHkvJrlkJHkuIrmipvlh7pcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZURlY29tcHJlc3NGYWlsKHppcFBhdGg6IHN0cmluZywgZXh0ZW5zaW9uTmFtZTogc3RyaW5nLCBoYW5kbGVFcnJvcjogYm9vbGVhbikge1xuICAgIC8vIOiHquWKqOWuieijheWksei0pVxuICAgIGNvbnN0IGluZm9SZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLmluZm8oRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUuZGVjb21wcmVzc0ZhaWwnKSwge1xuICAgICAgICBjYW5jZWw6IDAsXG4gICAgICAgIGJ1dHRvbnM6IFtFZGl0b3IuSTE4bi50KCdleHRlbnNpb24uc3RvcmUuY2FuY2VsJyksIEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5jb25maXJtJyldLFxuICAgIH0pO1xuICAgIGlmIChpbmZvUmVzdWx0LnJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IHNhdmVSZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLnNlbGVjdCh7XG4gICAgICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUuY29weVBhY2thZ2VUaXRsZScsIHsgZXh0ZW5zaW9uTmFtZTogZXh0ZW5zaW9uTmFtZSArICcuemlwJyB9KSxcbiAgICAgICAgICAgIHR5cGU6ICdkaXJlY3RvcnknLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHNhdmVSZXN1bHQuY2FuY2VsZWQpIHtcbiAgICAgICAgICAgIGlmIChoYW5kbGVFcnJvcikge1xuICAgICAgICAgICAgICAgIGhhbmRsZUNhbmNlbEltcG9ydCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbmNlbCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHNhdmVSZXN1bHQuZmlsZVBhdGhzWzBdKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRQYXRoID0gam9pbihzYXZlUmVzdWx0LmZpbGVQYXRoc1swXSwgZXh0ZW5zaW9uTmFtZSArICcuemlwJyk7XG4gICAgICAgICAgICBhd2FpdCBFZGl0b3IuVXRpbHMuRmlsZS5jb3B5KHppcFBhdGgsIHRhcmdldFBhdGgpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFtleHRlbnNpb25dIGNvcHkgJHtleHRlbnNpb25OYW1lfS56aXAgdG8gJHt0YXJnZXRQYXRofWApO1xuICAgICAgICAgICAgaWYgKGhhbmRsZUVycm9yKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlTWFudWFsSW5zdGFsbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21hbnVhbCBpbnN0YWxsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaGFuZGxlRXJyb3IpIHtcbiAgICAgICAgICAgIGhhbmRsZUNhbmNlbEltcG9ydCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWwnKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZUNhbmNlbEltcG9ydCgpIHtcbiAgICBFZGl0b3IuVGFzay5hZGROb3RpY2Uoe1xuICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLnN0b3JlLmluc3RhbGxfY2FuY2VsJyksXG4gICAgICAgIHR5cGU6ICdsb2cnLFxuICAgICAgICBzb3VyY2U6ICdleHRlbnNpb24nLFxuICAgICAgICB0aW1lb3V0OiA4MDAwLFxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlSW52YWxpZFBhdGgocGF0aDogc3RyaW5nKSB7XG4gICAgRWRpdG9yLlRhc2suYWRkTm90aWNlKHtcbiAgICAgICAgdGl0bGU6IEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5tZW51LmludmFsaWRQYXRoJywgeyBwYXRoIH0pLFxuICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICBzb3VyY2U6ICdleHRlbnNpb24nLFxuICAgICAgICB0aW1lb3V0OiA4MDAwLFxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlTWFudWFsSW5zdGFsbCgpIHtcbiAgICBjb25zb2xlLmxvZyhFZGl0b3IuSTE4bi50KCdleHRlbnNpb24uc3RvcmUuaW5zdGFsbF9tYW51YWxfZ3VpZGUnLCB7IHVybDogRWRpdG9yLkFwcC51cmxzLm1hbnVhbCB9KSk7XG4gICAgLy8g55So5oi35Zyo6Ieq5Yqo5a6J6KOF5aSx6LSl55qE5pe25YCZ6YCJ5oup5LqG6Ieq5bex5omL5Yqo5a6J6KOFXG4gICAgRWRpdG9yLlRhc2suYWRkTm90aWNlKHtcbiAgICAgICAgdGl0bGU6IEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5pbnN0YWxsX21hbnVhbF90aXRsZScpLFxuICAgICAgICBtZXNzYWdlOiBFZGl0b3IuSTE4bi50KCdleHRlbnNpb24uc3RvcmUuaW5zdGFsbF9tYW51YWxfY29udGVudCcpLFxuICAgICAgICBzb3VyY2U6ICdleHRlbnNpb24nLFxuICAgICAgICB0eXBlOiAnd2FybicsXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVVbmV4cGVjdGVkSW1wb3J0RXJyb3IoZXJyb3I/OiBFcnJvcikge1xuICAgIEVkaXRvci5UYXNrLmFkZE5vdGljZSh7XG4gICAgICAgIHRpdGxlOiBFZGl0b3IuSTE4bi50KCdleHRlbnNpb24uc3RvcmUuaW5zdGFsbF9mYWlsJyksXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yPy5tZXNzYWdlLFxuICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICBzb3VyY2U6ICdleHRlbnNpb24nLFxuICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICB9KTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYWNrYWdlVHlwZShwYXRoOiBzdHJpbmcpIHtcbiAgICBsZXQgdHlwZTogUGFja2FnZUluZm9bJ3R5cGUnXTtcbiAgICBpZiAoRWRpdG9yLlV0aWxzLlBhdGguY29udGFpbnMoRWRpdG9yLkFwcC5wYXRoLCBwYXRoKSkge1xuICAgICAgICB0eXBlID0gJ2ludGVybmFsJztcbiAgICB9IGVsc2UgaWYgKEVkaXRvci5VdGlscy5QYXRoLmNvbnRhaW5zKEVkaXRvci5Qcm9qZWN0LnBhdGgsIHBhdGgpKSB7XG4gICAgICAgIHR5cGUgPSAncHJvamVjdCc7XG4gICAgfSBlbHNlIGlmIChFZGl0b3IuVXRpbHMuUGF0aC5jb250YWlucyhFZGl0b3IuQXBwLmhvbWUsIHBhdGgpKSB7XG4gICAgICAgIHR5cGUgPSAnZ2xvYmFsJztcbiAgICB9IGVsc2Uge1xuICAgICAgICB0eXBlID0gJ2RldmVsb3AnO1xuICAgIH1cbiAgICByZXR1cm4gdHlwZTtcbn1cblxuLyoqXG4gKiDpgJLlvZLmn5DkuKrmlofku7blpLlcbiAqIEBwYXJhbSBkaXJcbiAqIEBwYXJhbSBoYW5kbGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlY3Vyc2l2ZShkaXI6IHN0cmluZywgaGFuZGxlOiBGdW5jdGlvbikge1xuICAgIGZ1bmN0aW9uIHN0ZXAoZmlsZTogc3RyaW5nKSB7XG4gICAgICAgIGlmICghZXhpc3RzU3luYyhmaWxlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0YXQgPSBzdGF0U3luYyhmaWxlKTtcbiAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgcmVhZGRpclN5bmMoZmlsZSkuZm9yRWFjaCgobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBqb2luKGZpbGUsIG5hbWUpO1xuICAgICAgICAgICAgICAgIHN0ZXAoY2hpbGQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBoYW5kbGUoZmlsZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGVwKGRpcik7XG59XG5cbi8qKlxuICog5qC85byP5YyW5pe26Ze077yMIOm7mOiupOWwhuaXtumXtOaIs+WkhOeQhuaIkHl5eXktTU0tZGRcbiAqIEBwYXJhbSBzdHIg5pe26Ze05oiz5oiW6ICF5pe26Ze05qC85byP5a2X56ym5LiyXG4gKiBAcGFyYW0gc3RyRm9ybWF0IOi/lOWbnueahOagvOW8j++8jOaUr+aMgSB5eXl5LU1NLWRkIEhIOm1tOnNzXG4gKiBAcmV0dXJuc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RGF0ZShzdHI6IGFueSwgc3RyRm9ybWF0PzogYW55KSB7XG4gICAgaWYgKCFzdHIpIHJldHVybjtcbiAgICBpZiAoIXN0ckZvcm1hdCkgc3RyRm9ybWF0ID0gJ3l5eXktTU0tZGQnO1xuICAgIHN3aXRjaCAodHlwZW9mIHN0cikge1xuICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgc3RyID0gbmV3IERhdGUoc3RyLnJlcGxhY2UoLy0vZywgJy8nKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgIHN0ciA9IG5ldyBEYXRlKHN0cik7XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKHN0ciBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgY29uc3QgZGljdDogYW55ID0ge1xuICAgICAgICAgICAgeXl5eTogc3RyLmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICBNOiBzdHIuZ2V0TW9udGgoKSArIDEsXG4gICAgICAgICAgICBkOiBzdHIuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgSDogc3RyLmdldEhvdXJzLFxuICAgICAgICAgICAgbTogc3RyLmdldE1pbnV0ZXMoKSxcbiAgICAgICAgICAgIHM6IHN0ci5nZXRTZWNvbmRzKCksXG4gICAgICAgICAgICBNTTogKCcnICsgKHN0ci5nZXRNb250aCgpICsgMTAxKSkuc3Vic3RyKDEpLFxuICAgICAgICAgICAgZGQ6ICgnJyArIChzdHIuZ2V0RGF0ZSgpICsgMTAwKSkuc3Vic3RyKDEpLFxuICAgICAgICAgICAgSEg6ICgnJyArIChzdHIuZ2V0SG91cnMoKSArIDEwMCkpLnN1YnN0cigxKSxcbiAgICAgICAgICAgIG1tOiAoJycgKyAoc3RyLmdldE1pbnV0ZXMoKSArIDEwMCkpLnN1YnN0cigxKSxcbiAgICAgICAgICAgIHNzOiAoJycgKyAoc3RyLmdldFNlY29uZHMoKSArIDEwMCkpLnN1YnN0cigxKSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHN0ckZvcm1hdC5yZXBsYWNlKC8oeXl5eXxNTT98ZGQ/fEhIP3xzcz98bW0/KS9nLCBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICAgICAgcmV0dXJuIGRpY3RbYXJnc1swXV07XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiDoioLmtYFcbiAqIEBwYXJhbSBmdW5jIOimgeaJp+ihjOeahOWHveaVsFxuICogQHBhcmFtIHRpbWUg6Ze06ZqU5pe26Ze0IOavq+enklxuICogQHBhcmFtIGltbWVkaWF0ZSDmmK/lkKbopoHnq4vljbPmiafooYxcbiAqIEByZXR1cm5zXG4gKi9cbmV4cG9ydCBjb25zdCB0aHJvdHRsZSA9IChmdW5jOiAoLi4uYXJnczogYW55KSA9PiBhbnksIHRpbWU6IG51bWJlciwgaW1tZWRpYXRlID0gZmFsc2UpID0+IHtcbiAgICBpZiAoaW1tZWRpYXRlKSB7XG4gICAgICAgIGxldCBwcmV2VGltZSA9IDA7XG4gICAgICAgIHJldHVybiAoLi4uYXJnczogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBub3dUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIGlmIChub3dUaW1lIC0gcHJldlRpbWUgPj0gdGltZSkge1xuICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgICAgICAgICAgcHJldlRpbWUgPSBub3dUaW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCB0aW1lcjogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gICAgICAgIHJldHVybiAoLi4uYXJnczogYW55KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRpbWVyKSB7XG4gICAgICAgICAgICAgICAgZnVuYy5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgICAgICB0aW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9LCB0aW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tQYWNrYWdlUGF0aFR5cGUocGF0aDogc3RyaW5nKTogUGFja2FnZVBhdGhUeXBlIHtcbiAgICAvL0B0cy1pZ25vcmVcbiAgICByZXR1cm4gRWRpdG9yLlBhY2thZ2UuX19wcm90ZWN0ZWRfXy5jaGVja1R5cGUocGF0aCk7XG59XG5cbmV4cG9ydCBjb25zdCBzbGVlcCA9IChtcyA9IDEwMCkgPT4ge1xuICAgIGxldCBhYm9ydCA9ICgpID0+IHt9O1xuXG4gICAgY29uc3QgcCA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvdmxlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgaGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgcmVzb3ZsZSgpO1xuICAgICAgICB9LCBtcyk7XG4gICAgICAgIGFib3J0ID0gKCkgPT4ge1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChoYW5kbGUpO1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignY2FuY2VsJykpO1xuICAgICAgICB9O1xuICAgIH0pIGFzIFByb21pc2U8dm9pZD4gJiB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBjYW5jZWwgc2xlZXAgYW5kIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZFxuICAgICAgICAgKi9cbiAgICAgICAgYWJvcnQoKTogdm9pZDtcbiAgICB9O1xuXG4gICAgcC5hYm9ydCA9IGFib3J0O1xuXG4gICAgcmV0dXJuIHA7XG59O1xuXG4vKipcbiAqIOWIpOaWreS4gOS4quaPkuS7tuaYr+S4jeaYr+acjeWKoeerr+aPkuS7tu+8iOWcqOacjeWKoeerr+WtmOWcqOaVsOaNru+8iVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNPbmxpbmVFeHRlbnNpb24oaXRlbTogRXh0ZW5zaW9uSXRlbSk6IGl0ZW0gaXMgRXh0ZW5zaW9uSXRlbU9ubGluZSB7XG4gICAgLy8g5a2Y5ZyoIGxhdGVzdF92ZXJzaW9uIOaVsOaNru+8jOWIpOaWreaYr+acjeWKoeerr+WtmOWcqOeahOaPkuS7tlxuICAgIGNvbnN0IGtleUxhdGVzdFZlcnNpb246IGtleW9mIEV4dGVuc2lvbkl0ZW1PbmxpbmUgPSAnbGF0ZXN0X3ZlcnNpb24nO1xuXG4gICAgcmV0dXJuIGtleUxhdGVzdFZlcnNpb24gaW4gaXRlbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc093bih0aGlzQXJnOiB1bmtub3duLCBrZXk6IFByb3BlcnR5S2V5KSB7XG4gICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzQXJnLCBrZXkpO1xufVxuXG5jb25zdCBjYW5jZWxTeW1ib2wgPSBTeW1ib2wuZm9yKCdjYW5jZWwnKTtcbmV4cG9ydCBjbGFzcyBDYW5jZWxFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgICBzdGF0aWMgaXNDYW5jZWwoZXJyOiB1bmtub3duKTogZXJyIGlzIENhbmNlbEVycm9yIHtcbiAgICAgICAgcmV0dXJuIGVyciBpbnN0YW5jZW9mIEVycm9yICYmIChlcnIgYXMgYW55KVtjYW5jZWxTeW1ib2xdID09PSB0cnVlO1xuICAgIH1cbiAgICBbY2FuY2VsU3ltYm9sXSA9IHRydWU7XG59XG4iXX0=