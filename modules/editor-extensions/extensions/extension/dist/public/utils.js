'use strict';
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CancelError = exports.hasOwn = exports.isOnlineExtension = exports.sleep = exports.checkPackagePathType = exports.throttle = exports.formatDate = exports.recursive = exports.getPackageType = exports.handleUnexpectedImportError = exports.handleManualInstall = exports.handleInvalidPath = exports.handleCancelImport = exports.handleDecompressFail = exports.matchInternalName = exports.FAKE_AUTHOR_ID = exports.INTERNAL_EXTENSION_NAME = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
// FIXME: 使用 import 时需要额外配置 tsconfig。配置后使用 tsc 编译时， package.json 会被同步复制到 dist 目录，这一点不符合预期
// 暂时只能用 require
const packageJson = require('../../package.json');
/**
 * extension 插件自身的名称
 */
exports.INTERNAL_EXTENSION_NAME = packageJson.name;
exports.FAKE_AUTHOR_ID = -1;
/**
 * 判断指定包名是与扩展管理器的包名相同
 */
function matchInternalName(packageName) {
    return packageName === exports.INTERNAL_EXTENSION_NAME;
}
exports.matchInternalName = matchInternalName;
/**
 *
 * @param zipPath
 * @param extensionName
 * @param handleError 是否自己采用默认方法处理错误，否的话就会向上抛出
 */
async function handleDecompressFail(zipPath, extensionName, handleError) {
    // 自动安装失败
    const infoResult = await Editor.Dialog.info(Editor.I18n.t('extension.menu.decompressFail'), {
        cancel: 0,
        buttons: [Editor.I18n.t('extension.store.cancel'), Editor.I18n.t('extension.store.confirm')],
    });
    if (infoResult.response) {
        const saveResult = await Editor.Dialog.select({
            title: Editor.I18n.t('extension.menu.copyPackageTitle', { extensionName: extensionName + '.zip' }),
            type: 'directory',
        });
        if (saveResult.canceled) {
            if (handleError) {
                handleCancelImport();
            }
            else {
                throw new Error('cancel');
            }
        }
        else if (saveResult.filePaths[0]) {
            const targetPath = path_1.join(saveResult.filePaths[0], extensionName + '.zip');
            await Editor.Utils.File.copy(zipPath, targetPath);
            console.log(`[extension] copy ${extensionName}.zip to ${targetPath}`);
            if (handleError) {
                handleManualInstall();
            }
            else {
                throw new Error('manual install');
            }
        }
    }
    else {
        if (handleError) {
            handleCancelImport();
        }
        else {
            throw new Error('cancel');
        }
    }
}
exports.handleDecompressFail = handleDecompressFail;
function handleCancelImport() {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_cancel'),
        type: 'log',
        source: 'extension',
        timeout: 8000,
    });
}
exports.handleCancelImport = handleCancelImport;
function handleInvalidPath(path) {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.menu.invalidPath', { path }),
        type: 'error',
        source: 'extension',
        timeout: 8000,
    });
}
exports.handleInvalidPath = handleInvalidPath;
function handleManualInstall() {
    console.log(Editor.I18n.t('extension.store.install_manual_guide', { url: Editor.App.urls.manual }));
    // 用户在自动安装失败的时候选择了自己手动安装
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_manual_title'),
        message: Editor.I18n.t('extension.store.install_manual_content'),
        source: 'extension',
        type: 'warn',
    });
}
exports.handleManualInstall = handleManualInstall;
function handleUnexpectedImportError(error) {
    Editor.Task.addNotice({
        title: Editor.I18n.t('extension.store.install_fail'),
        message: error?.message,
        type: 'error',
        source: 'extension',
        timeout: 10000,
    });
}
exports.handleUnexpectedImportError = handleUnexpectedImportError;
function getPackageType(path) {
    let type;
    if (Editor.Utils.Path.contains(Editor.App.path, path)) {
        type = 'internal';
    }
    else if (Editor.Utils.Path.contains(Editor.Project.path, path)) {
        type = 'project';
    }
    else if (Editor.Utils.Path.contains(Editor.App.home, path)) {
        type = 'global';
    }
    else {
        type = 'develop';
    }
    return type;
}
exports.getPackageType = getPackageType;
/**
 * 递归某个文件夹
 * @param dir
 * @param handle
 */
function recursive(dir, handle) {
    function step(file) {
        if (!fs_extra_1.existsSync(file)) {
            return;
        }
        const stat = fs_extra_1.statSync(file);
        if (stat.isDirectory()) {
            fs_extra_1.readdirSync(file).forEach((name) => {
                const child = path_1.join(file, name);
                step(child);
            });
        }
        else {
            handle(file);
        }
    }
    step(dir);
}
exports.recursive = recursive;
/**
 * 格式化时间， 默认将时间戳处理成yyyy-MM-dd
 * @param str 时间戳或者时间格式字符串
 * @param strFormat 返回的格式，支持 yyyy-MM-dd HH:mm:ss
 * @returns
 */
function formatDate(str, strFormat) {
    if (!str)
        return;
    if (!strFormat)
        strFormat = 'yyyy-MM-dd';
    switch (typeof str) {
        case 'string':
            str = new Date(str.replace(/-/g, '/'));
            break;
        case 'number':
            str = new Date(str);
            break;
    }
    if (str instanceof Date) {
        const dict = {
            yyyy: str.getFullYear(),
            M: str.getMonth() + 1,
            d: str.getDate(),
            H: str.getHours,
            m: str.getMinutes(),
            s: str.getSeconds(),
            MM: ('' + (str.getMonth() + 101)).substr(1),
            dd: ('' + (str.getDate() + 100)).substr(1),
            HH: ('' + (str.getHours() + 100)).substr(1),
            mm: ('' + (str.getMinutes() + 100)).substr(1),
            ss: ('' + (str.getSeconds() + 100)).substr(1),
        };
        return strFormat.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g, function (...args) {
            return dict[args[0]];
        });
    }
}
exports.formatDate = formatDate;
/**
 * 节流
 * @param func 要执行的函数
 * @param time 间隔时间 毫秒
 * @param immediate 是否要立即执行
 * @returns
 */
const throttle = (func, time, immediate = false) => {
    if (immediate) {
        let prevTime = 0;
        return (...args) => {
            const nowTime = Date.now();
            if (nowTime - prevTime >= time) {
                func.apply(this, args);
                prevTime = nowTime;
            }
        };
    }
    else {
        let timer = null;
        return (...args) => {
            if (!timer) {
                func.apply(this, args);
                timer = window.setTimeout(() => {
                    if (timer) {
                        clearTimeout(timer);
                    }
                    timer = null;
                }, time);
            }
        };
    }
};
exports.throttle = throttle;
function checkPackagePathType(path) {
    //@ts-ignore
    return Editor.Package.__protected__.checkType(path);
}
exports.checkPackagePathType = checkPackagePathType;
const sleep = (ms = 100) => {
    let abort = () => { };
    const p = new Promise((resovle, reject) => {
        const handle = window.setTimeout(() => {
            resovle();
        }, ms);
        abort = () => {
            window.clearTimeout(handle);
            reject(new Error('cancel'));
        };
    });
    p.abort = abort;
    return p;
};
exports.sleep = sleep;
/**
 * 判断一个插件是不是服务端插件（在服务端存在数据）
 */
function isOnlineExtension(item) {
    // 存在 latest_version 数据，判断是服务端存在的插件
    const keyLatestVersion = 'latest_version';
    return keyLatestVersion in item;
}
exports.isOnlineExtension = isOnlineExtension;
function hasOwn(thisArg, key) {
    return Object.prototype.hasOwnProperty.call(thisArg, key);
}
exports.hasOwn = hasOwn;
const cancelSymbol = Symbol.for('cancel');
class CancelError extends Error {
    constructor() {
        super(...arguments);
        this[_a] = true;
    }
    static isCancel(err) {
        return err instanceof Error && err[cancelSymbol] === true;
    }
}
exports.CancelError = CancelError;
_a = cancelSymbol;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvcHVibGljL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7OztBQUNiLHVDQUE2RDtBQUM3RCwrQkFBNEI7QUFHNUIseUZBQXlGO0FBQ3pGLGdCQUFnQjtBQUNoQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUVsRDs7R0FFRztBQUNVLFFBQUEsdUJBQXVCLEdBQVcsV0FBVyxDQUFDLElBQUksQ0FBQztBQUVuRCxRQUFBLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUVqQzs7R0FFRztBQUNILFNBQWdCLGlCQUFpQixDQUFDLFdBQW1CO0lBQ2pELE9BQU8sV0FBVyxLQUFLLCtCQUF1QixDQUFDO0FBQ25ELENBQUM7QUFGRCw4Q0FFQztBQUVEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLG9CQUFvQixDQUFDLE9BQWUsRUFBRSxhQUFxQixFQUFFLFdBQW9CO0lBQ25HLFNBQVM7SUFDVCxNQUFNLFVBQVUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLCtCQUErQixDQUFDLEVBQUU7UUFDeEYsTUFBTSxFQUFFLENBQUM7UUFDVCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLENBQUM7S0FDL0YsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxVQUFVLENBQUMsUUFBUSxFQUFFO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDMUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGlDQUFpQyxFQUFFLEVBQUUsYUFB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SUFFRixDQUFDLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUVoQixPQUFPLENBQUMsQ0FBQztBQUNiLENBQUMsQ0FBQztBQXJCVyxRQUFBLEtBQUssU0FxQmhCO0FBRUY7O0dBRUc7QUFDSCxTQUFnQixpQkFBaUIsQ0FBQyxJQUFtQjtJQUNqRCxtQ0FBbUM7SUFDbkMsTUFBTSxnQkFBZ0IsR0FBOEIsZ0JBQWdCLENBQUM7SUFFckUsT0FBTyxnQkFBZ0IsSUFBSSxJQUFJLENBQUM7QUFDcEMsQ0FBQztBQUxELDhDQUtDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLE9BQWdCLEVBQUUsR0FBZ0I7SUFDckQsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzlELENBQUM7QUFGRCx3QkFFQztBQUVELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUMsTUFBYSxXQUFZLFNBQVEsS0FBSztJQUF0Qzs7UUFJSSxRQUFjLEdBQUcsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFKRyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQVk7UUFDeEIsT0FBTyxHQUFHLFlBQVksS0FBSyxJQUFLLEdBQVcsQ0FBQyxZQUFZLENBQUMsS0FBSyxJQUFJLENBQUM7SUFDdkUsQ0FBQztDQUVKO0FBTEQsa0NBS0M7S0FESSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IHsgZXhpc3RzU3luYywgcmVhZGRpclN5bmMsIHN0YXRTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgUGFja2FnZUluZm8sIFBhY2thZ2VQYXRoVHlwZSwgRXh0ZW5zaW9uSXRlbU9ubGluZSwgRXh0ZW5zaW9uSXRlbSB9IGZyb20gJy4vaW50ZXJmYWNlJztcblxuLy8gRklYTUU6IOS9v+eUqCBpbXBvcnQg5pe26ZyA6KaB6aKd5aSW6YWN572uIHRzY29uZmln44CC6YWN572u5ZCO5L2/55SoIHRzYyDnvJbor5Hml7bvvIwgcGFja2FnZS5qc29uIOS8muiiq+WQjOatpeWkjeWItuWIsCBkaXN0IOebruW9le+8jOi/meS4gOeCueS4jeespuWQiOmihOacn1xuLy8g5pqC5pe25Y+q6IO955SoIHJlcXVpcmVcbmNvbnN0IHBhY2thZ2VKc29uID0gcmVxdWlyZSgnLi4vLi4vcGFja2FnZS5qc29uJyk7XG5cbi8qKlxuICogZXh0ZW5zaW9uIOaPkuS7tuiHqui6q+eahOWQjeensFxuICovXG5leHBvcnQgY29uc3QgSU5URVJOQUxfRVhURU5TSU9OX05BTUU6IHN0cmluZyA9IHBhY2thZ2VKc29uLm5hbWU7XG5cbmV4cG9ydCBjb25zdCBGQUtFX0FVVEhPUl9JRCA9IC0xO1xuXG4vKipcbiAqIOWIpOaWreaMh+WumuWMheWQjeaYr+S4juaJqeWxleeuoeeQhuWZqOeahOWMheWQjeebuOWQjFxuICovXG5leHBvcnQgZnVuY3Rpb24gbWF0Y2hJbnRlcm5hbE5hbWUocGFja2FnZU5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiBwYWNrYWdlTmFtZSA9PT0gSU5URVJOQUxfRVhURU5TSU9OX05BTUU7XG59XG5cbi8qKlxuICpcbiAqIEBwYXJhbSB6aXBQYXRoXG4gKiBAcGFyYW0gZXh0ZW5zaW9uTmFtZVxuICogQHBhcmFtIGhhbmRsZUVycm9yIOaYr+WQpuiHquW3semHh+eUqOm7mOiupOaWueazleWkhOeQhumUmeivr++8jOWQpueahOivneWwseS8muWQkeS4iuaKm+WHulxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlRGVjb21wcmVzc0ZhaWwoemlwUGF0aDogc3RyaW5nLCBleHRlbnNpb25OYW1lOiBzdHJpbmcsIGhhbmRsZUVycm9yOiBib29sZWFuKSB7XG4gICAgLy8g6Ieq5Yqo5a6J6KOF5aSx6LSlXG4gICAgY29uc3QgaW5mb1Jlc3VsdCA9IGF3YWl0IEVkaXRvci5EaWFsb2cuaW5mbyhFZGl0b3IuSTE4bi50KCdleHRlbnNpb24ubWVudS5kZWNvbXByZXNzRmFpbCcpLCB7XG4gICAgICAgIGNhbmNlbDogMCxcbiAgICAgICAgYnV0dG9uczogW0VkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5jYW5jZWwnKSwgRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLnN0b3JlLmNvbmZpcm0nKV0sXG4gICAgfSk7XG4gICAgaWYgKGluZm9SZXN1bHQucmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3Qgc2F2ZVJlc3VsdCA9IGF3YWl0IEVkaXRvci5EaWFsb2cuc2VsZWN0KHtcbiAgICAgICAgICAgIHRpdGxlOiBFZGl0b3IuSTE4bi50KCdleHRlbnNpb24ubWVudS5jb3B5UGFja2FnZVRpdGxlJywgeyBleHRlbnNpb25OYW1lOiBleHRlbnNpb25OYW1lICsgJy56aXAnIH0pLFxuICAgICAgICAgICAgdHlwZTogJ2RpcmVjdG9yeScsXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoc2F2ZVJlc3VsdC5jYW5jZWxlZCkge1xuICAgICAgICAgICAgaWYgKGhhbmRsZUVycm9yKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlQ2FuY2VsSW1wb3J0KCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignY2FuY2VsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoc2F2ZVJlc3VsdC5maWxlUGF0aHNbMF0pIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFBhdGggPSBqb2luKHNhdmVSZXN1bHQuZmlsZVBhdGhzWzBdLCBleHRlbnNpb25OYW1lICsgJy56aXAnKTtcbiAgICAgICAgICAgIGF3YWl0IEVkaXRvci5VdGlscy5GaWxlLmNvcHkoemlwUGF0aCwgdGFyZ2V0UGF0aCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW2V4dGVuc2lvbl0gY29weSAke2V4dGVuc2lvbk5hbWV9LnppcCB0byAke3RhcmdldFBhdGh9YCk7XG4gICAgICAgICAgICBpZiAoaGFuZGxlRXJyb3IpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVNYW51YWxJbnN0YWxsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbWFudWFsIGluc3RhbGwnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChoYW5kbGVFcnJvcikge1xuICAgICAgICAgICAgaGFuZGxlQ2FuY2VsSW1wb3J0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbmNlbCcpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlQ2FuY2VsSW1wb3J0KCkge1xuICAgIEVkaXRvci5UYXNrLmFkZE5vdGljZSh7XG4gICAgICAgIHRpdGxlOiBFZGl0b3IuSTE4bi50KCdleHRlbnNpb24uc3RvcmUuaW5zdGFsbF9jYW5jZWwnKSxcbiAgICAgICAgdHlwZTogJ2xvZycsXG4gICAgICAgIHNvdXJjZTogJ2V4dGVuc2lvbicsXG4gICAgICAgIHRpbWVvdXQ6IDgwMDAsXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVJbnZhbGlkUGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgICBFZGl0b3IuVGFzay5hZGROb3RpY2Uoe1xuICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLm1lbnUuaW52YWxpZFBhdGgnLCB7IHBhdGggfSksXG4gICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgIHNvdXJjZTogJ2V4dGVuc2lvbicsXG4gICAgICAgIHRpbWVvdXQ6IDgwMDAsXG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVNYW51YWxJbnN0YWxsKCkge1xuICAgIGNvbnNvbGUubG9nKEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5pbnN0YWxsX21hbnVhbF9ndWlkZScsIHsgdXJsOiBFZGl0b3IuQXBwLnVybHMubWFudWFsIH0pKTtcbiAgICAvLyDnlKjmiLflnKjoh6rliqjlronoo4XlpLHotKXnmoTml7blgJnpgInmi6nkuoboh6rlt7HmiYvliqjlronoo4VcbiAgICBFZGl0b3IuVGFzay5hZGROb3RpY2Uoe1xuICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnZXh0ZW5zaW9uLnN0b3JlLmluc3RhbGxfbWFudWFsX3RpdGxlJyksXG4gICAgICAgIG1lc3NhZ2U6IEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5pbnN0YWxsX21hbnVhbF9jb250ZW50JyksXG4gICAgICAgIHNvdXJjZTogJ2V4dGVuc2lvbicsXG4gICAgICAgIHR5cGU6ICd3YXJuJyxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZVVuZXhwZWN0ZWRJbXBvcnRFcnJvcihlcnJvcj86IEVycm9yKSB7XG4gICAgRWRpdG9yLlRhc2suYWRkTm90aWNlKHtcbiAgICAgICAgdGl0bGU6IEVkaXRvci5JMThuLnQoJ2V4dGVuc2lvbi5zdG9yZS5pbnN0YWxsX2ZhaWwnKSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3I/Lm1lc3NhZ2UsXG4gICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgIHNvdXJjZTogJ2V4dGVuc2lvbicsXG4gICAgICAgIHRpbWVvdXQ6IDEwMDAwLFxuICAgIH0pO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhY2thZ2VUeXBlKHBhdGg6IHN0cmluZykge1xuICAgIGxldCB0eXBlOiBQYWNrYWdlSW5mb1sndHlwZSddO1xuICAgIGlmIChFZGl0b3IuVXRpbHMuUGF0aC5jb250YWlucyhFZGl0b3IuQXBwLnBhdGgsIHBhdGgpKSB7XG4gICAgICAgIHR5cGUgPSAnaW50ZXJuYWwnO1xuICAgIH0gZWxzZSBpZiAoRWRpdG9yLlV0aWxzLlBhdGguY29udGFpbnMoRWRpdG9yLlByb2plY3QucGF0aCwgcGF0aCkpIHtcbiAgICAgICAgdHlwZSA9ICdwcm9qZWN0JztcbiAgICB9IGVsc2UgaWYgKEVkaXRvci5VdGlscy5QYXRoLmNvbnRhaW5zKEVkaXRvci5BcHAuaG9tZSwgcGF0aCkpIHtcbiAgICAgICAgdHlwZSA9ICdnbG9iYWwnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHR5cGUgPSAnZGV2ZWxvcCc7XG4gICAgfVxuICAgIHJldHVybiB0eXBlO1xufVxuXG4vKipcbiAqIOmAkuW9kuafkOS4quaWh+S7tuWkuVxuICogQHBhcmFtIGRpclxuICogQHBhcmFtIGhhbmRsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVjdXJzaXZlKGRpcjogc3RyaW5nLCBoYW5kbGU6IEZ1bmN0aW9uKSB7XG4gICAgZnVuY3Rpb24gc3RlcChmaWxlOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCFleGlzdHNTeW5jKGZpbGUpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RhdCA9IHN0YXRTeW5jKGZpbGUpO1xuICAgICAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICByZWFkZGlyU3luYyhmaWxlKS5mb3JFYWNoKChuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZCA9IGpvaW4oZmlsZSwgbmFtZSk7XG4gICAgICAgICAgICAgICAgc3RlcChjaGlsZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhhbmRsZShmaWxlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0ZXAoZGlyKTtcbn1cblxuLyoqXG4gKiDmoLzlvI/ljJbml7bpl7TvvIwg6buY6K6k5bCG5pe26Ze05oiz5aSE55CG5oiQeXl5eS1NTS1kZFxuICogQHBhcmFtIHN0ciDml7bpl7TmiLPmiJbogIXml7bpl7TmoLzlvI/lrZfnrKbkuLJcbiAqIEBwYXJhbSBzdHJGb3JtYXQg6L+U5Zue55qE5qC85byP77yM5pSv5oyBIHl5eXktTU0tZGQgSEg6bW06c3NcbiAqIEByZXR1cm5zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXREYXRlKHN0cjogYW55LCBzdHJGb3JtYXQ/OiBhbnkpIHtcbiAgICBpZiAoIXN0cikgcmV0dXJuO1xuICAgIGlmICghc3RyRm9ybWF0KSBzdHJGb3JtYXQgPSAneXl5eS1NTS1kZCc7XG4gICAgc3dpdGNoICh0eXBlb2Ygc3RyKSB7XG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICBzdHIgPSBuZXcgRGF0ZShzdHIucmVwbGFjZSgvLS9nLCAnLycpKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICAgICAgc3RyID0gbmV3IERhdGUoc3RyKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoc3RyIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBjb25zdCBkaWN0OiBhbnkgPSB7XG4gICAgICAgICAgICB5eXl5OiBzdHIuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgIE06IHN0ci5nZXRNb250aCgpICsgMSxcbiAgICAgICAgICAgIGQ6IHN0ci5nZXREYXRlKCksXG4gICAgICAgICAgICBIOiBzdHIuZ2V0SG91cnMsXG4gICAgICAgICAgICBtOiBzdHIuZ2V0TWludXRlcygpLFxuICAgICAgICAgICAgczogc3RyLmdldFNlY29uZHMoKSxcbiAgICAgICAgICAgIE1NOiAoJycgKyAoc3RyLmdldE1vbnRoKCkgKyAxMDEpKS5zdWJzdHIoMSksXG4gICAgICAgICAgICBkZDogKCcnICsgKHN0ci5nZXREYXRlKCkgKyAxMDApKS5zdWJzdHIoMSksXG4gICAgICAgICAgICBISDogKCcnICsgKHN0ci5nZXRIb3VycygpICsgMTAwKSkuc3Vic3RyKDEpLFxuICAgICAgICAgICAgbW06ICgnJyArIChzdHIuZ2V0TWludXRlcygpICsgMTAwKSkuc3Vic3RyKDEpLFxuICAgICAgICAgICAgc3M6ICgnJyArIChzdHIuZ2V0U2Vjb25kcygpICsgMTAwKSkuc3Vic3RyKDEpLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gc3RyRm9ybWF0LnJlcGxhY2UoLyh5eXl5fE1NP3xkZD98SEg/fHNzP3xtbT8pL2csIGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgICAgICByZXR1cm4gZGljdFthcmdzWzBdXTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG4vKipcbiAqIOiKgua1gVxuICogQHBhcmFtIGZ1bmMg6KaB5omn6KGM55qE5Ye95pWwXG4gKiBAcGFyYW0gdGltZSDpl7TpmpTml7bpl7Qg5q+r56eSXG4gKiBAcGFyYW0gaW1tZWRpYXRlIOaYr+WQpuimgeeri+WNs+aJp+ihjFxuICogQHJldHVybnNcbiAqL1xuZXhwb3J0IGNvbnN0IHRocm90dGxlID0gKGZ1bmM6ICguLi5hcmdzOiBhbnkpID0+IGFueSwgdGltZTogbnVtYmVyLCBpbW1lZGlhdGUgPSBmYWxzZSkgPT4ge1xuICAgIGlmIChpbW1lZGlhdGUpIHtcbiAgICAgICAgbGV0IHByZXZUaW1lID0gMDtcbiAgICAgICAgcmV0dXJuICguLi5hcmdzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vd1RpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgaWYgKG5vd1RpbWUgLSBwcmV2VGltZSA+PSB0aW1lKSB7XG4gICAgICAgICAgICAgICAgZnVuYy5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgICAgICBwcmV2VGltZSA9IG5vd1RpbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHRpbWVyOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgICAgICAgcmV0dXJuICguLi5hcmdzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGlmICghdGltZXIpIHtcbiAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICAgICAgICAgIHRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGltZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBudWxsO1xuICAgICAgICAgICAgICAgIH0sIHRpbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGVja1BhY2thZ2VQYXRoVHlwZShwYXRoOiBzdHJpbmcpOiBQYWNrYWdlUGF0aFR5cGUge1xuICAgIC8vQHRzLWlnbm9yZVxuICAgIHJldHVybiBFZGl0b3IuUGFja2FnZS5fX3Byb3RlY3RlZF9fLmNoZWNrVHlwZShwYXRoKTtcbn1cblxuZXhwb3J0IGNvbnN0IHNsZWVwID0gKG1zID0gMTAwKSA9PiB7XG4gICAgbGV0IGFib3J0ID0gKCkgPT4ge307XG5cbiAgICBjb25zdCBwID0gbmV3IFByb21pc2U8dm9pZD4oKHJlc292bGUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBoYW5kbGUgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICByZXNvdmxlKCk7XG4gICAgICAgIH0sIG1zKTtcbiAgICAgICAgYWJvcnQgPSAoKSA9PiB7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGhhbmRsZSk7XG4gICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdjYW5jZWwnKSk7XG4gICAgICAgIH07XG4gICAgfSkgYXMgUHJvbWlzZTx2b2lkPiAmIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIGNhbmNlbCBzbGVlcCBhbmQgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkXG4gICAgICAgICAqL1xuICAgICAgICBhYm9ydCgpOiB2b2lkO1xuICAgIH07XG5cbiAgICBwLmFib3J0ID0gYWJvcnQ7XG5cbiAgICByZXR1cm4gcDtcbn07XG5cbi8qKlxuICog5Yik5pat5LiA5Liq5o+S5Lu25piv5LiN5piv5pyN5Yqh56uv5o+S5Lu277yI5Zyo5pyN5Yqh56uv5a2Y5Zyo5pWw5o2u77yJXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc09ubGluZUV4dGVuc2lvbihpdGVtOiBFeHRlbnNpb25JdGVtKTogaXRlbSBpcyBFeHRlbnNpb25JdGVtT25saW5lIHtcbiAgICAvLyDlrZjlnKggbGF0ZXN0X3ZlcnNpb24g5pWw5o2u77yM5Yik5pat5piv5pyN5Yqh56uv5a2Y5Zyo55qE5o+S5Lu2XG4gICAgY29uc3Qga2V5TGF0ZXN0VmVyc2lvbjoga2V5b2YgRXh0ZW5zaW9uSXRlbU9ubGluZSA9ICdsYXRlc3RfdmVyc2lvbic7XG5cbiAgICByZXR1cm4ga2V5TGF0ZXN0VmVyc2lvbiBpbiBpdGVtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzT3duKHRoaXNBcmc6IHVua25vd24sIGtleTogUHJvcGVydHlLZXkpIHtcbiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXNBcmcsIGtleSk7XG59XG5cbmNvbnN0IGNhbmNlbFN5bWJvbCA9IFN5bWJvbC5mb3IoJ2NhbmNlbCcpO1xuZXhwb3J0IGNsYXNzIENhbmNlbEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAgIHN0YXRpYyBpc0NhbmNlbChlcnI6IHVua25vd24pOiBlcnIgaXMgQ2FuY2VsRXJyb3Ige1xuICAgICAgICByZXR1cm4gZXJyIGluc3RhbmNlb2YgRXJyb3IgJiYgKGVyciBhcyBhbnkpW2NhbmNlbFN5bWJvbF0gPT09IHRydWU7XG4gICAgfVxuICAgIFtjYW5jZWxTeW1ib2xdID0gdHJ1ZTtcbn1cbiJdfQ==