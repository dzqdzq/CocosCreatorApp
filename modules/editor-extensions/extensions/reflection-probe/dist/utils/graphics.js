"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.saveDataToImage = exports.flipImage = exports.readPixels = void 0;
const cc_1 = require("cc");
const fs_extra_1 = require("fs-extra");
const sharp_1 = __importDefault(require("sharp"));
const path_1 = require("path");
/**
 * @engineInternal
 * @param rt
 * @returns
 */
function readPixels(rt) {
    const width = rt.width;
    const height = rt.height;
    const needSize = 4 * width * height;
    const buffer = new Uint8Array(needSize);
    const gfxTexture = rt.getGFXTexture();
    if (!gfxTexture) {
        return null;
    }
    const gfxDevice = cc_1.gfx.deviceManager.gfxDevice;
    const bufferViews = [];
    const regions = [];
    const region0 = new cc_1.gfx.BufferTextureCopy();
    region0.texOffset.x = 0;
    region0.texOffset.y = 0;
    region0.texExtent.width = rt.width;
    region0.texExtent.height = rt.height;
    regions.push(region0);
    bufferViews.push(buffer);
    gfxDevice?.copyTextureToBuffers(gfxTexture, bufferViews, regions);
    return buffer;
}
exports.readPixels = readPixels;
function flipImage(data, width, height) {
    if (!data) {
        return null;
    }
    const newData = new Uint8Array(data.length);
    for (let i = 0; i < height; i++) {
        for (let j = 0; j < width; j++) {
            const index = (width * i + j) * 4;
            const newIndex = (width * (height - i - 1) + j) * 4;
            newData[newIndex] = data[index];
            newData[newIndex + 1] = data[index + 1];
            newData[newIndex + 2] = data[index + 2];
            newData[newIndex + 3] = data[index + 3];
        }
    }
    return newData;
}
exports.flipImage = flipImage;
async function saveDataToImage(data, width, height, sceneName, fileName) {
    let fullPath = '';
    // eslint-disable-next-line no-async-promise-executor
    await new Promise(async (resolve, reject) => {
        const assetPath = await Editor.Message.request('asset-db', 'query-path', 'db://assets');
        if (assetPath === null) {
            return;
        }
        const scenePath = (0, path_1.join)(assetPath, sceneName);
        if (!(0, fs_extra_1.existsSync)(scenePath)) {
            (0, fs_extra_1.mkdirSync)(scenePath);
        }
        fullPath = (0, path_1.join)(scenePath, fileName);
        const image = (0, sharp_1.default)(data, { raw: { width: width, height: height, channels: 4 } });
        image.toFile(fullPath)
            .then(async () => {
            resolve();
        })
            .catch((err) => {
            reject(err);
        });
    });
}
exports.saveDataToImage = saveDataToImage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdXRpbHMvZ3JhcGhpY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMkJBQXdDO0FBQ3hDLHVDQUFpRDtBQUNqRCxrREFBMEI7QUFDMUIsK0JBQTRCO0FBRTVCOzs7O0dBSUc7QUFDSCxTQUFnQixVQUFVLENBQUMsRUFBaUI7SUFDeEMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztJQUN2QixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBRXpCLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO0lBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXhDLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN0QyxJQUFJLENBQUMsVUFBVSxFQUFFO1FBQ2IsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELE1BQU0sU0FBUyxHQUFHLFFBQUcsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBRTlDLE1BQU0sV0FBVyxHQUFzQixFQUFFLENBQUM7SUFDMUMsTUFBTSxPQUFPLEdBQTRCLEVBQUUsQ0FBQztJQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLFFBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzVDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDeEIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztJQUNuQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBQ3JDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxD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Q2hCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBdEJELDBDQXNCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlbmRlclRleHR1cmUsIGdmeCB9IGZyb20gJ2NjJztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIG1rZGlyU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBzaGFycCBmcm9tICdzaGFycCc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5cbi8qKlxuICogQGVuZ2luZUludGVybmFsXG4gKiBAcGFyYW0gcnQgXG4gKiBAcmV0dXJucyBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlYWRQaXhlbHMocnQ6IFJlbmRlclRleHR1cmUpOiBVaW50OEFycmF5IHwgbnVsbCB7XG4gICAgY29uc3Qgd2lkdGggPSBydC53aWR0aDtcbiAgICBjb25zdCBoZWlnaHQgPSBydC5oZWlnaHQ7XG5cbiAgICBjb25zdCBuZWVkU2l6ZSA9IDQgKiB3aWR0aCAqIGhlaWdodDtcbiAgICBjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShuZWVkU2l6ZSk7XG5cbiAgICBjb25zdCBnZnhUZXh0dXJlID0gcnQuZ2V0R0ZYVGV4dHVyZSgpO1xuICAgIGlmICghZ2Z4VGV4dHVyZSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBnZnhEZXZpY2UgPSBnZnguZGV2aWNlTWFuYWdlci5nZnhEZXZpY2U7XG5cbiAgICBjb25zdCBidWZmZXJWaWV3czogQXJyYXlCdWZmZXJWaWV3W10gPSBbXTtcbiAgICBjb25zdCByZWdpb25zOiBnZnguQnVmZmVyVGV4dHVyZUNvcHlbXSA9IFtdO1xuXG4gICAgY29uc3QgcmVnaW9uMCA9IG5ldyBnZnguQnVmZmVyVGV4dHVyZUNvcHkoKTtcbiAgICByZWdpb24wLnRleE9mZnNldC54ID0gMDtcbiAgICByZWdpb24wLnRleE9mZnNldC55ID0gMDtcbiAgICByZWdpb24wLnRleEV4dGVudC53aWR0aCA9IHJ0LndpZHRoO1xuICAgIHJlZ2lvbjAudGV4RXh0ZW50LmhlaWdodCA9IHJ0LmhlaWdodDtcbiAgICByZWdpb25zLnB1c2gocmVnaW9uMCk7XG5cbiAgICBidWZmZXJWaWV3cy5wdXNoKGJ1ZmZlcik7XG4gICAgZ2Z4RGV2aWNlPy5jb3B5VGV4dHVyZVRvQnVmZmVycyhnZnhUZXh0dXJlLCBidWZmZXJWaWV3cywgcmVnaW9ucyk7XG4gICAgcmV0dXJuIGJ1ZmZlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZsaXBJbWFnZShkYXRhOiBVaW50OEFycmF5IHwgbnVsbCwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IG5ld0RhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmxlbmd0aCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWlnaHQ7IGkrKykge1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHdpZHRoOyBqKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gKHdpZHRoICogaSArIGopICogNDtcbiAgICAgICAgICAgIGNvbnN0IG5ld0luZGV4ID0gKHdpZHRoICogKGhlaWdodCAtIGkgLSAxKSArIGopICogNDtcbiAgICAgICAgICAgIG5ld0RhdGFbbmV3SW5kZXhdID0gZGF0YVtpbmRleF07XG4gICAgICAgICAgICBuZXdEYXRhW25ld0luZGV4ICsgMV0gPSBkYXRhW2luZGV4ICsgMV07XG4gICAgICAgICAgICBuZXdEYXRhW25ld0luZGV4ICsgMl0gPSBkYXRhW2luZGV4ICsgMl07XG4gICAgICAgICAgICBuZXdEYXRhW25ld0luZGV4ICsgM10gPSBkYXRhW2luZGV4ICsgM107XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ld0RhdGE7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlRGF0YVRvSW1hZ2UoZGF0YTogQnVmZmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgc2NlbmVOYW1lOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgZnVsbFBhdGggPSAnJztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXN5bmMtcHJvbWlzZS1leGVjdXRvclxuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgYXNzZXRQYXRoID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnYXNzZXQtZGInLCAncXVlcnktcGF0aCcsICdkYjovL2Fzc2V0cycpO1xuICAgICAgICBpZiAoYXNzZXRQYXRoID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2NlbmVQYXRoID0gam9pbihhc3NldFBhdGgsIHNjZW5lTmFtZSk7XG4gICAgICAgIGlmICghZXhpc3RzU3luYyhzY2VuZVBhdGgpKSB7XG4gICAgICAgICAgICBta2RpclN5bmMoc2NlbmVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBmdWxsUGF0aCA9IGpvaW4oc2NlbmVQYXRoLCBmaWxlTmFtZSk7XG4gICAgICAgIGNvbnN0IGltYWdlID0gc2hhcnAoZGF0YSwgeyByYXc6IHsgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCwgY2hhbm5lbHM6IDQgfSB9KTtcbiAgICAgICAgaW1hZ2UudG9GaWxlKGZ1bGxQYXRoKVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0pO1xufVxuIl19