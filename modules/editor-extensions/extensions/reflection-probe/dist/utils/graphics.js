"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.saveDataToImage = exports.flipImage = exports.readPixels = void 0;
const cc_1 = require("cc");
const fs_extra_1 = require("fs-extra");
const sharp_1 = __importDefault(require("sharp"));
const path_1 = require("path");
/**
 * @engineInternal
 * @param rt
 * @returns
 */
function readPixels(rt) {
    const width = rt.width;
    const height = rt.height;
    const needSize = 4 * width * height;
    const buffer = new Uint8Array(needSize);
    const gfxTexture = rt.getGFXTexture();
    if (!gfxTexture) {
        return null;
    }
    const gfxDevice = cc_1.gfx.deviceManager.gfxDevice;
    const bufferViews = [];
    const regions = [];
    const region0 = new cc_1.gfx.BufferTextureCopy();
    region0.texOffset.x = 0;
    region0.texOffset.y = 0;
    region0.texExtent.width = rt.width;
    region0.texExtent.height = rt.height;
    regions.push(region0);
    bufferViews.push(buffer);
    gfxDevice?.copyTextureToBuffers(gfxTexture, bufferViews, regions);
    return buffer;
}
exports.readPixels = readPixels;
function flipImage(data, width, height) {
    if (!data) {
        return null;
    }
    const newData = new Uint8Array(data.length);
    for (let i = 0; i < height; i++) {
        for (let j = 0; j < width; j++) {
            const index = (width * i + j) * 4;
            const newIndex = (width * (height - i - 1) + j) * 4;
            newData[newIndex] = data[index];
            newData[newIndex + 1] = data[index + 1];
            newData[newIndex + 2] = data[index + 2];
            newData[newIndex + 3] = data[index + 3];
        }
    }
    return newData;
}
exports.flipImage = flipImage;
async function saveDataToImage(data, width, height, sceneName, fileName) {
    let fullPath = '';
    // eslint-disable-next-line no-async-promise-executor
    await new Promise(async (resolve, reject) => {
        const assetPath = await Editor.Message.request('asset-db', 'query-path', 'db://assets');
        if (assetPath === null) {
            return;
        }
        const scenePath = path_1.join(assetPath, sceneName);
        if (!fs_extra_1.existsSync(scenePath)) {
            fs_extra_1.mkdirSync(scenePath);
        }
        fullPath = path_1.join(scenePath, fileName);
        const image = sharp_1.default(data, { raw: { width: width, height: height, channels: 4 } });
        image.toFile(fullPath)
            .then(async () => {
            resolve();
        })
            .catch((err) => {
            reject(err);
        });
    });
}
exports.saveDataToImage = saveDataToImage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGhpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdXRpbHMvZ3JhcGhpY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMkJBQXdDO0FBQ3hDLHVDQUFpRDtBQUNqRCxrREFBMEI7QUFDMUIsK0JBQTRCO0FBRTVCOzs7O0dBSUc7QUFDSCxTQUFnQixVQUFVLENBQUMsRUFBaUI7SUFDeEMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztJQUN2QixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBRXpCLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO0lBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXhDLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN0QyxJQUFJLENBQUMsVUFBVSxFQUFFO1FBQ2IsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELE1BQU0sU0FBUyxHQUFHLFFBQUcsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBRTlDLE1BQU0sV0FBVyxHQUFzQixFQUFFLENBQUM7SUFDMUMsTUFBTSxPQUFPLEdBQTRCLEVBQUUsQ0FBQztJQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLFFBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzVDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDeEIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztJQUNuQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBQ3JDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxD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QUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUF2QkQsMENBdUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVuZGVyVGV4dHVyZSwgZ2Z4IH0gZnJvbSAnY2MnO1xuaW1wb3J0IHsgZXhpc3RzU3luYywgbWtkaXJTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHNoYXJwIGZyb20gJ3NoYXJwJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcblxuLyoqXG4gKiBAZW5naW5lSW50ZXJuYWxcbiAqIEBwYXJhbSBydCBcbiAqIEByZXR1cm5zIFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVhZFBpeGVscyhydDogUmVuZGVyVGV4dHVyZSk6IFVpbnQ4QXJyYXkgfCBudWxsIHtcbiAgICBjb25zdCB3aWR0aCA9IHJ0LndpZHRoO1xuICAgIGNvbnN0IGhlaWdodCA9IHJ0LmhlaWdodDtcblxuICAgIGNvbnN0IG5lZWRTaXplID0gNCAqIHdpZHRoICogaGVpZ2h0O1xuICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KG5lZWRTaXplKTtcblxuICAgIGNvbnN0IGdmeFRleHR1cmUgPSBydC5nZXRHRlhUZXh0dXJlKCk7XG4gICAgaWYgKCFnZnhUZXh0dXJlKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGdmeERldmljZSA9IGdmeC5kZXZpY2VNYW5hZ2VyLmdmeERldmljZTtcblxuICAgIGNvbnN0IGJ1ZmZlclZpZXdzOiBBcnJheUJ1ZmZlclZpZXdbXSA9IFtdO1xuICAgIGNvbnN0IHJlZ2lvbnM6IGdmeC5CdWZmZXJUZXh0dXJlQ29weVtdID0gW107XG5cbiAgICBjb25zdCByZWdpb24wID0gbmV3IGdmeC5CdWZmZXJUZXh0dXJlQ29weSgpO1xuICAgIHJlZ2lvbjAudGV4T2Zmc2V0LnggPSAwO1xuICAgIHJlZ2lvbjAudGV4T2Zmc2V0LnkgPSAwO1xuICAgIHJlZ2lvbjAudGV4RXh0ZW50LndpZHRoID0gcnQud2lkdGg7XG4gICAgcmVnaW9uMC50ZXhFeHRlbnQuaGVpZ2h0ID0gcnQuaGVpZ2h0O1xuICAgIHJlZ2lvbnMucHVzaChyZWdpb24wKTtcblxuICAgIGJ1ZmZlclZpZXdzLnB1c2goYnVmZmVyKTtcbiAgICBnZnhEZXZpY2U/LmNvcHlUZXh0dXJlVG9CdWZmZXJzKGdmeFRleHR1cmUsIGJ1ZmZlclZpZXdzLCByZWdpb25zKTtcbiAgICByZXR1cm4gYnVmZmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxpcEltYWdlKGRhdGE6IFVpbnQ4QXJyYXkgfCBudWxsLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xuICAgIGlmICghZGF0YSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgbmV3RGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEubGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgd2lkdGg7IGorKykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSAod2lkdGggKiBpICsgaikgKiA0O1xuICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSAod2lkdGggKiAoaGVpZ2h0IC0gaSAtIDEpICsgaikgKiA0O1xuICAgICAgICAgICAgbmV3RGF0YVtuZXdJbmRleF0gPSBkYXRhW2luZGV4XTtcbiAgICAgICAgICAgIG5ld0RhdGFbbmV3SW5kZXggKyAxXSA9IGRhdGFbaW5kZXggKyAxXTtcbiAgICAgICAgICAgIG5ld0RhdGFbbmV3SW5kZXggKyAyXSA9IGRhdGFbaW5kZXggKyAyXTtcbiAgICAgICAgICAgIG5ld0RhdGFbbmV3SW5kZXggKyAzXSA9IGRhdGFbaW5kZXggKyAzXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV3RGF0YTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNhdmVEYXRhVG9JbWFnZShkYXRhOiBCdWZmZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBzY2VuZU5hbWU6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZylcbntcbiAgICBsZXQgZnVsbFBhdGggPSAnJztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXN5bmMtcHJvbWlzZS1leGVjdXRvclxuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgYXNzZXRQYXRoID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnYXNzZXQtZGInLCAncXVlcnktcGF0aCcsICdkYjovL2Fzc2V0cycpO1xuICAgICAgICBpZiAoYXNzZXRQYXRoID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2NlbmVQYXRoID0gam9pbihhc3NldFBhdGgsIHNjZW5lTmFtZSk7XG4gICAgICAgIGlmICghZXhpc3RzU3luYyhzY2VuZVBhdGgpKSB7XG4gICAgICAgICAgICBta2RpclN5bmMoc2NlbmVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBmdWxsUGF0aCA9IGpvaW4oc2NlbmVQYXRoLCBmaWxlTmFtZSk7XG4gICAgICAgIGNvbnN0IGltYWdlID0gc2hhcnAoZGF0YSwgeyByYXc6IHsgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCwgY2hhbm5lbHM6IDQgfSB9KTtcbiAgICAgICAgaW1hZ2UudG9GaWxlKGZ1bGxQYXRoKVxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH0pO1xufVxuIl19