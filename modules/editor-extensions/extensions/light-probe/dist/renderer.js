'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.beforeClose = exports.ready = exports.methods = exports.$ = exports.template = exports.style = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const Vue = require('vue/dist/vue.js');
Vue.config.productionTip = false;
Vue.config.devtools = false;
let panel = null;
let vm = null;
exports.style = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../dist/index.css'), 'utf8');
exports.template = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../static', '/index.html'), 'utf8');
exports.$ = {
    container: '.container',
};
exports.methods = {
    refresh() {
        vm && vm.refresh();
    },
    start() {
        if (!vm) {
            return;
        }
        vm.isBaking = true;
        vm.updateLog();
    },
    cancel() {
        if (!vm) {
            return;
        }
        vm.isBaking = false;
        vm.updateLog();
    },
    log() {
        vm && vm.updateLog();
    },
    progress() {
        vm && vm.updateLog();
    },
    finished() {
        vm && vm.updateLog();
    },
    end() {
        if (!vm) {
            return;
        }
        vm.isBaking = false;
        vm.updateLog();
    },
    clear() {
        vm && vm.updateLog();
    },
};
function ready() {
    // @ts-ignore
    panel = this;
    vm?.$destroy();
    vm = new Vue({
        el: panel.$.container,
        components: {},
        directives: {},
        data: {
            isInit: false,
            isBaking: false,
            rate: 0,
            logs: [],
            isStart: false,
            isFinish: false,
            isEnd: false,
        },
        async mounted() {
            this.sceneReady = await Editor.Message.request('scene', 'query-is-ready');
            if (this.sceneReady) {
                await this.refresh();
            }
        },
        updated() {
            this.scrollToBottom();
        },
        methods: {
            async refresh() {
                const dump = await Editor.Message.request('scene', 'execute-scene-script', {
                    name: 'light-probe',
                    method: 'query',
                    args: [],
                });
                if (!dump) {
                    return;
                }
                this.isInit = true;
                this.$refs.props.render(dump);
                this.$refs.props.querySelector('ui-section').setAttribute('whole', '');
            },
            confirm(event) {
                const target = event.target;
                if (!target) {
                    return;
                }
                const dump = target.dump;
                if (!dump) {
                    return;
                }
                Editor.Message.send('scene', 'execute-scene-script', {
                    name: 'light-probe',
                    method: 'update',
                    args: [dump],
                });
            },
            async baking() {
                // 在界面交互上规避重复点击，因为烘焙进程启动多个会导致卡死
                if (this.clickedBake) {
                    return;
                }
                this.clickedBake = true;
                setTimeout(() => {
                    this.clickedBake = false;
                }, 1000);
                try {
                    if (!this.isBaking) {
                        const filePath = (0, path_1.join)(Editor.Project.path, 'temp/light-probe');
                        const lightMapData = await Editor.Message.request('lightmap', 'getConfig');
                        lightMapData.path = filePath;
                        Editor.Message.send('lightmap', 'bakeLightProbe', lightMapData);
                        Editor.Metrics._trackEventWithTimer({
                            category: 'bakingSystem',
                            id: 'A100009',
                            value: 1,
                        });
                    }
                    else {
                        Editor.Message.send('lightmap', 'cancelLightProbe');
                    }
                }
                catch (error) {
                    console.error(error);
                    return;
                }
            },
            clear() {
                Editor.Message.send('scene', 'execute-scene-script', {
                    name: 'light-probe',
                    method: 'clear',
                    args: [],
                });
            },
            async updateLog() {
                const state = await Editor.Message.request('light-probe', 'unstaging');
                this.rate = state.rate;
                this.logs = state.logs;
                this.isStart = state.isStart;
                this.isFinish = state.isFinish;
                this.isEnd = state.isEnd;
            },
            scrollToBottom() {
                this.$nextTick(() => {
                    const $logs = this.$refs.logs;
                    if ($logs && ($logs.scrollHeight - $logs.scrollTop !== $logs.clientHeight)) {
                        $logs.scrollTop = $logs.scrollHeight;
                    }
                });
            },
        },
    });
}
exports.ready = ready;
async function beforeClose() {
    return await Editor.Message.request('scene', 'execute-scene-script', {
        name: 'light-probe',
        method: 'beforeClose',
        args: [],
    });
}
exports.beforeClose = beforeClose;
function close() {
    vm?.$destroy();
    vm = null;
    panel = null;
}
exports.close = close;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zb3VyY2UvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYiwyQkFBaUY7QUFDakYsK0JBQTRCO0FBRzVCLE1BQU0sR0FBRyxHQUFtQixPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN2RCxHQUFHLENBQUMsTUFBTSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7QUFDakMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO0FBRTVCLElBQUksS0FBSyxHQUFRLElBQUksQ0FBQztBQUN0QixJQUFJLEVBQUUsR0FBUSxJQUFJLENBQUM7QUFFTixRQUFBLEtBQUssR0FBRyxJQUFBLGlCQUFZLEVBQUMsSUFBQSxXQUFJLEVBQUMsU0FBUyxFQUFFLG1CQUFtQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFbkUsUUFBQSxRQUFRLEdBQUcsSUFBQSxpQkFBWSxFQUFDLElBQUEsV0FBSSxFQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsYUFBYSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFN0UsUUFBQSxDQUFDLEdBQUc7SUFDYixTQUFTLEVBQUUsWUFBWTtDQUMxQixDQUFDO0FBRVcsUUFBQSxPQUFPLEdBQUc7SUFDbkIsT0FBTztRQUNILEVBQUUsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUNELEtBQUs7UUFDRCxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQUUsT0FBTztTQUFFO1FBQ3BCLEVBQUUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ25CLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBQ0QsTUFBTTtRQUNGLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFDcEIsRUFBRSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDcEIsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFDRCxHQUFHO1FBQ0MsRUFBRSxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBQ0QsUUFBUTtRQUNKLEVBQUUsSUFBSSxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUNELFFBQVE7UUFDSixFQUFFLElBQUksRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFDRCxHQUFHO1FBQ0MsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUNwQixFQUFFLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUNwQixFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUNELEtBQUs7UUFDRCxFQUFFLElBQUksRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3pCLENBQUM7Q0FDSixDQUFDO0FBRUYsU0FBZ0IsS0FBSztJQUNqQixhQUFhO0lBQ2IsS0FBSyxHQUFHLElBQUksQ0FBQztJQUViLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQztJQUNmLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQztRQUNULEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDckIsVUFBVSxFQUFFLEVBQUU7UUFDZCxVQUFVLEVBQUUsRUFBRTtRQUNkLElBQUksRUFBRTtZQUNGLE1BQU0sRUFBRSxLQUFLO1lBQ2IsUUFBUSxFQUFFLEtBQUs7WUFFZixJQUFJLEVBQUUsQ0FBQztZQUNQLElBQUksRUFBRSxFQUFFO1lBQ1IsT0FBTyxFQUFFLEtBQUs7WUFDZCxRQUFRLEVBQUUsS0FBSztZQUNmLEtBQUssRUFBRSxLQUFLO1NBQ2Y7UUFDRCxLQUFLLENBQUMsT0FBTztZQUNULElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUMxRSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ2pCLE1BQU0sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQ3hCO1FBQ0wsQ0FBQztRQUNELE9BQU87WUFDSCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDMUIsQ0FBQztRQUNELE9BQU8sRUFBRTtZQUNMLEtBQUssQ0FBQyxPQUFPO2dCQUNULE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLHNCQUFzQixFQUFFO29CQUN2RSxJQUFJLEVBQUUsYUFBYTtvQkFDbkIsTUFBTSxFQUFFLE9BQU87b0JBQ2YsSUFBSSxFQUFFLEVBQUU7aUJBQ1gsQ0FBQyxDQUFDO2dCQUVILElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ1AsT0FBTztpQkFDVjtnQkFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFFbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzRSxDQUFDO1lBQ0QsT0FBTyxDQUFDLEtBQWlCO2dCQUNyQixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBYSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNULE9BQU87aUJBQ1Y7Z0JBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDekIsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDUCxPQUFPO2lCQUNWO2dCQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRTtvQkFDakQsSUFBSSxFQUFFLGFBQWE7b0JBQ25CLE1BQU0sRUFBRSxRQUFRO29CQUNoQixJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUM7aUJBQ2YsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztZQUNELEtBQUssQ0FBQyxNQUFNO2dCQUNSLCtCQUErQjtnQkFDL0IsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO29CQUNsQixPQUFPO2lCQUNWO2dCQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUN4QixVQUFVLENBQUMsR0FBRyxFQUFFO29CQUNaLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO2dCQUM3QixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBRVQsSUFBSTtvQkFDQSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTt3QkFDaEIsTUFBTSxRQUFRLEdBQUcsSUFBQSxXQUFJLEVBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzt3QkFFL0QsTUFBTSxZQUFZLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7d0JBQzNFLFlBQVksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO3dCQUU3QixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLENBQUM7d0JBQ2hFLE1BQU0sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUM7NEJBQ2hDLFFBQVEsRUFBRSxjQUFjOzRCQUN4QixFQUFFLEVBQUUsU0FBUzs0QkFDYixLQUFLLEVBQUUsQ0FBQzt5QkFDWCxDQUFDLENBQUM7cUJBQ047eUJBQU07d0JBQ0gsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGtCQUFrQixDQUFDLENBQUM7cUJBQ3ZEO2lCQUNKO2dCQUFDLE9BQU8sS0FBSyxFQUFFO29CQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ3JCLE9BQU87aUJBQ1Y7WUFDTCxDQUFDO1lBQ0QsS0FBSztnQkFDRCxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUU7b0JBQ2pELElBQUksRUFBRSxhQUFhO29CQUNuQixNQUFNLEVBQUUsT0FBTztvQkFDZixJQUFJLEVBQUUsRUFBRTtpQkFDWCxDQUFDLENBQUM7WUFDUCxDQUFDO1lBQ0QsS0FBSyxDQUFDLFNBQVM7Z0JBQ1gsTUFBTSxLQUFLLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ3ZFLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO2dCQUN2QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztnQkFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1lBQzdCLENBQUM7WUFDRCxjQUFjO2dCQUNWLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO29CQUNoQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztvQkFDOUIsSUFBSSxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFFO3dCQUN4RSxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUM7cUJBQ3hDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUNKO0tBQ0osQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQXRIRCxzQkFzSEM7QUFFTSxLQUFLLFVBQVUsV0FBVztJQUM3QixPQUFPLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLHNCQUFzQixFQUFFO1FBQ2pFLElBQUksRUFBRSxhQUFhO1FBQ25CLE1BQU0sRUFBRSxhQUFhO1FBQ3JCLElBQUksRUFBRSxFQUFFO0tBQ1gsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQU5ELGtDQU1DO0FBRUQsU0FBZ0IsS0FBSztJQUNqQixFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDZixFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQ1YsS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixDQUFDO0FBSkQsc0JBSUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IHJlYWRGaWxlU3luYywgZXhpc3RzU3luYywgcmVhZGRpclN5bmMsIHN0YXRTeW5jLCB1bmxpbmtTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgdHlwZSB7IFZ1ZUNvbnN0cnVjdG9yIH0gZnJvbSAndnVlJztcbmNvbnN0IFZ1ZTogVnVlQ29uc3RydWN0b3IgPSByZXF1aXJlKCd2dWUvZGlzdC92dWUuanMnKTtcblZ1ZS5jb25maWcucHJvZHVjdGlvblRpcCA9IGZhbHNlO1xuVnVlLmNvbmZpZy5kZXZ0b29scyA9IGZhbHNlO1xuXG5sZXQgcGFuZWw6IGFueSA9IG51bGw7XG5sZXQgdm06IGFueSA9IG51bGw7XG5cbmV4cG9ydCBjb25zdCBzdHlsZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uL2Rpc3QvaW5kZXguY3NzJyksICd1dGY4Jyk7XG5cbmV4cG9ydCBjb25zdCB0ZW1wbGF0ZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uL3N0YXRpYycsICcvaW5kZXguaHRtbCcpLCAndXRmOCcpO1xuXG5leHBvcnQgY29uc3QgJCA9IHtcbiAgICBjb250YWluZXI6ICcuY29udGFpbmVyJyxcbn07XG5cbmV4cG9ydCBjb25zdCBtZXRob2RzID0ge1xuICAgIHJlZnJlc2goKSB7XG4gICAgICAgIHZtICYmIHZtLnJlZnJlc2goKTtcbiAgICB9LFxuICAgIHN0YXJ0KCkge1xuICAgICAgICBpZiAoIXZtKSB7IHJldHVybjsgfVxuICAgICAgICB2bS5pc0Jha2luZyA9IHRydWU7XG4gICAgICAgIHZtLnVwZGF0ZUxvZygpO1xuICAgIH0sXG4gICAgY2FuY2VsKCkge1xuICAgICAgICBpZiAoIXZtKSB7IHJldHVybjsgfVxuICAgICAgICB2bS5pc0Jha2luZyA9IGZhbHNlO1xuICAgICAgICB2bS51cGRhdGVMb2coKTtcbiAgICB9LFxuICAgIGxvZygpIHtcbiAgICAgICAgdm0gJiYgdm0udXBkYXRlTG9nKCk7XG4gICAgfSxcbiAgICBwcm9ncmVzcygpIHtcbiAgICAgICAgdm0gJiYgdm0udXBkYXRlTG9nKCk7XG4gICAgfSxcbiAgICBmaW5pc2hlZCgpIHtcbiAgICAgICAgdm0gJiYgdm0udXBkYXRlTG9nKCk7XG4gICAgfSxcbiAgICBlbmQoKSB7XG4gICAgICAgIGlmICghdm0pIHsgcmV0dXJuOyB9XG4gICAgICAgIHZtLmlzQmFraW5nID0gZmFsc2U7XG4gICAgICAgIHZtLnVwZGF0ZUxvZygpO1xuICAgIH0sXG4gICAgY2xlYXIoKSB7XG4gICAgICAgIHZtICYmIHZtLnVwZGF0ZUxvZygpO1xuICAgIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gcmVhZHkoKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHBhbmVsID0gdGhpcztcblxuICAgIHZtPy4kZGVzdHJveSgpO1xuICAgIHZtID0gbmV3IFZ1ZSh7XG4gICAgICAgIGVsOiBwYW5lbC4kLmNvbnRhaW5lcixcbiAgICAgICAgY29tcG9uZW50czoge30sXG4gICAgICAgIGRpcmVjdGl2ZXM6IHt9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBpc0luaXQ6IGZhbHNlLFxuICAgICAgICAgICAgaXNCYWtpbmc6IGZhbHNlLFxuXG4gICAgICAgICAgICByYXRlOiAwLFxuICAgICAgICAgICAgbG9nczogW10sXG4gICAgICAgICAgICBpc1N0YXJ0OiBmYWxzZSxcbiAgICAgICAgICAgIGlzRmluaXNoOiBmYWxzZSxcbiAgICAgICAgICAgIGlzRW5kOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgICAgYXN5bmMgbW91bnRlZCgpIHtcbiAgICAgICAgICAgIHRoaXMuc2NlbmVSZWFkeSA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ3F1ZXJ5LWlzLXJlYWR5Jyk7XG4gICAgICAgICAgICBpZiAodGhpcy5zY2VuZVJlYWR5KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yZWZyZXNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZWQoKSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbFRvQm90dG9tKCk7XG4gICAgICAgIH0sXG4gICAgICAgIG1ldGhvZHM6IHtcbiAgICAgICAgICAgIGFzeW5jIHJlZnJlc2goKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVtcCA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnbGlnaHQtcHJvYmUnLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdxdWVyeScsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtdLFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFkdW1wKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmlzSW5pdCA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICB0aGlzLiRyZWZzLnByb3BzLnJlbmRlcihkdW1wKTtcbiAgICAgICAgICAgICAgICB0aGlzLiRyZWZzLnByb3BzLnF1ZXJ5U2VsZWN0b3IoJ3VpLXNlY3Rpb24nKS5zZXRBdHRyaWJ1dGUoJ3dob2xlJywgJycpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbmZpcm0oZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQgYXMgYW55O1xuICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkdW1wID0gdGFyZ2V0LmR1bXA7XG4gICAgICAgICAgICAgICAgaWYgKCFkdW1wKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKCdzY2VuZScsICdleGVjdXRlLXNjZW5lLXNjcmlwdCcsIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2xpZ2h0LXByb2JlJyxcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAndXBkYXRlJyxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW2R1bXBdLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFzeW5jIGJha2luZygpIHtcbiAgICAgICAgICAgICAgICAvLyDlnKjnlYzpnaLkuqTkupLkuIrop4Tpgb/ph43lpI3ngrnlh7vvvIzlm6DkuLrng5jnhJnov5vnqIvlkK/liqjlpJrkuKrkvJrlr7zoh7TljaHmrbtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jbGlja2VkQmFrZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2xpY2tlZEJha2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsaWNrZWRCYWtlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNCYWtpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gam9pbihFZGl0b3IuUHJvamVjdC5wYXRoLCAndGVtcC9saWdodC1wcm9iZScpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsaWdodE1hcERhdGEgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdsaWdodG1hcCcsICdnZXRDb25maWcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0TWFwRGF0YS5wYXRoID0gZmlsZVBhdGg7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIEVkaXRvci5NZXNzYWdlLnNlbmQoJ2xpZ2h0bWFwJywgJ2Jha2VMaWdodFByb2JlJywgbGlnaHRNYXBEYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIEVkaXRvci5NZXRyaWNzLl90cmFja0V2ZW50V2l0aFRpbWVyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogJ2Jha2luZ1N5c3RlbScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICdBMTAwMDA5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnbGlnaHRtYXAnLCAnY2FuY2VsTGlnaHRQcm9iZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY2xlYXIoKSB7XG4gICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZCgnc2NlbmUnLCAnZXhlY3V0ZS1zY2VuZS1zY3JpcHQnLCB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdsaWdodC1wcm9iZScsXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ2NsZWFyJyxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW10sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYXN5bmMgdXBkYXRlTG9nKCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnbGlnaHQtcHJvYmUnLCAndW5zdGFnaW5nJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5yYXRlID0gc3RhdGUucmF0ZTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ3MgPSBzdGF0ZS5sb2dzO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNTdGFydCA9IHN0YXRlLmlzU3RhcnQ7XG4gICAgICAgICAgICAgICAgdGhpcy5pc0ZpbmlzaCA9IHN0YXRlLmlzRmluaXNoO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNFbmQgPSBzdGF0ZS5pc0VuZDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY3JvbGxUb0JvdHRvbSgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0ICRsb2dzID0gdGhpcy4kcmVmcy5sb2dzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoJGxvZ3MgJiYgKCRsb2dzLnNjcm9sbEhlaWdodCAtICRsb2dzLnNjcm9sbFRvcCAhPT0gJGxvZ3MuY2xpZW50SGVpZ2h0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJGxvZ3Muc2Nyb2xsVG9wID0gJGxvZ3Muc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYmVmb3JlQ2xvc2UoKSB7XG4gICAgcmV0dXJuIGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICBuYW1lOiAnbGlnaHQtcHJvYmUnLFxuICAgICAgICBtZXRob2Q6ICdiZWZvcmVDbG9zZScsXG4gICAgICAgIGFyZ3M6IFtdLFxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xvc2UoKSB7IFxuICAgIHZtPy4kZGVzdHJveSgpO1xuICAgIHZtID0gbnVsbDtcbiAgICBwYW5lbCA9IG51bGw7XG59XG4iXX0=