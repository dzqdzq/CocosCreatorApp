'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.importConfig = exports.exportConfig = exports.close = exports.ready = exports.$ = exports.template = exports.style = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const Vue = require('vue/dist/vue.js');
Vue.config.productionTip = false;
Vue.config.devtools = false;
const vueTemplate = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../../static/contributions/preferences.html'), 'utf8');
const DevicePreferenceVM = Vue.extend({
    name: 'DevicePreferenceVM',
    data() {
        return {
            config: {
                builtin: [],
                custom: [],
                enable: [],
            },
            deviceType: '',
            num: -1,
            device: {
                name: '',
                width: 0,
                height: 0,
                ratio: 0,
            },
            editType: '', // '' | 'add' | 'update'
        };
    },
    computed: {
        // 校验表单输入，保存按钮是否禁用
        confirmButtonDisabled() {
            if (this.device.name && this.device.height !== 0 && this.device.width !== 0 && this.device.ratio !== 0) {
                return false;
            }
            return true;
        },
        // 表单输入是否禁用
        deviceFormDisabled() {
            if (this.deviceType === 'builtin' && this.editType !== 'add') {
                return true;
            }
            return false;
        },
    },
    mounted() {
        this.refresh();
    },
    methods: {
        async refresh() {
            const builtin = await Editor.Profile.getConfig('device', 'devices', 'default');
            const custom = await Editor.Profile.getConfig('device', 'custom', 'global');
            const enable = await Editor.Profile.getConfig('device', 'enable');
            if (builtin) {
                this.config.builtin = builtin;
            }
            if (custom) {
                this.config.custom = custom;
            }
            if (enable) {
                this.config.enable = enable;
            }
            // 初始默认选中默认设备的第一个
            this.chooseDevice('builtin', 0);
        },
        /**
         * 选中设备
         * @param {string} deviceType 默认设备 | 自定义设备
         * @param {number} num 设备索引
         */
        chooseDevice(deviceType, num) {
            if (this.editType === 'add') {
                return;
            }
            this.editType = '';
            this.deviceType = deviceType;
            this.num = num;
            this.updateDevice();
        },
        /**
         * 更新表单输入的数据
         */
        updateDevice() {
            requestAnimationFrame(() => {
                if (!this.config[this.deviceType] || !this.config[this.deviceType][this.num]) {
                    return;
                }
                const device = this.config[this.deviceType][this.num];
                this.device.name = device.name;
                this.device.width = device.width;
                this.device.height = device.height;
                this.device.ratio = device.ratio;
            });
        },
        /**
         * 设备信息变化
         */
        onDeviceChange(event) {
            const target = event.target;
            const path = target.getAttribute('path');
            if (!path || this.device[path] === undefined) {
                return;
            }
            const value = target.value;
            this.device[path] = value;
            // 修改设备信息，如果设备信息修改了才显示保存按钮
            if (this.editType !== 'add') {
                this.isDeviceChanged() ? this.editType = 'update' : this.editType = '';
            }
        },
        /**
         * 新增自定义设备
         */
        createDevice() {
            this.device.name = Editor.I18n.t('device.markname');
            this.device.width = 0;
            this.device.height = 0;
            this.device.ratio = 1;
            this.editType = 'add';
        },
        /**
         * 保存新增或修改设备的信息
         */
        confirmDevice() {
            if (this.editType === 'add') {
                // 新增设备信息
                if (this.isDeviceNameExist(this.device.name)) {
                    Editor.Dialog.warn(Editor.I18n.t('device.invalid.exists'));
                    return;
                }
                this.config.custom.push(JSON.parse(JSON.stringify(this.device)));
                this.editType = '';
                this.chooseDevice('custom', this.config.custom.length - 1);
            }
            else {
                // 修改设备信息
                const device = this.config.custom[this.num];
                if (!device) {
                    return;
                }
                if (device.name !== this.device.name && this.isDeviceNameExist(this.device.name)) {
                    Editor.Dialog.warn(Editor.I18n.t('device.invalid.exists'));
                    return;
                }
                device.name = this.device.name;
                device.width = this.device.width;
                device.height = this.device.height;
                device.ratio = this.device.ratio;
                this.editType = '';
            }
            Editor.Profile.setConfig('device', 'custom', this.config.custom, 'global');
        },
        /**
         * 取消新增自定义设备
         */
        cancelCreate() {
            this.editType = '';
            const device = this.config[this.deviceType][this.num];
            this.device.name = device.name;
            this.device.width = device.width;
            this.device.height = device.height;
            this.device.ratio = device.ratio;
        },
        /**
         * 删除自定义设备
         */
        deleteDevice(num) {
            if (!this.config.custom[num]) {
                return;
            }
            const deviceName = this.config.custom[num].name;
            this.config.custom.splice(num, 1);
            if (this.deviceType === 'custom' && num <= this.num) {
                this.config.custom.length === 0 ? this.chooseDevice('builtin', 0) : this.chooseDevice('custom', this.num - 1);
            }
            Editor.Profile.setConfig('device', 'custom', this.config.custom, 'global');
            // 删除 enabled 列表的设备
            const index = this.config.enable.indexOf(deviceName);
            if (index !== -1) {
                this.config.enable.splice(index, 1);
                Editor.Profile.setConfig('device', 'enable', this.config.enable, 'global');
            }
        },
        /**
         * 启/停用设备
         * @param {boolean} bool
         * @param {string} name
         */
        async switchEnable(bool, name) {
            const index = this.config.enable.indexOf(name);
            if (bool) {
                if (index === -1) {
                    this.config.enable.push(name);
                    await Editor.Profile.setConfig('device', 'enable', this.config.enable, 'global');
                }
            }
            else {
                if (index !== -1) {
                    this.config.enable.splice(index, 1);
                    await Editor.Profile.setConfig('device', 'enable', this.config.enable, 'global');
                }
            }
            // 启停用设备，广播消息
            Editor.Message.broadcast('device:devices-changed');
        },
        /**
         * 校验设备是否已存在
         */
        isDeviceNameExist(deviceName) {
            return this.config.builtin.some((device) => {
                return deviceName === device.name;
            }) ||
                this.config.custom.some((device) => {
                    return deviceName === device.name;
                });
        },
        /**
         * 判断设备信息是否修改
         */
        isDeviceChanged() {
            const device = this.config.custom[this.num];
            let changed = false;
            for (const key in device) {
                // @ts-ignore
                if (device[key] !== this.device[key]) {
                    changed = true;
                }
            }
            return changed;
        },
    },
    template: vueTemplate,
});
exports.style = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, './preferences.css'), 'utf8');
exports.template = '<div class="container"></div>';
exports.$ = {
    container: '.container',
};
function ready() {
    // @ts-ignore
    const panel = this;
    panel.vm?.$destroy();
    panel.vm = new DevicePreferenceVM();
    panel.vm.$mount(panel.$.container);
}
exports.ready = ready;
function close() {
    // @ts-ignore
    const panel = this;
    panel.vm?.$destroy();
    panel.vm = null;
}
exports.close = close;
async function exportConfig() {
    const configs = {};
    configs.custom = {
        type: 'global',
        value: await Editor.Message.request('preferences', 'query-config', 'device', 'custom'),
    };
    configs.enable = {
        type: 'global',
        value: await Editor.Message.request('preferences', 'query-config', 'device', 'enable'),
    };
    return configs;
}
exports.exportConfig = exportConfig;
async function importConfig(configs) {
    configs.custom && await Editor.Message.request('preferences', 'set-config', 'device', 'custom', configs.custom.value, 'global');
    configs.enable && await Editor.Message.request('preferences', 'set-config', 'device', 'enable', configs.enable.value, 'global');
}
exports.importConfig = importConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmVyZW5jZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvY29udHJpYnV0aW9ucy9wcmVmZXJlbmNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUdiLDJCQUFrQztBQUNsQywrQkFBNEI7QUFHNUIsTUFBTSxHQUFHLEdBQW1CLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3ZELEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztBQUNqQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7QUFtQjVCLE1BQU0sV0FBVyxHQUFHLElBQUEsaUJBQVksRUFBQyxJQUFBLFdBQUksRUFBQyxTQUFTLEVBQUUsNkNBQTZDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUV6RyxNQUFNLGtCQUFrQixHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDbEMsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixJQUFJO1FBQ0EsT0FBTztZQUNILE1BQU0sRUFBRTtnQkFDSixPQUFPLEVBQUUsRUFBRTtnQkFDWCxNQUFNLEVBQUUsRUFBRTtnQkFDVixNQUFNLEVBQUUsRUFBRTthQUNDO1lBQ2YsVUFBVSxFQUFFLEVBQW9CO1lBQ2hDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDUCxNQUFNLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLEVBQUU7Z0JBQ1IsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsTUFBTSxFQUFFLENBQUM7Z0JBQ1QsS0FBSyxFQUFFLENBQUM7YUFDRztZQUNmLFFBQVEsRUFBRSxFQUFFLEVBQUUsd0JBQXdCO1NBQ3pDLENBQUM7SUFDTixDQUFDO0lBQ0QsUUFBUSxFQUFFO1FBQ04sa0JBQWtCO1FBQ2xCLHFCQUFxQjtZQUNqQixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMs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LE1BQU0sR0FBRztRQUNiLElBQUksRUFBRSxRQUFRO1FBQ2QsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDO0tBQ3pGLENBQUM7SUFDRixPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDO0FBWEQsb0NBV0M7QUFFTSxLQUFLLFVBQVUsWUFBWSxDQUFDLE9BQXFCO0lBQ3BELE9BQU8sQ0FBQyxNQUFNLElBQUksTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEksT0FBTyxDQUFDLE1BQU0sSUFBSSxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztBQUNwSSxDQUFDO0FBSEQsb0NBR0MiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IEV4cG9ydENvbmZpZywgUHJlZmVyZW5jZXNQcm90b2NvbCB9IGZyb20gJy4uLy4uL0B0eXBlcy9wcml2YXRlJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcblxuaW1wb3J0IHR5cGUgeyBWdWVDb25zdHJ1Y3RvciB9IGZyb20gJ3Z1ZSc7XG5jb25zdCBWdWU6IFZ1ZUNvbnN0cnVjdG9yID0gcmVxdWlyZSgndnVlL2Rpc3QvdnVlLmpzJyk7XG5WdWUuY29uZmlnLnByb2R1Y3Rpb25UaXAgPSBmYWxzZTtcblZ1ZS5jb25maWcuZGV2dG9vbHMgPSBmYWxzZTtcblxudHlwZSBkZXZpY2VEYXRhID0ge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB3aWR0aDogbnVtYmVyO1xuICAgIGhlaWdodDogbnVtYmVyO1xuICAgIHJhdGlvOiBudW1iZXI7XG59XG5cbnR5cGUgZGV2aWNlRGF0YUtleXMgPSBrZXlvZiBkZXZpY2VEYXRhO1xuXG50eXBlIGNvbmZpZ0RhdGEgPSB7XG4gICAgYnVpbHRpbjogZGV2aWNlRGF0YVtdO1xuICAgIGN1c3RvbTogZGV2aWNlRGF0YVtdO1xuICAgIGVuYWJsZTogc3RyaW5nW107XG59XG5cbnR5cGUgY29uZmlnRGF0YUtleXMgPSAnYnVpbHRpbicgfCAnY3VzdG9tJztcblxuY29uc3QgdnVlVGVtcGxhdGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zdGF0aWMvY29udHJpYnV0aW9ucy9wcmVmZXJlbmNlcy5odG1sJyksICd1dGY4Jyk7XG5cbmNvbnN0IERldmljZVByZWZlcmVuY2VWTSA9IFZ1ZS5leHRlbmQoe1xuICAgIG5hbWU6ICdEZXZpY2VQcmVmZXJlbmNlVk0nLFxuICAgIGRhdGEoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICAgICAgICBidWlsdGluOiBbXSxcbiAgICAgICAgICAgICAgICBjdXN0b206IFtdLFxuICAgICAgICAgICAgICAgIGVuYWJsZTogW10sXG4gICAgICAgICAgICB9IGFzIGNvbmZpZ0RhdGEsXG4gICAgICAgICAgICBkZXZpY2VUeXBlOiAnJyBhcyBjb25maWdEYXRhS2V5cywgLy8g6buY6K6k6K6+5aSHIHwg6Ieq5a6a5LmJ6K6+5aSHXG4gICAgICAgICAgICBudW06IC0xLCAvLyDlvZPliY3pgInkuK3orr7lpIfnmoTntKLlvJVcbiAgICAgICAgICAgIGRldmljZToge1xuICAgICAgICAgICAgICAgIG5hbWU6ICcnLFxuICAgICAgICAgICAgICAgIHdpZHRoOiAwLFxuICAgICAgICAgICAgICAgIGhlaWdodDogMCxcbiAgICAgICAgICAgICAgICByYXRpbzogMCxcbiAgICAgICAgICAgIH0gYXMgZGV2aWNlRGF0YSxcbiAgICAgICAgICAgIGVkaXRUeXBlOiAnJywgLy8gJycgfCAnYWRkJyB8ICd1cGRhdGUnXG4gICAgICAgIH07XG4gICAgfSxcbiAgICBjb21wdXRlZDoge1xuICAgICAgICAvLyDmoKHpqozooajljZXovpPlhaXvvIzkv53lrZjmjInpkq7mmK/lkKbnpoHnlKhcbiAgICAgICAgY29uZmlybUJ1dHRvbkRpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuZGV2aWNlLm5hbWUgJiYgdGhpcy5kZXZpY2UuaGVpZ2h0ICE9PSAwICYmIHRoaXMuZGV2aWNlLndpZHRoICE9PSAwICYmIHRoaXMuZGV2aWNlLnJhdGlvICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIOihqOWNlei+k+WFpeaYr+WQpuemgeeUqFxuICAgICAgICBkZXZpY2VGb3JtRGlzYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgICAgICAgICBpZiAodGhpcy5kZXZpY2VUeXBlID09PSAnYnVpbHRpbicgJiYgdGhpcy5lZGl0VHlwZSAhPT0gJ2FkZCcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIG1vdW50ZWQoKSB7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgIH0sXG4gICAgbWV0aG9kczoge1xuICAgICAgICBhc3luYyByZWZyZXNoKCkge1xuICAgICAgICAgICAgY29uc3QgYnVpbHRpbiA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygnZGV2aWNlJywgJ2RldmljZXMnLCAnZGVmYXVsdCcpO1xuICAgICAgICAgICAgY29uc3QgY3VzdG9tID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdkZXZpY2UnLCAnY3VzdG9tJywgJ2dsb2JhbCcpO1xuICAgICAgICAgICAgY29uc3QgZW5hYmxlID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdkZXZpY2UnLCAnZW5hYmxlJyk7XG5cbiAgICAgICAgICAgIGlmIChidWlsdGluKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcuYnVpbHRpbiA9IGJ1aWx0aW47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjdXN0b20pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5jdXN0b20gPSBjdXN0b207XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChlbmFibGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5lbmFibGUgPSBlbmFibGU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOWIneWni+m7mOiupOmAieS4rem7mOiupOiuvuWkh+eahOesrOS4gOS4qlxuICAgICAgICAgICAgdGhpcy5jaG9vc2VEZXZpY2UoJ2J1aWx0aW4nLCAwKTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOmAieS4reiuvuWkh1xuICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGV2aWNlVHlwZSDpu5jorqTorr7lpIcgfCDoh6rlrprkuYnorr7lpIdcbiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IG51bSDorr7lpIfntKLlvJVcbiAgICAgICAgICovXG4gICAgICAgIGNob29zZURldmljZShkZXZpY2VUeXBlOiBjb25maWdEYXRhS2V5cywgbnVtOiBudW1iZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmVkaXRUeXBlID09PSAnYWRkJykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZWRpdFR5cGUgPSAnJztcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlVHlwZSA9IGRldmljZVR5cGU7XG4gICAgICAgICAgICB0aGlzLm51bSA9IG51bTtcblxuICAgICAgICAgICAgdGhpcy51cGRhdGVEZXZpY2UoKTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOabtOaWsOihqOWNlei+k+WFpeeahOaVsOaNrlxuICAgICAgICAgKi9cbiAgICAgICAgdXBkYXRlRGV2aWNlKCkge1xuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29uZmlnW3RoaXMuZGV2aWNlVHlwZV0gfHwgIXRoaXMuY29uZmlnW3RoaXMuZGV2aWNlVHlwZV1bdGhpcy5udW1dKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlID0gdGhpcy5jb25maWdbdGhpcy5kZXZpY2VUeXBlXVt0aGlzLm51bV07XG4gICAgICAgICAgICAgICAgdGhpcy5kZXZpY2UubmFtZSA9IGRldmljZS5uYW1lO1xuICAgICAgICAgICAgICAgIHRoaXMuZGV2aWNlLndpZHRoID0gZGV2aWNlLndpZHRoO1xuICAgICAgICAgICAgICAgIHRoaXMuZGV2aWNlLmhlaWdodCA9IGRldmljZS5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXZpY2UucmF0aW8gPSBkZXZpY2UucmF0aW87XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiuvuWkh+S/oeaBr+WPmOWMllxuICAgICAgICAgKi9cbiAgICAgICAgb25EZXZpY2VDaGFuZ2UoZXZlbnQ6IGFueSkge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IGFzIEVkaXRvci5VSS5IVE1MQ3VzdG9tRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCdwYXRoJykgYXMgZGV2aWNlRGF0YUtleXMgfCBudWxsO1xuICAgICAgICAgICAgaWYgKCFwYXRoIHx8IHRoaXMuZGV2aWNlW3BhdGhdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgKHRoaXMuZGV2aWNlIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pW3BhdGhdID0gdmFsdWU7XG5cbiAgICAgICAgICAgIC8vIOS/ruaUueiuvuWkh+S/oeaBr++8jOWmguaenOiuvuWkh+S/oeaBr+S/ruaUueS6huaJjeaYvuekuuS/neWtmOaMiemSrlxuICAgICAgICAgICAgaWYgKHRoaXMuZWRpdFR5cGUgIT09ICdhZGQnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pc0RldmljZUNoYW5nZWQoKSA/IHRoaXMuZWRpdFR5cGUgPSAndXBkYXRlJyA6IHRoaXMuZWRpdFR5cGUgPSAnJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOaWsOWinuiHquWumuS5ieiuvuWkh1xuICAgICAgICAgKi9cbiAgICAgICAgY3JlYXRlRGV2aWNlKCkge1xuICAgICAgICAgICAgdGhpcy5kZXZpY2UubmFtZSA9IEVkaXRvci5JMThuLnQoJ2RldmljZS5tYXJrbmFtZScpO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2Uud2lkdGggPSAwO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2UuaGVpZ2h0ID0gMDtcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlLnJhdGlvID0gMTtcblxuICAgICAgICAgICAgdGhpcy5lZGl0VHlwZSA9ICdhZGQnO1xuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog5L+d5a2Y5paw5aKe5oiW5L+u5pS56K6+5aSH55qE5L+h5oGvXG4gICAgICAgICAqL1xuICAgICAgICBjb25maXJtRGV2aWNlKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZWRpdFR5cGUgPT09ICdhZGQnKSB7XG4gICAgICAgICAgICAgICAgLy8g5paw5aKe6K6+5aSH5L+h5oGvXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNEZXZpY2VOYW1lRXhpc3QodGhpcy5kZXZpY2UubmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgRWRpdG9yLkRpYWxvZy53YXJuKEVkaXRvci5JMThuLnQoJ2RldmljZS5pbnZhbGlkLmV4aXN0cycpKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5jdXN0b20ucHVzaChKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuZGV2aWNlKSkpO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdFR5cGUgPSAnJztcbiAgICAgICAgICAgICAgICB0aGlzLmNob29zZURldmljZSgnY3VzdG9tJywgdGhpcy5jb25maWcuY3VzdG9tLmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyDkv67mlLnorr7lpIfkv6Hmga9cbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmNvbmZpZy5jdXN0b21bdGhpcy5udW1dO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFkZXZpY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGV2aWNlLm5hbWUgIT09IHRoaXMuZGV2aWNlLm5hbWUgJiYgdGhpcy5pc0RldmljZU5hbWVFeGlzdCh0aGlzLmRldmljZS5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBFZGl0b3IuRGlhbG9nLndhcm4oRWRpdG9yLkkxOG4udCgnZGV2aWNlLmludmFsaWQuZXhpc3RzJykpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRldmljZS5uYW1lID0gdGhpcy5kZXZpY2UubmFtZTtcbiAgICAgICAgICAgICAgICBkZXZpY2Uud2lkdGggPSB0aGlzLmRldmljZS53aWR0aDtcbiAgICAgICAgICAgICAgICBkZXZpY2UuaGVpZ2h0ID0gdGhpcy5kZXZpY2UuaGVpZ2h0O1xuICAgICAgICAgICAgICAgIGRldmljZS5yYXRpbyA9IHRoaXMuZGV2aWNlLnJhdGlvO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdFR5cGUgPSAnJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIEVkaXRvci5Qcm9maWxlLnNldENvbmZpZygnZGV2aWNlJywgJ2N1c3RvbScsIHRoaXMuY29uZmlnLmN1c3RvbSwgJ2dsb2JhbCcpO1xuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog5Y+W5raI5paw5aKe6Ieq5a6a5LmJ6K6+5aSHXG4gICAgICAgICAqL1xuICAgICAgICBjYW5jZWxDcmVhdGUoKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRUeXBlID0gJyc7XG5cbiAgICAgICAgICAgIGNvbnN0IGRldmljZSA9IHRoaXMuY29uZmlnW3RoaXMuZGV2aWNlVHlwZV1bdGhpcy5udW1dO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2UubmFtZSA9IGRldmljZS5uYW1lO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2Uud2lkdGggPSBkZXZpY2Uud2lkdGg7XG4gICAgICAgICAgICB0aGlzLmRldmljZS5oZWlnaHQgPSBkZXZpY2UuaGVpZ2h0O1xuICAgICAgICAgICAgdGhpcy5kZXZpY2UucmF0aW8gPSBkZXZpY2UucmF0aW87XG4gICAgICAgIH0sXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDliKDpmaToh6rlrprkuYnorr7lpIdcbiAgICAgICAgICovXG4gICAgICAgIGRlbGV0ZURldmljZShudW06IG51bWJlcikge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5jdXN0b21bbnVtXSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGRldmljZU5hbWUgPSB0aGlzLmNvbmZpZy5jdXN0b21bbnVtXS5uYW1lO1xuICAgICAgICAgICAgdGhpcy5jb25maWcuY3VzdG9tLnNwbGljZShudW0sIDEpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5kZXZpY2VUeXBlID09PSAnY3VzdG9tJyAmJiBudW0gPD0gdGhpcy5udW0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5jdXN0b20ubGVuZ3RoID09PSAwID8gdGhpcy5jaG9vc2VEZXZpY2UoJ2J1aWx0aW4nLCAwKSA6IHRoaXMuY2hvb3NlRGV2aWNlKCdjdXN0b20nLCB0aGlzLm51bSAtIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKCdkZXZpY2UnLCAnY3VzdG9tJywgdGhpcy5jb25maWcuY3VzdG9tLCAnZ2xvYmFsJyk7XG4gICAgICAgICAgICAvLyDliKDpmaQgZW5hYmxlZCDliJfooajnmoTorr7lpIdcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jb25maWcuZW5hYmxlLmluZGV4T2YoZGV2aWNlTmFtZSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcuZW5hYmxlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKCdkZXZpY2UnLCAnZW5hYmxlJywgdGhpcy5jb25maWcuZW5hYmxlLCAnZ2xvYmFsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlkK8v5YGc55So6K6+5aSHXG4gICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYm9vbFxuICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAgICAgKi9cbiAgICAgICAgYXN5bmMgc3dpdGNoRW5hYmxlKGJvb2w6IGJvb2xlYW4sIG5hbWU6IHN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmNvbmZpZy5lbmFibGUuaW5kZXhPZihuYW1lKTtcbiAgICAgICAgICAgIGlmIChib29sKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5lbmFibGUucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKCdkZXZpY2UnLCAnZW5hYmxlJywgdGhpcy5jb25maWcuZW5hYmxlLCAnZ2xvYmFsJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLmVuYWJsZS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBFZGl0b3IuUHJvZmlsZS5zZXRDb25maWcoJ2RldmljZScsICdlbmFibGUnLCB0aGlzLmNvbmZpZy5lbmFibGUsICdnbG9iYWwnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDlkK/lgZznlKjorr7lpIfvvIzlub/mkq3mtojmga9cbiAgICAgICAgICAgIEVkaXRvci5NZXNzYWdlLmJyb2FkY2FzdCgnZGV2aWNlOmRldmljZXMtY2hhbmdlZCcpO1xuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog5qCh6aqM6K6+5aSH5piv5ZCm5bey5a2Y5ZyoXG4gICAgICAgICAqL1xuICAgICAgICBpc0RldmljZU5hbWVFeGlzdChkZXZpY2VOYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5idWlsdGluLnNvbWUoKGRldmljZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRldmljZU5hbWUgPT09IGRldmljZS5uYW1lO1xuICAgICAgICAgICAgfSkgfHxcbiAgICAgICAgICAgIHRoaXMuY29uZmlnLmN1c3RvbS5zb21lKChkZXZpY2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBkZXZpY2VOYW1lID09PSBkZXZpY2UubmFtZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICAvKipcbiAgICAgICAgICog5Yik5pat6K6+5aSH5L+h5oGv5piv5ZCm5L+u5pS5XG4gICAgICAgICAqL1xuICAgICAgICBpc0RldmljZUNoYW5nZWQoKTogYm9vbGVhbiB7XG4gICAgICAgICAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmNvbmZpZy5jdXN0b21bdGhpcy5udW1dO1xuICAgICAgICAgICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGRldmljZSkge1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBpZiAoZGV2aWNlW2tleV0gIT09IHRoaXMuZGV2aWNlW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG4gICAgICAgIH0sXG4gICAgfSxcbiAgICB0ZW1wbGF0ZTogdnVlVGVtcGxhdGUsXG59KTtcblxuZXhwb3J0IGNvbnN0IHN0eWxlID0gcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi9wcmVmZXJlbmNlcy5jc3MnKSwgJ3V0ZjgnKTtcblxuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gJzxkaXYgY2xhc3M9XCJjb250YWluZXJcIj48L2Rpdj4nO1xuXG5leHBvcnQgY29uc3QgJCA9IHtcbiAgICBjb250YWluZXI6ICcuY29udGFpbmVyJyxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkeSgpIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgcGFuZWwgPSB0aGlzO1xuXG4gICAgcGFuZWwudm0/LiRkZXN0cm95KCk7XG4gICAgcGFuZWwudm0gPSBuZXcgRGV2aWNlUHJlZmVyZW5jZVZNKCk7XG4gICAgcGFuZWwudm0uJG1vdW50KHBhbmVsLiQuY29udGFpbmVyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsb3NlKCkge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBwYW5lbCA9IHRoaXM7XG5cbiAgICBwYW5lbC52bT8uJGRlc3Ryb3koKTtcbiAgICBwYW5lbC52bSA9IG51bGw7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleHBvcnRDb25maWcoKSB7XG4gICAgY29uc3QgY29uZmlnczogRXhwb3J0Q29uZmlnID0ge307XG4gICAgY29uZmlncy5jdXN0b20gPSB7XG4gICAgICAgIHR5cGU6ICdnbG9iYWwnLFxuICAgICAgICB2YWx1ZTogYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgncHJlZmVyZW5jZXMnLCAncXVlcnktY29uZmlnJywgJ2RldmljZScsICdjdXN0b20nKSxcbiAgICB9O1xuICAgIGNvbmZpZ3MuZW5hYmxlID0ge1xuICAgICAgICB0eXBlOiAnZ2xvYmFsJyxcbiAgICAgICAgdmFsdWU6IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3ByZWZlcmVuY2VzJywgJ3F1ZXJ5LWNvbmZpZycsICdkZXZpY2UnLCAnZW5hYmxlJyksXG4gICAgfTtcbiAgICByZXR1cm4gY29uZmlncztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGltcG9ydENvbmZpZyhjb25maWdzOiBFeHBvcnRDb25maWcpIHtcbiAgICBjb25maWdzLmN1c3RvbSAmJiBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdwcmVmZXJlbmNlcycsICdzZXQtY29uZmlnJywgJ2RldmljZScsICdjdXN0b20nLCBjb25maWdzLmN1c3RvbS52YWx1ZSwgJ2dsb2JhbCcpO1xuICAgIGNvbmZpZ3MuZW5hYmxlICYmIGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3ByZWZlcmVuY2VzJywgJ3NldC1jb25maWcnLCAnZGV2aWNlJywgJ2VuYWJsZScsIGNvbmZpZ3MuZW5hYmxlLnZhbHVlLCAnZ2xvYmFsJyk7XG59XG4iXX0=