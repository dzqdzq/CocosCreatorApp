"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.execAsync=exports.queryProcessListOfWin32=exports.queryProcessListOfDarwin=exports.queryProcessTree=void 0;const os_1=require("os"),child_process_1=require("child_process"),path_1=require("path");async function queryProcessTree(e){const r={};let s=null;function t(e){return r[e.pid]||(r[e.pid]=[]),{detail:{pid:e.pid,ppid:e.ppid,name:e.name,cmd:e.cmd,memory:e.memory,cpu:e.cpu},showArrow:!!r[e.pid].length,children:r[e.pid]}}return("darwin"===process.platform?await queryProcessListOfDarwin():await queryProcessListOfWin32(e)).forEach(i=>{i.pid===e&&(s=t(i)),r[i.ppid]?r[i.ppid].push(t(i)):r[i.ppid]=[t(i)]}),s}exports.queryProcessTree=queryProcessTree;const PS_REG=/^\s*([0-9]+)\s+([0-9]+)\s+([0-9]+\.[0-9]+)\s+([0-9]+\.[0-9]+)\s+(.+)$/;async function queryProcessListOfDarwin(){const e=os_1.totalmem();try{const r=await execAsync("which ps"),s=(await execAsync(`${r} -ax -o pid=,ppid=,pcpu=,pmem=,command=,comm=`)).toString().split("\n"),t=[];return s.forEach(r=>{const s=PS_REG.exec(r);s&&6===s.length&&t.push({name:path_1.basename(s[5]).replace(/--.*/,""),pid:Number(s[1]),ppid:Number(s[2]),cmd:s[5],cpu:Number(s[3]),memory:Math.ceil(Number(s[4])/100*e/1024/1024)})}),t}catch(e){return[]}}async function queryProcessListOfWin32(e){const r=path_1.join(Editor.App.path,"../tools/windows-process-tree");try{require(r)}catch(e){return[]}const s=require(r);return new Promise(r=>{s.getProcessList(e,e=>{s.getProcessCpuUsage(e,e=>{const s=[];e.forEach(e=>{const r=(e=>0===e.indexOf("\\\\?\\")?e.substr(4):0===e.indexOf("\\??\\")?e.substr(4):0===e.indexOf('"\\\\?\\')?'"'+e.substr(5):0===e.indexOf('"\\??\\')?'"'+e.substr(5):e)(e.commandLine||"");s.push(e.pid,{name:function(e){const r=/--utility-sub-type=network/;let s=/--type=([a-zA-Z-]+)/.exec(e);if(s&&2===s.length)return"renderer"===s[1]?"window":"utility"===s[1]&&r.exec(e)?"utility-network-service":s[1];const t=/[a-zA-Z-]+\.js/g;let i="";do{(s=t.exec(e))&&(i+=s+" ")}while(s);return i&&e.indexOf("node ")<0&&e.indexOf("node.exe")<0?`electron_node ${i}`:e}(r),pid:e.pid,ppid:e.ppid,cmd:r,cpu:e.cpu||0,memory:e.memory||0})}),r(s)})},s.ProcessDataFlag.CommandLine|s.ProcessDataFlag.Memory)})}async function execAsync(e,r={}){return new Promise((s,t)=>{child_process_1.exec(e,r,(e,r,i)=>{if(e||i)return t(e||i.toString().trim());s(r.toString().trim())})})}exports.queryProcessListOfDarwin=queryProcessListOfDarwin,exports.queryProcessListOfWin32=queryProcessListOfWin32,exports.execAsync=execAsync;