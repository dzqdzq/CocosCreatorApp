"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.execAsync=exports.queryProcessListOfWin32=exports.queryProcessListOfDarwin=exports.queryProcessTree=exports.processNameMap=void 0;const os_1=require("os"),child_process_1=require("child_process"),path_1=require("path"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker");async function queryProcessTree(e){const r="darwin"===process.platform?await queryProcessListOfDarwin():await queryProcessListOfWin32(e),s={},t=module.exports.processNameMap;let i=null;async function o(e){s[e.pid]||(s[e.pid]=[]);let r="";if(t[e.pid])r=t[e.pid];else if("window"===e.name)for(const s of windows.uuids){if(windows.uuid2win[s].webContents.getOSProcessId()===e.pid){r=windows.uuid2win[s].title,t[e.pid]=r;break}for(const s of["Build","Asset DB","Programming"]){const i=worker.query(s);if(i&&i.win.webContents.getOSProcessId()===e.pid){r=i.win.title,t[e.pid]=r;break}}}return{detail:{pid:e.pid,ppid:e.ppid,name:r||e.name,cmd:e.cmd,memory:e.memory,cpu:e.cpu},showArrow:!!s[e.pid].length,children:s[e.pid]}}for(const t of r){const r=await o(t);t.pid===e&&(i=r),s[t.ppid]?s[t.ppid].push(r):s[t.ppid]=[r]}return i}exports.processNameMap={},exports.queryProcessTree=queryProcessTree;const PS_REG=/^\s*([0-9]+)\s+([0-9]+)\s+([0-9]+\.[0-9]+)\s+([0-9]+\.[0-9]+)\s+(.+)$/;async function queryProcessListOfDarwin(){const e=os_1.totalmem();try{const r=await execAsync("which ps"),s=(await execAsync(`${r} -ax -o pid=,ppid=,pcpu=,pmem=,command=,comm=`)).toString().split("\n"),t=[];return s.forEach(r=>{const s=PS_REG.exec(r);s&&6===s.length&&t.push({name:path_1.basename(s[5]).replace(/--.*/,""),pid:Number(s[1]),ppid:Number(s[2]),cmd:s[5],cpu:Number(s[3]).toFixed(2),memory:Math.ceil(Number(s[4])/100*e/1024/1024)})}),t}catch(e){return[]}}async function queryProcessListOfWin32(e){const r=path_1.join(Editor.App.path,"../tools/windows-process-tree");try{require(r)}catch(e){return[]}const s=require(r);return new Promise(r=>{s.getProcessList(e,e=>{s.getProcessCpuUsage(e,e=>{const s=[];e.forEach(e=>{const r=(e=>0===e.indexOf("\\\\?\\")?e.substr(4):0===e.indexOf("\\??\\")?e.substr(4):0===e.indexOf('"\\\\?\\')?'"'+e.substr(5):0===e.indexOf('"\\??\\')?'"'+e.substr(5):e)(e.commandLine||"");s.push(e.pid,{name:function(e){const r=/--utility-sub-type=network/;let s=/--type=([a-zA-Z-]+)/.exec(e);if(s&&2===s.length)return"renderer"===s[1]?"window":"utility"===s[1]&&r.exec(e)?"utility-network-service":s[1];const t=/[a-zA-Z-]+\.js/g;let i="";do{(s=t.exec(e))&&(i+=s+" ")}while(s);return i&&e.indexOf("node ")<0&&e.indexOf("node.exe")<0?`electron_node ${i}`:e}(r),pid:e.pid,ppid:e.ppid,cmd:r,cpu:e.cpu.toFixed(2)||0,memory:Math.ceil(e.memory/1024/1024)||0})}),r(s)})},s.ProcessDataFlag.CommandLine|s.ProcessDataFlag.Memory)})}async function execAsync(e,r={}){return new Promise((s,t)=>{child_process_1.exec(e,r,(e,r,i)=>{if(e||i)return t(e||i.toString().trim());s(r.toString().trim())})})}exports.queryProcessListOfDarwin=queryProcessListOfDarwin,exports.queryProcessListOfWin32=queryProcessListOfWin32,exports.execAsync=execAsync;