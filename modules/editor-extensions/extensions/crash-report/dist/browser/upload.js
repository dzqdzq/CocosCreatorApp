"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.uploadMgr = exports.UploadMgr = exports.UploadFileInfo = void 0;
const axios_1 = __importDefault(require("axios"));
const fs_extra_1 = require("fs-extra");
const utils_1 = require("../utils");
const stream_1 = require("stream");
const path_1 = require("path");
/**
 * 由于我们 node 环境的模式，是不支持 es 的写法，
 * 需要写一个不进行编译的 js 脚本来加载 formdata-node 数据
 */
const { FormData, Blob, File } = require('formdata-node');
const { FormDataEncoder } = require('form-data-encoder');
const hmacSHA256 = require('crypto-js/hmac-sha256');
class UploadFileInfo {
    constructor() {
        this.file = Buffer.from(''); // 文件 buffer
        this.fileMd5 = ''; // 文件 md5
        this.partMd5 = ''; // 分片 md5
        this.name = 'unknow'; // 文件名
        this.size = 0; // 文件大小
        this.index = 1; // 第几个分片
        this.total = 1; // 总分片数
        this.action = 'upload'; // 动作类型：文件上传状态检查/上传, eg: check/upload
        this.projectId = 'CreatorAnalytics'; // 项目编码
        this.serviceId = 'crash-report'; // 服务标识（存放的目录）
        this.cuser = 'sys'; // 创建人
        this.tags = ''; // 标签
        this.isFuzzy = false; // 文件名是否模糊化
        this.uploadFlag = 0; // 上传 CDN（0只上传原始桶 3原始桶和国内外CDN同时上传）
    }
    toFormData() {
        const formData = new FormData();
        for (const key in this) {
            const value = this[key];
            if (Buffer.isBuffer(value)) {
                formData.append(key, new Blob([value.buffer]));
            }
            else {
                formData.append(key, String(value));
            }
        }
        return formData;
    }
}
exports.UploadFileInfo = UploadFileInfo;
// 将对象属性名，按 abcd.. 顺序排序。
function sortObjectKey(data) {
    const sortData = {};
    Object.keys(data)
        .sort()
        .map((key) => {
        sortData[key] = data[key];
    });
    return sortData;
}
/**
 * 文件上传 cdn 签名计算
 * 将该函数运行结果加入 http 请求头
 * @param data body 请求入参
 * @param url 请求路径的 path部分，不包含host部分。 eg:/cdn/getByPage
 * http://docs-console.cocos.org/#/backEnd/aksk?id=js-%e7%ad%be%e5%90%8d%e6%a0%b7%e4%be%8b
 * @param ak
 * @param sk
 * @param projectId
 */
function getReqSignature(data, url, ak, sk, projectId) {
    const timestamp = new Date().getTime();
    const reqBody = {};
    data.forEach((value, key) => {
        const valueType = value.toString();
        // 参数若包含文件，不加入签名计算
        if (valueType !== '[object File]' && valueType !== '[object Blob]') {
            reqBody[key] = value;
        }
    });
    const sortData = sortObjectKey(reqBody);
    let signString = '';
    for (const prop in sortData) {
        if ({}.hasOwnProperty.call(sortData, prop)) {
            signString += `${prop}=${sortData[prop]}&`;
        }
    }
    const signature = hmacSHA256(`${projectId}&${signString}${url}&${timestamp}`, sk).toString();
    return {
        grantType: 'aksk',
        accessKey: ak,
        projectId,
        timestamp,
        signature,
    };
}
class UploadMgr {
    constructor() {
        // cnd 存放的目录位置
        this.serviceId = 'crash-report';
        // ==== dev
        // baseURL = 'https://dev-gateway.cocos.org';
        // projectId = 'CreatorAnalytics';
        // ak = 'b234aba226ca401cb00492e32f41a62f';
        // sk = 'e0fae81ecad14d1f880c6f3365168589';
        // ====
        this.baseURL = 'https://gateway.cocos.com';
        this.projectId = 'CreatorAnalytics';
        this.ak = '107c2c83ea164b5682f9ffc8eede42ab';
        this.sk = '1131702614884bafba5a4fddaa73a8ed';
        // 上传大文件
        this.apiURL = '/cdn/uploadFileByCache';
        // 校验身份 A018AP001 -> allowCrashReport
        this.allowCrashReportAPIURL = '/A018/v1/A018AP001';
        this.client = axios_1.default.create({
            timeout: 2 * 60 * 1000,
        });
        this.client.interceptors.request.use(config => {
            if (config.data instanceof FormData) {
                const __apiURL__ = config.data.get('__apiURL__') || this.apiURL;
                config.data.delete('__apiURL__');
                config.maxContentLength = Infinity;
                const encoder = new FormDataEncoder(config.data);
                const headers = config.headers;
                config.headers = {
                    ...headers,
                    ...encoder.headers,
                    ...getReqSignature(config.data, __apiURL__, this.ak, this.sk, this.projectId),
                };
                config.data = stream_1.Readable.from(encoder.encode());
            }
            return config;
        });
    }
    /**
     * 校验用户是否符合提交报告资源
     */
    async check() {
        try {
            // @ts-ignore TODO 后续类型更新了在删除
            const { access_token } = await Editor.User.getUserToken();
            const formData = new FormData();
            formData.append('__apiURL__', this.allowCrashReportAPIURL);
            // @ts-ignore TODO 后续类型更新了在删除
            formData.append('access_token', String(access_token));
            const { data: result } = await this.client.post(this.baseURL + this.allowCrashReportAPIURL, formData);
            return result.data;
        }
        catch (e) {
            console.error(e);
            return false;
        }
    }
    /**
     * 打包多个 zip 并上传到 cdn
     * @param description
     * @param infos
     */
    async packMultipleZipAndUpload(description, infos) {
        for (let i = 0; i < infos.length; i++) {
            await this.packZipAndUpload(description, infos[i]);
        }
    }
    /**
     * 打包 zip 并上传到 cdn
     * @param description
     * @param info
     */
    packZipAndUpload(description, info) {
        const JsZip = require('jszip');
        const zip = new JsZip();
        // 问题描述
        zip.file('问题描述.txt', description || '未描述');
        // 编辑器日志
        try {
            zip.file('编辑器日志.log', fs_extra_1.readFileSync(info.editorLog));
        }
        catch (e) {
            zip.file('未找到编辑器日志.log', String(e));
        }
        // asset-db 日志
        try {
            const dbLogPath = utils_1.getLatestFilePath(info.dbLog, '.log');
            zip.file('AssetDB日志.log', fs_extra_1.readFileSync(dbLogPath));
        }
        catch (e) {
            zip.file('未找到AssetDB日志.log', String(e));
        }
        // 构建日志
        try {
            const buildLogPath = utils_1.getLatestFilePath(info.buildLog, '.log');
            zip.file('构建日志.log', fs_extra_1.readFileSync(buildLogPath));
        }
        catch (e) {
            zip.file('未找到构建日志.log', String(e));
        }
        // crash 文件
        try {
            const crashLogPath = utils_1.getLatestFilePath(info.crashLog, '.dmp');
            zip.file(path_1.basename(crashLogPath), fs_extra_1.readFileSync(crashLogPath));
        }
        catch (e) {
            zip.file('未找到 Crash 文件.log', String(e));
        }
        // 项目信息
        try {
            zip.file('项目信息.json', fs_extra_1.readFileSync(info.projectJSON));
        }
        catch (e) {
            zip.file('未找到项目信息.json', String(e));
        }
        // 崩溃详细信息
        zip.file('崩溃详细信息.json', Buffer.from(JSON.stringify(info, null, 4)));
        return new Promise(((resolve, reject) => {
            zip.generateAsync({
                type: 'nodebuffer',
                compression: 'DEFLATE',
                compressionOptions: {
                    level: 9,
                },
            })
                .then(async (buffer) => {
                try {
                    await this.upload(info, buffer, `{"Crash_${info.process}": "Crash_${info.process}"}`);
                    resolve(null);
                }
                catch (e) {
                    reject(e);
                }
            });
        }));
    }
    /**
     * 上传
     * @param info
     * @param zipFile
     * @param tags
     */
    async upload(info, zipFile, tags) {
        // 限制大小
        const chunk_size = 10485760;
        const total_size = zipFile.length;
        let current_chunk = 1;
        const total_chunk = Math.ceil(total_size / chunk_size);
        const zipMD5File = utils_1.calcMd5(zipFile);
        const name = info.zipName;
        let start = 0;
        let end = 0;
        while (current_chunk <= total_chunk) {
            start = (current_chunk - 1) * chunk_size;
            end = Math.min(total_size, start + chunk_size);
            await this.uploadSlice({
                name: name,
                file: Buffer.from(zipFile.slice(start, end)),
                size: total_size,
                index: current_chunk,
                total: total_chunk,
                tags: tags,
                fileMd5: zipMD5File,
                cuser: info.uid,
            });
            current_chunk++;
        }
    }
    /**
     * 分片上传
     */
    async uploadSlice(sliceInfo) {
        try {
            const info = new UploadFileInfo();
            info.file = sliceInfo.file;
            info.size = sliceInfo.size;
            info.index = sliceInfo.index;
            info.total = sliceInfo.total;
            info.partMd5 = utils_1.calcMd5(sliceInfo.file);
            info.fileMd5 = sliceInfo.fileMd5;
            info.name = sliceInfo.name;
            info.serviceId = 'crash-report';
            info.projectId = 'CreatorAnalytics';
            info.cuser = sliceInfo.cuser;
            info.tags = sliceInfo.tags;
            console.debug('>>> upload data：', info);
            const result = await this.client.post(this.baseURL + this.apiURL, info.toFormData());
            console.debug(`>>> upload data${result?.data?.code !== 200 ? 'failed' : 'successful'}，info：`, result);
        }
        catch (e) {
            console.error('>>> upload failed', e);
        }
    }
}
exports.UploadMgr = UploadMgr;
exports.uploadMgr = new UploadMgr();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvdXBsb2FkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtEQUE2QztBQUM3Qyx1Q0FBd0M7QUFHeEMsb0NBQXNEO0FBQ3RELG1DQUFrQztBQUNsQywrQkFBZ0M7QUFDaEM7OztHQUdHO0FBQ0gsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzFELE1BQU0sRUFBRSxlQUFlLEVBQUUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUN6RCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUVwRCxNQUFhLGNBQWM7SUFBM0I7UUFDSSxTQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVk7UUFDcEMsWUFBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFNBQVM7UUFDdkIsWUFBTyxHQUFHLEVBQUUsQ0FBQyxDQUFBLFNBQVM7UUFDdEIsU0FBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLE1BQU07UUFDdkIsU0FBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDakIsVUFBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVE7UUFDbkIsVUFBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDbEIsV0FBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLHFDQUFxQztRQUN4RCxjQUFTLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxPQUFPO1FBQ3ZDLGNBQVMsR0FBRyxjQUFjLENBQUMsQ0FBQyxjQUFjO1FBQzFDLFVBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxNQUFNO1FBQ3JCLFNBQUksR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLO1FBQ2hCLFlBQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxXQUFXO1FB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LGtCQUFrQixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsWUFBWSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDekc7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDekM7SUFDTCxDQUFDO0NBQ0o7QUF4TUQsOEJBd01DO0FBRVksUUFBQSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcywgeyBBeGlvc0luc3RhbmNlIH0gZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xuXG5pbXBvcnQgeyBDcmFzaFJlcG9ydCB9IGZyb20gJy4uL2RhdGEnO1xuaW1wb3J0IHsgY2FsY01kNSwgZ2V0TGF0ZXN0RmlsZVBhdGggfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBSZWFkYWJsZSB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBiYXNlbmFtZSB9IGZyb20gJ3BhdGgnO1xuLyoqXG4gKiDnlLHkuo7miJHku6wgbm9kZSDnjq/looPnmoTmqKHlvI/vvIzmmK/kuI3mlK/mjIEgZXMg55qE5YaZ5rOV77yMXG4gKiDpnIDopoHlhpnkuIDkuKrkuI3ov5vooYznvJbor5HnmoQganMg6ISa5pys5p2l5Yqg6L29IGZvcm1kYXRhLW5vZGUg5pWw5o2uXG4gKi9cbmNvbnN0IHsgRm9ybURhdGEsIEJsb2IsIEZpbGUgfSA9IHJlcXVpcmUoJ2Zvcm1kYXRhLW5vZGUnKTtcbmNvbnN0IHsgRm9ybURhdGFFbmNvZGVyIH0gPSByZXF1aXJlKCdmb3JtLWRhdGEtZW5jb2RlcicpO1xuY29uc3QgaG1hY1NIQTI1NiA9IHJlcXVpcmUoJ2NyeXB0by1qcy9obWFjLXNoYTI1NicpO1xuXG5leHBvcnQgY2xhc3MgVXBsb2FkRmlsZUluZm8ge1xuICAgIGZpbGUgPSBCdWZmZXIuZnJvbSgnJyk7IC8vIOaWh+S7tiBidWZmZXJcbiAgICBmaWxlTWQ1ID0gJyc7IC8vIOaWh+S7tiBtZDVcbiAgICBwYXJ0TWQ1ID0gJyc7Ly8g5YiG54mHIG1kNVxuICAgIG5hbWUgPSAndW5rbm93JzsgLy8g5paH5Lu25ZCNXG4gICAgc2l6ZSA9IDA7IC8vIOaWh+S7tuWkp+Wwj1xuICAgIGluZGV4ID0gMTsgLy8g56ys5Yeg5Liq5YiG54mHXG4gICAgdG90YWwgPSAxOyAvLyDmgLvliIbniYfmlbBcbiAgICBhY3Rpb24gPSAndXBsb2FkJzsgLy8g5Yqo5L2c57G75Z6L77ya5paH5Lu25LiK5Lyg54q25oCB5qOA5p+lL+S4iuS8oCwgZWc6IGNoZWNrL3VwbG9hZFxuICAgIHByb2plY3RJZCA9ICdDcmVhdG9yQW5hbHl0aWNzJzsgLy8g6aG555uu57yW56CBXG4gICAgc2VydmljZUlkID0gJ2NyYXNoLXJlcG9ydCc7IC8vIOacjeWKoeagh+ivhu+8iOWtmOaUvueahOebruW9le+8iVxuICAgIGN1c2VyID0gJ3N5cyc7IC8vIOWIm+W7uuS6ulxuICAgIHRhZ3MgPSAnJzsgLy8g5qCH562+XG4gICAgaXNGdXp6eSA9IGZhbHNlOyAvLyDmlofku7blkI3mmK/lkKbmqKHns4rljJZcbiAgICB1cGxvYWRGbGFnID0gMDsgLy8g5LiK5LygIENETu+8iDDlj6rkuIrkvKDljp/lp4vmobYgM+WOn+Wni+ahtuWSjOWbveWGheWklkNETuWQjOaXtuS4iuS8oO+8iVxuXG4gICAgdG9Gb3JtRGF0YSgpIHtcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcykge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW2tleV07XG4gICAgICAgICAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChrZXksIG5ldyBCbG9iKFt2YWx1ZS5idWZmZXJdKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChrZXksIFN0cmluZyh2YWx1ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmb3JtRGF0YTtcbiAgICB9XG59XG5cbi8vIOWwhuWvueixoeWxnuaAp+WQje+8jOaMiSBhYmNkLi4g6aG65bqP5o6S5bqP44CCXG5mdW5jdGlvbiBzb3J0T2JqZWN0S2V5KGRhdGE6IGFueSkge1xuICAgIGNvbnN0IHNvcnREYXRhOiBhbnkgPSB7fTtcbiAgICBPYmplY3Qua2V5cyhkYXRhKVxuICAgICAgICAuc29ydCgpXG4gICAgICAgIC5tYXAoKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBzb3J0RGF0YVtrZXldID0gZGF0YVtrZXldO1xuICAgICAgICB9KTtcblxuICAgIHJldHVybiBzb3J0RGF0YTtcbn1cblxuLyoqXG4gKiDmlofku7bkuIrkvKAgY2RuIOetvuWQjeiuoeeul1xuICog5bCG6K+l5Ye95pWw6L+Q6KGM57uT5p6c5Yqg5YWlIGh0dHAg6K+35rGC5aS0XG4gKiBAcGFyYW0gZGF0YSBib2R5IOivt+axguWFpeWPglxuICogQHBhcmFtIHVybCDor7fmsYLot6/lvoTnmoQgcGF0aOmDqOWIhu+8jOS4jeWMheWQq2hvc3Tpg6jliIbjgIIgZWc6L2Nkbi9nZXRCeVBhZ2VcbiAqIGh0dHA6Ly9kb2NzLWNvbnNvbGUuY29jb3Mub3JnLyMvYmFja0VuZC9ha3NrP2lkPWpzLSVlNyVhZCViZSVlNSU5MCU4ZCVlNiVhMCViNyVlNCViZSU4YlxuICogQHBhcmFtIGFrXG4gKiBAcGFyYW0gc2tcbiAqIEBwYXJhbSBwcm9qZWN0SWRcbiAqL1xuZnVuY3Rpb24gZ2V0UmVxU2lnbmF0dXJlKGRhdGE6IEZvcm1EYXRhLCB1cmw6IHN0cmluZywgYWs6IHN0cmluZywgc2s6IHN0cmluZywgcHJvamVjdElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICBjb25zdCByZXFCb2R5OiBhbnkgPSB7fTtcbiAgICBkYXRhLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgY29uc3QgdmFsdWVUeXBlID0gdmFsdWUudG9TdHJpbmcoKTtcbiAgICAgICAgLy8g5Y+C5pWw6Iul5YyF5ZCr5paH5Lu277yM5LiN5Yqg5YWl562+5ZCN6K6h566XXG4gICAgICAgIGlmICh2YWx1ZVR5cGUgIT09ICdbb2JqZWN0IEZpbGVdJyAmJiB2YWx1ZVR5cGUgIT09ICdbb2JqZWN0IEJsb2JdJykge1xuICAgICAgICAgICAgcmVxQm9keVtrZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHNvcnREYXRhID0gc29ydE9iamVjdEtleShyZXFCb2R5KTtcbiAgICBsZXQgc2lnblN0cmluZyA9ICcnO1xuICAgIGZvciAoY29uc3QgcHJvcCBpbiBzb3J0RGF0YSkge1xuICAgICAgICBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChzb3J0RGF0YSwgcHJvcCkpIHtcbiAgICAgICAgICAgIHNpZ25TdHJpbmcgKz0gYCR7cHJvcH09JHtzb3J0RGF0YVtwcm9wXX0mYDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBzaWduYXR1cmUgPSBobWFjU0hBMjU2KGAke3Byb2plY3RJZH0mJHtzaWduU3RyaW5nfSR7dXJsfSYke3RpbWVzdGFtcH1gLCBzaykudG9TdHJpbmcoKTtcbiAgICByZXR1cm4ge1xuICAgICAgICBncmFudFR5cGU6ICdha3NrJyxcbiAgICAgICAgYWNjZXNzS2V5OiBhayxcbiAgICAgICAgcHJvamVjdElkLFxuICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgIHNpZ25hdHVyZSxcbiAgICB9O1xufVxuXG4vKipcbiAqIOS4iuS8oOWIh+eJh+aJgOmcgOimgeeahOaVsOaNrlxuICovXG5pbnRlcmZhY2UgVXBsb2FkU2xpY2VJbmZvIHtcbiAgICAvLyDlkI3lrZdcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgLy8g5paH5Lu2IGJ1ZmZlclxuICAgIGZpbGU6IEJ1ZmZlcixcbiAgICAvLyDmlofku7blpKflsI9cbiAgICBzaXplOiBudW1iZXIsXG4gICAgLy8g5b2T5YmN5YiG54mHXG4gICAgaW5kZXg6IG51bWJlcixcbiAgICAvLyDmgLvliIbniYdcbiAgICB0b3RhbDogbnVtYmVyLFxuICAgIC8vIOagh+etvlxuICAgIHRhZ3M6IHN0cmluZyxcbiAgICAvLyDmgLvmlofku7bnmoQgbWQ1XG4gICAgZmlsZU1kNTogc3RyaW5nLFxuICAgIC8vXG4gICAgY3VzZXI6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFVwbG9hZE1nciB7XG4gICAgLy8gY25kIOWtmOaUvueahOebruW9leS9jee9rlxuICAgIHNlcnZpY2VJZCA9ICdjcmFzaC1yZXBvcnQnO1xuXG4gICAgLy8gPT09PSBkZXZcbiAgICAvLyBiYXNlVVJMID0gJ2h0dHBzOi8vZGV2LWdhdGV3YXkuY29jb3Mub3JnJztcbiAgICAvLyBwcm9qZWN0SWQgPSAnQ3JlYXRvckFuYWx5dGljcyc7XG4gICAgLy8gYWsgPSAnYjIzNGFiYTIyNmNhNDAxY2IwMDQ5MmUzMmY0MWE2MmYnO1xuICAgIC8vIHNrID0gJ2UwZmFlODFlY2FkMTRkMWY4ODBjNmYzMzY1MTY4NTg5JztcbiAgICAvLyA9PT09XG4gICAgYmFzZVVSTCA9ICdodHRwczovL2dhdGV3YXkuY29jb3MuY29tJztcbiAgICBwcm9qZWN0SWQgPSAnQ3JlYXRvckFuYWx5dGljcyc7XG4gICAgYWsgPSAnMTA3YzJjODNlYTE2NGI1NjgyZjlmZmM4ZWVkZTQyYWInO1xuICAgIHNrID0gJzExMzE3MDI2MTQ4ODRiYWZiYTVhNGZkZGFhNzNhOGVkJztcblxuICAgIC8vIOS4iuS8oOWkp+aWh+S7tlxuICAgIGFwaVVSTCA9ICcvY2RuL3VwbG9hZEZpbGVCeUNhY2hlJztcbiAgICAvLyDmoKHpqozouqvku70gQTAxOEFQMDAxIC0+IGFsbG93Q3Jhc2hSZXBvcnRcbiAgICBhbGxvd0NyYXNoUmVwb3J0QVBJVVJMID0gJy9BMDE4L3YxL0EwMThBUDAwMSc7XG5cbiAgICBjbGllbnQ6IEF4aW9zSW5zdGFuY2U7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBheGlvcy5jcmVhdGUoe1xuICAgICAgICAgICAgdGltZW91dDogMiAqIDYwICogMTAwMCxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2xpZW50LmludGVyY2VwdG9ycy5yZXF1ZXN0LnVzZShcbiAgICAgICAgICAgIGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgX19hcGlVUkxfXyA9IGNvbmZpZy5kYXRhLmdldCgnX19hcGlVUkxfXycpIHx8IHRoaXMuYXBpVVJMO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuZGF0YS5kZWxldGUoJ19fYXBpVVJMX18nKTtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1heENvbnRlbnRMZW5ndGggPSBJbmZpbml0eTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5jb2RlciA9IG5ldyBGb3JtRGF0YUVuY29kZXIoY29uZmlnLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnM7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uaGVhZGVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmVuY29kZXIuaGVhZGVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmdldFJlcVNpZ25hdHVyZShjb25maWcuZGF0YSwgX19hcGlVUkxfXywgdGhpcy5haywgdGhpcy5zaywgdGhpcy5wcm9qZWN0SWQpLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuZGF0YSA9IFJlYWRhYmxlLmZyb20oZW5jb2Rlci5lbmNvZGUoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBjb25maWc7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5qCh6aqM55So5oi35piv5ZCm56ym5ZCI5o+Q5Lqk5oql5ZGK6LWE5rqQXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGNoZWNrKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPIOWQjue7reexu+Wei+abtOaWsOS6huWcqOWIoOmZpFxuICAgICAgICAgICAgY29uc3QgeyBhY2Nlc3NfdG9rZW4gfSA9IGF3YWl0IEVkaXRvci5Vc2VyLmdldFVzZXJUb2tlbigpO1xuICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnX19hcGlVUkxfXycsIHRoaXMuYWxsb3dDcmFzaFJlcG9ydEFQSVVSTCk7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIFRPRE8g5ZCO57ut57G75Z6L5pu05paw5LqG5Zyo5Yig6ZmkXG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjY2Vzc190b2tlbicsIFN0cmluZyhhY2Nlc3NfdG9rZW4pKTtcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YTogcmVzdWx0IH0gPSBhd2FpdCB0aGlzLmNsaWVudC5wb3N0KHRoaXMuYmFzZVVSTCArIHRoaXMuYWxsb3dDcmFzaFJlcG9ydEFQSVVSTCwgZm9ybURhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5omT5YyF5aSa5LiqIHppcCDlubbkuIrkvKDliLAgY2RuXG4gICAgICogQHBhcmFtIGRlc2NyaXB0aW9uXG4gICAgICogQHBhcmFtIGluZm9zXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHBhY2tNdWx0aXBsZVppcEFuZFVwbG9hZChkZXNjcmlwdGlvbjogc3RyaW5nLCBpbmZvczogQ3Jhc2hSZXBvcnRbXSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm9zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBhY2taaXBBbmRVcGxvYWQoZGVzY3JpcHRpb24sIGluZm9zW2ldKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOaJk+WMhSB6aXAg5bm25LiK5Lyg5YiwIGNkblxuICAgICAqIEBwYXJhbSBkZXNjcmlwdGlvblxuICAgICAqIEBwYXJhbSBpbmZvXG4gICAgICovXG4gICAgcHVibGljIHBhY2taaXBBbmRVcGxvYWQoZGVzY3JpcHRpb246IHN0cmluZywgaW5mbzogQ3Jhc2hSZXBvcnQpIHtcbiAgICAgICAgY29uc3QgSnNaaXAgPSByZXF1aXJlKCdqc3ppcCcpO1xuICAgICAgICBjb25zdCB6aXAgPSBuZXcgSnNaaXAoKTtcbiAgICAgICAgLy8g6Zeu6aKY5o+P6L+wXG4gICAgICAgIHppcC5maWxlKCfpl67popjmj4/ov7AudHh0JywgZGVzY3JpcHRpb24gfHwgJ+acquaPj+i/sCcpO1xuICAgICAgICAvLyDnvJbovpHlmajml6Xlv5dcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHppcC5maWxlKCfnvJbovpHlmajml6Xlv5cubG9nJywgcmVhZEZpbGVTeW5jKGluZm8uZWRpdG9yTG9nKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHppcC5maWxlKCfmnKrmib7liLDnvJbovpHlmajml6Xlv5cubG9nJywgU3RyaW5nKGUpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBhc3NldC1kYiDml6Xlv5dcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGRiTG9nUGF0aCA9IGdldExhdGVzdEZpbGVQYXRoKGluZm8uZGJMb2csICcubG9nJyk7XG4gICAgICAgICAgICB6aXAuZmlsZSgnQXNzZXREQuaXpeW/ly5sb2cnLCByZWFkRmlsZVN5bmMoZGJMb2dQYXRoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHppcC5maWxlKCfmnKrmib7liLBBc3NldERC5pel5b+XLmxvZycsIFN0cmluZyhlKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5p6E5bu65pel5b+XXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBidWlsZExvZ1BhdGggPSBnZXRMYXRlc3RGaWxlUGF0aChpbmZvLmJ1aWxkTG9nLCAnLmxvZycpO1xuICAgICAgICAgICAgemlwLmZpbGUoJ+aehOW7uuaXpeW/ly5sb2cnLCByZWFkRmlsZVN5bmMoYnVpbGRMb2dQYXRoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHppcC5maWxlKCfmnKrmib7liLDmnoTlu7rml6Xlv5cubG9nJywgU3RyaW5nKGUpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBjcmFzaCDmlofku7ZcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNyYXNoTG9nUGF0aCA9IGdldExhdGVzdEZpbGVQYXRoKGluZm8uY3Jhc2hMb2csICcuZG1wJyk7XG4gICAgICAgICAgICB6aXAuZmlsZShiYXNlbmFtZShjcmFzaExvZ1BhdGgpLCByZWFkRmlsZVN5bmMoY3Jhc2hMb2dQYXRoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHppcC5maWxlKCfmnKrmib7liLAgQ3Jhc2gg5paH5Lu2LmxvZycsIFN0cmluZyhlKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g6aG555uu5L+h5oGvXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB6aXAuZmlsZSgn6aG555uu5L+h5oGvLmpzb24nLCByZWFkRmlsZVN5bmMoaW5mby5wcm9qZWN0SlNPTikpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB6aXAuZmlsZSgn5pyq5om+5Yiw6aG555uu5L+h5oGvLmpzb24nLCBTdHJpbmcoZSkpO1xuICAgICAgICB9XG4gICAgICAgIC8vIOW0qea6g+ivpue7huS/oeaBr1xuICAgICAgICB6aXAuZmlsZSgn5bSp5rqD6K+m57uG5L+h5oGvLmpzb24nLCBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShpbmZvLCBudWxsLCA0KSkpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHppcC5nZW5lcmF0ZUFzeW5jKHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnbm9kZWJ1ZmZlcicsXG4gICAgICAgICAgICAgICAgY29tcHJlc3Npb246ICdERUZMQVRFJyxcbiAgICAgICAgICAgICAgICBjb21wcmVzc2lvbk9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWw6IDksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4oYXN5bmMgKGJ1ZmZlcjogQnVmZmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnVwbG9hZChpbmZvLCBidWZmZXIsIGB7XCJDcmFzaF8ke2luZm8ucHJvY2Vzc31cIjogXCJDcmFzaF8ke2luZm8ucHJvY2Vzc31cIn1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5LiK5LygXG4gICAgICogQHBhcmFtIGluZm9cbiAgICAgKiBAcGFyYW0gemlwRmlsZVxuICAgICAqIEBwYXJhbSB0YWdzXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHVwbG9hZChpbmZvOiBDcmFzaFJlcG9ydCwgemlwRmlsZTogQnVmZmVyLCB0YWdzOiBzdHJpbmcpIHtcbiAgICAgICAgLy8g6ZmQ5Yi25aSn5bCPXG4gICAgICAgIGNvbnN0IGNodW5rX3NpemUgPSAxMDQ4NTc2MDtcbiAgICAgICAgY29uc3QgdG90YWxfc2l6ZSA9IHppcEZpbGUubGVuZ3RoO1xuICAgICAgICBsZXQgY3VycmVudF9jaHVuayA9IDE7XG4gICAgICAgIGNvbnN0IHRvdGFsX2NodW5rID0gTWF0aC5jZWlsKHRvdGFsX3NpemUgLyBjaHVua19zaXplKTtcbiAgICAgICAgY29uc3QgemlwTUQ1RmlsZSA9IGNhbGNNZDUoemlwRmlsZSk7XG5cbiAgICAgICAgY29uc3QgbmFtZSA9IGluZm8uemlwTmFtZTtcblxuICAgICAgICBsZXQgc3RhcnQgPSAwO1xuICAgICAgICBsZXQgZW5kID0gMDtcbiAgICAgICAgd2hpbGUgKGN1cnJlbnRfY2h1bmsgPD0gdG90YWxfY2h1bmspIHtcbiAgICAgICAgICAgIHN0YXJ0ID0gKGN1cnJlbnRfY2h1bmsgLSAxKSAqIGNodW5rX3NpemU7XG4gICAgICAgICAgICBlbmQgPSBNYXRoLm1pbih0b3RhbF9zaXplLCBzdGFydCArIGNodW5rX3NpemUpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGxvYWRTbGljZSh7XG4gICAgICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgICAgICBmaWxlOiBCdWZmZXIuZnJvbSh6aXBGaWxlLnNsaWNlKHN0YXJ0LCBlbmQpKSxcbiAgICAgICAgICAgICAgICBzaXplOiB0b3RhbF9zaXplLFxuICAgICAgICAgICAgICAgIGluZGV4OiBjdXJyZW50X2NodW5rLFxuICAgICAgICAgICAgICAgIHRvdGFsOiB0b3RhbF9jaHVuayxcbiAgICAgICAgICAgICAgICB0YWdzOiB0YWdzLFxuICAgICAgICAgICAgICAgIGZpbGVNZDU6IHppcE1ENUZpbGUsXG4gICAgICAgICAgICAgICAgY3VzZXI6IGluZm8udWlkLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjdXJyZW50X2NodW5rKys7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDliIbniYfkuIrkvKBcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgdXBsb2FkU2xpY2Uoc2xpY2VJbmZvOiBVcGxvYWRTbGljZUluZm8pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBuZXcgVXBsb2FkRmlsZUluZm8oKTtcbiAgICAgICAgICAgIGluZm8uZmlsZSA9IHNsaWNlSW5mby5maWxlO1xuICAgICAgICAgICAgaW5mby5zaXplID0gc2xpY2VJbmZvLnNpemU7XG4gICAgICAgICAgICBpbmZvLmluZGV4ID0gc2xpY2VJbmZvLmluZGV4O1xuICAgICAgICAgICAgaW5mby50b3RhbCA9IHNsaWNlSW5mby50b3RhbDtcbiAgICAgICAgICAgIGluZm8ucGFydE1kNSA9IGNhbGNNZDUoc2xpY2VJbmZvLmZpbGUpO1xuICAgICAgICAgICAgaW5mby5maWxlTWQ1ID0gc2xpY2VJbmZvLmZpbGVNZDU7XG4gICAgICAgICAgICBpbmZvLm5hbWUgPSBzbGljZUluZm8ubmFtZTtcbiAgICAgICAgICAgIGluZm8uc2VydmljZUlkID0gJ2NyYXNoLXJlcG9ydCc7XG4gICAgICAgICAgICBpbmZvLnByb2plY3RJZCA9ICdDcmVhdG9yQW5hbHl0aWNzJztcbiAgICAgICAgICAgIGluZm8uY3VzZXIgPSBzbGljZUluZm8uY3VzZXI7XG4gICAgICAgICAgICBpbmZvLnRhZ3MgPSBzbGljZUluZm8udGFncztcblxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnPj4+IHVwbG9hZCBkYXRh77yaJywgaW5mbyk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNsaWVudC5wb3N0KHRoaXMuYmFzZVVSTCArIHRoaXMuYXBpVVJMLCBpbmZvLnRvRm9ybURhdGEoKSk7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGA+Pj4gdXBsb2FkIGRhdGEke3Jlc3VsdD8uZGF0YT8uY29kZSAhPT0gMjAwID8gJ2ZhaWxlZCcgOiAnc3VjY2Vzc2Z1bCd977yMaW5mb++8mmAsIHJlc3VsdCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJz4+PiB1cGxvYWQgZmFpbGVkJywgZSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCB1cGxvYWRNZ3IgPSBuZXcgVXBsb2FkTWdyKCk7XG4iXX0=