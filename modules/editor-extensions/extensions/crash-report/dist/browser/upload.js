"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.uploadMgr = exports.UploadMgr = exports.UploadFileInfo = void 0;
const axios_1 = __importDefault(require("axios"));
const fs_extra_1 = require("fs-extra");
const utils_1 = require("../utils");
const stream_1 = require("stream");
const path_1 = require("path");
/**
 * 由于我们 node 环境的模式，是不支持 es 的写法，
 * 需要写一个不进行编译的 js 脚本来加载 formdata-node 数据
 */
const { FormData, Blob, File } = require('formdata-node');
const { FormDataEncoder } = require('form-data-encoder');
const hmacSHA256 = require('crypto-js/hmac-sha256');
class UploadFileInfo {
    constructor() {
        this.file = Buffer.from(''); // 文件 buffer
        this.fileMd5 = ''; // 文件 md5
        this.partMd5 = ''; // 分片 md5
        this.name = 'unknow'; // 文件名
        this.size = 0; // 文件大小
        this.index = 1; // 第几个分片
        this.total = 1; // 总分片数
        this.action = 'upload'; // 动作类型：文件上传状态检查/上传, eg: check/upload
        this.projectId = 'CreatorAnalytics'; // 项目编码
        this.serviceId = 'crash-report'; // 服务标识（存放的目录）
        this.cuser = 'sys'; // 创建人
        this.tags = ''; // 标签
        this.isFuzzy = false; // 文件名是否模糊化
        this.uploadFlag = 0; // 上传 CDN（0只上传原始桶 3原始桶和国内外CDN同时上传）
    }
    toFormData() {
        const formData = new FormData();
        for (const key in this) {
            const value = this[key];
            if (Buffer.isBuffer(value)) {
                formData.append(key, new Blob([value.buffer]));
            }
            else {
                formData.append(key, String(value));
            }
        }
        return formData;
    }
}
exports.UploadFileInfo = UploadFileInfo;
// 将对象属性名，按 abcd.. 顺序排序。
function sortObjectKey(data) {
    const sortData = {};
    Object.keys(data)
        .sort()
        .map((key) => {
        sortData[key] = data[key];
    });
    return sortData;
}
/**
 * 文件上传 cdn 签名计算
 * 将该函数运行结果加入 http 请求头
 * @param data body 请求入参
 * @param url 请求路径的 path部分，不包含host部分。 eg:/cdn/getByPage
 * http://docs-console.cocos.org/#/backEnd/aksk?id=js-%e7%ad%be%e5%90%8d%e6%a0%b7%e4%be%8b
 * @param ak
 * @param sk
 * @param projectId
 */
function getReqSignature(data, url, ak, sk, projectId) {
    const timestamp = new Date().getTime();
    const reqBody = {};
    data.forEach((value, key) => {
        const valueType = value.toString();
        // 参数若包含文件，不加入签名计算
        if (valueType !== '[object File]' && valueType !== '[object Blob]') {
            reqBody[key] = value;
        }
    });
    const sortData = sortObjectKey(reqBody);
    let signString = '';
    for (const prop in sortData) {
        if ({}.hasOwnProperty.call(sortData, prop)) {
            signString += `${prop}=${sortData[prop]}&`;
        }
    }
    const signature = hmacSHA256(`${projectId}&${signString}${url}&${timestamp}`, sk).toString();
    return {
        grantType: 'aksk',
        accessKey: ak,
        projectId,
        timestamp,
        signature,
    };
}
class UploadMgr {
    constructor() {
        // cnd 存放的目录位置
        this.serviceId = 'crash-report';
        // ==== dev
        // baseURL = 'https://dev-gateway.cocos.org';
        // projectId = 'CreatorAnalytics';
        // ak = 'b234aba226ca401cb00492e32f41a62f';
        // sk = 'e0fae81ecad14d1f880c6f3365168589';
        // ====
        this.baseURL = 'https://gateway.cocos.com';
        this.projectId = 'CreatorAnalytics';
        this.ak = '107c2c83ea164b5682f9ffc8eede42ab';
        this.sk = '1131702614884bafba5a4fddaa73a8ed';
        // 上传大文件
        this.apiURL = '/cdn/uploadFileByCache';
        // 校验身份 A018AP001 -> allowCrashReport
        this.allowCrashReportAPIURL = '/A018/v1/A018AP001';
        this.client = axios_1.default.create({
            timeout: 2 * 60 * 1000,
        });
        this.client.interceptors.request.use(config => {
            if (config.data instanceof FormData) {
                const __apiURL__ = config.data.get('__apiURL__') || this.apiURL;
                config.data.delete('__apiURL__');
                config.maxContentLength = Infinity;
                const encoder = new FormDataEncoder(config.data);
                const headers = config.headers;
                config.headers = {
                    ...headers,
                    ...encoder.headers,
                    ...getReqSignature(config.data, __apiURL__, this.ak, this.sk, this.projectId),
                };
                config.data = stream_1.Readable.from(encoder.encode());
            }
            return config;
        });
    }
    /**
     * 校验用户是否符合提交报告资源
     */
    async check() {
        try {
            // @ts-ignore TODO 后续类型更新了在删除
            const { access_token } = await Editor.User.getUserToken();
            const formData = new FormData();
            formData.append('__apiURL__', this.allowCrashReportAPIURL);
            // @ts-ignore TODO 后续类型更新了在删除
            formData.append('access_token', String(access_token));
            const { data: result } = await this.client.post(this.baseURL + this.allowCrashReportAPIURL, formData);
            return result.data;
        }
        catch (e) {
            console.error(e);
            return false;
        }
    }
    /**
     * 打包多个 zip 并上传到 cdn
     * @param description
     * @param infos
     */
    async packMultipleZipAndUpload(description, infos) {
        for (let i = 0; i < infos.length; i++) {
            await this.packZipAndUpload(description, infos[i]);
        }
    }
    /**
     * 打包 zip 并上传到 cdn
     * @param description
     * @param info
     */
    packZipAndUpload(description, info) {
        const JsZip = require('jszip');
        const zip = new JsZip();
        // 问题描述
        zip.file('问题描述.txt', description || '未描述');
        // 编辑器日志
        try {
            zip.file('编辑器日志.log', (0, fs_extra_1.readFileSync)(info.editorLog));
        }
        catch (e) {
            zip.file('未找到编辑器日志.log', String(e));
        }
        // asset-db 日志
        try {
            const dbLogPath = (0, utils_1.getLatestFilePath)(info.dbLog, '.log');
            zip.file('AssetDB日志.log', (0, fs_extra_1.readFileSync)(dbLogPath));
        }
        catch (e) {
            zip.file('未找到AssetDB日志.log', String(e));
        }
        // 构建日志
        try {
            const buildLogPath = (0, utils_1.getLatestFilePath)(info.buildLog, '.log');
            zip.file('构建日志.log', (0, fs_extra_1.readFileSync)(buildLogPath));
        }
        catch (e) {
            zip.file('未找到构建日志.log', String(e));
        }
        // crash 文件
        try {
            const crashLogPath = (0, utils_1.getLatestFilePath)(info.crashLog, '.dmp');
            zip.file((0, path_1.basename)(crashLogPath), (0, fs_extra_1.readFileSync)(crashLogPath));
        }
        catch (e) {
            zip.file('未找到 Crash 文件.log', String(e));
        }
        // 项目信息
        try {
            zip.file('项目信息.json', (0, fs_extra_1.readFileSync)(info.projectJSON));
        }
        catch (e) {
            zip.file('未找到项目信息.json', String(e));
        }
        // 崩溃详细信息
        zip.file('崩溃详细信息.json', Buffer.from(JSON.stringify(info, null, 4)));
        return new Promise(((resolve, reject) => {
            zip.generateAsync({
                type: 'nodebuffer',
                compression: 'DEFLATE',
                compressionOptions: {
                    level: 9,
                },
            })
                .then(async (buffer) => {
                try {
                    // 设置标签
                    const tags = {
                        [`Crash_${info.process}`]: `Crash_${info.process}`,
                        app_version: Editor.App.version,
                    };
                    await this.upload(info, buffer, JSON.stringify(tags));
                    resolve(null);
                }
                catch (e) {
                    reject(e);
                }
            });
        }));
    }
    /**
     * 上传
     * @param info
     * @param zipFile
     * @param tags
     */
    async upload(info, zipFile, tags) {
        // 限制大小
        const chunk_size = 10485760;
        const total_size = zipFile.length;
        let current_chunk = 1;
        const total_chunk = Math.ceil(total_size / chunk_size);
        const zipMD5File = (0, utils_1.calcMd5)(zipFile);
        const name = info.zipName;
        let start = 0;
        let end = 0;
        while (current_chunk <= total_chunk) {
            start = (current_chunk - 1) * chunk_size;
            end = Math.min(total_size, start + chunk_size);
            await this.uploadSlice({
                name: name,
                file: Buffer.from(zipFile.slice(start, end)),
                size: total_size,
                index: current_chunk,
                total: total_chunk,
                tags: tags,
                fileMd5: zipMD5File,
                cuser: info.uid,
            });
            current_chunk++;
        }
    }
    /**
     * 分片上传
     */
    async uploadSlice(sliceInfo) {
        try {
            const info = new UploadFileInfo();
            info.file = sliceInfo.file;
            info.size = sliceInfo.size;
            info.index = sliceInfo.index;
            info.total = sliceInfo.total;
            info.partMd5 = (0, utils_1.calcMd5)(sliceInfo.file);
            info.fileMd5 = sliceInfo.fileMd5;
            info.name = sliceInfo.name;
            info.serviceId = 'crash-report';
            info.projectId = 'CreatorAnalytics';
            info.cuser = sliceInfo.cuser;
            info.tags = sliceInfo.tags;
            console.debug('>>> upload data：', info);
            const result = await this.client.post(this.baseURL + this.apiURL, info.toFormData());
            console.debug(`>>> upload data${result?.data?.code !== 200 ? 'failed' : 'successful'}，info：`, result);
        }
        catch (e) {
            console.error('>>> upload failed', e);
        }
    }
}
exports.UploadMgr = UploadMgr;
exports.uploadMgr = new UploadMgr();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvdXBsb2FkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtEQUE2QztBQUM3Qyx1Q0FBd0M7QUFHeEMsb0NBQXNEO0FBQ3RELG1DQUFrQztBQUNsQywrQkFBZ0M7QUFDaEM7OztHQUdHO0FBQ0gsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzFELE1BQU0sRUFBRSxlQUFlLEVBQUUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUN6RCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUVwRCxNQUFhLGNBQWM7SUFBM0I7UUFDSSxTQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVk7UUFDcEMsWUFBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFNBQVM7UUFDdkIsWUFBTyxHQUFHLEVBQUUsQ0FBQyxDQUFBLFNBQVM7UUFDdEIsU0FBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLE1BQU07UUFDdkIsU0FBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDakIsVUFBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVE7UUFDbkIsVUFBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDbEIsV0FBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLHFDQUFxQztRQUN4RCxjQUFTLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxPQUFPO1FBQ3ZDLGNBQVMsR0FBRyxjQUFjLENBQUMsQ0FBQyxjQUFjO1FBQzFDLFVBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxNQUFNO1FBQ3JCLFNBQUksR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLO1FBQ2hCLFlBQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxXQUFXO1FB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QUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ3JGLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFZLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUN6RztRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7Q0FDSjtBQTdNRCw4QkE2TUM7QUFFWSxRQUFBLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zLCB7IEF4aW9zSW5zdGFuY2UgfSBmcm9tICdheGlvcyc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5cbmltcG9ydCB7IENyYXNoUmVwb3J0IH0gZnJvbSAnLi4vZGF0YSc7XG5pbXBvcnQgeyBjYWxjTWQ1LCBnZXRMYXRlc3RGaWxlUGF0aCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFJlYWRhYmxlIH0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCB7IGJhc2VuYW1lIH0gZnJvbSAncGF0aCc7XG4vKipcbiAqIOeUseS6juaIkeS7rCBub2RlIOeOr+Wig+eahOaooeW8j++8jOaYr+S4jeaUr+aMgSBlcyDnmoTlhpnms5XvvIxcbiAqIOmcgOimgeWGmeS4gOS4quS4jei/m+ihjOe8luivkeeahCBqcyDohJrmnKzmnaXliqDovb0gZm9ybWRhdGEtbm9kZSDmlbDmja5cbiAqL1xuY29uc3QgeyBGb3JtRGF0YSwgQmxvYiwgRmlsZSB9ID0gcmVxdWlyZSgnZm9ybWRhdGEtbm9kZScpO1xuY29uc3QgeyBGb3JtRGF0YUVuY29kZXIgfSA9IHJlcXVpcmUoJ2Zvcm0tZGF0YS1lbmNvZGVyJyk7XG5jb25zdCBobWFjU0hBMjU2ID0gcmVxdWlyZSgnY3J5cHRvLWpzL2htYWMtc2hhMjU2Jyk7XG5cbmV4cG9ydCBjbGFzcyBVcGxvYWRGaWxlSW5mbyB7XG4gICAgZmlsZSA9IEJ1ZmZlci5mcm9tKCcnKTsgLy8g5paH5Lu2IGJ1ZmZlclxuICAgIGZpbGVNZDUgPSAnJzsgLy8g5paH5Lu2IG1kNVxuICAgIHBhcnRNZDUgPSAnJzsvLyDliIbniYcgbWQ1XG4gICAgbmFtZSA9ICd1bmtub3cnOyAvLyDmlofku7blkI1cbiAgICBzaXplID0gMDsgLy8g5paH5Lu25aSn5bCPXG4gICAgaW5kZXggPSAxOyAvLyDnrKzlh6DkuKrliIbniYdcbiAgICB0b3RhbCA9IDE7IC8vIOaAu+WIhueJh+aVsFxuICAgIGFjdGlvbiA9ICd1cGxvYWQnOyAvLyDliqjkvZznsbvlnovvvJrmlofku7bkuIrkvKDnirbmgIHmo4Dmn6Uv5LiK5LygLCBlZzogY2hlY2svdXBsb2FkXG4gICAgcHJvamVjdElkID0gJ0NyZWF0b3JBbmFseXRpY3MnOyAvLyDpobnnm67nvJbnoIFcbiAgICBzZXJ2aWNlSWQgPSAnY3Jhc2gtcmVwb3J0JzsgLy8g5pyN5Yqh5qCH6K+G77yI5a2Y5pS+55qE55uu5b2V77yJXG4gICAgY3VzZXIgPSAnc3lzJzsgLy8g5Yib5bu65Lq6XG4gICAgdGFncyA9ICcnOyAvLyDmoIfnrb5cbiAgICBpc0Z1enp5ID0gZmFsc2U7IC8vIOaWh+S7tuWQjeaYr+WQpuaooeeziuWMllxuICAgIHVwbG9hZEZsYWcgPSAwOyAvLyDkuIrkvKAgQ0RO77yIMOWPquS4iuS8oOWOn+Wni+ahtiAz5Y6f5aeL5qG25ZKM5Zu95YaF5aSWQ0RO5ZCM5pe25LiK5Lyg77yJXG5cbiAgICB0b0Zvcm1EYXRhKCkge1xuICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNba2V5XTtcbiAgICAgICAgICAgIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgbmV3IEJsb2IoW3ZhbHVlLmJ1ZmZlcl0pKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgU3RyaW5nKHZhbHVlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvcm1EYXRhO1xuICAgIH1cbn1cblxuLy8g5bCG5a+56LGh5bGe5oCn5ZCN77yM5oyJIGFiY2QuLiDpobrluo/mjpLluo/jgIJcbmZ1bmN0aW9uIHNvcnRPYmplY3RLZXkoZGF0YTogYW55KSB7XG4gICAgY29uc3Qgc29ydERhdGE6IGFueSA9IHt9O1xuICAgIE9iamVjdC5rZXlzKGRhdGEpXG4gICAgICAgIC5zb3J0KClcbiAgICAgICAgLm1hcCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHNvcnREYXRhW2tleV0gPSBkYXRhW2tleV07XG4gICAgICAgIH0pO1xuXG4gICAgcmV0dXJuIHNvcnREYXRhO1xufVxuXG4vKipcbiAqIOaWh+S7tuS4iuS8oCBjZG4g562+5ZCN6K6h566XXG4gKiDlsIbor6Xlh73mlbDov5DooYznu5PmnpzliqDlhaUgaHR0cCDor7fmsYLlpLRcbiAqIEBwYXJhbSBkYXRhIGJvZHkg6K+35rGC5YWl5Y+CXG4gKiBAcGFyYW0gdXJsIOivt+axgui3r+W+hOeahCBwYXRo6YOo5YiG77yM5LiN5YyF5ZCraG9zdOmDqOWIhuOAgiBlZzovY2RuL2dldEJ5UGFnZVxuICogaHR0cDovL2RvY3MtY29uc29sZS5jb2Nvcy5vcmcvIy9iYWNrRW5kL2Frc2s/aWQ9anMtJWU3JWFkJWJlJWU1JTkwJThkJWU2JWEwJWI3JWU0JWJlJThiXG4gKiBAcGFyYW0gYWtcbiAqIEBwYXJhbSBza1xuICogQHBhcmFtIHByb2plY3RJZFxuICovXG5mdW5jdGlvbiBnZXRSZXFTaWduYXR1cmUoZGF0YTogRm9ybURhdGEsIHVybDogc3RyaW5nLCBhazogc3RyaW5nLCBzazogc3RyaW5nLCBwcm9qZWN0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIGNvbnN0IHJlcUJvZHk6IGFueSA9IHt9O1xuICAgIGRhdGEuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZVR5cGUgPSB2YWx1ZS50b1N0cmluZygpO1xuICAgICAgICAvLyDlj4LmlbDoi6XljIXlkKvmlofku7bvvIzkuI3liqDlhaXnrb7lkI3orqHnrpdcbiAgICAgICAgaWYgKHZhbHVlVHlwZSAhPT0gJ1tvYmplY3QgRmlsZV0nICYmIHZhbHVlVHlwZSAhPT0gJ1tvYmplY3QgQmxvYl0nKSB7XG4gICAgICAgICAgICByZXFCb2R5W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3Qgc29ydERhdGEgPSBzb3J0T2JqZWN0S2V5KHJlcUJvZHkpO1xuICAgIGxldCBzaWduU3RyaW5nID0gJyc7XG4gICAgZm9yIChjb25zdCBwcm9wIGluIHNvcnREYXRhKSB7XG4gICAgICAgIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvcnREYXRhLCBwcm9wKSkge1xuICAgICAgICAgICAgc2lnblN0cmluZyArPSBgJHtwcm9wfT0ke3NvcnREYXRhW3Byb3BdfSZgO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHNpZ25hdHVyZSA9IGhtYWNTSEEyNTYoYCR7cHJvamVjdElkfSYke3NpZ25TdHJpbmd9JHt1cmx9JiR7dGltZXN0YW1wfWAsIHNrKS50b1N0cmluZygpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGdyYW50VHlwZTogJ2Frc2snLFxuICAgICAgICBhY2Nlc3NLZXk6IGFrLFxuICAgICAgICBwcm9qZWN0SWQsXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgc2lnbmF0dXJlLFxuICAgIH07XG59XG5cbi8qKlxuICog5LiK5Lyg5YiH54mH5omA6ZyA6KaB55qE5pWw5o2uXG4gKi9cbmludGVyZmFjZSBVcGxvYWRTbGljZUluZm8ge1xuICAgIC8vIOWQjeWtl1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICAvLyDmlofku7YgYnVmZmVyXG4gICAgZmlsZTogQnVmZmVyLFxuICAgIC8vIOaWh+S7tuWkp+Wwj1xuICAgIHNpemU6IG51bWJlcixcbiAgICAvLyDlvZPliY3liIbniYdcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIC8vIOaAu+WIhueJh1xuICAgIHRvdGFsOiBudW1iZXIsXG4gICAgLy8g5qCH562+XG4gICAgdGFnczogc3RyaW5nLFxuICAgIC8vIOaAu+aWh+S7tueahCBtZDVcbiAgICBmaWxlTWQ1OiBzdHJpbmcsXG4gICAgLy9cbiAgICBjdXNlcjogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgVXBsb2FkTWdyIHtcbiAgICAvLyBjbmQg5a2Y5pS+55qE55uu5b2V5L2N572uXG4gICAgc2VydmljZUlkID0gJ2NyYXNoLXJlcG9ydCc7XG5cbiAgICAvLyA9PT09IGRldlxuICAgIC8vIGJhc2VVUkwgPSAnaHR0cHM6Ly9kZXYtZ2F0ZXdheS5jb2Nvcy5vcmcnO1xuICAgIC8vIHByb2plY3RJZCA9ICdDcmVhdG9yQW5hbHl0aWNzJztcbiAgICAvLyBhayA9ICdiMjM0YWJhMjI2Y2E0MDFjYjAwNDkyZTMyZjQxYTYyZic7XG4gICAgLy8gc2sgPSAnZTBmYWU4MWVjYWQxNGQxZjg4MGM2ZjMzNjUxNjg1ODknO1xuICAgIC8vID09PT1cbiAgICBiYXNlVVJMID0gJ2h0dHBzOi8vZ2F0ZXdheS5jb2Nvcy5jb20nO1xuICAgIHByb2plY3RJZCA9ICdDcmVhdG9yQW5hbHl0aWNzJztcbiAgICBhayA9ICcxMDdjMmM4M2VhMTY0YjU2ODJmOWZmYzhlZWRlNDJhYic7XG4gICAgc2sgPSAnMTEzMTcwMjYxNDg4NGJhZmJhNWE0ZmRkYWE3M2E4ZWQnO1xuXG4gICAgLy8g5LiK5Lyg5aSn5paH5Lu2XG4gICAgYXBpVVJMID0gJy9jZG4vdXBsb2FkRmlsZUJ5Q2FjaGUnO1xuICAgIC8vIOagoemqjOi6q+S7vSBBMDE4QVAwMDEgLT4gYWxsb3dDcmFzaFJlcG9ydFxuICAgIGFsbG93Q3Jhc2hSZXBvcnRBUElVUkwgPSAnL0EwMTgvdjEvQTAxOEFQMDAxJztcblxuICAgIGNsaWVudDogQXhpb3NJbnN0YW5jZTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9IGF4aW9zLmNyZWF0ZSh7XG4gICAgICAgICAgICB0aW1lb3V0OiAyICogNjAgKiAxMDAwLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jbGllbnQuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKFxuICAgICAgICAgICAgY29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBfX2FwaVVSTF9fID0gY29uZmlnLmRhdGEuZ2V0KCdfX2FwaVVSTF9fJykgfHwgdGhpcy5hcGlVUkw7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5kYXRhLmRlbGV0ZSgnX19hcGlVUkxfXycpO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcubWF4Q29udGVudExlbmd0aCA9IEluZmluaXR5O1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmNvZGVyID0gbmV3IEZvcm1EYXRhRW5jb2Rlcihjb25maWcuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGhlYWRlcnMgPSBjb25maWcuaGVhZGVycztcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgLi4uZW5jb2Rlci5oZWFkZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgLi4uZ2V0UmVxU2lnbmF0dXJlKGNvbmZpZy5kYXRhLCBfX2FwaVVSTF9fLCB0aGlzLmFrLCB0aGlzLnNrLCB0aGlzLnByb2plY3RJZCksXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5kYXRhID0gUmVhZGFibGUuZnJvbShlbmNvZGVyLmVuY29kZSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZztcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmoKHpqoznlKjmiLfmmK/lkKbnrKblkIjmj5DkuqTmiqXlkYrotYTmupBcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgY2hlY2soKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIFRPRE8g5ZCO57ut57G75Z6L5pu05paw5LqG5Zyo5Yig6ZmkXG4gICAgICAgICAgICBjb25zdCB7IGFjY2Vzc190b2tlbiB9ID0gYXdhaXQgRWRpdG9yLlVzZXIuZ2V0VXNlclRva2VuKCk7XG4gICAgICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdfX2FwaVVSTF9fJywgdGhpcy5hbGxvd0NyYXNoUmVwb3J0QVBJVVJMKTtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ETyDlkI7nu63nsbvlnovmm7TmlrDkuoblnKjliKDpmaRcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYWNjZXNzX3Rva2VuJywgU3RyaW5nKGFjY2Vzc190b2tlbikpO1xuICAgICAgICAgICAgY29uc3QgeyBkYXRhOiByZXN1bHQgfSA9IGF3YWl0IHRoaXMuY2xpZW50LnBvc3QodGhpcy5iYXNlVVJMICsgdGhpcy5hbGxvd0NyYXNoUmVwb3J0QVBJVVJMLCBmb3JtRGF0YSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0LmRhdGE7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmiZPljIXlpJrkuKogemlwIOW5tuS4iuS8oOWIsCBjZG5cbiAgICAgKiBAcGFyYW0gZGVzY3JpcHRpb25cbiAgICAgKiBAcGFyYW0gaW5mb3NcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgcGFja011bHRpcGxlWmlwQW5kVXBsb2FkKGRlc2NyaXB0aW9uOiBzdHJpbmcsIGluZm9zOiBDcmFzaFJlcG9ydFtdKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mb3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucGFja1ppcEFuZFVwbG9hZChkZXNjcmlwdGlvbiwgaW5mb3NbaV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5omT5YyFIHppcCDlubbkuIrkvKDliLAgY2RuXG4gICAgICogQHBhcmFtIGRlc2NyaXB0aW9uXG4gICAgICogQHBhcmFtIGluZm9cbiAgICAgKi9cbiAgICBwdWJsaWMgcGFja1ppcEFuZFVwbG9hZChkZXNjcmlwdGlvbjogc3RyaW5nLCBpbmZvOiBDcmFzaFJlcG9ydCkge1xuICAgICAgICBjb25zdCBKc1ppcCA9IHJlcXVpcmUoJ2pzemlwJyk7XG4gICAgICAgIGNvbnN0IHppcCA9IG5ldyBKc1ppcCgpO1xuICAgICAgICAvLyDpl67popjmj4/ov7BcbiAgICAgICAgemlwLmZpbGUoJ+mXrumimOaPj+i/sC50eHQnLCBkZXNjcmlwdGlvbiB8fCAn5pyq5o+P6L+wJyk7XG4gICAgICAgIC8vIOe8lui+keWZqOaXpeW/l1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgemlwLmZpbGUoJ+e8lui+keWZqOaXpeW/ly5sb2cnLCByZWFkRmlsZVN5bmMoaW5mby5lZGl0b3JMb2cpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgemlwLmZpbGUoJ+acquaJvuWIsOe8lui+keWZqOaXpeW/ly5sb2cnLCBTdHJpbmcoZSkpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGFzc2V0LWRiIOaXpeW/l1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZGJMb2dQYXRoID0gZ2V0TGF0ZXN0RmlsZVBhdGgoaW5mby5kYkxvZywgJy5sb2cnKTtcbiAgICAgICAgICAgIHppcC5maWxlKCdBc3NldERC5pel5b+XLmxvZycsIHJlYWRGaWxlU3luYyhkYkxvZ1BhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgemlwLmZpbGUoJ+acquaJvuWIsEFzc2V0RELml6Xlv5cubG9nJywgU3RyaW5nKGUpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyDmnoTlu7rml6Xlv5dcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGJ1aWxkTG9nUGF0aCA9IGdldExhdGVzdEZpbGVQYXRoKGluZm8uYnVpbGRMb2csICcubG9nJyk7XG4gICAgICAgICAgICB6aXAuZmlsZSgn5p6E5bu65pel5b+XLmxvZycsIHJlYWRGaWxlU3luYyhidWlsZExvZ1BhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgemlwLmZpbGUoJ+acquaJvuWIsOaehOW7uuaXpeW/ly5sb2cnLCBTdHJpbmcoZSkpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGNyYXNoIOaWh+S7tlxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY3Jhc2hMb2dQYXRoID0gZ2V0TGF0ZXN0RmlsZVBhdGgoaW5mby5jcmFzaExvZywgJy5kbXAnKTtcbiAgICAgICAgICAgIHppcC5maWxlKGJhc2VuYW1lKGNyYXNoTG9nUGF0aCksIHJlYWRGaWxlU3luYyhjcmFzaExvZ1BhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgemlwLmZpbGUoJ+acquaJvuWIsCBDcmFzaCDmlofku7YubG9nJywgU3RyaW5nKGUpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyDpobnnm67kv6Hmga9cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHppcC5maWxlKCfpobnnm67kv6Hmga8uanNvbicsIHJlYWRGaWxlU3luYyhpbmZvLnByb2plY3RKU09OKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHppcC5maWxlKCfmnKrmib7liLDpobnnm67kv6Hmga8uanNvbicsIFN0cmluZyhlKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5bSp5rqD6K+m57uG5L+h5oGvXG4gICAgICAgIHppcC5maWxlKCfltKnmuoPor6bnu4bkv6Hmga8uanNvbicsIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGluZm8sIG51bGwsIDQpKSk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgemlwLmdlbmVyYXRlQXN5bmMoe1xuICAgICAgICAgICAgICAgIHR5cGU6ICdub2RlYnVmZmVyJyxcbiAgICAgICAgICAgICAgICBjb21wcmVzc2lvbjogJ0RFRkxBVEUnLFxuICAgICAgICAgICAgICAgIGNvbXByZXNzaW9uT3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICBsZXZlbDogOSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbihhc3luYyAoYnVmZmVyOiBCdWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOiuvue9ruagh+etvlxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbYENyYXNoXyR7aW5mby5wcm9jZXNzfWBdOiBgQ3Jhc2hfJHtpbmZvLnByb2Nlc3N9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBfdmVyc2lvbjogRWRpdG9yLkFwcC52ZXJzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXBsb2FkKGluZm8sIGJ1ZmZlciwgSlNPTi5zdHJpbmdpZnkodGFncykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDkuIrkvKBcbiAgICAgKiBAcGFyYW0gaW5mb1xuICAgICAqIEBwYXJhbSB6aXBGaWxlXG4gICAgICogQHBhcmFtIHRhZ3NcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgdXBsb2FkKGluZm86IENyYXNoUmVwb3J0LCB6aXBGaWxlOiBCdWZmZXIsIHRhZ3M6IHN0cmluZykge1xuICAgICAgICAvLyDpmZDliLblpKflsI9cbiAgICAgICAgY29uc3QgY2h1bmtfc2l6ZSA9IDEwNDg1NzYwO1xuICAgICAgICBjb25zdCB0b3RhbF9zaXplID0gemlwRmlsZS5sZW5ndGg7XG4gICAgICAgIGxldCBjdXJyZW50X2NodW5rID0gMTtcbiAgICAgICAgY29uc3QgdG90YWxfY2h1bmsgPSBNYXRoLmNlaWwodG90YWxfc2l6ZSAvIGNodW5rX3NpemUpO1xuICAgICAgICBjb25zdCB6aXBNRDVGaWxlID0gY2FsY01kNSh6aXBGaWxlKTtcblxuICAgICAgICBjb25zdCBuYW1lID0gaW5mby56aXBOYW1lO1xuXG4gICAgICAgIGxldCBzdGFydCA9IDA7XG4gICAgICAgIGxldCBlbmQgPSAwO1xuICAgICAgICB3aGlsZSAoY3VycmVudF9jaHVuayA8PSB0b3RhbF9jaHVuaykge1xuICAgICAgICAgICAgc3RhcnQgPSAoY3VycmVudF9jaHVuayAtIDEpICogY2h1bmtfc2l6ZTtcbiAgICAgICAgICAgIGVuZCA9IE1hdGgubWluKHRvdGFsX3NpemUsIHN0YXJ0ICsgY2h1bmtfc2l6ZSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwbG9hZFNsaWNlKHtcbiAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgIGZpbGU6IEJ1ZmZlci5mcm9tKHppcEZpbGUuc2xpY2Uoc3RhcnQsIGVuZCkpLFxuICAgICAgICAgICAgICAgIHNpemU6IHRvdGFsX3NpemUsXG4gICAgICAgICAgICAgICAgaW5kZXg6IGN1cnJlbnRfY2h1bmssXG4gICAgICAgICAgICAgICAgdG90YWw6IHRvdGFsX2NodW5rLFxuICAgICAgICAgICAgICAgIHRhZ3M6IHRhZ3MsXG4gICAgICAgICAgICAgICAgZmlsZU1kNTogemlwTUQ1RmlsZSxcbiAgICAgICAgICAgICAgICBjdXNlcjogaW5mby51aWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGN1cnJlbnRfY2h1bmsrKztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWIhueJh+S4iuS8oFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyB1cGxvYWRTbGljZShzbGljZUluZm86IFVwbG9hZFNsaWNlSW5mbykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IG5ldyBVcGxvYWRGaWxlSW5mbygpO1xuICAgICAgICAgICAgaW5mby5maWxlID0gc2xpY2VJbmZvLmZpbGU7XG4gICAgICAgICAgICBpbmZvLnNpemUgPSBzbGljZUluZm8uc2l6ZTtcbiAgICAgICAgICAgIGluZm8uaW5kZXggPSBzbGljZUluZm8uaW5kZXg7XG4gICAgICAgICAgICBpbmZvLnRvdGFsID0gc2xpY2VJbmZvLnRvdGFsO1xuICAgICAgICAgICAgaW5mby5wYXJ0TWQ1ID0gY2FsY01kNShzbGljZUluZm8uZmlsZSk7XG4gICAgICAgICAgICBpbmZvLmZpbGVNZDUgPSBzbGljZUluZm8uZmlsZU1kNTtcbiAgICAgICAgICAgIGluZm8ubmFtZSA9IHNsaWNlSW5mby5uYW1lO1xuICAgICAgICAgICAgaW5mby5zZXJ2aWNlSWQgPSAnY3Jhc2gtcmVwb3J0JztcbiAgICAgICAgICAgIGluZm8ucHJvamVjdElkID0gJ0NyZWF0b3JBbmFseXRpY3MnO1xuICAgICAgICAgICAgaW5mby5jdXNlciA9IHNsaWNlSW5mby5jdXNlcjtcbiAgICAgICAgICAgIGluZm8udGFncyA9IHNsaWNlSW5mby50YWdzO1xuXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKCc+Pj4gdXBsb2FkIGRhdGHvvJonLCBpbmZvKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnBvc3QodGhpcy5iYXNlVVJMICsgdGhpcy5hcGlVUkwsIGluZm8udG9Gb3JtRGF0YSgpKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYD4+PiB1cGxvYWQgZGF0YSR7cmVzdWx0Py5kYXRhPy5jb2RlICE9PSAyMDAgPyAnZmFpbGVkJyA6ICdzdWNjZXNzZnVsJ33vvIxpbmZv77yaYCwgcmVzdWx0KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignPj4+IHVwbG9hZCBmYWlsZWQnLCBlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNvbnN0IHVwbG9hZE1nciA9IG5ldyBVcGxvYWRNZ3IoKTtcbiJdfQ==