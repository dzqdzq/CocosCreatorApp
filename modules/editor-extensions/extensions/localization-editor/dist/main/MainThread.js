"use strict";var __decorate=this&&this.__decorate||function(e,t,a,r){var i,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,a):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,a,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(n=(s<3?i(n):s>3?i(t,a,n):i(t,a))||n);return s>3&&n&&Object.defineProperty(t,a,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),EditorMessageService_1=__importDefault(require("../core/service/EditorMessageService")),TranslateItem_1=__importDefault(require("../core/entity/translate/TranslateItem")),SceneIPC_1=__importDefault(require("../core/ipc/SceneIPC")),TranslateDataSourceService_1=__importDefault(require("../core/service/persistent/TranslateDataSourceService")),ProjectConfigService_1=__importDefault(require("../core/service/persistent/ProjectConfigService")),TranslateProviderConfig_1=__importDefault(require("../core/entity/config/TranslateProviderConfig")),ScanOption_1=__importDefault(require("../core/entity/messages/ScanOption")),TranslateService_1=__importDefault(require("../core/service/translate/TranslateService")),LanguageConfig_1=__importDefault(require("../core/entity/translate/LanguageConfig")),FileScanService_1=__importDefault(require("../core/service/scanner/FileScanService")),CompileService_1=__importDefault(require("../core/service/persistent/CompileService")),TranslateData_1=__importDefault(require("../core/entity/translate/TranslateData")),TranslateProviderFactory_1=__importDefault(require("../core/factory/TranslateProviderFactory")),Association_1=__importDefault(require("../core/entity/translate/Association")),ITranslateProviderConfig_1=require("../core/entity/config/ITranslateProviderConfig"),EditorConfigService_1=__importDefault(require("../core/service/persistent/EditorConfigService")),TranslateFileService_1=__importDefault(require("../core/service/external-translate/TranslateFileService")),Errors_1=require("../core/error/Errors"),MainMessage_1=require("../core/entity/messages/MainMessage"),global_1=require("../core/service/util/global"),track_service_1=__importDefault(require("../core/service/track/track-service"));let MainThread=class{constructor(e,t,a,r,i,s,n,o,c,l,g){this.editorMessageService=e,this.sceneIPC=t,this.translateDataSourceService=a,this.projectConfigService=r,this.editorConfigService=i,this.translateService=s,this.fileScanService=n,this.compileService=o,this.translateProviderFactory=c,this.translateFileService=l,this.trackService=g,this.toggle=(async()=>await this.projectConfigService.toggle()),this.enableChanged=(async()=>{await this.projectConfigService.enableChanged()}),this.getEnable=(async()=>this.projectConfigService.getEnable()),this.openPanel=(async()=>{await this.readConfig(),this.editorMessageService.openPanel()}),this.previewBy=(async e=>{const t=await this.compileService.compile([e]);await this.editorConfigService.preview(e),await this.sceneIPC.addResourceBundle(e,t),await this.sceneIPC.preview(e)}),this.scan=(async e=>{const t=(new Date).getTime();await this.sceneIPC.scan(e),await this.projectConfigService.setScanOptions(e.map(ScanOption_1.default.parse));const a=(new Date).getTime(),r=this.getLocalLanguage();return r&&await this.previewBy(r),console.debug(`用时 ${a-t}`),this.getTranslateData()}),this.uninstall=(async()=>{if(await this.editorMessageService.queryDirty())throw new Errors_1.CustomError(MainMessage_1.MessageCode.EDITOR_DIRTY);await this.editorMessageService.closePanel(),await Promise.all([this.clearTranslateData(),this.projectConfigService.uninstall(),this.translateDataSourceService.uninstall(),this.editorConfigService.uninstall()]),await this.editorMessageService.softReload()}),this.clearTranslateData=(async()=>{if(await this.editorMessageService.queryDirty())throw new Errors_1.CustomError(MainMessage_1.MessageCode.EDITOR_DIRTY);let e=new TranslateData_1.default(TranslateData_1.default.INDEX_LOCALE);try{e=this.translateDataSourceService.getClonedIndexData()}catch(e){console.log(`[${global_1.MainName}]: Uninstall but not found index data, this does not cause additional errors, just a note, presumably the uninstall has been performed before`)}const t=this.editorConfigService.getCurrentPreview(),a=this.projectConfigService.getLocalLanguage();a&&a!==t&&await this.previewBy(a),await Promise.all([this.sceneIPC.uninstall([]),this.translateDataSourceService.removeAllTranslateData()])}),this.readConfig=(async()=>{await this.projectConfigService.read(),await this.translateDataSourceService.read(),await this.editorConfigService.read()}),this.getIndexData=(()=>{const e=this.translateDataSourceService.getClonedIndexData();return Array.from(e.items.values())}),this.getLocalLanguage=(()=>this.projectConfigService.getLocalLanguage()),this.getTranslateData=(e=>{var t,a,r;return e?Array.from(null!==(r=null===(a=null===(t=this.translateDataSourceService.getClonedTranslateData(e))||void 0===t?void 0:t.items)||void 0===a?void 0:a.values())&&void 0!==r?r:[]):Array.from(this.translateDataSourceService.getClonedLocalTranslateData().items.values())}),this.getTranslateDataObject=(e=>{var t;return e?null===(t=this.translateDataSourceService.getClonedTranslateData(e))||void 0===t?void 0:t.toObject():this.translateDataSourceService.getClonedLocalTranslateData().toObject()}),this.saveTranslateData=(async(e,t,a)=>{const r=null===t||void 0===t?void 0:t.map(TranslateItem_1.default.parse);await this.translateDataSourceService.saveTranslateData(e,r,a)}),this.setLocalLanguageLocale=(async e=>{await this.translateDataSourceService.setLocalTranslateData(e),await this.projectConfigService.setLocalLanguage(e),await this.sceneIPC.reloadResourceData()}),this.setLanguageConfig=(async e=>{const t=LanguageConfig_1.default.parse(e);await this.translateDataSourceService.updateLanguageConfig(e.bcp47Tag,t)}),this.getLanguageConfig=(e=>e?this.translateDataSourceService.getLanguageConfig(e):this.translateDataSourceService.getLocalLanguageConfig()),this.getAllLanguageConfigs=(()=>this.translateDataSourceService.getAllLanguageConfigs()),this.addTargetLanguage=(async e=>{await this.translateDataSourceService.addTranslateData(e)}),this.removeTargetLanguage=(async e=>{const t=this.editorConfigService.getCurrentPreview(),a=this.getLocalLanguage();return e===t&&a&&await this.previewBy(a),await this.sceneIPC.removeResourceBundle(e),await this.translateDataSourceService.removeTranslateData(e)}),this.getTranslateProviders=(()=>["YOUDAO","GOOGLE"]),this.getTranslateProviderSupportedLanguages=(e=>ITranslateProviderConfig_1.TranslateProviderSupportedLanguages.get(e)),this.getCurrentTranslateProvider=(()=>this.editorConfigService.getCurrentTranslateProviderConfig()),this.getTranslateProvider=(async e=>this.editorConfigService.getTranslateProviderConfig(e)),this.setCurrentTranslateProvider=(async e=>{const t=this.translateProviderFactory.createProvider(TranslateProviderConfig_1.default.parse(e));await this.editorConfigService.setCurrentTranslateProviderConfig(t)&&await this.translateDataSourceService.clearAllLanguagesProvider()}),this.clearTranslateProvider=(async()=>{await this.editorConfigService.clearTranslateProviderConfig()}),this.changeValue=((e,t,a)=>{this.translateDataSourceService.changeValue(e,t,a)}),this.getScanOptions=(()=>this.projectConfigService.getScanOptions()),this.autoTranslate=(async e=>{const t=this.translateDataSourceService.getClonedLocalTranslateData(),a=this.translateDataSourceService.getClonedTranslateData(e);return await this.translateService.translate(t,a)}),this.importMediaFiles=(async(e,t,a)=>{const r=this.translateDataSourceService.getClonedLocalTranslateData(),i=this.translateDataSourceService.getClonedTranslateData(e);return await this.fileScanService.scan(r,i,{fromPattern:t,toPattern:a,progress:(t,a)=>{this.editorMessageService.translateProgress(t,a,e)}})}),this.compile=(async e=>{e=e.filter(e=>e!==TranslateData_1.default.INDEX_LOCALE),await this.compileService.compile(e)}),this.addAssociation=(async(e,t)=>{const a=Association_1.default.create(t);await this.translateDataSourceService.addAssociation(e,a)}),this.removeAssociation=(async(e,t)=>{const a=Association_1.default.create(t);await this.translateDataSourceService.removeAssociation(e,a)}),this.onSceneReady=(async e=>{await this.sceneIPC.onSceneReady(e)}),this.getResourceList=(async()=>{const e=this.editorConfigService.getCurrentPreview(),t=this.projectConfigService.getLocalLanguage();if(!t)return;const a=this.translateDataSourceService.getAllLanguageTags();return{defaultLanguage:null!==e&&void 0!==e?e:t,fallbackLanguage:t,languages:a}}),this.getResourceBundle=(async e=>await this.compileService.compile(e)),this.exportTranslateFile=(async(e,t,a)=>{const r=this.translateDataSourceService.getClonedTranslateData(a),i=this.translateDataSourceService.getClonedLocalTranslateData();await this.translateFileService.exportTranslateFile(e,t,r,i)}),this.importTranslateFile=(async(e,t,a)=>{const r=await this.translateFileService.importTranslateFile(e,t,a);return Array.from(r.items.values())}),this.onBuilderTaskChanged=(async(e,t)=>{this.trackService.trackBuilder(e,t)})}};MainThread=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[EditorMessageService_1.default,SceneIPC_1.default,TranslateDataSourceService_1.default,ProjectConfigService_1.default,EditorConfigService_1.default,TranslateService_1.default,FileScanService_1.default,CompileService_1.default,TranslateProviderFactory_1.default,TranslateFileService_1.default,track_service_1.default])],MainThread),exports.default=MainThread;