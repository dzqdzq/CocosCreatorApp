"use strict";var __importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onBeforeBuildAssets=exports.onAfterInit=void 0,require("reflect-metadata");const tsyringe_1=require("tsyringe"),TranslateItemType_1=__importDefault(require("../core/entity/translate/TranslateItemType")),builder_1=__importDefault(require("./builder")),WrapperMainIPC_1=__importDefault(require("../core/ipc/WrapperMainIPC")),MainIPC_1=__importDefault(require("../core/ipc/MainIPC")),global_1=require("../core/service/util/global"),mainIPC=tsyringe_1.container.resolve(MainIPC_1.default),wrapper=tsyringe_1.container.resolve(WrapperMainIPC_1.default);async function getTargetLanguages(a){var e,t;const n=null!==(t=null===(e=a.packages[global_1.MainName])||void 0===e?void 0:e.targetLanguageMap)&&void 0!==t?t:{},l=await builder_1.default.getAllLanguagesInfo();return Object.values(n).filter(a=>a&&a.value).map(a=>a.locale).filter(a=>l.some(e=>e.bcp47Tag===a))}async function initOptions(a){var e,t,n,l,i,o,s,u;null!==(e=(i=a.packages)[global_1.MainName])&&void 0!==e||(i[global_1.MainName]={});let r="";try{r=await wrapper.getLocalLanguage()}catch(a){}const g=await getTargetLanguages(a);if(r){null!==(t=(o=a.packages[global_1.MainName]).defaultLanguage)&&void 0!==t||(o.defaultLanguage=r),null!==(n=(s=a.packages[global_1.MainName]).fallbackLanguage)&&void 0!==n||(s.fallbackLanguage=r),g.includes(a.packages[global_1.MainName].defaultLanguage)||(a.packages[global_1.MainName].defaultLanguage=r),g.includes(a.packages[global_1.MainName].fallbackLanguage)||(a.packages[global_1.MainName].fallbackLanguage=r);const e=null!==(l=(u=a.packages[global_1.MainName]).targetLanguageMap)&&void 0!==l?l:u.targetLanguageMap={},i=a.packages[global_1.MainName].defaultLanguage,c=a.packages[global_1.MainName].fallbackLanguage;e[i]||(e[i]={locale:i,value:!0}),e[c]||(e[c]={locale:c,value:!0})}}async function onAfterInit(a,e,t){var n;if(!await mainIPC.getEnable())return;await initOptions(a);const l=await getTargetLanguages(a);for(let a=0;a<l.length;a++){const e=l[a];console.debug(`[localization-editor]: start add depend of ${e}`);let i=[];try{i=(await wrapper.getTranslateData(e)).filter(a=>a.type===TranslateItemType_1.default.Media)}catch(a){console.error(a),i=[]}for(let a=0;a<i.length;a++){const e=i[a];if(e.key===e.value)continue;const l=await t.getDependUuids(e.key);if(!l.includes(e.value)){const a=await t.getAssetInfo(e.value);if(a){const t=null!==(n=a.subAssets)&&void 0!==n?n:{};l.push(e.value),console.debug(`[localization-editor]: ${e.key} add depends ${e.value}`);for(const a in t){const n=t[a];l.push(n.uuid),console.debug(`[localization-editor]: ${e.key} add depends ${n.uuid}`)}}else console.error(`[localization-editor]: failed to add depends of ${e.key}, assetInfo of ${e.value} is not exist `)}}}}async function onBeforeBuildAssets(a,e,t){var n,l,i,o,s;try{if(!await mainIPC.getEnable())return;l=null===(n=a.packages[global_1.MainName])||void 0===n?void 0:n.polyfillMap;const u=await builder_1.default.getICUlPolyfillFileInfos(),r=await getTargetLanguages(a),g=["Intl.PluralRules"];e.bundles.forEach(a=>{for(let e=0;e<u.length;e++){const t=u[e],n=t.uuid;r.length&&g.includes(t.name)||a.removeAsset(n)}});const c=await builder_1.default.getResourceListJsonAssetInfo();if(!c)return;const d=await t.getInstance(c.uuid),f=null!==(i=d.json)&&void 0!==i?i:{};d.json=f,f.defaultLanguage=null===(o=a.packages[global_1.MainName])||void 0===o?void 0:o.defaultLanguage,f.fallbackLanguage=null===(s=a.packages[global_1.MainName])||void 0===s?void 0:s.fallbackLanguage,f.languages=r,t.addInstance(d);const p=await builder_1.default.getResourceBundleJsonAssetInfo();if(!p)return;const _=await t.getInstance(p.uuid);_.json=await mainIPC.getResourceBundle(r),t.addInstance(_)}catch(a){console.warn(a)}}exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets;