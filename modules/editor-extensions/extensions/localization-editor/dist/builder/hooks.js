"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onBeforeBuildAssets=exports.onAfterInit=void 0,require("reflect-metadata");const tsyringe_1=require("tsyringe"),TranslateItemType_1=__importDefault(require("../core/entity/translate/TranslateItemType")),builder_1=__importDefault(require("./builder")),WrapperMainIPC_1=__importDefault(require("../core/ipc/WrapperMainIPC")),MainIPC_1=__importDefault(require("../core/ipc/MainIPC")),global_1=require("../core/service/util/global"),mainIPC=tsyringe_1.container.resolve(MainIPC_1.default),wrapper=tsyringe_1.container.resolve(WrapperMainIPC_1.default);async function getTargetLanguages(e){var a,t;const i=null!==(t=null===(a=e.packages["localization-editor"])||void 0===a?void 0:a.targetLanguageMap)&&void 0!==t?t:{},n=await builder_1.default.getAllLanguagesInfo();return Object.values(i).filter(e=>e&&e.value).map(e=>e.locale).filter(e=>n.some(a=>a.bcp47Tag===e))}async function initOptions(e){var a,t,i,n,o,l;null!==(a=(n=e.packages)["localization-editor"])&&void 0!==a||(n["localization-editor"]={});let r="";try{r=await wrapper.getLocalLanguage()}catch(e){}const s=await getTargetLanguages(e);r&&(null!==(t=(o=e.packages["localization-editor"]).defaultLanguage)&&void 0!==t||(o.defaultLanguage=r),null!==(i=(l=e.packages["localization-editor"]).fallbackLanguage)&&void 0!==i||(l.fallbackLanguage=r),s.includes(e.packages["localization-editor"].defaultLanguage)||(e.packages["localization-editor"].defaultLanguage=r),s.includes(e.packages["localization-editor"].fallbackLanguage)||(e.packages["localization-editor"].fallbackLanguage=r))}async function onAfterInit(e,a,t){var i;if(!await mainIPC.getEnable())return;const n=new Set,o=new Map;await initOptions(e);const l=await getTargetLanguages(e);for(let e=0;e<l.length;e++){const a=l[e];console.debug(`[localization-editor]: start add depend of ${a}`);let r=[];try{r=(await wrapper.getTranslateData(a)).filter(e=>e.type===TranslateItemType_1.default.Media)}catch(e){console.error(e),r=[]}for(let e=0;e<r.length;e++){let a=!1;const l=r[e],s=t.getAssetInfo(l.key);if(s&&(checkSpriteFrame(s,t,n),a=await isUseCompressTexture(s,t)),l.key===l.value)continue;const u=await t.getDependUuids(l.key);if(!u.includes(l.value)){const e=await t.getAssetInfo(l.value);if(e){if(a!==await isUseCompressTexture(e,t)){o.set(l.key,l.value);continue}checkSpriteFrame(e,t,n);const r=null!==(i=e.subAssets)&&void 0!==i?i:{};u.push(l.value),console.debug(`[localization-editor]: ${l.key} add depends ${l.value}`);for(const e in r){const a=r[e];u.push(a.uuid),console.debug(`[localization-editor]: ${l.key} add depends ${a.uuid}`)}}else console.error(`[localization-editor]: failed to add depends of ${l.key}, assetInfo of ${l.value} is not exist `)}}}if(n.forEach(e=>{console.error(`[${global_1.MainName}]: ${Editor.I18n.t(global_1.MainName+".build.packable_warning").replace("${uuid}",e)}`)}),o.forEach((e,a)=>{console.error(`[${global_1.MainName}]: ${Editor.I18n.t(global_1.MainName+".build.compress_warning").replace("${a}",e).replace("${b}",a)}`)}),n.size||o.size)throw new Error(`[${global_1.MainName}]: build failed`)}async function onBeforeBuildAssets(e,a,t){var i,n,o,l,r;try{if(!await mainIPC.getEnable())return;n=null===(i=e.packages["localization-editor"])||void 0===i?void 0:i.polyfillMap;const s=await builder_1.default.getICUlPolyfillFileInfos(),u=await getTargetLanguages(e),c=["Intl.PluralRules"];a.bundles.forEach(e=>{for(let a=0;a<s.length;a++){const t=s[a],i=t.uuid;u.length&&c.includes(t.name)||e.removeAsset(i)}});const d=await builder_1.default.getResourceListJsonAssetInfo();if(!d)return;const g=await t.getInstance(d.uuid),f=null!==(o=g.json)&&void 0!==o?o:{};g.json=f,f.defaultLanguage=null===(l=e.packages["localization-editor"])||void 0===l?void 0:l.defaultLanguage,f.fallbackLanguage=null===(r=e.packages["localization-editor"])||void 0===r?void 0:r.fallbackLanguage,f.languages=u,t.addInstance(g);const p=await builder_1.default.getResourceBundleJsonAssetInfo();if(!p)return;const v=await t.getInstance(p.uuid);v.json=await mainIPC.getResourceBundle(u),t.addInstance(v)}catch(e){console.warn(e)}}async function checkSpriteFrame(e,a,t){var i,n;if(e&&"cc.ImageAsset"===e.type)for(const o in null===e||void 0===e?void 0:e.subAssets){const l=e.subAssets[o];"cc.SpriteFrame"===(null===l||void 0===l?void 0:l.type)&&(null===(n=null===(i=await a.getMeta(l.uuid))||void 0===i?void 0:i.userData)||void 0===n?void 0:n.packable)&&t.add(l.uuid)}}async function isUseCompressTexture(e,a){var t,i;if(!e||"cc.ImageAsset"!==e.type)return!1;const n=await a.getMeta(e.uuid);return!(null===(i=null===(t=null===n||void 0===n?void 0:n.userData)||void 0===t?void 0:t.compressSettings)||void 0===i||!i.useCompressTexture)}exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets;