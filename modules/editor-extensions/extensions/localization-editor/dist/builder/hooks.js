"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onBeforeBuildAssets=exports.onAfterInit=void 0,require("reflect-metadata");const tsyringe_1=require("tsyringe"),TranslateItemType_1=__importDefault(require("../core/entity/translate/TranslateItemType")),builder_1=__importDefault(require("./builder")),WrapperMainIPC_1=__importDefault(require("../core/ipc/WrapperMainIPC")),MainIPC_1=__importDefault(require("../core/ipc/MainIPC")),global_1=require("../core/service/util/global"),mainIPC=tsyringe_1.container.resolve(MainIPC_1.default),wrapper=tsyringe_1.container.resolve(WrapperMainIPC_1.default);async function getTargetLanguages(e){var a,t;const n=null!==(t=null===(a=e.packages[global_1.MainName])||void 0===a?void 0:a.targetLanguageMap)&&void 0!==t?t:{},l=await builder_1.default.getAllLanguagesInfo();return Object.values(n).filter(e=>e&&e.value).map(e=>e.locale).filter(e=>l.some(a=>a.bcp47Tag===e))}async function initOptions(e){var a,t,n,l,i,o;null!==(a=(l=e.packages)[global_1.MainName])&&void 0!==a||(l[global_1.MainName]={});let s="";try{s=await wrapper.getLocalLanguage()}catch(e){}const r=await getTargetLanguages(e);s&&(null!==(t=(i=e.packages[global_1.MainName]).defaultLanguage)&&void 0!==t||(i.defaultLanguage=s),null!==(n=(o=e.packages[global_1.MainName]).fallbackLanguage)&&void 0!==n||(o.fallbackLanguage=s),r.includes(e.packages[global_1.MainName].defaultLanguage)||(e.packages[global_1.MainName].defaultLanguage=s),r.includes(e.packages[global_1.MainName].fallbackLanguage)||(e.packages[global_1.MainName].fallbackLanguage=s))}async function onAfterInit(e,a,t){var n;if(!await mainIPC.getEnable())return;const l=new Set,i=new Map;await initOptions(e);const o=await getTargetLanguages(e);for(let e=0;e<o.length;e++){const a=o[e];console.debug(`[localization-editor]: start add depend of ${a}`);let s=[];try{s=(await wrapper.getTranslateData(a)).filter(e=>e.type===TranslateItemType_1.default.Media)}catch(e){console.error(e),s=[]}for(let e=0;e<s.length;e++){let a=!1;const o=s[e],r=t.getAssetInfo(o.key);if(r&&(checkSpriteFrame(r,t,l),a=await isUseCompressTexture(r,t)),o.key===o.value)continue;const u=await t.getDependUuids(o.key);if(!u.includes(o.value)){const e=await t.getAssetInfo(o.value);if(e){if(a!==await isUseCompressTexture(e,t)){i.set(o.key,o.value);continue}checkSpriteFrame(e,t,l);const s=null!==(n=e.subAssets)&&void 0!==n?n:{};u.push(o.value),console.debug(`[localization-editor]: ${o.key} add depends ${o.value}`);for(const e in s){const a=s[e];u.push(a.uuid),console.debug(`[localization-editor]: ${o.key} add depends ${a.uuid}`)}}else console.error(`[localization-editor]: failed to add depends of ${o.key}, assetInfo of ${o.value} is not exist `)}}}if(l.forEach(e=>{console.error(`[${global_1.MainName}]: ${Editor.I18n.t(global_1.MainName+".build.packable_warning").replace("${uuid}",e)}`)}),i.forEach((e,a)=>{console.error(`[${global_1.MainName}]: ${Editor.I18n.t(global_1.MainName+".build.compress_warning").replace("${a}",e).replace("${b}",a)}`)}),l.size||i.size)throw new Error(`[${global_1.MainName}]: build failed`)}async function onBeforeBuildAssets(e,a,t){var n,l,i,o,s;try{if(!await mainIPC.getEnable())return;l=null===(n=e.packages[global_1.MainName])||void 0===n?void 0:n.polyfillMap;const r=await builder_1.default.getICUlPolyfillFileInfos(),u=await getTargetLanguages(e),c=["Intl.PluralRules"];a.bundles.forEach(e=>{for(let a=0;a<r.length;a++){const t=r[a],n=t.uuid;u.length&&c.includes(t.name)||e.removeAsset(n)}});const g=await builder_1.default.getResourceListJsonAssetInfo();if(!g)return;const d=await t.getInstance(g.uuid),f=null!==(i=d.json)&&void 0!==i?i:{};d.json=f,f.defaultLanguage=null===(o=e.packages[global_1.MainName])||void 0===o?void 0:o.defaultLanguage,f.fallbackLanguage=null===(s=e.packages[global_1.MainName])||void 0===s?void 0:s.fallbackLanguage,f.languages=u,t.addInstance(d);const p=await builder_1.default.getResourceBundleJsonAssetInfo();if(!p)return;const _=await t.getInstance(p.uuid);_.json=await mainIPC.getResourceBundle(u),t.addInstance(_)}catch(e){console.warn(e)}}async function checkSpriteFrame(e,a,t){var n,l;if(e&&"cc.ImageAsset"===e.type)for(const i in null===e||void 0===e?void 0:e.subAssets){const o=e.subAssets[i];"cc.SpriteFrame"===(null===o||void 0===o?void 0:o.type)&&(null===(l=null===(n=await a.getMeta(o.uuid))||void 0===n?void 0:n.userData)||void 0===l?void 0:l.packable)&&t.add(o.uuid)}}async function isUseCompressTexture(e,a){var t,n;if(!e||"cc.ImageAsset"!==e.type)return!1;const l=await a.getMeta(e.uuid);return!(null===(n=null===(t=null===l||void 0===l?void 0:l.userData)||void 0===t?void 0:t.compressSettings)||void 0===n||!n.useCompressTexture)}exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets;