"use strict";var L10nManagerWrapper_1,__decorate=this&&this.__decorate||function(e,a,t,r){var n,s=arguments.length,i=s<3?a:null===r?r=Object.getOwnPropertyDescriptor(a,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,a,t,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(i=(s<3?n(i):s>3?n(a,t,i):n(a,t))||i);return s>3&&i&&Object.defineProperty(a,t,i),i},__metadata=this&&this.__metadata||function(e,a){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,a)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),cc_1=require("cc"),global_1=require("../service/util/global"),tsyringe_1=require("tsyringe"),EditorMessageService_1=__importDefault(require("../service/EditorMessageService")),TranslateItemType_1=__importDefault(require("../entity/translate/TranslateItemType")),MainIPC_1=__importDefault(require("../ipc/MainIPC"));module.paths.push((0,path_1.join)(Editor.App.path,"node_modules"));let L10nManagerWrapper=L10nManagerWrapper_1=class{constructor(e,a){this.editorMessageService=e,this.mainIpc=a}async l10nManager(){return(await Editor.Module.importProjectModule(`db://${global_1.MainName}/core/l10n-manager.ts`)).default}async preview(e,a){const t=await this.l10nManager();t.isInitialized()||await t.createIntl({}),await(await this.l10nManager()).changeLanguage(e),await this.releaseAsset(a),this.editorMessageService.softReload()}async reloadResourceData(){const e=(await this.l10nManager()).reloadResourceData();return await this.releaseAsset(),await this.editorMessageService.softReload(),e}async addResourceBundle(e,a){const t=(await this.l10nManager())._intl;(null===t||void 0===t?void 0:t.hasResourceBundle(e,L10nManagerWrapper_1.DEFAULT_NAMESPACE))&&(null===t||void 0===t||t.removeResourceBundle(e,L10nManagerWrapper_1.DEFAULT_NAMESPACE));const r=a[e][L10nManagerWrapper_1.DEFAULT_NAMESPACE];null===t||void 0===t||t.addResourceBundle(e,L10nManagerWrapper_1.DEFAULT_NAMESPACE,r,!0,!0),this.editorMessageService.softReload()}async removeResourceBundle(e,a){const t=await this.l10nManager(),r=t._intl;null===r||void 0===r||r.removeResourceBundle(e,L10nManagerWrapper_1.DEFAULT_NAMESPACE),delete t.resourceBundle[e],await this.releaseAsset(a),this.editorMessageService.softReload()}async uninstall(){const e=await this.l10nManager();e._intl=void 0,e.resourceList=void 0,e.resourceBundle={},e.amPipeLineManager.uninstall()}async releaseAsset(e){let a;a=e?Object.entries(e.items).filter(e=>e[1].type===TranslateItemType_1.default.Media).map(e=>e[0]):(await this.mainIpc.getIndexData()).filter(e=>e.type===TranslateItemType_1.default.Media).map(e=>e.key);for(const e of a)cc_1.assetManager.assets.forEach(a=>{a._uuid.startsWith(e)&&(cc_1.assetManager.releaseAsset(a),console.debug("[localization-editor]: release asset",a))})}};L10nManagerWrapper.DEFAULT_NAMESPACE="translation",L10nManagerWrapper=L10nManagerWrapper_1=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[EditorMessageService_1.default,MainIPC_1.default])],L10nManagerWrapper),exports.default=L10nManagerWrapper;