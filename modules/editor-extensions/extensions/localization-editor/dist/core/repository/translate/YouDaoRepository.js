"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var a,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var n=e.length-1;n>=0;n--)(a=e[n])&&(i=(s<3?a(i):s>3?a(t,r,i):a(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),crypto_js_1=__importDefault(require("crypto-js")),form_data_1=__importDefault(require("form-data")),UUIDService_1=__importDefault(require("../../service/util/UUIDService")),TranslateRepository_1=require("./TranslateRepository"),Errors_1=require("../../error/Errors"),MainMessage_1=require("../../entity/messages/MainMessage");let YouDaoRepository=class extends TranslateRepository_1.TranslateRepository{constructor(e){super(),this.uuidService=e,this.name="YOUDAO",this.shouldCatchErrorCode=new Map([["207","重放请求"],["301","辞典查询失败"],["302","翻译查询失败"],["1412","超过最大识别字节数"],["2004","合成字符过长"],["2412","超过最大请求字符数"],["3412","超过最大请求字符数"]])}transformTranslateRequestConfig(e){const t=this.uuidService.v4(),r=Math.round((new Date).getTime()/1e3),o=e.query.filter(e=>e&&e.length>0).join("\n").trim(),a=this.generateSign(e.appKey,e.appSecret,this.truncate(o),t,r.toString()),s={q:o,from:e.from,to:e.to,appKey:e.appKey,salt:t,sign:a,signType:"v3",curtime:r},i=new form_data_1.default;for(const[e,t]of Object.entries(s))i.append(e,t);return{url:e.url,method:"post",data:i,headers:i.getHeaders()}}transformTranslateResponse(e){if(200!==e.status)throw new Errors_1.CustomError(MainMessage_1.MessageCode.AUTO_TRANSLATE_NETWORK_ERROR,`${null===e||void 0===e?void 0:e.status} ${null===e||void 0===e?void 0:e.statusText}`);if(this.shouldCatchErrorCode.has(e.data.errorCode))throw new Errors_1.CustomError(MainMessage_1.MessageCode.PROVIDER_INPUT_ERROR,`YouDao error: ${e.data.errorCode}, ${this.shouldCatchErrorCode.get(e.data.errorCode)}`);if("0"!==e.data.errorCode)throw new Errors_1.CustomError(MainMessage_1.MessageCode.PROVIDER_INPUT_ERROR,`YouDao error: ${e.data.errorCode}, please check https://ai.youdao.com/DOCSIRMA/html/%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E7%BF%BB%E8%AF%91/API%E6%96%87%E6%A1%A3/%E6%96%87%E6%9C%AC%E7%BF%BB%E8%AF%91%E6%9C%8D%E5%8A%A1/%E6%96%87%E6%9C%AC%E7%BF%BB%E8%AF%91%E6%9C%8D%E5%8A%A1-API%E6%96%87%E6%A1%A3.html and check [错误代码列表]`);const t=e.data;return{translation:t.translation[0].split("\n"),status:parseInt(t.errorCode)}}generateSign(e,t,r,o,a){const s=`${e}${r}${o}${a}${t}`;return crypto_js_1.default.SHA256(s).toString(crypto_js_1.default.enc.Hex)}truncate(e){const t=e.length;return t<=20?e:`${e.substring(0,10)}${t}${e.substring(t-10,t)}`}};YouDaoRepository=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[UUIDService_1.default])],YouDaoRepository),exports.default=YouDaoRepository;