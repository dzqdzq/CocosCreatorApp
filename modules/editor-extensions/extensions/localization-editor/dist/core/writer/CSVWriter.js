"use strict";var CSVWriter_1,__decorate=this&&this.__decorate||function(e,t,r,a){var l,i=arguments.length,n=i<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,a);else for(var s=e.length-1;s>=0;s--)(l=e[s])&&(n=(i<3?l(n):i>3?l(t,r,n):l(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const type_1=require("../type/type"),tsyringe_1=require("tsyringe"),sync_1=require("csv-stringify/sync"),fs_extra_1=require("fs-extra"),TranslateItemType_1=__importDefault(require("../entity/translate/TranslateItemType"));let CSVWriter=CSVWriter_1=class{constructor(e){this.pluralRules=e,this.type=type_1.TranslateFileType.CSV}async write(e,t,r){const a=this.generateCsvTranslateItems(r,t),l=(0,sync_1.stringify)(a,{header:!0,columns:["key","sourceValue","targetValue"]});await(0,fs_extra_1.writeFile)(e,l,"utf-8")}generateCsvTranslateItems(e,t){var r,a,l,i,n,s;const o=[{key:CSVWriter_1.LocaleKey,sourceValue:e.locale,targetValue:t.locale}];for(const[u,c]of e.items.entries()){const e=t.items.get(u);if(c.type!==TranslateItemType_1.default.Media&&(o.push({key:u,sourceValue:c.value,targetValue:null!==(r=null===e||void 0===e?void 0:e.value)&&void 0!==r?r:""}),c.variants.length>0||(null!==(a=null===e||void 0===e?void 0:e.variants.length)&&void 0!==a?a:0)>0)){const r=null!==(l=this.pluralRules[new Intl.Locale(t.locale).language])&&void 0!==l?l:["other"];for(const t of r){const r=null===(i=null===e||void 0===e?void 0:e.variants)||void 0===i?void 0:i.find(e=>e.key.endsWith(t));o.push({key:null!==(n=null===r||void 0===r?void 0:r.key)&&void 0!==n?n:`${u}_${t}`,sourceValue:"",targetValue:null!==(s=null===r||void 0===r?void 0:r.value)&&void 0!==s?s:""})}}}return o}};CSVWriter.LocaleKey="LanguageTag",CSVWriter=CSVWriter_1=__decorate([(0,tsyringe_1.singleton)(),__param(0,(0,tsyringe_1.inject)("PluralRules")),__metadata("design:paramtypes",[Object])],CSVWriter),exports.default=CSVWriter;