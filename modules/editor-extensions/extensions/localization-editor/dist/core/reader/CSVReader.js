"use strict";var __decorate=this&&this.__decorate||function(e,t,r,a){var l,n=arguments.length,i=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var s=e.length-1;s>=0;s--)(l=e[s])&&(i=(n<3?l(i):n>3?l(t,r,i):l(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),type_1=require("../type/type"),TranslateData_1=__importDefault(require("../entity/translate/TranslateData")),fs_extra_1=require("fs-extra"),sync_1=require("csv-parse/sync"),CSVWriter_1=__importDefault(require("../writer/CSVWriter")),Errors_1=require("../error/Errors"),MainMessage_1=require("../entity/messages/MainMessage"),TranslateItem_1=__importDefault(require("../entity/translate/TranslateItem")),TranslateItemType_1=__importDefault(require("../entity/translate/TranslateItemType")),UUIDService_1=__importDefault(require("../service/util/UUIDService"));let CSVReader=class{constructor(e,t){this.pluralRules=e,this.uuidService=t,this.type=type_1.TranslateFileType.CSV}async read(e){const t=await(0,fs_extra_1.readFile)(e),r=(0,sync_1.parse)(t).map(e=>({key:e[0],sourceValue:e[1],targetValue:e[2]}));return r.shift(),this.generateTranslateData(r)}generateTranslateData(e){var t,r,a;if(e.length<1||e[0].key!==CSVWriter_1.default.LocaleKey)throw new Errors_1.CustomError(MainMessage_1.MessageCode.UNAVAILABLE_CSV_FILE,`file not found ${CSVWriter_1.default.LocaleKey}`);const l=new TranslateData_1.default(e[0].targetValue),n=null!==(t=this.pluralRules[new Intl.Locale(l.locale).language])&&void 0!==t?t:["other"];e.shift();for(const t of e){let e;if(this.checkVariant(n,t)){const a=this.trimPluralRule(n,t);(e=null!==(r=l.items.get(a))&&void 0!==r?r:new TranslateItem_1.default(a,"",TranslateItemType_1.default.External)).addVariant(new TranslateItem_1.default(t.key,t.targetValue,TranslateItemType_1.default.External))}else(e=null!==(a=l.items.get(t.key))&&void 0!==a?a:new TranslateItem_1.default(t.key,t.targetValue,TranslateItemType_1.default.External)).value=t.targetValue;l.items.set(e.key,e)}return l}checkVariant(e,t){return e.find(e=>t.key.endsWith(e))}trimPluralRule(e,t){const r=this.checkVariant(e,t);let a=t.key.replace(new RegExp(`_${r}$`),"");return a=a.length>0?a:this.uuidService.v4()}};CSVReader=__decorate([(0,tsyringe_1.singleton)(),__param(0,(0,tsyringe_1.inject)("PluralRules")),__metadata("design:paramtypes",[Object,UUIDService_1.default])],CSVReader),exports.default=CSVReader;