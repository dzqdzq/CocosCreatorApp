"use strict";var __decorate=this&&this.__decorate||function(e,t,r,a){var s,n=arguments.length,i=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const type_1=require("../type/type"),TranslateData_1=__importDefault(require("../entity/translate/TranslateData")),fs_extra_1=require("fs-extra"),gettext_parser_1=require("gettext-parser"),TranslateItem_1=__importDefault(require("../entity/translate/TranslateItem")),tsyringe_1=require("tsyringe"),TranslateItemType_1=__importDefault(require("../entity/translate/TranslateItemType")),UUIDService_1=__importDefault(require("../service/util/UUIDService"));let POReader=class{constructor(e,t){this.pluralRules=e,this.uuidService=t,this.type=type_1.TranslateFileType.PO}async read(e){const t=await(0,fs_extra_1.readFile)(e),r=gettext_parser_1.po.parse(t,"utf-8"),a=r.translations[""],s=new TranslateData_1.default(r.headers.Language);for(const[e,t]of Object.entries(a)){if(!e)continue;const r=this.transform(t,s.locale);r&&s.items.set(r.key,r)}return s}transform(e,t){var r,a;const s=new TranslateItem_1.default(null!==(r=e.comments.reference)&&void 0!==r?r:this.uuidService.v4(),"",TranslateItemType_1.default.External);if(e.msgid_plural){s.value=e.msgid_plural;const r=null!==(a=this.pluralRules[new Intl.Locale(t).language])&&void 0!==a?a:["other"];for(const[t,a]of r.entries()){const r=new TranslateItem_1.default(`${s.key}_${a}`,e.msgstr[t],s.type,!0);s.addVariant(r)}}else s.value=e.msgstr[0];return s.value?s:void 0}};POReader=__decorate([(0,tsyringe_1.singleton)(),__param(0,(0,tsyringe_1.inject)("PluralRules")),__metadata("design:paramtypes",[Object,UUIDService_1.default])],POReader),exports.default=POReader;