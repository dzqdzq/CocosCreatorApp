"use strict";var __decorate=this&&this.__decorate||function(e,t,s,r){var o,a=arguments.length,c=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,s,r);else for(var i=e.length-1;i>=0;i--)(o=e[i])&&(c=(a<3?o(c):a>3?o(t,s,c):o(t,s))||c);return a>3&&c&&Object.defineProperty(t,s,c),c},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),glob_1=__importDefault(require("glob")),tsyringe_1=require("tsyringe"),MediaProcessor_1=__importDefault(require("./processor/MediaProcessor")),ScriptProcessor_1=__importDefault(require("./processor/ScriptProcessor")),SceneProcessor_1=__importDefault(require("./processor/SceneProcessor")),EditorMessageService_1=__importDefault(require("../EditorMessageService")),ComponentUnLoader_1=__importDefault(require("./processor/ComponentUnLoader"));let ScanService=class{constructor(e,t,s,r,o){this.mediaProcessor=e,this.sceneProcessor=t,this.scriptProcessor=s,this.editorMessageService=r,this.componentUnLoader=o}async scan(e,t,s){const r=await this.scanFiles(t),o=(await Promise.all(r.map(e=>this.editorMessageService.queryAssetInfo(e)))).filter(e=>e),a=e.transformToValueMap(),c=[];for(const[e,t]of o.entries()){if(!t)continue;let r=[];t.type.includes("ImageAsset")||t.type.includes("AudioClip")||t.type.includes("VideoClip")?r=await this.mediaProcessor.process(t,a):t.type.includes("SceneAsset")||t.type.includes("Prefab")?r=await this.sceneProcessor.process(t,a):t.type.includes("Script")&&(r=await this.scriptProcessor.process(t,a)),c.push(...r),null===s||void 0===s||s(e+1,o.length)}return c}async scanAndUnInstall(e,t){const s=await this.editorMessageService.queryAssets({pattern:"db://assets/**/*.{scene,prefab}"});for(const e of s)this.componentUnLoader.process(e)}cancelScan(){this.mediaProcessor.cancel(),this.sceneProcessor.cancel(),this.scriptProcessor.cancel()}generateGlobs(e){const t=[];for(const s of e){let e;switch(s.dirs.length){case 0:continue;case 1:e=s.dirs[0];break;default:e=`{${s.dirs.join(",")}}`}const r=s.excludes.map(e=>(0,path_1.join)(Editor.Project.path,"assets",e,"**","*"));let o;switch(s.extNames.length){case 0:o="!(*.meta)";break;case 1:o=`*.${s.extNames[0]}`;break;default:o=`*.{${s.extNames.join(",")}}`}t.push({pattern:(0,path_1.join)(Editor.Project.path,"assets",e,"**",o),ignores:r})}return t}async scanFiles(e,t){const s=[],r=this.generateGlobs(e);for(const e of r){const t={nodir:!0};e.ignores.length>0&&(t.ignore=e.ignores),s.push(new Promise((s,r)=>{(0,glob_1.default)(e.pattern,t,(e,t)=>{e?r(e):s(t.map(e=>(0,path_1.join)(e)))})}))}return(await Promise.all(s)).flat()}};ScanService=__decorate([(0,tsyringe_1.autoInjectable)(),__metadata("design:paramtypes",[MediaProcessor_1.default,SceneProcessor_1.default,ScriptProcessor_1.default,EditorMessageService_1.default,ComponentUnLoader_1.default])],ScanService),exports.default=ScanService;