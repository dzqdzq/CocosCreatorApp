"use strict";var ScanService_1,__decorate=this&&this.__decorate||function(e,t,r,s){var c,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,s);else for(var i=e.length-1;i>=0;i--)(c=e[i])&&(a=(o<3?c(a):o>3?c(t,r,a):c(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),glob_1=__importDefault(require("glob")),tsyringe_1=require("tsyringe"),MediaProcessor_1=__importDefault(require("./processor/MediaProcessor")),ScriptProcessor_1=__importDefault(require("./processor/ScriptProcessor")),SceneProcessor_1=__importDefault(require("./processor/SceneProcessor")),EditorMessageService_1=__importDefault(require("../EditorMessageService")),ComponentUnLoader_1=__importDefault(require("./processor/ComponentUnLoader"));let ScanService=ScanService_1=class{constructor(e,t,r,s,c){this.mediaProcessor=e,this.sceneProcessor=t,this.scriptProcessor=r,this.editorMessageService=s,this.componentUnLoader=c}async scan(e,t,r){const s=await this.scanFiles(t),c=(await Promise.all(s.map(e=>this.editorMessageService.queryAssetInfo(e)))).filter(e=>e),o=e.transformToValueMap(),a=[];for(const[e,t]of c.entries()){if(!t)continue;const s=t.type;let i=[];ScanService_1.MEDIA_ASSET_TYPES.includes(s)?i=await this.mediaProcessor.process(t,o):ScanService_1.SCENE_ASSET_TYPES.includes(s)?i=await this.sceneProcessor.process(t,o):ScanService_1.SCRIPT_ASSET_TYPES.includes(s)&&(i=await this.scriptProcessor.process(t,o)),a.push(...i),null===r||void 0===r||r(e+1,c.length)}return a}async scanAndUnInstall(e,t){const r=await this.editorMessageService.queryAssets({pattern:"db://assets/**/*.{scene,prefab}"});for(const e of r)this.componentUnLoader.process(e)}cancelScan(){this.mediaProcessor.cancel(),this.sceneProcessor.cancel(),this.scriptProcessor.cancel()}generateGlobs(e){const t=[];for(const r of e){let e;switch(r.dirs.length){case 0:continue;case 1:e=r.dirs[0];break;default:e=`{${r.dirs.join(",")}}`}const s=r.excludes.map(e=>(0,path_1.join)(Editor.Project.path,"assets",e,"**","*"));let c;switch(r.extNames.length){case 0:c="!(*.meta)";break;case 1:c=`*.${r.extNames[0]}`;break;default:c=`*.{${r.extNames.join(",")}}`}t.push({pattern:(0,path_1.join)(Editor.Project.path,"assets",e,"**",c),ignores:s})}return t}async scanFiles(e,t){const r=[],s=this.generateGlobs(e);for(const e of s){const t={nodir:!0};e.ignores.length>0&&(t.ignore=e.ignores),r.push(new Promise((r,s)=>{(0,glob_1.default)(e.pattern,t,(e,t)=>{e?s(e):r(t.map(e=>(0,path_1.join)(e)))})}))}return(await Promise.all(r)).flat()}};ScanService.MEDIA_ASSET_TYPES=["cc.ImageAsset","cc.AudioClip","cc.VideoClip","cc.TTFFont","cc.BitmapFont"],ScanService.SCENE_ASSET_TYPES=["cc.SceneAsset","cc.Prefab"],ScanService.SCRIPT_ASSET_TYPES=["cc.Script"],ScanService=ScanService_1=__decorate([(0,tsyringe_1.autoInjectable)(),__metadata("design:paramtypes",[MediaProcessor_1.default,SceneProcessor_1.default,ScriptProcessor_1.default,EditorMessageService_1.default,ComponentUnLoader_1.default])],ScanService),exports.default=ScanService;