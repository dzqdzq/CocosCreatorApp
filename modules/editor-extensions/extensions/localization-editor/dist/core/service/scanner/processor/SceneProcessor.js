"use strict";var SceneProcessor_1,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,n)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,r,i){var n,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path");module.paths.push((0,path_1.join)(Editor.App.path,"node_modules"));const cc=__importStar(require("cc")),tsyringe_1=require("tsyringe"),AssetSerializeService_1=__importDefault(require("../serialize/AssetSerializeService")),TranslateItem_1=__importDefault(require("../../../entity/translate/TranslateItem")),Association_1=__importDefault(require("../../../entity/translate/Association")),TranslateItemType_1=__importDefault(require("../../../entity/translate/TranslateItemType")),UUIDService_1=__importDefault(require("../../util/UUIDService"));let SceneProcessor=SceneProcessor_1=class{constructor(e,t){this.assetSerializeService=e,this.uuidService=t,this.started=!0}async process(e,t){this.translateItemValueMap=t;let r,i=null;if(e.type.includes("Scene")){const t=this.assetSerializeService.deserializeFile(e.file);i=t.scene,r=t}else if(e.type.includes("Prefab")){const t=this.assetSerializeService.deserializeFile(e.file);i=t.data,r=t}if(!i)return[];const n=this.scan(i,e);return n.length>0&&this.assetSerializeService.serialize(e.file,r),Promise.resolve(Array.from(n.values()))}scan(e,t){const r=[];return e.walk(e=>{if(e instanceof cc.Node){if(e.getComponent(SceneProcessor_1.ICUComponentName))return;const i=e.getComponent(cc.Label);if(i){const n=this.translateItemValueMap.get(i.string),a=this.addComponent(e,null===n||void 0===n?void 0:n.key),s=Association_1.default.create({sceneUuid:t.uuid,nodeUuid:e.uuid,reference:t.uuid});let o;n?(n.associations.push(s),o=n):(o=new TranslateItem_1.default(a.key,i.string,TranslateItemType_1.default.Text),this.translateItemValueMap.set(i.string,o),r.push(o),o.associations.push(s)),a.added&&r.push(o)}}}),r}addComponent(e,t){let r=e.getComponent(SceneProcessor_1.L10nComponentName),i=!1;return r||(i=!0,(r=e.addComponent(SceneProcessor_1.L10nLabelComponentName)).key=t||this.uuidService.v4()),{key:r.key,added:i}}cancel(){this.started=!1}};SceneProcessor.L10nLabelComponentName="L10nLabel",SceneProcessor.ICUComponentName="ICUComponent",SceneProcessor.L10nComponentName="L10nComponent",SceneProcessor=SceneProcessor_1=__decorate([(0,tsyringe_1.autoInjectable)(),__metadata("design:paramtypes",[AssetSerializeService_1.default,UUIDService_1.default])],SceneProcessor),exports.default=SceneProcessor;