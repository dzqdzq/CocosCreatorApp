"use strict";var SceneProcessor_1,__decorate=this&&this.__decorate||function(e,t,r,s){var a,n=arguments.length,i=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,s);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(i=(n<3?a(i):n>3?a(t,r,i):a(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path");module.paths.push((0,path_1.join)(Editor.App.path,"node_modules"));const cc_1=require("cc"),tsyringe_1=require("tsyringe"),AssetSerializeService_1=__importDefault(require("../serialize/AssetSerializeService")),TranslateItem_1=__importDefault(require("../../../entity/translate/TranslateItem")),Association_1=__importDefault(require("../../../entity/translate/Association")),TranslateItemType_1=__importDefault(require("../../../entity/translate/TranslateItemType")),UUIDService_1=__importDefault(require("../../util/UUIDService"));let SceneProcessor=SceneProcessor_1=class{constructor(e,t){this.assetSerializeService=e,this.uuidService=t,this.started=!0}async process(e,t){this.translateItemValueMap=t;let r,s=null;if(e.type.includes("Scene")){const t=this.assetSerializeService.deserializeFile(e.file);s=t.scene,r=t}else if(e.type.includes("Prefab")){const t=this.assetSerializeService.deserializeFile(e.file);s=t.data,r=t}if(!s)return[];const a=this.scan(s.walk.bind(s),e);return a.length>0&&this.assetSerializeService.serialize(e.file,r),Promise.resolve(Array.from(a.values()))}scan(e,t){const r=[];return e(e=>{if(e instanceof cc_1.Node){if(e.getComponent(SceneProcessor_1.ICUComponentName))return;const s=e.getComponent(cc_1.Label);if(s){const a=this.translateItemValueMap.get(s.string),n=this.addComponent(e,null===a||void 0===a?void 0:a.key),i=Association_1.default.create({sceneUuid:t.uuid,nodeUuid:e.uuid,reference:t.uuid});let o;a?(a.associations.push(i),o=a):(o=new TranslateItem_1.default(n.key,s.string,TranslateItemType_1.default.Text),this.translateItemValueMap.set(s.string,o),r.push(o),o.associations.push(i)),n.added&&r.push(o)}}}),r}addComponent(e,t){let r=e.getComponent(SceneProcessor_1.L10nComponentName),s=!1;return r||(s=!0,(r=e.addComponent(SceneProcessor_1.L10nLabelComponentName)).key=t||this.uuidService.v4()),{key:r.key,added:s}}cancel(){this.started=!1}};SceneProcessor.L10nLabelComponentName="L10nLabel",SceneProcessor.ICUComponentName="ICUComponent",SceneProcessor.L10nComponentName="L10nComponent",SceneProcessor=SceneProcessor_1=__decorate([(0,tsyringe_1.autoInjectable)(),__metadata("design:paramtypes",[AssetSerializeService_1.default,UUIDService_1.default])],SceneProcessor),exports.default=SceneProcessor;