"use strict";var __decorate=this&&this.__decorate||function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,a){t(r,a,e)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),ProjectConfigService_1=__importDefault(require("../persistent/ProjectConfigService")),TranslateRepository_1=require("../../repository/translate/TranslateRepository"),YouDaoRepository_1=__importDefault(require("../../repository/translate/YouDaoRepository")),Errors_1=require("../../error/Errors"),MainMessage_1=require("../../entity/messages/MainMessage"),TranslateDataSourceService_1=__importDefault(require("../persistent/TranslateDataSourceService")),EditorMessageService_1=__importDefault(require("../EditorMessageService")),TranslateItemType_1=__importDefault(require("../../entity/translate/TranslateItemType")),GoogleRepository_1=__importDefault(require("../../repository/translate/GoogleRepository")),EditorConfigService_1=__importDefault(require("../persistent/EditorConfigService"));tsyringe_1.container.register("TranslateRepository",{useClass:YouDaoRepository_1.default}),tsyringe_1.container.register("TranslateRepository",{useClass:GoogleRepository_1.default});let TranslateService=class{constructor(e,t,r,a,o){this.globalConfigService=e,this.translateDataSourceService=t,this.editorConfigService=r,this.editorMessageService=a,this.translateRepositoryMap=o}async translate(e,t){const r=this.editorConfigService.getCurrentTranslateProviderConfig();if(!r)throw new Errors_1.CustomError(MainMessage_1.MessageCode.TRANSLATE_PROVIDER_CONFIG_NOT_FOUND);if(!e.languageConfig.providerTag)throw new Errors_1.CustomError(MainMessage_1.MessageCode.PROVIDER_TAG_NOT_FOUND);if(!t.languageConfig.providerTag)throw new Errors_1.CustomError(MainMessage_1.MessageCode.PROVIDER_TAG_NOT_FOUND);const a=this.translateDataSourceService.getShouldTranslateItems(t.locale).filter(e=>e.type!==TranslateItemType_1.default.Media);return new Promise(o=>{let s=0,i=0,n=0;const l=[],u=[],_=setInterval(()=>{n=i+20>a.length?a.length:i+20;const c=a.slice(i,n),g={url:r.url,query:c.map(e=>e.value),from:e.languageConfig.providerTag,to:t.languageConfig.providerTag,appKey:r.appKey,appSecret:r.appSecret},p=this.request(r.name,g);u.push(p.then(e=>{var r;for(let a=0;a<e.length;a++){const o=null!==(r=t.items.get(c[a].key))&&void 0!==r?r:c[a].clone();o.value=e[a],l.push(o)}return this.editorMessageService.translateProgress(s,a.length/20,t.languageConfig.bcp47Tag),Promise.resolve()})),s+=1,(i=n)>=a.length&&(Promise.all(u).then(()=>{o(l)}),clearInterval(_))},1e3/r.qps)})}async request(e,t){if(0===t.query.length)return[];return(await this.translateRepositoryMap.get(e).translate(t)).translation}};TranslateService=__decorate([(0,tsyringe_1.autoInjectable)(),__param(4,(0,tsyringe_1.injectAllWithTransform)("TranslateRepository",TranslateRepository_1.TranslateRepositoryTransform)),__metadata("design:paramtypes",[ProjectConfigService_1.default,TranslateDataSourceService_1.default,EditorConfigService_1.default,EditorMessageService_1.default,Map])],TranslateService),exports.default=TranslateService;