"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,a,e,s){void 0===s&&(s=e);var r=Object.getOwnPropertyDescriptor(a,e);r&&("get"in r?a.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return a[e]}}),Object.defineProperty(t,s,r)}:function(t,a,e,s){void 0===s&&(s=e),t[s]=a[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,a){Object.defineProperty(t,"default",{enumerable:!0,value:a})}:function(t,a){t.default=a}),__decorate=this&&this.__decorate||function(t,a,e,s){var r,i=arguments.length,n=i<3?a:null===s?s=Object.getOwnPropertyDescriptor(a,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,a,e,s);else for(var l=t.length-1;l>=0;l--)(r=t[l])&&(n=(i<3?r(n):i>3?r(a,e,n):r(a,e))||n);return i>3&&n&&Object.defineProperty(a,e,n),n},__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var a={};if(null!=t)for(var e in t)"default"!==e&&Object.prototype.hasOwnProperty.call(t,e)&&__createBinding(a,t,e);return __setModuleDefault(a,t),a},__metadata=this&&this.__metadata||function(t,a){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,a)},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),path_1=require("path"),YAML=__importStar(require("yaml")),promises_1=require("fs/promises"),fs_1=require("fs"),TranslateData_1=__importDefault(require("../../entity/translate/TranslateData")),ProjectConfigService_1=__importDefault(require("./ProjectConfigService")),TranslateItem_1=__importDefault(require("../../entity/translate/TranslateItem")),directory_structure_1=require("../../entity/directory-structure/directory-structure"),Errors_1=require("../../error/Errors"),MainMessage_1=require("../../entity/messages/MainMessage"),UUIDService_1=__importDefault(require("../util/UUIDService")),TranslateItemType_1=__importDefault(require("../../entity/translate/TranslateItemType"));let TranslateDataSourceService=class{constructor(t,a,e){this.globalConfigService=t,this.configDirectory=a,this.uuidService=e,this.translateDataMap=new Map}async getAllTranslateDataFile(){const t=this.configDirectory.translateData;return(0,fs_1.existsSync)(t)?(await(0,promises_1.readdir)(t)).map(a=>(0,path_1.join)(t,a)).filter(t=>(0,fs_1.statSync)(t).isFile()&&t.endsWith(".yaml")):[]}initDataSource(){this.translateDataMap.clear()}async read(){const t=await this.getAllTranslateDataFile();if((await Promise.all(t.map(t=>(0,promises_1.readFile)(t,"utf-8")))).forEach((t,a)=>{const e=YAML.parse(t);try{const t=TranslateData_1.default.parse(e);this.translateDataMap.set(t.locale,t)}catch(t){}}),!this.translateDataMap.has(TranslateData_1.default.INDEX_LOCALE)){const t=new TranslateData_1.default;this.translateDataMap.set(TranslateData_1.default.INDEX_LOCALE,t)}const a=this.globalConfigService.getLocalLanguage();if(a&&!this.translateDataMap.has(a)){const t=new TranslateData_1.default(a);this.translateDataMap.set(a,t)}}async persistent(t){const a=this.configDirectory.translateData;(0,fs_1.existsSync)(a)||await this.generateDir();const e=async t=>{const a=YAML.stringify(t);await(0,promises_1.writeFile)(this.getFilePath(t.locale),a,"utf-8")},s=async t=>{const a=this.getFilePath(t);(0,fs_1.existsSync)(a)&&await(0,promises_1.rm)(a)};if(t){const a=this.translateDataMap.get(t);a?await e(a):await s(t)}else{const t=(await this.getAllTranslateDataFile()).map(t=>{var a,e;return null!==(e=null===(a=t.split("/").pop())||void 0===a?void 0:a.replace(".yaml",""))&&void 0!==e?e:void 0}),a=Array.from(this.translateDataMap.values());await Promise.all([...t.map(t=>t&&!this.translateDataMap.has(t)?s(t):Promise.resolve()),...a.map(t=>e(t))])}t!==TranslateData_1.default.INDEX_LOCALE&&this.translateDataMap.has(TranslateData_1.default.INDEX_LOCALE)&&await e(this.translateDataMap.get(TranslateData_1.default.INDEX_LOCALE))}async uninstall(){await(0,promises_1.rmdir)(this.configDirectory.root,{recursive:!0}),this.initDataSource()}async generateDir(){const t=this.configDirectory.root;(0,fs_1.existsSync)(t)||await(0,promises_1.mkdir)(t);const a=this.configDirectory.translateData;(0,fs_1.existsSync)(a)||await(0,promises_1.mkdir)(a,{recursive:!0})}getFilePath(t){return(0,path_1.join)(this.configDirectory.translateData,`${t}.yaml`)}async addTranslateData(t){if(this.translateDataMap.has(t))throw new Errors_1.CustomError(MainMessage_1.MessageCode.TARGET_TRANSLATE_DATA_EXIST,t);const a=new TranslateData_1.default(t);return this.translateDataMap.set(t,a),await this.persistent(t),a.clone()}async removeTranslateData(t){return this.translateDataMap.has(t)?(this.translateDataMap.delete(t),await this.persistent(t),console.log("TranslateDataSourceService.removeTranslateData",`${t}.yaml delete success`),!0):(console.log("TranslateDataSourceService.removeTranslateData",`${t}.yaml don't need delete`),!1)}async removeAllTranslateData(){Array.from(this.translateDataMap.values()).forEach(t=>{t.items.clear(),t.languageConfig.translateFinished=0,t.languageConfig.translateTotal=0,t.languageConfig.compileFinished=0,t.languageConfig.compileTotal=0}),await this.persistent()}_getLocalTranslateData(){const t=this.globalConfigService.getLocalLanguage();if(!t||!this.translateDataMap.has(t))throw new Errors_1.CustomError(MainMessage_1.MessageCode.LOCAL_LANGUAGE_NOT_SET);return this.translateDataMap.get(t)}getClonedLocalTranslateData(){return this._getLocalTranslateData().clone()}_getTranslateData(t){if(!this.translateDataMap.has(t))throw new Errors_1.CustomError(MainMessage_1.MessageCode.TARGET_TRANSLATE_DATA_NOT_FOUND,t);return this.translateDataMap.get(t)}getClonedTranslateData(t){return this._getTranslateData(t).clone()}getClonedAllTranslateData(){return Array.from(this.translateDataMap.values()).map(t=>t.clone())}getAllLanguageTags(){return Array.from(this.translateDataMap.keys()).filter(t=>t!==TranslateData_1.default.INDEX_LOCALE)}async overrideTranslateData(t){this.translateDataMap.set(t.locale,t),await this.persistent(t.locale)}async saveTranslateData(t,a,e){this.updateTranslateData(t,a,e),await this.persistent(t)}updateTranslateData(t,a,e){var s;const r=this._getIndexData(),i=this._getTranslateData(t),n=i.transformToValueMap();for(const t of a){const a=r.items.get(t.key),l=n.get(t.value);if(a){const r=null!==(s=i.items.get(a.key))&&void 0!==s?s:a.clone().clearAssociation();r.merge(t,e),r.value.length>0?i.items.set(r.key,r):i.items.delete(r.key)}else if(l){if(l.merge(t,e),!r.items.has(l.key)){const t=l.clone().clearVariant().clearValue();r.items.set(t.key,t)}t.value.length>0?(l.clearAssociation(),i.items.set(l.key,l)):i.items.delete(l.key)}else{const a=t.clone().clearValue().clearVariant();r.items.set(a.key,a),t.value.length>0?(t.clearAssociation(),i.items.set(t.key,t),n.set(t.value,t)):(i.items.delete(t.key),n.delete(t.value))}}const l=this.globalConfigService.getLocalLanguage(),o=this._getLocalTranslateData();if(i.locale!==l)i.statisticsFinished(o);else{Array.from(this.translateDataMap.values()).forEach(t=>{t.statisticsFinished(o)})}i.statisticsTotal()}async setLocalTranslateData(t){var a,e;const s=this.globalConfigService.getLocalLanguage();if(s!==t){const r=this.translateDataMap.get(s),i=null!==(a=this.translateDataMap.get(t))&&void 0!==a?a:new TranslateData_1.default(t);for(const[t,a]of null!==(e=null===r||void 0===r?void 0:r.items)&&void 0!==e?e:[]){const e=a.clone();i.items.has(t)||i.items.set(t,e)}i.statisticsTotal(),this.translateDataMap.set(i.locale,i),this.translateDataMap.forEach(t=>{t.statisticsFinished(i)}),await this.persistent()}}async updateLanguageConfig(t,a){this._getTranslateData(t).languageConfig=a,await this.persistent(t)}_getIndexData(){return this._getTranslateData(TranslateData_1.default.INDEX_LOCALE)}getClonedIndexData(){return this._getIndexData().clone()}getLocalLanguageConfig(){var t;if(this.globalConfigService.getLocalLanguage())return null===(t=this.translateDataMap.get(this.globalConfigService.getLocalLanguage()))||void 0===t?void 0:t.languageConfig}getLanguageConfig(t){return this._getTranslateData(t).languageConfig.clone()}getAllLanguageConfigs(){const t=this.globalConfigService.getLocalLanguage();return Array.from(this.translateDataMap.values()).filter(a=>a.locale!==t&&a.locale!==TranslateData_1.default.INDEX_LOCALE).map(t=>t.languageConfig.clone())}changeValue(t,a,e){}async addAssociation(t,a){try{const e=this._getIndexData();let s;if(e.items.has(t))s=e.items.get(t);else{if(!(t.length>0))return;s=new TranslateItem_1.default(t,"",TranslateItemType_1.default.Text,!1,[a])}s.associations.push(a),e.items.set(t,s),await this.persistent(TranslateData_1.default.INDEX_LOCALE)}catch(t){t instanceof Errors_1.CustomError?(console.log(t),console.log("Don't need remove this association")):console.warn(t)}}async removeAssociation(t,a){try{const e=this._getIndexData().items.get(t);e&&(e.removeAssociation(a),await this.persistent(TranslateData_1.default.INDEX_LOCALE))}catch(t){t instanceof Errors_1.CustomError?(console.log(t),console.log("Don't need remove this association")):console.warn(t)}}getShouldTranslateItems(t){const a=this.getClonedLocalTranslateData(),e=this._getTranslateData(t);return Array.from(a.items.values()).filter(t=>{var a,s;return t.value.length>0&&0===(null!==(s=null===(a=e.items.get(t.key))||void 0===a?void 0:a.value.length)&&void 0!==s?s:0)}).map(t=>t.clone())}async clearAllLanguagesProvider(){for(const t of this.translateDataMap.values())t.languageConfig.providerTag=void 0;await this.persistent()}};TranslateDataSourceService=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[ProjectConfigService_1.default,directory_structure_1.ConfigDirectoryStructure,UUIDService_1.default])],TranslateDataSourceService),exports.default=TranslateDataSourceService;