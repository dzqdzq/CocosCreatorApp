"use strict";var __decorate=this&&this.__decorate||function(e,t,a,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,a):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,a,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(i=(o<3?s(i):o>3?s(t,a,i):s(t,a))||i);return o>3&&i&&Object.defineProperty(t,a,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const tsyringe_1=require("tsyringe"),TranslateData_1=__importDefault(require("../../entity/translate/TranslateData")),TranslateItemType_1=__importDefault(require("../../entity/translate/TranslateItemType")),EditorMessageService_1=__importDefault(require("../EditorMessageService")),global_1=require("../util/global"),TranslateDataSourceService_1=__importDefault(require("./TranslateDataSourceService"));let CompileService=class{constructor(e,t){this.translateDataSourceService=e,this.editorMessageService=t}async addSubAssetUUIDToResourceItem(e,t){const a=await this.editorMessageService.queryAssetInfo(t.key);if(a)for(const r in a.subAssets){const s=a.subAssets[r],o=s.uuid.replace(t.key,t.value);await this.editorMessageService.queryAssetInfo(o)?e[s.uuid]=o:console.warn(`[${global_1.MainName}]: UUID mapping from "${s}" to "${o}" fails because asset with UUID "${o}" does not exist`)}}async translateDataToResourceData(e){const t={};global_1.ALLOW_NAMESPACE.forEach(e=>t[e]={});for(const[a,r]of e.items.entries())if(r.type===TranslateItemType_1.default.Media)r.value!==r.key&&(t[global_1.ASSET_NAMESPACE][r.key]=r.value,await this.addSubAssetUUIDToResourceItem(t[global_1.ASSET_NAMESPACE],r));else{t[global_1.DEFAULT_NAMESPACE][r.key]=r.value;for(const e of r._variants)t[global_1.DEFAULT_NAMESPACE][e.key]=e.value}return t}async compile(e){let t;t=e.length>0?e.map(e=>this.translateDataSourceService.getClonedTranslateData(e)):this.translateDataSourceService.getClonedAllTranslateData().filter(e=>e.locale!==TranslateData_1.default.INDEX_LOCALE);const a={};for(let e=0;e<t.length;e++){const r=t[e],s=await this.translateDataToResourceData(r);a[r.locale]=s}return a}};CompileService=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[TranslateDataSourceService_1.default,EditorMessageService_1.default])],CompileService),exports.default=CompileService;