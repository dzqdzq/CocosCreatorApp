"use strict";var __decorate=this&&this.__decorate||function(e,t,a,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,a):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,a,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(s=(i<3?n(s):i>3?n(t,a,s):n(t,a))||s);return i>3&&s&&Object.defineProperty(t,a,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");const tsyringe_1=require("tsyringe"),TranslateProviderConfig_1=__importDefault(require("../entity/config/TranslateProviderConfig")),LanguageConfig_1=__importDefault(require("../entity/translate/LanguageConfig")),TranslateData_1=__importDefault(require("../entity/translate/TranslateData")),TranslateItem_1=__importDefault(require("../entity/translate/TranslateItem")),WrapperTranslateItem_1=__importDefault(require("../entity/translate/WrapperTranslateItem")),EventBusService_1=__importDefault(require("../service/util/EventBusService")),global_1=require("../service/util/global"),EditorMessageService_1=__importDefault(require("../service/EditorMessageService")),MainIPC_1=__importDefault(require("./MainIPC"));let WrapperMainIPC=class{constructor(e,t,a){this.editorMessageService=e,this.eventBus=t,this.mainIPC=a,this.formatter=Intl.NumberFormat("en",{notation:"compact"})}uninstall(){return this.requestMainMethod("uninstall")}async toggle(){return!!await this.requestMainMethod("toggle")}async getEnable(){return!!await this.requestMainMethod("getEnable")}async getAllLanguageTranslationDataList(){var e;const t=await this.getAllLanguageConfigs(),a=[];for(let r=0;r<t.length;r++){const n=t[r],i=null!==(e=await this.getTranslateData(n.bcp47Tag))&&void 0!==e?e:[];i.forEach(e=>e.locale=n.bcp47Tag),a.push(...i)}return a}getCurrentTranslateProvider(){return this.requestMainMethod("getCurrentTranslateProvider")}getTranslateProvider(e){return this.requestMainMethod("getTranslateProvider",e)}setCurrentTranslateProvider(e){return this.requestMainMethod("setCurrentTranslateProvider",TranslateProviderConfig_1.default.parse(e))}clearTranslateProvider(){return this.requestMainMethod("clearTranslateProvider")}async getProviderLanguages(e){var t;if(e){const a={};return(null!==(t=await this.requestMainMethod("getTranslateProviderSupportedLanguages",e))&&void 0!==t?t:[]).forEach(t=>{a[t]=this.getDisplayNameOfLanguage(t,"none")||Editor.I18n.t(`${global_1.MainName}.${e}.${t}`)||t}),a}return{}}setLanguageConfig(e){return this.requestMainMethod("setLanguageConfig",LanguageConfig_1.default.parse(e))}async getTranslateProviders(){var e;return null!==(e=await this.requestMainMethod("getTranslateProviders"))&&void 0!==e?e:[]}async getLocalLanguageConfig(){return this.getLanguageConfig()}async getLanguageConfig(e){const t=await this.getLocalLanguage();if(!t)return null;const a=await this.requestMainMethod("getLanguageConfig",e);return a?(a.bcp47Tag===t&&(a.translateFinished=a.translateTotal),Object.assign({displayName:this.getDisplayNameOfLanguage(a.bcp47Tag)},a)):null}async getIndexData(){var e;const t=null!==(e=await this.requestMainMethod("getIndexData"))&&void 0!==e?e:[],a=[];if(null===t||void 0===t?void 0:t.length)for(let e=0;e<t.length;e++){const r=t[e],n=await WrapperTranslateItem_1.default.toSerialize(r);for(let e=0;e<n.associations.length;e++){const t=n.associations[e];if(t.reference){const e=await this.editorMessageService.queryAssetInfo(t.reference);e&&(t.assetInfo=e)}}a.push(n)}return a}async getAllLanguageConfigs(){var e;if(!await this.getLocalLanguage())return[];const t=await this.getLocalLanguageConfig(),a=(null!==(e=await this.requestMainMethod("getAllLanguageConfigs"))&&void 0!==e?e:[]).filter(e=>e.bcp47Tag!==TranslateData_1.default.INDEX_LOCALE).map(e=>Object.assign({displayName:this.getDisplayNameOfLanguage(e.bcp47Tag)},e));return t?[t,...a]:a}setLocalLanguage(e){return this.requestMainMethod("setLocalLanguageLocale",e)}async removeLanguage(e){return!!(await Editor.Dialog.info("是否删除？",{buttons:["no","yes"],cancel:0})).response&&!!await this.requestMainMethod("removeTargetLanguage",e)}async importFilesFromDirectory(e,t,a){var r;const n=null!==(r=await this.requestMainMethod("importMediaFiles",e,t,a))&&void 0!==r?r:[],i=[];for(let e=0;e<n.length;e++){const t=n[e];i.push(await WrapperTranslateItem_1.default.toSerialize(t))}return i}saveTranslateData(e,t,a){let r;return r=t instanceof Array?t.map(TranslateItem_1.default.parse):Object.values(t).map(e=>e&&TranslateItem_1.default.parse(e)).filter(Boolean),this.requestMainMethod("saveTranslateData",e,r,a)}compile(e){return this.requestMainMethod("compile",e)}previewBy(e){return this.requestMainMethod("previewBy",e)}async autoTranslate(e){var t;const a=null!==(t=await this.requestMainMethod("autoTranslate",e))&&void 0!==t?t:[],r=[];for(let e=0;e<a.length;e++){const t=a[e];r.push(await WrapperTranslateItem_1.default.toSerialize(t))}return r}numberFormat(e){return this.formatter.format(e)}async getTranslateData(e){var t,a;const r=null!==(t=await this.requestMainMethod("getTranslateData",e))&&void 0!==t?t:[],n=await this.getLocalLanguage();if(!e||n===e){const e=null!==(a=await this.requestMainMethod("getIndexData"))&&void 0!==a?a:[];for(let t=0;t<e.length;t++){const a=e[t];r.some(e=>e.key===a.key)||r.push(a)}}const i=[];if(r)for(let e=0;e<r.length;e++){const t=r[e];i.push(await WrapperTranslateItem_1.default.toSerialize(t))}return i}async getLocalLanguage(){return await this.requestMainMethod("getLocalLanguage")||""}async getScanOptions(){var e;return null!==(e=await this.requestMainMethod("getScanOptions"))&&void 0!==e?e:[]}scan(e){return this.requestMainMethod("scan",e)}getFileInfoByUUIDOrPath(e){return Editor.Message.request("asset-db","query-asset-info",e)}getDisplayNameOfLanguage(e,t="code"){const a=Editor.I18n.t(`${global_1.MainName}.language_code.${e}`);return a||"none"!==t?null!==a&&void 0!==a?a:e:a}addTargetLanguage(e){return this.requestMainMethod("addTargetLanguage",e)}async requestMainMethod(e,...t){try{return await this.mainIPC[e](...t)}catch(e){const t=e;return void this.eventBus.emit("onCustomError",t)}}addAssociation(e,t){return this.requestMainMethod("addAssociation",e,t)}removeAssociation(e,t){return this.requestMainMethod("removeAssociation",e,t)}async importTranslateFile(e,t,a){var r;return null!==(r=await this.requestMainMethod("importTranslateFile",e,t,a))&&void 0!==r?r:[]}async exportTranslateFile(e,t,a){return this.requestMainMethod("exportTranslateFile",e,t,a)}};WrapperMainIPC=__decorate([(0,tsyringe_1.singleton)(),__metadata("design:paramtypes",[EditorMessageService_1.default,EventBusService_1.default,MainIPC_1.default])],WrapperMainIPC),exports.default=WrapperMainIPC;