{"code":"'use strict';\r\nimport { LFX_App } from './backer/LFX_App';\r\nimport fs from 'fs';\r\nimport cc from 'cc';\r\nimport ps from 'path';\r\nconst Chroma = require('chroma-js');\r\nclass Lightmap {\r\n    constructor() {\r\n        // 当前场景\r\n        this.scene = null;\r\n        this.renderScene = null;\r\n        this._startBakerTim = 0;\r\n    }\r\n    init() {\r\n        this.lfxApp = new LFX_App();\r\n        this.lfxApp.Baker.on('login', (data) => {\r\n            console.debug('lightMap output info: login', data);\r\n            Editor.Message.broadcast('scene:lightmap-start');\r\n            this._startBakerTim = new Date().getTime();\r\n        });\r\n        this.lfxApp.Baker.on('log', (data) => {\r\n            console.debug('lightMap output info: log', data);\r\n            Editor.Message.broadcast('scene:lightmap-log', data);\r\n        });\r\n        this.lfxApp.Baker.on('progress', (data) => {\r\n            console.debug('lightMap output info: progress', data);\r\n            // progress 也要作为log一部分输出\r\n            Editor.Message.broadcast('scene:lightmap-progress', data);\r\n        });\r\n        this.lfxApp.Baker.on('fineshed', (data) => {\r\n            console.debug('lightMap output info: fineshed', data);\r\n            Editor.Message.broadcast('scene:lightmap-finished');\r\n        });\r\n        this.lfxApp.Baker.on('end', (data) => {\r\n            console.debug('lightMap output info: end', data);\r\n            Editor.Message.broadcast('scene:lightmap-end', data);\r\n            // 光源数量 埋点\r\n            this.reportLightMap('A100002', this.lfxApp?.Baker.World.Lights.length);\r\n            // 烘焙时间记录 埋点 单位分钟\r\n            const endBakerTim = Number(((new Date().getTime() - this._startBakerTim) / 1000 / 60).toFixed(2));\r\n            this.reportLightMap('A100000', endBakerTim);\r\n        });\r\n        this.lfxApp.Baker.on('cancel', (data) => {\r\n            console.debug('lightMap output info: cancel', data);\r\n            Editor.Message.broadcast('scene:lightmap-cancel', data);\r\n        });\r\n        // 加载场景\r\n        this.scene = cc.director.getScene();\r\n        cce.Scene.on('open', this.onLoadScene.bind(this));\r\n        cce.Scene.on('reload', this.onLoadScene.bind(this));\r\n    }\r\n    reportLightMap(id, value) {\r\n        // @ts-ignore\r\n        Editor.Metrics._trackEventWithTimer({\r\n            category: 'bakingSystem',\r\n            id,\r\n            value,\r\n        });\r\n    }\r\n    onLoadScene(scene) {\r\n        this.scene = scene;\r\n        this.renderScene = this.scene._renderScene;\r\n    }\r\n    async apply(data, appPath) {\r\n        if (!fs.existsSync(data.path)) {\r\n            fs.mkdirSync(data.path);\r\n        }\r\n        appPath && (this.lfxApp.Baker.lfxpath = ps.join(appPath, '../tools/lightmap-tools'));\r\n        data.aoColor = Chroma(data.aoColor).rgb();\r\n        this.lfxApp.Init(data);\r\n        await this.bake();\r\n    }\r\n    clear() {\r\n        LFX_App.Reset(this.scene);\r\n    }\r\n    async bake() {\r\n        await this.lfxApp.Bake(this.scene);\r\n    }\r\n    cancel() {\r\n        this.lfxApp.Cancel();\r\n    }\r\n}\r\nexport default new Lightmap();\r\n","references":["/Users/mac/Documents/editor_3d/v3.6.1/app/modules/editor-extensions/extensions/lightmap/source/lightmap/backer/LFX_App.ts","/Users/mac/Documents/editor_3d/v3.6.1/app/node_modules/cc/cc.d.ts","/Users/mac/Documents/editor_3d/v3.6.1/app/modules/editor-extensions/extensions/lightmap/source/panel/components/manager.ts","/Users/mac/Documents/editor_3d/v3.6.1/app/node_modules/chroma-js/chroma.js"]}
