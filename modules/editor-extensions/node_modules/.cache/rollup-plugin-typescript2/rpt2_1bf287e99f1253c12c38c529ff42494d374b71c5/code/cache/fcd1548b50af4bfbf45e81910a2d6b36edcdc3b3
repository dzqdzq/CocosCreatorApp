{"code":"'use strict';\nimport fs from 'fs';\nimport { join } from 'path';\nimport Vue from 'vue';\nimport { Profile } from '../../profile';\nVue.config.productionTip = false;\nVue.config.devtools = false;\nimport readImageList, { getImageInfo } from '../operation/image';\nconst Chroma = require('chroma-js');\nexport var Modes;\n(function (Modes) {\n    Modes[Modes[\"SCENE\"] = 0] = \"SCENE\";\n    Modes[Modes[\"BAKED\"] = 1] = \"BAKED\";\n})(Modes || (Modes = {}));\nexport default Vue.extend({\n    name: 'App',\n    data() {\n        return {\n            mode: Modes.SCENE,\n            progress: 0,\n            logInfos: [],\n            picInfos: [],\n            selectInfo: null,\n            // 是否点击了生成按钮\n            isGenerate: false,\n            msaa: 4,\n            path: '',\n            size: 1024,\n            highp: false,\n            giScale: 1.0,\n            giSamples: 25,\n            giPathLength: 2,\n            aoLevel: 1,\n            aoStrength: 1.0,\n            aoRadius: 1.0,\n            aoColor: [136, 136, 136, 255],\n            tab: 0,\n            r: true,\n            g: true,\n            b: true,\n            a: false,\n            sceneUUID: '',\n            filter: true,\n        };\n    },\n    computed: {\n        channel() {\n            const result = (this.r ? 'r' : '') + (this.g ? 'g' : '') + (this.b ? 'b' : '') + (this.a ? 'a' : '');\n            return result || undefined;\n        },\n    },\n    async mounted() {\n        const state = await Editor.Message.request('lightmap', 'unstaging');\n        if (state.isStart && !state.isEnd) {\n            this.isGenerate = true;\n            this.progress = state.progress;\n        }\n        this.setLogs(state.logInfos);\n    },\n    methods: {\n        async onSceneReady(uuid) {\n            this.sceneUUID = uuid;\n            const uuids = await Profile.getLatestLightmapResults(uuid);\n            this.picInfos = (await Promise.all(uuids.map((item) => getImageInfo(item)))).filter(Boolean);\n            this.$set(this.logInfos, 'length', 0);\n            this.onItemClick(0);\n        },\n        changeColor(eve) {\n            this.aoColor = eve.target.value;\n            this.saveEdit();\n        },\n        saveEdit() {\n            Editor.Profile.setConfig('lightmap', 'lightmap', {\n                msaa: this.msaa,\n                size: this.size,\n                highp: this.highp,\n                giScale: this.giScale,\n                giSamples: this.giSamples,\n                giPathLength: this.giPathLength,\n                aoLevel: this.aoLevel,\n                aoStrength: this.aoStrength,\n                aoRadius: this.aoRadius,\n                aoColor: this.aoColor,\n                filter: this.filter,\n            });\n            // 默认显示第一张图信息\n            this.onItemClick(0);\n        },\n        /**\n         * 翻译\n         * @param key\n         */\n        t(key) {\n            const name = `lightmap.${key}`;\n            return Editor.I18n.t(name);\n        },\n        clickTab(tab, value) {\n            this[tab] = value;\n            if (tab === 'a') {\n                if (value) {\n                    this.r = this.g = this.b = false;\n                }\n            }\n            else {\n                if (value) {\n                    this.a = false;\n                }\n            }\n        },\n        changeMode(val) {\n            this.mode = val;\n        },\n        async onClear() {\n            const state = await Editor.Message.request('lightmap', 'unstaging');\n            this.sceneUUID = await Editor.Message.request('scene', 'query-current-scene');\n            const path = state.currPath || (await Profile.getLatestLightmapResultDir(this.sceneUUID));\n            // 保证路径存在并且没有在烘焙状态下\n            if (path && !this.isGenerate) {\n                const somethingDeleted = delDir(path);\n                await Profile.setLatestLightmapResults(this.sceneUUID, []);\n                this.selectInfo = null;\n                // 同时清空所有输出\n                this.picInfos = [];\n                this.logInfos = [];\n                if (somethingDeleted) {\n                    await Editor.Message.request('scene', 'execute-scene-script', {\n                        name: 'lightmap',\n                        method: 'clear',\n                        args: [],\n                    });\n                    await Editor.Message.request('lightmap', 'clear');\n                    await Editor.Message.request('asset-db', 'refresh-asset', 'db://assets');\n                }\n            }\n        },\n        /**\n         * 取消烘焙\n         */\n        async onCancel() {\n            this.isGenerate = false;\n            this.logInfos = [];\n            await Editor.Message.request('scene', 'execute-scene-script', {\n                name: 'lightmap',\n                method: 'cancel',\n                args: [],\n            });\n        },\n        /**\n         * 烘焙结束事件\n         */\n        async onBakerEnd() {\n            this.isGenerate = false;\n            const state = await Editor.Message.request('lightmap', 'unstaging');\n            this.picInfos = await readImageList(join(state.currPath, 'output'));\n            this.saveEdit();\n        },\n        /**\n         * 添加输出\n         */\n        pushLog(log) {\n            this.logInfos.push(log);\n        },\n        setLogs(logs) {\n            this.logInfos = [];\n            for (let i = 0; i < logs.length; i++) {\n                this.logInfos.push(logs[i]);\n            }\n        },\n        onItemClick(index) {\n            if (!this.picInfos[index]) {\n                this.selectInfo = null;\n                return;\n            }\n            this.selectInfo = {};\n            for (const key in this.picInfos[index]) {\n                if (key !== 'path' && key !== 'uuid') {\n                    this.selectInfo[key] = this.picInfos[index][key];\n                }\n            }\n        },\n        /**\n         * 提交烘焙\n         */\n        async onConfirm() {\n            this.r = this.g = this.b = true;\n            this.progress = 0;\n            this.logInfos = [];\n            let lastSelectedPath;\n            const latestLightmapResultDir = await Profile.getLatestLightmapResultDir(this.sceneUUID);\n            if (latestLightmapResultDir) {\n                lastSelectedPath = join(latestLightmapResultDir, '../');\n            }\n            const selectResult = await Editor.Dialog.select({\n                type: 'directory',\n                title: this.t('title'),\n                path: lastSelectedPath || join(Editor.Project.path, 'assets'),\n                multi: false,\n                filters: [{ name: 'Lightmap', extensions: ['png'] }],\n            });\n            let filePath = selectResult.filePaths ? selectResult.filePaths[0] : [];\n            if (Array.isArray(filePath)) {\n                filePath = filePath[0];\n            }\n            if (!filePath) {\n                return false;\n            }\n            filePath = `${filePath}/LightFX`;\n            this.path = filePath;\n            // 延迟生成逻辑，让编辑器先触发窗口焦点导致的db刷新操作，避免meta里的uuid更新，导致prefab渲染异常\n            await new Promise((resolve) => {\n                setTimeout(resolve, 500);\n            });\n            await Editor.Message.request('lightmap', 'savePicPath', filePath);\n            if (fs.existsSync(filePath)) {\n                delDir(filePath);\n                await Editor.Message.request('asset-db', 'refresh-asset', filePath);\n            }\n            this.logInfos.push(this.t('start') + '\\n');\n            this.isGenerate = true;\n            try {\n                await Editor.Message.request('scene', 'execute-scene-script', {\n                    name: 'lightmap',\n                    method: 'apply',\n                    args: [this.$data, Editor.App.path],\n                });\n            }\n            catch (error) {\n                console.error(error);\n                await this.onCancel();\n                this.logInfos.push(this.t('fail') + '\\n');\n            }\n            // lightmap generate按钮点击次数 埋点\n            Editor.Metrics.trackEvent({\n                sendToNewCocosAnalyticsOnly: true,\n                category: 'bakingSystem',\n                value: {\n                    A100003: 1,\n                },\n            });\n        },\n    },\n});\n/**\n *\n * @param path\n * @param delSelf\n * @returns 是否有内容被删除了\n */\nexport function delDir(path, delSelf = false) {\n    let files = [];\n    let someThingDeleted = false;\n    if (fs.existsSync(path)) {\n        files = fs.readdirSync(path);\n        files.forEach((file, index) => {\n            const curPath = path + '/' + file;\n            // 跳过meta文件，避免改变uuid，导致资源的引用出错\n            if (file.endsWith('.meta')) {\n                return;\n            }\n            if (fs.statSync(curPath).isDirectory()) {\n                // 递归删除文件夹\n                const result = delDir(curPath, true);\n                someThingDeleted || (someThingDeleted = result);\n            }\n            else {\n                // 删除文件\n                fs.unlinkSync(curPath);\n                someThingDeleted = true;\n            }\n        });\n    }\n    return someThingDeleted;\n}\n","references":["/Users/mac/Documents/editor_3d/v3.8.8/app/node_modules/path/path.js","/Users/mac/Documents/editor_3d/v3.8.8/app/node_modules/vue/types/index.d.ts","/Users/mac/Documents/editor_3d/v3.8.8/app/modules/editor-extensions/extensions/lightmap/source/profile/index.ts","/Users/mac/Documents/editor_3d/v3.8.8/app/modules/editor-extensions/extensions/lightmap/source/panel/operation/image.ts","/Users/mac/Documents/editor_3d/v3.8.8/app/node_modules/chroma-js/chroma.js"]}
