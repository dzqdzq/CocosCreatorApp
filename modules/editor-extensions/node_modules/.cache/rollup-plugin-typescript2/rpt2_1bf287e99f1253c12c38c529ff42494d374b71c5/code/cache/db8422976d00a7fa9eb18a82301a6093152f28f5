{"code":"'use strict';\nimport { LFX_App } from './backer/LFX_App';\nimport fs from 'fs';\nimport cc from 'cc';\nimport ps from 'path';\nclass Lightmap {\n    constructor() {\n        // 当前场景\n        this.scene = null;\n        this.renderScene = null;\n        this._startBakerTim = 0;\n    }\n    init() {\n        this.lfxApp = new LFX_App();\n        this.lfxApp.Baker.on('login', (data) => {\n            console.debug('lightFX output info: login', data);\n            this._startBakerTim = new Date().getTime();\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:start');\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-start');\n            }\n        });\n        this.lfxApp.Baker.on('log', (data) => {\n            console.debug('lightFX output info: log', data);\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:log', data);\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-log', data);\n            }\n        });\n        this.lfxApp.Baker.on('progress', (data) => {\n            console.debug('lightFX output info: progress', data);\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:progress', data);\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-progress', data);\n            }\n        });\n        this.lfxApp.Baker.on('fineshed', (data) => {\n            console.debug('lightFX output info: fineshed', data);\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:finished');\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-finished');\n                this.scene?.globals.lightProbeInfo.onProbeBakeFinished();\n            }\n        });\n        this.lfxApp.Baker.on('end', (data) => {\n            console.debug('lightFX output info: end', data);\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:end', data);\n                // 光源数量 埋点\n                this.reportLightMap('A100002', this.lfxApp?.Baker.World.Lights.length);\n                // 烘焙时间记录 埋点 单位分钟\n                const endBakerTim = Number(((new Date().getTime() - this._startBakerTim) / 1000 / 60).toFixed(2));\n                this.reportLightMap('A100000', endBakerTim);\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-end', data);\n            }\n            cce.Engine.repaintInEditMode();\n        });\n        this.lfxApp.Baker.on('cancel', (data) => {\n            console.debug('lightFX output info: cancel', data);\n            if (this.lfxApp?.Baker.World.Settings.BakeLightMap) {\n                Editor.Message.broadcast('lightmap:cancel', data);\n            }\n            if (this.lfxApp?.Baker.World.Settings.BakeLightProbe) {\n                Editor.Message.broadcast('lightmap:light-probe-cancel', data);\n            }\n        });\n        // 加载场景\n        this.scene = cc.director.getScene();\n        cce.Scene.on('open', this.onLoadScene.bind(this));\n        cce.Scene.on('reload', this.onLoadScene.bind(this));\n    }\n    reportLightMap(id, value) {\n        const eventValue = {};\n        eventValue[id] = value;\n        Editor.Metrics.trackEvent({\n            sendToNewCocosAnalyticsOnly: true,\n            category: 'bakingSystem',\n            value: eventValue,\n        });\n    }\n    onLoadScene(scene) {\n        this.scene = scene;\n        this.renderScene = this.scene.renderScene;\n    }\n    async apply(data, appPath) {\n        if (!fs.existsSync(data.path)) {\n            fs.mkdirSync(data.path);\n        }\n        appPath && (this.lfxApp.Baker.lfxpath = ps.join(appPath, '../tools/lightmap-tools'));\n        this.lfxApp.Init(data);\n        await this.bake();\n    }\n    clear() {\n        LFX_App.Reset(this.scene);\n        cce.Engine.repaintInEditMode();\n    }\n    async bake() {\n        await this.lfxApp.BakeLightMap(this.scene);\n    }\n    cancel() {\n        this.lfxApp.Cancel();\n    }\n    bakeLightProbe(data, appPath) {\n        if (!fs.existsSync(data.path)) {\n            fs.mkdirSync(data.path);\n        }\n        appPath && (this.lfxApp.Baker.lfxpath = ps.join(appPath, '../tools/lightmap-tools'));\n        this.lfxApp.Init(data);\n        this.lfxApp.BakeLightProbe(this.scene);\n        try {\n            if (this.scene &&\n                this.scene.globals.lightProbeInfo &&\n                this.scene.globals.lightProbeInfo.data &&\n                this.scene.globals.lightProbeInfo.data.probes) {\n                const probes = this.scene.globals.lightProbeInfo.data.probes.length;\n                Editor.Metrics._trackEventWithTimer({\n                    category: 'bakingSystem',\n                    id: 'A100010',\n                    value: probes,\n                });\n            }\n        }\n        catch (error) {\n            console.debug(error);\n        }\n    }\n    cancelLightProbe() {\n        this.lfxApp.Cancel();\n    }\n}\nexport default new Lightmap();\n","references":["/Users/mac/Documents/editor_3d/v3.8.8/app/modules/editor-extensions/extensions/lightmap/source/lightmap/backer/LFX_App.ts","/Users/mac/Documents/editor_3d/v3.8.8/app/node_modules/cc/cc.d.ts","/Users/mac/Documents/editor_3d/v3.8.8/app/node_modules/path/path.js","/Users/mac/Documents/editor_3d/v3.8.8/app/modules/editor-extensions/extensions/lightmap/source/panel/components/manager.ts"]}
