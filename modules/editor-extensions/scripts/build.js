"use strict";const{rollup:rollup}=require("rollup"),{join:join,dirname:dirname}=require("path"),{readFileSync:readFileSync,existsSync:existsSync,writeFileSync:writeFileSync,readdirSync:readdirSync,statSync:statSync}=require("fs"),{getTaskConfig:getTaskConfig}=require("./rollup-utils/index"),configFile=join(__dirname,"../config.json");existsSync(configFile)||(console.error("没有找到 config.json，无法正常构建"),process.exit(-1));try{const e=readFileSync(configFile),r=JSON.parse(e);let t="";t+=`/// <reference path="${join(r.enginePath,"./bin/.declarations/cc.d.ts")}"/>\n`,t+=`/// <reference path="${join(r.enginePath,"/bin/.declarations/cc.editor.d.ts")}"/>\n`,writeFileSync(join(__dirname,"../@types/cc.d.ts"),t)}catch(e){console.error("config.json 格式错误"),console.error(e),process.exit(-1)}process.argv.some(e=>e.startsWith("--only-dts"))&&process.exit(0);const builder=require("@editor/build");function scan(e){readdirSync(e).forEach(r=>{const t=join(e,r);statSync(t).isDirectory()&&builder.addWorkspace(t)})}scan(join(__dirname,"../extensions")),builder.config({entry:".editor.js",config:join(__dirname,".build-cache.json")}),builder.register("rollup",{title:"编译 Typescript(Rollup)",timeLength:8,stateLength:7,parallel:5,async execute(e){if("string"==typeof e){const r=e,t={state:"null",info:dirname(r)};e=[];const o=require(r);if(!o.rollup)return t.state="null",t;if(t.state="success",!(e=o.rollup()))return t.state="null",t;try{const o=dirname(r);for(let n of e){const{outputOptions:e,inputOptions:i}=getTaskConfig(n,o);join(dirname(r),n.sourceDir);try{const r=await rollup(i);await r.write(e)}catch(e){console.error(e),t.state="error"}}}catch(e){console.error(e),t.state="error"}return t}let r="success";try{for(const t of e){const{outputOptions:e,inputOptions:o}=getTaskConfig(t,this.path);join(this.path,t.sourceDir);try{const t=await rollup(o);await t.write(e)}catch(e){console.error(e),r="error"}}}catch(e){console.error(e),r="error"}return r}}),async function(){const e=await builder.executeTask(["tsc","rollup","lessc","file","compress"]),r=[];for(const t in e){const o=e[t];for(const e of o)"error"===e.state&&r.push(e)}r.length&&(console.log(["================================================================================","没有正确完成构建任务，请查看日志，并根据建议尝试修复"].join("\n")),r.forEach(e=>{console.log(e)}),console.log(["================================================================================"].join("\n")),process.exit(-1))}();