"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),path=require("path");async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-creative-app",value:{}}),e.server&&!e.server.endsWith("/")&&(e.server+="/");const r=e.includeModules.findIndex(e=>e.startsWith("physics-ammo"));-1!==r&&(e.includeModules[r]="physics-cannon"),e.buildEngineParam.split=!0,t.staticsInfo.B100012=e.server}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.platform="TAOBAO";const t=e.includeModules.indexOf("gfx-webgl2");-1!==t&&(e.includeModules.splice(t,1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0}async function onBeforeCompressSettings(e,t,a){t.settings.orientation="portrait"}async function onAfterBuild(e,t,a){if(!t.paths.dir)return;const r=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=(0,path_1.join)(r,"templates/taobao-creative-app");await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/taobao",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/taobao",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js"));const i={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},o=await ejs_1.default.renderFile((0,path_1.join)(s,"app.ejs"),i);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"app.js"),o);const n=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(n)&&((0,fs_extra_1.copySync)(n,t.paths.dir),console.debug(`Use build-template {link(${n})}.`)),["mini.project.json","app.json"].forEach(e=>{const a=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s,e)),r=(0,path_1.join)(n,e);if((0,fs_extra_1.existsSync)(r)){const e=(0,fs_extra_1.readJSONSync)(r);Object.assign(a,e)}const i=(0,path_1.join)(t.paths.dir,e);(0,fs_extra_1.writeJSONSync)(i,a)}),(await globby(["**/*","!mini.project.json","!app.json","!**/*.ejs"],{cwd:s})).map(e=>path.resolve(s,e)).forEach(e=>{if((0,fs_extra_1.statSync)(e).isFile()){const a=(0,path_1.relative)(s,e),r=(0,fs_extra_1.readFileSync)(e,"utf8");(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),r,{encoding:"utf8"})}}),await postHandleScript(e,t,a)}async function postHandleScript(e,t,a){const r=e.debug?"\n":"";let s=`var window = $global, global = $global, globalThis = $global;${r}`;["__globalAdapter","cc","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket","CANNON"].forEach(e=>{s+=`var ${e} = window.${e};${r}`});const i=e.packages["taobao-creative-app"].globalVariable;if(i){i.split(",").map(e=>e.trim()).forEach(e=>{s+=`var ${e} = window.${e};${r}`})}const o=["app.js","pages/**/*.js","**/system.bundle*.js","**/polyfills.bundle*.js","**/import-map*.js","src/assets/**/*.js"],n=t.paths.dir,l=/System\.register\((\[.*?\].*?\{)/g,p=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g,c=(await globby(["**/*.js",...o.map(e=>"!"+e)],{cwd:n})).map(e=>path.resolve(t.paths.dir,e));c.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");let i=(0,fs_extra_1.readFileSync)(e,"utf8");if(l.test(i))i=i.replace(l,`$global.System.register('no-schema:/${a}', $1${r}${s}`);else{if(p.test(i))i=i.replace(p,`$global.System.register($1${r}${s}`);else{i=`$global.System.register('no-schema:/${a}', [], (_export, _context) => { return { setters: [], execute () {${r}`+s+i+`${r}}}});`}}(0,fs_extra_1.writeFileSync)(e,i,"utf8")}),(await globby(o,{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{let t=(0,fs_extra_1.readFileSync)(e,"utf8");t=s+t,(0,fs_extra_1.writeFileSync)(e,t,"utf8")});const f=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(r),d=(0,path_1.join)(t.paths.dir,"app.js");let u=(0,fs_extra_1.readFileSync)(d,"utf8");u=f+u,(0,fs_extra_1.writeFileSync)(d,u,"utf8");let h="";c.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");h+=`require('./${a}');\n`}),(await globby("assets/**/*.js",{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");h+=`require('./${a}');\n`}),(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"load-module.js"),h,{encoding:"utf8"});let _="";(await globby("src/assets/**/*.js",{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");_+=`require('./${a}');\n`}),(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"load-module-plugin.js"),_,{encoding:"utf8"});const m=(await globby(["cocos-js/base*.js"],{cwd:n})).map(e=>path.resolve(n,e)),y=(await globby(["cocos-js/physics-ammo*.js","cocos-js/physics-cannon*.js","cocos-js/physics-framework*.js","cocos-js/physics-builtin*.js"],{cwd:n})).map(e=>path.resolve(n,e));1===m.length&&y.forEach(e=>{const t=m[0].replace(/\\/g,"/").lastIndexOf("/");if(-1!==t){const a=m[0].substring(t+1);let r=(0,fs_extra_1.readFileSync)(e,"utf8");r=r.replace(/base.js/,a),(0,fs_extra_1.writeFileSync)(e,r,"utf8")}})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;