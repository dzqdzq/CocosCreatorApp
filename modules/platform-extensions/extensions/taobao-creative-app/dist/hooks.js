"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby");async function onAfterInit(t,e,a){t.polyfills&&(t.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-creative-app",value:{}}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(e.paths.dir),t.server&&!t.server.endsWith("/")&&(t.server+="/"),t.moveRemoteBundleScript=!0,Object.assign(t.buildEngineParam,{platform:"TAOBAO"}),t.buildScriptParam.importMapFormat="commonjs",t.buildScriptParam.system={preset:"commonjs-like"},t.buildEngineParam.split=!0;const r=t.includeModules.indexOf("gfx-webgl2");-1!==r&&(t.includeModules.splice(r,1),t.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),t.assetSerializeOptions.exportCCON=!0;const s={remoteServerAddress:t.server};a.__addStaticsInfo(s)}async function onBeforeCompressSettings(t,e,a){e.settings.orientation="portrait"}async function onAfterBuild(t,e,a){if(!e.paths.dir)return;const r=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=path_1.join(r,"templates/taobao-creative-app");await fs_extra_1.copy(path_1.join(r,"bin/adapter/minigame/taobao",`web-adapter.${t.debug?"":"min."}js`),path_1.join(e.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(r,"bin/adapter/minigame/taobao",`engine-adapter.${t.debug?"":"min."}js`),path_1.join(e.paths.dir,"engine-adapter.js"));const i={polyfillsBundleFile:e.paths.polyfillsJs&&Build.Utils.relativeUrl(e.paths.dir,e.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(e.paths.dir,e.paths.systemJs),importMapFile:Build.Utils.relativeUrl(e.paths.dir,e.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(e.paths.dir,e.paths.applicationJS)},o=await ejs_1.default.renderFile(path_1.join(s,"app.ejs"),i);fs_extra_1.writeFileSync(path_1.join(e.paths.dir,"app.js"),o);const n=path_1.join(Build.buildTemplateDir,t.platform);fs_extra_1.existsSync(n)&&(fs_extra_1.copySync(n,e.paths.dir),console.debug(`Use build-template {link(${n})}.`)),["mini.project.json","app.json"].forEach(t=>{const a=fs_extra_1.readJSONSync(path_1.join(s,t)),r=path_1.join(n,t);if(fs_extra_1.existsSync(r)){const t=fs_extra_1.readJSONSync(r);Object.assign(a,t)}const i=path_1.join(e.paths.dir,t);fs_extra_1.writeJSONSync(i,a)}),(await globby([path_1.join(s,"**/*"),`!${path_1.join(s,"mini.project.json")}`,`!${path_1.join(s,"app.json")}`,`!${path_1.join(s,"**/*.ejs")}`])).forEach(t=>{if(fs_extra_1.statSync(t).isFile()){const a=path_1.relative(s,t),r=fs_extra_1.readFileSync(t,"utf8");fs_extra_1.outputFileSync(path_1.join(e.paths.dir,a),r,{encoding:"utf8"})}}),await postHandleScript(t,e,a)}async function postHandleScript(t,e,a){const r=t.debug?"\n":"";let s=`var window = $global, global = $global, globalThis = $global;${r}`;["__globalAdapter","cc","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(t=>{s+=`var ${t} = window.${t};${r}`});const i=t.packages["taobao-creative-app"].globalVariable;if(i){i.split(",").map(t=>t.trim()).forEach(t=>{s+=`var ${t} = window.${t};${r}`})}const o=[path_1.join(e.paths.dir,"app.js"),path_1.join(e.paths.dir,"pages/**/*.js"),path_1.join(e.paths.dir,"**/system.bundle*.js"),path_1.join(e.paths.dir,"**/polyfills.bundle*.js"),path_1.join(e.paths.dir,"**/import-map*.js"),path_1.join(e.paths.dir,"src/assets/**/*.js")],n=await globby([path_1.join(e.paths.dir,"**/*.js"),...o.map(t=>"!"+t)]),p=/System\.register\((\[.*?\].*?\{)/g,l=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;n.forEach(t=>{const a=path_1.relative(e.paths.dir,t).replace(/\\/g,"/");let i=fs_extra_1.readFileSync(t,"utf8");if(p.test(i))i=i.replace(p,`$global.System.register('no-schema:/${a}', $1${r}${s}`);else{if(l.test(i))i=i.replace(l,`$global.System.register($1${r}${s}`);else{i=`$global.System.register('no-schema:/${a}', [], (_export, _context) => { return { setters: [], execute () {${r}`+s+i+`${r}}}});`}}fs_extra_1.writeFileSync(t,i,"utf8")}),(await globby(o)).forEach(t=>{let e=fs_extra_1.readFileSync(t,"utf8");e=s+e,fs_extra_1.writeFileSync(t,e,"utf8")});const c=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(r),_=path_1.join(e.paths.dir,"app.js");let d=fs_extra_1.readFileSync(_,"utf8");d=c+d,fs_extra_1.writeFileSync(_,d,"utf8");let h="";n.forEach(t=>{const a=path_1.relative(e.paths.dir,t).replace(/\\/g,"/");h+=`require('./${a}');\n`}),(await globby(path_1.join(e.paths.dir,"assets/**/*.js"))).forEach(t=>{const a=path_1.relative(e.paths.dir,t).replace(/\\/g,"/");h+=`require('./${a}');\n`}),fs_extra_1.outputFileSync(path_1.join(e.paths.dir,"load-module.js"),h,{encoding:"utf8"});let f="";(await globby(path_1.join(e.paths.dir,"src/assets/**/*.js"))).forEach(t=>{const a=path_1.relative(e.paths.dir,t).replace(/\\/g,"/");f+=`require('./${a}');\n`}),fs_extra_1.outputFileSync(path_1.join(e.paths.dir,"load-module-plugin.js"),f,{encoding:"utf8"});const u=await globby([path_1.join(e.paths.dir,"cocos-js/base*.js")]),j=await globby([path_1.join(e.paths.dir,"cocos-js/physics-ammo*.js"),path_1.join(e.paths.dir,"cocos-js/physics-cannon*.js"),path_1.join(e.paths.dir,"cocos-js/physics-framework*.js"),path_1.join(e.paths.dir,"cocos-js/physics-builtin*.js")]);1===u.length&&j.forEach(t=>{const e=u[0].lastIndexOf("/");if(-1!==e){const a=u[0].substring(e+1);let r=fs_extra_1.readFileSync(t,"utf8");r=r.replace(/base.js/,a),fs_extra_1.writeFileSync(t,r,"utf8")}})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;