"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareVersion=exports.verificationFunc=exports.findSignIdentify=exports.renameXcodeResource=exports.updateXcodeproject=exports.modifyPackageName=exports.checkPackageNameValidity=exports.changePackageName=exports.updateOrientation=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),plist=require("plist"),child_process_1=require("child_process");async function updateOrientation(e,t){if(!t)return;const a=path_1.join(e,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist");if(fs_extra_1.existsSync(a)){let e=await fs_extra_1.readFile(a,"utf8");const r=plist.parse(e),i=[];t.landscapeRight&&i.push("UIInterfaceOrientationLandscapeRight"),t.landscapeLeft&&i.push("UIInterfaceOrientationLandscapeLeft"),t.portrait&&i.push("UIInterfaceOrientationPortrait"),t.upsideDown&&i.push("UIInterfaceOrientationPortraitUpsideDown"),r.UISupportedInterfaceOrientations=i,e=plist.build(r),await fs_extra_1.writeFile(a,e)}}async function changePackageName(e,t){const a=path_1.join(e,".cocos-project.json");if(!fs_extra_1.existsSync(a))return void console.error(`Can't find project json [${a}]`);const r=await fs_extra_1.readJSON(a);if(!checkPackageNameValidity(t=t||r.packageName))return void console.error("The package name is illegal(iOS). It can only contain these characters: [0-9], [a-z], [A-Z], [_].");let i=r.packageName;r.mac&&r.mac.packageName&&(i=r.mac.packageName);const n=i!==t;if(!n)return;const o=path_1.join(e,"cocos-project-template.json");if(!fs_extra_1.existsSync(o))return void console.error(`Can't find template json [${o}]`);const s=(await fs_extra_1.readJSON(o)).do_add_native_support;let c;if(n){c=s.project_replace_ios_bundleid.files;for(const a of c){const r=path_1.join(e,a);if(!fs_extra_1.existsSync(r)){console.error(`Can't not find file [${a}], replace package name failed`);continue}let n=await fs_extra_1.readFile(r,"utf8");n=n.replace(new RegExp(i,"gm"),t),await fs_extra_1.writeFile(r,n)}}r.ios||(r.ios={}),r.ios.packageName=t,await fs_extra_1.writeFile(a,JSON.stringify(r,null,2))}function checkPackageNameValidity(e){return/^[a-zA-Z]+([a-zA-Z0-9-.])+$/.test(e)}function modifyPackageName(e){return e}async function updateXcodeproject(e,t){const a=await(await Editor.Message.request("engine","query-engine-info")).native.builtin,r=t.packages.native.template,i=path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj`);if("link"===r&&fs_extra_1.existsSync(i)){const e=path_1.join(i,"project.pbxproj");let t=(await fs_extra_1.readFile(e)).toString();t=t.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,path_1.normalize(a)),await fs_extra_1.writeFile(e,t)}const n=path_1.join(i,"xcshareddata/xcschemes/HelloJavascript-clip.xcscheme");if(fs_extra_1.existsSync(n)){let e=(await fs_extra_1.readFile(n)).toString();e=e.replace(/HelloJavascript/g,t.name),await fs_extra_1.writeFile(n,e)}}async function renameXcodeResource(e,t){const a=[path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/HelloJavascript-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/${t.name}-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios/HelloJavascript-mobileRelease.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios/${t.name}-mobileRelease.entitlements`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios_appclip/HelloJavascript.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios_appclip/${t.name}.entitlements`)];for(let e=0;e<a.length;e+=2)fs_extra_1.existsSync(a[e])?await fs_extra_1.rename(a[e],a[e+1]):console.log(`notice: file ${a[e]} not found!`)}function flatArray(e,t){if(e instanceof Array)for(let a of e)flatArray(a,t);else t.push(e)}function readOrganizationUnits(e){const t=child_process_1.execSync(`xcrun security find-certificate -c "${e}" -p`),a=/OU=(\w+),/,r=child_process_1.execSync("openssl x509 -inform PEM -noout -text",{input:t}).toString("utf8").split("\n").filter(t=>t.indexOf(e)>=0).map(e=>e.match(a)).filter(e=>null!==e).map(e=>e[1]);return 0===r.length?[]:r}async function findSignIdentify(){try{const e=child_process_1.execSync("xcrun security find-identity -v -p codesigning").toString("utf8").split("\n"),t=/(\w+\)) ([0-9A-Z]+) "([^"]+)"\s*(\((\w+)\))?/,a=e.map(e=>e.match(t)).filter(e=>null!==e).map(e=>{const t=e[3].split(":");return readOrganizationUnits(e[3]).map(a=>({idx:e[1].substr(0,e[1].length-1),hash:e[2],kind:t[0],displayValue:t[1].trim(),outputValue:a,fullValue:e[3].replace(/\(\w+\)/,`(TEAM:${a})`),errorState:e[5]}))}),r=[];return flatArray(a,r),r.filter(e=>e.outputValue.length>0)}catch(e){return console.warn("ios:"+Editor.I18n.t("ios.tips.developerTeamListError")),console.warn(e),[]}}function verificationFunc(e,t,a){const r={error:"",newValue:t,level:!0};switch(e){case"targetVersion":{let e="11.0";if(!/^([1-9]\d|[1-9])(\.([1-9]\d|\d)){1,2}$/.test(t))return r.error="i18n:ios.tips.version_style_error",r;"taskFlow"===a.packages.native.JobSystem&&(compareVersion(t,e="12.0")||(r.error="i18n:ios.tips.targetVersionErrorWithTaskFlow",r.newValue=e)),r.error||compareVersion(t,e)||(r.error="i18n:ios.tips.targetVersionError",r.newValue=e)}break;case"orientation":case"osTarget":if(!t)return r.error="i18n:ios.tips.not_empty",r;if(Object.keys(t).every(e=>!t[e]))return r.error="i18n:ios.tips.at_least_one",r;break;case"packageName":if(!t)return r.error="i18n:ios.tips.not_empty",r;if(!checkPackageNameValidity(t))return r.error="i18n:ios.tips.packageNameRuleMessage",r}return r}function compareVersion(e,t,a="."){if("string"!=typeof e||"string"!=typeof t)return!0;const r=Math.max(e.length,t.length);return e=e.replace(a,"").padStart(r,"0"),t=t.replace(a,"").padStart(r,"0"),Number(e)>Number(t)||Number(e)===Number(t)}exports.updateOrientation=updateOrientation,exports.changePackageName=changePackageName,exports.checkPackageNameValidity=checkPackageNameValidity,exports.modifyPackageName=modifyPackageName,exports.updateXcodeproject=updateXcodeproject,exports.renameXcodeResource=renameXcodeResource,exports.findSignIdentify=findSignIdentify,exports.verificationFunc=verificationFunc,exports.compareVersion=compareVersion;