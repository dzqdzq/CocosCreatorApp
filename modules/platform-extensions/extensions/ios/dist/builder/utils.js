"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareVersion=exports.verificationFunc=exports.findSignIdentify=exports.renameXcodeResource=exports.updateXcodeproject=exports.modifyPackageName=exports.checkPackageNameValidity=exports.changePackageName=exports.updateOrientation=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),plist=require("plist"),child_process_1=require("child_process");async function updateOrientation(e,a){var r,t,i;a&&(e=(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist"),(0,fs_extra_1.existsSync)(e))&&(r=await(0,fs_extra_1.readFile)(e,"utf8"),t=plist.parse(r),i=[],a.landscapeRight&&i.push("UIInterfaceOrientationLandscapeRight"),a.landscapeLeft&&i.push("UIInterfaceOrientationLandscapeLeft"),a.portrait&&i.push("UIInterfaceOrientationPortrait"),a.upsideDown&&i.push("UIInterfaceOrientationPortraitUpsideDown"),t.UISupportedInterfaceOrientations=i,r=plist.build(t),await(0,fs_extra_1.writeFile)(e,r))}async function changePackageName(e,r){var t=(0,path_1.join)(e,".cocos-project.json");if((0,fs_extra_1.existsSync)(t)){var i=await(0,fs_extra_1.readJSON)(t);if(checkPackageNameValidity(r=r||i.packageName)){let a=i.packageName;var o=(a=i.mac&&i.mac.packageName?i.mac.packageName:a)!==r;if(o){var n=(0,path_1.join)(e,"cocos-project-template.json");if((0,fs_extra_1.existsSync)(n)){var s=(await(0,fs_extra_1.readJSON)(n)).do_add_native_support;if(o)for(const p of s.project_replace_ios_bundleid.files){var c=(0,path_1.join)(e,p);if((0,fs_extra_1.existsSync)(c)){let e=await(0,fs_extra_1.readFile)(c,"utf8");e=e.replace(new RegExp(a,"gm"),r),await(0,fs_extra_1.writeFile)(c,e)}else console.error(`Can't not find file [${p}], replace package name failed`)}i.ios||(i.ios={}),i.ios.packageName=r,await(0,fs_extra_1.writeFile)(t,JSON.stringify(i,null,2))}else console.error(`Can't find template json [${n}]`)}}else console.error("The package name is illegal(iOS). It can only contain these characters: [0-9], [a-z], [A-Z], [_].")}else console.error(`Can't find project json [${t}]`)}function checkPackageNameValidity(e){return/^[a-zA-Z]+([a-zA-Z0-9-.])+$/.test(e)}function modifyPackageName(e){return e}async function updateXcodeproject(a,r){var t=r.engineInfo.native.builtin,i=r.packages.native.template,a=(0,path_1.join)(a,"frameworks/runtime-src/proj.ios_mac",r.name+".xcodeproj");if("link"===i&&(0,fs_extra_1.existsSync)(a)){i=(0,path_1.join)(a,"project.pbxproj");let e=(await(0,fs_extra_1.readFile)(i)).toString();e=e.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,(0,path_1.normalize)(t)),await(0,fs_extra_1.writeFile)(i,e)}t=(0,path_1.join)(a,"xcshareddata/xcschemes/HelloJavascript-clip.xcscheme");if((0,fs_extra_1.existsSync)(t)){let e=(await(0,fs_extra_1.readFile)(t)).toString();e=e.replace(/HelloJavascript/g,r.name),await(0,fs_extra_1.writeFile)(t,e)}}async function renameXcodeResource(e,a){var r=[(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",a.name+".xcodeproj/xcshareddata/xcschemes/HelloJavascript-clip.xcscheme"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`${a.name}.xcodeproj/xcshareddata/xcschemes/${a.name}-clip.xcscheme`),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac","ios/HelloJavascript-mobileRelease.entitlements"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`ios/${a.name}-mobileRelease.entitlements`),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac","ios_appclip/HelloJavascript.entitlements"),(0,path_1.join)(e,"frameworks/runtime-src/proj.ios_mac",`ios_appclip/${a.name}.entitlements`)];for(let e=0;e<r.length;e+=2)(0,fs_extra_1.existsSync)(r[e])?await(0,fs_extra_1.rename)(r[e],r[e+1]):console.log(`notice: file ${r[e]} not found!`)}function flatArray(e,a){if(e instanceof Array)for(var r of e)flatArray(r,a);else a.push(e)}function readOrganizationUnits(e){e=(0,child_process_1.execSync)(`xcrun security find-certificate -c "${e}" -p`),e=(0,child_process_1.execSync)("openssl x509 -inform PEM -noout -text",{input:e}).toString("utf8");const a=/OU\s*=\s*(\w+),/;e=e.split("\n").filter(e=>e.match(/^\s*Subject:/)).map(e=>e.match(a)).filter(e=>null!==e).map(e=>e[1]);return 0===e.length?[]:e}async function findSignIdentify(){try{var e=(0,child_process_1.execSync)("xcrun security find-identity -v -p codesigning").toString("utf8").split("\n");const t=/(\w+\)) ([0-9A-Z]+) "([^"]+)"\s*(\((\w+)\))?/;var a=e.map(e=>e.match(t)).filter(e=>null!==e).map(a=>{const r=a[3].split(":");return readOrganizationUnits(a[3]).map(e=>({idx:a[1].substr(0,a[1].length-1),hash:a[2],kind:r[0],displayValue:r[1].trim(),outputValue:e,fullValue:a[3].replace(/\(\w+\)/,`(TEAM:${e})`),errorState:a[5]}))}),r=[];return flatArray(a,r),r.filter(e=>0<e.outputValue.length)}catch(e){return console.warn("ios:"+Editor.I18n.t("ios.tips.developerTeamListError")),console.warn(e),[]}}function verificationFunc(e,a,r){var t={error:"",newValue:a,level:"error"};switch(e){case"targetVersion":{let e="11.0";if(!/^([1-9]\d|[1-9])(\.([1-9]\d|\d)){1,2}$/.test(a))return t.error="i18n:ios.tips.version_style_error",t;"taskFlow"===r.packages.native.JobSystem&&(e="12.0",compareVersion(a,e)||(t.error="i18n:ios.tips.targetVersionErrorWithTaskFlow",t.newValue=e)),t.error||compareVersion(a,e)||(t.error="i18n:ios.tips.targetVersionError",t.newValue=e)}break;case"orientation":if(!a)return t.error="i18n:ios.tips.not_empty",t;if(Object.keys(a).every(e=>!a[e]))return t.error="i18n:ios.tips.at_least_one",t;break;case"osTarget":if(!a)return t.error="i18n:ios.tips.not_empty",t;if(Object.keys(a).every(e=>!a[e]))return t.error="i18n:ios.tips.at_least_one",t;break;case"packageName":if(a){if(checkPackageNameValidity(a))break;t.error="i18n:ios.tips.packageNameRuleMessage"}else t.error="i18n:ios.tips.not_empty";return t}return t}function compareVersion(e,a,r="."){var t;return"string"!=typeof e||"string"!=typeof a||(t=Math.max(e.length,a.length),e=e.replace(r,"").padStart(t,"0"),a=a.replace(r,"").padStart(t,"0"),Number(e)>Number(a))||Number(e)===Number(a)}exports.updateOrientation=updateOrientation,exports.changePackageName=changePackageName,exports.checkPackageNameValidity=checkPackageNameValidity,exports.modifyPackageName=modifyPackageName,exports.updateXcodeproject=updateXcodeproject,exports.renameXcodeResource=renameXcodeResource,exports.findSignIdentify=findSignIdentify,exports.verificationFunc=verificationFunc,exports.compareVersion=compareVersion;