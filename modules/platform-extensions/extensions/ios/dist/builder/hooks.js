"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;const fs_extra_1=require("fs-extra"),path_1=require("path"),cc_1=require("cc"),utils_1=require("./utils");async function onAfterInit(e,t,a){const o=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0},i=e.cocosParams;Object.keys(o).forEach(e=>{i.cMakeConfig["CC_USE_"+e.toUpperCase()]=o[e]});var s,r=e.packages.ios;i.platformParams.orientation=e.packages.ios.orientation,i.platformParams.bundleId=e.packages.ios.packageName,i.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${i.packageName})`,r.developerTeam&&(s=r.developerTeam.split("_")[0],i.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${s})`,i.platformParams.teamid=s),i.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${r.targetVersion||"12.0"})`,i.cMakeConfig.USE_PORTRAIT=!!r.orientation.portrait,i.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=r.skipUpdateXcodeProject,i.platformParams.skipUpdateXcodeProject=r.skipUpdateXcodeProject,i.executableName=(0,utils_1.executableNameOrDefault)(i.projectName,e.packages.ios.executableName),"CocosGame"===i.executableName&&console.warn(`The provided project name "${i.projectName}" is not suitable for use as an executable name. 'CocosGame' is applied instead.`),i.cMakeConfig.CC_EXECUTABLE_NAME=`set(CC_EXECUTABLE_NAME "${i.executableName}")`,r.osTarget&&(void 0!==r.osTarget.simulator&&(i.platformParams.simulator=r.osTarget.simulator),void 0!==r.osTarget.iphoneos)&&(i.platformParams.iphoneos=r.osTarget.iphoneos),t.staticsInfo.B100005=e.packages.ios.packageName,t.staticsInfo.B100011=e.packages.ios.orientation}async function onAfterBundleInit(e){var t=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0};e.assetSerializeOptions["cc.EffectAsset"].glsl1=t.gles2??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl3=t.gles3??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl4=t.metal??!0}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0)}async function onAfterBuild(e,t){await buildSplash(e,t)}async function buildSplash(e,t){var a=t.settings.splashScreen;if(a&&a.logo&&a.background){var o=(0,path_1.join)(Editor.Project.path,"native/engine/ios"),i=((0,fs_extra_1.ensureDirSync)(o),[{width:1242,height:2208,outputPath:(0,path_1.join)(o,"LaunchScreenBackgroundPortrait.png")},{width:2208,height:1242,outputPath:(0,path_1.join)(o,"LaunchScreenBackgroundLandscape.png")}]);try{for(const r of i)await generateSplashPicture(r,a,t.settings.screen.designResolution);var s=e.packages.ios.orientation.portrait?(0,path_1.join)(o,"LaunchScreenBackgroundPortrait.png"):(0,path_1.join)(o,"LaunchScreenBackgroundLandscape.png");(0,fs_extra_1.copyFileSync)(s,(0,path_1.join)(o,"LaunchScreenBackground.png")),console.debug("Generate splash to:",(0,path_1.join)(o,"LaunchScreenBackgroundPortrait.png"))}catch(e){console.warn("Failed to generate splash:",e)}}}async function generateSplashPicture(e,a,o){var i=document.createElement("canvas"),s=(i.width=e.width,i.height=e.height,i.getContext("2d"));if("custom"===a.background?.type&&a.background.base64){var o=o.policy,r=new Image;r.src=a.background.base64,await c(r),Math.max(i.width/r.width,i.height/r.height);let e,t;t=o===cc_1.ResolutionPolicy.FIXED_HEIGHT?(e=r.width*i.height/r.height,i.height):o===cc_1.ResolutionPolicy.FIXED_WIDTH?(e=i.width,r.height*i.width/r.width):o===cc_1.ResolutionPolicy.SHOW_ALL?r.width/r.height>i.width/i.height?(e=i.width,r.height*i.width/r.width):(e=r.width*i.height/r.height,i.height):o===cc_1.ResolutionPolicy.NO_BORDER?r.width/r.height>i.width/i.height?(e=r.width*i.height/r.height,i.height):(e=i.width,r.height*i.width/r.width):(e=i.width,i.height);var o=(i.width-e)/2,n=(i.height-t)/2;s.beginPath(),s.rect(o,n,e,t),s.closePath(),s.clip(),s.drawImage(r,o,n,e,t)}else"color"===a.background?.type&&a.background.color?(r=a.background.color,s.fillStyle=`rgba(${255*r.x}, ${255*r.y}, ${255*r.z}, ${255*r.w})`):s.fillStyle="rgba(4, 9, 10, 1)",s.fillRect(0,0,i.width,i.height);if(("custom"===a.logo?.type||"default"===a.logo?.type)&&a.logo.base64){var o=new Image,n=(o.src=a.logo.base64,await c(o),o.height/o.width),r=.185*i.height*a.displayRatio,n=r/n,t=(i.width-n)/2;let e=(i.height*(5/6)-r)/2;r>i.height*(5/6)&&(e=(i.height-r)/2),s.drawImage(o,t,e,n,r),"default"===a.logo.type&&(s.font="400 36px Arial",s.textBaseline="top",s.textAlign="center",s.fillStyle="rgba(250, 250, 250, 0.4)",s.lineWidth=2,s.strokeStyle="rgba(5, 5, 5, 0.3)",s.strokeText("Created with Cocos",i.width/2,e+r+48),s.fillText("Created with Cocos",i.width/2,e+r+48))}o=i.toDataURL("image/png"),t=atob(o.split(",")[1]);function c(a){return new Promise((e,t)=>{a.complete?e(a):(a.addEventListener("load",()=>{e(a)}),a.addEventListener("error",e=>{t(e)}))})}(0,fs_extra_1.writeFileSync)(e.outputPath,t,"binary"),console.log("Generate splash to:",e.outputPath)}exports.throwError=!0;