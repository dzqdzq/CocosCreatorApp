"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),lodash_1=require("lodash"),path_1=require("path");async function onAfterInit(e,t,a){const o=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0},s=t.compileOptions;Object.keys(o).forEach(e=>{s.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=o[e]});const i=e.packages.ios;if(s.platformParams.orientation=e.packages.ios.orientation,s.platformParams.bundleId=e.packages.ios.packageName,s.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${s.packageName})`,i.developerTeam){const e=i.developerTeam.split("_")[0];s.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${e})`,s.platformParams.teamid=e}s.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${i.targetVersion||"12.0"})`,s.cMakeConfig.USE_PORTRAIT=!!i.orientation.portrait,s.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=i.skipUpdateXcodeProject,s.platformParams.skipUpdateXcodeProject=i.skipUpdateXcodeProject,s.executableName=executableNameOrDefault(s.projectName,e.packages.ios.executableName),s.cMakeConfig.CC_EXECUTABLE_NAME=`set(CC_EXECUTABLE_NAME "${s.executableName}")`,i.osTarget&&(void 0!==i.osTarget.simulator&&(s.platformParams.simulator=i.osTarget.simulator),void 0!==i.osTarget.iphoneos&&(s.platformParams.iphoneos=i.osTarget.iphoneos)),await fs_extra_1.outputJSON(t.paths.compileConfig,s),t.staticsInfo.B100005=e.packages.ios.packageName,t.staticsInfo.B100011=e.packages.ios.orientation}async function onAfterBundleInit(e){var t,a,o;const s=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0};e.assetSerializeOptions["cc.EffectAsset"].glsl1=null===(t=s.gles2)||void 0===t||t,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(a=s.gles3)||void 0===a||a,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null===(o=s.metal)||void 0===o||o,e.buildScriptParam.platform="IOS"}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0)}async function onAfterBuild(e,t){const a=t.settings.splashScreen;if(a&&!await compareSplash(a)){const t=path_1.join(Editor.Project.path,"native/engine/ios"),o=[{width:1242,height:2208,displayRatio:(null===a||void 0===a?void 0:a.displayRatio)||1,outputPath:path_1.join(t,"LaunchScreenBackgroundPortrait.png")},{width:2208,height:1242,displayRatio:(null===a||void 0===a?void 0:a.displayRatio)||1,outputPath:path_1.join(t,"LaunchScreenBackgroundLandscape.png")}];if((null===a||void 0===a?void 0:a.base64src)&&(null===a||void 0===a?void 0:a.bgBase64))try{for(const e of o)await generateSplash(a.bgBase64,a.base64src,e);const s=e.packages.ios.orientation.portrait?path_1.join(t,"LaunchScreenBackgroundPortrait.png"):path_1.join(t,"LaunchScreenBackgroundLandscape.png");fs_extra_1.copyFileSync(s,path_1.join(t,"LaunchScreenBackground.png")),console.debug("Generate splash to:",path_1.join(t,"LaunchScreenBackgroundPortrait.png")),Editor.Profile.setProject("ios","splash-setting",a,"project")}catch(e){console.debug("Failed to generate splash:",e)}}}async function compareSplash(e){try{const t=await Editor.Profile.getProject("ios","splash-setting","project");if(t)return t.totalTime=e.totalTime=0,lodash_1.isEqual(t,e)}catch(e){console.debug("Failed to generate splash:",e)}return!1}function generateSplash(e,t,a){const o=new Image,s=new Image;return o.src=e,s.src=t,Promise.all([i(o),i(s)]).then(e=>{const t=document.createElement("canvas");t.width=a.width,t.height=a.height;const o=t.getContext("2d"),s=t.width>t.height;o.fillStyle="#04090A",o.fillRect(0,0,t.width,t.height),o.globalAlpha=.6,o.fillStyle="rgba(0, 0, 0, 0.6)",o.fillRect(0,0,t.width,t.height),o.globalAlpha=1;const i=e[1].height/e[1].width,n=s?.185*t.width*5/6*a.displayRatio:.185*t.height*5/6*a.displayRatio,r=n/i,l=(t.width-r)/2;let c=(5*t.height/6-n)/2;n>5*t.height/6&&(c=(t.height-n)/2),o.drawImage(e[1],l,c,r,n),o.font="400 36px Arial",o.textBaseline="top",o.textAlign="center",o.fillStyle="rgba(250, 250, 250, 0.4)",o.lineWidth=2,o.strokeStyle="rgba(5, 5, 5, 0.3)",o.strokeText("Created with Cocos",t.width/2,c+n+48),o.fillText("Created with Cocos",t.width/2,c+n+48);const p=t.toDataURL("image/png"),d=atob(p.split(",")[1]);fs_extra_1.writeFileSync(a.outputPath,d,"binary"),console.log("Generate splash to:",a.outputPath)});function i(e){return new Promise((t,a)=>{e.complete?t(e):(e.addEventListener("load",()=>{t(e)}),e.addEventListener("error",e=>{a(e)}))})}}function executableNameOrDefault(e,t){return t||(/^[0-9a-zA-Z_-]+$/.test(e)?`${e}-mobile`:(console.warn(`The provided project name "${e}" is not suitable for use as an executable name. 'CocosGame' is applied instead.`),"CocosGame"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;