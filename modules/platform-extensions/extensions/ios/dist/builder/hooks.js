"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,o){const a=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0},n=t.compileOptions;Object.keys(a).forEach(e=>{n.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=a[e]});const s=e.packages.ios;if(n.platformParams.orientation=e.packages.ios.orientation,n.platformParams.bundleId=e.packages.ios.packageName,n.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${n.packageName})`,s.developerTeam){const e=s.developerTeam.split("_")[0];n.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${e})`,n.platformParams.teamid=e}n.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${s.targetVersion||"12.0"})`,n.cMakeConfig.USE_PORTRAIT=!!s.orientation.portrait,n.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=s.skipUpdateXcodeProject,n.platformParams.skipUpdateXcodeProject=s.skipUpdateXcodeProject,n.executableName=executableNameOrDefault(n.projectName,e.packages.ios.executableName),n.cMakeConfig.CC_EXECUTABLE_NAME=`set(CC_EXECUTABLE_NAME "${n.executableName}")`,s.osTarget&&(void 0!==s.osTarget.simulator&&(n.platformParams.simulator=s.osTarget.simulator),void 0!==s.osTarget.iphoneos&&(n.platformParams.iphoneos=s.osTarget.iphoneos)),await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,n),t.staticsInfo.B100005=e.packages.ios.packageName,t.staticsInfo.B100011=e.packages.ios.orientation}async function onAfterBundleInit(e){var t,o,a;const n=e.packages.ios.renderBackEnd={gles2:!1,gles3:!1,metal:!0};e.assetSerializeOptions["cc.EffectAsset"].glsl1=null===(t=n.gles2)||void 0===t||t,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(o=n.gles3)||void 0===o||o,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null===(a=n.metal)||void 0===a||a,e.buildScriptParam.platform="IOS"}async function onAfterBuildAssets(e,t,o){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,o){t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0)}async function onAfterBuild(e,t){await buildSplash(e,t)}async function buildSplash(e,t){const o=t.settings.splashScreen;if(o&&o.logo&&o.background){const t=(0,path_1.join)(Editor.Project.path,"native/engine/ios");(0,fs_extra_1.ensureDirSync)(t);const a=[{width:1242,height:2208,outputPath:(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png")},{width:2208,height:1242,outputPath:(0,path_1.join)(t,"LaunchScreenBackgroundLandscape.png")}];try{for(const e of a)await generateSplashPicture(e,o);const n=e.packages.ios.orientation.portrait?(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png"):(0,path_1.join)(t,"LaunchScreenBackgroundLandscape.png");(0,fs_extra_1.copyFileSync)(n,(0,path_1.join)(t,"LaunchScreenBackground.png")),console.debug("Generate splash to:",(0,path_1.join)(t,"LaunchScreenBackgroundPortrait.png"))}catch(e){console.warn("Failed to generate splash:",e)}}}async function generateSplashPicture(e,t){var o,a,n,s;const i=document.createElement("canvas");i.width=e.width,i.height=e.height;const r=i.getContext("2d");if("custom"===(null===(o=t.background)||void 0===o?void 0:o.type)&&t.background.base64){const e=new Image;e.src=t.background.base64,await p(e);const o=Math.max(i.width/e.width,i.height/e.height),a=(i.width-e.width*o)/2,n=(i.height-e.height*o)/2;r.beginPath(),r.rect(a,n,e.width*o,e.height*o),r.closePath(),r.clip(),r.drawImage(e,a,n,e.width*o,e.height*o)}else if("color"===(null===(a=t.background)||void 0===a?void 0:a.type)&&t.background.color){const e=t.background.color;r.fillStyle=`rgba(${255*e.x}, ${255*e.y}, ${255*e.z}, ${255*e.w})`,r.fillRect(0,0,i.width,i.height)}else r.fillStyle="rgba(4, 9, 10, 1)",r.fillRect(0,0,i.width,i.height);if(("custom"===(null===(n=t.logo)||void 0===n?void 0:n.type)||"default"===(null===(s=t.logo)||void 0===s?void 0:s.type))&&t.logo.base64){const e=new Image;e.src=t.logo.base64,await p(e);const o=e.height/e.width,a=.185,n=5/6,s=i.height*a*t.displayRatio,c=s/o,l=(i.width-c)/2;let g=(i.height*n-s)/2;s>i.height*n&&(g=(i.height-s)/2),r.drawImage(e,l,g,c,s),"default"===t.logo.type&&(r.font="400 36px Arial",r.textBaseline="top",r.textAlign="center",r.fillStyle="rgba(250, 250, 250, 0.4)",r.lineWidth=2,r.strokeStyle="rgba(5, 5, 5, 0.3)",r.strokeText("Created with Cocos",i.width/2,g+s+48),r.fillText("Created with Cocos",i.width/2,g+s+48))}const c=i.toDataURL("image/png"),l=atob(c.split(",")[1]);function p(e){return new Promise((t,o)=>{e.complete?t(e):(e.addEventListener("load",()=>{t(e)}),e.addEventListener("error",e=>{o(e)}))})}(0,fs_extra_1.writeFileSync)(e.outputPath,l,"binary"),console.log("Generate splash to:",e.outputPath)}function executableNameOrDefault(e,t){return t||(/^[0-9a-zA-Z_-]+$/.test(e)?`${e}-mobile`:(console.warn(`The provided project name "${e}" is not suitable for use as an executable name. 'CocosGame' is applied instead.`),"CocosGame"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;