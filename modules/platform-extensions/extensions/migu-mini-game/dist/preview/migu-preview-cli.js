"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const path_1=require("path"),fs_1=require("fs"),share_1=require("../share"),express=require("express"),app=express();class PreviewManager{constructor(){this.isOpen=!1}async run(e,o){var r,a,t;this.isOpen?console.warn("migu multiple preview services are enabled, turn off others!"):(0,fs_1.existsSync)(e)?(r=(0,path_1.dirname)(e),app.use(express.static(r)),a=await Editor.Message.request("preview","get-preview-ip"),t=await Editor.Network.getFreePort(7456),app.listen(t,a,async()=>{console.log(`migu server listening at http://${a}:`+t);var e=await Editor.Profile.getConfig(share_1.PLATFORM_NAME,"builder"),r=`http://${a}:`+t+`/${null==e?void 0:e.common.name}.rpk`,s="youplay://cocosgame?",i=(s=(s+="gameId="+(null==e?void 0:e.options[share_1.PLATFORM_NAME].package))+("&gameName="+(null==e?void 0:e.common.name)),"portrait"===(null==e?void 0:e.options[share_1.PLATFORM_NAME].deviceOrientation)?1:0),i=(s=(s+="&portrait="+i)+("&versionCode="+(null==e?void 0:e.options[share_1.PLATFORM_NAME].versionCode)),null!=e&&e.options[share_1.PLATFORM_NAME].isSubpackage?1:0),s=s+("&hasSubpackage="+i)+("&mainUrl="+r);this.isOpen=!0,o(null,s)}).on("error",e=>{console.error("migu server failed to start:",e),this.isOpen=!1,o(e)})):console.error(`migu rpk (${e}) does not exist, please build before preview!`)}kill(){this.isOpen=!1}}exports.previewManager=new PreviewManager;