"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs"));function onAfterInit(e,t,s){e.packages["web-desktop"];e.buildEngineParam.assetURLFormat="runtime-resolved",e.server&&!e.server.endsWith("/")&&(e.server+="/")}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"};var t=e.packages["web-desktop"].useWebGPU;e.buildScriptParam.flags.WEBGPU=t,e.buildScriptParam.platform="HTML5",t?(e.includeModules.includes("gfx-webgpu")||e.includeModules.push("gfx-webgpu"),e.assetSerializeOptions["cc.EffectAsset"].glsl4=!0):e.includeModules.includes("gfx-webgpu")&&(t=e.includeModules.indexOf("gfx-webgpu"),e.includeModules.splice(t,1))}async function onBeforeCompressSettings(e,t,s){if(t.paths.dir){const i=t.settings;i.screen.exactFitScreen=!1,i.plugins.jsList.forEach((e,t)=>{i.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")})}}async function onBeforeCopyBuildTemplate(e,t){var s=(0,path_1.join)(e.engineInfo.typescript.builtin,"templates/web-desktop"),i=e.packages["web-desktop"],n=(0,path_1.join)(t.paths.dir,"style.css"),n=(e.md5CacheOptions.includes.push(n),this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(s,"style.css"),n),this.buildTemplate.findFile("favicon.ico")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(s,"favicon.ico"),(0,path_1.join)(t.paths.dir,"favicon.ico")),this.buildTemplate.initUrl("index.js.ejs","indexJs")||(0,path_1.join)(s,"index.js.ejs")),n=await ejs_1.default.renderFile(n,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),n=await Build.Utils.transformCode(n,{importMapFormat:"systemjs"});if(!n)throw new Error("Cannot generate index.js");var r=(0,path_1.join)(t.paths.dir,"index.js"),r=(t.paths.indexJs=r,e.md5CacheOptions.includes.push(t.paths.indexJs),(0,fs_extra_1.outputFileSync)(r,n,"utf8"),this.buildTemplate.initUrl("index.ejs")||(0,path_1.join)(s,"index.ejs")),n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,previewWidth:i.resolution.designWidth,previewHeight:i.resolution.designHeight,cocosTemplate:(0,path_1.join)(s,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:"./index.js",cssUrl:"./style.css"},i=await ejs_1.default.renderFile(r,n);t.paths.indexHTML=(0,path_1.join)(t.paths.dir,"index.html"),(0,fs_extra_1.outputFileSync)(t.paths.indexHTML,i,"utf8"),e.md5CacheOptions.replaceOnly.push(t.paths.indexHTML),Editor.Message.request("web-desktop","set-preview-path",t.paths.dir)}function run(e,t){Editor.Message.request("web-desktop","preview",e,t.packages["web-desktop"].useWebGPU)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.run=run;