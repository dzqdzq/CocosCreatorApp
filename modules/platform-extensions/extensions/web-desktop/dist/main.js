"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.load=exports.methods=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),server_1=require("./server"),lodash=require("lodash");async function load(){const e=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.values(e).forEach(e=>{if(1!==e.progress)return;const t=lodash.get(e,"options.platform"),s=lodash.get(e,"options.buildPath");if("web-desktop"!==t||"string"!=typeof s)return;const o=path_1.join(Editor.UI.__protected__.File.resolveToRaw(s),e.options.outputName);server_1.setRootPath(o)})}exports.methods={async"create-build-template"(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"templates/web-desktop","build-template.json");if(!fs_extra_1.existsSync(t))return void console.error("build-template.json not exist!");const s={};Object.assign(s,fs_extra_1.readJSONSync(t));const o=s.templates||[];let r=!1;for(const t of o){const s=path_1.join(e,"templates/web-desktop",t),o=path_1.join(Editor.Project.path,"build-templates/web-desktop",t);if(fs_extra_1.existsSync(o)){if(1===(await Editor.Dialog.warn(Editor.I18n.t("web-desktop.tips.overwriteTemplate",{file:t}),{title:Editor.I18n.t("builder.create_user_template"),buttons:[Editor.I18n.t("web-desktop.tips.overwrite"),Editor.I18n.t("web-desktop.tips.cancel")],default:0,cancel:1})).response)continue}fs_extra_1.copySync(s,o),r=!0}if(r){const e=path_1.join(Editor.Project.path,"build-templates","templates-version.json");let t={"web-desktop":s.version};if(fs_extra_1.existsSync(e)){const o=fs_extra_1.readJSONSync(e);o["web-desktop"]!==s.version&&(t=Object.assign({},o,t),fs_extra_1.outputJSONSync(e,t,{spaces:4}))}else fs_extra_1.outputJSONSync(e,t,{spaces:4});console.log(`web-desktop ${Editor.I18n.t("web-desktop.tips.createTemplateSuccess")}({link(${path_1.join(Editor.Project.path,"build-templates/web-desktop")})})`)}},async preview(e){server_1.setRootPath(e);const t=await Editor.Message.request("server","query-port"),s=`http://${await Editor.Message.request("preview","get-preview-ip")}:${t}/web-desktop/${path_1.basename(e)}/index.html`;return Editor.Message.send("program","open-url",s),!0},"set-preview-path":e=>!!fs_extra_1.existsSync(e)&&(server_1.setRootPath(e),!0)},exports.load=load;