"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPreviewUrl=exports.load=exports.methods=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),server_1=require("./server"),lodash=require("lodash");async function load(){setPreviewPathFromTask().catch(e=>{console.error(e)})}async function setPreviewPathFromTask(){const e=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.values(e).forEach(e=>{if(1!==e.progress)return;const t=lodash.get(e,"options.platform"),s=lodash.get(e,"options.buildPath");if("web-desktop"!==t||"string"!=typeof s)return;const o=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(s),e.options.outputName);(0,server_1.setRootPath)(o)})}async function getPreviewUrl(e,t=!1){const s=await Editor.Message.request("preview","query-preview-url"),o=new URL(s);if(t&&"http:"===o.protocol){return`http://localhost:${await Editor.Message.request("server","query-port")}/web-desktop/${e}/index.html`}return`${s}/web-desktop/${e}/index.html`}exports.methods={async"create-build-template"(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=(0,path_1.join)(e,"templates/web-desktop","build-template.json");if(!(0,fs_extra_1.existsSync)(t))return void console.error("build-template.json not exist!");const s=(0,path_1.join)(Editor.Project.path,"build-templates"),o={};Object.assign(o,(0,fs_extra_1.readJSONSync)(t));const r=o.templates||[];let a=!1;for(const t of r){const o=(0,path_1.join)(e,"templates/web-desktop",t),r=(0,path_1.join)(s,"web-desktop",t);if((0,fs_extra_1.existsSync)(r)){if(1===(await Editor.Dialog.warn(Editor.I18n.t("web-desktop.tips.overwriteTemplate",{file:t}),{title:Editor.I18n.t("builder.create_user_template"),buttons:[Editor.I18n.t("web-desktop.tips.overwrite"),Editor.I18n.t("web-desktop.tips.cancel")],default:0,cancel:1})).response)continue}(0,fs_extra_1.copySync)(o,r),a=!0}if(a){const e=(0,path_1.join)(s,"templates-version.json");let t={"web-desktop":o.version};if((0,fs_extra_1.existsSync)(e)){const s=(0,fs_extra_1.readJSONSync)(e);s["web-desktop"]!==o.version&&(t=Object.assign({},s,t),(0,fs_extra_1.outputJSONSync)(e,t,{spaces:4}))}else(0,fs_extra_1.outputJSONSync)(e,t,{spaces:4});console.log(`web-desktop ${Editor.I18n.t("web-desktop.tips.createTemplateSuccess")}({link(${(0,path_1.join)(s,"web-desktop")})})`)}},preview:async(e,t=!1)=>((0,server_1.setRootPath)(e),Editor.Message.send("program","open-url",await getPreviewUrl((0,path_1.basename)(e),t)),!0),"set-preview-path":e=>!!(0,fs_extra_1.existsSync)(e)&&((0,server_1.setRootPath)(e),!0)},exports.load=load,exports.getPreviewUrl=getPreviewUrl;