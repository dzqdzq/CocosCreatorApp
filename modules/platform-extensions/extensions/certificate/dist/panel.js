"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const{readFileSync:readFileSync}=require("fs"),{join:join}=require("path"),Vue=require("vue/dist/vue.js");let vm,panel=null;Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=readFileSync(join(__dirname,"../static/index.html"),"utf8"),exports.style=readFileSync(join(__dirname,"../dist/index.css"),"utf8"),exports.$={certificate:"#certificate"},exports.methods={};const ready=async function(e){vm=new Vue({el:(panel=this).$.certificate,data:{platform:e,settings:{country:"CN",state:"福建省",locality:"厦门市",organization:"",organizationalUnit:"",commonName:"",email:"",certificatePath:""},saveBtnState:!1,saveBtnDisabled:!1,generateSuccess:!1,verifyResult:{country:void 0,state:void 0,locality:void 0,organization:void 0,organizationalUnit:void 0,commonName:void 0,email:void 0,certificatePath:void 0},verifyFuncMap:{certificatePath(e){let t="";return Editor.Utils.Path.contains(join(Editor.Project.path,"./build"),e)&&(t="i18n:certificate.certificatePath_error"),t},country(e){let t="";return/^[A-Z]{2}$/.test(e)||(t="i18n:certificate.country_error"),t},email(e){let t="";return/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/.test(e)||(t="i18n:certificate.email_error"),t}}},async mounted(){this.netStatus="success",await this.initData()},methods:{onChange(e){var t;const i=e.target,s=i.getAttribute("name");if(!s)return;const r=i.value,o=this;o.saveBtnState=!1;let a=o.judgeEmptyAndSpace(s,r);a||(a=null===(t=o.verifyFuncMap[s])||void 0===t?void 0:t.call(o,r)),o.verifyResult[s]=a,o.saveBtnDisabled=o.calcBtnState()},onConfirm(e){const t=e.target,i=t.getAttribute("name");if(!i)return;const s=t.value;this.settings[i]=s;const r=this.platform?this.platform:"settings";Editor.Profile.setConfig("certificate",`${r}.${i}`,s,"global")},judgeEmptyAndSpace(e,t){let i="";return!t||"string"==typeof t&&!t.trim().length?i="i18n:certificate.empty_error":t&&/^[^\s]*$/.test(t)||(i="i18n:certificate.space_error"),i},onGenerate(){const e=this;process.env.PATH=process.env.PATH||"",-1===process.env.PATH.indexOf("/usr/bin/openssl")&&(process.env.PATH+=":/usr/bin/openssl");const t=e.settings.certificatePath,{country:i,state:s,locality:r,organization:o,organizationalUnit:a,commonName:n,email:c}=e.settings,l=`/C=${i}/ST=${s}/L=${r}/O=${o}/OU=${a}/CN=${n}/emailAddress=${c}`,d=join(Editor.App.path,"../tools/openSSLWin64/bin"),f=join(d,"openssl"),u=`${"win32"===process.platform?f:"openssl"} req -newkey rsa:2048 -nodes -keyout private.pem -x509 -days 3650 -out certificate.pem -subj ${l}`,p=join(d,"openssl.cfg"),v="win32"===process.platform?{OPENSSL_CONF:p}:process.env;(0,require("child_process").exec)(`${u}`,{env:v,cwd:t},async i=>{if(i)return e.generateSuccess=!1,console.error(Editor.I18n.t("certificate.build_certificate_fail")+i),void Editor.Task.addNotice({title:Editor.I18n.t("certificate.title"),message:Editor.I18n.t("certificate.build_certificate_fail")+i,type:"error"});console.log(Editor.I18n.t("certificate.build_certificate_complete")),Editor.Task.addNotice({title:Editor.I18n.t("certificate.title"),message:Editor.I18n.t("certificate.build_certificate_complete"),type:"success"}),e.generateSuccess=!0,Editor.Message.broadcast("certificate:generate-certificate-success",t),Editor.Panel.close("certificate")})},calcBtnState(){const e=this;if(e.saveBtnState)return!0;for(const t of Object.keys(e.verifyResult))if(e.verifyResult[t])return!0;return!1},async initData(){var e;const t=this,i=t.platform?t.platform:"settings",s=await Editor.Profile.getConfig("certificate",i,"global");Object.assign(t.settings,s),t.platform&&"android"===t.platform&&(t.verifyResult=Object.assign({},{validity:void 0,password:void 0,confirmPassword:void 0,alias:void 0,aliasPassword:void 0,confirmAliasPassword:void 0},t.verifyResult),t.settings=Object.assign({},{validity:1,password:"",confirmPassword:"",alias:"",aliasPassword:"",confirmAliasPassword:""},t.settings));for(const i of Object.keys(t.settings)){let s=t.judgeEmptyAndSpace(i,t.settings[i]);s||(s=null===(e=t.verifyFuncMap[i])||void 0===e?void 0:e.call(t,t.settings[i])),t.verifyResult[i]=s,s&&(t.saveBtnState=!0,t.saveBtnDisabled=!0)}}}})};exports.ready=ready;const beforeClose=async function(){};exports.beforeClose=beforeClose;const close=async function(){vm&&vm.$destroy()};exports.close=close;