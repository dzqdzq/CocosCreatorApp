"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TemplateCreator=exports.CCPluginNEW=void 0;const cocosCli_1=require("./cocosCli"),path=__importStar(require("path")),fs=__importStar(require("fs-extra")),cocosConfig_1=require("./cocosConfig"),afs_1=require("./afs"),default_1=require("./default"),URL=__importStar(require("url")),native_utils_1=require("../builder/native-utils"),fs_extra_1=require("fs-extra"),android_platform_1=require("../android-platform"),PackageNewConfig="cocos-project-template.json",projectCONFIG={projectType:"js",hasNative:!0,customStepScript:null},COCOS2D_FILES_PATH="templates/cocos2dx_files.json";class CCPluginNEW extends cocosCli_1.CCPlugin{depends(){return null}init(){return this.setEnv("PROJECT_NAME",this.projectName),this.setEnv("COMMON_DIR",cocosCli_1.cchelper.join(this.sharedDir,this.commonDir)),this.setEnv("NATIVE_DIR",cocosCli_1.cchelper.join(this.sharedDir,this.platformTemplateDirName)),this.projectDir&&!fs.existsSync(this.projectDir)&&cocosCli_1.cchelper.makeDirectoryRecursive(this.projectDir),!0}get commonDir(){return"common"}async run(){const e=new TemplateCreator(this);return await e.run(),!0}getEnginePath(){return this.args.enginePath}doListTemplates(){console.log("templates:");const e=this.getTemplatesDirNames();for(const t of e)console.log(` - ${t}/`)}get projectName(){return this.args.projectName}get projectDir(){return this.args.directory}get sharedDir(){return path.join(Editor.Project.path,"native","engine")}get enginePath(){return this.args.enginePath}}exports.CCPluginNEW=CCPluginNEW;class TemplateCreator{constructor(e){this.excludes=[],this.plugin=e;const t=e.args,a=e.getTemplatesRootPath();this.lang=t.language,this.cocosRoot=e.getCocosRoot(),this.projectName=t.projectName,this.projectDir=e.projectDir,this.tpName=t.templateName,this.enginePath=t.enginePath,this.tpDir=a,native_utils_1.mergeAndroidPlatformConfig(this),cocosConfig_1.cocosConfig.supportTemplates.indexOf(this.tpName)<0&&console.error(`template name "${this.tpName}" is not supported!`),fs.existsSync(cocosCli_1.cchelper.join(this.tpDir,PackageNewConfig))?this.templateInfo=JSON.parse(fs.readFileSync(cocosCli_1.cchelper.join(this.tpDir,PackageNewConfig)).toString("utf8")):console.error(`can not find ${PackageNewConfig} in ${this.tpDir}`)}get packageName(){const e=this.plugin.getPlatform();return e===default_1.PLATFORM_ENUM.ANDROID?this.plugin.args.android.packageName:e===default_1.PLATFORM_ENUM["XR-HUAWEIVR"]?this.plugin.args["xr-huaweivr"].packageName:e===default_1.PLATFORM_ENUM["XR-META"]?this.plugin.args["xr-meta"].packageName:e===default_1.PLATFORM_ENUM["XR-PICO"]?this.plugin.args["xr-pico"].packageName:e===default_1.PLATFORM_ENUM["XR-ROKID"]?this.plugin.args["xr-rokid"].packageName:e===default_1.PLATFORM_ENUM["XR-MONADO"]?this.plugin.args["xr-monado"].packageName:e==default_1.PLATFORM_ENUM.OHOS?this.plugin.args.ohos.packageName:e===default_1.PLATFORM_ENUM.IOS?this.plugin.args.ios.bundleId:void 0}async doPostSteps(){await this.setOrientation();const e=this.plugin.getPlatform();e!==default_1.PLATFORM_ENUM.ANDROID&&e!==default_1.PLATFORM_ENUM["HUAWEI-AGC"]&&e!==default_1.PLATFORM_ENUM["XR-HUAWEIVR"]&&e!==default_1.PLATFORM_ENUM["XR-META"]&&e!==default_1.PLATFORM_ENUM["XR-PICO"]&&e!==default_1.PLATFORM_ENUM["XR-ROKID"]&&e!==default_1.PLATFORM_ENUM["XR-MONADO"]||(await this.updateAndroidGradleValues(),await this.configAndroidInstant())}async configAndroidInstant(){if(!this.plugin.args.android.androidInstant)return void console.log("android instant not configured");const e=this.plugin.args.android.remoteUrl;if(!e)return;const t=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"instantapp/AndroidManifest.xml");if(!fs.existsSync(t))return void console.error(`${t} not found`);const a=URL.parse(e);if(!a.host)return void console.error(`parse url ${e} fail`);let i=fs.readFileSync(t,"utf8");i=i.replace(/<category\s*android:name="android.intent.category.DEFAULT"\s*\/>/,e=>{let t='<category android:name="android.intent.category.DEFAULT" />';return t+=`\n                <data android:host="${a.host}" android:pathPattern="${a.path}" android:scheme="https"/>`+'\n                <data android:scheme="http"/>'}),fs.writeFileSync(t,i,"utf8")}async run(){let e=this.plugin.args.platform;if("linux"===e)return fs.copySync(path.join(this.tpDir,e,"CMakeLists.txt"),path.join(this.plugin.projectDir,"proj","CMakeLists.txt")),void this.generateCMakeConfig();const t=path.join(this.plugin.nativeTemplateDir,this.plugin.commonDir);fs.copySync(path.join(this.tpDir,"common"),t,{overwrite:!1}),e===default_1.PLATFORM_ENUM["HUAWEI-AGC"]&&(e=default_1.PLATFORM_ENUM.ANDROID);let a=this.plugin.sourceTemplatePath;if(e===default_1.PLATFORM_ENUM.ANDROID||e===default_1.PLATFORM_ENUM["XR-HUAWEIVR"]||e===default_1.PLATFORM_ENUM["XR-META"]||e===default_1.PLATFORM_ENUM["XR-PICO"]||e===default_1.PLATFORM_ENUM["XR-ROKID"]||e===default_1.PLATFORM_ENUM["XR-MONADO"]){a=path.join(this.tpDir,e,"template");const t=path.join(this.projectDir,"proj");fs.copySync(path.join(this.tpDir,e,"build"),t,{overwrite:!1})}e&&!fs.existsSync(this.plugin.platformTemplatePath)&&fs.copySync(a,this.plugin.platformTemplatePath,{overwrite:!1});for(const e in this.templateInfo)await this.execute(this.templateInfo[e]);await this.doPostSteps(),this.generateCMakeConfig()}generateCMakeConfig(){const e=path.join(this.plugin.projectDir,"proj","cfg.cmake");let t="";const a=this.plugin.args.cMakeConfig;Object.keys(a).forEach(e=>{"boolean"==typeof a[e]&&(a[e]=`set(${e} ${a[e]?"ON":"OFF"})`)}),Object.keys(a).forEach(e=>{t+=a[e]+"\n"}),console.debug(`generateCMakeConfig, ${JSON.stringify(a)}`),fs.outputFileSync(e,t)}async setOrientation(){const e=this.plugin.args;if((e.platform===default_1.PLATFORM_ENUM.IOS||e.platform===default_1.PLATFORM_ENUM.IOSSIMULATOR)&&e.ios){const t=e.ios.orientation,a=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"Info.plist");if(fs.existsSync(a)){const e=[];t.landscapeRight&&e.push("UIInterfaceOrientationLandscapeRight"),t.landscapeLeft&&e.push("UIInterfaceOrientationLandscapeLeft"),t.portrait&&e.push("UIInterfaceOrientationPortrait"),t.upsideDown&&e.push("UIInterfaceOrientationPortraitUpsideDown");const i=`\t<key>UISupportedInterfaceOrientations</key>\n\t<array>\n${e.map(e=>`\t\t<string>${e}</string>\n`).join("")}\n\t</array>`,r=[],o=fs.readFileSync(a).toString("utf-8").split("\n");let n=0,s=0;for(let e=0;e<o.length;e++)if(o[e].indexOf("UISupportedInterfaceOrientations")>=0){for(n+=1,e++;e<o.length&&o[e].indexOf("</array>")<0;)e++;o[e].indexOf("</array>")>=0&&(s+=1),r.push(i)}else r.push(o[e]);1!==n||1!==s?console.error("error occurs while setting orientations for iOS"):await afs_1.afs.writeFile(a,r.join("\n"))}}android_platform_1.androidsPlatform.forEach(async t=>{if(e.platform===t&&e[t]){const a=e[t].orientation,i=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"app/AndroidManifest.xml"),r=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"instantapp/AndroidManifest.xml");if(fs.existsSync(i)&&fs.existsSync(r)){const e=/android:screenOrientation="[^"]*"/;let t='android:screenOrientation="unspecified"';if(a.landscapeRight&&a.landscapeLeft&&a.portrait&&a.upsideDown)t='android:screenOrientation="fullSensor"';else if(a.landscapeRight&&!a.landscapeLeft)t='android:screenOrientation="landscape"';else if(!a.landscapeRight&&a.landscapeLeft)t='android:screenOrientation="reverseLandscape"';else if(a.landscapeRight&&a.landscapeLeft)t='android:screenOrientation="sensorLandscape"';else if(a.portrait&&!a.upsideDown)t='android:screenOrientation="portrait"';else if(!a.portrait&&a.upsideDown){t=`android:screenOrientation="${"reversePortrait"}"`}else if(a.portrait&&a.upsideDown){t=`android:screenOrientation="${"sensorPortrait"}"`}let o=await afs_1.afs.readFile(i,"utf8");o=o.replace(e,t);let n=await afs_1.afs.readFile(r,"utf8");n=n.replace(e,t),await afs_1.afs.writeFile(i,o),await afs_1.afs.writeFile(r,n)}}})}parseVersion(e,t,a){const i=new RegExp(`${t}=(.*)`),r=e.match(i);if(!r)return a;const o=Number.parseInt(r[1],10);return Number.isNaN(o)?a:o}async updateAndroidGradleValues(){const e=this.plugin.args;if(!e)return;console.log("update settings.properties"),await cocosCli_1.cchelper.replaceInFile([{reg:"^rootProject\\.name.*",text:`rootProject.name = "${e.projectName}"`}],path.join(this.projectDir,"proj/settings.gradle")),console.log("update gradle.properties");const t=cocosCli_1.cchelper.join(this.projectDir,"proj/gradle.properties");if(fs.existsSync(t)){let a=e.android.keyStorePath;this.plugin.getCurrentPlatform()===default_1.PLATFORM_ENUM.WINDOWS&&(a=cocosCli_1.cchelper.fixPath(a));let i=e.android.apiLevel;i||(i=27),console.log(`AndroidAPI level ${i}`);let r=fs.readFileSync(t,"utf-8");r=a?(r=(r=(r=r.replace(/.*RELEASE_STORE_FILE=.*/,`RELEASE_STORE_FILE=${a}`)).replace(/.*RELEASE_STORE_PASSWORD=.*/,`RELEASE_STORE_PASSWORD=${e.android.keystorePassword}`)).replace(/.*RELEASE_KEY_ALIAS=.*/,`RELEASE_KEY_ALIAS=${e.android.keystoreAlias}`)).replace(/.*RELEASE_KEY_PASSWORD=.*/,`RELEASE_KEY_PASSWORD=${e.android.keystoreAliasPassword}`):(r=(r=(r=r.replace(/.*RELEASE_STORE_FILE=.*/,`# RELEASE_STORE_FILE=${a}`)).replace(/.*RELEASE_STORE_PASSWORD=.*/,`# RELEASE_STORE_PASSWORD=${e.android.keystorePassword}`)).replace(/.*RELEASE_KEY_ALIAS=.*/,`# RELEASE_KEY_ALIAS=${e.android.keystoreAlias}`)).replace(/.*RELEASE_KEY_PASSWORD=.*/,`# RELEASE_KEY_PASSWORD=${e.android.keystoreAliasPassword}`);const o=this.parseVersion(r,"PROP_COMPILE_SDK_VERSION",27),n=this.parseVersion(r,"PROP_MIN_SDK_VERSION",21);r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/PROP_TARGET_SDK_VERSION=.*/,`PROP_TARGET_SDK_VERSION=${i}`)).replace(/PROP_COMPILE_SDK_VERSION=.*/,`PROP_COMPILE_SDK_VERSION=${Math.max(i,o,27)}`)).replace(/PROP_MIN_SDK_VERSION=.*/,`PROP_MIN_SDK_VERSION=${Math.min(i,n)}`)).replace(/PROP_APP_NAME=.*/,`PROP_APP_NAME=${e.projectName}`)).replace(/PROP_ENABLE_INSTANT_APP=.*/,`PROP_ENABLE_INSTANT_APP=${this.plugin.args.android.androidInstant?"true":"false"}`)).replace(/RES_PATH=.*/,`RES_PATH=${cocosCli_1.cchelper.fixPath(this.projectDir)}`)).replace(/COCOS_ENGINE_PATH=.*/,`COCOS_ENGINE_PATH=${cocosCli_1.cchelper.fixPath(this.plugin.getEnginePath())}`)).replace(/APPLICATION_ID=.*/,`APPLICATION_ID=${this.plugin.args.android.packageName}`)).replace(/NATIVE_DIR=.*/,`NATIVE_DIR=${cocosCli_1.cchelper.fixPath(this.plugin.getEnv("NATIVE_DIR"))}`),"win32"===process.platform&&(e.android.ndkPath=e.android.ndkPath.replace(/\\/g,"\\\\")),r=r.replace(/PROP_NDK_PATH=.*/,`PROP_NDK_PATH=${e.android.ndkPath}`);const s=e.android.appABIs&&e.android.appABIs.length>0?e.android.appABIs.join(":"):"armeabi-v7a";r=r.replace(/PROP_APP_ABI=.*/g,`PROP_APP_ABI=${s}`),fs.writeFileSync(t,r),r="",r+=`sdk.dir=${e.android.sdkPath}`,"win32"===process.platform&&(r=(r=r.replace(/\\/g,"\\\\")).replace(/:/g,"\\:")),fs.writeFileSync(cocosCli_1.cchelper.join(path.dirname(t),"local.properties"),r)}else console.log(`warning: ${t} not found!`)}get cocos2dxFiles(){return fs.readJSONSync(path.join(this.enginePath,COCOS2D_FILES_PATH))}async execute(e){var t;const a=this.plugin.args.platform,i=this.plugin.args;e.appendFile&&(e.appendFile.forEach(e=>{const t=cocosCli_1.cchelper.replaceEnvVariables(e.to);fs.ensureDirSync(path.dirname(t)),fs.copySync(path.join(this.cocosRoot,e.from),t)}),delete e.appendFile);const r={};if(e.projectReplaceProjectName){const t=e.projectReplaceProjectName;t.files.forEach(e=>{const a=cocosCli_1.cchelper.join(this.projectDir,e);r[a]=r[a]||[],r[a].push({reg:t.srcProjectName,content:this.projectName})}),delete e.projectReplaceProjectName}if(e.projectReplacePackageName){const t=e.projectReplacePackageName,a=t.srcPackageName.replace(/\./g,"\\.");t.files.forEach(e=>{const t=cocosCli_1.cchelper.join(this.projectDir,e);r[t]=r[t]||[],r[t].push({reg:a,content:this.packageName})}),delete e.projectReplacePackageName}for(const e in r){const t=r[e];await cocosCli_1.cchelper.replaceInFile(t.map(e=>({reg:e.reg,text:e.content})),e)}if(Object.keys(e).length>0)for(const t in e)console.error(`command "${t}" is not parsed in ${PackageNewConfig}`);if(a===default_1.PLATFORM_ENUM.OHOS){const e=this.plugin.platformTemplatePath,a=path.normalize(this.cocosRoot);if(!fs.existsSync(i.ohos.sdkPath))throw new Error(`Directory hwsdk.dir ${i.ohos.sdkPath} not exists`);if(!fs.existsSync(i.ohos.ndkPath))throw new Error(`Directory native.dir ${i.ohos.ndkPath} not exists`);await cocosCli_1.cchelper.replaceInFile([{reg:"^hwsdk\\.dir.*",text:`hwsdk.dir=${cocosCli_1.cchelper.fixPath(i.ohos.sdkPath)}`},{reg:"^native\\.dir.*",text:`native.dir=${cocosCli_1.cchelper.fixPath(i.ohos.ndkPath)}`}],path.join(e,"local.properties")),await cocosCli_1.cchelper.replaceInFile([{reg:"\\$\\{ENGINE_ROOT\\}",text:cocosCli_1.cchelper.fixPath(a)},{reg:"^rootProject\\.name.*",text:`rootProject.name = "${i.projectName}"`}],path.join(e,"settings.gradle")),await cocosCli_1.cchelper.replaceInFile([{reg:"^RES_PATH.*",text:`RES_PATH=${cocosCli_1.cchelper.fixPath(this.projectDir)}`},{reg:"^ENGINE_ROOT.*",text:`ENGINE_ROOT=${cocosCli_1.cchelper.fixPath(a)}`},{reg:"^COMMON_DIR.*",text:`COMMON_DIR=${cocosCli_1.cchelper.fixPath(process.env.COMMON_DIR||"")}`}],path.join(e,"gradle.properties"));try{const a=path.join(e,"entry/src/main/config.json"),r=JSON.parse(await afs_1.afs.readFile(a,"utf8")),o=null===(t=r.module)||void 0===t?void 0:t.abilities;if((null===o||void 0===o?void 0:o.length)>0){const e=i.ohos.orientation;let t="landscape";t=e.portrait&&(e.landscapeRight||e.landscapeLeft)?"unspecified":!e.portrait||e.landscapeLeft||e.landscapeRight?e.landscapeLeft||e.landscapeRight?"landscape":"unspecified":"portrait",o.forEach(e=>{e.orientation=t})}r.app.bundleName=i.ohos.packageName,fs_extra_1.outputJSONSync(a,r,{spaces:2})}catch(e){console.error(e)}try{const t=path.join(e,"entry/src/main/resources/base/element/string.json"),a=JSON.parse(await afs_1.afs.readFile(t,"utf8")),r=a.string=a.string||[];let o=r.find(e=>"app_name"===e.name);o||(o={name:"app_name",value:"CocosGame"},r.push(o)),o.value=i.projectName||"CocosGame",fs_extra_1.outputJSONSync(t,a,{spaces:2})}catch(e){console.error(e)}}}}exports.TemplateCreator=TemplateCreator;