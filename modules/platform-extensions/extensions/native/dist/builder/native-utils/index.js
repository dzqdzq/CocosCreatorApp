"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkName=exports.packToolHandler=exports._createBundle=exports.checkLiteVersion=exports.generateJsbAdapter=exports.compileJsbAdapter=exports.clearDest=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),babelify=require("babelify"),browserify=require("browserify");async function clearDest(e){try{await fs_extra_1.remove(path_1.join(e,"data"))}catch(e){console.error(e)}}async function compileJsbAdapter(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript,t=path_1.join(e.path,"platforms/native"),a=path_1.join(e.path,"bin/.cache/dev/native-preview-adapter");if(!hasChanged(t,a))return;const r=path_1.join(t,"builtin/index.js"),n=path_1.join(t,"engine/index.js");await _createBundle(r,path_1.join(a,"web-adapter.js"),{targets:"chrome 80"}),await _createBundle(n,path_1.join(a,"engine-adapter.js"),{targets:"chrome 80"})}async function generateJsbAdapter(e,t){const a=path_1.join(e,"platforms/native"),r=path_1.join(a,"builtin/index.js"),n=path_1.join(a,"engine/index.js");await _createBundle(r,path_1.join(t,"web-adapter.js"),{targets:"chrome 80"}),await _createBundle(n,path_1.join(t,"engine-adapter.js"),{targets:"chrome 80"})}async function checkLiteVersion(e){const t=path_1.join(e,".cocos-project.json");if(!fs_extra_1.existsSync(t))return void console.error(`Can't find project json [{link(${t})}]`);(await fs_extra_1.readJSON(t)).engine_version}function checkFileStat(e,t){return fs_extra_1.readdirSync(e).some(a=>{const r=path_1.join(e,a),n=fs_extra_1.statSync(r);return n.isDirectory()?checkFileStat(r,t):n.mtime.getTime()>t||void 0})}function hasChanged(e,t){if(!fs_extra_1.existsSync(t))return!0;const a=path_1.join(t,"web-adapter.js"),r=path_1.join(t,"engine-adapter.js");if(!fs_extra_1.existsSync(a)||!fs_extra_1.existsSync(r))return!0;const n=fs_extra_1.statSync(t);return checkFileStat(path_1.dirname(e),n.mtime.getTime())}async function _createBundle(e,t,a){let r,n;Array.isArray(a)?r=a:a&&(r=a.excludes,n=a.targets);const i=browserify(e);return r&&r.forEach(function(e){i.exclude(e)}),await fs_extra_1.ensureDir(path_1.dirname(t)),new Promise((e,a)=>{i.transform(babelify,{presets:[[require("@babel/preset-env"),{targets:n}]]}).bundle((r,n)=>{if(r)return console.error(r),void a(r);fs_extra_1.writeFileSync(t,n,"utf8"),e()})})}exports.clearDest=clearDest,exports.compileJsbAdapter=compileJsbAdapter,exports.generateJsbAdapter=generateJsbAdapter,exports.checkLiteVersion=checkLiteVersion,exports._createBundle=_createBundle;class PackToolHandler{constructor(){this._init=!1}get ready(){return this._init}async init(e=""){if(!this._init){if(!e){const{path:t}=(await Editor.Message.request("engine","query-engine-info")).typescript;e=t}this.packRoot=path_1.join(e,"scripts","native-pack-tool"),this.manager=require(path_1.join(this.packRoot,"dist/index")).nativePackToolMg}}async runTask(e,t){this.ready||await this.init(),await this.manager.init(t),await this.manager[e](t.platform)}}function checkName(e){return"android"===e.platform?/^[\u4e00-\u9fa5A-Za-z0-9-_]+$/.test(e.name):/^[A-Za-z0-9-_]+$/.test(e.name)}exports.packToolHandler=new PackToolHandler,exports.checkName=checkName;