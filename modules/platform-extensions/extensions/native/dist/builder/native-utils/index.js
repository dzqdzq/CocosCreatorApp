"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.packToolHandler=void 0,exports.clearDest=clearDest,exports.compileJsbAdapter=compileJsbAdapter,exports.generateJsbAdapter=generateJsbAdapter,exports.checkLiteVersion=checkLiteVersion,exports._createBundle=_createBundle,exports.acceptChineseName=acceptChineseName,exports.checkName=checkName;const fs_extra_1=require("fs-extra"),path_1=require("path"),babelify=require("babelify"),browserify=require("browserify");async function clearDest(e){try{await(0,fs_extra_1.remove)((0,path_1.join)(e,"data"))}catch(e){console.error(e)}}async function compileJsbAdapter(){var e,t=(await Editor.Message.request("engine","query-engine-info")).typescript,a=(0,path_1.join)(t.path,"platforms/native"),t=(0,path_1.join)(t.path,"bin/.cache/dev/native-preview-adapter");hasChanged(a,t)&&(e=(0,path_1.join)(a,"builtin/index.js"),a=(0,path_1.join)(a,"engine/index.js"),await _createBundle(e,(0,path_1.join)(t,"web-adapter.js"),{targets:"chrome 80"}),await _createBundle(a,(0,path_1.join)(t,"engine-adapter.js"),{targets:"chrome 80"}))}async function generateJsbAdapter(e,t){var e=(0,path_1.join)(e,"platforms/native"),a=(0,path_1.join)(e,"builtin/index.js"),e=(0,path_1.join)(e,"engine/index.js");await _createBundle(a,(0,path_1.join)(t,"web-adapter.js"),{targets:"chrome 80"}),await _createBundle(e,(0,path_1.join)(t,"engine-adapter.js"),{targets:"chrome 80"})}async function checkLiteVersion(e){e=(0,path_1.join)(e,".cocos-project.json");(0,fs_extra_1.existsSync)(e)?(await(0,fs_extra_1.readJSON)(e)).engine_version:console.error(`Can't find project json [{link(${e})}]`)}function checkFileStat(a,i){return(0,fs_extra_1.readdirSync)(a).some(e=>{var e=(0,path_1.join)(a,e),t=(0,fs_extra_1.statSync)(e);return t.isDirectory()?checkFileStat(e,i):t.mtime.getTime()>i||void 0})}function hasChanged(e,t){var a,i;return!(0,fs_extra_1.existsSync)(t)||(i=(0,path_1.join)(t,"web-adapter.js"),a=(0,path_1.join)(t,"engine-adapter.js"),!(0,fs_extra_1.existsSync)(i))||!(0,fs_extra_1.existsSync)(a)||(i=(0,fs_extra_1.statSync)(t),checkFileStat((0,path_1.dirname)(e),i.mtime.getTime()))}async function _createBundle(e,r,t){let a,n;Array.isArray(t)?a=t:t&&(a=t.excludes,n=t.targets);const s=browserify(e);return a&&a.forEach(function(e){s.exclude(e)}),await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(r)),new Promise((a,i)=>{s.transform(babelify,{presets:[[require("@babel/preset-env"),{targets:n}]]}).bundle((e,t)=>{e?(console.error(e),i(e)):((0,fs_extra_1.writeFileSync)(r,t,"utf8"),a())})})}class PackToolHandler{_init=!1;packRoot;manager;get ready(){return this._init}async init(e,t){this._init&&!t||(e=e||(await Editor.Message.request("engine","query-engine-info")).typescript.path,this.packRoot=(0,path_1.join)(e,"scripts","native-pack-tool"),this.manager=require((0,path_1.join)(this.packRoot,"dist/index")).nativePackToolMg,this._init=!0)}async getProjectBuildPath(e){return this._init?e?.projectDistPath:""}async initPackTool(e){return await this.init(e.enginePath),this.manager.init(e)}async runTask(e,t){return await this.initPackTool(t),this.manager[e](t.platform)}async openWithIDE(e,t,a){return await this.init(),this.manager.openWithIDE(e,t,a)}}function acceptChineseName(e){return["mac","ios","windows","android"].includes(e.platform)}function checkName(e,t){return(acceptChineseName(t)?/^[\u4e00-\u9fa5A-Za-z0-9-_]+$/:/^[A-Za-z0-9-_]+$/).test(e)}exports.packToolHandler=new PackToolHandler;