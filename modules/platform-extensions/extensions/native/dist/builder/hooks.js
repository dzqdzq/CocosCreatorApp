"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterCompressSettings=exports.onAfterBuildAssets=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const os_1=__importDefault(require("os")),ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),native_utils_1=require("./native-utils");function fixPath(e){return"win32"===os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}function isAppleSilicon(){const e=os_1.default.cpus(),t=e&&e[0]&&e[0].model?e[0].model:"";return/Apple/.test(t)&&"darwin"===process.platform}async function getCmakePath(){const e=await Editor.Message.request("program","query-program-info","cmake");let t=e?e.path:"";if(!t){const e=path_1.join(Editor.App.path,"../tools/cmake");return"win32"===process.platform?path_1.join(e,"bin/cmake.exe"):path_1.join(e,"bin/cmake")}return t="win32"===process.platform&&t.indexOf(" ")>-1?`"${t}"`:t.replace(/ /g,"\\ ")}async function genCocosParams(e,t){const a=e.name,i=await Editor.Message.request("engine","query-engine-info"),s=e.packages,r=await Editor.Profile.getProject("engine","macroConfig"),n={buildDir:path_1.dirname(t.paths.dir),buildAssetsDir:t.paths.dir,projDir:Editor.Project.path,cmakePath:await getCmakePath(),nativeEnginePath:i.native.path,enginePath:i.typescript.path,projectName:a,debug:e.debug,encrypted:e.packages.native.encrypted&&!e.debug,xxteaKey:e.packages.native.xxteaKey,compressZip:e.packages.native.compressZip,cMakeConfig:{APP_NAME:`set(APP_NAME ${a})`,COCOS_X_PATH:`set(COCOS_X_PATH "${fixPath(i.native.path)}")`,USE_JOB_SYSTEM_TASKFLOW:"taskFlow"===s.native.JobSystem,USE_JOB_SYSTEM_TBB:"tbb"===s.native.JobSystem,ENABLE_ANTIALIAS_FXAA:r.ENABLE_ANTIALIAS_FXAA},platformParams:{},platform:e.platform,packageName:e.packages[e.platform]&&e.packages[e.platform].packageName||""};"custom"===i.native.type&&(n.cMakeConfig.BUILTIN_COCOS_X_PATH=`set(BUILTIN_COCOS_X_PATH "${fixPath(i.native.builtin)}")`);const o=await Editor.Profile.getConfig("engine","modules.moduleConfig","default");return Object.keys(o).forEach(t=>{o[t].native&&(n.cMakeConfig[o[t].native]=`set(${o[t].native} ${e.includeModules.includes(t)?"ON":"OFF"})`)}),fs_extra_1.existsSync(n.buildDir)||await fs_extra_1.mkdir(n.buildDir),n}async function getBrowserslistQuery(e){const t=path_1.join(e,".browserslistrc");let a;try{a=await fs_extra_1.readFile(t,"utf8")}catch(e){return}const i=function(e){const t=[];for(const a of e.split("\n")){const e=a.indexOf("#"),i=(e<0?a:a.substr(0,e)).trim();0!==i.length&&t.push(i)}return t}(a);if(0!==i.length)return i.join(" or ")}async function onAfterInit(e,t){if(!native_utils_1.checkName(e)){const t="android"===e.platform?Editor.I18n.t("native.options.androidNameErrorTips"):Editor.I18n.t("native.options.nameErrorTips");throw new Error(t)}e.buildScriptParam.hotModuleReload=e.packages.native.hotModuleReload,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.assetSerializeOptions.exportCCON=!0,e.assetSerializeOptions.allowCCONExtension=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/");const{native:{path:a},typescript:{path:i}}=await Editor.Message.request("engine","query-engine-info");let s;native_utils_1.packToolHandler.init(i),console.debug("Native engine root:"+a),e.includeModules=e.includeModules.filter(e=>!["gfx-webgl2","gfx-webgl"].includes(e)),Object.assign(e.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const r=await getBrowserslistQuery(a);r&&(s=r),s&&(e.buildEngineParam.targets=s,e.buildScriptParam.targets=s,e.buildScriptParam.polyfills||(e.buildScriptParam.polyfills={}),e.buildScriptParam.polyfills.targets=s,"asyncFunctions"in e.buildScriptParam.polyfills&&delete e.buildScriptParam.polyfills.asyncFunctions),e.buildScriptParam.system={preset:"commonjs-like"};const n=path_1.join(t.paths.dir,"assets");t.paths.dir=path_1.join(t.paths.dir,"data");const o=t.paths.dir;t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS)),window.__manager.taskManager.debug||await fs_extra_1.emptyDirSync(o);try{fs_extra_1.existsSync(n)||fs_extra_1.symlinkSync(o,n,"junction")}catch(e){console.error(`Failed to create symbolic link ${n}`),console.error(e)}const l=await genCocosParams(e,t);t.compileOptions=l,await fs_extra_1.outputJSON(t.paths.compileConfig,l),await fs_extra_1.copy(path_1.join(l.enginePath,"bin/adapter/native",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"jsb-adapter/web-adapter.js")),await fs_extra_1.copy(path_1.join(l.enginePath,"bin/adapter/native",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"jsb-adapter/engine-adapter.js"))}async function onBeforeBuildAssets(e,t,a){for(const e of a.scriptUuids){const i=a.getAssetInfo(e),s=await a.getMeta(e);i?s?s.userData.isPlugin&&s.userData.loadPluginInNative&&t.addPlugin(i):console.error(`Get meta of script {asset(${i.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onAfterBuildAssets(e,t){t.bundles.forEach(e=>{e.configOutPutName="cc.config"})}async function onAfterCompressSettings(e,t){const a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=path_1.join(a,"templates/native"),s={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)};let r=path_1.join(Build.buildTemplateDir,"native","index.ejs");if(fs_extra_1.existsSync(r))try{const e=fs_extra_1.readJSONSync(path_1.join(i,"build-template.json"));if(e.version){const t=path_1.join(Build.buildTemplateDir,"templates-version.json");let a="";fs_extra_1.existsSync(t)&&(a=fs_extra_1.readJSONSync(t).native),compareBuildTemplateVersion(e.version,a)&&console.warn(Editor.I18n.t("native.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else r=path_1.join(i,"index.ejs");const n=(await ejs_1.default.renderFile(r,s)).toString();await fs_extra_1.writeFile(path_1.join(t.paths.dir,"main.js"),n,"utf8"),await native_utils_1.packToolHandler.runTask("create",t.compileOptions);const o=e.server||"",l=path_1.resolve(t.paths.dir,"../remote");fs_extra_1.removeSync(l),o&&fs_extra_1.existsSync(t.paths.remote)&&(fs_extra_1.moveSync(t.paths.remote,l),t.paths.remote=l)}async function onAfterBuild(e,t){await native_utils_1.packToolHandler.runTask("generate",t.compileOptions);const a=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(a)&&(fs_extra_1.copySync(a,path_1.dirname(t.paths.dir)),console.debug(`Use user build-template in {link(${a})}`))}async function make(e,t){await native_utils_1.packToolHandler.runTask("make",t)}async function run(e,t){await native_utils_1.packToolHandler.runTask("run",t)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,i]=[e.split("."),t.split(".")],s=Math.max(a.length,i.length);for(let e=0;e<s;e++)if(parseInt(a[e])>parseInt(i[e]))return!0;return!1}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onAfterCompressSettings=onAfterCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;