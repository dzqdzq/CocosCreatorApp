"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterBuildAssets=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),index_1=require("./native-utils/index"),ejs_1=__importDefault(require("ejs")),default_1=require("../console/default"),cocosCli_1=require("../console/cocosCli"),os_1=__importDefault(require("os")),encrypted_1=require("./encrypted"),path=require("path");function fixPath(e){return"win32"===os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}async function genConsoleParams(e,a,t){const o=new default_1.ConsoleParams;o.pluginName=t;const i=a.paths.dir,s=path_1.dirname(i),r=e.name;o.enginePath=await index_1.Path.queryNativeEnginePath(),o.projectName=r,o.cMakeConfig.APP_NAME=`set(APP_NAME ${r})`,o.cMakeConfig.COCOS_X_PATH=`set(COCOS_X_PATH "${fixPath(o.enginePath)}")`,e.packages.native.encrypted&&(o.cMakeConfig.XXTEAKEY=`set(XXTEAKEY "${e.packages.native.xxteaKey}")`);const n=e.packages;let d=`com.cocos.${r}`;const c=[];if(o.debug=e.debug,o.cMakeConfig.USE_JOB_SYSTEM_TASKFLOW="taskFlow"===n.native.JobSystem,o.cMakeConfig.USE_JOB_SYSTEM_TBB="tbb"===n.native.JobSystem,["mac","linux","windows"].includes(e.platform)){o.cMakeConfig.USE_SERVER_MODE=`set(USE_SERVER_MODE ${n.native.serverMode?"ON":"OFF"})`;const e=Number(n.native.netMode);o.cMakeConfig.NET_MODE=`set(NET_MODE ${isNaN(e)||e>2||e<0?0:e})`}let l;n.android&&("huawei-agc"===e.platform?c.push("huawei-agc"):c.push("android"),o.android.ndkPath=n.android.ndkPath,o.android.sdkPath=n.android.sdkPath,o.android.androidInstant=n.android.androidInstant,o.android.remoteUrl=n.android.remoteUrl,o.android.packageName=n.android.packageName,o.android.apiLevel=Number(n.android.apiLevel.match(/[1-9][0-9]/)[0])),n.ios&&(c.push("ios"),n.ios.developerTeam&&(o.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${n.ios.developerTeam})`)&&(o.teamid=n.ios.developerTeam),o.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${n.ios.targetVersion||"12.0"})`,o.cMakeConfig.USE_PORTRAIT=!!n.ios.orientation.portrait,o.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=n.ios.skipUpdateXcodeProject,o.ios.skipUpdateXcodeProject=n.ios.skipUpdateXcodeProject,n.ios.osTarget&&(void 0!==n.ios.osTarget.simulator&&(o.ios.simulator=n.ios.osTarget.simulator),void 0!==n.ios.osTarget.iphoneos&&(o.ios.iphoneos=n.ios.osTarget.iphoneos))),n.windows&&(c.push("windows"),o.win.targetPlatform=n.windows.targetPlatform),n.mac&&(c.push("mac"),o.cMakeConfig.TARGET_OSX_VERSION=`set(TARGET_OSX_VERSION ${n.mac.targetVersion||"10.14"})`,o.cMakeConfig.CUSTOM_COPY_RESOURCE_HOOK=n.mac.skipUpdateXcodeProject,o.mac.skipUpdateXcodeProject=n.mac.skipUpdateXcodeProject),n.ohos&&(c.push("ohos"),o.ohos.ndkPath=n.ohos.ndkPath,o.ohos.sdkPath=n.ohos.sdkPath,o.ohos.packageName=n.ohos.packageName,o.ohos.orientation=n.ohos.orientation),n.android&&n.android.packageName&&(d=n.android.packageName,o.android.appBundle=n.android.appBundle,o.android.orientation=n.android.orientation,o.android.appABIs=n.android.appABIs,o.cMakeConfig.CC_ENABLE_SWAPPY=!!n.android.swappy,n.android.useDebugKeystore?(o.android.keyStorePath=path_1.join(Editor.App.path,"../tools/keystore/debug.keystore"),o.android.keystoreAlias="debug_keystore",o.android.keystorePassword="123456",o.android.keystoreAliasPassword="123456"):(o.android.keyStorePath=n.android.keystorePath,o.android.keystoreAliasPassword=n.android.keystoreAliasPassword,o.android.keystorePassword=n.android.keystorePassword,o.android.keystoreAlias=n.android.keystoreAlias)),n.ohos&&(o.ohos=n.ohos),"linux"===e.platform&&c.push("linux"),1===c.length?l=c[0]:console.error(`Invalidate platforms "${c}", size ${c.length}.`);if(e.packages&&e.packages[e.platform]){let a=e.packages[e.platform].renderBackEnd;if("huawei-agc"===e.platform){const t="android";a=e.packages[t].renderBackEnd}a&&Object.keys(a).forEach(e=>{o.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=a[e]})}const p=await Editor.Profile.getConfig("engine","modules.moduleConfig","default");Object.keys(p).forEach(a=>{p[a].native&&(o.cMakeConfig[p[a].native]=`set(${p[a].native} ${e.includeModules.includes(a)?"ON":"OFF"})`)});const u=s;return fs_extra_1.existsSync(u)||await fs_extra_1.mkdir(u),o.language=default_1.LANGUAGE.JS,o.directory=u,o.templateName="link",o.buildDir=path_1.join(s,"proj"),n.ios&&n.ios.packageName&&(o.ios.orientation=n.ios.orientation,o.ios.bundleId=n.ios.packageName,o.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${o.ios.bundleId})`),o.sharedDir=path_1.join(u,".."),l&&(o.platform=default_1.PLATFORM_ENUM[l.toUpperCase()]),n.mac&&n.mac.packageName&&(o.mac.bundleId=n.mac.packageName,o.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${o.mac.bundleId})`),o}async function copyNativeTemplates(e,a){const t=await genConsoleParams(e,a,default_1.PLUGIN_NAME_ENUM.NEW);await new cocosCli_1.NativeConsole(t).run()}async function generateNativeProject(e,a){const t=await genConsoleParams(e,a,default_1.PLUGIN_NAME_ENUM.GENERATE);await new cocosCli_1.NativeConsole(t).run(),e.packages.native.params=t.toJSON(),fs_extra_1.outputJSONSync(path_1.join(t.directory,"cocos.compile.config.json"),e)}async function getBrowserslistQuery(e){const a=path_1.join(e,".browserslistrc");let t;try{t=await fs_extra_1.readFile(a,"utf8")}catch(e){return}const o=function(e){const a=[];for(const t of e.split("\n")){const e=t.indexOf("#"),o=(e<0?t:t.substr(0,e)).trim();0!==o.length&&a.push(o)}return a}(t);if(0!==o.length)return o.join(" or ")}async function onAfterInit(e,a){e.assetSerializeOptions.exportCCON=!0,e.assetSerializeOptions.allowCCONExtension=!0;let t=e.packages.native.remoteServerAddress||"";t&&!t.endsWith("/")&&(t+="/"),e.mainBundleIsRemote&&!t&&(console.warn(Editor.I18n.t("native.options.bundle_invalid_warning")),e.mainBundleIsRemote=!1),Object.assign(e.appTemplateData,{server:t}),e.packages.native.makeAfterBuild&&(e.nextTasks=["make"]),e.packages.native.runAfterMake&&(e.nextTasks=["run"]);const{nativePath:o}=await Editor.Message.request("engine","query-info");let i;index_1.Path._root=e.packages.native.engine||o,console.debug("Native engine root:"+index_1.Path._root),e.includeModules=e.includeModules.filter(e=>!["gfx-webgl2","gfx-webgl"].includes(e)),Object.assign(e.appTemplateData,{showFPS:!1}),Object.assign(e.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const s=await getBrowserslistQuery(index_1.Path._root);if(s&&(i=s),e.buildScriptParam.polyfills=e.packages.native.polyfills,i&&(e.buildEngineParam.targets=i,e.buildScriptParam.targets=i,e.buildScriptParam.polyfills||(e.buildScriptParam.polyfills={}),e.buildScriptParam.polyfills.targets=i,"asyncFunctions"in e.buildScriptParam.polyfills&&delete e.buildScriptParam.polyfills.asyncFunctions),["mac","linux","windows"].includes(e.platform)){e.buildScriptParam.flags.SERVER_MODE=!!e.packages.native.serverMode;const a=Number(e.packages.native.netMode);e.buildScriptParam.flags.NET_MODE=isNaN(a)||a>2||a<0?0:a}e.buildScriptParam.system={preset:"commonjs-like"};const r=path.join(a.paths.dir,"assets");a.paths.dir=path_1.join(a.paths.dir,"data");const n=a.paths.dir;a.paths.applicationJS=path_1.join(a.paths.dir,"src",path_1.basename(a.paths.applicationJS)),window.__manager.taskManager.debug||await fs_extra_1.emptyDirSync(n);try{fs_extra_1.existsSync(r)||fs_extra_1.symlinkSync(n,r,"junction")}catch(e){console.error(`Failed to create symbolic link ${r}`),console.error(e)}await index_1.outputJSBAdapter(n,{targets:i})}async function onBeforeBuildAssets(e,a,t){for(const e of t.scriptUuids){const o=t.getAssetInfo(e),i=await t.getMeta(e);o?i?i.userData.isPlugin&&i.userData.loadPluginInNative&&a.addPlugin(o):console.error(`Get meta of script {asset(${o.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onAfterBuildAssets(e,a){if(a.bundles.forEach(e=>{e.configOutPutName="cc.config"}),await copyNativeTemplates(e,a),!e.debug){if(!e.packages.native.xxteaKey)return Promise.reject(Error(Editor.I18n.t("native.encrypt.xxtea_key_empty")));if(e.packages.native.encrypted&&await encrypted_1.setEncryptConfig(a),!e.debug&&e.packages.native.encrypted){if(!e.packages.native.xxteaKey)return Promise.reject(Error(Editor.I18n.t("native.encrypt.xxtea_key_empty")));a.bundles.map(e=>e.scriptDest);await encrypted_1.encryptJs(a,{encrypted:e.packages.native.encrypted,compressZip:e.packages.native.compressZip,xxteaKey:e.packages.native.xxteaKey})}}}async function onAfterBuild(e,a){const t=e.packages.native.remoteServerAddress||"",o=path_1.resolve(a.paths.dir,"../remote");fs_extra_1.removeSync(o),t&&fs_extra_1.existsSync(a.paths.remote)&&(fs_extra_1.moveSync(a.paths.remote,o),a.paths.remote=o);const i=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(i)&&(fs_extra_1.copySync(i,path_1.dirname(a.paths.dir)),console.debug(`Use user build-template in {link(${i})}`)),fs_extra_1.ensureDirSync(path_1.join(a.paths.dir,"src"));const s=path_1.join(__dirname,"../../static/build-template/index.ejs"),r={polyfillsBundleFile:a.paths.polyfillsJs&&Build.Utils.relativeUrl(a.paths.dir,a.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.systemJs),importMapFile:Build.Utils.relativeUrl(a.paths.dir,a.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(a.paths.dir,a.paths.applicationJS)},n=(await ejs_1.default.renderFile(s,r)).toString();await fs_extra_1.writeFile(path_1.join(a.paths.dir,"main.js"),n,"utf8"),await generateNativeProject(e,a)}async function make(e,a){const t=a.packages.native.params;t.pluginName=default_1.PLUGIN_NAME_ENUM.COMPILE,await new cocosCli_1.NativeConsole(t).run()}async function run(e,a){const t=a.packages.native.params;t.pluginName=default_1.PLUGIN_NAME_ENUM.RUN,await new cocosCli_1.NativeConsole(t).run()}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;