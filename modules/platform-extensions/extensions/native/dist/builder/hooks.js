"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterCompressSettings=exports.onAfterBundleDataTask=exports.onAfterBundleInit=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const os_1=__importDefault(require("os")),ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),native_utils_1=require("./native-utils");function fixPath(e){return"win32"===os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}function isAppleSilicon(){const e=os_1.default.cpus(),t=e&&e[0]&&e[0].model?e[0].model:"";return/Apple/.test(t)&&"darwin"===process.platform}async function getCmakePath(){const e=await Editor.Message.request("program","query-program-info","cmake"),t=e?e.path:"";if(!t){const e=(0,path_1.join)(Editor.App.path,"../tools/cmake");return"win32"===process.platform?(0,path_1.join)(e,"bin/cmake.exe"):(0,path_1.join)(e,"bin/cmake")}return t}async function genCocosParams(e,t){const a=e.name,i=await Editor.Message.request("engine","query-engine-info"),n=e.packages,r=await Editor.Profile.getProject("engine","macroConfig"),s={buildDir:(0,path_1.dirname)(t.paths.dir),buildAssetsDir:t.paths.dir,projDir:Editor.Project.path,cmakePath:await getCmakePath(),nativeEnginePath:i.native.path,enginePath:i.typescript.path,projectName:a,debug:e.debug,encrypted:e.packages.native.encrypted,xxteaKey:e.packages.native.xxteaKey,compressZip:e.packages.native.compressZip,cMakeConfig:{APP_NAME:`set(APP_NAME "${a}")`,COCOS_X_PATH:`set(COCOS_X_PATH "${fixPath(i.native.path)}")`,USE_JOB_SYSTEM_TASKFLOW:"taskFlow"===n.native.JobSystem,USE_JOB_SYSTEM_TBB:"tbb"===n.native.JobSystem,ENABLE_FLOAT_OUTPUT:r.ENABLE_FLOAT_OUTPUT},platformParams:{},platform:e.platform,packageName:e.packages[e.platform]&&e.packages[e.platform].packageName||""};e.debug&&s.encrypted&&(console.warn(Editor.I18n.t("native.encrypt.disable_tips")),s.encrypted=!1),"custom"===i.native.type&&(s.cMakeConfig.BUILTIN_COCOS_X_PATH=`set(BUILTIN_COCOS_X_PATH "${fixPath(i.native.builtin)}")`);const o=await Editor.Profile.getConfig("engine","modules.moduleConfig","default");return Object.keys(o).forEach(t=>{o[t].native&&(s.cMakeConfig[o[t].native]=`set(${o[t].native} ${e.includeModules.includes(t)?"ON":"OFF"})`)}),(0,fs_extra_1.existsSync)(s.buildDir)||await(0,fs_extra_1.mkdir)(s.buildDir),s}async function getBrowserslistQuery(e){const t=(0,path_1.join)(e,".browserslistrc");let a;try{a=await(0,fs_extra_1.readFile)(t,"utf8")}catch(e){return}const i=function(e){const t=[];for(const a of e.split("\n")){const e=a.indexOf("#"),i=(e<0?a:a.substr(0,e)).trim();0!==i.length&&t.push(i)}return t}(a);if(0!==i.length)return i.join(" or ")}function onBeforeBuild(e){e.useCache=!0}async function onAfterInit(e,t){if(!(0,native_utils_1.checkName)(e.name,e)){const t=(0,native_utils_1.acceptChineseName)(e),a=Editor.I18n.t(t?"native.options.nameErrorTips":"native.options.nameErrorTips_non_chinese");throw new Error(a)}e.server&&!e.server.endsWith("/")&&(e.server+="/");const{native:{path:a},typescript:{path:i}}=await Editor.Message.request("engine","query-engine-info");native_utils_1.packToolHandler.init(i),console.debug("Native engine root:"+a),Object.assign(e.buildEngineParam,{engineName:"src/cocos-js"});const n=(0,path_1.join)(t.paths.dir,"assets");t.paths.dir=(0,path_1.join)(t.paths.dir,"data");const r=t.paths.dir;"normal"===e.buildMode&&await(0,fs_extra_1.emptyDirSync)(r),t.paths.applicationJS=(0,path_1.join)(t.paths.dir,"src",(0,path_1.basename)(t.paths.applicationJS));try{(0,fs_extra_1.existsSync)(n)||(0,fs_extra_1.symlinkSync)(r,n,"junction")}catch(e){console.error(`Failed to create symbolic link ${n}`),console.error(e)}const s=await genCocosParams(e,t);t.compileOptions=s,await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,s),await(0,fs_extra_1.copy)((0,path_1.join)(s.enginePath,"bin/adapter/native",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"jsb-adapter/web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(s.enginePath,"bin/adapter/native",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"jsb-adapter/engine-adapter.js"))}async function onAfterBundleInit(e){const{native:{path:t}}=await Editor.Message.request("engine","query-engine-info");for(let t=0;t<e.includeModules.length;t++){const a=e.includeModules[t];["gfx-webgl2","gfx-webgl"].includes(a)&&(e.includeModules.splice(t,1),t--)}let a;e.buildScriptParam.hotModuleReload=e.packages.native.hotModuleReload,e.buildScriptParam.platform="NATIVE",e.polyfills&&(e.polyfills.asyncFunctions=!1),e.assetSerializeOptions.exportCCON=!0;const i=await getBrowserslistQuery(t);i&&(a=i),a&&(e.buildScriptParam.targets=a,e.buildScriptParam.polyfills||(e.buildScriptParam.polyfills={}),e.buildScriptParam.polyfills.targets=a,"asyncFunctions"in e.buildScriptParam.polyfills&&delete e.buildScriptParam.polyfills.asyncFunctions),e.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterBundleDataTask(e,t,a){t.forEach(e=>{for(const t of e.pluginScript){const i=a.getAssetInfo(t);i.meta.userData.isPlugin&&!i.meta.userData.loadPluginInNative&&e.pluginScript.delete(t)}e.configOutPutName="cc.config"})}async function onAfterCompressSettings(e,t){const a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=(0,path_1.join)(a,"templates/native"),n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)};let r=(0,path_1.join)(Build.buildTemplateDir,"native","index.ejs");if((0,fs_extra_1.existsSync)(r))try{const e=(0,fs_extra_1.readJSONSync)((0,path_1.join)(i,"build-template.json"));if(e.version){const t=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let a="";(0,fs_extra_1.existsSync)(t)&&(a=(0,fs_extra_1.readJSONSync)(t).native),compareBuildTemplateVersion(e.version,a)&&console.warn(Editor.I18n.t("native.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else r=(0,path_1.join)(i,"index.ejs");const s=(await ejs_1.default.renderFile(r,n)).toString();await(0,fs_extra_1.writeFile)((0,path_1.join)(t.paths.dir,"main.js"),s,"utf8"),await native_utils_1.packToolHandler.runTask("create",t.compileOptions);const o=e.server||"",l=(0,path_1.resolve)(t.paths.dir,"../remote");if((0,fs_extra_1.removeSync)(l),o&&(0,fs_extra_1.existsSync)(t.paths.remote))try{(0,fs_extra_1.moveSync)(t.paths.remote,l),t.paths.remote=l}catch(e){console.error(e)}}async function onAfterBuild(e,t){await native_utils_1.packToolHandler.runTask("generate",t.compileOptions);const a=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(a)&&((0,fs_extra_1.copySync)(a,(0,path_1.dirname)(t.paths.dir)),console.debug(`Use user build-template in {link(${a})}`))}async function make(e,t){await native_utils_1.packToolHandler.runTask("make",t)}async function run(e,t){await native_utils_1.packToolHandler.runTask("run",t)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,i]=[e.split("."),t.split(".")],n=Math.max(a.length,i.length);for(let e=0;e<n;e++)if(parseInt(a[e])>parseInt(i[e]))return!0;return!1}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onAfterCompressSettings=onAfterCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;