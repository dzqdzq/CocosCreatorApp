const path=require("path"),fs=require("fs"),gulp=require("gulp"),babelify=require("babelify"),browserify=require("browserify"),source=require("vinyl-source-stream"),buffer=require("vinyl-buffer");function checkFileStat(e,n){return fs.readdirSync(e).some(t=>{const i=path.join(e,t),r=fs.statSync(i);return r.isDirectory()?checkFileStat(i,n):r.mtime.getTime()>n||void 0})}function hasChanged(e,n){if(!fs.existsSync(n))return!0;const t=fs.statSync(n);return checkFileStat(path.dirname(e),t.mtime.getTime())}function createBundleTask(e,n,t){const i=path.basename(n);n=path.dirname(n);const r=browserify(e);return t&&t.forEach(function(e){r.exclude(e)}),r.transform(babelify,{presets:[require("@babel/preset-env")]}).bundle().pipe(source(i)).pipe(buffer()).pipe(gulp.dest(n))}function createCopyTask(e,n){return gulp.src(e).pipe(gulp.dest(n))}async function prebuild(e){const{rootPath:n,dstPath:t}=e;if(!n)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{const i=path.join(n,"./builtin/index.js"),r=path.join(t,"./jsb-builtin.js");hasChanged(i,r)?createBundleTask(i,r).on("end",e):e()}),await new Promise(e=>{const i=path.join(n,"./engine/index.js"),r=path.join(t,"./jsb-engine.js");hasChanged(i,r)?createBundleTask(i,r).on("end",e):e()}),console.timeEnd("build jsb-adapter")}async function build(e){const{rootPath:n,dstPath:t,excludedModules:i}=e;if(!n)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{createCopyTask(path.join(n,"./bin/jsb-builtin.js"),t).on("end",e)}),await new Promise(e=>{if(i&&i.length>0){const r=[],s=require(Editor.url("packages://jsb-adapter/modules.json"));i.forEach(function(e){s.some(function(t){if(t.name===e&&t.entries)return t.entries.forEach(function(e){r.push(path.join(n,e))}),!0})}),createBundleTask(path.join(n,"./engine/index.js"),path.join(t,"./jsb-engine.js"),r).on("end",e)}else{createCopyTask(path.join(n,"./bin/jsb-engine.js"),t).on("end",e)}}),console.timeEnd("build jsb-adapter")}const jsbAdapterBuilder={prebuild:prebuild,build:build,createBundleTask:createBundleTask};module.exports=jsbAdapterBuilder;