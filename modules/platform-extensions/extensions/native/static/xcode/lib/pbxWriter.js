var pbxProj=require("./pbxProject"),util=require("util"),f=util.format,INDENT="\t",COMMENT_KEY=/_comment$/,QUOTED=/^"(.*)"$/,EventEmitter=require("events").EventEmitter;function i(t){return t<=0?"":INDENT+i(t-1)}function comment(t,i){var e=i[t+"_comment"];return e||null}function isObject(t){return t===Object(t)}function isArray(t){return Array.isArray(t)}function pbxWriter(t,i){i||(i={}),void 0===i.omitEmptyValues&&(i.omitEmptyValues=!1),this.contents=t,this.sync=!1,this.indentLevel=0,this.omitEmptyValues=i.omitEmptyValues}util.inherits(pbxWriter,EventEmitter),pbxWriter.prototype.write=function(t){var e=f.apply(null,arguments);this.sync&&(this.buffer+=f("%s%s",i(this.indentLevel),e))},pbxWriter.prototype.writeFlush=function(t){var i=this.indentLevel;this.indentLevel=0,this.write.apply(this,arguments),this.indentLevel=i},pbxWriter.prototype.writeSync=function(){return this.sync=!0,this.buffer="",this.writeHeadComment(),this.writeProject(),this.buffer},pbxWriter.prototype.writeHeadComment=function(){this.contents.headComment&&this.write("// %s\n",this.contents.headComment)},pbxWriter.prototype.writeProject=function(){var t,i,e,n=this.contents.project;if(this.write("{\n"),n){for(t in this.indentLevel++,n)if(!COMMENT_KEY.test(t))if(i=comment(t,n),isArray(e=n[t]))this.writeArray(e,t);else if(isObject(e))this.write("%s = {\n",t),this.indentLevel++,"objects"===t?this.writeObjectsSections(e):this.writeObject(e),this.indentLevel--,this.write("};\n");else{if(this.omitEmptyValues&&(void 0===e||null===e))continue;i?this.write("%s = %s /* %s */;\n",t,e,i):this.write("%s = %s;\n",t,e)}this.indentLevel--}this.write("}\n")},pbxWriter.prototype.writeObject=function(t){var i,e,n;for(i in t)if(!COMMENT_KEY.test(i))if(n=comment(i,t),isArray(e=t[i]))this.writeArray(e,i);else if(isObject(e))this.write("%s = {\n",i),this.indentLevel++,this.writeObject(e),this.indentLevel--,this.write("};\n");else{if(this.omitEmptyValues&&(void 0===e||null===e))continue;n?this.write("%s = %s /* %s */;\n",i,e,n):this.write("%s = %s;\n",i,e)}},pbxWriter.prototype.writeObjectsSections=function(t){var i,e;for(i in t)this.writeFlush("\n"),isObject(e=t[i])&&(this.writeSectionComment(i,!0),this.writeSection(e),this.writeSectionComment(i,!1))},pbxWriter.prototype.writeArray=function(t,i){var e,n;for(this.write("%s = (\n",i),this.indentLevel++,e=0;e<t.length;e++)(n=t[e]).value&&n.comment?this.write("%s /* %s */,\n",n.value,n.comment):isObject(n)?(this.write("{\n"),this.indentLevel++,this.writeObject(n),this.indentLevel--,this.write("},\n")):this.write("%s,\n",n);this.indentLevel--,this.write(");\n")},pbxWriter.prototype.writeSectionComment=function(t,i){i?this.writeFlush("/* Begin %s section */\n",t):this.writeFlush("/* End %s section */\n",t)},pbxWriter.prototype.writeSection=function(t){var i,e,n;for(i in t)COMMENT_KEY.test(i)||(n=comment(i,t),"PBXBuildFile"==(e=t[i]).isa||"PBXFileReference"==e.isa?this.writeInlineObject(i,n,e):(n?this.write("%s /* %s */ = {\n",i,n):this.write("%s = {\n",i),this.indentLevel++,this.writeObject(e),this.indentLevel--,this.write("};\n")))},pbxWriter.prototype.writeInlineObject=function(t,i,e){var n=[],s=this,r=function(t,i,e){var o,h,c;for(o in i?n.push(f("%s /* %s */ = {",t,i)):n.push(f("%s = {",t)),e)if(!COMMENT_KEY.test(o))if(h=comment(o,e),isArray(c=e[o])){n.push(f("%s = (",o));for(var u=0;u<c.length;u++)n.push(f("%s, ",c[u]));n.push("); ")}else if(isObject(c))r(o,h,c);else{if(s.omitEmptyValues&&(void 0===c||null===c))continue;h?n.push(f("%s = %s /* %s */; ",o,c,h)):n.push(f("%s = %s; ",o,c))}n.push("}; ")};r(t,i,e),this.write("%s\n",n.join("").trim())},module.exports=pbxWriter;