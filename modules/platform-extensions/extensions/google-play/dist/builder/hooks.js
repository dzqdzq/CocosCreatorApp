"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),customIcon_1=require("./customIcon"),os_1=require("os");async function generateOptions(e){var e=e.packages["google-play"],a=(e.orientation=e.orientation||{},await Editor.Message.request("program","query-program-info","androidSDK")),o=await Editor.Message.request("program","query-program-info","androidNDK"),t=await Editor.Message.request("program","query-program-info","javaHome");if(e.sdkPath=e.sdkPath||a?.path||"",e.ndkPath=e.ndkPath||o?.path||"",e.javaHome=e.javaHome||t?.path||"",e.javaPath="",e.javaHome)try{var r,s,n=(0,fs_extra_1.statSync)(e.javaHome);n.isFile()?(e.javaPath=e.javaHome,e.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(e.javaPath),".."))):n.isDirectory()&&(r="win32"===(0,os_1.platform)()?"java.exe":"java",s=(0,path_1.join)(e.javaHome,"bin",r),(0,fs_extra_1.existsSync)(s)?e.javaPath=s:console.error(`Java executable not found at ${e.javaHome}/bin`))}catch(e){console.error(e)}if(e.sdkPath&&e.ndkPath)return{packageName:e.packageName||"",resizeableActivity:e.resizeableActivity??!0,maxAspectRatio:e.maxAspectRatio??"2.4",orientation:{landscapeRight:e.orientation.landscapeRight??!0,landscapeLeft:e.orientation.landscapeLeft??!0,portrait:e.orientation.portrait??!1,upsideDown:e.orientation.upsideDown??!1},apiLevel:e.apiLevel,appABIs:e.appABIs||[],useDebugKeystore:e.useDebugKeystore,keystorePath:e.keystorePath||"",keystorePassword:e.keystorePassword||"",keystoreAlias:e.keystoreAlias||"",keystoreAliasPassword:e.keystoreAliasPassword||"",isSoFileCompressed:e.isSoFileCompressed??!1,appBundle:e.appBundle??!0,androidInstant:e.androidInstant??!1,googleBilling:e.googleBilling??!0,playGames:e.playGames??!0,inputSDK:e.inputSDK??!1,remoteUrl:e.remoteUrl||"",sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",javaHome:e.javaHome||"",javaPath:e.javaPath||"",swappy:e.swappy||!1,adpf:e.adpf||!1,renderBackEnd:{vulkan:e.renderBackEnd?.vulkan??!0,gles3:e.renderBackEnd?.gles3??!0,gles2:e.renderBackEnd?.gles2??!0},customIcon:e.customIcon};throw new Error(Editor.I18n.t("googlePlay.tips.android_sdk_error"))}async function onAfterInit(a,e,o){var t=await generateOptions(a);const r=(a.packages["google-play"]=t).renderBackEnd;e.staticsInfo.B100005=t.packageName,e.staticsInfo.B100011=t.orientation;e=await(0,options_1.checkAndroidAPILevels)(t.apiLevel,a);e.error&&(console.error(e.error),e.newValue)&&(t.apiLevel=e.newValue),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:a.packages["google-play"].renderBackEnd.vulkan?100:0}),t.useDebugKeystore&&(t.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),t.keystoreAlias="debug_keystore",t.keystorePassword="123456",t.keystoreAliasPassword="123456"),Object.assign(a.cocosParams.platformParams,t),r&&Object.keys(r).forEach(e=>{a.cocosParams.cMakeConfig["CC_USE_"+e.toUpperCase()]=r[e]}),a.cocosParams.cMakeConfig.CC_ENABLE_SWAPPY=!!t.swappy,a.cocosParams.cMakeConfig.USE_ADPF=!!t.adpf,a.includeModules.includes("vendor-google")||(a.includeModules.push("vendor-google"),t.googleBilling&&(a.cocosParams.cMakeConfig.USE_GOOGLE_BILLING=!0),t.playGames&&(a.cocosParams.cMakeConfig.USE_GOOGLE_PLAY_GAMES=!0)),a.cocosParams.platformParams.customIconInfo=(0,customIcon_1.getCustomIconInfo)(t.customIcon,a.outputName)}function onAfterBundleInit(e){var a=e.packages["google-play"].renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=a.gles2??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl3=a.gles3??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl4=a.vulkan??!0}exports.throwError=!0;