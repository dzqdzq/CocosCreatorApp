"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),customIcon_1=require("./customIcon"),os_1=require("os");async function generateOptions(e){var e=e.packages["google-play"],a=(e.orientation=e.orientation||{},await Editor.Message.request("program","query-program-info","androidSDK")),o=await Editor.Message.request("program","query-program-info","androidNDK"),t=await Editor.Message.request("program","query-program-info","javaHome");if(e.sdkPath=e.sdkPath||(null==a?void 0:a.path)||"",e.ndkPath=e.ndkPath||(null==o?void 0:o.path)||"",e.javaHome=e.javaHome||(null==t?void 0:t.path)||"",e.javaPath="",e.javaHome)try{var r,n,s=(0,fs_extra_1.statSync)(e.javaHome);s.isFile()?(e.javaPath=e.javaHome,e.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(e.javaPath),".."))):s.isDirectory()&&(r="win32"===(0,os_1.platform)()?"java.exe":"java",n=(0,path_1.join)(e.javaHome,"bin",r),(0,fs_extra_1.existsSync)(n)?e.javaPath=n:console.error(`Java executable not found at ${e.javaHome}/bin`))}catch(e){console.error(e)}if(e.sdkPath&&e.ndkPath)return{packageName:e.packageName||"",resizeableActivity:null==(a=e.resizeableActivity)||a,maxAspectRatio:null!=(o=e.maxAspectRatio)?o:"2.4",orientation:{landscapeRight:null==(t=e.orientation.landscapeRight)||t,landscapeLeft:null==(s=e.orientation.landscapeLeft)||s,portrait:null!=(r=e.orientation.portrait)&&r,upsideDown:null!=(n=e.orientation.upsideDown)&&n},apiLevel:e.apiLevel,appABIs:e.appABIs||[],useDebugKeystore:e.useDebugKeystore,keystorePath:e.keystorePath||"",keystorePassword:e.keystorePassword||"",keystoreAlias:e.keystoreAlias||"",keystoreAliasPassword:e.keystoreAliasPassword||"",appBundle:null==(a=e.appBundle)||a,androidInstant:null!=(o=e.androidInstant)&&o,googleBilling:null==(t=e.googleBilling)||t,playGames:null==(s=e.playGames)||s,inputSDK:null!=(r=e.inputSDK)&&r,remoteUrl:e.remoteUrl||"",sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",javaHome:e.javaHome||"",javaPath:e.javaPath||"",swappy:e.swappy||!1,adpf:e.adpf||!1,renderBackEnd:{vulkan:null==(a=null==(n=e.renderBackEnd)?void 0:n.vulkan)||a,gles3:null==(t=null==(o=e.renderBackEnd)?void 0:o.gles3)||t,gles2:null==(r=null==(s=e.renderBackEnd)?void 0:s.gles2)||r},customIcon:e.customIcon};throw new Error(Editor.I18n.t("googlePlay.tips.android_sdk_error"))}async function onAfterInit(a,e,o){var t=await generateOptions(a);const r=(a.packages["google-play"]=t).renderBackEnd;e.staticsInfo.B100005=t.packageName,e.staticsInfo.B100011=t.orientation;e=await(0,options_1.checkAndroidAPILevels)(t.apiLevel,a);e.error&&(console.error(e.error),e.newValue)&&(t.apiLevel=e.newValue),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:a.packages["google-play"].renderBackEnd.vulkan?100:0}),t.useDebugKeystore&&(t.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),t.keystoreAlias="debug_keystore",t.keystorePassword="123456",t.keystoreAliasPassword="123456"),Object.assign(a.cocosParams.platformParams,t),r&&Object.keys(r).forEach(e=>{a.cocosParams.cMakeConfig["CC_USE_"+e.toUpperCase()]=r[e]}),a.cocosParams.cMakeConfig.CC_ENABLE_SWAPPY=!!t.swappy,a.cocosParams.cMakeConfig.USE_ADPF=!!t.adpf,a.includeModules.includes("vendor-google")||(a.includeModules.push("vendor-google"),t.googleBilling&&(a.cocosParams.cMakeConfig.USE_GOOGLE_BILLING=!0),t.playGames&&(a.cocosParams.cMakeConfig.USE_GOOGLE_PLAY_GAMES=!0)),a.cocosParams.platformParams.customIconInfo=(0,customIcon_1.getCustomIconInfo)(t.customIcon,a.outputName)}function onAfterBundleInit(e){var a,o=e.packages["google-play"].renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null==(a=o.gles2)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(a=o.gles3)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null==(a=o.vulkan)||a,e.buildScriptParam.platform="ANDROID"}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;