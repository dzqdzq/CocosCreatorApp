"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAPILevel=exports.ready=exports.update=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),customIcon_1=require("./customIcon"),lodash=require("lodash");let panel;exports.style=`
.set-androidSDK,
.new-keystore {
    margin-left: 4px;
}
.row {
    margin-bottom: 4px;
}

.custom-icon-container {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    align-items: center;
}
.custom-icon-container > .button-select-image {
    width: 100%;
}
.custom-icon-container > .display-icon-container {
    position: relative;
    height: 130px;
}
.custom-icon-container > .display-icon-container > ui-image {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    height: 120px;
    width: 120px;
}
`,exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../static/builder/view.html"),"utf8");const MaxAspectRatioList=[{label:"2.4 (12:5)",value:"2.4"},{label:"1.77 (16:9)",value:"16:9"},{label:"1.6 (16:10)",value:"16:10"},{label:"1.33 (4:3)",value:"4:3"}],parseAspectRationValue=e=>{var t;return e?(t=e.match(/^(\d+):(\d+)$/))?Number.parseInt(t[1],10)/Number.parseInt(t[2],10):Number.parseFloat(e):0},methods={t(e,t){return Editor.I18n.t("android."+e,t)},async onSetAndroidSDK(){Editor.Message.send("preferences","open-settings","program")},getDefaultPackageName(){return options_1.defaultOptions.packageName||"com.test.cocos"},onNewKeyStore(){Editor.Panel.open("certificate","android")},async onChangeDebugKeystore(e){const t=this;await t.onUpdateOptions("useDebugKeystore",e);var a=["keystorePath","keystorePassword","keystoreAlias","keystoreAliasPassword"];if(!0===e)a.forEach(e=>{t.pkgErrorMap[e]=null,t.emitChange(e,t.pkgOptions[e],null)});else for(const o of a)t.pkgErrorMap[o]=(await(0,options_1.verificationFunc)(o,t.pkgOptions[o],panel.options)).error,t.emitChange(o,t.pkgOptions[o],t.pkgErrorMap[o])},async onRenderBackEnd(e){var t=this,e=e.target.value;t.pkgOptions.renderBackEnd=e?Object.assign(t.pkgOptions.renderBackEnd,{gles3:!0}):Object.assign(t.pkgOptions.renderBackEnd,{gles2:!1,gles3:!1}),await t.onUpdateOptions("renderBackEnd",t.pkgOptions.renderBackEnd)},async onChange(e){var t=e.target.value,e=e.target.getAttribute("path");await this.onUpdateOptions(e,t)},async onUpdateOptions(e,t){var a,o;e&&(a=this,lodash.set(a.pkgOptions,e,t),panel.options.packages["google-play"]=a.pkgOptions,e.startsWith("renderBackEnd")&&(e="renderBackEnd",t=a.pkgOptions.renderBackEnd),"apiLevel"===e&&(t=Number(t)),o=await(0,options_1.verificationFunc)(e,t,panel.options),a.pkgErrorMap[e]=o.error,a.emitChange(e,t,o.error))},emitChange(e,t,a){panel.dispatch("update",`packages.${this.pkgName}.`+e,t,a)},async changeMaxAspectRatio(e){var t=this;let a=e.target.value;e=e.target.getAttribute("path");"maxAspectRatio"===e?a="custom"!==(t.maxAspectRatio=a)?a:t.customMaxAspectRatio:"customMaxAspectRatio"===e&&(t.customMaxAspectRatio=a),await t.onUpdateOptions("maxAspectRatio",a)},async onChangeABI(e,t){var a=this,e=e.target.value;Array.isArray(a.pkgOptions.appABIs)||(a.pkgOptions.appABIs=[]),e?a.pkgOptions.appABIs.push(t):a.pkgOptions.appABIs.splice(a.pkgOptions.appABIs.indexOf(t),1),await a.onUpdateOptions("appABIs",a.pkgOptions.appABIs)},async changeInstantValue(e){var t=this,a=((t.pkgOptions.androidInstant=e)?(a=await(0,options_1.verificationFunc)("remoteUrl",t.pkgOptions.remoteUrl,panel.options),t.pkgErrorMap.remoteUrl=a.error):t.pkgErrorMap.remoteUrl=null,await(0,options_1.verificationFunc)("apiLevel",t.pkgOptions.apiLevel,panel.options));t.pkgErrorMap.apiLevel=a.error,t.apiLevels.length||(t.pkgErrorMap.apiLevel="i18n:google-play.tips.apilevel_empty"),t.emitChange("androidInstant",e),t.emitChange("apiLevel",t.pkgOptions.apiLevel,t.pkgErrorMap.apiLevel),t.emitChange("remoteUrl",t.pkgOptions.remoteUrl,t.pkgErrorMap.remoteUrl)},updateDisplayCustomIcon(e){var t=this;t.displayCustomIcon=e||(0,customIcon_1.getDisplayCustomIcon)(t.pkgOptions.customIcon,t.outputName)},async changeCustomIconType(e){await this.onUpdateOptions("customIcon",e),this.updateDisplayCustomIcon()},async onSelectImage(e){var t=(await Editor.Dialog.select({type:"file",multi:!1,filters:[{extensions:["png"],name:"Image"}]})).filePaths[0];t&&(await(0,customIcon_1.saveCustomIcon)(t,"custom",this.outputName),await this.changeCustomIconType("custom"))},async init(){var e,t=this;t.pkgOptions=lodash.get(panel.options,"packages.google-play")||{},t.apiLevels=await getAndroidAPILevels(),t.pkgOptions.apiLevel=t.pkgOptions.apiLevel||t.apiLevels[0],t.pkgOptions.resizeableActivity=null==(e=t.pkgOptions.resizeableActivity)||e;for(const o of Object.keys(options_1.defaultOptions)){var a=await(0,options_1.verificationFunc)(o,t.pkgOptions[o],panel.options);t.pkgErrorMap[o]=a.error}t.apiLevels.length||(t.pkgErrorMap.apiLevel="i18n:google-play.tips.apilevel_empty"),panel.dispatch("update","packages."+t.pkgName,t.pkgOptions,t.pkgErrorMap)}};async function update(e,t){(panel=this).options=e,"packages.native.JobSystem"===t?(panel.options.packages.native.JobSystem=e.packages.native.JobSystem,panel.vm.onUpdateOptions("apiLevel",e.packages["google-play"].apiLevel)):t&&!t.startsWith("packages."+panel.pkgName)||(panel.options=e,panel.vm.init())}function ready(e,t,a,o){panel=this;var p=require("vue/dist/vue.js");panel.options=e,panel.pkgName=a,panel.errorMap=o,panel.vm=new p({el:panel.$.root,data(){return{pkgName:a,type:t,pkgOptions:options_1.defaultOptions,pkgErrorMap:options_1.defaultOptions,apiLevels:[],appABIList:["armeabi-v7a","arm64-v8a","x86","x86_64"],maxAspectRatioOptions:MaxAspectRatioList,maxAspectRatio:"",customMaxAspectRatio:"",outputName:e.outputName,displayCustomIcon:""}},async mounted(){var e=this;"check"===e.type?(e.pkgOptions=lodash.get(panel.options,"packages.android")||{},e.apiLevels=e.pkgOptions.apiLevel&&[e.pkgOptions.apiLevel],e.pkgErrorMap={}):(e.init(),e.updateDisplayCustomIcon(),initMaxAspectRatio(e))},methods:methods})}function initMaxAspectRatio(t){var e=t.pkgOptions.maxAspectRatio;if(void 0!==e){const o=parseAspectRationValue(e);var a=MaxAspectRatioList.filter(e=>parseAspectRationValue(e.value)===o);t.maxAspectRatio=a.length?a[0].value:"custom"}else t.maxAspectRatio=MaxAspectRatioList[0].value;if("custom"===t.maxAspectRatio&&e){a=e.match(/^(\d+):(\d+)$/);if(a){const p=Number.parseInt(a[1]),s=Number.parseInt(a[2]);t.$nextTick(()=>{var e=`${(p/s).toFixed(2)} (${p}:${s})`;t.customMaxAspectRatio=e})}else t.customMaxAspectRatio=e}}exports.$={root:".google-play"},exports.update=update,exports.ready=ready;const MIN_COMPILE_LEVEL=19;async function getAndroidAPILevels(){var e=await Editor.Message.request("program","query-program-info","androidSDK");if(!e||!e.path||!(0,fs_extra_1.existsSync)(e.path))return[];const o=(0,path_1.join)(e.path,"platforms");return(0,fs_extra_1.existsSync)(o)?(0,fs_extra_1.readdirSync)(o).filter(e=>{var t=getAPILevel(e),a=(0,fs_extra_1.statSync)((0,path_1.join)(o,e));return!!/^android-/.test(e)&&!!(t>=MIN_COMPILE_LEVEL&&a.isDirectory())}).map(e=>parseInt(e.split("-")[1])):[]}function getAPILevel(e){e=(e=e||"").match("android-([0-9]+)$");let t=-1;return t=e?parseInt(e[1]):t}exports.getAPILevel=getAPILevel;