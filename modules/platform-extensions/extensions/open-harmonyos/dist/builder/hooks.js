"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function generateOptions(t){var e,n,r,a,o,i;const s=t.packages["open-harmonyos"];if(s.orientation=s.orientation||{},s.sdkPath=await Editor.Profile.getConfig("program","ohos_sdk")||"",s.ndkPath=await Editor.Profile.getConfig("program","ohos_ndk")||"",!s.sdkPath||!s.ndkPath)throw new Error(Editor.I18n.t("ohos.tips.ohos_sdk_error"));return{packageName:s.packageName||"",orientation:{landscapeRight:null===(e=s.orientation.landscapeRight)||void 0===e||e,landscapeLeft:null===(n=s.orientation.landscapeLeft)||void 0===n||n,portrait:null!==(r=s.orientation.portrait)&&void 0!==r&&r,upsideDown:null!==(a=s.orientation.upsideDown)&&void 0!==a&&a},apiLevel:s.apiLevel||"7",sdkPath:s.sdkPath||"",ndkPath:s.ndkPath||"",renderBackEnd:{gles3:null===(i=null===(o=s.renderBackEnd)||void 0===o?void 0:o.gles3)||void 0===i||i}}}async function onAfterInit(t,e,n){var r;fs_extra_1.emptyDirSync(e.paths.dir);const a=await generateOptions(t);t.packages["open-harmonyos"]=a;const o=a.renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(r=o.gles3)||void 0===r||r;const i={packageName:a.packageName,orientation:a.orientation};let s;n.__addStaticsInfo(i),t.assetSerializeOptions.exportCCON=!0,t.assetSerializeOptions.allowCCONExtension=!0,Object.assign(t.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const{nativePath:c}=await Editor.Message.request("engine","query-info"),l=await getBrowserslistQuery(c);l&&(s=l),s&&(t.buildEngineParam.targets=s,t.buildScriptParam.targets=s),t.buildScriptParam.system={preset:"commonjs-like"},await fs_extra_1.emptyDirSync(e.paths.dir)}async function getBrowserslistQuery(t){const e=path_1.join(t,".browserslistrc");let n;try{n=await fs_extra_1.readFile(e,"utf8")}catch(t){return}const r=function(t){const e=[];for(const n of t.split("\n")){const t=n.indexOf("#"),r=(t<0?n:n.substr(0,t)).trim();0!==r.length&&e.push(r)}return e}(n);if(0!==r.length)return r.join(" or ")}exports.throwError=!0,exports.onAfterInit=onAfterInit;