"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function generateOptions(t){var e,r,a,n,o,i;const s=t.packages["open-harmonyos"];s.orientation=s.orientation||{};const p=await Editor.Message.request("program","query-program-info","ohosSDK"),c=await Editor.Message.request("program","query-program-info","ohosNDK");if(s.sdkPath=p?p.path:"",s.ndkPath=c?c.path:"",!s.sdkPath||!s.ndkPath)throw new Error(Editor.I18n.t("ohos.tips.ohos_sdk_error"));return{packageName:s.packageName||"",orientation:{landscapeRight:null===(e=s.orientation.landscapeRight)||void 0===e||e,landscapeLeft:null===(r=s.orientation.landscapeLeft)||void 0===r||r,portrait:null!==(a=s.orientation.portrait)&&void 0!==a&&a,upsideDown:null!==(n=s.orientation.upsideDown)&&void 0!==n&&n},apiLevel:s.apiLevel||"7",sdkPath:s.sdkPath||"",ndkPath:s.ndkPath||"",renderBackEnd:{gles3:null===(i=null===(o=s.renderBackEnd)||void 0===o?void 0:o.gles3)||void 0===i||i}}}async function onAfterInit(t,e,r){var a;fs_extra_1.emptyDirSync(e.paths.dir);const n=await generateOptions(t);t.packages["open-harmonyos"]=n;const o=n.renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(a=o.gles3)||void 0===a||a;const i={packageName:n.packageName,orientation:n.orientation};let s;r.__addStaticsInfo(i),t.assetSerializeOptions.exportCCON=!0,t.assetSerializeOptions.allowCCONExtension=!0,Object.assign(t.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const{native:{path:p}}=await Editor.Message.request("engine","query-engine-info"),c=await getBrowserslistQuery(p);c&&(s=c),s&&(t.buildEngineParam.targets=s,t.buildScriptParam.targets=s),t.buildScriptParam.system={preset:"commonjs-like"},await fs_extra_1.emptyDirSync(e.paths.dir)}async function getBrowserslistQuery(t){const e=path_1.join(t,".browserslistrc");let r;try{r=await fs_extra_1.readFile(e,"utf8")}catch(t){return}const a=function(t){const e=[];for(const r of t.split("\n")){const t=r.indexOf("#"),a=(t<0?r:r.substr(0,t)).trim();0!==a.length&&e.push(a)}return e}(r);if(0!==a.length)return a.join(" or ")}exports.throwError=!0,exports.onAfterInit=onAfterInit;