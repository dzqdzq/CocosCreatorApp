"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){const s=e.packages["baidu-mini-game"];-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.moveRemoteBundleScript=!0;let i=s.remoteServerAddress||"";i&&!i.endsWith("/")&&(i+="/"),Object.assign(e.appTemplateData,{showFPS:!1,server:i}),Object.assign(e.buildEngineParam,{platform:"BAIDU"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"};const r=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),o=path_1.join(Editor.Project.tmpDir,"builder/baidu-mini-game",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(r)&&(fs_extra_1.existsSync(o)&&fs_extra_1.removeSync(o),fs_extra_1.copySync(r,o));const n={orientation:s.orientation,appid:s.appid,remoteServerAddress:s.remoteServerAddress};if(a.__addStaticsInfo(n),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(o))fs_extra_1.moveSync(o,r);else if(s.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-info")).path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,r)}}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(sortSubPackage(e,t,a),await buildAdapters(t.paths.dir))}async function onAfterBuild(e,t,a){const s=await Build.Utils.getModuleFiles(t);await Promise.all(s.map(attachSystemGlobal)),await copyResFiles(e,t)}function sortSubPackage(e,t,a){for(const e of t.bundles)fs_extra_1.existsSync(e.scriptDest)?attachSystemGlobal(e.scriptDest):fs_extra_1.outputFileSync(e.scriptDest,"")}async function buildAdapters(e){const t=(await Editor.Message.request("engine","query-info")).path,a=path_1.join(t,"platforms/minigame"),s=await globby(path_1.join(a,"common/**/*"),{nodir:!0});await Promise.all(s.map(t=>{let s=fs_extra_1.readFileSync(t,"utf8");s=compileJS(s,t);const i=path_1.relative(a,t),r=path_1.join(e,"libs",i);fs_extra_1.outputFileSync(r,s,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)});const i=await globby(path_1.join(a,"platforms/baidu/wrapper/**/*"),{nodir:!0});await Promise.all(i.map(t=>{let s=fs_extra_1.readFileSync(t,"utf8");s=compileJS(s,t);const i=path_1.relative(path_1.join(a,"platforms/baidu/"),t),r=path_1.join(e,"libs",i);fs_extra_1.outputFileSync(r,s,"utf8")})).catch(e=>{e.stack=`BuildBaiduLibTemplate error: ${e.stack}`,console.error(e)})}async function copyResFiles(e,t){e.packages["baidu-mini-game"];const a=e.buildEngineParam.engineName,s=path_1.join(templateDir,"build-template"),i=path_1.join(s,"game.ejs"),r={engineName:a,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},o=await ejs_1.default.renderFile(i,r);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),o,"utf8");const n=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(n)&&(fs_extra_1.copySync(n,t.paths.dir),console.debug(`Use build-template {link(${n})}.`)),buildGameJson(s,t.paths.dir,e,t,n),buildProjectJson(s,t.paths.dir,e,n)}function buildGameJson(e,t,a,s,i){const r=a.packages["baidu-mini-game"],o=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));o.deviceOrientation=r.orientation,r.buildOpenDataContextTemplate?o.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete o.openDataContext;const n=[];for(const e of s.bundles)e.isSubpackage&&n.push({name:e.name,root:`subpackages/${e.name}/`});n.length>0&&(o.subpackages=n);const p=path_1.join(i,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(o,e)}const l=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(l,o,{spaces:4})}function buildProjectJson(e,t,a,s){const i=fs_extra_1.readJSONSync(path_1.join(e,"project.swan.json"));i.appid=a.packages["baidu-mini-game"].appid||"testappid",i.projectname=a.name;const r=path_1.join(t,"project.swan.json"),o=path_1.join(s,"project.swan.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(i,e)}fs_extra_1.outputJSONSync(r,i)}function compileJS(e,t){let a;try{a=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[[require("@babel/preset-env"),{loose:!0}]],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return a.code}function attachSystemGlobal(e){if(!fs_extra_1.existsSync(e)||fs_extra_1.statSync(e).isDirectory())return;fs_extra_1.writeFileSync(e,"var System=window.System;"+fs_extra_1.readFileSync(e,"utf8"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;