"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1);const s=e.packages["baidu-mini-game"];-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.moveRemoteBundleScript=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{platform:"BAIDU"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"};const i=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),n=path_1.join(Editor.Project.tmpDir,"builder/baidu-mini-game",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(i)&&(fs_extra_1.existsSync(n)&&fs_extra_1.removeSync(n),fs_extra_1.copySync(i,n));const r={orientation:s.orientation,appid:s.appid,remoteServerAddress:e.server};if(a.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(n))fs_extra_1.moveSync(n,i);else if(s.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,i)}}async function onBeforeCompressSettings(e,t,a){if(!t.paths.dir)return;sortSubPackage(e,t,a);const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/baidu",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/baidu",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"))}async function onAfterBuild(e,t,a){const s=await Build.Utils.getModuleFiles(t);await Promise.all(s.map(attachSystemGlobal)),await copyResFiles(e,t)}function sortSubPackage(e,t,a){for(const e of t.bundles)fs_extra_1.existsSync(e.scriptDest)?attachSystemGlobal(e.scriptDest):fs_extra_1.outputFileSync(e.scriptDest,"")}async function copyResFiles(e,t){e.packages["baidu-mini-game"];const a=e.buildEngineParam.engineName,s=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=path_1.join(s,"templates/baidu-mini-game"),n=path_1.join(i,"game.ejs"),r={engineName:a,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},o=await ejs_1.default.renderFile(n,r);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),o,"utf8");const p=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(p)&&(fs_extra_1.copySync(p,t.paths.dir),console.debug(`Use build-template {link(${p})}.`)),buildGameJson(i,t.paths.dir,e,t,p),buildProjectJson(i,t.paths.dir,e,p)}function buildGameJson(e,t,a,s,i){const n=a.packages["baidu-mini-game"],r=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));r.deviceOrientation=n.orientation,n.buildOpenDataContextTemplate?r.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete r.openDataContext;const o=[];for(const e of s.bundles)e.isSubpackage&&o.push({name:e.name,root:`subpackages/${e.name}/`});o.length>0&&(r.subpackages=o);const p=path_1.join(i,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(r,e)}const c=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(c,r,{spaces:4})}function buildProjectJson(e,t,a,s){const i=fs_extra_1.readJSONSync(path_1.join(e,"project.swan.json"));i.appid=a.packages["baidu-mini-game"].appid||"testappid",i.projectname=a.name;const n=path_1.join(t,"project.swan.json"),r=path_1.join(s,"project.swan.json");if(fs_extra_1.existsSync(r)){const e=fs_extra_1.readJSONSync(r);Object.assign(i,e)}fs_extra_1.outputJSONSync(n,i)}function attachSystemGlobal(e){if(!fs_extra_1.existsSync(e)||fs_extra_1.statSync(e).isDirectory())return;fs_extra_1.writeFileSync(e,"var System=window.System;"+fs_extra_1.readFileSync(e,"utf8"))}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;