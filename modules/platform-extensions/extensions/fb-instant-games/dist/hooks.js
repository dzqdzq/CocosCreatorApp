"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,s)}:function(e,t,n,i){e[i=void 0===i?n:i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var s=function(e){return(s=Object.getOwnPropertyNames||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=s(e),i=0;i<n.length;i++)"default"!==n[i]&&__createBinding(t,e,n[i]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterBuild=onAfterBuild;const ejs_1=__importDefault(require("ejs")),fs_extra_1=__importStar(require("fs-extra")),path_1=require("path"),JsZip_1=require("./utils/JsZip"),remote_1=require("@electron/remote");async function onAfterInit(e,t,n){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"fb-instant-games",value:{orientation:e.packages["fb-instant-games"].orientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!1,e.buildEngineParam.assetURLFormat="runtime-resolved";e=e.packages["fb-instant-games"];t.staticsInfo.B100011=e.orientation}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"}}async function onBeforeCompressSettings(e,t,n){t.paths.dir&&(e=e.packages["fb-instant-games"],t.settings.screen.orientation=e.orientation)}async function onBeforeCopyBuildTemplate(e,t){var n=e.packages["fb-instant-games"],i=e.engineInfo.typescript.path,i=(0,path_1.join)(i,"templates/fb-instant-games"),s=this.buildTemplate.initUrl("index.js.ejs","indexEjs")||(0,path_1.join)(i,"index.js.ejs"),s=await ejs_1.default.renderFile(s,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),s=await Build.Utils.transformCode(s,{importMapFormat:"systemjs"});if(!s)throw new Error("Unable to generate index.js");var r=(0,path_1.join)(t.paths.dir,"index.js"),s=((0,fs_extra_1.outputFileSync)(r,s,"utf-8"),e.md5CacheOptions.includes.push("index.js"),(0,path_1.join)(t.paths.dir,"style.css"));e.md5CacheOptions.includes.push("style.css"),this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"style.css"),s);let a="";n.embedWebDebugger&&(n=(0,path_1.join)(t.paths.dir,"vconsole.min.js"),e.md5CacheOptions.excludes.push("vconsole.min.js"),this.buildTemplate.findFile("vconsole.min.js")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"vconsole.min.js"),n),a="./vconsole.min.js");n=(0,fs_extra_1.readJSONSync)((0,path_1.join)(i,"fbapp-config.json")),n&&n.instant_games&&(n.instant_games.orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),n.instant_games.override_web_orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),(0,fs_extra_1.writeJsonSync)((0,path_1.join)(t.paths.dir,"fbapp-config.json"),n),e.md5CacheOptions.excludes.push("fbapp-config.json")),n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:a,cocosTemplate:(0,path_1.join)(i,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(r),cssUrl:(0,path_1.basename)(s)},r=this.buildTemplate.initUrl("index.ejs","index")||(0,path_1.join)(i,"index.ejs"),s=await ejs_1.default.renderFile(r,n);(0,path_1.join)(t.paths.dir,"index.html");(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"index.html"),s,"utf8"),e.md5CacheOptions.replaceOnly.push("index.html")}async function onAfterBuild(e,n){n.settings.plugins.jsList.forEach((e,t)=>{n.settings.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")}),(0,fs_extra_1.outputFileSync)(n.paths.settings,JSON.stringify(n.settings,null,e.debug?4:0));const t=(0,path_1.join)(n.paths.dir,e.name.concat(".zip"));await _generate_zip(n.paths.dir,t).then(function(){remote_1.shell.showItemInFolder(t)}).catch(function(e){console.error(`Zip failed, error: ${e}.`)})}async function _generate_zip(e,t,n=[]){const i=new JsZip_1.JsZip;i.directory(e,(0,path_1.basename)(e));for(const r of n)i.remove(r);const s=fs_extra_1.default.createWriteStream(t);return new Promise(e=>{i.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(s).on("finish",()=>{e()})})}exports.throwError=!0;