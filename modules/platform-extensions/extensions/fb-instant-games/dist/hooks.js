"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,a)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleDataTask=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=__importStar(require("fs-extra")),path_1=require("path"),JsZip_1=require("./utils/JsZip"),electron_1=require("electron");async function onAfterInit(e,t,n){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"fb-instant-games",value:{orientation:e.packages["fb-instant-games"].orientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!1,e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved";const i=e.packages["fb-instant-games"];t.staticsInfo.B100011=i.orientation}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"},e.buildScriptParam.platform="HTML5"}async function onAfterBundleDataTask(e,t,n){t.forEach(e=>{for(const t of e.pluginScript){const i=n.getAssetInfo(t);i.meta.userData.isPlugin&&!i.meta.userData.loadPluginInWeb&&e.pluginScript.delete(t)}})}async function onBeforeCompressSettings(e,t,n){if(!t.paths.dir)return;const i=e.packages["fb-instant-games"];t.settings.screen.orientation=i.orientation,t.settings.plugins.jsList.forEach((e,n)=>{t.settings.plugins.jsList[n]=e.split("/").map(encodeURIComponent).join("/")})}async function onAfterBuild(e,t){const n=e.packages["fb-instant-games"],i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,a=(0,path_1.join)(i,"templates/fb-instant-games"),s=await ejs_1.default.renderFile((0,path_1.join)(a,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),r=await Build.Utils.transformCode(s,{importMapFormat:"systemjs"});if(!r)throw new Error("Unable to generate index.js");let o="";e.md5Cache&&(o="."+Build.Utils.calcMd5(r));const l=(0,path_1.join)(t.paths.dir,`index${o}.js`);(0,fs_extra_1.outputFileSync)(l,r,"utf-8");let p=(0,path_1.join)(t.paths.dir,"style.css");if((0,fs_extra_1.copyFileSync)((0,path_1.join)(a,"style.css"),p),e.md5Cache){p=(await Build.Utils.appendMd5ToPaths([p])).paths[0]}const c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(a,"fbapp-config.json"));c&&c.instant_games&&(c.instant_games.orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),c.instant_games.override_web_orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),(0,fs_extra_1.writeJsonSync)((0,path_1.join)(t.paths.dir,"fbapp-config.json"),c));const u={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:"",cocosTemplate:(0,path_1.join)(a,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(l),cssUrl:(0,path_1.basename)(p)};if(n.embedWebDebugger){u.webDebuggerSrc="./vconsole.min.js";try{(0,fs_extra_1.copySync)((0,path_1.join)(a,"vconsole.min.js"),(0,path_1.join)(t.paths.dir,"vconsole.min.js"))}catch(e){console.warn("Copy vconsole failed.")}}let f=!0,d=(0,path_1.join)(Build.buildTemplateDir,e.platform,"index.ejs");(0,fs_extra_1.existsSync)(d)||(d=(0,path_1.join)(a,"index.ejs"),f=!1);const _=await ejs_1.default.renderFile(d,u);(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"index.html"),_,"utf8");const m=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(m)&&((0,fs_extra_1.copySync)(m,t.paths.dir),console.debug(`Use build-template {link(${m})}.`)),f&&(0,fs_extra_1.removeSync)((0,path_1.join)(t.paths.dir,"index.ejs"));const h=(0,path_1.join)(t.paths.dir,e.name.concat(".zip"));await _generate_zip(t.paths.dir,h).then(function(){electron_1.shell.showItemInFolder(h)}).catch(function(e){console.error(`Zip failed, error: ${e}.`)})}async function _generate_zip(e,t,n=[]){const i=new JsZip_1.JsZip;i.directory(e,(0,path_1.basename)(e));for(const e of n)i.remove(e);const a=fs_extra_1.default.createWriteStream(t);return new Promise(e=>{i.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(a).on("finish",()=>{e()})})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;