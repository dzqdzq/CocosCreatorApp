"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=__importStar(require("fs-extra")),path_1=require("path"),JsZip_1=require("./utils/JsZip"),electron_1=require("electron");async function onAfterInit(e,t,s){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"fb-instant-games",value:{orientation:e.packages["fb-instant-games"].orientation}}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildScriptParam.system={preset:"web"},e.buildEngineParam.split=!1,e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved";const i={orientation:e.packages["fb-instant-games"].orientation};s.__addStaticsInfo(i)}async function onBeforeBuildAssets(e,t,s){for(const e of s.scriptUuids){const i=s.getAssetInfo(e),n=await s.getMeta(e);i?n?n.userData.isPlugin&&n.userData.loadPluginInWeb&&t.addPlugin(i):console.error(`Get meta of script {asset(${i.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onBeforeCompressSettings(e,t,s){if(!t.paths.dir)return;const i=e.packages["fb-instant-games"];t.settings.screen.orientation=i.orientation,t.settings.plugins.jsList.forEach((e,s)=>{t.settings.plugins.jsList[s]=e.split("/").map(encodeURIComponent).join("/")})}async function onAfterBuild(e,t){const s=e.packages["fb-instant-games"],i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,n=path_1.join(i,"templates/fb-instant-games"),a=await ejs_1.default.renderFile(path_1.join(n,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),r=await Build.Utils.transformCode(a,{importMapFormat:"systemjs"});if(!r)throw new Error("Unable to generate index.js");let o="";e.md5Cache&&(o="."+Build.Utils.calcMd5(r));const l=path_1.join(t.paths.dir,`index${o}.js`);fs_extra_1.outputFileSync(l,r,"utf-8");let p=path_1.join(t.paths.dir,"style.css");if(fs_extra_1.copyFileSync(path_1.join(n,"style.css"),p),e.md5Cache){p=(await Build.Utils.appendMd5ToPaths([p])).paths[0]}const c=fs_extra_1.readJSONSync(path_1.join(n,"fbapp-config.json"));c&&c.instant_games&&(c.instant_games.orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),c.instant_games.override_web_orientation=e.packages["fb-instant-games"].orientation.toUpperCase(),fs_extra_1.writeJsonSync(path_1.join(t.paths.dir,"fbapp-config.json"),c));const f={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:"",cocosTemplate:path_1.join(n,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:path_1.basename(l),cssUrl:path_1.basename(p)};if(s.embedWebDebugger){f.webDebuggerSrc="./vconsole.min.js";try{fs_extra_1.copySync(path_1.join(n,"vconsole.min.js"),path_1.join(t.paths.dir,"vconsole.min.js"))}catch(e){console.warn("Copy vconsole failed.")}}let d=!0,u=path_1.join(Build.buildTemplateDir,e.platform,"index.ejs");fs_extra_1.existsSync(u)||(u=path_1.join(n,"index.ejs"),d=!1);const _=await ejs_1.default.renderFile(u,f);fs_extra_1.outputFileSync(path_1.join(t.paths.dir,"index.html"),_,"utf8");const m=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(m)&&(fs_extra_1.copySync(m,t.paths.dir),console.debug(`Use build-template {link(${m})}.`)),d&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"index.ejs"));const h=path_1.join(t.paths.dir,e.name.concat(".zip"));await _generate_zip(t.paths.dir,h).then(function(){electron_1.shell.showItemInFolder(h)}).catch(function(e){console.error(`Zip failed, error: ${e}.`)})}async function _generate_zip(e,t,s=[]){const i=new JsZip_1.JsZip;i.directory(e,path_1.basename(e));for(const e of s)i.remove(e);const n=fs_extra_1.default.createWriteStream(t);return new Promise(e=>{i.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(n).on("finish",()=>{e()})})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;