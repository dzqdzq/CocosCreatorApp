const axios=require("axios"),fs=require("fs"),FormData=require("form-data"),crypto=require("crypto"),promisify=require("util")["promisify"],Buffer=require("buffer")["Buffer"],{outputJSON,readJSON}=require("fs-extra"),join=require("path")["join"],privateKey="-----BEGIN RSA PRIVATE KEY-----\nMIIEpQIBAAKCAQEA0tiW47ObZTzer7I1JLKVLBSm3Yk0r/8iozAoxd7RmBWkSqqc6bKdT6+AcFU1vO7oHoI66iRqBtlHjYOisrEp17FfYy6baFCvDy2PIyzWW7hr1Pj+F4ScqU51yLw7Gt8joJvjaRqVCafHYdbruKyZUtBfMunKMWuFXfUANY7FlXSsF1nDlajN/RNlLzUXD38WhWzDkdEpP9VdNHYiOgqeFnmXGg5RjR7bhZr2b2efDtkHojlLTa05PSSsSLpoecsVhQftZmhfz4pkxdeqj2LVuNuuJ1XK9s1Dd3C1OFrF/6WIC04A91XMOx52tIodI3GaI70sB+Qx8XXWBTb4h98uuQIDAQABAoIBAQDNRu3xFuaONCsi p8Ax0GSHnDuxqGnRh/bzJmor63noNfnUcDOBG9Mox9emhm9hWMBJI8W0PGu160lMsAJxMydnxlr2N2Q6tYMapeKb/oVcmzrxCNJpl0TnWWo3W3u399O6BMvtgmHkGqN10EeDbxd/lzt4WEHwx5v7FBN2EWCw1jbMEFnlU+VZ7x90b6n22alJDwC21GG7v6bLa4kadDNJsHgXy3jfz5bDFhGjqVfYPSa8KG50AlLpah9fQTLdtM+ZQ0KCQrf1stoQ32J/1GCxB9nO7qwwgWBd+qpgkonZTeAlhmsXm9rJEOTCoFtDRW0I60j/t8qPnY9vanIzjDgBAoGBAPzRt+qZkwAWGWvxfdCsZ3iu5c371XhRPnYos9NdagdMelY5NjLU7ZEk5zMKwI3JZQa/b9pTEXCoJP9WYE/gcUQhIxQBSIV3AkjjibSK9AGCNd5A+pO3HKnWmYGFCF6HKbEj/SBxhG1bzuRlw2YFHZ4nAY+yI+lOwGHsVGQfJXs5AoGBANV/rv/nalRuQ8BuPhcKoCZedUQ/vcoML4XiFFCF3PLy5/Ogh/AyhYDmevrwSbbnLexSg0xaqiKl6Oxn0VZJUUp1/k2jJcQVrYLgluuxcysD09YVXGIDglgrHqIP4wZecigEDomYWamCyJxxwf9YznuAGQe6fkpjI75dznTNIc+BAoGAcw72xrvx3L4x/6A+BDQSOyhNybrs4f8HkDrh7DW9RWkW3BrZgbTKEZ5b4izoiR647aM+Qnw/mafMfrBO0MtygPEbx8T1vlf1IDr9tr7uYali3q1v3L4fO2RBJGLo9ixJWybn0lYXULXRqLxvewSlAA78dOs70LhYcbheh9ps8nECgYEAiPxOCsAvB1Fgg1241QvqSfQdhdboLXW4IE04/5mEdRXKIhWEY2fnJRe9HLmEcqjOXG1s9VbPB0AwvU63kIemcwJWUvY1SyUlmW4FJ+FJpfXku94k0nax8WRpWU6cOf/reyVvNnXcQdk6YrbS5MXUZoWAiebtFUmbK5AA4gykfwECgYEA2fkKkWhoOahK0c17t2714a/mANAWaXdmg7sgA4XkqzpZVEwAEtdt4NY8MfflTzRUbQK6p619FknFvr2K89pPdOWcY7/tRfy+EY4lwQ9+3eBXvbcc9OZy8K2IqKBFpwaDVraHR8DOrAPeJia1CBNeLDC2cNZ8pFWjPIdCRfgi8vo=\n-----END RSA PRIVATE KEY-----";function generateSignature(e,a,r,t){e=[e,a,t,r];const o=crypto.createHash("sha256");e.forEach(e=>{o.update(e+`
`)});a=o.digest("base64"),t=crypto.createSign("RSA-SHA256"),t.update(Buffer.from(a)),r=t.sign({key:privateKey,padding:crypto.constants.RSA_PKCS1_PADDING},"base64");return r}async function calculateMD5(e){const a=crypto.createHash("md5");e=fs.createReadStream(e);return e.on("data",e=>{a.update(e)}),await promisify(require("stream").pipeline)(e,async()=>{}),a.digest("hex")}async function uploadZipFile(e,a,r,t){if(!fs.existsSync(e))throw new Error("文件不存在: "+e);var o=await calculateMD5(e),n=Date.now(),i=generateSignature(a,r,n.toString(),o),s=new FormData;s.append("app_id",a),s.append("version",r),s.append("source",fs.createReadStream(e)),s.append("source_md5",o);try{var p=await axios.post(t,s,{headers:{...s.getHeaders(),"x-signature":i,"x-timestamp":n.toString()}});if(0===p.data.error)return console.log("上传成功: "+(new Date).toLocaleString()),await outputJSON(join(__dirname,"../dist/uploadInfo.json"),{appID:a,version:r,signature:i,timestamp:n}),{appID:a,version:r,signature:i,timestamp:n};console.error("上传失败:",p.data)}catch(e){console.error("上传失败:",e.response?e.response.data:e.message)}}async function checkPluginCompileState(e){var{appID:e,version:a,timestamp:r,signature:t}=e=e||await readJSON(join(__dirname,"../dist/uploadInfo.json")),o=new FormData;o.append("app_id",e),o.append("version",a);try{var n=await axios.get("https://developer.toutiao.com/v1/game_plugin_compile_progress",o,{headers:{...o.getHeaders(),"x-signature":t,"x-timestamp":r.toString()}});if(0===n.data.error)return console.log("编译成功: "+(new Date).toLocaleString()),!0;console.error("编译失败:",n.data)}catch(e){console.error("编译失败:",e.response?e.response.data:e.message)}}module.exports={uploadZipFile:uploadZipFile,checkPluginCompileState:checkPluginCompileState};