"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),child_process_1=require("child_process"),ejs_1=__importDefault(require("ejs")),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,s){e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{moduleStyle:"cjs"});const n=e.packages["bytedance-mini-game"],a=(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),i=(0,path_1.join)(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);if((0,fs_extra_1.existsSync)(a)&&((0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.removeSync)(i),(0,fs_extra_1.copySync)(a,i)),t.staticsInfo.B100011=n.orientation,t.staticsInfo.B100013=n.appid,(0,fs_extra_1.existsSync)(i))(0,fs_extra_1.moveSync)(i,a);else if(n.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=(0,path_1.join)(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.copySync)(t,a)}e.buildScriptParam.flags.WASM_SUBPACKAGE=n.wasmSubpackage}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1);const t=e.packages["bytedance-mini-game"];if(-1!==e.includeModules.indexOf("gfx-webgl2")&&e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),e.assetSerializeOptions.exportCCON=!0,"physX"===t.physX.use){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t&&e.includeModules.splice(t,1,"physics-physx")}e.includeModules.includes("physics-physx")&&!t.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),delete t.physX.use,Object.assign(e.physicsConfig,{physX:t.physX}),e.moveRemoteBundleScript=!0,e.includeModules=Array.from(new Set(e.includeModules)),e.buildScriptParam.platform="BYTEDANCE",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!t.physX.notPackPhysXLibs}async function onAfterBundleBuildTask(e,t,s){const n=[];t.forEach(e=>{if(!e.isSubpackage)return;const t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js");(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,n.push({name:e.name,root:`subpackages/${e.name}/`})}),n.length&&(e.packages["bytedance-mini-game"].subpackages=n)}async function onBeforeCompressSettings(e,t){if(!t.paths.dir)return;const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await(0,fs_extra_1.copy)((0,path_1.join)(s,"bin/adapter/minigame/bytedance",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(s,"bin/adapter/minigame/bytedance",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js"))}async function onAfterBuild(e,t,s,n){const a=(0,path_1.join)(t.paths.dir,`src/${e.buildScriptParam.outputName}`);(0,fs_extra_1.existsSync)(a)||(0,fs_extra_1.outputFileSync)(a,"console.log('There is no script in project.')","utf-8"),await copyResFiles(e,t,n)}async function run(e,t){const s=await Editor.Message.request("program","query-program-info","bytedanceDevtools"),n=s?s.path:"";if(!n||!(0,fs_extra_1.existsSync)(n)){return console.warn(Editor.I18n.t("bytedance-mini-game.tips.bytedance_app_path_empty")),1===(await Editor.Dialog.warn(Editor.I18n.t("bytedance-mini-game.tips.bytedance_app_path_empty"),{buttons:[Editor.I18n.t("bytedance-mini-game.tips.cancel"),Editor.I18n.t("bytedance-mini-game.tips.setDevTools")]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}if(!(0,fs_extra_1.existsSync)(n))return await Editor.Dialog.error(Editor.I18n.t("bytedance-mini-game.tips.client_path_error")),!1;let a,i="",o="";const r={path:`"${e}"`,"project-type":"microgame",mode:handleLaunchMethod(t.packages["bytedance-mini-game"].devToolsLaunchMethod,n)};"darwin"===process.platform?(i=`${a="open"} "${n}" --args ${mapToCommandArgs(r)}`,o=`${a} bytedanceide:?${mapToCommandArgs(r,"&",!1)}`):(i=`${a="start"} "" "${n}" ${mapToCommandArgs(r)}`,o=`${a} "" bytedanceide:?${mapToCommandArgs(r,"^&",!1)}`),console.log(`Run command: ${i} && ${o}`);const p=(0,child_process_1.exec)(`${i} && ${o}`);p&&p.stdout&&p.stdout.on("data",function(e){console.log(`[Douyin IDE] ${e.toString()}`)}),p&&p.stderr&&p.stderr.on("data",function(e){console.error(`[Douyin IDE stderr] ${e.toString()}`)}),p.on("close",e=>{p.kill()})}function mapToCommandArgs(e,t=" ",s=!0){return Object.entries(e).map(([e,t])=>`${s?"--":""}${e}=${t}`).join(t)}function handleLaunchMethod(e,t){let s=e;if("lite"===e){const n="darwin"===process.platform?(0,path_1.join)(t,"Contents/Resources/app/package.json"):(0,path_1.join)((0,path_1.dirname)(t),"resources/app/package.json");if((0,fs_extra_1.existsSync)(n))try{const t=JSON.parse((0,fs_extra_1.readFileSync)(n,"utf8"));if(compareVersion(t.version,"4.1.0"))return e;console.log(Editor.I18n.t("bytedance-mini-game.tips.client_version_err",{currVersion:t.version||"",version:"4.1.0"}))}catch(e){console.error(e)}else console.warn(Editor.I18n.t("bytedance-mini-game.tips.client_info_path_err",{path:n}));s="full"}return s}function compareVersion(e,t,s="."){if("string"!=typeof e||"string"!=typeof t)return!0;let[n,a]=e.split("-"),[i,o]=t.split("-");const r=Math.max(n.length,i.length);return n=n.replace(s,"").padStart(r,"0"),i=i.replace(s,"").padStart(r,"0"),Number(n)!==Number(i)?Number(n)>Number(i):void 0!==a&&void 0!==o?Number(a)>=Number(o):void 0!==a||void 0===o}async function copyResFiles(e,t,s){const n=e.packages["bytedance-mini-game"],a=e.buildEngineParam.engineName,i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,o=(0,path_1.join)(i,"templates/bytedance-mini-game");let r=(0,path_1.join)(Build.buildTemplateDir,e.platform,"game.ejs"),p=!0;if((0,fs_extra_1.existsSync)(r))try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(o,"build-template.json"));if(t.version){const s=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let n="";(0,fs_extra_1.existsSync)(s)&&(n=(0,fs_extra_1.readJSONSync)(s)[e.platform]),compareBuildTemplateVersion(t.version,n)&&console.warn(Editor.I18n.t("bytedance-mini-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else r=(0,path_1.join)(o,"game.ejs"),p=!1;const c={engineName:a,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:n.appid,isUsePhysX:e.includeModules.includes("physics-physx")},l=await ejs_1.default.renderFile(r,c);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),l,"utf-8");const d=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(d)&&(0,fs_extra_1.copySync)(d,t.paths.dir),p&&(0,fs_extra_1.removeSync)((0,path_1.join)(t.paths.dir,"game.ejs")),buildGameJson(o,t,e,s,d),buildProjectJson(o,t.paths.dir,e,d)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[s,n]=[e.split("."),t.split(".")],a=Math.max(s.length,n.length);for(let e=0;e<a;e++)if(parseInt(s[e])>parseInt(n[e]))return!0;return!1}function buildGameJson(e,t,s,n,a){var i,o;const r=t.paths.dir,p=s.packages["bytedance-mini-game"],c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"game.json")),l=(0,path_1.join)(a,"game.json");if((0,fs_extra_1.existsSync)(l)){const e=(0,fs_extra_1.readJSONSync)(l);Object.assign(c,e)}if("landscapeRight"!==p.orientation&&"landscapeLeft"!==p.orientation||(p.orientation="landscape"),c.deviceOrientation=p.orientation,p.buildOpenDataContextTemplate?c.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete c.openDataContext,p.wasmSubpackage){const e=(0,path_1.join)(t.paths.engineDir,"./assets/"),s=(0,path_1.join)(t.paths.engineDir,"./chunks/");(0,fs_extra_1.existsSync)(e)&&(null!==(i=p.subpackages)&&void 0!==i||(p.subpackages=[]),p.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(s)&&(null!==(o=p.subpackages)&&void 0!==o||(p.subpackages=[]),p.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}))}p.subpackages&&(c.subpackages=p.subpackages);const d=(0,path_1.join)(r,"game.json");(0,fs_extra_1.outputJSONSync)(d,c,{spaces:4})}function buildProjectJson(e,t,s,n){const a=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"project.config.json")),i=(0,path_1.join)(n,"project.config.json");if((0,fs_extra_1.existsSync)(i)){const e=(0,fs_extra_1.readJSONSync)(i);Object.assign(a,e)}a.appid=s.packages["bytedance-mini-game"].appid||"testappid",a.projectname=s.name;const o=(0,path_1.join)(t,"project.config.json");(0,fs_extra_1.outputJSONSync)(o,a)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;