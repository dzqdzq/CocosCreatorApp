"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,s){e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{moduleStyle:"cjs"});const a=e.packages["bytedance-mini-game"],i=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),n=path_1.join(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);if(fs_extra_1.existsSync(i)&&(fs_extra_1.existsSync(n)&&fs_extra_1.removeSync(n),fs_extra_1.copySync(i,n)),t.staticsInfo.B100011=a.orientation,t.staticsInfo.B100013=a.appid,window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(n))fs_extra_1.moveSync(n,i);else if(a.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,i)}e.buildScriptParam.flags.WASM_SUBPACKAGE=a.wasmSubpackage}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1);const t=e.packages["bytedance-mini-game"];if(-1!==e.includeModules.indexOf("gfx-webgl2")&&e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),e.assetSerializeOptions.exportCCON=!0,"physX"===t.physX.use){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t&&e.includeModules.splice(t,1,"physics-physx")}e.includeModules.includes("physics-physx")&&!t.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),Object.assign(e.physicsConfig,{physX:t.physX}),delete e.physicsConfig.physX.use,e.moveRemoteBundleScript=!0,e.includeModules=Array.from(new Set(e.includeModules)),e.buildScriptParam.platform="BYTEDANCE",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!t.physX.notPackPhysXLibs}async function onAfterBundleBuildTask(e,t,s){const a=[];t.forEach(e=>{if(!e.isSubpackage)return;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,a.push({name:e.name,root:`subpackages/${e.name}/`})}),a.length&&(e.packages["bytedance-mini-game"].subpackages=a)}async function onBeforeCompressSettings(e,t){if(!t.paths.dir)return;const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/bytedance",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/bytedance",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"))}async function onAfterBuild(e,t,s,a){const i=path_1.join(t.paths.dir,`src/${e.buildScriptParam.outputName}`);fs_extra_1.existsSync(i)||fs_extra_1.outputFileSync(i,"console.log('There is no script in project.')","utf-8"),await copyResFiles(e,t,a)}async function copyResFiles(e,t,s){const a=e.packages["bytedance-mini-game"],i=e.buildEngineParam.engineName,n=(await Editor.Message.request("engine","query-engine-info")).typescript.path,o=path_1.join(n,"templates/bytedance-mini-game");let r=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs"),p=!0;if(fs_extra_1.existsSync(r))try{const t=fs_extra_1.readJSONSync(path_1.join(o,"build-template.json"));if(t.version){const s=path_1.join(Build.buildTemplateDir,"templates-version.json");let a="";fs_extra_1.existsSync(s)&&(a=fs_extra_1.readJSONSync(s)[e.platform]),compareBuildTemplateVersion(t.version,a)&&console.warn(Editor.I18n.t("bytedance-mini-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else r=path_1.join(o,"game.ejs"),p=!1;const c={engineName:i,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:a.appid,isUsePhysX:e.includeModules.includes("physics-physx")},l=await ejs_1.default.renderFile(r,c);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),l,"utf-8");const u=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(u)&&fs_extra_1.copySync(u,t.paths.dir),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),buildGameJson(o,t,e,s,u),buildProjectJson(o,t.paths.dir,e,u)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[s,a]=[e.split("."),t.split(".")],i=Math.max(s.length,a.length);for(let e=0;e<i;e++)if(parseInt(s[e])>parseInt(a[e]))return!0;return!1}function buildGameJson(e,t,s,a,i){var n,o;const r=t.paths.dir,p=s.packages["bytedance-mini-game"],c=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));"landscapeRight"!==p.orientation&&"landscapeLeft"!==p.orientation||(p.orientation="landscape"),c.deviceOrientation=p.orientation,p.buildOpenDataContextTemplate?c.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete c.openDataContext;const l=path_1.join(i,"game.json");if(fs_extra_1.existsSync(l)){const e=fs_extra_1.readJSONSync(l);Object.assign(c,e)}if(p.wasmSubpackage){const e=path_1.join(t.paths.engineDir,"./assets/"),s=path_1.join(t.paths.engineDir,"./chunks/");fs_extra_1.existsSync(e)&&(null!==(n=p.subpackages)&&void 0!==n||(p.subpackages=[]),p.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),fs_extra_1.existsSync(s)&&(null!==(o=p.subpackages)&&void 0!==o||(p.subpackages=[]),p.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}))}p.subpackages&&(c.subpackages=p.subpackages);const u=path_1.join(r,"game.json");fs_extra_1.outputJSONSync(u,c,{spaces:4})}function buildProjectJson(e,t,s,a){const i=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));i.appid=s.packages["bytedance-mini-game"].appid||"testappid",i.projectname=s.name;const n=path_1.join(t,"project.config.json"),o=path_1.join(a,"project.config.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(i,e)}fs_extra_1.outputJSONSync(n,i)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;