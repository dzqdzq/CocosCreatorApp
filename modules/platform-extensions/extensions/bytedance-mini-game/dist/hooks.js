"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,s){const a=e.packages["bytedance-mini-game"];if(-1!==e.includeModules.indexOf("gfx-webgl2")&&e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),e.assetSerializeOptions.exportCCON=!0,"physX"===a.physX.use){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t&&e.includeModules.splice(t,1,"physics-physx")}e.includeModules.includes("physics-physx")&&!a.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),e.moveRemoteBundleScript=!0,e.includeModules=Array.from(new Set(e.includeModules));let i=a.remoteServerAddress||"";i&&!i.endsWith("/")&&(i+="/"),Object.assign(e.appTemplateData,{showFPS:!1,server:i}),Object.assign(e.buildEngineParam,{platform:"BYTEDANCE",moduleStyle:"cjs"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!a.physX.notPackPhysXLibs,Object.assign(e.physicsConfig,{physX:a.physX}),delete e.physicsConfig.physX.use;const n=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),o=path_1.join(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(n)&&(fs_extra_1.existsSync(o)&&fs_extra_1.removeSync(o),fs_extra_1.copySync(n,o));const r={orientation:a.orientation,appid:a.appid,remoteServerAddress:a.remoteServerAddress};if(s.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(o))fs_extra_1.moveSync(o,n);else if(a.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-info")).path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,n)}}async function onBeforeCompressSettings(e,t){t.paths.dir&&await buildAdapters(t.paths.dir)}async function onAfterBuild(e,t,s,a){const i=path_1.join(t.paths.dir,`src/${e.buildScriptParam.outputName}`);fs_extra_1.existsSync(i)||fs_extra_1.outputFileSync(i,"console.log('There is no script in project.')","utf-8"),await copyResFiles(e,t,a)}async function buildAdapters(e){const t=(await Editor.Message.request("engine","query-info")).path,s=path_1.join(t,"platforms/minigame"),a=await globby(path_1.join(s,"common/**/*"),{nodir:!0});await Promise.all(a.map(t=>{let a=fs_extra_1.readFileSync(t,"utf-8");a=compileJS(a,t);const i=path_1.relative(s,t),n=path_1.join(e,"libs",i);fs_extra_1.outputFileSync(n,a,"utf-8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)});const i=await globby(path_1.join(s,"platforms/bytedance/wrapper/**/*"),{nodir:!0});await Promise.all(i.map(t=>{let a=fs_extra_1.readFileSync(t,"utf-8");a=compileJS(a,t);const i=path_1.relative(path_1.join(s,"platforms/bytedance/"),t),n=path_1.join(e,"libs",i);fs_extra_1.outputFileSync(n,a,"utf-8")})).catch(e=>{e.stack=`BuildByteDanceLibTemplate error: ${e.stack}`,console.error(e)})}async function copyResFiles(e,t,s){const a=e.packages["bytedance-mini-game"],i=e.buildEngineParam.engineName,n=path_1.join(templateDir,"build-template"),o=path_1.join(n,"game.ejs"),r={engineName:i,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:a.appid,isUsePhysX:e.includeModules.includes("physics-physx")},p=await ejs_1.default.renderFile(o,r);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),p,"utf-8");const c=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(c)&&fs_extra_1.copySync(c,t.paths.dir),buildGameJson(n,t,e,s,c),buildProjectJson(n,t.paths.dir,e,c)}function buildGameJson(e,t,s,a,i){const n=t.paths.dir,o=s.packages["bytedance-mini-game"],r=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));"landscapeRight"!==o.orientation&&"landscapeLeft"!==o.orientation||(o.orientation="landscape"),r.deviceOrientation=o.orientation,o.buildOpenDataContextTemplate?r.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete r.openDataContext;const p=path_1.join(i,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(r,e)}const c=[];for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,c.push({name:e.name,root:`subpackages/${e.name}/`})}c.length>0&&(r.subpackages=c);const l=path_1.join(n,"game.json");fs_extra_1.outputJSONSync(l,r,{spaces:4})}function buildProjectJson(e,t,s,a){const i=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));i.appid=s.packages["bytedance-mini-game"].appid||"testappid",i.projectname=s.name;const n=path_1.join(t,"project.config.json"),o=path_1.join(a,"project.config.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(i,e)}fs_extra_1.outputJSONSync(n,i)}function compileJS(e,t){let s;try{s=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[[require("@babel/preset-env"),{loose:!0}]],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return s.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;