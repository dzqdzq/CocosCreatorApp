"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,s){e.polyfills&&(e.polyfills.asyncFunctions=!1);const i=e.packages["bytedance-mini-game"];if(-1!==e.includeModules.indexOf("gfx-webgl2")&&e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),e.assetSerializeOptions.exportCCON=!0,"physX"===i.physX.use){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t&&e.includeModules.splice(t,1,"physics-physx")}e.includeModules.includes("physics-physx")&&!i.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),e.moveRemoteBundleScript=!0,e.includeModules=Array.from(new Set(e.includeModules)),e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{platform:"BYTEDANCE",moduleStyle:"cjs"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!i.physX.notPackPhysXLibs,Object.assign(e.physicsConfig,{physX:i.physX}),delete e.physicsConfig.physX.use;const n=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),a=path_1.join(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(n)&&(fs_extra_1.existsSync(a)&&fs_extra_1.removeSync(a),fs_extra_1.copySync(n,a));const r={orientation:i.orientation,appid:i.appid,remoteServerAddress:e.server};if(s.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(a))fs_extra_1.moveSync(a,n);else if(i.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,n)}}async function onBeforeCompressSettings(e,t){if(!t.paths.dir)return;const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/bytedance",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/bytedance",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"))}async function onAfterBuild(e,t,s,i){const n=path_1.join(t.paths.dir,`src/${e.buildScriptParam.outputName}`);fs_extra_1.existsSync(n)||fs_extra_1.outputFileSync(n,"console.log('There is no script in project.')","utf-8"),await copyResFiles(e,t,i)}async function copyResFiles(e,t,s){const i=e.packages["bytedance-mini-game"],n=e.buildEngineParam.engineName,a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,r=path_1.join(a,"templates/bytedance-mini-game");let o=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs"),p=!0;if(fs_extra_1.existsSync(o))try{const t=fs_extra_1.readJSONSync(path_1.join(r,"build-template.json"));if(t.version){const s=path_1.join(Build.buildTemplateDir,"templates-version.json");let i="";fs_extra_1.existsSync(s)&&(i=fs_extra_1.readJSONSync(s)[e.platform]),compareBuildTemplateVersion(t.version,i)&&console.warn(Editor.I18n.t("bytedance-mini-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else o=path_1.join(r,"game.ejs"),p=!1;const c={engineName:n,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:i.appid,isUsePhysX:e.includeModules.includes("physics-physx")},l=await ejs_1.default.renderFile(o,c);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),l,"utf-8");const d=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(d)&&fs_extra_1.copySync(d,t.paths.dir),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),buildGameJson(r,t,e,s,d),buildProjectJson(r,t.paths.dir,e,d)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[s,i]=[e.split("."),t.split(".")],n=Math.max(s.length,i.length);for(let e=0;e<n;e++)if(parseInt(s[e])>parseInt(i[e]))return!0;return!1}function buildGameJson(e,t,s,i,n){const a=t.paths.dir,r=s.packages["bytedance-mini-game"],o=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));"landscapeRight"!==r.orientation&&"landscapeLeft"!==r.orientation||(r.orientation="landscape"),o.deviceOrientation=r.orientation,r.buildOpenDataContextTemplate?o.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete o.openDataContext;const p=path_1.join(n,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(o,e)}const c=[];for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,c.push({name:e.name,root:`subpackages/${e.name}/`})}c.length>0&&(o.subpackages=c);const l=path_1.join(a,"game.json");fs_extra_1.outputJSONSync(l,o,{spaces:4})}function buildProjectJson(e,t,s,i){const n=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));n.appid=s.packages["bytedance-mini-game"].appid||"testappid",n.projectname=s.name;const a=path_1.join(t,"project.config.json"),r=path_1.join(i,"project.config.json");if(fs_extra_1.existsSync(r)){const e=fs_extra_1.readJSONSync(r);Object.assign(n,e)}fs_extra_1.outputJSONSync(a,n)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;