"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateSeparateEngine=generateSeparateEngine;const fs_extra_1=require("fs-extra"),path_1=require("path");async function generateSeparateEngine(e,r=!1){var e=e?(0,path_1.join)(e,"app"):(0,path_1.join)(__dirname,"../../../../../"),i=(0,path_1.join)(e,"../resources/3d/engine"),e=require((0,path_1.join)(e,"builtin/builder/dist/worker/builder/asset-handler/script/separate-engine"))["buildCocos"],e=await zipDirectory((await e({engine:i,platform:require("../package.json").name,platformType:"BYTEDANCE",pluginFeatures:"default",pluginName:"cocos",nativeCodeBundleMode:"asmjs",signatureProvider:require("./../static/cocos/signature.json").provider})).plugin),i=await(0,fs_extra_1.stat)(e);6291456<i.size?console.error("引擎插件包体大小超出限制 6 MB，请检查代码是否过大"):console.log("引擎插件包体大小："+i.size/1024/1024+" M"),r&&(console.log("开始上传引擎插件包"),i=require((0,path_1.join)(__dirname,"../static/upload-plugin"))["uploadZipFile"],await i(e,require("../static/cocos/signature.json").provider,require("../../../../../package.json").version,"https://developer.toutiao.com/api/developer/ide/microgame/v1/upload_game_plugin"))}async function zipDirectory(i){const a=(0,path_1.join)(i,"../",(0,path_1.basename)(i)+".zip"),o=(0,fs_extra_1.createWriteStream)(a);const t=require("archiver")("zip",{zlib:{level:9}});return new Promise((e,r)=>{o.on("close",()=>{console.log(`抖音引擎分离包压缩完成: ${a}（总字节: ${t.pointer()}）`),e(a)}),t.on("error",e=>r(e)),t.pipe(o),t.directory(i+"/",!1),t.finalize()})}