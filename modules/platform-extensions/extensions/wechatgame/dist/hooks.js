"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),separate_engine_1=require("./separate-engine"),ccbuild_1=require("@cocos/ccbuild"),fs_1=require("fs"),child_process_1=require("child_process"),iconv=require("iconv-lite"),userTemplateDir=path_1.join(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){const s=e.packages.wechatgame;if(e.server&&!e.server.endsWith("/")&&(e.server+="/"),/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){s.separateEngine&&e.debug&&console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?s.separateEngine=s.separateEngine&&!e.debug:console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_only_in_normal_version"));if("js"===s.wasm)s.wasm=!1;else if("wasm"===s.wasm){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t?(e.includeModules.splice(t,1,"physics-ammo"),s.wasm=!0):s.wasm=!1}Object.assign(e.buildEngineParam,{sourceMaps:!s.separateEngine&&e.sourceMaps,split:s.separateEngine,skip:s.separateEngine,ammoJsWasm:s.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out";const i=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),n=path_1.join(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);if(fs_extra_1.existsSync(i)&&(fs_extra_1.existsSync(n)&&fs_extra_1.removeSync(n),fs_extra_1.copySync(i,n)),e.useSplashScreen){const e=await Editor.Profile.getProject("builder","splash-setting.url");e&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(e))&&console.error("The width or height of the splash screen image cannot be larger than 2048!")}if(t.staticsInfo.B100011=s.orientation,t.staticsInfo.B100013=s.appid,window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(n))fs_extra_1.moveSync(n,i);else if(s.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,i)}e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage&&!s.separateEngine}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0;const t=e.packages.wechatgame;-1!==e.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==t.enabelWebGL2&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="WECHAT",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}async function onAfterBundleBuildTask(e,t,a){const s=[];t.forEach(e=>{if(!e.isSubpackage)return;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,s.push({name:e.name,root:`subpackages/${e.name}/`})}),s.length&&(e.packages.wechatgame.subpackages=s)}function validRatio(e){return new Promise((t,a)=>{const s=new Image;s.src=`data:image/png;base64,${fs_extra_1.readFileSync(e).toString("base64")}`,s.onload=function(){(s.width>2048||s.height>2048)&&t(!1),t(!0)},s.onerror=function(e){a(e)}})}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${path_1.relative(t.paths.dir,e).replace(/\\/g,"/")}`),t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0))}async function onAfterBuild(e,t,a,s){e.packages.wechatgame.separateEngine&&(await buildSeparateEngine(e,t),Build.ScriptBuilder.outputImportMap(t.importMap,{dest:t.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug}));const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,n=path_1.join(i,"templates/wechatgame");await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/wechat",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/wechat",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js")),fs_extra_1.existsSync(userTemplateDir)&&copyUserTemplates(e,t,n,userTemplateDir),await _buildWeChatTemplate(e,t,s,n)}async function buildSeparateEngine(e,t){var a;fs_extra_1.ensureDirSync(t.paths.engineDir),await separate_engine_1.buildCocos(!Editor.App.dev);const s=e.buildEngineParam.includeModules,i=await ccbuild_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),n=i.getUnitsOfFeatures(s),r=separate_engine_1.getWechatPluginFeatures(),o=i.getUnitsOfFeatures(r),p=fs_extra_1.readJSONSync(path_1.join(separate_engine_1.separateEnginPaths.outDir,"meta.json")),c=[],l=path_1.join(t.paths.engineDir,"cc.js"),_=await ccbuild_1.buildEngine.transform(i.evaluateIndexModuleSource(n,e=>o.includes(e)?(c.push(e),`plugin:cocos/${e}.js`):(fs_extra_1.copySync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,`${e}.js`),path_1.join(t.paths.engineDir,`${e}.js`)),`./${e}.js`)),"system");fs_extra_1.writeFileSync(l,_.code,"utf8");const u=ccbuild_1.buildEngine.enumerateAllDependents(p,r),d=n.filter(e=>!r.includes(e)),g=ccbuild_1.buildEngine.enumerateAllDependents(p,d),h=new Set(ccbuild_1.buildEngine.enumerateAllDependents(p,c)),f=null!==(a=t.importMap.imports)&&void 0!==a?a:{},m=e=>e in p.chunkAliases,y=e=>{var t;return null!==(t=p.chunkAliases[e])&&void 0!==t?t:e};g.forEach(e=>{u.includes(e)?(e=>{const a=y(e);h.add(a);const s=m(e)?e:`../${path_1.basename(t.paths.engineDir)}/${a}`,i=`plugin:cocos/${a}`;f[s]=i})(e):(e=>{const a=y(e),s=path_1.join(t.paths.engineDir,a);fs_extra_1.ensureDirSync(path_1.dirname(s)),fs_extra_1.copyFileSync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,a),s),m(e)&&(f[e]=`../${path_1.basename(t.paths.engineDir)}/${a}`)})(e)}),f.cc=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/cc.js`,s.includes("physics-ammo")&&(f["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/wait-for-ammo-instantiation.js`),t.importMap.imports=f;const S=path_1.join(t.paths.dir,"cocos");await separate_engine_1.generateCocos(Array.from(h),S)}function readAllFilesDeep(e){if(!fs_extra_1.statSync(e).isDirectory())return[e];const t=fs_1.readdirSync(e),a=[];for(const s of t){const t=path_1.join(e,s),i=readAllFilesDeep(t);i.length?a.push(...i):a.push(t)}return a}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],i=Math.max(a.length,s.length);for(let e=0;e<i;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a,s){var i,n,r,o;let p=!0;if(!fs_extra_1.existsSync(path_1.join(userTemplateDir,"game.js"))){let a=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs");fs_extra_1.existsSync(a)||(a=path_1.join(s,"game.ejs"),p=!1);const r=null===(i=t.settings.engine.macros)||void 0===i?void 0:i.ENABLE_TRANSPARENT_CANVAS,o=null===(n=t.settings.engine.macros)||void 0===n?void 0:n.ENABLE_WEBGL_ANTIALIAS,c={engineName:e.buildEngineParam.engineName,cocosTemplate:path_1.join(s,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===r?"default":r,antialias:void 0===o?"default":o,useWebgl2:"sameAsProjectSetting"===e.packages.wechatgame.enabelWebGL2&&-1!==e.includeModules.indexOf("gfx-webgl2")},l=await ejs_1.default.renderFile(a,c);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),l,"utf8")}if(!fs_extra_1.existsSync(path_1.join(userTemplateDir,"first-screen.js"))){const e=path_1.join(s,"first-screen.ejs"),a=null!==(o=null===(r=t.settings.splashScreen)||void 0===r?void 0:r.displayRatio)&&void 0!==o?o:1,i=await ejs_1.default.renderFile(e,{displayRatio:a}),n=path_1.join(t.paths.dir,"first-screen.js");fs_extra_1.writeFileSync(n,i,"utf8")}const c=await Editor.Message.request("information","query-information","customSplash");if(c&&c.data&&c.data.enable&&!c.data[c.data.id].complete)fs_extra_1.copyFileSync(path_1.join(s,"logo.png"),path_1.join(t.paths.dir,"logo.png"));else if(!fs_extra_1.existsSync(path_1.join(userTemplateDir,"logo.png")))if(await compareSplashLogo(t.settings.splashScreen))fs_extra_1.copyFileSync(path_1.join(s,"logo.png"),path_1.join(t.paths.dir,"logo.png"));else{const e=await Editor.Profile.getProject("builder","splash-setting"),a=Editor.UI.__protected__.File.resolveToRaw(e.url);fs_extra_1.existsSync(a)&&fs_extra_1.copyFileSync(a,path_1.join(t.paths.dir,"logo.png"))}fs_extra_1.existsSync(path_1.join(userTemplateDir,"background.png"))||fs_extra_1.copyFileSync(path_1.join(s,"background.png"),path_1.join(t.paths.dir,"background.png")),fs_extra_1.existsSync(path_1.join(userTemplateDir,"slogan.png"))||fs_extra_1.copyFileSync(path_1.join(s,"slogan.png"),path_1.join(t.paths.dir,"slogan.png")),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),await buildGameJson(s,t.paths.dir,e,t),buildProjectConfig(s,t.paths.dir,e)}async function compareSplashLogo(e){if(!e)return!1;try{const t=await Editor.Profile.getProject("builder","splash-setting","default"),a=Editor.UI.__protected__.File.resolveToRaw(t.url);if(`data:image/png;base64,${fs_extra_1.readFileSync(a).toString("base64")}`===e.base64src)return!0}catch(e){return!0}return!1}function copyUserTemplates(e,t,a,s){try{const t=fs_extra_1.readJSONSync(path_1.join(a,"build-template.json"));if(t.version){const a=path_1.join(Build.buildTemplateDir,"templates-version.json");let s="";fs_extra_1.existsSync(a)&&(s=fs_extra_1.readJSONSync(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("wechatgame.tips.templateVersionWarning"))}}catch(e){console.debug(e)}fs_extra_1.copySync(s,t.paths.dir),console.debug(`Use build-template {link(${s})}.`)}function buildProjectConfig(e,t,a){const s=a.packages.wechatgame,i=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));i.appid=s.appid||"wx6ac3f5090a6b99c5",i.projectname=a.name,a.server&&a.useBuiltinServer&&(i.packOptions={ignore:[{type:"folder",value:"remote"}]});const n=path_1.join(userTemplateDir,"project.config.json");if(fs_extra_1.existsSync(n)){const e=fs_extra_1.readJSONSync(n);Object.assign(i,e)}const r=path_1.join(t,"project.config.json");fs_extra_1.outputJSONSync(r,i)}async function buildGameJson(e,t,a,s){var i,n;const r=a.packages.wechatgame,o=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));if(o.deviceOrientation=r.orientation,r.separateEngine){const t=path_1.join(e,"patch.json");let a=Editor.App.version;fs_extra_1.existsSync(t)&&(a=await Editor.Profile.getConfig("wechatgame","plugin-version")||Editor.App.version),o.plugins={cocos:{version:a,provider:require(path_1.join(__dirname,"../static/cocos/signature.json")).provider,path:"cocos"}}}if(r.buildOpenDataContextTemplate?o.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete o.openDataContext,r.highPerformanceMode?o.iOSHighPerformance=!0:delete o.iOSHighPerformance,r.wasmSubpackage&&!r.separateEngine){const e=path_1.join(s.paths.engineDir,"./assets/"),t=path_1.join(s.paths.engineDir,"./chunks/");fs_extra_1.existsSync(e)&&(null!==(i=r.subpackages)&&void 0!==i||(r.subpackages=[]),r.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),fs_extra_1.existsSync(t)&&(null!==(n=r.subpackages)&&void 0!==n||(r.subpackages=[]),r.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}))}r.subpackages&&(o.subpackages=r.subpackages);const p=path_1.join(userTemplateDir,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(o,e)}const c=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(c,o,{spaces:4})}async function run(e,t){const a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);a&&console.warn(Editor.I18n.t("wechatgame.tips.build_path_contains_symbol",{symbol:a[1]}));const s=await Editor.Message.request("program","query-program-info","wechatDevtools");let i=s?s.path:"";if(!i||!fs_extra_1.existsSync(i)){return console.warn(`${Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty",{wechatgamePath:i})}`),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}fs_extra_1.statSync(i).isDirectory()||"win32"!==process.platform||(i=path_1.dirname(i));const n={stdio:"pipe"};let r;if("darwin"===process.platform?(r=path_1.join(i,"Contents/Resources/app.nw/bin/cli"),fs_extra_1.existsSync(r)||(r=path_1.join(i,"Contents/MacOS/cli"))):(r=path_1.join(i,"cli.bat"),n.shell=!0),!fs_extra_1.existsSync(r))return await Editor.Dialog.error(Editor.I18n.t("wechatgame.options.client_path_error")),!1;const o=["-o",e,"-f","cocos"];console.log(`Run command : ${o.join(" ")}`);const p=child_process_1.spawn(r,o);p&&p.stdout&&p.stdout.on("data",function(e){console.log(`[WeChat Dev Tool] ${iconv.decode(e,"utf8").toString()}`)}),p&&p.stderr&&p.stderr.on("data",function(e){console.error(`[WeChat Dev Tool]${iconv.decode(e,"utf8").toString()}`)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;