"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,n){void 0===n&&(n=a),e[n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),separate_engine_1=require("./separate-engine"),stats_query_1=require("@cocos/build-engine/dist/stats-query"),index_1=require("@cocos/build-engine/dist/index"),ccBuild=__importStar(require("@cocos/build-engine")),enumerate_dependent_chunks_js_1=require("@cocos/build-engine/dist/enumerate-dependent-chunks.js"),fs_1=require("fs"),child_process_1=require("child_process"),iconv=require("iconv-lite"),userTemplateDir=path_1.join(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1);const n=e.packages.wechatgame;if(-1!==e.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==n.enabelWebGL2&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.moveRemoteBundleScript=!0,e.assetSerializeOptions.exportCCON=!0,/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){n.separateEngine&&e.debug&&console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?n.separateEngine=n.separateEngine&&!e.debug:console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_only_in_normal_version"));if("js"===n.wasm)n.wasm=!1;else if("wasm"===n.wasm){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t?(e.includeModules.splice(t,1,"physics-ammo"),n.wasm=!0):n.wasm=!1}Object.assign(e.buildEngineParam,{platform:"WECHAT",sourceMaps:!n.separateEngine&&e.sourceMaps,split:n.separateEngine,skip:n.separateEngine,ammoJsWasm:n.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"};const i=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),s=path_1.join(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);if(fs_extra_1.existsSync(i)&&(fs_extra_1.existsSync(s)&&fs_extra_1.removeSync(s),fs_extra_1.copySync(i,s)),e.replaceSplashScreen){const e=await Editor.Profile.getProject("builder","splash-setting.url");e&&!await validRatio(Editor.UI.File.resolveToRaw(e))&&console.error("The splash screen image is too large!")}const r={orientation:n.orientation,appid:n.appid,remoteServerAddress:e.server};if(a.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(s))fs_extra_1.moveSync(s,i);else if(n.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,i)}}function validRatio(e){return new Promise((t,a)=>{const n=new Image;n.src=`data:image/png;base64,${fs_extra_1.readFileSync(e).toString("base64")}`,n.onload=function(){(n.width>2048||n.height>2048)&&t(!1),t(!0)},n.onerror=function(e){a(e)}})}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(e.packages.wechatgame.separateEngine&&await buildSeparateEngine(e,t),t.settings.scriptPackages=t.scriptPackages.map(e=>`project://${path_1.relative(t.paths.dir,e).replace(/\\/g,"/")}`),sortSubPackage(e,t,a))}async function onAfterBuild(e,t,a,n){await _buildWeChatTemplate(e,t,n)}async function buildSeparateEngine(e,t){fs_extra_1.ensureDirSync(t.paths.engineDir),await separate_engine_1.buildCocos(!Editor.App.dev);const a=e.buildEngineParam.includeModules,n=await stats_query_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),i=n.getUnitsOfFeatures(a),s=separate_engine_1.getWechatPluginFeatures(),r=n.getUnitsOfFeatures(s),o=fs_extra_1.readJSONSync(path_1.join(separate_engine_1.separateEnginPaths.outDir,"meta.json")),p=[],c=path_1.join(t.paths.engineDir,"cc.js"),l=await index_1.build.transform(n.evaluateIndexModuleSource(i,e=>r.includes(e)?(p.push(e),`plugin:cocos/${e}.js`):(fs_extra_1.copySync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,`${e}.js`),path_1.join(t.paths.engineDir,`${e}.js`)),`./${e}.js`)),ccBuild.ModuleOption.system);fs_extra_1.writeFileSync(c,l.code,"utf8");const _=enumerate_dependent_chunks_js_1.enumerateDependentChunks(o,s),d=i.filter(e=>!s.includes(e)),u=enumerate_dependent_chunks_js_1.enumerateDependentChunks(o,d),g=new Set(enumerate_dependent_chunks_js_1.enumerateDependentChunks(o,p)),h={},f=e=>e in o.chunkAliases,m=e=>{var t;return null!==(t=o.chunkAliases[e])&&void 0!==t?t:e};u.forEach(e=>{_.includes(e)?(e=>{const a=m(e);g.add(a);const n=f(e)?e:`../${path_1.basename(t.paths.engineDir)}/${a}`,i=`plugin:cocos/${a}`;h[n]=i})(e):(e=>{const a=m(e),n=path_1.join(t.paths.engineDir,a);fs_extra_1.ensureDirSync(path_1.dirname(n)),fs_extra_1.copyFileSync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,a),n),f(e)&&(h[e]=`../${path_1.basename(t.paths.engineDir)}/${a}`)})(e)}),h.cc=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/cc.js`,a.includes("physics-ammo")&&(h["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/wait-for-ammo-instantiation.js`),t.importMap.imports=h;const j=path_1.join(t.paths.dir,"cocos");await separate_engine_1.generateCocos(Array.from(g),j)}function sortSubPackage(e,t,a){for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t}}function readAllFilesDeep(e){if(!fs_extra_1.statSync(e).isDirectory())return[e];const t=fs_1.readdirSync(e),a=[];for(const n of t){const t=path_1.join(e,n),i=readAllFilesDeep(t);i.length?a.push(...i):a.push(t)}return a}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,n]=[e.split("."),t.split(".")],i=Math.max(a.length,n.length);for(let e=0;e<i;e++)if(parseInt(a[e])>parseInt(n[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a){var n,i;const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/wechat",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(s,"bin/adapter/minigame/wechat",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"));const r=path_1.join(s,"templates/wechatgame");let o=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs"),p=!0;if(fs_extra_1.existsSync(o))try{const t=fs_extra_1.readJSONSync(path_1.join(r,"build-template.json"));if(t.version){const a=path_1.join(Build.buildTemplateDir,"templates-version.json");let n="";fs_extra_1.existsSync(a)&&(n=fs_extra_1.readJSONSync(a)[e.platform]),compareBuildTemplateVersion(t.version,n)&&console.warn(Editor.I18n.t("wechatgame.tips.templateVersionWarning"))}}catch(e){console.debug(e)}else o=path_1.join(r,"game.ejs"),p=!1;const c=null===(n=t.settings.macros)||void 0===n?void 0:n.ENABLE_TRANSPARENT_CANVAS,l=null===(i=t.settings.macros)||void 0===i?void 0:i.ENABLE_WEBGL_ANTIALIAS,_={engineName:e.buildEngineParam.engineName,cocosTemplate:path_1.join(r,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===c?"default":c,antialias:void 0===l?"default":l,useWebgl2:"sameAsProjectSetting"===e.packages.wechatgame.enabelWebGL2&&-1!==e.includeModules.indexOf("gfx-webgl2")},d=await ejs_1.default.renderFile(o,_);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),d,"utf8"),fs_extra_1.copyFileSync(path_1.join(r,"first-screen.js"),path_1.join(t.paths.dir,"first-screen.js")),fs_extra_1.copyFileSync(path_1.join(r,"splash.png"),path_1.join(t.paths.dir,"splash.png")),fs_extra_1.existsSync(userTemplateDir)&&(fs_extra_1.copySync(userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${userTemplateDir})}.`)),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),buildGameJson(r,t.paths.dir,e,t),buildProjectConfig(r,t.paths.dir,e)}function buildProjectConfig(e,t,a){const n=a.packages.wechatgame,i=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));i.appid=n.appid||"wx6ac3f5090a6b99c5",i.projectname=a.name,a.server&&a.useBuiltinServer&&(i.packOptions={ignore:[{type:"folder",value:"remote"}]});const s=path_1.join(userTemplateDir,"project.config.json");if(fs_extra_1.existsSync(s)){const e=fs_extra_1.readJSONSync(s);Object.assign(i,e)}const r=path_1.join(t,"project.config.json");fs_extra_1.outputJSONSync(r,i)}function buildGameJson(e,t,a,n){const i=a.packages.wechatgame,s=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));if(s.deviceOrientation=i.orientation,i.separateEngine){const t=path_1.join(e,"patch.json");let a=Editor.App.version;if(fs_extra_1.existsSync(t)){a=fs_extra_1.readJSONSync(t)["plugin-version"]||Editor.App.version}s.plugins={cocos:{version:a,provider:require(path_1.join(__dirname,"../static/cocos/signature.json")).provider,path:"cocos"}}}i.buildOpenDataContextTemplate?s.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete s.openDataContext;const r=[];for(const e of n.bundles)e.isSubpackage&&r.push({name:e.name,root:`subpackages/${e.name}/`});r.length>0&&(s.subpackages=r);const o=path_1.join(userTemplateDir,"game.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(s,e)}const p=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(p,s,{spaces:4})}async function run(e,t){const a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);a&&console.warn(Editor.I18n.t("wechatgame.tips.build_path_contains_symbol",{symbol:a[1]}));let n=await Editor.Profile.getConfig("program","wechat_devtools");if(!n||!fs_extra_1.existsSync(n)){return console.warn(`${Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty",{wechatgamePath:n})}`),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}fs_extra_1.statSync(n).isDirectory()||"win32"!==process.platform||(n=path_1.dirname(n));const i={stdio:"pipe"};let s;if("darwin"===process.platform?(s=path_1.join(n,"Contents/Resources/app.nw/bin/cli"),fs_extra_1.existsSync(s)||(s=path_1.join(n,"Contents/MacOS/cli"))):(s=path_1.join(n,"cli.bat"),i.shell=!0),!fs_extra_1.existsSync(s))return await Editor.Dialog.error(Editor.I18n.t("wechatgame.options.client_path_error")),!1;const r=["-o",e,"-f","cocos"];console.log(`Run command : ${r.join(" ")}`);const o=child_process_1.spawn(s,r);o&&o.stdout&&o.stdout.on("data",function(e){console.log(`${iconv.decode(e,"utf8").toString()}`)}),o&&o.stderr&&o.stderr.on("data",function(e){console.error(`${iconv.decode(e,"utf8").toString()}`)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;