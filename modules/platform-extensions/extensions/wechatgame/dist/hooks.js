"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBuildAssets=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),separate_engine_1=require("./separate-engine"),ccbuild_1=require("@cocos/ccbuild"),fs_1=require("fs"),child_process_1=require("child_process"),iconv=require("iconv-lite"),userTemplateDir=(0,path_1.join)(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onAfterInit(e,t,a){const s=e.packages.wechatgame;if(e.server&&!e.server.endsWith("/")&&(e.server+="/"),/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){s.separateEngine&&e.debug&&console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?s.separateEngine=s.separateEngine&&!e.debug:console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("wechatgame.tips.separate_engine_only_in_normal_version"));if("js"===s.wasm)s.wasm=!1;else if("wasm"===s.wasm){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t?(e.includeModules.splice(t,1,"physics-ammo"),s.wasm=!0):s.wasm=!1}Object.assign(e.buildEngineParam,{sourceMaps:!s.separateEngine&&e.sourceMaps,split:s.separateEngine,skip:s.separateEngine,ammoJsWasm:s.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out";const i=(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),n=(0,path_1.join)(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);if((0,fs_extra_1.existsSync)(i)&&((0,fs_extra_1.existsSync)(n)&&(0,fs_extra_1.removeSync)(n),(0,fs_extra_1.copySync)(i,n)),e.useSplashScreen){const{logo:e,background:t}=await Editor.Profile.getProject("builder","splash-setting");("custom"===e.type&&e.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(e.image))||"custom"===t.type&&t.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(t.image)))&&console.error("The width or height of the splash screen image cannot be larger than 2048 for wechatgame!")}if(t.staticsInfo.B100011=s.orientation,t.staticsInfo.B100013=s.appid,(0,fs_extra_1.existsSync)(n))(0,fs_extra_1.moveSync)(n,i);else if(s.buildOpenDataContextTemplate){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=(0,path_1.join)(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.copySync)(t,i)}e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage&&!s.separateEngine}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0;const t=e.packages.wechatgame;-1!==e.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==t.enabelWebGL2&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="WECHAT",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}async function onAfterBundleBuildTask(e,t,a){const s=[];t.forEach(e=>{if(!e.isSubpackage)return;const t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js");(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,s.push({name:e.name,root:`subpackages/${e.name}/`})}),s.length&&(e.packages.wechatgame.subpackages=s)}function validRatio(e){return new Promise((t,a)=>{const s=new Image;s.src=`data:image/png;base64,${(0,fs_extra_1.readFileSync)(e).toString("base64")}`,s.onload=function(){(s.width>2048||s.height>2048)&&t(!1),t(!0)},s.onerror=function(e){a(e)}})}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")}`),t.settings.splashScreen&&(t.settings.splashScreen.totalTime=0))}async function onAfterBuild(e,t,a,s){e.packages.wechatgame.separateEngine&&(await buildSeparateEngine(e,t),Build.ScriptBuilder.outputImportMap(t.importMap,{dest:t.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug}));const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,n=(0,path_1.join)(i,"templates/wechatgame");await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/wechat",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/wechat",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js")),(0,fs_extra_1.existsSync)(userTemplateDir)&&await copyUserTemplates(e,t,n,userTemplateDir),await buildWeChatSplash(t,n),await _buildWeChatTemplate(e,t,s,n)}async function buildSeparateEngine(e,t){var a;(0,fs_extra_1.ensureDirSync)(t.paths.engineDir),await(0,separate_engine_1.buildCocos)(!Editor.App.dev);const s=e.buildEngineParam.includeModules,i=await ccbuild_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),n=i.getUnitsOfFeatures(s),o=(0,separate_engine_1.getWechatPluginFeatures)(),r=i.getUnitsOfFeatures(o),p=n.filter(e=>!o.includes(e)),c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.outDir,"meta.json")),l=(0,path_1.join)(t.paths.engineDir,"cc.js"),u=await ccbuild_1.buildEngine.transform(i.evaluateIndexModuleSource(n,e=>r.includes(e)?`plugin:cocos/${e}.js`:`./${e}.js`),"system");(0,fs_extra_1.writeFileSync)(l,u.code,"utf8");const d=ccbuild_1.buildEngine.enumerateDependentChunks(c,p),g=ccbuild_1.buildEngine.enumerateDependentChunks(c,r),_=ccbuild_1.buildEngine.enumerateDependentAssets(c,p).concat(ccbuild_1.buildEngine.enumerateDependentAssets(c,r)),m=null!==(a=t.importMap.imports)&&void 0!==a?a:{},h=e=>e in c.chunkAliases,f=e=>{var t;return null!==(t=c.chunkAliases[e])&&void 0!==t?t:e},b=e=>{const a=f(e),s=(0,path_1.join)(t.paths.engineDir,a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),(0,fs_extra_1.copyFileSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.cacheCocos,a),s),h(e)&&(m[e]=`../${(0,path_1.basename)(t.paths.engineDir)}/${a}`)};d.forEach(e=>{g.includes(e)?(e=>{const a=f(e),s=h(e)?e:`../${(0,path_1.basename)(t.paths.engineDir)}/${a}`,i=`plugin:cocos/${a}`;m[s]=i})(e):b(e)}),_.forEach(e=>{b(e)}),m.cc=`./${Build.Utils.relativeUrl((0,path_1.dirname)(t.paths.importMap),t.paths.engineDir)}/cc.js`,s.includes("physics-ammo")&&(m["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl((0,path_1.dirname)(t.paths.importMap),t.paths.engineDir)}/wait-for-ammo-instantiation.js`),t.importMap.imports=m;const y=(0,path_1.join)(t.paths.dir,"cocos");await(0,separate_engine_1.generateCocos)(g,y)}function readAllFilesDeep(e){if(!(0,fs_extra_1.statSync)(e).isDirectory())return[e];const t=(0,fs_1.readdirSync)(e),a=[];for(const s of t){const t=(0,path_1.join)(e,s),i=readAllFilesDeep(t);i.length?a.push(...i):a.push(t)}return a}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],i=Math.max(a.length,s.length);for(let e=0;e<i;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a,s){var i,n,o,r,p,c,l,u,d;let g=!0;if(!(0,fs_extra_1.existsSync)((0,path_1.join)(userTemplateDir,"game.js"))){let a=(0,path_1.join)(Build.buildTemplateDir,e.platform,"game.ejs");(0,fs_extra_1.existsSync)(a)||(a=(0,path_1.join)(s,"game.ejs"),g=!1);const o=null===(i=t.settings.engine.macros)||void 0===i?void 0:i.ENABLE_TRANSPARENT_CANVAS,r=null===(n=t.settings.engine.macros)||void 0===n?void 0:n.ENABLE_WEBGL_ANTIALIAS,p={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(s,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===o?"default":o,antialias:void 0===r?"default":r,useWebgl2:"sameAsProjectSetting"===e.packages.wechatgame.enabelWebGL2&&-1!==e.includeModules.indexOf("gfx-webgl2")},c=await ejs_1.default.renderFile(a,p);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),c,"utf8")}if(!(0,fs_extra_1.existsSync)((0,path_1.join)(userTemplateDir,"first-screen.js"))){const e=t.settings.splashScreen,a=(0,path_1.join)(s,"first-screen.ejs"),i=null===(o=e.background)||void 0===o?void 0:o.color,n=e.logo,g=e.background,_={displayRatio:null!==(p=null===(r=t.settings.splashScreen)||void 0===r?void 0:r.displayRatio)&&void 0!==p?p:1,bgColor:i?[i.x,i.y,i.z,i.w]:[0,0,0,1],useCustomBg:"custom"===(null===g||void 0===g?void 0:g.type),useLogo:null===(c="none"!==(null===n||void 0===n?void 0:n.type))||void 0===c||c,useDefaultLogo:null===(l="default"===(null===n||void 0===n?void 0:n.type))||void 0===l||l,logoName:(0,path_1.basename)(null!==(u=null===n||void 0===n?void 0:n.image)&&void 0!==u?u:"logo.png"),bgName:(0,path_1.basename)(null!==(d=null===g||void 0===g?void 0:g.image)&&void 0!==d?d:"background.png")},m=await ejs_1.default.renderFile(a,_),h=(0,path_1.join)(t.paths.dir,"first-screen.js");(0,fs_extra_1.writeFileSync)(h,m,"utf8")}g&&(0,fs_extra_1.removeSync)((0,path_1.join)(t.paths.dir,"game.ejs")),await buildGameJson(s,t.paths.dir,e,t),buildProjectConfig(s,t.paths.dir,e)}async function buildWeChatSplash(e,t){const a=await Editor.Message.request("information","query-information","customSplash"),s=await Editor.Profile.getProject("builder","splash-setting"),i={logo:"",background:"",slogan:""};a&&a.data&&a.data.enable&&!a.data[a.data.id].complete?(i.logo=(0,path_1.join)(t,"logo.png"),i.slogan=(0,path_1.join)(t,"slogan.png")):("default"===s.logo.type?(i.logo=(0,path_1.join)(t,"logo.png"),i.slogan=(0,path_1.join)(t,"slogan.png")):"custom"===s.logo.type&&(i.logo=Editor.UI.__protected__.File.resolveToRaw(s.logo.image)),"custom"===s.background.type&&(i.background=Editor.UI.__protected__.File.resolveToRaw(s.background.image)));const n=e.settings.splashScreen,o=[];Object.entries(i).forEach(([t,a])=>{if(a)try{const{ext:s}=(0,path_1.parse)(a),i=(0,path_1.join)(e.paths.dir,`${t}${s}`);o.push({source:a,target:i}),(null===n||void 0===n?void 0:n.logo)&&"logo"===t&&(n.logo.image=(0,path_1.relative)(e.paths.settings,i)),(null===n||void 0===n?void 0:n.background)&&"background"===t&&(n.background.image=(0,path_1.relative)(e.paths.settings,i))}catch(e){console.warn(e)}}),await Promise.all(o.map(({source:e,target:t})=>(0,fs_extra_1.copyFile)(e,t)));const r=(0,fs_extra_1.readFileSync)(e.paths.settings,"utf8"),p=JSON.parse(r);p.splashScreen=n,(0,fs_extra_1.writeFileSync)(e.paths.settings,JSON.stringify(p,null,0),"utf8")}async function copyUserTemplates(e,t,a,s){try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(a,"build-template.json"));if(t.version){const a=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let s="";(0,fs_extra_1.existsSync)(a)&&(s=(0,fs_extra_1.readJSONSync)(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("wechatgame.tips.templateVersionWarning"))}}catch(e){console.debug(e)}await copyDirWithFilter(s,t.paths.dir,["logo.png","background.png","slogan.png"]),console.debug(`Use build-template {link(${s})}.`)}async function copyDirWithFilter(e,t,a){const s=[];(0,fs_1.readdirSync)(e).forEach(i=>{if(!a.includes(i)){const a=(0,path_1.join)(e,i),n=(0,path_1.join)(t,i);s.push({source:a,target:n})}}),await Promise.all(s.map(({source:e,target:t})=>(0,fs_extra_1.copy)(e,t)))}function buildProjectConfig(e,t,a){const s=a.packages.wechatgame,i=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"project.config.json")),n=(0,path_1.join)(userTemplateDir,"project.config.json");if((0,fs_extra_1.existsSync)(n)){const e=(0,fs_extra_1.readJSONSync)(n);Object.assign(i,e)}i.appid=s.appid||"wx6ac3f5090a6b99c5",i.projectname=a.name,a.server&&a.useBuiltinServer&&(i.packOptions={ignore:[{type:"folder",value:"remote"}]});const o=(0,path_1.join)(t,"project.config.json");(0,fs_extra_1.outputJSONSync)(o,i)}async function buildGameJson(e,t,a,s){var i,n;const o=a.packages.wechatgame,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"game.json")),p=(0,path_1.join)(userTemplateDir,"game.json");if((0,fs_extra_1.existsSync)(p)){const e=(0,fs_extra_1.readJSONSync)(p);Object.assign(r,e)}if(r.deviceOrientation=o.orientation,o.separateEngine){const t=(0,path_1.join)(e,"patch.json");let a=Editor.App.version;(0,fs_extra_1.existsSync)(t)&&(a=await Editor.Profile.getConfig("utils",`${Editor.App.version.replace(".","_")}_plugin_version.wechatgame`)||Editor.App.version),r.plugins={cocos:{version:a,provider:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).provider}}}if(o.buildOpenDataContextTemplate?r.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete r.openDataContext,o.highPerformanceMode?r.iOSHighPerformance=!0:delete r.iOSHighPerformance,o.wasmSubpackage&&!o.separateEngine){const e=(0,path_1.join)(s.paths.engineDir,"./assets/"),t=(0,path_1.join)(s.paths.engineDir,"./chunks/");(0,fs_extra_1.existsSync)(e)&&(null!==(i=o.subpackages)&&void 0!==i||(o.subpackages=[]),o.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(t)&&(null!==(n=o.subpackages)&&void 0!==n||(o.subpackages=[]),o.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}))}o.subpackages&&(r.subpackages=o.subpackages);const c=(0,path_1.join)(t,"game.json");(0,fs_extra_1.outputJSONSync)(c,r,{spaces:4})}async function run(e,t){const a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);a&&console.warn(Editor.I18n.t("wechatgame.tips.build_path_contains_symbol",{symbol:a[1]}));const s=await Editor.Message.request("program","query-program-info","wechatDevtools");let i=s?s.path:"";if(!i||!(0,fs_extra_1.existsSync)(i)){return console.warn(`${Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty",{wechatgamePath:i})}`),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}(0,fs_extra_1.statSync)(i).isDirectory()||"win32"!==process.platform||(i=(0,path_1.dirname)(i));const n={stdio:"pipe"};let o;if("darwin"===process.platform?(o=(0,path_1.join)(i,"Contents/Resources/app.nw/bin/cli"),(0,fs_extra_1.existsSync)(o)||(o=(0,path_1.join)(i,"Contents/MacOS/cli"))):(o=(0,path_1.join)(i,"cli.bat"),n.shell=!0),!(0,fs_extra_1.existsSync)(o))return await Editor.Dialog.error(Editor.I18n.t("wechatgame.options.client_path_error")),!1;const r=["-o",e,"-f","cocos"];console.log(`Run command : ${r.join(" ")}`);const p=(0,child_process_1.spawn)(o,r);p&&p.stdout&&p.stdout.on("data",function(e){console.log(`[WeChat Dev Tool] ${iconv.decode(e,"utf8").toString()}`)}),p&&p.stderr&&p.stderr.on("data",function(e){console.warn(`[WeChat Dev Tool]${iconv.decode(e,"utf8").toString()}`)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;