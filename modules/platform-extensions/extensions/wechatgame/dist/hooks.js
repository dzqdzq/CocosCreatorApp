"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,s)}:function(e,t,a,i){e[i=void 0===i?a:i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var s=function(e){return(s=Object.getOwnPropertyNames||function(e){var t,a=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[a.length]=t);return a})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a=s(e),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(t,e,a[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.onAfterBuild=onAfterBuild;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importStar(require("ejs")),share_1=require("./share"),OPEN_DATA_CONTEXT_ROOT="openDataContext";async function onBeforeBuild(e,t,a){var t=(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),i=(0,path_1.join)(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.existsSync)(t)&&((0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.removeSync)(i),(0,fs_extra_1.copySync)(t,i))}async function onAfterInit(e,t,a){var i=e.packages.wechatgame,s=(share_1.Paths.internalTemplateDir=(0,path_1.join)(e.engineInfo.typescript.path,"templates/wechatgame"),e.server&&!e.server.endsWith("/")&&(e.server+="/"),i.separateEngine&&(e.buildEngineParam.separateEngineOptions={useCacheForce:Editor.App.isPackaged,pluginFeatures:"default",pluginName:"cocos",checkVersionValid:!0,signatureProvider:require("../static/cocos/signature.json").provider},e.buildEngineParam.nativeCodeBundleMode="wasm"),e.buildEngineParam.assetURLFormat="relative-from-out",e.useSplashScreen&&({logo:s,background:n}=await Editor.Profile.getProject("builder","splash-setting"),"custom"===s.type&&s.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(s.image))||"custom"===n.type&&n.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(n.image)))&&console.error("The width or height of the splash screen image cannot be larger than 2048 for wechatgame!"),t.staticsInfo.B100011=i.orientation,t.staticsInfo.B100013=i.appid,(0,path_1.join)(t.paths.dir,OPEN_DATA_CONTEXT_ROOT)),n=(0,path_1.join)(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);(0,fs_extra_1.existsSync)(n)?(0,fs_extra_1.moveSync)(n,s):i.buildOpenDataContextTemplate&&(t=e.engineInfo.typescript.path,n=(0,path_1.join)(t,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT),(0,fs_extra_1.copySync)(n,s)),e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage&&!i.separateEngine}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.importMapFormat="commonjs"}async function onAfterBundleBuildTask(e,t,a){const i=[];t.forEach(e=>{var t;e.isSubpackage&&(t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${ejs_1.name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,i.push({name:e.name,root:`subpackages/${e.name}/`}))}),i.length&&(e.packages.wechatgame.subpackages=i)}function validRatio(i){return new Promise((e,t)=>{const a=new Image;a.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(i).toString("base64"),a.onload=function(){(2048<a.width||2048<a.height)&&e(!1),e(!0)},a.onerror=function(e){t(e)}})}async function onAfterBuildAssets(e,t,a){e.useSplashScreen||(e.useSplashScreen=!0)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>"project://"+(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")),t.settings.splashScreen)&&(t.settings.splashScreen.totalTime=0)}async function onBeforeCopyBuildTemplate(e,t,a){var i=e.engineInfo.typescript.path;for(const p of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/wechat",`${p}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,p+".js"));var s,n,r,o=(0,path_1.join)(t.paths.dir,"game.js");e.md5CacheOptions.replaceOnly.push("game.js"),this.buildTemplate.findFile("game.js")||(s=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),n=t.settings.engine.macros?.ENABLE_TRANSPARENT_CANVAS,r=t.settings.engine.macros?.ENABLE_WEBGL_ANTIALIAS,n={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(share_1.Paths.internalTemplateDir,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===n?"default":n,antialias:void 0===r?"default":r,useWebgl2:e.includeModules.includes("gfx-webgl2")},r=await ejs_1.default.renderFile(s,n),(0,fs_extra_1.writeFileSync)(o,r,"utf8"))}async function onAfterCopyBuildTemplate(e,t){await buildGameJson(t.paths.dir,e,t,this.buildTemplate.findFile("game.json")),buildProjectConfig(t.paths.dir,e,this.buildTemplate.findFile("project.config.json"))}async function onAfterBuild(e,t){await buildWeChatSplash(t);var a,i,s,n,r=(0,path_1.join)(t.paths.dir,"first-screen.js");this.buildTemplate.findFile("first-screen.js")||(t=t.settings.splashScreen,e=e.designResolution||{},a=(0,path_1.join)(share_1.Paths.internalTemplateDir,"first-screen.ejs"),n=(i=t.background||{type:"default"}).color,s=t.logo||{type:"default"},t={displayRatio:t.displayRatio??1,bgColor:n?[n.x,n.y,n.z,n.w]:[0,0,0,1],useCustomBg:"custom"===i.type,useLogo:"none"!==s.type,useDefaultLogo:"default"===s.type,logoName:(0,path_1.basename)(s.image||"logo.png"),bgName:(0,path_1.basename)(i.image||"background.png"),fitWidth:e.fitWidth??!0,fitHeight:e.fitHeight??!0},n=await ejs_1.default.renderFile(a,t),(0,fs_extra_1.writeFileSync)(r,n,"utf8"))}async function buildWeChatSplash(s){var e=await Editor.Message.request("information","query-information","customSplash"),t=await Editor.Profile.getProject("builder","splash-setting"),a={logo:"",background:"",slogan:""};e&&e.data&&e.data.enable&&!e.data[e.data.id].complete?(a.logo=(0,path_1.join)(share_1.Paths.internalTemplateDir,"logo.png"),a.slogan=(0,path_1.join)(share_1.Paths.internalTemplateDir,"slogan.png")):("default"===t.logo.type?(a.logo=(0,path_1.join)(share_1.Paths.internalTemplateDir,"logo.png"),a.slogan=(0,path_1.join)(share_1.Paths.internalTemplateDir,"slogan.png")):"custom"===t.logo.type&&t.logo.image&&(a.logo=Editor.UI.__protected__.File.resolveToRaw(t.logo.image)),"custom"===t.background.type&&t.background.image&&(a.background=Editor.UI.__protected__.File.resolveToRaw(t.background.image)));const n=s.settings.splashScreen,r=[];Object.entries(a).forEach(([e,t])=>{if(t)try{var a=(0,path_1.parse)(t)["ext"],i=(0,path_1.join)(s.paths.dir,""+e+a);r.push({source:t,target:i}),n?.logo&&"logo"===e&&(n.logo.image=(0,path_1.relative)(s.paths.settings,i),n.logo.base64=""),n?.background&&"background"===e&&(n.background.image=(0,path_1.relative)(s.paths.settings,i))}catch(e){console.warn(e)}}),await Promise.all(r.map(({source:e,target:t})=>(0,fs_extra_1.copyFile)(e,t)));e=(0,fs_extra_1.readFileSync)(s.paths.settings,"utf8"),t=JSON.parse(e);t.splashScreen=n,(0,fs_extra_1.writeFileSync)(s.paths.settings,JSON.stringify(t,null,0),"utf8")}function buildProjectConfig(e,t,a){var i=t.packages.wechatgame,s=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"project.config.json")),a=(a&&(a=(0,fs_extra_1.readJSONSync)(a),Object.assign(s,a)),s.appid=i.appid||"wx6ac3f5090a6b99c5",s.projectname=t.name,t.server&&t.useBuiltinServer&&(s.packOptions={ignore:[{type:"folder",value:"remote"}]}),(0,path_1.join)(e,"project.config.json"));t.md5CacheOptions.excludes.push("project.config.json"),(0,fs_extra_1.outputJSONSync)(a,s)}async function buildGameJson(e,t,a,i){var s=t.packages.wechatgame,n=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json"));if(i&&(i=(0,fs_extra_1.readJSONSync)(i),Object.assign(n,i)),n.deviceOrientation=s.orientation,s.separateEngine){var i=(0,path_1.join)(share_1.Paths.internalTemplateDir,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(i)&&(e=await Editor.Profile.getConfig("utils",Editor.App.version.replace(".","_")+"_plugin_version.wechatgame")||Editor.App.version),n.plugins={cocos:{version:e,provider:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).provider}}}s.buildOpenDataContextTemplate&&(n.openDataContext=OPEN_DATA_CONTEXT_ROOT),n.openDataContext||delete n.openDataContext,s.highPerformanceMode?n.iOSHighPerformance=!0:delete n.iOSHighPerformance,s.wasmSubpackage&&!s.separateEngine&&(i=(0,path_1.join)(a.paths.engineDir,"./assets/"),a=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(i)&&(s.subpackages??=[],s.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(a))&&(s.subpackages??=[],s.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"})),s.subpackages&&(n.subpackages=s.subpackages);i=(0,path_1.join)(e,"game.json");t.md5CacheOptions.excludes.push("game.json"),(0,fs_extra_1.outputJSONSync)(i,n,{spaces:4})}exports.throwError=!0;