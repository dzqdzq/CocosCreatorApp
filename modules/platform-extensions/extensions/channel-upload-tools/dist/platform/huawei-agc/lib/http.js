"use strict";const Constant=require("../const"),request=require("request"),md5=require("md5"),url=require("url"),release_url="https://creator-api.cocos.com/",agentOptions={},creatorVersion=Editor.App.version,parseParameter=async function(t){return t.version=creatorVersion,signParam(t,Constant.PLUGIN_ID,Constant.PLUGIN_SECRET)};function signParam(e,t,s){e.plugin_id=t;t=Object.keys(e).sort();const r={};t.forEach(t=>{r[t]=e[t]});let o="";for(const n in r)o+=`${n}=${encodeURIComponent(r[n])}&`;return o+=s,e.sign=md5(o),e}module.exports={sessionToken:null,post(t,e){return new Promise((r,o)=>{request.post({url:t,json:!0,form:e,agentOptions:agentOptions},(t,e,s)=>{t||200!==e.statusCode?o({status:e.statusCode,msg:t}):r(s)})})},async fetchOAuthUrl(){var t={session_token:await this.getSessionToken(),lang:Editor.I18n.getLanguage()||"en"};return this.post("https://creator-api.cocos.com/api/hms/get_oauth_url",await parseParameter(t))},async fetchOAuthToken(){var t={session_token:await this.getSessionToken()};return this.post("https://creator-api.cocos.com/api/hms/get_tp_info",await parseParameter(t))},async getSessionToken(){var t;return this.sessionToken||((t=await this.fetchSessionToken(Constant.PLUGIN_ID,Constant.PLUGIN_SECRET))&&t.data.session_token?(this.sessionToken=t.data.session_token,this.sessionToken):void console.error("get plugin session token error"))},async fetchSessionToken(t,e){var s=url.resolve(release_url,"api/session/token"),t=await signParam({session_code:(await Editor.User.getSessionCode(t)).session_code,ip:"127.0.0.1",plugin_id:t,client_type:1},t,e);try{var r=await Editor.Network.post(s,t);return JSON.parse(r.toString())}catch(t){console.error(t)}},async getOAuthToken(){var t=await this.fetchOAuthToken();if(t&&t.data.tp_access_token)return t.data.tp_access_token;console.error("get plugin tp access token url error")},async getOAuthUrl(){var t=await this.fetchOAuthUrl();if(t&&t.data.oauth_url)return{url:t.data.oauth_url,redirect:t.data.redirect_url};console.error("get plugin login url error")},async needLogin(){let t=!1;var e=await this.fetchOAuthToken();return e?t=720===e.status||721===e.status||t:(console.error("get plugin login url error"),!0)},async logout(){var t={session_token:await this.getSessionToken()};return this.post("https://creator-api.cocos.com/api/hms/unbind_oauth",await parseParameter(t))}};