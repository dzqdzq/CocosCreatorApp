"use strict";const Constant=require("../const"),request=require("request"),md5=require("md5"),url=require("url"),release_url="https://creator-api.cocos.com/",agentOptions={ciphers:"ALL",secureProtocol:"TLSv1_method"},creatorVersion=Editor.App.version,parseParameter=async function(t){return t.version=creatorVersion,await signParam(t,Constant.PLUGIN_ID,Constant.PLUGIN_SECRET)};function signParam(t,e,s){t.plugin_id=e;const o={};Object.keys(t).sort().forEach(e=>{o[e]=t[e]});let n="";for(const t in o)n+=`${t}=${encodeURIComponent(o[t])}&`;return n+=s,t.sign=md5(n),t}module.exports={sessionToken:null,post:(t,e)=>new Promise((s,o)=>{request.post({url:t,json:!0,form:e,agentOptions:agentOptions},(t,e,n)=>{t||200!==e.statusCode?o({status:e.statusCode,msg:t}):s(n)})}),async fetchOAuthUrl(){const t={session_token:await this.getSessionToken(),lang:Editor.I18n.getLanguage()||"en"};return await this.post("https://creator-api.cocos.com/api/hms/get_oauth_url",await parseParameter(t))},async fetchOAuthToken(){const t={session_token:await this.getSessionToken()};return await this.post("https://creator-api.cocos.com/api/hms/get_tp_info",await parseParameter(t))},async getSessionToken(){if(this.sessionToken)return this.sessionToken;const t=await this.fetchSessionToken(Constant.PLUGIN_ID,Constant.PLUGIN_SECRET);if(t&&t.data.session_token)return this.sessionToken=t.data.session_token,this.sessionToken;console.error("get plugin session token error")},async fetchSessionToken(t,e){const s=url.resolve(release_url,"api/session/token");let o={session_code:(await Editor.User.getSessionCode(t)).session_code,ip:"127.0.0.1",plugin_id:t,client_type:1};o=await signParam(o,t,e);const n=await Editor.Network.post(s,o);return JSON.parse(n.toString())},async getOAuthToken(){const t=await this.fetchOAuthToken();if(t&&t.data.tp_access_token)return t.data.tp_access_token;console.error("get plugin tp access token url error")},async getOAuthUrl(){const t=await this.fetchOAuthUrl();if(t&&t.data.oauth_url)return{url:t.data.oauth_url,redirect:t.data.redirect_url};console.error("get plugin login url error")},async needLogin(){let t=!1;const e=await this.fetchOAuthToken();return e?(720!==e.status&&721!==e.status||(t=!0),t):(console.error("get plugin login url error"),!0)},async logout(){const t={session_token:await this.getSessionToken()};return await this.post("https://creator-api.cocos.com/api/hms/unbind_oauth",await parseParameter(t))}};