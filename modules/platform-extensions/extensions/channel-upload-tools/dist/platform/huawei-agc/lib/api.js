"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.API=void 0;const fs_extra_1=require("fs-extra"),Network=require("../../../utils/network"),Constant=require("../const"),MAX_APK_SIZE=4294967296,{AuditInfo:AuditInfo,AppInfo:AppInfo,ErrorCode:ErrorCode,AccessTokenRet:AccessTokenRet,AppInfoRet:AppInfoRet,UploadUrlRet:UploadUrlRet,UploadRet:UploadRet,UpdateAPKRet:UpdateAPKRet}=require("./entity");class API{constructor(e,t,r){this.loginType=e,this.accessToken=t,e===Constant.LOGIN_TYPE.client&&(this.clientID=r)}get oAuthLogin(){return this.loginType===Constant.LOGIN_TYPE.oauth}genHeader(){const e={};return this.oAuthLogin?e.oauth2Token=this.accessToken:(e.Authorization=`Bearer ${this.accessToken}`,e.client_id=this.clientID),e}static async getAccessToken(e,t){const r=new AccessTokenRet,s=API.HOST+"/api/oauth2/v1/token",o={grant_type:"client_credentials",client_id:e,client_secret:t};try{let e=await Network.postAsync(s,JSON.stringify(o));(e=JSON.parse(e)).access_token&&(r.code=ErrorCode.success,r.accessToken=e.access_token)}catch(e){r.errorMessage=e}return r}async queryAppInfo(e){const t=new AppInfoRet,r=API.HOST+"/api/publish/v2/app-info",s={appId:e};try{let e=await Network.getAsync(r,s,this.genHeader());0===(e=JSON.parse(e)).ret.code&&(t.code=ErrorCode.success,e.appInfo=new AppInfo(e.appInfo),e.auditInfo=new AuditInfo(e.auditInfo))}catch(e){t.errorMessage=e}return t}async getUploadUrl(e,t){const r=new UploadUrlRet,s=API.HOST+"/api/publish/v2/upload-url",o={appId:e,suffix:t||"apk"};try{let e=await Network.getAsync(s,o,this.genHeader());(e=JSON.parse(e)).uploadUrl&&(r.code=ErrorCode.success,r.uploadUrl=e.uploadUrl,e.chunkUploadUrl&&(r.chunkUploadUrl=e.chunkUploadUrl),r.authCode=e.authCode)}catch(e){r.errorMessage=e}return r}async uploadFile(e,t,r){const s=new UploadRet;if(!fs_extra_1.existsSync(t))return s.code=ErrorCode.fileNotExists,s;if(fs_extra_1.statSync(t).size>MAX_APK_SIZE)return s.code=ErrorCode.fileTooLarge,s;try{let o=await Network.uploadFile(e,t,r);(o=(o=JSON.parse(o)).result).UploadFileRsp&&o.UploadFileRsp.ifSuccess&&(s.code=ErrorCode.success,s.files=o.UploadFileRsp.fileInfoList.map(e=>({fileDestUrl:e.fileDestUlr,size:e.size})))}catch(e){s.errorMessage=e}return s}async updateApkInfo(e,t,r,s=1){const o=new UpdateAPKRet,a=API.HOST+"/api/publish/v2/app-file-info";try{const n={appId:e,releaseType:s},c={fileType:5,files:[{fileName:t,fileDestUrl:r}]};let i=await Network.putAsync(a,n,this.genHeader(),JSON.stringify(c));0===(i=(i=JSON.parse(i)).ret).code?o.code=ErrorCode.success:o.errorMessage=i.msg}catch(e){o.errorMessage=e}return o}}exports.API=API,API.HOST="https://connect-api.cloud.huawei.com";