"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),Constant=require("./const"),Http=require("./lib/http"),{API:API}=require("./lib/api"),{ErrorCode:ErrorCode}=require("./lib/entity"),Pkg=require("../../../package.json");let comp;var UPLOAD_STATE;!function(o){o[o.fail=0]="fail",o[o.idle=1]="idle",o[o.fetch_token=2]="fetch_token",o[o.fetch_token_fail=3]="fetch_token_fail",o[o.fetch_url=4]="fetch_url",o[o.fetch_url_fail=5]="fetch_url_fail",o[o.upload=6]="upload",o[o.upload_fail=7]="upload_fail",o[o.update_info=8]="update_info",o[o.update_info_fail=9]="update_info_fail",o[o.success=10]="success",o[o.cancel=11]="cancel"}(UPLOAD_STATE||(UPLOAD_STATE={})),module.exports={name:`${Constant.PLATFORM}-upload-list`,template:(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static",`platform/${Constant.PLATFORM}/upload-list.html`),"utf8"),props:["info","compName"],async created(){comp=this,await comp.loadHistory(),comp.needUpload&&(await comp.prepareApi(),await comp.uploadApk())},computed:{btnStatus:()=>comp.pause?comp.t("resume"):comp.t("pause"),historyTips:()=>(comp.toggle?"▼ ":"▶ ")+comp.t("history"),uploading:()=>!!comp.info.config&&comp.info.config.version&&comp.uploadState!==UPLOAD_STATE.success&&comp.uploadState!==UPLOAD_STATE.cancel,needUpload:()=>!!comp.info.config&&comp.info.config.version,showBtns:()=>!comp.cancel&&comp.uploading,processFail:()=>[0,3,5,7,9].includes(comp.uploadState)},data:function(){return{toggle:!1,uploadProgress:0,pause:!1,uploadState:UPLOAD_STATE.idle,progressTips:"",history:[],page:this.compName,cancel:!1}},watch:{history:{deep:!0,async handler(){await comp.save()}},page:function(o){comp.$emit("update:compName",o)}},methods:{toggleClick(){comp.toggle=!comp.toggle},returnClick(){comp.cancelClick(),comp.page=`${Constant.PLATFORM}-upload`},cancelClick(){comp.cancel=!0,comp.checkCancel()},async loadHistory(){comp.history=await Editor.Profile.getConfig(Pkg.name,`options.${Constant.PLATFORM}.history`,"local")||[]},addHistory(){comp.history.length>=Constant.MAX_HISTORY_LENGTH&&comp.history.pop(),comp.history.unshift({time:Date.now(),description:comp.info.config.description,version:comp.info.config.version})},changeState(o){const e=comp.getStateKey(o);comp.uploadState=o,comp.progressTips=comp.t(e)},getStateKey(o){for(const e in UPLOAD_STATE)if(o===UPLOAD_STATE[e])return e},formatTime:o=>new Date(o).toLocaleString("zh"===Editor.I18n.getLanguage()?"zh-cn":"en"),async save(){Editor.Profile.setConfig(Pkg.name,`options.${Constant.PLATFORM}.history`,comp.history,"local")},checkCancel:()=>!!comp.cancel&&(comp.uploadProgress=0,comp.changeState(UPLOAD_STATE.cancel),!0),async prepareApi(){let o;if(comp.info.config.loginType===Constant.LOGIN_TYPE.oauth)o=await Http.getOAuthToken();else{o=(await API.getAccessToken(comp.info.config.clientId,comp.info.config.clientSecret)).accessToken}comp.api=new API(comp.info.config.loginType,o,comp.info.config.clientId)},async uploadApk(){if(comp.uploadProgress=10,comp.checkCancel())return;comp.uploadProgress=20,comp.changeState(UPLOAD_STATE.fetch_url);const o=await comp.api.getUploadUrl(comp.info.config.appid,"apk");if(o.code!==ErrorCode.success)return comp.uploadProgress=100,comp.changeState(UPLOAD_STATE.fetch_url_fail),void console.error("Fetch upload url fail,",o.errorMessage);if(comp.checkCancel())return;comp.uploadProgress=30,comp.changeState(UPLOAD_STATE.upload);const e=await comp.api.uploadFile(o.uploadUrl,comp.info.config.apkPath,o.authCode);if(e.code!==ErrorCode.success)return comp.uploadProgress=100,comp.changeState(UPLOAD_STATE.upload_fail),void console.error("Upload fail,",e.errorMessage);if(comp.checkCancel())return;comp.uploadProgress=90;const c=(0,path_1.basename)(comp.info.config.apkPath);comp.changeState(UPLOAD_STATE.update_info);const a=await comp.api.updateApkInfo(comp.info.config.appid,c,e.files[0].fileDestUrl);if(a.code!==ErrorCode.success)return comp.uploadProgress=100,comp.changeState(UPLOAD_STATE.update_info_fail),void console.error("Update apk info fail,",a.errorMessage);comp.changeState(UPLOAD_STATE.success),comp.uploadProgress=100,comp.addHistory()},t:o=>Editor.I18n.t(`channel-upload-tools.${o}`)}};