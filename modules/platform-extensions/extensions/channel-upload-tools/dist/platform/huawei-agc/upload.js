"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),Constant=require("./const"),Http=require("./lib/http");let comp;module.exports={platform:Constant.PLATFORM,name:`${Constant.PLATFORM}-upload`,template:fs_extra_1.readFileSync(path_1.join(__dirname,"../../../static",`platform/${Constant.PLATFORM}/upload.html`),"utf8"),props:["info","compName"],async created(){const t=this;global.xxxx=this,comp=t,t._registerEvent();const o=await Editor.Profile.getConfig(Constant.PLATFORM,"config")||{};o&&Object.keys(t.config).forEach(e=>{const n=o[e];n&&(t.config[e]=n)}),t.config.loginType===Constant.LOGIN_TYPE.oauth&&await t.checkNeedLogin()},computed:{oAuth(){return this.config.loginType===Constant.LOGIN_TYPE.oauth},showLoginBtn(){return this.oAuth&&this.needLogin},isLogin(){return!this.needLogin&&this.oAuth}},data:function(){return{config:{loginType:Constant.LOGIN_TYPE.oauth,clientId:"",clientSecret:"",appid:"",version:"1.0",apkPath:"",description:""},page:this.compName,loginChecked:!1,loading:!1,needLogin:!0,accessToken:"",loginType:[{type:Constant.LOGIN_TYPE.oauth,name:this.t("oauth")},{type:Constant.LOGIN_TYPE.client,name:this.t("client")}]}},watch:{page:function(t){comp.$emit("update:compName",t)},info(t){comp.$emit("update:info",t)},async"config.loginType"(t){if(t===Constant.LOGIN_TYPE.oauth){if(comp.loginChecked)return;await comp.checkNeedLogin()}},config:{async handler(t){let o=await Editor.Profile.getConfig(Constant.PLATFORM,"config")||{};o=Object.assign(o,t),Editor.Profile.setConfig(Constant.PLATFORM,"config",o,"local")},deep:!0}},methods:{oauthTypeChange(t){this.config.loginType=t.target.value},async checkNeedLogin(){const t=this;await Editor.User.isLoggedIn()?(t.loading=!0,t.needLogin=await Http.needLogin(),t.loading=!1,t.loginChecked=!0):t.popupWarns(comp.t("need_login"))},_registerEvent(){this.$root.$on("loginResult",this.updateLoginResult),this.$root.$on("oAuthWindowClose",this.oAuthWindowClose)},async updateLoginResult(t,o){const e=this;t===module.exports.platform&&"success"===o&&(e.needLogin=await Http.needLogin(),e.accessToken=await Http.getOAuthToken(),e.loading=!1)},async oAuthWindowClose(){comp.needLogin=await Http.needLogin(),comp.loading=!1},async onChooseDistPathClick(t){t.stopPropagation()},async onUpdateValue(t,o){t.stopPropagation(),comp.config[o]=t.target.value},cancelClick(){Editor.Panel.close("channel-upload-tools")},popupWarns:t=>Editor.Dialog.warn(t,{title:comp.t("notice_title"),buttons:[comp.t("confirm")],default:-1,cancel:-1}),async oauthClick(){if(comp.loading=!0,!await Editor.User.isLoggedIn())return comp.loading=!1,comp.popupWarns(comp.t("need_login"));const t=await Http.getOAuthUrl();t?Editor.Panel.open("channel-upload-tools.oauth",{platform:Constant.PLATFORM,url:t.url,redirect:t.redirect,method:"loginResult"}):console.error("Get OAuth url fail, please retry")},async uploadClick(){const t=this;if(t.oAuth||t.config.clientId)if(t.oAuth||t.config.clientSecret)if(t.config.appid)if(t.config.version)if(t.config.apkPath&&fs_extra_1.existsSync(path_1.normalize(t.config.apkPath)))if(t.oAuth&&t.needLogin){0===(await t.popupWarns(t.t("need_huawei_login"))).response&&t.oauthClick()}else t.info.config=t.config,t.page=`${Constant.PLATFORM}-upload-list`;else t.popupWarns(t.t("need_apk"));else t.popupWarns(t.t("need_version"));else t.popupWarns(t.t("need_appid"));else t.popupWarns(t.t("need_client_secret"));else t.popupWarns(t.t("need_clientid"))},async logoutClick(){comp.loading=!0;try{await Http.logout(),await comp.checkNeedLogin()}catch(t){}comp.loading=!1},t:t=>Editor.I18n.t(`channel-upload-tools.${t}`)}};