"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuild=onAfterBuild;const fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),json5_1=__importDefault(require("json5"));async function generateOptions(t){var t=t.packages["harmonyos-next"],e=(t.orientation=t.orientation||{},await Editor.Message.request("program","query-program-info","OpenHarmonySDK")),a=await Editor.Message.request("program","query-program-info","OpenHarmonyNDK");return t.sdkPath=e?e.path:"",t.ndkPath=a?a.path:"",{packageName:t.packageName||"",orientation:t.orientation,appABIs:t.appABIs||[],sdkPath:t.sdkPath||"",ndkPath:t.ndkPath||"",renderBackEnd:{gles3:t.renderBackEnd?.gles3??!0},useAotOptimization:t.useAotOptimization,jsEngine:t.jsEngine}}async function onBeforeBuild(t,e,a){t.sourceMaps=!1}async function onAfterInit(t,e,a){var s=await generateOptions(t);const n=(t.packages["harmonyos-next"]=s).renderBackEnd,r=(t.buildEngineParam.preserveType=s.useAotOptimization,e.staticsInfo.B100005=s.packageName,e.staticsInfo.B100011=s.orientation,t.cocosParams);Object.keys(n).forEach(t=>{r.cMakeConfig["CC_USE_"+t.toUpperCase()]=n[t]}),"JSVM"===s.jsEngine?(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 OFF)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI OFF)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM ON)"):"V8"===s.jsEngine?(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 ON)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI OFF)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM OFF)"):"ARK"===s.jsEngine&&(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 OFF)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI ON)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM OFF)",r.encrypted=!1),Object.assign(r.platformParams,s),await(0,fs_extra_1.outputJSON)(e.paths.compileConfig,r)}function onAfterBundleInit(t){"ARK"===t.packages["harmonyos-next"].jsEngine&&(t.buildScriptParam.importMapFormat="esm");var e=t.packages["harmonyos-next"].renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=e.gles3??!0}async function onAfterBuild(e,a,t){var s=e.packages["harmonyos-next"]["useAotOptimization"],n=("ARK"===e.packages["harmonyos-next"].jsEngine&&(i="export default "+(i=(0,fs_extra_1.readFileSync)(a.paths.settings,"utf8")),i=await Build.Utils.transformCode(i,{importMapFormat:"systemjs"}),(0,fs_extra_1.unlinkSync)(a.paths.settings),n=(0,path_1.join)((0,path_1.dirname)(a.paths.settings),"settings.js"),(0,fs_extra_1.outputFileSync)(n,i,"utf8")),(0,path_1.join)(a.paths.dir,"assets"));const r=(0,path_1.join)(Editor.Project.path,"native/engine",e.platform,"entry/src/main");var i=(0,path_1.join)(r,"ets/cocos/src/cocos-js/assets"),o=(0,path_1.join)(Editor.Project.path,"native/engine",e.platform,"entry"),p=(0,path_1.join)(o,"src/main/ets/cocos/src/effect.bin"),_=(0,path_1.join)(r,"resources/rawfile/Resources");const c=(0,path_1.join)(_,"assets");var f=(0,path_1.join)(_,"cocos-js/assets"),h=(0,path_1.join)(_,"src/effect.bin"),n=(await(0,fs_extra_2.emptyDir)(c),await(0,fs_extra_2.ensureDir)(c),await(0,fs_extra_1.pathExists)(n)?await(0,fs_extra_2.copy)(n,c):console.debug(`assets directory not found: ${n}, the bundles may be configured as remote bundles.`),(0,path_1.join)(a.paths.dir,"src"));if(await(0,fs_extra_2.emptyDir)((0,path_1.join)(r,"ets/cocos/src")),await(0,fs_extra_2.emptyDir)((0,path_1.join)(r,"ets/cocos/assets")),await(0,fs_extra_2.copy)(n,(0,path_1.join)(r,"ets/cocos/src")),"V8"===e.packages["harmonyos-next"].jsEngine||"JSVM"===e.packages["harmonyos-next"].jsEngine){var u=(0,path_1.join)(r,"ets/cocos");for(const S of["jsb-adapter","src"]){var m=(0,path_1.join)(u,S),l=(0,path_1.join)(_,S);await(0,fs_extra_2.ensureDir)(l),await(0,fs_extra_2.emptyDir)(l),await(0,fs_extra_2.copy)(m,l),await(0,fs_extra_1.rm)(m,{force:!0,recursive:!0})}var n=(0,path_1.join)(r,"ets/cocos",(0,path_1.basename)(a.paths.applicationJS)),n=((0,fs_extra_1.existsSync)(n)&&await(0,fs_extra_1.rm)(n,{force:!0,recursive:!0}),await(0,fs_extra_2.copy)(a.paths.applicationJS,(0,path_1.join)(_,(0,path_1.basename)(a.paths.applicationJS))),(0,path_1.join)(a.paths.dir,"main.js")),d=(0,path_1.join)(_,"main.js");await(0,fs_extra_2.copy)(n,d)}else await(0,fs_extra_2.copy)(a.paths.applicationJS,(0,path_1.join)(r,"ets/cocos",(0,path_1.basename)(a.paths.applicationJS))),this.bundleManager.bundles.forEach(t=>{t.isRemote||((0,fs_extra_2.moveSync)((0,path_1.join)(c,t.name,(0,path_1.basename)(t.scriptDest)),(0,path_1.join)(r,"ets/cocos/assets",t.name,(0,path_1.basename)(t.scriptDest))),e.sourceMaps&&(0,fs_extra_2.moveSync)((0,path_1.join)(c,t.name,"index.js.map"),(0,path_1.join)(r,"ets/cocos/assets",t.name,"index.js.map")))}),(0,fs_extra_1.existsSync)(i)&&(await(0,fs_extra_2.ensureDir)(f),await(0,fs_extra_2.emptyDir)(f),await(0,fs_extra_2.copy)(i,f),await(0,fs_extra_1.rm)(i,{force:!0,recursive:!0})),(0,fs_extra_1.existsSync)(p)&&await(0,fs_extra_2.copy)(p,h);const g=[];this.bundleManager.bundles.forEach(t=>{t.isRemote||g.push(t.name+"/"+(0,path_1.basename)(t.scriptDest))});var j=[];for(const y in a.paths.plugins){var x=a.paths.plugins[y],x=(0,path_1.relative)(a.paths.dir,x);j.push(x.split("\\").join("/"))}n=e.engineInfo;if("ARK"===e.packages["harmonyos-next"].jsEngine){d=(0,path_1.join)(n.typescript.path,"templates/harmonyos-next/entry/src/main/ets/cocos/game.ts"),f=(0,path_1.join)(r,"ets/cocos/game.ts");let t=(0,fs_extra_2.readdirSync)(a.paths.engineDir);t=t.filter(t=>!(0,fs_extra_1.statSync)((0,path_1.join)(a.paths.engineDir,t)).isDirectory());i=a.importMap.imports.cc.slice(2),p={importMapUrl:(0,path_1.basename)(a.paths.importMap),applicationUrl:(0,path_1.basename)(a.paths.applicationJS),systemBundleUrl:(0,path_1.basename)(a.paths.systemJs),ccUrls:t,systemCCUrl:i,bundleJsList:g,pluginsJsList:j,chunkBundleUrl:"",useAotOptimization:s};(0,fs_extra_1.existsSync)((0,path_1.join)(a.paths.dir,"src/chunks"))&&(h=(0,fs_extra_2.readdirSync)((0,path_1.join)(a.paths.dir,"src/chunks")).find(t=>t.startsWith("bundle")&&t.endsWith(".js")))&&(p.chunkBundleUrl=h),(0,fs_extra_2.writeFileSync)(f,await ejs_1.default.renderFile(d,p),"utf8")}else{i=(0,path_1.join)(r,"ets/cocos/game.ts");(0,fs_extra_1.existsSync)(i)&&await(0,fs_extra_1.rm)(i,{force:!0,recursive:!0})}s=(0,path_1.join)(n.typescript.path,"templates/harmonyos-next/entry/src/main/ets/workers/cocos_worker.ets"),h=(0,path_1.join)(r,"ets/workers/cocos_worker.ets"),f={useV8:"V8"===e.packages["harmonyos-next"].jsEngine||"JSVM"===e.packages["harmonyos-next"].jsEngine},(0,fs_extra_2.writeFileSync)(h,await ejs_1.default.renderFile(s,f),"utf8"),d=(0,path_1.join)(o,"build-profile.json5"),p=json5_1.default.parse((0,fs_extra_1.readFileSync)(d,"utf8"));(0,fs_extra_2.writeFileSync)(d,json5_1.default.stringify(p,null,2),"utf8")}async function getBrowserslistQuery(t){t=(0,path_1.join)(t,".browserslistrc");let e;try{e=await(0,fs_extra_2.readFile)(t,"utf8")}catch(t){return}t=function(t){var e=[];for(const s of t.split("\n")){var a=s.indexOf("#"),a=(a<0?s:s.substr(0,a)).trim();0!==a.length&&e.push(a)}return e}(e);if(0!==t.length)return t.join(" or ")}exports.throwError=!0;