"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuild=onAfterBuild,exports.openWithIDE=openWithIDE;const fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),json5_1=__importDefault(require("json5"));async function generateOptions(e){var e=e.packages["harmonyos-next"],t=(e.orientation=e.orientation||{},e.deviceTypes=e.deviceTypes||{},await Editor.Message.request("program","query-program-info","OpenHarmonySDK")),a=await Editor.Message.request("program","query-program-info","OpenHarmonyNDK");return e.sdkPath=t?t.path:"",e.ndkPath=a?a.path:"",{packageName:e.packageName||"",orientation:e.orientation,deviceTypes:e.deviceTypes,appABIs:e.appABIs||[],sdkPath:e.sdkPath||"",ndkPath:e.ndkPath||"",renderBackEnd:{gles3:e.renderBackEnd?.gles3??!0},useAotOptimization:e.useAotOptimization,jsEngine:e.jsEngine,useGamepad:e.useGamepad}}async function onBeforeBuild(e,t,a){e.sourceMaps=!1}async function onAfterInit(e,t,a){var s=await generateOptions(e);const n=(e.packages["harmonyos-next"]=s).renderBackEnd,r=(e.buildEngineParam.preserveType=s.useAotOptimization,t.staticsInfo.B100005=s.packageName,t.staticsInfo.B100011=s.orientation,e.cocosParams);Object.keys(n).forEach(e=>{r.cMakeConfig["CC_USE_"+e.toUpperCase()]=n[e]}),"JSVM"===s.jsEngine?(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 OFF)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI OFF)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM ON)"):"V8"===s.jsEngine?(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 ON)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI OFF)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM OFF)"):"ARK"===s.jsEngine&&(r.cMakeConfig.USE_SE_V8="set(USE_SE_V8 OFF)",r.cMakeConfig.USE_SE_NAPI="set(USE_SE_NAPI ON)",r.cMakeConfig.USE_SE_JSVM="set(USE_SE_JSVM OFF)",r.encrypted=!1),s.useGamepad?r.cMakeConfig.USE_GAMEPAD="set(USE_GAMEPAD ON)":r.cMakeConfig.USE_GAMEPAD="set(USE_GAMEPAD OFF)",Object.assign(r.platformParams,s),await(0,fs_extra_1.outputJSON)(t.paths.compileConfig,r)}function onAfterBundleInit(e){"ARK"===e.packages["harmonyos-next"].jsEngine&&(e.buildScriptParam.importMapFormat="esm");var t=e.packages["harmonyos-next"].renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl3=t.gles3??!0}async function onAfterBuild(t,a,e){var s=t.packages["harmonyos-next"]["useAotOptimization"],n=("ARK"===t.packages["harmonyos-next"].jsEngine&&(i="export default "+(i=(0,fs_extra_1.readFileSync)(a.paths.settings,"utf8")),i=await Build.Utils.transformCode(i,{importMapFormat:"systemjs"}),(0,fs_extra_1.unlinkSync)(a.paths.settings),n=(0,path_1.join)((0,path_1.dirname)(a.paths.settings),"settings.js"),(0,fs_extra_1.outputFileSync)(n,i,"utf8")),(0,path_1.join)(a.paths.dir,"assets"));const r=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry/src/main");var i=(0,path_1.join)(r,"ets/cocos/src/cocos-js/assets"),o=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry"),p=(0,path_1.join)(o,"src/main/ets/cocos/src/effect.bin"),c=(0,path_1.join)(r,"resources/rawfile/Resources");const _=(0,path_1.join)(c,"assets");var f=(0,path_1.join)(c,"cocos-js/assets"),h=(0,path_1.join)(c,"src/effect.bin"),n=(await(0,fs_extra_2.emptyDir)(_),await(0,fs_extra_2.ensureDir)(_),await(0,fs_extra_1.pathExists)(n)?await(0,fs_extra_2.copy)(n,_):console.debug(`assets directory not found: ${n}, the bundles may be configured as remote bundles.`),(0,path_1.join)(a.paths.dir,"src"));if(await(0,fs_extra_2.emptyDir)((0,path_1.join)(r,"ets/cocos/src")),await(0,fs_extra_2.emptyDir)((0,path_1.join)(r,"ets/cocos/assets")),await(0,fs_extra_2.copy)(n,(0,path_1.join)(r,"ets/cocos/src")),"V8"===t.packages["harmonyos-next"].jsEngine||"JSVM"===t.packages["harmonyos-next"].jsEngine){var u=(0,path_1.join)(r,"ets/cocos");for(const x of["jsb-adapter","src"]){var m=(0,path_1.join)(u,x),d=(0,path_1.join)(c,x);await(0,fs_extra_2.ensureDir)(d),await(0,fs_extra_2.emptyDir)(d),await(0,fs_extra_2.copy)(m,d),await(0,fs_extra_1.rm)(m,{force:!0,recursive:!0})}var n=(0,path_1.join)(r,"ets/cocos",(0,path_1.basename)(a.paths.applicationJS)),n=((0,fs_extra_1.existsSync)(n)&&await(0,fs_extra_1.rm)(n,{force:!0,recursive:!0}),await(0,fs_extra_2.copy)(a.paths.applicationJS,(0,path_1.join)(c,(0,path_1.basename)(a.paths.applicationJS))),(0,path_1.join)(a.paths.dir,"main.js")),l=(0,path_1.join)(c,"main.js");await(0,fs_extra_2.copy)(n,l)}else await(0,fs_extra_2.copy)(a.paths.applicationJS,(0,path_1.join)(r,"ets/cocos",(0,path_1.basename)(a.paths.applicationJS))),this.bundleManager.bundles.forEach(e=>{e.isRemote||((0,fs_extra_2.moveSync)((0,path_1.join)(_,e.name,(0,path_1.basename)(e.scriptDest)),(0,path_1.join)(r,"ets/cocos/assets",e.name,(0,path_1.basename)(e.scriptDest))),t.sourceMaps&&(0,fs_extra_2.moveSync)((0,path_1.join)(_,e.name,"index.js.map"),(0,path_1.join)(r,"ets/cocos/assets",e.name,"index.js.map")))}),(0,fs_extra_1.existsSync)(i)&&(await(0,fs_extra_2.ensureDir)(f),await(0,fs_extra_2.emptyDir)(f),await(0,fs_extra_2.copy)(i,f),await(0,fs_extra_1.rm)(i,{force:!0,recursive:!0})),(0,fs_extra_1.existsSync)(p)&&await(0,fs_extra_2.copy)(p,h);const E=[];this.bundleManager.bundles.forEach(e=>{e.isRemote||E.push(e.name+"/"+(0,path_1.basename)(e.scriptDest))});var g=[];for(const S in a.paths.plugins){var y=a.paths.plugins[S],y=(0,path_1.relative)(a.paths.dir,y);g.push(y.split("\\").join("/"))}n=t.engineInfo;if("ARK"===t.packages["harmonyos-next"].jsEngine){l=(0,path_1.join)(n.typescript.path,"templates/harmonyos-next/entry/src/main/ets/cocos/game.ts"),f=(0,path_1.join)(r,"ets/cocos/game.ts");let e=(0,fs_extra_2.readdirSync)(a.paths.engineDir);e=e.filter(e=>!(0,fs_extra_1.statSync)((0,path_1.join)(a.paths.engineDir,e)).isDirectory());i=a.importMap.imports.cc.slice(2),p={importMapUrl:(0,path_1.basename)(a.paths.importMap),applicationUrl:(0,path_1.basename)(a.paths.applicationJS),systemBundleUrl:(0,path_1.basename)(a.paths.systemJs),ccUrls:e,systemCCUrl:i,bundleJsList:E,pluginsJsList:g,chunkBundleUrl:"",useAotOptimization:s};(0,fs_extra_1.existsSync)((0,path_1.join)(a.paths.dir,"src/chunks"))&&(h=(0,fs_extra_2.readdirSync)((0,path_1.join)(a.paths.dir,"src/chunks")).find(e=>e.startsWith("bundle")&&e.endsWith(".js")))&&(p.chunkBundleUrl=h),(0,fs_extra_2.writeFileSync)(f,await ejs_1.default.renderFile(l,p),"utf8")}else{i=(0,path_1.join)(r,"ets/cocos/game.ts");(0,fs_extra_1.existsSync)(i)&&await(0,fs_extra_1.rm)(i,{force:!0,recursive:!0})}s=(0,path_1.join)(n.typescript.path,"templates/harmonyos-next/entry/src/main/ets/workers/cocos_worker.ets"),h=(0,path_1.join)(r,"ets/workers/cocos_worker.ets"),f={useV8:"V8"===t.packages["harmonyos-next"].jsEngine||"JSVM"===t.packages["harmonyos-next"].jsEngine},(0,fs_extra_2.writeFileSync)(h,await ejs_1.default.renderFile(s,f),"utf8"),l=(0,path_1.join)(o,"build-profile.json5"),p=json5_1.default.parse((0,fs_extra_1.readFileSync)(l,"utf8"));(0,fs_extra_2.writeFileSync)(l,json5_1.default.stringify(p,null,2),"utf8")}async function openWithIDE(e){var t=await Editor.Message.request("program","query-program-info","devEcoStudio");t&&t.path?Editor.Message.send("builder","execute-hook-task","native","open",e,(0,path_1.dirname)(t.path)):Editor.Dialog.warn(Editor.I18n.t("harmonyos-next.customIcon.ideNotFound"),{title:Editor.I18n.t("harmonyos-next.customIcon.openFailed")})}async function getBrowserslistQuery(e){e=(0,path_1.join)(e,".browserslistrc");let t;try{t=await(0,fs_extra_2.readFile)(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const s of e.split("\n")){var a=s.indexOf("#"),a=(a<0?s:s.substr(0,a)).trim();0!==a.length&&t.push(a)}return t}(t);if(0!==e.length)return e.join(" or ")}exports.throwError=!0;