"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.XcodeProjModifer=void 0;const xcode=require("xcode"),path=__importStar(require("path")),fs=__importStar(require("fs")),console_1=require("console"),plist=__importStar(require("plist")),CFG={CC_LIB_NAME:"libcocos2d iOS AppClip",PRODUCT_TYPE_APPCLIP:"com.apple.product-type.application.on-demand-install-capable",PRODUCT_TYPE_APP:"com.apple.product-type.application",ENTITLEMENT_NAME:"appclip.entitlements",KEY_PARENT:"com.apple.developer.parent-application-identifiers"};class XcodeProjModifer{constructor(e){if(this.cclibAppClip={},this.appClipTarget={},this._iosTargets=[],this._bundeIds=[],this._valid=!0,!e.refXcodeProject.endsWith(".xcodeproj"))throw new Error("refXcodeProject must end with .xcodeproj");if(!e.inputXcodeProj.endsWith(".xcodeproj"))throw new Error("inputXcodeProj must end with .xcodeproj");if(!fs.existsSync(path.join(e.projectResDir,"ios-app-clip")))throw new Error(`${e.projectResDir}/ios-app-clip does not exists`);this.refXcodeProject=e.refXcodeProject,this.inputXcodeProj=e.inputXcodeProj,this.doBackup=e.doBackup,this.appName=e.appName,this.cocosRoot=e.cocosRoot,this.projectResDir=e.projectResDir,this.parseInputProject(),this.createGroups(),this.insertCocosEngineProject()&&(this.recordIOSTargets(),this.recordRefBundleID(),this.getCCLibUUID(),this.addAppClipTarget(),this.setupSourceAndResourceFiles(),this.cloneBuildSettingFromTpl(),this.setupDependencyToCCLib(),this.injectAppClip())}get engineProj(){return path.join(this.cocosRoot,"build/cocos2d_libs.xcodeproj")}get refProjDir(){return path.dirname(this.refXcodeProject)}get inputDir(){return path.dirname(this.inputXcodeProj)}get proj(){return this._proj}get templateProj(){return this._templateProj}parseInputProject(){this._proj=xcode.project(path.join(this.inputXcodeProj,"project.pbxproj")).parseSync(),this._templateProj=xcode.project(path.join(this.refXcodeProject,"project.pbxproj")).parseSync(),this.cocosProj=xcode.project(path.join(this.cocosRoot,"build/cocos2d_libs.xcodeproj/project.pbxproj")).parseSync()}createGroups(){mkdirP(path.join(this.inputDir,"CocosCreator")),this.groupHash=this.proj.pbxCreateGroup("CocosCreator","CocosCreator"),this.groupClass=this.proj.pbxCreateGroup("Classes","Classes"),this.groupOldIOS=this.proj.pbxCreateGroup("ios","ios"),this.groupResource=this.proj.pbxCreateGroup("Resources"),this.groupAppClip=this.proj.pbxCreateGroup("appclip","appclip"),this.groupFrameworks=this.proj.pbxCreateGroup("Frameworks");const e=this.mainGroupUUID;this.proj.addToPbxGroup(this.groupHash,e),this.proj.addToPbxGroup(this.groupClass,this.groupHash),this.proj.addToPbxGroup(this.groupOldIOS,this.groupHash),this.proj.addToPbxGroup(this.groupResource,this.groupHash),this.proj.addToPbxGroup(this.groupAppClip,this.groupHash),this.proj.addToPbxGroup(this.groupFrameworks,this.groupHash)}get mainGroupUUID(){return this.proj.pbxProjectSection()[this.proj.hash.project.rootObject].mainGroup}insertCocosEngineProject(){return this._valid=this._valid&&this.proj.loadAnotherXcodeProj(this.engineProj,this.groupHash,{sourceTree:'"<absolute>"'}),this._valid}getCCLibUUID(){const e=this.proj.findPBXGroupKeyAndType({name:/cocos2d_libs\.xcodeproj/},"PBXFileReference");if(!e)throw new Error(`can not find cocos2d_libs.xcodeproj in ${this.refXcodeProject}`);const t=this.cocosProj.findPBXGroupKeyAndType({name:new RegExp(`${CFG.CC_LIB_NAME}`)},"PBXNativeTarget");if(!t)throw new Error(`can not find ${CFG.CC_LIB_NAME}.a in ${this.engineProj}`);const o=this.proj.generateUuid(),i={isa:"PBXContainerItemProxy",containerPortal:e,containerPortal_comment:"cocos2d_libs.xcodeproj",proxyType:2,remoteGlobalIDString:t,remoteInfo:`"${CFG.CC_LIB_NAME}.a"`},r=this.proj.pbxContainerItemProxySection();r[o]=i,r[o+"_comment"]="PBXContainerItemProxy",this.cclibAppClip.itemProxyUUID=o,this._addCCLibToBuildFileSection()}_addCCLibToBuildFileSection(){const e=`"${CFG.CC_LIB_NAME}.a"`,t=this.proj.findPBXGroupKeyAndType({path:e},"PBXReferenceProxy");if(!t)throw new Error(`Can not find ${e} in PBXReferenceProxy`);const o={uuid:this.proj.generateUuid(),fileRef:t,basename:`${CFG.CC_LIB_NAME}.a`,group:"Frameworks"};this.proj.addToPbxBuildFileSection(o)}addAppClipTarget(){this.appClipTarget=this.proj.addTarget(this.appName,"appclip","CocosCreator/appclip"),this.proj.addTargetDependency(this.appClipTarget.uuid,[this.cclibAppClip.itemProxyUUID])}setupSourceAndResourceFiles(){const e={target:this.appClipTarget.uuid};copyFileOrDir(path.join(this.refProjDir,"ios_appclip"),path.join(this.inputDir,"CocosCreator/appclip")),copyFileOrDir(path.join(this.refProjDir,"ios"),path.join(this.inputDir,"CocosCreator/ios")),copyFileOrDir(path.join(this.refProjDir,"../Classes"),path.join(this.inputDir,"CocosCreator/Classes"));{const t=(e,t,o)=>{e.endsWith(".h")||e.endsWith(".hpp")?this.proj.addHeaderFileForce(e,t,o):this.proj.addSourceFileForce(e,t,o)};t("jsb_module_register.cpp",e,this.groupClass),t("AppDelegate.cpp",e,this.groupClass),t("AppDelegate.h",e,this.groupClass),t("AppController.h",e,this.groupOldIOS),t("AppController.mm",e,this.groupOldIOS),t("RootViewController.h",e,this.groupOldIOS),t("RootViewController.mm",e,this.groupOldIOS),t("SDKWrapper.m",e,this.groupOldIOS),t("SDKWrapper.h",e,this.groupOldIOS),t("service/SDKDelegate.h",e,this.groupOldIOS),t("main.m",e,this.groupOldIOS),this.proj.addHeaderFileForce("Info.plist",e,this.groupAppClip)}{const t=path.join(this.inputDir,"CocosCreator/appclip"),o=fs.readdirSync(t).filter(e=>e.endsWith(".entitlements"));1===o.length&&o[0]!==CFG.ENTITLEMENT_NAME?(fs.renameSync(`${t}/${o[0]}`,`${t}/${CFG.ENTITLEMENT_NAME}`),this.updateEntitlements(path.join(t,CFG.ENTITLEMENT_NAME))):(console.log(`[notice] multiple entitlements ${o}, remove others!`),fs.readdirSync(t).filter(e=>e.endsWith(".entitlements")).filter(e=>e!==CFG.ENTITLEMENT_NAME).map(e=>path.join(t,e)).forEach(e=>fs.unlinkSync(e))),fs.existsSync(path.join(t,"appclip.entitlements"))&&this.proj.addFileForce("appclip.entitlements",this.groupAppClip,e)}this.proj.addResourceFileForce(path.join(this.projectResDir,"ios-app-clip"),{target:this.appClipTarget.uuid},this.groupResource),this.proj.addResourceFileForce(path.join(this.projectResDir,"project.json"),{target:this.appClipTarget.uuid},this.groupResource),this.proj.addResourceFileForce("Base.lproj/Localizable.strings",{target:this.appClipTarget.uuid,sourceTree:'"<group>"'},this.groupOldIOS),this.proj.addResourceFileForce("Base.lproj/LaunchScreen.storyboard",{target:this.appClipTarget.uuid,sourceTree:'"<group>"'},this.groupOldIOS),this.proj.addResourceFileForce("LaunchScreenBackground.png",{target:this.appClipTarget.uuid,sourceTree:'"<group>"'},this.groupOldIOS)}updateEntitlements(e){const t=this.getRefBundleId();if(t&&fs.existsSync(e)){const o=plist.parse(fs.readFileSync(e).toString("utf8"));o[CFG.KEY_PARENT]&&o[CFG.KEY_PARENT].length>0&&(o[CFG.KEY_PARENT][0]=`$(AppIdentifierPrefix)${removeQuotes(t)}`,fs.writeFileSync(e,plist.build(o)))}}recordIOSTargets(){const e=this.proj.pbxNativeTargetSection(),t=[],o=this.proj.hash.project.objects.XCConfigurationList,i=this.proj.pbxXCBuildConfigurationSection(),r=this.proj.pbxProjectSection(),s={},n={};for(const p in r){if(p.endsWith("_comment"))continue;const a=r[p];if(s[p]=[],n[p]=!1,a.buildConfigurationList){const e=o[a.buildConfigurationList];for(const t of e.buildConfigurations){if("iphoneos"===i[t.value].buildSettings.SDKROOT){n[p]=!0;break}}}if(n[p])for(const o of a.targets){const i=e[o.value];i&&i.productType.indexOf(CFG.PRODUCT_TYPE_APP)>=0&&t.push({target:e[o.value],uuid:o.value})}else a.targets&&a.targets.length>0&&(s[p]=s[p].concat(a.targets.map(e=>e.value)))}for(const r in s)for(const p of s[r]){const s=e[p];if(!s||s.productType.indexOf(CFG.PRODUCT_TYPE_APP)<0)continue;const a=o[s.buildConfigurationList].buildConfigurations;for(const e of a){("iphoneos"===i[e.value].buildSettings.SDKROOT||n[r])&&t.push({target:s,uuid:p})}}{const e={};for(const o of t)e[o.uuid]=o.target;t.length=0;for(const o in e)t.push({uuid:o,target:e[o]})}for(let e=t.length-1;e>=0;e--){const o=t[e];for(const i of o.target.buildPhases)i.comment.indexOf("Embed App Clips")>-1&&(console.warn(`[warning] skip target ${o.target.name} which already contains an Appclip in ${this.injectAppClip}`),t.splice(e,1))}if(0===t.length)throw new Error("No iOS targets found in "+this.inputXcodeProj);this._iosTargets=t}injectAppClip(){let e;{const t=this.proj.pbxBuildFileSection(),o=this.proj.pbxFileReferenceSection();{const i=this.proj.generateUuid();o[i]={isa:"PBXFileReference",explicitFileType:"wrapper.application",includeInIndex:0,path:`${this.appName}.app`,sourceTree:"BUILT_PRODUCTS_DIR"},o[i+"_comment"]=`${this.appName}.app`;this.proj.hash.project.objects.PBXGroup[this.groupFrameworks].children.push({value:i,comment:`${this.appName}.app`});const r=this.proj.generateUuid();t[r]={isa:"PBXBuildFile",fileRef:i,fileRef_comment:`${this.appName}.app`,settings:{ATTRIBUTES:["RemoveHeadersOnCopy"]}},t[r+"_comment"]=`${this.appName}.app in Embed App Clips`,e=r}}const t=this._iosTargets;if(1!==t.length)throw t.length>1?new Error(`[error] ${t.length} iOS target found!`):new Error("[error] NO iOS target found!");{const o=this.proj.pbxEmbedAppClipsBuildPhaseObj(t[0].uuid);o.dstPath='"$(CONTENTS_FOLDER_PATH)/AppClips"',o.dstSubfolderSpec=16,o.name='"Embed App Clips"',o.files.push({value:e,comment:`${this.appName}.app in Embed App Clips`})}}recordRefBundleID(){if(1===this._iosTargets.length){const e=this._iosTargets[0],t=this.proj.pbxXCBuildConfigurationSection(),o=this.proj.pbxXCConfigurationList()[e.target.buildConfigurationList];for(const e of o.buildConfigurations){const o=t[e.value];o.buildSettings.PRODUCT_BUNDLE_IDENTIFIER&&this._bundeIds.push({name:o.name,bundleId:o.buildSettings.PRODUCT_BUNDLE_IDENTIFIER})}}}getRefBundleId(e){const t=this.queryRefBundleId(e);return null===t?null:t.match(/[${}()]/)?(console.log(`warning: incorrect buildId ${t}`),null):t}queryRefBundleId(e){if(0===this._bundeIds.length)return null;if(1===this._bundeIds.length)return this._bundeIds[0].bundleId;if(e)for(const t of this._bundeIds)if(t.name===e)return t.bundleId;return this._bundeIds[0].bundleId}cloneBuildSettingFromTpl(){const e=["$(SRCROOT)/CocosCreator","$(SRCROOT)/CocosCreator/Classes","$(SRCROOT)/CocosCreator/ios","$(SRCROOT)/CocosCreator/ios/service"],t=`CocosCreator/appclip/${CFG.ENTITLEMENT_NAME}`,o=this.templateProj.pbxNativeTargetSection(),i={};{const r=this.templateProj.pbxXCBuildConfigurationSection();for(const s in o)if(!s.endsWith("_comment")&&o[s].productType.indexOf(CFG.PRODUCT_TYPE_APPCLIP)>-1){const n=s,p=o[n],a=p.buildConfigurationList,c=this.templateProj.pbxXCConfigurationList()[a];for(const o of c.buildConfigurations){const s=r[o.value];let n=s.buildSettings.USER_HEADER_SEARCH_PATHS;n=removeQuotes(n);for(const t of e)n+=` ${t}`;s.buildSettings.USER_HEADER_SEARCH_PATHS='"'+n+'"',s.buildSettings.CODE_SIGN_ENTITLEMENTS='"'+t+'"',s.buildSettings.INFOPLIST_FILE='"$(SRCROOT)/CocosCreator/appclip/Info.plist"',s.buildSettings.ONLY_ACTIVE_ARCH="YES";const p=this.getRefBundleId(s.name);p&&(s.buildSettings.PRODUCT_BUNDLE_IDENTIFIER=p),i[s.name]=s.buildSettings}const l=p.buildPhases,u=this.templateProj.pbxFrameworksBuildPhaseObj(n),d=this.templateProj.pbxFileReferenceSection(),h=this.templateProj.pbxBuildFileSection(),f=this.groupFrameworks;for(const e of l)if("Frameworks"===e.comment){const e=[];for(const t of u.files){if(t.comment.split(" in ")[0].indexOf("iOS AppClip")>=0)continue;const o=d[h[t.value].fileRef],i=this.proj.addFile(o.path,f,o);if(null===i){console.error(`[error] failed to add framework ${path.basename(o.path)}`);continue}const r=this.proj.generateUuid();i.uuid=r,this.proj.addToPbxBuildFileSection(i),e.push(i)}const t=this.proj.pbxFrameworksBuildPhaseSection(),o=this.proj.generateUuid(),i={isa:"PBXFrameworksBuildPhase",buildActionMask:2147483647,files:e.map(e=>({value:e.uuid,comment:`${e.basename} in Frameworks`})),runOnlyForDeploymentPostprocessing:0};t[o]=i,t[o+"_comment"]="Frameworks",this.proj.pbxNativeTargetSection()[this.appClipTarget.uuid].buildPhases.push({value:o,comment:"Frameworks"})}break}}const r=this.proj.pbxXCBuildConfigurationSection(),s=this._iosTargets[0],n=this.proj.pbxXCConfigurationList()[s.target.buildConfigurationList],p={},a=[];for(const e of n.buildConfigurations){const t=r[e.value];p[t.name]=e.value,a.push(t.name)}const c=e=>{const t=["LIBRARY_SEARCH_PATHS","USER_HEADER_SEARCH_PATHS"];for(const o of t){if("string"!=typeof e[o])continue;const t=e[o].replace(/\$\(SRCROOT\)\/\.\.\/\.\.\/cocos2d-x/g,this.cocosRoot);e[o]=t}},l=this.proj.pbxXCConfigurationList()[this.appClipTarget.pbxNativeTarget.buildConfigurationList];for(let e=l.buildConfigurations.length-1;e>=0;e--){const t=l.buildConfigurations[e],o=r[t.value];if(!(o.name in p)){delete r[t.value],l.buildConfigurations.splice(e,1);continue}const s=selectBuildConfigurationName(i,o.name,"Release");Object.assign(o.buildSettings,s),c(o.buildSettings),delete p[o.name]}for(const e in p){const t={name:e,isa:"XCBuildConfiguration",buildSettings:selectBuildConfigurationName(i,e,"Release")},o=this.proj.generateUuid();l.buildConfigurations.push({value:o,comment:e}),c(t.buildSettings),r[o]=t,r[o+"_comment"]=e}a.includes(l.defaultConfigurationName)||(l.defaultConfigurationName=a[0])}setupDependencyToCCLib(){const e=`${CFG.CC_LIB_NAME}.a`,t=this.proj.pbxBuildFileSection();let o=null;for(const i in t)if(i.endsWith("_comment")&&t[i].indexOf(e)>-1){o=i.substring(0,i.length-"_comment".length);break}if(!o)throw new Error(`cant not find ${e} in PBXBuildFileSection`);this.proj.buildPhaseObject("PBXFrameworksBuildPhase","Frameworks",this.appClipTarget.uuid).files.push({value:o,comment:`${e} in Frameworks`})}chooseBackname(){const e=path.basename(this.inputXcodeProj),t=path.dirname(this.inputXcodeProj),o=new Date,i=`XcodeProjBackup/${fillZeros(o.getFullYear(),4)}${fillZeros(o.getMonth()+1,2)}${fillZeros(o.getDate(),2)}`+`_${fillZeros(o.getHours(),2)}${fillZeros(o.getMinutes(),2)}.${fillZeros(o.getMilliseconds(),2)}`;return mkdirP(path.join(t,i)),path.join(t,i,e)}write(){if(!this._valid)throw new Error("[warning] invalidate target!");if(this.doBackup){const e=this.chooseBackname();copyFileOrDir(this.inputXcodeProj,e),console.log(`backup to ${e}`)}return fs.writeFileSync(path.join(this.inputXcodeProj,"project.pbxproj"),this.proj.writeSync({omitEmptyValues:!0})),this._valid}}function mkdirP(e){if(!path.isAbsolute(e))throw new Error(`src must be an absolute path, ${e} got`);const t=[];let o=e;for(;!fs.existsSync(o);)t.push(o),o=path.dirname(o);for(;t.length>0;)fs.mkdirSync(t[t.length-1]),t.length=t.length-1}function copyFileOrDir(e,t){if(!path.isAbsolute(e))throw new Error(`src must be an absolute path, ${e} got`);if(!path.isAbsolute(t))throw new Error(`dst must be an absolute, ${t} got`);const o=fs.statSync(e);if(o.isFile())fs.copyFileSync(e,t);else if(o.isDirectory()){fs.existsSync(t)||fs.mkdirSync(t);const o=fs.readdirSync(e).filter(e=>!e.startsWith(".")).map(o=>({from:path.join(e,o),to:path.join(t,o)}));for(const e of o)copyFileOrDir(e.from,e.to)}}function fillZeros(e,t){const o="00000000000"+e;return console_1.assert(t<o.length),o.substr(o.length-t)}function removeQuotes(e){for(;e.startsWith('"')&&e.endsWith('"')&&e.length>1;)e=e.substr(1,e.length-2);return e}function selectBuildConfigurationName(e,t,o){if(t in e)return e[t];for(const o in e)if(t.indexOf(o)>-1)return e[o];return e[o]}exports.XcodeProjModifer=XcodeProjModifer;