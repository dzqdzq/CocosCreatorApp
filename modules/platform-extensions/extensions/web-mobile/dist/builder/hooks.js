"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),buildStaticDir=path_1.join(__dirname,"../../static/build-template");async function onAfterInit(e,t,i){window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir);const s=e.packages["web-mobile"],r={orientation:s.orientation,remoteServerAddress:s.remoteServerAddress};i.__addStaticsInfo(r),e.buildScriptParam.polyfills=e.packages["web-mobile"].polyfills,e.buildScriptParam.system={preset:"web"},e.buildEngineParam.split=!1,e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved";let a=e.packages["web-mobile"].remoteServerAddress||"";a&&!a.endsWith("/")&&(a+="/"),Object.assign(e.appTemplateData,{server:a})}async function onBeforeBuildAssets(e,t,i){for(const e of i.scriptUuids){const s=i.getAssetInfo(e),r=await i.getMeta(e);s?r?r.userData.isPlugin&&r.userData.loadPluginInWeb&&t.addPlugin(s):console.error(`Get meta of script {asset(${s.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onBeforeCompressSettings(e,t,i){if(!t.paths.dir)return;const s=e.packages["web-mobile"],r=t.settings;r.orientation=s.orientation,r.jsList.forEach((e,t)=>{r.jsList[t]=e.split("/").map(encodeURIComponent).join("/")})}async function onAfterBuild(e,t){const i=e.packages["web-mobile"],s=await ejs_1.default.renderFile(path_1.join(buildStaticDir,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),r=await babel.transformAsync(s,{presets:[[preset_env_1.default,{modules:"systemjs"}]]});if(!r||!r.code)throw new Error("无法生成 index.js");let a="";e.md5Cache&&(a="."+Build.Utils.calcMd5(r.code));const o=path_1.join(t.paths.dir,`index${a}.js`);fs_extra_1.outputFileSync(o,r.code,"utf-8");let n=path_1.join(t.paths.dir,"style.css");if(fs_extra_1.copyFileSync(path_1.join(buildStaticDir,"style.css"),n),e.md5Cache){n=(await Build.Utils.appendMd5ToPaths([n])).paths[0]}const l={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,orientation:i.orientation,engineName:e.buildEngineParam.engineName,webDebuggerSrc:"",cocosTemplate:path_1.join(buildStaticDir,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:path_1.basename(o),cssUrl:path_1.basename(n)};if(i.embedWebDebugger){l.webDebuggerSrc="./vconsole.min.js";try{fs_extra_1.copySync(path_1.join(buildStaticDir,"vconsole.min.js"),path_1.join(t.paths.dir,"vconsole.min.js"))}catch(e){console.warn("Copy vconsole failed.")}}let p=!0,d=path_1.join(Build.buildTemplateDir,e.platform,"index.ejs");fs_extra_1.existsSync(d)||(d=path_1.join(buildStaticDir,"index.ejs"),p=!1);const c=await ejs_1.default.renderFile(d,l);fs_extra_1.outputFileSync(path_1.join(t.paths.dir,"index.html"),c,"utf8");const u=path_1.join(Editor.Project.path,"build-templates",e.platform);fs_extra_1.existsSync(u)&&(fs_extra_1.copySync(u,t.paths.dir),console.debug(`Use build-template {link(${u})}.`)),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"index.ejs")),Editor.Message.request("web-mobile","set-preview-path",t.paths.dir)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;