"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,s){window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir);const i={orientation:e.packages["web-mobile"].orientation,remoteServerAddress:e.server};s.__addStaticsInfo(i),e.buildScriptParam.system={preset:"web"},e.buildEngineParam.split=!1,e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved",e.server&&!e.server.endsWith("/")&&(e.server+="/")}async function onBeforeBuildAssets(e,t,s){for(const e of s.scriptUuids){const i=s.getAssetInfo(e),r=await s.getMeta(e);i?r?r.userData.isPlugin&&r.userData.loadPluginInWeb&&t.addPlugin(i):console.error(`Get meta of script {asset(${i.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onBeforeCompressSettings(e,t,s){if(!t.paths.dir)return;const i=e.packages["web-mobile"];t.settings.orientation=i.orientation,t.settings.jsList.forEach((e,s)=>{t.settings.jsList[s]=e.split("/").map(encodeURIComponent).join("/")})}async function onAfterBuild(e,t){const s=e.packages["web-mobile"],i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,r=path_1.join(i,"templates/web-mobile"),n=await ejs_1.default.renderFile(path_1.join(r,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),o=await Build.Utils.transformCode(n,{importMapFormat:"systemjs"});if(!o)throw new Error("无法生成 index.js");let a="";e.md5Cache&&(a="."+Build.Utils.calcMd5(o));const l=path_1.join(t.paths.dir,`index${a}.js`);fs_extra_1.outputFileSync(l,o,"utf-8");let p=path_1.join(t.paths.dir,"style.css");if(fs_extra_1.copyFileSync(path_1.join(r,"style.css"),p),e.md5Cache){p=(await Build.Utils.appendMd5ToPaths([p])).paths[0]}const d={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:"",cocosTemplate:path_1.join(r,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:path_1.basename(l),cssUrl:path_1.basename(p)};if(s.embedWebDebugger){d.webDebuggerSrc="./vconsole.min.js";try{fs_extra_1.copySync(path_1.join(r,"vconsole.min.js"),path_1.join(t.paths.dir,"vconsole.min.js"))}catch(e){console.warn("Copy vconsole failed.")}}let u=!0,c=path_1.join(Build.buildTemplateDir,e.platform,"index.ejs");fs_extra_1.existsSync(c)||(c=path_1.join(r,"index.ejs"),u=!1);const f=await ejs_1.default.renderFile(c,d);fs_extra_1.outputFileSync(path_1.join(t.paths.dir,"index.html"),f,"utf8");const m=path_1.join(Editor.Project.path,"build-templates",e.platform);if(fs_extra_1.existsSync(m)){try{const t=fs_extra_1.readJSONSync(path_1.join(r,"build-template.json"));if(t.version){const s=path_1.join(Build.buildTemplateDir,"templates-version.json");let i="";fs_extra_1.existsSync(s)&&(i=fs_extra_1.readJSONSync(s)[e.platform]),compareBuildTemplateVersion(t.version,i)&&console.warn(Editor.I18n.t("web-mobile.tips.templateVersionWarning"))}}catch(e){console.debug(e)}fs_extra_1.copySync(m,t.paths.dir),console.debug(`Use build-template {link(${m})}.`)}u&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"index.ejs")),Editor.Message.request("web-mobile","set-preview-path",t.paths.dir)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[s,i]=[e.split("."),t.split(".")],r=Math.max(s.length,i.length);for(let e=0;e<r;e++)if(parseInt(s[e])>parseInt(i[e]))return!0;return!1}function run(e,t){Editor.Message.request("web-mobile","preview",e)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;