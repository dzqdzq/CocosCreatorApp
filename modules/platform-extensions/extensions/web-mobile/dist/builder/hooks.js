"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleDataTask=exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,s){const i=e.packages["web-mobile"];t.staticsInfo.orientation=i.orientation,e.buildEngineParam.split=!1,e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved",e.buildScriptParam.flags.WASM_FALLBACK=!0,e.buildScriptParam.flags.CULL_ASM_JS_MODULE=i.cullEngineAsmJsModule,e.server&&!e.server.endsWith("/")&&(e.server+="/")}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"},e.buildScriptParam.platform="HTML5";const t=e.packages["web-mobile"].useWebGPU;e.buildScriptParam.flags.WEBGPU=t,t&&(e.assetSerializeOptions["cc.EffectAsset"].glsl4=!0)}async function onAfterBundleDataTask(e,t,s){t.forEach(e=>{for(const t of e.pluginScript){const i=s.getAssetInfo(t);i.meta.userData.isPlugin&&!i.meta.userData.loadPluginInWeb&&e.pluginScript.delete(t)}})}async function onBeforeCompressSettings(e,t,s){if(!t.paths.dir)return;const i=e.packages["web-mobile"];t.settings.screen.orientation=i.orientation,t.settings.plugins.jsList.forEach((e,s)=>{t.settings.plugins.jsList[s]=e.split("/").map(encodeURIComponent).join("/")})}async function onAfterBuild(e,t){const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=(0,path_1.join)(s,"templates/web-mobile"),n=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(n)&&copyUserTemplates(e,t,i,n),await copyTemplates(e,t,i,n),Editor.Message.request("web-mobile","set-preview-path",t.paths.dir)}function copyUserTemplates(e,t,s,i){try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s,"build-template.json"));if(t.version){const s=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let i="";(0,fs_extra_1.existsSync)(s)&&(i=(0,fs_extra_1.readJSONSync)(s)[e.platform]),compareBuildTemplateVersion(t.version,i)&&console.warn(Editor.I18n.t("web-mobile.tips.templateVersionWarning"))}}catch(e){console.debug(e)}(0,fs_extra_1.copySync)(i,t.paths.dir),console.debug(`Use build-template {link(${i})}.`)}async function copyTemplates(e,t,s,i){const n=e.packages["web-mobile"];let a=(0,path_1.join)(t.paths.dir,"index.js");if(!(0,fs_extra_1.existsSync)((0,path_1.join)(i,"index.js"))){const i=await ejs_1.default.renderFile((0,path_1.join)(s,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),n=await Build.Utils.transformCode(i,{importMapFormat:"systemjs"});if(!n)throw new Error("Cannot generate index.js");let r="";e.md5Cache&&(r="."+Build.Utils.calcMd5(n)),a=(0,path_1.join)(t.paths.dir,`index${r}.js`),(0,fs_extra_1.outputFileSync)(a,n,"utf-8")}t.paths.indexJs=a;let r=(0,path_1.join)(t.paths.dir,"style.css");if(!(0,fs_extra_1.existsSync)((0,path_1.join)(i,"style.css"))&&((0,fs_extra_1.copyFileSync)((0,path_1.join)(s,"style.css"),r),e.md5Cache)){r=(await Build.Utils.appendMd5ToPaths([r])).paths[0]}t.paths.styleCSS=r;let o="";if(n.embedWebDebugger&&(o="./vconsole.min.js",!(0,fs_extra_1.existsSync)((0,path_1.join)(i,"vconsole.min.js"))&&((0,fs_extra_1.copySync)((0,path_1.join)(s,"vconsole.min.js"),(0,path_1.join)(t.paths.dir,"vconsole.min.js")),e.md5Cache))){const e=await Build.Utils.appendMd5ToPaths([(0,path_1.join)(t.paths.dir,"vconsole.min.js")]);o=`./${(0,path_1.basename)(e.paths[0])}`}let l=!0;if(!(0,fs_extra_1.existsSync)((0,path_1.join)(i,"index.html"))){const n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:o,cocosTemplate:(0,path_1.join)(s,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(a),cssUrl:(0,path_1.basename)(r)};let p=(0,path_1.join)(i,"index.ejs");(0,fs_extra_1.existsSync)(p)||(p=(0,path_1.join)(s,"index.ejs"),l=!1);const c=await ejs_1.default.renderFile(p,n);(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"index.html"),c,"utf8")}t.paths.indexHTML=(0,path_1.join)(t.paths.dir,"index.html"),l&&(0,fs_extra_1.existsSync)((0,path_1.join)(t.paths.dir,"index.ejs"))&&(0,fs_extra_1.removeSync)((0,path_1.join)(t.paths.dir,"index.ejs"))}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[s,i]=[e.split("."),t.split(".")],n=Math.max(s.length,i.length);for(let e=0;e<n;e++)if(parseInt(s[e])>parseInt(i[e]))return!0;return!1}function run(e,t){Editor.Message.request("web-mobile","preview",e,t.packages["web-mobile"].useWebGPU)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;