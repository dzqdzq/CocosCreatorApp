"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterBuild=onAfterBuild;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path");async function onAfterInit(e,t,i){var s=e.packages["web-mobile"];t.staticsInfo.orientation=s.orientation,e.buildEngineParam.split=!1,e.buildEngineParam.assetURLFormat="runtime-resolved",e.server&&!e.server.endsWith("/")&&(e.server+="/")}function onAfterBundleInit(e){e.buildScriptParam.system={preset:"web"};var t=e.packages["web-mobile"].useWebGPU;(e.buildScriptParam.flags.WEBGPU=t)?(e.includeModules.includes("gfx-webgpu")||e.includeModules.push("gfx-webgpu"),e.assetSerializeOptions["cc.EffectAsset"].glsl4=!0):e.includeModules.includes("gfx-webgpu")&&(t=e.includeModules.indexOf("gfx-webgpu"),e.includeModules.splice(t,1))}async function onBeforeCompressSettings(e,t,i){t.paths.dir&&(e=e.packages["web-mobile"],t.settings.screen.orientation=e.orientation)}async function onBeforeCopyBuildTemplate(e,t){var i=(0,path_1.join)(e.engineInfo.typescript.builtin,"templates/web-mobile"),s=e.packages["web-mobile"],n=(0,path_1.join)(t.paths.dir,"style.css");e.md5CacheOptions.includes.push(n),this.buildTemplate.findFile("style.css")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"style.css"),n);let a="";s.embedWebDebugger&&(s=(0,path_1.join)(t.paths.dir,"vconsole.min.js"),this.buildTemplate.findFile("vconsole.min.js")||((0,fs_extra_1.copyFileSync)((0,path_1.join)(i,"vconsole.min.js"),s),e.md5CacheOptions.excludes.push(s)),a="./vconsole.min.js");s=this.buildTemplate.initUrl("index.js.ejs","indexJs")||(0,path_1.join)(i,"index.js.ejs"),s=await ejs_1.default.renderFile(s,{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),s=await Build.Utils.transformCode(s,{importMapFormat:"systemjs"});if(!s)throw new Error("Cannot generate index.js");var r=(0,path_1.join)(t.paths.dir,"index.js"),s=(t.paths.indexJs=r,e.md5CacheOptions.includes.push(t.paths.indexJs),(0,fs_extra_1.outputFileSync)(r,s,"utf8"),this.buildTemplate.initUrl("index.ejs")||(0,path_1.join)(i,"index.ejs")),i={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,webDebuggerSrc:a,cocosTemplate:(0,path_1.join)(i,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:(0,path_1.basename)(r),cssUrl:(0,path_1.basename)(n)},r=await ejs_1.default.renderFile(s,i);t.paths.indexHTML=(0,path_1.join)(t.paths.dir,"index.html"),(0,fs_extra_1.outputFileSync)(t.paths.indexHTML,r,"utf8"),e.md5CacheOptions.replaceOnly.push(t.paths.indexHTML),Editor.Message.request("web-mobile","set-preview-path",t.paths.dir)}async function onAfterBuild(e,i){i.settings.plugins.jsList.forEach((e,t)=>{i.settings.plugins.jsList[t]=e.split("/").map(encodeURIComponent).join("/")}),(0,fs_extra_1.outputFileSync)(i.paths.settings,JSON.stringify(i.settings,null,e.debug?4:0))}exports.throwError=!0;