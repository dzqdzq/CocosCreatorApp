"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),os_1=require("os");async function generateOptions(e){var a=e.packages.android,t=(a.orientation=a.orientation||{},await Editor.Message.request("program","query-program-info","androidSDK")),r=await Editor.Message.request("program","query-program-info","androidNDK"),o=await Editor.Message.request("program","query-program-info","javaHome");if(a.sdkPath=e.packages.android.sdkPath||(null==t?void 0:t.path)||"",a.ndkPath=e.packages.android.ndkPath||(null==r?void 0:r.path)||"",a.javaHome=e.packages.android.javaHome||(null==o?void 0:o.path)||"",a.javaPath="",a.javaHome)try{var n,s,i=(0,fs_extra_1.statSync)(a.javaHome);i.isFile()?(a.javaPath=a.javaHome,a.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(a.javaPath),".."))):i.isDirectory()&&(n="win32"===(0,os_1.platform)()?"java.exe":"java",s=(0,path_1.join)(a.javaHome,"bin",n),(0,fs_extra_1.existsSync)(s)?a.javaPath=s:console.error(`Java executable not found at ${a.javaHome}/bin`))}catch(e){console.error(e)}if(a.sdkPath&&a.ndkPath)return{packageName:a.packageName||"",resizeableActivity:null==(t=a.resizeableActivity)||t,maxAspectRatio:null!=(r=a.maxAspectRatio)?r:"2.4",orientation:{landscapeRight:null==(e=a.orientation.landscapeRight)||e,landscapeLeft:null==(o=a.orientation.landscapeLeft)||o,portrait:null!=(i=a.orientation.portrait)&&i,upsideDown:null!=(n=a.orientation.upsideDown)&&n},apiLevel:a.apiLevel,appABIs:a.appABIs||[],useDebugKeystore:a.useDebugKeystore,keystorePath:a.keystorePath||"",keystorePassword:a.keystorePassword||"",keystoreAlias:a.keystoreAlias||"",keystoreAliasPassword:a.keystoreAliasPassword||"",appBundle:null!=(s=a.appBundle)&&s,androidInstant:null!=(t=a.androidInstant)&&t,inputSDK:null!=(r=a.inputSDK)&&r,remoteUrl:a.remoteUrl||"",sdkPath:a.sdkPath||"",ndkPath:a.ndkPath||"",javaHome:a.javaHome||"",javaPath:a.javaPath||"",swappy:a.swappy||!1,renderBackEnd:{vulkan:null==(o=null==(e=a.renderBackEnd)?void 0:e.vulkan)||o,gles3:null==(n=null==(i=a.renderBackEnd)?void 0:i.gles3)||n,gles2:null==(t=null==(s=a.renderBackEnd)?void 0:s.gles2)||t}};throw new Error(Editor.I18n.t("android.tips.android_sdk_error"))}async function onAfterInit(a,e,t){var r=await generateOptions(a);const o=(a.packages.android=r).renderBackEnd;e.staticsInfo.B100005=r.packageName,e.staticsInfo.B100011=r.orientation;e=await(0,options_1.checkAndroidAPILevels)(r.apiLevel,a);e.error&&(console.error(e.error),e.newValue)&&(r.apiLevel=e.newValue),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:a.packages.android.renderBackEnd.vulkan?100:0}),r.useDebugKeystore&&(r.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),r.keystoreAlias="debug_keystore",r.keystorePassword="123456",r.keystoreAliasPassword="123456"),Object.assign(a.cocosParams.platformParams,r),o&&Object.keys(o).forEach(e=>{a.cocosParams.cMakeConfig["CC_USE_"+e.toUpperCase()]=o[e]}),a.cocosParams.cMakeConfig.CC_ENABLE_SWAPPY=!!r.swappy,a.cocosParams.cMakeConfig.USE_ADPF=!0}function onAfterBundleInit(e){var a,t=e.packages.android.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null==(a=t.gles2)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(a=t.gles3)||a,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null==(a=t.vulkan)||a,e.buildScriptParam.platform="ANDROID"}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;