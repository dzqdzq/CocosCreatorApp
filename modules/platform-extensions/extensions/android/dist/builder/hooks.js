"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options");async function generateOptions(e){var o,t,a,r,n,s,i,d,l,p,c,u;const k=e.packages.android;k.orientation=k.orientation||{};const g=await Editor.Message.request("program","query-program-info","androidSDK"),v=await Editor.Message.request("program","query-program-info","androidNDK");if(k.sdkPath=g?g.path:"",k.ndkPath=v?v.path:"",!k.sdkPath||!k.ndkPath)throw new Error(Editor.I18n.t("android.tips.android_sdk_error"));return{packageName:k.packageName||"",orientation:{landscapeRight:null===(o=k.orientation.landscapeRight)||void 0===o||o,landscapeLeft:null===(t=k.orientation.landscapeLeft)||void 0===t||t,portrait:null!==(a=k.orientation.portrait)&&void 0!==a&&a,upsideDown:null!==(r=k.orientation.upsideDown)&&void 0!==r&&r},apiLevel:k.apiLevel,appABIs:k.appABIs||[],useDebugKeystore:k.useDebugKeystore,keystorePath:k.keystorePath||"",keystorePassword:k.keystorePassword||"",keystoreAlias:k.keystoreAlias||"",keystoreAliasPassword:k.keystoreAliasPassword||"",appBundle:null!==(n=k.appBundle)&&void 0!==n&&n,androidInstant:null!==(s=k.androidInstant)&&void 0!==s&&s,remoteUrl:k.remoteUrl||"",sdkPath:k.sdkPath||"",ndkPath:k.ndkPath||"",swappy:k.swappy||!1,renderBackEnd:{vulkan:null===(d=null===(i=k.renderBackEnd)||void 0===i?void 0:i.vulkan)||void 0===d||d,gles3:null===(p=null===(l=k.renderBackEnd)||void 0===l?void 0:l.gles3)||void 0===p||p,gles2:null===(u=null===(c=k.renderBackEnd)||void 0===c?void 0:c.gles2)||void 0===u||u}}}async function onAfterInit(e,o,t){var a,r,n;const s=await generateOptions(e);e.packages.android=s;const i=s.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null===(a=i.gles2)||void 0===a||a,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(r=i.gles3)||void 0===r||r,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null===(n=i.vulkan)||void 0===n||n;const d={packageName:s.packageName,orientation:s.orientation};t.__addStaticsInfo(d);const l=await options_1.checkAndroidAPILevels(s.apiLevel,e);l.error&&(console.error(l.error),l.newValue&&(s.apiLevel=l.newValue)),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:e.packages.android.renderBackEnd.vulkan?100:0}),s.useDebugKeystore&&(s.keystorePath=path_1.join(Editor.App.path,"../tools/keystore/debug.keystore"),s.keystoreAlias="debug_keystore",s.keystorePassword="123456",s.keystoreAliasPassword="123456"),Object.assign(o.compileOptions.platformParams,s),i&&Object.keys(i).forEach(e=>{o.compileOptions.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=i[e]}),o.compileOptions.cMakeConfig.CC_ENABLE_SWAPPY=!!s.swappy,await fs_extra_1.outputJSON(o.paths.compileConfig,o.compileOptions)}exports.throwError=!0,exports.onAfterInit=onAfterInit;