"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options");async function generateOptions(e){var t,o,r,a,n,s,i,d,l,p,c,u,k;const g=e.packages.android;g.orientation=g.orientation||{};const f=await Editor.Message.request("program","query-program-info","androidSDK"),v=await Editor.Message.request("program","query-program-info","androidNDK");if(g.sdkPath=f?f.path:"",g.ndkPath=v?v.path:"",!g.sdkPath||!g.ndkPath)throw new Error(Editor.I18n.t("android.tips.android_sdk_error"));return{packageName:g.packageName||"",orientation:{landscapeRight:null===(t=g.orientation.landscapeRight)||void 0===t||t,landscapeLeft:null===(o=g.orientation.landscapeLeft)||void 0===o||o,portrait:null!==(r=g.orientation.portrait)&&void 0!==r&&r,upsideDown:null!==(a=g.orientation.upsideDown)&&void 0!==a&&a},apiLevel:g.apiLevel,appABIs:g.appABIs||[],useDebugKeystore:g.useDebugKeystore,keystorePath:g.keystorePath||"",keystorePassword:g.keystorePassword||"",keystoreAlias:g.keystoreAlias||"",keystoreAliasPassword:g.keystoreAliasPassword||"",appBundle:null!==(n=g.appBundle)&&void 0!==n&&n,androidInstant:null!==(s=g.androidInstant)&&void 0!==s&&s,inputSDK:null!==(i=g.inputSDK)&&void 0!==i&&i,remoteUrl:g.remoteUrl||"",sdkPath:g.sdkPath||"",ndkPath:g.ndkPath||"",swappy:g.swappy||!1,renderBackEnd:{vulkan:null===(l=null===(d=g.renderBackEnd)||void 0===d?void 0:d.vulkan)||void 0===l||l,gles3:null===(c=null===(p=g.renderBackEnd)||void 0===p?void 0:p.gles3)||void 0===c||c,gles2:null===(k=null===(u=g.renderBackEnd)||void 0===u?void 0:u.gles2)||void 0===k||k}}}async function onAfterInit(e,t,o){const r=await generateOptions(e);e.packages.android=r;const a=r.renderBackEnd;t.staticsInfo.B100005=r.packageName,t.staticsInfo.B100011=r.orientation;const n=await options_1.checkAndroidAPILevels(r.apiLevel,e);n.error&&(console.error(n.error),n.newValue&&(r.apiLevel=n.newValue)),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:e.packages.android.renderBackEnd.vulkan?100:0}),r.useDebugKeystore&&(r.keystorePath=path_1.join(Editor.App.path,"../tools/keystore/debug.keystore"),r.keystoreAlias="debug_keystore",r.keystorePassword="123456",r.keystoreAliasPassword="123456"),Object.assign(t.compileOptions.platformParams,r),a&&Object.keys(a).forEach(e=>{t.compileOptions.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=a[e]}),t.compileOptions.cMakeConfig.CC_ENABLE_SWAPPY=!!r.swappy,await fs_extra_1.outputJSON(t.paths.compileConfig,t.compileOptions)}function onAfterBundleInit(e){var t,o,r;const a=e.packages.android.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null===(t=a.gles2)||void 0===t||t,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(o=a.gles3)||void 0===o||o,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null===(r=a.vulkan)||void 0===r||r,e.buildScriptParam.platform="ANDROID"}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;