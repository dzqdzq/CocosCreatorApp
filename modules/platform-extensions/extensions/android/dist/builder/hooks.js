"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.openWithIDE=openWithIDE;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),os_1=require("os");async function generateOptions(e){var a=e.packages.android,t=(a.orientation=a.orientation||{},await Editor.Message.request("program","query-program-info","androidSDK")),o=await Editor.Message.request("program","query-program-info","androidNDK"),r=await Editor.Message.request("program","query-program-info","javaHome");if(a.sdkPath=e.packages.android.sdkPath||t?.path||"",a.ndkPath=e.packages.android.ndkPath||o?.path||"",a.javaHome=e.packages.android.javaHome||r?.path||"",a.javaPath="",a.javaHome)try{var s,n,i=(0,fs_extra_1.statSync)(a.javaHome);i.isFile()?(a.javaPath=a.javaHome,a.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(a.javaPath),".."))):i.isDirectory()&&(s="win32"===(0,os_1.platform)()?"java.exe":"java",n=(0,path_1.join)(a.javaHome,"bin",s),(0,fs_extra_1.existsSync)(n)?a.javaPath=n:console.error(`Java executable not found at ${a.javaHome}/bin`))}catch(e){console.error(e)}if(a.sdkPath&&a.ndkPath)return a.keystorePath&&(a.keystorePath=Editor.UI.__protected__.File.resolveToRaw(a.keystorePath)),{packageName:a.packageName||"",resizeableActivity:a.resizeableActivity??!0,maxAspectRatio:a.maxAspectRatio??"2.4",orientation:{landscapeRight:a.orientation.landscapeRight??!0,landscapeLeft:a.orientation.landscapeLeft??!0,portrait:a.orientation.portrait??!1,upsideDown:a.orientation.upsideDown??!1},apiLevel:a.apiLevel,appABIs:a.appABIs||[],isSoFileCompressed:a.isSoFileCompressed??!0,useDebugKeystore:a.useDebugKeystore,keystorePath:a.keystorePath||"",keystorePassword:a.keystorePassword||"",keystoreAlias:a.keystoreAlias||"",keystoreAliasPassword:a.keystoreAliasPassword||"",appBundle:a.appBundle??!1,androidInstant:a.androidInstant??!1,inputSDK:a.inputSDK??!1,remoteUrl:a.remoteUrl||"",sdkPath:a.sdkPath||"",ndkPath:a.ndkPath||"",javaHome:a.javaHome||"",javaPath:a.javaPath||"",swappy:a.swappy||!1,renderBackEnd:{vulkan:a.renderBackEnd?.vulkan??!0,gles3:a.renderBackEnd?.gles3??!0,gles2:a.renderBackEnd?.gles2??!0}};throw new Error(Editor.I18n.t("android.tips.android_sdk_error"))}async function onAfterInit(a,e,t){var o=await generateOptions(a);const r=(a.packages.android=o).renderBackEnd;e.staticsInfo.B100005=o.packageName,e.staticsInfo.B100011=o.orientation;e=await(0,options_1.checkAndroidAPILevels)(o.apiLevel,a);e.error&&(console.error(e.error),e.newValue)&&(o.apiLevel=e.newValue),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:a.packages.android.renderBackEnd.vulkan?100:0}),o.useDebugKeystore&&(o.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),o.keystoreAlias="debug_keystore",o.keystorePassword="123456",o.keystoreAliasPassword="123456"),Object.assign(a.cocosParams.platformParams,o),r&&Object.keys(r).forEach(e=>{a.cocosParams.cMakeConfig["CC_USE_"+e.toUpperCase()]=r[e]}),a.cocosParams.cMakeConfig.CC_ENABLE_SWAPPY=!!o.swappy,a.cocosParams.cMakeConfig.USE_ADPF=!0}function onAfterBundleInit(e){var a=e.packages.android.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=a.gles2??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl3=a.gles3??!0,e.assetSerializeOptions["cc.EffectAsset"].glsl4=a.vulkan??!0}async function openWithIDE(e){var a=await Editor.Message.request("program","query-program-info","androidStudio");a&&a.path?Editor.Message.send("builder","execute-hook-task","native","open",e,(0,path_1.dirname)(a.path)):Editor.Dialog.warn(Editor.I18n.t("android.customIcon.ideNotFound"),{title:Editor.I18n.t("android.customIcon.openFailed")})}exports.throwError=!0;