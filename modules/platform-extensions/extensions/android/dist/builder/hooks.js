"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),options_1=require("./options"),os_1=require("os");async function generateOptions(e){var a,t,o,r,n,i,s,l,d,p,c,u,v,k,f;const g=e.packages.android;g.orientation=g.orientation||{};const h=await Editor.Message.request("program","query-program-info","androidSDK"),m=await Editor.Message.request("program","query-program-info","androidNDK"),y=await Editor.Message.request("program","query-program-info","javaHome");if(g.sdkPath=h?h.path:"",g.ndkPath=m?m.path:"",g.javaHome=y?y.path:"",g.javaPath="",g.javaHome)try{const e=(0,fs_extra_1.statSync)(g.javaHome);if(e.isFile())g.javaPath=g.javaHome,g.javaHome=(0,path_1.normalize)((0,path_1.join)((0,path_1.dirname)(g.javaPath),".."));else if(e.isDirectory()){const e="win32"===(0,os_1.platform)()?"java.exe":"java",a=(0,path_1.join)(g.javaHome,"bin",e);(0,fs_extra_1.existsSync)(a)?g.javaPath=a:console.error(`Java executable not found at ${g.javaHome}/bin`)}}catch(e){console.error(e)}if(!g.sdkPath||!g.ndkPath)throw new Error(Editor.I18n.t("android.tips.android_sdk_error"));return{packageName:g.packageName||"",resizeableActivity:null===(a=g.resizeableActivity)||void 0===a||a,maxAspectRatio:null!==(t=g.maxAspectRatio)&&void 0!==t?t:"2.4",orientation:{landscapeRight:null===(o=g.orientation.landscapeRight)||void 0===o||o,landscapeLeft:null===(r=g.orientation.landscapeLeft)||void 0===r||r,portrait:null!==(n=g.orientation.portrait)&&void 0!==n&&n,upsideDown:null!==(i=g.orientation.upsideDown)&&void 0!==i&&i},apiLevel:g.apiLevel,appABIs:g.appABIs||[],useDebugKeystore:g.useDebugKeystore,keystorePath:g.keystorePath||"",keystorePassword:g.keystorePassword||"",keystoreAlias:g.keystoreAlias||"",keystoreAliasPassword:g.keystoreAliasPassword||"",appBundle:null!==(s=g.appBundle)&&void 0!==s&&s,androidInstant:null!==(l=g.androidInstant)&&void 0!==l&&l,inputSDK:null!==(d=g.inputSDK)&&void 0!==d&&d,remoteUrl:g.remoteUrl||"",sdkPath:g.sdkPath||"",ndkPath:g.ndkPath||"",javaHome:g.javaHome||"",javaPath:g.javaPath||"",swappy:g.swappy||!1,renderBackEnd:{vulkan:null===(c=null===(p=g.renderBackEnd)||void 0===p?void 0:p.vulkan)||void 0===c||c,gles3:null===(v=null===(u=g.renderBackEnd)||void 0===u?void 0:u.gles3)||void 0===v||v,gles2:null===(f=null===(k=g.renderBackEnd)||void 0===k?void 0:k.gles2)||void 0===f||f}}}async function onAfterInit(e,a,t){const o=await generateOptions(e);e.packages.android=o;const r=o.renderBackEnd;a.staticsInfo.B100005=o.packageName,a.staticsInfo.B100011=o.orientation;const n=await(0,options_1.checkAndroidAPILevels)(o.apiLevel,e);n.error&&(console.error(n.error),n.newValue&&(o.apiLevel=n.newValue)),Editor.Metrics.trackEvent({category:"Project",action:"Rendering Backend",label:"Vulkan",value:e.packages.android.renderBackEnd.vulkan?100:0}),o.useDebugKeystore&&(o.keystorePath=(0,path_1.join)(Editor.App.path,"../tools/keystore/debug.keystore"),o.keystoreAlias="debug_keystore",o.keystorePassword="123456",o.keystoreAliasPassword="123456"),Object.assign(a.compileOptions.platformParams,o),r&&Object.keys(r).forEach(e=>{a.compileOptions.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=r[e]}),a.compileOptions.cMakeConfig.CC_ENABLE_SWAPPY=!!o.swappy,await(0,fs_extra_1.outputJSON)(a.paths.compileConfig,a.compileOptions)}function onAfterBundleInit(e){var a,t,o;const r=e.packages.android.renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl1=null===(a=r.gles2)||void 0===a||a,e.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(t=r.gles3)||void 0===t||t,e.assetSerializeOptions["cc.EffectAsset"].glsl4=null===(o=r.vulkan)||void 0===o||o,e.buildScriptParam.platform="ANDROID"}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit;