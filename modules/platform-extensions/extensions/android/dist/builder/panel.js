"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAPILevel=exports.ready=exports.update=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),options_1=require("./options"),lodash=require("lodash");let panel;exports.style="\n.set-androidSDK,\n.new-keystore {\n    margin-left: 4px;\n}\n",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/builder/view.html"),"utf8");const methods={t:(e,t)=>Editor.I18n.t(`android.${e}`,t),async onSetAndroidSDK(){Editor.Message.send("preferences","open-settings","program")},getDefaultPackageName:()=>options_1.defaultOptions.packageName||"com.test.cocos",onNewKeyStore(){Editor.Panel.open("certificate","android")},async onChangeDebugKeystore(e){const t=this;await t.onUpdateOptions("useDebugKeystore",e);const a=["keystorePath","keystorePassword","keystoreAlias","keystoreAliasPassword"];if(!0===e)a.forEach(e=>{t.pkgErrorMap[e]=null,t.emitChange(e,t.pkgOptions[e],null)});else for(const e of a)t.pkgErrorMap[e]=(await options_1.verificationFunc(e,t.pkgOptions[e],panel.options)).error,t.emitChange(e,t.pkgOptions[e],t.pkgErrorMap[e])},async onRenderBackEnd(e){const t=this,a=e.target.value;t.pkgOptions.renderBackEnd=a?Object.assign(t.pkgOptions.renderBackEnd,{gles3:!0}):Object.assign(t.pkgOptions.renderBackEnd,{gles2:!1,gles3:!1}),await t.onUpdateOptions("renderBackEnd",t.pkgOptions.renderBackEnd)},async onChange(e){const t=e.target.value,a=e.target.getAttribute("path");await this.onUpdateOptions(a,t)},async onUpdateOptions(e,t){if(!e)return;const a=this;lodash.set(a.pkgOptions,e,t),panel.options.packages.android=a.pkgOptions,e.startsWith("renderBackEnd")&&(e="renderBackEnd",t=a.pkgOptions.renderBackEnd),"apiLevel"===e&&(t=Number(t));const p=await options_1.verificationFunc(e,t,panel.options);a.pkgErrorMap[e]=p.error,a.emitChange(e,t,p.error)},emitChange(e,t,a){panel.dispatch("update",`packages.${this.pkgName}.${e}`,t,a)},async onChangeABI(e,t){const a=this,p=e.target.value;Array.isArray(a.pkgOptions.appABIs)||(a.pkgOptions.appABIs=[]),p?a.pkgOptions.appABIs.push(t):a.pkgOptions.appABIs.splice(a.pkgOptions.appABIs.indexOf(t),1),await a.onUpdateOptions("appABIs",a.pkgOptions.appABIs)},async changeInstantValue(e){const t=this;if(t.pkgOptions.androidInstant=e,e){const e=await options_1.verificationFunc("remoteUrl",t.pkgOptions.remoteUrl,panel.options);t.pkgErrorMap.remoteUrl=e.error}else t.pkgErrorMap.remoteUrl=null;const a=await options_1.verificationFunc("apiLevel",t.pkgOptions.apiLevel,panel.options);t.pkgErrorMap.apiLevel=a.error,t.apiLevels.length||(t.pkgErrorMap.apiLevel="i18n:android.tips.apilevel_empty"),t.emitChange("androidInstant",e),t.emitChange("apiLevel",t.pkgOptions.apiLevel,t.pkgErrorMap.apiLevel),t.emitChange("remoteUrl",t.pkgOptions.remoteUrl,t.pkgErrorMap.remoteUrl)},async init(){const e=this;e.pkgOptions=lodash.get(panel.options,"packages.android")||{},e.apiLevels=await getAndroidAPILevels(),e.pkgOptions.apiLevel=e.pkgOptions.apiLevel||e.apiLevels[0];for(const t of Object.keys(options_1.defaultOptions)){const a=await options_1.verificationFunc(t,e.pkgOptions[t],panel.options);e.pkgErrorMap[t]=a.error}e.apiLevels.length||(e.pkgErrorMap.apiLevel="i18n:android.tips.apilevel_empty"),panel.dispatch("update",`packages.${e.pkgName}`,e.pkgOptions,e.pkgErrorMap)}};async function update(e,t){if((panel=this).options=e,"packages.native.JobSystem"===t)return panel.options.packages.native.JobSystem=e.packages.native.JobSystem,void panel.vm.onUpdateOptions("apiLevel",e.packages.android.apiLevel);t&&!t.startsWith(`packages.${panel.pkgName}`)||(panel.options=e,panel.vm.init())}function ready(e,t,a,p){panel=this;const n=require("vue/dist/vue.js");panel.options=e,panel.pkgName=a,panel.errorMap=p,panel.vm=new n({el:panel.$.root,data:()=>({pkgName:a,type:t,pkgOptions:options_1.defaultOptions,pkgErrorMap:options_1.defaultOptions,apiLevels:[],appABIList:["armeabi-v7a","arm64-v8a","x86","x86_64"]}),async mounted(){const e=this;if("check"===e.type)return e.pkgOptions=lodash.get(panel.options,"packages.android")||{},e.apiLevels=e.pkgOptions.apiLevel&&[e.pkgOptions.apiLevel],void(e.pkgErrorMap={});e.init()},methods:methods})}exports.$={root:".android"},exports.update=update,exports.ready=ready;const MIN_COMPILE_LEVEL=18;async function getAndroidAPILevels(){const e=await Editor.Profile.getConfig("program","android_sdk"),t=path_1.join(e,"platforms");return e&&fs_1.existsSync(e)&&fs_1.existsSync(t)?fs_1.readdirSync(t).filter(e=>{const a=getAPILevel(e),p=fs_1.statSync(path_1.join(t,e));return!!/^android-/.test(e)&&!!(a>=MIN_COMPILE_LEVEL&&p.isDirectory())}).map(e=>parseInt(e.split("-")[1])):[]}function getAPILevel(e){const t=(e=e||"").match("android-([0-9]+)$");let a=-1;return t&&(a=parseInt(t[1])),a}exports.getAPILevel=getAPILevel;