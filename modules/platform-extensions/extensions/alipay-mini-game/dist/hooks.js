"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterCopyBuildTemplate=exports.onBeforeCopyBuildTemplate=exports.onBeforeCompressSettings=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),share_1=require("./share");async function onAfterInit(e,i,t){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame",value:{orientation:e.packages["alipay-mini-game"].deviceOrientation}});var a=e.packages["alipay-mini-game"],i=(/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev?(a.separateEngine&&e.debug&&console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_debug")),"builtin"===e.engineInfo.typescript.type?a.separateEngine=a.separateEngine&&!e.debug:console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_custom_engine"))):console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_only_in_normal_version")),Object.assign(e.buildEngineParam,{sourceMaps:!a.separateEngine&&e.sourceMaps,skip:a.separateEngine}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),i.staticsInfo.B100011=e.packages["alipay-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=a.wasmSubpackage,e.buildEngineParam.includeModules),a=i.indexOf("gfx-webgpu");-1<a&&i.splice(a,1)}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.platform="ALIPAY",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}async function onBeforeCompressSettings(e,i,t){i.settings.screen.orientation=e.packages["alipay-mini-game"].deviceOrientation}async function onBeforeCopyBuildTemplate(e,i,t){var a,s,n=e.engineInfo.typescript.path;share_1.Paths.internalTemplateDir=(0,path_1.join)(n,"templates/alipay-mini-game");for(const r of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(n,"bin/adapter/minigame/alipay",`${r}.${e.debug?"":"min."}js`),(0,path_1.join)(i.paths.dir,r+".js"));this.buildTemplate.findFile("game.js")||(s=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),a={polyfillsBundleFile:i.paths.polyfillsJs&&Build.Utils.relativeUrl(i.paths.dir,i.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(i.paths.dir,i.paths.systemJs),importMapFile:Build.Utils.relativeUrl(i.paths.dir,i.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(i.paths.dir,i.paths.applicationJS)},s=await ejs_1.default.renderFile(s,a),(0,fs_extra_1.writeFileSync)((0,path_1.join)(i.paths.dir,"game.js"),s),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(i.paths.dir,"game.js")))}async function onAfterCopyBuildTemplate(e,i,t){var a=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json")),s=this.buildTemplate.findFile("game.json"),s=(s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(a,s)),a.screenOrientation=e.packages["alipay-mini-game"].deviceOrientation,e.packages["alipay-mini-game"]);if(s.separateEngine){var n=(0,path_1.join)(Build.buildTemplateDir,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(n)&&(e=await Editor.Profile.getConfig("alipay-mini-game","plugin-version")||Editor.App.version),a.plugins={cocos:{version:e,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}var r,o=[];for(const p of this.bundleManager.bundles)p.isSubpackage&&(r=(0,path_1.join)((0,path_1.dirname)(p.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(p.scriptDest)?(0,fs_extra_1.renameSync)(p.scriptDest,r):(0,fs_extra_1.outputFileSync)(r,`console.log('${p.name}: no script in subPackage.')`,"utf8"),p.scriptDest=r,o.push({name:p.name,root:`subpackages/${p.name}/`}));s.wasmSubpackage&&(n=(0,path_1.join)(i.paths.engineDir,"./assets/"),s=(0,path_1.join)(i.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(n)&&o.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(s))&&o.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),0<o.length&&(a.subpackages=o);n=(0,path_1.join)(i.paths.dir,"game.json");e.md5CacheOptions.excludes.push(n),(0,fs_extra_1.writeJSONSync)(n,a)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate;