"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby");async function onAfterInit(e,t,a){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame"}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir);let i=e.packages["alipay-mini-game"].remoteUrl||"";i&&!i.endsWith("/")&&(i+="/"),Object.assign(e.appTemplateData,{showFPS:!1,server:i}),e.moveRemoteBundleScript=!0,Object.assign(e.buildEngineParam,{platform:"ALIPAY"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.polyfills=e.packages["alipay-mini-game"].polyfills,e.buildScriptParam.system={preset:"commonjs-like"},-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0;const r={orientation:e.packages["alipay-mini-game"].deviceOrientation,remoteServerAddress:e.packages["alipay-mini-game"].remoteUrl};a.__addStaticsInfo(r)}async function onBeforeCompressSettings(e,t,a){t.settings.orientation=e.packages["alipay-mini-game"].deviceOrientation}async function onAfterBuild(e,t,a){if(!t.paths.dir)return;const i=(await Editor.Message.request("engine","query-info")).path,r=path_1.join(i,"platforms/minigame"),s=(e.buildEngineParam.engineName,path_1.join(__dirname,"../static/build-template"));copyAdapter(r,t.paths.dir);this.getTaskResult("build-task/script");const o={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},l=await ejs_1.default.renderFile(path_1.join(s,"game.ejs"),o);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),l);const n=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(n)&&(fs_extra_1.copySync(n,t.paths.dir),console.debug(`Use build-template {link(${n})}.`));const p=fs_extra_1.readJSONSync(path_1.join(s,"game.json"));p.screenOrientation=e.packages["alipay-mini-game"].deviceOrientation;const c=path_1.join(n,"game.json");if(fs_extra_1.existsSync(c)){const e=fs_extra_1.readJSONSync(c);Object.assign(p,e)}const m=path_1.join(t.paths.dir,"game.json");fs_extra_1.writeJSONSync(m,p)}async function copyAdapter(e,t){const a=await globby(path_1.join(e,"common/**/*"),{nodir:!0});await Promise.all(a.map(a=>{let i=fs_extra_1.readFileSync(a,"utf8");i=compileJS(i,a);const r=path_1.relative(e,a),s=path_1.join(t,"libs",r);fs_extra_1.outputFileSync(s,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)});const i=await globby(path_1.join(e,"platforms/alipay/wrapper/**/*"),{nodir:!0});await Promise.all(i.map(a=>{let i=fs_extra_1.readFileSync(a,"utf8");i=compileJS(i,a);const r=path_1.relative(path_1.join(e,"platforms/alipay/"),a),s=path_1.join(t,"libs",r);fs_extra_1.outputFileSync(s,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)})}function compileJS(e,t){let a;try{a=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[[require("@babel/preset-env"),{loose:!0}]],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return a.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;