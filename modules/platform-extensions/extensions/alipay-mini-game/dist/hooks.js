"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby");async function onAfterInit(e,t,i){e.polyfills&&(e.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame",value:{orientation:e.packages["alipay-mini-game"].deviceOrientation}}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.moveRemoteBundleScript=!0,Object.assign(e.buildEngineParam,{platform:"ALIPAY"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0;const a={orientation:e.packages["alipay-mini-game"].deviceOrientation,remoteServerAddress:e.server};i.__addStaticsInfo(a)}async function onBeforeCompressSettings(e,t,i){t.settings.orientation=e.packages["alipay-mini-game"].deviceOrientation}async function onAfterBuild(e,t,i){if(!t.paths.dir)return;const a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=path_1.join(a,"templates/alipay-mini-game");await fs_extra_1.copy(path_1.join(a,"bin/adapter/minigame/alipay",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(a,"bin/adapter/minigame/alipay",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"));this.getTaskResult("build-task/script");const r={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},n=await ejs_1.default.renderFile(path_1.join(s,"game.ejs"),r);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),n);const o=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(o)&&(fs_extra_1.copySync(o,t.paths.dir),console.debug(`Use build-template {link(${o})}.`));const p=fs_extra_1.readJSONSync(path_1.join(s,"game.json"));p.screenOrientation=e.packages["alipay-mini-game"].deviceOrientation;const l=path_1.join(o,"game.json");if(fs_extra_1.existsSync(l)){const e=fs_extra_1.readJSONSync(l);Object.assign(p,e)}const d=path_1.join(t.paths.dir,"game.json");fs_extra_1.writeJSONSync(d,p)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;