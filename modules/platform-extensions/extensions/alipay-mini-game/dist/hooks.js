"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs"));async function onAfterInit(e,i,t){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"alipay-minigame",value:{orientation:e.packages["alipay-mini-game"].deviceOrientation}});const a=e.packages["alipay-mini-game"];if(/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){a.separateEngine&&e.debug&&console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?a.separateEngine=a.separateEngine&&!e.debug:console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("alipay-mini-game.tips.separate_engine_only_in_normal_version"));Object.assign(e.buildEngineParam,{sourceMaps:!a.separateEngine&&e.sourceMaps,skip:a.separateEngine}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),i.staticsInfo.B100011=e.packages["alipay-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=a.wasmSubpackage}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.platform="ALIPAY",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0}async function onBeforeCompressSettings(e,i,t){i.settings.screen.orientation=e.packages["alipay-mini-game"].deviceOrientation}async function onAfterBuild(e,i,t){if(!i.paths.dir)return;const a=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=(0,path_1.join)(a,"templates/alipay-mini-game");await(0,fs_extra_1.copy)((0,path_1.join)(a,"bin/adapter/minigame/alipay",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(i.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(a,"bin/adapter/minigame/alipay",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(i.paths.dir,"engine-adapter.js"));const n={polyfillsBundleFile:i.paths.polyfillsJs&&Build.Utils.relativeUrl(i.paths.dir,i.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(i.paths.dir,i.paths.systemJs),importMapFile:Build.Utils.relativeUrl(i.paths.dir,i.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(i.paths.dir,i.paths.applicationJS)},r=await ejs_1.default.renderFile((0,path_1.join)(s,"game.ejs"),n);(0,fs_extra_1.writeFileSync)((0,path_1.join)(i.paths.dir,"game.js"),r);const o=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(o)&&((0,fs_extra_1.copySync)(o,i.paths.dir),console.debug(`Use build-template {link(${o})}.`));const p=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s,"game.json")),l=(0,path_1.join)(o,"game.json");if((0,fs_extra_1.existsSync)(l)){const e=(0,fs_extra_1.readJSONSync)(l);Object.assign(p,e)}p.screenOrientation=e.packages["alipay-mini-game"].deviceOrientation;const c=e.packages["alipay-mini-game"];if(c.separateEngine){const e=(0,path_1.join)(Build.buildTemplateDir,"patch.json");let i=Editor.App.version;(0,fs_extra_1.existsSync)(e)&&(i=await Editor.Profile.getConfig("alipay-mini-game","plugin-version")||Editor.App.version),p.plugins={cocos:{version:i,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}const u=[];for(const e of this.bundleManager.bundles){if(!e.isSubpackage)continue;const i=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js");(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,i):(0,fs_extra_1.outputFileSync)(i,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=i,u.push({name:e.name,root:`subpackages/${e.name}/`})}if(c.wasmSubpackage){const e=(0,path_1.join)(i.paths.engineDir,"./assets/"),t=(0,path_1.join)(i.paths.engineDir,"./chunks/");(0,fs_extra_1.existsSync)(e)&&u.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(t)&&u.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"})}u.length>0&&(p.subpackages=u);const d=(0,path_1.join)(i.paths.dir,"game.json");(0,fs_extra_1.writeJSONSync)(d,p)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;