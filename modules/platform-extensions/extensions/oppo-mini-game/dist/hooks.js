"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,i){void 0===i&&(i=t);var n=Object.getOwnPropertyDescriptor(a,t);n&&("get"in n?a.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,i,n)}:function(e,a,t,i){e[i=void 0===i?t:i]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var a,t=[];for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[t.length]=a);return t})(e)};return function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t=n(e),i=0;i<t.length;i++)"default"!==t[i]&&__createBinding(a,e,t[i]);return __setModuleDefault(a,e),a}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.make=make;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importStar(require("path")),Ejs=__importStar(require("ejs")),share_1=require("./share");async function onAfterInit(e,a,t){e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),a.staticsInfo.B100011=e.packages["oppo-mini-game"].deviceOrientation,a.staticsInfo.B100005=e.packages["oppo-mini-game"].package,e.useSplashScreen&&({logo:a,background:i}=await Editor.Profile.getProject("builder","splash-setting"),"custom"===a.type&&a.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(a.image))||"custom"===i.type&&i.image&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(i.image)))&&console.error("The width or height of the splash screen image cannot be larger than 4069 for oppo-mini-game!");var i,a=e.packages["oppo-mini-game"];e.buildScriptParam.flags.WASM_SUBPACKAGE=a.wasmSubpackage&&!a.separateEngine,a.separateEngine&&(e.buildEngineParam.separateEngineOptions={pluginFeatures:"all",outputLocalPlugin:!0,pluginName:share_1.ENGINE_PLUGIN_NAME},e.buildEngineParam.nativeCodeBundleMode="asmjs"),a.icon=Editor.UI.__protected__.File.resolveToRaw(a.icon),a.privatePemPath&&(a.privatePemPath=Editor.UI.__protected__.File.resolveToRaw(a.privatePemPath)),a.certificatePemPath&&(a.certificatePemPath=Editor.UI.__protected__.File.resolveToRaw(a.certificatePemPath))}function onBeforeBundleInit(e,a){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.system={preset:"commonjs-like"}}function onAfterBundleDataTask(a,e){e.forEach(e=>{e.isSubpackage&&(e.dest=path_1.default.join((0,path_1.dirname)(a.dest),share_1.subpackagePrefix+e.name),e.scriptDest=path_1.default.join(e.dest,"main.js"))})}async function onAfterBundleBuildTask(e,a,t){const i=[];a.forEach(e=>{e.isSubpackage&&(e=""+share_1.subpackagePrefix+e.name,i.push({name:e,root:e+"/"}))}),i.length&&(e.packages["oppo-mini-game"].subpackages=i)}async function onBeforeCopyBuildTemplate(e,a,t){var i=e.packages["oppo-mini-game"],{icon:n,useDebugKey:r,privatePemPath:s,certificatePemPath:o}=i,p=(0,path_1.join)(a.paths.dir,`src/${e.buildScriptParam.outputName}.js`),p=((0,fs_extra_1.existsSync)(p)||(0,fs_extra_1.outputFileSync)(p,"console.log('There is no script in project.')","utf8"),this.buildTemplate.findFile("main.js")||await renderMainJs(this.buildTemplate.initUrl("main.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"main.ejs"),e,a),await generateAdapter(e,a.paths.dir),(0,path_1.join)(a.paths.dir,share_1.ICON_NAME+(0,path_1.extname)(n)));(0,fs_extra_1.copyFileSync)(n,p),e.md5CacheOptions.excludes.push(share_1.ICON_NAME+(0,path_1.extname)(n)),handleSign(a.paths.dir,r,s,o),i.wasmSubpackage&&!i.separateEngine&&(p=(0,path_1.join)(a.paths.engineDir,"./assets/"),e=(0,path_1.join)(a.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(p)&&(i.subpackages??=[],i.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(p,"game.js"),(0,path_1.join)(p,"main.js"))),(0,fs_extra_1.existsSync)(e))&&(i.subpackages??=[],i.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(e,"game.js"),(0,path_1.join)(e,"main.js")))}async function onAfterCopyBuildTemplate(e,a){var t=this.buildTemplate.findFile("manifest.json");e.packages["oppo-mini-game"].hasSubPackage=await writeConfigFile(a.paths.dir,e,t)}async function renderMainJs(e,a,t){var i={optionDebug:a.debug,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},e=await Ejs.renderFile(e,i);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"main.js"),e),a.md5CacheOptions.replaceOnly.push("main.js")}async function make(e,a){var t={name:a.name,hasSubPackage:!!a.packages["oppo-mini-game"].hasSubPackage,useDebugKey:a.packages["oppo-mini-game"].useDebugKey};if(!await isInstallNodeJs())throw new Error("Please install node in global first!");(0,fs_extra_1.existsSync)(share_1.Paths.packPath)||(console.debug("start unzip pack tools"),i=require("v-unzip"),n=share_1.Paths.packPath+".zip",await i.unzip(n,share_1.Paths.packPath)),(0,fs_extra_1.emptyDirSync)(share_1.Paths.temp);var i=(0,path_1.join)(share_1.Paths.temp,"remote"),n=(0,path_1.join)(e,"remote");a.server&&(0,fs_extra_1.existsSync)(n)&&(0,fs_extra_1.moveSync)(n,i),t.hasSubPackage?(console.log(Editor.I18n.t("oppo-runtime.building_subpack_rpk")),await buildSubPackage(e,t)):await buildRpk(e,t),a.server&&(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.moveSync)(i,n)}async function buildRpk(e,a){console.log(Editor.I18n.t("oppo-builder.rpk_installing"));var t=[""+(0,path_1.join)(share_1.Paths.packPath,"lib/bin/index"),"cocoscreator"],t=(a.useDebugKey||t.push("release"),await Build.Utils.quickSpawn("node",t,{env:process.env,cwd:e}));if(!0===t)return t=(0,path_1.join)(e,"dist",a.name+(a.useDebugKey?".":".signed.")+"rpk"),console.log(Editor.I18n.t("oppo-mini-game.tips.rpk_install_success")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("oppo-mini-game.tips.rpk_install_fail"))}async function buildSubPackage(e,a){var t=[(0,path_1.join)(share_1.Paths.packPath,"lib/bin/index"),"subpack","--no-build-js"],t=(a.useDebugKey||t.push("release"),await Build.Utils.quickSpawn("node",t,{env:process.env,cwd:e}));if(t||1===t)return t=(0,path_1.join)(e,"dist",a.name+(a.useDebugKey?".":".signed.")+"rpk"),console.log(Editor.I18n.t("oppo-mini-game.tips.build_subpack_rpk_complet")+`{link(${t})}`),t;throw new Error(Editor.I18n.t("oppo-mini-game.tips.build_subpack_rpk_error"))}async function writeConfigFile(e,a,t){var i=a.packages["oppo-mini-game"],{versionName:n,versionCode:r,minPlatformVersion:s,deviceOrientation:o,icon:p}=i,c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"manifest.json")),t=(t&&(t=(0,fs_extra_1.readJSONSync)(t),Object.assign(c,t)),Object.assign(c,{package:i.package,name:a.name,versionName:n,versionCode:r,minPlatformVersion:s,icon:"/"+share_1.ICON_NAME+(0,path_1.extname)(p),orientation:o,useWebgl2:-1!==a.includeModules.indexOf("gfx-webgl2")}),i.subpackages&&0<i.subpackages.length?c.subpackages=i.subpackages:delete c.subpackages,i.separateEngine&&(c.plugins={},c.plugins[share_1.ENGINE_PLUGIN_NAME]={version:Editor.App.version,provider:"",path:share_1.ENGINE_PLUGIN_NAME},(0,fs_extra_1.writeJSONSync)((0,path_1.join)(e,share_1.ENGINE_PLUGIN_NAME+"/plugin.json"),{},{spaces:2})),(0,path_1.join)(e,"manifest.json"));return(0,fs_extra_1.writeJSONSync)(t,c),a.md5CacheOptions.excludes.push("manifest.json"),!!i.subpackages}function handleSign(e,a,t,i){e=(0,path_1.join)(e,"sign");(0,fs_extra_1.emptyDirSync)(e),a||(a=(0,path_1.join)(e,"release"),(0,fs_extra_1.ensureDirSync)(a),(0,fs_extra_1.existsSync)(t)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(a,"private.pem"),(0,fs_extra_1.readFileSync)(t)),(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.writeFileSync)((0,path_1.join)(a,"certificate.pem"),(0,fs_extra_1.readFileSync)(i)))}async function generateAdapter(e,a){var a=(0,path_1.join)(a,"runtime-adapter"),t=e.engineInfo.typescript.path,i=e.platform,t=(0,path_1.join)(t,"bin/adapter/runtime"),n=path_1.default.join(__dirname,"../static/adapter");await(0,fs_extra_1.copy)((0,path_1.join)(n,`web-adapter${e.debug?"":".min"}.js`),(0,path_1.join)(a,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(n,i,`ral.${e.debug?"":"min."}js`),(0,path_1.join)(a,"ral.js")),await(0,fs_extra_1.copy)((0,path_1.join)(t,i,`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(a,"engine-adapter.js")),e.md5CacheOptions.includes.push("runtime-adapter/*.js")}function isInstallNodeJs(){return new Promise((a,t)=>{(0,child_process_1.exec)("node -v",{env:process.env},e=>{e?("win32"===process.platform?console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),t(!1)):a(!0)})})}function validRatio(i){return new Promise((e,a)=>{const t=new Image;t.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(i).toString("base64"),t.onload=function(){(4096<t.width||4096<t.height)&&e(!1),e(!0)},t.onerror=function(e){a(e)}})}exports.throwError=!0;