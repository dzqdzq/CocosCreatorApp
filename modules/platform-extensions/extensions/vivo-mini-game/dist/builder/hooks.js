"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,s)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterBundleBuildTask=exports.onAfterBundleDataTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=__importStar(require("path")),cli_1=require("../utils/cli"),ejs_1=__importDefault(require("ejs")),ccbuild_1=require("@cocos/ccbuild"),separate_engine_1=require("./separate-engine"),ENGINE_PLUGIN_NAME="cocos-library",MAIN_JS_NAME="game.js",REAL_MAIN_JS_NAME="externs-game.js",REAL_MAIN_JS_PATH=REAL_MAIN_JS_NAME,ICON_NAME="image/icon",Paths={temp:(0,path_1.join)(Editor.Project.tmpDir,"builder","vivo-mini-game"),packPath:(0,path_1.join)(Editor.App.path,"../tools","vivo-pack-tools"),userTemplateDir:(0,path_1.join)(Build.buildTemplateDir,"vivo-mini-game")},templateDir=(0,path_1.join)(__dirname,"../../static/build-template"),subpackagePrefix="usr_";function getTemplatePath(e){return(0,path_1.join)(templateDir,e)}function getResPath(e){return(0,path_1.join)(templateDir,"res",e)}async function onAfterInit(e,t,a){const i=e.packages["vivo-mini-game"];e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{engineName:e.buildEngineParam.engineName}),e.buildScriptParam.system={preset:"commonjs-like"},t.staticsInfo.B100005=i.package,t.staticsInfo.B100011=i.deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage&&!i.separateEngine}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="VIVO"}async function onAfterBundleDataTask(e,t,a){t.forEach(t=>{t.isSubpackage&&(t.dest=path_1.default.join((0,path_1.dirname)(e.dest),subpackagePrefix+t.name),t.scriptDest=path_1.default.join(t.dest,MAIN_JS_NAME))})}async function onAfterBundleBuildTask(e,t,a){const i=[];t.forEach(e=>{if(!e.isSubpackage)return;const t=e.scriptDest;if((0,fs_extra_1.existsSync)(t)){const e="var System=window.System;";(0,fs_extra_1.writeFileSync)(t,e+(0,fs_extra_1.readFileSync)(t,"utf8"))}else(0,fs_extra_1.outputFileSync)(t,`console.log('${e.name}: no script in subPackage.')`,"utf8");const a=`${subpackagePrefix}${e.name}`;i.push({name:a,root:`${a}/`})}),i.length&&(e.packages["vivo-mini-game"].subpackages=i)}async function onAfterBuild(e,t,a){if(!t.paths.dir)return;await renderGameJs(e,t);const i=(0,path_1.join)(t.paths.dir,".src");await(0,fs_extra_1.ensureDir)(i);const s=t.paths.dir,n=await(0,fs_extra_1.readdir)(s);await Promise.all(n.map(async t=>{t===(0,path_1.basename)(i)||"remote"===t&&e.server||await(0,fs_extra_1.move)((0,path_1.join)(s,t),(0,path_1.join)(i,t))}));const r=(0,path_1.join)(t.paths.dir,"src");await(0,fs_extra_1.move)(i,r);const o=(0,path_1.join)(r,Build.SUBPACKAGES_HEADER);if((0,fs_extra_1.existsSync)(o)){for(const e of(0,fs_extra_1.readdirSync)(o)){const t=path_1.default.join(o,e),a=path_1.default.join(r,e);(0,fs_extra_1.moveSync)(t,a)}(0,fs_extra_1.removeSync)(o)}const c=e.packages["vivo-mini-game"];await generateAdapter(e,t.paths.dir),await handleSrc(e,t,r);const{useDebugKey:p,privatePemPath:l,certificatePemPath:_}=c;handleSign(t.paths.dir,p,l,_),await(0,fs_extra_1.outputFile)((0,path_1.join)(r,"game.js"),`require('${REAL_MAIN_JS_NAME}')`);const u=(await Editor.Message.request("engine","query-engine-info")).typescript.path,d=(0,path_1.join)(u,"templates",e.platform);if((0,fs_extra_1.existsSync)(Paths.userTemplateDir)){try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(d,"build-template.json"));if(t.version){const a=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let i="";(0,fs_extra_1.existsSync)(a)&&(i=(0,fs_extra_1.readJSONSync)(a)[e.platform]),compareBuildTemplateVersion(t.version,i)&&console.warn(Editor.I18n.t("vivo-mini-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}(0,fs_extra_1.copySync)(Paths.userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${Paths.userTemplateDir})}.`)}e.packages["vivo-mini-game"].separateEngine&&(await buildSeparateEngine(e,t),await handleImportMap(e,t));const f=await handleExternalFile(t.paths.dir,r);zipVIVOExternals(t.paths.dir,f),writeConfigFile(t.paths.dir,e,t,d)}async function initPackTools(){const e=Paths.packPath+".zip";if(!(0,fs_extra_1.existsSync)(Paths.packPath)&&(0,fs_extra_1.existsSync)(e)){console.debug("start unzip pack tools");const t=require("v-unzip");await t.unzip(e,Paths.packPath)}if(console.debug("Check is install nodejs"),console.debug("Check is install pack tools"),(0,cli_1.isInitVivo)(Paths.packPath))console.debug("Use the cache vivo pack tools");else{if(console.debug("install vivo pack tools "),!(0,cli_1.isInstallVivoMiniGameTool)())throw"win32"===process.platform?console.log(Editor.I18n.t("vivo-mini-game.tips.not_install_nodejs_windows_error")):console.log(Editor.I18n.t("vivo-mini-game.tips.not_install_nodejs_mac_error")),new Error("Please install tools: npm install -g @vivo-minigame/cli");await(0,cli_1.initVivoProject)(Paths.packPath)}console.debug("clear resources in pack tools"),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"src")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"engine")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"dist"))}async function make(e,t){const a={name:t.name,useDebugKey:t.packages["vivo-mini-game"].useDebugKey};await initPackTools(),(0,fs_extra_1.copySync)(e,Paths.packPath),await buildRpk(a);const i=(0,path_1.join)(Paths.packPath,"dist");if(!(0,fs_extra_1.existsSync)(i))throw new Error("build rpk failed!");(0,fs_extra_1.copySync)(i,(0,path_1.join)(e,"dist"))}async function readDirRecursive(e,t){return await Promise.all((await(0,fs_extra_1.readdir)(e)).map(async a=>{const i=(0,path_1.join)(e,a),s=await(0,fs_extra_1.stat)(i);s.isFile()?t(i):s.isDirectory()&&await readDirRecursive(i,t)}))}async function handleExternalFile(e,t){const a=[];return await readDirRecursive(t,i=>{if(!i.toLowerCase().endsWith(".js"))return;const s=Build.Utils.relativeUrl(t,i);a.push({module_name:s,module_path:s,module_from:Build.Utils.relativeUrl(e,i)})}),a}function zipVIVOExternals(e,t){const a=getResPath("minigame.config.js");let i=(0,fs_extra_1.readFileSync)(a,"utf8");i=i.replace("EXTERNALS_PLACEHOLDER",t.map(e=>JSON.stringify(e)).join(",\n")),(0,fs_extra_1.writeFileSync)((0,path_1.join)(e,"minigame.config.js"),i)}async function handleSrc(e,t,a){const i=e.packages["vivo-mini-game"],s=(0,path_1.join)(a,ICON_NAME+(0,path_1.extname)(i.icon));(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),(0,fs_extra_1.copyFileSync)(i.icon,s)}async function renderGameJs(e,t){const a={optionDebug:e.debug,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,importMapFile:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},i=await ejs_1.default.renderFile((0,path_1.join)(__dirname,"../../static/build-template/game.ejs"),a);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,REAL_MAIN_JS_PATH),i,"utf8")}async function buildRpk(e){if(console.log(Editor.I18n.t("vivo-mini-game.tips.rpk_installing")),!(0,fs_extra_1.existsSync)((0,path_1.join)(Paths.packPath,"node_modules/.staging"))){if(!await(0,cli_1.install)(Paths.packPath))return void console.error("build rpk failed!")}console.debug("start build rpk",e);const t=["run",e.useDebugKey?"build":"release"],a=await Build.Utils.quickSpawn("npm",t,{cwd:Paths.packPath,downGradeError:!0});if(!0!==a)throw new Error(Editor.I18n.t("vivo-mini-game.tips.rpk_install_fail")+a);console.log(Editor.I18n.t("vivo-mini-game.tips.rpk_install_success"))}async function buildSeparateEngine(e,t){const a=(await Editor.Message.request("engine","query-engine-info")).typescript.builtin,i=await(0,separate_engine_1.buildCocos)(a),s=await ccbuild_1.StatsQuery.create(a),n=(0,path_1.join)(i,"cocos"),r=(0,path_1.join)(t.paths.dir,ENGINE_PLUGIN_NAME);(0,fs_extra_1.ensureDirSync)(r),Build.Utils.copyDirSync(n,r);const o=s.getUnitsOfFeatures(e.includeModules),c=(0,path_1.join)(t.paths.dir,"src/cocos-js/cc.js"),p=await ccbuild_1.buildEngine.transform(s.evaluateIndexModuleSource(o,e=>`plugin:cocos-library/${e}.js`),"system");(0,fs_extra_1.emptyDirSync)((0,path_1.dirname)(c)),(0,fs_extra_1.outputFileSync)(c,p.code,"utf8");const l=(0,path_1.join)(r,"assets");if((0,fs_extra_1.existsSync)(l)){const e=(0,path_1.join)(t.paths.dir,"src/cocos-js/assets");(0,fs_extra_1.ensureDirSync)(e),(0,fs_extra_1.emptyDirSync)(e),Build.Utils.copyDirSync(l,e),(0,fs_extra_1.rmSync)(l,{force:!0,recursive:!0})}}async function handleImportMap(e,t){const a=(0,path_1.join)(t.paths.dir,"src/src/"+(0,path_1.basename)(t.paths.importMap)),i=await(0,fs_extra_1.readJson)(a);i.imports.cc="./../cocos-js/cc.js",(null===i||void 0===i?void 0:i.imports["wait-for-ammo-instantiation"])&&(i.imports["wait-for-ammo-instantiation"]="plugin:cocos-library/wait-for-ammo-instantiation.js"),(0,fs_extra_1.writeJson)(a,i,{spaces:2})}async function writeConfigFile(e,t,a,i){var s,n;const r=t.packages["vivo-mini-game"],o=(0,path_1.join)(e,"src","manifest.json");if(r.wasmSubpackage&&!r.separateEngine){const e=(0,path_1.join)(a.paths.dir,"./src/cocos-js/assets/"),t=(0,path_1.join)(a.paths.dir,"./src/cocos-js/chunks/");if((0,fs_extra_1.existsSync)(e)&&(null!==(s=r.subpackages)&&void 0!==s||(r.subpackages=[]),r.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"})),(0,fs_extra_1.existsSync)(t)){null!==(n=r.subpackages)&&void 0!==n||(r.subpackages=[]),r.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"});const e=(0,path_1.join)(t,"game.js");if((0,fs_extra_1.existsSync)(e)){const t="var System=window.System;",a=(0,fs_extra_1.readFileSync)(e,"utf8");(0,fs_extra_1.writeFileSync)(e,t+a)}}}const{versionName:c,versionCode:p,minPlatformVersion:l,logLevel:_,icon:u,deviceOrientation:d}=r,f=(0,fs_extra_1.readJSONSync)((0,path_1.join)(i,"project.config.json")),m=(0,path_1.join)(Paths.userTemplateDir,"project.config.json");if((0,fs_extra_1.existsSync)(m)){const e=(0,fs_extra_1.readJSONSync)(m);Object.assign(f,e)}Object.assign(f,{package:r.package,name:t.name,versionName:c,versionCode:p,minPlatformVersion:l,icon:"/"+ICON_NAME+(0,path_1.extname)(u),deviceOrientation:d,config:{logLevel:_||"log"}}),r.subpackages&&(f.subpackages=r.subpackages),r.separateEngine&&(f.plugins={},f.plugins[ENGINE_PLUGIN_NAME]={version:Editor.App.version,provider:"",path:ENGINE_PLUGIN_NAME},(0,fs_extra_1.outputJSONSync)((0,path_1.join)(e,`${ENGINE_PLUGIN_NAME}/plugin.json`),{},{spaces:2})),(0,fs_extra_1.outputJSONSync)(o,f,{spaces:2})}async function generateAdapter(e,t){const a=(0,path_1.join)(t,"src","runtime-adapter"),i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=e.platform,n=(0,path_1.join)(i,"bin/adapter/runtime");(0,fs_extra_1.ensureDirSync)(a);const r=(0,path_1.join)(n,s,`engine-adapter${e.debug?"":".min"}.js`),o=(0,path_1.join)(a,"engine-adapter.js");(0,fs_extra_1.copyFileSync)(r,o);const c=(0,path_1.join)(n,`web-adapter${e.debug?"":".min"}.js`),p=(0,path_1.join)(a,"web-adapter.js");(0,fs_extra_1.copyFileSync)(c,p);const l=(0,path_1.join)(n,s,`ral${e.debug?"":".min"}.js`),_=(0,path_1.join)(a,"ral.js");(0,fs_extra_1.copyFileSync)(l,_)}function handleSign(e,t,a,i){const s=(0,path_1.join)(e,"sign");if((0,fs_extra_1.emptyDirSync)(s),!t){const e=(0,path_1.join)(s,"release");(0,fs_extra_1.ensureDirSync)(e),(0,fs_extra_1.existsSync)(a)&&(0,fs_extra_1.copySync)(a,(0,path_1.join)(e,"private.pem")),(0,fs_extra_1.existsSync)(i)&&(0,fs_extra_1.copySync)(i,(0,path_1.join)(e,"certificate.pem"))}const n=(0,path_1.join)(s,"debug");(0,fs_extra_1.ensureDirSync)(n),(0,fs_extra_1.copySync)(getResPath("certificate.pem"),(0,path_1.join)(n,"certificate.pem")),(0,fs_extra_1.copySync)(getResPath("private.pem"),(0,path_1.join)(n,"private.pem"))}async function run(e,t){const a=t.packages["vivo-mini-game"],i=(0,path_1.join)(e,"dist",`${a.package}${a.useDebugKey?".":".signed."}rpk`);return(0,fs_extra_1.existsSync)(i)?(await Editor.Panel.open("vivo-mini-game.preview",i),Editor.Message.send("vivo-mini-game","update-rpk-path",i),!0):(console.error(`vivo rpk (${i}) does not exist, please build before preview!`),!1)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,i]=[e.split("."),t.split(".")],s=Math.max(a.length,i.length);for(let e=0;e<s;e++)if(parseInt(a[e])>parseInt(i[e]))return!0;return!1}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleDataTask=onAfterBundleDataTask,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;