"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const path_1=require("path"),fs_1=require("fs"),child_process_1=require("child_process"),cli_1=require("../utils/cli"),fs_extra_1=require("fs-extra"),killPort=require("./killPort");class PreviewManager{lastPid=null;lastRpkPath="";lastPreviewIp="";port=null;packToolDir=(0,path_1.join)(Editor.App.path,"../tools","vivo-pack-tools");run(e,o){var r;(0,cli_1.isInstallNodeJs)()?(0,fs_1.existsSync)(e)?(this.lastRpkPath=e,(0,fs_extra_1.copySync)((0,path_1.dirname)(e),(0,path_1.join)(this.packToolDir,"dist")),(0,fs_1.existsSync)((0,path_1.join)(this.packToolDir,"node_modules"))?(r="win32"===process.platform?"npm.cmd":"npm",r=(0,child_process_1.spawn)(r,["run","server"],{cwd:this.packToolDir,shell:!0}),this.lastPid=r.pid||null,(0,path_1.dirname)((0,path_1.dirname)(e)),r.stdout.on("data",e=>{var r,t;e&&-1!==e.indexOf("地址 http:")?(r=e.toString().replace(/[\n\r]/g,""),this.lastPreviewIp=r.match(t=/http:\/\/[^\s]*:(\d*)/)[0],this.port=Number(r.match(t)[1]),o(null,this.lastPreviewIp)):console.debug(e.toString())}),r.stderr.on("data",function(e){console.error(e.toString()),o(e)}),r.on("exit",(e,r)=>{console.debug("=======vivo preview process exit, exit:"+e)}),r.on("close",function(e,r){console.debug("=======vivo preview process close, exit:"+e)})):console.error("Please install in (vivo-pack-tools) first!")):console.error(`vivo rpk (${e}) does not exist, please build before preview!`):console.error("Please install nodeJs in global first!")}kill(e){killPort(e,this.port)}}exports.previewManager=new PreviewManager;