"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const path_1=require("path"),fs_1=require("fs"),child_process_1=require("child_process"),cli_1=require("../utils/cli"),fs_extra_1=require("fs-extra"),killPort=require("./killPort");class PreviewManager{constructor(){this.lastPid=null,this.lastRpkPath="",this.lastPreviewIp="",this.port=null,this.packToolDir=path_1.join(Editor.App.path,"../tools","vivo-pack-tools")}run(e,t){if(!cli_1.isInstallNodeJs())return void console.error("Please install nodeJs in global first!");if(!fs_1.existsSync(e))return void console.error(`vivo rpk (${e}) does not exist, please build before preview!`);if(this.lastRpkPath=e,fs_extra_1.copySync(path_1.dirname(e),path_1.join(this.packToolDir,"dist")),!fs_1.existsSync(path_1.join(this.packToolDir,"node_modules")))return void console.error("Please install in (vivo-pack-tools) first!");const i="win32"===process.platform?"npm.cmd":"npm",r=child_process_1.spawn(`${i}`,["run","server"],{cwd:this.packToolDir});this.lastPid=r.pid||null;path_1.dirname(path_1.dirname(e));r.stdout.on("data",e=>{if(e&&-1!==e.indexOf("地址 http:")){const i=e.toString().replace(/[\n\r]/g,""),r=/http:\/\/[^\s]*:(\d*)/;return this.lastPreviewIp=i.match(r)[0],this.port=Number(i.match(r)[1]),void t(null,this.lastPreviewIp)}console.debug(e.toString())}),r.stderr.on("data",function(e){console.error(e.toString()),t(e)}),r.on("exit",(e,t)=>{const i="=======vivo preview process exit, exit:"+e;console.debug(i)}),r.on("close",function(e,t){console.debug("=======vivo preview process close, exit:"+e)})}kill(e){killPort(e,this.port)}}exports.previewManager=new PreviewManager;