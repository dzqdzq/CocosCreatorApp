"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),cli_1=require("./utils/cli"),globby=require("globby"),PKG_NAME="xiaomi-quick-game",SUB_PACKAGE_JS_NAME="main.js",ICON_NAME="image/icon",Paths={temp:path_1.join(Build.projectTempDir,PKG_NAME),packPath:path_1.join(Editor.App.path,"../tools","xiaomi-pack-tools"),userTemplateDir:path_1.join(Build.buildTemplateDir,PKG_NAME),templateDir:""};function getTemplatePath(e){return path_1.join(Paths.templateDir,e)}function onBeforeBuild(e){const t=e.packages[PKG_NAME];t.certificatePemPath=Editor.UI.File.resolveToRaw(t.certificatePemPath),t.privatePemPath=Editor.UI.File.resolveToRaw(t.privatePemPath)}async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1);const i=e.packages[PKG_NAME];Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"xiaomi-runtime"}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.moveRemoteBundleScript=!0,e.generateCompileConfig=!0,-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.packages["xiaomi-quick-game"].icon=Editor.UI.File.resolveToRaw(e.packages["xiaomi-quick-game"].icon),Object.assign(e.buildEngineParam,{platform:"XIAOMI",engineName:"src/cocos-js"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS));const s={orientation:i.deviceOrientation,remoteServerAddress:e.server,packageName:i.package};a.__addStaticsInfo(s);const n=(await Editor.Message.request("engine","query-engine-info")).typescript.path;Paths.templateDir=path_1.join(n,"templates/xiaomi-quick-game")}async function onBeforeCompressSettings(e,t,a){sortSubPackage(e,t,a),t.settings.orientation=e.packages[PKG_NAME].deviceOrientation}async function onAfterBuild(e,t,a,i){const s=e.packages[PKG_NAME];if(!t.paths.dir)return;const n=(await Editor.Message.request("engine","query-engine-info")).typescript.path;if(await fs_extra_1.copy(path_1.join(n,"bin/adapter/minigame/xiaomi",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(n,"bin/adapter/minigame/xiaomi",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js")),await copyResFiles(e,t),s.encapsulation||void 0===s.encapsulation)for(const e of t.bundles){if(!fs_extra_1.existsSync(e.scriptDest))continue;const t=await fs_extra_1.readFile(e.scriptDest,"utf8");fs_extra_1.outputFileSync(e.scriptDest,`(function() { \n${t}\n })()`)}fs_extra_1.existsSync(Paths.userTemplateDir)&&(fs_extra_1.copySync(Paths.userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${Paths.userTemplateDir})}.`)),writeConfigFile(t.paths.dir,e,t);let o=fs_extra_1.readFileSync(t.paths.importMap,"utf-8");const r=path_1.basename(t.paths.engineDir);o=o.replace(new RegExp(`./${r}`,"g"),`no-schema:/src/${path_1.basename(t.paths.engineDir)}`),fs_extra_1.writeFileSync(t.paths.importMap,o)}async function make(e,t){const a={name:t.name,tinyPackageServer:t.server||"",useDebugKey:t.packages[PKG_NAME].useDebugKey};if(fs_extra_1.existsSync(Paths.packPath))await initPackFiles();else{console.debug("start unzip pack tools");const e=require("v-unzip"),t=Paths.packPath+".zip";await e.unzip(t,Paths.packPath)}if(console.debug("Check is install nodejs"),!await Build.Utils.isInstallNodeJs())return void console.error("Please install nodejs in global first!");console.debug("Check is install pack tools"),fs_extra_1.copySync(e,Paths.packPath),await buildRpk(a);const i=path_1.join(Paths.packPath,"dist");if(!fs_extra_1.existsSync(i))throw new Error("compile rpk failed!");fs_extra_1.copySync(i,path_1.join(e,"dist"));const s=path_1.join(e,"dist",`${t.name}${a.useDebugKey?".debug.":".release."}rpk`);console.debug(`compile rpk success {link(${s})}`)}async function copyResFiles(e,t){const a=e.packages[PKG_NAME],i=t.paths.systemJs;fs_extra_1.writeFileSync(i,"var self=window; var navigator=window.navigator;"+fs_extra_1.readFileSync(i,"utf8")),await buildGameJs(e,t);const s=path_1.join(t.paths.dir,ICON_NAME+path_1.extname(a.icon));fs_extra_1.ensureDirSync(path_1.dirname(s)),fs_extra_1.existsSync(a.icon)?fs_extra_1.copyFileSync(a.icon,s):console.warn("Icon is missing");const{useDebugKey:n,privatePemPath:o,certificatePemPath:r}=a;handleSign(t.paths.dir,n,o,r)}async function initPackFiles(){if(cli_1.isInit(Paths.packPath))console.debug("use the cache xiaomi pack tools");else{if(fs_extra_1.existsSync(path_1.join(Paths.packPath,"package.json"))||(fs_extra_1.copySync(getTemplatePath("package.json"),path_1.join(Paths.packPath,"package.json")),fs_extra_1.copySync(getTemplatePath("babel.config.js"),path_1.join(Paths.packPath,"babel.config.js"))),console.debug("start install xiaomi pack tools"),!0!==await cli_1.install(Paths.packPath))throw fs_extra_1.removeSync(path_1.join(Paths.packPath,"node_modules")),new Error("init xiaomi pack tools failed!");console.log("init xiaomi pack tools success")}fs_extra_1.removeSync(path_1.join(Paths.packPath,"src")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"libs")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"assets")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"remote")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"dist")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"image")),fs_extra_1.existsSync(path_1.join(Paths.packPath,"subpackages"))&&fs_extra_1.removeSync(path_1.join(Paths.packPath,"subpackages"))}async function buildRpk(e){let t=e.useDebugKey?"build":"release";e.tinyPackageServer&&(t+="-ignore-res");const a=["run",t,"--cocos-wx-game"];if(!0!==await Build.Utils.quickSpawn("npm",a,{cwd:Paths.packPath}))throw new Error("Build rpk failed!")}async function buildGameJs(e,t){e.packages[PKG_NAME],e.buildEngineParam.engineName;const a={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},i=await ejs_1.default.renderFile(getTemplatePath("game.ejs"),a);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,SUB_PACKAGE_JS_NAME),i,"utf8")}function sortSubPackage(e,t,a){for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),SUB_PACKAGE_JS_NAME);fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,""),e.scriptDest=t}}function writeConfigFile(e,t,a){const i=t.packages[PKG_NAME],s=path_1.join(e,"manifest.json"),{versionName:n,versionCode:o,minPlatformVersion:r,logLevel:c,icon:p,deviceOrientation:l}=i,_={package:i.package,name:t.name,versionName:n,versionCode:o,minPlatformVersion:r,icon:"/"+ICON_NAME+path_1.extname(p),orientation:l,type:"game",config:{logLevel:c},display:{}},u=[];for(const e of a.bundles)e.isSubpackage&&u.push({name:"usr_"+e.name,root:`subpackages/${e.name}/`});u.length>0&&(_.subpackages=u);const h=s.replace(e,Paths.userTemplateDir);if(fs_extra_1.existsSync(h)){const e=fs_extra_1.readJSONSync(h);Object.assign(_,e)}fs_extra_1.outputJSONSync(s,_)}function handleSign(e,t,a,i){const s=path_1.join(e,"sign");if(fs_extra_1.emptyDirSync(s),!t){const e=path_1.join(s,"release");return fs_extra_1.ensureDirSync(e),fs_extra_1.existsSync(a)&&fs_extra_1.copySync(a,path_1.join(e,"private.pem")),void(fs_extra_1.existsSync(i)&&fs_extra_1.copySync(i,path_1.join(e,"certificate.pem")))}const n=path_1.join(s,"debug");fs_extra_1.ensureDirSync(n),fs_extra_1.copySync(getTemplatePath("certificate/certificate.pem"),path_1.join(n,"certificate.pem")),fs_extra_1.copySync(getTemplatePath("certificate/private.pem"),path_1.join(n,"private.pem"))}async function run(e,t){const a=t.packages[PKG_NAME],i=path_1.join(e,"dist",`${a.package}${a.useDebugKey?".debug.":".release."}rpk`);return fs_extra_1.existsSync(i)?(await Editor.Panel.open("xiaomi-quick-game.preview"),Editor.Message.send(PKG_NAME,"update-rpk-path",i),!0):(console.error(`xiaomi rpk (${i}) does not exist, please build before preview!`),!1)}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;