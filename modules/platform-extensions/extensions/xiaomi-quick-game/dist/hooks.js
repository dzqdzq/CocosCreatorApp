"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onAfterInit=exports.onBeforeBundleInit=exports.onBeforeBuild=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),cli_1=require("./utils/cli"),globby=require("globby"),PKG_NAME="xiaomi-quick-game",SUB_PACKAGE_JS_NAME="main.js",ICON_NAME="image/icon",Paths={temp:path_1.join(Build.projectTempDir,PKG_NAME),packPath:path_1.join(Editor.App.path,"../tools","xiaomi-pack-tools"),userTemplateDir:path_1.join(Build.buildTemplateDir,PKG_NAME),templateDir:""};function getTemplatePath(e){return path_1.join(Paths.templateDir,e)}function onBeforeBuild(e){const t=e.packages[PKG_NAME];t.certificatePemPath=Editor.UI.__protected__.File.resolveToRaw(t.certificatePemPath),t.privatePemPath=Editor.UI.__protected__.File.resolveToRaw(t.privatePemPath)}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="XIAOMI",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterInit(e,t,a){const s=e.packages[PKG_NAME];Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"xiaomi-runtime"}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),s.icon=Editor.UI.__protected__.File.resolveToRaw(e.packages["xiaomi-quick-game"].icon),Object.assign(e.buildEngineParam,{engineName:"src/cocos-js"}),t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS)),t.staticsInfo.B100011=s.deviceOrientation,t.staticsInfo.B100005=s.package;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path;Paths.templateDir=path_1.join(i,"templates/xiaomi-quick-game"),e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage}async function onAfterBundleBuildTask(e,t,a){const s=[];for(const e of t){if(e.isSubpackage){const t=path_1.join(path_1.dirname(e.scriptDest),SUB_PACKAGE_JS_NAME);fs_extra_1.existsSync(e.scriptDest)&&fs_extra_1.renameSync(e.scriptDest,t),e.scriptDest=t,s.push({name:"usr_"+e.name,root:`subpackages/${e.name}/`})}await handleScript(e.scriptDest)}e.packages["xiaomi-quick-game"].subpackages=s}async function handleScript(e){if(!fs_extra_1.existsSync(e))return void fs_extra_1.outputFileSync(e,"(function() { \n \n })()");const t=await fs_extra_1.readFile(e,"utf8");fs_extra_1.outputFileSync(e,`(function() { \n${t}\n })()`)}async function onBeforeCompressSettings(e,t,a){t.settings.screen.orientation=e.packages[PKG_NAME].deviceOrientation}async function onAfterBuild(e,t,a,s){e.packages[PKG_NAME];if(!t.paths.dir)return;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path;if(await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/xiaomi",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/xiaomi",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js")),await copyResFiles(e,t),fs_extra_1.existsSync(Paths.userTemplateDir)){try{const t=fs_extra_1.readJSONSync(path_1.join(Paths.templateDir,"build-template.json"));if(t.version){const a=path_1.join(Paths.userTemplateDir,"templates-version.json");let s="";fs_extra_1.existsSync(a)&&(s=fs_extra_1.readJSONSync(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("xiaomi-quick-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}fs_extra_1.copySync(Paths.userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${Paths.userTemplateDir})}.`)}writeConfigFile(t.paths.dir,e,t);let n=fs_extra_1.readFileSync(t.paths.importMap,"utf-8");const r=path_1.basename(t.paths.engineDir);n=n.replace(new RegExp(`./${r}`,"g"),`no-schema:/src/${path_1.basename(t.paths.engineDir)}`),fs_extra_1.writeFileSync(t.paths.importMap,n)}async function make(e,t){const a={name:t.name,tinyPackageServer:t.server||"",useDebugKey:t.packages[PKG_NAME].useDebugKey};if(fs_extra_1.existsSync(Paths.packPath))await initPackFiles();else{console.debug("start unzip pack tools");const e=require("v-unzip"),t=Paths.packPath+".zip";await e.unzip(t,Paths.packPath)}if(console.debug("Check is install nodejs"),!await Build.Utils.isInstallNodeJs())return void console.error("Please install nodejs in global first!");console.debug("Check is install pack tools"),fs_extra_1.copySync(e,Paths.packPath),await buildRpk(a);const s=path_1.join(Paths.packPath,"dist");if(!fs_extra_1.existsSync(s))throw new Error("compile rpk failed!");fs_extra_1.copySync(s,path_1.join(e,"dist"));const i=path_1.join(e,"dist",`${t.name}${a.useDebugKey?".debug.":".release."}rpk`);console.debug(`compile rpk success {link(${i})}`)}async function copyResFiles(e,t){const a=e.packages[PKG_NAME],s=t.paths.systemJs;fs_extra_1.writeFileSync(s,"var self=window; var navigator=window.navigator;"+fs_extra_1.readFileSync(s,"utf8")),await buildGameJs(e,t);const i=path_1.join(t.paths.dir,ICON_NAME+path_1.extname(a.icon));fs_extra_1.ensureDirSync(path_1.dirname(i)),fs_extra_1.existsSync(a.icon)?fs_extra_1.copyFileSync(a.icon,i):console.warn("Icon is missing");const{useDebugKey:n,privatePemPath:r,certificatePemPath:o}=a;handleSign(t.paths.dir,n,r,o)}async function initPackFiles(){if(cli_1.isInit(Paths.packPath))console.debug("use the cache xiaomi pack tools");else{if(fs_extra_1.existsSync(path_1.join(Paths.packPath,"package.json"))||(fs_extra_1.copySync(getTemplatePath("package.json"),path_1.join(Paths.packPath,"package.json")),fs_extra_1.copySync(getTemplatePath("babel.config.js"),path_1.join(Paths.packPath,"babel.config.js"))),console.debug("start install xiaomi pack tools"),!0!==await cli_1.install(Paths.packPath))throw fs_extra_1.removeSync(path_1.join(Paths.packPath,"node_modules")),new Error("init xiaomi pack tools failed!");console.log("init xiaomi pack tools success")}fs_extra_1.removeSync(path_1.join(Paths.packPath,"src")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"libs")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"assets")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"remote")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"dist")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"image")),fs_extra_1.existsSync(path_1.join(Paths.packPath,"subpackages"))&&fs_extra_1.removeSync(path_1.join(Paths.packPath,"subpackages"))}async function buildRpk(e){let t=e.useDebugKey?"build":"release";e.tinyPackageServer&&(t+="-ignore-res");const a=["run",t,"--cocos-wx-game"];if(!0!==await Build.Utils.quickSpawn("npm",a,{cwd:Paths.packPath}))throw new Error("Build rpk failed!")}async function buildGameJs(e,t){e.packages[PKG_NAME],e.buildEngineParam.engineName;const a={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},s=await ejs_1.default.renderFile(getTemplatePath("game.ejs"),a);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,SUB_PACKAGE_JS_NAME),s,"utf8")}function writeConfigFile(e,t,a){var s,i;const n=t.packages[PKG_NAME],r=path_1.join(e,"manifest.json"),{versionName:o,versionCode:p,minPlatformVersion:c,logLevel:l,icon:_,deviceOrientation:u}=n,h={package:n.package,name:t.name,versionName:o,versionCode:p,minPlatformVersion:c,icon:"/"+ICON_NAME+path_1.extname(_),orientation:u,type:"game",config:{logLevel:l},display:{}};if(n.wasmSubpackage){const e=path_1.join(a.paths.engineDir,"./assets/"),t=path_1.join(a.paths.engineDir,"./chunks/");fs_extra_1.existsSync(e)&&(null!==(s=n.subpackages)&&void 0!==s||(n.subpackages=[]),n.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"src/cocos-js/assets/"}),fs_extra_1.renameSync(path_1.join(e,"game.js"),path_1.join(e,"main.js"))),fs_extra_1.existsSync(t)&&(null!==(i=n.subpackages)&&void 0!==i||(n.subpackages=[]),n.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"src/cocos-js/chunks/"}),fs_extra_1.renameSync(path_1.join(t,"game.js"),path_1.join(t,"main.js")))}n.subpackages&&(h.subpackages=n.subpackages);const f=path_1.join(Paths.userTemplateDir,"manifest.json");if(fs_extra_1.existsSync(f)){const e=fs_extra_1.readJSONSync(f);Object.assign(h,e)}fs_extra_1.outputJSONSync(r,h)}function handleSign(e,t,a,s){const i=path_1.join(e,"sign");if(fs_extra_1.emptyDirSync(i),!t){const e=path_1.join(i,"release");return fs_extra_1.ensureDirSync(e),fs_extra_1.existsSync(a)&&fs_extra_1.copySync(a,path_1.join(e,"private.pem")),void(fs_extra_1.existsSync(s)&&fs_extra_1.copySync(s,path_1.join(e,"certificate.pem")))}const n=path_1.join(i,"debug");fs_extra_1.ensureDirSync(n),fs_extra_1.copySync(getTemplatePath("certificate/certificate.pem"),path_1.join(n,"certificate.pem")),fs_extra_1.copySync(getTemplatePath("certificate/private.pem"),path_1.join(n,"private.pem"))}async function run(e,t){const a=t.packages[PKG_NAME],s=path_1.join(e,"dist",`${a.package}${a.useDebugKey?".debug.":".release."}rpk`);return fs_extra_1.existsSync(s)?(await Editor.Panel.open("xiaomi-quick-game.preview"),Editor.Message.send(PKG_NAME,"update-rpk-path",s),!0):(console.error(`xiaomi rpk (${s}) does not exist, please build before preview!`),!1)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],i=Math.max(a.length,s.length);for(let e=0;e<i;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterInit=onAfterInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;