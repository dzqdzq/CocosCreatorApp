"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onAfterInit=exports.onBeforeBundleInit=exports.onBeforeBuild=exports.throwError=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),cli_1=require("./utils/cli"),globby=require("globby"),PKG_NAME="xiaomi-quick-game",SUB_PACKAGE_JS_NAME="main.js",ICON_NAME="image/icon",Paths={temp:(0,path_1.join)(Build.projectTempDir,PKG_NAME),packPath:(0,path_1.join)(Editor.App.path,"../tools","xiaomi-pack-tools"),userTemplateDir:(0,path_1.join)(Build.buildTemplateDir,PKG_NAME),templateDir:""};function getTemplatePath(e){return(0,path_1.join)(Paths.templateDir,e)}function onBeforeBuild(e){const t=e.packages[PKG_NAME];t.certificatePemPath=Editor.UI.__protected__.File.resolveToRaw(t.certificatePemPath),t.privatePemPath=Editor.UI.__protected__.File.resolveToRaw(t.privatePemPath)}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="XIAOMI",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterInit(e,t,a){const s=e.packages[PKG_NAME];Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"xiaomi-runtime"}),e.generateCompileConfig=!0,e.server&&!e.server.endsWith("/")&&(e.server+="/"),s.icon=Editor.UI.__protected__.File.resolveToRaw(e.packages["xiaomi-quick-game"].icon),Object.assign(e.buildEngineParam,{engineName:"src/cocos-js"}),t.paths.applicationJS=(0,path_1.join)(t.paths.dir,"src",(0,path_1.basename)(t.paths.applicationJS)),t.staticsInfo.B100011=s.deviceOrientation,t.staticsInfo.B100005=s.package;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path;Paths.templateDir=(0,path_1.join)(i,"templates/xiaomi-quick-game"),e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage}async function onAfterBundleBuildTask(e,t,a){const s=[];for(const e of t){if(e.isSubpackage){const t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),SUB_PACKAGE_JS_NAME);(0,fs_extra_1.existsSync)(e.scriptDest)&&(0,fs_extra_1.renameSync)(e.scriptDest,t),e.scriptDest=t,s.push({name:"usr_"+e.name,root:`subpackages/${e.name}/`})}await handleScript(e.scriptDest)}e.packages["xiaomi-quick-game"].subpackages=s}async function handleScript(e){if(!(0,fs_extra_1.existsSync)(e))return void(0,fs_extra_1.outputFileSync)(e,"(function() { \n \n })()");const t=await(0,fs_extra_1.readFile)(e,"utf8");(0,fs_extra_1.outputFileSync)(e,`(function() { \n${t}\n })()`)}async function onBeforeCompressSettings(e,t,a){t.settings.screen.orientation=e.packages[PKG_NAME].deviceOrientation}async function onAfterBuild(e,t,a,s){e.packages[PKG_NAME];if(!t.paths.dir)return;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path;if(await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/xiaomi",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/xiaomi",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js")),await copyResFiles(e,t),(0,fs_extra_1.existsSync)(Paths.userTemplateDir)){try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(Paths.templateDir,"build-template.json"));if(t.version){const a=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let s="";(0,fs_extra_1.existsSync)(a)&&(s=(0,fs_extra_1.readJSONSync)(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("xiaomi-quick-game.tips.templateVersionWarning"))}}catch(e){console.debug(e)}(0,fs_extra_1.copySync)(Paths.userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${Paths.userTemplateDir})}.`)}writeConfigFile(t.paths.dir,e,t);let n=(0,fs_extra_1.readFileSync)(t.paths.importMap,"utf-8");const o=(0,path_1.basename)(t.paths.engineDir);n=n.replace(new RegExp(`./${o}`,"g"),`no-schema:/src/${(0,path_1.basename)(t.paths.engineDir)}`),(0,fs_extra_1.writeFileSync)(t.paths.importMap,n)}async function make(e,t){const a={name:t.name,tinyPackageServer:t.server||"",useDebugKey:t.packages[PKG_NAME].useDebugKey};if((0,fs_extra_1.existsSync)(Paths.packPath))await initPackFiles();else{console.debug("start unzip pack tools");const e=require("v-unzip"),t=Paths.packPath+".zip";await e.unzip(t,Paths.packPath)}if(console.debug("Check is install nodejs"),!await Build.Utils.isInstallNodeJs())return void console.error("Please install nodejs in global first!");console.debug("Check is install pack tools"),(0,fs_extra_1.copySync)(e,Paths.packPath),await buildRpk(a);const s=(0,path_1.join)(Paths.packPath,"dist");if(!(0,fs_extra_1.existsSync)(s))throw new Error("compile rpk failed!");(0,fs_extra_1.copySync)(s,(0,path_1.join)(e,"dist"));const i=(0,path_1.join)(e,"dist",`${t.name}${a.useDebugKey?".debug.":".release."}rpk`);console.debug(`compile rpk success {link(${i})}`)}async function copyResFiles(e,t){const a=e.packages[PKG_NAME],s=t.paths.systemJs;(0,fs_extra_1.writeFileSync)(s,"var self=window; var navigator=window.navigator;"+(0,fs_extra_1.readFileSync)(s,"utf8")),await buildGameJs(e,t);const i=(0,path_1.join)(t.paths.dir,ICON_NAME+(0,path_1.extname)(a.icon));(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(i)),(0,fs_extra_1.existsSync)(a.icon)?(0,fs_extra_1.copyFileSync)(a.icon,i):console.warn("Icon is missing");const{useDebugKey:n,privatePemPath:o,certificatePemPath:r}=a;handleSign(t.paths.dir,n,o,r)}async function initPackFiles(){if((0,cli_1.isInit)(Paths.packPath))console.debug("use the cache xiaomi pack tools");else{if((0,fs_extra_1.existsSync)((0,path_1.join)(Paths.packPath,"package.json"))||((0,fs_extra_1.copySync)(getTemplatePath("package.json"),(0,path_1.join)(Paths.packPath,"package.json")),(0,fs_extra_1.copySync)(getTemplatePath("babel.config.js"),(0,path_1.join)(Paths.packPath,"babel.config.js"))),console.debug("start install xiaomi pack tools"),!0!==await(0,cli_1.install)(Paths.packPath))throw(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"node_modules")),new Error("init xiaomi pack tools failed!");console.log("init xiaomi pack tools success")}(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"src")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"libs")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"assets")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"remote")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"dist")),(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"image")),(0,fs_extra_1.existsSync)((0,path_1.join)(Paths.packPath,"subpackages"))&&(0,fs_extra_1.removeSync)((0,path_1.join)(Paths.packPath,"subpackages"))}async function buildRpk(e){let t=e.useDebugKey?"build":"release";e.tinyPackageServer&&(t+="-ignore-res");const a=["run",t,"--cocos-wx-game"];if(!0!==await Build.Utils.quickSpawn("npm",a,{cwd:Paths.packPath}))throw new Error("Build rpk failed!")}async function buildGameJs(e,t){e.packages[PKG_NAME],e.buildEngineParam.engineName;const a={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},s=await ejs_1.default.renderFile(getTemplatePath("game.ejs"),a);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,SUB_PACKAGE_JS_NAME),s,"utf8")}function writeConfigFile(e,t,a){var s,i;const n=t.packages[PKG_NAME],o=(0,path_1.join)(e,"manifest.json");if(n.wasmSubpackage){const e=(0,path_1.join)(a.paths.engineDir,"./assets/"),t=(0,path_1.join)(a.paths.engineDir,"./chunks/");(0,fs_extra_1.existsSync)(e)&&(null!==(s=n.subpackages)&&void 0!==s||(n.subpackages=[]),n.subpackages.push({name:"__ccWasmAssetSubpkg__",root:"src/cocos-js/assets/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(e,"game.js"),(0,path_1.join)(e,"main.js"))),(0,fs_extra_1.existsSync)(t)&&(null!==(i=n.subpackages)&&void 0!==i||(n.subpackages=[]),n.subpackages.push({name:"__ccWasmChunkSubpkg__",root:"src/cocos-js/chunks/"}),(0,fs_extra_1.renameSync)((0,path_1.join)(t,"game.js"),(0,path_1.join)(t,"main.js")))}const{versionName:r,versionCode:c,minPlatformVersion:p,logLevel:l,icon:_,deviceOrientation:u}=n,h=(0,fs_extra_1.readJSONSync)((0,path_1.join)(Paths.templateDir,"manifest.json")),f=(0,path_1.join)(Paths.userTemplateDir,"manifest.json");if((0,fs_extra_1.existsSync)(f)){const e=(0,fs_extra_1.readJSONSync)(f);Object.assign(h,e)}Object.assign(h,{package:n.package,name:t.name,versionName:r,versionCode:c,minPlatformVersion:p,icon:"/"+ICON_NAME+(0,path_1.extname)(_),orientation:u,config:{logLevel:l||"log"}}),n.subpackages&&(h.subpackages=n.subpackages),(0,fs_extra_1.outputJSONSync)(o,h)}function handleSign(e,t,a,s){const i=(0,path_1.join)(e,"sign");if((0,fs_extra_1.emptyDirSync)(i),!t){const e=(0,path_1.join)(i,"release");return(0,fs_extra_1.ensureDirSync)(e),(0,fs_extra_1.existsSync)(a)&&(0,fs_extra_1.copySync)(a,(0,path_1.join)(e,"private.pem")),void((0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.copySync)(s,(0,path_1.join)(e,"certificate.pem")))}const n=(0,path_1.join)(i,"debug");(0,fs_extra_1.ensureDirSync)(n),(0,fs_extra_1.copySync)(getTemplatePath("certificate/certificate.pem"),(0,path_1.join)(n,"certificate.pem")),(0,fs_extra_1.copySync)(getTemplatePath("certificate/private.pem"),(0,path_1.join)(n,"private.pem"))}async function run(e,t){const a=t.packages[PKG_NAME],s=(0,path_1.join)(e,"dist",`${a.package}${a.useDebugKey?".debug.":".release."}rpk`);return(0,fs_extra_1.existsSync)(s)?(await Editor.Panel.open("xiaomi-quick-game.preview"),Editor.Message.send(PKG_NAME,"update-rpk-path",s),!0):(console.error(`xiaomi rpk (${s}) does not exist, please build before preview!`),!1)}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],i=Math.max(a.length,s.length);for(let e=0;e<i;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterInit=onAfterInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;