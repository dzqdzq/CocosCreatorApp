"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),killPort=require("./killPort");class PreviewManager{constructor(){this.lastPid=null,this.lastPreviewIp="",this.port=4e3,this.child=null}run(e,r){if(!isInstallNodeJs())return void console.error("Please install nodeJs in global first!");if(!(0,fs_1.existsSync)(e))return void console.error(`xiaomi rpk (${e}) does not exist, please build before preview!`);const t=(0,path_1.join)(Editor.App.path,"../tools","xiaomi-pack-tools");if((0,fs_extra_1.copySync)((0,path_1.dirname)(e),(0,path_1.join)(t,"dist")),!(0,fs_1.existsSync)((0,path_1.join)(t,"node_modules")))return void console.error(`Please install in (${t}) first!`);const o="win32"===process.platform?"npm.cmd":"npm",s=(0,child_process_1.spawn)(`${o}`,["run","server","--","--port",String(this.port)],{cwd:t});this.lastPid=s.pid||null,s.stdout.on("data",e=>{-1!==e.indexOf("生成HTTP服务器的二维码")&&(console.log(e),r(!0))}),s.stderr.on("data",function(e){const t=e.toString();let o="error";(/Cannot read property 'ws' of undefined/gi.test(t)||/Unhandled promise rejections are deprecated/gi.test(t))&&(o="warn"),console[o](t),r(!1,e)}),s.on("exit",(e,r)=>{console.log("=======child process exit ,exit:"+e),this.lastPid=null}),s.on("close",(e,r)=>{console.log("=======child process close ,exit:"+e),this.lastPid=null})}exist(){this.lastPid&&killPort(this.lastPid,this.port)}async getPreviewIp(){return`http://${await Editor.Message.request("preview","get-preview-ip")}:${this.port}`}}function isInstallNodeJs(){return new Promise((e,r)=>{(0,child_process_1.exec)("node -v",{},t=>{if(t){if("win32"===process.platform)return console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))),void r(!1);console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),r(!1)}else e(!0)})})}exports.previewManager=new PreviewManager;