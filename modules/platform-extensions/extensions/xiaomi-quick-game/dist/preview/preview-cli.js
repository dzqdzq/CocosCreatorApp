"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewManager=void 0;const child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),killPort=require("./killPort");class PreviewManager{constructor(){this.lastPid=null,this.lastPreviewIp="",this.port="4000",this.child=null}run(e,r){if(!isInstallNodeJs())return void console.error("Please install nodeJs in global first!");if(!fs_1.existsSync(e))return void console.error(`xiaomi rpk (${e}) does not exist, please build before preview!`);const o=path_1.join(Editor.App.path,"../tools","xiaomi-pack-tools");if(fs_extra_1.copySync(path_1.dirname(e),path_1.join(o,"dist")),!fs_1.existsSync(path_1.join(o,"node_modules")))return void console.error(`Please install in (${o}) first!`);const s="win32"===process.platform?"npm.cmd":"npm",t=child_process_1.spawn(`${s}`,["run","server","--","--port",this.port],{cwd:o});this.lastPid=t.pid,t.stdout.on("data",e=>{-1!==e.indexOf("生成HTTP服务器的二维码")&&(console.log(e),r(!0))}),t.stderr.on("data",function(e){console.error(e.toString()),r(!1,e)}),t.on("exit",(e,r)=>{console.log("=======child process exit ,exit:"+e),this.lastPid=null}),t.on("close",(e,r)=>{console.log("=======child process close ,exit:"+e),this.lastPid=null})}exist(){this.lastPid&&killPort(this.lastPid,this.port)}async getPreviewIp(){return`http://${await Editor.Message.request("preview","get-preview-ip")}:${this.port}`}}function isInstallNodeJs(){return new Promise((e,r)=>{child_process_1.exec("node -v",{},o=>{if(o){if("win32"===process.platform)return console.error(new Error(Editor.I18n.t("builder.window_default_npm_path_error"))),void r(!1);console.error(new Error(Editor.I18n.t("builder.mac_default_npm_path_error"))),r(!1)}else e(!0)})})}exports.previewManager=new PreviewManager;