"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.run=run;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),child_process_1=require("child_process"),share_1=require("./share"),globby_1=__importDefault(require("globby")),path=require("path"),iconv=require("iconv-lite");async function onAfterInit(e,a,t){var s,r=e.packages.wechatprogram;e.server&&!e.server.endsWith("/")&&(e.server+="/"),Object.assign(e.buildEngineParam,{platform:"WECHAT_MINI_PROGRAM",sourceMaps:e.sourceMaps,split:!0,skip:!1}),e.buildEngineParam.assetURLFormat="relative-from-out",e.useSplashScreen&&(s=await Editor.Profile.getProject("builder","splash-setting.logo.image"))&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(s))&&console.error("The splash screen image is too large for wechatprogram!"),a.staticsInfo.B100011=r.orientation,a.staticsInfo.B100013=r.appid,share_1.Paths.internalTemplateDir=(0,path_1.join)(e.engineInfo.typescript.path,"templates/wechatprogram")}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0,e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"}}function validRatio(s){return new Promise((e,a)=>{const t=new Image;t.src="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(s).toString("base64"),t.onload=function(){(2048<t.width||2048<t.height)&&e(!1),e(!0)},t.onerror=function(e){a(e)}})}async function onAfterBundleBuildTask(e,a,t){await sortSubPackage(a)}async function onBeforeCompressSettings(e,a,t){a.paths.dir&&(a.settings.scripting.scriptPackages=a.scriptPackages.map(e=>"project://"+(0,path_1.relative)(a.paths.dir,e).replace(/\\/g,"/")))}async function onBeforeCopyBuildTemplate(e,a,t,s){var r=e.engineInfo.typescript.path;for(const i of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/wechat",`${i}.${e.debug?"":"min."}js`),(0,path_1.join)(a.paths.dir,i+".js"));await _buildWeChatTemplate.call(this,e,a),await postHandleScript(e,a,t)}async function onAfterCopyBuildTemplate(e,a){await buildGameJson(a.paths.dir,e,this.bundleManager.bundles,this.buildTemplate.findFile("game.json")),buildProjectConfig(a.paths.dir,e,this.buildTemplate.findFile("project.config.json"))}async function postHandleScript(a,s,e){const r=a.debug?"\n":"";let i="var GameGlobal = getApp().GameGlobal, window = global = globalThis = getApp().GameGlobal, WebAssembly = WXWebAssembly;"+r;["__globalAdapter","cc","System","document","HTMLElement","HTMLImageElement","HTMLCanvasElement","performance","Image","ImageBitmap","fsUtils","XMLHttpRequest","WebSocket"].forEach(e=>{i+=`var ${e} = GameGlobal.${e};`+r}),i=(i=(i+="var DOMParser = globalThis.DOMParser = GameGlobal.DOMParser;"+r)+"var requestAnimationFrame = GameGlobal.canvas.requestAnimationFrame;"+r)+"var cancelAnimationFrame = GameGlobal.canvas.cancelAnimationFrame;"+r;a=a.packages.wechatprogram.globalVariable;a&&a.split(",").map(e=>e.trim()).forEach(e=>{i+=`var ${e} = globalThis.${e};`+r});const t=s.paths.dir;(await(0,globby_1.default)(["engine-adapter.js","web-adapter.js","assets/**/index.js","src/assets/**/*.js","src/chunks/*.js","src/bundle-scripts/**/index.js","!src/chunks/bundle.js"],{cwd:t})).map(e=>path.resolve(t,e)).forEach(e=>{var a=(0,fs_extra_1.readFileSync)(e,"utf8"),a=i+a;(0,fs_extra_1.writeFileSync)(e,a,"utf8")});var a="const global = getApp().GameGlobal;"+r,n=(0,path_1.join)(s.paths.dir,"src/system.bundle.js"),a=a+(0,fs_extra_1.readFileSync)(n,"utf8");(0,fs_extra_1.writeFileSync)(n,a,"utf8");n=(await(0,globby_1.default)(["cocos-js/*.js"],{cwd:t})).map(e=>path.resolve(t,e));const o=/System\.register\((\[.*?\].*?\{)/g;n.forEach(e=>{var a=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");let t=(0,fs_extra_1.readFileSync)(e,"utf8");o.test(t)&&(console.log("register:"+a),t=t.replace(o,`getApp().GameGlobal.System.register('no-schema:/${a}', $1`+r+i),(0,fs_extra_1.writeFileSync)(e,t,"utf8"))});let p="";n.forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");p+=`    .then(()=>require.async('subpackages/cocos-js/${(0,path_1.basename)(e,".js")}/index.js'))
`});(await(0,globby_1.default)(["src/chunks/*.js"],{cwd:t})).map(e=>path.resolve(t,e)).forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");p+=`    .then(()=>require.async('./${e}'))
`});p="export function loadModules() {\n    return Promise.resolve()\n"+p+"}",(0,fs_extra_1.outputFileSync)((0,path_1.join)(s.paths.dir,"load-module.js"),p,{encoding:"utf8"});const l=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s.paths.dir,"app.json"));n.forEach(e=>{e=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/");l.subPackages.push({root:"subpackages/cocos-js/"+(0,path_1.basename)(e,".js"),pages:["index"]})});a=(0,path_1.join)(s.paths.dir,"app.json"),(0,fs_extra_1.outputJSONSync)(a,l,{spaces:4}),n.forEach(e=>{var a=(0,path_1.relative)(s.paths.dir,e).replace(/\\/g,"/"),t=a.substring(0,a.indexOf(".")),t=((0,fs_extra_1.ensureDirSync)((0,path_1.join)(s.paths.dir,"subpackages/"+t)),(0,path_1.join)(s.paths.dir,`subpackages/${t}/index.js`));(0,fs_extra_1.moveSync)(e,t,{overwrite:!0});e=`console.log('加载 ${a} 分包');
`+(0,fs_extra_1.readFileSync)(t,"utf8");(0,fs_extra_1.writeFileSync)(t,e,"utf8")}),a=(0,path_1.join)(s.paths.dir,"application.js");if((0,fs_extra_1.existsSync)(a)){let e=(0,fs_extra_1.readFileSync)(a,"utf8");o.test(e)&&(e=e.replace(o,'getApp().GameGlobal.System.register("no-schema:/application.js", $1'+r+i)),(0,fs_extra_1.writeFileSync)(a,e,"utf8")}n=(0,path_1.join)(s.paths.dir,"src/chunks/bundle.js");if((0,fs_extra_1.existsSync)(n)){let e=(0,fs_extra_1.readFileSync)(n,"utf8");o.test(e)&&(e=e.replace(o,'getApp().GameGlobal.System.register("project://src/chunks/bundle.js", $1'+r+i)),(0,fs_extra_1.writeFileSync)(n,e,"utf8")}}function sortSubPackage(e){for(const t of e){var a;t.isSubpackage&&(a=(0,path_1.join)((0,path_1.dirname)(t.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(t.scriptDest)?(0,fs_extra_1.renameSync)(t.scriptDest,a):(0,fs_extra_1.outputFileSync)(a,`console.log('${name}: no script in subPackage.')`,"utf8"),t.scriptDest=a)}}async function _buildWeChatTemplate(e,t){var a,s,r;this.buildTemplate.findFile("game.js")||(a=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(share_1.Paths.internalTemplateDir,"game.ejs"),s=t.settings.engine.macros?.ENABLE_TRANSPARENT_CANVAS,r=t.settings.engine.macros?.ENABLE_WEBGL_ANTIALIAS,s={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(share_1.Paths.internalTemplateDir,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===s?"default":s,antialias:void 0===r?"default":r,useWebgl2:e.buildEngineParam.includeModules.includes("gfx-webgl2")},r=await ejs_1.default.renderFile(a,s),(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),r,"utf8"),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"game.js"))),(await(0,globby_1.default)(["*","!splash.png","!first-screen.js"],{cwd:share_1.Paths.internalTemplateDir})).map(e=>path.resolve(share_1.Paths.internalTemplateDir,e)).forEach(e=>{var a;(0,fs_extra_1.statSync)(e).isFile()&&(a=(0,path_1.relative)(share_1.Paths.internalTemplateDir,e),e=(0,fs_extra_1.readFileSync)(e,"utf8"),(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),e,{encoding:"utf8"}))}),this.buildTemplate.findFile("splash.png")||(0,fs_extra_1.copyFileSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"splash.png"),(0,path_1.join)(t.paths.dir,"splash.png")),this.buildTemplate.findFile("first-screen.js")&&(0,fs_extra_1.copyFileSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"first-screen.js"),(0,path_1.join)(t.paths.dir,"first-screen.js")),(0,fs_extra_1.copyFileSync)((0,path_1.join)(t.paths.dir,"game.js"),(0,path_1.join)(t.paths.dir,"index.js")),e.md5CacheOptions.replaceOnly.push((0,path_1.join)(t.paths.dir,"index.js"))}function buildProjectConfig(e,a,t){var s=a.packages.wechatprogram,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"project.config.json")),t=(t&&(t=(0,fs_extra_1.readJSONSync)(t),Object.assign(r,t)),r.appid=s.appid||"wx2c815291f1aa4d1c",r.projectname=a.name,a.server&&a.useBuiltinServer&&(r.packOptions={ignore:[{type:"folder",value:"remote"}]}),(0,path_1.join)(e,"project.config.json"));a.md5CacheOptions.excludes.push(t),(0,fs_extra_1.outputJSONSync)(t,r)}async function buildGameJson(e,a,t,s){var a=a.packages.wechatprogram,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"game.json")),i=(s&&(s=(0,fs_extra_1.readJSONSync)(s),Object.assign(r,s)),r.deviceOrientation=a.orientation,[]);for(const n of t)n.isSubpackage&&i.push({name:n.name,root:`subpackages/${n.name}/`});0<i.length&&(r.subpackages=i);s=(0,path_1.join)(e,"game.json"),(0,fs_extra_1.outputJSONSync)(s,r,{spaces:4}),t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(share_1.Paths.internalTemplateDir,"app.json")),t.window.pageOrientation=a.orientation,s=(0,path_1.join)(e,"app.json");(0,fs_extra_1.outputJSONSync)(s,t,{spaces:4})}async function run(e,a){var t=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im),t=(t&&console.warn(Editor.I18n.t("wechatprogram.tips.build_path_contains_symbol",{symbol:t[1]})),await Editor.Message.request("program","query-program-info","wechatDevtools"));let s=t?t.path:"";if(!s||!(0,fs_extra_1.existsSync)(s))return console.warn(""+Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty",{wechatprogramPath:s})),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1;(0,fs_extra_1.statSync)(s).isDirectory()||"win32"!==process.platform||(s=(0,path_1.dirname)(s));let r;if("darwin"===process.platform?(r=(0,path_1.join)(s,"Contents/Resources/app.nw/bin/cli"),(0,fs_extra_1.existsSync)(r)||(r=(0,path_1.join)(s,"Contents/MacOS/cli"))):r=(0,path_1.join)(s,"cli.bat"),!(0,fs_extra_1.existsSync)(r))return await Editor.Dialog.error(Editor.I18n.t("wechatprogram.options.client_path_error")),!1;t=["-o",e,"-f","cocos"],console.log("Run command : "+t.join(" ")),e=(0,child_process_1.spawn)(r,t);e&&e.stdout&&e.stdout.on("data",function(e){console.log("[WeChat Dev Tool] "+iconv.decode(e,"utf8").toString())}),e&&e.stderr&&e.stderr.on("data",function(e){console.error("[WeChat Dev Tool]"+iconv.decode(e,"utf8").toString())})}exports.throwError=!0;