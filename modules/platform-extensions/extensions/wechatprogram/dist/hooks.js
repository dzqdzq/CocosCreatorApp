"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterBundleBuildTask=exports.onBeforeBundleInit=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),fs_1=require("fs"),child_process_1=require("child_process"),glob=require("globby"),globby=require("globby"),path=require("path"),iconv=require("iconv-lite"),userTemplateDir=(0,path_1.join)(Build.buildTemplateDir,"wechatprogram");async function onAfterInit(e,t,a){const s=e.packages.wechatprogram;if(e.server&&!e.server.endsWith("/")&&(e.server+="/"),"js"===s.wasm)s.wasm=!1;else if("wasm"===s.wasm){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t?(e.includeModules.splice(t,1,"physics-ammo"),s.wasm=!0):s.wasm=!1}if(Object.assign(e.buildEngineParam,{platform:"WECHAT_MINI_PROGRAM",sourceMaps:e.sourceMaps,split:!0,skip:!1,ammoJsWasm:s.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out",e.useSplashScreen){const e=await Editor.Profile.getProject("builder","splash-setting.logo.image");e&&!await validRatio(Editor.UI.__protected__.File.resolveToRaw(e))&&console.error("The splash screen image is too large for wechatprogram!")}t.staticsInfo.B100011=s.orientation,t.staticsInfo.B100013=s.appid}function onBeforeBundleInit(e){e.moveRemoteBundleScript=!0;const t=e.packages.wechatprogram;-1!==e.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==t.enabelWebGL2&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.polyfills&&(e.polyfills.asyncFunctions=!1),e.buildScriptParam.platform="WECHAT_MINI_PROGRAM",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.assetSerializeOptions.exportCCON=!0}function validRatio(e){return new Promise((t,a)=>{const s=new Image;s.src=`data:image/png;base64,${(0,fs_extra_1.readFileSync)(e).toString("base64")}`,s.onload=function(){(s.width>2048||s.height>2048)&&t(!1),t(!0)},s.onerror=function(e){a(e)}})}async function onAfterBundleBuildTask(e,t,a){await sortSubPackage(t)}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")}`))}async function onAfterBuild(e,t,a,s){const r=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=(0,path_1.join)(r,"templates/wechatprogram");await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/wechat",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(r,"bin/adapter/minigame/wechat",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js")),(0,fs_extra_1.existsSync)(userTemplateDir)&&copyUserTemplates(e,t,i,userTemplateDir),await _buildWeChatTemplate(e,t,this.bundleManager.bundles,i),await postHandleScript(e,t,a)}async function postHandleScript(e,t,a){const s=e.debug?"\n":"";let r=`var GameGlobal = getApp().GameGlobal, window = global = globalThis = getApp().GameGlobal, WebAssembly = WXWebAssembly;${s}`;["__globalAdapter","cc","System","document","HTMLElement","HTMLImageElement","HTMLCanvasElement","performance","Image","ImageBitmap","fsUtils","XMLHttpRequest","WebSocket"].forEach(e=>{r+=`var ${e} = GameGlobal.${e};${s}`}),r+=`var DOMParser = globalThis.DOMParser = GameGlobal.DOMParser;${s}`,r+=`var requestAnimationFrame = GameGlobal.canvas.requestAnimationFrame;${s}`,r+=`var cancelAnimationFrame = GameGlobal.canvas.cancelAnimationFrame;${s}`;const i=e.packages.wechatprogram.globalVariable;(0,path_1.join)(t.paths.dir,"app.js");if(i){i.split(",").map(e=>e.trim()).forEach(e=>{r+=`var ${e} = globalThis.${e};${s}`})}const n=t.paths.dir;(await globby(["engine-adapter.js","web-adapter.js","assets/**/index.js","src/assets/**/*.js","src/chunks/*.js","src/bundle-scripts/**/index.js","!src/chunks/bundle.js"],{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{let t=(0,fs_extra_1.readFileSync)(e,"utf8");t=r+t,(0,fs_extra_1.writeFileSync)(e,t,"utf8")});const o=`const global = getApp().GameGlobal;${s}`,p=(0,path_1.join)(t.paths.dir,"src/system.bundle.js");let c=(0,fs_extra_1.readFileSync)(p,"utf8");c=o+c,(0,fs_extra_1.writeFileSync)(p,c,"utf8");const l=(await globby(["cocos-js/*.js"],{cwd:n})).map(e=>path.resolve(n,e)),d=/System\.register\((\[.*?\].*?\{)/g;l.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");let i=(0,fs_extra_1.readFileSync)(e,"utf8");d.test(i)&&(console.log("register:"+a),i=i.replace(d,`getApp().GameGlobal.System.register('no-schema:/${a}', $1${s}${r}`),(0,fs_extra_1.writeFileSync)(e,i,"utf8"))});let u="";l.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");u+=`    .then(()=>require.async('subpackages/cocos-js/${(0,path_1.basename)(a,".js")}/index.js'))\n`}),(await globby(["src/chunks/*.js"],{cwd:n})).map(e=>path.resolve(n,e)).forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");u+=`    .then(()=>require.async('./${a}'))\n`});u="export function loadModules() {\n    return Promise.resolve()\n"+u+"}",(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,"load-module.js"),u,{encoding:"utf8"});const _=(0,fs_extra_1.readJSONSync)((0,path_1.join)(t.paths.dir,"app.json"));l.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");_.subPackages.push({root:`subpackages/cocos-js/${(0,path_1.basename)(a,".js")}`,pages:["index"]})});const f=(0,path_1.join)(t.paths.dir,"app.json");(0,fs_extra_1.outputJSONSync)(f,_,{spaces:4}),l.forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/"),s=a.substring(0,a.indexOf("."));(0,fs_extra_1.ensureDirSync)((0,path_1.join)(t.paths.dir,`subpackages/${s}`));const r=(0,path_1.join)(t.paths.dir,`subpackages/${s}/index.js`);(0,fs_extra_1.moveSync)(e,r,{overwrite:!0});let i=(0,fs_extra_1.readFileSync)(r,"utf8");i=`console.log('加载 ${a} 分包');\n`+i,(0,fs_extra_1.writeFileSync)(r,i,"utf8")});const h=(0,path_1.join)(t.paths.dir,"application.js");if((0,fs_extra_1.existsSync)(h)){let e=(0,fs_extra_1.readFileSync)(h,"utf8");d.test(e)&&(e=e.replace(d,`getApp().GameGlobal.System.register("no-schema:/application.js", $1${s}${r}`)),(0,fs_extra_1.writeFileSync)(h,e,"utf8")}const m=(0,path_1.join)(t.paths.dir,"src/chunks/bundle.js");if((0,fs_extra_1.existsSync)(m)){let e=(0,fs_extra_1.readFileSync)(m,"utf8");d.test(e)&&(e=e.replace(d,`getApp().GameGlobal.System.register("project://src/chunks/bundle.js", $1${s}${r}`)),(0,fs_extra_1.writeFileSync)(m,e,"utf8")}}function sortSubPackage(e){for(const t of e){if(!t.isSubpackage)continue;const e=(0,path_1.join)((0,path_1.dirname)(t.scriptDest),"game.js");(0,fs_extra_1.existsSync)(t.scriptDest)?(0,fs_extra_1.renameSync)(t.scriptDest,e):(0,fs_extra_1.outputFileSync)(e,`console.log('${name}: no script in subPackage.')`,"utf8"),t.scriptDest=e}}function readAllFilesDeep(e){if(!(0,fs_extra_1.statSync)(e).isDirectory())return[e];const t=(0,fs_1.readdirSync)(e),a=[];for(const s of t){const t=(0,path_1.join)(e,s),r=readAllFilesDeep(t);r.length?a.push(...r):a.push(t)}return a}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],r=Math.max(a.length,s.length);for(let e=0;e<r;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a,s){var r,i;let n=!0;if(!(0,fs_extra_1.existsSync)((0,path_1.join)(userTemplateDir,"game.js"))){let a=(0,path_1.join)(Build.buildTemplateDir,e.platform,"game.ejs");(0,fs_extra_1.existsSync)(a)||(a=(0,path_1.join)(s,"game.ejs"),n=!1);const o=null===(r=t.settings.engine.macros)||void 0===r?void 0:r.ENABLE_TRANSPARENT_CANVAS,p=null===(i=t.settings.engine.macros)||void 0===i?void 0:i.ENABLE_WEBGL_ANTIALIAS,c={engineName:e.buildEngineParam.engineName,cocosTemplate:(0,path_1.join)(s,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===o?"default":o,antialias:void 0===p?"default":p,useWebgl2:"sameAsProjectSetting"===e.packages.wechatprogram.enabelWebGL2&&-1!==e.includeModules.indexOf("gfx-webgl2")},l=await ejs_1.default.renderFile(a,c);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),l,"utf8")}glob.sync(["*","!splash.png","!first-screen.js"],{cwd:s}).map(e=>path.resolve(s,e)).forEach(e=>{if((0,fs_extra_1.statSync)(e).isFile()){const a=(0,path_1.relative)(s,e),r=(0,fs_extra_1.readFileSync)(e,"utf8");(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),r,{encoding:"utf8"})}}),(0,fs_extra_1.existsSync)((0,path_1.join)(userTemplateDir,"splash.png"))||(0,fs_extra_1.copyFileSync)((0,path_1.join)(s,"splash.png"),(0,path_1.join)(t.paths.dir,"splash.png")),(0,fs_extra_1.existsSync)((0,path_1.join)(userTemplateDir,"first-screen.js"))||(0,fs_extra_1.copyFileSync)((0,path_1.join)(s,"first-screen.js"),(0,path_1.join)(t.paths.dir,"first-screen.js")),(0,fs_extra_1.copyFileSync)((0,path_1.join)(t.paths.dir,"game.js"),(0,path_1.join)(t.paths.dir,"index.js")),n&&(0,fs_extra_1.removeSync)((0,path_1.join)(t.paths.dir,"game.ejs")),await buildGameJson(s,t.paths.dir,e,a),buildProjectConfig(s,t.paths.dir,e)}function copyUserTemplates(e,t,a,s){try{const t=(0,fs_extra_1.readJSONSync)((0,path_1.join)(a,"build-template.json"));if(t.version){const a=(0,path_1.join)(Build.buildTemplateDir,"templates-version.json");let s="";(0,fs_extra_1.existsSync)(a)&&(s=(0,fs_extra_1.readJSONSync)(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("wechatprogram.tips.templateVersionWarning"))}}catch(e){console.debug(e)}(0,fs_extra_1.copySync)(s,t.paths.dir),console.debug(`Use build-template {link(${s})}.`)}function buildProjectConfig(e,t,a){const s=a.packages.wechatprogram,r=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"project.config.json")),i=(0,path_1.join)(userTemplateDir,"project.config.json");if((0,fs_extra_1.existsSync)(i)){const e=(0,fs_extra_1.readJSONSync)(i);Object.assign(r,e)}r.appid=s.appid||"wx2c815291f1aa4d1c",r.projectname=a.name,a.server&&a.useBuiltinServer&&(r.packOptions={ignore:[{type:"folder",value:"remote"}]});const n=(0,path_1.join)(t,"project.config.json");(0,fs_extra_1.outputJSONSync)(n,r)}async function buildGameJson(e,t,a,s){const r=a.packages.wechatprogram,i=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"game.json")),n=(0,path_1.join)(userTemplateDir,"game.json");if((0,fs_extra_1.existsSync)(n)){const e=(0,fs_extra_1.readJSONSync)(n);Object.assign(i,e)}i.deviceOrientation=r.orientation;const o=[];for(const e of s)e.isSubpackage&&o.push({name:e.name,root:`subpackages/${e.name}/`});o.length>0&&(i.subpackages=o);const p=(0,path_1.join)(t,"game.json");(0,fs_extra_1.outputJSONSync)(p,i,{spaces:4});const c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(e,"app.json"));c.window.pageOrientation=r.orientation;const l=(0,path_1.join)(t,"app.json");(0,fs_extra_1.outputJSONSync)(l,c,{spaces:4})}async function run(e,t){const a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);a&&console.warn(Editor.I18n.t("wechatprogram.tips.build_path_contains_symbol",{symbol:a[1]}));const s=await Editor.Message.request("program","query-program-info","wechatDevtools");let r=s?s.path:"";if(!r||!(0,fs_extra_1.existsSync)(r)){return console.warn(`${Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty",{wechatprogramPath:r})}`),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}(0,fs_extra_1.statSync)(r).isDirectory()||"win32"!==process.platform||(r=(0,path_1.dirname)(r));const i={stdio:"pipe"};let n;if("darwin"===process.platform?(n=(0,path_1.join)(r,"Contents/Resources/app.nw/bin/cli"),(0,fs_extra_1.existsSync)(n)||(n=(0,path_1.join)(r,"Contents/MacOS/cli"))):(n=(0,path_1.join)(r,"cli.bat"),i.shell=!0),!(0,fs_extra_1.existsSync)(n))return await Editor.Dialog.error(Editor.I18n.t("wechatprogram.options.client_path_error")),!1;const o=["-o",e,"-f","cocos"];console.log(`Run command : ${o.join(" ")}`);const p=(0,child_process_1.spawn)(n,o);p&&p.stdout&&p.stdout.on("data",function(e){console.log(`[WeChat Dev Tool] ${iconv.decode(e,"utf8").toString()}`)}),p&&p.stderr&&p.stderr.on("data",function(e){console.error(`[WeChat Dev Tool]${iconv.decode(e,"utf8").toString()}`)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBundleBuildTask=onAfterBundleBuildTask,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;