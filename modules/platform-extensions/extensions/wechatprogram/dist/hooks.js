"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),fs_1=require("fs"),child_process_1=require("child_process"),glob=require("globby"),globby=require("globby"),iconv=require("iconv-lite"),userTemplateDir=path_1.join(Build.buildTemplateDir,"wechatprogram");async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1);const s=e.packages.wechatprogram;if(-1!==e.includeModules.indexOf("gfx-webgl2")&&"sameAsProjectSetting"!==s.enabelWebGL2&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.moveRemoteBundleScript=!0,e.assetSerializeOptions.exportCCON=!0,"js"===s.wasm)s.wasm=!1;else if("wasm"===s.wasm){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t?(e.includeModules.splice(t,1,"physics-ammo"),s.wasm=!0):s.wasm=!1}if(Object.assign(e.buildEngineParam,{platform:"WECHAT_MINI_PROGRAM",sourceMaps:e.sourceMaps,split:!0,skip:!1,ammoJsWasm:s.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.useSplashScreen){const e=await Editor.Profile.getProject("builder","splash-setting.url");e&&!await validRatio(Editor.UI.File.resolveToRaw(e))&&console.error("The splash screen image is too large!")}const r={orientation:s.orientation,appid:s.appid};a.__addStaticsInfo(r),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir)}function validRatio(e){return new Promise((t,a)=>{const s=new Image;s.src=`data:image/png;base64,${fs_extra_1.readFileSync(e).toString("base64")}`,s.onload=function(){(s.width>2048||s.height>2048)&&t(!1),t(!0)},s.onerror=function(e){a(e)}})}async function onBeforeCompressSettings(e,t,a){t.paths.dir&&(t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${path_1.relative(t.paths.dir,e).replace(/\\/g,"/")}`),sortSubPackage(e,t,a))}async function onAfterBuild(e,t,a,s){const r=(await Editor.Message.request("engine","query-engine-info")).typescript.path,i=path_1.join(r,"templates/wechatprogram");await fs_extra_1.copy(path_1.join(r,"bin/adapter/minigame/wechat",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(r,"bin/adapter/minigame/wechat",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js")),fs_extra_1.existsSync(userTemplateDir)&&copyUserTemplates(e,t,i,userTemplateDir),await _buildWeChatTemplate(e,t,s,i),await postHandleScript(e,t,a)}async function postHandleScript(e,t,a){const s=e.debug?"\n":"";let r=`var GameGlobal = getApp().GameGlobal, window = global = globalThis = getApp().GameGlobal, WebAssembly = WXWebAssembly;${s}`;["__globalAdapter","cc","System","document","HTMLElement","HTMLImageElement","HTMLCanvasElement","performance","Image","ImageBitmap","fsUtils","XMLHttpRequest","WebSocket"].forEach(e=>{r+=`var ${e} = GameGlobal.${e};${s}`}),r+=`var DOMParser = globalThis.DOMParser = GameGlobal.DOMParser;${s}`,r+=`var requestAnimationFrame = GameGlobal.canvas.requestAnimationFrame;${s}`,r+=`var cancelAnimationFrame = GameGlobal.canvas.cancelAnimationFrame;${s}`;const i=e.packages.wechatprogram.globalVariable;path_1.join(t.paths.dir,"app.js");if(i){i.split(",").map(e=>e.trim()).forEach(e=>{r+=`var ${e} = globalThis.${e};${s}`})}(await globby([path_1.join(t.paths.dir,"engine-adapter.js"),path_1.join(t.paths.dir,"web-adapter.js"),path_1.join(t.paths.dir,"assets/**/index.js"),path_1.join(t.paths.dir,"src/assets/**/*.js"),path_1.join(t.paths.dir,"src/chunks/*.js"),path_1.join(t.paths.dir,"src/bundle-scripts/**/index.js"),`!${path_1.join(t.paths.dir,"src/chunks/bundle.js")}`])).forEach(e=>{let t=fs_extra_1.readFileSync(e,"utf8");t=r+t,fs_extra_1.writeFileSync(e,t,"utf8")});const n=`const global = getApp().GameGlobal;${s}`,o=path_1.join(t.paths.dir,"src/system.bundle.js");let p=fs_extra_1.readFileSync(o,"utf8");p=n+p,fs_extra_1.writeFileSync(o,p,"utf8");const c=await globby([path_1.join(t.paths.dir,"cocos-js/*.js")]),l=/System\.register\((\[.*?\].*?\{)/g;c.forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/");let i=fs_extra_1.readFileSync(e,"utf8");l.test(i)&&(console.log("register:"+a),i=i.replace(l,`getApp().GameGlobal.System.register('no-schema:/${a}', $1${s}${r}`),fs_extra_1.writeFileSync(e,i,"utf8"))});let _="";c.forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/");_+=`    .then(()=>require.async('subpackages/cocos-js/${path_1.basename(a,".js")}/index.js'))\n`}),(await globby([path_1.join(t.paths.dir,"src/chunks/*.js")])).forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/");_+=`    .then(()=>require.async('./${a}'))\n`});_="export function loadModules() {\n    return Promise.resolve()\n"+_+"}",fs_extra_1.outputFileSync(path_1.join(t.paths.dir,"load-module.js"),_,{encoding:"utf8"});const d=fs_extra_1.readJSONSync(path_1.join(t.paths.dir,"app.json"));c.forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/");d.subPackages.push({root:`subpackages/cocos-js/${path_1.basename(a,".js")}`,pages:["index"]})});const h=path_1.join(t.paths.dir,"app.json");fs_extra_1.outputJSONSync(h,d,{spaces:4}),c.forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/"),s=a.substring(0,a.indexOf("."));fs_extra_1.ensureDirSync(path_1.join(t.paths.dir,`subpackages/${s}`));const r=path_1.join(t.paths.dir,`subpackages/${s}/index.js`);fs_extra_1.moveSync(e,r,{overwrite:!0});let i=fs_extra_1.readFileSync(r,"utf8");i=`console.log('加载 ${a} 分包');\n`+i,fs_extra_1.writeFileSync(r,i,"utf8")});const u=path_1.join(t.paths.dir,"application.js");if(fs_extra_1.existsSync(u)){let e=fs_extra_1.readFileSync(u,"utf8");l.test(e)&&(e=e.replace(l,`getApp().GameGlobal.System.register("no-schema:/application.js", $1${s}${r}`)),fs_extra_1.writeFileSync(u,e,"utf8")}const f=path_1.join(t.paths.dir,"src/chunks/bundle.js");if(fs_extra_1.existsSync(f)){let e=fs_extra_1.readFileSync(f,"utf8");l.test(e)&&(e=e.replace(l,`getApp().GameGlobal.System.register("project://src/chunks/bundle.js", $1${s}${r}`)),fs_extra_1.writeFileSync(f,e,"utf8")}}function sortSubPackage(e,t,a){for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t}}function readAllFilesDeep(e){if(!fs_extra_1.statSync(e).isDirectory())return[e];const t=fs_1.readdirSync(e),a=[];for(const s of t){const t=path_1.join(e,s),r=readAllFilesDeep(t);r.length?a.push(...r):a.push(t)}return a}function compareBuildTemplateVersion(e,t){if(!t)return"1.0.0"!==e;const[a,s]=[e.split("."),t.split(".")],r=Math.max(a.length,s.length);for(let e=0;e<r;e++)if(parseInt(a[e])>parseInt(s[e]))return!0;return!1}async function _buildWeChatTemplate(e,t,a,s){var r,i;let n=!0;if(!fs_extra_1.existsSync(path_1.join(userTemplateDir,"game.js"))){let a=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs");fs_extra_1.existsSync(a)||(a=path_1.join(s,"game.ejs"),n=!1);const o=null===(r=t.settings.engine.macros)||void 0===r?void 0:r.ENABLE_TRANSPARENT_CANVAS,p=null===(i=t.settings.engine.macros)||void 0===i?void 0:i.ENABLE_WEBGL_ANTIALIAS,c={engineName:e.buildEngineParam.engineName,cocosTemplate:path_1.join(s,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir),alpha:void 0===o?"default":o,antialias:void 0===p?"default":p,useWebgl2:"sameAsProjectSetting"===e.packages.wechatprogram.enabelWebGL2&&-1!==e.includeModules.indexOf("gfx-webgl2")},l=await ejs_1.default.renderFile(a,c);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),l,"utf8")}glob.sync([path_1.join(s,"*"),`!${path_1.join(s,"splash.png")}`,`!${path_1.join(s,"first-screen.js")}`]).forEach(e=>{if(fs_extra_1.statSync(e).isFile()){const a=path_1.relative(s,e),r=fs_extra_1.readFileSync(e,"utf8");fs_extra_1.outputFileSync(path_1.join(t.paths.dir,a),r,{encoding:"utf8"})}}),fs_extra_1.existsSync(path_1.join(userTemplateDir,"splash.png"))||fs_extra_1.copyFileSync(path_1.join(s,"splash.png"),path_1.join(t.paths.dir,"splash.png")),fs_extra_1.existsSync(path_1.join(userTemplateDir,"first-screen.js"))||fs_extra_1.copyFileSync(path_1.join(s,"first-screen.js"),path_1.join(t.paths.dir,"first-screen.js")),fs_extra_1.copyFileSync(path_1.join(t.paths.dir,"game.js"),path_1.join(t.paths.dir,"index.js")),n&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),await buildGameJson(s,t.paths.dir,e,t),buildProjectConfig(s,t.paths.dir,e)}function copyUserTemplates(e,t,a,s){try{const t=fs_extra_1.readJSONSync(path_1.join(a,"build-template.json"));if(t.version){const a=path_1.join(Build.buildTemplateDir,"templates-version.json");let s="";fs_extra_1.existsSync(a)&&(s=fs_extra_1.readJSONSync(a)[e.platform]),compareBuildTemplateVersion(t.version,s)&&console.warn(Editor.I18n.t("wechatprogram.tips.templateVersionWarning"))}}catch(e){console.debug(e)}fs_extra_1.copySync(s,t.paths.dir),console.debug(`Use build-template {link(${s})}.`)}function buildProjectConfig(e,t,a){const s=a.packages.wechatprogram,r=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));r.appid=s.appid||"wx2c815291f1aa4d1c",r.projectname=a.name,a.server&&a.useBuiltinServer&&(r.packOptions={ignore:[{type:"folder",value:"remote"}]});const i=path_1.join(userTemplateDir,"project.config.json");if(fs_extra_1.existsSync(i)){const e=fs_extra_1.readJSONSync(i);Object.assign(r,e)}const n=path_1.join(t,"project.config.json");fs_extra_1.outputJSONSync(n,r)}async function buildGameJson(e,t,a,s){const r=a.packages.wechatprogram,i=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));i.deviceOrientation=r.orientation;const n=[];for(const e of s.bundles)e.isSubpackage&&n.push({name:e.name,root:`subpackages/${e.name}/`});n.length>0&&(i.subpackages=n);const o=path_1.join(userTemplateDir,"game.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(i,e)}const p=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(p,i,{spaces:4});const c=fs_extra_1.readJSONSync(path_1.join(e,"app.json"));c.window.pageOrientation=r.orientation;const l=path_1.join(t,"app.json");fs_extra_1.outputJSONSync(l,c,{spaces:4})}async function run(e,t){const a=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);a&&console.warn(Editor.I18n.t("wechatprogram.tips.build_path_contains_symbol",{symbol:a[1]}));const s=await Editor.Message.request("program","query-program-info","wechatDevtools");let r=s?s.path:"";if(!r||!fs_extra_1.existsSync(r)){return console.warn(`${Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty",{wechatprogramPath:r})}`),1===(await Editor.Dialog.warn(Editor.I18n.t("wechatprogram.tips.wechatprogram_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}fs_extra_1.statSync(r).isDirectory()||"win32"!==process.platform||(r=path_1.dirname(r));const i={stdio:"pipe"};let n;if("darwin"===process.platform?(n=path_1.join(r,"Contents/Resources/app.nw/bin/cli"),fs_extra_1.existsSync(n)||(n=path_1.join(r,"Contents/MacOS/cli"))):(n=path_1.join(r,"cli.bat"),i.shell=!0),!fs_extra_1.existsSync(n))return await Editor.Dialog.error(Editor.I18n.t("wechatprogram.options.client_path_error")),!1;const o=["-o",e,"-f","cocos"];console.log(`Run command : ${o.join(" ")}`);const p=child_process_1.spawn(n,o);p&&p.stdout&&p.stdout.on("data",function(e){console.log(`[WeChat Dev Tool] ${iconv.decode(e,"utf8").toString()}`)}),p&&p.stderr&&p.stderr.on("data",function(e){console.error(`[WeChat Dev Tool]${iconv.decode(e,"utf8").toString()}`)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.run=run;