"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),index_1=require("@cocos/build-engine/dist/index"),ccBuild=__importStar(require("@cocos/build-engine")),enumerate_dependent_chunks_js_1=require("@cocos/build-engine/dist/enumerate-dependent-chunks.js"),separate_engine_1=require("./separate-engine"),stats_query_1=require("@cocos/build-engine/dist/stats-query"),globby=require("globby");async function onAfterInit(e,t,a){e.polyfills&&(e.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-mini-game",value:{orientation:e.packages["taobao-mini-game"].deviceOrientation}}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.moveRemoteBundleScript=!0,Object.assign(e.buildEngineParam,{platform:"TAOBAO_MINIGAME"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildEngineParam.split=!0;const i=e.includeModules.indexOf("gfx-webgl2");-1!==i&&(e.includeModules.splice(i,1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0;const n=e.packages["taobao-mini-game"];if(/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){n.separateEngine&&e.debug&&console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?n.separateEngine=n.separateEngine&&!e.debug:console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_only_in_normal_version"));Object.assign(e.buildEngineParam,{sourceMaps:!n.separateEngine&&e.sourceMaps,skip:n.separateEngine});const s={orientation:e.packages["taobao-mini-game"].deviceOrientation,remoteServerAddress:e.server};a.__addStaticsInfo(s)}async function onBeforeCompressSettings(e,t,a){t.settings.screen.orientation=e.packages["taobao-mini-game"].deviceOrientation,e.packages["taobao-mini-game"].separateEngine&&await buildSeparateEngine(e,t),t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${path_1.relative(t.paths.dir,e).replace(/\\/g,"/")}`)}async function onAfterBuild(e,t,a){if(!t.paths.dir)return;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,n=path_1.join(i,"templates/taobao-mini-game");await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/taobao-mini-game",`web-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/taobao-mini-game",`engine-adapter.${e.debug?"":"min."}js`),path_1.join(t.paths.dir,"engine-adapter.js"));const s={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},r=await ejs_1.default.renderFile(path_1.join(n,"game.ejs"),s);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),r);const o=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(o)&&(fs_extra_1.copySync(o,t.paths.dir),console.debug(`Use build-template {link(${o})}.`)),["mini.project.json","game.json"].forEach(async a=>{const i=fs_extra_1.readJSONSync(path_1.join(n,a));if("game.json"===a){if(e.packages["taobao-mini-game"].separateEngine){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.join(e,"templates/taobao-mini-game"),a=path_1.join(t,"patch.json");let n=Editor.App.version;fs_extra_1.existsSync(a)&&(n=await Editor.Profile.getConfig("taobao-mini-game","plugin-version")||Editor.App.version),i.plugins={cocos:{pluginVersion:n,pluginId:require(path_1.join(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}i.deviceOrientation=e.packages["taobao-mini-game"].deviceOrientation;const a=[];for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,a.push({name:e.name,root:`subpackages/${e.name}/`})}a.length>0&&(i.subpackages=a)}const s=path_1.join(o,a);if(fs_extra_1.existsSync(s)){const e=fs_extra_1.readJSONSync(s);Object.assign(i,e)}const r=path_1.join(t.paths.dir,a);fs_extra_1.writeJSONSync(r,i)}),(await globby([path_1.join(n,"**/*"),`!${path_1.join(n,"build-template.json")}`,`!${path_1.join(n,"mini.project.json")}`,`!${path_1.join(n,"game.json")}`,`!${path_1.join(n,"**/*.ejs")}`])).forEach(e=>{if(fs_extra_1.statSync(e).isFile()){const a=path_1.relative(n,e),i=fs_extra_1.readFileSync(e,"utf8");fs_extra_1.outputFileSync(path_1.join(t.paths.dir,a),i,{encoding:"utf8"})}}),await postHandleScript(e,t,a)}async function postHandleScript(e,t,a){const i=e.debug?"\n":"";let n=`var window = $global, global = $global, globalThis = $global;${i}const self = $global;${i}`;["__globalAdapter","cc","canvas","localStorage","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(e=>{n+=`var ${e} = window.${e};${i}`});let s=n;const r=e.packages["taobao-mini-game"].globalVariable;if(r){r.split(",").map(e=>e.trim()).forEach(e=>{s+=`var ${e} = window.${e};${i}`})}const o=[path_1.join(t.paths.dir,"game.js"),path_1.join(t.paths.dir,"**/system.bundle*.js"),path_1.join(t.paths.dir,"**/polyfills.bundle*.js"),path_1.join(t.paths.dir,"**/import-map*.js"),path_1.join(t.paths.dir,"src/assets/**/*.js")],p=/System\.register\((\[.*?\].*?\{)/g,c=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;(await globby([path_1.join(t.paths.dir,"**/*.js"),...o.map(e=>"!"+e)])).forEach(e=>{const a=path_1.relative(t.paths.dir,e).replace(/\\/g,"/");let r=fs_extra_1.readFileSync(e,"utf8"),o=s;if((a.startsWith("cocos/")||a.startsWith("cocos-js/"))&&(o=n),p.test(r))r=r.replace(p,`$global.System.register($1${i}${o}`);else{r=c.test(r)?r.replace(c,`$global.System.register($1${i}${o}`):o+r}fs_extra_1.writeFileSync(e,r,"utf8")}),(await globby(o)).forEach(e=>{let t=fs_extra_1.readFileSync(e,"utf8");t=s+t,fs_extra_1.writeFileSync(e,t,"utf8")});const l=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(i),_=path_1.join(t.paths.dir,"game.js");let u=fs_extra_1.readFileSync(_,"utf8");u=l+u,fs_extra_1.writeFileSync(_,u,"utf8");const d=await globby([path_1.join(t.paths.dir,"cocos-js/base*.js")]),g=await globby([path_1.join(t.paths.dir,"cocos-js/physics-ammo*.js"),path_1.join(t.paths.dir,"cocos-js/physics-cannon*.js"),path_1.join(t.paths.dir,"cocos-js/physics-framework*.js"),path_1.join(t.paths.dir,"cocos-js/physics-builtin*.js")]);1===d.length&&g.forEach(e=>{const t=d[0].lastIndexOf("/");if(-1!==t){const a=d[0].substring(t+1);let i=fs_extra_1.readFileSync(e,"utf8");i=i.replace(/base.js/,a),fs_extra_1.writeFileSync(e,i,"utf8")}})}async function buildSeparateEngine(e,t){var a;fs_extra_1.ensureDirSync(t.paths.engineDir),await separate_engine_1.buildCocos(!Editor.App.dev);const i=e.buildEngineParam.includeModules,n=await stats_query_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),s=n.getUnitsOfFeatures(i),r=separate_engine_1.getPluginFeatures(),o=n.getUnitsOfFeatures(r),p=fs_extra_1.readJSONSync(path_1.join(separate_engine_1.separateEnginPaths.outDir,"meta.json")),c=[],l=path_1.join(t.paths.engineDir,"cc.js"),_=await index_1.build.transform(n.evaluateIndexModuleSource(s,e=>o.includes(e)?(c.push(e),`plugin:cocos/${e}.js`):(fs_extra_1.copySync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,`${e}.js`),path_1.join(t.paths.engineDir,`${e}.js`)),`./${e}.js`)),ccBuild.ModuleOption.system);fs_extra_1.writeFileSync(l,_.code,"utf8");const u=enumerate_dependent_chunks_js_1.enumerateDependentChunks(p,r),d=s.filter(e=>!r.includes(e)),g=enumerate_dependent_chunks_js_1.enumerateDependentChunks(p,d),m=new Set(enumerate_dependent_chunks_js_1.enumerateDependentChunks(p,c)),h=null!==(a=t.importMap.imports)&&void 0!==a?a:{},f=e=>e in p.chunkAliases,j=e=>{var t;return null!==(t=p.chunkAliases[e])&&void 0!==t?t:e};g.forEach(e=>{u.includes(e)?(e=>{const a=j(e);m.add(a);const i=f(e)?e:`../${path_1.basename(t.paths.engineDir)}/${a}`,n=`plugin:cocos/${a}`;h[i]=n})(e):(e=>{const a=j(e),i=path_1.join(t.paths.engineDir,a);fs_extra_1.ensureDirSync(path_1.dirname(i)),fs_extra_1.copyFileSync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,a),i),f(e)&&(h[e]=`../${path_1.basename(t.paths.engineDir)}/${a}`)})(e)}),h.cc=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/cc.js`,i.includes("physics-ammo")&&(h["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl(path_1.dirname(t.paths.importMap),t.paths.engineDir)}/wait-for-ammo-instantiation.js`),t.importMap.imports=h;const y=path_1.join(t.paths.dir,"cocos");await separate_engine_1.generateCocos(Array.from(m),y)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;