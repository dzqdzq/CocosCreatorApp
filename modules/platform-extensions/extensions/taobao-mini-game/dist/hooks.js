"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),globby=require("globby");async function onAfterInit(t,e,a){t.polyfills&&(t.polyfills.asyncFunctions=!1),Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-mini-game",value:{orientation:t.packages["taobao-mini-game"].deviceOrientation}}),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(e.paths.dir),t.server&&!t.server.endsWith("/")&&(t.server+="/"),t.moveRemoteBundleScript=!0,Object.assign(t.buildEngineParam,{platform:"TAOBAO_MINIGAME"}),t.buildScriptParam.importMapFormat="commonjs",t.buildScriptParam.system={preset:"commonjs-like"},t.buildEngineParam.split=!0;const i=t.includeModules.indexOf("gfx-webgl2");-1!==i&&(t.includeModules.splice(i,1),t.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),t.assetSerializeOptions.exportCCON=!0;const s={orientation:t.packages["taobao-mini-game"].deviceOrientation,remoteServerAddress:t.server};a.__addStaticsInfo(s)}async function onBeforeCompressSettings(t,e,a){e.settings.screen.orientation=t.packages["taobao-mini-game"].deviceOrientation}async function onAfterBuild(t,e,a){if(!e.paths.dir)return;const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=path_1.join(i,"templates/taobao-mini-game");await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/taobao-mini-game",`web-adapter.${t.debug?"":"min."}js`),path_1.join(e.paths.dir,"web-adapter.js")),await fs_extra_1.copy(path_1.join(i,"bin/adapter/minigame/taobao-mini-game",`engine-adapter.${t.debug?"":"min."}js`),path_1.join(e.paths.dir,"engine-adapter.js"));const r={polyfillsBundleFile:e.paths.polyfillsJs&&Build.Utils.relativeUrl(e.paths.dir,e.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(e.paths.dir,e.paths.systemJs),importMapFile:Build.Utils.relativeUrl(e.paths.dir,e.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(e.paths.dir,e.paths.applicationJS)},n=await ejs_1.default.renderFile(path_1.join(s,"game.ejs"),r);fs_extra_1.writeFileSync(path_1.join(e.paths.dir,"game.js"),n);const o=path_1.join(Build.buildTemplateDir,t.platform);fs_extra_1.existsSync(o)&&(fs_extra_1.copySync(o,e.paths.dir),console.debug(`Use build-template {link(${o})}.`)),["mini.project.json","game.json"].forEach(a=>{const i=fs_extra_1.readJSONSync(path_1.join(s,a));if("game.json"===a){i.deviceOrientation=t.packages["taobao-mini-game"].deviceOrientation;const a=[];for(const t of e.bundles){if(!t.isSubpackage)continue;const e=path_1.join(path_1.dirname(t.scriptDest),"game.js");fs_extra_1.existsSync(t.scriptDest)?fs_extra_1.renameSync(t.scriptDest,e):fs_extra_1.outputFileSync(e,`console.log('${name}: no script in subPackage.')`,"utf8"),t.scriptDest=e,a.push({name:t.name,root:`subpackages/${t.name}/`})}a.length>0&&(i.subpackages=a)}const r=path_1.join(o,a);if(fs_extra_1.existsSync(r)){const t=fs_extra_1.readJSONSync(r);Object.assign(i,t)}const n=path_1.join(e.paths.dir,a);fs_extra_1.writeJSONSync(n,i)}),(await globby([path_1.join(s,"**/*"),`!${path_1.join(s,"build-template.json")}`,`!${path_1.join(s,"mini.project.json")}`,`!${path_1.join(s,"game.json")}`,`!${path_1.join(s,"**/*.ejs")}`])).forEach(t=>{if(fs_extra_1.statSync(t).isFile()){const a=path_1.relative(s,t),i=fs_extra_1.readFileSync(t,"utf8");fs_extra_1.outputFileSync(path_1.join(e.paths.dir,a),i,{encoding:"utf8"})}}),await postHandleScript(t,e,a)}async function postHandleScript(t,e,a){const i=t.debug?"\n":"";let s=`var __taobaoRequire = (urlNoSchema) => {\n        require("./" + urlNoSchema);\n    };\n    var window = $global, global = $global, globalThis = $global;${i}const self = $global;${i}`;["__globalAdapter","cc","canvas","localStorage","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(t=>{s+=`var ${t} = window.${t};${i}`});const r=t.packages["taobao-mini-game"].globalVariable;if(r){r.split(",").map(t=>t.trim()).forEach(t=>{s+=`var ${t} = window.${t};${i}`})}const n=[path_1.join(e.paths.dir,"game.js"),path_1.join(e.paths.dir,"**/system.bundle.js"),path_1.join(e.paths.dir,"**/polyfills.bundle.js"),path_1.join(e.paths.dir,"**/import-map.js"),path_1.join(e.paths.dir,"src/assets/**/*.js")],o=/System\.register\((\[.*?\].*?\{)/g,l=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;(await globby([path_1.join(e.paths.dir,"**/*.js"),...n.map(t=>"!"+t)])).forEach(t=>{path_1.relative(e.paths.dir,t).replace(/\\/g,"/");let a=fs_extra_1.readFileSync(t,"utf8");if(o.test(a))a=a.replace(o,`$global.System.register($1${i}${s}`);else{a=l.test(a)?a.replace(l,`$global.System.register($1${i}${s}`):s+a}fs_extra_1.writeFileSync(t,a,"utf8")}),(await globby(n)).forEach(t=>{let e=fs_extra_1.readFileSync(t,"utf8");e=s+e,fs_extra_1.writeFileSync(t,e,"utf8")});const p=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(i),c=path_1.join(e.paths.dir,"game.js");let m=fs_extra_1.readFileSync(c,"utf8");m=p+m,fs_extra_1.writeFileSync(c,m,"utf8");const _=await globby([path_1.join(e.paths.dir,"cocos-js/base*.js")]),f=await globby([path_1.join(e.paths.dir,"cocos-js/physics-ammo*.js"),path_1.join(e.paths.dir,"cocos-js/physics-cannon*.js"),path_1.join(e.paths.dir,"cocos-js/physics-framework*.js"),path_1.join(e.paths.dir,"cocos-js/physics-builtin*.js")]);1===_.length&&f.forEach(t=>{const e=_[0].lastIndexOf("/");if(-1!==e){const a=_[0].substring(e+1);let i=fs_extra_1.readFileSync(t,"utf8");i=i.replace(/base.js/,a),fs_extra_1.writeFileSync(t,i,"utf8")}})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;