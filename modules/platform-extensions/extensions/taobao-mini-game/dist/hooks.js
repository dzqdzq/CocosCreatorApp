"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.throwError=void 0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onBeforeCopyBuildTemplate=onBeforeCopyBuildTemplate,exports.onAfterCopyBuildTemplate=onAfterCopyBuildTemplate,exports.onBeforeBundleInit=onBeforeBundleInit,exports.onAfterBuild=onAfterBuild;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),fast_glob_1=__importDefault(require("fast-glob")),path_2=__importDefault(require("path")),generate_separate_engine_command_1=require("./generate-separate-engine-command");async function onAfterInit(e,a,t){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-mini-game",value:{orientation:e.packages["taobao-mini-game"].deviceOrientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!0;var i=e.packages["taobao-mini-game"];i.separateEngine&&(e.buildEngineParam.separateEngineOptions={useCacheForce:Editor.App.isPackaged,pluginFeatures:"default",pluginName:"cocos",signatureProvider:require("./../static/cocos/signature.json").pluginId,outputLocalPlugin:!0,checkVersionValid:!0},e.buildEngineParam.nativeCodeBundleMode="wasm"),a.staticsInfo.B100012=e.server,a.staticsInfo.B100011=e.packages["taobao-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=i.wasmSubpackage&&!i.separateEngine}async function onBeforeCompressSettings(e,a,t){a.settings.screen.orientation=e.packages["taobao-mini-game"].deviceOrientation,a.settings.scripting.scriptPackages=a.scriptPackages.map(e=>"project://"+(0,path_1.relative)(a.paths.dir,e).replace(/\\/g,"/"))}async function onBeforeCopyBuildTemplate(e,t,a){var i=e.engineInfo.typescript.path;const s=(0,path_1.join)(i,"templates/taobao-mini-game");for(const o of["web-adapter","engine-adapter"])await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/taobao-mini-game",`${o}.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,o+".js"));var r=this.buildTemplate.initUrl("game.ejs")||(0,path_1.join)(s,"game.ejs"),n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},r=await ejs_1.default.renderFile(r,n);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),r),e.md5CacheOptions.replaceOnly.push("game.js"),(await(0,fast_glob_1.default)(["**/*","!build-template.json","!$'mini.project.json'}","!game.json","!**/*.ejs"],{cwd:s})).map(e=>path_2.default.resolve(s,e)).forEach(e=>{var a;(0,fs_extra_1.statSync)(e).isFile()&&(a=(0,path_1.relative)(s,e),e=(0,fs_extra_1.readFileSync)(e,"utf8"),(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),e,{encoding:"utf8"}))})}async function onAfterCopyBuildTemplate(o,l){var e=o.engineInfo.typescript.path;const p=(0,path_1.join)(e,"templates/taobao-mini-game");["mini.project.json","game.json"].forEach(async e=>{var a=this.buildTemplate.findFile(e),a=(0,fs_extra_1.readJSONSync)(a||(0,path_1.join)(p,e));if("game.json"===e){var t=o.packages["taobao-mini-game"];if(t.separateEngine){var i=(0,path_1.join)(p,"patch.json");let e=Editor.App.version;(0,fs_extra_1.existsSync)(i)&&(e=await Editor.Profile.getConfig("utils",Editor.App.version.replace(".","_")+"_plugin-version.taobao-mini-game")||await Editor.Profile.getConfig("taobao-mini-game","plugin-version")),a.plugins={cocos:{pluginVersion:e,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}a.deviceOrientation=o.packages["taobao-mini-game"].deviceOrientation;var s,r=[];for(const n of this.bundleManager.bundles)n.isSubpackage&&(s=(0,path_1.join)((0,path_1.dirname)(n.scriptDest),"game.js"),(0,fs_extra_1.existsSync)(n.scriptDest)?(0,fs_extra_1.renameSync)(n.scriptDest,s):(0,fs_extra_1.outputFileSync)(s,`console.log('${name}: no script in subPackage.')`,"utf8"),n.scriptDest=s,r.push({name:n.name,root:`subpackages/${n.name}/`}));t.wasmSubpackage&&!t.separateEngine&&(i=(0,path_1.join)(l.paths.engineDir,"./assets/"),t=(0,path_1.join)(l.paths.engineDir,"./chunks/"),(0,fs_extra_1.existsSync)(i)&&r.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(t))&&r.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"}),0<r.length&&(a.subpackages=r)}i=(0,path_1.join)(l.paths.dir,e);(0,fs_extra_1.writeJSONSync)(i,a),o.md5CacheOptions.excludes.push(e)})}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"}}async function onAfterBuild(e,a,t){if(e.packages["taobao-mini-game"].separateEngine&&!Editor.App.isPackaged){var i=a.separateEngineResult?.paths;if(!i)throw new Error("Build separate engine failed.");await(0,generate_separate_engine_command_1.changePluginJSON)(i,(0,path_1.join)(a.paths.dir,e.buildEngineParam.separateEngineOptions.pluginName))}await postHandleScript(e,a,t)}async function postHandleScript(e,l,a){const t=l.paths.dir;if(!e.packages["taobao-mini-game"].separateEngine){{const p=l.importMap.imports;var i=await(0,fast_glob_1.default)(["**/*.js"],{cwd:t});const c=/System\.register\((\[.*?\].*?\{)/,m=/System\.register\((.*?,\s*?\[.*?\].*?\{)/;i.map(e=>path_2.default.resolve(t,e)).forEach(r=>{if((0,path_1.relative)(l.paths.dir,r).replace(/\\/g,"/").startsWith("cocos-js/")){let t=(0,fs_extra_1.readFileSync)(r,"utf8"),i=c,s=i.exec(t);if(s||(i=m,s=i.exec(t)),s){let e=s[1],a=!1;for(const o in p){var n=`./${o}.js`;e.includes(n)&&(e=e.replace(n,o),a=!0)}a&&(t=t.replace(i,"System.register("+e),(0,fs_extra_1.writeFileSync)(r,t,"utf8"))}}})}await 0}if(!e.packages["taobao-mini-game"].removeGlobalAdapter){{const n=e.debug?"\n":"";let s=`var window = $global, global = $global, globalThis = $global;${n}const self = $global;`+n;["__globalAdapter","cc","canvas","localStorage","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(e=>{s+=`var ${e} = window.${e};`+n});let r=s;i=e.packages["taobao-mini-game"].globalVariable,i=(i&&i.split(",").map(e=>e.trim()).forEach(e=>{r+=`var ${e} = window.${e};`+n}),["game.js","**/system.bundle*.js","**/polyfills.bundle*.js","**/import-map*.js","src/assets/**/*.js"]),e=await(0,fast_glob_1.default)(["**/*.js",...i.map(e=>"!"+e)],{cwd:t});const o=/System\.register\((\[.*?\].*?\{)/g,g=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;e.map(e=>path_2.default.resolve(t,e)).forEach(e=>{var a=(0,path_1.relative)(l.paths.dir,e).replace(/\\/g,"/");let t=(0,fs_extra_1.readFileSync)(e,"utf8"),i=r;(a.startsWith("cocos/")||a.startsWith("cocos-js/"))&&(i=s);a=o.test(t);t=a?t.replace(o,"$global.System.register($1"+n+i):g.test(t)?t.replace(g,"$global.System.register($1"+n+i):i+t,(0,fs_extra_1.writeFileSync)(e,t,"utf8")});(await(0,fast_glob_1.default)(i,{cwd:t})).map(e=>path_2.default.resolve(t,e)).forEach(e=>{var a=(0,fs_extra_1.readFileSync)(e,"utf8"),a=r+a;(0,fs_extra_1.writeFileSync)(e,a,"utf8")});e=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(n),i=(0,path_1.join)(l.paths.dir,"game.js"),e+=(0,fs_extra_1.readFileSync)(i,"utf8");(0,fs_extra_1.writeFileSync)(i,e,"utf8")}await 0}const s=(await(0,fast_glob_1.default)(["cocos-js/base*.js"],{cwd:t})).map(e=>path_2.default.resolve(t,e));e=(await(0,fast_glob_1.default)(["cocos-js/physics-ammo*.js","cocos-js/physics-cannon*.js","cocos-js/physics-framework*.js","cocos-js/physics-builtin*.js"],{cwd:t})).map(e=>path_2.default.resolve(t,e));1===s.length&&e.forEach(a=>{var t=s[0].replace(/\\/g,"/").lastIndexOf("/");if(-1!==t){t=s[0].substring(t+1);let e=(0,fs_extra_1.readFileSync)(a,"utf8");e=e.replace(/base.js/,t),(0,fs_extra_1.writeFileSync)(a,e,"utf8")}})}exports.throwError=!0;