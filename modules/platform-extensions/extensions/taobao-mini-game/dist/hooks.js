"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onBeforeBundleInit=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),separate_engine_1=require("./separate-engine"),ccbuild_1=require("@cocos/ccbuild"),globby=require("globby"),path=require("path");async function onAfterInit(e,t,a){Editor.Metrics.trackEvent({category:"Project",action:"BetaPlatforms",label:"taobao-mini-game",value:{orientation:e.packages["taobao-mini-game"].deviceOrientation}}),e.server&&!e.server.endsWith("/")&&(e.server+="/"),e.buildEngineParam.split=!0;const i=e.includeModules.indexOf("gfx-webgl2");-1!==i&&(e.includeModules.splice(i,1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0;const s=e.packages["taobao-mini-game"];if(/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){s.separateEngine&&e.debug&&console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_debug")),"builtin"===(await Editor.Message.request("engine","query-engine-info")).typescript.type?s.separateEngine=s.separateEngine&&!e.debug:console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_with_custom_engine"))}else console.warn(Editor.I18n.t("taobao-mini-game.tips.separate_engine_only_in_normal_version"));Object.assign(e.buildEngineParam,{sourceMaps:!s.separateEngine&&e.sourceMaps,skip:s.separateEngine}),t.staticsInfo.B100012=e.server,t.staticsInfo.B100011=e.packages["taobao-mini-game"].deviceOrientation,e.buildScriptParam.flags.WASM_SUBPACKAGE=s.wasmSubpackage&&!s.separateEngine}async function onBeforeCompressSettings(e,t,a){t.settings.screen.orientation=e.packages["taobao-mini-game"].deviceOrientation,t.settings.scripting.scriptPackages=t.scriptPackages.map(e=>`project://${(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/")}`)}async function onAfterBuild(e,t,a){if(!t.paths.dir)return;e.packages["taobao-mini-game"].separateEngine&&(await buildSeparateEngine(e,t),Build.ScriptBuilder.outputImportMap(t.importMap,{dest:t.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug}));const i=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=(0,path_1.join)(i,"templates/taobao-mini-game");await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/taobao-mini-game",`web-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"web-adapter.js")),await(0,fs_extra_1.copy)((0,path_1.join)(i,"bin/adapter/minigame/taobao-mini-game",`engine-adapter.${e.debug?"":"min."}js`),(0,path_1.join)(t.paths.dir,"engine-adapter.js"));const n={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},r=await ejs_1.default.renderFile((0,path_1.join)(s,"game.ejs"),n);(0,fs_extra_1.writeFileSync)((0,path_1.join)(t.paths.dir,"game.js"),r);const o=(0,path_1.join)(Build.buildTemplateDir,e.platform);(0,fs_extra_1.existsSync)(o)&&((0,fs_extra_1.copySync)(o,t.paths.dir),console.debug(`Use build-template {link(${o})}.`)),["mini.project.json","game.json"].forEach(async a=>{const n=(0,fs_extra_1.readJSONSync)((0,path_1.join)(s,a));if("game.json"===a){const a=e.packages["taobao-mini-game"];if(a.separateEngine){const e=(0,path_1.join)(i,"templates/taobao-mini-game"),t=(0,path_1.join)(e,"patch.json");let a=Editor.App.version;(0,fs_extra_1.existsSync)(t)&&(a=await Editor.Profile.getConfig("utils",`${Editor.App.version.replace(".","_")}_plugin-version.taobao-mini-game`)||await Editor.Profile.getConfig("taobao-mini-game","plugin-version")),n.plugins={cocos:{pluginVersion:a,pluginId:require((0,path_1.join)(__dirname,"../static/cocos/signature.json")).pluginId,path:"cocos"}}}n.deviceOrientation=e.packages["taobao-mini-game"].deviceOrientation;const s=[];for(const e of this.bundleManager.bundles){if(!e.isSubpackage)continue;const t=(0,path_1.join)((0,path_1.dirname)(e.scriptDest),"game.js");(0,fs_extra_1.existsSync)(e.scriptDest)?(0,fs_extra_1.renameSync)(e.scriptDest,t):(0,fs_extra_1.outputFileSync)(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,s.push({name:e.name,root:`subpackages/${e.name}/`})}if(a.wasmSubpackage&&!a.separateEngine){const e=(0,path_1.join)(t.paths.engineDir,"./assets/"),a=(0,path_1.join)(t.paths.engineDir,"./chunks/");(0,fs_extra_1.existsSync)(e)&&s.push({name:"__ccWasmAssetSubpkg__",root:"cocos-js/assets/"}),(0,fs_extra_1.existsSync)(a)&&s.push({name:"__ccWasmChunkSubpkg__",root:"cocos-js/chunks/"})}s.length>0&&(n.subpackages=s)}const r=(0,path_1.join)(o,a);if((0,fs_extra_1.existsSync)(r)){const e=(0,fs_extra_1.readJSONSync)(r);Object.assign(n,e)}const p=(0,path_1.join)(t.paths.dir,a);(0,fs_extra_1.writeJSONSync)(p,n)}),(await globby(["**/*","!build-template.json","!$'mini.project.json'}","!game.json","!**/*.ejs"],{cwd:s})).map(e=>path.resolve(s,e)).forEach(e=>{if((0,fs_extra_1.statSync)(e).isFile()){const a=(0,path_1.relative)(s,e),i=(0,fs_extra_1.readFileSync)(e,"utf8");(0,fs_extra_1.outputFileSync)((0,path_1.join)(t.paths.dir,a),i,{encoding:"utf8"})}}),await postHandleScript(e,t,a)}function onBeforeBundleInit(e){e.polyfills&&(e.polyfills.asyncFunctions=!1),e.moveRemoteBundleScript=!0,e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.platform="TAOBAO_MINIGAME";const t=e.includeModules.indexOf("gfx-webgl2");-1!==t&&(e.includeModules.splice(t,1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1),e.assetSerializeOptions.exportCCON=!0}async function postHandleScript(e,t,a){const i=e.debug?"\n":"";let s=`var window = $global, global = $global, globalThis = $global;${i}const self = $global;${i}`;["__globalAdapter","cc","canvas","localStorage","System","document","requestAnimationFrame","cancelAnimationFrame","XMLHttpRequest","performance","DOMParser","HTMLElement","HTMLImageElement","HTMLCanvasElement","Image","ImageBitmap","WebSocket"].forEach(e=>{s+=`var ${e} = window.${e};${i}`});let n=s;const r=e.packages["taobao-mini-game"].globalVariable;if(r){r.split(",").map(e=>e.trim()).forEach(e=>{n+=`var ${e} = window.${e};${i}`})}const o=["game.js","**/system.bundle*.js","**/polyfills.bundle*.js","**/import-map*.js","src/assets/**/*.js"],p=t.paths.dir,c=/System\.register\((\[.*?\].*?\{)/g,l=/System\.register\((.*?,\s*?\[.*?\].*?\{)/g;(await globby(["**/*.js",...o.map(e=>"!"+e)],{cwd:p})).map(e=>path.resolve(p,e)).forEach(e=>{const a=(0,path_1.relative)(t.paths.dir,e).replace(/\\/g,"/");let r=(0,fs_extra_1.readFileSync)(e,"utf8"),o=n;if((a.startsWith("cocos/")||a.startsWith("cocos-js/"))&&(o=s),c.test(r))r=r.replace(c,`$global.System.register($1${i}${o}`);else{r=l.test(r)?r.replace(l,`$global.System.register($1${i}${o}`):o+r}(0,fs_extra_1.writeFileSync)(e,r,"utf8")}),(await globby(o,{cwd:p})).map(e=>path.resolve(p,e)).forEach(e=>{let t=(0,fs_extra_1.readFileSync)(e,"utf8");t=n+t,(0,fs_extra_1.writeFileSync)(e,t,"utf8")});const u=["(function () {",'if (typeof $global !== "object") return;','const globalFuncMap = {"Int8Array": Int8Array, "Uint8Array": Uint8Array, "Int16Array": Int16Array, "Uint16Array": Uint16Array, "Int32Array": Int32Array, "Uint32Array": Uint32Array, "Float32Array": Float32Array, "Float64Array": Float64Array};',"Object.keys(globalFuncMap).forEach((funcName)=>{","$global[funcName] = globalFuncMap[funcName];","});","})();"].join(i),g=(0,path_1.join)(t.paths.dir,"game.js");let m=(0,fs_extra_1.readFileSync)(g,"utf8");m=u+m,(0,fs_extra_1.writeFileSync)(g,m,"utf8");const d=(await globby(["cocos-js/base*.js"],{cwd:p})).map(e=>path.resolve(p,e)),_=(await globby(["cocos-js/physics-ammo*.js","cocos-js/physics-cannon*.js","cocos-js/physics-framework*.js","cocos-js/physics-builtin*.js"],{cwd:p})).map(e=>path.resolve(p,e));1===d.length&&_.forEach(e=>{const t=d[0].replace(/\\/g,"/").lastIndexOf("/");if(-1!==t){const a=d[0].substring(t+1);let i=(0,fs_extra_1.readFileSync)(e,"utf8");i=i.replace(/base.js/,a),(0,fs_extra_1.writeFileSync)(e,i,"utf8")}})}async function buildSeparateEngine(e,t){var a;(0,fs_extra_1.ensureDirSync)(t.paths.engineDir),await(0,separate_engine_1.buildCocos)(!Editor.App.dev);const i=e.buildEngineParam.includeModules,s=await ccbuild_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),n=s.getUnitsOfFeatures(i),r=(0,separate_engine_1.getPluginFeatures)(),o=s.getUnitsOfFeatures(r),p=n.filter(e=>!r.includes(e)),c=(0,fs_extra_1.readJSONSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.outDir,"meta.json")),l=(0,path_1.join)(t.paths.engineDir,"cc.js"),u=await ccbuild_1.buildEngine.transform(s.evaluateIndexModuleSource(n,e=>o.includes(e)?`plugin:cocos/${e}.js`:`./${e}.js`),"system");(0,fs_extra_1.writeFileSync)(l,u.code,"utf8");const g=ccbuild_1.buildEngine.enumerateDependentChunks(c,p),m=ccbuild_1.buildEngine.enumerateDependentChunks(c,o),d=ccbuild_1.buildEngine.enumerateDependentAssets(c,p).concat(ccbuild_1.buildEngine.enumerateDependentAssets(c,o)),_=null!==(a=t.importMap.imports)&&void 0!==a?a:{},f=e=>e in c.chunkAliases,h=e=>{var t;return null!==(t=c.chunkAliases[e])&&void 0!==t?t:e},b=e=>{const a=h(e),i=(0,path_1.join)(t.paths.engineDir,a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(i)),(0,fs_extra_1.copyFileSync)((0,path_1.join)(separate_engine_1.separateEnginPaths.cacheCocos,a),i),f(e)&&(_[e]=`../${(0,path_1.basename)(t.paths.engineDir)}/${a}`)};g.forEach(e=>{m.includes(e)?(e=>{const a=h(e),i=f(e)?e:`../${(0,path_1.basename)(t.paths.engineDir)}/${a}`,s=`plugin:cocos/${a}`;_[i]=s})(e):b(e)}),d.forEach(e=>{b(e)}),_.cc=`./${Build.Utils.relativeUrl((0,path_1.dirname)(t.paths.importMap),t.paths.engineDir)}/cc.js`,i.includes("physics-ammo")&&(_["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl((0,path_1.dirname)(t.paths.importMap),t.paths.engineDir)}/wait-for-ammo-instantiation.js`),t.importMap.imports=_;const y=(0,path_1.join)(t.paths.dir,"cocos");await(0,separate_engine_1.generateCocos)(m,y)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.onBeforeBundleInit=onBeforeBundleInit;