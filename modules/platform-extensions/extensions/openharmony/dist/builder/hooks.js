"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterBundleInit=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const ccbuild_1=require("@cocos/ccbuild"),fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),json5_1=__importDefault(require("json5"));async function generateOptions(t){var e,s;const a=t.packages.openharmony;a.orientation=a.orientation||{};const n=await Editor.Message.request("program","query-program-info","OpenHarmonySDK"),r=await Editor.Message.request("program","query-program-info","OpenHarmonyNDK");return a.sdkPath=n?n.path:"",a.ndkPath=r?r.path:"",{packageName:a.packageName||"",orientation:a.orientation,apiLevel:Number(a.apiLevel)||9,appABIs:a.appABIs||[],sdkPath:a.sdkPath||"",ndkPath:a.ndkPath||"",renderBackEnd:{gles3:null===(s=null===(e=a.renderBackEnd)||void 0===e?void 0:e.gles3)||void 0===s||s},useAotOptimization:a.useAotOptimization}}async function onBeforeBuild(t,e,s){t.sourceMaps=!1}async function onAfterInit(t,e,s){const a=await generateOptions(t);t.packages.openharmony=a;const n=a.renderBackEnd;t.buildEngineParam.preserveType=a.useAotOptimization,e.staticsInfo.B100005=a.packageName,e.staticsInfo.B100011=a.orientation;const r=e.compileOptions;Object.keys(n).forEach(t=>{r.cMakeConfig[`CC_USE_${t.toUpperCase()}`]=n[t]}),Object.assign(r.platformParams,a),await fs_extra_1.outputJSON(e.paths.compileConfig,r),checkSDKEnv(t)}function onAfterBundleInit(t){var e;t.buildScriptParam.importMapFormat="esm";const s=t.packages.openharmony.renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(e=s.gles3)||void 0===e||e,t.buildScriptParam.platform="OPEN_HARMONY"}async function onAfterBuild(t,e,s){const a=t.packages.openharmony.useAotOptimization;let n=fs_extra_1.readFileSync(e.paths.settings,"utf8");n="export default "+n;const{code:r}=await ccbuild_1.buildEngine.transform(n,"system");fs_extra_1.unlinkSync(e.paths.settings);const o=path_1.join(path_1.dirname(e.paths.settings),"settings.js");fs_extra_1.outputFileSync(o,r,"utf8");const i=path_1.join(e.paths.dir,"assets"),p=path_1.join(Editor.Project.path,"native/engine",t.platform,"entry/src/main"),c=path_1.join(p,"ets/cocos/src/cocos-js/assets"),_=path_1.join(Editor.Project.path,"native/engine",t.platform,"entry"),u=path_1.join(p,"resources/rawfile/Resources"),l=path_1.join(u,"assets"),f=path_1.join(u,"cocos-js/assets");await fs_extra_2.emptyDir(l),await fs_extra_2.ensureDir(l),await fs_extra_2.copy(i,l);const h=path_1.join(e.paths.dir,"src");await fs_extra_2.emptyDir(path_1.join(p,"ets/cocos/src")),await fs_extra_2.emptyDir(path_1.join(p,"ets/cocos/assets")),await fs_extra_2.copy(h,path_1.join(p,"ets/cocos/src"));const d=[];this.bundleManager.bundles.forEach(e=>{e.isRemote||(d.push(`${e.name}/${path_1.basename(e.scriptDest)}`),fs_extra_2.moveSync(path_1.join(l,e.name,path_1.basename(e.scriptDest)),path_1.join(p,"ets/cocos/assets",e.name,path_1.basename(e.scriptDest))),t.sourceMaps&&fs_extra_2.moveSync(path_1.join(l,e.name,"index.js.map"),path_1.join(p,"ets/cocos/assets",e.name,"index.js.map")))}),fs_extra_1.existsSync(c)&&(await fs_extra_2.ensureDir(f),await fs_extra_2.emptyDir(f),await fs_extra_2.copy(c,f),await fs_extra_1.rm(c,{force:!0,recursive:!0}));const m=[];for(const t in e.paths.plugins){const s=e.paths.plugins[t],a=path_1.relative(e.paths.dir,s);m.push(a.split("\\").join("/"))}const y=await Editor.Message.request("engine","query-engine-info"),g=path_1.join(y.typescript.path,"templates/openharmony/entry/src/main/ets/cocos/game.ts"),x=path_1.join(p,"ets/cocos/game.ts");let j=fs_extra_2.readdirSync(e.paths.engineDir);j=j.filter(t=>!fs_extra_1.statSync(path_1.join(e.paths.engineDir,t)).isDirectory());const k=e.importMap.imports.cc.slice(2),O={importMapUrl:path_1.basename(e.paths.importMap),applicationUrl:path_1.basename(e.paths.applicationJS),systemBundleUrl:path_1.basename(e.paths.systemJs),ccUrls:j,systemCCUrl:k,bundleJsList:d,pluginsJsList:m,chunkBundleUrl:"",useAotOptimization:a};if(fs_extra_1.existsSync(path_1.join(e.paths.dir,"src/chunks"))){const t=fs_extra_2.readdirSync(path_1.join(e.paths.dir,"src/chunks")).find(t=>t.startsWith("bundle")&&t.endsWith(".js"));t&&(O.chunkBundleUrl=t)}fs_extra_2.writeFileSync(x,await ejs_1.default.renderFile(g,O),"utf8");const S=path_1.join(_,"build-profile.json5"),B=json5_1.default.parse(fs_extra_1.readFileSync(S,"utf8"));B.buildOption.compileMode=a?"esmodule":"jsbundle",fs_extra_2.writeFileSync(S,json5_1.default.stringify(B,null,2))}async function getBrowserslistQuery(t){const e=path_1.join(t,".browserslistrc");let s;try{s=await fs_extra_2.readFile(e,"utf8")}catch(t){return}const a=function(t){const e=[];for(const s of t.split("\n")){const t=s.indexOf("#"),a=(t<0?s:s.substr(0,t)).trim();0!==a.length&&e.push(a)}return e}(s);if(0!==a.length)return a.join(" or ")}function checkSDKEnv(t){const e=t.packages.openharmony;if(!process.env.OHOS_SDK_HOME&&!e.sdkPath)throw new Error(Editor.I18n.t("openharmony.tips.ohos_sdk_error"));process.env.OHOS_SDK_HOME?e.sdkPath=process.env.OHOS_SDK_HOME:process.env.OHOS_SDK_HOME=e.sdkPath}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuild=onAfterBuild;