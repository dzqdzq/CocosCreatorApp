"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs"));async function generateOptions(e){var e=e.packages.openharmony;return e.orientation=e.orientation||{},e.sdkPath=e.sdkPath||await Editor.Profile.getConfig("program","openharmony_sdk")||"",{packageName:e.packageName||"",orientation:e.orientation,apiLevel:Number(e.apiLevel)||9,appABIs:e.appABIs||[],sdkPath:e.sdkPath||"",renderBackEnd:{gles3:null==(e=null==(e=e.renderBackEnd)?void 0:e.gles3)||e}}}async function onBeforeBuild(e,t,a){e.sourceMaps=!1}async function onAfterInit(e,t,a){var s=await generateOptions(e);e.buildEngineParam.forceJitValue=!1;const r=(e.packages.openharmony=s).renderBackEnd;e.assetSerializeOptions["cc.EffectAsset"].glsl3=null==(n=r.gles3)||n;var n={packageName:s.packageName,orientation:s.orientation};a.__addStaticsInfo(n);const o=t.compileOptions;Object.keys(r).forEach(e=>{o.cMakeConfig["CC_USE_"+e.toUpperCase()]=r[e]}),e.buildScriptParam.importMapFormat="commonjs",Object.assign(o.platformParams,s),await fs_extra_1.outputJSON(t.paths.compileConfig,o),checkSDKEnv(e)}async function onAfterBuild(t,e,a){var s=path_1.join(e.paths.dir,"assets");const r=path_1.join(Editor.Project.path,"native/engine",t.platform,"entry/src/main"),n=path_1.join(r,"resources/rawfile/Resources/assets");await fs_extra_2.emptyDir(n),await fs_extra_2.ensureDir(n),await fs_extra_2.copy(s,n);s=path_1.join(e.paths.dir,"src");await fs_extra_2.emptyDir(path_1.join(r,"ets/cocos/src")),await fs_extra_2.emptyDir(path_1.join(r,"ets/cocos/assets")),await fs_extra_2.copy(s,path_1.join(r,"ets/cocos/src"));const o=[];e.bundles.forEach(e=>{e.isRemote||(o.push(e.name+"/"+path_1.basename(e.scriptDest)),fs_extra_2.moveSync(path_1.join(n,e.name,path_1.basename(e.scriptDest)),path_1.join(r,"ets/cocos/assets",e.name,path_1.basename(e.scriptDest))),t.sourceMaps&&fs_extra_2.moveSync(path_1.join(n,e.name,"index.js.map"),path_1.join(r,"ets/cocos/assets",e.name,"index.js.map")))});var s=await Editor.Message.request("engine","query-info",Editor.Project.type),s=path_1.join(s.path,"templates/openharmony/entry/src/main/ets/cocos/game.ts"),i=path_1.join(r,"ets/cocos/game.ts"),p=fs_extra_2.readdirSync(e.paths.engineDir),p={importMapUrl:path_1.basename(e.paths.importMap),applicationUrl:path_1.basename(e.paths.applicationJS),systemBundleUrl:path_1.basename(e.paths.systemJs),ccUrls:p,bundleJsList:o,chunkBundleUrl:""};fs_extra_1.existsSync(path_1.join(e.paths.dir,"src/chunks"))&&(e=fs_extra_2.readdirSync(path_1.join(e.paths.dir,"src/chunks")).find(e=>e.startsWith("bundle")&&e.endsWith(".js")))&&(p.chunkBundleUrl=e),fs_extra_2.writeFileSync(i,await ejs_1.default.renderFile(s,p),"utf8")}async function getBrowserslistQuery(e){e=path_1.join(e,".browserslistrc");let t;try{t=await fs_extra_2.readFile(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const s of e.split("\n")){var a=s.indexOf("#"),a=(a<0?s:s.substr(0,a)).trim();0!==a.length&&t.push(a)}return t}(t);if(0!==e.length)return e.join(" or ")}function checkSDKEnv(e){e=e.packages.openharmony;if(!process.env.OHOS_SDK_HOME&&!e.sdkPath)throw new Error(Editor.I18n.t("openharmony.tips.ohos_sdk_error"));process.env.OHOS_SDK_HOME?e.sdkPath=process.env.OHOS_SDK_HOME:process.env.OHOS_SDK_HOME=e.sdkPath}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBuild=onAfterBuild;