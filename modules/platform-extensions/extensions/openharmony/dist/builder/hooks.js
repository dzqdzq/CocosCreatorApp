"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterBundleInit=exports.onAfterInit=exports.onBeforeBuild=exports.throwError=void 0;const ccbuild_1=require("@cocos/ccbuild"),fs_extra_1=require("fs-extra"),fs_extra_2=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),json5_1=__importDefault(require("json5"));async function generateOptions(t){var e,s;const a=t.packages.openharmony;a.orientation=a.orientation||{};const n=await Editor.Message.request("program","query-program-info","OpenHarmonySDK"),r=await Editor.Message.request("program","query-program-info","OpenHarmonyNDK");return a.sdkPath=n?n.path:"",a.ndkPath=r?r.path:"",{packageName:a.packageName||"",orientation:a.orientation,apiLevel:Number(a.apiLevel)||9,appABIs:a.appABIs||[],sdkPath:a.sdkPath||"",ndkPath:a.ndkPath||"",renderBackEnd:{gles3:null===(s=null===(e=a.renderBackEnd)||void 0===e?void 0:e.gles3)||void 0===s||s},useAotOptimization:a.useAotOptimization,useV8:a.useV8}}async function onBeforeBuild(t,e,s){t.sourceMaps=!1}async function onAfterInit(t,e,s){const a=await generateOptions(t);t.packages.openharmony=a;const n=a.renderBackEnd;t.buildEngineParam.preserveType=a.useAotOptimization,e.staticsInfo.B100005=a.packageName,e.staticsInfo.B100011=a.orientation;const r=e.compileOptions;Object.keys(n).forEach(t=>{r.cMakeConfig[`CC_USE_${t.toUpperCase()}`]=n[t]}),r.cMakeConfig.USE_SE_V8=`set(USE_SE_V8 ${a.useV8?"ON":"OFF"})`,r.cMakeConfig.USE_SE_NAPI=`set(USE_SE_NAPI ${a.useV8?"OFF":"ON"})`,Object.assign(r.platformParams,a),await(0,fs_extra_1.outputJSON)(e.paths.compileConfig,r),checkSDKEnv(t)}function onAfterBundleInit(t){var e;t.packages.openharmony.useV8||(t.buildScriptParam.importMapFormat="esm");const s=t.packages.openharmony.renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(e=s.gles3)||void 0===e||e,t.buildScriptParam.platform="OPEN_HARMONY"}async function onAfterBuild(t,e,s){const{useAotOptimization:a,useV8:n}=t.packages.openharmony;if(!n){let t=(0,fs_extra_1.readFileSync)(e.paths.settings,"utf8");t="export default "+t;const{code:s}=await ccbuild_1.buildEngine.transform(t,"system");(0,fs_extra_1.unlinkSync)(e.paths.settings);const a=(0,path_1.join)((0,path_1.dirname)(e.paths.settings),"settings.js");(0,fs_extra_1.outputFileSync)(a,s,"utf8")}const r=(0,path_1.join)(e.paths.dir,"assets"),o=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry/src/main"),i=(0,path_1.join)(o,"ets/cocos/src/cocos-js/assets"),p=(0,path_1.join)(Editor.Project.path,"native/engine",t.platform,"entry"),c=(0,path_1.join)(p,"src/main/ets/cocos/src/effect.bin"),_=(0,path_1.join)(o,"resources/rawfile/Resources"),u=(0,path_1.join)(_,"assets"),f=(0,path_1.join)(_,"cocos-js/assets"),h=(0,path_1.join)(_,"src/effect.bin");await(0,fs_extra_2.emptyDir)(u),await(0,fs_extra_2.ensureDir)(u),await(0,fs_extra_2.copy)(r,u);const l=(0,path_1.join)(e.paths.dir,"src");if(await(0,fs_extra_2.emptyDir)((0,path_1.join)(o,"ets/cocos/src")),await(0,fs_extra_2.emptyDir)((0,path_1.join)(o,"ets/cocos/assets")),await(0,fs_extra_2.copy)(l,(0,path_1.join)(o,"ets/cocos/src")),n){const t=(0,path_1.join)(o,"ets/cocos"),s=["jsb-adapter","src"];for(const e of s){const s=(0,path_1.join)(t,e),a=(0,path_1.join)(_,e);await(0,fs_extra_2.ensureDir)(a),await(0,fs_extra_2.emptyDir)(a),await(0,fs_extra_2.copy)(s,a),await(0,fs_extra_1.rm)(s,{force:!0,recursive:!0})}const a=(0,path_1.join)(e.paths.dir,"main.js"),n=(0,path_1.join)(_,"main.js");await(0,fs_extra_2.copy)(a,n)}else this.bundleManager.bundles.forEach(e=>{e.isRemote||((0,fs_extra_2.moveSync)((0,path_1.join)(u,e.name,(0,path_1.basename)(e.scriptDest)),(0,path_1.join)(o,"ets/cocos/assets",e.name,(0,path_1.basename)(e.scriptDest))),t.sourceMaps&&(0,fs_extra_2.moveSync)((0,path_1.join)(u,e.name,"index.js.map"),(0,path_1.join)(o,"ets/cocos/assets",e.name,"index.js.map")))}),(0,fs_extra_1.existsSync)(i)&&(await(0,fs_extra_2.ensureDir)(f),await(0,fs_extra_2.emptyDir)(f),await(0,fs_extra_2.copy)(i,f),await(0,fs_extra_1.rm)(i,{force:!0,recursive:!0})),(0,fs_extra_1.existsSync)(c)&&await(0,fs_extra_2.copy)(c,h);const d=[];this.bundleManager.bundles.forEach(t=>{t.isRemote||d.push(`${t.name}/${(0,path_1.basename)(t.scriptDest)}`)});const m=[];for(const t in e.paths.plugins){const s=e.paths.plugins[t],a=(0,path_1.relative)(e.paths.dir,s);m.push(a.split("\\").join("/"))}const y=await Editor.Message.request("engine","query-engine-info"),j=(0,path_1.join)(y.typescript.path,"templates/openharmony/entry/src/main/ets/cocos/game.ts"),x=(0,path_1.join)(o,"ets/cocos/game.ts");let g=(0,fs_extra_2.readdirSync)(e.paths.engineDir);g=g.filter(t=>!(0,fs_extra_1.statSync)((0,path_1.join)(e.paths.engineDir,t)).isDirectory());const S=e.importMap.imports.cc.slice(2),w={importMapUrl:(0,path_1.basename)(e.paths.importMap),applicationUrl:(0,path_1.basename)(e.paths.applicationJS),systemBundleUrl:(0,path_1.basename)(e.paths.systemJs),ccUrls:g,systemCCUrl:S,bundleJsList:d,pluginsJsList:m,chunkBundleUrl:"",useAotOptimization:a};if((0,fs_extra_1.existsSync)((0,path_1.join)(e.paths.dir,"src/chunks"))){const t=(0,fs_extra_2.readdirSync)((0,path_1.join)(e.paths.dir,"src/chunks")).find(t=>t.startsWith("bundle")&&t.endsWith(".js"));t&&(w.chunkBundleUrl=t)}(0,fs_extra_2.writeFileSync)(x,await ejs_1.default.renderFile(j,w),"utf8");const k=(0,path_1.join)(y.typescript.path,"templates/openharmony/entry/src/main/ets/workers/cocos_worker.ts"),E=(0,path_1.join)(o,"ets/workers/cocos_worker.ts"),O={useV8:n};(0,fs_extra_2.writeFileSync)(E,await ejs_1.default.renderFile(k,O),"utf8");const b=(0,path_1.join)(p,"build-profile.json5"),B=json5_1.default.parse((0,fs_extra_1.readFileSync)(b,"utf8"));B.buildOption.compileMode=a?"esmodule":"jsbundle",(0,fs_extra_2.writeFileSync)(b,json5_1.default.stringify(B,null,2))}async function getBrowserslistQuery(t){const e=(0,path_1.join)(t,".browserslistrc");let s;try{s=await(0,fs_extra_2.readFile)(e,"utf8")}catch(t){return}const a=function(t){const e=[];for(const s of t.split("\n")){const t=s.indexOf("#"),a=(t<0?s:s.substr(0,t)).trim();0!==a.length&&e.push(a)}return e}(s);if(0!==a.length)return a.join(" or ")}function checkSDKEnv(t){const e=t.packages.openharmony;if(!process.env.OHOS_SDK_HOME&&!e.sdkPath)throw new Error(Editor.I18n.t("openharmony.tips.ohos_sdk_error"));process.env.OHOS_SDK_HOME?e.sdkPath=process.env.OHOS_SDK_HOME:process.env.OHOS_SDK_HOME=e.sdkPath}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.onAfterInit=onAfterInit,exports.onAfterBundleInit=onAfterBundleInit,exports.onAfterBuild=onAfterBuild;