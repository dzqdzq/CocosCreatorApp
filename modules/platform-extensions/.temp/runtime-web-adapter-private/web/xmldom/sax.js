var nameStartChar=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,nameChar=new RegExp("[\\-\\.0-9"+nameStartChar.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),tagNamePattern=new RegExp("^"+nameStartChar.source+nameChar.source+"*(?::"+nameStartChar.source+nameChar.source+"*)?$"),S_TAG=0,S_ATTR=1,S_ATTR_SPACE=2,S_EQ=3,S_ATTR_NOQUOT_VALUE=4,S_ATTR_END=5,S_TAG_SPACE=6,S_TAG_CLOSE=7;function XMLReader(){}function parse(r,e,a,n,s){function c(e){var t=e.slice(1,-1);return t in a?a[t]:"#"===t.charAt(0)?65535<(t=parseInt(t.substr(1).replace("x","0x")))?(t-=65536,String.fromCharCode(55296+(t>>10),56320+(1023&t))):String.fromCharCode(t):(s.error("entity not found:"+e),e)}function t(e){var t;_<e&&(t=r.substring(_,e).replace(/&#?\w+;/g,c),m&&i(_),n.characters(t,0,e-_),_=e)}function i(e,t){for(;l<=e&&(t=u.exec(r));)o=t.index,l=o+t[0].length,m.lineNumber++;m.columnNumber=e-o+1}for(var o=0,l=0,u=/.*(?:\r\n?|\n)|.*$/g,m=n.locator,d=[{currentNSMap:e}],T={},_=0;;){try{var S,f,p=r.indexOf("<",_);if(p<0)return void(r.substr(_).match(/^\s*$/)||(f=(S=n.doc).createTextNode(r.substr(_)),S.appendChild(f),n.currentElement=f));switch(_<p&&t(p),r.charAt(p+1)){case"/":var h=r.indexOf(">",p+3),A=r.substring(p+2,h),g=d.pop(),w=(h<0?(A=r.substring(p+2).replace(/[\s<].*/,""),s.error("end tag name: "+A+" is not complete:"+g.tagName),h=p+1+A.length):A.match(/\s</)&&(A=A.replace(/[\s<].*/,""),s.error("end tag name: "+A+" maybe not complete"),h=p+1+A.length),g.localNSMap),E=g.tagName==A;if(E||g.tagName&&g.tagName.toLowerCase()==A.toLowerCase()){if(n.endElement(g.uri,g.localName,A),w)for(var N in w)n.endPrefixMapping(N);E||s.fatalError("end tag name: "+A+" is not match the current start tagName:"+g.tagName)}else d.push(g);h++;break;case"?":m&&i(p),h=parseInstruction(r,p,n);break;case"!":m&&i(p),h=parseDCC(r,p,n,s);break;default:m&&i(p);var b=new ElementAttributes,x=d[d.length-1].currentNSMap,h=parseElementStartPart(r,p,b,x,c,s),C=b.length;if(!b.closed&&fixSelfClosed(r,h,b.tagName,T)&&(b.closed=!0,a.nbsp||s.warning("unclosed xml attribute")),m&&C){for(var v=copyLocator(m,{}),R=0;R<C;R++){var O=b[R];i(O.offset),O.locator=copyLocator(m,{})}n.locator=v,appendElement(b,n,x)&&d.push(b),n.locator=m}else appendElement(b,n,x)&&d.push(b);"http://www.w3.org/1999/xhtml"!==b.uri||b.closed?h++:h=parseHtmlSpecialContent(r,h,b.tagName,c,n)}}catch(e){s.error("element parse error: "+e),h=-1}_<h?_=h:t(Math.max(p,_)+1)}}function copyLocator(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function parseElementStartPart(e,t,r,a,n,s){for(var c,i=++t,o=S_TAG;;){var l=e.charAt(i);switch(l){case"=":if(o===S_ATTR)c=e.slice(t,i);else if(o!==S_ATTR_SPACE)throw new Error("attribute equal must after attrName");o=S_EQ;break;case"'":case'"':if(o===S_EQ||o===S_ATTR){if(o===S_ATTR&&(s.warning('attribute value must after "="'),c=e.slice(t,i)),!(0<(i=e.indexOf(l,t=i+1))))throw new Error("attribute value no end '"+l+"' match");u=e.slice(t,i).replace(/&#?\w+;/g,n),r.add(c,u,t-1)}else{if(o!=S_ATTR_NOQUOT_VALUE)throw new Error('attribute value must after "="');u=e.slice(t,i).replace(/&#?\w+;/g,n),r.add(c,u,t),s.warning('attribute "'+c+'" missed start quot('+l+")!!"),t=i+1}o=S_ATTR_END;break;case"/":switch(o){case S_TAG:r.setTagName(e.slice(t,i));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:o=S_TAG_CLOSE,r.closed=!0;case S_ATTR_NOQUOT_VALUE:case S_ATTR:case S_ATTR_SPACE:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return s.error("unexpected end of input"),o==S_TAG&&r.setTagName(e.slice(t,i)),i;case">":switch(o){case S_TAG:r.setTagName(e.slice(t,i));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:break;case S_ATTR_NOQUOT_VALUE:case S_ATTR:"/"===(u=e.slice(t,i)).slice(-1)&&(r.closed=!0,u=u.slice(0,-1));case S_ATTR_SPACE:o===S_ATTR_SPACE&&(u=c),o==S_ATTR_NOQUOT_VALUE?(s.warning('attribute "'+u+'" missed quot(")!!'),r.add(c,u.replace(/&#?\w+;/g,n),t)):("http://www.w3.org/1999/xhtml"===a[""]&&u.match(/^(?:disabled|checked|selected)$/i)||s.warning('attribute "'+u+'" missed value!! "'+u+'" instead!!'),r.add(u,u,t));break;case S_EQ:throw new Error("attribute value missed!!")}return i;case"Â€":l=" ";default:if(l<=" ")switch(o){case S_TAG:r.setTagName(e.slice(t,i)),o=S_TAG_SPACE;break;case S_ATTR:c=e.slice(t,i),o=S_ATTR_SPACE;break;case S_ATTR_NOQUOT_VALUE:var u=e.slice(t,i).replace(/&#?\w+;/g,n);s.warning('attribute "'+u+'" missed quot(")!!'),r.add(c,u,t);case S_ATTR_END:o=S_TAG_SPACE}else switch(o){case S_ATTR_SPACE:r.tagName;"http://www.w3.org/1999/xhtml"===a[""]&&c.match(/^(?:disabled|checked|selected)$/i)||s.warning('attribute "'+c+'" missed value!! "'+c+'" instead2!!'),r.add(c,c,t),t=i,o=S_ATTR;break;case S_ATTR_END:s.warning('attribute space is required"'+c+'"!!');case S_TAG_SPACE:o=S_ATTR,t=i;break;case S_EQ:o=S_ATTR_NOQUOT_VALUE,t=i;break;case S_TAG_CLOSE:throw new Error("elements closed character '/' and '>' must be connected to")}}i++}}function appendElement(e,t,r){for(var a=e.tagName,n=null,s=e.length;s--;){var c=e[s],i=c.qName,o=c.value,i=0<(u=i.indexOf(":"))?(l=c.prefix=i.slice(0,u),m=i.slice(u+1),"xmlns"===l&&m):(l=null,"xmlns"===(m=i)&&"");c.localName=m,!1!==i&&(null==n&&(n={},_copy(r,r={})),r[i]=n[i]=o,c.uri="http://www.w3.org/2000/xmlns/",t.startPrefixMapping(i,o))}for(var l,s=e.length;s--;)(l=(c=e[s]).prefix)&&("xml"===l&&(c.uri="http://www.w3.org/XML/1998/namespace"),"xmlns"!==l)&&(c.uri=r[l||""]);var u,m=0<(u=a.indexOf(":"))?(l=e.prefix=a.slice(0,u),e.localName=a.slice(u+1)):(l=null,e.localName=a),d=e.uri=r[l||""];if(t.startElement(d,m,a,e),!e.closed)return e.currentNSMap=r,e.localNSMap=n,!0;if(t.endElement(d,m,a),n)for(l in n)t.endPrefixMapping(l)}function parseHtmlSpecialContent(e,t,r,a,n){if(/^(?:script|textarea)$/i.test(r)){var s=e.indexOf("</"+r+">",t),e=e.substring(t+1,s);if(/[&<]/.test(e))return/^script$/i.test(r)?n.characters(e,0,e.length):(e=e.replace(/&#?\w+;/g,a),n.characters(e,0,e.length)),s}return t+1}function fixSelfClosed(e,t,r,a){var n=a[r];return null==n&&((n=e.lastIndexOf("</"+r+">"))<t&&(n=e.lastIndexOf("</"+r)),a[r]=n),n<t}function _copy(e,t){for(var r in e)t[r]=e[r]}function parseDCC(e,t,r,a){var n,s;return"-"===e.charAt(t+2)?"-"===e.charAt(t+3)?t<(n=e.indexOf("--\x3e",t+4))?(r.comment(e,t+4,n-t-4),n+3):(a.error("Unclosed comment"),-1):-1:"CDATA["==e.substr(t+3,6)?(n=e.indexOf("]]>",t+9),r.startCDATA(),r.characters(e,t+9,n-t-9),r.endCDATA(),n+3):1<(n=(a=split(e,t)).length)&&/!doctype/i.test(a[0][0])?(e=a[1][0],t=3<n&&/^public$/i.test(a[2][0])&&a[3][0],s=4<n&&a[4][0],a=a[n-1],r.startDTD(e,t&&t.replace(/^(['"])(.*?)\1$/,"$2"),s&&s.replace(/^(['"])(.*?)\1$/,"$2")),r.endDTD(),a.index+a[0].length):-1}function parseInstruction(e,t,r){var a=e.indexOf("?>",t);return a&&(e=e.substring(t,a).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/))?(e[0].length,r.processingInstruction(e[1],e[2]),a+2):-1}function ElementAttributes(e){}function split(e,t){var r,a=[],n=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;for(n.lastIndex=t,n.exec(e);r=n.exec(e);)if(a.push(r),r[1])return a}XMLReader.prototype={parse:function(e,t,r){var a=this.domBuilder;a.startDocument(),_copy(t,t={}),parse(e,t,r,a,this.errorHandler),a.endDocument()}},ElementAttributes.prototype={setTagName:function(e){if(!tagNamePattern.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},add:function(e,t,r){if(!tagNamePattern.test(e))throw new Error("invalid attribute:"+e);this[this.length++]={qName:e,value:t,offset:r}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},exports.XMLReader=XMLReader;