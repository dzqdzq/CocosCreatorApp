import Event from"./Event";import FILE_CACHE from"./util/FileCache";import XMLHttpRequestEventTarget from"./XMLHttpRequestEventTarget";const fsm=ral.getFileSystemManager(),_XMLHttpRequest=window.XMLHttpRequest;window.ral=window.ral||{};export default class XMLHttpRequest extends XMLHttpRequestEventTarget{_isLocal=!1;_readyState=0;_response;_responseText;_responseURL;_responseXML;_status;_statusText;_responseType;constructor(){super(new _XMLHttpRequest),this._xhr.onreadystatechange=function(t){var e=new Event("readystatechange");this.dispatchEvent(Object.assign(e,t))}.bind(this)}get readyState(){return this._isLocal?this._readyState:this._xhr.readyState}get response(){var t=this._isLocal?this._response:this._xhr.response;return"blob"===this._responseType?new Blob([t]):t}get responseText(){return this._isLocal?this._responseText:this._xhr.responseText}get responseType(){return this._responseType}set responseType(t){"blob"===(this._responseType=this._xhr.responseType=t)&&(this._xhr.responseType="arraybuffer")}get responseURL(){return this._isLocal?this._responseURL:this._xhr.responseURL}get responseXML(){return this._isLocal?this._responseXML:this._xhr.responseXML}get status(){return this._isLocal?this._status:this._xhr.status}get statusText(){return this._isLocal?this._statusText:this._xhr.statusText}get timeout(){return this._xhr.timeout}set timeout(t){this._xhr.timeout=t}get upload(){return this._xhr.upload}set withCredentials(t){this._xhr.withCredentials=t}get withCredentials(){return this._xhr.withCredentials}abort(){this._xhr.abort()}getAllResponseHeaders(){return this._xhr.getAllResponseHeaders()}getResponseHeader(t){return this._xhr.getResponseHeader(t)}open(t,e,s,r,a){if("string"==typeof e){var n=e.toLocaleString();if(n.startsWith("http://")||n.startsWith("https://"))return this._isLocal=!1,this._xhr.open(...arguments)}this._isLocal=!0,this._url=e,1!=this._readyState&&(this._readyState=1,this.dispatchEvent(new Event("readystatechange")))}overrideMimeType(){return this._xhr.overrideMimeType(...arguments)}send(){if(1!==this.readyState)throw"Uncaught DOMException: Failed to execute 'send' on 'XMLHttpRequest': The object's state must be OPENED.";if(this._isLocal){let s=this,r="arraybuffer"===this._xhr.responseType;this._readyState=2,this.dispatchEvent(new Event("readystatechange")),fsm.readFile({filePath:this._url,encoding:r?"binary":"utf8",success(t){s._status=200,s._response=s._responseText=t.data,r&&FILE_CACHE.setCache(s._url,t.data);var e=new Event("progress"),t=(e.loaded=0,e.total=r?t.data.byteLength:t.data.length,new Event("progress"));t.loaded=e.total,t.total=e.total,s.dispatchEvent(new Event("loadstart")),s.dispatchEvent(e),s.dispatchEvent(t),s.dispatchEvent(new Event("load"))},fail:function(t){1===t.errCode?(s._status=404,s.dispatchEvent(new Event("loadstart")),s.dispatchEvent(new Event("load"))):this.dispatchEvent(new Event("error"))}.bind(this),complete:function(){this._readyState=4,this.dispatchEvent(new Event("readystatechange")),this.dispatchEvent(new Event("loadend"))}.bind(this)})}else this._xhr.send(...arguments)}setRequestHeader(){this._xhr.setRequestHeader(...arguments)}}