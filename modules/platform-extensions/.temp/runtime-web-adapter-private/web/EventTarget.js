import TouchEvent from"./TouchEvent";import _weakMap from"./util/WeakMap";import DeviceMotionEvent from"./DeviceMotionEvent";let _listenerStat={},_onTouchStart=function(e){var t=new TouchEvent("touchstart");window.dispatchEvent(Object.assign(t,e))},_onTouchMove=function(e){var t=new TouchEvent("touchmove");window.dispatchEvent(Object.assign(t,e))},_onTouchCancel=function(e){var t=new TouchEvent("touchcancel");window.dispatchEvent(Object.assign(t,e))},_onTouchEnd=function(e){var t=new TouchEvent("touchend");window.dispatchEvent(Object.assign(t,e))},_systemInfo=ral.getSystemInfoSync(),_isAndroid="android"===_systemInfo.platform.toLowerCase(),_alpha=.8,_gravity=[0,0,0],_onAccelerometerChange=function(e){_isAndroid?(e.x*=-10,e.y*=-10,e.z*=-10):(e.x*=10,e.y*=10,e.z*=10),_gravity[0]=_alpha*_gravity[0]+(1-_alpha)*e.x,_gravity[1]=_alpha*_gravity[1]+(1-_alpha)*e.y,_gravity[2]=_alpha*_gravity[2]+(1-_alpha)*e.z;e=new DeviceMotionEvent({acceleration:{x:e.x-_gravity[0],y:e.y-_gravity[1],z:e.z-_gravity[2]},accelerationIncludingGravity:{x:e.x,y:e.y,z:e.z}});window.dispatchEvent(e)};export default class EventTarget{constructor(){_weakMap.set(this,{})}addEventListener(e,t,a={}){let o=_weakMap.get(this),n=(o||_weakMap.set(this,o={}),_weakMap.get(o));n||_weakMap.set(o,n={}),n[e]||(n[e]=[]);var c=n[e],r=c.length;for(let e=0;e<r;++e)if(c[e]===t)return;if(c.push(t),_listenerStat[e])++_listenerStat[e];else switch(_listenerStat[e]=1,e){case"touchstart":ral.onTouchStart(_onTouchStart);break;case"touchmove":ral.onTouchMove(_onTouchMove);break;case"touchcancel":ral.onTouchCancel(_onTouchCancel);break;case"touchend":ral.onTouchEnd(_onTouchEnd);break;case"devicemotion":ral.onAccelerometerChange(_onAccelerometerChange),ral.startAccelerometer()}a.capture,a.once,a.passive}removeEventListener(t,a){var e=_weakMap.get(this);let o;if(o=e?_weakMap.get(e):o){var n=o[t];if(n&&0<n.length)for(let e=n.length;e--;e)if(n[e]===a){if(n.splice(e,1),0==--_listenerStat[t])switch(t){case"touchstart":ral.offTouchStart(_onTouchStart);break;case"touchmove":ral.offTouchMove(_onTouchMove);break;case"touchcancel":ral.offTouchCancel(_onTouchCancel);break;case"touchend":ral.offTouchEnd(_onTouchEnd);break;case"devicemotion":ral.offAccelerometerChange(_onAccelerometerChange),ral.stopAccelerometer()}break}}}dispatchEvent(o={}){if(o._target=o._currentTarget=this,o instanceof TouchEvent){let t=o.touches,a=t.length;for(let e=0;e<a;++e)t[e].target=this;t=o.changedTouches,a=t.length;for(let e=0;e<a;++e)t[e].target=this}var e=this["on"+o.type],e=("function"==typeof e&&e.call(this,o),_weakMap.get(this));let t;if(t=e?_weakMap.get(e):t){var a=t[o.type];if(a)for(let e=0;e<a.length;e++)a[e].call(this,o)}return!(o._target=o._currentTarget=null)}}