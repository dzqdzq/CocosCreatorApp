let _subpackages={},_remoteBundles={},_server,_downloader=cc.assetManager.downloader,_originInit=cc.assetManager.init,_zipCache={},_fsm=ral.getFileSystemManager();const CACHED_FILE_PATH=ral.env.USER_DATA_PATH+"/zipBundleCacheList.json";function downloadBundle(a,e,r){let n=e.version||_downloader.bundleVers[a],l="assets/"+a,t=`${l}/config.${n?n+".":""}json`,c=l+"/index.js";if(_subpackages[a]){var s=ral.loadSubpackage({name:a,success(){e.responseType="json",t=`${a}/config.${n?n+".":""}json`,cc.assetManager.downloader.downloadFile(t,e,e.onFileProgress,function(n,e){if(!n&&"string"==typeof e)try{e=JSON.parse(e)}catch(e){n=e}e&&(e.base=a+"/"),r&&r(n,e)})},fail(e){console.warn(`Load Subpackage failed: path: ${a} message: `+e.errMsg),r&&r(new Error(`Failed to load subpackage ${a}: `+e.errMsg))}});"function"==typeof e.onFileProgress&&s.onProgressUpdate(e.onFileProgress)}else{let s=null,i=0,o=null;_remoteBundles[a]&&(l=_server+a,t=`${l}/config.${n?n+".":""}json`,c="src/scripts/"+a+"/index.js"),_downloader.downloadFile(t,e,e.onFileProgress,function(e,n){if(e&&(o=e),"string"==typeof n)try{var a;(s=JSON.parse(n))&&s.isZip?(a=s.zipVersion,_handleZip(l,a,function(e,n){e?r&&r(e):(s.base=n+"/res/",2===++i&&r(o,s))})):(s&&(s.base=l+"/"),2===++i&&r(o,s))}catch(e){o=e}}),_downloader.downloadScript(c,e,function(e){e&&(o=e),2===++i&&r(o,s)})}}function _handleZip(a,e,s){var n={};let i=ral.env.USER_DATA_PATH+"/"+Date.now().toString(),o=a+`/res.${e?e+".":""}zip`;_zipCache[a]?n["If-Modified-Since"]=_zipCache[a].lastModifiedTime:n["If-Modified-Since"]=null,ral.downloadFile({url:o,header:n,filePath:i+".zip",success:function(n){200===n.statusCode?_fsm.unzip({zipFilePath:n.filePath,targetPath:i,success:function(){try{_fsm.unlinkSync(n.filePath),_zipCache[a]&&_fsm.rmdirSync(_zipCache[a].unZipTargetPath,!0);var e=(new Date).toUTCString();_zipCache[a]={unzipPath:i,lastModifiedTime:e},_fsm.writeFileSync(CACHED_FILE_PATH,JSON.stringify(_zipCache),"utf8")}catch(e){console.warn(e)}s&&s(null,i)},fail:function(e){console.warn("Unzip file failed: path: "+o),_fsm.unlinkSync(e.filePath),s&&s(new Error(e.errMsg),null)}}):304===n.statusCode?s&&s(null,_zipCache[a].unzipPath):(console.warn(`Download file failed: path: ${o} message: `+n.statusCode),s&&s(new Error(n.statusCode),null))},fail:function(e){console.warn(`Download file failed: path: ${o} message: `+e.statusCode),s&&s(new Error(e.errMsg),null)}})}cc.assetManager.init=function(e){if(e.subpackages&&e.subpackages.forEach(e=>_subpackages[e]=!0),e.remoteBundles&&e.remoteBundles.forEach(e=>_remoteBundles[e]=!0),_server=e.server+"/remote/",_originInit.apply(this,arguments),e.remoteBundles)try{var n=_fsm.readFileSync(CACHED_FILE_PATH,"utf8");_zipCache=JSON.parse(n)}catch(e){}},_downloader.register("bundle",downloadBundle);