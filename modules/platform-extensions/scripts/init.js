"use strict";const{existsSync,writeFileSync}=require("fs"),{readJSONSync,outputJSONSync}=require("fs-extra"),{join,relative,dirname}=require("path"),defaultConfig={};function fillConfig(n){let e=!1;return("string"!=typeof n.enginePath||defaultConfig.enginePath&&defaultConfig.enginePath!==n.enginePath)&&(n.enginePath=defaultConfig.enginePath||"",e=!0),e}process.argv.forEach(n=>{n=n.split("=");2<=n.length&&(defaultConfig[n[0].substr(2)]=n[1])});const configFile=join(__dirname,"../config.json");if(existsSync(configFile))try{const e=readJSONSync(configFile),f=fillConfig(e);f&&writeFileSync(configFile,JSON.stringify(e,null,4))}catch(n){console.error("config.json 格式错误，请检查文件内容"),console.error(n)}else{const h={};fillConfig(h),writeFileSync(configFile,JSON.stringify(h,null,4))}function initNativePackToolPath(){if(!defaultConfig.enginePath)throw new Error("请设置 enginePath 参数");const o=join(__dirname,"../extensions");["native","linux"].forEach(n=>{try{var e=join(o,n,"tsconfig.json"),i=readJSONSync(e);i.compilerOptions.paths["native-pack-tool"]=[relative(dirname(e),join(defaultConfig.enginePath,"scripts/native-pack-tool")).replace(/\\/g,"/")],outputJSONSync(e,i,{spaces:4})}catch(n){console.error("native-pack-tools 模块路径生成失败"),console.error(n)}})}async function initRepo(){var{initWorkflow:n,executeTask:e}=require("@creator/workflow"),i=(n({entry:"init.config.js",params:process.argv,cacheFile:join(__dirname,"../.temp/.cache-build.json"),cacheDir:join(__dirname,"../.temp"),workspaces:[join(__dirname,"./configs")]}),await e(["repo","npm"])),o=[];for(const t in i)for(const r of i[t])"error"===r&&o.push(r);o.length&&(console.log(["================================================================================","没有正确完成仓库初始化任务，请查看日志，并根据建议尝试修复"].join("\n")),console.log(["================================================================================"].join("\n")),process.exit(-1))}(async()=>{await initRepo(),initNativePackToolPath()})();