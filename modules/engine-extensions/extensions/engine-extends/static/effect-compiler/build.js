"use strict";const ps=require("path"),fs=require("fs-extra"),fsJetpack=require("fs-jetpack"),{Module:Module}=require("module"),editorRoot=ps.join(__dirname,"../../../../../../.."),options={engineRoot:"",shouldThrow:!1,noSource:!1,stripSpaces:!1,noOutput:!1,essentialOnly:!1,keepNewlines:!1,filesOrDirs:[]},argc=process.argv.length;for(let e=2;e<argc;e++){const n=process.argv[e];"--engine"===n&&e<argc-1?options.engineRoot=ps.resolve(process.argv[++e]):"--default-engine"===n?options.engineRoot="default":"--throw"===n?options.shouldThrow=!0:"--no-source"===n?options.noSource=!0:"--strip-spaces"===n?options.stripSpaces=!0:"--no-output"===n?options.noOutput=!0:"--essential-only"===n?options.essentialOnly=!0:n.startsWith("--keep-newlines")?options.keepNewlines=n.length>15?n.substring(16):"":options.filesOrDirs.push(n)}const defaultEngineRoot=ps.join(editorRoot,"resources/3d/engine"),cacheFile=ps.join(__dirname,"engine_root_cache.txt");options.engineRoot?("default"===options.engineRoot&&(options.engineRoot=defaultEngineRoot),fs.existsSync(options.engineRoot)&&fs.writeFileSync(cacheFile,options.engineRoot)):(fs.existsSync(cacheFile)&&(options.engineRoot=fs.readFileSync(cacheFile,"utf8")),options.engineRoot||(options.engineRoot=defaultEngineRoot)),console.log(`Editor location: ${editorRoot}`),(Module.createRequire||Module.createRequireFromPath)(ps.resolve(editorRoot,"app/index.js"))("cc/location").set(options.engineRoot),Object.assign(global,{Manager:{AssetInfo:{engine:options.engineRoot}},cc:{},CC_EDITOR:!1,CC_DEV:!1,CC_TEST:!1});const shdcLib=require(ps.join(editorRoot,"app/modules/engine-extensions/extensions/engine-extends/static/effect-compiler"));shdcLib.options.throwOnWarning=shdcLib.options.throwOnError=options.shouldThrow,shdcLib.options.noSource=options.noSource,shdcLib.options.skipParserTest=!0;const closure={dir:""},chunksDir={dir:ps.join(options.engineRoot,"editor/assets/chunks")};shdcLib.options.chunkSearchFn=(e=>{const n={name:void 0,content:void 0};for(let s=0;s<e.length;s++){const t=e[s];let i=ps.resolve(closure.dir,t+".chunk");if(fs.existsSync(i)||(i=ps.resolve(chunksDir.dir,t+".chunk"),fs.existsSync(i))){n.name=t,n.content=fs.readFileSync(i,{encoding:"utf-8"});break}}return n});const addChunks=e=>{const n=fsJetpack.find(e,{matching:"*.chunk",recursive:!1});for(let e=0;e<n.length;++e){const s=ps.basename(n[e],".chunk"),t=fs.readFileSync(n[e],{encoding:"utf8"});shdcLib.addChunk(s,t)}};addChunks(ps.join(options.engineRoot,"editor/assets/chunks"));const indent=(e,n)=>e.replace(/\n/g,"\n"+" ".repeat(n)),stringify=e=>JSON.stringify(e).replace(/([,{]|":)/g,"$1 ").replace(/([}])/g," $1"),stringifyArray=(e,n=stringify)=>{let s="";if(!e.length)return"[]";for(const t of e)s+=`  ${indent(n(t),2)},\n`;return`[\n${s.slice(0,-2)}\n]`},stringifySource=(()=>{const e=/\s*?\n\s*/g,n=/[\s\n]+/g,s=/\w/,t=(e,n,t)=>n&&s.test(t[n-1])&&s.test(t[n+e.length])?" ":"",i=(s,i)=>(options.stripSpaces&&(s=s.replace(n,t)),options.essentialOnly&&(s=s.replace(e,"\n")),i.includes(options.keepNewlines)?`\`${s}\``:`"${s.replace(/\n/g,"\\n")}"`);return(e,n)=>{let s="{\n";return s+=`  "vert": ${indent(i(e.vert,n+".vert"),4)},\n`,s+=`  "frag": ${indent(i(e.frag,n+".frag"),4)},\n`,s+="}"}})(),stringifyEffect=(()=>{const e=e=>`{"name": "${e.name}", "defines": ${stringify(e.defines)}, "binding": ${e.binding}, `+(e.descriptorType?'"descriptorType": '+e.descriptorType+", ":"")+`"stageFlags": ${e.stageFlags}, "members": ${stringifyArray(e.members)}}`,n=n=>{let s="",{name:t,hash:i,glsl4:r,glsl3:o,glsl1:a,builtins:c,defines:l,blocks:p,samplerTextures:u,buffers:d,images:f,textures:g,samplers:h,subpassInputs:y,attributes:m,varyings:b}=n;return s+="{\n",s+=`  "name": "${t}",\n`,s+=`  "hash": ${i},\n`,r&&(s+=`  "glsl4": ${indent(stringifySource(r,"glsl4"),2)},\n`),o&&(s+=`  "glsl3": ${indent(stringifySource(o,"glsl3"),2)},\n`),a&&(s+=`  "glsl1": ${indent(stringifySource(a,"glsl1"),2)},\n`),b&&(s+=`  "varyings": ${indent(stringifyArray(b),2)},\n`),s+='  "builtins": {\n',s+=`    "statistics": ${stringify(c.statistics)},\n`,s+=`    "globals": ${stringify(c.globals)},\n`,s+=`    "locals": ${stringify(c.locals)}\n`,s+="  },\n",s+=`  "defines": ${indent(stringifyArray(l),2)},\n`,s+=`  "attributes": ${indent(stringifyArray(m),2)},\n`,s+=`  "blocks": ${indent(stringifyArray(p,e),2)},\n`,s+=`  "samplerTextures": ${indent(stringifyArray(u),2)},\n`,s+=`  "buffers": ${indent(stringifyArray(d),2)},\n`,s+=`  "images": ${indent(stringifyArray(f),2)},\n`,s+=`  "textures": ${indent(stringifyArray(g),2)},\n`,s+=`  "samplers": ${indent(stringifyArray(h),2)},\n`,s+=`  "subpassInputs": ${indent(stringifyArray(y),2)}\n`,s+="}"};return e=>{options.essentialOnly&&shdcLib.stripEditorSupport(e);let s="";return s+="{\n",s+=`  "name": "${e.name}",\n`,s+=e._uuid?`  "_uuid": "${e._uuid}",\n`:"",s+=`  "techniques": ${indent(stringifyArray(e.techniques),2)},\n`,options.essentialOnly||(s+=`  "dependencies": ${indent(stringifyArray(e.dependencies),2)},\n`,e.editor&&(s+=`  "editor": ${indent(stringify(e.editor),2)},\n`)),s+=`  "shaders": ${indent(stringifyArray(e.shaders,n),2)}\n`,s+="}"}})(),addEssential=(()=>{const e={"pipeline/planar-shadow":{newName:"planar-shadow",techs:[]},"pipeline/skybox":{newName:"skybox",techs:[]},"pipeline/deferred-lighting":{newName:"deferred-lighting",techs:[]},"pipeline/bloom":{newName:"bloom",techs:[]},"pipeline/post-process":{newName:"post-process",techs:[]},"util/profiler":{newName:"profiler",techs:[]},"util/splash-screen":{newName:"splash-screen",techs:[]},"builtin-standard":{newName:"standard",techs:[0]},"builtin-unlit":{newName:"unlit",techs:[0]},"builtin-sprite":{newName:"sprite",techs:[]},"builtin-particle":{newName:"particle",techs:[0]},"builtin-particle-gpu":{newName:"particle-gpu",techs:[0]},"builtin-particle-trail":{newName:"particle-trail",techs:[0]},"builtin-billboard":{newName:"billboard",techs:[0]},"builtin-terrain":{newName:"terrain",techs:[0]},"builtin-graphics":{newName:"graphics",techs:[]},"builtin-clear-stencil":{newName:"clear-stencil",techs:[]},"builtin-spine":{newName:"spine",techs:[0]},"builtin-occlusion-query":{newName:"occlusion-query",techs:[0]},"builtin-geometry-renderer":{newName:"geometry-renderer",techs:[]}};return(n,s,t)=>{const i=e[s];if(void 0!==i){const e=Object.assign({},t);i.techs.length&&(e.techniques=i.techs.reduce((n,s)=>(n.push(e.techniques[s]),n),[]),e.shaders=e.shaders.filter(n=>e.techniques.some(e=>e.passes.some(e=>e.program===n.name)))),e.name=i.newName,e.shaders=e.shaders.map(e=>{const n=Object.assign({},e);return n.name=n.name.replace(s,i.newName),n}),e.techniques=e.techniques.map(e=>{const n=Object.assign({},e);return n.passes=n.passes.map(e=>{const n=Object.assign({},e);return n.program=n.program.replace(s,i.newName),n}),n}),n.push(e)}}})(),buildEffect=(e,n)=>{let s=null;if(options.shouldThrow)try{s=shdcLib.buildEffect(e,n)}catch(e){console.log(e)}else s=shdcLib.buildEffect(e,n);return s},output=(e,n)=>{options.noOutput||(fs.ensureDirSync(ps.dirname(e)),fs.writeFileSync(e,n,{encoding:"utf8"}),console.log(e+" saved."))};if(options.filesOrDirs.length){const e=e=>{try{return fs.lstatSync(e)}catch(n){console.error(e,"does not exist!")}return null},n=e=>{const n=ps.basename(e,".effect"),s=fs.readFileSync(e,{encoding:"utf8"});closure.dir=ps.dirname(e);const t=buildEffect(n,s);t&&output(ps.join(ps.dirname(e),`${n}.ts`),"/* eslint-disable */\n"+`export const effect = ${stringifyEffect(t)};\n`)};for(let s=0;s<options.filesOrDirs.length;s++){const t=options.filesOrDirs[s],i=e(t);i&&(i.isDirectory()?(addChunks(t),fsJetpack.find(t,{matching:"*.effect",recursive:!1}).forEach(e=>n(e))):(addChunks(ps.dirname(t)),n(t)))}process.exit()}const target=ps.join(options.engineRoot,"editor/assets"),files=fsJetpack.find(target,{matching:"**/*.effect"}),debugDir=ps.join(editorRoot,"effects.ts"),essentialDir=ps.join(options.engineRoot,"cocos/core/builtin/effects.ts"),shaderDir=ps.join(options.engineRoot,"cocos/core/builtin/shader-sources");let all=[],essentials=[];for(let e=0;e<files.length;++e){const n=ps.relative(ps.join(target,"effects"),ps.dirname(files[e])).replace(/\\/g,"/"),s=n+(n.length?"/":"")+ps.basename(files[e],".effect"),t=fs.readFileSync(files[e],{encoding:"utf8"}),i=buildEffect(s,t);i&&(all.push(i),addEssential(essentials,s,i,files[e]))}output(debugDir,`\nexport const effects = ${stringifyArray(all,stringifyEffect)};\n`),options.essentialOnly=!0;for(const e of["glsl4","glsl3","glsl1"]){const n=essentials.map(({shaders:n})=>n.map(n=>{const s=n[e]||null;return delete n[e],s})),s=n=>stringifyArray(n,n=>stringifySource(n,e));output(ps.join(shaderDir,`${e}.ts`),"/* eslint-disable */\n"+`export const ${e} = ${stringifyArray(n,s)};\n`)}output(essentialDir,"/* eslint-disable */\n// absolute essential effects\n"+`export const effects = ${stringifyArray(essentials,stringifyEffect)};\n`);