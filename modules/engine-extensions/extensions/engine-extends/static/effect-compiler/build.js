"use strict";const ps=require("path"),fs=require("fs-extra"),fsJetpack=require("fs-jetpack"),{Module:Module}=require("module"),editorRoot=ps.join(__dirname,"../../../../../../.."),options={engineRoot:"",shouldThrow:!1,noSource:!1,stripSpaces:!1,noOutput:!1,essentialOnly:!1,keepNewlines:!1,filesOrDirs:[]},argc=process.argv.length;for(let e=2;e<argc;e++){const s=process.argv[e];"--engine"===s&&e<argc-1?options.engineRoot=ps.resolve(process.argv[++e]):"--default-engine"===s?options.engineRoot="default":"--throw"===s?options.shouldThrow=!0:"--no-source"===s?options.noSource=!0:"--strip-spaces"===s?options.stripSpaces=!0:"--no-output"===s?options.noOutput=!0:"--essential-only"===s?options.essentialOnly=!0:s.startsWith("--keep-newlines")?options.keepNewlines=s.length>15?s.substring(16):"":options.filesOrDirs.push(s)}const defaultEngineRoot=ps.join(editorRoot,"resources/3d/engine"),cacheFile=ps.join(__dirname,"engine_root_cache.txt");options.engineRoot?("default"===options.engineRoot&&(options.engineRoot=defaultEngineRoot),fs.existsSync(options.engineRoot)&&fs.writeFileSync(cacheFile,options.engineRoot)):(fs.existsSync(cacheFile)&&(options.engineRoot=fs.readFileSync(cacheFile,"utf8")),options.engineRoot||(options.engineRoot=defaultEngineRoot)),console.log(`Editor location: ${editorRoot}`),Object.assign(global,{Manager:{AssetInfo:{engine:options.engineRoot}},cc:{},CC_EDITOR:!1,CC_DEV:!1,CC_TEST:!1});const{default:preload}=(Module.createRequire||Module.createRequireFromPath)(ps.resolve(editorRoot,"app/index.js"))("cc/preload");function main(){const e=require(ps.join(editorRoot,"app/modules/engine-extensions/extensions/engine-extends/static/effect-compiler"));e.options.throwOnWarning=e.options.throwOnError=options.shouldThrow,e.options.noSource=options.noSource,e.options.skipParserTest=!0;const s={dir:""},n={dir:ps.join(options.engineRoot,"editor/assets/chunks")};e.options.chunkSearchFn=(e=>{const t={name:void 0,content:void 0};for(let o=0;o<e.length;o++){const i=e[o];let r=ps.resolve(s.dir,i+".chunk");if(fs.existsSync(r)||(r=ps.resolve(n.dir,i+".chunk"),fs.existsSync(r))){t.name=i,t.content=fs.readFileSync(r,{encoding:"utf-8"});break}}return t});const t=s=>{const n=fsJetpack.find(s,{matching:"*.chunk",recursive:!1});for(let s=0;s<n.length;++s){const t=ps.basename(n[s],".chunk"),o=fs.readFileSync(n[s],{encoding:"utf8"});e.addChunk(t,o)}};t(ps.join(options.engineRoot,"editor/assets/chunks"));const o=(e,s)=>e.replace(/\n/g,"\n"+" ".repeat(s)),i=e=>JSON.stringify(e).replace(/([,{]|":)/g,"$1 ").replace(/([}])/g," $1"),r=(e,s=i)=>{let n="";if(!e.length)return"[]";for(const t of e)n+=`  ${o(s(t),2)},\n`;return`[\n${n.slice(0,-2)}\n]`},l=(()=>{const e=/\s*?\n\s*/g,s=/[\s\n]+/g,n=/\w/,t=(e,s,t)=>s&&n.test(t[s-1])&&n.test(t[s+e.length])?" ":"",i=(n,o)=>(options.stripSpaces&&(n=n.replace(s,t)),options.essentialOnly&&(n=n.replace(e,"\n")),o.includes(options.keepNewlines)?`\`${n}\``:`"${n.replace(/\n/g,"\\n")}"`);return(e,s)=>{let n="{\n";return n+=`  "vert": ${o(i(e.vert,s+".vert"),4)},\n`,n+=`  "frag": ${o(i(e.frag,s+".frag"),4)},\n`,n+="}"}})(),c=(()=>{const s=e=>`{"name": "${e.name}", "defines": ${i(e.defines)}, "binding": ${e.binding}, `+(e.descriptorType?'"descriptorType": '+e.descriptorType+", ":"")+`"stageFlags": ${e.stageFlags}, "members": ${r(e.members)}}`,n=e=>{let n="";const{name:t,hash:c,glsl4:a,glsl3:p,glsl1:u,builtins:d,defines:g,blocks:f,samplerTextures:h,buffers:b,images:m,textures:$,samplers:y,subpassInputs:R,attributes:x,varyings:S}=e;return n+="{\n",n+=`  "name": "${t}",\n`,n+=`  "hash": ${c},\n`,a&&(n+=`  "glsl4": ${o(l(a,"glsl4"),2)},\n`),p&&(n+=`  "glsl3": ${o(l(p,"glsl3"),2)},\n`),u&&(n+=`  "glsl1": ${o(l(u,"glsl1"),2)},\n`),S&&(n+=`  "varyings": ${o(r(S),2)},\n`),n+='  "builtins": {\n',n+=`    "statistics": ${i(d.statistics)},\n`,n+=`    "globals": ${i(d.globals)},\n`,n+=`    "locals": ${i(d.locals)}\n`,n+="  },\n",n+=`  "defines": ${o(r(g),2)},\n`,n+=`  "attributes": ${o(r(x),2)},\n`,n+=`  "blocks": ${o(r(f,s),2)},\n`,n+=`  "samplerTextures": ${o(r(h),2)},\n`,n+=`  "buffers": ${o(r(b),2)},\n`,n+=`  "images": ${o(r(m),2)},\n`,n+=`  "textures": ${o(r($),2)},\n`,n+=`  "samplers": ${o(r(y),2)},\n`,n+=`  "subpassInputs": ${o(r(R),2)}\n`,n+="}"};return s=>{options.essentialOnly&&e.stripEditorSupport(s);let t="";return t+="{\n",t+=`  "name": "${s.name}",\n`,t+=s._uuid?`  "_uuid": "${s._uuid}",\n`:"",t+=`  "techniques": ${o(r(s.techniques),2)},\n`,options.essentialOnly||(t+=`  "dependencies": ${o(r(s.dependencies),2)},\n`,s.editor&&(t+=`  "editor": ${o(i(s.editor),2)},\n`)),t+=`  "shaders": ${o(r(s.shaders,n),2)}\n`,t+="}"}})(),a=(()=>{const e={"pipeline/planar-shadow":{techs:[]},"pipeline/skybox":{techs:[]},"pipeline/deferred-lighting":{techs:[]},"pipeline/bloom":{techs:[]},"pipeline/post-process":{techs:[]},"util/profiler":{techs:[]},"util/splash-screen":{techs:[]},"builtin-standard":{techs:[0]},"builtin-unlit":{techs:[0]},"builtin-sprite":{techs:[]},"builtin-particle":{techs:[0]},"builtin-particle-gpu":{techs:[0]},"builtin-particle-trail":{techs:[0]},"builtin-billboard":{techs:[0]},"builtin-terrain":{techs:[0]},"builtin-graphics":{techs:[]},"builtin-clear-stencil":{techs:[]},"builtin-spine":{techs:[0]},"builtin-occlusion-query":{techs:[0]},"builtin-geometry-renderer":{techs:[]},"builtin-debug-renderer":{techs:[0]}};return(s,n,t)=>{const o=e[n];if(void 0!==o){const e=Object.assign({},t);o.techs.length&&(e.techniques=o.techs.reduce((s,n)=>(s.push(e.techniques[n]),s),[]),e.shaders=e.shaders.filter(s=>e.techniques.some(e=>e.passes.some(e=>e.program===s.name)))),e.shaders=e.shaders.map(e=>{return Object.assign({},e)}),e.techniques=e.techniques.map(e=>{const s=Object.assign({},e);return s.passes=s.passes.map(e=>{return Object.assign({},e)}),s}),s.push(e)}}})(),p=(s,n)=>{let t=null;if(options.shouldThrow)try{t=e.buildEffect(s,n)}catch(e){console.log(e)}else t=e.buildEffect(s,n);return t},u=(e,s)=>{options.noOutput||(fs.ensureDirSync(ps.dirname(e)),fs.writeFileSync(e,s,{encoding:"utf8"}),console.log(e+" saved."))};if(options.filesOrDirs.length){const e=e=>{try{return fs.lstatSync(e)}catch(s){console.error(e,"does not exist!")}return null},n=e=>{const n=ps.basename(e,".effect"),t=fs.readFileSync(e,{encoding:"utf8"});s.dir=ps.dirname(e);const o=p(n,t);o&&u(ps.join(ps.dirname(e),`${n}.ts`),"/* eslint-disable */\n"+`export const effect = ${c(o)};\n`)};for(let s=0;s<options.filesOrDirs.length;s++){const o=options.filesOrDirs[s],i=e(o);i&&(i.isDirectory()?(t(o),fsJetpack.find(o,{matching:"*.effect",recursive:!1}).forEach(e=>n(e))):(t(ps.dirname(o)),n(o)))}process.exit()}const d=ps.join(options.engineRoot,"editor/assets"),g=fsJetpack.find(d,{matching:"**/*.effect"}),f=ps.join(editorRoot,"effects.ts"),h=ps.join(options.engineRoot,"test/fixtures/builtin-effects.ts"),b=ps.join(options.engineRoot,"test/fixtures/builtin-glsl4.ts"),m=[],$=[];for(let e=0;e<g.length;++e){const s=ps.relative(ps.join(d,"effects"),ps.dirname(g[e])).replace(/\\/g,"/"),n=s+(s.length?"/":"")+ps.basename(g[e],".effect"),t=fs.readFileSync(g[e],{encoding:"utf8"}),o=p(n,t);o&&(m.push(o),a($,n,o,g[e]))}u(f,`\nexport const effects = ${r(m,c)};\n`),options.essentialOnly=!0;const y=$.map(({shaders:e})=>e.map(e=>{const s=e.glsl4||null;return delete e.glsl4,s}));u(b,"/* eslint-disable */\n"+`export const glsl4 = ${r(y,e=>r(e,e=>l(e,version)))};\n`),u(h,"/* eslint-disable */\n// absolute essential effects\n"+`export const effects = ${r($,c)};\n`)}(async()=>{await preload({root:options.engineRoot,editorExtensions:!1,requiredModules:["cc/editor/offline-mappings"]}),main()})().catch(e=>{console.error(e)});