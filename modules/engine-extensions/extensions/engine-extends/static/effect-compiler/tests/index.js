const ps=require("path"),fs=require("fs"),fsJetpack=require("fs-jetpack"),{Module:Module}=require("module"),editorRoot=ps.resolve(__dirname,"../../../../../../../.."),engineRoot=ps.join(editorRoot,"resources/3d/engine");Object.assign(global,{Manager:{AssetInfo:{engine:engineRoot}},cc:{},CC_EDITOR:!1,CC_DEV:!1,CC_TEST:!1}),(Module.createRequire||Module.createRequireFromPath)(ps.resolve(editorRoot,"app","index.js"))("cc/location").set(engineRoot);const shdcLib=require(ps.resolve(__dirname,".."));shdcLib.options.noSource=!0,shdcLib.options.throwOnWarning=!0,shdcLib.options.skipParserTest=!0;const errorTests=()=>{const e=/EFX\d\d\d\d/i,r=/\/\/\s*@efx-([\w-]*)/g;return fsJetpack.find(ps.resolve(__dirname,"./errors"),{matching:"*.effect",recursive:!1}).reduce((c,s)=>{const t=ps.basename(s,".effect"),n=fs.readFileSync(s,{encoding:"utf8"});r.lastIndex=0;let o=r.exec(n);for(;o;){switch(o[1]){case"no-check":return c}o=r.exec(n)}try{shdcLib.buildEffect(t,n),c.push(`no error reported from ${t}`)}catch(r){"string"==typeof r&&2===r.match(new RegExp(t.match(e)[0],"g")).length||c.push(r)}return c},[])},featureTests=()=>{const spacesRE=/[\s\n]+/g,identifierRE=/\w/,replacer=(e,r,c)=>r&&identifierRE.test(c[r-1])&&identifierRE.test(c[r+e.length])?" ":"",checkRE=/\/\/\s*@check(.*)/g,objEquals=(e,r)=>Array.isArray(r)?r.every((r,c)=>e&&objEquals(e[c],r)):"object"==typeof r?Object.keys(r).every(c=>e&&objEquals(e[c],r[c])):e===r,{UniformBinding:UniformBinding}=shdcLib.mappings;return fsJetpack.find(__dirname,{matching:"*.effect",recursive:!1}).reduce((acc,file)=>{const name=ps.basename(file,".effect"),content=fs.readFileSync(file,{encoding:"utf8"});try{const effect=shdcLib.buildEffect(name,content);for(const e of effect.shaders)e.glsl1.vert=e.glsl1.vert.replace(spacesRE,replacer),e.glsl1.frag=e.glsl1.frag.replace(spacesRE,replacer),e.glsl3.vert=e.glsl3.vert.replace(spacesRE,replacer),e.glsl3.frag=e.glsl3.frag.replace(spacesRE,replacer),e.glsl4.vert=e.glsl4.vert.replace(spacesRE,replacer),e.glsl4.frag=e.glsl4.frag.replace(spacesRE,replacer);checkRE.lastIndex=0;let count=1,cap=checkRE.exec(content);for(;cap;)eval(cap[1])||acc.push(`${name}.effect check #${count} failed`),cap=checkRE.exec(content),count++}catch(e){acc.push(e)}return acc},[])};errorTests().forEach(e=>console.log(e)),featureTests().forEach(e=>console.log(e));