"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,s)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var s=function(e){return(s=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=s(e),a=0;a<r.length;a++)"default"!==r[a]&&__createBinding(t,e,r[a]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpineHandler=void 0;const asset_db_1=require("@editor/asset-db"),path=__importStar(require("path")),fs=__importStar(require("fs")),fse=__importStar(require("fs-extra")),ATLAS_EXTS=[".atlas",".txt",".atlas.txt",""],cc_1=require("cc"),utils_1=require("../utils");function searchAtlas(s,n){var e=path.extname(s);s=s.substr(0,s.length-e.length),function t(r){var e=ATLAS_EXTS[r];const a=s+e;fs.exists(a,e=>{if(e)return n(null,a);r+1<ATLAS_EXTS.length?t(r+1):n(null,void 0)})}(0)}function loadAtlasText(t,a){searchAtlas(t.source,(e,r)=>{if(e)return a(e,null);r?fs.readFile(r,{encoding:"utf8"},(e,t)=>{a(e,{path:r,content:t})}):a(new Error(`The atlas with the same name is not found. Select the {asset[${t.basename}${t.extname}](${t.uuid})} asset and add it manually in the attribute inspector.`),null)})}class TextureParser{asset;atlasPath;texturesUUID;textureNames;constructor(e,t){this.atlasPath=t,this.texturesUUID=[],this.textureNames=[],this.asset=e,this.asset.depend(t)}load(e){var t=path.basename(e),r=path.dirname(this.atlasPath),r=path.resolve(r,t),t=(0,asset_db_1.queryAsset)(r);return t?(t=t.uuid+"@6c48a",this.asset.depend(t),console.log(`UUID is initialized for ${r}.`),this.texturesUUID.push(t),this.textureNames.push(e)):fs.existsSync(r)?console.warn(`WARN: UUID not yet initialized for "${r}".`):console.error(`Can not find texture "${e}" for atlas "${this.atlasPath}"`),null}}const scale=1;function parserAtlas(e,t){var r=new TextureParser(e,t.path),a=t.content.split("\n");if(!a||a.length<1)throw new Error(`Failed to load atlas file: "${t.path}"`);let s=null;for(let e=0;e<a.length;e++){var n=a[e].trim();0===n.length?s=null:s||(s=n,r.load(s))}return{textures:r.texturesUUID.map(e=>EditorExtends.serialize.asAsset(e,cc_1.Texture2D)),textureNames:r.textureNames,atlasText:t.content,atlasUuid:(0,asset_db_1.queryUUID)(t.path)}}function saveToLibrary(t,e,r,a,s){if(r)try{var n=parserAtlas(t,r);e.textures=n.textures,e.textureNames=n.textureNames,e.atlasText=n.atlasText,t.userData.atlasUuid=n.atlasUuid}catch(e){s(e)}const i=EditorExtends.serialize(e);t.saveToLibrary(".json",i).then(()=>{var e=(0,utils_1.getDependUUIDList)(i);t.setData("depends",e),a(!0)},s)}function initTexture(n,i){return new Promise((r,a)=>{var e=n.userData;if(e.atlasUuid){const s=(0,asset_db_1.queryAsset)(e.atlasUuid);s?fs.readFile(s.source,{encoding:"utf8"},(e,t)=>{t={path:s.source,content:t};saveToLibrary(n,i,t,r,a)}):a(new Error("Failed to load atlas file by uuid: "+e.atlasUuid))}else loadAtlasText(n,(e,t)=>{if(e)return a(e);saveToLibrary(n,i,t,r,a)})})}async function importJson(e){var t=e.source,t=await fse.readFile(t,{encoding:"utf8"});let r;try{r=JSON.parse(t)}catch(e){return console.error(e),!1}t=new cc_1.sp.SkeletonData;return t.name=e.basename||"",t.skeletonJson=r,t.scale=scale,initTexture(e,t)}async function importBinary(e){await e.copyToLibrary(".bin",e.source);e.source;var t=new cc_1.sp.SkeletonData;return t.name=e.basename||"",t._setRawAsset(".bin"),t.scale=scale,initTexture(e,t)}exports.SpineHandler={name:"spine-data",assetType:"sp.SkeletonData",async validate(e){e=e.source;if(e.endsWith(".skel"))return!0;let t;var e=fs.readFileSync(e,"utf8"),r=e.slice(0,30);if(0<r.indexOf("slots")||0<r.indexOf("skins")||0<r.indexOf("events")||0<r.indexOf("animations")||0<r.indexOf("bones")||0<r.indexOf("skeleton")||0<r.indexOf('"ik"')){try{t=JSON.parse(e)}catch(e){return!1}return Array.isArray(t.bones)}return!1},importer:{version:"1.2.7",async import(e){return(e.source.endsWith(".skel")?importBinary:importJson)(e)}}},exports.default=exports.SpineHandler;