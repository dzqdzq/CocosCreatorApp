"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.walk=walk,exports.walkAsync=walkAsync,exports.getComponent=getComponent,exports.walkNode=walkNode,exports.walkNodeAsync=walkNodeAsync,exports.getPrefabOfNode=getPrefabOfNode,exports.isNestedPrefab=isNestedPrefab,exports.walkPrefabInstances=walkPrefabInstances;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),fs_1=require("fs");function walk(e,_){if(Array.isArray(e))for(const n of e)walk(n,_);else if(e&&"object"==typeof e)if("__uuid__"in e)_(e);else for(const t of Object.values(e))walk(t,_)}async function walkAsync(e,_){if(Array.isArray(e))for(const n of e)await walk(n,_);else if(e&&"object"==typeof e)if("__uuid__"in e)await _(e);else for(const t of Object.values(e))await walk(t,_)}function getComponent(e,_,n){if(!("number"!=typeof _||_<0))for(const a of e[_]._components){var t=e[a.__id__];if(n.test(t.__type__))return t}return null}function walkNode(_,e,n){var t;!e||"number"!=typeof e.__id__||e.__id__<0||(t=_[e.__id__],n(t,e),t._children&&t._children.forEach(e=>{walkNode(_,e,n)}))}async function walkNodeAsync(_,e,n){if(e&&"number"==typeof e.__id__&&!(e.__id__<0)){var t=_[e.__id__];if(await n(t,e),t._children)for(let e=0;e<t._children.length;e++)await walkNodeAsync(_,t._children[e],n)}}function getPrefabOfNode(e,_){if(e&&_[e]){e=_[e];if(e&&"cc.Node"===e.__type__){e=e._prefab?.__id__;if(e&&_[e])return _[e]}}}function isNestedPrefab(e,_,n){return!(!e?._prefab?.__id__||!_[e._prefab.__id__]?.asset?.__uuid__)&&_[e._prefab.__id__]?.asset?.__uuid__!==n}const walkPrefabInstanceChildren=async function(_,n,t,a,s){for(let e=0;e<_.length;e++){var o=_[e];await walkNodeAsync(n,o,async(e,_)=>{isNestedPrefab(e,n,s)?await walkPrefabInstances(e,n,t,a):(a(e),e._components&&e._components.forEach(e=>{e=n[e.__id__];e&&a(e)}))})}};async function walkPrefabInstances(e,n,t,a){if(e?._prefab?.__id__){a(e,n);var e=n[e._prefab.__id__],s=e?.asset?.__uuid__;if(s){var o=(0,asset_db_1.queryAsset)(s);if(o&&o.source){let _=[],e;if(e=o.source.includes("@")?(o.init||(o._assetDB.taskManager.pause(t.task),await o.waitInit(),o._assetDB.taskManager.resume(t.task)),o.library+".json"):o.source,(0,fs_1.existsSync)(e))try{_=(0,fs_extra_1.readJSONSync)(e)}catch(e){console.warn(e)}if(!_[0]||!_[0]?.data?.__id__)return;o=_[_[0].data.__id__];o?._children&&await walkPrefabInstanceChildren(o._children,_,t,a,s),o?._components&&o._components.forEach(e=>{e=_[e.__id__];e&&a(e)})}o=e?.instance?.__id__;if(o&&n[o]){e=n[o];if(e.mountedChildren&&0<e.mountedChildren.length){const r=[];e.mountedChildren.forEach(e=>{e=n[e.__id__];if(e&&e.nodes)for(const _ of e.nodes)r.push(_)}),await walkPrefabInstanceChildren(r,n,t,a,s)}e.mountedComponents&&0<e.mountedComponents.length&&e.mountedComponents.forEach(e=>{e=n[e.__id__];if(e&&e.components)for(const _ of e.components)_.__id__&&n[_.__id__]&&a(n[_.__id__])})}}}}