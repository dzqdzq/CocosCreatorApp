"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var i=function(e){return(i=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&__createBinding(t,e,r[a]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImageHandler=void 0;const DataURI=__importStar(require("@cocos/data-uri")),fs_extra_1=__importStar(require("fs-extra")),path_1=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),image_mics_1=require("../image/image-mics"),uri_utils_1=require("../utils/uri-utils"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),match_image_type_pattern_1=require("../utils/match-image-type-pattern"),image_mime_type_to_ext_1=require("../utils/image-mime-type-to-ext"),base64_1=require("../utils/base64"),cc_1=require("cc"),utils_2=require("../../utils"),utils_3=require("../image/utils");function resolveImageDataURI(e){var t;if(e.base64&&e.mediaType&&"image"===e.mediaType.type)return t=(0,base64_1.decodeBase64ToArrayBuffer)(e.data),{data:Buffer.from(t),mimeType:e.mediaType.value};throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for image.`)}exports.GltfImageHandler={name:"gltf-embeded-image",assetType:"cc.ImageAsset",iconInfo:{default:utils_3.defaultIconConfig,generateThumbnail(e){return{type:"image",value:e.library+e.getData("imageExtName")}}},importer:{version:"1.0.3",async import(i){if(!i.parent)return!1;var r=i.userData.gltfIndex,a=await reader_manager_1.glTfReaderManager.getOrCreate(i.parent);const s=a.gltf.images[r];let n;var r=async t=>{try{var e=url_1.default.fileURLToPath(t),r=await fs_extra_1.default.readFile(e),a=(0,match_image_type_pattern_1.matchImageTypePattern)(r);n={data:r,mimeType:a,extName:path_1.default.extname(e)}}catch(e){console.error((0,utils_1.i18nTranslate)("engine-extends.importers.glTF.failed_to_load_image",{url:t,reason:e}),(0,utils_1.linkToAssetTarget)(i.uuid))}},u=i.getSwapSpace().resolved;if(u)await r(url_1.default.pathToFileURL(u).href);else if(void 0!==s.bufferView)n={data:a.readImageInBufferView(a.gltf.bufferViews[s.bufferView])};else if(void 0!==s.uri){const t=a.path;u=e=>{console.error(`The uri "${s.uri}" provided by model file${t} is not correct: `+e)};if(s.uri.startsWith("data:"))try{var o=DataURI.parse(s.uri);if(!o)throw new Error(`Unable to parse data uri "${s.uri}"`);n=resolveImageDataURI(o)}catch(e){u(e)}else{o=a.path;let t;try{var l=url_1.default.pathToFileURL(o).toString();let e=new urijs_1.default(s.uri);e=e.absoluteTo(l),(0,uri_utils_1.convertsEncodedSeparatorsInURI)(e),t=e.toString()}catch(e){u(e)}t&&(t.startsWith("file://")?await r(t):console.error((0,utils_1.i18nTranslate)("engine-extends.importers.glTF.image_uri_should_be_file_url"),(0,utils_1.linkToAssetTarget)(i.uuid)))}}a=new cc_1.ImageAsset;if(n){let e;o=s.mimeType??n.mimeType;if(!(e=(e=o?(0,image_mime_type_to_ext_1.imageMimeTypeToExt)(o):e)||n.extName))throw new Error("Unknown image type");let t=n.data;if(".tga"===e.toLowerCase()){l=await(0,image_mics_1.convertTGA)(t);if(l instanceof Error||!l)return console.error((0,utils_1.i18nTranslate)("engine-extends.importers.glTF.failed_to_convert_tga"),(0,utils_1.linkToAssetTarget)(i.uuid)),!1;e=l.extName,t=l.data}else if(".psd"===e.toLowerCase()){u=await(0,image_mics_1.convertPSD)(t);({extName:e,data:t}=u)}else if(".exr"===e.toLowerCase()){r=(0,path_1.join)(i.temp,"image"+e),o=(await(0,fs_extra_1.outputFile)(r,t),await(0,image_mics_1.convertHDROrEXR)(e,r,i.uuid,i.temp));if(o instanceof Error||!o)return console.error((0,utils_1.i18nTranslate)("engine-extends.importers.glTF.failed_to_convert_tga"),(0,utils_1.linkToAssetTarget)(i.uuid)),!1;e=o.extName,t=o.source}a._setRawAsset(e),i.userData.fixAlphaTransparencyArtifacts=!0,t=await(0,utils_3.handleImageUserData)(i,t,e),await i.saveToLibrary(e,t),i.setData("imageExtName",e)}l=EditorExtends.serialize(a),await i.saveToLibrary(".json",l),u=(0,utils_2.getDependUUIDList)(l);return i.setData("depends",u),!0}}},exports.default=exports.GltfImageHandler;