"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.glTfReaderManager=void 0;const utils_1=require("../../utils"),gltf_converter_1=require("../utils/gltf-converter"),validation_1=require("./validation"),fs_extra_1=__importDefault(require("fs-extra")),gltf_1=require("../gltf"),fbx_1=require("../fbx");class GlTfReaderManager{_map=new Map;async getOrCreate(e,r=!1){let t=this._map.get(e.uuid);if(!t){var{converter:n,referencedBufferFiles:a}=await createGlTfReader(e);if(t=n,this._map.set(e.uuid,t),r)for(const s of a)e.depend(s)}return t}delete(e){this._map.delete(e.uuid)}}async function createGlTfReader(i){let e;var r=await(e=("fbx"===i.meta.importer?fbx_1:gltf_1).getGltfFilePath)(i);const t=r!==i.source;var n=i.userData;void 0===n.skipValidation||n.skipValidation||await(0,validation_1.validateGlTf)(r,i.source);const{glTF:a,buffers:s}=await(0,gltf_converter_1.readGltf)(r),l=[];n=await Promise.all(s.map(async e=>Buffer.isBuffer(e)?e:(t||l.push(e),fs_extra_1.default.readFile(e))));function o(r,t){if(Array.isArray(a[r])){let e;switch(r){case"meshes":e="engine-extends.importers.glTF.glTF_asset_group_mesh";break;case"animations":e="engine-extends.importers.glTF.glTF_asset_group_animation";break;case"nodes":e="engine-extends.importers.glTF.glTF_asset_group_node";break;case"skins":e="engine-extends.importers.glTF.glTF_asset_group_skin";break;case"samplers":e="engine-extends.importers.glTF.glTF_asset_group_sampler";break;default:e=r}var n=a[r][t];return"string"==typeof n.name&&n.name?(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.glTF_asset",{group:(0,utils_1.i18nTranslate)(e),name:n.name,index:t}):(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.glTF_asset_no_name",{group:(0,utils_1.i18nTranslate)(e),index:t})}return""}return{converter:new gltf_converter_1.GltfConverter(a,n,r,{logger:(e,r,t)=>{let n;switch(r){case gltf_converter_1.GltfConverter.ConverterError.UnsupportedAlphaMode:var a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.unsupported_alpha_mode",{material:o("materials",a.material),mode:a.mode});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedTextureParameter:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.unsupported_texture_parameter",{sampler:"",texture:o("textures",a.texture),type:(0,utils_1.i18nTranslate)("minFilter"===a.type?"engine-extends.importers.glTF.min_filter":"magFilter"===a.type?"engine-extends.importers.glTF.mag_filter":"engine-extends.importers.glTF.wrapMode"),value:""});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedChannelPath:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.unsupported_channel_path",{animation:o("animations",a.animation),channel:a.channel,path:a.path});break;case gltf_converter_1.GltfConverter.ConverterError.ReferenceSkinInDifferentScene:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.reference_skin_in_different_scene",{node:o("nodes",a.node),skin:o("skins",a.skin)});break;case gltf_converter_1.GltfConverter.ConverterError.DisallowCubicSplineChannelSplit:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.disallow_cubic_spline_channel_split",{animation:o("animations",a.animation),channel:a.channel});break;case gltf_converter_1.GltfConverter.ConverterError.FailedToCalculateTangents:a=t;n=(0,utils_1.i18nTranslate)("normal"===a.reason?"engine-extends.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_normals":"engine-extends.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_uvs",{mesh:o("meshes",a.mesh),primitive:a.primitive});break;case gltf_converter_1.GltfConverter.ConverterError.EmptyMorph:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.empty_morph",{mesh:o("meshes",a.mesh),primitive:a.primitive});break;case gltf_converter_1.GltfConverter.ConverterError.UnsupportedExtension:a=t;n=(0,utils_1.i18nTranslate)("engine-extends.importers.glTF.unsupported_extension",{name:a.name})}var s=(0,utils_1.linkToAssetTarget)(i.uuid);switch(e){case gltf_converter_1.GltfConverter.LogLevel.Info:default:console.log(n,s);break;case gltf_converter_1.GltfConverter.LogLevel.Warning:console.warn(n,s);break;case gltf_converter_1.GltfConverter.LogLevel.Error:console.error(n,s);break;case gltf_converter_1.GltfConverter.LogLevel.Debug:console.debug(n,s)}},userData:i.userData,promoteSingleRootNode:i.userData?.promoteSingleRootNode??!1,generateLightmapUVNode:i.userData?.generateLightmapUVNode??!1}),referencedBufferFiles:l}}exports.glTfReaderManager=new GlTfReaderManager;