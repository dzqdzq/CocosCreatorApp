"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,s)}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.dumpMaterial=exports.GltfMaterialHandler=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("../utils/load-asset-sync"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),url_1=require("url");function createMaterial(e,t,a,r){return t.createMaterial(e,a,e=>{e=(0,asset_db_1.queryUUID)(e);return(0,load_asset_sync_1.loadAssetSync)(e,cc.EffectAsset)},{useVertexColors:r.useVertexColors,depthWriteInAlphaModeBlend:r.depthWriteInAlphaModeBlend,smartMaterialEnabled:r.fbx?.smartMaterialEnabled??!1})}async function dumpMaterial(e,t,a,r,s){var i=e.userData;let n=null;i.materialDumpDir&&!(n=(0,asset_db_1.queryPath)(i.materialDumpDir))&&console.warn("The specified dump directory of materials is not valid. Default directory is used."),n||(n=path_1.default.join(path_1.default.dirname(e.source),"Materials_"+e.basename),i.materialDumpDir=await(0,asset_db_1.queryUrl)(n)),fs_extra_1.default.ensureDirSync(n);s=path_1.default.join(n,s.replace(/[\/:*?"<>|]/g,"-")),fs_extra_1.default.existsSync(s)||(r=createMaterial(r,a,t,i),a=EditorExtends.serialize(r),fs_extra_1.default.writeFileSync(s,a)),(findAssetDB(i.materialDumpDir)||e._assetDB).refresh(s),t=(0,asset_db_1.queryUrl)(s);if(t){r=(0,asset_db_1.queryUUID)(t);if(r&&"string"==typeof r)return r}return e.depend(s),null}function findAssetDB(e){return e&&(e=(0,url_1.parse)(e)).host?Manager.assetDBManager.assetDBMap[e.host]:null}exports.GltfMaterialHandler={name:"gltf-material",assetType:"cc.Material",instantiation:".material",importer:{version:"1.0.14",async import(e){if(!e.parent)return!1;if(e.parent.meta?.userData?.materials){var t=e.parent.meta.userData.materials[e.uuid];if(t){console.log("importer: Reuse previously edited material data. "+e.uuid);const r=JSON.stringify(t),s=(await e.saveToLibrary(".json",r),(0,utils_1.getDependUUIDList)(r));return e.setData("depends",s),!0}}var t=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),a=e.parent.userData,t=createMaterial(e.userData.gltfIndex,t,new asset_finder_1.DefaultGltfAssetFinder(a.assetFinder),a);const r=EditorExtends.serialize(t),s=(await e.saveToLibrary(".json",r),(0,utils_1.getDependUUIDList)(r));return e.setData("depends",s),!0}},createInfo:{async save(t,e){var t=t.uuid,[a]=t.split("@");if(!e||Buffer.isBuffer(e))throw new Error(""+Editor.I18n.t("asset-db.saveAssetMeta.fail.content"));var r=Manager.assetManager.queryAssetMeta(a);r.userData.materials&&"object"==typeof r.userData.materials||(r.userData.materials={});try{r.userData.materials[t]="string"==typeof e?JSON.parse(e):e,await Manager.assetManager.saveAssetMeta(a,r)}catch(e){return console.error(`Save materials({asset(${t})} data to fbx {asset(${a})} failed!`),console.error(e),!1}return!0}}},exports.default=exports.GltfMaterialHandler,exports.dumpMaterial=dumpMaterial;