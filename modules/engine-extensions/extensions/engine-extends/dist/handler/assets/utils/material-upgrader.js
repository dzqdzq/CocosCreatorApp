"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.upgradeProperties=upgradeProperties;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),auxMap={x:"r",y:"g",z:"b",w:"a",r:"x",g:"y",b:"z",a:"w"};function getVectorComponent(e,r){var t=e[r],e=e[auxMap[r]];return void 0!==t?t:void 0!==e?e:0}const idxMap=["x","y","z","w"];function serializeAsVector(e){const t={__type__:"cc.Vec"+e.length};return e.forEach((e,r)=>t[idxMap[r]]=e),t}const defineRE=/<\s*(\w+)\s*(?:\|\s*(\w+))?\s*>/g,targetRE=/(\w+)\s*(?:\.\s*([xyzw]+|[rgba]+))?/i;function handleFormerlySerializedAs(e,r,t,s,o){let i=defineRE.exec(s),a=!1;for(i&&i[0].length>=s.length-1&&(a=!0);i;){var n=r[i[1]]||i[2]||"",d=i.index,l=i.index+i[0].length;s=s.substring(0,d)+n+s.substring(l),defineRE.lastIndex=0,i=defineRE.exec(s)}var c,p=targetRE.exec(s);if(!p)return console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1;if(!s.endsWith("!")&&void 0!==e[t])return!1;if(a)return e[t]!==s&&(e[t]=s,!0);const f=e[p[1]];return void 0!==f&&((c=p[2]&&p[2].toLowerCase()||"")&&"object"!=typeof f?(console.warn(`formerlySerializedAs: '${s}' expected an object, get ${typeof f} in ${o}, upgrade skipped`),!1):4<c.length?(console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1):(0===c.length?(e[t]=f,delete e[p[1]]):1===c.length?e[t]=getVectorComponent(f,c):(o=c.split("").map(e=>getVectorComponent(f,e)),e[t]=serializeAsVector(o)),!0))}async function upgradeProperties(r,e){var t=e.uuid,e=r._effectAsset&&r._effectAsset.__uuid__;let s=!1;if(!e)return!1;e=(0,asset_db_1.queryAsset)(e);if(!e||!e.imported)return!1;var o=e.library+".json";if(!(0,fs_extra_1.existsSync)(o))return console.error(`upgradeProperties: the library json of effect(${e.source}) not found, upgrade skipped`),!1;var i=(0,fs_extra_1.readJSONSync)(o).techniques[r._techIdx].passes;for(let e=0;e<i.length;e++){var a=i[e].migrations;if(a){var n=r._props[e],d=r._defines[e];if(a.properties&&n&&d){for(const p of Object.keys(a.properties)){var l=a.properties[p].formerlySerializedAs;l&&(s=handleFormerlySerializedAs(n,d,p,l,t)||s)}for(const f of Object.keys(a.properties))a.properties[f].removeImmediately&&(delete n[f],s=!0)}if(a.macros&&d){for(const u of Object.keys(a.macros)){var c=a.macros[u].formerlySerializedAs;c&&(s=handleFormerlySerializedAs(d,d,u,c,t)||s)}for(const g of Object.keys(a.macros))a.macros[g].removeImmediately&&(delete d[g],s=!0)}}}return s}