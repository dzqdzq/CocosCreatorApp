"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,n,a){void 0===a&&(a=n);var r=Object.getOwnPropertyDescriptor(e,n);r&&("get"in r?e.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,a,r)}:function(t,e,n,a){t[a=void 0===a?n:a]=e[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(){var r=function(t){return(r=Object.getOwnPropertyNames||function(t){var e,n=[];for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[n.length]=e);return n})(t)};return function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n=r(t),a=0;a<n.length;a++)"default"!==n[a]&&__createBinding(e,t,n[a]);return __setModuleDefault(e,t),e}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTFTrsTrackData=exports.GlTFTrsAnimationData=void 0;const glTF_constants_1=require("./glTF.constants"),cc=__importStar(require("cc")),exotic_animation_1=require("cc/editor/exotic-animation");class GlTFTrsAnimationData{nodes={};inputs=[];addNodeAnimation(t){return this.nodes[t]??=new GlTFNodeTrsAnimationData}createExotic(){var t,e,n=new exotic_animation_1.ExoticAnimation;for([t,e]of Object.entries(this.nodes))e.emitExotic(n,t);return n}}exports.GlTFTrsAnimationData=GlTFTrsAnimationData;const INPUT_0=new Float32Array([0]);class GlTFNodeTrsAnimationData{position=null;rotation=null;scale=null;setConstantPosition(t){this.position=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}setConstantRotation(t){this.rotation=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Quat.toArray(new Float32Array(4),t))}setConstantScale(t){this.scale=new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP,INPUT_0,cc.Vec3.toArray(new Float32Array(3),t))}emitExotic(t,e){var{position:n,rotation:a,scale:r}=this;(n||a||r)&&(t=t.addNodeAnimation(e),n&&({input:e,output:n}=n.toLinearVec3Curve(30),t.createPosition(e,n)),a&&({input:e,output:n}=a.toLinearQuatCurveNormalized(30),t.createRotation(e,n)),r)&&({input:a,output:e}=r.toLinearVec3Curve(30),t.createScale(a,e))}}class GlTFTrsTrackData{interpolation;input;output;constructor(t,e,n){this.interpolation=t,this.input=e,this.output=n}toLinearVec3Curve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,3,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,3,t);default:return{input:this.input,output:this.output}}}toLinearQuatCurveNormalized(t){var t=this.toLinearQuatCurve(t),e=t["output"],n=new cc.Quat;for(let t=0;t<e.length/4;++t)cc.Quat.fromArray(n,e,4*t),cc.Quat.normalize(n,n),cc.Quat.toArray(e,n,4*t);return t}toLinearQuatCurve(t){switch(this.interpolation){case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:return cubicSplineToLinearCurveData(this.input,this.output,4,t);case glTF_constants_1.GlTfAnimationInterpolation.STEP:return constantToLinearCurveData(this.input,this.output,4,t);default:return{input:this.input,output:this.output}}}}function calculateBakeParams(t,e){var n=t[0],t=t[t.length-1],e=1/e;return{startTime:n,endTime:t,interval:e,count:(t-n)/e}}function createTimesFromBakeParams(t,e){var{startTime:n,endTime:a,interval:r,count:o}=t,i=new e(o);for(let t=0;t<o;t++)i[t]=t===o-1?a:n+r*t;return i}function constantToLinearCurveData(t,a,r,e){if(t.length<2)return{input:t,output:a};var o=a.length/r,i=calculateBakeParams(t,e),u=new Float32Array(r*i.count);for(let n=0;n<r;++n){var c=new cc.RealCurve;c.assignSorted(Array.from(t),Array.from({length:o},(t,e)=>({value:a[r*e+n],interpolationMode:cc.RealInterpolationMode.CONSTANT}))),bake(c,i,u,r,n)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function cubicSplineToLinearCurveData(t,r,o,e){if(t.length<2)return{input:t,output:r};var n=r.length/(3*o),i=calculateBakeParams(t,e),u=new Float32Array(o*i.count);for(let a=0;a<o;++a){var c=new cc.RealCurve;c.assignSorted(Array.from(t),Array.from({length:n},(t,e)=>{var e=3*o*e+a,n=r[e+0*o];return{value:r[e+ +o],leftTangent:n,rightTangent:r[e+2*o],interpolationMode:cc.RealInterpolationMode.CUBIC}})),bake(c,i,u,o,a)}return{input:createTimesFromBakeParams(i,Float32Array),output:u}}function bake(e,t,n,a,r){var{startTime:t,endTime:o,interval:i,count:u}=t;let c=t;for(let t=0;t<u;++t,c+=i){var s=e.evaluate(t===u-1?o:c);n[a*t+r]=s}}exports.GlTFTrsTrackData=GlTFTrsTrackData;