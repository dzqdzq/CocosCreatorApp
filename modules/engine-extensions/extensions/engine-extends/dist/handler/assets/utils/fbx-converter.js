"use strict";var FbxGlTfConvLogLevel,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){e[o=void 0===o?r:o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=n(e),o=0;o<r.length;o++)"default"!==r[o]&&__createBinding(t,e,r[o]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFbxConverter=createFbxConverter;const path_1=__importDefault(require("path")),fs_extra_1=__importStar(require("fs-extra")),child_process_1=__importDefault(require("child_process")),utils_1=require("../../utils");function createFbxConverter(l){const u="out.gltf";let f=require("@cocos/fbx-gltf-conv")["tool"];var e=f.replace("app.asar","app.asar.unpacked");return fs_extra_1.default.existsSync(e)&&(f=e),{get options(){return l},get(e,t){return path_1.default.join(t,u)},async convert(e,t){var a,s,i,r=[],e=(r.push(c(e.source)),r.push("--unit-conversion",l.unitConversion??"geometry-level"),r.push("--animation-bake-rate",""+(l.animationBakeRate??0)),r.push("--prefer-local-time-span="+(l.preferLocalTimeSpan??!0)),r.push("--match-mesh-names="+(l.matchMeshNames??!0)),l.smartMaterialEnabled&&(r.push("--export-fbx-file-header-info"),r.push("--export-raw-materials")),path_1.default.join(t,u)),o=(await fs_extra_1.default.ensureDir(path_1.default.dirname(e)),r.push("--out",c(e)),path_1.default.join(t,".fbm")),o=(await fs_extra_1.default.ensureDir(o),r.push("--fbm-dir",c(o)),v(t));await fs_extra_1.default.ensureDir(path_1.default.dirname(o)),r.push("--log-file",c(o));a=f,s=r,i=t;let n=await new Promise((t,e)=>{var r=child_process_1.default.spawn(c(a),s,{cwd:i,shell:!0});let o="",n=(r.stdout&&r.stdout.on("data",e=>o+=e),"");r.stderr&&r.stderr.on("data",e=>n+=e),r.on("error",e),r.on("close",e=>{o&&console.log(o),n&&console.error(n),0===e?t(!0):(1!==e&&(3221225781===e?console.error(Editor.I18n.t("engine-extends.importers.fbx.fbxGlTfConv.missing_dll")):126===e&&"darwin"===process.platform?console.error(Editor.I18n.t("engine-extends.importers.fbx.fbxGlTfConv.badCPU")):console.error("FBX-glTF-conv existed with unexpected non-zero code "+e)),t(!1))})});return n&&!await(0,fs_extra_1.pathExists)(e)&&(n=!1,console.error(`Tool FBX-glTF-conv ends abnormally(spawn ${f} ${r.join(" ")}).`)),n},async printLogs(t,r){r=v(r);if(await(0,fs_extra_1.pathExists)(r)){let e;try{e=await fs_extra_1.default.readJson(r)}catch{console.debug("No logs are generated, it should not happen indeed.")}if(Array.isArray(e))try{var o,n,a,s=e,i=t,l=e=>{let r;switch(e){case FbxGlTfConvLogLevel.verbose:r=console.debug;break;case FbxGlTfConvLogLevel.info:r=console.log;break;case FbxGlTfConvLogLevel.warning:r=console.warn;break;case FbxGlTfConvLogLevel.error:case FbxGlTfConvLogLevel.fatal:default:r=console.error}return e=>{var t;r.call(console,(t=i,`${e} [${(0,utils_1.linkToAssetTarget)(t.uuid)}]`))}},u="unsupported_inherit_type",f={};for({level:_,message:o}of s){var c,d,p,_=l(_);"string"==typeof o?_(o):(c=o.code)===u?(d=o.type,p=o.node,d in f||(f[d]=[]),f[d].push(p)):_("string"==typeof c?b(c,o):JSON.stringify(o,void 0,2))}for([n,a]of Object.entries(f))l(FbxGlTfConvLogLevel.verbose)(b(u,{type:n,nodes:a}))}catch(e){console.error(e)}}}};function c(e){return`"${e}"`}function v(e){return path_1.default.join(e,"log.json")}function b(e,t){return Editor.I18n.t("engine-extends.importers.fbx.fbxGlTfConv."+e,t)}}!function(e){e[e.verbose=0]="verbose",e[e.info=1]="info",e[e.warning=2]="warning",e[e.error=3]="error",e[e.fatal=4]="fatal"}(FbxGlTfConvLogLevel=FbxGlTfConvLogLevel||{});