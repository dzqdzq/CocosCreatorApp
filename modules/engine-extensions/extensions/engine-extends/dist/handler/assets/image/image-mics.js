"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertTGA=convertTGA,exports.convertImageToHDR=convertImageToHDR,exports.convertPSD=convertPSD,exports.convertTIFF=convertTIFF,exports.convertHDROrEXR=convertHDROrEXR,exports.convertHDR=convertHDR,exports.convertWithCmft=convertWithCmft;const path_1=require("path"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js")),sharp_1=__importDefault(require("sharp"));async function convertTGA(t){var e=new tga_js_1.default,t=(e.load(t),e.getImageData()),e=new pngjs_1.PNG({width:t.width,height:t.height});return e.data=Buffer.from(t.data),savePNGObject(e)}async function convertImageToHDR(t,e,r){r=(0,path_1.join)(r,e+".hdr");(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r));let n=(0,path_1.join)(Editor.App.path,"../tools/mali_darwin/convert");"win32"===process.platform&&(n=(0,path_1.join)(Editor.App.path,"../tools/mali_win32/convert.exe"));var e=(0,path_1.dirname)(n),a=(n="."+path_1.sep+(0,path_1.basename)(n),Object.assign({},process.env));return a.PATH=e+":"+a.PATH,await Editor.Utils.Process.quickSpawn(n,[(0,path_1.normalize)(t),(0,path_1.normalize)(r)],{cwd:e,env:a}),{extName:".hdr",source:r}}async function convertPSD(t){t=new psd_js_1.default(t),t.parse(),t=t.image.toPng();return savePNGObject(t)}async function convertTIFF(t){return new Promise((e,r)=>{(0,sharp_1.default)(t).png().toBuffer().then(t=>{e({extName:".png",data:t})}).catch(t=>r(t))})}async function savePNGObject(n){return new Promise((t,e)=>{const r=[];n.on("data",t=>{r.push(t)}),n.on("end",()=>{t({extName:".png",data:Buffer.concat(r)})}),n.on("error",t=>{e(t)}),n.pack()})}async function convertHDROrEXR(t,e,r,n){console.debug(`Start to convert asset {asset[${r}](${r})}`);var a=(0,path_1.join)(n,r);if((0,fs_extra_1.ensureDirSync)(n),".hdr"===t)return convertWithCmft(e,a);if(".exr"===t)try{return await convertWithCmft(e,a,"_withexr")}catch(t){return convertWithCmft((await convertImageToHDR(e,r,n)).source,a)}}async function convertHDR(t,e,r){console.debug(`Start to convert asset {asset[${e}](${e})}`);e=(0,path_1.join)(r,e);return(0,fs_extra_1.ensureDirSync)(r),convertWithCmft(t,e)}async function convertWithCmft(t,e,r=""){let n=(0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"+r+("win32"===process.platform?".exe":""));return(0,fs_extra_1.existsSync)(n)||(n=(0,path_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"+("win32"===process.platform?".exe":""))),await Editor.Utils.Process.quickSpawn(n,["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",t,"--output0",e]),console.debug(`Convert asset${t} -> PNG success.`),{extName:".png",source:e+".png"}}