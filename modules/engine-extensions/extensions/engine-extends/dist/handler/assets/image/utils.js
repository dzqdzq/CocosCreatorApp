"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.defaultIconConfig=void 0,exports.makeDefaultTextureCubeAssetUserData=makeDefaultTextureCubeAssetUserData,exports.makeDefaultTexture2DAssetUserData=makeDefaultTexture2DAssetUserData,exports.makeDefaultTexture2DAssetUserDataFromImagePath=makeDefaultTexture2DAssetUserDataFromImagePath,exports.makeDefaultTexture2DAssetUserDataFromImageUuid=makeDefaultTexture2DAssetUserDataFromImageUuid,exports.makeDefaultSpriteFrameAssetUserData=makeDefaultSpriteFrameAssetUserData,exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=makeDefaultSpriteFrameAssetUserDataFromImageUuid,exports.saveImageAsset=saveImageAsset,exports.isCapableToFixAlphaTransparencyArtifacts=isCapableToFixAlphaTransparencyArtifacts,exports.handleImageUserData=handleImageUserData,exports.importWithType=importWithType,exports.converImage=converImage,exports.openImageAsset=openImageAsset;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),utils_1=require("../../utils"),bleeding_1=require("../utils/algorithm/bleeding"),texture_base_1=require("../texture-base"),remote_1=require("@electron/remote"),RGBChannels=3,RGBAChannels=4;function makeDefaultTextureCubeAssetUserData(){var e=(0,texture_base_1.makeDefaultTextureBaseAssetUserData)();return e.isRGBE=!1,e.mipfilter="linear",e}function makeDefaultTexture2DAssetUserData(){return(0,texture_base_1.makeDefaultTextureBaseAssetUserData)()}function makeDefaultTexture2DAssetUserDataFromImagePath(e){return Object.assign((0,texture_base_1.makeDefaultTextureBaseAssetUserData)(),{isUuid:!1,imageUuidOrDatabaseUri:e})}function makeDefaultTexture2DAssetUserDataFromImageUuid(e,a){var t=(0,texture_base_1.makeDefaultTextureBaseAssetUserData)();return a&&[".exr",".hdr",".znt"].includes(a)&&(t.mipfilter="none",t.minfilter="nearest",t.magfilter="nearest"),Object.assign(t,{isUuid:!0,imageUuidOrDatabaseUri:e})}function makeDefaultSpriteFrameAssetUserData(){return(0,texture_base_1.makeDefaultSpriteFrameBaseAssetUserData)()}function makeDefaultSpriteFrameAssetUserDataFromImageUuid(e,a){return Object.assign((0,texture_base_1.makeDefaultSpriteFrameBaseAssetUserData)(),{isUuid:!0,imageUuidOrDatabaseUri:e,atlasUuid:a})}async function saveImageAsset(e,a,t,r){"string"==typeof a?await e.copyToLibrary(t,a):await e.saveToLibrary(t,a);a=new cc_1.ImageAsset,a.name=r,a._setRawAsset(t),r=EditorExtends.serialize(a),await e.saveToLibrary(".json",r),t=(0,utils_1.getDependUUIDList)(r);e.setData("depends",t)}function isCapableToFixAlphaTransparencyArtifacts(e,a,t){return!["normal map","texture cube","sprite-frame","texture"].includes(a)&&(a=t.toLocaleLowerCase().replace(".",""),t=e.userData,!["hdr","exr"].includes(a))&&!t.isRGBE}async function handleImageUserData(e,t,a){"string"==typeof t&&(t=await(0,fs_extra_1.readFile)(t));e=e.userData;const r=(0,sharp_1.default)(t);var s=await r.metadata(),i=(e.hasAlpha=s.hasAlpha,e.type||="texture",!!e.flipVertical);if(i&&(t=await r.flip().toBuffer()),!1!==e.fixAlphaTransparencyArtifacts&&s.hasAlpha){var u=await(0,sharp_1.default)(t).raw().toBuffer();let a=!1;for(let e=0;e<u.length;e+=RGBAChannels)if(0===u[e+3]){a=!0;break}if(a){var i=Buffer.from(u),n=[-1,0,1,-1,1,-1,0,1],m=[-1,-1,-1,0,0,1,1,1],o=[],l=s.width*RGBAChannels;for(let e=0;e<n.length;e++)o[e]=n[e]*RGBAChannels+m[e]*l;(0,bleeding_1.applyContourBleed)(i,u,s.width,new cc_1.Rect(0,0,s.width,s.height),n,m,o),t=await(0,sharp_1.default)(i,{raw:{channels:RGBAChannels,height:s.height,width:s.width}}).toFormat("png").toBuffer()}}if(e.flipGreenChannel){const r=await(0,sharp_1.default)(t);var{width:i,height:s}=await r.metadata(),D=await r.raw().toBuffer(),p=D.length/i/s;for(let e=1;e<D.length;e=p+e)D[e]=255-D[e];e={raw:{width:i,height:s,channels:p}};t=await(0,sharp_1.default)(D,e).toFormat("png").toBuffer()}return t}async function importWithType(e,a,t,r){var s=e.userData;switch(a){case"texture":var i=await e.createSubAsset("texture","texture",{displayName:t});s.redirect=i.uuid,i.assignUserData(makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid,r)),i.userData.imageUuidOrDatabaseUri=e.uuid,i.userData.visible=!1;break;case"normal map":(await e.createSubAsset("normalMap","texture",{displayName:t})).assignUserData(makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));break;case"texture cube":i=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:t});i.assignUserData(makeDefaultTextureCubeAssetUserData()),i.userData.imageDatabaseUri=e.uuid,i.userData.isRGBE=!!s.isRGBE;break;case"sprite-frame":var i=await e.createSubAsset("texture","texture",{displayName:t}),u=(i.userData.wrapModeS=i.userData.wrapModeS||"clamp-to-edge",i.userData.wrapModeT=i.userData.wrapModeT||"clamp-to-edge",s.redirect=i.uuid,i.userData.imageUuidOrDatabaseUri=e.uuid,i.userData.isUuid=!0,i.userData.visible=!1,await e.createSubAsset("spriteFrame","sprite-frame",{displayName:t}));u.assignUserData(makeDefaultSpriteFrameAssetUserDataFromImageUuid(i.uuid,"")),u.userData.imageUuidOrDatabaseUri=i.uuid}}async function converImage(){}async function openImageAsset(e){var a=await Editor.Message.request("program","open-program","pictureEditor",[e.source]);return a||(await remote_1.shell.openPath(e.source),!0)}exports.defaultIconConfig={type:"icon",value:"image"};