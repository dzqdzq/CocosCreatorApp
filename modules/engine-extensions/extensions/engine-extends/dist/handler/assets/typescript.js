"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TypeScriptHandler=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../utils"),javascript_1=__importDefault(require("./javascript")),ts_utils_1=require("./utils/ts-utils");async function getTypeCheckLevel(){return await Editor.Profile.getProject("project","general.type_check_level")}exports.TypeScriptHandler={name:"typescript",assetType:"cc.Script",open:utils_1.openCode,createInfo:{async generateMenuInfo(){let e=[{label:"i18n:ENGINE.assets.newTypeScript",fullFileName:ts_utils_1.ScriptNameChecker.getDefaultClassName()+".ts",template:`db://internal/default_file_content/${exports.TypeScriptHandler.name}/ts`,group:"script",fileNameCheckConfigs:[ts_utils_1.DefaultScriptFileNameCheckConfig]}];const a=(0,path_1.join)(Editor.Project.path,".creator/asset-template/typescript"),s="Custom Script Template Help Documentation.url";var t=(0,path_1.join)(a,s);if((0,fs_extra_1.existsSync)(t)||(0,fs_extra_1.outputFileSync)(t,"[InternetShortcut]\nURL=https://docs.cocos.com/creator/manual/en/scripting/setup.html#custom-script-template"),(0,fs_extra_1.existsSync)(a)){t=(0,fs_extra_1.readdirSync)(a);const r=[];t.forEach(e=>{var t=(0,path_1.join)(a,e);(0,fs_extra_1.statSync)(t).isDirectory()||e===s||e.startsWith(".")||(e=(0,path_1.basename)(e,(0,path_1.extname)(e)),r.push({label:e,fullFileName:(ts_utils_1.ScriptNameChecker.getValidClassName(e)||ts_utils_1.ScriptNameChecker.getDefaultClassName())+".ts",template:t,fileNameCheckConfigs:[ts_utils_1.DefaultScriptFileNameCheckConfig]}))}),r.length&&(r.splice(0,0,e[0]),r[0].fullFileName=ts_utils_1.ScriptNameChecker.getDefaultClassName()+".ts",e=[{label:"i18n:ENGINE.assets.newTypeScript",group:"script",submenu:r}],r.push({label:Editor.I18n.t("assets.menu.setCustomTypeScript"),message:{target:"asset-db",name:"show-asset-template-dir",params:[a]}}))}return e},async create(e){var t=Manager.Utils.url2path(e.template||"db://internal/default_file_content/ts");let a=await(0,fs_extra_1.readFile)(t,"utf-8");a=a.replace(ts_utils_1.ScriptNameChecker.commentsReg,e=>e.includes("COMMENTS_GENERATE_IGNORE")?"":e);var t=(0,path_1.basename)(e.target,(0,path_1.extname)(e.target)),s=await ts_utils_1.ScriptNameCheckerManager.getScriptChecker(a),r=await Editor.User.getData();const l={Name:ts_utils_1.ScriptNameChecker.getValidClassName(t),UnderscoreCaseClassName:ts_utils_1.ScriptNameChecker.getValidClassName(t),CamelCaseClassName:s.getValidCamelCaseClassName(t),DateTime:(new Date).toString(),Author:r.nickname,FileBasename:(0,path_1.basename)(e.target),FileBasenameNoExtension:t,URL:Manager.assetManager.queryUrl(e.target),EditorVersion:Editor.App.version,ManualUrl:Editor.App.urls.manual};r=s.classNameStringFormat.substring(2,s.classNameStringFormat.length-2);if(r in l){let e=l[r];e&&ts_utils_1.ScriptNameChecker.invalidClassNameReg.test(e)||(l.DefaultCamelCaseClassName=l.CamelCaseClassName||ts_utils_1.ScriptNameChecker.getDefaultClassName(),ts_utils_1.ScriptNameChecker.invalidClassNameReg.test(e)||(a=(a=a.replace(`@ccclass('<%${r}%>')`,"@ccclass('<%DefaultCamelCaseClassName%>')")).replace(`class <%${r}%>`,"class <%DefaultCamelCaseClassName%>")),e=l.DefaultCamelCaseClassName,l.CamelCaseClassName)||console.warn(Editor.I18n.t("engine-extends.importers.script.findClassNameFromFileNameFailed",{fileBasename:t,className:e})),l.CamelCaseClassName||(l.Name||(l.Name=e),l.CamelCaseClassName=e)}return Object.keys(l).forEach(e=>{a=a.replace(new RegExp(`<%${e}%>`,"g"),l[e])}),(0,fs_extra_1.outputFileSync)(e.target,a,"utf-8"),e.target},preventDefaultTemplateMenu:!0},importer:{...javascript_1.default.importer,async import(e){if(e.source.endsWith(".d.ts"))return!0;let t=!1,a=!1;switch(await getTypeCheckLevel()){case"checkOnly":t=!0,a=!1;break;case"fatalOnError":t=!0,a=!0;break;default:t=!1}return javascript_1.default.importer.import(e)}}},exports.default=exports.TypeScriptHandler;