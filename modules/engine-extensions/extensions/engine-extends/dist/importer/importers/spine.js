"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,n)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpineImporter=void 0;const asset_db_1=require("@editor/asset-db"),path=__importStar(require("path")),fs=__importStar(require("fs")),fse=__importStar(require("fs-extra")),ATLAS_EXTS=[".atlas",".txt",".atlas.txt",""],cc_1=require("cc"),utils_1=require("../utils");function basenameNoExt(e){const t=path.basename(e),s=path.extname(e);return t.substring(0,t.length-s.length)}function searchAtlas(e,t){const s=path.extname(e);e=e.substr(0,e.length-s.length),function s(r){const n=ATLAS_EXTS[r],a=e+n;fs.exists(a,n=>{if(n)return t(null,a);r+1<ATLAS_EXTS.length?s(r+1):t(new Error(`Can not find ${e+ATLAS_EXTS[0]}`))})}(0)}function loadAtlasText(e,t){searchAtlas(e,(e,s)=>{if(e)return t(e);fs.readFile(s,{encoding:"utf8"},(e,r)=>{t(e,{data:r,atlasPath:s})})})}class TextureParser{constructor(e,t){this.atlasPath=t,this.texturesUUID=[],this.textureNames=[],this.asset=e,this.asset.depend(t)}load(e){const t=path.basename(e),s=path.dirname(this.atlasPath),r=path.resolve(s,t),n=(0,asset_db_1.queryAsset)(r);if(n){const t=n.uuid+"@6c48a";this.asset.depend(t),console.log('UUID is initialized for "%s".',r),this.texturesUUID.push(t),this.textureNames.push(e)}else fs.existsSync(r)?console.warn('WARN: UUID not yet initialized for "%s".',path):console.error('Can not find texture "%s" for atlas "%s"',e,this.atlasPath);return null}}class SpineImporter extends asset_db_1.Importer{constructor(){super(...arguments),this.scale=1,this.textures=[]}get version(){return"1.2.6"}get name(){return"spine-data"}get assetType(){return"sp.SkeletonData"}async validate(e){const t=e.source;if(t.endsWith(".skel"))return!0;let s;const r=fs.readFileSync(t,"utf8"),n=r.slice(0,30);if(n.indexOf("slots")>0||n.indexOf("skins")>0||n.indexOf("events")>0||n.indexOf("animations")>0||n.indexOf("bones")>0||n.indexOf("skeleton")>0||n.indexOf('"ik"')>0){try{s=JSON.parse(r)}catch(e){return!1}return Array.isArray(s.bones)}return!1}async _initTexture(e,t,s){return new Promise((r,n)=>{loadAtlasText(s,(s,a)=>{if(s)return n(s);const i=new TextureParser(e,a.atlasPath),o=null===a||void 0===a?void 0:a.data.split("\n");if(!o||o.length<1)return n(new Error(`Failed to load atlas file: "${a.atlasPath}"`));let l=null;const u=o.length;for(let e=0;e<u;e++){const t=o[e].trim();0===t.length?l=null:l||(l=t,i.load(l))}this.textures=i.texturesUUID,t.textures=i.texturesUUID.map(e=>EditorExtends.serialize.asAsset(e,cc_1.Texture2D)),t.textureNames=i.textureNames,t.atlasText=a.data;const c=EditorExtends.serialize(t);e.saveToLibrary(".json",c).then(()=>{const t=(0,utils_1.getDependUUIDList)(c);e.setData("depends",t),r(!0)},n)})})}async _importJson(e){const t=e.source,s=await fse.readFile(t,{encoding:"utf8"});let r;try{r=JSON.parse(s)}catch(e){return console.error(e),!1}const n=new cc_1.sp.SkeletonData;return n.name=e.basename||"",n.skeletonJson=r,n.scale=this.scale,await this._initTexture(e,n,t)}async _importBinary(e){await e.copyToLibrary(".bin",e.source);const t=e.source,s=new cc_1.sp.SkeletonData;return s.name=e.basename||"",s._setRawAsset(".bin"),s.scale=this.scale,await this._initTexture(e,s,t)}async import(e){return e.source.endsWith(".skel")?await this._importBinary(e):await this._importJson(e)}}exports.SpineImporter=SpineImporter;