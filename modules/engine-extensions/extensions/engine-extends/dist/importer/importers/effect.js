"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),closure={root:"",dir:""};effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=(e=>[path_1.relative(closure.root,path_1.resolve(closure.dir,e)).replace(/\\/g,"/")]),effect_compiler_1.options.chunkSearchFn=(e=>{const t={name:void 0,content:void 0};return asset_db_1.forEach(r=>{if(void 0===t.content)for(let o=0;o<e.length;o++){const n=e[o],a=path_1.resolve(r.options.target,"chunks",n+".chunk");if(fs_extra_1.existsSync(a)){t.name=n,t.content=fs_extra_1.readFileSync(a,{encoding:"utf-8"});break}}}),t});class EffectImporter extends asset_db_1.Importer{get version(){return"1.4.8"}get name(){return"effect"}get assetType(){return"cc.EffectAsset"}get migrations(){return migrations}async import(e){try{const t=this.assetDB.options.target;closure.root=path_1.join(t,"chunks"),closure.dir=path_1.dirname(e.source);const r=path_1.relative(path_1.join(t,"effects"),closure.dir).replace(/\\/g,"/"),o=r+(r.length?"/":"")+path_1.basename(e.source,path_1.extname(e.source)),n=fs_extra_1.readFileSync(e.source,{encoding:"utf-8"}),a=effect_compiler_1.buildEffect(o,n);asset_db_1.forEach(t=>{for(const r of a.dependencies)e.depend(path_1.resolve(t.options.target,"chunks",r+".chunk"))});const i=new cc_1.EffectAsset;return Object.assign(i,a),a.editor&&a.editor.hide&&(i.hideInEditor=!0),e.userData&&(e.userData.combinations&&(i.combinations=e.userData.combinations),a.editor?e.userData.editor=a.editor:e.userData.editor=void 0),await e.saveToLibrary(".json",EditorExtends.serialize(i)),!0}catch(e){return console.error(e),!1}}}exports.default=EffectImporter;const migrations=[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog}],inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let t=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});t=t.replace(inspectorRE,"editor:"),fs_extra_1.writeFileSync(e.source,t,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let t=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});t.match(inputIncludeRE)&&(t=t.replace(UVAttribute,"")),fs_extra_1.writeFileSync(e.source,t,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let t=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});t.match(MacroStandardTransparent)&&(t=t.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),fs_extra_1.writeFileSync(e.source,t,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG";function migrateApplyFog(e){let t=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});t.match(MacroApplyFog)&&(t=t.replace(MacroApplyFog,ReplaceApplyFog)),fs_extra_1.writeFileSync(e.source,t,{encoding:"utf8"})}