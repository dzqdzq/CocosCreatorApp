"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateChunkFolders=exports.migrateMacroUseBatching=exports.migrateCSMInclude=exports.migrateMacroUseLightMap=exports.migrateIncludeDecodeBase=exports.migrateDefines=exports.migrateEnableDirShadow=exports.EffectImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),custom_pipeline_1=require("cc/editor/custom-pipeline"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),utils_1=require("../utils"),closure={root:"",dir:""};effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=(e=>[path_1.relative(closure.root,path_1.resolve(closure.dir,e)).replace(/\\/g,"/")]),effect_compiler_1.options.chunkSearchFn=(e=>{const a={name:void 0,content:void 0};return asset_db_1.forEach(t=>{if(void 0===a.content)for(let r=0;r<e.length;r++){const c=e[r],o=path_1.resolve(t.options.target,"chunks",c+".chunk");if(fs_extra_1.existsSync(o)){a.name=c,a.content=fs_extra_1.readFileSync(o,{encoding:"utf-8"});break}}}),a});class EffectImporter extends asset_db_1.Importer{get version(){return"1.7.0"}get name(){return"effect"}get assetType(){return"cc.EffectAsset"}get migrations(){return migrations}_rebuildDescriptorHierarchy(e){const a=[];for(const t of e){const e=path_1.join(t.temp,"materialxxx.json");fs_extra_1.existsSync(e)||a.push(t)}return a}async buildCustomLayout(e,a){const t=new custom_pipeline_1.VisibilityGraph;for(const a of e){const e=a.library+".json",r=await fs_extra_1.readJSON(e),c=cc.deserialize(r);t.mergeEffect(c)}const r=new custom_pipeline_1.LayoutGraphInfo(t);for(const a of e){const e=a.library+".json",t=await fs_extra_1.readJSON(e),c=cc.deserialize(t);r.addEffect(c)}r.build()&&console.error("build failed"),custom_pipeline_1.buildLayoutGraphData(r.lg,a)}async afterImport(e){const a=this._rebuildDescriptorHierarchy(e);if(a.length>0){const e=new custom_pipeline_1.LayoutGraphData;await this.buildCustomLayout(a,e);const t=path_1.join(Editor.Project.tmpDir,"asset-db/effect/effect.bin");await fs_extra_1.ensureDir(path_1.dirname(t));const r=new custom_pipeline_1.BinaryOutputArchive;custom_pipeline_1.saveLayoutGraphData(r,e),fs_extra_1.writeFileSync(t,r.buffer)}}async import(e){try{const a=this.assetDB.options.target;closure.root=path_1.join(a,"chunks"),closure.dir=path_1.dirname(e.source);const t=path_1.relative(path_1.join(a,"effects"),closure.dir).replace(/\\/g,"/"),r=t+(t.length?"/":"")+path_1.basename(e.source,path_1.extname(e.source)),c=fs_extra_1.readFileSync(e.source,{encoding:"utf-8"}),o=effect_compiler_1.buildEffect(r,c);asset_db_1.forEach(a=>{for(const t of o.dependencies)e.depend(path_1.resolve(a.options.target,"chunks",t+".chunk"))});const i=new cc_1.EffectAsset;Object.assign(i,o),o.editor&&o.editor.hide&&(i.hideInEditor=!0),e.userData&&(e.userData.combinations&&(i.combinations=e.userData.combinations),o.editor?e.userData.editor=o.editor:e.userData.editor=void 0);const n=EditorExtends.serialize(i);await e.saveToLibrary(".json",n);const s=utils_1.getDependUUIDList(n);return e.setData("depends",s),!0}catch(e){return console.error(e),!1}}}exports.EffectImporter=EffectImporter;const migrations=[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog},{version:"1.4.9",migrate:e=>{migrateMacroToFunction(e),migrateEnableDirShadow(e)}},{version:"1.5.0",migrate:migrateMacroToFunction},{version:"1.5.1",migrate:migrateShadowFactorParameter},{version:"1.5.2",migrate:migrateDefines},{version:"1.5.3",migrate:migrateIncludeDecodeBase},{version:"1.5.4",migrate:migrateSpecularIntensity},{version:"1.5.5",migrate:migrateUnpackLightingMap},{version:"1.5.6",migrate:migrateMacroUseLightMap},{version:"1.5.7",migrate:migrateChunkFolders},{version:"1.5.8",migrate:migrateCSMInclude},{version:"1.6.0",migrate:migrateMacroUseBatching},{version:"1.6.1",migrate:migrateGetLightingMapAlpha}],inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=a.replace(inspectorRE,"editor:"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(inputIncludeRE)&&(a=a.replace(UVAttribute,"")),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroStandardTransparent)&&(a=a.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG",MacroTransferFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_TRANSFER_FOG/g,ReplaceTransferFog="CC_TRANSFER_FOG";function migrateApplyFog(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroApplyFog)&&(a=a.replace(MacroApplyFog,ReplaceApplyFog)),a.match(MacroTransferFog)&&(a=a.replace(MacroTransferFog,ReplaceTransferFog)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroEnableDirShadow=/&&\s*CC_ENABLE_DIR_SHADOW/g,ReplaceEnableDirShadow="";function migrateEnableDirShadow(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroEnableDirShadow)&&(a=a.replace(MacroEnableDirShadow,ReplaceEnableDirShadow)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateEnableDirShadow=migrateEnableDirShadow;const MacroShadowFactor=/CC_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactor="$1 = CCShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroShadowFactorBase=/CC_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBase="$1 = CCShadowFactorBase($2, $3)",MacroSpotShadowFactor=/CC_SPOT_SHADOW_FACTOR\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactor="$1 = CCSpotShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroSpotShadowFactorBase=/CC_SPOT_SHADOW_FACTOR_BASE\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBase="$1 = CCSpotShadowFactorBase($2, $3)";function migrateMacroToFunction(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroShadowFactorBase)&&(a=a.replace(MacroShadowFactorBase,ReplaceShadowFactorBase)),a.match(MacroShadowFactor)&&(a=a.replace(MacroShadowFactor,ReplaceShadowFactor)),a.match(MacroSpotShadowFactorBase)&&(a=a.replace(MacroSpotShadowFactorBase,ReplaceSpotShadowFactorBase)),a.match(MacroSpotShadowFactor)&&(a=a.replace(MacroSpotShadowFactor,ReplaceSpotShadowFactor)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const ShadowFactorBaseParameter=/CCShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceShadowFactorBaseParameter="CCShadowFactorBase($1, $2, vec2(0.0, 0.0))",SpotShadowFactorBaseParameter=/CCSpotShadowFactorBase\s*\(\s*([\w.\[\]]+)\s*,\s*([\w.\[\]]+)\s*\)/g,ReplaceSpotShadowFactorBaseParameter="CCSpotShadowFactorBase($1, $2, vec2(0.0, 0.0))";function migrateShadowFactorParameter(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(ShadowFactorBaseParameter)&&(a=a.replace(ShadowFactorBaseParameter,ReplaceShadowFactorBaseParameter)),a.match(SpotShadowFactorBaseParameter)&&(a=a.replace(SpotShadowFactorBaseParameter,ReplaceSpotShadowFactorBaseParameter)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const DefineMetaRE=/#pragma\s+define\s+/g,DefineRE=/#define/g;function migrateDefines(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=(a=a.replace(DefineMetaRE,"#pragma define-meta ")).replace(DefineRE,"#pragma define"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateDefines=migrateDefines;const IncludeLocalBatch1=/(\s*)#include\s*<cc-local-batch>/g,IncludeLocalBatch2=/(\s*)#include\s*"cc-local-batch"/g,ReplaceIncludeLocalBatch="$1#include <decode-base>$1#include <cc-local-batch>";function migrateIncludeDecodeBase(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(IncludeLocalBatch1)&&(a=a.replace(IncludeLocalBatch1,ReplaceIncludeLocalBatch)),a.match(IncludeLocalBatch2)&&(a=a.replace(IncludeLocalBatch2,ReplaceIncludeLocalBatch)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateIncludeDecodeBase=migrateIncludeDecodeBase;const MetallicParam=/(\s*)s.metallic\s*=/g,ReplaceMetallicParam="$1s.specularIntensity = 0.5;$1s.metallic =";function migrateSpecularIntensity(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MetallicParam)&&(a=a.replace(MetallicParam,ReplaceMetallicParam)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UnpackLightingMap=/UnpackLightingmap\s*\(\s*([\w.\[\]]+)\s*\)/g,ReplaceUnpackLightingMap="$1.rgb";function migrateUnpackLightingMap(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UnpackLightingMap)&&(a=a.replace(UnpackLightingMap,ReplaceUnpackLightingMap)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UseLightMap=/(\s+)USE_LIGHTMAP/g,ReplaceUseLightMap="$1CC_USE_LIGHTMAP";function migrateMacroUseLightMap(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UseLightMap)&&(a=a.replace(UseLightMap,ReplaceUseLightMap)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseLightMap=migrateMacroUseLightMap;const CCShadow=/(\s*)#include\s*<builtin\/uniforms\/cc-shadow>/g,ReplaceCCShadow="$1#include <builtin/uniforms/cc-shadow>\n#if CC_SUPPORT_CASCADED_SHADOW_MAP\n  #include <builtin/uniforms/cc-csm>\n#endif";function migrateCSMInclude(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(CCShadow)&&(a=a.replace(CCShadow,ReplaceCCShadow)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateCSMInclude=migrateCSMInclude;const CCBatching=/&&\s+!USE_BATCHING\s*/g;function migrateMacroUseBatching(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(CCBatching)&&(a=a.replace(CCBatching,"")),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateMacroUseBatching=migrateMacroUseBatching;const UseShadingStandBaseInclude=/#include.*standard-surface-entry/g,GetLightingMapAlpha1=/(\s*)s.lightmap.rgb\s*=\s*([a-zA-Z]+)/g,GetLightingMapAlpha2=/(\s*)s.lightmap\s*=\s*([a-zA-Z]+)/g,ReplaceGetLightingMapAlpha="$1s.lightmap.a = $2.a;$1s.lightmap.rgb = $2";function migrateGetLightingMapAlpha(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(UseShadingStandBaseInclude)&&(a.match(GetLightingMapAlpha1)&&(a=a.replace(GetLightingMapAlpha1,ReplaceGetLightingMapAlpha)),a.match(GetLightingMapAlpha2)&&(a=a.replace(GetLightingMapAlpha2,ReplaceGetLightingMapAlpha))),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}function migrateChunkFolders(e){const a=new Map([["cc-fog-base","legacy/fog-base"],["cc-shadow-map-base","legacy/shadow-map-base"],["morph","legacy/morph"],["cc-skinning","legacy/skinning"],["cc-local-batch","legacy/local-batch"],["lighting","legacy/lighting"],["lightingmap-fs","legacy/lightingmap-fs"],["cc-shadow-map-vs","legacy/shadow-map-vs"],["cc-shadow-map-fs","legacy/shadow-map-fs"],["cc-fog-vs","legacy/fog-vs"],["cc-fog-fs","legacy/fog-fs"],["lightingmap-vs","legacy/lightingmap-vs"],["decode","legacy/decode"],["decode-base","legacy/decode-base"],["decode-standard","legacy/decode-standard"],["input","legacy/input"],["input-standard","legacy/input-standard"],["output","legacy/output"],["output-standard","legacy/output-standard"],["shading-standard","legacy/shading-standard"],["shading-standard-base","legacy/shading-standard-base"],["shading-standard-additive","legacy/shading-standard-additive"],["shading-cluster-additive","legacy/shading-cluster-additive"],["shading-toon","legacy/shading-toon"],["standard-surface-entry","legacy/standard-surface-entry"],["alpha-test","builtin/internal/alpha-test"],["cc-sprite-common","builtin/internal/sprite-common"],["cc-sprite-texture","builtin/internal/sprite-texture"],["embedded-alpha","builtin/internal/embedded-alpha"],["particle-common","builtin/internal/particle-common"],["cc-global","builtin/uniforms/cc-global"],["cc-local","builtin/uniforms/cc-local"],["cc-forward-light","builtin/uniforms/cc-forward-light"],["cc-environment","builtin/uniforms/cc-environment"],["cc-diffusemap","builtin/uniforms/cc-diffusemap"],["cc-shadow","builtin/uniforms/cc-shadow"],["cc-csm","builtin/uniforms/cc-csm"],["cc-world-bound","builtin/uniforms/cc-world-bound"],["builtin/uniforms/cc-skinning-uniforms","builtin/uniforms/cc-skinning"],["common","common/common-define"],["texture-lod","common/texture/texture-lod"],["packing","common/data/packing"],["unpack","common/data/unpack"],["aces","common/color/aces"],["gamma","common/color/gamma"],["octahedron-transform","common/math/octahedron-transform"],["transform","common/math/transform"],["rect-area-light","common/lighting/rect-area-light"],["fxaa","post-process/fxaa"],["anti-aliasing","post-process/anti-aliasing"]]),t=new Map([["vert:\\s+particle-vs-gpu","vert: builtin/internal/particle-vs-gpu"],["vert:\\s+particle-vs-legacy","vert: builtin/internal/particle-vs-legacy"],["vert:\\s+particle-trail","vert: builtin/internal/particle-trail"],["vert:\\s+outline-vs","vert: legacy/main-functions/outline-vs"],["frag:\\s+outline-fs","frag: legacy/main-functions/outline-fs"],["vert:\\s+general-vs","vert: legacy/main-functions/general-vs"],["CCGetShadowFactorSoft2X","CCGetDirLightShadowFactorSoft3X"],["CCGetShadowFactorSoft","CCGetDirLightShadowFactorSoft"],["CCGetShadowFactorHard","CCGetDirLightShadowFactorHard"],["CCGetSpotLightShadowFactorSoft2X","CCGetSpotLightShadowFactorSoft3X"]]);let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"}),c=!1;for(const[e,t]of a){const a=new RegExp("#include\\s+<"+e+">","g"),o=new RegExp('#include\\s+"'+e+'"',"g"),i="#include <"+t+">";r.match(a)&&(r=r.replace(a,i),c=!0),r.match(o)&&(r=r.replace(o,i),c=!0)}for(const[e,a]of t){const t=new RegExp(e,"g"),o=a;r.match(t)&&(r=r.replace(t,o),c=!0)}c&&fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}exports.migrateChunkFolders=migrateChunkFolders;