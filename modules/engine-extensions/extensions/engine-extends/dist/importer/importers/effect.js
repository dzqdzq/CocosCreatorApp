"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateDefines=exports.migrateEnableDirShadow=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),closure={root:"",dir:""};effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=(e=>[path_1.relative(closure.root,path_1.resolve(closure.dir,e)).replace(/\\/g,"/")]),effect_compiler_1.options.chunkSearchFn=(e=>{const a={name:void 0,content:void 0};return asset_db_1.forEach(t=>{if(void 0===a.content)for(let r=0;r<e.length;r++){const o=e[r],c=path_1.resolve(t.options.target,"chunks",o+".chunk");if(fs_extra_1.existsSync(c)){a.name=o,a.content=fs_extra_1.readFileSync(c,{encoding:"utf-8"});break}}}),a});class EffectImporter extends asset_db_1.Importer{get version(){return"1.5.4"}get name(){return"effect"}get assetType(){return"cc.EffectAsset"}get migrations(){return migrations}async import(e){try{const a=this.assetDB.options.target;closure.root=path_1.join(a,"chunks"),closure.dir=path_1.dirname(e.source);const t=path_1.relative(path_1.join(a,"effects"),closure.dir).replace(/\\/g,"/"),r=t+(t.length?"/":"")+path_1.basename(e.source,path_1.extname(e.source)),o=fs_extra_1.readFileSync(e.source,{encoding:"utf-8"}),c=effect_compiler_1.buildEffect(r,o);asset_db_1.forEach(a=>{for(const t of c.dependencies)e.depend(path_1.resolve(a.options.target,"chunks",t+".chunk"))});const s=new cc_1.EffectAsset;return Object.assign(s,c),c.editor&&c.editor.hide&&(s.hideInEditor=!0),e.userData&&(e.userData.combinations&&(s.combinations=e.userData.combinations),c.editor?e.userData.editor=c.editor:e.userData.editor=void 0),await e.saveToLibrary(".json",EditorExtends.serialize(s)),!0}catch(e){return console.error(e),!1}}}exports.default=EffectImporter;const migrations=[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog},{version:"1.4.9",migrate:migrateEnableDirShadow},{version:"1.5.0",migrate:migrateMacroToFunction},{version:"1.5.1",migrate:migrateShadowFactorParameter},{version:"1.5.2",migrate:migrateDefines},{version:"1.5.3",migrate:migrateIncludeDecodeBase},{version:"1.5.4",migrate:migrateSpecularIntensity}],inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=a.replace(inspectorRE,"editor:"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(inputIncludeRE)&&(a=a.replace(UVAttribute,"")),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroStandardTransparent)&&(a=a.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG",MacroTransferFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_TRANSFER_FOG/g,ReplaceTransferFog="CC_TRANSFER_FOG";function migrateApplyFog(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroApplyFog)&&(a=a.replace(MacroApplyFog,ReplaceApplyFog)),a.match(MacroTransferFog)&&(a=a.replace(MacroTransferFog,ReplaceTransferFog)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MacroEnableDirShadow=/&&\s*CC_ENABLE_DIR_SHADOW/g,ReplaceEnableDirShadow="";function migrateEnableDirShadow(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroEnableDirShadow)&&(a=a.replace(MacroEnableDirShadow,ReplaceEnableDirShadow)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateEnableDirShadow=migrateEnableDirShadow;const MacroShadowFactor=/CC_SHADOW_FACTOR\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceShadowFactor="$1 = CCShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroShadowFactorBase=/CC_SHADOW_FACTOR_BASE\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceShadowFactorBase="$1 = CCShadowFactorBase($2, $3)",MacroSpotShadowFactor=/CC_SPOT_SHADOW_FACTOR\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceSpotShadowFactor="$1 = CCSpotShadowFactorBase(CC_SHADOW_POSITION, $2)",MacroSpotShadowFactorBase=/CC_SPOT_SHADOW_FACTOR_BASE\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceSpotShadowFactorBase="$1 = CCSpotShadowFactorBase($2, $3)";function migrateMacroToFunction(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MacroShadowFactorBase)&&(a=a.replace(MacroShadowFactorBase,ReplaceShadowFactorBase)),a.match(MacroShadowFactor)&&(a=a.replace(MacroShadowFactor,ReplaceShadowFactor)),a.match(MacroSpotShadowFactorBase)&&(a=a.replace(MacroSpotShadowFactorBase,ReplaceSpotShadowFactorBase)),a.match(MacroSpotShadowFactor)&&(a=a.replace(MacroSpotShadowFactor,ReplaceSpotShadowFactor)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const ShadowFactorBaseParameter=/CCShadowFactorBase\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceShadowFactorBaseParameter="CCShadowFactorBase($1, $2, vec2(0.0, 0.0))",SpotShadowFactorBaseParameter=/CCSpotShadowFactorBase\s*\(\s*([\w.]+)\s*,\s*([\w.]+)\s*\)/g,ReplaceSpotShadowFactorBaseParameter="CCSpotShadowFactorBase($1, $2, vec2(0.0, 0.0))";function migrateShadowFactorParameter(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(ShadowFactorBaseParameter)&&(a=a.replace(ShadowFactorBaseParameter,ReplaceShadowFactorBaseParameter)),a.match(SpotShadowFactorBaseParameter)&&(a=a.replace(SpotShadowFactorBaseParameter,ReplaceSpotShadowFactorBaseParameter)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const DefineMetaRE=/#pragma\s+define\s+/g,DefineRE=/#define/g;function migrateDefines(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a=(a=a.replace(DefineMetaRE,"#pragma define-meta ")).replace(DefineRE,"#pragma define"),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}exports.migrateDefines=migrateDefines;const IncludeLocalBatch=/(\s*)#include\s*<cc-local-batch>/g,ReplaceIncludeLocalBatch="$1#include <decode-base>$1#include <cc-local-batch>";function migrateIncludeDecodeBase(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(IncludeLocalBatch)&&(a=a.replace(IncludeLocalBatch,ReplaceIncludeLocalBatch)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}const MetallicParam=/(\s*)s.metallic\s*=/g,ReplaceMetallicParam="$1s.specularIntensity = 0.5;$1s.metallic =";function migrateSpecularIntensity(e){let a=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});a.match(MetallicParam)&&(a=a.replace(MetallicParam,ReplaceMetallicParam)),fs_extra_1.writeFileSync(e.source,a,{encoding:"utf8"})}