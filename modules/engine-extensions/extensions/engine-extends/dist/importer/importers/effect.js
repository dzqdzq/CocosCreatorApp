"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),effect_compiler_1=require("../../../static/effect-compiler"),closure={root:"",dir:""};effect_compiler_1.options.throwOnWarning=!0,effect_compiler_1.options.skipParserTest=!0,effect_compiler_1.options.getAlternativeChunkPaths=(e=>[path_1.relative(closure.root,path_1.resolve(closure.dir,e)).replace(/\\/g,"/")]),effect_compiler_1.options.chunkSearchFn=(e=>{const r={name:void 0,content:void 0};return asset_db_1.forEach(t=>{if(void 0===r.content)for(let a=0;a<e.length;a++){const o=e[a],n=path_1.resolve(t.options.target,"chunks",o+".chunk");if(fs_extra_1.existsSync(n)){r.name=o,r.content=fs_extra_1.readFileSync(n,{encoding:"utf-8"});break}}}),r});class EffectImporter extends asset_db_1.Importer{get version(){return"1.4.9"}get name(){return"effect"}get assetType(){return"cc.EffectAsset"}get migrations(){return migrations}async import(e){try{const r=this.assetDB.options.target;closure.root=path_1.join(r,"chunks"),closure.dir=path_1.dirname(e.source);const t=path_1.relative(path_1.join(r,"effects"),closure.dir).replace(/\\/g,"/"),a=t+(t.length?"/":"")+path_1.basename(e.source,path_1.extname(e.source)),o=fs_extra_1.readFileSync(e.source,{encoding:"utf-8"}),n=effect_compiler_1.buildEffect(a,o);asset_db_1.forEach(r=>{for(const t of n.dependencies)e.depend(path_1.resolve(r.options.target,"chunks",t+".chunk"))});const c=new cc_1.EffectAsset;return Object.assign(c,n),n.editor&&n.editor.hide&&(c.hideInEditor=!0),e.userData&&(e.userData.combinations&&(c.combinations=e.userData.combinations),n.editor?e.userData.editor=n.editor:e.userData.editor=void 0),await e.saveToLibrary(".json",EditorExtends.serialize(c)),!0}catch(e){return console.error(e),!1}}}exports.default=EffectImporter;const migrations=[{version:"1.3.7",migrate:migrateEditorProps},{version:"1.4.2",migrate:migrateUVAttribute},{version:"1.4.7",migrate:migrateStandardTransparent},{version:"1.4.8",migrate:migrateApplyFog},{version:"1.4.9",migrate:migrateEnableDirShadow}],inspectorRE=/inspector\s*:/g;function migrateEditorProps(e){let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});r=r.replace(inspectorRE,"editor:"),fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}const UVAttribute=/in\s*vec2\s*a_texCoord\s*;/,inputIncludeRE=/include.*input/;function migrateUVAttribute(e){let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});r.match(inputIncludeRE)&&(r=r.replace(UVAttribute,"")),fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}const MacroStandardTransparent=/CC_STANDARD_TRANSPARENT/g,ReplaceTransparentWithForward="CC_FORCE_FORWARD_SHADING";function migrateStandardTransparent(e){let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});r.match(MacroStandardTransparent)&&(r=r.replace(MacroStandardTransparent,ReplaceTransparentWithForward)),fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}const MacroApplyFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_APPLY_FOG/g,ReplaceApplyFog="CC_APPLY_FOG",MacroTransferFog=/[a-zA-Z_][a-zA-Z_0-9]*\s*=\s*CC_TRANSFER_FOG/g,ReplaceTransferFog="CC_TRANSFER_FOG";function migrateApplyFog(e){let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});r.match(MacroApplyFog)&&(r=r.replace(MacroApplyFog,ReplaceApplyFog)),r.match(MacroTransferFog)&&(r=r.replace(MacroTransferFog,ReplaceTransferFog)),fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}const MacroEnableDirShadow=/&&\s*CC_ENABLE_DIR_SHADOW/g,ReplaceEnableDirShadow="";function migrateEnableDirShadow(e){let r=fs_extra_1.readFileSync(e.source,{encoding:"utf8"});r.match(MacroEnableDirShadow)&&(r=r.replace(MacroEnableDirShadow,ReplaceEnableDirShadow)),fs_extra_1.writeFileSync(e.source,r,{encoding:"utf8"})}