"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrate_1_0_10=exports.migrate_1_0_8=exports.changeCCType=exports.migrate_1_0_3=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),migrate_animation_clip_3_3_0_1=require("./migrates/migrate-animation-clip-3-3-0"),migrates_1=require("./scene/migrates"),migration_utils_1=require("./utils/migration-utils"),serialize_library_1=require("./utils/serialize-library"),cc=__importStar(require("cc")),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),archive_space_1=require("./migrates/archive-space");class AnimationImporter extends asset_db_1.Importer{get version(){return"2.0.3"}get name(){return"animation-clip"}get assetType(){return"cc.AnimationClip"}get migrations(){return[{version:"1.0.2",migrate:migrates_1.migrateImageUuid},{version:"1.0.3",migrate:migrate_1_0_3},{version:"1.0.4",async migrate(e){await migrates_1.migrateNameToId(e,!0)}},{version:"1.0.5",migrate:migrates_1.migrateNameToId},{version:"1.0.6",migrate:migrateType},{version:"1.0.7",migrate:migrateSharedMaterials},{version:"1.0.8",migrate:migrate_1_0_8},{version:"1.0.10",migrate:migrate_1_0_10},{version:"1.0.11",migrate:migrateComponentNames},{version:"2.0.0",migrate:async e=>{const t=e.getSwapSpace(),a=new migration_utils_1.Archive(t.json);await migrate_animation_clip_3_3_0_1.migrateAnimationClip330(a);const r=a.get();t.json=r}}]}get migrationHook(){return Object.assign(Object.assign({},migrates_1.migrationHook),{async pre(e){try{const t=path_2.default.join(e.temp,"migration-backup","source"),a=path_2.default.join(e.temp,"migration-backup","meta");await fs_extra_2.default.ensureDir(path_2.default.dirname(t)),await fs_extra_2.default.copyFile(e.source,t),await fs_extra_2.default.ensureDir(path_2.default.dirname(a)),await fs_extra_2.default.copyFile(`${e.source}.meta`,a)}catch(t){console.error(`Error when attempt to save asset ${e.source} before migration.`)}return await migrates_1.migrationHook.pre(e)},post:async(e,t)=>await migrates_1.migrationHook.post(e,t)})}async force(e){return e.userData.name!==e.basename}async import(e){var t;const a=e.userData;try{const r=fs_extra_1.readJSONSync(e.source),i=cc.deserialize.Details.pool.get(),s=cc.deserialize(r,i,void 0),n=i.uuidList.length;for(let e=0;e<n;++e){const a=i.uuidList[e],r=i.uuidObjList[e],s=i.uuidPropList[e],n=i.uuidTypeList[e],o=new(null!==(t=cc.js._getClassById(n))&&void 0!==t?t:cc.Asset);o._uuid=a+"",r[s]=o}s.name=path_1.basename(e.source,".anim"),a.name=s.name,s.hash;const{extension:o,data:c}=serialize_library_1.serializeForLibrary(s);await e.saveToLibrary(o,c)}catch(e){return console.error(e),!1}return!0}}exports.default=AnimationImporter;const walkCCClass=(e,t,a)=>{if(Array.isArray(e))e.forEach(e=>{walkCCClass(e,t,a)});else if(e&&"object"==typeof e)if(e.__type__===t)a(e);else for(const r of Object.values(e))walkCCClass(r,t,a)},walkCCClasses=(e,t)=>{if(Array.isArray(e))e.forEach((a,r)=>{e[r]=walkCCClasses(a,t)});else if(e&&"object"==typeof e){if(e.__type__ in t)return t[e.__type__](e);for(const a of Object.keys(e))e[a]=walkCCClasses(e[a],t)}return e};async function migrate_1_0_3(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);walkCCClass(t,cc.js.getClassName(cc.AnimationClip),e=>{const{_curves:t,curveDatas:a}=e;Array.isArray(t)&&0!==t.length&&"object"==typeof a&&0!==Object.keys(a).length&&delete e._curves})}function changeCCType(e,t){return e.__type__=t,e}async function migrate_1_0_8(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);walkCCClasses(t,{"cc.ComponentModifier":e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.ComponentPath)),"cc.HierachyModifier":e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.HierarchyPath)),"cc.UniformCurveValueAdapter":e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.UniformProxyFactory))})}async function migrate_1_0_10(e){const t=e.getSwapSpace(),a=t.json||await fs_extra_1.readJSON(e.source),r=new migration_utils_1.Archive(a);r.visitTypedObject(archive_space_1.ArchiveSpace.ANIMATION_CLIP_TYPE_NAME,e=>{if(!e.curveDatas)return;const t=function(e){const t=[];for(const a of Object.keys(e)){const r={__type__:"cc.animation.HierarchyPath",path:a},i=e[a];if(i.props)for(const e of Object.keys(i.props)){const a=i.props[e];t.push({modifiers:[r,e],data:a})}if(i.comps)for(const e of Object.keys(i.comps)){const a={__type__:"cc.animation.ComponentPath",component:e},s=i.comps[e];for(const e of Object.keys(s)){const i=s[e];t.push({modifiers:[r,a,e],data:i})}}}return t}(e.curveDatas);e._curves=t,delete e.curveDatas}),t.json=r.get()}async function migrateComponentNames(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<t.length;e++){const a=t[e],r=migrates_1._renameMap[a.component];r&&(a.component=r)}}async function migrateType(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);"cc.AnimationClip"!==t.__type__&&(t.__type__="cc.AnimationClip")}async function migrateSharedMaterials(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);if(!t)return;const a=t[0];if(!a||a.__type__!==cc_1.js.getClassName(cc_1.AnimationClip))return;const r=a._curves;r&&r.length>0&&r.forEach(e=>{if(e){const t=e.modifiers;t&&t.length>=2&&"sharedMaterials"===t[1]&&(t[1]="materials")}})}exports.migrate_1_0_3=migrate_1_0_3,exports.changeCCType=changeCCType,exports.migrate_1_0_8=migrate_1_0_8,exports.migrate_1_0_10=migrate_1_0_10;