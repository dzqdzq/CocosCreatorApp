"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TiledMapImporter=void 0;const asset_db_1=require("@editor/asset-db"),path=__importStar(require("path")),fs=__importStar(require("fs")),xmldom_1=require("xmldom"),sharp_1=__importDefault(require("sharp")),cc_1=require("cc"),image_utils_1=require("./utils/image-utils"),utils_1=require("../utils");async function searchDependFiles(e,t,a){const s=(new xmldom_1.DOMParser).parseFromString(a);if(!s)throw console.error(`failed to parse ${a}`),new Error(`TiledMap import failed: failed to parser ${t}`);let r=[];const i=[];let n=[],o=[];const l=s.documentElement,m=l.getElementsByTagName("tileset");for(let a=0;a<m.length;a++){const s=m[a],l=s.getAttribute("source");if(l){const a=path.join(path.dirname(t),l);if(e.depend(a),!fs.existsSync(a))return console.warn(`cannot find ${a}`),null;{i.push(a);const t=fs.readFileSync(a,"utf-8"),s=(new xmldom_1.DOMParser).parseFromString(t);if(s){const t=await parseTilesetImages(e,s,a);if(!t)return null;r=r.concat(t.imageFullPath),n=n.concat(t.imageBaseName),o=o.concat(t.imageSizes)}else console.warn("Parse %s failed.",a)}}const c=await parseTilesetImages(e,s,t);if(!c)return null;r=r.concat(c.imageFullPath),n=n.concat(c.imageBaseName),o=o.concat(c.imageSizes)}const c=[],u=[],p=l.getElementsByTagName("imagelayer");for(let a=0,s=p.length;a<s;a++){const s=p[a].getElementsByTagName("image");if(s&&s.length>0){const a=s[0].getAttribute("source"),r=path.join(path.dirname(t),a);if(e.depend(r),fs.existsSync(r)){c.push(r);let e=path.relative(path.dirname(t),r);e=e.replace(/\\/g,"/"),u.push(e)}else console.warn(`cannot find ${r}`)}}return{imgFullPaths:r,tsxFiles:i,imgBaseNames:n,imageLayerTextures:c,imageLayerTextureNames:u,imgSizes:o}}async function parseTilesetImages(e,t,a){const s=t.getElementsByTagName("image"),r=[],i=[],n=[];for(let t=0;t<s.length;t++){const o=s[t].getAttribute("source");if(o){const t=path.join(path.dirname(a),o);if(e.depend(t),!fs.existsSync(t))throw new Error(`Image does not exist: ${t}`);{const e=await sharp_1.default(t).metadata();n.push(new cc_1.Size(e.width,e.height)),r.push(t);const a=path.basename(t);i.push(a)}}}return{imageFullPath:r,imageBaseName:i,imageSizes:n}}class TiledMapImporter extends asset_db_1.Importer{get version(){return"1.0.2"}get name(){return"tiled-map"}get assetType(){return"cc.TiledMapAsset"}async validate(e){return!0}async import(e){await e.copyToLibrary(e.extname,e.source);const t=new cc_1.TiledMapAsset,a=fs.readFileSync(e.source,{encoding:"utf8"});t.name=path.basename(e.source,e.extname);const s=new cc_1.TextAsset;s.name=t.name,s.text=a,t.tmxXmlStr=a;const r=await searchDependFiles(e,e.source,a);if(!r)return!1;t.spriteFrames=r.imgFullPaths.map(e=>{const t=asset_db_1.queryAsset(e);if(t)return image_utils_1.changeImageDefaultType(t,"sprite-frame"),EditorExtends.serialize.asAsset(t.uuid+"@f9941",cc_1.SpriteFrame)}),t.spriteFrameNames=r.imgBaseNames,t.tsxFiles=r.tsxFiles.map(e=>{const t=asset_db_1.queryAsset(e);if(t)return EditorExtends.serialize.asAsset(t.uuid,cc_1.TextAsset)}),t.tsxFileNames=r.tsxFiles.map(e=>path.basename(e)),t.imageLayerSpriteFrame=r.imageLayerTextures.map(e=>{const t=asset_db_1.queryAsset(e);return EditorExtends.serialize.asAsset(t.uuid+"@f9941",cc_1.SpriteFrame)}),t.imageLayerSpriteFrameNames=r.imageLayerTextureNames.map(e=>path.basename(e)),t.spriteFrameSizes=r.imgSizes;const i=EditorExtends.serialize(t);await e.saveToLibrary(".json",i);const n=utils_1.getDependUUIDList(i);return e.setData("depends",n),!0}}exports.TiledMapImporter=TiledMapImporter;