"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),image_utils_1=require("./utils/image-utils"),fs_extra_1=require("fs-extra"),path_1=require("path"),cc_1=require("cc"),BlendFactor=cc_1.gfx.BlendFactor,{PositionType:PositionType,EmitterMode:EmitterMode}=cc_1.ParticleSystem2D,plist=require("plist"),defaultParticlesUseData={totalParticles:150,life:1,lifeVar:0,emissionRate:10,duration:-1,srcBlendFactor:BlendFactor.SRC_ALPHA,dstBlendFactor:BlendFactor.ONE_MINUS_CONSTANT_ALPHA,startColor:new cc_1.Color(255,255,255,255),startColorVar:new cc_1.Color(0,0,0,0),endColor:new cc_1.Color(255,255,255,0),endColorVar:new cc_1.Color(0,0,0,0),startSize:50,startSizeVar:0,endSize:0,endSizeVar:0,positionType:PositionType.FREE,sourcePos:new cc_1.Vec2(0,0),posVar:new cc_1.Vec2(0,0),angle:90,angleVar:20,startSpin:0,startSpinVar:0,endSpin:0,endSpinVar:0,emitterMode:EmitterMode.GRAVITY,gravity:new cc_1.Vec2(0,0),speed:180,speedVar:50,radialAccel:80,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,rotationIsDir:!1,startRadius:0,startRadiusVar:0,endRadius:0,endRadiusVar:0,rotatePerS:0,rotatePerSVar:0,spriteFrameUuid:""};function getBlendFactor2DTo3D(e){switch(e){case 0:return BlendFactor.ZERO;case 1:return BlendFactor.ONE;case 770:return BlendFactor.SRC_ALPHA;case 772:return BlendFactor.DST_ALPHA;case 771:return BlendFactor.ONE_MINUS_SRC_ALPHA;case 773:return BlendFactor.ONE_MINUS_DST_ALPHA;case 768:return BlendFactor.SRC_COLOR;case 774:return BlendFactor.DST_COLOR;case 769:return BlendFactor.ONE_MINUS_SRC_COLOR;case 775:return BlendFactor.ONE_MINUS_DST_COLOR}return e}class ParticleImporter extends asset_db_1.Importer{get version(){return"1.0.2"}get name(){return"particle"}get assetType(){return"cc.ParticleAsset"}async validate(e){try{return void 0!==plist.parse(await fs_extra_1.readFile(e.source,"utf8")).maxParticles}catch(e){return!1}}async import(e){const a=e.userData;Object.keys(defaultParticlesUseData).forEach(e=>{e in a||(a[e]=defaultParticlesUseData[e])});let t=!1;const r=path_1.extname(e.source);if(!await e.existsInLibrary(".json")&&this.assetDB){const i=plist.parse(await fs_extra_1.readFile(e.source,"utf8"));await this.syncParticleData(e);const s=this.createParticle(e);if(i.blendFuncSource&&(i.blendFuncSource=getBlendFactor2DTo3D(i.blendFuncSource)),i.blendFuncDestination&&(i.blendFuncDestination=getBlendFactor2DTo3D(i.blendFuncDestination)),i.textureImageData)delete i.textureFileName,delete i.spriteFrameUuid;else if(i.spriteFrameUuid)i.spriteFrameUuid.endsWith("@f9941")||(i.spriteFrameUuid=i.spriteFrameUuid+"@f9941"),e.depend(i.spriteFrameUuid),a.spriteFrameUuid=i.spriteFrameUuid,s.spriteFrame=EditorExtends.serialize.asAsset(i.spriteFrameUuid,cc_1.SpriteFrame),delete i.textureFileName,delete i.textureImageData;else if(i.textureFileName){const t=path_1.basename(i.textureFileName),r=path_1.join(path_1.dirname(e.source),t);e.depend(r);const o=this.assetDB.pathToUuid(r);if(!fs_extra_1.existsSync(r))return console.error(`Particle import failed: Unable to find file Texture, the path: ${r}`),!1;if(!o)return!1;{const e=this.assetDB.getAsset(o);await image_utils_1.changeImageDefaultType(e,"sprite-frame");const t=o+"@f9941";s.spriteFrame=EditorExtends.serialize.asAsset(t,cc_1.SpriteFrame),a.spriteFrameUuid=t,i.spriteFrameUuid=t,delete i.textureFileName,delete i.textureImageData}}const o=plist.build(i);await e.saveToLibrary(r,o),await e.saveToLibrary(".json",EditorExtends.serialize(s)),t=!0}return t}createParticle(e){const a=new cc.ParticleAsset;return a.name=e.basename,a._setRawAsset(e.extname),a}async syncParticleData(e){const a=e.userData,t=plist.parse(await fs_extra_1.readFile(e.source,"utf8"));a.totalParticles=parseInt(t.maxParticles||0),a.life=parseFloat(t.particleLifespan||0),a.lifeVar=parseFloat(t.particleLifespanVariance||0),a.emissionRate=t.emissionRate||Math.min(a.totalParticles/a.life,Number.MAX_VALUE),a.duration=parseFloat(t.duration||0),a.srcBlendFactor=parseInt(t.blendFuncSource||BlendFactor.SRC_ALPHA),a.dstBlendFactor=parseInt(t.blendFuncDestination||BlendFactor.ONE_MINUS_SRC_ALPHA);const r=a.startColor;r.r=255*parseFloat(t.startColorRed||0),r.g=255*parseFloat(t.startColorGreen||0),r.b=255*parseFloat(t.startColorBlue||0),r.a=255*parseFloat(t.startColorAlpha||0);const i=a.startColorVar;i.r=255*parseFloat(t.startColorVarianceRed||0),i.g=255*parseFloat(t.startColorVarianceGreen||0),i.b=255*parseFloat(t.startColorVarianceBlue||0),i.a=255*parseFloat(t.startColorVarianceAlpha||0);const s=a.endColor;s.r=255*parseFloat(t.finishColorRed||0),s.g=255*parseFloat(t.finishColorGreen||0),s.b=255*parseFloat(t.finishColorBlue||0),s.a=255*parseFloat(t.finishColorAlpha||0);const o=a.endColorVar;o.r=255*parseFloat(t.finishColorVarianceRed||0),o.g=255*parseFloat(t.finishColorVarianceGreen||0),o.b=255*parseFloat(t.finishColorVarianceBlue||0),o.a=255*parseFloat(t.finishColorVarianceAlpha||0),a.startSize=parseFloat(t.startParticleSize||0),a.startSizeVar=parseFloat(t.startParticleSizeVariance||0),a.endSize=parseFloat(t.finishParticleSize||0),a.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),a.positionType=parseFloat(void 0!==t.positionType?t.positionType:0),a.sourcePos=new cc_1.Vec2(0,0);const n=parseFloat(t.sourcePositionVariancex||0),l=parseFloat(t.sourcePositionVariancey||0);if(a.posVar=new cc_1.Vec2(n,l),a.angle=parseFloat(t.angle||0),a.angleVar=parseFloat(t.angleVariance||0),a.startSpin=parseFloat(t.rotationStart||0),a.startSpinVar=parseFloat(t.rotationStartVariance||0),a.endSpin=parseFloat(t.rotationEnd||0),a.endSpinVar=parseFloat(t.rotationEndVariance||0),a.emitterMode=parseInt(t.emitterType||0),a.emitterMode===EmitterMode.GRAVITY){const e=parseFloat(t.gravityx||0),r=parseFloat(t.gravityy||0);a.gravity=new cc_1.Vec2(e,r),a.speed=parseFloat(t.speed||0),a.speedVar=parseFloat(t.speedVariance||0),a.radialAccel=parseFloat(t.radialAcceleration||0),a.radialAccelVar=parseFloat(t.radialAccelVariance||0),a.tangentialAccel=parseFloat(t.tangentialAcceleration||0),a.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);let i=t.rotationIsDir||"";null!==i?(i=i.toString().toLowerCase(),a.rotationIsDir="true"===i||"1"===i):a.rotationIsDir=!1}else a.emitterMode===EmitterMode.RADIUS&&(a.startRadius=parseFloat(t.maxRadius||0),a.startRadiusVar=parseFloat(t.maxRadiusVariance||0),a.endRadius=parseFloat(t.minRadius||0),a.endRadiusVar=parseFloat(t.minRadiusVariance||0),a.rotatePerS=parseFloat(t.rotatePerSecond||0),a.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0))}}exports.default=ParticleImporter;