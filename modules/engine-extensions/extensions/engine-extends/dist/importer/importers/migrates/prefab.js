"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migratePrefab=exports.beforeMigratePrefab=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),PrefabInfo={__type__:"cc.PrefabInfo",targetOverrides:[]},addPrefabInfo=function(e,n){let t,_,o=n[0];if(o&&(o=o.data||o.scene)&&!(_=n[o.__id__]))return void console.warn(`Can not find root node, root info: ${n[0]}`);const r=_._prefab&&_._prefab.__id__;return r?t=n[r]:(t=JSON.parse(JSON.stringify(PrefabInfo)),n.push(t),_._prefab={__id__:n.length-1}),t.targetOverrides=e,t},TargetOverrideInfo={__type__:"cc.TargetOverrideInfo",source:null,sourceInfo:null,propertyPath:[],target:null,targetInfo:null},createTargetOverrideInfo=function(){return JSON.parse(JSON.stringify(TargetOverrideInfo))},PrefabLink={__type__:"cc.PrefabLink",_name:"",_objFlags:0,node:{__id__:2},_enabled:!0,__prefab:null,prefab:null,_id:"a6NH7Dj9tMVbatCdgoxYyz"},addPrefabLink=function(e,n,t){const _=e[t];if(!_||!_.asset)return-1;const o=JSON.parse(JSON.stringify(PrefabLink));return o.node={__id__:n},o.prefab={__uuid__:_.asset.__uuid__},e.push(o),e.length-1},PrefabInstance={__type__:"cc.PrefabInstance",fileId:"",prefabRootNode:null,mountedChildren:[],propertyOverrides:[],removedComponents:[]},addPrefabInstance=function(e,n,t){const _=JSON.parse(JSON.stringify(PrefabInstance));return t&&(_.prefabRootNode={__id__:1}),_.fileId=Editor.Utils.UUID.generate(),n.push(_),n[e].instance={__id__:n.length-1},_},CCPropertyOverrideInfo={__type__:"CCPropertyOverrideInfo",targetInfo:null,propertyPath:[],value:null},createPropertyOverrideInfo=function(e,n){const t=JSON.parse(JSON.stringify(CCPropertyOverrideInfo)),_=[];return"_lpos"===e?_.push("position"):"_lrot"===e?_.push("rotation"):"_lscale"===e?_.push("scale"):_.push(e),t.propertyPath=_,t.value=n,t},TargetInfo={__type__:"cc.TargetInfo",localID:[]},createTargetInfo=function(e){const n=JSON.parse(JSON.stringify(TargetInfo));return n.localID=e,n},CompPrefabInfo={__type__:"cc.CompPrefabInfo",fileId:""},addCompPrefabInfo=function(e,n){const t=n[e];if("cc.Node"!==t.__type__&&t.node){if(!n[t.node.__id__]._prefab)return;if(t.__prefab)return;const e=JSON.parse(JSON.stringify(CompPrefabInfo));e.fileId=Editor.Utils.UUID.generate(),n.push(e),t.__prefab={__id__:n.length-1}}},MountedChildrenInfo={__type__:"cc.MountedChildrenInfo",targetInfo:null,nodes:[]},addMountedChildrenInfo=function(e,n,t,_){const o=JSON.parse(JSON.stringify(MountedChildrenInfo));return o.nodes=_,{prefabInstanceID:e,mountedChildrenInfo:o,targetInfo:createTargetInfo(t)}},INSTANCE_RESERVED_KEYWORDS=["__type__","_objFlags","_parent","_prefab","_id"];function compareBaseProp(e,n,t,_,o){const r=[],a=["_lpos","_lrot","_lscale","_active","_name","_layer"];for(const o of a){const a=n[o],s=t[o];if(JSON.stringify(a)!==JSON.stringify(s)){const n=createPropertyOverrideInfo(o,a),t=createTargetInfo(_);r.push({prefabInstanceID:e,propertyOverrideInfo:n,targetInfo:t})}}return r}function compareComponentIDProp(e,n,t,_,o,r,a,s){const i=o[n];if(!i)return null;const c="cc.Node"!==i.__type__;let f,d;if(c){if(!(d=i.node&&i.node.__id__))return null;f=o[d]}else f=i,d=n;const p=f&&f._prefab&&f._prefab.__id__,l=p&&o[p],u=l&&l.root&&l.root.__id__;if(!l||!l.asset||r.has(u)||0===l.asset.__id__)return null;const b=o[u];if(!b)return null;const I=createTargetOverrideInfo();I.propertyPath=e;let h=[];const g=totalPrefab.get(l.asset.__uuid__);if(!g)return console.warn(`Cannot get Base Prefab by UUID: ${l.asset.__uuid__}, PrefabInfo ID: ${d} name: ${f._name}.`),null;const m=g[0]&&g[0].data&&g[0].data.__id__,y=g&&g[m];let P,O;if(u===d)P=y,O=m;else{const e=b._children.findIndex(e=>e.__id__===d);P=g[O=y._children[e]&&y._children[e].__id__]}if(c){const e=f._components.findIndex(e=>e.__id__===n),t=P&&P._components[e]&&P._components[e].__id__,_=t&&g[t];if(!_||i.__type__!==_.__type__)return void r.set(u,p);h=getLocalID(t,g,c)}else{if(!P)return void r.set(u,p);h=getLocalID(O,g,c)}I.source={__id__:t};const v=createTargetInfo(h);return I.target={__id__:l.root.__id__},{emptyProp:s,targetOverrideInfo:I,sourceInfo:_,targetInfo:v}}const SKIP_COMPONENT_KEY=["_name","_objFlags","node","__prefab","_id"];function compareComponentProp(e,n,t,_,o,r){const a=[],s=n.__id__,i=_[s],c=t&&t.__id__,f=o[c];if(!f)return a;let d=[];d=i.__prefab?getLocalID(c,o,!0):getLocalID(s,_,!0);for(const n in i){if(SKIP_COMPONENT_KEY.includes(n))continue;const t=i[n];if(t){if(r[s]===n)continue}const _=f[n];if(JSON.stringify(t)!==JSON.stringify(_)){const _=createPropertyOverrideInfo(n,t),o=createTargetInfo(d);a.push({prefabInstanceID:e,propertyOverrideInfo:_,targetInfo:o})}}return a}function isEqual(e,n,t,_){if(!e._prefab||!n._prefab)return!1;const o=_[e._prefab.__id__],r=t[n._prefab.__id__];if(!o||!r)return!1;if("__uuid__"in r.asset&&o.asset.__uuid__!==r.asset.__uuid__)return!1;if(!!o.sync)return!0;if(e.__type__!==n.__type__)return!1;if(e._children&&!n._children||!e._children&&n._children||!e._children&&!n._children)return!1;if(e._children.length<n._children.length)return!1;const a=e._children.map(e=>_[e.__id__]),s=n._children.map(e=>t[e.__id__]);for(let e=0;e<a.length;++e){if(s[e]&&!isEqual(a[e],s[e],t,_))return!1}if(e._components&&!n._components||!e._components&&n._components||!e._components&&!n._components)return!1;if(e._components.length!==n._components.length)return!1;const i=e._components.map(e=>_[e.__id__]),c=n._components.map(e=>t[e.__id__]);for(let e=0;e<i.length;++e){const n=i[e],t=c[e];if(!n||!t)return!1;if("cc.SkeletalAnimation"===n.__type__&&n._sockets.length>0)return!1;if(n.__type__!==t.__type__)return!1}return!0}function isDiff(e,n){if(!e.asset)return!0;const t=e.root&&e.root.__id__,_=e.asset&&e.asset.__uuid__,o=totalPrefab.get(_);if(!o)return console.warn(`Cannot get Prefab by UUID: ${_}\n PrefabInfo ID: ${t} name: ${n[t]._name} \n`),!0;const r=n[t],a=o[0]&&o[0].data&&o[0].data.__id__;return!isEqual(r,a&&o[a],o,n)}function addInstanceFileID(e,n,t){if(e.instance){const _=n[e.instance.__id__];_&&t.push(_.fileId)}}function getLocalID(e,n,t=!1){const _=[];if(t){const t=n[e];if(t){const e=t.node&&n[t.node.__id__];if(e._prefab){addInstanceFileID(e._prefab&&n[e._prefab.__id__],n,_)}const o=t.__prefab&&t.__prefab.__id__;if(o){const e=n[o];_.push(e.fileId)}}}else{const t=n[e],o=t._prefab&&n[t._prefab.__id__];o&&(addInstanceFileID(o,n,_),_.push(o.fileId))}return _}function isMountedChild(e,n,t,_){const o=e._prefab&&e._prefab.__id__;if(o){if(t[o].sync)return!1}return e.__type__!==n.__type__}function compareChildren(e,n,t,_,o,r){let a=[],s=[],i=[];if(n._children)for(let c=0;c<n._children.length;++c){const f=n._children[c],d=f&&f.__id__,p=d&&o[d];if(!p)continue;const l=t._children[c];if(!l){i.push({__id__:d});continue}const u=l.__id__,b=_[u];if(isMountedChild(p,b,o,_)){i.push({__id__:d});continue}if(p._prefab){a=getLocalID(u,_);const n=compareChildren(e,p,b,_,o,r);n&&(s=s.concat(n.childPropertyOverrides),i=i.concat(n.childMountedNodes))}else a=getLocalID(d,o);const I=compareBaseProp(e,p,b,a,o);s=s.concat(I)}if(n._components)for(let a=0;a<n._components.length;++a){const i=compareComponentProp(e,n._components[a],t._components[a],o,_,r);s=s.concat(i)}return{childPropertyOverrides:s,childMountedNodes:i}}function comparePrefab(e,n,t,_){let o=null,r=[];const a=e.root&&e.root.__id__,s=a&&n[a],i=e.asset.__uuid__,c=totalPrefab.get(i);if(!c)return void console.warn(`Cannot get Base Prefab by UUID: ${i}, PrefabInfo ID: ${a} name: ${s._name}.`);const f=c[c[0]&&c[0].data&&c[0].data.__id__];if(!f)return;const d=(f._prefab&&c[f._prefab.__id__]).fileId;let p=s._prefab&&n[s._prefab.__id__];p&&!p.instance&&(addPrefabInstance(s._prefab.__id__,n,t),p=n[s._prefab.__id__]);const l=p&&p.instance&&p.instance.__id__,u=compareBaseProp(l,s,f,[d],n);r=r.concat(u);const b=compareChildren(l,s,f,c,n,_),{childPropertyOverrides:I,childMountedNodes:h}=b;if(r=r.concat(I),h.length>0){o=addMountedChildrenInfo(l,n,[d],h)}return{propertyOverrides:r,mountedChildrenInfo:o,childMountedNodes:h}}function updateReplaceIDs(e,n,t){const _=(JSON.stringify(n).match(/(?<="__id__":)([0-9]+)/g)||[]).map(e=>Number(e));for(const n of e)for(let e=0;e<_.length;++e){const o=_[e];let r=t[e];r||(r={baseID:o,newID:o},t.push(r)),o>n&&r.newID--}}function addRemoveID(e,n){n.includes(e)||n.push(e)}function addRemove(e,n,t,_=!0){const o=n[e];o._prefab&&(addRemoveID(o._prefab.__id__,t),o._prefab=null),o.__prefab&&(addRemoveID(o.__prefab.__id__,t),o.__prefab=null),o.instance&&(addRemoveID(o.instance.__id__,t),o.instance=null),_&&addRemoveID(e,t)}function restoreNormalNodes(e,n,t){const _=e._prefab&&e._prefab.__id__;if(!_||!n[_].instance){if(e._children){const _=e._children.map(e=>n[e.__id__]);for(const e of _)restoreNormalNodes(e,n,t)}if(e._components)for(let t=0;t<e._components.length;++t){const _=n[e._components[t].__id__];_&&_.__prefab&&(_.__prefab=null)}_&&(e._prefab=null)}}const totalPrefab=new Map;async function beforeMigratePrefab(e){const n=e.getSwapSpace().json;if(0===totalPrefab.size){const e=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Prefab"});for(const n of e)!totalPrefab.has(n.uuid)&&n.file&&totalPrefab.set(n.uuid,(0,fs_extra_1.readJSONSync)(n.file))}const t=n[0]&&"cc.Prefab"===n[0].__type__;for(let e=0;e<n.length;++e){const _=n[e];addCompPrefabInfo(e,n),"cc.PrefabInfo"===_.__type__&&(_.fileId||(_.fileId=Editor.Utils.UUID.generate()),_.sync&&addPrefabInstance(e,n,t))}t&&totalPrefab.set(e.uuid,n)}function removeAllChild(e,n,t,_=!0,o){const r=n[e];for(const e of r._children){const r=Number(e.__id__);o&&o.includes(r)||(addRemove(r,n,t,_),removeAllChild(r,n,t,_,o))}n[e]._children.length=[];for(const e of r._components){addRemove(Number(e.__id__),n,t,_)}n[e]._components.legnth=[]}function getTargetOverrideInfoForComponents(e,n,t,_,o,r,a){const s=[],i=_[e],c=_[i.node&&i.node.__id__];let f=e,d=null;const p=!o,l=c&&c._prefab&&_[c._prefab.__id__];if(l&&!p){const e=l.asset&&0===l.asset.__id__;if(!(l.root&&r.has(l.root.__id__))&&!e){const e=getLocalID(n,o,!0);d=createTargetInfo(e),f=l.root.__id__}}for(const n of t){let t;const o=i[n];if(o&&Array.isArray(o)&&o[0]&&o[0].__id__)for(let i=0;i<o.length;++i){const c=o[i];if(!c)continue;const l={componentID:e,key:n,idx:i};(t=compareComponentIDProp([n,i.toString()],c.__id__,f,d,_,r,p,l))&&(a[e]=l.key,s.push(t))}else if(o&&o.__id__){const i={componentID:e,key:n,idx:-1};(t=compareComponentIDProp([n],o.__id__,f,d,_,r,p,i))&&(a[e]=i.key,s.push(t))}}return s}async function migratePrefab(e){const n=e.getSwapSpace(),t=n.json,_=[];for(const t of n.json){if("cc.PrefabInfo"!==t.__type__||!t.asset||!t.asset.__uuid__||t.asset.__uuid__===e.uuid)continue;const n=t.asset.__uuid__;if(!_.includes(n)){_.push(n);const t=(0,asset_db_1.queryAsset)(n);if(t){t._init||(e._assetDB.taskManager.pause(e.task),await t.waitInit(),e._assetDB.taskManager.resume(e.task));try{const e=(0,fs_extra_1.readJSONSync)(t.library+".json");totalPrefab.has(n)||totalPrefab.set(n,e)}catch(e){console.error(e)}}else console.warn(`depends aseet uuid: ${n} missing in the scene: ${e.basename}`)}}const o=t[0]&&"cc.Prefab"===t[0].__type__,r=o?"prefab":"scene",a=new Map,s=[],i=new Map;let c=[],f=[],d=[],p=[];const l=[];for(let n=0;n<t.length;++n){const _=t[n];if("cc.Node"===_.__type__&&_._prefab){const o=_._prefab.__id__,s=t[o];if(!s||!s.root||!s.asset){i.get(n)||i.set(n,o),console.warn(`Prefab asset missing, name: ${_._name} in the ${r} : ${e.basename}.`);continue}let c=a.get(s.root.__id__);c?c.push(o):c=[o],a.set(s.root.__id__,c)}}a.forEach((e,n,_)=>{const r=t[n];if(!r)return void console.warn(`The prefab is bad. id: ${n}`);const a=r._prefab&&r._prefab.__id__,s=t[a];let c=!0;o&&(c=!!s.instance&&!s.sync),c&&isDiff(s,t)&&!i.get(n)&&i.set(n,a)});for(const n of t)if("cc.Node"===n.__type__&&n._components){const _=n._components.map((e,n)=>{const _=t[e.__id__],o=[];for(const e in _){const n=_[e];!SKIP_COMPONENT_KEY.includes(e)&&n&&((Array.isArray(n)?n[0]&&n[0].__id__:n&&n.__id__)&&o.push(e))}if(o.length>0)return{index:n,__id__:e.__id__,keys:o}}).filter(Boolean);if(0===_.length)continue;let o;const a=n._prefab&&n._prefab.__id__;if(n._prefab){const _=t[a],s=_&&_.asset&&_.asset.__uuid__;0===(_.asset&&_.asset.__id__)?o=t:s&&((o=totalPrefab.get(s))||console.warn(`Cannot get Prefab by UUID: ${s}, the node name: ${n._name} in the ${r} : ${e.basename}`))}const s=o&&o[1];for(const e of _){const n=e.index,_=e.__id__,r=e.keys,a=getTargetOverrideInfoForComponents(_,s&&s._components[n]&&s._components[n].__id__,r,t,o,i,l);p=p.concat(a)}}a.forEach((e,n,_)=>{const r=t[n];if(!r)return;const a=r._prefab.__id__,s=t[a];let p=!0,u=!0;if(o&&(u=!!s.instance&&!s.sync,p=!!s.instance),(!u||!i.has(n))&&p)try{const e=comparePrefab(s,t,o,l);if(e){const{propertyOverrides:n,mountedChildrenInfo:t,childMountedNodes:_}=e;t&&(f=f.concat(t),c=c.concat(_)),d=d.concat(n)}}catch(e){a&&!i.has(n)&&i.set(n,a),console.error(e)}}),a.forEach((e,n,_)=>{if(i.has(n))return;const o=t[n],r=o._prefab&&o._prefab.__id__;r&&r.instance&&removeAllChild(n,t,s,!0,c);for(const n of e){const e=t[n];if(e.instance)for(const e in o)INSTANCE_RESERVED_KEYWORDS.includes(e)||delete o[e];delete e.sync,delete e._synced}});for(const e of d){t.push(e.targetInfo);const n=t.length-1;e.propertyOverrideInfo.targetInfo={__id__:n},t.push(e.propertyOverrideInfo);const _=t.length-1;t[e.prefabInstanceID].propertyOverrides.push({__id__:_})}for(const e of f){t.push(e.targetInfo);const n=t.length-1;e.mountedChildrenInfo.targetInfo={__id__:n},t.push(e.mountedChildrenInfo);const _=t.length-1;t[e.prefabInstanceID].mountedChildren.push({__id__:_})}if(p.length>0){const e=[];for(const n of p){const _=n.emptyProp&&n.emptyProp.componentID;if(_){const e=t[_],n=e&&e.node&&e.node.__id__,o=t[n],r=o._prefab&&o._prefab.__id__,a=t[r],s=a&&a.root&&a.root.__id__;if(s&&i.has(s))continue}if(n.sourceInfo){t.push(n.sourceInfo);const e=t.length-1;n.targetOverrideInfo.sourceInfo={__id__:e}}if(n.targetInfo){t.push(n.targetInfo);const e=t.length-1;t.length;n.targetOverrideInfo.targetInfo={__id__:e}}t.push(n.targetOverrideInfo);const o=t.length-1;e.push({__id__:o});const r=n.emptyProp;if(r){const e=t[r.componentID];let n=e[r.key];Array.isArray(n)?n[r.idx]=null:n=null,e[r.key]=n}}addPrefabInfo(e,t)}for(const e of c){const n=e.__id__,_=t[n],o=t[_._prefab.__id__];if(o.instance)continue;const r=o.root&&o.root.__id__;if(r&&i.has(r))continue;const a=!o;addRemove(n,t,s,a),removeAllChild(n,t,s,a),_._prefab=null}i.forEach((e,n,_)=>{const o=t[n];if(t[e].instance)return;restoreNormalNodes(o,t,s);const r=addPrefabLink(t,n,e);-1!==r&&o._components.push({__id__:r})}),n.json=t}exports.beforeMigratePrefab=beforeMigratePrefab,exports.migratePrefab=migratePrefab;