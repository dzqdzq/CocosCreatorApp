"use strict";var Helper_1,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,r,i){var o,c=arguments.length,a=c<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(a=(c<3?o(a):c>3?o(t,r,a):o(t,r))||a);return c>3&&a&&Object.defineProperty(t,r,a),a},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateAnimationClip330=void 0;const migration_utils_1=require("../utils/migration-utils"),cc=__importStar(require("cc")),archive_space_1=require("./archive-space"),animation_clip_migration_1=require("cc/editor/animation-clip-migration");let Helper=Helper_1=class{constructor(){this.duration=0,this._keys=[],this._curves=[],this._commonTargets=[]}static createFromSerializedLegacyClip(e){var t,r,i,o,c;const a=new ArrayBuffer(0),n=null!==(t=e.duration)&&void 0!==t?t:0,s=(null!==(r=e._keys)&&void 0!==r?r:[]).map(e=>decodeMaybeCompactValueTypeArray(e,a)),l=null!==(i=e._curves)&&void 0!==i?i:[];l.forEach(e=>{decodeMaybeCompactValueTypeArray(e.data.values,a)});const _=null!==(o=e._commonTargets)&&void 0!==o?o:[],d=new migration_utils_1.Archive,u=d.addTypedObject(cc.js.getClassName(Helper_1));u.duration=n,u._keys=s,u._curves=l,u._commonTargets=_;const p=cc.deserialize.Details.pool.get(),m=d.get(u),y=cc.deserialize(m,p,void 0),v=p.uuidList.length;for(let e=0;e<v;++e){const t=p.uuidList[e],r=p.uuidObjList[e],i=p.uuidPropList[e],o=p.uuidTypeList[e],a=new(null!==(c=cc.js._getClassById(o))&&void 0!==c?c:cc.Asset);a._uuid=t+"",r[i]=a}return y}toLegacyData(){const e=new animation_clip_migration_1.AnimationClipLegacyData(this.duration);return e.keys=this._keys,e.curves=this._curves,e.commonTargets=this._commonTargets,e}};async function migrateAnimationClip330(e){e.visitTypedObject(archive_space_1.ArchiveSpace.ANIMATION_CLIP_TYPE_NAME,e=>{const t=Helper.createFromSerializedLegacyClip(e).toLegacyData(),r=e.events;delete e._keys,delete e._curves,delete e._commonTargets,delete e._stepness,delete e.events;const i=t.toTracks(),o=new migration_utils_1.Archive(EditorExtends.serialize(i,{stringify:!1})),c=e;c._tracks=o.root,c._events=r,c._exoticAnimation=null})}function decodeMaybeCompactValueTypeArray(e,t){if(Array.isArray(e))return e;return cc.deserialize(e,void 0,void 0).decompress(t)}__decorate([cc._decorator.property],Helper.prototype,"duration",void 0),__decorate([cc._decorator.property],Helper.prototype,"_keys",void 0),__decorate([cc._decorator.property],Helper.prototype,"_curves",void 0),__decorate([cc._decorator.property],Helper.prototype,"_commonTargets",void 0),Helper=Helper_1=__decorate([cc._decorator.ccclass("cc._internal.migrate-animation_clip-3-3-0.Helper")],Helper),exports.migrateAnimationClip330=migrateAnimationClip330;