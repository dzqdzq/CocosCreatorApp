"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),script_compiler_1=require("./utils/script-compiler"),utils_1=require("../utils");class JavascriptImporter extends asset_db_1.Importer{constructor(e){super(e)}get version(){return"4.0.23"}get name(){return"javascript"}get assetType(){return"cc.Script"}get migrations(){return[{version:"4.0.22",migrate(e){const t=e.userData,r=e.userData;!0===t.simulateGlobals?r.simulateGlobals=void 0:!1!==t.simulateGlobals&&void 0!==t.simulateGlobals||(r.simulateGlobals=[])}},{version:"4.0.23",migrate(e){const t=e.userData;void 0!==t.importAsPlugin&&delete t.importAsPlugin}}]}async import(e){if(!(e instanceof asset_db_1.Asset))return console.error("Expect non-virtual asset"),!1;const t=e.userData;try{return!t.isPlugin||await this._importPluginScript(e)}catch(t){return console.error(utils_1.i18nTranslate("asset-db.importers.javascript.transform_failure",{path:e.source,reason:t}),utils_1.linkToAssetTarget(e.uuid)),!1}}async _importPluginScript(e){const t=await fs_extra_1.readFile(e.source,"utf-8"),{executionScope:r="enclosed",experimentalHideCommonJs:s,experimentalHideAmd:i,simulateGlobals:a}=e.userData;if("global"===r)return await e.saveToLibrary(".js",t),!0;const o=void 0===a?["self","window","global","globalThis"]:a,l=await script_compiler_1.transformPluginScript(t,{simulateGlobals:o,hideCommonJs:null===s||void 0===s||s,hideAmd:null===i||void 0===i||i});return await e.saveToLibrary(".js",l.code),!0}}exports.default=JavascriptImporter;