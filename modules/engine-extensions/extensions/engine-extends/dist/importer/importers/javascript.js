"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JavascriptImporter=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),script_compiler_1=require("./utils/script-compiler"),utils_1=require("../utils");class JavascriptImporter extends asset_db_1.Importer{constructor(e){super(e)}get version(){return"4.0.23"}get name(){return"javascript"}get assetType(){return"cc.Script"}get migrations(){return[{version:"4.0.22",migrate(e){const r=e.userData,t=e.userData;!0===r.simulateGlobals?t.simulateGlobals=void 0:!1!==r.simulateGlobals&&void 0!==r.simulateGlobals||(t.simulateGlobals=[])}},{version:"4.0.23",migrate(e){const r=e.userData;void 0!==r.importAsPlugin&&delete r.importAsPlugin}}]}async import(e){if(!(e instanceof asset_db_1.Asset))return console.error("Expect non-virtual asset"),!1;const r=e.userData;try{return!r.isPlugin||await this._importPluginScript(e)}catch(r){return console.error(utils_1.i18nTranslate("asset-db.importers.javascript.transform_failure",{path:e.source,reason:r}),utils_1.linkToAssetTarget(e.uuid)),!1}}async _importPluginScript(e){const r=await fs_extra_1.readFile(e.source,"utf-8"),{executionScope:t="enclosed",experimentalHideCommonJs:s,experimentalHideAmd:i,simulateGlobals:a}=e.userData;if("global"===t)return await e.saveToLibrary(".js",r),!0;const o=void 0===a?["self","window","global","globalThis"]:a,l=await script_compiler_1.transformPluginScript(r,{simulateGlobals:o,hideCommonJs:null===s||void 0===s||s,hideAmd:null===i||void 0===i||i});return await e.saveToLibrary(".js",l.code),!0}}exports.JavascriptImporter=JavascriptImporter;