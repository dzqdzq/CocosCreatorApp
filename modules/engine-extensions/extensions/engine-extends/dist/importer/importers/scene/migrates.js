"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,o){void 0===o&&(o=a),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,o){void 0===o&&(o=a),e[o]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateFogData=exports.migrateHDRData=exports.migrateShadowAutoAdapt=exports.migratePrivateNode=exports.migrateShadowDepthBias=exports.migrateShadowInfo=exports.migratePrefabCompPrefabInfo=exports.migrateUILayout=exports._renameMap=exports.migrateShadow=exports.migrateScrollAndPageViewComponenetModule=exports.migrateParticleComponentModule=exports.migrateParticleModule=exports.migrateSkybox=exports.migrateUIPriority=exports.migrateWidgetComponent=exports.migrateSavePrefabInfoAgain=exports.migrateSavePrefabInfo=exports.migrateDefaultLayer=exports.migrateNameToId=exports.migrateAnimationName=exports.migrateImageUuid=exports.migrations=exports.migrationHook=void 0;const asset_db_1=require("@editor/asset-db"),utils_1=require("@editor/asset-db/libs/utils"),cc=__importStar(require("cc")),fs_extra_1=require("fs-extra"),path_1=require("path"),reader_manager_1=require("../gltf/reader-manager"),utils_2=require("./utils"),components_1=require("../migrates/components"),prefab_1=require("../migrates/prefab"),migration_utils_1=require("../utils/migration-utils"),migrate_curve_range_3_3_0_1=require("../migrates/migrate-curve-range-3-3-0"),migrate_geometry_curve_3_3_0_1=require("../migrates/migrate-geometry-curve-3-3-0"),migrate_prefab_1_1_34_1=require("./migrate-prefab-1-1-34"),{clamp:clamp}=Editor.Utils.Math;async function migrateImageUuid(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);utils_2.walk(t,e=>{if(!("__uuid__"in e))return;const t=e.__uuid__;if(!/@/.test(t))return;const a=t.split("@");let o;const i=asset_db_1.queryAsset(a[0]);if(i&&(o=i),o&&"image"===o.meta.importer)switch(o.meta.userData.type){case"raw":break;case"texture":a[1]="texture";break;case"normal map":a[1]="normalMap";break;case"texture cube":a[1]="textureCube";break;case"sprite-frame":a[1]="spriteFrame"}e.__uuid__=a.join("@")})}exports.migrationHook={async pre(e){e.getSwapSpace().json=await fs_extra_1.readJSON(e.source)},async post(e,t){const a=e.getSwapSpace();if(t>0){const t=JSON.stringify(a.json,null,2);await fs_extra_1.writeFile(e.source,t)}delete a.json}},exports.migrations=[{version:"1.0.4",migrate:migrateImageUuid},{version:"1.0.5",migrate:migrateSkinningRoot},{version:"1.0.6",migrate:migrateAnimationName},{version:"1.0.13",migrate:migrateVisibility},{version:"1.0.14",migrate:migrateClearFlags},{version:"1.0.15",migrate:async e=>{await migrateNameToId(e,!0)}},{version:"1.0.16",migrate:migrateDefaultLayer},{version:"1.0.18",migrate:migrateCameraVisibility},{version:"1.0.20",migrate:migrateNameToId},{version:"1.0.21",migrate:migrateWidgetComponent},{version:"1.0.22",migrate:migrateUIPriority},{version:"1.0.23",migrate:migrateSkybox},{version:"1.0.24",migrate:migrateSkinningMaterial},{version:"1.0.25",migrate:migrateBackSkinningMaterial},{version:"1.0.26",migrate:migrateSkinningMaterialForMeshSplit},{version:"1.0.27",migrate:migrateCapsuleColliderHeight},{version:"1.0.28",migrate:migrateParticleModule},{version:"1.0.29",migrate:migrateParticleComponentModule},{version:"1.0.31",migrate:async e=>{}},{version:"1.0.32",migrate:migrateShadow},{version:"1.1.0",migrate:migrateComponentNames},{version:"1.1.20",migrate:migrateClickEventsNames},{version:"1.1.21",migrate:migrateCanvasAddWidget},{version:"1.1.22",migrate:migrateRigidBody},{version:"1.1.23",migrate:migrateUICustomMaterial},{version:"1.1.24",migrate:migrateVisibilityTypeError},{version:"1.1.25",migrate:migrateUILayout},{version:"1.1.26",migrate:migrateCanvasCamera},{version:"1.1.27",migrate:async e=>{await migratePrefabCompPrefabInfo(e),await prefab_1.beforeMigratePrefab(e),await prefab_1.migratePrefab(e);const t=e.getSwapSpace();t&&t.json&&(t.json=JSON.parse(JSON.stringify(t.json)))}},{version:"1.1.29",migrate:async e=>{await migrateShadowInfo(e)}},{version:"1.1.30",migrate:migrateGeometryCurveCurveRange330},{version:"1.1.31",migrate:async e=>{await migrateShadowDepthBias(e)}},{version:"1.1.32",migrate:async e=>{await migratePrivateNode(e)}},{version:"1.1.33",migrate:async e=>{await migrateShadowAutoAdapt(e)}},{version:"1.1.34",migrate:async e=>{await migrate_prefab_1_1_34_1.migratePrefabInstanceRoots(e)}},{version:"1.1.35",migrate:async e=>{await migrateHDRData(e),await migrateFogData(e)}}],exports.migrateImageUuid=migrateImageUuid;const animationRE=/AnimationComponent/i,skinningRE=/SkinningModelComponent/i;async function migrateSkinningRoot(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t){if(!skinningRE.test(e.__type__))continue;const a=e._skinningRoot&&e._skinningRoot.__id__;if(utils_2.getComponent(t,a,animationRE))continue;let o=e.node.__id__;for(;o===e.node.__id__||!utils_2.getComponent(t,o,animationRE);){const e=t[o]._parent;o=e&&e.__id__||null}null!==o&&(e._skinningRoot={__id__:o})}fs_extra_1.writeJSONSync(e.source,t,{spaces:2})}async function migrateAnimationName(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);await utils_2.walkAsync(t,async t=>{if(!("__uuid__"in t))return;const a=t.__uuid__;if(!/@/.test(a))return;const o=a.split("@");let i;const n=asset_db_1.queryAsset(o[0]);n&&(i=n),i&&(e._assetDB.taskManager.pause(e.task),await i.waitInit(),e._assetDB.taskManager.resume(e.task),Object.keys(i.subAssets).some(e=>{const t=e.replace(/[ <>:'#\/\\|?*\x00-\x1F]/g,"-");if(o[1]===t)return o[1]=e,!0})),t.__uuid__=o.join("@")}),fs_extra_1.writeJSONSync(e.source,t,{spaces:2})}exports.migrateAnimationName=migrateAnimationName;const MissingClass=EditorExtends.MissingReporter.classInstance;function classFinder(e,t,a,o){const i=MissingClass.classFinder(e,t,a,o);return i||cc.MissingScript}async function migrateNormalizeScene(e){if(".scene"!==e.extname)return;const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source),a=cc.deserialize.Details.pool.get();MissingClass.hasMissingClass=!1;const o=cc.deserialize(t,a,{createAssetRefs:!0,ignoreEditorOnly:!1,classFinder:classFinder});if(o instanceof cc.SceneAsset){const e=o.scene;null!==e&&(e._lpos&&(e._lpos.x=e._lpos.y=e._lpos.z=0),e._lscale&&(e._lscale.x=e._lscale.y=e._lscale.z=1),e._lrot&&(e._lrot.x=e._lrot.y=e._lrot.z=0,e._lrot.w=1),e._euler&&(e._euler.x=e._euler.y=e._euler.z=0),e._components&&(e._components=[]))}fs_extra_1.writeFileSync(e.source,EditorExtends.serialize(o)),MissingClass.reset()}classFinder.onDereferenced=MissingClass.classFinder.onDereferenced;const cameraRE=/CameraComponent/i;async function migrateVisibility(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)if(cameraRE.test(e.__type__)&&(e._visibility=1619001344),void 0!==e._visFlags&&(e._visFlags&=~(1<<30)),e.node){const a=t[e.node.__id__]._layer;2&a&&(t[e.node.__id__]._layer&=-3,t[e.node.__id__]._layer|=1<<20),4&a&&(t[e.node.__id__]._layer&=-5,t[e.node.__id__]._layer|=1<<21),8&a&&(t[e.node.__id__]._layer&=-9,t[e.node.__id__]._layer|=1<<22),16&a&&(t[e.node.__id__]._layer&=-17,t[e.node.__id__]._layer|=1<<23),t[e.node.__id__]._layer|=1<<30}}async function migrateClearFlags(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source),a=/SkyboxInfo/i,o=t.find(e=>a.test(e.__type__));if(o&&o._enabled)for(const e of t)cameraRE.test(e.__type__)&&(e._clearFlags=cc.Camera.ClearFlag.SKYBOX)}async function migrateNameToId(e,t){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);utils_2.walk(a,e=>{const a=e.__uuid__;if(!/@/.test(a))return;const o=a.split("@");if(o.length<=1)return;for(let e=1;e<o.length;e++)o[e]=utils_1.nameToId(o[e]);const i=o.join("@");(!0===t||asset_db_1.queryAsset(i))&&(e.__uuid__=i)})}async function migrateDefaultLayer(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)if(e.node){1073741825===t[e.node.__id__]._layer&&(t[e.node.__id__]._layer=1073741824)}}async function migrateSavePrefabInfo(e){if(".prefab"!==e.extname)return;const t=e.getSwapSpace(),a=t.json||await fs_extra_1.readJSON(e.source);let o=!1,i=!1;for(const e of a)e.__type__.startsWith("cc.Scene")&&(o=!0),e.__type__.startsWith("cc.PrefabInfo")&&(i=!0);if(!o&&i)return;const n=cc.deserialize.Details.pool.get();MissingClass.hasMissingClass=!1;const r=cc.deserialize(a,n,{createAssetRefs:!0,ignoreEditorOnly:!1,classFinder:classFinder});r.data.parent=null,function e(t,a){const o=t.parent&&t.parent._prefab;const i=new cc.Prefab._utils.PrefabInfo;i.asset=a||(null===o||void 0===o?void 0:o.asset);i.root=o&&o.root||t;i.fileId=t._prefab?t._prefab.fileId:t.uuid;t._prefab=i;Array.isArray(t.children)&&t.children.forEach(t=>{t.parent&&t.parent._prefab&&e(t,null)})}(r.data,r),t.json=JSON.parse(EditorExtends.serialize(r)),MissingClass.reset()}function migrateSavePrefabInfoAgain(e){migrateSavePrefabInfo(e)}async function migrateCameraVisibility(e){(e.getSwapSpace().json||await fs_extra_1.readJSON(e.source)).forEach(e=>{"cc.CameraComponent"===e.__type__?1619001344===e._visibility?e._visibility=1822425087:1610612736===e._visibility&&(e._visibility=1822425087):"cc.Node"!==e.__type__&&"cc.Scene"!==e.__type__||1===e._layer&&(e._layer=1073741824)})}async function migrateWidgetComponent(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.WidgetComponent"===e.__type__&&(e._isAbsLeft||0===e._left||(e._left/=100),e._isAbsRight||0===e._right||(e._right/=100),e._isAbsTop||0===e._top||(e._top/=100),e._isAbsBottom||0===e._bottom||(e._bottom/=100),e._isAbsHorizontalCenter||0===e._horizontalCenter||(e._horizontalCenter/=100),e._isAbsVerticalCenter||0===e._verticalCenter||(e._verticalCenter/=100))}async function migrateUIPriority(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)if(void 0!==e._priority){if("cc.UITransformComponent"===e.__type__||"cc.CanvasComponent"===e.__type__)continue;const a=t[e.node.__id__];for(let o=0;o<a._components.length;o++){const i=t[a._components[o].__id__];"cc.UITransformComponent"===i.__type__&&(i._priority=e._priority,delete e._priority)}}}async function migrateSkybox(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.SceneGlobals"===e.__type__&&e.skybox&&(e._skybox=e.skybox,delete e.skybox)}exports.migrateNameToId=migrateNameToId,exports.migrateDefaultLayer=migrateDefaultLayer,exports.migrateSavePrefabInfo=migrateSavePrefabInfo,exports.migrateSavePrefabInfoAgain=migrateSavePrefabInfoAgain,exports.migrateWidgetComponent=migrateWidgetComponent,exports.migrateUIPriority=migrateUIPriority,exports.migrateSkybox=migrateSkybox;const skinningMaterials=new Set;async function migrateSkinningMaterial(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const a of t)if(a._materials&&"cc.SkinningModelComponent"===a.__type__)for(const t of a._materials){const a=t&&t.__uuid__,o=a&&asset_db_1.queryAsset(a);if(o&&!skinningMaterials.has(a))if(e._assetDB.taskManager.pause(e.task),await o.waitInit(),e._assetDB.taskManager.resume(e.task),fs_extra_1.existsSync(o.source)){skinningMaterials.add(a);const e=await fs_extra_1.readJSON(o.source),t=e._defines.length||1;for(let a=0;a<t;a++){let t=e._defines[a];t||(t=e._defines[0]={}),t.USE_SKINNING||(t.USE_SKINNING=!0)}fs_extra_1.writeJSONSync(o.source,e,{spaces:2})}else if("@"===a[a.length-6]){const e=o._name;if(e.indexOf("-skinning")>=0)continue;const i=utils_1.nameToId(e.slice(0,e.indexOf("."))+"-skinning.material");o.parent&&o.parent.subAssets[i]&&(t.__uuid__=a.slice(0,-6)+"@"+i)}}for(const e of t)if(e._materials&&"cc.SkinningModelComponent"!==e.__type__)for(const a of e._materials){if(!a)continue;const o=a.__uuid__;if(skinningMaterials.has(o)){const a=t[e.node.__id__].name;console.warn(`skinning material '${o}' used on non-skinning model component on node '${a}'`)}}}async function migrateBackSkinningMaterial(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const a of t)if(a._materials&&"cc.SkinningModelComponent"===a.__type__)for(const t of a._materials){const a=t&&t.__uuid__;if("@"===a[a.length-6]){const o=a.slice(0,a.length-6),i=asset_db_1.queryAsset(o);if(!i)continue;e._assetDB.taskManager.pause(e.task),await i.waitInit(),e._assetDB.taskManager.resume(e.task);const n=a.slice(a.length-5);for(const e in i.subAssets){const a=i.subAssets[e],o=a&&a._name||"";if(utils_1.nameToId(o.slice(0,o.indexOf("."))+"-skinning.material")===n){t.__uuid__=a.uuid;break}}}}}async function migrateSkinningMaterialForMeshSplit(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const a of t)if("cc.SkinningModelComponent"===a.__type__){const t=a._materials;if(!a._mesh)continue;const o=a._mesh.__uuid__,i=o.split("@")[0],n=asset_db_1.queryAsset(i);if(!n)continue;e._assetDB.taskManager.pause(e.task),await n.waitInit(),e._assetDB.taskManager.resume(e.task);const r=asset_db_1.queryAsset(o);if(!r)continue;const _=r.library+".json";if(fs_extra_1.existsSync(_)){const e=fs_extra_1.readJsonSync(_)._struct,a=e.primitives.length,o=t.length;if(o<a){const i=await reader_manager_1.glTfReaderManager.getOrCreate(r.parent);let n=i.processedMeshes.find(t=>{var a;return null===(a=e.jointMaps)||void 0===a?void 0:a.every((e,a)=>e.every((e,o)=>t.jointMaps&&t.jointMaps[a][o]===e))});n||(n=i.processedMeshes.find(t=>e.vertexBundles.every((e,a)=>{var o;return e.view.count===(null===(o=t.geometries[a])||void 0===o?void 0:o.vertexCount)})));const _=n&&n.materialIndices||Array(a).fill(0).map((e,t)=>Math.min(t,o-1)),s=t.slice();for(let e=0;e<a;e++)t[e]=s[_[e]]}}}}const ParticleModule=["cc.ColorOvertimeModule","cc.SizeOvertimeModule","cc.RotationOvertimeModule","cc.ForceOvertimeModule","cc.LimitVelocityOvertimeModule","cc.VelocityOvertimeModule","cc.ShapeModule"];async function migrateParticleModule(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)-1!==ParticleModule.indexOf(e.__type__)&&void 0!==e.enable&&(e._enable=e.enable)}exports.migrateParticleModule=migrateParticleModule;const ParticleModuleName=["colorOverLifetimeModule","sizeOvertimeModule","rotationOvertimeModule","forceOvertimeModule","limitVelocityOvertimeModule","velocityOvertimeModule","shapeModule","trailModule","textureAnimationModule"];async function migrateParticleComponentModule(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.ParticleSystemComponent"===e.__type__&&ParticleModuleName.forEach(t=>{e["_"+t]=e[t],delete e[t]})}async function migrateScrollAndPageViewComponenetModule(e,t){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of a)if(e.__type__===t&&e._content){const t=a[e._content.__id__];if(!t._components)continue;let o=null;for(let e=0;e<t._components.length;++e){const i=t._components[e].__id__;if("cc.UITransformComponent"===a[i].__type__){o=i;break}}e._content.__id__=o}}async function migrateCapsuleColliderHeight(e){(e.getSwapSpace().json||await fs_extra_1.readJSON(e.source)).forEach(e=>{if("cc.CapsuleColliderComponent"===e.__type__){let t=e._height-2*e._radius;t<0&&(t=0),e._cylinderHeight=t,delete e._height}})}async function migrateShadow(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.SceneGlobals"===e.__type__?e.planarShadows&&(e.shadows=e.planarShadows,delete e.planarShadows):"cc.PlanarShadowInfo"===e.__type__&&(e.__type__="cc.ShadowsInfo")}async function migrateComponentNames(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<t.length;e++){const a=t[e];let o=a.__type__,i=exports._renameMap[o];i&&(a.__type__=i,o=o.substring(3),i=i.substring(3),a._name=a._name.replace(o,i))}}async function migrateClickEventsNames(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<t.length;e++){const a=t[e];if("cc.ClickEvent"!==a.__type__)continue;const o=a._componentId,i=exports._renameMap[o];i&&(a._componentId=i)}}exports.migrateParticleComponentModule=migrateParticleComponentModule,exports.migrateScrollAndPageViewComponenetModule=migrateScrollAndPageViewComponenetModule,exports.migrateShadow=migrateShadow,exports._renameMap={"cc.ModelComponent":"cc.MeshRenderer","cc.SkinningModelComponent":"cc.SkinnedMeshRenderer","cc.BatchedSkinningModelComponent":"cc.SkinnedMeshBatchRenderer","cc.CameraComponent":"cc.Camera","cc.AudioSourceComponent":"cc.AudioSource","cc.DirectionalLightComponent":"cc.DirectionalLight","cc.SphereLightComponent":"cc.SphereLight","cc.SpotLightComponent":"cc.SpotLight","cc.LightComponent":"cc.Light","cc.AnimationComponent":"cc.Animation","cc.SkeletalAnimationComponent":"cc.SkeletalAnimation","cc.ParticleSystemComponent":"cc.ParticleSystem","cc.BillboardComponent":"cc.Billboard","cc.LineComponent":"cc.Line","cc.RigidBodyComponent":"cc.RigidBody","cc.BoxColliderComponent":"cc.BoxCollider","cc.SphereColliderComponent":"cc.SphereCollider","cc.CapsuleColliderComponent":"cc.CapsuleCollider","cc.CylinderColliderComponent":"cc.CylinderCollider","cc.ConeColliderComponent":"cc.ConeCollider","cc.PlaneColliderComponent":"cc.PlaneCollider","cc.SimplexColliderComponent":"cc.SimplexCollider","cc.TerrainColliderComponent":"cc.TerrainCollider","cc.MeshColliderComponent":"cc.MeshCollider","cc.HingeConstraintComponent":"cc.HingeConstraint","cc.PointToPointConstraintComponent":"cc.PointToPointConstraint","cc.UITransformComponent":"cc.UITransform","cc.UIModelComponent":"cc.UIMeshRenderer","cc.CanvasComponent":"cc.Canvas","cc.SpriteComponent":"cc.Sprite","cc.LabelComponent":"cc.Label","cc.GraphicsComponent":"cc.Graphics","cc.WidgetComponent":"cc.Widget","cc.ButtonComponent":"cc.Button","cc.MaskComponent":"cc.Mask","cc.ScrollViewComponent":"cc.ScrollView","cc.ScrollBarComponent":"cc.ScrollBar","cc.PageViewComponent":"cc.PageView","cc.PageViewIndicatorComponent":"cc.PageViewIndicator","cc.SliderComponent":"cc.Slider","cc.ToggleContainerComponent":"cc.ToggleContainer","cc.ToggleComponent":"cc.Toggle","cc.RichTextComponent":"cc.RichText","cc.LayoutComponent":"cc.Layout","cc.UIStaticBatchComponent":"cc.UIStaticBatch","cc.UIOpacityComponent":"cc.UIOpacity","cc.LabelOutlineComponent":"cc.LabelOutline","cc.ProgressBarComponent":"cc.ProgressBar","cc.EditBoxComponent":"cc.EditBox","cc.BlockInputEventsComponent":"cc.BlockInputEvents","cc.UICoordinateTrackerComponent":"cc.UICoordinateTracker","cc.SafeAreaComponent":"cc.SafeArea","cc.ViewGroupComponent":"cc.ViewGroup","cc.RenderComponent":"cc.UIRenderable"};const widgetRE=/^cc.Widget$/i;async function migrateCanvasAddWidget(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);try{for(const e of t)if("cc.Canvas"===e.__type__&&!utils_2.getComponent(t,e.node.__id__,widgetRE)){const a=JSON.parse(JSON.stringify(components_1.Widget));a.node.__id__=e.node.__id__,a._alignFlags=45,t.push(a);const o=t[e.node.__id__];o&&o._components.push({__id__:t.length-1})}}catch(e){console.error(e)}}const _maskMap=new Map;let _times=0;async function migrateCanvasCamera(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);let a=await Editor.Profile.getProject("project","layer");if(a||(a=[]),0===_times){_times++;const e=path_1.join(__dirname,"../../../../static/migrate-scene-canvas.ts"),t=path_1.join(Editor.Project.path,"./assets/migrate-canvas.ts");await fs_extra_1.copyFile(e,t),Manager.AssetWorker.assets.refresh(t);for(const e of a)_maskMap.set(e.value,e.name)}try{for(const e of t)if("cc.Camera"===e.__type__)for(let t=20;t>0;t--){const a=1<<t;!_maskMap.has(a)&&e._visibility&a&&(e._visibility^=a)}let o=0,i="",n=0;for(const r of t)if("cc.Canvas"===r.__type__){const _=20-++o>=_maskMap.size;_||console.warn(`layer is not enough! Please check the scene! [${e.url}]`);const s=t[r.node.__id__];for(let e=20-o;e>=0;e--){if(_maskMap.has(1<<e)&&_)continue;n=1<<e,i=`canvas_${e}`,s._layer=n,a.find(e=>e.value===n)||(a.push({name:i,value:n}),a.sort((e,t)=>e.value-t.value),await Editor.Profile.setProject("project","layer",a));break}if(r.node){preChildSet(t,r.node,n);const e=t.length,a=JSON.parse(getNodeStr());a[0]._name=`UICamera_${t[r.node.__id__]._name}`,a[0]._parent=r.node,a[0]._layer=n,a[0]._id=Editor.Utils.UUID.generate(),t[r.node.__id__]._children.push({__id__:e});const o=t[0]&&"cc.Prefab"===t[0].__type__;o&&(a[0]._prefab={},a[0]._prefab.__id__=e+1),a[0]._components[0].__id__=o?e+2:e+1;let i=null;if(o){(i=JSON.parse(getPrefabInfoStr())[0]).root.__id__=e,i.asset.__id__=0,i.fileId=Editor.Utils.UUID.generate()}const _=JSON.parse(getCameraStr());_[0].node.__id__=e,_[0]._priority=getViewPriority(r,r._priority),_[0]._targetTexture=r._targetTexture,_[0]._clearFlags=void 0!==r._clearFlag?r._clearFlag:6,_[0]._color=void 0!==r._color?JSON.parse(JSON.stringify(r._color)):{__type__:"cc.Color",r:0,g:0,b:0,a:255},_[0]._visibility=1<<23,_[0]._visibility|=1<<25,_[0]._visibility|=n,_[0]._projection=0,_[0]._far=2e3,_[0]._rect={__type__:"cc.Rect",x:0,y:0,width:1,height:1},o&&(_[0].__prefab={},_[0].__prefab.__id__=e+3),_[0]._id=Editor.Utils.UUID.generate();let c=null;if(o){(c=JSON.parse(getCompPrefabInfoStr())[0]).fileId=Editor.Utils.UUID.generate()}if(r._cameraComponent={},r._cameraComponent.__id__=o?e+2:e+1,r._alignCanvasWithScreen=!0,t.push(a[0]),o&&t.push(i),t.push(_[0]),o&&t.push(c),!o&&s&&s._prefab){const e=JSON.parse(getSinglePrefabInfoStr()),o=t[s._prefab.__id__];o&&(e.root.__id__=o.root.__id__,e.asset={__uuid__:o.asset.__uuid__},e.fileId=Editor.Utils.UUID.generate()),t.push(e);const i=t.length-1;a[0]._prefab={__id__:i}}}}}catch(e){console.error(e)}}function preChildSet(e,t,a){for(const o of e[t.__id__]._children)e[o.__id__]._layer=a,preChildSet(e,o,a)}function getViewPriority(e,t){const a=e._renderMode;return 0===a||void 0===a?t|1<<30:t}function getNodeStr(){return'[{"__type__": "cc.Node","_name": "Camera","_objFlags": 0,"_parent": {  "__id__": 1},"_children": [],"_active": true,"_components": [  {    "__id__": 10  }],"_prefab": null,"_lpos": {  "__type__": "cc.Vec3",  "x": 0,  "y": 0,  "z": 0},"_lrot": {  "__type__": "cc.Quat",  "x": 0,  "y": 0,  "z": 0,  "w": 1},"_lscale": {  "__type__": "cc.Vec3",  "x": 1,  "y": 1,  "z": 1},"_layer": 1073741824,"_euler": {  "__type__": "cc.Vec3",  "x": 0,  "y": 0,  "z": 0},"_id": "c9DMICJLFO5IeO07EPon7U"}]'}function getCameraStr(){return'[{"__type__": "cc.Camera","_name": "","_objFlags": 0,"node": {  "__id__": 0},"_enabled": true,"__prefab": null,"_projection": 1,"_priority": 0,"_fov": 45,"_fovAxis": 0,"_orthoHeight": 10,"_near": 1,"_far": 1000,"_color": {  "__type__": "cc.Color",  "r": 51,  "g": 51,  "b": 51,  "a": 255},"_depth": 1,"_stencil": 0,"_clearFlags": 7,"_rect": {  "__type__": "cc.Rect",  "x": 0,  "y": 0,  "width": 1,  "height": 1},"_aperture": 19,"_shutter": 7,"_iso": 0,"_screenScale": 1,"_visibility": 1822425087,"_targetTexture": null,"_id": "7dWQTpwS5LrIHnc1zAPUtf"}]'}function getPrefabInfoStr(){return'[{"__type__": "cc.PrefabInfo","root": {"__id__": 1 },"asset": {"__id__": 0 },"fileId": "deuJTKRANDsKzJ5LeyO/KM"}]'}function getSinglePrefabInfoStr(){return'{"__type__": "cc.PrefabInfo","root": {"__id__": 1 },"asset": {"__uuid__": 0 },"fileId": ""}'}function getCompPrefabInfoStr(){return'[{"__type__": "cc.CompPrefabInfo","fileId": "3cUBXFJqdHqabkl+K4SlQ6"}]'}async function migrateRigidBody(e){(e.getSwapSpace().json||await fs_extra_1.readJSON(e.source)).forEach(e=>{"cc.RigidBody"===e.__type__&&(0==e._mass?e._type=2:e._isKinematic&&(e._type=4),e._fixedRotation&&(e._angularFactor.x=0,e._angularFactor.y=0,e._angularFactor.z=0))})}async function migrateUICustomMaterial(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<t.length;e++){const a=t[e];"cc.Sprite"!==a.__type__&&"cc.Label"!==a.__type__&&"cc.Graphics"!==a.__type__&&"cc.Mask"!==a.__type__&&"cc.UIStaticBatch"!==a.__type__||(a._materials&&a._materials.length&&(a._customMaterial=a._materials[0]),delete a._materials)}}async function migrateVisibilityTypeError(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<t.length;e++){const a=t[e];"cc.Camera"===a.__type__&&(a._visibility=a._visibility-0)}}async function migrateUILayout(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.Layout"===e.__type__&&(void 0!==e._N$layoutType&&(e._layoutType=e._N$layoutType,delete e._N$layoutType),void 0!==e._N$padding&&(e._paddingLeft=e._paddingRight=e._paddingTop=e._paddingBottom=e._N$padding,delete e._N$padding))}async function migratePrefabCompPrefabInfo(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source),a=t[0]&&"cc.Prefab"===t[0].__type__;for(const o of t)"cc.CompPrefabInfo "===o.__type__?o.__type__="cc.CompPrefabInfo":a&&"cc.PrefabInfo"===o.__type__&&1===o.root.__id__&&(null!==o.asset&&o.asset.__uuid__!==e.uuid||(o.asset={__id__:0}))}async function migrateGeometryCurveCurveRange330(e){const t=e.getSwapSpace(),a=new migration_utils_1.Archive(t.json);await migrate_geometry_curve_3_3_0_1.migrateGeometryCurve330(a),await migrate_curve_range_3_3_0_1.migrateCurveRange330(a);const o=a.get();t.json=o}async function migrateShadowInfo(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);let a=4096,o=8;for(const e of t)if("cc.ShadowsInfo"===e.__type__&&(e._shadowColor&&(e._saturation=e._shadowColor.a/255),e._size)){const t=e._size,i=cc.math.absMax(t.x,t.y);for(let e=8;e<12;e++){const t=cc.math.bits.abs((1<<e)-i);t<a&&(a=t,o=e)}e._size={__type__:"cc.Vec2",x:1<<o,y:1<<o}}}async function migrateShadowDepthBias(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)"cc.ShadowsInfo"===e.__type__&&e._bias&&(e._bias=clamp(1e4*e._bias,.01,1))}async function migratePrivateNode(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source),a=cc.CCObject.Flags.DontSave|cc.CCObject.Flags.HideInHierarchy;for(const e of t)"cc.PrivateNode"===e.__type__&&(e.__type__="cc.Node",e._objFlags|=a)}async function migrateShadowAutoAdapt(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)if("cc.ShadowsInfo"===e.__type__){"_packing"in e&&delete e._packing,"_linear"in e&&delete e._linear,"_selfShadow"in e&&delete e._selfShadow,"_aspect"in e&&delete e._aspect;const t="_autoAdapt"in e;"_shadowDistance"in e?(e._firstSetCSM=!1,t&&delete e._autoAdapt):t&&(!0===e._autoAdapt?(e._fixedArea=!1,e._firstSetCSM=!0):e._fixedArea=!0,delete e._autoAdapt)}}async function migrateHDRData(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t){if("cc.SkyboxInfo"===e.__type__){const t="_envmapLDR"in e,a="_diffuseMapLDR"in e,o="_diffuseMapHDR"in e,i="_applyDiffuseMap"in e,n="_isRGBE"in e;"_useHDR"in e||(e._useHDR=!0),t||(e._envmapLDR=e._envmap,e._envmapHDR=e._envmap),a||(e._diffuseMapLDR=null),o||(e._diffuseMapHDR=null),n&&delete e._isRGBE,i||(e._applyDiffuseMap=!1)}if("cc.AmbientInfo"===e.__type__){const t=new cc.Color(e._skyColor),a=new cc.Color(e._groundAlbedo),o="_groundAlbedoLDR"in e,i="_skyIllumLDR"in e,n="_skyIllumHDR"in e;"_skyColorLDR"in e||(e._skyColor={__type__:"cc.Vec4",x:0,y:0,z:0,w:0},e._skyColor.x=t.x,e._skyColor.y=t.y,e._skyColor.z=t.z,e._skyColor.w=.520833125,e._skyColorLDR=e._skyColor,e._skyColorHDR=e._skyColor),o||(e._groundAlbedo={__type__:"cc.Vec4",x:0,y:0,z:0,w:0},e._groundAlbedo.x=a.x,e._groundAlbedo.y=a.y,e._groundAlbedo.z=a.z,e._groundAlbedo.w=a.w,e._groundAlbedoLDR=e._groundAlbedo,e._groundAlbedoHDR=e._groundAlbedo),i||(e._skyIllumLDR=e._skyIllum*(1/38400)*1.5),n||(e._skyIllumHDR=e._skyIllum)}if("cc.DirectionalLight"===e.__type__){const t="_illuminanceHDR"in e;"_illuminanceLDR"in e||(e._illuminanceLDR=e._illuminance*(1/38400)),t||(e._illuminanceHDR=e._illuminance)}if("cc.SpotLight"===e.__type__||"cc.SphereLight"===e.__type__){const t="_luminanceHDR"in e;if(!("_luminanceLDR"in e)){const t=1e4;e._luminanceLDR=e._luminance*(1/38400)*t}t||(e._luminanceHDR=e._luminance)}}}async function migrateFogData(e){const t=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(const e of t)if("cc.FogInfo"===e.__type__){const t="_accurate"in e;"_fogColor"in e&&(e._fogColor.r=Math.floor(255*Math.sqrt(e._fogColor.r/255)),e._fogColor.g=Math.floor(255*Math.sqrt(e._fogColor.g/255)),e._fogColor.b=Math.floor(255*Math.sqrt(e._fogColor.b/255))),t||(e._accurate=!1)}}exports.migrateUILayout=migrateUILayout,exports.migratePrefabCompPrefabInfo=migratePrefabCompPrefabInfo,exports.migrateShadowInfo=migrateShadowInfo,exports.migrateShadowDepthBias=migrateShadowDepthBias,exports.migratePrivateNode=migratePrivateNode,exports.migrateShadowAutoAdapt=migrateShadowAutoAdapt,exports.migrateHDRData=migrateHDRData,exports.migrateFogData=migrateFogData;