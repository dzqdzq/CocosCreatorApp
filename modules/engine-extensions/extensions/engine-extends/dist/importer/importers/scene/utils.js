"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.walkPrefabInstances=exports.isNestedPrefab=exports.getPrefabOfNode=exports.walkNodeAsync=exports.walkNode=exports.getComponent=exports.walkAsync=exports.walk=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),fs_1=require("fs");function walk(e,o){if(Array.isArray(e))for(const n of e)walk(n,o);else if(e&&"object"==typeof e)if("__uuid__"in e)o(e);else for(const n of Object.values(e))walk(n,o)}async function walkAsync(e,o){if(Array.isArray(e))for(const n of e)await walk(n,o);else if(e&&"object"==typeof e)if("__uuid__"in e)await o(e);else for(const n of Object.values(e))await walk(n,o)}function getComponent(e,o,n){if("number"!=typeof o||o<0)return null;const t=e[o]._components;for(const o of t){const t=e[o.__id__];if(n.test(t.__type__))return t}return null}function walkNode(e,o,n){if(!o||"number"!=typeof o.__id__||o.__id__<0)return;const t=e[o.__id__];n(t,o),t._children&&t._children.forEach(o=>{walkNode(e,o,n)})}async function walkNodeAsync(e,o,n){if(!o||"number"!=typeof o.__id__||o.__id__<0)return;const t=e[o.__id__];if(await n(t,o),t._children)for(let o=0;o<t._children.length;o++){const _=t._children[o];await walkNodeAsync(e,_,n)}}function getPrefabOfNode(e,o){var n;if(e&&o[e]){const t=o[e];if(t&&"cc.Node"===t.__type__){const e=null===(n=t._prefab)||void 0===n?void 0:n.__id__;if(e&&o[e])return o[e]}}}function isNestedPrefab(e,o,n){var t,_,s,i,a;return!!((null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.__id__)&&(null===(s=null===(_=o[e._prefab.__id__])||void 0===_?void 0:_.asset)||void 0===s?void 0:s.__uuid__))&&(null===(a=null===(i=o[e._prefab.__id__])||void 0===i?void 0:i.asset)||void 0===a?void 0:a.__uuid__)!==n}exports.walk=walk,exports.walkAsync=walkAsync,exports.getComponent=getComponent,exports.walkNode=walkNode,exports.walkNodeAsync=walkNodeAsync,exports.getPrefabOfNode=getPrefabOfNode,exports.isNestedPrefab=isNestedPrefab;const walkPrefabInstanceChildren=async function(e,o,n,t,_){for(let s=0;s<e.length;s++){const i=e[s];await walkNodeAsync(o,i,async(e,s)=>{isNestedPrefab(e,o,_)?await walkPrefabInstances(e,o,n,t):(t(e),e._components&&e._components.forEach(e=>{const n=o[e.__id__];n&&t(n)}))})}};async function walkPrefabInstances(e,o,n,t){var _,s,i,a,r;if(!(null===(_=null===e||void 0===e?void 0:e._prefab)||void 0===_?void 0:_.__id__))return;t(e,o);const d=o[e._prefab.__id__],l=null===(s=null===d||void 0===d?void 0:d.asset)||void 0===s?void 0:s.__uuid__;if(!l)return;const c=asset_db_1.queryAsset(l);if(c&&c.source){let e,o=[];if(c.source.includes("@")?(c.init||(c._assetDB.taskManager.pause(n.task),await c.waitInit(),c._assetDB.taskManager.resume(n.task)),e=c.library+".json"):e=c.source,fs_1.existsSync(e))try{o=fs_extra_1.readJSONSync(e)}catch(e){console.warn(e)}if(!o[0]||!(null===(a=null===(i=o[0])||void 0===i?void 0:i.data)||void 0===a?void 0:a.__id__))return;const _=o[o[0].data.__id__];(null===_||void 0===_?void 0:_._children)&&await walkPrefabInstanceChildren(_._children,o,n,t,l),(null===_||void 0===_?void 0:_._components)&&_._components.forEach(e=>{const n=o[e.__id__];n&&t(n)})}const f=null===(r=null===d||void 0===d?void 0:d.instance)||void 0===r?void 0:r.__id__;if(f&&o[f]){const e=o[f];if(e.mountedChildren&&e.mountedChildren.length>0){const _=[];e.mountedChildren.forEach(e=>{const n=o[e.__id__];if(n&&n.nodes)for(const e of n.nodes)_.push(e)}),await walkPrefabInstanceChildren(_,o,n,t,l)}e.mountedComponents&&e.mountedComponents.length>0&&e.mountedComponents.forEach(e=>{const n=o[e.__id__];if(n&&n.components)for(const e of n.components)e.__id__&&o[e.__id__]&&t(o[e.__id__])})}}exports.walkPrefabInstances=walkPrefabInstances;