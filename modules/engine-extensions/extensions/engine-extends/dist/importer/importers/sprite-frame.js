"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=exports.makeDefaultSpriteFrameAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),utils_1=require("../utils"),texture_base_1=require("./texture-base"),cc=__importStar(require("cc"));try{require("sharp")}catch(e){console.error(e),console.error(Editor.I18n.t("engine-extends.importers.sharpError"))}const Sharp=require("sharp");function makeDefaultSpriteFrameAssetUserData(){return texture_base_1.makeDefaultSpriteFrameBaseAssetUserData()}function makeDefaultSpriteFrameAssetUserDataFromImageUuid(e,t){return Object.assign(texture_base_1.makeDefaultSpriteFrameBaseAssetUserData(),{isUuid:!0,imageUuidOrDatabaseUri:e,atlasUuid:t})}Sharp.cache(!1),exports.makeDefaultSpriteFrameAssetUserData=makeDefaultSpriteFrameAssetUserData,exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=makeDefaultSpriteFrameAssetUserDataFromImageUuid;class SpriteFrameImporter extends asset_db_1.Importer{get version(){return"1.0.9"}get name(){return"sprite-frame"}get assetType(){return"cc.SpriteFrame"}async import(e){if(!e.parent)return!1;if("image"===e.parent.meta.importer){const t=e.userData;let r;r=[".tga",".hdr",".bmp"].includes(e.parent.extname.toLowerCase())?e.parent.library+".png":e.parent.source;const a=1,i=await Sharp(r).raw().toBuffer({resolveWithObject:!0});if(!i)return!1;if(void 0===t.trimThreshold&&(t.trimThreshold=1),t.rotated=!!t.rotated,t.packable=void 0===t.packable||t.packable,t.rawHeight=i.info.height,t.rawWidth=i.info.width,"auto"===t.trimType)if(4!==i.info.channels)t.width=i.info.width,t.height=i.info.height,t.trimX=0,t.trimY=0;else{const e=utils_1.getTrimRect(Buffer.from(i.data),t.rawWidth,t.rawHeight,t.trimThreshold);t.width=Math.max(e[2],a),t.height=Math.max(e[3],a),t.trimX=utils_1.clamp(e[0],0,t.rawWidth-t.width),t.trimY=utils_1.clamp(e[1],0,t.rawHeight-t.height)}else"none"===t.trimType?(t.trimX=0,t.trimY=0,t.width=i.info.width,t.height=i.info.height):(t.trimX=utils_1.clamp(t.trimX,0,t.rawWidth-a),t.trimY=utils_1.clamp(t.trimY,0,t.rawHeight-a),t.width=utils_1.clamp(-1===t.width?t.rawWidth:t.width,a,t.rawWidth-t.trimX),t.height=utils_1.clamp(-1===t.height?t.rawHeight:t.height,a,t.rawHeight-t.trimY));t.offsetX=t.trimX+t.width/2-t.rawWidth/2,t.offsetY=-(t.trimY+t.height/2-t.rawHeight/2),t.borderLeft=utils_1.clamp(t.borderLeft,0,t.width),t.borderRight=utils_1.clamp(t.borderRight,0,t.width-t.borderLeft),t.borderTop=utils_1.clamp(t.borderTop,0,t.height),t.borderBottom=utils_1.clamp(t.borderBottom,0,t.height-t.borderTop)}const t=this.createSpriteFrame(e);return this.getTexture(e,t),await e.saveToLibrary(".json",EditorExtends.serialize(t)),!0}createSpriteFrame(e){const t=e.userData,r=new cc.SpriteFrame;return r.name=e.displayName?e.displayName:e._name,r.atlasUuid=t.atlasUuid,r._rect=cc.rect(t.trimX,t.trimY,t.width,t.height),r._originalSize=cc.size(t.rawWidth,t.rawHeight),r._offset=cc.v2(t.offsetX,t.offsetY),r._capInsets=[t.borderLeft,t.borderTop,t.borderRight,t.borderBottom],r._rotated=t.rotated,r._packable=t.packable,r}getTexture(e,t){const r=e.userData,a=r.imageUuidOrDatabaseUri;if(a){let e=null;r.isUuid?e=a:(e=asset_db_1.queryUUID(a))||console.warn(`Cannot find image ${asset_db_1.queryPath(a)||""}.`),null!==e&&(t._texture=EditorExtends.serialize.asAsset(e,cc.Texture2D))}}}exports.default=SpriteFrameImporter;