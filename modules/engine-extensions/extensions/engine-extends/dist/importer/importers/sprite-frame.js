"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpriteFrameImporter=exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=exports.makeDefaultSpriteFrameAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),utils_1=require("../utils"),texture_base_1=require("./texture-base"),cc=__importStar(require("cc")),utils_2=require("../utils");try{require("sharp")}catch(e){console.error(e),console.error(Editor.I18n.t("engine-extends.importers.sharpError"))}const Sharp=require("sharp");function makeDefaultSpriteFrameAssetUserData(){return texture_base_1.makeDefaultSpriteFrameBaseAssetUserData()}function makeDefaultSpriteFrameAssetUserDataFromImageUuid(e,t){return Object.assign(texture_base_1.makeDefaultSpriteFrameBaseAssetUserData(),{isUuid:!0,imageUuidOrDatabaseUri:e,atlasUuid:t})}Sharp.cache(!1),exports.makeDefaultSpriteFrameAssetUserData=makeDefaultSpriteFrameAssetUserData,exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid=makeDefaultSpriteFrameAssetUserDataFromImageUuid;class SpriteFrameImporter extends asset_db_1.Importer{get version(){return"1.0.11"}get name(){return"sprite-frame"}get assetType(){return"cc.SpriteFrame"}async import(e){if(!e.parent)return!1;if("image"===e.parent.meta.importer){const t=e.userData;let r;r=[".tga",".hdr",".bmp"].includes(e.parent.extname.toLowerCase())?e.parent.library+".png":e.parent.source;const i=1,a=await Sharp(r).raw().toBuffer({resolveWithObject:!0});if(!a)return!1;if(void 0===t.trimThreshold&&(t.trimThreshold=1),t.rotated=!!t.rotated,t.packable=void 0===t.packable||t.packable,t.rawHeight=a.info.height,t.rawWidth=a.info.width,"auto"===t.trimType)if(4!==a.info.channels)t.width=a.info.width,t.height=a.info.height,t.trimX=0,t.trimY=0;else{const e=utils_1.getTrimRect(Buffer.from(a.data),t.rawWidth,t.rawHeight,t.trimThreshold);t.width=Math.max(e[2],i),t.height=Math.max(e[3],i),t.trimX=utils_1.clamp(e[0],0,t.rawWidth-t.width),t.trimY=utils_1.clamp(e[1],0,t.rawHeight-t.height)}else"none"===t.trimType?(t.trimX=0,t.trimY=0,t.width=a.info.width,t.height=a.info.height):(t.trimX=utils_1.clamp(t.trimX,0,t.rawWidth-i),t.trimY=utils_1.clamp(t.trimY,0,t.rawHeight-i),t.width=utils_1.clamp(-1===t.width?t.rawWidth:t.width,i,t.rawWidth-t.trimX),t.height=utils_1.clamp(-1===t.height?t.rawHeight:t.height,i,t.rawHeight-t.trimY));t.offsetX=t.trimX+t.width/2-t.rawWidth/2,t.offsetY=-(t.trimY+t.height/2-t.rawHeight/2),t.borderLeft=utils_1.clamp(t.borderLeft,0,t.width),t.borderRight=utils_1.clamp(t.borderRight,0,t.width-t.borderLeft),t.borderTop=utils_1.clamp(t.borderTop,0,t.height),t.borderBottom=utils_1.clamp(t.borderBottom,0,t.height-t.borderTop),this.initVerticesData(t)}const t=this.createSpriteFrame(e);e.parent instanceof asset_db_1.Asset&&(t.name=t.name||e.parent.basename||""),this.getTexture(e,t);const r=EditorExtends.serialize(t);await e.saveToLibrary(".json",r);const i=utils_2.getDependUUIDList(r);return e.setData("depends",i),!0}createSpriteFrame(e){const t=e.userData,r=new cc.SpriteFrame;return r.name=e.displayName?e.displayName:e._name,r.atlasUuid=t.atlasUuid,r._rect=cc.rect(t.trimX,t.trimY,t.width,t.height),r._originalSize=cc.size(t.rawWidth,t.rawHeight),r._offset=cc.v2(t.offsetX,t.offsetY),r._capInsets=[t.borderLeft,t.borderTop,t.borderRight,t.borderBottom],r._rotated=t.rotated,r._packable=t.packable,r._pixelsToUnit=t.pixelsToUnit,r._pivot=cc.v2(t.pivotX,t.pivotY),r._meshType=t.meshType,this.initVertices(r,t),r}getTexture(e,t){const r=e.userData,i=r.imageUuidOrDatabaseUri;if(i){let e=null;r.isUuid?e=i:(e=asset_db_1.queryUUID(i))||console.warn(`Cannot find image ${asset_db_1.queryPath(i)||""}.`),null!==e&&(t._texture=EditorExtends.serialize.asAsset(e,cc.Texture2D))}}initVerticesData(e){void 0===e.vertices&&(e.vertices={rawPosition:[],indexes:[],uv:[],nuv:[],minPos:[],maxPos:[]});const t=e.vertices;if(t.rawPosition.length=0,e.meshType===cc.SpriteFrame.MeshType.POLYGON);else{const r=e.width,i=e.height,a=r/2,s=i/2,o=e.rawWidth,n=e.rawHeight,m=e.trimX,u=n-e.trimY-i,c=0===o?0:m/o,h=0===o?1:(m+r)/o,d=0===n?1:(u+i)/n,p=0===n?0:u/n;t.rawPosition=[-a,-s,0,a,-s,0,-a,s,0,a,s,0],t.uv=[m,u+i,m+r,u+i,m,u,m+r,u],t.nuv=[c,p,h,p,c,d,h,d],t.indexes=[0,1,2,2,1,3],t.minPos=[-a,-s,0],t.maxPos=[a,s,0]}}initVertices(e,t){const r=t.vertices;e.vertices={rawPosition:[],positions:[],indexes:r.indexes,uv:r.uv,nuv:r.nuv,minPos:cc.v3(r.minPos[0],r.minPos[1],r.minPos[2]),maxPos:cc.v3(r.maxPos[0],r.maxPos[1],r.maxPos[2])};const i=e.vertices,a=r.rawPosition,s=cc.v3();for(let e=0;e<a.length;e+=3)s.set(a[e],a[e+1],a[e+2]),i.rawPosition.push(s.clone())}}exports.SpriteFrameImporter=SpriteFrameImporter;