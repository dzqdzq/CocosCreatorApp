"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),migrates_1=require("./scene/migrates"),material_upgrader_1=require("./utils/material-upgrader");class MaterialImporter extends asset_db_1.Importer{get version(){return"1.0.12"}get name(){return"material"}get assetType(){return"cc.Material"}async validate(r){try{return"cc.Material"===fs_extra_1.readJSONSync(r.source).__type__}catch(r){return!1}}get migrations(){return migrations}get migrationHook(){return migrates_1.migrationHook}async import(r){try{const a=fs_extra_1.readJSONSync(r.source),e=a._effectAsset&&a._effectAsset.__uuid__;return r.depend(e),await material_upgrader_1.upgradeProperties(a,r)&&fs_extra_1.writeJSONSync(r.source,a,{spaces:2}),await r.saveToLibrary(".json",JSON.stringify(a,void 0,2)),!0}catch(r){return console.error(r),!1}}}exports.default=MaterialImporter;const migrations=[{version:"1.0.5",migrate:migrates_1.migrateImageUuid},{version:"1.0.6",migrate:migrates_1.migrateAnimationName},{version:"1.0.7",async migrate(r){await migrates_1.migrateNameToId(r,!0)}},{version:"1.0.9",migrate:migrateStandardEffect},{version:"1.0.10",migrate:migrateLinearColor},{version:"1.0.11",migrate:migrateBlendColor},{version:"1.0.12",migrate:migrateLinearColorFixUnlitShader}],componentMap={r:"x",g:"y",b:"z",a:"w"};async function migrateStandardEffect(r){const a=r.getSwapSpace().json||await fs_extra_1.readJSON(r.source);if("1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__){let r=a._defines[0];r||(r=a._defines[0]={}),r.OCCLUSION_CHANNEL||(r.OCCLUSION_CHANNEL="b"),r.ROUGHNESS_CHANNEL||(r.ROUGHNESS_CHANNEL="r"),r.METALLIC_CHANNEL||(r.METALLIC_CHANNEL="g");let e=a._props[0];e||(e=a._props[0]={}),e.occlusion=(e.pbrParams&&e.pbrParams[componentMap[r.OCCLUSION_CHANNEL]]||1)*(e.pbrScale&&e.pbrScale[componentMap[r.OCCLUSION_CHANNEL]]||1),e.roughness=(e.pbrParams&&e.pbrParams[componentMap[r.ROUGHNESS_CHANNEL]]||1)*(e.pbrScale&&e.pbrScale[componentMap[r.ROUGHNESS_CHANNEL]]||.8),e.metallic=(e.pbrParams&&e.pbrParams[componentMap[r.METALLIC_CHANNEL]]||1)*(e.pbrScale&&e.pbrScale[componentMap[r.METALLIC_CHANNEL]]||.6),r.USE_PBR_MAP?(e.occlusion=e.pbrScale&&e.pbrScale[componentMap[r.OCCLUSION_CHANNEL]],"number"!=typeof e.occlusion&&(e.occlusion=1),e.roughness=e.pbrScale&&e.pbrScale[componentMap[r.ROUGHNESS_CHANNEL]],"number"!=typeof e.roughness&&(e.roughness=1),e.metallic=e.pbrScale&&e.pbrScale[componentMap[r.METALLIC_CHANNEL]],"number"!=typeof e.metallic&&(e.metallic=1)):r.USE_METALLIC_ROUGHNESS_MAP?(e.roughness=e.pbrScale&&e.pbrScale[componentMap[r.ROUGHNESS_CHANNEL]],"number"!=typeof e.roughness&&(e.roughness=1),e.metallic=e.pbrScale&&e.pbrScale[componentMap[r.METALLIC_CHANNEL]],"number"!=typeof e.metallic&&(e.metallic=1)):r.USE_OCCLUSION_MAP&&(e.occlusion=e.pbrScale&&e.pbrScale[componentMap[r.OCCLUSION_CHANNEL]],"number"!=typeof e.occlusion&&(e.occlusion=1))}}async function migrateLinearColor(r){const a=r.getSwapSpace().json||await fs_extra_1.readJSON(r.source),e="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,o="a7612b54-35e3-4238-a1a9-4a7b54635839"===a._effectAsset.__uuid__,t="a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__,s="99498f84-efe6-43a6-a9a7-e6e93eb845c1"===a._effectAsset.__uuid__;if(e||o||s){let r=o?a._props[1]:a._props[0];r||(r=a._props[0]={}),r.mainColor&&(r.mainColor.r=Math.floor(255*Math.sqrt(r.mainColor.r/255)),r.mainColor.g=Math.floor(255*Math.sqrt(r.mainColor.g/255)),r.mainColor.b=Math.floor(255*Math.sqrt(r.mainColor.b/255))),r.emissive&&(r.emissive.r=Math.floor(255*Math.sqrt(r.emissive.r/255)),r.emissive.g=Math.floor(255*Math.sqrt(r.emissive.g/255)),r.emissive.b=Math.floor(255*Math.sqrt(r.emissive.b/255))),o&&(r.shadeColor1&&(r.shadeColor1.r=Math.floor(255*Math.sqrt(r.shadeColor1.r/255)),r.shadeColor1.g=Math.floor(255*Math.sqrt(r.shadeColor1.g/255)),r.shadeColor1.b=Math.floor(255*Math.sqrt(r.shadeColor1.b/255))),r.shadeColor2&&(r.shadeColor2.r=Math.floor(255*Math.sqrt(r.shadeColor2.r/255)),r.shadeColor2.g=Math.floor(255*Math.sqrt(r.shadeColor2.g/255)),r.shadeColor2.b=Math.floor(255*Math.sqrt(r.shadeColor2.b/255))),r.specular&&(r.specular.r=Math.floor(255*Math.sqrt(r.specular.r/255)),r.specular.g=Math.floor(255*Math.sqrt(r.specular.g/255)),r.specular.b=Math.floor(255*Math.sqrt(r.specular.b/255))))}if(t){let r=a._props[0];r||(r=a._props[0]={}),r.mainColor&&(r.mainColor.r=Math.floor(255*Math.sqrt(r.mainColor.r/255)),r.mainColor.g=Math.floor(255*Math.sqrt(r.mainColor.g/255)),r.mainColor.b=Math.floor(255*Math.sqrt(r.mainColor.b/255)))}}async function migrateLinearColorFixUnlitShader(r){const a=r.getSwapSpace().json||await fs_extra_1.readJSON(r.source);if("a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__){let r=a._props[0];r||(r=a._props[0]={}),r.mainColor&&(r.mainColor.r=Math.floor(r.mainColor.r*r.mainColor.r/65535*255),r.mainColor.g=Math.floor(r.mainColor.g*r.mainColor.g/65535*255),r.mainColor.b=Math.floor(r.mainColor.b*r.mainColor.b/65535*255))}}async function migrateBlendColor(r){const a=r.getSwapSpace().json||await fs_extra_1.readJSON(r.source);a._states&&Array.isArray(a._states)&&a._states.forEach(r=>{var a,e,o,t;const s=r.blendState;if(s&&s.blendColor){const r=s.blendColor;Array.isArray(r)&&(s.blendColor={__type__:"cc.Color",r:null!==(a=r[0])&&void 0!==a?a:0,g:null!==(e=r[1])&&void 0!==e?e:0,b:null!==(o=r[2])&&void 0!==o?o:0,a:null!==(t=r[3])&&void 0!==t?t:0})}})}