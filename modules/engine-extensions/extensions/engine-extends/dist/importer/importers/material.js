"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialImporter=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),migrates_1=require("./scene/migrates"),material_upgrader_1=require("./utils/material-upgrader"),utils_1=require("../utils");class MaterialImporter extends asset_db_1.Importer{get version(){return"1.0.21"}get name(){return"material"}get assetType(){return"cc.Material"}async validate(e){try{return"cc.Material"===(0,fs_extra_1.readJSONSync)(e.source).__type__}catch(e){return!1}}get migrations(){return migrations}get migrationHook(){return migrates_1.migrationHook}async import(e){try{const a=(0,fs_extra_1.readJSONSync)(e.source),r=a._effectAsset&&a._effectAsset.__uuid__;e.depend(r),await(0,material_upgrader_1.upgradeProperties)(a,e)&&(0,fs_extra_1.writeJSONSync)(e.source,a,{spaces:2}),a._name=e.basename||"";const t=JSON.stringify(a,void 0,2);await e.saveToLibrary(".json",t);const o=(0,utils_1.getDependUUIDList)(t);return e.setData("depends",o),!0}catch(e){return console.error(e),!1}}}exports.MaterialImporter=MaterialImporter;const migrations=[{version:"1.0.5",migrate:migrates_1.migrateImageUuid},{version:"1.0.6",migrate:migrates_1.migrateAnimationName},{version:"1.0.7",async migrate(e){await(0,migrates_1.migrateNameToId)(e,!0)}},{version:"1.0.9",migrate:migrateStandardEffect},{version:"1.0.10",migrate:migrateLinearColor},{version:"1.0.11",migrate:migrateBlendColor},{version:"1.0.12",migrate:migrateLinearColorFixUnlitShader},{version:"1.0.13",migrate:migrateNormalStrength},{version:"1.0.14",migrate:migrateOcclusion},{version:"1.0.15",migrate:migrateMacroUseBatching},{version:"1.0.16",migrate:migrateRoughnessAndMetallic},{version:"1.0.17",migrate:migrateEmissiveColor},{version:"1.0.19",migrate:migrateAlbedoScaleType},{version:"1.0.20",migrate:migrateEmissiveScaleType},{version:"1.0.21",migrate:migrateSpecularIntensity}],componentMap={r:"x",g:"y",b:"z",a:"w"};async function migrateStandardEffect(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source);if("1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__){let e=a._defines[0];e||(e=a._defines[0]={}),e.OCCLUSION_CHANNEL||(e.OCCLUSION_CHANNEL="b"),e.ROUGHNESS_CHANNEL||(e.ROUGHNESS_CHANNEL="r"),e.METALLIC_CHANNEL||(e.METALLIC_CHANNEL="g");let r=a._props[0];r||(r=a._props[0]={}),r.occlusion=(r.pbrParams&&r.pbrParams[componentMap[e.OCCLUSION_CHANNEL]]||1)*(r.pbrScale&&r.pbrScale[componentMap[e.OCCLUSION_CHANNEL]]||1),r.roughness=(r.pbrParams&&r.pbrParams[componentMap[e.ROUGHNESS_CHANNEL]]||1)*(r.pbrScale&&r.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]]||.8),r.metallic=(r.pbrParams&&r.pbrParams[componentMap[e.METALLIC_CHANNEL]]||1)*(r.pbrScale&&r.pbrScale[componentMap[e.METALLIC_CHANNEL]]||.6),e.USE_PBR_MAP?(r.occlusion=r.pbrScale&&r.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof r.occlusion&&(r.occlusion=1),r.roughness=r.pbrScale&&r.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof r.roughness&&(r.roughness=1),r.metallic=r.pbrScale&&r.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof r.metallic&&(r.metallic=1)):e.USE_METALLIC_ROUGHNESS_MAP?(r.roughness=r.pbrScale&&r.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof r.roughness&&(r.roughness=1),r.metallic=r.pbrScale&&r.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof r.metallic&&(r.metallic=1)):e.USE_OCCLUSION_MAP&&(r.occlusion=r.pbrScale&&r.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof r.occlusion&&(r.occlusion=1))}}async function migrateLinearColor(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,t="a7612b54-35e3-4238-a1a9-4a7b54635839"===a._effectAsset.__uuid__,o="a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__,s="99498f84-efe6-43a6-a9a7-e6e93eb845c1"===a._effectAsset.__uuid__;if(r||t||s){let e=t?a._props[1]:a._props[0];e||(e=a._props[0]={}),e.mainColor&&(e.mainColor.r=Math.floor(255*Math.sqrt(e.mainColor.r/255)),e.mainColor.g=Math.floor(255*Math.sqrt(e.mainColor.g/255)),e.mainColor.b=Math.floor(255*Math.sqrt(e.mainColor.b/255))),e.emissive&&(e.emissive.r=Math.floor(255*Math.sqrt(e.emissive.r/255)),e.emissive.g=Math.floor(255*Math.sqrt(e.emissive.g/255)),e.emissive.b=Math.floor(255*Math.sqrt(e.emissive.b/255))),t&&(e.shadeColor1&&(e.shadeColor1.r=Math.floor(255*Math.sqrt(e.shadeColor1.r/255)),e.shadeColor1.g=Math.floor(255*Math.sqrt(e.shadeColor1.g/255)),e.shadeColor1.b=Math.floor(255*Math.sqrt(e.shadeColor1.b/255))),e.shadeColor2&&(e.shadeColor2.r=Math.floor(255*Math.sqrt(e.shadeColor2.r/255)),e.shadeColor2.g=Math.floor(255*Math.sqrt(e.shadeColor2.g/255)),e.shadeColor2.b=Math.floor(255*Math.sqrt(e.shadeColor2.b/255))),e.specular&&(e.specular.r=Math.floor(255*Math.sqrt(e.specular.r/255)),e.specular.g=Math.floor(255*Math.sqrt(e.specular.g/255)),e.specular.b=Math.floor(255*Math.sqrt(e.specular.b/255))))}if(o){let e=a._props[0];e||(e=a._props[0]={}),e.mainColor&&(e.mainColor.r=Math.floor(255*Math.sqrt(e.mainColor.r/255)),e.mainColor.g=Math.floor(255*Math.sqrt(e.mainColor.g/255)),e.mainColor.b=Math.floor(255*Math.sqrt(e.mainColor.b/255)))}}async function migrateLinearColorFixUnlitShader(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source);if("a3cd009f-0ab0-420d-9278-b9fdab939bbc"===a._effectAsset.__uuid__){let e=a._props[0];e||(e=a._props[0]={}),e.mainColor&&(e.mainColor.r=Math.floor(e.mainColor.r*e.mainColor.r/65535*255),e.mainColor.g=Math.floor(e.mainColor.g*e.mainColor.g/65535*255),e.mainColor.b=Math.floor(e.mainColor.b*e.mainColor.b/65535*255))}}async function migrateBlendColor(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source);a._states&&Array.isArray(a._states)&&a._states.forEach(e=>{var a,r,t,o;const s=e.blendState;if(s&&s.blendColor){const e=s.blendColor;Array.isArray(e)&&(s.blendColor={__type__:"cc.Color",r:null!==(a=e[0])&&void 0!==a?a:0,g:null!==(r=e[1])&&void 0!==r?r:0,b:null!==(t=e[2])&&void 0!==t?t:0,a:null!==(o=e[3])&&void 0!==o?o:0})}})}async function migrateNormalStrength(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,t="a7612b54-35e3-4238-a1a9-4a7b54635839"===a._effectAsset.__uuid__;if(r||t){let e=t?a._props[1]:a._props[0];e||(e=a._props[0]={}),void 0!==e.normalStrenth&&(e.normalStrength=e.normalStrenth)}}async function migrateOcclusion(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source);let r=a._props[0];r||(r=a._props[0]={}),void 0!==r.occlusion&&(r.occlusion=1-r.occlusion)}async function migrateMacroUseBatching(e){const a=(e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source))._defines[0];a&&a.USE_BATCHING&&(a.USE_BATCHING=void 0)}async function migrateRoughnessAndMetallic(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,t="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(r||t){let e=a._props[0];e||(e=a._props[0]={}),void 0===e.roughness&&(e.roughness=.8),void 0===e.metallic&&(e.metallic=.6)}}async function migrateEmissiveColor(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,t="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(r||t){let e=a._props[0];e||(e=a._props[0]={}),e.emissiveMap&&e.emissive&&(e.emissiveScale||(e.emissiveScale={__type__:"cc.Vec3",x:1,y:1,z:1}),e.emissiveScale.x*=e.emissive.r/255,e.emissiveScale.y*=e.emissive.g/255,e.emissiveScale.z*=e.emissive.b/255)}}async function migrateAlbedoScaleType(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source);for(let e=0;e<a._props.length;e++){const r=a._props[e].albedoScale;r&&"cc.Vec4"===r.__type__&&(delete r.w,r.__type__="cc.Vec3")}}async function migrateEmissiveScaleType(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="1baf0fc9-befa-459c-8bdd-af1a450a0319"===a._effectAsset.__uuid__,t="c8f66d17-351a-48da-a12c-0212d28575c4"===a._effectAsset.__uuid__;if(r||t)for(let e=0;e<a._props.length;e++){const r=a._props[e].emissiveScale;r&&"cc.Vec4"===r.__type__&&(delete r.w,r.__type__="cc.Vec3")}}async function migrateSpecularIntensity(e){const a=e.getSwapSpace().json||await(0,fs_extra_1.readJSON)(e.source),r="e396231e-43c6-4547-86f5-0ef92bf154ce"===a._effectAsset.__uuid__,t="fc0ce5f8-063d-42da-b13a-2fad25abb951"===a._effectAsset.__uuid__;if(r||t)for(let e=0;e<a._props.length;e++){const r=a._props[e].specularIntensity;if(r&&r<=.2&&(a._props[e].specularIntensity=Math.min(10*r,.5)),t){const r=a._props[e].IntensityTRT;r&&r<=1&&(a._props[e].IntensityTRT=Math.min(3*r,3))}}}