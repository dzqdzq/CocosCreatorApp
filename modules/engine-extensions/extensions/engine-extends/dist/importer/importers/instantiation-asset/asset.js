"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.zip=void 0;const asset_db_1=require("@editor/asset-db"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path");class AssetImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"instantiation-asset"}get assetType(){return"cc.Asset"}async import(e){const t=path_1.join(e._assetDB.options.temp,e.uuid);let r;r="win32"===process.platform?unzipOfWin32:unzipOfDarwin,fs_extra_1.existsSync(t)&&fs_extra_1.removeSync(t),await new Promise((s,n)=>{r(e.source,t,e=>{if(e)return n(e);s()})});const s=fs_extra_1.readdirSync(t);for(let r=0;r<s.length;r++){const n=s[r],o=path_1.join(t,n);await e.copyToLibrary("."+n,o)}return fs_extra_1.existsSync(t)&&fs_extra_1.removeSync(t),!0}}function zip(e,t){const r=require("archiver"),s=fs_extra_1.createWriteStream(e),n=r("zip");n.on("error",e=>{throw e}),n.pipe(s),t.forEach(e=>{const t=path_1.parse(e);n.append(fs_extra_1.createReadStream(e),{name:t.ext.substr(1)})}),n.finalize()}exports.default=AssetImporter,exports.zip=zip;const unzipOfDarwin=(e,t,r)=>{const s=path_1.dirname(t);fs_extra_1.ensureDirSync(s);const n=child_process_1.spawn("unzip",[e,"-d",t]);let o="";n.stderr.on("data",e=>{o+=e});let a="";n.stdout.on("data",e=>{a+=e}),n.on("close",e=>{a&&console.log(a),o&&console.warn(o);let t=null;0!==e&&(t=new Error("The decompression has failed")),r(t)})},unzipOfWin32=(e,t,r)=>{const s=path_1.dirname(t);fs_extra_1.ensureDirSync(s);const n=child_process_1.spawn(path_1.join(Editor.App.path,"../tools/unzip.exe"),[e,"-d",t]);let o="";n.stderr.on("data",e=>{o+=e});let a="";n.stdout.on("data",e=>{a+=e}),n.on("close",e=>{a&&console.log(a),o&&console.warn(o);let t=null;0!==e&&(t=new Error("The decompression has failed")),r(t)})};