"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__rest=this&&this.__rest||function(e,t){var a={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(a[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(s=Object.getOwnPropertySymbols(e);r<s.length;r++)t.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(e,s[r])&&(a[s[r]]=e[s[r]])}return a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateFbxMatchMeshNames=exports.migrateMeshOptimizerOption=exports.GltfImporter=void 0;const asset_db_1=require("@editor/asset-db"),ajv_1=__importDefault(require("ajv")),assert_1=require("assert"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),asset_finder_1=require("./gltf/asset-finder"),material_1=require("./gltf/material"),reader_manager_1=require("./gltf/reader-manager"),texture_1=require("./texture"),migratesNameToId=__importStar(require("./migrates/name2id")),uri_utils_1=require("./utils/uri-utils"),cc_1=require("cc"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),resolve_glTF_image_path_1=require("./utils/resolve-glTF-image-path"),serialize_library_1=require("./utils/serialize-library"),original_animation_1=require("./gltf/original-animation"),path_1=require("path"),utils_1=require("../utils"),meshSimplify_1=require("./gltf/meshSimplify"),lodash=require("lodash"),ajv=new ajv_1.default({errorDataPath:""});class GltfImporter extends asset_db_1.Importer{constructor(e){super(e);const t=path.join(__dirname,"..","..","..","static","meta-schemas","glTF.meta.json"),a=fs.readJSONSync(t);this._metaValidator=ajv.compile(a)}get version(){return"2.3.8"}get name(){return"gltf"}get migrations(){return[{version:"1.1.21",migrate(e){delete e.meta.userData.assetFinder}},{version:"1.1.23",migrate:migratesNameToId.migrate},{version:"1.3.0",migrate:migrateImageLocations},{version:"1.3.21",migrate:migrateDumpMaterial},{version:"2.0.0",migrate:migrateFbxConverterSelector},{version:"2.0.8",migrate:migrateFbxConverterUnitConversion},{version:"2.1.9",migrate:migrateFbxConverterPreferLocalTimeSpan},{version:"2.2.0",migrate:migrateSmartMaterialEnabled},{version:"2.3.0",migrate:migrateFBXPromoteSingleRootNode},{version:"2.3.2",migrate:migrateMeshOptimizerOption},{version:"2.3.5",migrate:migrateImageRemap},{version:"2.3.7",migrate:migrateFbxMatchMeshNames}]}async import(e){return await this._validateMeta(e),await this._importSubAssets(e)}async afterSubAssetsImport(e){await reader_manager_1.glTfReaderManager.delete(e)}async getGltfFilePath(e){const t=e.userData;return t.meshOptimizer&&t.meshOptimizer.enable?await this.getOptimizerPath(e,e.source,t.meshOptimizer):e.source}async getOptimizerPath(e,t,a){return"gltfpack"===a.algorithm?this._getOptimizerPath(e,t,a.gltfpackOptions):t}async _getOptimizerPath(e,t,a={}){const s=e._assetDB.options.temp,r=path.join(s,`gltfpack-${e.uuid}`);fs.ensureDirSync(r);const i=path.join(r,"out.gltf"),n=path.join(r,"status.json"),o={mtimeMs:(await fs_extra_1.stat(e.source)).mtimeMs,version:this.version,options:JSON.stringify(a)};if(fs_extra_1.existsSync(i)&&fs_extra_1.existsSync(n))try{const e=await fs_extra_1.readJSON(n);if(e.mtimeMs===o.mtimeMs&&e.version===o.version&&e.options===o.options)return i}catch(e){}return new Promise(e=>{try{const s=path.join(Editor.App.path,"./node_modules/gltfpack/bin/gltfpack.js"),r=["-i",t,"-o",i],m=a.c;"1"===m?r.push("-c"):"2"===m&&r.push("-cc"),a.te&&r.push("-te"),a.tb&&r.push("-tb"),a.tc&&r.push("-tc"),50!==a.tq&&void 0!==a.tq&&(r.push("-tq"),r.push(a.tq)),a.tu&&r.push("-tu"),1!==a.si&&void 0!==a.si&&(r.push("-si"),r.push(a.si)),a.sa&&r.push("-sa"),14!==a.vp&&void 0!==a.vp&&(r.push("-vp"),r.push(a.vp)),12!==a.vt&&void 0!==a.vt&&(r.push("-vt"),r.push(a.vt)),8!==a.vn&&void 0!==a.vn&&(r.push("-vn"),r.push(a.vn)),16!==a.at&&void 0!==a.at&&(r.push("-at"),r.push(a.at)),12!==a.ar&&void 0!==a.ar&&(r.push("-ar"),r.push(a.ar)),16!==a.as&&void 0!==a.as&&(r.push("-as"),r.push(a.as)),30!==a.af&&void 0!==a.af&&(r.push("-af"),r.push(a.af)),a.ac&&r.push("-ac"),a.kn&&r.push("-kn"),a.ke&&r.push("-ke"),a.cf&&r.push("-cf"),(a.noq||void 0===a.noq)&&r.push("-noq"),(a.v||void 0===a.v)&&r.push("-v"),child_process_1.fork(s,r).on("exit",async t=>{await fs.writeFile(n,JSON.stringify(o,void 0,2)),e(i)})}catch(a){console.error(a),e(t)}})}async _validateMeta(e){var t,a;if(null!==(t=(a=e.meta.userData).imageMetas)&&void 0!==t||(a.imageMetas=[]),!await this._metaValidator(e.meta.userData)){0!==Object.keys(e.meta.userData).length&&console.debug("Meta file of asset "+e.source+" is damaged: \n"+(this._metaValidator.errors||[]).map(e=>e.message)+"\nA default meta file is patched.");const t={imageMetas:[],legacyFbxImporter:!1,allowMeshDataAccess:!0,addVertexColor:!1,generateLightmapUVNode:!1,meshOptimizer:{enable:!1,algorithm:"simplify",simplifyOptions:meshSimplify_1.getDefautOptions()},lods:{enable:!1,hasBuiltinLOD:!1,options:[]}};e.meta.userData=lodash.defaultsDeep(e.meta.userData,t)}}async _importSubAssets(e){reader_manager_1.glTfReaderManager.delete(e);const t=await reader_manager_1.glTfReaderManager.getOrCreate(e,!0);await this._adjustMeta(e,t);const a=e.userData,s=new asset_finder_1.DefaultGltfAssetFinder(a.assetFinder),r=await this._importMeshes(e,t);s.set("meshes",r),await this._saveOriginalAnimations(e,t,!0);const{animationImportSettings:i}=a;if(i)for(const t of i)for(const a of t.splits){const{previousId:s,name:r,from:n,to:o,fps:m}=a,u=__rest(a,["previousId","name","from","to","fps"]),l=await e.createSubAsset(`${r}.animation`,"gltf-animation",{id:s});a.previousId=l._id;const c=l.userData;c.gltfIndex=i.indexOf(t),Object.assign(c,u),c.sample=null!==m&&void 0!==m?m:t.fps,c.span={from:n,to:o}}const n=await this._importSkins(e,t);s.set("skeletons",n),await this._importImages(e,t);const o=await this._importTextures(e,t);s.set("textures",o);const m=await this._importMaterials(e,t,s);s.set("materials",m);const u=await this._importScenes(e,t);if(s.set("scenes",u),!a.lods||!a.lods.options||!a.lods.options.length){const r=await Manager.Utils.queryAssetMeta(e.userData.redirect);if(r){const e=t.createScene(r.userData.gltfIndex||0,s),i=await loadLODs(a,e,t),n=i.length>0;a.lods={enable:n,hasBuiltinLOD:n,options:n?i:await generateDefaultLODsOption()}}}return a.dumpMaterials&&!m.every(e=>null!==e)?(console.debug("Waiting for dependency materials..."),!1):(a.assetFinder=s.serialize(),!0)}async _adjustMeta(e,t){const a=e.userData,s=t.gltf.images;if(s){const e=a.imageMetas,t=s.map((t,a)=>{const r={};if(t.name){if(r.name=t.name,e){const t=e.find(e=>e.remap&&e.name&&e.name===r.name);t&&(r.remap=t.remap)}}else e&&s.length===e.length&&!e[a].name&&e[a].remap&&(r.remap=e[a].remap);return r});a.imageMetas=t}else a.imageMetas=[];const r=t.gltf.animations;if(r){const s=a.animationImportSettings||[],i=makeUniqueSubAssetNames(e.basename,r,"animations",""),n=r.map((a,n)=>{const o=t.getAnimationDuration(n),m=a.name||i[n];let u=m;if(1===r.length){const t=path.basename(e.basename,path.extname(e.basename)).split("@");t.length>1&&(u=t[t.length-1])}const l={name:m,duration:o,fps:30,splits:[{name:u,from:0,to:o,wrapMode:cc_1.AnimationClip.WrapMode.Loop}]};let c=s.find(e=>e.name===l.name);if(c||s.length!==a.length||(c=s[n]),c){l.fps=c.fps;const e=e=>e===c.duration?o:Math.min(e,o);l.splits=c.splits.map(t=>{var a;return Object.assign(Object.assign({},t),{from:e(t.from),to:e(t.to),wrapMode:null!==(a=t.wrapMode)&&void 0!==a?a:cc_1.AnimationClip.WrapMode.Loop})})}return l});a.animationImportSettings=n}else delete a.animationImportSettings}async _importMeshes(e,t){const a=t.gltf.meshes;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"meshes",".mesh"),r=[];for(let t=0;t<a.length;t++){a[t];const i=await e.createSubAsset(s[t],"gltf-mesh");i.userData.gltfIndex=t,r.push(i.uuid)}const i=e.userData;if(i.lods&&!i.lods.hasBuiltinLOD&&i.lods.enable)for(let t=0;t<s.length;t++){const a=i.lods.options;for(let i=1;i<a.length;i++){const n=s[t].split(".mesh")[0]+`_LOD${i}.mesh`,o=await e.createSubAsset(n,"gltf-mesh");o.userData.gltfIndex=t,o.userData.lodLevel=i,o.userData.lodOptions={faceCount:a[i].faceCount},r.push(o.uuid)}}return r}async _importSkins(e,t){const a=t.gltf.skins;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"skeletons",".skeleton"),r=new Array(a.length);for(let t=0;t<a.length;t++){a[t];const i=await e.createSubAsset(s[t],"gltf-skeleton");i.userData.gltfIndex=t,r[t]=i.uuid}return r}async _importImages(e,t){const a=t.gltf.images;if(void 0===a)return;const s=e.userData,r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",i=e=>(()=>{const e=t.gltf.asset.generator;return null===e||void 0===e?void 0:e.includes("FBX2glTF")})()&&e===r,n=e=>(()=>{const e=t.gltf.asset.generator;return null===e||void 0===e?void 0:e.includes("FBX-glTF-conv")})()&&e===r,o=makeUniqueSubAssetNames(e.basename,a,"images",".image");for(let m=0;m<a.length;++m){const u=a[m],l=s.imageMetas[m],c=u.uri;let f,p=!1;if(c&&(i(c)||n(c)))p=!0;else if(c&&!c.startsWith("data:")){const e=t.path,a=url_1.default.pathToFileURL(e).toString();try{let e=new urijs_1.default(c);e=e.absoluteTo(a),uri_utils_1.convertsEncodedSeparatorsInURI(e),"file"===e.scheme()&&(f=url_1.default.fileURLToPath(e.toString()),p=!0)}catch(e){}}let d="";if(p){const t=e._assetDB.options.target,a=await resolve_glTF_image_path_1.resolveGlTfImagePath(u.name,f,path.dirname(e.source),u.extras,t);if(a){const t=asset_db_1.queryUrl(a);if(t)l.uri=t;else{const t=path_1.relative(Editor.Project.tmpDir,a);path_1.isAbsolute(t)||t.startsWith(`..${path_1.sep}`)?console.warn(`In model file ${e.source},`+`the image ${u.name} is resolved to ${a},`+"which is a location out of asset directory.This can cause problem as your project migrated."):d=a}}}if(!l.uri){const a=await e.createSubAsset(o[m],"gltf-embeded-image");a.userData.gltfIndex=m,l.uri=a.uuid,d?a.getSwapSpace().resolved=d:u.uri===r&&t.fbxMissingImagesId.push(m)}}}async _importTextures(e,t){const a=t.gltf.textures;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"textures",".texture"),r=new Array(a.length);for(let i=0;i<a.length;i++){const n=a[i],o=s[i],m=await e.createSubAsset(o,"texture"),u=texture_1.makeDefaultTexture2DAssetUserData();t.getTextureParameters(n,u);const l=m.userData;if(m.assignUserData(u),void 0!==n.source){const t=e.userData.imageMetas[n.source],a=t.remap||t.uri;if(a){const e=!a.startsWith("db://");if(l.isUuid=e,l.imageUuidOrDatabaseUri=a,!e){const e=asset_db_1.queryPath(l.imageUuidOrDatabaseUri);if(!e)throw new assert_1.AssertionError({message:`${l.imageUuidOrDatabaseUri} is not found in asset-db.`});m.depend(e)}}else delete l.imageUuidOrDatabaseUri,delete l.isUuid}r[i]=m.uuid}return r}async _importMaterials(e,t,a){const s=t.gltf.materials;if(void 0===s)return[];const{dumpMaterials:r}=e.userData,i=makeUniqueSubAssetNames(e.basename,s,"materials",r?".mtl":".material"),n=new Array(s.length);for(let o=0;o<s.length;o++)if(r)n[o]=await material_1.dumpMaterial(e,a,t,o,i[o]);else{const t=await e.createSubAsset(i[o],"gltf-material");t.userData.gltfIndex=o,n[o]=t.uuid}return n}async _importScenes(e,t){const a=t.gltf.scenes;if(void 0===a)return[];let s="";if(e.uuid2recycle)for(const t in e.uuid2recycle){const a=e.uuid2recycle[t];"gltf-scene"===a.importer&&"id"in a&&(s=t)}const r=makeUniqueSubAssetNames(e.basename,a,"scenes",".prefab"),i=new Array(a.length);for(let n=0;n<a.length;n++){a[n];const o=await e.createSubAsset(r[n],"gltf-scene",{id:s});o.userData.gltfIndex=n,(t.gltf.scene||0)===n&&(e.userData.redirect=o.uuid),i[n]=o.uuid}return i}async _saveOriginalAnimations(e,t,a){const s=t.gltf.animations;s&&await Promise.all(s.map(async(a,s)=>{const r=t.createAnimation(s),{data:i,extension:n}=serialize_library_1.serializeForLibrary(r),o=original_animation_1.getOriginalAnimationLibraryPath(e,s);await e.saveToLibrary(o,i);const m=utils_1.getDependUUIDList(i);e.setData("depends",m)}))}}exports.GltfImporter=GltfImporter;const maxLodLevel=7,defaultLODsOptions={screenRatio:0,faceCount:0};async function deepFindMeshRenderer(e,t,a,s){var r;const i=e.getComponents(cc_1.MeshRenderer);let n=0;if(i&&i.length>0)for(const e of i)if(e.mesh&&e.mesh.uuid){let i=0;const o=await Manager.Utils.queryAssetMeta(e.mesh.uuid);o.userData.lodLevel=a,null===(r=t.createMesh(o.userData.gltfIndex,s).struct.primitives)||void 0===r||r.forEach(e=>{e&&e.indexView&&(i+=e.indexView.count)}),n+=i/3}if(e.children&&e.children.length>0)for(const r of e.children){return n+await deepFindMeshRenderer(r,t,a,s)}return n}async function loadLODs(e,t,a){const s=[],r=[];for(const i of t.children){const t=/_LOD(\d+)$/i.exec(i.name);if(t&&t.length>1){const n=parseInt(t[1],10);n<=maxLodLevel&&(s[n]=s[n]||Object.assign({},defaultLODsOptions),r[n]=(r[n]||0)+await deepFindMeshRenderer(i,a,n,e.generateLightmapUVNode))}}if(s.length>0){const e=Math.max(...Object.keys(s).map(e=>+e));let t=.25;for(let a=0;a<e;a++)s[a]||(console.debug(`No mesh name are ending with _LOD${a}`),s[a]=Object.assign({},defaultLODsOptions)),s[a].screenRatio=t,t/=2,0!==r[0]&&(s[a].faceCount=r[a]/r[0]);s[e].screenRatio=t<.01?t:.01,s[e].faceCount=r[0]?r[e]/r[0]:0}return s}async function generateDefaultLODsOption(){const e=[],t=[.25,.125,.01],a=[1,.25,.1];for(let s=0;s<3;s++)e[s]={screenRatio:t[s],faceCount:a[s]};return e}function makeUniqueSubAssetNames(e,t,a,s){let r=t.map(t=>{let s;return s="scenes"===a?e:"string"==typeof t.name?t.name:(()=>{switch(a){case"animations":return"UnnamedAnimation";case"images":return"UnnamedImage";case"meshes":return"UnnamedMesh";case"materials":return"UnnamedMaterial";case"skeletons":return"UnnamedSkeleton";case"textures":return"UnnamedTexture";default:return"Unnamed"}})()});if(!isDifferWithEachOther(r)){let e="-";for(;!r.every(t=>!t.endsWith(e));)e+="-";r=r.map((t,a)=>t+`${e}${a}`)}return r.map(e=>e+s)}function isDifferWithEachOther(e){if(e.length>=2){const t=e.slice().sort();for(let e=0;e<t.length-1;++e)if(t[e]===t[e+1])return!1}return!0}async function migrateImageLocations(e){const t=e.meta.userData,a=[];if(t.imageLocations){const{imageLocations:e}=t;for(const t of Object.keys(e)){const s=e[t];s.targetDatabaseUrl&&a.push({name:t,remap:s.targetDatabaseUrl})}delete t.imageLocations}e.meta.userData.imageMetas=a,t.assetFinder&&t.assetFinder.images&&delete t.assetFinder.images}async function migrateImageRemap(e){const t=e.meta.userData;if(t.imageMetas)for(const e of t.imageMetas){const{remap:t}=e;if(!t)continue;const a=asset_db_1.queryUUID(t);a&&(e.remap=a)}}async function migrateDumpMaterial(e){if(!e.userData.dumpMaterials||e.userData.materialDumpDir)return;const t=path.join(e.source,`../Materials_${e.basename}.FBX`),a=path.join(e.source,`../Materials_${e.basename}.FBX.meta`),s=path.join(e.source,`../Materials_${e.basename}`),r=path.join(e.source,`../Materials_${e.basename}.meta`);fs.existsSync(t)&&!fs.existsSync(s)&&(fs.renameSync(t,s),fs.existsSync(a)&&fs.renameSync(a,r),e._assetDB.refresh(s))}async function migrateFbxConverterSelector(e){".fbx"===e.extname&&(e.userData.legacyFbxImporter=!0)}async function migrateFbxConverterUnitConversion(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;a.legacyFbxImporter||((null!==(t=a.fbx)&&void 0!==t?t:a.fbx={}).unitConversion="hierarchy-level")}async function migrateFbxConverterPreferLocalTimeSpan(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;a.legacyFbxImporter||((null!==(t=a.fbx)&&void 0!==t?t:a.fbx={}).preferLocalTimeSpan=!1)}async function migrateSmartMaterialEnabled(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;(null!==(t=a.fbx)&&void 0!==t?t:a.fbx={}).smartMaterialEnabled=!1}async function migrateFBXPromoteSingleRootNode(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;(null===(t=a.fbx)||void 0===t?void 0:t.promoteSingleRootNode)&&(a.promoteSingleRootNode=a.fbx.promoteSingleRootNode,delete a.fbx.promoteSingleRootNode)}function migrateMeshOptimizerOption(e){const t=e.userData;t.meshOptimizer&&(t.meshOptimizer={algorithm:"gltfpack",enable:!0,gltfpackOptions:t.meshOptimizerOptions||{}},delete t.meshOptimizerOptions)}function migrateFbxMatchMeshNames(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;(null!==(t=a.fbx)&&void 0!==t?t:a.fbx={}).matchMeshNames=!1}exports.migrateMeshOptimizerOption=migrateMeshOptimizerOption,exports.migrateFbxMatchMeshNames=migrateFbxMatchMeshNames,exports.default=GltfImporter;