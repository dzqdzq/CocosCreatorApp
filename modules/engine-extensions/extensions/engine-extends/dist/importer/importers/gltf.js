"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImporter=void 0;const asset_db_1=require("@editor/asset-db"),ajv_1=__importDefault(require("ajv")),assert_1=require("assert"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),asset_finder_1=require("./gltf/asset-finder"),material_1=require("./gltf/material"),reader_manager_1=require("./gltf/reader-manager"),texture_1=require("./texture"),migratesNameToId=__importStar(require("./migrates/name2id")),uri_utils_1=require("./utils/uri-utils"),cc_1=require("cc"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),resolve_glTF_image_path_1=require("./utils/resolve-glTF-image-path"),serialize_library_1=require("./utils/serialize-library"),original_animation_1=require("./gltf/original-animation"),path_1=require("path"),utils_1=require("../utils"),ajv=new ajv_1.default({errorDataPath:""});class GltfImporter extends asset_db_1.Importer{constructor(e){super(e);e=path.join(__dirname,"..","..","..","static","meta-schemas","glTF.meta.json"),e=fs.readJSONSync(e);this._metaValidator=ajv.compile(e)}get version(){return"2.3.1"}get name(){return"gltf"}get migrations(){return[{version:"1.1.21",migrate(e){delete e.meta.userData.assetFinder}},{version:"1.1.23",migrate:migratesNameToId.migrate},{version:"1.3.0",migrate:migrateImageLocations},{version:"1.3.21",migrate:migrateDumpMaterial},{version:"2.0.0",migrate:migrateFbxConverterSelector},{version:"2.0.8",migrate:migrateFbxConverterUnitConversion},{version:"2.1.9",migrate:migrateFbxConverterPreferLocalTimeSpan},{version:"2.2.0",migrate:migrateSmartMaterialEnabled},{version:"2.3.0",migrate:migrateFBXPromoteSingleRootNode}]}async import(e){return await this._validateMeta(e),this._importSubAssets(e)}async getGltfFilePath(e){var t=e.userData;return t.meshOptimizer?this.getOptimizerPath(e,e.source,t.meshOptimizerOptions||{}):e.source}async getOptimizerPath(e,s,i){var t=e._assetDB.options.temp,t=path.join(t,"gltfpack-"+e.uuid);fs.ensureDirSync(t);const n=path.join(t,"out.gltf"),o=path.join(t,"status.json"),u={mtimeMs:(await fs_extra_1.stat(e.source)).mtimeMs,version:this.version,options:JSON.stringify(i)};if(fs_extra_1.existsSync(n)&&fs_extra_1.existsSync(o))try{var a=await fs_extra_1.readJSON(o);if(a.mtimeMs===u.mtimeMs&&a.version===u.version&&a.options===u.options)return n}catch(e){}return new Promise(t=>{try{var e=path.join(Editor.App.path,"./node_modules/gltfpack/bin/gltfpack.js"),a=["-i",s,"-o",n],r=i.c;"1"===r?a.push("-c"):"2"===r&&a.push("-cc"),i.te&&a.push("-te"),i.tb&&a.push("-tb"),i.tc&&a.push("-tc"),50!==i.tq&&void 0!==i.tq&&(a.push("-tq"),a.push(i.tq)),i.tu&&a.push("-tu"),1!==i.si&&void 0!==i.si&&(a.push("-si"),a.push(i.si)),i.sa&&a.push("-sa"),14!==i.vp&&void 0!==i.vp&&(a.push("-vp"),a.push(i.vp)),12!==i.vt&&void 0!==i.vt&&(a.push("-vt"),a.push(i.vt)),8!==i.vn&&void 0!==i.vn&&(a.push("-vn"),a.push(i.vn)),16!==i.at&&void 0!==i.at&&(a.push("-at"),a.push(i.at)),12!==i.ar&&void 0!==i.ar&&(a.push("-ar"),a.push(i.ar)),16!==i.as&&void 0!==i.as&&(a.push("-as"),a.push(i.as)),30!==i.af&&void 0!==i.af&&(a.push("-af"),a.push(i.af)),i.ac&&a.push("-ac"),i.kn&&a.push("-kn"),i.ke&&a.push("-ke"),i.cf&&a.push("-cf"),!i.noq&&void 0!==i.noq||a.push("-noq"),!i.v&&void 0!==i.v||a.push("-v"),child_process_1.fork(e,a).on("exit",async e=>{await fs.writeFile(o,JSON.stringify(u,void 0,2)),t(n)})}catch(e){console.error(e),t(s)}})}async _validateMeta(e){await this._metaValidator(e.meta.userData)||(0!==Object.keys(e.meta.userData).length&&console.warn("Meta file of asset "+e.source+" is damaged: \n"+(this._metaValidator.errors||[]).map(e=>e.message)+"\nA default meta file is generated."),e.meta.userData={imageMetas:[],legacyFbxImporter:!1,allowMeshDataAccess:!0})}async _importSubAssets(e){reader_manager_1.glTfReaderManager.delete(e);var t,a=await reader_manager_1.glTfReaderManager.getOrCreate(e,!0),r=(await this._adjustMeta(e,a),e.userData),s=new asset_finder_1.DefaultGltfAssetFinder(r.assetFinder),i=await this._importMeshes(e,a),n=(s.set("meshes",i),await this._saveOriginalAnimations(e,a,!0),r)["animationImportSettings"];if(n)for(const u of n)for(const m of u.splits){var o=(await e.createSubAsset(m.name+".animation","gltf-animation")).userData;o.gltfIndex=n.indexOf(u),void 0!==m.wrapMode&&(o.wrapMode=m.wrapMode),void 0!==m.speed&&(o.speed=m.speed),o.sample=null!=(t=m.fps)?t:u.fps,o.span={from:m.from,to:m.to}}i=await this._importSkins(e,a),s.set("skeletons",i),await this._importImages(e,a),i=await this._importTextures(e,a),s.set("textures",i),i=await this._importMaterials(e,a,s),s.set("materials",i),a=await this._importScenes(e,a);return s.set("scenes",a),r.dumpMaterials&&!i.every(e=>null!==e)?(console.debug("Waiting for dependency materials..."),!1):(r.assetFinder=s.serialize(),!0)}async _adjustMeta(m,l){var e=m.userData;const r=l.gltf.images;if(r){const s=e.imageMetas;var t=r.map((e,t)=>{const a={};return e.name?(a.name=e.name,s&&(e=s.find(e=>e.remap&&e.name&&e.name===a.name))&&(a.remap=e.remap)):s&&r.length===s.length&&!s[t].name&&s[t].remap&&(a.remap=s[t].remap),a});e.imageMetas=t}else e.imageMetas=[];const p=l.gltf.animations;if(p){const f=e.animationImportSettings||[],c=makeUniqueSubAssetNames(m.basename,p,"animations","");t=p.map((e,t)=>{const a=l.getAnimationDuration(t);var r,s=e.name||c[t];let i=s;1===p.length&&1<(r=path.basename(m.basename,path.extname(m.basename)).split("@")).length&&(i=r[r.length-1]);const n={name:s,duration:a,fps:30,splits:[{name:i,from:0,to:a,wrapMode:cc_1.AnimationClip.WrapMode.Loop}]};let o=f.find(e=>e.name===n.name);if(o=o||f.length!==e.length?o:f[t]){n.fps=o.fps;const u=e=>e===o.duration?a:Math.min(e,a);n.splits=o.splits.map(e=>{var t;return{name:e.name,from:u(e.from),to:u(e.to),fps:e.fps,wrapMode:null!=(t=e.wrapMode)?t:cc_1.AnimationClip.WrapMode.Loop,speed:e.speed}})}return n});e.animationImportSettings=t}else delete e.animationImportSettings}async _importMeshes(t,e){var a=e.gltf.meshes;if(void 0===a)return[];var r=makeUniqueSubAssetNames(t.basename,a,"meshes",".mesh"),s=new Array(a.length);for(let e=0;e<a.length;e++){a[e];var i=await t.createSubAsset(r[e],"gltf-mesh");s[i.userData.gltfIndex=e]=i.uuid}return s}async _importSkins(t,e){var a=e.gltf.skins;if(void 0===a)return[];var r=makeUniqueSubAssetNames(t.basename,a,"skeletons",".skeleton"),s=new Array(a.length);for(let e=0;e<a.length;e++){a[e];var i=await t.createSubAsset(r[e],"gltf-skeleton");s[i.userData.gltfIndex=e]=i.uuid}return s}async _importImages(s,i){var n=i.gltf.images;if(void 0!==n){var o=s.userData;const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";var u=e=>{return(null==(t=i.gltf.asset.generator)?void 0:t.includes("FBX2glTF"))&&e===a;var t};var m=e=>{return(null==(t=i.gltf.asset.generator)?void 0:t.includes("FBX-glTF-conv"))&&e===a;var t},l=makeUniqueSubAssetNames(s.basename,n,"images",".image");for(let r=0;r<n.length;++r){var p=n[r],f=o.imageMetas[r],c=p.uri;let t=!1,a;if(c&&(u(c)||m(c)))t=!0;else if(c&&!c.startsWith("data:")){var d=i.path,d=url_1.default.pathToFileURL(d).toString();try{let e=new urijs_1.default(c);e=e.absoluteTo(d),uri_utils_1.convertsEncodedSeparatorsInURI(e),"file"===e.scheme()&&(a=url_1.default.fileURLToPath(e.toString()),t=!0)}catch(e){}}let e="";t&&(c=s._assetDB.options.target,d=await resolve_glTF_image_path_1.resolveGlTfImagePath(p.name,a,path.dirname(s.source),p.extras,c))&&((c=asset_db_1.queryUrl(d))?f.uri=c:(c=path_1.relative(Editor.Project.tmpDir,d),path_1.isAbsolute(c)||c.startsWith(".."+path_1.sep)?console.warn(`In model file ${s.source},`+`the image ${p.name} is resolved to ${d},`+"which is a location out of asset directory.This can cause problem as your project migrated."):e=d)),f.uri||((c=await s.createSubAsset(l[r],"gltf-embeded-image")).userData.gltfIndex=r,f.uri=c.uuid,e&&(c.getSwapSpace().resolved=e))}}}async _importTextures(t,a){var r=a.gltf.textures;if(void 0===r)return[];var s=makeUniqueSubAssetNames(t.basename,r,"textures",".texture"),i=new Array(r.length);for(let e=0;e<r.length;e++){var n=r[e],o=s[e],o=await t.createSubAsset(o,"texture"),u=o.userData;if(o.assignUserData(texture_1.makeDefaultTexture2DAssetUserData()),a.getTextureParameters(n,u),void 0!==n.source){n=t.userData.imageMetas[n.source],n=n.remap||n.uri;if(n){var m=!n.startsWith("db://");if(u.isUuid=m,u.imageUuidOrDatabaseUri=n,!m){n=asset_db_1.queryPath(u.imageUuidOrDatabaseUri);if(!n)throw new assert_1.AssertionError({message:u.imageUuidOrDatabaseUri+" is not found in asset-db."});o.depend(n)}}else delete u.imageUuidOrDatabaseUri,delete u.isUuid}i[e]=o.uuid}return i}async _importMaterials(t,a,r){var s=a.gltf.materials;if(void 0===s)return[];var i,n=t.userData["dumpMaterials"],o=makeUniqueSubAssetNames(t.basename,s,"materials",n?".mtl":".material"),u=new Array(s.length);for(let e=0;e<s.length;e++)n?u[e]=await material_1.dumpMaterial(t,r,a,e,o[e]):u[(i=await t.createSubAsset(o[e],"gltf-material")).userData.gltfIndex=e]=i.uuid;return u}async _importScenes(t,a){var r=a.gltf.scenes;if(void 0===r)return[];let s="";if(t.uuid2recycle)for(const u in t.uuid2recycle){var e=t.uuid2recycle[u];"gltf-scene"===e.importer&&"id"in e&&(s=u)}var i=makeUniqueSubAssetNames(t.basename,r,"scenes",".prefab"),n=new Array(r.length);for(let e=0;e<r.length;e++){r[e];var o=await t.createSubAsset(i[e],"gltf-scene",{id:s});o.userData.gltfIndex=e,(a.gltf.scene||0)===e&&(t.userData.redirect=o.uuid),n[e]=o.uuid}return n}async _saveOriginalAnimations(r,s,e){var t=s.gltf.animations;t&&await Promise.all(t.map(async(e,t)=>{var a=s.createAnimation(t),a=serialize_library_1.serializeForLibrary(a)["data"],t=original_animation_1.getOriginalAnimationLibraryPath(r,t),t=(await r.saveToLibrary(t,a),utils_1.getDependUUIDList(a));r.setData("depends",t)}))}}function makeUniqueSubAssetNames(a,e,r,t){let s=e.map(e=>{let t;return t="scenes"===r?a:"string"==typeof e.name?e.name:(()=>{switch(r){case"animations":return"UnnamedAnimation";case"images":return"UnnamedImage";case"meshes":return"UnnamedMesh";case"materials":return"UnnamedMaterial";case"skeletons":return"UnnamedSkeleton";case"textures":return"UnnamedTexture";default:return"Unnamed"}})()});if(!isDifferWithEachOther(s)){let a="-";for(;;){if(s.every(e=>!e.endsWith(a)))break;a+="-"}s=s.map((e,t)=>e+(""+a)+t)}return s.map(e=>e+t)}function isDifferWithEachOther(e){if(2<=e.length){var t=e.slice().sort();for(let e=0;e<t.length-1;++e)if(t[e]===t[e+1])return!1}return!0}async function migrateImageLocations(e){var t=e.meta.userData,a=[];if(t.imageLocations){var r=t["imageLocations"];for(const i of Object.keys(r)){var s=r[i];s.targetDatabaseUrl&&a.push({name:i,remap:s.targetDatabaseUrl})}delete t.imageLocations}e.meta.userData.imageMetas=a,t.assetFinder&&t.assetFinder.images&&delete t.assetFinder.images}async function migrateDumpMaterial(e){var t,a,r,s;e.userData.dumpMaterials&&!e.userData.materialDumpDir&&(t=path.join(e.source,`../Materials_${e.basename}.FBX`),a=path.join(e.source,`../Materials_${e.basename}.FBX.meta`),r=path.join(e.source,"../Materials_"+e.basename),s=path.join(e.source,`../Materials_${e.basename}.meta`),fs.existsSync(t))&&!fs.existsSync(r)&&(fs.renameSync(t,r),fs.existsSync(a)&&fs.renameSync(a,s),e._assetDB.refresh(r))}async function migrateFbxConverterSelector(e){".fbx"===e.extname&&(e.userData.legacyFbxImporter=!0)}async function migrateFbxConverterUnitConversion(e){var t;".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((null!=(t=e.fbx)?t:e.fbx={}).unitConversion="hierarchy-level")}async function migrateFbxConverterPreferLocalTimeSpan(e){var t;".fbx"!==e.extname||(e=e.userData).legacyFbxImporter||((null!=(t=e.fbx)?t:e.fbx={}).preferLocalTimeSpan=!1)}async function migrateSmartMaterialEnabled(e){var t;".fbx"===e.extname&&((null!=(t=(e=e.userData).fbx)?t:e.fbx={}).smartMaterialEnabled=!1)}async function migrateFBXPromoteSingleRootNode(e){var t;".fbx"===e.extname&&null!=(t=(e=e.userData).fbx)&&t.promoteSingleRootNode&&(e.promoteSingleRootNode=e.fbx.promoteSingleRootNode,delete e.fbx.promoteSingleRootNode)}exports.GltfImporter=GltfImporter,exports.default=GltfImporter;