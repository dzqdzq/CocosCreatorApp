"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.upgradeProperties=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),auxMap={x:"r",y:"g",z:"b",w:"a",r:"x",g:"y",b:"z",a:"w"};function getVectorComponent(e,r){const t=e[r],s=e[auxMap[r]];return void 0!==t?t:void 0!==s?s:0}const idxMap=["x","y","z","w"];function serializeAsVector(e){const r={__type__:"cc.Vec"+e.length};return e.forEach((e,t)=>r[idxMap[t]]=e),r}const defineRE=/<\s*(\w+)\s*(?:\|\s*(\w+))?\s*>/g,targetRE=/(\w+)\s*(?:\.\s*([xyzw]+|[rgba]+))?/i;function handleFormerlySerializedAs(e,r,t,s,o){let n=defineRE.exec(s),i=!1;for(n&&n[0].length>=s.length-1&&(i=!0);n;){const e=r[n[1]]||n[2]||"",t=n.index,o=n.index+n[0].length;s=s.substring(0,t)+e+s.substring(o),defineRE.lastIndex=0,n=defineRE.exec(s)}const a=targetRE.exec(s);if(!a)return console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1;if(!s.endsWith("!")&&void 0!==e[t])return!1;if(i)return e[t]!==s&&(e[t]=s,!0);const c=e[a[1]];if(void 0===c)return!1;const d=a[2]&&a[2].toLowerCase()||"";if(d&&"object"!=typeof c)return console.warn(`formerlySerializedAs: '${s}' expected an object, get ${typeof c} in ${o}, upgrade skipped`),!1;if(d.length>4)return console.warn(`formerlySerializedAs: illegal target '${s}', upgrade skipped`),!1;if(0===d.length)e[t]=c,delete e[a[1]];else if(1===d.length)e[t]=getVectorComponent(c,d);else{const r=d.split("").map(e=>getVectorComponent(c,e));e[t]=serializeAsVector(r)}return!0}async function upgradeProperties(e,r){const t=r.uuid,s=e._effectAsset&&e._effectAsset.__uuid__;let o=!1;if(!s)return!1;const n=(0,asset_db_1.queryAsset)(s);if(!n||!n.imported)return!1;const i=n.library+".json";if(!(0,fs_extra_1.existsSync)(i))return console.error(`upgradeProperties: the library json of effect(${n.source}) not found, upgrade skipped`),!1;const a=(0,fs_extra_1.readJSONSync)(i).techniques[e._techIdx].passes;for(let r=0;r<a.length;r++){const s=a[r].migrations;if(!s)continue;const n=e._props[r],i=e._defines[r];if(s.properties&&n&&i){for(const e of Object.keys(s.properties)){const r=s.properties[e].formerlySerializedAs;r&&(o=handleFormerlySerializedAs(n,i,e,r,t)||o)}for(const e of Object.keys(s.properties))s.properties[e].removeImmediately&&(delete n[e],o=!0)}if(s.macros&&i){for(const e of Object.keys(s.macros)){const r=s.macros[e].formerlySerializedAs;r&&(o=handleFormerlySerializedAs(i,i,e,r,t)||o)}for(const e of Object.keys(s.macros))s.macros[e].removeImmediately&&(delete i[e],o=!0)}}return o}exports.upgradeProperties=upgradeProperties;