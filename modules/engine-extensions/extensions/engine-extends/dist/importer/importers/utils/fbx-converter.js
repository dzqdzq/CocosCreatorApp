"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFbxConverter=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importStar(require("fs-extra")),child_process_1=__importDefault(require("child_process")),utils_1=require("../../utils");function createFbxConverter(e){let{tool:t}=require("@editor/fbx-gltf-conv");const r=t.replace("app.asar","app.asar.unpacked");return fs_extra_1.default.existsSync(r)&&(t=r),{get options(){return e},get:(e,t)=>path_1.default.join(t,"out.gltf"),async convert(r,a){var s,i,l,u,f;const c=[];c.push(o(r.source)),c.push("--unit-conversion",null!==(s=e.unitConversion)&&void 0!==s?s:"geometry-level"),c.push("--animation-bake-rate",`${null!==(i=e.animationBakeRate)&&void 0!==i?i:0}`),c.push(`--prefer-local-time-span=${null===(l=e.preferLocalTimeSpan)||void 0===l||l}`),c.push(`--match-mesh-names=${null===(u=e.matchMeshNames)||void 0===u||u}`),null!==(f=e.smartMaterialEnabled)&&void 0!==f&&f&&(c.push("--export-fbx-file-header-info"),c.push("--export-raw-materials"));const d=path_1.default.join(a,"out.gltf");await fs_extra_1.default.ensureDir(path_1.default.dirname(d)),c.push("--out",o(d));const p=path_1.default.join(a,".fbm");await fs_extra_1.default.ensureDir(p),c.push("--fbm-dir",o(p));const _=n(a);await fs_extra_1.default.ensureDir(path_1.default.dirname(_)),c.push("--log-file",o(_));let v=await(b=t,h=c,g=a,new Promise((e,t)=>{const r=child_process_1.default.spawn(o(b),h,{cwd:g,shell:!0});let n="";r.stdout&&r.stdout.on("data",e=>n+=e);let a="";r.stderr&&r.stderr.on("data",e=>a+=e),r.on("error",t),r.on("close",t=>{n&&console.log(n),a&&console.error(a),0===t?e(!0):(1===t||(3221225781===t?console.error(Editor.I18n.t("asset-db.importers.fbx.fbxGlTfConv.missing_dll")):126===t&&"darwin"===process.platform?console.error(Editor.I18n.t("engine-extends.importers.fbx.fbxGlTfConv.badCPU")):console.error(`FBX-glTF-conv existed with unexpected non-zero code ${t}`)),e(!1))})}));var b,h,g;return v&&!await(0,fs_extra_1.pathExists)(d)&&(v=!1,console.error(`Tool FBX-glTF-conv ends abnormally(spawn ${t} ${c.join(" ")}).`)),v},async printLogs(e,t){const r=n(t);if(await(0,fs_extra_1.pathExists)(r)){let t;try{t=await fs_extra_1.default.readJson(r)}catch(e){console.debug("No logs are generated, it should not happen indeed.")}if(Array.isArray(t))try{!function(e,t){const r=e=>{let r;switch(e){case FbxGlTfConvLogLevel.verbose:r=console.debug;break;case FbxGlTfConvLogLevel.info:r=console.log;break;case FbxGlTfConvLogLevel.warning:r=console.warn;break;case FbxGlTfConvLogLevel.error:case FbxGlTfConvLogLevel.fatal:default:r=console.error}return e=>{r.call(console,function(e,t){return`${e} [${(0,utils_1.linkToAssetTarget)(t.uuid)}]`}(e,t))}},o={};for(const{level:t,message:n}of e){const e=r(t);if("string"==typeof n)e(n);else{const t=n.code;if("unsupported_inherit_type"===t){const e=n.type,t=n.node;e in o||(o[e]=[]),o[e].push(t)}else e("string"==typeof t?a(t,n):JSON.stringify(n,void 0,2))}}for(const[e,t]of Object.entries(o))r(FbxGlTfConvLogLevel.verbose)(a("unsupported_inherit_type",{type:e,nodes:t}))}(t,e)}catch(e){console.error(e)}}}};function o(e){return`"${e}"`}function n(e){return path_1.default.join(e,"log.json")}function a(e,t){return Editor.I18n.t(`asset-db.importers.fbx.fbxGlTfConv.${e}`,t)}}var FbxGlTfConvLogLevel;exports.createFbxConverter=createFbxConverter,function(e){e[e.verbose=0]="verbose",e[e.info=1]="info",e[e.warning=2]="warning",e[e.error=3]="error",e[e.fatal=4]="fatal"}(FbxGlTfConvLogLevel||(FbxGlTfConvLogLevel={}));