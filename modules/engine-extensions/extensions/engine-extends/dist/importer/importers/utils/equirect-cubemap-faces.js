"use strict";function clamp(e,n,t){return Math.min(t,Math.max(n,e))}function srgbToLinear(e){return Math.pow(e,2.2)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.equirectToCubemapFaces=exports.InterpolationType=exports.nearestPowerOfTwo=void 0;const i255=1/255;function betweenZeroAndOne(e){return i255*e}function linearToSRGB(e){return Math.pow(e,.454545)}const ilog2=1/Math.log(2);function nearestPowerOfTwo(e){return 1<<Math.round(Math.log(e)*ilog2)}var InterpolationType;exports.nearestPowerOfTwo=nearestPowerOfTwo,function(e){e.BILINEAR="bilinear",e.NEAREST="nearest"}(InterpolationType=exports.InterpolationType||(exports.InterpolationType={}));const DEFAULT_OPTIONS={flipTheta:!1,interpolation:InterpolationType.BILINEAR,isRGBE:!1},rgbe_base=1.1;function floatToRGBE(e,n,t,r,o){const a=Math.max(Math.max(e,n),t),i=Math.ceil(Math.log(a)/Math.log(rgbe_base)),s=Math.min(Math.max(i+128,0),255),b=Math.pow(rgbe_base,s-128);r[o+0]=e/b*255|0,r[o+1]=n/b*255|0,r[o+2]=t/b*255|0,r[o+3]=s}function transformSingleFace(e,n,t,r){const o=r.flipTheta?-1:1,a=0|t.width,i=0|e.width,s=0|e.height,b=e.data,h=r.interpolation===InterpolationType.NEAREST,w=r.isRGBE,c=t.data,d=0|t.width,l=0|t.height,g=0|n,f=2/d,p=2/l;for(let e=0;e<l;++e)for(let n=0;n<d;++n){const t=f*n,r=p*e,d=n+e*a<<2;let l=0,T=0,u=0;switch(g){case 0:l=1,T=1-t,u=1-r;break;case 1:l=-1,T=t-1,u=1-r;break;case 2:l=t-1,T=r-1,u=1;break;case 3:l=t-1,T=1-r,u=-1;break;case 4:l=t-1,T=1,u=1-r;break;case 5:l=1-t,T=-1,u=1-r}const A=o*Math.atan2(T,l),O=Math.sqrt(l*l+T*T),m=Math.atan2(u,O),M=i/4*2*(A+Math.PI)/Math.PI,Z=i/4*2*(Math.PI/2-m)/Math.PI,I=0|Math.floor(M),L=0|Math.floor(Z);if(h){const e=I%i+i*clamp(L,0,s-1)<<2;c[d+0]=0|b[e+0],c[d+1]=0|b[e+1],c[d+2]=0|b[e+2],c[d+3]=0|b[e+3]}else{const e=I+1,n=L+1,t=M-I,r=Z-L,o=I%i+i*clamp(L,0,s-1)<<2,a=e%i+i*clamp(L,0,s-1)<<2,h=I%i+i*clamp(n,0,s-1)<<2,l=e%i+i*clamp(n,0,s-1)<<2,g=(1-t)*(1-r),f=t*(1-r),p=(1-t)*r,T=t*r;if(w){const e=Math.pow(rgbe_base,(0|b[o+3])-128),n=Math.pow(rgbe_base,(0|b[a+3])-128),t=Math.pow(rgbe_base,(0|b[h+3])-128),r=Math.pow(rgbe_base,(0|b[l+3])-128),i=betweenZeroAndOne(0|b[o+0])*e,s=betweenZeroAndOne(0|b[o+1])*e,w=betweenZeroAndOne(0|b[o+2])*e,u=betweenZeroAndOne(0|b[a+0])*n,A=betweenZeroAndOne(0|b[a+1])*n,O=betweenZeroAndOne(0|b[a+2])*n,m=betweenZeroAndOne(0|b[h+0])*t,M=betweenZeroAndOne(0|b[h+1])*t,Z=betweenZeroAndOne(0|b[h+2])*t;floatToRGBE(i*g+u*f+m*p+betweenZeroAndOne(0|b[l+0])*r*T,s*g+A*f+M*p+betweenZeroAndOne(0|b[l+1])*r*T,w*g+O*f+Z*p+betweenZeroAndOne(0|b[l+2])*r*T,c,d)}else{const e=betweenZeroAndOne(0|b[o+3]),n=betweenZeroAndOne(0|b[a+3]),t=betweenZeroAndOne(0|b[h+3]),r=betweenZeroAndOne(0|b[l+3]),i=srgbToLinear(betweenZeroAndOne(0|b[o+0]))*e,s=srgbToLinear(betweenZeroAndOne(0|b[o+1]))*e,w=srgbToLinear(betweenZeroAndOne(0|b[o+2]))*e,u=srgbToLinear(betweenZeroAndOne(0|b[a+0]))*n,A=srgbToLinear(betweenZeroAndOne(0|b[a+1]))*n,O=srgbToLinear(betweenZeroAndOne(0|b[a+2]))*n,m=srgbToLinear(betweenZeroAndOne(0|b[h+0]))*t,M=srgbToLinear(betweenZeroAndOne(0|b[h+1]))*t,Z=srgbToLinear(betweenZeroAndOne(0|b[h+2]))*t,I=i*g+u*f+m*p+srgbToLinear(betweenZeroAndOne(0|b[l+0]))*r*T,L=s*g+A*f+M*p+srgbToLinear(betweenZeroAndOne(0|b[l+1]))*r*T,x=w*g+O*f+Z*p+srgbToLinear(betweenZeroAndOne(0|b[l+2]))*r*T,E=e*g+n*f+t*p+r*T,P=1/E;c[d+3]=255*E|0,c[d+0]=255*linearToSRGB(I*P)|0,c[d+1]=255*linearToSRGB(L*P)|0,c[d+2]=255*linearToSRGB(x*P)|0}}}return t}function transformToCubeFaces(e,n,t){if(6!==n.length)throw new Error("facePixArray length must be 6!");for(let r=0;r<6;++r)transformSingleFace(e,r,n[r],t);return n}function imageGetPixels(e){if(e instanceof ImageData)return e;let n,t=e;return"CANVAS"!==t.tagName?((t=document.createElement("canvas")).width=e.width,t.height=e.height,(n=t.getContext("2d")).drawImage(e,0,0,t.width,t.height,0,0,t.width,t.height)):n=t.getContext("2d"),n.getImageData(0,0,t.width,t.height)}async function equirectToCubemapFaces(e,n,t){const r=await e.metadata(),o=await e.raw().toBuffer();let a=null;if(3===r.channels){const e=(r.width||0)*(r.height||0);a=new Uint8Array(4*e);for(let n=0;n<e;++n)a[4*n+0]=o[3*n+0],a[4*n+1]=o[3*n+1],a[4*n+2]=o[3*n+2],a[4*n+3]=255}const i={width:r.width||0,height:r.height||0,data:a?Buffer.from(a.buffer):o},s=[];for(let e=0;e<6;++e)s.push({width:n,height:n,data:new Uint8Array(n*n*4)});return t||(t=DEFAULT_OPTIONS),transformToCubeFaces(i,s,t),s}exports.equirectToCubemapFaces=equirectToCubemapFaces;