"use strict";function clamp(e,n,t){return Math.min(t,Math.max(n,e))}function srgbToLinear(e){return Math.pow(e,2.2)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.equirectToCubemapFaces=exports.InterpolationType=exports.nearestPowerOfTwo=exports.linearToSRGB=exports.srgbToLinear=void 0,exports.srgbToLinear=srgbToLinear;const i255=1/255;function betweenZeroAndOne(e){return i255*e}function linearToSRGB(e){return Math.pow(e,.454545)}exports.linearToSRGB=linearToSRGB;const ilog2=1/Math.log(2);function nearestPowerOfTwo(e){return 1<<Math.round(Math.log(e)*ilog2)}var InterpolationType;exports.nearestPowerOfTwo=nearestPowerOfTwo,function(e){e.BILINEAR="bilinear",e.NEAREST="nearest"}(InterpolationType=exports.InterpolationType||(exports.InterpolationType={}));const DEFAULT_OPTIONS={flipTheta:!1,interpolation:InterpolationType.BILINEAR,isRGBE:!1},rgbe_base=1.1;function floatToRGBE(e,n,t,r,o){const a=Math.max(Math.max(e,n),t),i=Math.ceil(Math.log(a)/Math.log(rgbe_base)),s=Math.min(Math.max(i+128,0),255),b=Math.pow(rgbe_base,s-128);r[o+0]=e/b*255|0,r[o+1]=n/b*255|0,r[o+2]=t/b*255|0,r[o+3]=s}function transformSingleFace(e,n,t,r){const o=r.flipTheta?-1:1,a=0|t.width,i=0|e.width,s=0|e.height,b=e.data,h=r.interpolation===InterpolationType.NEAREST,w=r.isRGBE,c=t.data,l=0|t.width,d=0|t.height,g=0|n,T=2/l,p=2/d;for(let e=0;e<d;++e)for(let n=0;n<l;++n){const t=T*n,r=p*e,l=n+e*a<<2;let d=0,f=0,u=0;switch(g){case 0:d=1,f=1-t,u=1-r;break;case 1:d=-1,f=t-1,u=1-r;break;case 2:d=t-1,f=r-1,u=1;break;case 3:d=t-1,f=1-r,u=-1;break;case 4:d=t-1,f=1,u=1-r;break;case 5:d=1-t,f=-1,u=1-r}const A=o*Math.atan2(f,d),O=Math.sqrt(d*d+f*f),m=Math.atan2(u,O),M=i/4*2*(A+Math.PI)/Math.PI,Z=i/4*2*(Math.PI/2-m)/Math.PI,x=0|Math.floor(M),I=0|Math.floor(Z);if(h){const e=x%i+i*clamp(I,0,s-1)<<2;c[l+0]=0|b[e+0],c[l+1]=0|b[e+1],c[l+2]=0|b[e+2],c[l+3]=0|b[e+3]}else{const e=x+1,n=I+1,t=M-x,r=Z-I,o=x%i+i*clamp(I,0,s-1)<<2,a=e%i+i*clamp(I,0,s-1)<<2,h=x%i+i*clamp(n,0,s-1)<<2,d=e%i+i*clamp(n,0,s-1)<<2,g=(1-t)*(1-r),T=t*(1-r),p=(1-t)*r,f=t*r;if(w){const e=Math.pow(rgbe_base,(0|b[o+3])-128),n=Math.pow(rgbe_base,(0|b[a+3])-128),t=Math.pow(rgbe_base,(0|b[h+3])-128),r=Math.pow(rgbe_base,(0|b[d+3])-128),i=betweenZeroAndOne(0|b[o+0])*e,s=betweenZeroAndOne(0|b[o+1])*e,w=betweenZeroAndOne(0|b[o+2])*e,u=betweenZeroAndOne(0|b[a+0])*n,A=betweenZeroAndOne(0|b[a+1])*n,O=betweenZeroAndOne(0|b[a+2])*n,m=betweenZeroAndOne(0|b[h+0])*t,M=betweenZeroAndOne(0|b[h+1])*t,Z=betweenZeroAndOne(0|b[h+2])*t;floatToRGBE(i*g+u*T+m*p+betweenZeroAndOne(0|b[d+0])*r*f,s*g+A*T+M*p+betweenZeroAndOne(0|b[d+1])*r*f,w*g+O*T+Z*p+betweenZeroAndOne(0|b[d+2])*r*f,c,l)}else{const e=betweenZeroAndOne(0|b[o+3]),n=betweenZeroAndOne(0|b[a+3]),t=betweenZeroAndOne(0|b[h+3]),r=betweenZeroAndOne(0|b[d+3]),i=srgbToLinear(betweenZeroAndOne(0|b[o+0]))*e,s=srgbToLinear(betweenZeroAndOne(0|b[o+1]))*e,w=srgbToLinear(betweenZeroAndOne(0|b[o+2]))*e,u=srgbToLinear(betweenZeroAndOne(0|b[a+0]))*n,A=srgbToLinear(betweenZeroAndOne(0|b[a+1]))*n,O=srgbToLinear(betweenZeroAndOne(0|b[a+2]))*n,m=srgbToLinear(betweenZeroAndOne(0|b[h+0]))*t,M=srgbToLinear(betweenZeroAndOne(0|b[h+1]))*t,Z=srgbToLinear(betweenZeroAndOne(0|b[h+2]))*t,x=i*g+u*T+m*p+srgbToLinear(betweenZeroAndOne(0|b[d+0]))*r*f,I=s*g+A*T+M*p+srgbToLinear(betweenZeroAndOne(0|b[d+1]))*r*f,L=w*g+O*T+Z*p+srgbToLinear(betweenZeroAndOne(0|b[d+2]))*r*f,B=e*g+n*T+t*p+r*f,R=1/B;c[l+3]=255*B|0,c[l+0]=255*linearToSRGB(x*R)|0,c[l+1]=255*linearToSRGB(I*R)|0,c[l+2]=255*linearToSRGB(L*R)|0}}}return t}function transformToCubeFaces(e,n,t){if(6!==n.length)throw new Error("facePixArray length must be 6!");for(let r=0;r<6;++r)transformSingleFace(e,r,n[r],t);return n}function imageGetPixels(e){if(e instanceof ImageData)return e;let n,t=e;return"CANVAS"!==t.tagName?((t=document.createElement("canvas")).width=e.width,t.height=e.height,(n=t.getContext("2d")).drawImage(e,0,0,t.width,t.height,0,0,t.width,t.height)):n=t.getContext("2d"),n.getImageData(0,0,t.width,t.height)}async function equirectToCubemapFaces(e,n,t){const r=await e.metadata(),o=await e.raw().toBuffer();let a=null;if(3===r.channels){const e=(r.width||0)*(r.height||0);a=new Uint8Array(4*e);for(let n=0;n<e;++n)a[4*n+0]=o[3*n+0],a[4*n+1]=o[3*n+1],a[4*n+2]=o[3*n+2],a[4*n+3]=255}const i={width:r.width||0,height:r.height||0,data:a?Buffer.from(a.buffer):o},s=[];for(let e=0;e<6;++e)s.push({width:n,height:n,data:new Uint8Array(n*n*4)});return t||(t=DEFAULT_OPTIONS),transformToCubeFaces(i,s,t),s}exports.equirectToCubemapFaces=equirectToCubemapFaces;