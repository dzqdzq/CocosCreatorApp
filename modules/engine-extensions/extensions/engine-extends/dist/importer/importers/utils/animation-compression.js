"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressAnimationClip=void 0;const cc_1=require("cc"),{approx:approx}=cc_1.math;function compressAnimationClip(e){for(const r of e.tracks)for(const{curve:e}of r.channels())e instanceof cc_1.RealCurve&&compressRealCurve(e)}function compressRealCurve(e){if(e.keyFramesCount<2)return;if(!Array.from(e.values()).every(({interpolationMode:e})=>e===cc_1.RealInterpolationMode.LINEAR))return;const r=compress(Array.from(e.times()),Array.from(e.values()).map(({value:e})=>e),[{type:"remove-linear-keys",maxDiff:1e-4},{type:"remove-trivial-keys",maxDiff:1e-4}]);e.assignSorted(r.times,r.values)}function compress(e,r,s){for(const o of s)switch(o.type){case"remove-linear-keys":({keys:e,values:r}=removeLinearKeys(e,r,o.maxDiff));break;case"remove-trivial-keys":({keys:e,values:r}=removeTrivialKeys(e,r,o.maxDiff))}return{times:e,values:r}}function removeLinearKeys(e,r,s=.001){const o=e.length;if(o<3)return{keys:e.slice(),values:r.slice()};const t=new Array(o).fill(!1),i=o-1;for(let o=1;o<i;++o){const i=o-1,n=o+1,{[i]:a,[o]:l,[n]:c}=e,{[i]:f,[o]:m,[n]:u}=r;approx((u-f)*((l-a)/(c-a))+f,m,s)&&(t[o]=!0)}return filterFromRemoveFlags(e,r,t)}function removeTrivialKeys(e,r,s=.001){const o=e.length;if(o<2)return{keys:e.slice(),values:r.slice()};const t=new Array(o).fill(!1);for(let e=1;e<o;++e){const o=e-1,{[o]:i,[e]:n}=r;approx(i,n,s)&&(t[e]=!0)}return filterFromRemoveFlags(e,r,t)}function filterFromRemoveFlags(e,r,s){const o=e.length,t=s.reduce((e,r)=>r?e+1:e,0);if(!t)return{keys:e.slice(),values:r.slice()};const i=o-t,n=new Array(i).fill(0),a=new Array(i).fill(0);for(let t=0,i=0;i<o;++i)s[i]||(n[t]=e[i],a[t]=r[i],++t);return{keys:n,values:a}}exports.compressAnimationClip=compressAnimationClip;