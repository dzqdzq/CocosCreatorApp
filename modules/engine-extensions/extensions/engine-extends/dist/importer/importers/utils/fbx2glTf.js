"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convert=void 0;const child_process_1=__importDefault(require("child_process")),fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),utils_1=require("../../utils");function convert(e,t,r=[]){return new Promise((s,a)=>{try{const o=path_1.default.dirname(require.resolve("@cocos/fbx2gltf")),n="Windows_NT"===os_1.default.type()?".exe":"";let i=path_1.default.join(o,"bin",os_1.default.type(),"FBX2glTF"+n);const l=i.replace("app.asar","app.asar.unpacked");if(fs_extra_1.default.existsSync(l)&&(i=l),!fs_extra_1.default.existsSync(i))throw new Error(`Unsupported OS: ${os_1.default.type()}`);let u="";if(t.endsWith(".glb"))u=".glb",r.includes("--binary")||r.push("--binary");else{if(!t.endsWith(".gltf"))throw new Error(`Unsupported file extension: ${t}`);u=".gltf"}0!==u.length&&fs_extra_1.default.ensureDirSync(path_1.default.dirname(t));const _=fs_extra_1.default.realpathSync(e),f=path_1.default.dirname(_),d=t,p=path_1.default.basename(_),c=r.slice(0);c.push("--input",p,"--output",d);const h=child_process_1.default.spawn(i,c,{cwd:f});let x="";h.stdout&&h.stdout.on("data",e=>x+=e),h.stderr&&h.stderr.on("data",e=>x+=e),h.on("error",a),h.on("close",e=>{const t=_.replace(/.fbx$/i,".fbm"),r=e=>e&&console.warn(`Failed to delete ${t}: ${e}`);try{fs_extra_1.default.existsSync(t)&&(0,rimraf_1.default)(t,{},r)}catch(e){r(e)}0!==e?a(new Error((0,utils_1.i18nTranslate)("asset-db.importers.fbx.fbx2glTF_exists_with_non_zero_code",{code:e,output:x.length?x:"<none>"}))):s(d)})}catch(e){a(e)}})}exports.convert=convert;