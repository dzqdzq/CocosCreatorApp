"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.splitAnimation=void 0;const cc_1=require("cc"),exotic_animation_1=require("cc/editor/exotic-animation"),curve_utils_1=require("./curve-utils");function splitAnimation(e,n,t){const a=new cc_1.AnimationClip;a.duration=t-n,a.enableTrsBlending=e.enableTrsBlending;for(const i of e.tracks){const e=cloneTrackWithoutChannels(i),o=Array.from(i.channels()),r=Array.from(e.channels());o.forEach(({name:e,curve:a},i)=>{r[i].name=e;const o=r[i].curve;if(a instanceof cc_1.RealCurve)splitRealCurve(a,n,t,o);else{if(!(a instanceof cc_1.QuatCurve))throw new Error("Unknown curve type.");splitQuaternionCurve(a,n,t,o)}}),a.addTrack(i)}const i=e[exotic_animation_1.exoticAnimationTag];return i&&(a[exotic_animation_1.exoticAnimationTag]=i.split(n,t)),a}function cloneTrackWithoutChannels(e){switch(!0){default:throw new Error("Unknown track type.");case e instanceof cc_1.animation.RealTrack:return new cc_1.animation.RealTrack;case e instanceof cc_1.animation.QuatTrack:return new cc_1.animation.QuatTrack;case e instanceof cc_1.animation.ObjectTrack:return new cc_1.animation.ObjectTrack;case e instanceof cc_1.animation.VectorTrack:{const n=new cc_1.animation.VectorTrack;return n.componentsCount=e.componentsCount,n}case e instanceof cc_1.animation.ColorTrack:return new cc_1.animation.ColorTrack;case e instanceof exotic_animation_1.RealArrayTrack:{const n=new exotic_animation_1.RealArrayTrack;return n.elementCount=e.elementCount,n}}}function splitRealCurve(e,n,t,a){const i=e.indexOfKeyframe(n),o=e.indexOfKeyframe(t),r=i,c=o,l=[...e.keyframes()].slice(r,c);if(r!==i){const{value:t,tangent:a}=evaluateBetweenKeyframes(e,i,r,n);l.unshift([n,{value:t,interpolationMode:e.getKeyframeValue(i).interpolationMode,rightTangent:a.y,rightTangentWeight:a.x}])}if(c!==o){const{value:n,tangent:a}=evaluateBetweenKeyframes(e,c,o,t);l.unshift([t,{value:n,interpolationMode:e.getKeyframeValue(o).interpolationMode,leftTangent:a.y,leftTangentWeight:a.x}])}a.assignSorted(l),a.preExtrapolation=e.preExtrapolation,a.postExtrapolation=e.postExtrapolation}function splitQuaternionCurve(e,n,t,a){const i=e.indexOfKeyframe(n),o=e.indexOfKeyframe(t),r=i,c=o,l=[...e.keyframes()].slice(r,c);if(r!==i&&i>=0){const t=e.evaluate(n);l.unshift([n,{value:t,interpolationMode:e.getKeyframeValue(i).interpolationMode,easingMethod:e.getKeyframeValue(i).easingMethod}])}if(c!==o&&o>=0){const n=e.evaluate(t);l.unshift([t,{value:n,interpolationMode:e.getKeyframeValue(o).interpolationMode,easingMethod:e.getKeyframeValue(o).easingMethod}])}a.assignSorted(l)}function evaluateBetweenKeyframes(e,n,t,a){const i=e.getKeyframeTime(n),{value:o,rightTangent:r,rightTangentWeight:c}=e.getKeyframeValue(n),l=e.getKeyframeTime(t),{value:s,leftTangent:u,leftTangentWeight:f}=e.getKeyframeValue(t);return(0,curve_utils_1.evaluateValueTangent)(a,i,o,c,r,l,s,f,u)}exports.splitAnimation=splitAnimation;