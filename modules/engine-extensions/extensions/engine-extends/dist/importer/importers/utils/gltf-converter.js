"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTfConformanceError=exports.isDataUri=exports.readGltf=exports.GltfConverter=exports.doCreateSocket=exports.getWorldTransformUntilRoot=exports.getPathFromRoot=exports.isFilesystemPath=void 0;const DataURI=__importStar(require("@cocos/data-uri")),cc=__importStar(require("cc")),cc_1=require("cc"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),glTF_meta_1=require("../../meta-schemas/glTF.meta"),texture_base_1=require("../texture-base"),base64_1=require("./base64"),glTF_constants_1=require("./glTF.constants"),khr_draco_mesh_compression_1=require("./khr-draco-mesh-compression"),pp_geometry_1=require("./pp-geometry"),extras_1=require("@editor/fbx-gltf-conv/lib/extras"),exotic_animation_1=require("cc/editor/exotic-animation"),glTF_animation_utils_1=require("./glTF-animation-utils"),color_utils_1=require("cc/editor/color-utils");function isFilesystemPath(e){return!e.isDataUri}function getPathFromRoot(e,t){let r=e,n="";for(;null!==r&&r!==t;)n=`${r.name}/${n}`,r=r.parent;return n.slice(0,-1)}function getWorldTransformUntilRoot(e,t,r,n,s){for(cc_1.Vec3.set(r,0,0,0),cc_1.Quat.set(n,0,0,0,1),cc_1.Vec3.set(s,1,1,1);e!==t;)cc_1.Vec3.multiply(r,r,e.scale),cc_1.Vec3.transformQuat(r,r,e.rotation),cc_1.Vec3.add(r,r,e.position),cc_1.Quat.multiply(n,e.rotation,n),cc_1.Vec3.multiply(s,e.scale,s),e=e.parent}var GltfAssetKind;exports.isFilesystemPath=isFilesystemPath,exports.getPathFromRoot=getPathFromRoot,exports.getWorldTransformUntilRoot=getWorldTransformUntilRoot,function(e){e[e.Node=0]="Node",e[e.Mesh=1]="Mesh",e[e.Texture=2]="Texture",e[e.Skin=3]="Skin",e[e.Animation=4]="Animation",e[e.Image=5]="Image",e[e.Material=6]="Material",e[e.Scene=7]="Scene"}(GltfAssetKind||(GltfAssetKind={}));const qt=new cc_1.Quat,v3a=new cc_1.Vec3,v3b=new cc_1.Vec3,v3Min=new cc_1.Vec3,v3Max=new cc_1.Vec3;function doCreateSocket(e,t,r){const n=getPathFromRoot(r.parent,e);if(r.parent===e)return;let s=t.find(e=>e.path===n);if(!s){const o=new cc.Node;o.name=`${r.parent.name} Socket`,o.parent=e,getWorldTransformUntilRoot(r.parent,e,v3a,qt,v3b),o.setPosition(v3a),o.setRotation(qt),o.setScale(v3b),s=new cc.SkeletalAnimation.Socket(n,o),t.push(s)}r.parent=s.target}exports.doCreateSocket=doCreateSocket;const skinRootNotCalculated=-2,skinRootAbsent=-1,supportedExtensions=new Set(["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_materials_unlit","KHR_texture_transform"]);class GltfConverter{constructor(e,t,r,n){var s,o,i,a,l;this._gltf=e,this._buffers=t,this._gltfFilePath=r,this._promotedRootNodes=[],this._parents=[],this._skinRoots=[],this._processedMeshes=[],this._socketMappings=new Map,n=n||{},this._logger=n.logger||GltfConverter._defaultLogger,null===(s=this._gltf.extensionsRequired)||void 0===s||s.forEach(e=>this._warnIfExtensionNotSupported(e,!0)),null===(o=this._gltf.extensionsUsed)||void 0===o||o.forEach(e=>{var t;(null===(t=this._gltf.extensionsRequired)||void 0===t?void 0:t.includes(e))||this._warnIfExtensionNotSupported(e,!1)}),n.promoteSingleRootNode&&this._promoteSingleRootNodes(),void 0!==this._gltf.nodes&&(this._parents=new Array(this._gltf.nodes.length).fill(-1),this._gltf.nodes.forEach((e,t)=>{if(void 0!==e.children)for(const r of e.children)this._parents[r]=t})),this._gltf.skins&&(this._skinRoots=new Array(this._gltf.skins.length).fill(skinRootNotCalculated)),this._nodePathTable=this._createNodePathTable();const c=n.userData||{};if(this._gltf.meshes){const e=null!==(i=c.normals)&&void 0!==i?i:glTF_meta_1.NormalImportSetting.require,t=null!==(a=c.tangents)&&void 0!==a?a:glTF_meta_1.TangentImportSetting.require,r=null!==(l=c.morphNormals)&&void 0!==l?l:glTF_meta_1.NormalImportSetting.exclude;for(let n=0;n<this._gltf.meshes.length;n++){const s=this._gltf.meshes[n],o=new cc_1.Vec3(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new cc_1.Vec3(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),{geometries:a,materialIndices:l,jointMaps:u}=pp_geometry_1.PPGeometry.skinningProcess(s.primitives.map((s,a)=>{const l=this._readPrimitive(s,n,a);return l.reduceJointInfluences(),this._applySettings(l,e,t,r,a,n),this._readBounds(s,v3Min,v3Max),cc_1.Vec3.min(o,o,v3Min),cc_1.Vec3.max(i,i,v3Max),l.sanityCheck(),l}),!1!==c.disableMeshSplit);this._processedMeshes.push({geometries:a,materialIndices:l,jointMaps:u,minPosition:o,maxPosition:i})}}if(this._gltf.nodes&&this._gltf.skins){const e=this._gltf.nodes,t=[];for(let r=0;r<e.length;r++){const n=e[r];void 0!==n.mesh&&void 0===n.skin&&t.push(r)}for(let e=0;e<t.length;e++){const r=t[e];t.some(e=>this._isAncestorOf(e,r))&&(t[e]=t[t.length-1],t.length--,e--)}for(let r=0;r<t.length;r++){const n=t[r],s=e[this._getParent(n)];s&&this._socketMappings.set(this._getNodePath(n),s.name+" Socket/"+e[n].name)}}}get gltf(){return this._gltf}get path(){return this._gltfFilePath}get processedMeshes(){return this._processedMeshes}createMesh(e,t=!1){const r=this._processedMeshes[e],n=this._gltf.meshes[e],s=new BufferBlob,o=new Array,i={primitives:r.geometries.map((e,r)=>{const{vertexCount:n,vertexStride:i,formats:a,vertexBuffer:l}=interleaveVertices(e,t);s.setNextAlignment(0),o.push({view:{offset:s.getLength(),length:l.byteLength,count:n,stride:i},attributes:a}),s.addBuffer(l);const c={primitiveMode:e.primitiveMode,jointMapIndex:e.jointMapIndex,vertexBundelIndices:[r]};if(void 0!==e.indices){const t=e.indices;s.setNextAlignment(t.BYTES_PER_ELEMENT),c.indexView={offset:s.getLength(),length:t.byteLength,count:t.length,stride:t.BYTES_PER_ELEMENT},s.addBuffer(t.buffer)}return c}),vertexBundles:o,minPosition:r.minPosition,maxPosition:r.maxPosition,jointMaps:r.jointMaps};{const e=r.geometries.map(e=>{let t=0;const r=[];if(e.forEachAttribute(e=>{if(e.morphs){if(0===t)t=e.morphs.length;else if(t!==e.morphs.length)throw new Error("Bad morph...");r.push(e)}}),0===t)return null;const n=new Array(t);for(let e=0;e<t;++e)n[e]={displacements:r.map(t=>{const r=t.morphs[e];s.setNextAlignment(r.BYTES_PER_ELEMENT);const n=s.getLength();return s.addBuffer(r.buffer),{offset:n,length:r.byteLength,stride:r.BYTES_PER_ELEMENT,count:r.length}})};return{attributes:r.map(e=>pp_geometry_1.getGfxAttributeName(e)),targets:n}}),t=e.find(e=>null!==e);if(t&&(assertGlTFConformance(e.every(e=>!e||e.targets.length===t.targets.length),"glTF expects that every primitive has same number of targets"),0!==e.length&&assertGlTFConformance(void 0===n.weights||n.weights.length===t.targets.length,'Number of "weights" mismatch number of morph targets'),i.morph={subMeshMorphs:e,weights:n.weights},"object"==typeof n.extras&&Array.isArray(n.extras.targetNames))){const e=n.extras.targetNames;e.length===t.targets.length&&e.every(e=>"string"==typeof e)&&(i.morph.targetNames=e.slice())}}const a=new cc.Mesh;return a.name=this._getGltfXXName(GltfAssetKind.Mesh,e),a.assign(i,s.getCombined()),a.hash,a}createSkeleton(e,t){const r=this._gltf.skins[e],n=new cc.Skeleton;if(n.name=this._getGltfXXName(GltfAssetKind.Skin,e),n._joints=r.joints.map(e=>this._mapToSocketPath(this._getNodePath(e))),void 0!==r.inverseBindMatrices){const e=this._gltf.accessors[r.inverseBindMatrices];if(e.componentType!==WebGLRenderingContext.FLOAT||"MAT4"!==e.type)throw new Error("The inverse bind matrix should be floating-point 4x4 matrix.");const t=new Array(r.joints.length),s=new Float32Array(16*t.length);this._readAccessor(e,createDataViewFromTypedArray(s)),assertGlTFConformance(s.length===16*t.length,"Wrong data in bind-poses accessor.");for(let e=0;e<t.length;++e)t[e]=new cc_1.Mat4(s[16*e+0],s[16*e+1],s[16*e+2],s[16*e+3],s[16*e+4],s[16*e+5],s[16*e+6],s[16*e+7],s[16*e+8],s[16*e+9],s[16*e+10],s[16*e+11],s[16*e+12],s[16*e+13],s[16*e+14],s[16*e+15]);n._bindposes=t}return n.hash,n}getAnimationDuration(e){const t=this._gltf.animations[e];let r=0;return t.channels.forEach(e=>{if(void 0===e.target.node)return;const n=t.samplers[e.sampler],s=this._gltf.accessors[n.input],o=void 0!==s.max&&1===s.max.length?Math.fround(s.max[0]):0;r=Math.max(o,r)}),r}createAnimation(e){const t=this._gltf.animations[e],r=new glTF_animation_utils_1.GlTFTrsAnimationData,n=e=>{const t=this._mapToSocketPath(this._getNodePath(e));return r.addNodeAnimation(t)};let s=0;const o=new Array,i=new Map,a=e=>{let t=i.get(e);if(void 0===t){const r=this._gltf.accessors[e],n=this._readAccessorIntoArray(r);t=o.length,o.push(n),i.set(e,t)}return t},l=[];if(t.channels.forEach(e=>{const r=e.target.node;if(void 0===r)return;const i=n(r),c=t.samplers[e.sampler],u=a(c.input);"weights"===e.target.path?l.push(...this._glTFWeightChannelToTracks(t,e,o[u])):this._gltfChannelToCurveData(t,e,i,o[u]);const _=this._gltf.accessors[c.input],f=void 0!==_.max&&1===_.max.length?Math.fround(_.max[0]):0;s=Math.max(f,s)}),this._gltf.nodes){new Float32Array([0]);const e=new cc_1.Quat,t=new cc_1.Vec3,r=new cc_1.Vec3;this._gltf.nodes.forEach((s,o)=>{if(this._promotedRootNodes.includes(o))return;const i=n(o);let a;if(s.matrix&&(a=this._readNodeMatrix(s.matrix),cc_1.Mat4.toRTS(a,e,t,r)),!i.position){const e=new cc_1.Vec3;s.translation?cc_1.Vec3.set(e,s.translation[0],s.translation[1],s.translation[2]):a&&cc_1.Vec3.copy(e,t),i.setConstantPosition(e)}if(!i.scale){const e=new cc_1.Vec3(1,1,1);s.scale?cc_1.Vec3.set(e,s.scale[0],s.scale[1],s.scale[2]):a&&cc_1.Vec3.copy(e,r),i.setConstantScale(e)}if(!i.rotation){const t=new cc_1.Quat;s.rotation?this._getNodeRotation(s.rotation,t):a&&cc_1.Quat.copy(t,e),i.setConstantRotation(t)}})}const c=r.createExotic(),u=new cc.AnimationClip;return u.name=this._getGltfXXName(GltfAssetKind.Animation,e),u.wrapMode=cc.AnimationClip.WrapMode.Loop,u.duration=s,u.sample=30,u.hash,u.enableTrsBlending=!0,l.forEach(e=>u.addTrack(e)),u[exotic_animation_1.exoticAnimationTag]=c,u}createMaterial(e,t,r,n){var s,o,i,a;const l=null===(s=n.useVertexColors)||void 0===s||s,c=null!==(o=n.depthWriteInAlphaModeBlend)&&void 0!==o&&o,u=null!==(i=n.smartMaterialEnabled)&&void 0!==i&&i,_=this._gltf.materials[e],f=void 0!==(_.extensions&&_.extensions.KHR_materials_unlit),d=this._gltf.extras;if(u){let n="";if("object"==typeof d&&d&&"FBX-glTF-conv"in d){const s=d["FBX-glTF-conv"];if(void 0!==s.fbxFileHeaderInfo){void 0!==s.fbxFileHeaderInfo.sceneInfo&&(n=s.fbxFileHeaderInfo.sceneInfo.original.applicationName);const o=/Blender/g,i=/Maya/g,a=/Max/g,l=/Cinema/g,c=/mixamo/g,u=_.extras["FBX-glTF-conv"].raw;if(o.test(n)||c.test(n)){if("phong"===u.type)return this._convertBlenderPBRMaterial(_,e,t,r)}else if(i.test(n)){if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,5,u.properties);if(u.properties.Maya&&1398031443===u.properties.Maya.value.TypeId.value)return this._convertMayaStandardSurface(e,t,r,u.properties.Maya.value)}else if(a.test(n)){if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,1,u.properties);if(u.properties["3dsMax"].value.ORIGINAL_MTL&&"PHYSICAL_MTL"===u.properties["3dsMax"].value.ORIGINAL_MTL.value)return this._convertMaxPhysicalMaterial(e,t,r,u.properties["3dsMax"].value.Parameters.value)}else if(l.test(n)){if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,3,u.properties)}else if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,0,u.properties)}else console.debug("Failed to read fbx header info, default material was used")}else console.debug("Failed to read fbx info.")}else{const n=(()=>{if(!extras_1.hasOriginalMaterialExtras(_.extras))return null;const{originalMaterial:n}=_.extras["FBX-glTF-conv"];return extras_1.isAdsk3dsMaxPhysicalMaterial(n)?this._convertAdskPhysicalMaterial(_,e,t,r,n):null})();if(n)return n}const m=new cc.Material;m.name=this._getGltfXXName(GltfAssetKind.Material,e),m._effectAsset=r(`db://internal/effects/${f?"builtin-unlit":"legacy/standard"}.effect`);const p={},h={},g={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}};if(this._gltf.meshes)for(let t=0;t<this._gltf.meshes.length;t++){const r=this._gltf.meshes[t];for(let t=0;t<r.primitives.length;t++){const n=r.primitives[t];n.material===e&&(n.attributes.COLOR_0&&l&&(p.USE_VERTEX_COLOR=!0),n.attributes.TEXCOORD_1&&(p.HAS_SECOND_UV=!0))}}let T=!1;if(_.pbrMetallicRoughness){const e=_.pbrMetallicRoughness;if(void 0!==e.baseColorTexture&&(T=!0,p[f?"USE_TEXTURE":"USE_ALBEDO_MAP"]=!0,e.baseColorTexture.texCoord&&(p.ALBEDO_UV="v_uv1"),h.mainTexture=t.find("textures",e.baseColorTexture.index,cc.Texture2D),void 0!==e.baseColorTexture.extensions&&e.baseColorTexture.extensions.KHR_texture_transform&&(h.tilingOffset=this._khrTextureTransformToTiling(e.baseColorTexture.extensions.KHR_texture_transform))),e.baseColorFactor){T=!0;const t=e.baseColorFactor;f?h.mainColor=new cc_1.Vec4(t[0],t[1],t[2],1):h.albedoScale=new cc_1.Vec3(t[0],t[1],t[2])}void 0!==e.metallicRoughnessTexture&&(T=!0,p.USE_METALLIC_ROUGHNESS_MAP=!0,h.metallicRoughnessMap=t.find("textures",e.metallicRoughnessTexture.index,cc.Texture2D),h.metallic=1,h.roughness=1),void 0!==e.metallicFactor&&(T=!0,h.metallic=e.metallicFactor),void 0!==e.roughnessFactor&&(T=!0,h.roughness=e.roughnessFactor)}if(!T&&(null===(a=_.extensions)||void 0===a?void 0:a.KHR_materials_pbrSpecularGlossiness))return this._convertGltfPbrSpecularGlossiness(_,e,t,r,c);if(void 0!==_.normalTexture){const e=_.normalTexture;void 0!==e.index&&(p.USE_NORMAL_MAP=!0,h.normalMap=t.find("textures",e.index,cc.Texture2D),void 0!==e.scale&&(h.normalStrenth=e.scale))}if(_.occlusionTexture){const e=_.occlusionTexture;void 0!==e.index&&(p.USE_OCCLUSION_MAP=!0,h.occlusionMap=t.find("textures",e.index,cc.Texture2D),void 0!==e.strength&&(h.occlusion=e.strength))}if(void 0!==_.emissiveTexture&&(p.USE_EMISSIVE_MAP=!0,_.emissiveTexture.texCoord&&(p.EMISSIVE_UV="v_uv1"),h.emissiveMap=t.find("textures",_.emissiveTexture.index,cc.Texture2D)),void 0!==_.emissiveFactor){const e=_.emissiveFactor;h.emissive=this._normalizeArrayToCocosColor(e)[1]}switch(_.doubleSided&&(g.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),_.alphaMode){case"BLEND":{const e=g.blendState.targets[0];e.blend=!0,e.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,e.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,e.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,g.depthStencilState.depthWrite=c;break}case"MASK":{const e=void 0===_.alphaCutoff?.5:_.alphaCutoff;p.USE_ALPHA_TEST=!0,h.alphaThreshold=e;break}case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:_.alphaMode,material:e})}return m._defines=[p],m._props=[h],m._states=[g],m}getTextureParameters(e,t){const r=t=>{switch(void 0===t&&(t=glTF_constants_1.GltfWrapMode.__DEFAULT),t){case glTF_constants_1.GltfWrapMode.CLAMP_TO_EDGE:return"clamp-to-edge";case glTF_constants_1.GltfWrapMode.MIRRORED_REPEAT:return"mirrored-repeat";case glTF_constants_1.GltfWrapMode.REPEAT:return"repeat";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"wrapMode",value:t,fallback:glTF_constants_1.GltfWrapMode.REPEAT,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),"repeat"}},n=t=>{switch(t){case glTF_constants_1.GltfTextureMagFilter.NEAREST:return"nearest";case glTF_constants_1.GltfTextureMagFilter.LINEAR:return"linear";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"magFilter",value:t,fallback:glTF_constants_1.GltfTextureMagFilter.LINEAR,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),"linear"}},s=t=>{switch(t){case glTF_constants_1.GltfTextureMinFilter.NEAREST:return["nearest","none"];case glTF_constants_1.GltfTextureMinFilter.LINEAR:return["linear","none"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_NEAREST:return["nearest","nearest"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_NEAREST:return["linear","nearest"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_LINEAR:return["nearest","linear"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_LINEAR:return["linear","linear"];default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"minFilter",value:t,fallback:glTF_constants_1.GltfTextureMinFilter.LINEAR,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),["linear","none"]}};if(void 0===e.sampler)t.wrapModeS="repeat",t.wrapModeT="repeat";else{const o=this._gltf.samplers[e.sampler];if(t.wrapModeS=r(o.wrapS),t.wrapModeT=r(o.wrapT),t.magfilter=void 0===o.magFilter?texture_base_1.defaultMagFilter:n(o.magFilter),t.minfilter=texture_base_1.defaultMinFilter,void 0!==o.minFilter){const[e,r]=s(o.minFilter);t.minfilter=e,t.mipfilter=r}}}createScene(e,t,r=!0){const n=this._getSceneNode(e,t,r);return n.getComponentsInChildren(cc.SkinnedMeshRenderer).forEach(e=>e.skinningRoot=n),n}createSockets(e){const t=[];for(const r of this._socketMappings){doCreateSocket(e,t,e.getChildByPath(r[0]))}return t}readImageInBufferView(e){return this._readBufferView(e)}_warnIfExtensionNotSupported(e,t){supportedExtensions.has(e)||this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedExtension,{name:e,required:t})}_promoteSingleRootNodes(){if(void 0!==this._gltf.nodes&&void 0!==this._gltf.scenes)for(const e of this._gltf.scenes)if(void 0!==e.nodes&&1===e.nodes.length){const t=e.nodes[0];if(this._gltf.skins&&this._gltf.skins.some(e=>e.joints.includes(t)))continue;if(this._gltf.animations&&this._gltf.animations.some(e=>e.channels.some(e=>e.target.node===t)))continue;this._promotedRootNodes.push(t)}}_getNodeRotation(e,t){return cc_1.Quat.set(t,e[0],e[1],e[2],e[3]),cc_1.Quat.normalize(t,t),t}_gltfChannelToCurveData(e,t,r,n){var s;let o;if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.translation)o="position";else if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.rotation)o="rotation";else{if(t.target.path!==glTF_constants_1.GltfAnimationChannelTargetPath.scale)return void this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.UnsupportedChannelPath,{channel:e.channels.indexOf(t),animation:this._gltf.animations.indexOf(e),path:t.target.path});o="scale"}const i=e.samplers[t.sampler],a=null!==(s=i.interpolation)&&void 0!==s?s:glTF_constants_1.GlTfAnimationInterpolation.LINEAR;switch(a){case glTF_constants_1.GlTfAnimationInterpolation.STEP:case glTF_constants_1.GlTfAnimationInterpolation.LINEAR:case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:break;default:return}const l=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[i.output]);r[o]=new glTF_animation_utils_1.GlTFTrsTrackData(a,n,l)}_glTFWeightChannelToTracks(e,t,r){const n=e.samplers[t.sampler],s=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[n.output]),o=this._gltf.nodes[t.target.node],i=this._processedMeshes[o.mesh],a=new Array,l=i.geometries.length;let c=0;for(let e=0;e<l;++e){const t=i.geometries[e];if(!t.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.position))continue;const{morphs:r}=t.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.position);if(r){c=r.length;break}}if(0===c)return console.debug(`Morph animation in ${e.name} on node ${this._gltf.nodes[t.target.node]}`+"is going to be ignored due to lack of morph information in mesh."),[];const u=new exotic_animation_1.RealArrayTrack;a.push(u),u.path=(new cc.animation.TrackPath).toHierarchy(this._mapToSocketPath(this._getNodePath(t.target.node))).toComponent(cc.js.getClassName(cc.MeshRenderer)),u.proxy=new cc.animation.MorphWeightsAllValueProxy,u.elementCount=c;for(let e=0;e<c;++e){const{curve:t}=u.channels()[e],n=Array.from({length:r.length},(t,r)=>{return{value:s[c*r+e],interpolationMode:cc.RealInterpolationMode.LINEAR}});t.assignSorted(Array.from(r),n)}return a}_getParent(e){return this._parents[e]}_getRootParent(e){for(let t=e;t>=0;t=this._getParent(e))e=t;return e}_commonRoot(e){let t=1/0;const r=e.map(e=>{const r=[];let n=e;for(;n>=0;)r.unshift(n),n=this._getParent(n);return t=Math.min(t,r.length),r});if(0===r.length)return-1;const n=[];for(let e=0;e<t;++e){const t=r[0][e];if(!r.every(r=>r[e]===t))break;n.push(t)}return 0===n.length?-1:n[n.length-1]}_getSkinRoot(e){let t=this._skinRoots[e];return t===skinRootNotCalculated&&(t=this._commonRoot(this._gltf.skins[e].joints),this._skinRoots[e]=t),t}_readPrimitive(e,t,r){let n=null;if(e.extensions)for(const t of Object.keys(e.extensions)){const r=e.extensions[t];switch(t){case"KHR_draco_mesh_compression":n=this._decodeDracoGeometry(e,r)}}const s=this._getPrimitiveMode(void 0===e.mode?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:e.mode);let o;if(void 0!==e.indices){let t;if(n&&n.indices)t=n.indices;else{const r=this._gltf.accessors[e.indices];t=this._readAccessorIntoArray(r)}o=t}if(!("POSITION"in e.attributes))throw new Error("The primitive doesn't contains positions.");const i=n?n.vertices.POSITION.length/3:this._gltf.accessors[e.attributes.POSITION].count,a=new pp_geometry_1.PPGeometry(i,s,o);for(const t of Object.getOwnPropertyNames(e.attributes)){const r=this._gltf.accessors[e.attributes[t]];let s;if(n&&t in n.vertices){s=n.vertices[t]}else{s=this._readAccessorIntoArray(r)}const o=glTFAttributeNameToPP(t),i=this._getComponentsPerAttribute(r.type);a.setAttribute(o,s,i)}if(e.targets){const n=Object.getOwnPropertyNames(e.targets[0]);for(const t of n){const r=glTFAttributeNameToPP(t);if(!pp_geometry_1.PPGeometry.isStdSemantic(r)||![pp_geometry_1.PPGeometry.StdSemantics.position,pp_geometry_1.PPGeometry.StdSemantics.normal,pp_geometry_1.PPGeometry.StdSemantics.tangent].includes(r))throw new Error(`Only position, normal, tangent attribute are morph-able, but provide ${t}`);assertGlTFConformance(a.hasAttribute(r),`Primitive do not have attribute ${t} for morph.`);const n=a.getAttribute(r);n.morphs=new Array(e.targets.length);for(let r=0;r<e.targets.length;++r){const s=e.targets[r];assertGlTFConformance(t in s,"Morph attributes in all target must be same.");const o=this._gltf.accessors[s[t]],i=this._readAccessorIntoArray(o);n.morphs[r]=i}}let s=!1;a.forEachAttribute(e=>{!s&&e.morphs&&e.morphs.some(e=>e.some(e=>0!==e))&&(s=!0)}),s||this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.EmptyMorph,{mesh:t,primitive:r})}return a}_decodeDracoGeometry(e,t){const r=this._gltf.bufferViews[t.bufferView],n=this._buffers[r.buffer],s=void 0===r.byteOffset?0:r.byteOffset,o=n.slice(s,s+r.byteLength),i={buffer:new Int8Array(o),attributes:{}};void 0!==e.indices&&(i.indices=this._getAttributeBaseTypeStorage(this._gltf.accessors[e.indices].componentType));for(const r of Object.keys(t.attributes))if(r in e.attributes){const n=this._gltf.accessors[e.attributes[r]];i.attributes[r]={uniqueId:t.attributes[r],storageConstructor:this._getAttributeBaseTypeStorage(n.componentType),components:this._getComponentsPerAttribute(n.type)}}return khr_draco_mesh_compression_1.decodeDracoGeometry(i)}_readBounds(e,t,r){const n=e.attributes.POSITION;if(void 0!==n){const e=this._gltf.accessors[n];e.min&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(t.x=Math.fround(e.min[0]),t.y=Math.fround(e.min[1]),t.z=Math.fround(e.min[2])):(t.x=e.min[0],t.y=e.min[1],t.z=e.min[2])),e.max&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(r.x=Math.fround(e.max[0]),r.y=Math.fround(e.max[1]),r.z=Math.fround(e.max[2])):(r.x=e.max[0],r.y=e.max[1],r.z=e.max[2]))}}_applySettings(e,t,r,n,s,o){if(t===glTF_meta_1.NormalImportSetting.recalculate||t===glTF_meta_1.NormalImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)){const t=e.calculateNormals();e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal,t,3)}else t===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal);if(r===glTF_meta_1.TangentImportSetting.recalculate||r===glTF_meta_1.TangentImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent))if(e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal))if(e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord)){const t=e.calculateTangents();e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent,t,4)}else this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"uv",primitive:s,mesh:o});else this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"normal",primitive:s,mesh:o});else r===glTF_meta_1.TangentImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent);if(n===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)){e.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal).morphs=null}}_readBufferView(e){const t=this._buffers[e.buffer];return Buffer.from(t.buffer,t.byteOffset+(e.byteOffset||0),e.byteLength)}_readAccessorIntoArray(e){const t=new(this._getAttributeBaseTypeStorage(e.componentType))(e.count*this._getComponentsPerAttribute(e.type));return this._readAccessor(e,createDataViewFromTypedArray(t)),void 0!==e.sparse&&this._applyDeviation(e,t),t}_readAccessorIntoArrayAndNormalizeAsFloat(e){let t=this._readAccessorIntoArray(e);if(!(t instanceof Float32Array)){const e=new Float32Array(t.length),r=(()=>t instanceof Int8Array?e=>Math.max(e/127,-1):t instanceof Uint8Array?e=>e/255:t instanceof Int16Array?e=>Math.max(e/32767,-1):t instanceof Uint16Array?e=>e/65535:e=>e)();for(let n=0;n<t.length;++n)e[n]=r(t[n]);t=e}return t}_getSceneNode(e,t,r=!0){const n=this._getGltfXXName(GltfAssetKind.Scene,e),s=this._gltf.scenes[e];let o;if(s.nodes&&0!==s.nodes.length){const e=s.nodes,i=new Array(this._gltf.nodes.length).fill(null);if(1===s.nodes.length&&this._promotedRootNodes.includes(s.nodes[0])){const e=s.nodes[0];o=this._createEmptyNodeRecursive(e,i,r)}else{o=new cc.Node(n);for(const e of s.nodes){this._createEmptyNodeRecursive(e,i,r).parent=o}}i.forEach((r,n)=>{this._setupNode(n,i,t,o,e)})}else o=new cc.Node(n);return o}_createEmptyNodeRecursive(e,t,r=!0){const n=this._gltf.nodes[e],s=this._createEmptyNode(e,r);if(void 0!==n.children)for(const e of n.children){this._createEmptyNodeRecursive(e,t,r).parent=s}return t[e]=s,s}_setupNode(e,t,r,n,s){const o=t[e];if(null===o)return;const i=this._gltf.nodes[e];if(void 0!==i.mesh){let a=null;if(void 0===i.skin)a=o.addComponent(cc.MeshRenderer);else{const l=o.addComponent(cc.SkinnedMeshRenderer),c=r.find("skeletons",i.skin,cc.Skeleton);c&&(l.skeleton=c);const u=t[this._getSkinRoot(i.skin)];if(null===u){this.gltf.skins[i.skin].joints.every(e=>s.includes(this._getRootParent(e)))?l.skinningRoot=n:this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.ReferenceSkinInDifferentScene,{node:e,skin:i.skin})}else l.skinningRoot=u;a=l}const l=r.find("meshes",i.mesh,cc.Mesh);l&&(a._mesh=l);const c=this.gltf.meshes[i.mesh],u=this._processedMeshes[i.mesh].materialIndices.map(e=>{const t=c.primitives[e];if(void 0===t.material)return null;{const e=r.find("materials",t.material,cc.Material);if(e)return e}return null});a._materials=u}}_createEmptyNode(e,t=!0){const r=this._gltf.nodes[e],n=this._getGltfXXName(GltfAssetKind.Node,e),s=new cc.Node(n);if(!t)return s;if(r.translation&&s.setPosition(r.translation[0],r.translation[1],r.translation[2]),r.rotation&&s.setRotation(this._getNodeRotation(r.rotation,new cc_1.Quat)),r.scale&&s.setScale(r.scale[0],r.scale[1],r.scale[2]),r.matrix){const e=r.matrix,t=this._readNodeMatrix(e),n=new cc_1.Vec3,o=new cc_1.Quat,i=new cc_1.Vec3;cc_1.Mat4.toRTS(t,o,n,i),s.setPosition(n),s.setRotation(o),s.setScale(i)}return s}_readNodeMatrix(e){return new cc_1.Mat4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}_getNodePath(e){return this._nodePathTable[e]}_isAncestorOf(e,t){if(e!==t)for(;t>=0;){if(t===e)return!0;t=this._getParent(t)}return!1}_mapToSocketPath(e){for(const t of this._socketMappings)if(e===t[0]||e.startsWith(t[0]+"/"))return t[1]+e.slice(t[0].length);return e}_createNodePathTable(){if(void 0===this._gltf.nodes)return[];const e=new Array(this._gltf.nodes.length).fill(-1);this._gltf.nodes.forEach((t,r)=>{if(t.children){t.children.forEach(t=>{e[t]=r}),makeUniqueNames(t.children.map(e=>{let t=this._gltf.nodes[e].name;return"string"==typeof t&&0!==t.length||(t=null),t}),uniqueChildNodeNameGenerator).forEach((e,r)=>{this._gltf.nodes[t.children[r]].name=e})}});const t=new Array(this._gltf.nodes.length).fill("");for(let e=0;e<t.length;++e)t[e]=this._getGltfXXName(GltfAssetKind.Node,e);const r=new Array(this._gltf.nodes.length).fill("");return this._gltf.nodes.forEach((n,s)=>{const o=[];for(let r=s;r>=0;r=e[r])this._promotedRootNodes.includes(r)||o.unshift(t[r]);r[s]=o.join("/")}),r}_readAccessor(e,t,r=0){if(void 0===e.bufferView)return;const n=this._gltf.bufferViews[e.bufferView],s=this._getComponentsPerAttribute(e.type),o=this._getBytesPerComponent(e.componentType);0===r&&(r=s*o);const i=(void 0!==e.byteOffset?e.byteOffset:0)+(void 0!==n.byteOffset?n.byteOffset:0),a=createDataViewFromBuffer(this._buffers[n.buffer],i),l=void 0!==n.byteStride?n.byteStride:s*o,c=this._getComponentReader(e.componentType),u=this._getComponentWriter(e.componentType);for(let n=0;n<e.count;++n){const e=createDataViewFromTypedArray(a,l*n),i=createDataViewFromTypedArray(t,r*n);for(let t=0;t<s;++t){const r=o*t;u(i,r,c(e,r))}}}_applyDeviation(e,t){const{sparse:r}=e,n=this._gltf.bufferViews[r.indices.bufferView],s=this._buffers[n.buffer],o=new(this._getAttributeBaseTypeStorage(r.indices.componentType))(s.buffer,s.byteOffset+(n.byteOffset||0)+(r.indices.byteOffset||0),r.count),i=this._gltf.bufferViews[r.values.bufferView],a=this._buffers[i.buffer],l=new(this._getAttributeBaseTypeStorage(e.componentType))(a.buffer,a.byteOffset+(i.byteOffset||0)+(r.values.byteOffset||0)),c=this._getComponentsPerAttribute(e.type);for(let e=0;e<c;++e)for(let r=0;r<o.length;++r){t[c*o[r]+e]=l[c*r+e]}}_getPrimitiveMode(e){switch(void 0===e&&(e=glTF_constants_1.GltfPrimitiveMode.__DEFAULT),e){case glTF_constants_1.GltfPrimitiveMode.POINTS:return cc_1.gfx.PrimitiveMode.POINT_LIST;case glTF_constants_1.GltfPrimitiveMode.LINES:return cc_1.gfx.PrimitiveMode.LINE_LIST;case glTF_constants_1.GltfPrimitiveMode.LINE_LOOP:return cc_1.gfx.PrimitiveMode.LINE_LOOP;case glTF_constants_1.GltfPrimitiveMode.LINE_STRIP:return cc_1.gfx.PrimitiveMode.LINE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLES:return cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_STRIP:return cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_FAN:return cc_1.gfx.PrimitiveMode.TRIANGLE_FAN;default:throw new Error(`Unrecognized primitive mode: ${e}.`)}}_getAttributeBaseTypeStorage(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return Int8Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return Uint8Array;case glTF_constants_1.GltfAccessorComponentType.SHORT:return Int16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return Uint16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return Uint32Array;case glTF_constants_1.GltfAccessorComponentType.FLOAT:return Float32Array;default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentsPerAttribute(e){return glTF_constants_1.getGltfAccessorTypeComponents(e)}_getBytesPerComponent(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return 1;case glTF_constants_1.GltfAccessorComponentType.SHORT:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return 2;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:case glTF_constants_1.GltfAccessorComponentType.FLOAT:return 4;default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentReader(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t)=>e.getInt8(t);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t)=>e.getUint8(t);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t)=>e.getInt16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t)=>e.getUint16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t)=>e.getUint32(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t)=>e.getFloat32(t,DataViewUseLittleEndian);default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentWriter(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t,r)=>e.setInt8(t,r);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t,r)=>e.setUint8(t,r);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t,r)=>e.setInt16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t,r)=>e.setUint16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t,r)=>e.setUint32(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t,r)=>e.setFloat32(t,r,DataViewUseLittleEndian);default:throw new Error(`Unrecognized component type: ${e}`)}}_getGltfXXName(e,t){const r={[GltfAssetKind.Animation]:"animations",[GltfAssetKind.Image]:"images",[GltfAssetKind.Material]:"materials",[GltfAssetKind.Node]:"nodes",[GltfAssetKind.Skin]:"skins",[GltfAssetKind.Texture]:"textures",[GltfAssetKind.Scene]:"scenes"},n=this._gltf[r[e]];if(!n)return"";const s=n[t];return"string"==typeof s.name?s.name:`${GltfAssetKind[e]}-${t}`}_normalizeArrayToCocosColor(e){let t=1;Math.max(...e)>1&&(t=Math.max(...e));const r=e.map(e=>color_utils_1.linearToSrgb8Bit(e/t));3===r.length&&r.push(255);const n=new cc.Color(r[0],r[1],r[2],r[3]);return[t,n]}_convertAdskPhysicalMaterial(e,t,r,n,s){var o,i,a,l,c,u,_,f,d,m,p,h,g;const T={},v={},{Parameters:A}=s.properties["3dsMax"],x=null!==(o=A.base_color)&&void 0!==o?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color;v.mainColor=cc.Vec4.set(new cc.Color,x[0],x[1],x[2],x[3]);const S=null!==(i=A.basic_weight)&&void 0!==i?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.basic_weight;v.albedoScale=new cc.Vec3(S,S,S);const E=null!==(a=A.base_color_map_on)&&void 0!==a?a:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color_map_on,M=A.base_color_map;E&&M&&(T.USE_ALBEDO_MAP=!0,v.mainTexture=null!==(l=r.find("textures",M.index,cc.Texture2D))&&void 0!==l?l:void 0,1===M.texCoord&&(T.ALBEDO_UV="v_uv1"),hasKHRTextureTransformExtension(M)&&(v.tilingOffset=this._khrTextureTransformToTiling(M.extensions.KHR_texture_transform)));const y=null!==(c=A.metalness)&&void 0!==c?c:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness;v.metallic=y;const P=null!==(u=A.roughness)&&void 0!==u?u:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness,b=null!==(_=A.roughness_inv)&&void 0!==_?_:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_inv;v.roughness=b?1-P:P;null!==(f=A.metalness_map_on)&&void 0!==f||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness_map_on,A.metalness_map,null!==(d=A.roughness_map_on)&&void 0!==d||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_map_on,A.roughness_map;const C=null!==(m=A.emission)&&void 0!==m?m:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emission,I=null!==(p=A.emit_color)&&void 0!==p?p:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color;v.emissive=new cc_1.Vec4(I[0]*C,I[1]*C,I[2]*C,I[3]*C);const N=null!==(h=A.emit_color_map_on)&&void 0!==h?h:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color_map_on,F=A.emit_color_map;N&&F&&(T.USE_EMISSIVE_MAP=!0,v.emissiveMap=null!==(g=r.find("textures",F.index,cc.Texture2D))&&void 0!==g?g:void 0,1===F.texCoord&&(T.EMISSIVE_UV="v_uv1"));const G=new cc.Material;return G.name=this._getGltfXXName(GltfAssetKind.Material,t),G._effectAsset=n("db://internal/effects/builtin-standard.effect"),G._defines=[T],G._props=[v],G._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],G}_convertMaxPhysicalMaterial(e,t,r,n){var s,o,i,a,l,c,u,_;const f={},d={};n.base_color_map&&(f.USE_ALBEDO_MAP=!0,d.mainTexture=null!==(s=t.find("textures",n.base_color_map.value.index,cc.Texture2D))&&void 0!==s?s:void 0),d.mainColor=this._normalizeArrayToCocosColor(n.base_color.value)[1],n.base_weight_map&&(f.USE_WEIGHT_MAP=!0,d.baseWeightMap=null!==(o=t.find("textures",n.base_weight_map.value.index,cc.Texture2D))&&void 0!==o?o:void 0),d.albedoScale=n.base_weight.value,n.metalness_map&&(f.USE_METALLIC_MAP=!0,d.metallicMap=null!==(i=t.find("textures",n.metalness_map.value.index,cc.Texture2D))&&void 0!==i?i:void 0),d.metallic=n.metalness.value,n.roughness_map&&(f.USE_ROUGHNESS_MAP=!0,d.roughnessMap=null!==(a=t.find("textures",n.roughness_map.value.index,cc.Texture2D))&&void 0!==a?a:void 0),d.roughness=n.roughness.value,n.bump_map&&(f.USE_NORMAL_MAP=!0,d.normalMap=null!==(l=t.find("textures",n.bump_map.value.index,cc.Texture2D))&&void 0!==l?l:void 0),n.emission_map&&(f.USE_EMISSIVESCALE_MAP=!0,d.emissiveScaleMap=null!==(c=t.find("textures",n.emission_map.value.index,cc.Texture2D))&&void 0!==c?c:void 0),d.emissiveScale=n.emission.value,n.emit_color_map&&(f.USE_EMISSIVE_MAP=!0,d.emissiveMap=null!==(u=t.find("textures",n.emit_color_map.value.index,cc.Texture2D))&&void 0!==u?u:void 0),d.emissive=this._normalizeArrayToCocosColor(n.emit_color.value)[1],d.alphaSource=1;let m=0;n.cutout_map&&(m=1,f.USE_ALPHA_TEST=!1,f.USE_OPACITY_MAP=!0,d.alphaSourceMap=null!==(_=t.find("textures",n.cutout_map.value.index,cc.Texture2D))&&void 0!==_?_:void 0);const p=new cc.Material;return p.name=this._getGltfXXName(GltfAssetKind.Material,e),p._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),p._defines=[f],p._props=[d],p._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],setTechniqueIndex(p,m),p}_convertMayaStandardSurface(e,t,r,n){var s,o,i,a,l,c,u,_;const f={},d={};n.base.texture&&(f.USE_WEIGHT_MAP=!0,d.baseWeightMap=null!==(s=t.find("textures",n.base.texture.index,cc.Texture2D))&&void 0!==s?s:void 0),d.albedoScale=n.base.value,n.baseColor.texture&&(f.USE_ALBEDO_MAP=!0,d.mainTexture=null!==(o=t.find("textures",n.baseColor.texture.index,cc.Texture2D))&&void 0!==o?o:void 0),d.mainColor=this._normalizeArrayToCocosColor(n.baseColor.value)[1],n.metalness.texture&&(f.USE_METALLIC_MAP=!0,d.metallicMap=null!==(i=t.find("textures",n.metalness.texture.index,cc.Texture2D))&&void 0!==i?i:void 0),d.metallic=n.metalness.value,n.specularRoughness.texture&&(f.USE_ROUGHNESS_MAP=!0,d.roughnessMap=null!==(a=t.find("textures",n.specularRoughness.texture.index,cc.Texture2D))&&void 0!==a?a:void 0),d.roughness=n.specularRoughness.value,void 0!==n.normalCamera.texture&&(f.USE_NORMAL_MAP=!0,d.normalMap=null!==(l=t.find("textures",n.normalCamera.texture.index,cc.Texture2D))&&void 0!==l?l:void 0),void 0!==n.emission.texture&&(f.USE_EMISSIVESCALE_MAP=!0,d.emissiveScaleMap=null!==(c=t.find("textures",n.emission.texture.index,cc.Texture2D))&&void 0!==c?c:void 0),d.emissiveScale=n.emission.value,void 0!==n.emissionColor.texture&&(f.USE_EMISSIVE_MAP=!0,d.emissiveMap=null!==(u=t.find("textures",n.emissionColor.texture.index,cc.Texture2D))&&void 0!==u?u:void 0),d.emissive=this._normalizeArrayToCocosColor(n.emissionColor.value)[1],n.opacity.texture?(f.USE_ALPHA_TEST=!1,f.USE_OPACITY_MAP=!0,d.alphaSourceMap=null!==(_=t.find("textures",n.opacity.texture.index,cc.Texture2D))&&void 0!==_?_:void 0):Math.max(...n.opacity.value)<.99&&(d.alphaSource=Math.max(...n.opacity.value));const m=new cc.Material;return m.name=this._getGltfXXName(GltfAssetKind.Material,e),m._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),m._defines=[f],m._props=[d],m._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],m}_convertPhongMaterial(e,t,r,n,s){var o,i,a,l,c,u,_,f,d,m;const p={},h={};let g=0,T=255;if(void 0!==s.transparentColor.texture)p.USE_ALPHA_TEST=!1,p.USE_TRANSPARENCY_MAP=!0,h.transparencyMap=null!==(o=t.find("textures",s.transparentColor.texture.index,cc.Texture2D))&&void 0!==o?o:void 0,g=1;else if(s.transparencyFactor){const t=(s.transparentColor.value[0]+s.transparentColor.value[1]+s.transparentColor.value[2])/3;s.transparentColor.value[0]===s.transparentColor.value[1]&&s.transparentColor.value[0]===s.transparentColor.value[2]||console.warn(`Material ${this._getGltfXXName(GltfAssetKind.Material,e)} : Transparent color property is not supported, average value would be used.`),0!==s.transparencyFactor.value*t&&(g=1,T=color_utils_1.linearToSrgb8Bit(1-s.transparencyFactor.value*t))}if(s.diffuse){const e=this._normalizeArrayToCocosColor(s.diffuse.value);h.albedoScale=s.diffuseFactor.value*e[0],e[1].a=T,h.mainColor=e[1],void 0!==s.diffuse.texture&&(p.USE_ALBEDO_MAP=!0,h.mainTexture=null!==(i=t.find("textures",s.diffuse.texture.index,cc.Texture2D))&&void 0!==i?i:void 0)}if(s.specular){const e=this._normalizeArrayToCocosColor(s.specular.value);h.specularFactor=s.specularFactor.value*e[0],h.specularColor=e[1],void 0!==s.specular.texture&&(p.USE_SPECULAR_MAP=!0,h.specularMap=null!==(a=t.find("textures",s.specular.texture.index,cc.Texture2D))&&void 0!==a?a:void 0)}if(void 0!==(null===(l=s.normalMap)||void 0===l?void 0:l.texture)?(p.USE_NORMAL_MAP=!0,h.normalMap=null!==(c=t.find("textures",s.normalMap.texture.index,cc.Texture2D))&&void 0!==c?c:void 0):void 0!==(null===(u=s.bump)||void 0===u?void 0:u.texture)&&(p.USE_NORMAL_MAP=!0,h.normalMap=null!==(_=t.find("textures",s.bump.texture.index,cc.Texture2D))&&void 0!==_?_:void 0),s.shininess&&(h.shininessExponent=s.shininess.value,void 0!==s.shininess.texture&&(p.USE_SHININESS_MAP=!0,h.shininessExponentMap=null!==(f=t.find("textures",s.shininess.texture.index,cc.Texture2D))&&void 0!==f?f:void 0)),s.emissive){const e=this._normalizeArrayToCocosColor(s.emissive.value);h.emissiveScale=s.emissiveFactor.value*e[0],h.emissive=e[1],void 0!==s.emissive.texture&&(p.USE_EMISSIVE_MAP=!0,h.emissiveMap=null!==(d=t.find("textures",s.emissive.texture.index,cc.Texture2D))&&void 0!==d?d:void 0),void 0!==s.emissiveFactor.texture&&(p.USE_EMISSIVESCALE_MAP=!0,h.emissiveScaleMap=null!==(m=t.find("textures",s.emissiveFactor.texture.index,cc.Texture2D))&&void 0!==m?m:void 0)}p.DCC_APP_NAME=n;const v=new cc.Material;return v.name=this._getGltfXXName(GltfAssetKind.Material,e),setTechniqueIndex(v,g),v._effectAsset=r("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),v._defines=[p],v._props=[h],v._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],v}_convertBlenderPBRMaterial(e,t,r,n){var s,o,i,a,l,c,u,_,f;const d={},m={},p=e.extras["FBX-glTF-conv"].raw.properties;if(d.DCC_APP_NAME=2,d.HAS_EXPORTED_METALLIC=!0,p.diffuse){const e=this._normalizeArrayToCocosColor(p.diffuse.value);m.mainColor=e[1],void 0!==p.diffuse.texture&&(d.USE_ALBEDO_MAP=!0,m.mainTexture=null!==(s=r.find("textures",p.diffuse.texture.index,cc.Texture2D))&&void 0!==s?s:void 0)}if(void 0!==(null===(o=p.bump)||void 0===o?void 0:o.texture)&&(d.USE_NORMAL_MAP=!0,m.normalMap=null!==(i=r.find("textures",p.bump.texture.index,cc.Texture2D))&&void 0!==i?i:void 0),p.shininess&&(m.shininessExponent=p.shininess.value,void 0!==p.shininess.texture&&(d.USE_SHININESS_MAP=!0,m.shininessExponentMap=null!==(a=r.find("textures",p.shininess.texture.index,cc.Texture2D))&&void 0!==a?a:void 0)),p.emissive){const e=this._normalizeArrayToCocosColor(p.emissive.value);m.emissiveScale=p.emissiveFactor.value*e[0],m.emissive=e[1],void 0!==p.emissive.texture&&(d.USE_EMISSIVE_MAP=!0,m.emissiveMap=null!==(l=r.find("textures",p.emissive.texture.index,cc.Texture2D))&&void 0!==l?l:void 0),void 0!==p.emissiveFactor.texture&&(d.USE_EMISSIVESCALE_MAP=!0,m.emissiveScaleMap=null!==(c=r.find("textures",p.emissiveFactor.texture.index,cc.Texture2D))&&void 0!==c?c:void 0)}p.reflectionFactor&&(m.metallic=p.reflectionFactor.value,void 0!==p.reflectionFactor.texture&&(d.USE_METALLIC_MAP=!0,m.metallicMap=null!==(u=r.find("textures",p.reflectionFactor.texture.index,cc.Texture2D))&&void 0!==u?u:void 0)),p.specularFactor&&(p.specularFactor.texture?(d.USE_SPECULAR_MAP=!0,m.specularMap=null!==(_=r.find("textures",p.specularFactor.texture.index,cc.Texture2D))&&void 0!==_?_:void 0):m.specularFactor=p.specularFactor.value),p.transparencyFactor&&(void 0!==p.transparencyFactor.texture?(d.USE_ALPHA_TEST=!1,d.USE_TRANSPARENCY_MAP=!0,m.transparencyMap=null!==(f=r.find("textures",p.transparencyFactor.texture.index,cc.Texture2D))&&void 0!==f?f:void 0):m.transparencyFactor=p.transparencyFactor.value);const h=new cc.Material;return h.name=this._getGltfXXName(GltfAssetKind.Material,t),h._effectAsset=n("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),h._defines=[d],h._props=[m],h._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],h}_convertGltfPbrSpecularGlossiness(e,t,r,n,s){var o,i;const a={},l={},c={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}},u=e.extensions.KHR_materials_pbrSpecularGlossiness;if(a.DCC_APP_NAME=4,u.diffuseFactor){const e=this._normalizeArrayToCocosColor(u.diffuseFactor);l.mainColor=e[1]}if(void 0!==u.diffuseTexture&&(a.USE_ALBEDO_MAP=!0,l.mainTexture=null!==(o=r.find("textures",u.diffuseTexture.index,cc.Texture2D))&&void 0!==o?o:void 0),u.specularFactor){const e=this._normalizeArrayToCocosColor(u.specularFactor);l.specularColor=e[1]}if(u.glossinessFactor&&(a.HAS_EXPORTED_GLOSSINESS=!0,l.glossiness=u.glossinessFactor),void 0!==u.specularGlossinessTexture&&(a.HAS_EXPORTED_GLOSSINESS=!0,a.USE_SPECULAR_GLOSSINESS_MAP=!0,l.specularGlossinessMap=null!==(i=r.find("textures",u.specularGlossinessTexture.index,cc.Texture2D))&&void 0!==i?i:void 0),void 0!==e.normalTexture){const t=e.normalTexture;void 0!==t.index&&(a.USE_NORMAL_MAP=!0,l.normalMap=r.find("textures",t.index,cc.Texture2D))}if(void 0!==e.emissiveTexture&&(a.USE_EMISSIVE_MAP=!0,e.emissiveTexture.texCoord&&(a.EMISSIVE_UV="v_uv1"),l.emissiveMap=r.find("textures",e.emissiveTexture.index,cc.Texture2D)),void 0!==e.emissiveFactor){const t=e.emissiveFactor;l.emissive=this._normalizeArrayToCocosColor(t)[1]}switch(e.doubleSided&&(c.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),e.alphaMode){case"BLEND":{const e=c.blendState.targets[0];e.blend=!0,e.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,e.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,e.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,c.depthStencilState.depthWrite=s;break}case"MASK":{const t=void 0===e.alphaCutoff?.5:e.alphaCutoff;a.USE_ALPHA_TEST=!0,l.alphaThreshold=t;break}case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:e.alphaMode,material:t})}const _=new cc.Material;return _.name=this._getGltfXXName(GltfAssetKind.Material,t),_._effectAsset=n("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),_._defines=[a],_._props=[l],_._states=[c],_}_khrTextureTransformToTiling(e){const t=new cc_1.Vec4(1,1,0,0);return e.scale&&(t.x=e.scale[0],t.y=e.scale[1]),e.offset&&(t.z=e.offset[0],t.w=e.offset[1]),t}}function hasKHRTextureTransformExtension(e){const{extensions:t}=e;return"object"==typeof t&&null!==t&&"object"==typeof t.KHR_texture_transform}function setTechniqueIndex(e,t){e._techIdx=t}async function readGltf(e){return".glb"===path.extname(e)?await readGlb(e):await readGltfJson(e)}async function readGltfJson(e){const t=await fs.readJSON(e);return{glTF:t,buffers:t.buffers?t.buffers.map(t=>t.uri?resolveBufferUri(e,t.uri):Buffer.alloc(0)):[]}}async function readGlb(e){const t=()=>{throw new Error("Bad glb format.")},r=await fs.readFile(e);if(r.length<12)return t();if(1179937895!==r.readUInt32LE(0))return t();r.readUInt32LE(4),r.readUInt32LE(8);let n,s;for(let e=0,o=12;o+8<=r.length;++e){const i=r.readUInt32LE(o);o+=4;const a=r.readUInt32LE(o);if((o+=4)+i>r.length)return t();const l=Buffer.from(r.buffer,o,i);if(o+=i,0===e){if(1313821514!==a)return t();const e=new TextDecoder("utf-8").decode(l);n=JSON.parse(e)}else 5130562===a&&(s=l)}if(n){return{glTF:n,buffers:n.buffers?n.buffers.map((t,r)=>t.uri?resolveBufferUri(e,t.uri):0===r&&s?s:Buffer.alloc(0)):[]}}return t()}function resolveBufferUri(e,t){const r=DataURI.parse(t);if(r)return Buffer.from(resolveBufferDataURI(r));return path.resolve(path.dirname(e),t)}function isDataUri(e){return e.startsWith("data:")}exports.GltfConverter=GltfConverter,GltfConverter._defaultLogger=((e,t,r)=>{const n=JSON.stringify({error:t,arguments:r},void 0,4);switch(e){case GltfConverter.LogLevel.Info:console.log(n);break;case GltfConverter.LogLevel.Warning:console.warn(n);break;case GltfConverter.LogLevel.Error:console.error(n);break;case GltfConverter.LogLevel.Debug:console.debug(n)}}),function(e){let t,r;!function(e){e[e.Info=0]="Info",e[e.Warning=1]="Warning",e[e.Error=2]="Error",e[e.Debug=3]="Debug"}(t=e.LogLevel||(e.LogLevel={})),function(e){e[e.ReferenceSkinInDifferentScene=0]="ReferenceSkinInDifferentScene",e[e.UnsupportedAlphaMode=1]="UnsupportedAlphaMode",e[e.UnsupportedTextureParameter=2]="UnsupportedTextureParameter",e[e.UnsupportedChannelPath=3]="UnsupportedChannelPath",e[e.DisallowCubicSplineChannelSplit=4]="DisallowCubicSplineChannelSplit",e[e.FailedToCalculateTangents=5]="FailedToCalculateTangents",e[e.EmptyMorph=6]="EmptyMorph",e[e.UnsupportedExtension=7]="UnsupportedExtension"}(r=e.ConverterError||(e.ConverterError={}))}(GltfConverter=exports.GltfConverter||(exports.GltfConverter={})),exports.readGltf=readGltf,exports.isDataUri=isDataUri;class BufferBlob{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){if(0!==e){const t=this._length%e;if(0!==t){const r=e-t;this._arrayBufferOrPaddings.push(r),this._length+=r}}}addBuffer(e){const t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const e=new Uint8Array(this._length);let t=0;return this._arrayBufferOrPaddings.forEach(r=>{"number"==typeof r?t+=r:(e.set(new Uint8Array(r),t),t+=r.byteLength)}),e}}function createDataViewFromBuffer(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}function createDataViewFromTypedArray(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}const DataViewUseLittleEndian=!0;function uniqueChildNodeNameGenerator(e,t,r,n){return`${e||""}(__autogen ${r}${0===n?"":`-${n}`})`}function makeUniqueNames(e,t){const r=new Array(e.length).fill("");for(let n=0;n<e.length;++n){let s=e[n],o=0;for(;;){if(null!==s&&(()=>r.every((e,t)=>t===n||s!==e))()){r[n]=s;break}s=t(e[n],s,n,o++)}}return r}function resolveBufferDataURI(e){if(!e.base64||!e.mediaType||"application/octet-stream"!==e.mediaType.value&&"application/gltf-buffer"!==e.mediaType.value)throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for buffer.`);return base64_1.decodeBase64ToArrayBuffer(e.data)}class DynamicArrayBuffer{constructor(e){this._size=0,this._arrayBuffer=new ArrayBuffer(Math.max(e||0,4))}get arrayBuffer(){return this._arrayBuffer}grow(e){const t=this._size;if(e){const r=this._arrayBuffer.byteLength,n=r-t-e;if(n<0){const e=new ArrayBuffer(1.5*(r+-n));new Uint8Array(e,0,r).set(new Uint8Array(this._arrayBuffer)),this._arrayBuffer=e}this._size+=e}return t}shrink(){return this._arrayBuffer.slice(0,this._size)}}function getDataviewWritterOfTypedArray(e,t){switch(e.constructor){case Int8Array:return(e,t,r)=>e.setInt8(t,r);case Uint8Array:return(e,t,r)=>e.setUint8(t,r);case Int16Array:return(e,r,n)=>e.setInt16(r,n,t);case Uint16Array:return(e,r,n)=>e.setUint16(r,n,t);case Int32Array:return(e,r,n)=>e.setInt32(r,n,t);case Uint32Array:return(e,r,n)=>e.setUint32(r,n,t);case Float32Array:return(e,r,n)=>e.setFloat32(r,n,t);default:throw new Error("Bad storage constructor.")}}function interleaveVertices(e,t=!1){const r=e.vertexCount;let n=!1;const s=[];for(const t of e.attributes()){let e;try{(e=pp_geometry_1.getGfxAttributeName(t))===cc_1.gfx.AttributeName.ATTR_TEX_COORD1&&(n=!0)}catch(e){console.error(e);continue}s.push([e,t])}t&&!n&&s.push(["a_texCoord1",new pp_geometry_1.PPGeometry.Attribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord,new Float32Array(2*r),2)]);let o=0;for(const[e,t]of s)o+=t.data.BYTES_PER_ELEMENT*t.components;const i=new ArrayBuffer(r*o),a=new DataView(i);let l=0;const c=[];for(const[e,t]of s){const n=t.data,s=getDataviewWritterOfTypedArray(n,DataViewUseLittleEndian);for(let e=0;e<r;++e){const r=l+o*e;for(let o=0;o<t.components;++o){const i=n[t.components*e+o];s(a,r+n.BYTES_PER_ELEMENT*o,i)}}l+=t.data.BYTES_PER_ELEMENT*t.components,c.push({name:e,format:t.getGFXFormat(),isNormalized:t.isNormalized})}return{vertexCount:r,vertexStride:o,formats:c,vertexBuffer:i}}const glTFAttributeNameToPP=(()=>e=>{if(e.startsWith("_"))return e;const t=/([a-zA-Z]+)(?:_(\d+))?/g.exec(e);if(!t)return e;const r=t[1];let n;const s=parseInt(t[2]||"0");switch(r){case"POSITION":n=pp_geometry_1.PPGeometry.StdSemantics.position;break;case"NORMAL":n=pp_geometry_1.PPGeometry.StdSemantics.normal;break;case"TANGENT":n=pp_geometry_1.PPGeometry.StdSemantics.tangent;break;case"COLOR":n=pp_geometry_1.PPGeometry.StdSemantics.color;break;case"TEXCOORD":n=pp_geometry_1.PPGeometry.StdSemantics.texcoord;break;case"JOINTS":n=pp_geometry_1.PPGeometry.StdSemantics.joints;break;case"WEIGHTS":n=pp_geometry_1.PPGeometry.StdSemantics.weights}return void 0===n?e:pp_geometry_1.PPGeometry.StdSemantics.set(n,s)})();class GlTfConformanceError extends Error{}function assertGlTFConformance(e,t){if(!e)throw new GlTfConformanceError(`glTF non-conformance error: ${t}`)}exports.GlTfConformanceError=GlTfConformanceError;