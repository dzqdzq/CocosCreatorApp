"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,n)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTfConformanceError=exports.BufferBlob=exports.isDataUri=exports.readGltf=exports.GltfConverter=exports.doCreateSocket=exports.getWorldTransformUntilRoot=exports.getPathFromRoot=exports.isFilesystemPath=void 0;const DataURI=__importStar(require("@cocos/data-uri")),cc=__importStar(require("cc")),cc_1=require("cc"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),glTF_meta_1=require("../../meta-schemas/glTF.meta"),texture_base_1=require("../texture-base"),base64_1=require("./base64"),glTF_constants_1=require("./glTF.constants"),khr_draco_mesh_compression_1=require("./khr-draco-mesh-compression"),pp_geometry_1=require("./pp-geometry"),extras_1=require("@editor/fbx-gltf-conv/lib/extras"),exotic_animation_1=require("cc/editor/exotic-animation"),glTF_animation_utils_1=require("./glTF-animation-utils"),color_utils_1=require("cc/editor/color-utils");function isFilesystemPath(e){return!e.isDataUri}function getPathFromRoot(e,t){let r=e,s="";for(;null!==r&&r!==t;)s=`${r.name}/${s}`,r=r.parent;return s.slice(0,-1)}function getWorldTransformUntilRoot(e,t,r,s,n){for(cc_1.Vec3.set(r,0,0,0),cc_1.Quat.set(s,0,0,0,1),cc_1.Vec3.set(n,1,1,1);e!==t;)cc_1.Vec3.multiply(r,r,e.scale),cc_1.Vec3.transformQuat(r,r,e.rotation),cc_1.Vec3.add(r,r,e.position),cc_1.Quat.multiply(s,e.rotation,s),cc_1.Vec3.multiply(n,e.scale,n),e=e.parent}var GltfAssetKind;exports.isFilesystemPath=isFilesystemPath,exports.getPathFromRoot=getPathFromRoot,exports.getWorldTransformUntilRoot=getWorldTransformUntilRoot,function(e){e[e.Node=0]="Node",e[e.Mesh=1]="Mesh",e[e.Texture=2]="Texture",e[e.Skin=3]="Skin",e[e.Animation=4]="Animation",e[e.Image=5]="Image",e[e.Material=6]="Material",e[e.Scene=7]="Scene"}(GltfAssetKind||(GltfAssetKind={}));const qt=new cc_1.Quat,v3a=new cc_1.Vec3,v3b=new cc_1.Vec3,v3Min=new cc_1.Vec3,v3Max=new cc_1.Vec3;function doCreateSocket(e,t,r){const s=getPathFromRoot(r.parent,e);if(r.parent===e)return;let n=t.find(e=>e.path===s);if(!n){const o=new cc.Node;o.name=`${r.parent.name} Socket`,o.parent=e,getWorldTransformUntilRoot(r.parent,e,v3a,qt,v3b),o.setPosition(v3a),o.setRotation(qt),o.setScale(v3b),n=new cc.SkeletalAnimation.Socket(s,o),t.push(n)}r.parent=n.target}exports.doCreateSocket=doCreateSocket;const skinRootNotCalculated=-2,skinRootAbsent=-1,supportedExtensions=new Set(["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_materials_unlit","KHR_texture_transform"]);var AppId;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.ADSK_3DS_MAX=1]="ADSK_3DS_MAX",e[e.CINEMA4D=3]="CINEMA4D",e[e.MAYA=5]="MAYA"}(AppId||(AppId={}));class GltfConverter{get gltf(){return this._gltf}get path(){return this._gltfFilePath}get processedMeshes(){return this._processedMeshes}get fbxMissingImagesId(){return this._fbxMissingImagesId}constructor(e,t,r,s){var n,o,i,a,l;this._gltf=e,this._buffers=t,this._gltfFilePath=r,this._promotedRootNodes=[],this._parents=[],this._skinRoots=[],this._processedMeshes=[],this._socketMappings=new Map,this._fbxMissingImagesId=[],s=s||{},this._logger=s.logger||GltfConverter._defaultLogger,null===(n=this._gltf.extensionsRequired)||void 0===n||n.forEach(e=>this._warnIfExtensionNotSupported(e,!0)),null===(o=this._gltf.extensionsUsed)||void 0===o||o.forEach(e=>{var t;(null===(t=this._gltf.extensionsRequired)||void 0===t?void 0:t.includes(e))||this._warnIfExtensionNotSupported(e,!1)}),s.promoteSingleRootNode&&this._promoteSingleRootNodes(),void 0!==this._gltf.nodes&&(this._parents=new Array(this._gltf.nodes.length).fill(-1),this._gltf.nodes.forEach((e,t)=>{if(void 0!==e.children)for(const r of e.children)this._parents[r]=t})),this._gltf.skins&&(this._skinRoots=new Array(this._gltf.skins.length).fill(skinRootNotCalculated)),this._nodePathTable=this._createNodePathTable();const c=s.userData||{};if(this._gltf.meshes){const e=null!==(i=c.normals)&&void 0!==i?i:glTF_meta_1.NormalImportSetting.require,t=null!==(a=c.tangents)&&void 0!==a?a:glTF_meta_1.TangentImportSetting.require,r=null!==(l=c.morphNormals)&&void 0!==l?l:glTF_meta_1.NormalImportSetting.exclude;for(let s=0;s<this._gltf.meshes.length;s++){const n=this._gltf.meshes[s],o=new cc_1.Vec3(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new cc_1.Vec3(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),{geometries:a,materialIndices:l,jointMaps:u}=pp_geometry_1.PPGeometry.skinningProcess(n.primitives.map((n,a)=>{const l=this._readPrimitive(n,s,a);return l.reduceJointInfluences(),this._applySettings(l,e,t,r,a,s),this._readBounds(n,v3Min,v3Max),cc_1.Vec3.min(o,o,v3Min),cc_1.Vec3.max(i,i,v3Max),l.sanityCheck(),l}),!1!==c.disableMeshSplit);this._processedMeshes.push({geometries:a,materialIndices:l,jointMaps:u,minPosition:o,maxPosition:i})}}if(this._gltf.nodes&&this._gltf.skins){const e=this._gltf.nodes,t=[];for(let r=0;r<e.length;r++){const s=e[r];void 0!==s.mesh&&void 0===s.skin&&t.push(r)}for(let e=0;e<t.length;e++){const r=t[e];t.some(e=>this._isAncestorOf(e,r))&&(t[e]=t[t.length-1],t.length--,e--)}for(let r=0;r<t.length;r++){const s=t[r],n=e[this._getParent(s)];n&&this._socketMappings.set(this._getNodePath(s),n.name+" Socket/"+e[s].name)}}}createMesh(e,t=!1,r=!1){const s=this._processedMeshes[e],n=this._gltf.meshes[e],o=new BufferBlob,i=new Array,a={primitives:s.geometries.map((e,s)=>{const{vertexCount:n,vertexStride:a,formats:l,vertexBuffer:c}=interleaveVertices(e,t,r);o.setNextAlignment(0),i.push({view:{offset:o.getLength(),length:c.byteLength,count:n,stride:a},attributes:l}),o.addBuffer(c);const u={primitiveMode:e.primitiveMode,jointMapIndex:e.jointMapIndex,vertexBundelIndices:[s]};if(void 0!==e.indices){const t=e.indices;o.setNextAlignment(t.BYTES_PER_ELEMENT),u.indexView={offset:o.getLength(),length:t.byteLength,count:t.length,stride:t.BYTES_PER_ELEMENT},o.addBuffer(t.buffer)}return u}),vertexBundles:i,minPosition:s.minPosition,maxPosition:s.maxPosition,jointMaps:s.jointMaps};{const e=s.geometries.map(e=>{let t=0;const r=[];if(e.forEachAttribute(e=>{if(e.morphs){if(0===t)t=e.morphs.length;else if(t!==e.morphs.length)throw new Error("Bad morph...");r.push(e)}}),0===t)return null;const s=new Array(t);for(let e=0;e<t;++e)s[e]={displacements:r.map(t=>{const r=t.morphs[e];o.setNextAlignment(r.BYTES_PER_ELEMENT);const s=o.getLength();return o.addBuffer(r.buffer),{offset:s,length:r.byteLength,stride:r.BYTES_PER_ELEMENT,count:r.length}})};return{attributes:r.map(e=>(0,pp_geometry_1.getGfxAttributeName)(e)),targets:s}}),t=e.find(e=>null!==e);if(t&&(assertGlTFConformance(e.every(e=>!e||e.targets.length===t.targets.length),"glTF expects that every primitive has same number of targets"),0!==e.length&&assertGlTFConformance(void 0===n.weights||n.weights.length===t.targets.length,'Number of "weights" mismatch number of morph targets'),a.morph={subMeshMorphs:e,weights:n.weights},"object"==typeof n.extras&&Array.isArray(n.extras.targetNames))){const e=n.extras.targetNames;e.length===t.targets.length&&e.every(e=>"string"==typeof e)&&(a.morph.targetNames=e.slice())}}const l=new cc.Mesh;return l.name=this._getGltfXXName(GltfAssetKind.Mesh,e),l.assign(a,o.getCombined()),l.hash,l}createSkeleton(e,t){const r=this._gltf.skins[e],s=new cc.Skeleton;if(s.name=this._getGltfXXName(GltfAssetKind.Skin,e),s._joints=r.joints.map(e=>this._mapToSocketPath(this._getNodePath(e))),void 0!==r.inverseBindMatrices){const e=this._gltf.accessors[r.inverseBindMatrices];if(e.componentType!==WebGLRenderingContext.FLOAT||"MAT4"!==e.type)throw new Error("The inverse bind matrix should be floating-point 4x4 matrix.");const t=new Array(r.joints.length),n=new Float32Array(16*t.length);this._readAccessor(e,createDataViewFromTypedArray(n)),assertGlTFConformance(n.length===16*t.length,"Wrong data in bind-poses accessor.");for(let e=0;e<t.length;++e)t[e]=new cc_1.Mat4(n[16*e+0],n[16*e+1],n[16*e+2],n[16*e+3],n[16*e+4],n[16*e+5],n[16*e+6],n[16*e+7],n[16*e+8],n[16*e+9],n[16*e+10],n[16*e+11],n[16*e+12],n[16*e+13],n[16*e+14],n[16*e+15]);s._bindposes=t}return s.hash,s}getAnimationDuration(e){const t=this._gltf.animations[e];let r=0;return t.channels.forEach(e=>{if(void 0===e.target.node)return;const s=t.samplers[e.sampler],n=this._gltf.accessors[s.input],o=void 0!==n.max&&1===n.max.length?Math.fround(n.max[0]):0;r=Math.max(o,r)}),r}createAnimation(e){const t=this._gltf.animations[e],r=new glTF_animation_utils_1.GlTFTrsAnimationData,s=e=>{const t=this._mapToSocketPath(this._getNodePath(e));return r.addNodeAnimation(t)};let n=0;const o=new Array,i=new Map,a=e=>{let t=i.get(e);if(void 0===t){const r=this._gltf.accessors[e],s=this._readAccessorIntoArray(r);t=o.length,o.push(s),i.set(e,t)}return t},l=[];if(t.channels.forEach(e=>{const r=e.target.node;if(void 0===r)return;const i=s(r),c=t.samplers[e.sampler],u=a(c.input);"weights"===e.target.path?l.push(...this._glTFWeightChannelToTracks(t,e,o[u])):this._gltfChannelToCurveData(t,e,i,o[u]);const _=this._gltf.accessors[c.input],d=void 0!==_.max&&1===_.max.length?Math.fround(_.max[0]):0;n=Math.max(d,n)}),this._gltf.nodes){new Float32Array([0]);const e=new cc_1.Quat,t=new cc_1.Vec3,r=new cc_1.Vec3;this._gltf.nodes.forEach((n,o)=>{if(this._promotedRootNodes.includes(o))return;const i=s(o);let a;if(n.matrix&&(a=this._readNodeMatrix(n.matrix),cc_1.Mat4.toRTS(a,e,t,r)),!i.position){const e=new cc_1.Vec3;n.translation?cc_1.Vec3.set(e,n.translation[0],n.translation[1],n.translation[2]):a&&cc_1.Vec3.copy(e,t),i.setConstantPosition(e)}if(!i.scale){const e=new cc_1.Vec3(1,1,1);n.scale?cc_1.Vec3.set(e,n.scale[0],n.scale[1],n.scale[2]):a&&cc_1.Vec3.copy(e,r),i.setConstantScale(e)}if(!i.rotation){const t=new cc_1.Quat;n.rotation?this._getNodeRotation(n.rotation,t):a&&cc_1.Quat.copy(t,e),i.setConstantRotation(t)}})}const c=r.createExotic(),u=new cc.AnimationClip;return u.name=this._getGltfXXName(GltfAssetKind.Animation,e),u.wrapMode=cc.AnimationClip.WrapMode.Loop,u.duration=n,u.sample=30,u.hash,u.enableTrsBlending=!0,l.forEach(e=>u.addTrack(e)),u[exotic_animation_1.exoticAnimationTag]=c,u}createMaterial(e,t,r,s){var n,o,i,a;const l=null===(n=s.useVertexColors)||void 0===n||n,c=null!==(o=s.depthWriteInAlphaModeBlend)&&void 0!==o&&o,u=null!==(i=s.smartMaterialEnabled)&&void 0!==i&&i,_=this._gltf.materials[e],d=void 0!==(_.extensions&&_.extensions.KHR_materials_unlit),f=this._gltf.extras;if(u){let s="";if("object"==typeof f&&f&&"FBX-glTF-conv"in f){const n=f["FBX-glTF-conv"];if(void 0!==n.fbxFileHeaderInfo){void 0!==n.fbxFileHeaderInfo.sceneInfo&&(s=n.fbxFileHeaderInfo.sceneInfo.original.applicationName);const o=/Blender/,i=/Maya/,a=/Max/,l=/Cinema/,c=/mixamo/,u=_.extras["FBX-glTF-conv"].raw;if(o.test(s)||c.test(s)){if("phong"===u.type)return this._convertBlenderPBRMaterial(_,e,t,r)}else if(i.test(s)){if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,AppId.MAYA,u.properties);if(u.properties.Maya&&1398031443===u.properties.Maya.value.TypeId.value)return this._convertMayaStandardSurface(e,t,r,u.properties.Maya.value)}else if(a.test(s)){if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,AppId.ADSK_3DS_MAX,u.properties);if(u.properties["3dsMax"].value.ORIGINAL_MTL&&"PHYSICAL_MTL"===u.properties["3dsMax"].value.ORIGINAL_MTL.value)return this._convertMaxPhysicalMaterial(e,t,r,u.properties["3dsMax"].value.Parameters.value)}else if(l.test(s)&&("phong"===u.type||"lambert"===u.type))return this._convertPhongMaterial(e,t,r,AppId.CINEMA4D,u.properties);if("phong"===u.type||"lambert"===u.type)return this._convertPhongMaterial(e,t,r,AppId.UNKNOWN,u.properties)}else console.debug("Failed to read fbx header info, default material was used")}else console.debug("Failed to read fbx info.")}else{const s=(()=>{if(!(0,extras_1.hasOriginalMaterialExtras)(_.extras))return null;const{originalMaterial:s}=_.extras["FBX-glTF-conv"];return(0,extras_1.isAdsk3dsMaxPhysicalMaterial)(s)?this._convertAdskPhysicalMaterial(_,e,t,r,s):null})();if(s)return s}const m=new cc.Material;m.name=this._getGltfXXName(GltfAssetKind.Material,e),m._effectAsset=r(`db://internal/effects/${d?"builtin-unlit":"builtin-standard"}.effect`);const p={},g={},h={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}};if(this._gltf.meshes)for(let t=0;t<this._gltf.meshes.length;t++){const r=this._gltf.meshes[t];for(let t=0;t<r.primitives.length;t++){const s=r.primitives[t];s.material===e&&(s.attributes.COLOR_0&&l&&(p.USE_VERTEX_COLOR=!0),s.attributes.TEXCOORD_1&&(p.HAS_SECOND_UV=!0))}}let x=!1;if(_.pbrMetallicRoughness){const e=_.pbrMetallicRoughness;if(void 0!==e.baseColorTexture){x=!0;const r=t.find("textures",e.baseColorTexture.index,cc.Texture2D);p[d?"USE_TEXTURE":"USE_ALBEDO_MAP"]=!!r,g.mainTexture=r,e.baseColorTexture.texCoord&&(p.ALBEDO_UV="v_uv1"),void 0!==e.baseColorTexture.extensions&&e.baseColorTexture.extensions.KHR_texture_transform&&(g.tilingOffset=this._khrTextureTransformToTiling(e.baseColorTexture.extensions.KHR_texture_transform))}if(e.baseColorFactor){x=!0;const t=e.baseColorFactor;d?g.mainColor=new cc_1.Vec4(t[0],t[1],t[2],1):g.albedoScale=new cc_1.Vec3(t[0],t[1],t[2])}void 0!==e.metallicRoughnessTexture&&(x=!0,p.USE_PBR_MAP=!0,g.pbrMap=t.find("textures",e.metallicRoughnessTexture.index,cc.Texture2D),g.metallic=1,g.roughness=1),void 0!==e.metallicFactor&&(x=!0,g.metallic=e.metallicFactor),void 0!==e.roughnessFactor&&(x=!0,g.roughness=e.roughnessFactor)}if(!x&&(null===(a=_.extensions)||void 0===a?void 0:a.KHR_materials_pbrSpecularGlossiness))return this._convertGltfPbrSpecularGlossiness(_,e,t,r,c);if(void 0!==_.normalTexture){const e=_.normalTexture;void 0!==e.index&&(p.USE_NORMAL_MAP=!0,g.normalMap=t.find("textures",e.index,cc.Texture2D),void 0!==e.scale&&(g.normalStrenth=e.scale))}if(g.occlusion=0,_.occlusionTexture){const e=_.occlusionTexture;void 0!==e.index&&(p.USE_OCCLUSION_MAP=!0,g.occlusionMap=t.find("textures",e.index,cc.Texture2D),void 0!==e.strength&&(g.occlusion=e.strength))}if(void 0!==_.emissiveTexture&&(p.USE_EMISSIVE_MAP=!0,_.emissiveTexture.texCoord&&(p.EMISSIVE_UV="v_uv1"),g.emissiveMap=t.find("textures",_.emissiveTexture.index,cc.Texture2D)),void 0!==_.emissiveFactor){const e=_.emissiveFactor;g.emissive=this._normalizeArrayToCocosColor(e)[1]}switch(_.doubleSided&&(h.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),_.alphaMode){case"BLEND":{const e=h.blendState.targets[0];e.blend=!0,e.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,e.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,e.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,h.depthStencilState.depthWrite=c;break}case"MASK":{const e=void 0===_.alphaCutoff?.5:_.alphaCutoff;p.USE_ALPHA_TEST=!0,g.alphaThreshold=e;break}case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:_.alphaMode,material:e})}return m._defines=[p],m._props=[g],m._states=[h],m}getTextureParameters(e,t){const r=t=>{switch(void 0===t&&(t=glTF_constants_1.GltfWrapMode.__DEFAULT),t){case glTF_constants_1.GltfWrapMode.CLAMP_TO_EDGE:return"clamp-to-edge";case glTF_constants_1.GltfWrapMode.MIRRORED_REPEAT:return"mirrored-repeat";case glTF_constants_1.GltfWrapMode.REPEAT:return"repeat";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"wrapMode",value:t,fallback:glTF_constants_1.GltfWrapMode.REPEAT,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),"repeat"}},s=t=>{switch(t){case glTF_constants_1.GltfTextureMagFilter.NEAREST:return"nearest";case glTF_constants_1.GltfTextureMagFilter.LINEAR:return"linear";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"magFilter",value:t,fallback:glTF_constants_1.GltfTextureMagFilter.LINEAR,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),"linear"}},n=t=>{switch(t){case glTF_constants_1.GltfTextureMinFilter.NEAREST:return["nearest","none"];case glTF_constants_1.GltfTextureMinFilter.LINEAR:return["linear","none"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_NEAREST:return["nearest","nearest"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_NEAREST:return["linear","nearest"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_LINEAR:return["nearest","linear"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_LINEAR:return["linear","linear"];default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"minFilter",value:t,fallback:glTF_constants_1.GltfTextureMinFilter.LINEAR,sampler:e.sampler,texture:this._gltf.textures.indexOf(e)}),["linear","none"]}};if(void 0===e.sampler)t.wrapModeS="repeat",t.wrapModeT="repeat";else{const o=this._gltf.samplers[e.sampler];if(t.wrapModeS=r(o.wrapS),t.wrapModeT=r(o.wrapT),t.magfilter=void 0===o.magFilter?texture_base_1.defaultMagFilter:s(o.magFilter),t.minfilter=texture_base_1.defaultMinFilter,void 0!==o.minFilter){const[e,r]=n(o.minFilter);t.minfilter=e,t.mipfilter=r}}}createScene(e,t,r=!0){const s=this._getSceneNode(e,t,r);return s.getComponentsInChildren(cc.SkinnedMeshRenderer).forEach(e=>e.skinningRoot=s),s}createSockets(e){const t=[];for(const r of this._socketMappings){doCreateSocket(e,t,e.getChildByPath(r[0]))}return t}readImageInBufferView(e){return this._readBufferView(e)}_warnIfExtensionNotSupported(e,t){supportedExtensions.has(e)||this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedExtension,{name:e,required:t})}_promoteSingleRootNodes(){if(void 0!==this._gltf.nodes&&void 0!==this._gltf.scenes)for(const e of this._gltf.scenes)if(void 0!==e.nodes&&1===e.nodes.length){const t=e.nodes[0];if(this._gltf.skins&&this._gltf.skins.some(e=>e.joints.includes(t)))continue;if(this._gltf.animations&&this._gltf.animations.some(e=>e.channels.some(e=>e.target.node===t)))continue;this._promotedRootNodes.push(t)}}_getNodeRotation(e,t){return cc_1.Quat.set(t,e[0],e[1],e[2],e[3]),cc_1.Quat.normalize(t,t),t}_gltfChannelToCurveData(e,t,r,s){var n;let o;if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.translation)o="position";else if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.rotation)o="rotation";else{if(t.target.path!==glTF_constants_1.GltfAnimationChannelTargetPath.scale)return void this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.UnsupportedChannelPath,{channel:e.channels.indexOf(t),animation:this._gltf.animations.indexOf(e),path:t.target.path});o="scale"}const i=e.samplers[t.sampler],a=null!==(n=i.interpolation)&&void 0!==n?n:glTF_constants_1.GlTfAnimationInterpolation.LINEAR;switch(a){case glTF_constants_1.GlTfAnimationInterpolation.STEP:case glTF_constants_1.GlTfAnimationInterpolation.LINEAR:case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:break;default:return}const l=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[i.output]);r[o]=new glTF_animation_utils_1.GlTFTrsTrackData(a,s,l)}_glTFWeightChannelToTracks(e,t,r){const s=e.samplers[t.sampler],n=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[s.output]),o=this._gltf.nodes[t.target.node],i=this._processedMeshes[o.mesh],a=new Array,l=i.geometries.length;let c=0;for(let e=0;e<l;++e){const t=i.geometries[e];if(!t.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.position))continue;const{morphs:r}=t.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.position);if(r){c=r.length;break}}if(0===c)return console.debug(`Morph animation in ${e.name} on node ${this._gltf.nodes[t.target.node]}`+"is going to be ignored due to lack of morph information in mesh."),[];const u=new exotic_animation_1.RealArrayTrack;a.push(u),u.path=(new cc.animation.TrackPath).toHierarchy(this._mapToSocketPath(this._getNodePath(t.target.node))).toComponent(cc.js.getClassName(cc.MeshRenderer)),u.proxy=new cc.animation.MorphWeightsAllValueProxy,u.elementCount=c;for(let e=0;e<c;++e){const{curve:t}=u.channels()[e],s=Array.from({length:r.length},(t,r)=>{return{value:n[c*r+e],interpolationMode:cc.RealInterpolationMode.LINEAR}});t.assignSorted(Array.from(r),s)}return a}_getParent(e){return this._parents[e]}_getRootParent(e){for(let t=e;t>=0;t=this._getParent(e))e=t;return e}_commonRoot(e){let t=1/0;const r=e.map(e=>{const r=[];let s=e;for(;s>=0;)r.unshift(s),s=this._getParent(s);return t=Math.min(t,r.length),r});if(0===r.length)return-1;const s=[];for(let e=0;e<t;++e){const t=r[0][e];if(!r.every(r=>r[e]===t))break;s.push(t)}return 0===s.length?-1:s[s.length-1]}_getSkinRoot(e){let t=this._skinRoots[e];return t===skinRootNotCalculated&&(t=this._commonRoot(this._gltf.skins[e].joints),this._skinRoots[e]=t),t}_readPrimitive(e,t,r){let s=null;if(e.extensions)for(const t of Object.keys(e.extensions)){const r=e.extensions[t];switch(t){case"KHR_draco_mesh_compression":s=this._decodeDracoGeometry(e,r)}}const n=this._getPrimitiveMode(void 0===e.mode?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:e.mode);let o;if(void 0!==e.indices){let t;if(s&&s.indices)t=s.indices;else{const r=this._gltf.accessors[e.indices];t=this._readAccessorIntoArray(r)}o=t}if(!("POSITION"in e.attributes))throw new Error("The primitive doesn't contains positions.");const i=s?s.vertices.POSITION.length/3:this._gltf.accessors[e.attributes.POSITION].count,a=new pp_geometry_1.PPGeometry(i,n,o);for(const t of Object.getOwnPropertyNames(e.attributes)){const r=this._gltf.accessors[e.attributes[t]];let n;if(s&&t in s.vertices){n=s.vertices[t]}else{n=this._readAccessorIntoArray(r)}const o=glTFAttributeNameToPP(t),i=this._getComponentsPerAttribute(r.type);a.setAttribute(o,n,i)}if(e.targets){const s=Object.getOwnPropertyNames(e.targets[0]);for(const t of s){const r=glTFAttributeNameToPP(t);if(!pp_geometry_1.PPGeometry.isStdSemantic(r)||![pp_geometry_1.PPGeometry.StdSemantics.position,pp_geometry_1.PPGeometry.StdSemantics.normal,pp_geometry_1.PPGeometry.StdSemantics.tangent].includes(r))throw new Error(`Only position, normal, tangent attribute are morph-able, but provide ${t}`);assertGlTFConformance(a.hasAttribute(r),`Primitive do not have attribute ${t} for morph.`);const s=a.getAttribute(r);s.morphs=new Array(e.targets.length);for(let r=0;r<e.targets.length;++r){const n=e.targets[r];assertGlTFConformance(t in n,"Morph attributes in all target must be same.");const o=this._gltf.accessors[n[t]],i=this._readAccessorIntoArray(o);s.morphs[r]=i}}let n=!1;a.forEachAttribute(e=>{!n&&e.morphs&&e.morphs.some(e=>e.some(e=>0!==e))&&(n=!0)}),n||this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.EmptyMorph,{mesh:t,primitive:r})}return a}_decodeDracoGeometry(e,t){const r=this._gltf.bufferViews[t.bufferView],s=this._buffers[r.buffer],n=void 0===r.byteOffset?0:r.byteOffset,o=s.slice(n,n+r.byteLength),i={buffer:new Int8Array(o),attributes:{}};void 0!==e.indices&&(i.indices=this._getAttributeBaseTypeStorage(this._gltf.accessors[e.indices].componentType));for(const r of Object.keys(t.attributes))if(r in e.attributes){const s=this._gltf.accessors[e.attributes[r]];i.attributes[r]={uniqueId:t.attributes[r],storageConstructor:this._getAttributeBaseTypeStorage(s.componentType),components:this._getComponentsPerAttribute(s.type)}}return(0,khr_draco_mesh_compression_1.decodeDracoGeometry)(i)}_readBounds(e,t,r){const s=e.attributes.POSITION;if(void 0!==s){const e=this._gltf.accessors[s];e.min&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(t.x=Math.fround(e.min[0]),t.y=Math.fround(e.min[1]),t.z=Math.fround(e.min[2])):(t.x=e.min[0],t.y=e.min[1],t.z=e.min[2])),e.max&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(r.x=Math.fround(e.max[0]),r.y=Math.fround(e.max[1]),r.z=Math.fround(e.max[2])):(r.x=e.max[0],r.y=e.max[1],r.z=e.max[2]))}}_applySettings(e,t,r,s,n,o){if(t===glTF_meta_1.NormalImportSetting.recalculate||t===glTF_meta_1.NormalImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)){const t=e.calculateNormals();e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal,t,3)}else t===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal);if(r===glTF_meta_1.TangentImportSetting.recalculate||r===glTF_meta_1.TangentImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent))if(e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal))if(e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord)){const t=e.calculateTangents();e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent,t,4)}else this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"uv",primitive:n,mesh:o});else this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"normal",primitive:n,mesh:o});else r===glTF_meta_1.TangentImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent);if(s===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)){e.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal).morphs=null}}_readBufferView(e){const t=this._buffers[e.buffer];return Buffer.from(t.buffer,t.byteOffset+(e.byteOffset||0),e.byteLength)}_readAccessorIntoArray(e){const t=new(this._getAttributeBaseTypeStorage(e.componentType))(e.count*this._getComponentsPerAttribute(e.type));return this._readAccessor(e,createDataViewFromTypedArray(t)),void 0!==e.sparse&&this._applyDeviation(e,t),t}_readAccessorIntoArrayAndNormalizeAsFloat(e){let t=this._readAccessorIntoArray(e);if(!(t instanceof Float32Array)){const e=new Float32Array(t.length),r=(()=>t instanceof Int8Array?e=>Math.max(e/127,-1):t instanceof Uint8Array?e=>e/255:t instanceof Int16Array?e=>Math.max(e/32767,-1):t instanceof Uint16Array?e=>e/65535:e=>e)();for(let s=0;s<t.length;++s)e[s]=r(t[s]);t=e}return t}_getSceneNode(e,t,r=!0){const s=this._getGltfXXName(GltfAssetKind.Scene,e),n=this._gltf.scenes[e];let o;if(n.nodes&&0!==n.nodes.length){const e=n.nodes,i=new Array(this._gltf.nodes.length).fill(null);if(1===n.nodes.length&&this._promotedRootNodes.includes(n.nodes[0])){const e=n.nodes[0];o=this._createEmptyNodeRecursive(e,i,r)}else{o=new cc.Node(s);for(const e of n.nodes){this._createEmptyNodeRecursive(e,i,r).parent=o}}i.forEach((r,s)=>{this._setupNode(s,i,t,o,e)})}else o=new cc.Node(s);return o}_createEmptyNodeRecursive(e,t,r=!0){const s=this._gltf.nodes[e],n=this._createEmptyNode(e,r);if(void 0!==s.children)for(const e of s.children){this._createEmptyNodeRecursive(e,t,r).parent=n}return t[e]=n,n}_setupNode(e,t,r,s,n){const o=t[e];if(null===o)return;const i=this._gltf.nodes[e];if(void 0!==i.mesh){let a=null;if(void 0===i.skin)a=o.addComponent(cc.MeshRenderer);else{const l=o.addComponent(cc.SkinnedMeshRenderer),c=r.find("skeletons",i.skin,cc.Skeleton);c&&(l.skeleton=c);const u=t[this._getSkinRoot(i.skin)];if(null===u){this.gltf.skins[i.skin].joints.every(e=>n.includes(this._getRootParent(e)))?l.skinningRoot=s:this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.ReferenceSkinInDifferentScene,{node:e,skin:i.skin})}else l.skinningRoot=u;a=l}const l=r.find("meshes",i.mesh,cc.Mesh);l&&(a._mesh=l);const c=this.gltf.meshes[i.mesh],u=this._processedMeshes[i.mesh].materialIndices.map(e=>{const t=c.primitives[e];if(void 0===t.material)return null;{const e=r.find("materials",t.material,cc.Material);if(e)return e}return null});a._materials=u}}_createEmptyNode(e,t=!0){const r=this._gltf.nodes[e],s=this._getGltfXXName(GltfAssetKind.Node,e),n=new cc.Node(s);if(!t)return n;if(r.translation&&n.setPosition(r.translation[0],r.translation[1],r.translation[2]),r.rotation&&n.setRotation(this._getNodeRotation(r.rotation,new cc_1.Quat)),r.scale&&n.setScale(r.scale[0],r.scale[1],r.scale[2]),r.matrix){const e=r.matrix,t=this._readNodeMatrix(e),s=new cc_1.Vec3,o=new cc_1.Quat,i=new cc_1.Vec3;cc_1.Mat4.toRTS(t,o,s,i),n.setPosition(s),n.setRotation(o),n.setScale(i)}return n}_readNodeMatrix(e){return new cc_1.Mat4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}_getNodePath(e){return this._nodePathTable[e]}_isAncestorOf(e,t){if(e!==t)for(;t>=0;){if(t===e)return!0;t=this._getParent(t)}return!1}_mapToSocketPath(e){for(const t of this._socketMappings)if(e===t[0]||e.startsWith(t[0]+"/"))return t[1]+e.slice(t[0].length);return e}_createNodePathTable(){if(void 0===this._gltf.nodes)return[];const e=new Array(this._gltf.nodes.length).fill(-1);this._gltf.nodes.forEach((t,r)=>{if(t.children){t.children.forEach(t=>{e[t]=r}),makeUniqueNames(t.children.map(e=>{let t=this._gltf.nodes[e].name;return"string"==typeof t&&0!==t.length||(t=null),t}),uniqueChildNodeNameGenerator).forEach((e,r)=>{this._gltf.nodes[t.children[r]].name=e})}});const t=new Array(this._gltf.nodes.length).fill("");for(let e=0;e<t.length;++e)t[e]=this._getGltfXXName(GltfAssetKind.Node,e);const r=new Array(this._gltf.nodes.length).fill("");return this._gltf.nodes.forEach((s,n)=>{const o=[];for(let r=n;r>=0;r=e[r])this._promotedRootNodes.includes(r)||o.unshift(t[r]);r[n]=o.join("/")}),r}_readAccessor(e,t,r=0){if(void 0===e.bufferView)return;const s=this._gltf.bufferViews[e.bufferView],n=this._getComponentsPerAttribute(e.type),o=this._getBytesPerComponent(e.componentType);0===r&&(r=n*o);const i=(void 0!==e.byteOffset?e.byteOffset:0)+(void 0!==s.byteOffset?s.byteOffset:0),a=createDataViewFromBuffer(this._buffers[s.buffer],i),l=void 0!==s.byteStride?s.byteStride:n*o,c=this._getComponentReader(e.componentType),u=this._getComponentWriter(e.componentType);for(let s=0;s<e.count;++s){const e=createDataViewFromTypedArray(a,l*s),i=createDataViewFromTypedArray(t,r*s);for(let t=0;t<n;++t){const r=o*t;u(i,r,c(e,r))}}}_applyDeviation(e,t){const{sparse:r}=e,s=this._gltf.bufferViews[r.indices.bufferView],n=this._buffers[s.buffer],o=new(this._getAttributeBaseTypeStorage(r.indices.componentType))(n.buffer,n.byteOffset+(s.byteOffset||0)+(r.indices.byteOffset||0),r.count),i=this._gltf.bufferViews[r.values.bufferView],a=this._buffers[i.buffer],l=new(this._getAttributeBaseTypeStorage(e.componentType))(a.buffer,a.byteOffset+(i.byteOffset||0)+(r.values.byteOffset||0)),c=this._getComponentsPerAttribute(e.type);for(let e=0;e<c;++e)for(let r=0;r<o.length;++r){t[c*o[r]+e]=l[c*r+e]}}_getPrimitiveMode(e){switch(void 0===e&&(e=glTF_constants_1.GltfPrimitiveMode.__DEFAULT),e){case glTF_constants_1.GltfPrimitiveMode.POINTS:return cc_1.gfx.PrimitiveMode.POINT_LIST;case glTF_constants_1.GltfPrimitiveMode.LINES:return cc_1.gfx.PrimitiveMode.LINE_LIST;case glTF_constants_1.GltfPrimitiveMode.LINE_LOOP:return cc_1.gfx.PrimitiveMode.LINE_LOOP;case glTF_constants_1.GltfPrimitiveMode.LINE_STRIP:return cc_1.gfx.PrimitiveMode.LINE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLES:return cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_STRIP:return cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_FAN:return cc_1.gfx.PrimitiveMode.TRIANGLE_FAN;default:throw new Error(`Unrecognized primitive mode: ${e}.`)}}_getAttributeBaseTypeStorage(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return Int8Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return Uint8Array;case glTF_constants_1.GltfAccessorComponentType.SHORT:return Int16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return Uint16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return Uint32Array;case glTF_constants_1.GltfAccessorComponentType.FLOAT:return Float32Array;default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentsPerAttribute(e){return(0,glTF_constants_1.getGltfAccessorTypeComponents)(e)}_getBytesPerComponent(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return 1;case glTF_constants_1.GltfAccessorComponentType.SHORT:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return 2;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:case glTF_constants_1.GltfAccessorComponentType.FLOAT:return 4;default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentReader(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t)=>e.getInt8(t);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t)=>e.getUint8(t);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t)=>e.getInt16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t)=>e.getUint16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t)=>e.getUint32(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t)=>e.getFloat32(t,DataViewUseLittleEndian);default:throw new Error(`Unrecognized component type: ${e}`)}}_getComponentWriter(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t,r)=>e.setInt8(t,r);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t,r)=>e.setUint8(t,r);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t,r)=>e.setInt16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t,r)=>e.setUint16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t,r)=>e.setUint32(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t,r)=>e.setFloat32(t,r,DataViewUseLittleEndian);default:throw new Error(`Unrecognized component type: ${e}`)}}_getGltfXXName(e,t){const r={[GltfAssetKind.Animation]:"animations",[GltfAssetKind.Image]:"images",[GltfAssetKind.Material]:"materials",[GltfAssetKind.Node]:"nodes",[GltfAssetKind.Skin]:"skins",[GltfAssetKind.Texture]:"textures",[GltfAssetKind.Scene]:"scenes"},s=this._gltf[r[e]];if(!s)return"";const n=s[t];return"string"==typeof n.name?n.name:`${GltfAssetKind[e]}-${t}`}_normalizeArrayToCocosColor(e){let t=1;Math.max(...e)>1&&(t=Math.max(...e));const r=e.map(e=>(0,color_utils_1.linearToSrgb8Bit)(e/t));3===r.length&&r.push(255);const s=new cc.Color(r[0],r[1],r[2],r[3]);return[t,s]}_convertAdskPhysicalMaterial(e,t,r,s,n){var o,i,a,l,c,u,_,d,f,m,p,g,h;const x={},v={},{Parameters:A}=n.properties["3dsMax"],T=null!==(o=A.base_color)&&void 0!==o?o:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color;v.mainColor=cc.Vec4.set(new cc.Color,T[0],T[1],T[2],T[3]);const S=null!==(i=A.basic_weight)&&void 0!==i?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.basic_weight;v.albedoScale=new cc.Vec3(S,S,S);const M=null!==(a=A.base_color_map_on)&&void 0!==a?a:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color_map_on,E=A.base_color_map;M&&E&&(x.USE_ALBEDO_MAP=!0,v.mainTexture=null!==(l=r.find("textures",E.index,cc.Texture2D))&&void 0!==l?l:void 0,1===E.texCoord&&(x.ALBEDO_UV="v_uv1"),hasKHRTextureTransformExtension(E)&&(v.tilingOffset=this._khrTextureTransformToTiling(E.extensions.KHR_texture_transform)));const y=null!==(c=A.metalness)&&void 0!==c?c:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness;v.metallic=y;const b=null!==(u=A.roughness)&&void 0!==u?u:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness,I=null!==(_=A.roughness_inv)&&void 0!==_?_:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_inv;v.roughness=I?1-b:b;null!==(d=A.metalness_map_on)&&void 0!==d||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness_map_on,A.metalness_map,null!==(f=A.roughness_map_on)&&void 0!==f||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_map_on,A.roughness_map;const P=null!==(m=A.emission)&&void 0!==m?m:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emission,C=null!==(p=A.emit_color)&&void 0!==p?p:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color;v.emissive=new cc_1.Vec4(C[0]*P,C[1]*P,C[2]*P,C[3]*P);const N=null!==(g=A.emit_color_map_on)&&void 0!==g?g:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color_map_on,F=A.emit_color_map;N&&F&&(x.USE_EMISSIVE_MAP=!0,v.emissiveMap=null!==(h=r.find("textures",F.index,cc.Texture2D))&&void 0!==h?h:void 0,1===F.texCoord&&(x.EMISSIVE_UV="v_uv1"));const G=new cc.Material;return G.name=this._getGltfXXName(GltfAssetKind.Material,t),G._effectAsset=s("db://internal/effects/builtin-standard.effect"),G._defines=[x],G._props=[v],G._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],G}_convertMaxPhysicalMaterial(e,t,r,s){var n,o,i,a,l,c,u,_;const d={},f={};s.base_color_map&&!this.fbxMissingImagesId.includes(s.base_color_map.value.index)&&(d.USE_ALBEDO_MAP=!0,f.mainTexture=null!==(n=t.find("textures",s.base_color_map.value.index,cc.Texture2D))&&void 0!==n?n:void 0),f.mainColor=this._normalizeArrayToCocosColor(s.base_color.value)[1],s.base_weight_map&&!this.fbxMissingImagesId.includes(s.base_weight_map.value.index)&&(d.USE_WEIGHT_MAP=!0,f.baseWeightMap=null!==(o=t.find("textures",s.base_weight_map.value.index,cc.Texture2D))&&void 0!==o?o:void 0),f.albedoScale=s.base_weight.value,s.metalness_map&&!this.fbxMissingImagesId.includes(s.metalness_map.value.index)&&(d.USE_METALLIC_MAP=!0,f.metallicMap=null!==(i=t.find("textures",s.metalness_map.value.index,cc.Texture2D))&&void 0!==i?i:void 0),f.metallic=s.metalness.value,s.roughness_map&&!this.fbxMissingImagesId.includes(s.roughness_map.value.index)&&(d.USE_ROUGHNESS_MAP=!0,f.roughnessMap=null!==(a=t.find("textures",s.roughness_map.value.index,cc.Texture2D))&&void 0!==a?a:void 0),f.roughness=s.roughness.value,s.bump_map&&!this.fbxMissingImagesId.includes(s.bump_map.value.index)&&(d.USE_NORMAL_MAP=!0,f.normalMap=null!==(l=t.find("textures",s.bump_map.value.index,cc.Texture2D))&&void 0!==l?l:void 0),s.emission_map&&!this.fbxMissingImagesId.includes(s.emission_map.value.index)&&(d.USE_EMISSIVESCALE_MAP=!0,f.emissiveScaleMap=null!==(c=t.find("textures",s.emission_map.value.index,cc.Texture2D))&&void 0!==c?c:void 0),f.emissiveScale=s.emission.value,s.emit_color_map&&!this.fbxMissingImagesId.includes(s.emit_color_map.value.index)&&(d.USE_EMISSIVE_MAP=!0,f.emissiveMap=null!==(u=t.find("textures",s.emit_color_map.value.index,cc.Texture2D))&&void 0!==u?u:void 0),f.emissive=this._normalizeArrayToCocosColor(s.emit_color.value)[1],f.alphaSource=1;let m=0;s.cutout_map&&(m=1,d.USE_ALPHA_TEST=!1,d.USE_OPACITY_MAP=!0,f.alphaSourceMap=null!==(_=t.find("textures",s.cutout_map.value.index,cc.Texture2D))&&void 0!==_?_:void 0);const p=new cc.Material;return p.name=this._getGltfXXName(GltfAssetKind.Material,e),p._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),p._defines=[d],p._props=[f],p._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],setTechniqueIndex(p,m),p}_convertMayaStandardSurface(e,t,r,s){var n,o,i,a,l,c,u,_;const d={},f={};s.base.texture&&!this.fbxMissingImagesId.includes(s.base.texture.index)&&(d.USE_WEIGHT_MAP=!0,f.baseWeightMap=null!==(n=t.find("textures",s.base.texture.index,cc.Texture2D))&&void 0!==n?n:void 0),f.albedoScale=s.base.value,s.baseColor.texture&&!this.fbxMissingImagesId.includes(s.baseColor.texture.index)&&(d.USE_ALBEDO_MAP=!0,f.mainTexture=null!==(o=t.find("textures",s.baseColor.texture.index,cc.Texture2D))&&void 0!==o?o:void 0),f.mainColor=this._normalizeArrayToCocosColor(s.baseColor.value)[1],s.metalness.texture&&!this.fbxMissingImagesId.includes(s.metalness.texture.index)&&(d.USE_METALLIC_MAP=!0,f.metallicMap=null!==(i=t.find("textures",s.metalness.texture.index,cc.Texture2D))&&void 0!==i?i:void 0),f.metallic=s.metalness.value,s.specularRoughness.texture&&!this.fbxMissingImagesId.includes(s.specularRoughness.texture.index)&&(d.USE_ROUGHNESS_MAP=!0,f.roughnessMap=null!==(a=t.find("textures",s.specularRoughness.texture.index,cc.Texture2D))&&void 0!==a?a:void 0),f.roughness=s.specularRoughness.value,f.specularIntensity=.5*Math.max(...s.specularColor.value),void 0===s.normalCamera.texture||this.fbxMissingImagesId.includes(s.normalCamera.texture.index)||(d.USE_NORMAL_MAP=!0,f.normalMap=null!==(l=t.find("textures",s.normalCamera.texture.index,cc.Texture2D))&&void 0!==l?l:void 0),void 0===s.emission.texture||this.fbxMissingImagesId.includes(s.emission.texture.index)||(d.USE_EMISSIVESCALE_MAP=!0,f.emissiveScaleMap=null!==(c=t.find("textures",s.emission.texture.index,cc.Texture2D))&&void 0!==c?c:void 0),f.emissiveScale=s.emission.value,void 0===s.emissionColor.texture||this.fbxMissingImagesId.includes(s.emissionColor.texture.index)||(d.USE_EMISSIVE_MAP=!0,f.emissiveMap=null!==(u=t.find("textures",s.emissionColor.texture.index,cc.Texture2D))&&void 0!==u?u:void 0),f.emissive=this._normalizeArrayToCocosColor(s.emissionColor.value)[1],s.opacity.texture&&!this.fbxMissingImagesId.includes(s.opacity.texture.index)?(d.USE_ALPHA_TEST=!1,d.USE_OPACITY_MAP=!0,f.alphaSourceMap=null!==(_=t.find("textures",s.opacity.texture.index,cc.Texture2D))&&void 0!==_?_:void 0):Math.max(...s.opacity.value)<.99&&(f.alphaSource=Math.max(...s.opacity.value));const m=new cc.Material;return m.name=this._getGltfXXName(GltfAssetKind.Material,e),m._effectAsset=r("db://internal/effects/util/dcc/imported-metallic-roughness.effect"),m._defines=[d],m._props=[f],m._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],m}_convertPhongMaterial(e,t,r,s,n){var o,i,a,l,c,u,_,d,f,m;const p={},g={};let h=0,x=255;if(void 0===n.transparentColor.texture||this.fbxMissingImagesId.includes(n.transparentColor.texture.index)){if(n.transparencyFactor){const t=(n.transparentColor.value[0]+n.transparentColor.value[1]+n.transparentColor.value[2])/3;n.transparentColor.value[0]===n.transparentColor.value[1]&&n.transparentColor.value[0]===n.transparentColor.value[2]||console.warn(`Material ${this._getGltfXXName(GltfAssetKind.Material,e)} : Transparent color property is not supported, average value would be used.`),0!==n.transparencyFactor.value*t&&(h=1,x=(0,color_utils_1.linearToSrgb8Bit)(1-n.transparencyFactor.value*t))}}else p.USE_ALPHA_TEST=!1,p.USE_TRANSPARENCY_MAP=!0,g.transparencyMap=null!==(o=t.find("textures",n.transparentColor.texture.index,cc.Texture2D))&&void 0!==o?o:void 0,h=1;if(n.diffuse){const e=this._normalizeArrayToCocosColor(n.diffuse.value);g.albedoScale=n.diffuseFactor.value*e[0],e[1].a=x,g.mainColor=e[1],void 0===n.diffuse.texture||this.fbxMissingImagesId.includes(n.diffuse.texture.index)||(p.USE_ALBEDO_MAP=!0,g.mainTexture=null!==(i=t.find("textures",n.diffuse.texture.index,cc.Texture2D))&&void 0!==i?i:void 0)}if(n.specular){const e=this._normalizeArrayToCocosColor(n.specular.value);g.specularFactor=n.specularFactor.value*e[0],g.specularColor=e[1],void 0===n.specular.texture||this.fbxMissingImagesId.includes(n.specular.texture.index)||(p.USE_SPECULAR_MAP=!0,g.specularMap=null!==(a=t.find("textures",n.specular.texture.index,cc.Texture2D))&&void 0!==a?a:void 0)}if(void 0===(null===(l=n.normalMap)||void 0===l?void 0:l.texture)||this.fbxMissingImagesId.includes(n.normalMap.texture.index)?void 0!==(null===(u=n.bump)||void 0===u?void 0:u.texture)&&(p.USE_NORMAL_MAP=!0,g.normalMap=null!==(_=t.find("textures",n.bump.texture.index,cc.Texture2D))&&void 0!==_?_:void 0):(p.USE_NORMAL_MAP=!0,g.normalMap=null!==(c=t.find("textures",n.normalMap.texture.index,cc.Texture2D))&&void 0!==c?c:void 0),n.shininess&&(g.shininessExponent=n.shininess.value,void 0===n.shininess.texture||this.fbxMissingImagesId.includes(n.shininess.texture.index)||(p.USE_SHININESS_MAP=!0,g.shininessExponentMap=null!==(d=t.find("textures",n.shininess.texture.index,cc.Texture2D))&&void 0!==d?d:void 0)),n.emissive){const e=this._normalizeArrayToCocosColor(n.emissive.value);g.emissiveScale=n.emissiveFactor.value*e[0],g.emissive=e[1],void 0===n.emissive.texture||this.fbxMissingImagesId.includes(n.emissive.texture.index)||(p.USE_EMISSIVE_MAP=!0,g.emissiveMap=null!==(f=t.find("textures",n.emissive.texture.index,cc.Texture2D))&&void 0!==f?f:void 0),void 0===n.emissiveFactor.texture||this.fbxMissingImagesId.includes(n.emissiveFactor.texture.index)||(p.USE_EMISSIVESCALE_MAP=!0,g.emissiveScaleMap=null!==(m=t.find("textures",n.emissiveFactor.texture.index,cc.Texture2D))&&void 0!==m?m:void 0)}p.DCC_APP_NAME=s;const v=new cc.Material;return v.name=this._getGltfXXName(GltfAssetKind.Material,e),setTechniqueIndex(v,h),v._effectAsset=r("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),v._defines=[p],v._props=[g],v._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],v}_convertBlenderPBRMaterial(e,t,r,s){var n,o,i,a,l,c,u,_,d;const f={},m={},p=e.extras["FBX-glTF-conv"].raw.properties;if(f.DCC_APP_NAME=2,f.HAS_EXPORTED_METALLIC=!0,p.diffuse){const e=this._normalizeArrayToCocosColor(p.diffuse.value);m.mainColor=e[1],void 0===p.diffuse.texture||this.fbxMissingImagesId.includes(p.diffuse.texture.index)||(f.USE_ALBEDO_MAP=!0,m.mainTexture=null!==(n=r.find("textures",p.diffuse.texture.index,cc.Texture2D))&&void 0!==n?n:void 0)}if(void 0===(null===(o=p.bump)||void 0===o?void 0:o.texture)||this.fbxMissingImagesId.includes(p.bump.texture.index)||(f.USE_NORMAL_MAP=!0,m.normalMap=null!==(i=r.find("textures",p.bump.texture.index,cc.Texture2D))&&void 0!==i?i:void 0),p.shininess&&(m.shininessExponent=p.shininess.value,void 0===p.shininess.texture||this.fbxMissingImagesId.includes(p.shininess.texture.index)||(f.USE_SHININESS_MAP=!0,m.shininessExponentMap=null!==(a=r.find("textures",p.shininess.texture.index,cc.Texture2D))&&void 0!==a?a:void 0)),p.emissive){const e=this._normalizeArrayToCocosColor(p.emissive.value);m.emissiveScale=p.emissiveFactor.value*e[0],m.emissive=e[1],void 0===p.emissive.texture||this.fbxMissingImagesId.includes(p.emissive.texture.index)||(f.USE_EMISSIVE_MAP=!0,m.emissiveMap=null!==(l=r.find("textures",p.emissive.texture.index,cc.Texture2D))&&void 0!==l?l:void 0),void 0===p.emissiveFactor.texture||this.fbxMissingImagesId.includes(p.emissiveFactor.texture.index)||(f.USE_EMISSIVESCALE_MAP=!0,m.emissiveScaleMap=null!==(c=r.find("textures",p.emissiveFactor.texture.index,cc.Texture2D))&&void 0!==c?c:void 0)}p.reflectionFactor&&(m.metallic=p.reflectionFactor.value,void 0===p.reflectionFactor.texture||this.fbxMissingImagesId.includes(p.reflectionFactor.texture.index)||(f.USE_METALLIC_MAP=!0,m.metallicMap=null!==(u=r.find("textures",p.reflectionFactor.texture.index,cc.Texture2D))&&void 0!==u?u:void 0)),p.specularFactor&&(void 0===p.specularFactor.texture||this.fbxMissingImagesId.includes(p.specularFactor.texture.index)?m.specularFactor=p.specularFactor.value:(f.USE_SPECULAR_MAP=!0,m.specularMap=null!==(_=r.find("textures",p.specularFactor.texture.index,cc.Texture2D))&&void 0!==_?_:void 0)),p.transparencyFactor&&(void 0===p.transparencyFactor.texture||this.fbxMissingImagesId.includes(p.transparencyFactor.texture.index)?m.transparencyFactor=p.transparencyFactor.value:(f.USE_ALPHA_TEST=!1,f.USE_TRANSPARENCY_MAP=!0,m.transparencyMap=null!==(d=r.find("textures",p.transparencyFactor.texture.index,cc.Texture2D))&&void 0!==d?d:void 0));const g=new cc.Material;return g.name=this._getGltfXXName(GltfAssetKind.Material,t),g._effectAsset=s("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),g._defines=[f],g._props=[m],g._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],g}_convertGltfPbrSpecularGlossiness(e,t,r,s,n){var o,i;const a={},l={},c={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}},u=e.extensions.KHR_materials_pbrSpecularGlossiness;if(a.DCC_APP_NAME=4,u.diffuseFactor){const e=this._normalizeArrayToCocosColor(u.diffuseFactor);l.mainColor=e[1]}if(void 0!==u.diffuseTexture&&(a.USE_ALBEDO_MAP=!0,l.mainTexture=null!==(o=r.find("textures",u.diffuseTexture.index,cc.Texture2D))&&void 0!==o?o:void 0),u.specularFactor){const e=this._normalizeArrayToCocosColor(u.specularFactor);l.specularColor=e[1]}if(u.glossinessFactor&&(a.HAS_EXPORTED_GLOSSINESS=!0,l.glossiness=u.glossinessFactor),void 0!==u.specularGlossinessTexture&&(a.HAS_EXPORTED_GLOSSINESS=!0,a.USE_SPECULAR_GLOSSINESS_MAP=!0,l.specularGlossinessMap=null!==(i=r.find("textures",u.specularGlossinessTexture.index,cc.Texture2D))&&void 0!==i?i:void 0),void 0!==e.normalTexture){const t=e.normalTexture;void 0!==t.index&&(a.USE_NORMAL_MAP=!0,l.normalMap=r.find("textures",t.index,cc.Texture2D))}if(void 0!==e.emissiveTexture&&(a.USE_EMISSIVE_MAP=!0,e.emissiveTexture.texCoord&&(a.EMISSIVE_UV="v_uv1"),l.emissiveMap=r.find("textures",e.emissiveTexture.index,cc.Texture2D)),void 0!==e.emissiveFactor){const t=e.emissiveFactor;l.emissive=this._normalizeArrayToCocosColor(t)[1]}switch(e.doubleSided&&(c.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),e.alphaMode){case"BLEND":{const e=c.blendState.targets[0];e.blend=!0,e.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,e.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,e.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,c.depthStencilState.depthWrite=n;break}case"MASK":{const t=void 0===e.alphaCutoff?.5:e.alphaCutoff;a.USE_ALPHA_TEST=!0,l.alphaThreshold=t;break}case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:e.alphaMode,material:t})}const _=new cc.Material;return _.name=this._getGltfXXName(GltfAssetKind.Material,t),_._effectAsset=s("db://internal/effects/util/dcc/imported-specular-glossiness.effect"),_._defines=[a],_._props=[l],_._states=[c],_}_khrTextureTransformToTiling(e){const t=new cc_1.Vec4(1,1,0,0);return e.scale&&(t.x=e.scale[0],t.y=e.scale[1]),e.offset&&(t.z=e.offset[0],t.w=e.offset[1]),t}}function hasKHRTextureTransformExtension(e){const{extensions:t}=e;return"object"==typeof t&&null!==t&&"object"==typeof t.KHR_texture_transform}function setTechniqueIndex(e,t){e._techIdx=t}async function readGltf(e){return".glb"===path.extname(e)?await readGlb(e):await readGltfJson(e)}async function readGltfJson(e){const t=await fs.readJSON(e);return{glTF:t,buffers:t.buffers?t.buffers.map(t=>t.uri?resolveBufferUri(e,t.uri):Buffer.alloc(0)):[]}}async function readGlb(e){const t=()=>{throw new Error("Bad glb format.")},r=await fs.readFile(e);if(r.length<12)return t();if(1179937895!==r.readUInt32LE(0))return t();r.readUInt32LE(4),r.readUInt32LE(8);let s,n;for(let e=0,o=12;o+8<=r.length;++e){const i=r.readUInt32LE(o);o+=4;const a=r.readUInt32LE(o);if((o+=4)+i>r.length)return t();const l=Buffer.from(r.buffer,o,i);if(o+=i,0===e){if(1313821514!==a)return t();const e=new TextDecoder("utf-8").decode(l);s=JSON.parse(e)}else 5130562===a&&(n=l)}if(s){return{glTF:s,buffers:s.buffers?s.buffers.map((t,r)=>t.uri?resolveBufferUri(e,t.uri):0===r&&n?n:Buffer.alloc(0)):[]}}return t()}function resolveBufferUri(e,t){const r=DataURI.parse(t);if(r)return Buffer.from(resolveBufferDataURI(r));return path.resolve(path.dirname(e),t)}function isDataUri(e){return e.startsWith("data:")}exports.GltfConverter=GltfConverter,GltfConverter._defaultLogger=((e,t,r)=>{const s=JSON.stringify({error:t,arguments:r},void 0,4);switch(e){case GltfConverter.LogLevel.Info:console.log(s);break;case GltfConverter.LogLevel.Warning:console.warn(s);break;case GltfConverter.LogLevel.Error:console.error(s);break;case GltfConverter.LogLevel.Debug:console.debug(s)}}),function(e){let t,r;!function(e){e[e.Info=0]="Info",e[e.Warning=1]="Warning",e[e.Error=2]="Error",e[e.Debug=3]="Debug"}(t=e.LogLevel||(e.LogLevel={})),function(e){e[e.ReferenceSkinInDifferentScene=0]="ReferenceSkinInDifferentScene",e[e.UnsupportedAlphaMode=1]="UnsupportedAlphaMode",e[e.UnsupportedTextureParameter=2]="UnsupportedTextureParameter",e[e.UnsupportedChannelPath=3]="UnsupportedChannelPath",e[e.DisallowCubicSplineChannelSplit=4]="DisallowCubicSplineChannelSplit",e[e.FailedToCalculateTangents=5]="FailedToCalculateTangents",e[e.EmptyMorph=6]="EmptyMorph",e[e.UnsupportedExtension=7]="UnsupportedExtension"}(r=e.ConverterError||(e.ConverterError={}))}(GltfConverter=exports.GltfConverter||(exports.GltfConverter={})),exports.readGltf=readGltf,exports.isDataUri=isDataUri;class BufferBlob{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){if(0!==e){const t=this._length%e;if(0!==t){const r=e-t;this._arrayBufferOrPaddings.push(r),this._length+=r}}}addBuffer(e){const t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const e=new Uint8Array(this._length);let t=0;return this._arrayBufferOrPaddings.forEach(r=>{"number"==typeof r?t+=r:(e.set(new Uint8Array(r),t),t+=r.byteLength)}),e}}function createDataViewFromBuffer(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}function createDataViewFromTypedArray(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}exports.BufferBlob=BufferBlob;const DataViewUseLittleEndian=!0;function uniqueChildNodeNameGenerator(e,t,r,s){return`${e||""}(__autogen ${r}${0===s?"":`-${s}`})`}function makeUniqueNames(e,t){const r=new Array(e.length).fill("");for(let s=0;s<e.length;++s){let n=e[s],o=0;for(;;){if(null!==n&&(()=>r.every((e,t)=>t===s||n!==e))()){r[s]=n;break}n=t(e[s],n,s,o++)}}return r}function resolveBufferDataURI(e){if(!e.base64||!e.mediaType||"application/octet-stream"!==e.mediaType.value&&"application/gltf-buffer"!==e.mediaType.value)throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for buffer.`);return(0,base64_1.decodeBase64ToArrayBuffer)(e.data)}class DynamicArrayBuffer{get arrayBuffer(){return this._arrayBuffer}constructor(e){this._size=0,this._arrayBuffer=new ArrayBuffer(Math.max(e||0,4))}grow(e){const t=this._size;if(e){const r=this._arrayBuffer.byteLength,s=r-t-e;if(s<0){const e=new ArrayBuffer(1.5*(r+-s));new Uint8Array(e,0,r).set(new Uint8Array(this._arrayBuffer)),this._arrayBuffer=e}this._size+=e}return t}shrink(){return this._arrayBuffer.slice(0,this._size)}}function getDataviewWritterOfTypedArray(e,t){switch(e.constructor){case Int8Array:return(e,t,r)=>e.setInt8(t,r);case Uint8Array:return(e,t,r)=>e.setUint8(t,r);case Int16Array:return(e,r,s)=>e.setInt16(r,s,t);case Uint16Array:return(e,r,s)=>e.setUint16(r,s,t);case Int32Array:return(e,r,s)=>e.setInt32(r,s,t);case Uint32Array:return(e,r,s)=>e.setUint32(r,s,t);case Float32Array:return(e,r,s)=>e.setFloat32(r,s,t);default:throw new Error("Bad storage constructor.")}}function interleaveVertices(e,t=!1,r=!1){const s=e.vertexCount;let n=!1,o=!1;const i=[];for(const t of e.attributes()){let e;try{(e=(0,pp_geometry_1.getGfxAttributeName)(t))===cc_1.gfx.AttributeName.ATTR_TEX_COORD1&&(n=!0),e===cc_1.gfx.AttributeName.ATTR_COLOR&&(o=!0)}catch(e){console.error(e);continue}i.push([e,t])}if(r&&!o){const e=new cc_1.Vec4(1,1,1,1),t=new Float32Array(4*s);for(let r=0;r<s;++r)t[4*r+0]=e.x,t[4*r+1]=e.y,t[4*r+2]=e.z,t[4*r+3]=e.w;i.push(["a_color",new pp_geometry_1.PPGeometry.Attribute(pp_geometry_1.PPGeometry.StdSemantics.color,t,4)])}t&&!n&&i.push(["a_texCoord1",new pp_geometry_1.PPGeometry.Attribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord,new Float32Array(2*s),2)]);let a=0;for(const[e,t]of i)a+=t.data.BYTES_PER_ELEMENT*t.components;const l=new ArrayBuffer(s*a),c=new DataView(l);let u=0;const _=[];for(const[e,t]of i){const r=t.data,n=getDataviewWritterOfTypedArray(r,DataViewUseLittleEndian);for(let e=0;e<s;++e){const s=u+a*e;for(let o=0;o<t.components;++o){const i=r[t.components*e+o];n(c,s+r.BYTES_PER_ELEMENT*o,i)}}u+=t.data.BYTES_PER_ELEMENT*t.components,_.push({name:e,format:t.getGFXFormat(),isNormalized:t.isNormalized})}return{vertexCount:s,vertexStride:a,formats:_,vertexBuffer:l}}const glTFAttributeNameToPP=(()=>e=>{if(e.startsWith("_"))return e;const t=/([a-zA-Z]+)(?:_(\d+))?/g.exec(e);if(!t)return e;const r=t[1];let s;const n=parseInt(t[2]||"0");switch(r){case"POSITION":s=pp_geometry_1.PPGeometry.StdSemantics.position;break;case"NORMAL":s=pp_geometry_1.PPGeometry.StdSemantics.normal;break;case"TANGENT":s=pp_geometry_1.PPGeometry.StdSemantics.tangent;break;case"COLOR":s=pp_geometry_1.PPGeometry.StdSemantics.color;break;case"TEXCOORD":s=pp_geometry_1.PPGeometry.StdSemantics.texcoord;break;case"JOINTS":s=pp_geometry_1.PPGeometry.StdSemantics.joints;break;case"WEIGHTS":s=pp_geometry_1.PPGeometry.StdSemantics.weights}return void 0===s?e:pp_geometry_1.PPGeometry.StdSemantics.set(s,n)})();class GlTfConformanceError extends Error{}function assertGlTFConformance(e,t){if(!e)throw new GlTfConformanceError(`glTF non-conformance error: ${t}`)}exports.GlTfConformanceError=GlTfConformanceError;