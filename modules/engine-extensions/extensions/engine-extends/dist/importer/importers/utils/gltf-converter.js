"use strict";var GltfAssetKind,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlTfConformanceError=exports.isDataUri=exports.readGltf=exports.GltfConverter=exports.doCreateSocket=exports.getWorldTransformUntilRoot=exports.getPathFromRoot=exports.isFilesystemPath=void 0;const DataURI=__importStar(require("@cocos/data-uri")),cc=__importStar(require("cc")),cc_1=require("cc"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),glTF_meta_1=require("../../meta-schemas/glTF.meta"),texture_base_1=require("../texture-base"),base64_1=require("./base64"),glTF_constants_1=require("./glTF.constants"),khr_draco_mesh_compression_1=require("./khr-draco-mesh-compression"),pp_geometry_1=require("./pp-geometry"),extras_1=require("@editor/fbx-gltf-conv/lib/extras"),exotic_animation_1=require("cc/editor/exotic-animation"),glTF_animation_utils_1=require("./glTF-animation-utils");function isFilesystemPath(e){return!e.isDataUri}function getPathFromRoot(e,t){let r=e,n="";for(;null!==r&&r!==t;)n=r.name+"/"+n,r=r.parent;return n.slice(0,-1)}function getWorldTransformUntilRoot(e,t,r,n,s){for(cc_1.Vec3.set(r,0,0,0),cc_1.Quat.set(n,0,0,0,1),cc_1.Vec3.set(s,1,1,1);e!==t;)cc_1.Vec3.multiply(r,r,e.scale),cc_1.Vec3.transformQuat(r,r,e.rotation),cc_1.Vec3.add(r,r,e.position),cc_1.Quat.multiply(n,e.rotation,n),cc_1.Vec3.multiply(s,e.scale,s),e=e.parent}exports.isFilesystemPath=isFilesystemPath,exports.getPathFromRoot=getPathFromRoot,exports.getWorldTransformUntilRoot=getWorldTransformUntilRoot,function(e){e[e.Node=0]="Node",e[e.Mesh=1]="Mesh",e[e.Texture=2]="Texture",e[e.Skin=3]="Skin",e[e.Animation=4]="Animation",e[e.Image=5]="Image",e[e.Material=6]="Material",e[e.Scene=7]="Scene"}(GltfAssetKind=GltfAssetKind||{});const qt=new cc_1.Quat,v3a=new cc_1.Vec3,v3b=new cc_1.Vec3,v3Min=new cc_1.Vec3,v3Max=new cc_1.Vec3;function doCreateSocket(t,r,n){const s=getPathFromRoot(n.parent,t);if(n.parent!==t){let e=r.find(e=>e.path===s);var a;e||((a=new cc.Node).name=n.parent.name+" Socket",a.parent=t,getWorldTransformUntilRoot(n.parent,t,v3a,qt,v3b),a.setPosition(v3a),a.setRotation(qt),a.setScale(v3b),e=new cc.SkeletalAnimation.Socket(s,a),r.push(e)),n.parent=e.target}}exports.doCreateSocket=doCreateSocket;const skinRootNotCalculated=-2,skinRootAbsent=-1,supportedExtensions=new Set(["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_materials_unlit","KHR_texture_transform"]);class GltfConverter{constructor(e,t,r,n){this._gltf=e,this._buffers=t,this._gltfFilePath=r,this._promotedRootNodes=[],this._parents=[],this._skinRoots=[],this._processedMeshes=[],this._socketMappings=new Map,this._logger=(n=n||{}).logger||GltfConverter._defaultLogger,null!=(e=this._gltf.extensionsRequired)&&e.forEach(e=>this._warnIfExtensionNotSupported(e,!0)),null!=(t=this._gltf.extensionsUsed)&&t.forEach(e=>{var t;null!=(t=this._gltf.extensionsRequired)&&t.includes(e)||this._warnIfExtensionNotSupported(e,!1)}),n.promoteSingleRootNode&&this._promoteSingleRootNodes(),void 0!==this._gltf.nodes&&(this._parents=new Array(this._gltf.nodes.length).fill(-1),this._gltf.nodes.forEach((e,t)=>{if(void 0!==e.children)for(const r of e.children)this._parents[r]=t})),this._gltf.skins&&(this._skinRoots=new Array(this._gltf.skins.length).fill(skinRootNotCalculated)),this._nodePathTable=this._createNodePathTable();var s=n.userData||{};if(this._gltf.meshes){const d=null!=(r=s.normals)?r:glTF_meta_1.NormalImportSetting.require,m=null!=(e=s.tangents)?e:glTF_meta_1.TangentImportSetting.require,p=null!=(t=s.morphNormals)?t:glTF_meta_1.NormalImportSetting.exclude;for(let n=0;n<this._gltf.meshes.length;n++){var a=this._gltf.meshes[n];const h=new cc_1.Vec3(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),g=new cc_1.Vec3(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);var{geometries:a,materialIndices:o,jointMaps:i}=pp_geometry_1.PPGeometry.skinningProcess(a.primitives.map((e,t)=>{var r=this._readPrimitive(e,n,t);return r.reduceJointInfluences(),this._applySettings(r,d,m,p,t,n),this._readBounds(e,v3Min,v3Max),cc_1.Vec3.min(h,h,v3Min),cc_1.Vec3.max(g,g,v3Max),r.sanityCheck(),r}),s.disableMeshSplit);this._processedMeshes.push({geometries:a,materialIndices:o,jointMaps:i,minPosition:h,maxPosition:g})}}if(this._gltf.nodes&&this._gltf.skins){var l=this._gltf.nodes,c=[];for(let e=0;e<l.length;e++){var _=l[e];void 0!==_.mesh&&void 0===_.skin&&c.push(e)}for(let e=0;e<c.length;e++){const T=c[e];c.some(e=>this._isAncestorOf(e,T))&&(c[e]=c[c.length-1],c.length--,e--)}for(let e=0;e<c.length;e++){var u=c[e],f=l[this._getParent(u)];f&&this._socketMappings.set(this._getNodePath(u),f.name+" Socket/"+l[u].name)}}}get gltf(){return this._gltf}get path(){return this._gltfFilePath}get processedMeshes(){return this._processedMeshes}createMesh(e){var t=this._processedMeshes[e],r=this._gltf.meshes[e];const o=new BufferBlob,i=new Array;var n={primitives:t.geometries.map((e,t)=>{var{vertexCount:r,vertexStride:n,formats:s,vertexBuffer:a}=interleaveVertices(e),r=(o.setNextAlignment(0),i.push({view:{offset:o.getLength(),length:a.byteLength,count:r,stride:n},attributes:s}),o.addBuffer(a),{primitiveMode:e.primitiveMode,jointMapIndex:e.jointMapIndex,vertexBundelIndices:[t]});return void 0!==e.indices&&(n=e.indices,o.setNextAlignment(n.BYTES_PER_ELEMENT),r.indexView={offset:o.getLength(),length:n.byteLength,count:n.length,stride:n.BYTES_PER_ELEMENT},o.addBuffer(n.buffer)),r}),vertexBundles:i,minPosition:t.minPosition,maxPosition:t.maxPosition,jointMaps:t.jointMaps};{var t=t.geometries.map(e=>{let t=0;const n=[];if(e.forEachAttribute(e=>{if(e.morphs){if(0===t)t=e.morphs.length;else if(t!==e.morphs.length)throw new Error("Bad morph...");n.push(e)}}),0===t)return null;var s=new Array(t);for(let r=0;r<t;++r)s[r]={displacements:n.map(e=>{var e=e.morphs[r],t=(o.setNextAlignment(e.BYTES_PER_ELEMENT),o.getLength());return o.addBuffer(e.buffer),{offset:t,length:e.byteLength,stride:e.BYTES_PER_ELEMENT,count:e.length}})};return{attributes:n.map(e=>pp_geometry_1.getGfxAttributeName(e)),targets:s}});const s=t.find(e=>null!==e);s&&(assertGlTFConformance(t.every(e=>!e||e.targets.length===s.targets.length),"glTF expects that every primitive has same number of targets"),0!==t.length&&assertGlTFConformance(void 0===r.weights||r.weights.length===s.targets.length,'Number of "weights" mismatch number of morph targets'),n.morph={subMeshMorphs:t,weights:r.weights},"object"==typeof r.extras)&&Array.isArray(r.extras.targetNames)&&(t=r.extras.targetNames).length===s.targets.length&&t.every(e=>"string"==typeof e)&&(n.morph.targetNames=t.slice())}r=new cc.Mesh;return r.name=this._getGltfXXName(GltfAssetKind.Mesh,e),r.assign(n,o.getCombined()),r.hash,r}createSkeleton(e,t){var r=this._gltf.skins[e],n=new cc.Skeleton;if(n.name=this._getGltfXXName(GltfAssetKind.Skin,e),n._joints=r.joints.map(e=>this._mapToSocketPath(this._getNodePath(e))),void 0!==r.inverseBindMatrices){e=this._gltf.accessors[r.inverseBindMatrices];if(e.componentType!==WebGLRenderingContext.FLOAT||"MAT4"!==e.type)throw new Error("The inverse bind matrix should be floating-point 4x4 matrix.");var s=new Array(r.joints.length),a=new Float32Array(16*s.length);this._readAccessor(e,createDataViewFromTypedArray(a)),assertGlTFConformance(a.length===16*s.length,"Wrong data in bind-poses accessor.");for(let e=0;e<s.length;++e)s[e]=new cc_1.Mat4(a[16*e+0],a[16*e+1],a[16*e+2],a[16*e+3],a[16*e+4],a[16*e+5],a[16*e+6],a[16*e+7],a[16*e+8],a[16*e+9],a[16*e+10],a[16*e+11],a[16*e+12],a[16*e+13],a[16*e+14],a[16*e+15]);n._bindposes=s}return n.hash,n}getAnimationDuration(e){const t=this._gltf.animations[e];let r=0;return t.channels.forEach(e=>{void 0!==e.target.node&&(e=t.samplers[e.sampler],e=void 0!==(e=this._gltf.accessors[e.input]).max&&1===e.max.length?Math.fround(e.max[0]):0,r=Math.max(e,r))}),r}createAnimation(e){const s=this._gltf.animations[e],t=new glTF_animation_utils_1.GlTFTrsAnimationData,a=e=>{e=this._mapToSocketPath(this._getNodePath(e));return t.addNodeAnimation(e)};let o=0;const i=new Array,n=new Map,l=e=>{let t=n.get(e);var r;return void 0===t&&(r=this._gltf.accessors[e],r=this._readAccessorIntoArray(r),t=i.length,i.push(r),n.set(e,t)),t},c=[];if(s.channels.forEach(e=>{var t,r,n=e.target.node;void 0!==n&&(n=a(n),t=s.samplers[e.sampler],r=l(t.input),"weights"===e.target.path?c.push(...this._glTFWeightChannelToTracks(s,e,i[r])):this._gltfChannelToCurveData(s,e,n,i[r]),n=void 0!==(e=this._gltf.accessors[t.input]).max&&1===e.max.length?Math.fround(e.max[0]):0,o=Math.max(n,o))}),this._gltf.nodes){new Float32Array([0]);const u=new cc_1.Quat,f=new cc_1.Vec3,d=new cc_1.Vec3;this._gltf.nodes.forEach((t,r)=>{if(!this._promotedRootNodes.includes(r)){var n,r=a(r);let e;t.matrix&&(e=this._readNodeMatrix(t.matrix),cc_1.Mat4.toRTS(e,u,f,d)),r.position||(n=new cc_1.Vec3,t.translation?cc_1.Vec3.set(n,t.translation[0],t.translation[1],t.translation[2]):e&&cc_1.Vec3.copy(n,f),r.setConstantPosition(n)),r.scale||(n=new cc_1.Vec3(1,1,1),t.scale?cc_1.Vec3.set(n,t.scale[0],t.scale[1],t.scale[2]):e&&cc_1.Vec3.copy(n,d),r.setConstantScale(n)),r.rotation||(n=new cc_1.Quat,t.rotation?this._getNodeRotation(t.rotation,n):e&&cc_1.Quat.copy(n,u),r.setConstantRotation(n))}})}var r=t.createExotic();const _=new cc.AnimationClip;return _.name=this._getGltfXXName(GltfAssetKind.Animation,e),_.wrapMode=cc.AnimationClip.WrapMode.Loop,_.duration=o,_.sample=30,_.hash,_.enableTrsBlending=!0,c.forEach(e=>_.addTrack(e)),_[exotic_animation_1.exoticAnimationTag]=r,_}createMaterial(t,r,n,s){var a=null==(i=s.useVertexColors)||i,e=null!=(i=s.depthWriteInAlphaModeBlend)&&i,s=null!=(i=s.smartMaterialEnabled)&&i;const o=this._gltf.materials[t];var i=void 0!==(o.extensions&&o.extensions.KHR_materials_unlit),l=this._gltf.extras;if(s){let e="";if("object"==typeof l&&l&&"FBX-glTF-conv"in l){s=l["FBX-glTF-conv"];if(void 0!==s.fbxFileHeaderInfo){void 0!==s.fbxFileHeaderInfo.sceneInfo&&(e=s.fbxFileHeaderInfo.sceneInfo.original.applicationName);var l=/Blender/g,s=/Maya/g,c=/Max/g,_=/Cinema/g,u=/mixamo/g,f=o.extras["FBX-glTF-conv"].raw;if(l.test(e)||u.test(e)){if("phong"===f.type)return this._convertBlenderPBRMaterial(o,t,r,n)}else if(s.test(e)){if("phong"===f.type||"lambert"===f.type)return this._convertPhongMaterial(t,r,n,1,f.properties);if(f.properties.Maya&&1398031443===f.properties.Maya.value.TypeId.value)return this._convertMayaStandardSurface(t,r,n,f.properties.Maya.value)}else if(c.test(e)){if("phong"===f.type||"lambert"===f.type)return this._convertPhongMaterial(t,r,n,1,f.properties);if(f.properties["3dsMax"].value.ORIGINAL_MTL&&"PHYSICAL_MTL"===f.properties["3dsMax"].value.ORIGINAL_MTL.value)return this._convertMaxPhysicalMaterial(t,r,n,f.properties["3dsMax"].value.Parameters.value)}else if(_.test(e)){if("phong"===f.type||"lambert"===f.type)return this._convertPhongMaterial(t,r,n,3,f.properties)}else if("phong"===f.type||"lambert"===f.type)return this._convertPhongMaterial(t,r,n,0,f.properties)}else console.debug("Failed to read fbx header info, default material was used")}else console.debug("Failed to read fbx info.")}else{u=extras_1.hasOriginalMaterialExtras(o.extras)&&(l=o.extras["FBX-glTF-conv"].originalMaterial,extras_1.isAdsk3dsMaxPhysicalMaterial(l))?this._convertAdskPhysicalMaterial(o,t,r,n,l):null;if(u)return u}var s=new cc.Material,d=(s.name=this._getGltfXXName(GltfAssetKind.Material,t),s._effectAsset=n(`db://internal/effects/builtin-${i?"unlit":"standard"}.effect`),{}),m={},p={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}};if(this._gltf.meshes)for(let e=0;e<this._gltf.meshes.length;e++){var h=this._gltf.meshes[e];for(let e=0;e<h.primitives.length;e++){var g=h.primitives[e];g.material===t&&(g.attributes.COLOR_0&&a&&(d.USE_VERTEX_COLOR=!0),g.attributes.TEXCOORD_1)&&(d.HAS_SECOND_UV=!0)}}let T=!1;if(o.pbrMetallicRoughness&&(void 0!==(c=o.pbrMetallicRoughness).baseColorTexture&&(T=!0,d[i?"USE_TEXTURE":"USE_ALBEDO_MAP"]=!0,c.baseColorTexture.texCoord&&(d.ALBEDO_UV="v_uv1"),m.mainTexture=r.find("textures",c.baseColorTexture.index,cc.Texture2D),void 0!==c.baseColorTexture.extensions)&&c.baseColorTexture.extensions.KHR_texture_transform&&(m.tilingOffset=this._khrTextureTransformToTiling(c.baseColorTexture.extensions.KHR_texture_transform)),c.baseColorFactor&&(T=!0,_=c.baseColorFactor,i?m.mainColor=new cc_1.Vec4(_[0],_[1],_[2],1):m.albedoScale=new cc_1.Vec3(_[0],_[1],_[2])),void 0!==c.metallicRoughnessTexture&&(T=!0,d.USE_METALLIC_ROUGHNESS_MAP=!0,m.metallicRoughnessMap=r.find("textures",c.metallicRoughnessTexture.index,cc.Texture2D),m.metallic=1,m.roughness=1),void 0!==c.metallicFactor&&(T=!0,m.metallic=c.metallicFactor),void 0!==c.roughnessFactor)&&(T=!0,m.roughness=c.roughnessFactor),!T&&null!=(f=o.extensions)&&f.KHR_materials_pbrSpecularGlossiness)return this._convertGltfPbrSpecularGlossiness(o,t,r,n,e);switch(void 0!==o.normalTexture&&void 0!==(l=o.normalTexture).index&&(d.USE_NORMAL_MAP=!0,m.normalMap=r.find("textures",l.index,cc.Texture2D),void 0!==l.scale)&&(m.normalStrenth=l.scale),o.occlusionTexture&&void 0!==(u=o.occlusionTexture).index&&(d.USE_OCCLUSION_MAP=!0,m.occlusionMap=r.find("textures",u.index,cc.Texture2D),void 0!==u.strength)&&(m.occlusion=u.strength),void 0!==o.emissiveTexture&&(d.USE_EMISSIVE_MAP=!0,o.emissiveTexture.texCoord&&(d.EMISSIVE_UV="v_uv1"),m.emissiveMap=r.find("textures",o.emissiveTexture.index,cc.Texture2D)),void 0!==o.emissiveFactor&&(i=o.emissiveFactor,m.emissive=this._normalizeArrayToCocosColor(i)[1]),o.doubleSided&&(p.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),o.alphaMode){case"BLEND":var v=p.blendState.targets[0];v.blend=!0,v.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,v.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,v.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,p.depthStencilState.depthWrite=e;break;case"MASK":v=void 0===o.alphaCutoff?.5:o.alphaCutoff;d.USE_ALPHA_TEST=!0,m.alphaThreshold=v;break;case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:o.alphaMode,material:t})}return s._defines=[d],s._props=[m],s._states=[p],s}getTextureParameters(t,e){var r,n=e=>{switch(e=void 0===e?glTF_constants_1.GltfWrapMode.__DEFAULT:e){case glTF_constants_1.GltfWrapMode.CLAMP_TO_EDGE:return"clamp-to-edge";case glTF_constants_1.GltfWrapMode.MIRRORED_REPEAT:return"mirrored-repeat";case glTF_constants_1.GltfWrapMode.REPEAT:return"repeat";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"wrapMode",value:e,fallback:glTF_constants_1.GltfWrapMode.REPEAT,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),"repeat"}},s=e=>{switch(e){case glTF_constants_1.GltfTextureMagFilter.NEAREST:return"nearest";case glTF_constants_1.GltfTextureMagFilter.LINEAR:return"linear";default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"magFilter",value:e,fallback:glTF_constants_1.GltfTextureMagFilter.LINEAR,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),"linear"}},a=e=>{switch(e){case glTF_constants_1.GltfTextureMinFilter.NEAREST:return["nearest","none"];case glTF_constants_1.GltfTextureMinFilter.LINEAR:return["linear","none"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_NEAREST:return["nearest","nearest"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_NEAREST:return["linear","nearest"];case glTF_constants_1.GltfTextureMinFilter.NEAREST_MIPMAP_LINEAR:return["nearest","linear"];case glTF_constants_1.GltfTextureMinFilter.LINEAR_MIPMAP_LINEAR:return["linear","linear"];default:return this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedTextureParameter,{type:"minFilter",value:e,fallback:glTF_constants_1.GltfTextureMinFilter.LINEAR,sampler:t.sampler,texture:this._gltf.textures.indexOf(t)}),["linear","none"]}};void 0===t.sampler?(e.wrapModeS="repeat",e.wrapModeT="repeat"):(r=this._gltf.samplers[t.sampler],e.wrapModeS=n(r.wrapS),e.wrapModeT=n(r.wrapT),e.magfilter=void 0===r.magFilter?texture_base_1.defaultMagFilter:s(r.magFilter),e.minfilter=texture_base_1.defaultMinFilter,void 0!==r.minFilter&&([n,s]=a(r.minFilter),e.minfilter=n,e.mipfilter=s))}createScene(e,t,r=!0){const n=this._getSceneNode(e,t,r);return n.getComponentsInChildren(cc.SkinnedMeshRenderer).forEach(e=>e.skinningRoot=n),n}createSockets(e){var t=[];for(const n of this._socketMappings){var r=e.getChildByPath(n[0]);doCreateSocket(e,t,r)}return t}readImageInBufferView(e){return this._readBufferView(e)}_warnIfExtensionNotSupported(e,t){supportedExtensions.has(e)||this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedExtension,{name:e,required:t})}_promoteSingleRootNodes(){if(void 0!==this._gltf.nodes&&void 0!==this._gltf.scenes)for(const e of this._gltf.scenes)if(void 0!==e.nodes&&1===e.nodes.length){const t=e.nodes[0];this._gltf.skins&&this._gltf.skins.some(e=>e.joints.includes(t))||this._gltf.animations&&this._gltf.animations.some(e=>e.channels.some(e=>e.target.node===t))||this._promotedRootNodes.push(t)}}_getNodeRotation(e,t){return cc_1.Quat.set(t,e[0],e[1],e[2],e[3]),cc_1.Quat.normalize(t,t),t}_gltfChannelToCurveData(e,t,r,n){let s;if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.translation)s="position";else if(t.target.path===glTF_constants_1.GltfAnimationChannelTargetPath.rotation)s="rotation";else{if(t.target.path!==glTF_constants_1.GltfAnimationChannelTargetPath.scale)return void this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.UnsupportedChannelPath,{channel:e.channels.indexOf(t),animation:this._gltf.animations.indexOf(e),path:t.target.path});s="scale"}e=e.samplers[t.sampler],t=null!=(t=e.interpolation)?t:glTF_constants_1.GlTfAnimationInterpolation.LINEAR;switch(t){case glTF_constants_1.GlTfAnimationInterpolation.STEP:case glTF_constants_1.GlTfAnimationInterpolation.LINEAR:case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:break;default:return}e=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[e.output]);r[s]=new glTF_animation_utils_1.GlTFTrsTrackData(t,n,e)}_glTFWeightChannelToTracks(e,t,n){var r=e.samplers[t.sampler];const s=this._readAccessorIntoArrayAndNormalizeAsFloat(this._gltf.accessors[r.output]);var r=this._gltf.nodes[t.target.node],a=this._processedMeshes[r.mesh],r=new Array,o=a.geometries.length;let i=0;for(let e=0;e<o;++e){var l=a.geometries[e];if(l.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.position)){l=l.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.position)["morphs"];if(l){i=l.length;break}}}if(0===i)return console.debug(`Morph animation in ${e.name} on node `+this._gltf.nodes[t.target.node]+"is going to be ignored due to lack of morph information in mesh."),[];var c=new exotic_animation_1.RealArrayTrack;r.push(c),c.path=(new cc.animation.TrackPath).toHierarchy(this._mapToSocketPath(this._getNodePath(t.target.node))).toComponent(cc.js.getClassName(cc.MeshRenderer)),c.proxy=new cc.animation.MorphWeightsAllValueProxy,c.elementCount=i;for(let r=0;r<i;++r){var _=c.channels()[r]["curve"],u=Array.from({length:n.length},(e,t)=>{return{value:s[i*t+r],interpolationMode:cc.RealInterpolationMode.LINEAR}});_.assignSorted(Array.from(n),u)}return r}_getParent(e){return this._parents[e]}_getRootParent(t){for(let e=t;0<=e;e=this._getParent(t))t=e;return t}_commonRoot(e){let n=1/0;var r=e.map(e=>{var t=[];let r=e;for(;0<=r;)t.unshift(r),r=this._getParent(r);return n=Math.min(n,t.length),t});if(0===r.length)return-1;var s=[];for(let t=0;t<n;++t){const a=r[0][t];if(!r.every(e=>e[t]===a))break;s.push(a)}return 0===s.length?-1:s[s.length-1]}_getSkinRoot(e){let t=this._skinRoots[e];return t===skinRootNotCalculated&&(t=this._commonRoot(this._gltf.skins[e].joints),this._skinRoots[e]=t),t}_readPrimitive(r,e,n){let t=null;if(r.extensions)for(const m of Object.keys(r.extensions)){var s=r.extensions[m];"KHR_draco_mesh_compression"===m&&(t=this._decodeDracoGeometry(r,s))}var a=this._getPrimitiveMode(void 0===r.mode?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:r.mode);let o;if(void 0!==r.indices){let e;e=t&&t.indices?t.indices:(i=this._gltf.accessors[r.indices],this._readAccessorIntoArray(i)),o=e}if(!("POSITION"in r.attributes))throw new Error("The primitive doesn't contains positions.");var i=t?t.vertices.POSITION.length/3:this._gltf.accessors[r.attributes.POSITION].count,l=new pp_geometry_1.PPGeometry(i,a,o);for(const p of Object.getOwnPropertyNames(r.attributes)){var c=this._gltf.accessors[r.attributes[p]];let e;e=t&&p in t.vertices?t.vertices[p]:this._readAccessorIntoArray(c);var _=glTFAttributeNameToPP(p),c=this._getComponentsPerAttribute(c.type);l.setAttribute(_,e,c)}if(r.targets){for(const h of Object.getOwnPropertyNames(r.targets[0])){var u=glTFAttributeNameToPP(h);if(!pp_geometry_1.PPGeometry.isStdSemantic(u)||![pp_geometry_1.PPGeometry.StdSemantics.position,pp_geometry_1.PPGeometry.StdSemantics.normal,pp_geometry_1.PPGeometry.StdSemantics.tangent].includes(u))throw new Error("Only position, normal, tangent attribute are morph-able, but provide "+h);assertGlTFConformance(l.hasAttribute(u),`Primitive do not have attribute ${h} for morph.`);var f=l.getAttribute(u);f.morphs=new Array(r.targets.length);for(let e=0;e<r.targets.length;++e){var d=r.targets[e],d=(assertGlTFConformance(h in d,"Morph attributes in all target must be same."),this._gltf.accessors[d[h]]),d=this._readAccessorIntoArray(d);f.morphs[e]=d}}let t=!1;l.forEachAttribute(e=>{!t&&e.morphs&&e.morphs.some(e=>e.some(e=>0!==e))&&(t=!0)}),t||this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.EmptyMorph,{mesh:e,primitive:n})}return l}_decodeDracoGeometry(e,t){var r,n=this._gltf.bufferViews[t.bufferView],s=this._buffers[n.buffer],a=void 0===n.byteOffset?0:n.byteOffset,s=s.slice(a,a+n.byteLength),o={buffer:new Int8Array(s),attributes:{}};void 0!==e.indices&&(o.indices=this._getAttributeBaseTypeStorage(this._gltf.accessors[e.indices].componentType));for(const i of Object.keys(t.attributes))i in e.attributes&&(r=this._gltf.accessors[e.attributes[i]],o.attributes[i]={uniqueId:t.attributes[i],storageConstructor:this._getAttributeBaseTypeStorage(r.componentType),components:this._getComponentsPerAttribute(r.type)});return khr_draco_mesh_compression_1.decodeDracoGeometry(o)}_readBounds(e,t,r){var e=e.attributes.POSITION;void 0!==e&&((e=this._gltf.accessors[e]).min&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(t.x=Math.fround(e.min[0]),t.y=Math.fround(e.min[1]),t.z=Math.fround(e.min[2])):(t.x=e.min[0],t.y=e.min[1],t.z=e.min[2])),e.max)&&(e.componentType===glTF_constants_1.GltfAccessorComponentType.FLOAT?(r.x=Math.fround(e.max[0]),r.y=Math.fround(e.max[1]),r.z=Math.fround(e.max[2])):(r.x=e.max[0],r.y=e.max[1],r.z=e.max[2]))}_applySettings(e,t,r,n,s,a){var o;t===glTF_meta_1.NormalImportSetting.recalculate||t===glTF_meta_1.NormalImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)?(o=e.calculateNormals(),e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal,o,3)):t===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal),r===glTF_meta_1.TangentImportSetting.recalculate||r===glTF_meta_1.TangentImportSetting.require&&!e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)?e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)?e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.texcoord)?(o=e.calculateTangents(),e.setAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent,o,4)):this._logger(GltfConverter.LogLevel.Debug,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"uv",primitive:s,mesh:a}):this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.FailedToCalculateTangents,{reason:"normal",primitive:s,mesh:a}):r===glTF_meta_1.TangentImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent)&&e.deleteAttribute(pp_geometry_1.PPGeometry.StdSemantics.tangent),n===glTF_meta_1.NormalImportSetting.exclude&&e.hasAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal)&&(e.getAttribute(pp_geometry_1.PPGeometry.StdSemantics.normal).morphs=null)}_readBufferView(e){var t=this._buffers[e.buffer];return Buffer.from(t.buffer,t.byteOffset+(e.byteOffset||0),e.byteLength)}_readAccessorIntoArray(e){var t=new(this._getAttributeBaseTypeStorage(e.componentType))(e.count*this._getComponentsPerAttribute(e.type));return this._readAccessor(e,createDataViewFromTypedArray(t)),void 0!==e.sparse&&this._applyDeviation(e,t),t}_readAccessorIntoArrayAndNormalizeAsFloat(e){let t=this._readAccessorIntoArray(e);if(!(t instanceof Float32Array)){var r=new Float32Array(t.length),n=t instanceof Int8Array?e=>Math.max(e/127,-1):t instanceof Uint8Array?e=>e/255:t instanceof Int16Array?e=>Math.max(e/32767,-1):t instanceof Uint16Array?e=>e/65535:e=>e;for(let e=0;e<t.length;++e)r[e]=n(t[e]);t=r}return t}_getSceneNode(e,r,t=!0){var n=this._getGltfXXName(GltfAssetKind.Scene,e),e=this._gltf.scenes[e];let s;if(e.nodes&&0!==e.nodes.length){const o=e.nodes,i=new Array(this._gltf.nodes.length).fill(null);if(1===e.nodes.length&&this._promotedRootNodes.includes(e.nodes[0])){var a=e.nodes[0];s=this._createEmptyNodeRecursive(a,i,t)}else{s=new cc.Node(n);for(const l of e.nodes)this._createEmptyNodeRecursive(l,i,t).parent=s}i.forEach((e,t)=>{this._setupNode(t,i,r,s,o)})}else s=new cc.Node(n);return s}_createEmptyNodeRecursive(e,t,r=!0){var n=this._gltf.nodes[e],s=this._createEmptyNode(e,r);if(void 0!==n.children)for(const a of n.children)this._createEmptyNodeRecursive(a,t,r).parent=s;return t[e]=s}_setupNode(t,r,n,s,a){var o=r[t];if(null!==o){var i=this._gltf.nodes[t];if(void 0!==i.mesh){let e=null;e=void 0===i.skin?o.addComponent(cc.MeshRenderer):(o=o.addComponent(cc.SkinnedMeshRenderer),(l=n.find("skeletons",i.skin,cc.Skeleton))&&(o.skeleton=l),null===(l=r[this._getSkinRoot(i.skin)])?this.gltf.skins[i.skin].joints.every(e=>a.includes(this._getRootParent(e)))?o.skinningRoot=s:this._logger(GltfConverter.LogLevel.Error,GltfConverter.ConverterError.ReferenceSkinInDifferentScene,{node:t,skin:i.skin}):o.skinningRoot=l,o);var l,r=n.find("meshes",i.mesh,cc.Mesh);r&&(e._mesh=r);const c=this.gltf.meshes[i.mesh];s=this._processedMeshes[i.mesh].materialIndices.map(e=>{e=c.primitives[e];return void 0!==e.material&&n.find("materials",e.material,cc.Material)||null});e._materials=s}}}_createEmptyNode(e,t=!0){var r,n,s=this._gltf.nodes[e],e=this._getGltfXXName(GltfAssetKind.Node,e),e=new cc.Node(e);return t&&(s.translation&&e.setPosition(s.translation[0],s.translation[1],s.translation[2]),s.rotation&&e.setRotation(this._getNodeRotation(s.rotation,new cc_1.Quat)),s.scale&&e.setScale(s.scale[0],s.scale[1],s.scale[2]),s.matrix)&&(t=s.matrix,s=this._readNodeMatrix(t),t=new cc_1.Vec3,r=new cc_1.Quat,n=new cc_1.Vec3,cc_1.Mat4.toRTS(s,r,t,n),e.setPosition(t),e.setRotation(r),e.setScale(n)),e}_readNodeMatrix(e){return new cc_1.Mat4(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}_getNodePath(e){return this._nodePathTable[e]}_isAncestorOf(e,t){if(e!==t)for(;0<=t;){if(t===e)return!0;t=this._getParent(t)}return!1}_mapToSocketPath(e){for(const t of this._socketMappings)if(e===t[0]||e.startsWith(t[0]+"/"))return t[1]+e.slice(t[0].length);return e}_createNodePathTable(){if(void 0===this._gltf.nodes)return[];const n=new Array(this._gltf.nodes.length).fill(-1),s=(this._gltf.nodes.forEach((r,t)=>{r.children&&(r.children.forEach(e=>{n[e]=t}),makeUniqueNames(r.children.map(e=>{let t=this._gltf.nodes[e].name;return t="string"==typeof t&&0!==t.length?t:null}),uniqueChildNodeNameGenerator).forEach((e,t)=>{this._gltf.nodes[r.children[t]].name=e}))}),new Array(this._gltf.nodes.length).fill(""));for(let e=0;e<s.length;++e)s[e]=this._getGltfXXName(GltfAssetKind.Node,e);const a=new Array(this._gltf.nodes.length).fill("");return this._gltf.nodes.forEach((e,t)=>{var r=[];for(let e=t;0<=e;e=n[e])this._promotedRootNodes.includes(e)||r.unshift(s[e]);a[t]=r.join("/")}),a}_readAccessor(t,r,n=0){if(void 0!==t.bufferView){var e=this._gltf.bufferViews[t.bufferView],s=this._getComponentsPerAttribute(t.type),a=this._getBytesPerComponent(t.componentType),o=(0===n&&(n=s*a),(void 0!==t.byteOffset?t.byteOffset:0)+(void 0!==e.byteOffset?e.byteOffset:0)),i=createDataViewFromBuffer(this._buffers[e.buffer],o),l=void 0!==e.byteStride?e.byteStride:s*a,c=this._getComponentReader(t.componentType),_=this._getComponentWriter(t.componentType);for(let e=0;e<t.count;++e){var u=createDataViewFromTypedArray(i,l*e),f=createDataViewFromTypedArray(r,n*e);for(let e=0;e<s;++e){var d=a*e;_(f,d,c(u,d))}}}}_applyDeviation(e,r){var t=e["sparse"],n=this._gltf.bufferViews[t.indices.bufferView],s=this._buffers[n.buffer],a=new(this._getAttributeBaseTypeStorage(t.indices.componentType))(s.buffer,s.byteOffset+(n.byteOffset||0)+(t.indices.byteOffset||0),t.count),s=this._gltf.bufferViews[t.values.bufferView],n=this._buffers[s.buffer],o=new(this._getAttributeBaseTypeStorage(e.componentType))(n.buffer,n.byteOffset+(s.byteOffset||0)+(t.values.byteOffset||0)),i=this._getComponentsPerAttribute(e.type);for(let t=0;t<i;++t)for(let e=0;e<a.length;++e)r[i*a[e]+t]=o[i*e+t]}_getPrimitiveMode(e){switch(e=void 0===e?glTF_constants_1.GltfPrimitiveMode.__DEFAULT:e){case glTF_constants_1.GltfPrimitiveMode.POINTS:return cc_1.gfx.PrimitiveMode.POINT_LIST;case glTF_constants_1.GltfPrimitiveMode.LINES:return cc_1.gfx.PrimitiveMode.LINE_LIST;case glTF_constants_1.GltfPrimitiveMode.LINE_LOOP:return cc_1.gfx.PrimitiveMode.LINE_LOOP;case glTF_constants_1.GltfPrimitiveMode.LINE_STRIP:return cc_1.gfx.PrimitiveMode.LINE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLES:return cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_STRIP:return cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP;case glTF_constants_1.GltfPrimitiveMode.TRIANGLE_FAN:return cc_1.gfx.PrimitiveMode.TRIANGLE_FAN;default:throw new Error(`Unrecognized primitive mode: ${e}.`)}}_getAttributeBaseTypeStorage(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return Int8Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return Uint8Array;case glTF_constants_1.GltfAccessorComponentType.SHORT:return Int16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return Uint16Array;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return Uint32Array;case glTF_constants_1.GltfAccessorComponentType.FLOAT:return Float32Array;default:throw new Error("Unrecognized component type: "+e)}}_getComponentsPerAttribute(e){return glTF_constants_1.getGltfAccessorTypeComponents(e)}_getBytesPerComponent(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return 1;case glTF_constants_1.GltfAccessorComponentType.SHORT:case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return 2;case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:case glTF_constants_1.GltfAccessorComponentType.FLOAT:return 4;default:throw new Error("Unrecognized component type: "+e)}}_getComponentReader(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t)=>e.getInt8(t);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t)=>e.getUint8(t);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t)=>e.getInt16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t)=>e.getUint16(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t)=>e.getUint32(t,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t)=>e.getFloat32(t,DataViewUseLittleEndian);default:throw new Error("Unrecognized component type: "+e)}}_getComponentWriter(e){switch(e){case glTF_constants_1.GltfAccessorComponentType.BYTE:return(e,t,r)=>e.setInt8(t,r);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_BYTE:return(e,t,r)=>e.setUint8(t,r);case glTF_constants_1.GltfAccessorComponentType.SHORT:return(e,t,r)=>e.setInt16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_SHORT:return(e,t,r)=>e.setUint16(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.UNSIGNED_INT:return(e,t,r)=>e.setUint32(t,r,DataViewUseLittleEndian);case glTF_constants_1.GltfAccessorComponentType.FLOAT:return(e,t,r)=>e.setFloat32(t,r,DataViewUseLittleEndian);default:throw new Error("Unrecognized component type: "+e)}}_getGltfXXName(e,t){var r={[GltfAssetKind.Animation]:"animations",[GltfAssetKind.Image]:"images",[GltfAssetKind.Material]:"materials",[GltfAssetKind.Node]:"nodes",[GltfAssetKind.Skin]:"skins",[GltfAssetKind.Texture]:"textures",[GltfAssetKind.Scene]:"scenes"},r=this._gltf[r[e]];return r?"string"==typeof(r=r[t]).name?r.name:GltfAssetKind[e]+"-"+t:""}_normalizeArrayToCocosColor(e){let t=1;1<Math.max(...e)&&(t=Math.max(...e));e=e.map(e=>e/t*255),3===e.length&&e.push(255),e=new cc.Color(e[0],e[1],e[2],e[3]);return[t,e]}_convertAdskPhysicalMaterial(e,t,r,n,s){var a={},o={},s=s.properties["3dsMax"]["Parameters"],i=null!=(i=s.base_color)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color,i=(o.mainColor=cc.Vec4.set(new cc.Color,i[0],i[1],i[2],i[3]),null!=(i=s.basic_weight)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.basic_weight),i=(o.albedoScale=new cc.Vec3(i,i,i),null!=(i=s.base_color_map_on)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.base_color_map_on),l=s.base_color_map,l=(i&&l&&(a.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(i=r.find("textures",l.index,cc.Texture2D))?i:void 0,1===l.texCoord&&(a.ALBEDO_UV="v_uv1"),hasKHRTextureTransformExtension(l))&&(o.tilingOffset=this._khrTextureTransformToTiling(l.extensions.KHR_texture_transform)),null!=(i=s.metalness)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness),l=(o.metallic=l,null!=(i=s.roughness)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness),i=null!=(i=s.roughness_inv)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_inv,l=(o.roughness=i?1-l:l,null!=s.metalness_map_on||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.metalness_map_on,s.metalness_map,null!=s.roughness_map_on||extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.roughness_map_on,s.roughness_map,null!=(i=s.emission)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emission),i=null!=(i=s.emit_color)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color,l=(o.emissive=new cc_1.Vec4(i[0]*l,i[1]*l,i[2]*l,i[3]*l),null!=(i=s.emit_color_map_on)?i:extras_1.ADSK_3DS_MAX_PHYSICAL_MATERIAL_DEFAULT_PARAMETERS.emit_color_map_on),i=s.emit_color_map,l=(l&&i&&(a.USE_EMISSIVE_MAP=!0,o.emissiveMap=null!=(s=r.find("textures",i.index,cc.Texture2D))?s:void 0,1===i.texCoord)&&(a.EMISSIVE_UV="v_uv1"),new cc.Material);return l.name=this._getGltfXXName(GltfAssetKind.Material,t),l._effectAsset=n("db://internal/effects/builtin-standard.effect"),l._defines=[a],l._props=[o],l._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],l}_convertMaxPhysicalMaterial(e,t,r,n){var s,a={},o={},t=(n.base_color_map&&(a.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(s=t.find("textures",n.base_color_map.value.index,cc.Texture2D))?s:void 0),o.mainColor=this._normalizeArrayToCocosColor(n.base_color.value)[1],n.base_weight_map&&(a.USE_WEIGHT_MAP=!0,o.baseWeightMap=null!=(s=t.find("textures",n.base_weight_map.value.index,cc.Texture2D))?s:void 0),o.albedoScale=n.base_weight.value,n.metalness_map&&(a.USE_METALLIC_MAP=!0,o.metallicMap=null!=(s=t.find("textures",n.metalness_map.value.index,cc.Texture2D))?s:void 0),o.metallic=n.metalness.value,n.roughness_map&&(a.USE_ROUGHNESS_MAP=!0,o.roughnessMap=null!=(s=t.find("textures",n.roughness_map.value.index,cc.Texture2D))?s:void 0),o.roughness=n.roughness.value,n.bump_map&&(a.USE_NORMAL_MAP=!0,o.normalMap=null!=(s=t.find("textures",n.bump_map.value.index,cc.Texture2D))?s:void 0),n.emission_map&&(a.USE_EMISSIVESCALE_MAP=!0,o.emissiveScaleMap=null!=(s=t.find("textures",n.emission_map.value.index,cc.Texture2D))?s:void 0),o.emissiveScale=n.emission.value,n.emit_color_map&&(a.USE_EMISSIVE_MAP=!0,o.emissiveMap=null!=(s=t.find("textures",n.emit_color_map.value.index,cc.Texture2D))?s:void 0),o.emissive=this._normalizeArrayToCocosColor(n.emit_color.value)[1],o.alphaSource=1,n.cutout_map&&(a.USE_ALPHA_TEST=!0,a.USE_OPACITY_MAP=!0,o.alphaSourceMap=null!=(s=t.find("textures",n.cutout_map.value.index,cc.Texture2D))?s:void 0),new cc.Material);return t.name=this._getGltfXXName(GltfAssetKind.Material,e),t._effectAsset=r("db://internal/effects/dcc/imported-metallic-roughness.effect"),t._defines=[a],t._props=[o],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],t}_convertMayaStandardSurface(e,t,r,n){var s,a={},o={},t=(n.base.texture&&(a.USE_WEIGHT_MAP=!0,o.baseWeightMap=null!=(s=t.find("textures",n.base.texture.index,cc.Texture2D))?s:void 0),o.albedoScale=n.base.value,n.baseColor.texture&&(a.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(s=t.find("textures",n.baseColor.texture.index,cc.Texture2D))?s:void 0),o.mainColor=this._normalizeArrayToCocosColor(n.baseColor.value)[1],n.metalness.texture&&(a.USE_METALLIC_MAP=!0,o.metallicMap=null!=(s=t.find("textures",n.metalness.texture.index,cc.Texture2D))?s:void 0),o.metallic=n.metalness.value,n.specularRoughness.texture&&(a.USE_ROUGHNESS_MAP=!0,o.roughnessMap=null!=(s=t.find("textures",n.specularRoughness.texture.index,cc.Texture2D))?s:void 0),o.roughness=n.specularRoughness.value,void 0!==n.normalCamera.texture&&(a.USE_NORMAL_MAP=!0,o.normalMap=null!=(s=t.find("textures",n.normalCamera.texture.index,cc.Texture2D))?s:void 0),void 0!==n.emission.texture&&(a.USE_EMISSIVESCALE_MAP=!0,o.emissiveScaleMap=null!=(s=t.find("textures",n.emission.texture.index,cc.Texture2D))?s:void 0),o.emissiveScale=n.emission.value,void 0!==n.emissionColor.texture&&(a.USE_EMISSIVE_MAP=!0,o.emissiveMap=null!=(s=t.find("textures",n.emissionColor.texture.index,cc.Texture2D))?s:void 0),o.emissive=this._normalizeArrayToCocosColor(n.emissionColor.value)[1],n.opacity.texture?(a.USE_ALPHA_TEST=!0,a.USE_OPACITY_MAP=!0,o.alphaSourceMap=null!=(s=t.find("textures",n.opacity.texture.index,cc.Texture2D))?s:void 0):Math.max(...n.opacity.value)<.99&&(o.alphaSource=Math.max(...n.opacity.value)),new cc.Material);return t.name=this._getGltfXXName(GltfAssetKind.Material,e),t._effectAsset=r("db://internal/effects/dcc/imported-metallic-roughness.effect"),t._defines=[a],t._props=[o],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],t}_convertPhongMaterial(e,t,r,n,s){var a,o={},i={},t=(void 0!==s.transparentColor.texture?(o.USE_ALPHA_TEST=!0,o.USE_TRANSPARENCY_MAP=!0,i.transparencyMap=null!=(a=t.find("textures",s.transparentColor.texture.index,cc.Texture2D))?a:void 0):s.transparencyFactor&&(i.transparencyFactor=s.transparencyFactor.value*Math.max(...s.transparentColor.value)),s.diffuse&&(a=this._normalizeArrayToCocosColor(s.diffuse.value),i.albedoScale=s.diffuseFactor.value*a[0],i.mainColor=a[1],void 0!==s.diffuse.texture)&&(o.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(a=t.find("textures",s.diffuse.texture.index,cc.Texture2D))?a:void 0),s.specular&&(a=this._normalizeArrayToCocosColor(s.specular.value),i.specularFactor=s.specularFactor.value*a[0],i.specularColor=a[1],void 0!==s.specular.texture)&&(o.USE_SPECULAR_MAP=!0,i.specularMap=null!=(a=t.find("textures",s.specular.texture.index,cc.Texture2D))?a:void 0),void 0!==(null==(a=s.normalMap)?void 0:a.texture)?(o.USE_NORMAL_MAP=!0,i.normalMap=null!=(a=t.find("textures",s.normalMap.texture.index,cc.Texture2D))?a:void 0):void 0!==(null==(a=s.bump)?void 0:a.texture)&&(o.USE_NORMAL_MAP=!0,i.normalMap=null!=(a=t.find("textures",s.bump.texture.index,cc.Texture2D))?a:void 0),s.shininess&&(i.shininessExponent=s.shininess.value,void 0!==s.shininess.texture)&&(o.USE_SHININESS_MAP=!0,i.shininessExponentMap=null!=(a=t.find("textures",s.shininess.texture.index,cc.Texture2D))?a:void 0),s.emissive&&(a=this._normalizeArrayToCocosColor(s.emissive.value),i.emissiveColor=a[1],void 0!==s.emissive.texture)&&(o.USE_EMISSIVE_MAP=!0,i.emissiveMap=null!=(a=t.find("textures",s.emissive.texture.index,cc.Texture2D))?a:void 0),o.DCC_APP_NAME=n,new cc.Material);return t.name=this._getGltfXXName(GltfAssetKind.Material,e),t._effectAsset=r("db://internal/effects/dcc/imported-specular-glossiness.effect"),t._defines=[o],t._props=[i],t._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],t}_convertBlenderPBRMaterial(e,t,r,n){var s,a={},o={},e=e.extras["FBX-glTF-conv"].raw.properties,r=(a.DCC_APP_NAME=2,a.HAS_EXPORTED_METALLIC=!0,e.diffuse&&(s=this._normalizeArrayToCocosColor(e.diffuse.value),o.mainColor=s[1],void 0!==e.diffuse.texture)&&(a.USE_ALBEDO_MAP=!0,o.mainTexture=null!=(s=r.find("textures",e.diffuse.texture.index,cc.Texture2D))?s:void 0),void 0!==(null==(s=e.bump)?void 0:s.texture)&&(a.USE_NORMAL_MAP=!0,o.normalMap=null!=(s=r.find("textures",e.bump.texture.index,cc.Texture2D))?s:void 0),e.shininess&&(o.shininessExponent=e.shininess.value,void 0!==e.shininess.texture)&&(a.USE_SHININESS_MAP=!0,o.shininessExponentMap=null!=(s=r.find("textures",e.shininess.texture.index,cc.Texture2D))?s:void 0),e.emissive&&(s=this._normalizeArrayToCocosColor(e.emissive.value),o.emissiveFactor=s[0],o.emissiveColor=s[1],void 0!==e.emissive.texture)&&(a.USE_EMISSIVE_MAP=!0,o.emissiveMap=null!=(s=r.find("textures",e.emissive.texture.index,cc.Texture2D))?s:void 0),e.reflectionFactor&&(o.metallic=e.reflectionFactor.value,void 0!==e.reflectionFactor.texture)&&(a.USE_METALLIC_MAP=!0,o.metallicMap=null!=(s=r.find("textures",e.reflectionFactor.texture.index,cc.Texture2D))?s:void 0),e.specularFactor&&(e.specularFactor.texture?(a.USE_SPECULAR_MAP=!0,o.specularMap=null!=(s=r.find("textures",e.specularFactor.texture.index,cc.Texture2D))?s:void 0):o.specularFactor=e.specularFactor.value),e.transparencyFactor&&(void 0!==e.transparencyFactor.texture?(a.USE_ALPHA_TEST=!0,a.USE_TRANSPARENCY_MAP=!0,o.transparencyMap=null!=(s=r.find("textures",e.transparencyFactor.texture.index,cc.Texture2D))?s:void 0):o.transparencyFactor=e.transparencyFactor.value),new cc.Material);return r.name=this._getGltfXXName(GltfAssetKind.Material,t),r._effectAsset=n("db://internal/effects/dcc/imported-specular-glossiness.effect"),r._defines=[a],r._props=[o],r._states=[{rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}}],r}_convertGltfPbrSpecularGlossiness(e,t,r,n,s){var a,o={},i={},l={rasterizerState:{},blendState:{targets:[{}]},depthStencilState:{}},c=e.extensions.KHR_materials_pbrSpecularGlossiness;switch(o.DCC_APP_NAME=4,c.diffuseFactor&&(a=this._normalizeArrayToCocosColor(c.diffuseFactor),i.mainColor=a[1]),void 0!==c.diffuseTexture&&(o.USE_ALBEDO_MAP=!0,i.mainTexture=null!=(a=r.find("textures",c.diffuseTexture.index,cc.Texture2D))?a:void 0),c.specularFactor&&(a=this._normalizeArrayToCocosColor(c.specularFactor),i.specularColor=a[1]),c.glossinessFactor&&(o.HAS_EXPORTED_GLOSSINESS=!0,i.glossiness=c.glossinessFactor),void 0!==c.specularGlossinessTexture&&(o.HAS_EXPORTED_GLOSSINESS=!0,o.USE_SPECULAR_GLOSSINESS_MAP=!0,i.specularGlossinessMap=null!=(a=r.find("textures",c.specularGlossinessTexture.index,cc.Texture2D))?a:void 0),void 0!==e.normalTexture&&void 0!==(c=e.normalTexture).index&&(o.USE_NORMAL_MAP=!0,i.normalMap=r.find("textures",c.index,cc.Texture2D)),void 0!==e.emissiveTexture&&(o.USE_EMISSIVE_MAP=!0,e.emissiveTexture.texCoord&&(o.EMISSIVE_UV="v_uv1"),i.emissiveMap=r.find("textures",e.emissiveTexture.index,cc.Texture2D)),void 0!==e.emissiveFactor&&(a=e.emissiveFactor,i.emissiveColor=this._normalizeArrayToCocosColor(a)[1]),e.doubleSided&&(l.rasterizerState.cullMode=cc_1.gfx.CullMode.NONE),e.alphaMode){case"BLEND":var _=l.blendState.targets[0];_.blend=!0,_.blendSrc=cc_1.gfx.BlendFactor.SRC_ALPHA,_.blendDst=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,_.blendDstAlpha=cc_1.gfx.BlendFactor.ONE_MINUS_SRC_ALPHA,l.depthStencilState.depthWrite=s;break;case"MASK":_=void 0===e.alphaCutoff?.5:e.alphaCutoff;o.USE_ALPHA_TEST=!0,i.alphaThreshold=_;break;case"OPAQUE":case void 0:break;default:this._logger(GltfConverter.LogLevel.Warning,GltfConverter.ConverterError.UnsupportedAlphaMode,{mode:e.alphaMode,material:t})}c=new cc.Material;return c.name=this._getGltfXXName(GltfAssetKind.Material,t),c._effectAsset=n("db://internal/effects/dcc/imported-specular-glossiness.effect"),c._defines=[o],c._props=[i],c._states=[l],c}_khrTextureTransformToTiling(e){var t=new cc_1.Vec4(1,1,0,0);return e.scale&&(t.x=e.scale[0],t.y=e.scale[1]),e.offset&&(t.z=e.offset[0],t.w=e.offset[1]),t}}function hasKHRTextureTransformExtension(e){e=e.extensions;return"object"==typeof e&&null!==e&&"object"==typeof e.KHR_texture_transform}async function readGltf(e){return".glb"===path.extname(e)?await readGlb(e):await readGltfJson(e)}async function readGltfJson(t){var e=await fs.readJSON(t),r=e.buffers?e.buffers.map(e=>e.uri?resolveBufferUri(t,e.uri):Buffer.alloc(0)):[];return{glTF:e,buffers:r}}async function readGlb(r){var n=()=>{throw new Error("Bad glb format.")},s=await fs.readFile(r);if(s.length<12)return n();if(1179937895!==s.readUInt32LE(0))return n();var e;s.readUInt32LE(4),s.readUInt32LE(8);let a,o;for(let e=0,t=12;t+8<=s.length;++e){var i=s.readUInt32LE(t),l=(t+=4,s.readUInt32LE(t));if((t+=4)+i>s.length)return n();var c=Buffer.from(s.buffer,t,i);if(t+=i,0===e){if(1313821514!==l)return n();i=new TextDecoder("utf-8").decode(c);a=JSON.parse(i)}else 5130562===l&&(o=c)}return a?(e=a.buffers?a.buffers.map((e,t)=>e.uri?resolveBufferUri(r,e.uri):0===t&&o?o:Buffer.alloc(0)):[],{glTF:a,buffers:e}):n()}function resolveBufferUri(e,t){var r=DataURI.parse(t);return r?Buffer.from(resolveBufferDataURI(r)):path.resolve(path.dirname(e),t)}function isDataUri(e){return e.startsWith("data:")}(exports.GltfConverter=GltfConverter)._defaultLogger=(e,t,r)=>{var n=JSON.stringify({error:t,arguments:r},void 0,4);switch(e){case GltfConverter.LogLevel.Info:console.log(n);break;case GltfConverter.LogLevel.Warning:console.warn(n);break;case GltfConverter.LogLevel.Error:console.error(n);break;case GltfConverter.LogLevel.Debug:console.debug(n)}},function(e){var t;(t=e.LogLevel||(e.LogLevel={}))[t.Info=0]="Info",t[t.Warning=1]="Warning",t[t.Error=2]="Error",t[t.Debug=3]="Debug",(t=e.ConverterError||(e.ConverterError={}))[t.ReferenceSkinInDifferentScene=0]="ReferenceSkinInDifferentScene",t[t.UnsupportedAlphaMode=1]="UnsupportedAlphaMode",t[t.UnsupportedTextureParameter=2]="UnsupportedTextureParameter",t[t.UnsupportedChannelPath=3]="UnsupportedChannelPath",t[t.DisallowCubicSplineChannelSplit=4]="DisallowCubicSplineChannelSplit",t[t.FailedToCalculateTangents=5]="FailedToCalculateTangents",t[t.EmptyMorph=6]="EmptyMorph",t[t.UnsupportedExtension=7]="UnsupportedExtension"}(GltfConverter=exports.GltfConverter||(exports.GltfConverter={})),exports.readGltf=readGltf,exports.isDataUri=isDataUri;class BufferBlob{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){var t;0!==e&&0!=(t=this._length%e)&&(this._arrayBufferOrPaddings.push(e=e-t),this._length+=e)}addBuffer(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let r=0;return this._arrayBufferOrPaddings.forEach(e=>{"number"==typeof e?r+=e:(t.set(new Uint8Array(e),r),r+=e.byteLength)}),t}}function createDataViewFromBuffer(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}function createDataViewFromTypedArray(e,t=0){return new DataView(e.buffer,e.byteOffset+t)}const DataViewUseLittleEndian=!0;function uniqueChildNodeNameGenerator(e,t,r,n){return`${e||""}(__autogen ${r}${0===n?"":"-"+n})`}function makeUniqueNames(t,s){const a=new Array(t.length).fill("");for(let n=0;n<t.length;++n){let r=t[n],e=0;for(;;){if(null!==r&&a.every((e,t)=>t===n||r!==e)){a[n]=r;break}r=s(t[n],r,n,e++)}}return a}function resolveBufferDataURI(e){if(!e.base64||!e.mediaType||"application/octet-stream"!==e.mediaType.value&&"application/gltf-buffer"!==e.mediaType.value)throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for buffer.`);return base64_1.decodeBase64ToArrayBuffer(e.data)}class DynamicArrayBuffer{constructor(e){this._size=0,this._arrayBuffer=new ArrayBuffer(Math.max(e||0,4))}get arrayBuffer(){return this._arrayBuffer}grow(e){var t,r,n=this._size;return e&&((r=(t=this._arrayBuffer.byteLength)-n-e)<0&&(r=new ArrayBuffer(1.5*(t+-r)),new Uint8Array(r,0,t).set(new Uint8Array(this._arrayBuffer)),this._arrayBuffer=r),this._size+=e),n}shrink(){return this._arrayBuffer.slice(0,this._size)}}function getDataviewWritterOfTypedArray(e,n){switch(e.constructor){case Int8Array:return(e,t,r)=>e.setInt8(t,r);case Uint8Array:return(e,t,r)=>e.setUint8(t,r);case Int16Array:return(e,t,r)=>e.setInt16(t,r,n);case Uint16Array:return(e,t,r)=>e.setUint16(t,r,n);case Int32Array:return(e,t,r)=>e.setInt32(t,r,n);case Uint32Array:return(e,t,r)=>e.setUint32(t,r,n);case Float32Array:return(e,t,r)=>e.setFloat32(t,r,n);default:throw new Error("Bad storage constructor.")}}function interleaveVertices(e){var t,r,n=e.vertexCount,s=[];for(const p of e.attributes()){let e;try{e=pp_geometry_1.getGfxAttributeName(p)}catch(e){console.error(e);continue}s.push([e,p])}let a=0;for([t,r]of s)a+=r.data.BYTES_PER_ELEMENT*r.components;var e=new ArrayBuffer(n*a),o=new DataView(e);let i=0;var l,c,_=[];for([l,c]of s){var u=c.data,f=getDataviewWritterOfTypedArray(u,DataViewUseLittleEndian);for(let t=0;t<n;++t){var d=i+a*t;for(let e=0;e<c.components;++e){var m=u[c.components*t+e];f(o,d+u.BYTES_PER_ELEMENT*e,m)}}i+=c.data.BYTES_PER_ELEMENT*c.components,_.push({name:l,format:c.getGFXFormat(),isNormalized:c.isNormalized})}return{vertexCount:n,vertexStride:a,formats:_,vertexBuffer:e}}const glTFAttributeNameToPP=e=>{if(e.startsWith("_"))return e;var t=/([a-zA-Z]+)(?:_(\d+))?/g.exec(e);if(!t)return e;var r=t[1];let n;t=parseInt(t[2]||"0");switch(r){case"POSITION":n=pp_geometry_1.PPGeometry.StdSemantics.position;break;case"NORMAL":n=pp_geometry_1.PPGeometry.StdSemantics.normal;break;case"TANGENT":n=pp_geometry_1.PPGeometry.StdSemantics.tangent;break;case"COLOR":n=pp_geometry_1.PPGeometry.StdSemantics.color;break;case"TEXCOORD":n=pp_geometry_1.PPGeometry.StdSemantics.texcoord;break;case"JOINTS":n=pp_geometry_1.PPGeometry.StdSemantics.joints;break;case"WEIGHTS":n=pp_geometry_1.PPGeometry.StdSemantics.weights}return void 0===n?e:pp_geometry_1.PPGeometry.StdSemantics.set(n,t)};class GlTfConformanceError extends Error{}function assertGlTFConformance(e,t){if(!e)throw new GlTfConformanceError("glTF non-conformance error: "+t)}exports.GlTfConformanceError=GlTfConformanceError;