"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.modelConvertRoutine=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path"));async function modelConvertRoutine(t,e,a,i,r){var o;const s=path_1.default.join(a.options.temp,t,e.uuid);await fs_extra_1.default.ensureDir(s);const n=(await fs_extra_1.default.stat(e.source)).mtimeMs,u=path_1.default.join(s,"status.json");let l;try{l=await fs_extra_1.default.readJson(u)}catch(t){console.debug(`Status file ${u}: ${t}`)}const f=path_1.default.join(s,"output");await fs_extra_1.default.ensureDir(f);const c=r.options;if(!(void 0!==l&&l.version===i&&l.sourceTimeStamp===n&&validateOptions(c,l.options)&&await isOutputTimeStampsAvailable(f,l.outputTimeStamps))){if(await fs_extra_1.default.emptyDir(f),!await r.convert(e,f))return;const t={};await getMtimeTree(f,t);const a={version:i,sourceTimeStamp:n,outputTimeStamps:t,options:c};await fs_extra_1.default.ensureDir(path_1.default.dirname(u)),await fs_extra_1.default.writeJson(u,a,{spaces:2})}return await(null===(o=r.printLogs)||void 0===o?void 0:o.call(r,e,f)),await r.get(e,f)}async function getMtimeTree(t,e,a){const i=await fs_extra_1.default.readdir(t);await Promise.all(i.map(async i=>{const r=path_1.default.join(t,i),o=await fs_extra_1.default.stat(r),s=a?`${a}/${i}`:i;o.isFile()?e[s]=o.mtimeMs:o.isDirectory()&&await getMtimeTree(r,e,s)}))}async function isOutputTimeStampsAvailable(t,e){return(await Promise.all(Object.entries(e).map(async([e,a])=>{const i=path_1.default.join(t,path_1.default.join(...e.split("/")));try{return(await fs_extra_1.default.stat(i)).mtimeMs===a}catch(t){return!1}}))).every(t=>t)}function validateOptions(t,e){return matchObject(t,e)}function matchObject(t,e){return function t(e,a){return Array.isArray(e)?Array.isArray(a)&&e.length===a.length&&e.every((e,i)=>t(e,a[i])):"object"==typeof e&&null!==e?"object"==typeof a&&null!==a&&Object.keys(e).every(i=>t(e[i],a[i])):null===e?null===a:e===a}(t,e)}exports.modelConvertRoutine=modelConvertRoutine;