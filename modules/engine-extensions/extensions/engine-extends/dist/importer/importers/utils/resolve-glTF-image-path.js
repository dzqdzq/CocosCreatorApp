"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveGlTfImagePath=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));async function resolveGlTfImagePath(t,e,a,n,s){if(e&&await fs_extra_1.default.pathExists(e))return e;let o="",r="";if("object"==typeof n&&keyFbxGlTfConvImageExtras in n){console.debug(`Found FBX-glTF-conv specified extras: ${JSON.stringify(n[keyFbxGlTfConvImageExtras],void 0,2)}`);const{fileName:t,relativeFileName:e}=n[keyFbxGlTfConvImageExtras];e&&(r=normalizePathInFbx(e)),t&&(o=normalizePathInFbx(t))}if(r){const t=path_1.default.join(a,r);if(await fs_extra_1.default.pathExists(t))return t}if(o&&await fs_extra_1.default.pathExists(o))return o;console.debug("Image"+`(Name: ${t}, Expected path: ${e})`+" is not found, fuzzy search starts.");const i=e?path_1.default.extname(e):"",l=i.toLowerCase(),f=e?path_1.default.basename(e,i):"",u=new Set;if(0!==f.length&&u.add(f),t&&u.add(t),o&&u.add(path_1.default.basename(o,path_1.default.extname(o))),r&&u.add(path_1.default.basename(r,path_1.default.extname(r))),0===u.size)return null;const d=[".jpg",".jpeg",".png",".tga",".webp"];0===i.length||d.includes(l)||d.unshift(l);const c=["textures","materials"],_=toNormalizedAbsolute(s),h=t=>t.startsWith(_),p=Array.from(u);let x=toNormalizedAbsolute(a);for(let t=0;t<2&&h(x);++t){const t=await fuzzySearchTexture(x,p,d);if(t)return console.debug(`Found ${t}, use it.`),t;const e=await fs_extra_1.default.readdir(x);for(const t of e){if(!c.some(e=>caseInsensitiveStringEqual(t,e)))continue;const e=path_1.default.join(x,t);try{if(!(await fs_extra_1.default.stat(e)).isDirectory())continue}catch(t){}const a=await fuzzySearchTexture(e,p,d);if(a)return console.debug(`Found ${a}, use it.`),a}x=path_1.default.dirname(x)}const m=[];for(const t of d)for(const e of p)m.push(`${e}${t}`.toLowerCase());for(const t of listFile(a)){const e=path_1.default.basename(t).toLowerCase();if(m.includes(e))return t}return console.debug("Fuzzy search failed."),null}function*listFile(t){const e=fs_extra_1.default.readdirSync(t);for(const a of e){const e=path_1.default.join(t,a),n=fs_extra_1.default.statSync(e);n.isFile()?yield e:n.isDirectory()&&(yield*listFile(e))}}function toNormalizedAbsolute(t){const e=path_1.default.isAbsolute(t)?t:path_1.default.join(process.cwd(),t);return path_1.default.normalize(e)}async function fuzzySearchTexture(t,e,a){if(!await fs_extra_1.default.pathExists(t))return null;const n=await fs_extra_1.default.readdir(t);for(const s of n){const n=path_1.default.extname(s),o=path_1.default.basename(s,n);if(!e.some(t=>caseInsensitiveStringEqual(o,t)))continue;const r=path_1.default.join(t,s);if((await fs_extra_1.default.stat(r)).isFile()&&a.indexOf(n.toLowerCase())>=0)return r}return null}function caseInsensitiveStringEqual(t,e){return t.length===e.length&&t.toLowerCase()===e.toLowerCase()}exports.resolveGlTfImagePath=resolveGlTfImagePath;const keyFbxGlTfConvImageExtras="FBX-glTF-conv";function normalizePathInFbx(t){return t.split(/[\\/]/g).join(path_1.default.sep)}