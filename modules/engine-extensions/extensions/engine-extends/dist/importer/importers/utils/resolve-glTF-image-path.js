"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveGlTfImagePath=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));async function resolveGlTfImagePath(e,t,a,n,s){if(t&&await fs_extra_1.default.pathExists(t))return t;let r="",o="";if("object"==typeof n&&keyFbxGlTfConvImageExtras in n){console.debug(`Found FBX-glTF-conv specified extras: ${JSON.stringify(n[keyFbxGlTfConvImageExtras],void 0,2)}`);const{fileName:e,relativeFileName:t}=n[keyFbxGlTfConvImageExtras];t&&(o=normalizePathInFbx(t)),e&&(r=normalizePathInFbx(e))}if(o){const e=path_1.default.join(a,o);if(await fs_extra_1.default.pathExists(e))return e}if(r&&await fs_extra_1.default.pathExists(r))return r;console.debug("Image"+`(Name: ${e}, Expected path: ${t})`+" is not found, fuzzy search starts.");const i=t?path_1.default.extname(t):"",u=i.toLowerCase(),l=t?path_1.default.basename(t,i):"",f=new Set;if(0!==l.length&&f.add(l),e&&f.add(e),r&&f.add(path_1.default.basename(r,path_1.default.extname(r))),o&&f.add(path_1.default.basename(o,path_1.default.extname(o))),0===f.size)return null;const d=[".jpg",".jpeg",".png",".tga",".webp"];0===i.length||d.includes(u)||d.unshift(u);const c=["textures","materials"],_=toNormalizedAbsolute(s),h=e=>e.startsWith(_),p=Array.from(f);let x=toNormalizedAbsolute(a);for(let e=0;e<2&&h(x);++e){const e=await fuzzySearchTexture(x,p,d);if(e)return console.debug(`Found ${e}, use it.`),e;const t=await fs_extra_1.default.readdir(x);for(const e of t){if(!c.some(t=>caseInsensitiveStringEqual(e,t)))continue;const t=path_1.default.join(x,e);try{if(!(await fs_extra_1.default.stat(t)).isDirectory())continue}catch(e){}const a=await fuzzySearchTexture(t,p,d);if(a)return console.debug(`Found ${a}, use it.`),a}x=path_1.default.dirname(x)}return console.debug("Fuzzy search failed."),null}function toNormalizedAbsolute(e){const t=path_1.default.isAbsolute(e)?e:path_1.default.join(process.cwd(),e);return path_1.default.normalize(t)}async function fuzzySearchTexture(e,t,a){if(!await fs_extra_1.default.pathExists(e))return null;const n=await fs_extra_1.default.readdir(e);for(const s of n){const n=path_1.default.extname(s),r=path_1.default.basename(s,n);if(!t.some(e=>caseInsensitiveStringEqual(r,e)))continue;const o=path_1.default.join(e,s);if((await fs_extra_1.default.stat(o)).isFile()&&a.indexOf(n.toLowerCase())>=0)return o}return null}function caseInsensitiveStringEqual(e,t){return e.length===t.length&&e.toLowerCase()===t.toLowerCase()}exports.resolveGlTfImagePath=resolveGlTfImagePath;const keyFbxGlTfConvImageExtras="FBX-glTF-conv";function normalizePathInFbx(e){return e.split(/[\\/]/g).join(path_1.default.sep)}