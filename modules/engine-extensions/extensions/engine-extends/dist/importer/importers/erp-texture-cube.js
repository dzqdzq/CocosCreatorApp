"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextureCubeFaceImporter=exports.makeDefaultTextureCubeAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),texture_base_1=require("./texture-base"),equirect_cubemap_faces_1=require("./utils/equirect-cubemap-faces"),cc=__importStar(require("cc")),cube_map_simple_layout_1=require("./utils/cube-map-simple-layout"),migratesNameToId=__importStar(require("./migrates/name2id")),sharp_1=__importDefault(require("sharp")),fs_extra_1=require("fs-extra");function makeDefaultTextureCubeAssetUserData(){const e=texture_base_1.makeDefaultTextureBaseAssetUserData();return e.isRGBE=!1,e.mipfilter="linear",e}exports.makeDefaultTextureCubeAssetUserData=makeDefaultTextureCubeAssetUserData;class ERPTextureCubeImporter extends asset_db_1.Importer{get version(){return"1.0.10"}get name(){return"erp-texture-cube"}get assetType(){return"cc.TextureCube"}get migrations(){return[{version:"1.0.9",migrate:migratesNameToId.migrate}]}async import(e){0===Object.getOwnPropertyNames(e.userData).length&&e.assignUserData(makeDefaultTextureCubeAssetUserData(),!0);const t=e.userData,a=asset_db_1.queryAsset(t.imageDatabaseUri);if(!a)return!1;let r;r=[".tga",".hdr",".bmp"].includes(e.parent.extname.toLowerCase())?a.library+".png":a.source;const s=sharp_1.default(r),i=await s.metadata(),u=i.width,n=i.height;let o;const c=cube_map_simple_layout_1.matchSimpleLayout(u,n);o=c?await this._getFacesInSimpleLayout(s,c):await this._getFacesInEquirectangularProjected(r,0===t.faceSize?void 0:t.faceSize,t.isRGBE);const f={},p=e.getSwapSpace();for(const t of Object.getOwnPropertyNames(o)){const a=o[t];p[t]=a;const r=await e.createSubAsset(t,"texture-cube-face");f[t]=EditorExtends.serialize.asAsset(r.uuid,cc.ImageAsset)}const _=new cc.TextureCube;return texture_base_1.applyTextureBaseAssetUserData(t,_),_.isRGBE=t.isRGBE,_._mipmaps=[f],await e.saveToLibrary(".json",EditorExtends.serialize(_)),!0}async _getFacesInSimpleLayout(e,t){const a={},r=Object.getOwnPropertyNames(t);for(const e of r)a[e]=void 0;return await Promise.all(r.map(async r=>{const s=t[r],i=e.extract({left:s.x,top:s.y,width:s.width,height:s.height}),u=await i.toFormat(sharp_1.default.format.png).toBuffer();a[r]=u})),a}async _getFacesInEquirectangularProjected(e,t,a){const r=await fs_extra_1.readFile(e),s=await sharp_1.default(r),i=await s.metadata();t||(t=0|equirect_cubemap_faces_1.nearestPowerOfTwo((i.width||0)/4));const u=await equirect_cubemap_faces_1.equirectToCubemapFaces(s,t,{isRGBE:a});if(6!==u.length)throw new Error("Failed to resolve equirectangular projection image.");return{right:await sharp_1.default(Buffer.from(u[0].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer(),left:await sharp_1.default(Buffer.from(u[1].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer(),top:await sharp_1.default(Buffer.from(u[2].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer(),bottom:await sharp_1.default(Buffer.from(u[3].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer(),front:await sharp_1.default(Buffer.from(u[4].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer(),back:await sharp_1.default(Buffer.from(u[5].data),{raw:{width:t,height:t,channels:4}}).png().toBuffer()}}}exports.default=ERPTextureCubeImporter;class TextureCubeFaceImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"texture-cube-face"}get assetType(){return"cc.ImageAsset"}async import(e){if(!e.parent)return!1;const t=e.parent.getSwapSpace();if(!t)return!1;const a=e._name;if(!(a in t))return!1;const r=t[a];await e.saveToLibrary(".png",r);const s=new cc.ImageAsset;return s._setRawAsset(".png"),await e.saveToLibrary(".json",EditorExtends.serialize(s)),!0}}exports.TextureCubeFaceImporter=TextureCubeFaceImporter;