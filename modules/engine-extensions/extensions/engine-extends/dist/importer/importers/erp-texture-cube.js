"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkSize=exports.TextureCubeFaceImporter=exports.ERPTextureCubeImporter=exports.MipmapMode=exports.makeDefaultTextureCubeAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),texture_base_1=require("./texture-base"),equirect_cubemap_faces_1=require("./utils/equirect-cubemap-faces"),cc=__importStar(require("cc")),cube_map_simple_layout_1=require("./utils/cube-map-simple-layout"),migratesNameToId=__importStar(require("./migrates/name2id")),sharp_1=__importDefault(require("sharp")),fs_extra_1=require("fs-extra"),path_1=require("path"),fs_extra_2=require("fs-extra"),utils_1=require("../utils");function makeDefaultTextureCubeAssetUserData(){const e=texture_base_1.makeDefaultTextureBaseAssetUserData();return e.isRGBE=!1,e.mipfilter="linear",e}exports.makeDefaultTextureCubeAssetUserData=makeDefaultTextureCubeAssetUserData;const verticalCount=2;var MipmapMode;!function(e){e[e.NONE=0]="NONE",e[e.AUTO=1]="AUTO",e[e.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(MipmapMode=exports.MipmapMode||(exports.MipmapMode={}));class ERPTextureCubeImporter extends asset_db_1.Importer{get version(){return"1.0.10"}get name(){return"erp-texture-cube"}get assetType(){return"cc.TextureCube"}get migrations(){return[{version:"1.0.9",migrate:migratesNameToId.migrate}]}getTop(e,t){return 0==e?0:t.length>0?t[0].height:0}getLeft(e,t){if(e<verticalCount)return 0;let a=0;for(let r=verticalCount-1;r<t.length&&!(r>=e);r++)a+=t[r].width;return a}getMipmapLayout(e){const t=[];let a=0;for(;e;)t.push({left:this.getLeft(a,t),top:this.getTop(a,t),width:e,height:e,level:a++}),e>>=1;return t}getDirOfMipmaps(e,t){const a=path_1.dirname(e),r=path_1.basename(e,t);return path_1.join(a,r+"_convolution")}isNeedConvolution(e){if(!fs_extra_1.existsSync(e))return!0;for(let t=0;t<6;t++){const a=path_1.join(e,"mipmap_"+t.toString()+".png");if(!fs_extra_1.existsSync(a))return!0}return!1}saveMipmaps(e,t){fs_extra_1.existsSync(t)||fs_extra_2.ensureDirSync(t),fs_extra_1.copyFileSync(e,path_1.join(t,path_1.basename(e)))}async import(e){var t;0===Object.getOwnPropertyNames(e.userData).length&&e.assignUserData(makeDefaultTextureCubeAssetUserData(),!0);const a=e.userData,r=asset_db_1.queryAsset(a.imageDatabaseUri);if(!r)return!1;let s;const i=null===(t=e.parent.extname)||void 0===t?void 0:t.toLowerCase();s=[".tga",".hdr",".bmp",".psd",".tif",".tiff",".exr"].includes(i)||!i?r.library+".png":r.source;const o=sharp_1.default(s),n=await o.metadata(),u=n.width,p=n.height;switch(e.userData.mipBakeMode){case MipmapMode.BAKED_CONVOLUTION_MAP:{const t=e.parent.source;let s=path_1.join(e.temp,"mipmap");const o=this.getDirOfMipmaps(r.source,i);if(this.isNeedConvolution(o)){const r=["--srcFaceSize","768","--mipatlas","--filter","radiance","--lightingModel","ggx","--excludeBase","true","--output0params",a.isRGBE?"png,rgbm,facelist":"png,bgra8,facelist","--input",t,"--output0",s];a.isRGBE&&![".hdr",".exr"].includes(i)&&r.splice(0,0,"--rgbm"),fs_extra_2.ensureDirSync(e.temp),console.log(`Start to bake asset {asset[${e.uuid}](${e.uuid})}`);const o=path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64")+("win32"===process.platform?".exe":"");await Editor.Utils.Process.quickSpawn(o,r,{stdio:"inherit"})}else s=path_1.join(o,"mipmap");const n=["right","left","top","bottom","front","back"],u={},p=[],c=e.getSwapSpace();for(let t=0;t<n.length;t++){const a=`${s}_${t}.png`;this.saveMipmaps(a,o);const r=sharp_1.default(a),i=(await r.metadata()).width;p[t]=this.getMipmapLayout(i);const f=n[t],m=await r.toFormat(sharp_1.default.format.png).toBuffer();c[f]=m;const l=await e.createSubAsset(f,"texture-cube-face");u[f]=EditorExtends.serialize.asAsset(l.uuid,cc.ImageAsset)}const f=new cc.TextureCube;texture_base_1.applyTextureBaseAssetUserData(a,f),f.isRGBE=a.isRGBE,f._mipmapMode=MipmapMode.BAKED_CONVOLUTION_MAP,f._mipmapAtlas={atlas:u,layout:p[0]};const m=EditorExtends.serialize(f);await e.saveToLibrary(".json",m);const l=utils_1.getDependUUIDList(m);return e.setData("depends",l),!0}}let c;const f=cube_map_simple_layout_1.matchSimpleLayout(u,p);c=f?await this._getFacesInSimpleLayout(o,f):await this._getFacesInEquirectangularProjected(s,0===a.faceSize?void 0:a.faceSize,a.isRGBE);const m={},l=e.getSwapSpace();for(const t of Object.getOwnPropertyNames(c)){const a=c[t];l[t]=a;const r=await e.createSubAsset(t,"texture-cube-face");m[t]=EditorExtends.serialize.asAsset(r.uuid,cc.ImageAsset)}const _=new cc.TextureCube;texture_base_1.applyTextureBaseAssetUserData(a,_),_.isRGBE=a.isRGBE,_._mipmaps=[m];const d=EditorExtends.serialize(_);await e.saveToLibrary(".json",d);const h=utils_1.getDependUUIDList(d);return e.setData("depends",h),!0}async _getFacesInSimpleLayout(e,t){const a={},r=Object.getOwnPropertyNames(t);for(const e of r)a[e]=void 0;return await Promise.all(r.map(async r=>{const s=t[r],i=e.extract({left:s.x,top:s.y,width:s.width,height:s.height}),o=await i.toFormat(sharp_1.default.format.png).toBuffer();a[r]=o})),a}async _getFacesInEquirectangularProjected(e,t,a){const r=await fs_extra_1.readFile(e),s=await sharp_1.default(r),i=await s.metadata();t||(t=0|equirect_cubemap_faces_1.nearestPowerOfTwo((i.width||0)/4));const o=await equirect_cubemap_faces_1.equirectToCubemapFaces(s,t,{isRGBE:a});if(6!==o.length)throw new Error("Failed to resolve equirectangular projection image.");return{right:await sharp_1.default(Buffer.from(o[0].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),left:await sharp_1.default(Buffer.from(o[1].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),top:await sharp_1.default(Buffer.from(o[2].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),bottom:await sharp_1.default(Buffer.from(o[3].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),front:await sharp_1.default(Buffer.from(o[4].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),back:await sharp_1.default(Buffer.from(o[5].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer()}}}exports.ERPTextureCubeImporter=ERPTextureCubeImporter;class TextureCubeFaceImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"texture-cube-face"}get assetType(){return"cc.ImageAsset"}async import(e){if(!e.parent)return!1;const t=e.parent.getSwapSpace();if(!t)return!1;const a=e._name;if(!(a in t))return!1;let r=".png";e.parent&&e.parent.parent&&[".webp",".jpg"].includes(e.parent.parent.extname)&&(r=e.parent.parent.extname);const s=t[a];await e.saveToLibrary(r,s);const i=new cc.ImageAsset;i._setRawAsset(r);const o=EditorExtends.serialize(i);await e.saveToLibrary(".json",o);const n=utils_1.getDependUUIDList(o);return e.setData("depends",n),!0}}function checkSize(e,t){return 4*e==3*t||3*e==4*t||6*e===t||e===6*t||e===2*t}exports.TextureCubeFaceImporter=TextureCubeFaceImporter,exports.checkSize=checkSize;