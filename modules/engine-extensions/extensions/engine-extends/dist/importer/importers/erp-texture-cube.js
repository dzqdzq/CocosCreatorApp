"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextureCubeFaceImporter=exports.ERPTextureCubeImporter=exports.MipmapMode=exports.makeDefaultTextureCubeAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),texture_base_1=require("./texture-base"),equirect_cubemap_faces_1=require("./utils/equirect-cubemap-faces"),cc=__importStar(require("cc")),cube_map_simple_layout_1=require("./utils/cube-map-simple-layout"),migratesNameToId=__importStar(require("./migrates/name2id")),sharp_1=__importDefault(require("sharp")),fs_extra_1=require("fs-extra"),path_1=require("path"),child_process_1=require("child_process"),fs_extra_2=require("fs-extra"),utils_1=require("../utils");function makeDefaultTextureCubeAssetUserData(){const e=texture_base_1.makeDefaultTextureBaseAssetUserData();return e.isRGBE=!1,e.mipfilter="linear",e}exports.makeDefaultTextureCubeAssetUserData=makeDefaultTextureCubeAssetUserData;const verticalCount=2;var MipmapMode;!function(e){e[e.NONE=0]="NONE",e[e.AUTO=1]="AUTO",e[e.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(MipmapMode=exports.MipmapMode||(exports.MipmapMode={}));class ERPTextureCubeImporter extends asset_db_1.Importer{get version(){return"1.0.10"}get name(){return"erp-texture-cube"}get assetType(){return"cc.TextureCube"}get migrations(){return[{version:"1.0.9",migrate:migratesNameToId.migrate}]}getTop(e,t){return 0==e?0:t.length>0?t[0].height:0}getLeft(e,t){if(e<verticalCount)return 0;let a=0;for(let r=verticalCount-1;r<t.length&&!(r>=e);r++)a+=t[r].width;return a}getMipmapLayout(e){const t=[];let a=0;for(;e;)t.push({left:this.getLeft(a,t),top:this.getTop(a,t),width:e,height:e,level:a++}),e>>=1;return t}async import(e){0===Object.getOwnPropertyNames(e.userData).length&&e.assignUserData(makeDefaultTextureCubeAssetUserData(),!0);const t=e.userData,a=asset_db_1.queryAsset(t.imageDatabaseUri);if(!a)return!1;let r;const s=e.parent.extname.toLowerCase();r=[".tga",".hdr",".bmp",".psd",".tif",".tiff"].includes(s)?a.library+".png":a.source;const i=sharp_1.default(r),o=await i.metadata(),u=o.width,n=o.height;switch(e.userData.mipBakeMode){case MipmapMode.BAKED_CONVOLUTION_MAP:{const a=e.parent.source,r=path_1.join(e.temp,"mipmap"),i=["--srcFaceSize","768","--mipatlas","--filter","radiance","--lightingModel","ggx","--excludeBase","true","--output0params",t.isRGBE?"png,rgbm,facelist":"png,bgra8,facelist","--input",a,"--output0",r];t.isRGBE&&".hdr"!==s&&i.splice(0,0,"--rgbm");const o={stdio:"inherit"};let u;fs_extra_2.ensureDirSync(e.temp),console.log(`Start to bake asset {asset[${e.uuid}](${e.uuid})}`),u="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),i,o):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),i,o),await new Promise((e,t)=>{u.on("exit",a=>{if(0!==a)return console.error("Bake asset failed."),console.error(a),void t(a);console.log("Bake asset success."),e(a)})});const n=["right","left","top","bottom","front","back"],c={},p=[],f=e.getSwapSpace();for(let t=0;t<n.length;t++){const a=`${r}_${t}.png`,s=sharp_1.default(a),i=(await s.metadata()).width;p[t]=this.getMipmapLayout(i);const o=n[t],u=await s.toFormat(sharp_1.default.format.png).toBuffer();f[o]=u;const l=await e.createSubAsset(o,"texture-cube-face");c[o]=EditorExtends.serialize.asAsset(l.uuid,cc.ImageAsset)}const l=new cc.TextureCube;texture_base_1.applyTextureBaseAssetUserData(t,l),l.isRGBE=t.isRGBE,l._mipmapMode=MipmapMode.BAKED_CONVOLUTION_MAP,l._mipmapAtlas={atlas:c,layout:p[0]};const m=EditorExtends.serialize(l);await e.saveToLibrary(".json",m);const d=utils_1.getDependUUIDList(m);return e.setData("depends",d),!0}}let c;const p=cube_map_simple_layout_1.matchSimpleLayout(u,n);c=p?await this._getFacesInSimpleLayout(i,p):await this._getFacesInEquirectangularProjected(r,0===t.faceSize?void 0:t.faceSize,t.isRGBE);const f={},l=e.getSwapSpace();for(const t of Object.getOwnPropertyNames(c)){const a=c[t];l[t]=a;const r=await e.createSubAsset(t,"texture-cube-face");f[t]=EditorExtends.serialize.asAsset(r.uuid,cc.ImageAsset)}const m=new cc.TextureCube;texture_base_1.applyTextureBaseAssetUserData(t,m),m.isRGBE=t.isRGBE,m._mipmaps=[f];const d=EditorExtends.serialize(m);await e.saveToLibrary(".json",d);const _=utils_1.getDependUUIDList(d);return e.setData("depends",_),!0}async _getFacesInSimpleLayout(e,t){const a={},r=Object.getOwnPropertyNames(t);for(const e of r)a[e]=void 0;return await Promise.all(r.map(async r=>{const s=t[r],i=e.extract({left:s.x,top:s.y,width:s.width,height:s.height}),o=await i.toFormat(sharp_1.default.format.png).toBuffer();a[r]=o})),a}async _getFacesInEquirectangularProjected(e,t,a){const r=await fs_extra_1.readFile(e),s=await sharp_1.default(r),i=await s.metadata();t||(t=0|equirect_cubemap_faces_1.nearestPowerOfTwo((i.width||0)/4));const o=await equirect_cubemap_faces_1.equirectToCubemapFaces(s,t,{isRGBE:a});if(6!==o.length)throw new Error("Failed to resolve equirectangular projection image.");return{right:await sharp_1.default(Buffer.from(o[0].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),left:await sharp_1.default(Buffer.from(o[1].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),top:await sharp_1.default(Buffer.from(o[2].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),bottom:await sharp_1.default(Buffer.from(o[3].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),front:await sharp_1.default(Buffer.from(o[4].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer(),back:await sharp_1.default(Buffer.from(o[5].data),{raw:{width:t,height:t,channels:4}}).toFormat(i.format||"png").toBuffer()}}}exports.ERPTextureCubeImporter=ERPTextureCubeImporter;class TextureCubeFaceImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"texture-cube-face"}get assetType(){return"cc.ImageAsset"}async import(e){if(!e.parent)return!1;const t=e.parent.getSwapSpace();if(!t)return!1;const a=e._name;if(!(a in t))return!1;let r=".png";e.parent&&e.parent.parent&&[".webp",".jpg"].includes(e.parent.parent.extname)&&(r=e.parent.parent.extname);const s=t[a];await e.saveToLibrary(r,s);const i=new cc.ImageAsset;i._setRawAsset(r);const o=EditorExtends.serialize(i);await e.saveToLibrary(".json",o);const u=utils_1.getDependUUIDList(o);return e.setData("depends",u),!0}}exports.TextureCubeFaceImporter=TextureCubeFaceImporter;