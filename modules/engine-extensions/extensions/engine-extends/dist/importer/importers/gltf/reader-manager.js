"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.glTfReaderManager=void 0;const utils_1=require("../../utils"),gltf_converter_1=require("../utils/gltf-converter"),validation_1=require("./validation"),fs_extra_1=__importDefault(require("fs-extra"));class GlTfReaderManager{constructor(){this._map=new Map}async getOrCreate(e,r=!1){let t=this._map.get(e.uuid);if(!t){const{converter:a,referencedBufferFiles:s}=await createGlTfReader(e);if(t=a,this._map.set(e.uuid,t),r)for(const r of s)e.depend(r)}return t}delete(e){this._map.delete(e.uuid)}}async function createGlTfReader(e){var r,t,a,s;const n=e._assetDB.importerManager.name2importer[e.meta.importer];if(!n)throw new Error(`Importer is not found for asset ${e.source}`);const o=await n.getGltfFilePath(e),l=o!==e.source,i=e.userData;void 0===i.skipValidation||i.skipValidation||await(0,validation_1.validateGlTf)(o,e.source);const{glTF:_,buffers:u}=await(0,gltf_converter_1.readGltf)(o),c=[],p=await Promise.all(u.map(async e=>Buffer.isBuffer(e)?e:(l||c.push(e),await fs_extra_1.default.readFile(e))));function d(e,r){if(Array.isArray(_[e])){let t;switch(e){case"meshes":t="asset-db.importers.glTF.glTF_asset_group_mesh";break;case"animations":t="asset-db.importers.glTF.glTF_asset_group_animation";break;case"nodes":t="asset-db.importers.glTF.glTF_asset_group_node";break;case"skins":t="asset-db.importers.glTF.glTF_asset_group_skin";break;case"samplers":t="asset-db.importers.glTF.glTF_asset_group_sampler";break;default:t=e}const a=_[e][r];return"string"==typeof a.name&&a.name?(0,utils_1.i18nTranslate)("asset-db.importers.glTF.glTF_asset",{group:(0,utils_1.i18nTranslate)(t),name:a.name,index:r}):(0,utils_1.i18nTranslate)("asset-db.importers.glTF.glTF_asset_no_name",{group:(0,utils_1.i18nTranslate)(t),index:r})}return""}return{converter:new gltf_converter_1.GltfConverter(_,p,o,{logger:(r,t,a)=>{let s;switch(t){case gltf_converter_1.GltfConverter.ConverterError.UnsupportedAlphaMode:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_alpha_mode",{material:d("materials",e.material),mode:e.mode});break}case gltf_converter_1.GltfConverter.ConverterError.UnsupportedTextureParameter:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_texture_parameter",{sampler:"",texture:d("textures",e.texture),type:(0,utils_1.i18nTranslate)("minFilter"===e.type?"asset-db.importers.glTF.min_filter":"magFilter"===e.type?"asset-db.importers.glTF.mag_filter":"asset-db.importers.glTF.wrapMode"),value:""});break}case gltf_converter_1.GltfConverter.ConverterError.UnsupportedChannelPath:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_channel_path",{animation:d("animations",e.animation),channel:e.channel,path:e.path});break}case gltf_converter_1.GltfConverter.ConverterError.ReferenceSkinInDifferentScene:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.reference_skin_in_different_scene",{node:d("nodes",e.node),skin:d("skins",e.skin)});break}case gltf_converter_1.GltfConverter.ConverterError.DisallowCubicSplineChannelSplit:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.disallow_cubic_spline_channel_split",{animation:d("animations",e.animation),channel:e.channel});break}case gltf_converter_1.GltfConverter.ConverterError.FailedToCalculateTangents:{const e=a;s=(0,utils_1.i18nTranslate)("normal"===e.reason?"asset-db.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_normals":"asset-db.importers.glTF.failed_to_calculate_tangents_due_to_lack_of_uvs",{mesh:d("meshes",e.mesh),primitive:e.primitive});break}case gltf_converter_1.GltfConverter.ConverterError.EmptyMorph:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.empty_morph",{mesh:d("meshes",e.mesh),primitive:e.primitive});break}case gltf_converter_1.GltfConverter.ConverterError.UnsupportedExtension:{const e=a;s=(0,utils_1.i18nTranslate)("asset-db.importers.glTF.unsupported_extension",{name:e.name});break}}const n=(0,utils_1.linkToAssetTarget)(e.uuid);switch(r){case gltf_converter_1.GltfConverter.LogLevel.Info:default:console.log(s,n);break;case gltf_converter_1.GltfConverter.LogLevel.Warning:console.warn(s,n);break;case gltf_converter_1.GltfConverter.LogLevel.Error:console.error(s,n);break;case gltf_converter_1.GltfConverter.LogLevel.Debug:console.debug(s,n)}},userData:e.userData,promoteSingleRootNode:null!==(t=null===(r=e.userData)||void 0===r?void 0:r.promoteSingleRootNode)&&void 0!==t&&t,generateLightmapUVNode:null!==(s=null===(a=e.userData)||void 0===a?void 0:a.generateLightmapUVNode)&&void 0!==s&&s}),referencedBufferFiles:c}}exports.glTfReaderManager=new GlTfReaderManager;