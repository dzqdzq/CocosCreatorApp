"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfPrefabImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("./load-asset-sync"),reader_manager_1=require("./reader-manager"),{v5:uuidV5}=require("uuid"),utils_1=require("../../utils"),GLTF_PREFAB_NAMESPACE="8fa06a75-f07a-44d4-82cf-d08c3c986599";class GltfPrefabImporter extends asset_db_1.Importer{get version(){return"1.0.12"}get name(){return"gltf-scene"}get assetType(){return"cc.Prefab"}async import(e){if(!e.parent)return!1;const t=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),r=e.parent.userData,n=t.createScene(e.userData.gltfIndex,new asset_finder_1.DefaultGltfAssetFinder(r.assetFinder)),a=[];for(const t of Object.keys(e.parent.subAssets)){const r=e.parent.subAssets[t];"gltf-animation"===r.meta.importer&&a.push(r.uuid)}let o=null;if(n.getComponentInChildren(cc.SkinnedMeshRenderer)?(o=n.addComponent(cc.SkeletalAnimation))._sockets=t.createSockets(n):0!==a.length&&(o=n.addComponent(cc.Animation)),o){const e=a.map(e=>load_asset_sync_1.loadAssetSync(e,cc.AnimationClip)||null);o._clips=e;for(const t of e)if(t){o._defaultClip=t;break}}if(1===t.gltf.scenes.length){const t=e.parent.basename;n.name=path_1.default.basename(t,path_1.default.extname(t))}const s=generatePrefab(n),i=EditorExtends.serialize(s);await e.saveToLibrary(".json",i);const d=utils_1.getDependUUIDList(i);return e.setData("depends",d),!0}}function getCompressedUuid(e){let t=uuidV5(e,GLTF_PREFAB_NAMESPACE);return t=EditorExtends.UuidUtils.compressUuid(t,!0)}exports.GltfPrefabImporter=GltfPrefabImporter;const nodePathMap=new Map;function getNodePath(e){if(nodePathMap.has(e))return nodePathMap.get(e);let t="";const r=[];let n=e;for(;n;){const e=n.getSiblingIndex();r.push(n.name+e),n=n.parent}return t=r.reverse().join("/"),nodePathMap.set(e,t),t}function nodeFileIdGenerator(e){return getCompressedUuid(getNodePath(e))}function compFileIdGenerator(e,t){return getCompressedUuid(getNodePath(e.node)+"/comp"+t)}function getDumpableNode(e,t){return nodePathMap.clear(),EditorExtends.PrefabUtils.addPrefabInfo(e,e,t,{nodeFileIdGenerator:nodeFileIdGenerator,compFileIdGenerator:compFileIdGenerator}),EditorExtends.PrefabUtils.checkAndStripNode(e),e}function generatePrefab(e){const t=new cc.Prefab,r=getDumpableNode(e,t);return t.data=r,t}