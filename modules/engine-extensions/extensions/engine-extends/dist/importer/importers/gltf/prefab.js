"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfPrefabImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("./load-asset-sync"),reader_manager_1=require("./reader-manager"),{v5:uuidV5}=require("uuid"),utils_1=require("../../utils"),nodePathMap=new Map,GLTF_PREFAB_NAMESPACE="8fa06a75-f07a-44d4-82cf-d08c3c986599";class GltfPrefabImporter extends asset_db_1.Importer{get version(){return"1.0.14"}get name(){return"gltf-scene"}get assetType(){return"cc.Prefab"}async import(e){var t,n,r,o,a,s,i;if(!e.parent)return!1;const d=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),c=e.parent.userData,l=new asset_finder_1.DefaultGltfAssetFinder(c.assetFinder),u=d.createScene(e.userData.gltfIndex,l),f=[];for(const t of Object.keys(e.parent.subAssets)){const n=e.parent.subAssets[t];"gltf-animation"===n.meta.importer&&f.push(n.uuid)}const p=null===(t=c.mountAllAnimationsOnPrefab)||void 0===t||t;let m=null;if(u.getComponentInChildren(cc.SkinnedMeshRenderer)?(m=u.addComponent(cc.SkeletalAnimation))._sockets=d.createSockets(u):0!==f.length&&(m=u.addComponent(cc.Animation)),p&&m){const e=f.map(e=>load_asset_sync_1.loadAssetSync(e,cc.AnimationClip)||null);m._clips=e;for(const t of e)if(t){m._defaultClip=t;break}}if(c.lods&&!c.lods.hasBuiltinLOD&&c.lods.enable){const t=e.parent.subAssets,o={},a={};for(const e in t){const n=t[e];"gltf-mesh"===n.meta.importer&&(n.userData.lodOptions?o[n.uuid]=n.userData:a[n.uuid]=n.userData)}const s=new Array(a.length);u.children.forEach(e=>{const t=e.getComponentsInChildren(cc.MeshRenderer);for(const e in a)t.forEach(t=>{var n;(null===(n=null===t||void 0===t?void 0:t.mesh)||void 0===n?void 0:n.uuid)&&e===t.mesh.uuid&&(t.node.name=t.node.name+"_LOD0",s[a[e].gltfIndex]=t.node)})});for(const e in o){const t=(null===(r=null===(n=c.assetFinder)||void 0===n?void 0:n.meshes)||void 0===r?void 0:r.indexOf(e))||-1;if(-1===t)continue;const a=l.find("meshes",t,cc.Mesh);if(!a)continue;const i=o[e],d=s[i.gltfIndex],u=d.name.replace(/(_LOD0)+$/,`_LOD${i.lodLevel}`),f=cc.instantiate(d);f.name=u;const p=f.getComponent(cc.MeshRenderer);p&&(p.mesh=a),d.parent.addChild(f)}}const _=[];let h=u.getComponent(cc.LODGroup);if(u.children.forEach(e=>{const t=/_LOD(\d+)$/i.exec(e.name);if(t&&t.length>1){if(!h)try{h=u.addComponent(cc.LODGroup)}catch(e){console.error("Add LODGroup component failed!")}const n=parseInt(t[1],10);let r=null===h||void 0===h?void 0:h.LODs[n];(r=void 0!==r?r:_[n])||(r=new cc.LOD,_[n]=r);const o=e=>{const t=e.getComponents(cc.MeshRenderer);t&&t.length>0&&t.forEach(e=>{null===r||void 0===r||r.insertRenderer(-1,e)}),e.children&&e.children.length>0&&e.children.forEach(e=>{o(e)})};o(e)}}),h){let e=.25;const t=_.length;for(let n=0;n<t-1;n++){const t=_[n];e=(null===(a=null===(o=c.lods)||void 0===o?void 0:o.options[n])||void 0===a?void 0:a.screenRatio)||e,h.insertLOD(n,e,t),e/=2}(null===(i=null===(s=c.lods)||void 0===s?void 0:s.options[t-1])||void 0===i?void 0:i.screenRatio)?h.insertLOD(t-1,c.lods.options[t-1].screenRatio,_[t-1]):e<.01?h.insertLOD(t-1,e,_[t-1]):h.insertLOD(t-1,.01,_[t-1])}if(1===d.gltf.scenes.length){const t=e.parent.basename;u.name=path_1.default.basename(t,path_1.default.extname(t))}const g=generatePrefab(u),v=EditorExtends.serialize(g);await e.saveToLibrary(".json",v);const b=utils_1.getDependUUIDList(v);return e.setData("depends",b),nodePathMap.clear(),!0}}function getCompressedUuid(e){let t=uuidV5(e,GLTF_PREFAB_NAMESPACE);return t=EditorExtends.UuidUtils.compressUuid(t,!0)}function getNodePath(e){if(nodePathMap.has(e))return nodePathMap.get(e);let t="";const n=[];let r=e;for(;r;){const e=r.getSiblingIndex();n.push(r.name+e),r=r.parent}return t=n.reverse().join("/"),nodePathMap.set(e,t),t}function nodeFileIdGenerator(e){return getCompressedUuid(getNodePath(e))}function compFileIdGenerator(e,t){return getCompressedUuid(getNodePath(e.node)+"/comp"+t)}function getDumpableNode(e,t){return nodePathMap.clear(),EditorExtends.PrefabUtils.addPrefabInfo(e,e,t,{nodeFileIdGenerator:nodeFileIdGenerator,compFileIdGenerator:compFileIdGenerator}),EditorExtends.PrefabUtils.checkAndStripNode(e),e}function generatePrefab(e){const t=new cc.Prefab,n=getDumpableNode(e,t);return t.data=n,t}exports.GltfPrefabImporter=GltfPrefabImporter;