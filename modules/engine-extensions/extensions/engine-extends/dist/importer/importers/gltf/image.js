"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImageImporter=void 0;const DataURI=__importStar(require("@cocos/data-uri")),asset_db_1=require("@editor/asset-db"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),image_mics_1=require("../image/image-mics"),uri_utils_1=require("../utils/uri-utils"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),match_image_type_pattern_1=require("../utils/match-image-type-pattern"),image_mime_type_to_ext_1=require("../utils/image-mime-type-to-ext"),base64_1=require("../utils/base64"),cc_1=require("cc"),utils_2=require("../../utils"),utils_3=require("../image/utils");class GltfImageImporter extends asset_db_1.Importer{get version(){return"1.0.3"}get name(){return"gltf-embeded-image"}get assetType(){return"cc.ImageAsset"}async import(e){var t;if(!e.parent)return!1;const r=e.userData.gltfIndex,a=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),i=a.gltf.images[r];let s;const o=async t=>{try{const r=url_1.default.fileURLToPath(t),a=await fs_extra_1.default.readFile(r),i=(0,match_image_type_pattern_1.matchImageTypePattern)(a);s={data:a,mimeType:i,extName:path_1.default.extname(r)}}catch(r){console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.failed_to_load_image",{url:t,reason:r}),(0,utils_1.linkToAssetTarget)(e.uuid))}},u=e.getSwapSpace().resolved;if(u){const e=url_1.default.pathToFileURL(u);await o(e.href)}else if(void 0!==i.bufferView)s={data:a.readImageInBufferView(a.gltf.bufferViews[i.bufferView])};else if(void 0!==i.uri){const t=a.path,r=e=>{console.error(`The uri "${i.uri}" provided by model file${t} is not correct: ${e}`)};if(i.uri.startsWith("data:"))try{const e=DataURI.parse(i.uri);if(!e)throw new Error(`Unable to parse data uri "${i.uri}"`);s=resolveImageDataURI(e)}catch(e){r(e)}else{const t=a.path;let s;try{const e=url_1.default.pathToFileURL(t).toString();let a=new urijs_1.default(i.uri);a=a.absoluteTo(e),(0,uri_utils_1.convertsEncodedSeparatorsInURI)(a),s=a.toString()}catch(e){r(e)}s&&(s.startsWith("file://")?await o(s):console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.image_uri_should_be_file_url"),(0,utils_1.linkToAssetTarget)(e.uuid)))}}const n=new cc_1.ImageAsset;if(s){let r;const a=null!==(t=i.mimeType)&&void 0!==t?t:s.mimeType;if(a&&(r=(0,image_mime_type_to_ext_1.imageMimeTypeToExt)(a)),r||(r=s.extName),!r)throw new Error("Unknown image type");let o=s.data;if(".tga"===r.toLowerCase()){const t=await(0,image_mics_1.convertTGA)(o);if(t instanceof Error||!t)return console.error((0,utils_1.i18nTranslate)("asset-db.importers.glTF.failed_to_convert_tga"),(0,utils_1.linkToAssetTarget)(e.uuid)),!1;r=t.extName,o=t.data}else if(".psd"===r.toLowerCase()){const e=await(0,image_mics_1.convertPSD)(o);({extName:r,data:o}=e)}n._setRawAsset(r),e.userData.fixAlphaTransparencyArtifacts=!0,o=await(0,utils_3.handleImageUserData)(e,o,r),await e.saveToLibrary(r,o)}const l=EditorExtends.serialize(n);await e.saveToLibrary(".json",l);const _=(0,utils_2.getDependUUIDList)(l);return e.setData("depends",_),!0}}function resolveImageDataURI(e){if(!e.base64||!e.mediaType||"image"!==e.mediaType.type)throw new Error(`Cannot understand data uri(base64: ${e.base64}, mediaType: ${e.mediaType}) for image.`);const t=(0,base64_1.decodeBase64ToArrayBuffer)(e.data);return{data:Buffer.from(t),mimeType:e.mediaType.value}}exports.GltfImageImporter=GltfImageImporter;