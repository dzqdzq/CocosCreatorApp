"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfAnimationImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),embedded_player_1=require("cc/editor/embedded-player"),url_1=require("url"),serialize_library_1=require("../utils/serialize-library"),split_animation_1=require("../utils/split-animation"),load_asset_sync_1=require("./load-asset-sync"),original_animation_1=require("./original-animation"),utils_1=require("../../utils");class GltfAnimationImporter extends asset_db_1.Importer{get version(){return"1.0.16"}get name(){return"gltf-animation"}get assetType(){return"cc.AnimationClip"}get instantiation(){return".animation"}get migrations(){return[{version:"1.0.16",migrate:migrateEvents_3_3_0}]}async import(e){var t,a,i;if(!e.parent)return!1;const r=e.userData;null!==(t=r.events)&&void 0!==t||(r.events=[]);const n=e.parent.getFilePath(original_animation_1.getOriginalAnimationLibraryPath(e.parent,r.gltfIndex)),s=url_1.pathToFileURL(n).href,o=await new Promise((e,t)=>{cc.assetManager.loadAny({url:s},{preset:"remote"},null,(a,i)=>{a?t(a):e(i)})});let l=r.span;l&&0===l.from&&l.to===e.parent.userData.duration&&(l=void 0);const d=l?split_animation_1.splitAnimation(o,l.from,l.to):o;if(d.name=e._name,d.name.endsWith(".animation")&&(d.name=d.name.substr(0,d.name.length-".animation".length)),d.events=r.events.map(e=>({frame:e.frame,func:e.func,params:e.params.slice()})),d.wrapMode=null!==(a=r.wrapMode)&&void 0!==a?a:cc.AnimationClip.WrapMode.Loop,void 0!==r.speed&&(d.speed=r.speed),void 0!==r.sample&&(d.sample=r.sample),void 0!==r.editorExtras&&(d[cc.editorExtrasTag]=JSON.parse(JSON.stringify(r.editorExtras))),r.embeddedPlayers){const{embeddedPlayers:e}=r;for(const{begin:t,end:a,reconciledSpeed:r,editorExtras:n,playable:s}of e){const e=new embedded_player_1.EmbeddedPlayer;if(void 0!==n&&(e[cc.editorExtrasTag]=JSON.parse(JSON.stringify(n))),e.begin=t,e.end=a,e.reconciledSpeed=r,"animation-clip"===s.type){const t=new embedded_player_1.EmbeddedAnimationClipPlayable;t.path=s.path,s.clip&&(t.clip=null!==(i=load_asset_sync_1.loadAssetSync(s.clip,cc.AnimationClip))&&void 0!==i?i:null),e.playable=t}else if("particle-system"===s.type){const t=new embedded_player_1.EmbeddedParticleSystemPlayable;t.path=s.path,e.playable=t}d[embedded_player_1.addEmbeddedPlayerTag](e)}}d.hash;const{extension:m,data:p}=serialize_library_1.serializeForLibrary(d);await e.saveToLibrary(m,p);const c=utils_1.getDependUUIDList(p);return e.setData("depends",c),!0}}function migrateEvents_3_3_0(e){const t=e.meta.userData.events;if(!t)return;const a=t.map(e=>({frame:e.frame,func:e.functionName,params:e.parameters.slice()}));e.meta.userData.events=a}exports.GltfAnimationImporter=GltfAnimationImporter;