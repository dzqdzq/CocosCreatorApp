"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfAnimationImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),url_1=require("url"),serialize_library_1=require("../utils/serialize-library"),split_animation_1=require("../utils/split-animation"),original_animation_1=require("./original-animation");class GltfAnimationImporter extends asset_db_1.Importer{get version(){return"1.0.16"}get name(){return"gltf-animation"}get assetType(){return"cc.AnimationClip"}get instantiation(){return".animation"}get migrations(){return[{version:"1.0.16",migrate:migrateEvents_3_3_0}]}async import(e){var t,a;if(!e.parent)return!1;const r=e.userData;null!==(t=r.events)&&void 0!==t||(r.events=[]);const i=e.parent.getFilePath(original_animation_1.getOriginalAnimationLibraryPath(e.parent,r.gltfIndex)),n=url_1.pathToFileURL(i).href,o=await new Promise((e,t)=>{cc.assetManager.loadAny({url:n},{preset:"remote"},null,(a,r)=>{a?t(a):e(r)})});let s=r.span;s&&0===s.from&&s.to===e.parent.userData.duration&&(s=void 0);const l=s?split_animation_1.splitAnimation(o,s.from,s.to):o;l.name=e._name,l.name.endsWith(".animation")&&(l.name=l.name.substr(0,l.name.length-".animation".length)),l.events=r.events.map(e=>({frame:e.frame,func:e.func,params:e.params.slice()})),l.wrapMode=null!==(a=r.wrapMode)&&void 0!==a?a:cc.AnimationClip.WrapMode.Loop,void 0!==r.speed&&(l.speed=r.speed),void 0!==r.sample&&(l.sample=r.sample),l.hash;const{extension:m,data:u}=serialize_library_1.serializeForLibrary(l);return await e.saveToLibrary(m,u),!0}}function migrateEvents_3_3_0(e){const t=e.meta.userData.events;if(!t)return;const a=t.map(e=>({frame:e.frame,func:e.functionName,params:e.parameters.slice()}));e.meta.userData.events=a}exports.GltfAnimationImporter=GltfAnimationImporter;