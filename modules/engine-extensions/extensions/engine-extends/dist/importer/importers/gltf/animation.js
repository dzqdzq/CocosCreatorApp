"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,a,r)}:function(e,t,i,a){void 0===a&&(a=i),e[a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfAnimationImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),embedded_player_1=require("cc/editor/embedded-player"),exotic_animation_1=require("cc/editor/exotic-animation"),url_1=require("url"),serialize_library_1=require("../utils/serialize-library"),split_animation_1=require("../utils/split-animation"),load_asset_sync_1=require("./load-asset-sync"),original_animation_1=require("./original-animation"),utils_1=require("../../utils"),assert_1=__importDefault(require("assert"));class GltfAnimationImporter extends asset_db_1.Importer{get version(){return"1.0.17"}get name(){return"gltf-animation"}get assetType(){return"cc.AnimationClip"}get instantiation(){return".animation"}get migrations(){return[{version:"1.0.16",migrate:migrateEvents_3_3_0}]}async import(e){var t,i,a,r;if(!e.parent)return!1;const n=e.userData;null!==(t=n.events)&&void 0!==t||(n.events=[]);const o=e.parent.getFilePath((0,original_animation_1.getOriginalAnimationLibraryPath)(e.parent,n.gltfIndex)),s=(0,url_1.pathToFileURL)(o).href,l=await new Promise((e,t)=>{cc.assetManager.loadAny({url:s},{preset:"remote"},null,(i,a)=>{i?t(i):e(a)})});let d=n.span;d&&0===d.from&&d.to===e.parent.userData.duration&&(d=void 0);const c=d?(0,split_animation_1.splitAnimation)(l,d.from,d.to):l;if(c.name=e._name,c.name.endsWith(".animation")&&(c.name=c.name.substr(0,c.name.length-".animation".length)),c.events=n.events.map(e=>({frame:e.frame,func:e.func,params:e.params.slice()})),c.wrapMode=null!==(i=n.wrapMode)&&void 0!==i?i:cc.AnimationClip.WrapMode.Loop,void 0!==n.speed&&(c.speed=n.speed),void 0!==n.sample&&(c.sample=n.sample),void 0!==n.editorExtras&&(c[cc.editorExtrasTag]=JSON.parse(JSON.stringify(n.editorExtras))),n.embeddedPlayers){const{embeddedPlayers:e}=n;for(const{begin:t,end:i,reconciledSpeed:r,editorExtras:n,playable:o}of e){const e=new embedded_player_1.EmbeddedPlayer;if(void 0!==n&&(e[cc.editorExtrasTag]=JSON.parse(JSON.stringify(n))),e.begin=t,e.end=i,e.reconciledSpeed=r,"animation-clip"===o.type){const t=new embedded_player_1.EmbeddedAnimationClipPlayable;t.path=o.path,o.clip&&(t.clip=null!==(a=(0,load_asset_sync_1.loadAssetSync)(o.clip,cc.AnimationClip))&&void 0!==a?a:null),e.playable=t}else if("particle-system"===o.type){const t=new embedded_player_1.EmbeddedParticleSystemPlayable;t.path=o.path,e.playable=t}c[embedded_player_1.addEmbeddedPlayerTag](e)}}const p=c[exotic_animation_1.additiveSettingsTag];p.enabled=!1,p.refClip=null;const u=[];if(void 0!==n.additive){const e=c[exotic_animation_1.additiveSettingsTag];n.additive.enabled&&(e.enabled=!0,n.additive.refClip&&(u.push(n.additive.refClip),e.refClip=null!==(r=(0,load_asset_sync_1.loadAssetSync)(n.additive.refClip,cc.AnimationClip))&&void 0!==r?r:null))}if(void 0!==n.auxiliaryCurves)for(const[e,{curve:t}]of Object.entries(n.auxiliaryCurves)){const i=cc.deserialize(t,void 0,void 0);(0,assert_1.default)(i instanceof cc.RealCurve);const a=c.addAuxiliaryCurve_experimental(e);a.preExtrapolation=i.preExtrapolation,a.postExtrapolation=i.postExtrapolation,a.assignSorted(i.keyframes())}c.hash;const{extension:m,data:_}=(0,serialize_library_1.serializeForLibrary)(c);await e.saveToLibrary(m,_);const f=(0,utils_1.getDependUUIDList)(_);return e.setData("depends",Array.from(new Set([...f,...u]))),!0}}function migrateEvents_3_3_0(e){const t=e.meta.userData.events;if(!t)return;const i=t.map(e=>({frame:e.frame,func:e.functionName,params:e.parameters.slice()}));e.meta.userData.events=i}exports.GltfAnimationImporter=GltfAnimationImporter;