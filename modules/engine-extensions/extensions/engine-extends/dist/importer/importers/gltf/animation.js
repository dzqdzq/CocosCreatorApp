"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){e[r=void 0===r?a:r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfAnimationImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),embedded_player_1=require("cc/editor/embedded-player"),url_1=require("url"),serialize_library_1=require("../utils/serialize-library"),split_animation_1=require("../utils/split-animation"),load_asset_sync_1=require("./load-asset-sync"),original_animation_1=require("./original-animation"),utils_1=require("../../utils");class GltfAnimationImporter extends asset_db_1.Importer{get version(){return"1.0.16"}get name(){return"gltf-animation"}get assetType(){return"cc.AnimationClip"}get instantiation(){return".animation"}get migrations(){return[{version:"1.0.16",migrate:migrateEvents_3_3_0}]}async import(e){if(!e.parent)return!1;var t=e.userData,a=(null!=t.events||(t.events=[]),e.parent.getFilePath(original_animation_1.getOriginalAnimationLibraryPath(e.parent,t.gltfIndex)));const i=url_1.pathToFileURL(a).href;var a=await new Promise((a,r)=>{cc.assetManager.loadAny({url:i},{preset:"remote"},null,(e,t)=>{e?r(e):a(t)})});let r=t.span;var n=(r=r&&0===r.from&&r.to===e.parent.userData.duration?void 0:r)?split_animation_1.splitAnimation(a,r.from,r.to):a;if(n.name=e._name,n.name.endsWith(".animation")&&(n.name=n.name.substr(0,n.name.length-".animation".length)),n.events=t.events.map(e=>({frame:e.frame,func:e.func,params:e.params.slice()})),n.wrapMode=null!=(a=t.wrapMode)?a:cc.AnimationClip.WrapMode.Loop,void 0!==t.speed&&(n.speed=t.speed),void 0!==t.sample&&(n.sample=t.sample),void 0!==t.editorExtras&&(n[cc.editorExtrasTag]=JSON.parse(JSON.stringify(t.editorExtras))),t.embeddedPlayers){var s,l,o,d,m,a=t["embeddedPlayers"];for({begin:s,end:l,reconciledSpeed:o,editorExtras:d,playable:m}of a){var p,u,_=new embedded_player_1.EmbeddedPlayer;void 0!==d&&(_[cc.editorExtrasTag]=JSON.parse(JSON.stringify(d))),_.begin=s,_.end=l,_.reconciledSpeed=o,"animation-clip"===m.type?((p=new embedded_player_1.EmbeddedAnimationClipPlayable).path=m.path,m.clip&&(p.clip=null!=(u=load_asset_sync_1.loadAssetSync(m.clip,cc.AnimationClip))?u:null),_.playable=p):"particle-system"===m.type&&((u=new embedded_player_1.EmbeddedParticleSystemPlayable).path=m.path,_.playable=u),n[embedded_player_1.addEmbeddedPlayerTag](_)}}n.hash;var{extension:t,data:a}=serialize_library_1.serializeForLibrary(n),t=(await e.saveToLibrary(t,a),utils_1.getDependUUIDList(a));return e.setData("depends",t),!0}}function migrateEvents_3_3_0(e){var t=e.meta.userData.events;t&&(t=t.map(e=>({frame:e.frame,func:e.functionName,params:e.parameters.slice()})),e.meta.userData.events=t)}exports.GltfAnimationImporter=GltfAnimationImporter;