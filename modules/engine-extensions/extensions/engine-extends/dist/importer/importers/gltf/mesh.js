"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfMeshImporter=void 0;const asset_db_1=require("@editor/asset-db"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),cc_1=require("cc"),fs_extra_1=__importDefault(require("fs-extra")),uv_unwrap_1=require("../utils/uv-unwrap"),fs_extra_2=require("fs-extra"),meshOptimizer_1=require("./meshOptimizer");class GltfMeshImporter extends asset_db_1.Importer{get version(){return"1.1.1"}get name(){return"gltf-mesh"}get assetType(){return"cc.Mesh"}get instantiation(){return".mesh"}async import(e){var t,r,s;if(!e.parent)return!1;const i=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),a=e.parent.userData.generateLightmapUVNode,n=e.parent.userData,l=e.userData;let u=i.createMesh(e.userData.gltfIndex,a,null!==(t=n.addVertexColor)&&void 0!==t&&t);if(l.lodOptions){const e=(0,meshOptimizer_1.getDefaultSimplifyOptions)();e.targetRatio=l.lodOptions.faceCount,u=await(0,meshOptimizer_1.simplifyMesh)(u,e)}let o=0;if(l.triangleCount=0,null===(r=u.struct.primitives)||void 0===r||r.forEach(e=>{e&&e.indexView&&(o+=e.indexView.count/3)}),l.triangleCount=o,u.allowDataAccess=null===(s=e.parent.userData.allowMeshDataAccess)||void 0===s||s,a){let t=!1;const r=[],s=[];let i=0;for(let e=0;e<u.struct.primitives.length;e++){const a=u.readAttribute(e,cc_1.gfx.AttributeName.ATTR_POSITION);let n;2===u.struct.vertexBundles[e].view.stride?n=u.readIndices(e):4===u.struct.vertexBundles[e].view.stride?n=u.readIndices(e):(console.warn("Invalid indeces stride"),n=[]);for(let e=0;e<a.length;++e)r.push(a[e]);for(let e=0;e<n.length;++e)s.push(n[e]+i);u.readAttribute(e,cc_1.gfx.AttributeName.ATTR_TEX_COORD1)&&(t=!0),i+=u.struct.vertexBundles[e].view.count}const a=r.length/3,n=new Uint8Array(8+4*r.length+4*s.length),l=new Int32Array(n.buffer,0);l[0]=a,l[1]=s.length;const o=new Float32Array(n.buffer,8),m=new Int32Array(n.buffer,8+4*r.length);for(let e=0;e<r.length;e++)o[e]=r[e];for(let e=0;e<s.length;e++)m[e]=s[e];const f=e.uuid,p=e.temp;await(0,fs_extra_2.ensureDir)(p),await fs_extra_1.default.promises.writeFile(`${p}/${f}_in.bin`,n),await(0,uv_unwrap_1.unwrapLightmapUV)(`${p}/${f}_in.bin`,`${p}/${f}_out.bin`);const c=await fs_extra_1.default.promises.readFile(`${p}/${f}_out.bin`),d=new Uint8Array(c),_=new Float32Array(d.buffer,4);let h=0;for(let e=0;e<u.struct.primitives.length;e++){const t=u.readAttribute(e,cc_1.gfx.AttributeName.ATTR_TEX_COORD1),r=u.struct.vertexBundles[e].attributes;let s=0;if(t.length>0){for(let t=0;t<r.length&&r[t].name!==cc_1.gfx.AttributeName.ATTR_TEX_COORD1;t++){const i=u.readAttributeFormat(e,r[t].name);i&&(s+=i.size)}if(s>0)for(let t=0;t<u.struct.vertexBundles[e].view.count;t++){const r=u.struct.vertexBundles[e].view.offset+s+t*u.struct.vertexBundles[e].view.stride,i=new DataView(u.data.buffer);i.setFloat32(r,_[h],!0),i.setFloat32(r+4,_[h+1],!0),h+=2}}}}n.meshSimplify&&n.meshSimplify.enable&&(u=await(0,meshOptimizer_1.simplifyMesh)(u,n.meshSimplify)),n.meshOptimize&&n.meshOptimize.enable&&(u=await(0,meshOptimizer_1.optimizeMesh)(u,n.meshOptimize)),n.meshCluster&&n.meshCluster.enable&&(u=await(0,meshOptimizer_1.clusterizeMesh)(u,n.meshCluster)),n.meshCompress&&n.meshCompress.enable&&(u=await(0,meshOptimizer_1.compressMesh)(u,n.meshCompress)),0!==u.data.byteLength&&(u._setRawAsset(".bin"),await e.saveToLibrary(".bin",Buffer.from(u.data)));const m=EditorExtends.serialize(u);await e.saveToLibrary(".json",m);const f=(0,utils_1.getDependUUIDList)(m);return e.setData("depends",f),!0}}exports.GltfMeshImporter=GltfMeshImporter;