"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfMeshImporter=void 0;const asset_db_1=require("@editor/asset-db"),reader_manager_1=require("./reader-manager"),utils_1=require("../../utils"),meshSimplify_1=require("./meshSimplify"),cc_1=require("cc"),fs_extra_1=__importDefault(require("fs-extra")),uv_unwrap_1=require("../utils/uv-unwrap"),fs_extra_2=require("fs-extra");class GltfMeshImporter extends asset_db_1.Importer{get version(){return"1.1.0"}get name(){return"gltf-mesh"}get assetType(){return"cc.Mesh"}get instantiation(){return".mesh"}async import(e){var t;if(!e.parent)return!1;const r=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),a=e.parent.userData.generateLightmapUVNode,s=e.parent.userData;let i=r.createMesh(e.userData.gltfIndex,a);if(i.allowDataAccess=null===(t=e.parent.userData.allowMeshDataAccess)||void 0===t||t,a){let t=!1;const r=[],a=[];let s=0;for(let e=0;e<i.struct.primitives.length;e++){const n=i.readAttribute(e,cc_1.gfx.AttributeName.ATTR_POSITION);let u;u=(i.struct.vertexBundles[e].view.count,i.readIndices(e));for(let e=0;e<n.length;++e)r.push(n[e]);for(let e=0;e<u.length;++e)a.push(u[e]+s);i.readAttribute(e,cc_1.gfx.AttributeName.ATTR_TEX_COORD1)&&(t=!0),s+=i.struct.vertexBundles[e].view.count}const n=r.length/3,u=new Uint8Array(8+4*r.length+4*a.length),l=new Int32Array(u.buffer,0);l[0]=n,l[1]=a.length;const o=new Float32Array(u.buffer,8),f=new Int32Array(u.buffer,8+4*r.length);for(let e=0;e<r.length;e++)o[e]=r[e];for(let e=0;e<a.length;e++)f[e]=a[e];const _=e.uuid,c=e.temp;await fs_extra_2.ensureDir(c),await fs_extra_1.default.promises.writeFile(`${c}/${_}_in.bin`,u),await uv_unwrap_1.unwrapLightmapUV(`${c}/${_}_in.bin`,`${c}/${_}_out.bin`);const m=await fs_extra_1.default.promises.readFile(`${c}/${_}_out.bin`),p=new Uint8Array(m),d=new Float32Array(p.buffer,4);let h=0;for(let e=0;e<i.struct.primitives.length;e++){const t=i.readAttribute(e,cc_1.gfx.AttributeName.ATTR_TEX_COORD1),r=i.struct.vertexBundles[e].attributes;let a=0;if(t.length>0){for(let t=0;t<r.length&&r[t].name!==cc_1.gfx.AttributeName.ATTR_TEX_COORD1;t++){const s=i.readAttributeFormat(e,r[t].name);s&&(a+=s.size)}if(a>0)for(let t=0;t<i.struct.vertexBundles[e].view.count;t++){const r=i.struct.vertexBundles[e].view.offset+a+t*i.struct.vertexBundles[e].view.stride,s=new DataView(i.data.buffer);s.setFloat32(r,d[h],!0),s.setFloat32(r+4,d[h+1],!0),h+=2}}}}s.meshOptimizer&&s.meshOptimizer.enable&&"gltfpack"!==s.meshOptimizer.algorithm&&(i=meshSimplify_1.simplifyMesh(i,s.meshOptimizer.simplifyOptions)),0!==i.data.byteLength&&(i._setRawAsset(".bin"),await e.saveToLibrary(".bin",Buffer.from(i.data)));const n=EditorExtends.serialize(i);await e.saveToLibrary(".json",n);const u=utils_1.getDependUUIDList(n);return e.setData("depends",u),!0}}exports.GltfMeshImporter=GltfMeshImporter;