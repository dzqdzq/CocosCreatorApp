"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TexturePackerImporter=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),migratesNameToId=__importStar(require("./migrates/name2id")),sprite_frame_1=require("./sprite-frame"),sprite_atlas_1=__importStar(require("./sprite-atlas")),cc_1=require("cc"),utils_1=require("../utils"),plist=require("plist");class TexturePackerImporter extends sprite_atlas_1.default{get version(){return"1.0.8"}get migrations(){return[{version:"1.0.4",migrate:migratesNameToId.migrate}]}async validate(e){try{const t=plist.parse(await fs_extra_1.readFile(e.source,"utf8"));return void 0!==t.frames&&void 0!==t.metadata}catch(e){return!1}}async import(e){path_1.extname(e.source);const t=e.userData,r=await fs_extra_1.readFile(e.source,"utf8"),a=plist.parse(r),s=a.metadata;if(t.atlasTextureName=s.realTextureFileName||s.textureFileName,t.format=s.format,t.uuid=e.uuid,this.assetDB){const r=path_1.basename(t.atlasTextureName),a=path_1.join(path_1.dirname(e.source),r);fs_extra_1.existsSync(a)||console.warn("Parse Error: Unable to find file Texture, the path: "+a),e.depend(a);const s=this.assetDB.pathToUuid(a);if(!s)return!1;t.textureUuid=s+"@"+require("@editor/asset-db/libs/utils").nameToId("texture")}if(e.userData.textureUuid&&this.assetDB){const r=/\.[^.]+$/;let s="";const i=Object.keys(a.frames),o=new cc.SpriteAtlas;o.name=e.basename||"";for(const u of i){s=u.replace(r,"");const i=a.frames[u],n=await e.createSubAsset(s,"sprite-frame"),c=this.fillFrameData(i,t);c.borderBottom=c.borderBottom|n.userData.borderBottom,c.borderTop=c.borderTop|n.userData.borderTop,c.borderLeft=c.borderLeft|n.userData.borderLeft,c.borderRight=c.borderRight|n.userData.borderRight,"packable"in n.userData&&(c.packable=n.userData.packable),n.assignUserData(c,!0),n.userData.imageUuidOrDatabaseUri=c.imageUuidOrDatabaseUri;const d=u.split(".");d.pop();const l=d.join(".");o.spriteFrames[l]=EditorExtends.serialize.asAsset(n.uuid,cc_1.SpriteFrame)}const u=EditorExtends.serialize(o);await e.saveToLibrary(".json",u);const n=utils_1.getDependUUIDList(u);e.setData("depends",n)}return!0}fillFrameData(e,t){const r=t.format,a=sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(t.textureUuid,t.uuid);let s=!1,i="",o="",u="";1===r||2===r?(s=e.rotated,i=e.sourceSize,o=e.offset,u=e.frame):3===r&&(s=e.textureRotated,i=e.spriteSourceSize,o=e.spriteOffset,u=e.textureRect),a.rotated=s;const n=sprite_atlas_1._parseFloat2(i,cc_1.Size);a.rawWidth=n.width,a.rawHeight=n.height;const c=sprite_atlas_1._parseRect(u);a.trimX=c.x,a.trimY=c.y,a.width=c.width,a.height=c.height;const d=sprite_atlas_1._parseFloat2(o,cc_1.Vec2);return a.offsetX=d.x,a.offsetY=d.y,a}}exports.TexturePackerImporter=TexturePackerImporter;