"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.migratePlatformSettings=exports.migrations=void 0;const migratesNameToId=__importStar(require("../migrates/name2id")),lodash=require("lodash"),resolveQueue=[];function checkQueue(){return new Promise(e=>{resolveQueue.push(e),1===resolveQueue.length&&(e(),e.hasResolve=!0)})}function migrateStep(){const e=resolveQueue.shift();e&&e(),e&&e.hasResolve&&migrateStep()}async function migratePlatformSettings(e){const t=e.userData.platformSettings;if(!t||0===Object.keys(t).length)return;await checkQueue();const r={useCompressTexture:!0,presetId:""};t.default&&1===Object.keys(t).length?["miniGame","web","android","ios","pc"].forEach(e=>{t[e]=t.default}):Object.keys(t).forEach(e=>{if("default"!==e){if("default"!==e&&t.default){const r=JSON.parse(JSON.stringify(t.default));t[e]=Object.assign(r,t[e])}return migrateCompressTextureType(t[e]),"wechat"===e?(t.miniGame=t.wechat,void delete t.wechat):"html5"===e?(t.web=t.html5,void delete t.html5):void 0}}),delete t.default,0!==Object.keys(t).length?(r.presetId=await getPresetId(t),delete e.userData.platformSettings,e.userData.compressSettings=r,migrateStep()):migrateStep()}function migrateCompressTextureType(e){if(!e)return;const t={pvrtc_4bits:"pvrtc_4bits_rgba",pvrtc_2bits:"pvrtc_2bits_rgba",etc1:"etc1_rgb"};Object.keys(e).forEach(r=>{t[r]&&(e[t[r]]=e[r],delete e[r])})}async function getPresetId(e){const t="presetId"+Date.now();let r=await Editor.Profile.getProject("builder","textureCompressConfig.userPreset");if(!r)return r={[t]:{name:t,options:e}},await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",r),t;for(const t of Object.keys(r))if(lodash.isEqual(r[t].options,e))return t;return await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,{name:t,options:e}),t}exports.migrations=[{version:"1.0.13",async migrate(e){const t=Object.keys(e.meta.subMetas);if(1===t.length){let r;switch(e.meta.userData.type){case"raw":break;case"texture":r="texture";break;case"normal map":r="normalMap";break;case"texture cube":r="textureCube";break;case"sprite-frame":r="spriteFrame"}if(r&&t[0]!==r){const s=e.meta.subMetas[r]=e.meta.subMetas[t[0]],a=e.subAssets[r]=e.subAssets[t[0]];s.uuid=s.uuid.replace(`@${t[0]}`,`@${r}`),a.meta.uuid=a.uuid.replace(`@${t[0]}`,`@${r}`),delete e.meta.subMetas[t[0]],delete e.subAssets[t[0]]}}}},{version:"1.0.15",migrate:migratesNameToId.migrate},{version:"1.0.21",migrate:migratePlatformSettings}],exports.migratePlatformSettings=migratePlatformSettings;