"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertHDR=exports.convertTIFF=exports.convertPSD=exports.convertTGA=void 0;const path_1=require("path"),child_process_1=require("child_process"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js")),sharp_1=__importDefault(require("sharp"));async function convertTGA(e){var t=new tga_js_1.default,e=(t.load(e),t.getImageData()),t=new pngjs_1.PNG({width:e.width,height:e.height});return t.data=Buffer.from(e.data),savePNGObject(t)}async function convertPSD(e){e=new psd_js_1.default(e),e.parse(),e=e.image.toPng();return savePNGObject(e)}async function convertTIFF(e){return new Promise((t,r)=>{sharp_1.default(e).png().toBuffer().then(e=>{t({extName:".png",data:e})}).catch(e=>r(e))})}async function savePNGObject(o){return new Promise((e,t)=>{const r=[];o.on("data",e=>{r.push(e)}),o.on("end",()=>{e({extName:".png",data:Buffer.concat(r)})}),o.on("error",e=>{t(e)}),o.pack()})}function convertHDR(e,t,r){const o=path_1.join(r,t);fs_extra_1.ensureDirSync(r);let s;return console.debug(`Start to conver asset {asset[${t}](${t})}`),s="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",o]):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",o]),new Promise((t,r)=>{s.on("close",e=>{0!==e?(console.error("Conver asset failed."),console.error(e),r(e)):(console.log("Conver asset success."),t({extName:".png",source:o+".png"}))})})}exports.convertTGA=convertTGA,exports.convertPSD=convertPSD,exports.convertTIFF=convertTIFF,exports.convertHDR=convertHDR;