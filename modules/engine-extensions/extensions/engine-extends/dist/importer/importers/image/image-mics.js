"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertHDR=exports.convertTIFF=exports.convertPSD=exports.convertTGA=void 0;const path_1=require("path"),child_process_1=require("child_process"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js")),sharp_1=__importDefault(require("sharp"));async function convertTGA(e){const t=new tga_js_1.default;t.load(e);const r=t.getImageData(),o=new pngjs_1.PNG({width:r.width,height:r.height});return o.data=Buffer.from(r.data),await savePNGObject(o)}async function convertPSD(e){const t=new psd_js_1.default(e);return t.parse(),savePNGObject(t.image.toPng())}async function convertTIFF(e){return new Promise((t,r)=>{sharp_1.default(e).png().toBuffer().then(e=>{t({extName:".png",data:e})}).catch(e=>r(e))})}async function savePNGObject(e){return new Promise((t,r)=>{const o=[];e.on("data",e=>{o.push(e)}),e.on("end",()=>{t({extName:".png",data:Buffer.concat(o)})}),e.on("error",e=>{r(e)}),e.pack()})}function convertHDR(e,t,r){const o=path_1.join(r,t);let s;return fs_extra_1.ensureDirSync(r),console.debug(`Start to conver asset {asset[${t}](${t})}`),s="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",o]):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",o]),new Promise((e,t)=>{s.on("close",r=>{if(0!==r)return console.error("Conver asset failed."),console.error(r),void t(r);console.log("Conver asset success."),e({extName:".png",source:o+".png"})})})}exports.convertTGA=convertTGA,exports.convertPSD=convertPSD,exports.convertTIFF=convertTIFF,exports.convertHDR=convertHDR;