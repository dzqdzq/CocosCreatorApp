"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertWithCmft=exports.convertHDR=exports.convertHDROrEXR=exports.convertTIFF=exports.convertPSD=exports.convertImageToHDR=exports.convertTGA=void 0;const path_1=require("path"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js")),sharp_1=__importDefault(require("sharp"));async function convertTGA(t){const e=new tga_js_1.default;e.load(t);const r=e.getImageData(),o=new pngjs_1.PNG({width:r.width,height:r.height});return o.data=Buffer.from(r.data),await savePNGObject(o)}async function convertImageToHDR(t,e,r){const o=(0,path_1.join)(r,e+".hdr");(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(o));let n=(0,path_1.join)(Editor.App.path,"../tools/mali_darwin/convert");"win32"===process.platform&&(n=(0,path_1.join)(Editor.App.path,"../tools/mali_win32/convert.exe"));const a=(0,path_1.dirname)(n);n="."+path_1.sep+(0,path_1.basename)(n);const s=Object.assign({},process.env);return s.PATH=a+":"+s.PATH,await Editor.Utils.Process.quickSpawn(n,[(0,path_1.normalize)(t),(0,path_1.normalize)(o)],{cwd:a,env:s}),{extName:".hdr",source:o}}async function convertPSD(t){const e=new psd_js_1.default(t);return e.parse(),savePNGObject(e.image.toPng())}async function convertTIFF(t){return new Promise((e,r)=>{(0,sharp_1.default)(t).png().toBuffer().then(t=>{e({extName:".png",data:t})}).catch(t=>r(t))})}async function savePNGObject(t){return new Promise((e,r)=>{const o=[];t.on("data",t=>{o.push(t)}),t.on("end",()=>{e({extName:".png",data:Buffer.concat(o)})}),t.on("error",t=>{r(t)}),t.pack()})}async function convertHDROrEXR(t,e,r){console.debug(`Start to conver asset {asset[${e}](${e})}`);const o=(0,path_1.join)(r,e);(0,fs_extra_1.ensureDirSync)(r);const n=(0,path_1.extname)(t);if(".hdr"===n)return await convertWithCmft(t,o);if(".exr"===n)try{return await convertWithCmft(t,o,"_withexr")}catch(n){const a=await convertImageToHDR(t,e,r);return await convertWithCmft(a.source,o)}}async function convertHDR(t,e,r){console.debug(`Start to conver asset {asset[${e}](${e})}`);const o=(0,path_1.join)(r,e);return(0,fs_extra_1.ensureDirSync)(r),await convertWithCmft(t,o)}async function convertWithCmft(t,e,r=""){let o=(0,path_1.join)(Editor.App.path,`../tools/cmft/cmftRelease64${r}${"win32"===process.platform?".exe":""}`);return(0,fs_extra_1.existsSync)(o)||(o=(0,path_1.join)(Editor.App.path,`../tools/cmft/cmftRelease64${"win32"===process.platform?".exe":""}`)),await Editor.Utils.Process.quickSpawn(o,["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",t,"--output0",e]),console.debug(`Conver asset${t} -> PNG success.`),{extName:".png",source:e+".png"}}exports.convertTGA=convertTGA,exports.convertImageToHDR=convertImageToHDR,exports.convertPSD=convertPSD,exports.convertTIFF=convertTIFF,exports.convertHDROrEXR=convertHDROrEXR,exports.convertHDR=convertHDR,exports.convertWithCmft=convertWithCmft;