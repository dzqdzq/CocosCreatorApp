"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertHDR=exports.convertPSD=exports.convertTGA=void 0;const path_1=require("path"),child_process_1=require("child_process"),pngjs_1=require("pngjs"),tga_js_1=__importDefault(require("tga-js")),fs_extra_1=require("fs-extra"),psd_js_1=__importDefault(require("psd.js"));async function convertTGA(e){const t=new tga_js_1.default;t.load(e);const o=t.getImageData(),r=new pngjs_1.PNG({width:o.width,height:o.height});return r.data=Buffer.from(o.data),await savePNGObject(r)}async function convertPSD(e){const t=new psd_js_1.default(e);return t.parse(),savePNGObject(t.image.toPng())}async function savePNGObject(e){return new Promise((t,o)=>{const r=[];e.on("data",e=>{r.push(e)}),e.on("end",()=>{t({extName:".png",data:Buffer.concat(r)})}),e.on("error",e=>{o(e)}),e.pack()})}function convertHDR(e,t,o){const r=path_1.join(o,t);let s;return fs_extra_1.ensureDirSync(o),console.debug(`Start to conver asset {asset[${t}](${t})}`),s="darwin"===process.platform?child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",r]):child_process_1.spawn(path_1.join(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),["--bypassoutputtype","--output0params","png,rgbm,latlong","--input",e,"--output0",r]),new Promise((e,t)=>{s.on("close",o=>{if(0!==o)return console.error("Conver asset failed."),console.error(o),void t(o);console.log("Conver asset success."),e({extName:".png",source:r+".png"})})})}exports.convertTGA=convertTGA,exports.convertPSD=convertPSD,exports.convertHDR=convertHDR;