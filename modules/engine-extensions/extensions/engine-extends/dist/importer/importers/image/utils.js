"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importWithType=exports.handleImageUserData=exports.isCapableToFixAlphaTransparencyArtifacts=exports.saveImageAsset=void 0;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),utils_1=require("../../utils"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),bleeding_1=require("../utils/algorithm/bleeding"),RGBChannels=3,RGBAChannels=4;async function saveImageAsset(e,a,t,r){"string"==typeof a?await e.copyToLibrary(t,a):await e.saveToLibrary(t,a);const s=new cc_1.ImageAsset;s.name=r,s._setRawAsset(t);const i=EditorExtends.serialize(s);await e.saveToLibrary(".json",i);const u=(0,utils_1.getDependUUIDList)(i);e.setData("depends",u)}function isCapableToFixAlphaTransparencyArtifacts(e,a,t){if(["normal map","texture cube","sprite-frame","texture"].includes(a))return!1;const r=t.toLocaleLowerCase().replace(".",""),s=e.userData;return!["hdr","exr"].includes(r)&&!s.isRGBE}async function handleImageUserData(e,a,t){"string"==typeof a&&(a=await(0,fs_extra_1.readFile)(a));const r=e.userData,s=(0,sharp_1.default)(a),i=await s.metadata();if(r.hasAlpha=i.hasAlpha,r.type||(r.type="texture"),!!r.flipVertical&&(a=await s.flip().toBuffer()),!1!==r.fixAlphaTransparencyArtifacts&&i.hasAlpha){const e=await(0,sharp_1.default)(a).raw().toBuffer();let t=!1;for(let a=0;a<e.length;a+=RGBAChannels){if(0===e[a+3]){t=!0;break}}if(t){const t=Buffer.from(e),r=[-1,0,1,-1,1,-1,0,1],s=[-1,-1,-1,0,0,1,1,1],u=[],n=i.width*RGBAChannels;for(let e=0;e<r.length;e++)u[e]=r[e]*RGBAChannels+s[e]*n;(0,bleeding_1.applyContourBleed)(t,e,i.width,new cc_1.Rect(0,0,i.width,i.height),r,s,u),a=await(0,sharp_1.default)(t,{raw:{channels:RGBAChannels,height:i.height,width:i.width}}).toFormat("png").toBuffer()}}if(r.flipGreenChannel){const e=await(0,sharp_1.default)(a),{width:t,height:r}=await e.metadata(),s=await e.raw().toBuffer(),i=s.length/t/r;for(let e=1;e<s.length;e=i+e)s[e]=255-s[e];const u={raw:{width:t,height:r,channels:i}};a=await(0,sharp_1.default)(s,u).toFormat("png").toBuffer()}return a}async function importWithType(e,a,t,r){const s=e.userData;switch(a){case"raw":delete s.redirect;break;case"texture":{const a=await e.createSubAsset("texture","texture",{displayName:t});s.redirect=a.uuid,a.assignUserData((0,texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid)(e.uuid,r)),a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.visible=!1}break;case"normal map":{const a=await e.createSubAsset("normalMap","texture",{displayName:t});s.redirect=a.uuid,a.assignUserData((0,texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid)(e.uuid))}break;case"texture cube":{const a=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:t});s.redirect=a.uuid,a.assignUserData((0,erp_texture_cube_1.makeDefaultTextureCubeAssetUserData)()),a.userData.imageDatabaseUri=e.uuid,a.userData.isRGBE=!!s.isRGBE}break;case"sprite-frame":{const a=await e.createSubAsset("texture","texture",{displayName:t});a.userData.wrapModeS=a.userData.wrapModeS||"clamp-to-edge",a.userData.wrapModeT=a.userData.wrapModeT||"clamp-to-edge",s.redirect=a.uuid,a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.isUuid=!0,a.userData.visible=!1;const r=await e.createSubAsset("spriteFrame","sprite-frame",{displayName:t});s.redirect=r.uuid,r.assignUserData((0,sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid)(a.uuid,"")),r.userData.imageUuidOrDatabaseUri=a.uuid}}}exports.saveImageAsset=saveImageAsset,exports.isCapableToFixAlphaTransparencyArtifacts=isCapableToFixAlphaTransparencyArtifacts,exports.handleImageUserData=handleImageUserData,exports.importWithType=importWithType;