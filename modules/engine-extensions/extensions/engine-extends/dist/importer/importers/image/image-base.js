"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageBaseImporter=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),texture_1=require("../texture"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),cc_1=require("cc"),bleeding_1=require("../utils/algorithm/bleeding"),utils_1=require("../../utils");class ImageBaseImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}async saveImageAsset(e,a,t,r){"string"==typeof a?await e.copyToLibrary(t,a):await e.saveToLibrary(t,a);const s=new cc_1.ImageAsset;s.name=r,s._setRawAsset(t);const i=EditorExtends.serialize(s);await e.saveToLibrary(".json",i);const u=utils_1.getDependUUIDList(i);e.setData("depends",u)}isCapableToFixAlphaTransparencyArtifacts(e,a,t){const r=t.toLocaleLowerCase().replace(".",""),s=e.userData;return!(["hdr","exr"].includes(r)||["normal map"].includes(s.type)||s.isRGBE||["normal map","texture cube"].includes(a))}async handleImageUserData(e,a,t){"string"==typeof a&&(a=await fs_extra_1.readFile(a));const r=e.userData,s=await sharp_1.default(a),i=await s.metadata();if(r.hasAlpha=i.hasAlpha,r.type||(r.type="texture"),!!r.flipVertical&&(a=await s.flip().toBuffer()),!1!==r.fixAlphaTransparencyArtifacts&&i.hasAlpha){const e=await sharp_1.default(a).raw().toBuffer();let t=!1;for(let a=0;a<e.length;a+=4){if(0===e[a+3]){t=!0;break}}if(t){const t=new cc_1.Rect(0,0,i.width,i.height),r=[-1,0,1,-1,1,-1,0,1],s=[-1,-1,-1,0,0,1,1,1],u=[],n=4,d=t.width*n;for(let e=0;e<r.length;e++)u[e]=r[e]*n+s[e]*d;bleeding_1.applyContourBleed(e,e,t.width,t,r,s,u),a=await sharp_1.default(e,{raw:{channels:i.channels,height:t.height,width:t.width}}).toFormat("png").toBuffer()}}if(r.flipGreenChannel){let e;(e=e||(e={}))[e.Red=0]="Red",e[e.Green=1]="Green",e[e.Blue=2]="Blue",e[e.Alpha=3]="Alpha";let t=await sharp_1.default(a);const{channels:r,width:s,height:i}=await t.metadata(),u=await t.raw().toBuffer();for(let a=e.Green;a<u.length;a=r+a)u[a]=255-u[a];const n={raw:{width:s,height:i,channels:r}};t=await sharp_1.default(u,n),a=await t.toFormat("png").toBuffer()}var u;return a}async importWithType(e,a,t,r){const s=e.userData;switch(a){case"raw":delete s.redirect;break;case"texture":{const a=await e.createSubAsset("texture","texture",{displayName:t});s.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid,r)),a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.visible=!0}break;case"normal map":{const a=await e.createSubAsset("normalMap","texture",{displayName:t});s.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid))}break;case"texture cube":{const a=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:t});s.redirect=a.uuid,a.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),a.userData.imageDatabaseUri=e.uuid,a.userData.isRGBE=!!s.isRGBE}break;case"sprite-frame":{const a=await e.createSubAsset("texture","texture",{displayName:t});a.userData.wrapModeS=a.userData.wrapModeS||"clamp-to-edge",a.userData.wrapModeT=a.userData.wrapModeT||"clamp-to-edge",s.redirect=a.uuid,a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.isUuid=!0,a.userData.visible=!1;const r=await e.createSubAsset("spriteFrame","sprite-frame",{displayName:t});s.redirect=r.uuid,r.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(a.uuid,"")),r.userData.imageUuidOrDatabaseUri=a.uuid}}}}exports.ImageBaseImporter=ImageBaseImporter;