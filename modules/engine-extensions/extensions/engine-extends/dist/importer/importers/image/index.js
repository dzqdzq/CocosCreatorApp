"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageImporter=void 0;const fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),sharp_1=__importDefault(require("sharp")),path_1=require("path"),image_base_1=require("./image-base"),utils_1=require("./utils");class ImageImporter extends image_base_1.ImageBaseImporter{get version(){return"1.0.26"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),t=e.source;const r=e.meta.userData;if(".bmp"===a){const i=await(0,image_mics_1.convertHDR)(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert bmp image."),!1;a=i.extName,t=i.source,r.isRGBE=!0,r.fixAlphaTransparencyArtifacts||(r.fixAlphaTransparencyArtifacts=!1)}else if(".znt"===a){const i=e.source,s=await(0,image_mics_1.convertHDR)(i,e.uuid,e.temp);if(s instanceof Error||!s)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=s.extName,t=s.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0}else if(".hdr"===a||".exr"===a){const i=e.source,s=await(0,image_mics_1.convertHDROrEXR)(i,e.uuid,e.temp);if(s instanceof Error||!s)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=s.extName,t=s.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0;const o=await(0,sharp_1.default)(t),n=await o.metadata();!r.type&&(0,erp_texture_cube_1.checkSize)(n.width,n.height)&&(r.type="texture cube");const c=(0,path_1.join)(s.source.replace(".png","_sign.png"));(0,fs_extra_1.existsSync)(c)&&(r.sign=Editor.UI.File.resolveToUrl(c,"project"));const u=(0,path_1.join)(s.source.replace(".png","_alpha.png"));(0,fs_extra_1.existsSync)(u)&&(r.alpha=Editor.UI.File.resolveToUrl(u,"project"))}else if(".tga"===a){const r=await(0,image_mics_1.convertTGA)(await(0,fs_extra_1.readFile)(e.source));if(r instanceof Error||!r)return console.error("Failed to convert tga image."),!1;a=r.extName,t=r.data}else if(".psd"===a){const r=await(0,image_mics_1.convertPSD)(await(0,fs_extra_1.readFile)(e.source));a=r.extName,t=r.data}else if(".tif"===a||".tiff"===a){const r=await(0,image_mics_1.convertTIFF)(e.source);if(r instanceof Error||!r)return console.error(`Failed to convert ${a} image.`),!1;a=r.extName,t=r.data}return t=await(0,utils_1.handleImageUserData)(e,t,a),void 0===r.fixAlphaTransparencyArtifacts&&(r.fixAlphaTransparencyArtifacts=(0,utils_1.isCapableToFixAlphaTransparencyArtifacts)(e,r.type,e.extname)),await(0,utils_1.saveImageAsset)(e,t,a,e.basename),await(0,utils_1.importWithType)(e,r.type,e.basename,e.extname),r.sign&&await e.createSubAsset("sign","sign-image",{displayName:"sign"}),r.alpha&&await e.createSubAsset("alpha","alpha-image",{displayName:"alpha"}),!0}}exports.ImageImporter=ImageImporter;