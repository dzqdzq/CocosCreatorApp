"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageImporter=void 0;const fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),sharp_1=__importDefault(require("sharp")),path_1=require("path"),image_base_1=require("./image-base");class ImageImporter extends image_base_1.ImageBaseImporter{get version(){return"1.0.25"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),t=e.source;const r=e.meta.userData;if(".bmp"===a){const i=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert bmp image."),!1;a=i.extName,t=i.source,r.isRGBE=!0,r.fixAlphaTransparencyArtifacts||(r.fixAlphaTransparencyArtifacts=!1)}else if(".znt"===a){const i=e.source,s=await image_mics_1.convertHDR(i,e.uuid,e.temp);if(s instanceof Error||!s)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=s.extName,t=s.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0}else if(".hdr"===a||".exr"===a){const i=e.source,s=await image_mics_1.convertHDROrEXR(i,e.uuid,e.temp);if(s instanceof Error||!s)return console.error(`Failed to convert asset {asset(${e.uuid})}.`),!1;a=s.extName,t=s.source,r.fixAlphaTransparencyArtifacts=!1,r.isRGBE=!0;const o=await sharp_1.default(t),n=await o.metadata();!r.type&&erp_texture_cube_1.checkSize(n.width,n.height)&&(r.type="texture cube");const c=path_1.join(s.source.replace(".png","_sign.png"));fs_extra_1.existsSync(c)&&(r.sign=Editor.UI.File.resolveToUrl(c,"project"));const m=path_1.join(s.source.replace(".png","_alpha.png"));fs_extra_1.existsSync(m)&&(r.alpha=Editor.UI.File.resolveToUrl(m,"project"))}else if(".tga"===a){const r=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(r instanceof Error||!r)return console.error("Failed to convert tga image."),!1;a=r.extName,t=r.data}else if(".psd"===a){const r=await image_mics_1.convertPSD(await fs_extra_1.readFile(e.source));a=r.extName,t=r.data}else if(".tif"===a||".tiff"===a){const r=await image_mics_1.convertTIFF(e.source);if(r instanceof Error||!r)return console.error(`Failed to convert ${a} image.`),!1;a=r.extName,t=r.data}return void 0===r.fixAlphaTransparencyArtifacts&&(r.fixAlphaTransparencyArtifacts=this.isCapableToFixAlphaTransparencyArtifacts(e,r.type,e.extname)),t=await this.handleImageUserData(e,t,a),await this.saveImageAsset(e,t,a,e.basename),await this.importWithType(e,r.type,e.basename,e.extname),r.sign&&await e.createSubAsset("sign","sign-image",{displayName:"sign"}),r.alpha&&await e.createSubAsset("alpha","alpha-image",{displayName:"alpha"}),!0}}exports.ImageImporter=ImageImporter;