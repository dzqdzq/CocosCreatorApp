"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),assert_1=require("assert"),fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),cc_1=require("cc"),sharp_1=__importDefault(require("sharp"));class ImageImporter extends asset_db_1.Importer{get version(){return"1.0.22"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),t=e.source;if(".bmp"===a){const r=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(r instanceof Error||!r)return console.error("Failed to convert bmp image."),!1;a=r.extName,t=r.source,e.userData.isRGBE=!0}else if(".hdr"===a){const r=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(r instanceof Error||!r)return console.error("Failed to convert hdr image."),!1;a=r.extName,t=r.source,e.userData.type=e.userData.type||"texture cube",e.userData.isRGBE=!0}else if(".tga"===a){const r=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(r instanceof Error||!r)return console.error("Failed to convert tga image."),!1;a=r.extName,t=r.data}else if(".psd"===a){const r=await image_mics_1.convertPSD(await fs_extra_1.readFile(e.source));a=r.extName,t=r.data}"string"==typeof t&&(t=await fs_extra_1.readFile(t));const r=await sharp_1.default(t),s=await r.metadata();e.userData.hasAlpha=s.hasAlpha,!!e.userData.flipVertical&&(t=await r.flip().toBuffer()),"string"==typeof t?await e.copyToLibrary(a,t):await e.saveToLibrary(a,t);const i=new cc_1.ImageAsset;i._setRawAsset(a),await e.saveToLibrary(".json",EditorExtends.serialize(i));const u=asset_db_1.queryUrl(e.source);if(!u)throw new assert_1.AssertionError({message:`${e.source} is not found in asset-db.`});const o=e.userData.type||"texture";switch(e.userData.type=o,o){case"raw":delete e.userData.redirect;break;case"texture":const a=await e.createSubAsset("texture","texture",{displayName:e.basename});e.userData.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid)),a.userData.imageUuidOrDatabaseUri=e.uuid;break;case"normal map":const t=await e.createSubAsset("normalMap","texture",{displayName:e.basename});e.userData.redirect=t.uuid,t.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));break;case"texture cube":const r=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:e.basename});e.userData.redirect=r.uuid,r.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),r.userData.imageDatabaseUri=u,r.userData.isRGBE=!!e.userData.isRGBE;break;case"sprite-frame":const s=await e.createSubAsset("texture","texture",{displayName:e.basename});s.userData.wrapModeS="clamp-to-edge",s.userData.wrapModeT="clamp-to-edge",e.userData.redirect=s.uuid,s.userData.imageUuidOrDatabaseUri=e.uuid,s.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));const i=await e.createSubAsset("spriteFrame","sprite-frame",{displayName:e.basename});e.userData.redirect=i.uuid,i.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(s.uuid,"")),i.userData.imageUuidOrDatabaseUri=s.uuid}return!0}}exports.default=ImageImporter;