"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageImporter=void 0;const asset_db_1=require("@editor/asset-db"),assert_1=require("assert"),fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),cc_1=require("cc"),sharp_1=__importDefault(require("sharp")),bleeding_1=require("../utils/algorithm/bleeding"),utils_1=require("../../utils");class ImageImporter extends asset_db_1.Importer{get version(){return"1.0.25"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}getDefaultFixAlphaTransparencyArtifactsOfType(e){return!["normal map","texture cube"].includes(e)}isCapableToFixAlphaTransparencyArtifacts(e){const a=e.extname.toLocaleLowerCase().replace(".",""),t=e.userData;return!["hdr"].includes(a)&&!["normal map"].includes(t.type)&&!t.isRGBE}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),t=e.source;const r=e.meta.userData;if(".bmp"===a){const s=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(s instanceof Error||!s)return console.error("Failed to convert bmp image."),!1;a=s.extName,t=s.source,r.isRGBE=!0,r.fixAlphaTransparencyArtifacts||(r.fixAlphaTransparencyArtifacts=!1)}else if(".hdr"===a){const s=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(s instanceof Error||!s)return console.error("Failed to convert hdr image."),!1;a=s.extName,t=s.source,r.type||(r.type="texture cube"),r.fixAlphaTransparencyArtifacts||(r.fixAlphaTransparencyArtifacts=!1),r.isRGBE=!0}else if(".tga"===a){const r=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(r instanceof Error||!r)return console.error("Failed to convert tga image."),!1;a=r.extName,t=r.data}else if(".psd"===a){const r=await image_mics_1.convertPSD(await fs_extra_1.readFile(e.source));a=r.extName,t=r.data}else if(".tif"===a||".tiff"===a){const r=await image_mics_1.convertTIFF(e.source);if(r instanceof Error||!r)return console.error(`Failed to convert ${a} image.`),!1;a=r.extName,t=r.data}"string"==typeof t&&(t=await fs_extra_1.readFile(t)),r.type||(r.type="texture"),void 0===r.fixAlphaTransparencyArtifacts&&(r.fixAlphaTransparencyArtifacts=this.getDefaultFixAlphaTransparencyArtifactsOfType(r.type));const s=await sharp_1.default(t),i=await s.metadata();if(r.hasAlpha=i.hasAlpha,!!r.flipVertical&&(t=await s.flip().toBuffer()),!1!==r.fixAlphaTransparencyArtifacts&&i.hasAlpha&&this.isCapableToFixAlphaTransparencyArtifacts(e)){const e=await sharp_1.default(t).raw().toBuffer();let a=!1;for(let t=0;t<e.length;t+=4){if(0===e[t+3]){a=!0;break}}if(a){const a=new cc_1.Rect(0,0,i.width,i.height),r=[-1,0,1,-1,1,-1,0,1],s=[-1,-1,-1,0,0,1,1,1],u=[],n=4,o=a.width*n;for(let e=0;e<r.length;e++)u[e]=r[e]*n+s[e]*o;bleeding_1.applyContourBleed(e,e,a.width,a,r,s,u),t=await sharp_1.default(e,{raw:{channels:i.channels,height:a.height,width:a.width}}).toFormat("png").toBuffer()}}"string"==typeof t?await e.copyToLibrary(a,t):await e.saveToLibrary(a,t);const u=new cc_1.ImageAsset;u.name=e.basename||"",u._setRawAsset(a);const n=EditorExtends.serialize(u);await e.saveToLibrary(".json",n);const o=utils_1.getDependUUIDList(n);e.setData("depends",o);const c=asset_db_1.queryUrl(e.source);if(!c)throw new assert_1.AssertionError({message:`${e.source} is not found in asset-db.`});switch(r.type){case"raw":delete r.redirect;break;case"texture":{const a=await e.createSubAsset("texture","texture",{displayName:e.basename});r.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid)),a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.visible=!0}break;case"normal map":{const a=await e.createSubAsset("normalMap","texture",{displayName:e.basename});r.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid))}break;case"texture cube":{const a=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:e.basename});r.redirect=a.uuid,a.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),a.userData.imageDatabaseUri=c,a.userData.isRGBE=!!r.isRGBE}break;case"sprite-frame":{const a=await e.createSubAsset("texture","texture",{displayName:e.basename});a.userData.wrapModeS=a.userData.wrapModeS||"clamp-to-edge",a.userData.wrapModeT=a.userData.wrapModeT||"clamp-to-edge",r.redirect=a.uuid,a.userData.imageUuidOrDatabaseUri=e.uuid,a.userData.isUuid=!0,a.userData.visible=!1;const t=await e.createSubAsset("spriteFrame","sprite-frame",{displayName:e.basename});r.redirect=t.uuid,t.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(a.uuid,"")),t.userData.imageUuidOrDatabaseUri=a.uuid}}return!0}}exports.ImageImporter=ImageImporter;