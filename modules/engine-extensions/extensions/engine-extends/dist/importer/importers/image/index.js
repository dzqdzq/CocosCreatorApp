"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageImporter=void 0;const asset_db_1=require("@editor/asset-db"),assert_1=require("assert"),fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),cc_1=require("cc"),sharp_1=__importDefault(require("sharp")),bleeding_1=require("../utils/algorithm/bleeding"),utils_1=require("../../utils");class ImageImporter extends asset_db_1.Importer{get version(){return"1.0.25"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}getDefaultFixAlphaTransparencyArtifactsOfType(e){return!["normal map","texture cube"].includes(e)}isCapableToFixAlphaTransparencyArtifacts(e){var a=e.extname.toLocaleLowerCase().replace(".",""),e=e.userData;return!["hdr"].includes(a)&&!["normal map"].includes(e.type)&&!e.isRGBE}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname.toLocaleLowerCase(),r=e.source;var t=e.meta.userData;if(".bmp"===a){var i=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert bmp image."),!1;a=i.extName,r=i.source,t.isRGBE=!0,t.fixAlphaTransparencyArtifacts||(t.fixAlphaTransparencyArtifacts=!1)}else if(".hdr"===a){i=await image_mics_1.convertHDR(e.source,e.uuid,e.temp);if(i instanceof Error||!i)return console.error("Failed to convert hdr image."),!1;a=i.extName,r=i.source,t.type||(t.type="texture cube"),t.fixAlphaTransparencyArtifacts||(t.fixAlphaTransparencyArtifacts=!1),t.isRGBE=!0}else if(".tga"===a){i=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(i instanceof Error||!i)return console.error("Failed to convert tga image."),!1;a=i.extName,r=i.data}else if(".psd"===a){i=await image_mics_1.convertPSD(await fs_extra_1.readFile(e.source));a=i.extName,r=i.data}else if(".tif"===a||".tiff"===a){i=await image_mics_1.convertTIFF(e.source);if(i instanceof Error||!i)return console.error(`Failed to convert ${a} image.`),!1;a=i.extName,r=i.data}"string"==typeof r&&(r=await fs_extra_1.readFile(r)),t.type||(t.type="texture"),void 0===t.fixAlphaTransparencyArtifacts&&(t.fixAlphaTransparencyArtifacts=this.getDefaultFixAlphaTransparencyArtifactsOfType(t.type));var i=await sharp_1.default(r),s=await i.metadata(),u=(t.hasAlpha=s.hasAlpha,!!t.flipVertical);if(u&&(r=await i.flip().toBuffer()),!1!==t.fixAlphaTransparencyArtifacts&&s.hasAlpha&&this.isCapableToFixAlphaTransparencyArtifacts(e)){var n=await sharp_1.default(r).raw().toBuffer();let a=!1;for(let e=0;e<n.length;e+=4)if(0===n[e+3]){a=!0;break}if(a){var u=new cc_1.Rect(0,0,s.width,s.height),o=[-1,0,1,-1,1,-1,0,1],c=[-1,-1,-1,0,0,1,1,1],m=[],p=4*u.width;for(let e=0;e<o.length;e++)m[e]=4*o[e]+c[e]*p;bleeding_1.applyContourBleed(n,n,u.width,u,o,c,m),r=await sharp_1.default(n,{raw:{channels:s.channels,height:u.height,width:u.width}}).toFormat("png").toBuffer()}}"string"==typeof r?await e.copyToLibrary(a,r):await e.saveToLibrary(a,r);var i=new cc_1.ImageAsset,s=(i.name=e.basename||"",i._setRawAsset(a),EditorExtends.serialize(i)),u=(await e.saveToLibrary(".json",s),utils_1.getDependUUIDList(s)),l=(e.setData("depends",u),asset_db_1.queryUrl(e.source));if(!l)throw new assert_1.AssertionError({message:e.source+" is not found in asset-db."});switch(t.type){case"raw":delete t.redirect;break;case"texture":var d=await e.createSubAsset("texture","texture",{displayName:e.basename});t.redirect=d.uuid,d.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid)),d.userData.imageUuidOrDatabaseUri=e.uuid,d.userData.visible=!0;break;case"normal map":d=await e.createSubAsset("normalMap","texture",{displayName:e.basename});t.redirect=d.uuid,d.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));break;case"texture cube":d=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:e.basename});t.redirect=d.uuid,d.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),d.userData.imageDatabaseUri=l,d.userData.isRGBE=!!t.isRGBE;break;case"sprite-frame":var d=await e.createSubAsset("texture","texture",{displayName:e.basename}),f=(d.userData.wrapModeS=d.userData.wrapModeS||"clamp-to-edge",d.userData.wrapModeT=d.userData.wrapModeT||"clamp-to-edge",t.redirect=d.uuid,d.userData.imageUuidOrDatabaseUri=e.uuid,d.userData.isUuid=!0,d.userData.visible=!1,await e.createSubAsset("spriteFrame","sprite-frame",{displayName:e.basename}));t.redirect=f.uuid,f.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(d.uuid,"")),f.userData.imageUuidOrDatabaseUri=d.uuid}return!0}}exports.ImageImporter=ImageImporter;