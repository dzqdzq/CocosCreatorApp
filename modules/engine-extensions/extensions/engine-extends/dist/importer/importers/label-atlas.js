"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),path_1=require("path"),utils_1=require("../utils"),fntParser=require("../../../static/utils/fnt-parser"),FONT_SIZE=.88,defaultLabelAtlasUserData={itemWidth:2,itemHeight:2,fontSize:0,startChar:"",spriteFrameUuid:"",_fntConfig:{}};class LabelAtlasImporter extends asset_db_1.Importer{get version(){return"1.0.1"}get name(){return"label-atlas"}get assetType(){return"cc.LabelAtlas"}get assetExtends(){return["cc.Font"]}_createFntConfigString(e){const t=e.userData,a=asset_db_1.queryAsset(e.userData.spriteFrameUuid);if(!a)return null;const{itemWidth:r,itemHeight:i,fontSize:s}=t,n=a.meta,{rawWidth:l,rawHeight:o}=n.userData;let c=null;if(t.itemWidth>0&&t.itemHeight>0&&t.itemWidth<=l&&t.itemHeight<=o){const e=n.displayName,a=t.startChar.charCodeAt(0);c=`info face="Arial" size=${s} bold=0 italic=0 charset="" unicode=0 stretchH=100 smooth=1 aa=1 padding=0,0,0,0 spaceing=0,0\n`,c+=`common lineHeight=${i} base=${s} scaleW=${l} scaleH=${o} pages=1 packed=0\n`,c+=`page id=0 file="${e}"\n`,c+="chars count=0\n";let d=0;for(let e=i;e<=o;e+=i)for(let t=0;t<l&&t+r<=l;t+=r){const s=a+d;c+=`char id=${s}     x=${t}   y=${e-i}   width=${r}     height=${i}     xoffset=0     yoffset=0    xadvance=${r}    page=0 chnl=0 letter="${String.fromCharCode(s)}"\n`,++d}return fntParser.parseFnt(c)}{let a=`LabelAtlas '${e._url}' fnt data invalid, `;return t.itemWidth<=0||t.itemWidth>l?a+=`the item width must range from 1 - ${l}.`:(t.itemHeight<=0||t.itemHeight>o)&&(a+=`the item height must range from 1 - ${o}.`),console.warn(a),null}}async import(e){const t=e.userData;Object.keys(defaultLabelAtlasUserData).forEach(e=>{e in t||(t[e]=defaultLabelAtlasUserData[e])});const a=this.createLabelAtlas(e);t.spriteFrameUuid&&(a.fontSize=t.fontSize=t.itemHeight*FONT_SIZE,a.spriteFrame=EditorExtends.serialize.asAsset(t.spriteFrameUuid,cc_1.SpriteFrame),a.fntConfig=t._fntConfig=this._createFntConfigString(e)),a.name=e.basename||"";const r=EditorExtends.serialize(a);await e.saveToLibrary(".json",r);const i=utils_1.getDependUUIDList(r);return e.setData("depends",i),!0}createLabelAtlas(e){const t=new cc.LabelAtlas;return t.name=path_1.basename(e.source,e.extname),t.fontSize=e.userData.fontSize,t.fntConfig=e.userData._fntConfig,t}}exports.default=LabelAtlasImporter;