"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LabelAtlasImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),path_1=require("path"),utils_1=require("../utils"),fntParser=require("../../../static/utils/fnt-parser"),FONT_SIZE=.88,defaultLabelAtlasUserData={itemWidth:2,itemHeight:2,fontSize:0,startChar:"",spriteFrameUuid:"",_fntConfig:{}};class LabelAtlasImporter extends asset_db_1.Importer{get version(){return"1.0.1"}get name(){return"label-atlas"}get assetType(){return"cc.LabelAtlas"}_createFntConfigString(e,t){const a=e.userData,{itemWidth:r,itemHeight:i,fontSize:s}=a,n=t.meta,{rawWidth:o,rawHeight:l}=n.userData;let c=null;if(a.itemWidth>0&&a.itemHeight>0&&a.itemWidth<=o&&a.itemHeight<=l){const e=n.displayName,t=a.startChar.charCodeAt(0);c=`info face="Arial" size=${s} bold=0 italic=0 charset="" unicode=0 stretchH=100 smooth=1 aa=1 padding=0,0,0,0 spaceing=0,0\n`,c+=`common lineHeight=${i} base=${s} scaleW=${o} scaleH=${l} pages=1 packed=0\n`,c+=`page id=0 file="${e}"\n`,c+="chars count=0\n";let d=0;for(let e=i;e<=l;e+=i)for(let a=0;a<o&&a+r<=o;a+=r){const s=t+d;c+=`char id=${s}     x=${a}   y=${e-i}   width=${r}     height=${i}     xoffset=0     yoffset=0    xadvance=${r}    page=0 chnl=0 letter="${String.fromCharCode(s)}"\n`,++d}return fntParser.parseFnt(c)}{let t=`LabelAtlas '${e._url}' fnt data invalid, `;return a.itemWidth<=0||a.itemWidth>o?t+=`the item width must range from 1 - ${o}.`:(a.itemHeight<=0||a.itemHeight>l)&&(t+=`the item height must range from 1 - ${l}.`),console.warn(t),null}}async import(e){const t=e.userData;Object.keys(defaultLabelAtlasUserData).forEach(e=>{e in t||(t[e]=defaultLabelAtlasUserData[e])});const a=this.createLabelAtlas(e);if(t.spriteFrameUuid){e.depend(t.spriteFrameUuid);const r=(0,asset_db_1.queryAsset)(e.userData.spriteFrameUuid);if(!r)return!1;a.fontSize=t.fontSize=t.itemHeight*FONT_SIZE,a.spriteFrame=EditorExtends.serialize.asAsset(t.spriteFrameUuid,cc_1.SpriteFrame),a.fntConfig=t._fntConfig=this._createFntConfigString(e,r)}a.name=e.basename||"";const r=EditorExtends.serialize(a);await e.saveToLibrary(".json",r);const i=(0,utils_1.getDependUUIDList)(r);return e.setData("depends",i),!0}createLabelAtlas(e){const t=new cc.LabelAtlas;return t.name=(0,path_1.basename)(e.source,e.extname),t.fontSize=e.userData.fontSize,t.fntConfig=e.userData._fntConfig,t}}exports.LabelAtlasImporter=LabelAtlasImporter;