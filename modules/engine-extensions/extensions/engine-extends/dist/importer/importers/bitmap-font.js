"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),image_utils_1=require("./utils/image-utils"),fntParser=require("../../../static/utils/fnt-parser");function getRealFntTexturePath(e,t){const r=path_1.basename(e),a=path_1.join(path_1.dirname(t.source),r);return fs_extra_1.existsSync(a)||console.warn("Parse Error: Unable to find file Texture, the path: "+a),a}const UserFlags={DoNotNotify:!1};class BitmapImporter extends asset_db_1.Importer{get version(){return"1.0.5"}get name(){return"bitmap-font"}get assetType(){return"cc.BitmapFont"}get assetExtends(){return["cc.Font"]}async validate(e){return!0}async import(e){const t=await fs_extra_1.readFile(e.source,"utf8");let r;try{r=fntParser.parseFnt(t)}catch(t){throw console.error(t),new Error(`BitmapFont import failed: ${e.uuid} file parsing failed`)}if(e.userData._fntConfig=r,!r.fontSize)return console.error(`BitmapFont import failed: ${e.uuid} file parsing failed, There is no 'fontSize' in the configuration.`),!1;e.userData.fontSize=r.fontSize;const a=getRealFntTexturePath(r.atlasName,e);if(e.depend(a),!this.assetDB.pathToUuid(a))return!1;if(e.userData.textureUuid=this.assetDB.pathToUuid(a),e.userData.textureUuid){const t=asset_db_1.queryAsset(e.userData.textureUuid);if(!t)return!1;image_utils_1.changeImageDefaultType(t,"sprite-frame");const r=this.createBitmapFnt(e);r.spriteFrame=EditorExtends.serialize.asAsset(t.uuid+"@f9941",cc_1.SpriteFrame),await e.saveToLibrary(".json",EditorExtends.serialize(r))}return!0}createBitmapFnt(e){const t=new cc.BitmapFont;return t.name=path_1.basename(e.source,e.extname),t.fontSize=e.userData.fontSize,t.fntConfig=e.userData._fntConfig,t}}exports.default=BitmapImporter;