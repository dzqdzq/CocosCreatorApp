"use strict";const{join:join,dirname:dirname}=require("path"),{readFileSync:readFileSync,existsSync:existsSync,writeFileSync:writeFileSync,readdirSync:readdirSync,ensureDirSync:ensureDirSync}=require("fs-extra"),{execSync:execSync}=require("child_process"),builder=require("@editor/build"),configFile=join(__dirname,"../config.json");existsSync(configFile)||(console.error("没有找到 config.json，无法正常构建"),process.exit(-1));try{const e=readFileSync(configFile),n=JSON.parse(e);let i="";i+=`/// <reference path="${join(n.enginePath,"./bin/.declarations/cc.d.ts")}"/>\n`,i+=`/// <reference path="${join(n.enginePath,"/bin/.declarations/cc.editor.d.ts")}"/>\n`,writeFileSync(join(__dirname,"../@types/cc.d.ts"),i)}catch(e){console.error("config.json 格式错误"),console.error(e),process.exit(-1)}function generateMetaSchema(){const e=join(__dirname,"../extensions/engine-extends"),n=join(e,"source","importer","meta-schemas","glTF.meta.ts"),i=join(e,"dist","meta-schemas","glTF.meta.json");ensureDirSync(dirname(i)),execSync(`npx typescript-json-schema ${n} GlTFUserData -o ${i} --required`)}process.argv.some(e=>e.startsWith("--only-dts"))&&process.exit(0),builder.scan(join(__dirname,"../extensions")),builder.config({entry:".workflow.build.js",config:join(__dirname,".build-cache.json")}),builder.executeTask(["tsc","lessc","file","compress"]),console.log("Start generate meta-schemas..."),generateMetaSchema(),console.log("Generate meta-schemas success");