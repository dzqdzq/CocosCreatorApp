const fs=require("fs-extra"),ps=require("path"),wget=require("wget-improved"),cliProgress=require("cli-progress"),AdmZip=require("adm-zip"),{Octokit:Octokit}=require("@octokit/rest"),HttpsProxyAgent=require("https-proxy-agent");(async()=>{const e=(await fs.readJson(ps.join(__dirname,"package.json"))).version,t=/-editor\.\d+/.exec(e),n=t?e.substr(0,t.index)+e.substr(t.index+t[0].length):e,s=process.env.HTTP_PROXY||process.env.HTTPS_PROXY||void 0,r=ps.join(__dirname,"bin");await fs.ensureDir(r),await fs.emptyDir(r);const o=ps.join(__dirname,"types");await fs.ensureDir(o),await fs.emptyDir(o);const i=await async function(){const e=new Octokit({agent:HttpsProxyAgent({proxy:s})}),t=(await e.repos.listReleases({owner:"cocos-creator",repo:"FBX-glTF-conv"})).data.find(e=>e.tag_name===`release-v${n}`);if(!t)throw new Error(`Release ${n} is not found!`);const r=t.assets.find(e=>e.name.includes("win32"));if(!r)throw new Error("Windows asset is not found!");const o=t.assets.find(e=>e.name.includes("darwin"));if(!o)throw new Error("macOS asset is not found!");const i=t.assets.find(e=>e.name.includes("types"));if(!i)throw new Error("types asset is not found!");return{win32:r.browser_download_url,darwin:o.browser_download_url,types:i.browser_download_url}}(),a=ps.join(__dirname,".tmp");async function c(e){console.log(`Installing ${e}`);const t=ps.join(a,`${e}.zip`),n=ps.join(r,e);await fs.ensureDir(n),await async function(e,t){const n=new AdmZip(e),s=n.getEntries().filter(e=>!e.isDirectory&&(e=>e.split(/[\\/]/g).join("/"))(e.entryName).startsWith("Release/bin"));for(const e of s)console.log(`Extract ${e.entryName}`),n.extractEntryTo(e,t,!1)}(t,n)}await fs.ensureDir(a),await fs.emptyDir(a),await async function(){const e=new cliProgress.MultiBar({clearOnComplete:!1,hideCursor:!0,format:"{platform} | {bar} | {percentage}%",noTTYOutput:!0},cliProgress.Presets.shades_classic);await Promise.all(Object.entries(i).map(async([t,n])=>{const r=t.padEnd(6," "),o=ps.join(a,`${t}.zip`),i=e.create(1,0,{platform:r});await fs.ensureDir(ps.dirname(o));const c=wget.download(n,o,{proxy:s});await new Promise((e,t)=>{c.on("error",function(e){i.stop(),t(e)}),c.on("start",function(e){}),c.on("end",function(){i.stop(),e()}),c.on("progress",function(e){i.update(Math.round(100*(e+Number.EPSILON))/100,{platform:r})})})})),e.stop()}(),await c("win32"),await c("darwin"),await async function(){console.log("Installing types");const e=ps.join(a,"types.zip"),t=o;await fs.ensureDir(t),await async function(e,t){const n=new AdmZip(e),s=n.getEntries().filter(e=>!e.isDirectory);for(const e of s)console.log(`Extract ${e.entryName}`),n.extractEntryTo(e,t,!1)}(e,t)}(),await fs.writeFile(ps.join(__dirname,"VERSION"),n)})();