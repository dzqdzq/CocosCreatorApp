const fs=require("fs-extra"),ps=require("path"),wget=require("wget-improved"),cliProgress=require("cli-progress"),AdmZip=require("adm-zip"),{Octokit:Octokit}=require("@octokit/rest"),HttpsProxyAgent=require("https-proxy-agent");(async()=>{const t=(await fs.readJson(ps.join(__dirname,"package.json"))).version,e=/-editor\.\d+/.exec(t),n=e?t.substr(0,e.index)+t.substr(e.index+e[0].length):t,s="http://127.0.0.1:1080",r=ps.join(__dirname,"bin");await fs.ensureDir(r),await fs.emptyDir(r);const o=ps.join(__dirname,"types");await fs.ensureDir(o),await fs.emptyDir(o);const i=await async function(){const t=new Octokit({agent:HttpsProxyAgent({proxy:s})}),e=(await t.repos.listReleases({owner:"cocos-creator",repo:"FBX-glTF-conv"})).data.find(t=>t.tag_name===`release-v${n}`);if(!e)throw new Error(`Release ${n} is not found!`);const r=e.assets.find(t=>t.name.includes("win32"));if(!r)throw new Error("Windows asset is not found!");const o=e.assets.find(t=>t.name.includes("darwin"));if(!o)throw new Error("macOS asset is not found!");const i=e.assets.find(t=>t.name.includes("types"));if(!i)throw new Error("types asset is not found!");return{win32:r.browser_download_url,darwin:o.browser_download_url,types:i.browser_download_url}}(),a=ps.join(__dirname,".tmp");async function c(t){console.log(`Installing ${t}`);const e=ps.join(a,`${t}.zip`),n=ps.join(r,t);await fs.ensureDir(n),await async function(t,e){const n=new AdmZip(t),s=n.getEntries().filter(t=>!t.isDirectory&&(t=>t.split(/[\\/]/g).join("/"))(t.entryName).startsWith("Release/bin"));for(const t of s)console.log(`Extract ${t.entryName}`),n.extractEntryTo(t,e,!1)}(e,n)}await fs.ensureDir(a),await fs.emptyDir(a),await async function(){const t=new cliProgress.MultiBar({clearOnComplete:!1,hideCursor:!0,format:"{platform} | {bar} | {percentage}%",noTTYOutput:!0},cliProgress.Presets.shades_classic);await Promise.all(Object.entries(i).map(async([e,n])=>{const r=e.padEnd(6," "),o=ps.join(a,`${e}.zip`),i=t.create(1,0,{platform:r});await fs.ensureDir(ps.dirname(o));const c=wget.download(n,o,{proxy:s});await new Promise((t,e)=>{c.on("error",function(t){i.stop(),e(t)}),c.on("start",function(t){}),c.on("end",function(){i.stop(),t()}),c.on("progress",function(t){i.update(Math.round(100*(t+Number.EPSILON))/100,{platform:r})})})})),t.stop()}(),await c("win32"),await c("darwin"),await async function(){console.log("Installing types");const t=ps.join(a,"types.zip"),e=o;await fs.ensureDir(e),await async function(t,e){const n=new AdmZip(t),s=n.getEntries().filter(t=>!t.isDirectory);for(const t of s)console.log(`Extract ${t.entryName}`),n.extractEntryTo(t,e,!1)}(t,e)}(),await fs.writeFile(ps.join(__dirname,"VERSION"),n)})();