"use strict";let e={};module.exports=e;const t=require("electron"),r=require("@electron/remote"),i=require("async"),o=require("../../editor"),n=require("../../console"),l=require("../../ipc"),a=require("../../panel"),d=require("../../window"),c=require("./dom-utils"),u=require("./drag-drop");let s=null,f=[],p=null,h=0,g=!1;function m(e){let t=[];for(let r=0;r<e.children.length;++r){let i=e.children[r].id;t.push(i)}return t}function w(e,t,r,i,o){p||((p=document.createElement("div")).classList.add("dock-mask"),p.oncontextmenu=function(){return!1}),"dock"===e?(p.classList.remove("tab"),p.classList.add("dock")):"tab"===e&&(p.classList.remove("dock"),p.classList.add("tab")),p.style.left=`${t}px`,p.style.top=`${r}px`,p.style.width=`${i}px`,p.style.height=`${o}px`,p.parentElement||document.body.appendChild(p)}function v(){p&&p.remove(),s=null,h=0}e.root=null,Object.defineProperty(e,"resizerSpace",{enumerable:!0,get:()=>3}),Object.defineProperty(e,"tabbarSpace",{enumerable:!0,get:()=>22}),Object.defineProperty(e,"panelSpace",{enumerable:!0,get:()=>4}),e.dragstart=function(e,t){let r=t.frameEL,i=r.id,o=r.parentNode,n=o.getBoundingClientRect(),l={panelID:i,panelRectWidth:n.width,panelRectHeight:n.height,panelPreferredWidth:o._preferredWidth,panelPreferredHeight:o._preferredHeight};u.start(e.dataTransfer,{effect:"move",type:"tab",items:l})},e.dragend=function(){v(),u.end()},e.dragoverTab=function(e){d.focus(),f=[],s=null,p&&p.remove();let t=e.getBoundingClientRect();w("tab",t.left,t.top,t.width,t.height+2)},e.dragleaveTab=function(){p&&p.remove()},e.dropTab=function(t,r){let i=u.items()[0].panelID,o=a.find(i);if(o){let i=o.parentNode,n=t.panelEL,l=i!==n,d=i.$tabs.findTab(o);l&&i.closeNoCollapse(d);let c=n.insert(d,o,r);n.select(c),l&&i._collapse(),v(),e.finalize(),e.saveLayout(),o.focus(),a.isDirty(o.id)&&n.outOfDate(o)}else a.close(i,(o,l)=>{if(o)return n.error(`Failed to close panel ${i}: ${o.stack}`),void 0;l&&a.newFrame(i,(i,o)=>{if(i)return n.error(i.stack),void 0;window.updateEngineSupport&&window.updateEngineSupport(o._info.engineSupport),window.requestAnimationFrame(()=>{let i=t.panelEL,l=document.createElement("ui-dock-tab");l.name=o.name;let d=i.insert(l,o,r);i.select(d),a.dock(o),v(),e.finalize(),e.saveLayout(),o.focus(),a.isDirty(o.id)&&i.outOfDate(o),o.load(e=>{if(e)return n.error(e.stack),void 0;o.ready&&o.ready()})})})})},e.dragoverDock=function(e){"tab"===u.type()&&f.push(e)},e.dragenterMainDock=function(){++h},e.dragleaveMainDock=function(){0===--h&&p&&p.remove()},e.dragoverMainDock=function(e,t){d.focus();let r=null;s=null;for(let i=0;i<f.length;++i){let o=f[i],n=o.getBoundingClientRect(),l=n.left+n.width/2,a=n.top+n.height/2,d=null,c=Math.abs(e-n.left),u=Math.abs(e-n.right),p=Math.abs(t-n.top),h=Math.abs(t-n.bottom),g=100,m=-1;c<g&&(g=c,m=Math.abs(t-a),d="left"),u<g&&(g=u,m=Math.abs(t-a),d="right"),p<g&&(g=p,m=Math.abs(e-l),d="top"),h<g&&(g=h,m=Math.abs(e-l),d="bottom"),null!==d&&(null===r||m<r)&&(r=m,s={target:o,position:d})}if(s){let e=u.items()[0],t=s.target.getBoundingClientRect(),r=null,i=e.panelPreferredWidth,o=e.panelPreferredHeight,n=i;n>=Math.floor(t.width)&&(n=Math.floor(.5*t.width));let l=o;l>=Math.floor(t.height)&&(l=Math.floor(.5*t.height)),"top"===s.position?r={left:t.left,top:t.top,width:t.width,height:l}:"bottom"===s.position?r={left:t.left,top:t.bottom-l,width:t.width,height:l}:"left"===s.position?r={left:t.left,top:t.top,width:n,height:t.height}:"right"===s.position&&(r={left:t.right-n,top:t.top,width:n,height:t.height}),w("dock",r.left,r.top,r.width,r.height)}else p&&p.remove();f=[]},e.dropMainDock=function(t){if(null===s)return;let r=t.panelID,i=t.panelRectWidth,o=t.panelRectHeight,l=t.panelPreferredWidth,d=t.panelPreferredHeight,c=s.target,u=s.position,f=a.find(r);if(!f)return a.close(r,(t,i)=>{if(t)return n.error(`Failed to close panel ${r}: ${t.stack}`),void 0;i&&a.newFrame(r,(t,r)=>{if(t)return n.error(t.stack),void 0;window.requestAnimationFrame(()=>{let t=document.createElement("ui-dock-panel");t.add(r),t.select(0),t._preferredWidth=l,t._preferredHeight=d,c.addDock(u,t),a.dock(r),v(),e.finalize(),e.saveLayout(),r.focus(),a.isDirty(r.id)&&t.outOfDate(r),r.load(e=>{if(e)return n.error(e.stack),void 0;r.ready&&r.ready()})})})}),void 0;let p=f.parentNode;if(c===p&&1===c.tabCount)return;let h=p.parentNode,g=h===c.parentNode,m=p.$tabs.findTab(f);p.closeNoCollapse(m);let w=document.createElement("ui-dock-panel");w.add(f),w.select(0),w._preferredWidth=l,w._preferredHeight=d,c.addDock(u,w,g);let y=0===p.children.length;if(p._collapse(),y){let e=!1;if(w.parentNode!==h){let t=w,r=w.parentNode;for(;r&&r._dockable;){if(r===h){e=!0;break}t=r,r=r.parentNode}if(e){let e=0;h.row?(e=t.offsetWidth+3+i,t._preferredWidth=e):(e=t.offsetHeight+3+o,t._preferredHeight=e),t.style.flex=`0 0 ${e}px`}}}v(),e.finalize(),e.saveLayout(),f.focus(),a.isDirty(f.id)&&w.outOfDate(f)},e.collapse=function(){e.root&&e.root._collapseRecursively()},e.finalize=function(){e.root&&(e.root._finalizeMinMaxRecursively(),e.root._finalizePreferredSizeRecursively(),e.root._finalizeStyleRecursively(),e.root._reflowRecursively(),e.root._updatePreferredSizeRecursively(),e.root._notifyResize(),function(){let t=e.root;if(!t)return;let i=r.getCurrentWindow(),o=i.getSize(),n=o[0],l=o[1],a=window.innerWidth-t.clientWidth,d=window.innerHeight-t.clientHeight,c=t._computedMinWidth+a,u=t._computedMinHeight+d;a=n-window.innerWidth,d=l-window.innerHeight,c+=a,u+=d,i.setMinimumSize(c,u),n<c&&(n=c);l<u&&(l=u);i.setSize(n,l)}())},e.resize=function(){e.root&&(e.root._reflowRecursively(),e.root._notifyResize(),window.requestAnimationFrame(()=>{e.root._updatePreferredSizeRecursively()}))},e.reset=function(t,r,l){g=!0,i.waterfall([e=>{a._unloadAll(e)},e=>{if(c.clear(t),!r||!r.type||0!==r.type.indexOf("dock"))return e(null,[]),void 0;"dock-v"===r.type?t.row=!1:"dock-h"===r.type&&(t.row=!0);let i=[];(function e(t,r,i){if(!r)return;for(let o=0;o<r.length;++o){let n,l=r[o];if("dock-v"===l.type?(n=document.createElement("ui-dock")).row=!1:"dock-h"===l.type?(n=document.createElement("ui-dock")).row=!0:"panel"===l.type&&(n=document.createElement("ui-dock-panel")),n){if(void 0!==l.width&&(n._preferredWidth=l.width),void 0!==l.height&&(n._preferredHeight=l.height),"panel"===l.type)for(let e=0;e<l.children.length;++e)i.push({dockEL:n,panelID:l.children[e],active:e===l.active});else e(n,l.children,i);t.appendChild(n)}else Editor.warn(`Failed to create layout from ${l}`)}t._initResizers()})(t,r.children,i),e(null,i)},(t,r)=>{let o=[],l=Editor.remote.Window.windows;i.each(t,(e,t)=>{l.some(t=>-1!==t._panels.indexOf(e.panelID))&&a.close(e.panelID),a.newFrame(e.panelID,(r,i)=>{if(r)return n.error(r.stack),t(),void 0;let l=e.dockEL;l.add(i),e.active&&l.select(i),a.dock(i),o.push(i),t()})},t=>{g=!1,e.collapse(),e.finalize(),e.saveLayout(),r(t,o)})},(e,t)=>{let r=o.argv&&o.argv.panelID&&o.argv.panelArgv;e.forEach(e=>{e.load(t=>{if(t)return n.error(t.stack),void 0;e.ready&&e.ready(),r&&o.argv.panelID===e.id&&e.run&&e.run(o.argv.panelArgv)})}),t()}],e=>{l&&l(e)})},e.saveLayout=function(){g||window.requestAnimationFrame(()=>{l.sendToMain("editor:window-save-layout",e.dumpLayout())})},e.dumpLayout=function(){let t=e.root;if(!t)return null;if(t._dockable){return{type:t.row?"dock-h":"dock-v",children:function t(r){let i=[];for(let o=0;o<r.children.length;++o){let n=r.children[o];if(!n._dockable)continue;let l=n.getBoundingClientRect(),a={width:l.width,height:l.height};if(e.isPanel(n))a.type="panel",a.active=n.activeIndex,a.children=m(n);else{let e=n.row?"dock-h":"dock-v";a.type=e,a.children=t(n)}i.push(a)}return i}(t)}}{let e=t.getAttribute("id"),r=t.getBoundingClientRect();return{type:"standalone",panel:e,width:r.width,height:r.height}}},e.isPanel=function(e){return"UI-DOCK-PANEL"===e.tagName},e.isPanelFrame=function(e){return"UI-PANEL-FRAME"===e.tagName},e.isResizer=function(e){return"UI-DOCK-RESIZER"===e.tagName},e.isTab=function(e){return"UI-DOCK-TAB"===e.tagName},e.isTabBar=function(e){return"UI-DOCK-TABS"===e.tagName},t.ipcRenderer.on("editor:reset-layout",(t,r,i)=>{if(i)return l.sendToMain("editor:window-save-layout",r,()=>{t.reply&&t.reply()}),void 0;l._closeAllSessions(),e.reset(e.root,r,e=>{e&&n.error(`Failed to reset layout: ${e.stack}`)})}),window.addEventListener("resize",()=>{e.resize()});