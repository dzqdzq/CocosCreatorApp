"use strict";const{readJSONSync:readJSONSync}=require("fs-extra"),{join:join}=require("path"),{app:app,crashReporter:crashReporter}=require("electron");app.disableDomainBlockingFor3DAPIs(),app.commandLine.appendSwitch("ignore-gpu-blacklist"),app.allowRendererProcessReuse=!1,app.commandLine.appendSwitch("enable-webgl2-compute-context"),"win32"===require("os").platform()&&app.commandLine.appendSwitch("use-angle","OpenGL"),app.allowRendererProcessReuse=!1,process.env.BROWSERSLIST_IGNORE_OLD_DATA=!0;const _uncaughtExceptionFunc=e=>{global.Editor&&Editor.Metrics.trackException({code:-1,message:e.message}),process.send&&process.connected&&process.send({channel:"editor-error",message:e.message,stack:e.stack}),console.error(e)};async function useNativeScene(){const e=await Editor.Profile.getConfig("scene","scene.native-engine");return void 0!==e&&e}function checkLayout(e){let t=!1;return function e(i){if(i.panels&&i.panels.includes("scene.preview"))return t=!0,!0;i.children&&i.children.some(e)}(e.layout),t}async function scanPrePackage(){const e=[];return["./builtin/menu","./builtin/profile","./builtin/project","./builtin/messages","./builtin/program","./builtin/tester","./builtin/information","./builtin/preferences","./builtin/engine","./builtin/programming","./modules/editor-extensions/extensions/device","./modules/editor-extensions/extensions/ui-kit"].forEach(t=>{e.push(join(Editor.App.path,t))}),e}async function scanPackage(){const e={editor:join(Editor.App.path,"./modules/editor-extensions/extensions"),engine:join(Editor.App.path,"./modules/engine-extensions/extensions"),platform:join(Editor.App.path,"./modules/platform-extensions/extensions"),builtinOthers:join(Editor.App.path,"./extension"),globalBuiltin:join(Editor.App.home,`./builtin-extensions/${Editor.App.version}`),project:join(Editor.Project.path,"extensions")},t=[];["./builtin/asset-db","./builtin/scene","./builtin/server","./builtin/utils","./builtin/preview","./builtin/animator","./builtin/builder","./builtin/shortcuts","./builtin/animation-graph"].forEach(e=>{t.push(join(Editor.App.path,e))});for(const i in e){const n=e[i],a=await Editor.Package.__protected__.scan(n);t.push(...a)}return t.push(join(Editor.App.path,"./builtin/placeholder")),t}process.on("uncaughtException",_uncaughtExceptionFunc),async function(){const e=require("@editor/creator");await e.init({env:{LAYOUT:join(__dirname,"./static/layout-native.json")}});const t=join(__dirname,"node_modules");await e.registerFindModulePath(e=>{switch(e[0]){case"@electron/remote":case"cc":e[1].splice(0,0,t)}return e});const i=require("@editor/setting");if(i.PATH.PROJECT){const e=join(i.PATH.PROJECT,"temp/crash");app.setPath("crashDumps",e),crashReporter.start({uploadToServer:!1})}if(!i.PATH.PROJECT){const e=require("./dashboard/startup");return await e.app(),void await e.validation(i.dev)}if(i.args.build){await Editor.Startup.manager(!0,!!i.args.metric);const e=await scanPrePackage(),t=await scanPackage();await Editor.Startup.package({preList:e,list:t});const n={};i.args.build.split(";").forEach(e=>{if(!e)return;const t=e.split("=");n[t[0].trim()]=t[1]});const a=await Editor.Startup.build(n,i.args.dev);return void app.exit(a)}const n=await useNativeScene();let a=!1;await Promise.all([Editor.Startup.manager(!!i.args.nologin,!!i.args.metric),Editor.Startup.window({async beforeOpen(e,t){const i=checkLayout(t.layout);a||(a=!0,n?("win32"===process.platform&&(e.transparent=!0,e.resizable=!0,e.frame=!1),i||(t.layout=readJSONSync(join(__dirname,"./static/layout-native.json")))):i&&(t.layout=readJSONSync(join(__dirname,"./static/layout-web.json"))))},async afterOpen(e){if(!n)return;const{initNativize:t,Nativize:i}=require("./nativize/dist");Editor.Nativize=i,t(e)}})]);const r=await scanPrePackage(),o=await scanPackage();await Editor.Startup.package({preList:r,list:o})}();