"use strict";const{existsSync:existsSync,readdirSync:readdirSync,chmodSync:chmodSync,statSync:statSync}=require("fs"),{join:join,normalize:normalize,basename:basename}=require("path"),{ensureDirSync:ensureDirSync,copySync:copySync,readJSONSync:readJSONSync,outputJSONSync:outputJSONSync}=require("fs-extra"),project=require("@editor/project"),{v4:v4}=require("node-uuid"),{getName:getName,t:t,basenameNoExt:basenameNoExt,warnDuplicateProject:warnDuplicateProject,chooseProjectPath:chooseProjectPath,errorDialog:errorDialog}=require("./util"),PROJECT_NAME="NewProject";let template={name:"empty",path:join(__dirname,"../static/template-empty")};async function isEmptyDir(e){try{let t=readdirSync(e);return!t||!t.length}catch(t){return await errorDialog(t.message,e),!1}}async function changeMode(e){try{const t=readdirSync(e);for(const r of t){const t=join(e,r);chmodSync(t,511),statSync(t).isDirectory()&&changeMode(t)}}catch(t){await errorDialog(t.message,e)}}async function initGit(e){const t=require("child_process").exec;try{t("git init && git config core.autocrlf input",{env:process.env,cwd:e},async e=>{})}catch(e){}}async function updateProjectName(e){const r=v4();try{const a=readJSONSync(join(e,"package.json"));a.name=basename(e),a.uuid=r,outputJSONSync(join(e,"package.json"),a,{spaces:2})}catch(e){await errorDialog(t("message.rename_project_failed",{error:e.message}))}return r}async function trackEvent(e,t){try{const r=require("../../lib/dist/metrics").Metrics,a={projectId:e,projectNm:t,template:template.name,dimension:"2"};r.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreateProjectId",...a}),r.trackEvent({category:"CreateProject",action:"create",label:JSON.stringify(a)})}catch(e){await errorDialog(e.message,t)}}exports.createEmptyProject=async function(){try{const e=await chooseProjectPath(t("template.project_path_palceholder"));if(!e)return!1;let r=getName(join(normalize(e),"NewProject"));if(existsSync(r)){if(!await isEmptyDir(r))return await warnDuplicateProject(),!1}else ensureDirSync(r);copySync(template.path,r),await changeMode(r),await initGit(r);const a=updateProjectName(r),c=basenameNoExt(r);return await trackEvent(a,c),project.open(r),!0}catch(e){return await errorDialog(e.message),!1}};