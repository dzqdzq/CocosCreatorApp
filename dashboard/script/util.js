"use strict";const{app:app,shell:shell}=require("electron");exports.app=app,exports.i18n=require("@base/electron-i18n"),exports.metrics=require("@editor/creator/dist/metrics");const setting=require("@editor/setting"),{Manager:Manager}=require("@editor/extension-sdk"),{Dialog:Dialog}=require("@editor/creator/dist/dialog"),{I18n:I18n}=require("@editor/creator/dist/i18n"),{Utils:Utils}=require("@editor/creator/dist/utils"),{existsSync:existsSync,readJSONSync:readJSONSync}=require("fs-extra"),{basename:basename,extname:extname,join:join}=require("path"),{spawn:spawn}=require("child_process"),{lt:lt}=require("semver"),DOWNLOAD="https://www.cocos.com/creator-download",DASHBOARD_PROTOCOL="cocos-dashboard://";exports.basenameNoExt=function(e){return basename(e,extname(e))},exports.getName=Utils.File.getName;const languages={zh:require("../i18n/zh"),en:require("../i18n/en")};let initializedI18n=!1;function registerI18n(){initializedI18n=!0,exports.i18n.register(languages.en,"en"),exports.i18n.register(languages.zh,"zh"),app.getLocale().startsWith("zh")&&exports.i18n.switch("zh")}exports.initI18n=async function(e){initializedI18n||(e?registerI18n():(app.isReady()||await new Promise(e=>{app.once("ready",e)}),registerI18n()))};const t=exports.t=function(e,t){return I18n.t(e,t)};exports.queryDashboardPath=async function(){try{const e=await app.getApplicationInfoForProtocol(DASHBOARD_PROTOCOL);if(existsSync(e.path))return e.path}catch(e){}return""},exports.openDashboard=async function(){try{const e=exports.queryDashboardPath();if(e)return await shell.openPath(e),exports.exitApp(),!0}catch(e){}return!1},exports.goToInstall=async function(){await shell.openExternal(DOWNLOAD)};const projectMap=exports.projectMap=new Map;function getDependNames(e){let t="";for(let n=0;n<e.length;n++)t+=`${n+1}.${e[n]}\n`;return t}exports.exitApp=function(){0===projectMap.size&&app.exit(0)},exports.warnAlreadyOpened=async function(e){await Dialog.warn(t("project_opened"),{title:t("info"),detail:e,buttons:[t("confirm")]})},exports.errorDialog=async function(e,n){await Dialog.error(e,{detail:n||"",buttons:[t("confirm")]})},exports.warnDuplicateProject=async function(){await Dialog.warn(t("message.duplicate_project"),{title:t("warn"),buttons:[t("confirm")]})},exports.chooseProjectPath=async function(e){const t=await Dialog.select({type:"directory",title:e});return t&&t.filePaths&&t.filePaths[0]},exports.warnInstallDependFailed=async function(e,n){if(console.warn(n),setting.args.build)return console.warn(t("message.install_depend_error",{list:e})),-1;return(await Dialog.warn(t("message.install_depend_error"),{title:t("main.title"),detail:`${getDependNames(e)}`,buttons:[t("main.button.quit"),t("main.button.continue")],default:1})).response},exports.showMainDialog=async function(e){return(await Dialog.info(t("main.message"),{title:t("main.title"),detail:t("main.detail"),buttons:[t(e?"main.button.dashboard":"main.button.install"),t("main.button.empty"),t("main.button.open"),t("main.button.quit")],default:0,cancel:3})).response},exports.installProjectDepend=async function(e){return new Promise(async(t,n)=>{if(void 0!==process.send&&process.env.COCOS_DASHBOARD_VERSION)return t();const a=join(e,"extensions"),r=new Manager({extensionPaths:[a]}),s=await r.queryDepends([e]),i=await r.scanLocalExtensions(),o=[];for(const e of s){const t=i.find(t=>e.name===t.name);if(!t||lt(t.version,e.version)){o.push(e.name);break}}if(0===o.length)return t();await exports.initI18n();const c=await exports.queryDashboardPath();if(!c){switch(await exports.warnInstallDependFailed(o,new Error("Failed to install dependencies, the dashboard does not exist."))){case 0:return void exports.exitApp()}return t()}try{const e="win32"===process.platform?"../resources":"Contents/Resources";readJSONSync(join(c,e,"dashboard.json"))}catch(e){switch(await exports.warnInstallDependFailed(o,new Error("Failed to install dependencies, the dashboard does not support this feature."))){case 0:return void exports.exitApp()}return t()}let p=[];setting.args.build&&p.push("--project-install-silence"),p=p.concat(["--project-install-plugins",`--project=${e}`]);const l=c+("win32"===process.platform?"":"/Contents/MacOS/CocosDashboard"),u=spawn(l,p,{stdio:[0,1,2,"ipc"]});let d=!1;u.on("exit",()=>{console.log(`spawn ${l} exit, args: ${p}`),d||exports.exitApp()}),u.on("message",async e=>{switch(e.channel){case"dashboard-install-project-plugin":if(d=!0,u.kill(),e.stack){if(0===await exports.warnInstallDependFailed(o,e.stack))return void exports.exitApp()}}return t()}),u.on("error",async e=>{switch(await exports.warnInstallDependFailed(o,e)){case 0:return void exports.exitApp()}return t()})})};