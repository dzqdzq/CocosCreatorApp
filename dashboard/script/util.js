"use strict";const{app:app,shell:shell}=require("electron");exports.app=app,exports.i18n=require("@base/electron-i18n"),exports.metrics=require("@editor/creator/dist/metrics");const setting=require("@editor/setting"),{Manager:Manager}=require("@editor/extension-sdk"),{Dialog:Dialog}=require("@editor/creator/dist/dialog"),{I18n:I18n}=require("@editor/creator/dist/i18n"),{Utils:Utils}=require("@editor/creator/dist/utils"),{existsSync:existsSync,readJSONSync:readJSONSync}=require("fs-extra"),{basename:basename,extname:extname,join:join}=require("path"),{spawn:spawn}=require("child_process"),DOWNLOAD="https://www.cocos.com/creator-download",DASHBOARD_PROTOCOL="cocos-dashboard://";exports.basenameNoExt=function(t){return basename(t,extname(t))},exports.getName=Utils.File.getName;const languages={zh:require("../i18n/zh"),en:require("../i18n/en")};let initializedI18n=!1;function registerI18n(){initializedI18n=!0,exports.i18n.register(languages.en,"en"),exports.i18n.register(languages.zh,"zh"),app.getLocale().startsWith("zh")&&exports.i18n.switch("zh")}exports.initI18n=async function(t){initializedI18n||(t?registerI18n():(app.isReady()||await new Promise(t=>{app.once("ready",t)}),registerI18n()))};const t=exports.t=function(t,e){return I18n.t(t,e)};exports.queryDashboardPath=async function(){try{let t=!0;const e=(await app.getApplicationInfoForProtocol(DASHBOARD_PROTOCOL)).path;if("darwin"===process.platform&&(t=e.startsWith("/Applications/")),t&&existsSync(e))return e}catch(t){}return""},exports.openDashboard=async function(){try{let t=!0;const e=(await app.getApplicationInfoForProtocol(DASHBOARD_PROTOCOL)).path;if("darwin"===process.platform&&(t=e.startsWith("/Applications/")),t)return await shell.openPath(e),exports.exitApp(),!0}catch(t){}return!1},exports.goToInstall=async function(){await shell.openExternal(DOWNLOAD)};const projectMap=exports.projectMap=new Map;function getDependNames(t){let e="";for(let n=0;n<t.length;n++)e+=`${n+1}.${t[n]}\n`;return e}exports.exitApp=function(){0===projectMap.size&&app.exit(0)},exports.warnAlreadyOpened=async function(e){await Dialog.warn(t("project_opened"),{title:t("info"),detail:e,buttons:[t("confirm")]})},exports.errorDialog=async function(e,n){await Dialog.error(e,{detail:n||"",buttons:[t("confirm")]})},exports.warnDuplicateProject=async function(){await Dialog.warn(t("message.duplicate_project"),{title:t("warn"),buttons:[t("confirm")]})},exports.chooseProjectPath=async function(t){const e=await Dialog.select({type:"directory",title:t});return e&&e.filePaths&&e.filePaths[0]},exports.warnInstallDependFailed=async function(e,n){if(console.warn(n),setting.args.build)return console.warn(t("message.install_depend_error",{list:e})),-1;return(await Dialog.warn(t("message.install_depend_error"),{title:t("main.title"),detail:`${getDependNames(e)}`,buttons:[t("main.button.quit"),t("main.button.continue")],default:1})).response},exports.showMainDialog=async function(e){return(await Dialog.info(t("main.message"),{title:t("main.title"),detail:t("main.detail"),buttons:[t(e?"main.button.dashboard":"main.button.install"),t("main.button.empty"),t("main.button.open"),t("main.button.quit")],default:0,cancel:3})).response},exports.installProjectDepend=async function(t){return new Promise(async(e,n)=>{const a=join(t,"extensions"),r=new Manager({extensionPaths:[a]}),i=await r.queryDepends([t]),s=await r.scanLocalExtensions();if(i.every(t=>s.some(e=>e.name===t.name&&e.version===t.version)))return e();await exports.initI18n();const o=i.map(t=>t.name),p=await exports.queryDashboardPath();if(!p){switch(await exports.warnInstallDependFailed(o,new Error("Failed to install dependencies, the dashboard does not exist."))){case 0:return void exports.exitApp();case 1:return await exports.goToInstall(),void exports.exitApp()}return e()}try{const t="win32"===process.platform?"../resources":"Contents/Resources";readJSONSync(join(p,t,"dashboard.json"))}catch(t){switch(await exports.warnInstallDependFailed(o,new Error("Failed to install dependencies, the dashboard does not support this feature."))){case 0:return void exports.exitApp()}return e()}let c=[];setting.args.build&&c.push("--project-install-silence"),c=c.concat(["--project-install-plugins",`--project=${t}`]);const l="win32"===process.platform?"":"/Contents/MacOS/CocosDashboard",d=spawn(p+l,c,{stdio:[0,1,2,"ipc"]});d.on("message",async t=>{switch(t.channel){case"dashboard-install-project-plugin":if(d.kill(),t.stack){if(0===await exports.warnInstallDependFailed(o,t.stack))return void exports.exitApp()}}return e()}),d.on("error",async t=>{switch(await exports.warnInstallDependFailed(o,t)){case 0:return void exports.exitApp();case 1:return await exports.goToInstall(),void exports.exitApp()}return e()})})};