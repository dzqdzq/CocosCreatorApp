"use strict";const{shell:shell}=require("electron"),{spawn:spawn}=require("child_process"),project=require("@editor/project"),setting=require("@editor/setting"),user=require("@editor/user"),{join:join}=require("path"),{readJSONSync:readJSONSync,outputJSONSync:outputJSONSync,existsSync:existsSync}=require("fs-extra"),{createEmptyProject:createEmptyProject}=require("./script/template"),{openProject:openProject}=require("./script/project"),{openDashboard:openDashboard,queryDashboardPath:queryDashboardPath,exitApp:exitApp,goToInstall:goToInstall,warnAlreadyOpened:warnAlreadyOpened,errorDialog:errorDialog,showMainDialog:showMainDialog,t:t,metrics:metrics,app:app,i18n:i18n}=require("./script/util"),psList=require("ps-list"),languages={zh:require("./i18n/zh"),en:require("./i18n/en")},projectMap=new Map;function setOpenHandler(){project.setOpenHandler(async e=>{if(projectMap.get(e))return void await warnAlreadyOpened();const r=join(e,"temp","startup.json");let a={};if(existsSync(r)){const e=readJSONSync(r);if(e&&e.pid){const t=(await psList()).find(t=>t.pid===e.pid);if(t&&/Electron|CocosCreator/.test(t.name||""))return void await warnAlreadyOpened();a=e}}const o=join(e,"package.json");if(!existsSync(o))return void await errorDialog(t("open_with_error"),e);readJSONSync(o);const s=app.getPath("exe"),n=[],i=process.argv.indexOf("--pass-through"),p=(()=>{const e=["--inspect-brk","--inspect"];for(let t=0;t<i;++t){const r=process.argv[t],a=e.find(e=>r.startsWith(e));if(!a)continue;const o=r.substr(a.length),s=o.startsWith("=")?/^=(.*:)?(\d+)$/g.exec(o):null;if(!s)return a;const n=s[1],i=s[2]?parseInt(s[2])+1:void 0;return`${a}=${n?`${n}:${i}`:`${i}`}`}})();p&&n.push(p),n.push(join(__dirname,"../")),n.push("--project"),n.push(e),i>=0&&n.push(...process.argv.slice(i+1)),setting.dev&&n.push("--dev");const c=spawn(s,n,{stdio:[0,1,2,"ipc"]});a.pid=c.pid,user.addChildProcess(c),c.on("message",async e=>{if(e.channel&&"open-project"===e.channel){if(e.options.path)return project.open(e.options.path);app.dock&&app.dock.show(),await openProject()}e.channel&&"show-dashboard"===e.channel&&(app.dock&&app.dock.show(),await createEmptyProject())}),c.on("exit",()=>{projectMap.delete(e),user.removeChildProcess(c),projectMap.size<=0&&exitApp()}),outputJSONSync(r,a,{spaces:2}),app.dock&&app.dock.hide()})}exports.app=async function(){app.isReady()||(await new Promise(e=>{app.once("ready",e)}),i18n.register(languages.en,"en"),i18n.register(languages.zh,"zh"),app.getLocale().startsWith("zh")&&i18n.switch("zh"),await metrics.init())},exports.validation=async function(e){const t=await queryDashboardPath();return setOpenHandler(),await exports.show(t,e)},exports.show=async function(e,t){let r=!0;switch(await showMainDialog(e)){case 0:if(e){if(t)return await shell.openPath(e),!0;const r=join(__dirname,"../"),a="win32"===process.platform?join(r,"../../CocosCreator.exe"):join(r,"../../MacOS/CocosCreator");return await shell.openExternal(`cocos-dashboard://open/${a}`),exitApp(),!0}await goToInstall();break;case 1:r=await createEmptyProject();break;case 2:r=await openProject();break;case 3:return exitApp(),""}r||await exports.show(e)};