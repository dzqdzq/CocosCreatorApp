"use strict";require("../lib/require");const{join:join}=require("path"),{readJSONSync:readJSONSync,outputJSONSync:outputJSONSync,existsSync:existsSync}=require("fs-extra"),{spawn:spawn}=require("child_process"),{app:app,Tray:Tray,Menu:Menu,BrowserWindow:BrowserWindow,dialog:dialog}=require("electron"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),project=require("@editor/project"),user=require("@editor/user"),i18n=require("@base/electron-i18n"),psList=require("ps-list"),metrics=require("../lib/dist/metrics/browser/index"),profile=require("@base/electron-profile"),userProfile=profile.load("global://editor/user.json"),info=userProfile.get();user.setData(info),user.on("info-update",async()=>{const e=await user.getData();userProfile.set("session_id",e.session_id),userProfile.set("session_key",e.session_key),userProfile.set("cocos_uid",e.cocos_uid),userProfile.set("email",e.email),userProfile.set("nickname",e.nickname),userProfile.save()}),metrics.init();let window=null;const languages={zh:require("./i18n/zh"),en:require("./i18n/en")},projectMap=new Map;let openType="3d";exports.app=async function(){app.isReady()||await new Promise(e=>{app.once("ready",e)})},exports.window=function(){i18n.register(languages.en,"en"),i18n.register(languages.zh,"zh");const e=join(__dirname,"./renderer/template/index.html");(window=new BrowserWindow({width:920,height:650,minWidth:900,minHeight:600,show:!1,frame:!1,autoHideMenuBar:!0,titleBarStyle:"hiddenInset","max-width":1500,webPreferences:{nodeIntegration:!0,enableRemoteModule:!0,contextIsolation:!1}})).loadFile(e),window.once("ready-to-show",()=>{window.isDestroyed()||window.show()}),window.on("close",e=>{closeWindow()})};let tray=null;function warnAlreadyOpened(e){const n={title:i18n.translation("info"),message:i18n.translation("project_opened"),detail:e,type:"warning",buttons:["Cancel"]};dialog.showMessageBox(null,n)}function openWithError(e){const n={title:i18n.translation("error"),message:i18n.translation("open_with_error").replace("{type}",openType),detail:e,type:"error",buttons:["Cancel"]};dialog.showMessageBox(null,n)}function showWindow(){window&&!window.isDestroyed()&&window.show(),app.dock&&app.dock.show()}function hideWindow(){window.isDestroyed()||(window&&window.hide(),app.dock&&app.dock.hide())}function closeWindow(){projectMap.size<=0?exitApp():hideWindow()}function exitApp(){app.exit(0)}function ipcOpenState(){ipc.broadcast("dashboard:update-opens",{opens:Array.from(projectMap.keys())})}exports.tray=async function(){app.isReady()||await new Promise(e=>{app.once("ready",e)}),tray=new Tray(join(__dirname,"./tray.png"));const e=[];setting.dev&&(e.push({label:"DEV MODE",enabled:!1}),e.push({type:"separator"})),e.push({label:i18n.translation("menu.show"),click(){showWindow()}}),e.push({label:i18n.translation("menu.quit"),click(){exitApp()}});const n=Menu.buildFromTemplate(e);tray.setContextMenu(n)},exports.listener=function(){ipc.on("dashboard:close",e=>{closeWindow()}),ipc.on("dashboard:maxi",e=>{window.isDestroyed()||window.maximize()}),ipc.on("dashboard:unmaxi",e=>{window.isDestroyed()||window.unmaximize()}),ipc.on("dashboard:mini",e=>{window.isDestroyed()||window.minimize()}),ipc.on("dashboard:getTemplate",(e,n)=>{e.reply(null,{"2d":[],"3d":[]})}),ipc.on("dashboard:type",(e,n)=>{openType=n}),ipc.on("dashboard:get-opens",e=>{ipcOpenState()}),project.setOpenHandler(async e=>{if(projectMap.get(e))return ipcOpenState(),void warnAlreadyOpened();const n=join(e,"temp","startup.json");let i={};if(existsSync(n)){const e=readJSONSync(n);if(e&&e.pid){const n=(await psList()).find(n=>n.pid===e.pid);if(n&&/Electron|CocosCreator/.test(n.name||""))return void warnAlreadyOpened();i=e}}const o=join(e,"package.json");if(!existsSync(o))return void openWithError(e);const t=readJSONSync(o);if(!t.type&&t.engine&&(t.type=t.engine.includes("3d")?"3d":"2d"),openType!==t.type)return void openWithError(e);hideWindow();const s=app.getPath("exe"),r=[],a=process.argv.indexOf("--pass-through"),p=(()=>{const e=["--inspect-brk","--inspect"];for(let n=0;n<a;++n){const i=process.argv[n],o=e.find(e=>i.startsWith(e));if(!o)continue;const t=i.substr(o.length),s=t.startsWith("=")?/^=(.*:)?(\d+)$/g.exec(t):null;if(!s)return o;const r=s[1],a=s[2]?parseInt(s[2])+1:void 0;return`${o}=${r?`${r}:${a}`:`${a}`}`}})();p&&r.push(p),r.push(join(__dirname,"../")),r.push("--project"),r.push(e),a>=0&&r.push(...process.argv.slice(a+1)),setting.dev&&r.push("--dev");const d=spawn(s,r,{stdio:[0,1,2,"ipc"]});projectMap.set(e,d),i.pid=d.pid,ipcOpenState(),user.addChildProcess(d),d.on("message",e=>{if(e.channel&&"open-project"===e.channel){if(e.options.path)return project.open(e.options.path);window&&!window.isDestroyed()&&window.show(),ipc.broadcast("dashboard:set-options",e.options)}e.channel&&"show-dashboard"===e.channel&&(window&&!window.isDestroyed()&&window.show(),ipc.broadcast("dashboard:set-options",e.options))}),d.on("exit",()=>{projectMap.delete(e),user.removeChildProcess(d),ipcOpenState(),projectMap.size<=0&&showWindow()}),outputJSONSync(n,i,{spaces:2})})};