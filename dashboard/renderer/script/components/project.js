"use strict";const fs=require("fs"),fse=require("fs-extra"),ps=require("path"),semver=require("semver"),project=require("@editor/project"),ipc=require("@base/electron-base-ipc"),{Dialog:Dialog}=require("../../../../lib/dist/dialog"),{t:t}=require("../util"),{version:version}=require("@editor/setting");exports.template=fs.readFileSync(ps.join(__dirname,"../../template/project.html"),"utf-8"),exports.props=["type"],exports.data=function(){return{projects:[],opens:[],hover:null}},exports.watch={type(){this.projects=project.query({type:this.type})}},exports.computed={list(){return this.projects.map(e=>(e.state=this.opens.includes(e.path)?"opened":"",e))}},exports.methods={t:t,async removeProject(e){const{path:r}=e;if(!r)return!1;if(this.opens.includes(r))return await Dialog.warn(t("delete_project_close_first"),{title:t("warn"),buttons:["Cancel"]}),!1;switch((await Dialog.info(t("delete_project"),{title:t("delete_project"),detail:r,buttons:[t("message.delete_project_record"),t("message.delete_project_source"),t("cancel")],default:2,cancel:2})).response){case 2:break;case 1:e.state="deleting",project.remove(r),fse.removeSync(r);break;case 0:e.state="deleting",project.remove(r)}},async openProject(e){if(!e){const r=await Dialog.select({type:"directory",title:t("open_project"),path:require("electron").remote.app.getPath("home")});if(!r.filePaths||!r.filePaths[0])return;e=r.filePaths[0]}if(fs.existsSync(e))await this.confirmVersion(e)&&project.open(e);else{1===(await Dialog.warn(t("message.project_missing"),{title:t("project_missing"),buttons:[t("cancel"),t("remove")]})).response&&project.remove(e)}},async confirmVersion(e){try{const r=ps.join(e,"package.json"),s=fse.readJSONSync(r);let o=!0;if(s.version){const r=semver.gt(version,s.version),i=semver.lt(version,s.version);let a="",n="";if(r&&(a=t("message.upgrade_message"),n=t("message.upgrade_detail")),i&&(a=t("message.degrade_message"),n=t("message.degrade_detail")),a){switch(n=n.replace("$$projectVersion",s.version).replace("$$editorVersion",version).replace("$$projectPath",e),(await Dialog.warn(a,{title:t("warn"),detail:n,buttons:["Yes","Cancel"]})).response){case 0:o=!0;break;default:o=!1}}if(!o)return!1}return s.version=version,fse.outputJSONSync(r,s,{spaces:2}),o}catch(e){return console.error(`Check project editor version failed! ${e.message}`),!0}},stamp2time(e){let t=new Date(e);return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`},_onMouseEnter(e,t){this.hover=t},_onMouseLeave(e){this.hover=null},updateProjects(){this.projects=project.query({type:this.type})}},exports.mounted=function(){const e=()=>{this.updateProjects()};e(),project.on("add",e).on("remove",e).on("open",e),ipc.on("dashboard:update-opens",(e,t)=>{this.opens=t.opens}),ipc.send("dashboard:get-opens")};