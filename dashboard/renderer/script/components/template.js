"use strict";const fs=require("fs"),ps=require("path"),fse=require("fs-extra"),project=require("@editor/project"),{v4:v4}=require("node-uuid"),{getName:getName,t:t}=require("./../util"),dialog=require("../../../../lib/dist/dialog").Dialog,metrics=require("../../../../lib/dist/metrics").Metrics,profile=require("@base/electron-profile"),dashProfile=profile.load("profile://global/editor/dashboard.json");function updateProjectName(e){const t=v4();try{const r=fse.readJSONSync(ps.join(e,"package.json"));r.name=ps.basename(e),r.uuid=t,fse.outputJSONSync(ps.join(e,"package.json"),r,{spaces:2})}catch(e){console.error(`Rename project failed! ${e.message}`)}return t}exports.template=fs.readFileSync(ps.join(__dirname,"../../template/template.html"),"utf-8"),exports.props=["type"],exports.data=function(){return{list:[],activeIndex:0,directoryPath:"",projectName:"NewProject"}},exports.watch={type(){}},exports.methods={t:t,createProject(){let e=this.list[this.activeIndex];if(!this.directoryPath||!this.projectName)return;let r=ps.join(ps.normalize(this.directoryPath),this.projectName);if(fs.existsSync(r)){if(!this.isEmptyDir(r))return void dialog.warn(t("message.duplicate_project"),{title:t("warn"),buttons:["Cancel"]})}else fse.ensureDirSync(r);fse.copySync(e.path,r),this.changeMode(r),this.initGit(r),dashProfile.set("recentProPath",ps.join(this.directoryPath,this.projectName)),dashProfile.save();const i=updateProjectName(r);try{const t={projectId:i,projectNm:this.projectName,template:e.name,dimension:"2"};metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreateProjectId",...t}),metrics.trackEvent({category:"CreateProject",action:"create",label:JSON.stringify(t)})}catch(e){console.error(e)}project.open(r),this.updatedRecProPath()},chooseProSrc(){let e=this;dialog.select({path:this.directoryPath,type:"directory",title:this.t("template.select_project")}).then(t=>{!t.canceled&&t.filePaths[0]&&(e.directoryPath=t.filePaths[0])})},isEmptyDir(e){let t=fs.readdirSync(e);return!t||!t.length},updatedRecProPath(){const e=dashProfile.get("recentProPath");e&&(this.directoryPath=ps.dirname(e),this.projectName=ps.basename(getName(e)))},updateList(){this.list.push({name:"empty",path:ps.join(__dirname,`../../../static/${this.type}-template/empty`)})},changeMode(e){const t=fs.readdirSync(e);for(const r of t){const t=ps.join(e,r);fs.chmodSync(t,511),fs.statSync(t).isDirectory()&&this.changeMode(t)}},initGit(e){const t=require("child_process").exec;try{t("git init && git config core.autocrlf input",{env:process.env,cwd:e},e=>{if(e)throw new Error(e)})}catch(e){console.error(e)}}},exports.mounted=function(){this.updateList(),this.updatedRecProPath()};