"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),index_1=require("../../menu/browser/index"),Profile=require("@base/electron-profile"),ipc=require("@base/electron-base-ipc"),flag="editor-lib-user",user=process.send?require("@editor/user/dist/platform/child"):require("@editor/user");if(!process.send){const e=Profile.load("global://editor/user.json"),s=require("@editor/user"),i=e.get();s.setData(i),s.on("info-update",async()=>{const i=await s.getData();e.set("session_id",i.session_id),e.set("session_key",i.session_key),e.set("cocos_uid",i.cocos_uid),e.set("email",i.email),e.set("nickname",i.nickname),e.save()})}user.on("login",()=>{User.emit("login"),ipc.broadcast(`${flag}:emit`,"login")}),user.on("logout",()=>{User.emit("logout"),ipc.broadcast(`${flag}:emit`,"logout"),index_1.remove("i18n:menu.develop",{label:"i18n:menu.logout"}),index_1.apply()});class UserManager extends EventEmitter{constructor(){super(...arguments),this._initCallback=null,this._skip=!1}init(){return new Promise(e=>{void 0!==this._initCallback?(ipc.broadcast(`${flag}:init`),this._initCallback=e):e()})}nextInit(){this._initCallback&&this._initCallback(),this._initCallback=void 0}skip(){this._skip=!0,ipc.broadcast(`${flag}:hideMask`),this.emit("skip"),ipc.broadcast(`${flag}:emit`,"skip"),index_1.apply()}showMask(){ipc.broadcast(`${flag}:showMask`)}hideMask(){ipc.broadcast(`${flag}:hideMask`)}async getData(){return user.getData()}async isLoggedIn(){return!0!==this._skip&&user.isLoggedIn()}async login(e,s){return this._skip=!1,user.login(e,s)}async logout(){return user.logout()}async getUserToken(){return user.getUserToken()}async getSessionCode(e){return await user.getSessionCode(e)}}const User=module.exports=new UserManager;ipc.on(`${flag}:call`,async(e,s,...i)=>{const t=User[s];let r;try{r=await t.call(User,...i)}catch(s){return void e.reply(s,null)}e.reply(null,r)}),ipc.on(`${flag}:check-skip-init`,async(e,s,...i)=>(e.reply(null,User._skip),User._skip));