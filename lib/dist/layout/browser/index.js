"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.apply=exports.init=void 0;const panel_1=require("../../panel"),{BrowserWindow:BrowserWindow}=require("electron"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc");let mainID=null;function init(){}async function apply(e){if(null===mainID)return;const n=[];!function e(o){o.panels&&o.panels.forEach(e=>{n.push(e)}),o.children&&o.children.forEach(e)}(e.layout);for(let e=0;e<n.length;e++){const o=n[e],i=panel.getWindow(o)||[];if(!await tryClose(o,i))return void console.warn(`更改布局失败：${o} 面板不允许关闭`);1!==i.length||i[0]!==mainID||n.splice(e--,1)}for(let e=0;e<n.length;e++){const o=n[e];if(!await panel_1.Panel.close(o))return void console.warn(`更改布局失败：${o} 面板不允许关闭`)}const o=BrowserWindow.fromId(mainID);ipc.sendToWin(o,"editor-lib-layout:apply",e)}async function tryClose(e,n){if(null===n||void 0===n)return!0;const o=n.map(n=>new Promise((o,i)=>{const r=BrowserWindow.fromId(n);ipc.sendToWin(r,"editor-lib-layout:try-close",e).callback((e,n)=>{o(n)})}));return(await Promise.all(o)).every(Boolean)}exports.init=init,exports.apply=apply,ipc.on("editor-lib-layout:main",e=>{if(!e.sender)return void(mainID=null);const n=BrowserWindow.fromWebContents(e.sender);mainID=n&&"number"==typeof n.id?n.id:null});