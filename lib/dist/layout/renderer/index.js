"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.apply=void 0;const panel_1=require("../../panel"),fs=require("fs"),ps=require("path"),windows=require("@base/electron-windows"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n");let $dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}function findPanelsFromLayout(e){const t=[];return e.panels&&e.panels.forEach(e=>{t.push(e)}),e.children&&e.children.forEach(e=>{findPanelsFromLayout(e).forEach(e=>{t.push(e)})}),t}function init(){if($dock){let e=windows.userData.layout;if(!e){let t=ps.join(__dirname,"../layouts/default.json");e=JSON.parse(fs.readFileSync(t,"utf8"))}module.exports.apply(e);let t=null,n="";$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){let e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,o=e.top+e.bottom-e.height,a=windows.userData.layout=$dock.dump();windows.setMinSize(t+a.layout["min-width"],o+a.layout["min-height"]),windows.sync();try{if(!window.__MAIN__){const e=findPanelsFromLayout(a.layout);let t=e.join(",");if(n===t)return;n=t;const o=e.map(e=>{let t=$dock.$layout.querySelector(`panel-frame[name="${e}"]`).userData.title||e;return t.startsWith("i18n:")&&Editor.I18n.t(t.substr(5))||t});document.title=o.join(",")}}catch(e){console.warn(e)}},300),requestAnimationFrame(()=>{let e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(t),void window.close()})}),dock.registerMenuParser("popup",function(e){const t=e&&e.userData&&e.userData.flags&&e.userData.flags.popup;return{label:i18n.translation("menu.panel_popup"),enabled:!(!1===t),async click(e){!1!==await this.removePanel(e)&&panel_1.Panel.open(e)}}}),dock.registerMenuParser("close",function(e){const t=e&&e.userData&&e.userData.flags&&e.userData.flags.close;return{label:i18n.translation("menu.panel_close"),enabled:!(!1===t),async click(e){this.removePanel(e)}}})}}exports.apply=apply,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",async(e,t)=>{window.__MAIN__&&module.exports.apply(t)}),ipc.on("editor-lib-layout:try-close",async(e,t)=>{const n=panel.query(t);if(!n||n.length<=0)return e.reply(null,!0);const o=await Promise.all(n.map(async e=>await e.emit("beforeClose")));return e.reply(null,!o.some(e=>!1===e))}),exports.init=init;