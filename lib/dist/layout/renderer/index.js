"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.apply=void 0;const panel_1=require("../../panel"),fs=require("fs"),ps=require("path"),windows=require("@base/electron-windows"),dock=require("@editor/dock"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),i18n=require("@base/electron-i18n");let $dock=document.querySelector("dock-frame");function apply(e){$dock&&$dock.layout(e)}function findPanelsFromLayout(e){const t=[];return e.panels&&e.panels.forEach(e=>{t.push(e)}),e.children&&e.children.forEach(e=>{findPanelsFromLayout(e).forEach(e=>{t.push(e)})}),t}function init(){if($dock){let e=windows.userData.layout;if(!e){let t=ps.join(__dirname,"../layouts/default.json");e=JSON.parse(fs.readFileSync(t,"utf8"))}module.exports.apply(e);let t=null,a="";$dock.addEventListener("layout",function(){clearTimeout(t),t=setTimeout(function(){let e=$dock.getBoundingClientRect(),t=e.left+e.right-e.width,n=e.top+e.bottom-e.height,o=windows.userData.layout=$dock.dump();windows.setMinSize(t+o.layout["min-width"],n+o.layout["min-height"]),windows.sync();try{if(!window.__MAIN__){const e=findPanelsFromLayout(o.layout);let t=e.join(",");if(a===t)return;a=t;const n=e.map(e=>{let t=$dock.$layout.querySelector(`panel-frame[name="${e}"]`).userData.title||e;return t.startsWith("i18n:")&&Editor.I18n.t(t.substr(5))||t});document.title=n.join(",")}}catch(e){console.warn(e)}},300),requestAnimationFrame(()=>{let e=$dock.$layout.firstElementChild;if(!e||"DOCK-GROUPS"===e.tagName&&0===e.panels.length)return clearTimeout(t),void window.close()})}),dock.registerMenuParser(async function(e,t){const a=panel.queryInfo(t);let n=!0;a&&a.userData&&a.userData.flags&&!1===a.userData.flags.popup&&(n=!1);let o=!0;a&&a.userData&&a.userData.flags&&!1===a.userData.flags.close&&(o=!1);let l=[{label:i18n.translation("menu.panel_popup"),enabled:n,async click(){!1!==await e.removePanel(t)&&panel_1.Panel.open(t)}},{label:i18n.translation("menu.panel_close"),enabled:o,async click(){e.removePanel(t)}}];return a&&a.userData&&a.userData.menus&&a.userData.menus.forEach(e=>{e.click=function(){Editor.Message.send(a.userData.package,e.message)},delete e.icon,e.label=e.label.startsWith("i18n:")?Editor.I18n.t(e.label.substr(5)):e.label,l.push(e)}),l})}}exports.apply=apply,window.__MAIN__&&ipc.send("editor-lib-layout:main"),ipc.on("editor-lib-layout:apply",async(e,t)=>{window.__MAIN__&&module.exports.apply(t)}),ipc.on("editor-lib-layout:try-close",async(e,t)=>{const a=panel.query(t);if(!a||a.length<=0)return e.reply(null,!0);const n=await Promise.all(a.map(async e=>await e.emit("beforeClose")));return e.reply(null,!n.some(e=>!1===e))}),exports.init=init;