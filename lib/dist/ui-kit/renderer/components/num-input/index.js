"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NumInput=void 0;const vm=require("vm"),fs=require("fs"),path=require("path"),base_1=require("../base"),{mathUtils:mathUtils}=require("../../utils"),Profile=require("@base/electron-profile"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./num-input.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./num-input.html"),"utf8")}`,instanceArray=[];let customStyle="";const profile=Profile.load("global://editor/ui-kit.json"),settings={step:.001,preci:6,errorValue:0},step=profile.get("num-input.step");step&&(settings.step=step),Profile.on("change",(t,e,i,s)=>{let n=!1;"global"===t&&"editor/ui-kit.json"===e&&("num-input.step"===i&&(settings.step=s-0,n=!0),n&&instanceArray.forEach(t=>{t._setTooltip()}))});class NumInput extends base_1.Base{constructor(){super(),this.ignoreInputFocus=!1,this._staging=null,this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$input=this.shadowRoot.querySelector("input"),this.$up=this.shadowRoot.querySelector(".up"),this.$down=this.shadowRoot.querySelector(".down"),this.$label=this.shadowRoot.querySelector(".label"),this.$unit=this.shadowRoot.querySelector(".unit span"),this.$input.$root=this.$up.$root=this.$down.$root=this.$unit.$root=this.$label.$root=this,this._staging=null,this.$input.addEventListener("focus",this._onInputFocus),this.$input.addEventListener("blur",this._onInputBlur),this.$input.addEventListener("input",this._onInputChange),this.$input.addEventListener("wheel",this._onInputWheel),this.$unit.addEventListener("mousedown",this._onUnitClick),this.$label.addEventListener("mousedown",this._onLabelMouseDown),this.$up.addEventListener("mousedown",this._onUpMouseDown),this.$down.addEventListener("mousedown",this._onDownMouseDown))}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}static get observedAttributes(){return["disabled","readonly","invalid","path","label","unit","preci","step","max","min","state","title","value"]}attributeChangedCallback(t,e,i){switch(super.attributeChangedCallback(t,e,i),t){case"disabled":this.$input.disabled=null!==i;break;case"readonly":null!==i?this.$input.setAttribute("readonly",""):this.$input.removeAttribute("readonly");break;case"invalid":this.$input.value=null!==i?"-":this.value;break;case"value":if(this.invalid)return;if(null!==this._staging)return;this.$input.value=this.calcValue(i),this._checkState();break;case"label":this.$label.innerHTML=i||"",this.$label.hidden=!i;break;case"unit":this.$unit.innerHTML=i||"";break;case"preci":case"step":this._setTooltip();break;case"max":if(this.max=i,null===this.getAttribute("value"))return;const s=mathUtils.clamp(this.value,this.min,this.max);this.value!==s&&(this.value=s,this.dispatch("confirm")),this._setTooltip();break;case"min":if(this.min=i,null===this.getAttribute("value"))return;const n=mathUtils.clamp(this.value,this.min,this.max);this.value!==n&&(this.value=n,this.dispatch("confirm")),this._setTooltip()}}get value(){let t=this.$input.value.trim();if(!window.isFinite(t)){const t=this.getAttribute("value"),e=Number(t);return isNaN(e)?settings.errorValue:e}return Number(t)}set value(t){this.$input.value!=t&&(t=this.calcValue(t),this.setAttribute("value",String(t)))}get label(){return this.getAttribute("label")||""}set label(t){t?this.setAttribute("label",t):this.removeAttribute("label")}get unit(){return this.getAttribute("unit")||""}set unit(t){t+="",this.setAttribute("unit",t)}get preci(){const t=this.getAttribute("preci");return isNaN(Number(t))||[null,"",void 0].includes(t)?settings.preci:Number(t)}set preci(t){t-=0,t=mathUtils.clamp(t,0,20),this.setAttribute("preci",String(t))}get step(){let t=this.getAttribute("step");return(isNaN(Number(t))||[null,"",void 0].includes(t))&&(t=settings.step),mathUtils.comPreci(t)>this.preci&&(t=Math.pow(10,0-this.preci)),Number(t)}set step(t){t-=0,this.setAttribute("step",String(t))}get max(){let t=this.getAttribute("max");return null===t?null:"number"!=typeof(t=Number(t))||isNaN(t)?null:t}set max(t){if(null===t)this.removeAttribute("max");else{const e=this.getAttribute("max");t.toString()!==e&&this.setAttribute("max",String(t))}}get min(){let t=this.getAttribute("min");return null===t?null:"number"!=typeof(t=Number(t))||isNaN(t)?null:t}set min(t){if(null===t)this.removeAttribute("min");else{t!==this.getAttribute("min")&&this.setAttribute("min",String(t))}}get state(){return this.getAttribute("state")||""}set state(t){this.setAttribute("state",t)}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}this._setTooltip()}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}_setTooltip(){const t=[];null!==this.min&&t.push(`Min: ${this.min}`),null!==this.max&&t.push(`Max: ${this.max}`),null!==this.preci&&t.push(`Decimals: ${this.preci}`),null!==this.step&&t.push(`Step: ${this.step}`),this.setAttribute("tooltip",t.join("\n"))}_onFocus(t){super._onFocus(t),this.invalid||this.disabled||this.ignoreInputFocus||this.$input.focus()}_onInputFocus(){this.disabled||(this.$root._staging=this.$root.value,this.select())}_onInputBlur(){const t=this;t.$root._staging!==t.$root.value&&(t.value=t.$root.calcValue(t.value),t.setAttribute("value",t.value),t.$root._confirm(!0)),t.$root._staging=null}_onInputChange(){isNaN(this.value)||this.$root.dispatch("change")}_onInputWheel(t){const e=this;e.matches(":focus")&&(t.stopPropagation(),t.preventDefault(),-1===Math.sign(t.deltaY)?e.$root.stepUp():e.$root.stepDown())}_onUnitClick(t){t.stopPropagation(),t.preventDefault(),this.$root._onInputBlur.call(this),this.$root.dispatch("unit-click")}_onKeyDown(t){if(!this.disabled&&!this.readonly)switch(t.keyCode){case 13:this._confirm();break;case 27:this._cancel();break;case 38:t.preventDefault(),this.stepUp();break;case 40:t.preventDefault(),this.stepDown()}}_confirm(t){if(this.invalid)return;const e=this.value,i=null!==this._staging;null!==this._staging&&this._staging!==e&&(this._staging=e,this.dispatch("change"),this.dispatch("confirm")),this.invalid||(this.$input.value=e),t||(i?this.focus():this.$input.focus())}_cancel(){const t=null!==this._staging;null!==this._staging&&this._staging!==this.value&&(this.value=this.$input.value=this._staging,this.dispatch("change"),this.dispatch("cancel"),this.dispatch("confirm")),this.invalid||(this.$input.value=this.value),t&&this.focus()}stepUp(t){if(this.disabled||this.readonly)return;null===this._staging&&this.$input.focus();const e=t||this.step,i=mathUtils.accAdd(this.value,e);null!==this.max&&i>this.max?this._timer&&(clearTimeout(this._timer),clearInterval(this._timer)):(this.invalid&&(this.invalid=!1),this.$input.value=this.calcValue(i),this.setAttribute("value",this.$input.value),this.dispatch("change"))}stepDown(t){if(this.disabled||this.readonly)return;null===this._staging&&this.$input.focus();const e=t||this.step,i=mathUtils.accSub(this.value,e);null!==this.min&&i<this.min?this._timer&&(clearTimeout(this._timer),clearInterval(this._timer)):(this.invalid&&(this.invalid=!1),this.$input.value=this.calcValue(i),this.setAttribute("value",this.$input.value),this.dispatch("change"))}_onUpMouseDown(t){t.stopPropagation(),this.$root._onUpDownMouseDown(this,"stepUp")}_onDownMouseDown(t){t.stopPropagation(),this.$root._onUpDownMouseDown(this,"stepDown")}_onUpDownMouseDown(t,e){const i=this;i.disabled||i.readonly||(t.setAttribute("pressed",""),i[e](),clearTimeout(i._timer),clearInterval(i._timer),i._timer=setTimeout(()=>{i._timer=setInterval(()=>{i[e]()},50)},300),i._bindMouseUp=i._onUpDownMouseUp.bind(i),document.addEventListener("mouseup",i._bindMouseUp,!0))}_onUpDownMouseUp(){const t=this;document.removeEventListener("mouseup",t._bindMouseUp,!0),t._timer&&(clearTimeout(t._timer),clearInterval(t._timer),delete t._timer),t.$up.removeAttribute("pressed"),t.$down.removeAttribute("pressed"),t.dispatch("confirm")}_onLabelMouseDown(t){this._clientX=t.clientX,this._value=this.$root.value,this._onLabelMouseMove=this.$root._onLabelMouseMove.bind(this),this._onLabelMouseUp=this.$root._onLabelMouseUp.bind(this),document.addEventListener("mousemove",this._onLabelMouseMove),document.addEventListener("mouseup",this._onLabelMouseUp),this.$root.ignoreInputFocus=!0}_onLabelMouseMove(t){const e=t.clientX-this._clientX,i=Number(e*this.$root.step.toFixed(this.$root.preci));this.$root.value=this._value+i,this.$root.$input.value=this.$root.value,this.$root.dispatch("change")}_onLabelMouseUp(){document.removeEventListener("mousemove",this._onLabelMouseMove),document.removeEventListener("mouseup",this._onLabelMouseUp),this.$root.ignoreInputFocus=!1,this.$root.disabled||this.$root.readonly||this.$root.dispatch("confirm")}_checkState(){window.cancelAnimationFrame(this.animationId),this.animationId=window.requestAnimationFrame(()=>{const{value:t,max:e,min:i}=this;let s="";"number"==typeof e&&t>e&&(s="error-range"),"number"==typeof i&&t<i&&(s="error-range"),this.state=s})}calcValue(t){if(!t){const e=Number(t);if(isNaN(e))return settings.errorValue}const e={value:settings.errorValue};try{vm.runInNewContext(`value = ${t};`,e)}catch(t){}let i=e.value;if("number"==typeof this.preci){mathUtils.comPreci(i)>this.preci&&(i=Number(i.toFixed(this.preci)))}return"number"==typeof this.max&&(i=Math.min(this.max,i)),"number"==typeof this.min&&(i=Math.max(this.min,i)),i}}exports.NumInput=NumInput;