"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Curve=void 0;const __1=require("../.."),curve_1=require("../curve-editor/lib/curve"),fs=require("fs"),path=require("path"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./curve.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./curve.html"),"utf8")}`,instanceArray=[];let customStyle="";class Curve extends __1.Base{constructor(){super(),this._type="hermit",this._connect=!1,this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$canvas=this.shadowRoot.querySelector(".canvas"))}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}get type(){return this._type}set value(t){this.setAttribute("value",JSON.stringify(t))}get value(){return this._value}get config(){return this._config}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),!this.shadowRoot)return;const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle),this._connect=!0,this.$canvas.height=this.offsetHeight,this.$canvas.width=this.offsetWidth;try{const t=JSON.parse(this.getAttribute("config"));t&&!this._config&&(this._config=t)}catch(t){}this.render(),this.addEventListener("click",this._onClick)}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["focused","readonly","disabled","value","config"]}attributeChangedCallback(t,e,s){switch(t){case"value":try{const t=JSON.parse(s);this.render(t),this._value=t}catch(t){console.debug(t)}break;case"config":try{const t=JSON.parse(this.getAttribute("config"));t&&(this._config=t),this.render(this._value)}catch(t){}}}render(t=this.value){var e;if(!this._connect||!t||!t.keys)return;if(!this.$canvas.width){const t=new IntersectionObserver(e=>{const{isIntersecting:s}=e[0];if(s){const e=this.getBoundingClientRect();t.unobserve(this),this.$canvas.width=e.width,this.$canvas.height=e.height,this.render(this._value)}},{threshold:.2});t.observe(this)}const s=curve_1.getCurveClass("hermit");s&&s.quickPaint&&s.quickPaint(t.keys,this.$canvas,null!==(e=this.config&&this.config.negative)&&void 0!==e&&e)}_onClick(t){const e=this;t.target.disabled||t.target.readonly||Editor.Panel._kitControl.open({$kit:e,name:"ui-kit.curve-editor",value:e.value,config:e.config,label:e.getAttribute("label"),events:{confirm:t=>{e.value=t,e.dispatch("confirm",t)},change:t=>{e.value=t,e.dispatch("change",t)},cancel:t=>{e.value=t,e.dispatch("cancel",t)}}})}}exports.Curve=Curve;