"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Image=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base"),{DragArea:DragArea}=require("../drag/drag-area"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./image.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./image.html"),"utf8")}`,instanceArray=[];let customStyle="",srcTranslator=function(e){return e};class Image extends base_1.Base{constructor(){super(),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$img=this.shadowRoot.querySelector("img"),this.$area=this.shadowRoot.querySelector(".area ui-drag-area"),this.$placeholder=this.shadowRoot.querySelector(".area ui-drag-area .placeholder"),this.$img.$root=this.$area.$root=this)}static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),instanceArray.map(e=>{e.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}get size(){const e=this.getAttribute("size");return e?e.trim():""}set size(e){(e+="")?this.setAttribute("size",e):this.removeAttribute("size")}get placeholder(){const e=this.getAttribute("placeholder");return e?e.trim():""}set placeholder(e){e?this.setAttribute("placeholder",e):this.removeAttribute("placeholder")}get value(){const e=this.getAttribute("value");return e?e.trim():this.innerHTML.trim()}set value(e){(e+="")?this.setAttribute("value",e):this.removeAttribute("value")}get src(){return this.$img.src}set src(e){const t=this.$area.getBoundingClientRect();if(!t.width&&t.height)this.$img.style.width="auto",this.$img.style.height="100%";else if(t.width&&!t.height)this.$img.style.width="100%",this.$img.style.height="auto";else{null!==this.getAttribute("fill")?(this.$img.style.width="100%",this.$img.style.height="100%"):(this.$area.style.display="flex",this.$img.style.maxWidth="100%",this.$img.style.maxHeight="100%",this.$img.style.margin="auto")}e?this.$img.src=e:this.$img.removeAttribute("src")}get droppable(){return this.$area.droppable}set droppable(e){this.$area.droppable=e}static setSrcTranslator(e){"function"==typeof e&&(srcTranslator=e)}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this._droppable=this.getAttribute("droppable")||"",this._placeholder=this.getAttribute("placeholder")||this._droppable||"NONE",this._droppable&&(this.$area.droppable=this._droppable),this._placeholder&&(this.$placeholder.innerHTML=this._placeholder),!this.value&&this.setAttribute("title",this._droppable),this.shadowRoot){const e=this.shadowRoot.querySelector("#custom-style");e&&(e.innerHTML=customStyle)}this.$area.addEventListener("dragover",this._onAreaDragOver),this.$area.addEventListener("dragleave",this._onAreaDragLeave),this.$area.addEventListener("drop",this._onAreaDrop)}disconnectedCallback(){super.disconnectedCallback();const e=instanceArray.indexOf(this);instanceArray.splice(e,1),this.$area.removeEventListener("dragover",this._onAreaDragOver),this.$area.removeEventListener("dragleave",this._onAreaDragLeave),this.$area.removeEventListener("drop",this._onAreaDrop)}static get observedAttributes(){return["readonly","placeholder","disabled","value","src","droppable","size","path","fill"]}async attributeChangedCallback(e,t,r){switch(super.attributeChangedCallback(e,t,r),e){case"value":if(t===r)return;const a=await srcTranslator.call(this,r);this.src=a,this.$area.value!==r&&(this.$area.value=r),r||this.removeAttribute("value");break;case"droppable":this._droppable=r,this.$area.droppable=this._droppable;break;case"placeholder":this._placeholder=r||"NONE",this.$placeholder.innerHTML=this._placeholder}}_onAreaDragOver(){this.$root.disabled||this.$root.readonly||this.$root.setAttribute("state",this.hoving||this.additional?"allow":"refused")}_onAreaDragLeave(){this.$root.disabled||this.$root.readonly||this.$root.removeAttribute("state")}_onAreaDrop(e){const t=this;if(t.$root.disabled||t.$root.readonly)return;const r=t.$root.getAttribute("state");if(t.$root.removeAttribute("state"),"refused"===r)return;const a=e.dataTransfer.getData("value");if(a)return t.$root.value=a,t.$root.dispatch("confirm"),void(t.$root.invalid=!1);if(t.additional){const e=t.droppable,r=DragArea.currentDragInfo.additional;if(r)for(const a of r)if(e.includes(a.type))return t.$root.value=a.value,t.$root.dispatch("confirm"),void(t.$root.invalid=!1)}}}exports.Image=Image;