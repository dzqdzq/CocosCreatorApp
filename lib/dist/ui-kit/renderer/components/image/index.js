"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Image=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base"),{DragArea:DragArea}=require("../drag/drag-area"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./image.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./image.html"),"utf8")}`,instanceArray=[];let customStyle="",srcTranslator=function(t){return t};class Image extends base_1.Base{constructor(){super(),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$img=this.shadowRoot.querySelector("img"),this.$area=this.shadowRoot.querySelector(".area ui-drag-area"),this.$placeholder=this.shadowRoot.querySelector(".area ui-drag-area .placeholder"),this.$img.$root=this.$area.$root=this)}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}get size(){const t=this.getAttribute("size");return t?t.trim():""}set size(t){(t+="")?this.setAttribute("size",t):this.removeAttribute("size")}get value(){const t=this.getAttribute("value");return t?t.trim():this.innerHTML.trim()}set value(t){(t+="")?this.setAttribute("value",t):this.removeAttribute("value"),this.dispatch("change"),this.dispatch("confirm")}get src(){return this.$img.src}set src(t){const e=this.$area.getBoundingClientRect();if(!e.width&&e.height)this.$img.style.width="auto",this.$img.style.height="100%";else if(e.width&&!e.height)this.$img.style.width="100%",this.$img.style.height="auto";else{null!==this.getAttribute("fill")?(this.$img.style.width="100%",this.$img.style.height="100%"):(this.$area.style.display="flex",this.$img.style.maxWidth="100%",this.$img.style.maxHeight="100%",this.$img.style.margin="auto")}t?this.$img.src=t:this.$img.removeAttribute("src")}get droppable(){return this.$area.droppable}set droppable(t){this.$area.droppable=t}static setSrcTranslator(t){"function"==typeof t&&(srcTranslator=t)}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this._droppable=this.getAttribute("droppable")||"",this._placeholder=this.getAttribute("placeholder")||this._droppable||"NONE",this._droppable&&(this.$area.droppable=this._droppable),this._placeholder&&(this.$placeholder.innerHTML=this._placeholder),!this.value&&this.setAttribute("title",this._droppable),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}this.$area.addEventListener("dragover",this._onAreaDragOver),this.$area.addEventListener("dragleave",this._onAreaDragLeave),this.$area.addEventListener("drop",this._onAreaDrop)}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1),this.$area.removeEventListener("dragover",this._onAreaDragOver),this.$area.removeEventListener("dragleave",this._onAreaDragLeave),this.$area.removeEventListener("drop",this._onAreaDrop)}static get observedAttributes(){return["readonly","disabled","value","src","droppable","size","path","fill"]}async attributeChangedCallback(t,e,r){switch(super.attributeChangedCallback(t,e,r),t){case"value":if(e===r)return;const a=await srcTranslator.call(this,r);this.src=a,this.$area.value!==r&&(this.$area.value=r),r||this.removeAttribute("value");break;case"droppable":this._droppable=r,this.$area.droppable=this._droppable,this._placeholder=this.getAttribute("placeholder")||this._droppable||"NONE"}}_onAreaDragOver(){this.$root.disabled||this.$root.readonly||this.$root.setAttribute("state",this.hoving||this.additional?"allow":"refused")}_onAreaDragLeave(){this.$root.disabled||this.$root.readonly||this.$root.removeAttribute("state")}_onAreaDrop(t){const e=this;if(e.$root.disabled||e.$root.readonly)return;const r=e.$root.getAttribute("state");if(e.$root.removeAttribute("state"),"refused"===r)return;const a=t.dataTransfer.getData("value");if(a)return e.$root.value=a,void(e.$root.invalid=!1);if(e.additional){const t=e.droppable,r=DragArea.currentDragInfo.additional;if(r)for(const a of r)if(t.includes(a.type))return e.$root.value=a.value,void(e.$root.invalid=!1)}}}exports.Image=Image;