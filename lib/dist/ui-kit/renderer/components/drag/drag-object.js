"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DragObject=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base"),DragArea=require("./drag-area"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./drag-object.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./drag-object.html"),"utf8")}`,instanceArray=[];let customStyle="";class DragObject extends base_1.Base{constructor(){super(),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$area=this.shadowRoot.querySelector("ui-drag-area"),this.$clear=this.shadowRoot.querySelector(".clear"),this.$value=this.shadowRoot.querySelector("ui-drag-area .value"),this.$placeholder=this.shadowRoot.querySelector("ui-drag-area .placeholder"),this.$area.$root=this.$clear.$root=this)}static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),instanceArray.map(e=>{e.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}static get observedAttributes(){return["disabled","droppable","value","placeholder","readonly","invalid","path"]}async attributeChangedCallback(e,t,r){switch(super.attributeChangedCallback(e,t,r),e){case"droppable":this._droppable=r.trim(),this.placeholder=this._droppable;break;case"value":this._value!==r.trim()&&(this._value=r,this.$value.innerHTML=this._value),this._value?(this.setAttribute("effective",""),this.hasAttribute("editable")&&this.setAttribute("editable","true")):(this.removeAttribute("effective"),this.hasAttribute("editable")&&this.setAttribute("editable","false"));break;case"placeholder":this._placeholder=r.trim(),this.$placeholder.innerHTML=this._placeholder}}get droppable(){return this._droppable}set droppable(e){e+="",this._droppable!==e&&(this._droppable=e,this.$area.droppable=e)}get value(){return this._value}set value(e){if(e=e.toString().trim(),this.invalid)this.invalid=!1;else if(this._value===e)return;this._value=e,this.setAttribute("value",this._value),this.dispatch("change"),this.dispatch("confirm")}get placeholder(){return this._placeholder}set placeholder(e){e=e.toString().trim(),this._placeholder!==e&&this.setAttribute("placeholder",e)}get invalid(){return null!==this.getAttribute("invalid")}set invalid(e){e?this.setAttribute("invalid",""):this.removeAttribute("invalid")}async connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this._droppable=this.getAttribute("droppable")||"",this._value=this.getAttribute("value")||"",this._placeholder=this.getAttribute("placeholder")||this._droppable||"NONE",this._droppable&&(this.$area.droppable=this._droppable),this._placeholder&&(this.$placeholder.innerHTML=this._placeholder),this.$area.setAttribute("title",this._droppable),this.shadowRoot){const e=this.shadowRoot.querySelector("#custom-style");e&&(e.innerHTML=customStyle)}this.$area.addEventListener("dragover",this._onAreaDragOver),this.$area.addEventListener("dragleave",this._onAreaDragLeave),this.$area.addEventListener("drop",this._onAreaDrop),this.$clear.addEventListener("click",this._onClearClick)}disconnectedCallback(){super.disconnectedCallback();const e=instanceArray.indexOf(this);instanceArray.splice(e,1),this.$area.removeEventListener("dragover",this._onAreaDragOver),this.$area.removeEventListener("dragleave",this._onAreaDragLeave),this.$area.removeEventListener("drop",this._onAreaDrop),this.$clear.removeEventListener("click",this._onClearClick)}_onAreaDragOver(){this.$root.disabled||this.$root.readonly||this.$root.setAttribute("state",this.hoving||this.additional?"allow":"refused")}_onAreaDragLeave(){this.$root.disabled||this.$root.readonly||this.$root.removeAttribute("state")}_onAreaDrop(e){const t=this;if(t.$root.disabled||t.$root.readonly)return;const r=t.$root.getAttribute("state");if(t.$root.removeAttribute("state"),"refused"!==r){if(t.additional){const e=t.droppable,r=DragArea.currentDragInfo.additional;if(r)for(const a of r)if(e.includes(a.type))return void(t.$root.value=a.value)}else t.$root.invalid&&(t.$root.invalid=!1);t.$root.value=e.dataTransfer.getData("value")}}_onClearClick(e){this.$root.disabled||this.$root.readonly||(e.stopPropagation(),this.$root.value="",this.$root.dispatch("clear"))}}exports.DragObject=DragObject;