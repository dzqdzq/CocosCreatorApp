"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CurveEditor=void 0;const tooltip_1=require("../tooltip"),curve_ctrl_1=require("./lib/curve-ctrl"),fs=require("fs"),path=require("path"),STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./curve-editor.css"),"utf8")}</style>`,CUSTOM_STYLE='<style id="custom-style"></style>',HTML=`${fs.readFileSync(path.join(__dirname,"./curve-editor.html"),"utf8")}`;let customStyle="";class CurveEditor extends HTMLElement{constructor(){super(),this.config={type:"hermit",showPreWrapMode:!1,showPostWrapMode:!1,xRange:[0,1],yRange:[0,1],precision:2,color:"red"},this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$curveLabelX=this.shadowRoot.querySelector(".x-axis"),this.$curveLabelY=this.shadowRoot.querySelector(".y-axis"),this.$ctrlCanvas=this.shadowRoot.querySelector(".ctrl"))}set value(t){t&&t.keys?this.setAttribute("value",JSON.stringify(t)):this.curveCtrl.clearAll()}get value(){return this.curveCtrl?{keys:this.curveCtrl.getCurrentKeyframes(),preWrapMode:this.curveCtrl.curve.config.preWrapMode,postWrapMode:this.curveCtrl.curve.config.postWrapMode}:null}set focused(t){(t=!!t)?this.$ctrlCanvas.setAttribute("focused",""):this.$ctrlCanvas.removeAttribute("focused"),this.dispatch("focus-changed")}get disabled(){return null!==this.getAttribute("disabled")}set disabled(t){(t=!!t)?(this.setAttribute("disabled",""),this.$ctrlCanvas.setAttribute("tabindex","-1")):(this.removeAttribute("disabled"),this.$ctrlCanvas.setAttribute("tabindex","0"))}get readonly(){return null!==this.getAttribute("readonly")}set readonly(t){(t=!!t)?this.setAttribute("readonly",""):this.removeAttribute("readonly")}connectedCallback(){const t=null!==this.getAttribute("disabled"),e=this.getAttribute("tabindex")||"0";if(this.setAttribute("tabindex",t?"-1":e),!this.shadowRoot)return;const r=this.shadowRoot.querySelector("#custom-style");r&&(r.innerHTML=customStyle),this.initCurveCtrl(),this._render(this.value),tooltip_1.Tooltip.bind(this)}disconnectedCallback(){this.curveCtrl.unregisterHandler()}static get observedAttributes(){return["focused","readonly","disabled","value"]}attributeChangedCallback(t,e,r){switch(t){case"readonly":this.curveCtrl.readonly=!!r;break;case"value":if(!this.curveCtrl)break;try{const t=JSON.parse(r);this._render(t)}catch(t){console.debug(t)}}}initCurveCtrl(){const t=this.getAttribute("config");if(t)try{const e=JSON.parse(t);this.config=Object.assign(this.config,e)}catch(t){console.log(t)}let e=this.value;const r={curveConfig:{strokeStyle:this.config.color,preWrapMode:null===e||void 0===e?void 0:e.preWrapMode,postWrapMode:null===e||void 0===e?void 0:e.postWrapMode},gridConfig:{axisXConfig:{$container:this.$curveLabelX,maxValue:this.config.xRange[1],minValue:this.config.xRange[0],format:this.config.xFormat},axisYConfig:{$container:this.$curveLabelY,maxValue:this.config.yRange[1],minValue:this.config.yRange[0],format:this.config.yFormat},axisMargin:30,negative:this.config.negative},handlerSize:30,precision:this.config.precision};this.$ctrlCanvas.width=this.clientWidth,this.$ctrlCanvas.height=this.clientHeight,this.curveCtrl?this.curveCtrl.resetConfig(r):(this.curveCtrl=new curve_ctrl_1.CurveCtrl(this.$ctrlCanvas,r),this.curveCtrl.on("change",()=>this.dispatch("change")),this.curveCtrl.on("confirm",()=>this.dispatch("confirm")))}_render(t){this.curveCtrl.curve.config.preWrapMode=t.preWrapMode,this.curveCtrl.curve.config.postWrapMode=t.postWrapMode,t&&t.keys?this.curveCtrl.paint(t.keys):this.curveCtrl.grid.render()}dispatch(t){const e=document.createEvent("HTMLEvents");e.initEvent(t,!0,!0),this.dispatchEvent(e)}}exports.CurveEditor=CurveEditor;