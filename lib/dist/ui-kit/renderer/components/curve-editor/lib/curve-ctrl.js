"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CurveCtrl=void 0;const events_1=require("events"),curve_base_1=require("./curve-base"),grid_1=require("./grid"),hermite_1=require("./hermite"),utils_1=require("./utils"),Chroma=require("chroma-js"),lodash=require("lodash"),PIXEL_RANGE=20,UINT8_COLOR_DEFAULT=Array(4*PIXEL_RANGE*PIXEL_RANGE).fill(0).toString(),DEFAULT_CTRL_COLOR="rgba(255, 0, 0, 0.1)",AUX_LINE_COLOR="rgba(255, 0, 0, 0.3)",CLICK_RANGE=5,ICON_U16={settings:"&#xe736"},ICON_FONT_SIZE=10,ICON_FONT_NAME="editor-icon",I18N_HEADER="ui-kit.curve_editor",HANDLE_SIZE=40,editorBoxTemplate='\n<div class="edit-box">\n    <ui-prop>\n        <span slot="label">x: </span>\n        <ui-num-input name="x" slot="content"></ui-num-input>\n    </ui-prop>\n    <ui-prop>\n        <span slot="label">y: </span>\n        <ui-num-input name="y" slot="content"></ui-num-input>\n    </ui-prop>\n</div>';class CurveCtrl extends events_1.EventEmitter{constructor(e,t){var s,i,n;super(),this.readonly=!1,this.editCurveInfo={},this.config={handlerSize:HANDLE_SIZE,r:Math.floor(Math.sqrt(12)),strokeStyle:DEFAULT_CTRL_COLOR,precision:2,showPreWrapMode:!0,showPostWrapMode:!0,spacingFrame:5,wrapMode:1,sample:1},this.colors={handler:"gold",light:"rgba(255, 255, 255, 0.3)",defaultLine:"white",selectBoxLine:"rgba(255, 255, 255, 0.3)",selectBoxFill:"rgba(255, 255, 255, 0.1)"},this._rawCurveInfo={},this.curvePools=[],this.curveKeyQueue=[],this.currentCurveKey="",this.ctrlKeys=[],this.changeType="",this.ctrlState={showAuxin:!1,showCtrlHandle:!1,lightCurve:!1},this.currentKeyIndex=null,this.activeBoxInfo=null,this.selectedKeyInfos=null,this.mouseDownPoint=null,this._rawKeyFrames=[],this.editKeyInfo=null,this.eventHandlers=null,this.canvas=e,this.ctx=e.getContext("2d"),this.ctx.strokeStyle=this.config.strokeStyle;const r=e.cloneNode();r.className="grid";const o=document.createElement("div"),h=e.cloneNode();h.className="curve",o.append(h),e.parentNode.insertBefore(o,e),e.parentNode.insertBefore(r,o),this.canvasContainer=o,this.config.handlerSize=t.handlerSize||HANDLE_SIZE,this.config.precision=null!==(s=t.precision)&&void 0!==s?s:2,this.config.showPostWrapMode=null===(i=t.showPostWrapMode)||void 0===i||i,this.config.showPreWrapMode=null===(n=t.showPreWrapMode)||void 0===n||n,this.config.spacingFrame=t.spacingFrame||4,this.config.sample=t.sample||1,this.grid=new grid_1.Grid(r,t.gridConfig||{}),this.curve=new hermite_1.Hermite(h,this.grid,{sample:t.sample||this.config.sample||1}),this.curvePools.push(this.curve);const a=document.createElement("div");a.className="scale-ctrl";const c={main:a,top:document.createElement("div"),bottom:document.createElement("div"),right:document.createElement("div"),left:document.createElement("div")};["top","bottom","right","left"].forEach(e=>{c[e].setAttribute("name",e),c.main.append(c[e])}),this.scaleCtrl=c,this.canvas.after(this.scaleCtrl.main);const l=document.createElement("div");this.canvas.after(l),l.className="mask",l.style.display="none",l.innerHTML=editorBoxTemplate,this.editBox={main:l,x:l.firstElementChild.firstElementChild.lastElementChild,y:l.firstElementChild.lastElementChild.lastElementChild,box:l.firstElementChild},this.editBox.x.setAttribute("min",String(this.grid.axisXConfig.minValue||0)),this.editBox.x.setAttribute("max",String(this.grid.axisXConfig.maxValue||0)),this.editBox.y.setAttribute("min",String(this.grid.axisYConfig.minValue||0)),this.editBox.y.setAttribute("max",String(this.grid.axisYConfig.maxValue||0)),this.emitChange=lodash.throttle(()=>{this.emit("change")},60),this.emitConfirm=lodash.throttle(()=>{this.emit("confirm")},60),this.registerHandler()}static drawLine(e,t,s){s.beginPath(),s.moveTo(e.x,e.y),s.lineTo(t.x,t.y),s.closePath(),s.stroke()}static drawArc(e,t,s){s.beginPath(),s.moveTo(e.x,e.y),s.arc(e.x,e.y,t,0,2*Math.PI),s.closePath(),s.stroke(),s.fill()}get currentSelectKeys(){return this.selectedKeyInfos&&this.selectedKeyInfos[0]&&this.selectedKeyInfos[0].keys}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.grid.canvas.width=e,this.grid.canvas.height=t,this.curvePools.forEach(s=>{s.canvas.width=e,s.canvas.height=t,s.keyframes.forEach(e=>{e.canvas=this.grid.valueToPixel(e.point)})})}resetConfig(e){var t,s,i;this.config.handlerSize=e.handlerSize||HANDLE_SIZE,this.config.showPostWrapMode=null===(t=e.showPostWrapMode)||void 0===t||t,this.config.showPreWrapMode=null===(s=e.showPreWrapMode)||void 0===s||s,this.config.precision=null!==(i=e.precision)&&void 0!==i?i:2,this.config.spacingFrame=e.spacingFrame||4,this.canvasContainer.innerHTML="",this.curvePools=[],this.grid=new grid_1.Grid(this.grid.canvas,e.gridConfig||{}),this.editBox.x.setAttribute("min",String(this.grid.axisXConfig.minValue||0)),this.editBox.x.setAttribute("max",String(this.grid.axisXConfig.maxValue||0)),this.editBox.y.setAttribute("min",String(this.grid.axisYConfig.minValue||0)),this.editBox.y.setAttribute("max",String(this.grid.axisYConfig.maxValue||0)),this.curve=new hermite_1.Hermite(this.curve.canvas,this.grid,{sample:e.sample||this.config.sample||1}),this.curvePools=[this.curve]}updateSample(e){this.curvePools.length&&(this.config.sample=e,this.curvePools.forEach(t=>{t.config.sample=e,t.paint(t.keyframes)}))}setGridFormat(e,t){this.grid[`${t}Format`]=e}getCurrentCurveInfo(){const e={};return Object.keys(this.editCurveInfo).forEach(t=>{const s=this.editCurveInfo[t];e[t]={keys:s.curve.keyframes,preWrapMode:s.curve.config.preWrapMode,postWrapMode:s.curve.config.postWrapMode}}),{curveInfos:e,wrapMode:this.config.wrapMode}}paint(e){this.clearAll(),this.grid.render(),e?(this._rawCurveInfo=e.curveInfos,Object.keys(e.curveInfos).length&&(this.initCurveInfo(e.curveInfos,e.wrapMode,e.duration),this.changeEditCurve(this.curveKeyQueue.includes(this.currentCurveKey)?this.currentCurveKey:this.curveKeyQueue[0]),this.checkActiveInfo(),this.paintCtrlPoint())):this.clearData()}clearData(){this.editKeyInfo=null,this.currentCurveKey="",this._rawKeyFrames=[],this.ctrlKeys=[],this.curvePools.forEach(e=>e.paint([]))}initCurveInfo(e,t,s){this.editCurveInfo={},this.curveKeyQueue=Object.keys(e),this.curvePools.length&&this.curvePools.forEach(e=>{e.canvas.style.display="none"}),this.curveKeyQueue.forEach((i,n)=>{this.curvePools[n]||(this.curvePools[n]=this.createNewCurve());const r=e[i],o=this.curvePools[n];o.canvas.parentNode||this.canvasContainer.append(o.canvas),o.canvas.setAttribute("name",i),o.canvas.style.display="block",o.config.wrapMode=t,o.config.duration=s,o.config.preWrapMode=r.preWrapMode,o.config.postWrapMode=r.postWrapMode,o.config.strokeStyle=r.color||"red",o.config.strokeStyleAxu=`rgba(${Chroma(r.color||"red").rgb().toString()}, 0.3`,o.clear(),o.paint(r.keys);const h=this.transToCtrlKey(o.keyframes,this._rawCurveInfo[i].keys);this.editCurveInfo[i]={curve:o,ctrlKeys:h,key:i}})}createNewCurve(){const e=this.curvePools[0].canvas.cloneNode();return this.canvasContainer.append(e),new hermite_1.Hermite(e,this.grid,this.curvePools[0].config)}checkActiveInfo(){if(this.selectedKeyInfos){const e=[];this.selectedKeyInfos.forEach(t=>{if(!this.editCurveInfo[t.key])return;const s=[],i=this.editCurveInfo[t.key].ctrlKeys;for(const e of t.keys){const t=i.find(t=>this.grid.xFormat(t.key.point.x)===this.grid.xFormat(e.key.point.x));t&&s.push(t)}s.length&&e.push({key:t.key,keys:s})}),this.selectedKeyInfos=e.length?e:null}}rePaint(){this.clear(),this.grid.render(),Object.keys(this.editCurveInfo).length&&(this.curveKeyQueue.forEach(e=>{const t=this.editCurveInfo[e];t.curve.keyframes.forEach(e=>{e.canvas=this.grid.valueToPixel(e.point)}),t.curve.keyframes.length&&(t.curve.rePaint(),t.ctrlKeys.forEach((e,s)=>{const i=t.curve.keyframes[s];Object.assign(e,this.calcCtrl(i,i))}))}),this.paintCtrlPoint())}updateCurveWrapMode(e,t){this.curve.config[e]=t,"preWrapMode"===e?this.curve.paintPreWrapMode():this.curve.paintPostWrapMode()}moveTimeLine(e,t){return this.grid.transferX&&this.grid.transferX(e),this.grid.transferY&&this.grid.transferY(t),{x:this.grid.transferX&&this.grid.transferX(e)||0,y:this.grid.transferY&&this.grid.transferY(t)||0}}moveTimeLineX(e){return this.grid.transferX(e)}moveTimeLineY(e){return this.grid.transferY(e)}scaleTimeLine(e,t,s){return t>0?this.scaleTimeLineY(t,s)&&this.scaleTimeLineX(e,s):this.scaleTimeLineX(e,s)}scaleTimeLineY(e,t){const{yAxisScale:s}=this.grid;return this.grid.yAxisScaleAt(e,utils_1.smoothScale(t,this.grid.yAxisScale)),s!==this.grid.yAxisScale}scaleTimeLineX(e,t){const{xAxisScale:s}=this.grid;return this.grid.xAxisScaleAt(e,utils_1.smoothScale(t,this.grid.xAxisScale)),s!==this.grid.xAxisScale}createNewKey(e){const t=this.grid.pixelToValue(e),s=this.curve.createNewKey(t);if(null===s)return void console.warn("添加点无效",t);const i=lodash.cloneDeep(this.curve.keyframes[s]);this.ctrlKeys.splice(s,0,this.calcCtrl(this.curve.keyframes[s],i)),this.selectedKeyInfos=[{keys:[this.ctrlKeys[s]],key:this.currentCurveKey}],this.currentKeyIndex=s,this.refreshRender(),this.emitOperate("create-keys",this.selectedKeyInfos),this.emitChange(),this.emitConfirm()}createKeyInCurveAt(e){const t=this.curve.createKeyInCurveAt(e);if(null===t)return void console.warn("添加点无效",e);const s=lodash.cloneDeep(this.curve.keyframes[t]);this.ctrlKeys.splice(t,0,this.calcCtrl(this.curve.keyframes[t],s));const i=this.ctrlKeys[t];this.emitOperate("create-keys",[{key:this.currentCurveKey,keys:[i]}]),this.paintCtrlPoint(),this.drawCtrl(),this.emitChange(),this.emitConfirm()}transToCtrlKey(e,t){return e.map((e,s)=>this.calcCtrl(e,t[s]))}calcCtrl(e,t,s){let i,n;return 2===e.interpMode&&(n=this.calcCtrlPoint(e,e.inTangent||e.outTangent||0,"inTangent"),i=this.calcCtrlPoint(e,e.outTangent||e.inTangent||0,"outTangent")),{outCanvas:i,inCanvas:n,key:e,raw:lodash.cloneDeep(t)}}calcCtrlPoint(e,t,s){if([curve_base_1.TangentWeightMode.LEFT,curve_base_1.TangentWeightMode.BOTH].includes(e.tangentWeightMode)&&"inTangent"===s&&e.inCtrlPoint||[curve_base_1.TangentWeightMode.RIGHT,curve_base_1.TangentWeightMode.BOTH].includes(e.tangentWeightMode)&&"outTangent"===s&&e.outCtrlPoint)return Object.assign({type:s},"inTangent"===s?this.grid.valueToPixel(e.inCtrlPoint):this.grid.valueToPixel(e.outCtrlPoint));if("number"!=typeof t)throw new Error("k should be number.");const i=JSON.parse(JSON.stringify(e.canvas));t*=this.grid.yAxisScale/this.grid.xAxisScale/this.config.sample,i.y=this.canvas.height-i.y;const{handlerSize:n}=this.config;let r=0,o=0;return r=Math.sqrt(n*n/(1+t*t)),r="inTangent"===s?i.x-r:i.x+r,o=i.y-t*(i.x-r),{x:r,y:o=this.canvas.height-o,type:s}}delSelectedKeys(){if(this.selectedKeyInfos){for(const e of this.selectedKeyInfos){const t=this.editCurveInfo[e.key];e.keys.forEach(e=>{const s=t.ctrlKeys.findIndex(t=>t===e);t.curve.delKeyFrame(s),t.ctrlKeys.splice(s,1)})}this.emitOperate("remove-keys",this.selectedKeyInfos),this.emitChange(),this.emitConfirm(),this.selectedKeyInfos=null,this.currentKeyIndex=null,this.clear(),this.refreshRender(),this.paintCtrlPoint()}}flatSelectedKeys(){if(this.selectedKeyInfos){for(const e of this.selectedKeyInfos){const{curve:t,ctrlKeys:s}=this.editCurveInfo[e.key];e.keys.forEach(i=>{const n=s.findIndex(e=>e===i);t.updateTan(n,0,"inTangent"),t.updateTan(n,0,"outTangent"),t.changeInterpMode(n,2),s[n]=Object.assign(s[n],this.calcCtrl(s[n].key,this._rawCurveInfo[e.key].keys[n]))})}this.emitOperate("change-interp-mode",this.selectedKeyInfos),this.emitChange(),this.emitConfirm(),this.refreshRender()}}spacingSelectedKeys(){this.selectedKeyInfos&&(this.selectedKeyInfos.forEach(e=>{this.editCurveInfo[e.key].curve.spacingKeys(e.keys.map(e=>e.key),this.config.spacingFrame)}),this.emitOperate("move-keys",this.selectedKeyInfos),this.emitChange(),this.emitConfirm(),this.refreshRender())}delKeyFrame(e){this.curve.delKeyFrame(e),this.ctrlKeys.splice(e,1),this.clear(),this.refreshRender(),this.paintCtrlPoint()}refreshRender(){this.clear(),this.curveKeyQueue.forEach(e=>{this.editCurveInfo[e].curve.rePaint()}),this.resetCtrl("reset"),this.updateEditBoxPosition()}clear(){const{width:e,height:t}=this.canvas;this.ctx.clearRect(0,0,e,t),this.ctrlState.lightCurve=!1}clearAll(){this.clear(),this.curvePools.forEach(e=>e.clear()),this.grid.clear()}moveHandleCtrl(e,t,s){if(!this.ctrlKeys[this.currentKeyIndex])return;const i=this.ctrlKeys[this.currentKeyIndex];if("outTangent"===s&&e<=i.key.canvas.x||"inTangent"===s&&e>=i.key.canvas.x||t===i.key.canvas.y)return;if(!i.key.tangentWeightMode||i.key.tangentWeightMode===curve_base_1.TangentWeightMode.NONE||i.key.tangentWeightMode===curve_base_1.TangentWeightMode.RIGHT&&"inTangent"===s||i.key.tangentWeightMode===curve_base_1.TangentWeightMode.LEFT&&"outTangent"===s)return void this.updateTan(e,t,s);const n=this.ctrlKeys[this.currentKeyIndex-1],r=(n&&n.key.canvas.x||this.grid.valueToPixelX(0),this.ctrlKeys[this.currentKeyIndex+1]),o=(r&&r.key.canvas.x,this.grid.pixelToValue({x:e,y:t})),h=(o.y-i.key.point.y)/((o.x-i.key.point.x)/this.config.sample);this.curve.updateTangentWeight(this.currentKeyIndex,o,h,s)&&("inTangent"===s?i.inCanvas={x:e,y:t}:i.outCanvas={x:e,y:t},Object.assign(i,this.calcCtrl(i.key,this._rawKeyFrames[this.currentKeyIndex])),this.emitChange(),this.refreshRender())}updateKeyBrokenState(e){const t=this.currentSelectKeys[0];t.key.broken=e,e||t.key.inTangent!==t.key.outTangent&&(t.key.outTangent=t.key.inTangent,Object.assign(t,this.calcCtrl(t.key,t.raw)),this.refreshRender(),this.drawCtrl())}updateTan(e,t,s){const i=this.currentKeyIndex,{key:{canvas:n,point:r},raw:o}=this.ctrlKeys[this.currentKeyIndex];if("outTangent"===s&&e<=n.x||"inTangent"===s&&e>=n.x||t===n.y)return;const h=this.grid.pixelToValue({x:e,y:t});if(h.x===r.x)return;let a=(h.y-r.y)/((h.x-r.x)/this.config.sample);"outTangent"===s&&(a=(r.y-h.y)/((r.x-h.x)/this.config.sample)),a!==1/0&&(this.curve.updateTan(i,a,s),this.emitChange(),Object.assign(this.ctrlKeys[i],this.calcCtrl(this.curve.keyframes[i],o)),this.refreshRender())}moveSelectedKeys(e,t){if(!this.selectedKeyInfos||!this.mouseDownPoint)return!1;const{offsetX:s,offsetY:i,startInfo:n}=this.mouseDownPoint,r=e-s-(this.currentSelectKeys[0].key.canvas.x-n.startKey.x),o=t-i-(this.currentSelectKeys[0].key.canvas.y-n.startKey.y);return this.selectedKeyInfos.forEach(e=>{this.editCurveInfo[e.key].curve.moveKeys(e.keys.map(e=>e.key),{x:r,y:o})}),this.mouseDownPoint.keys=this.selectedKeyInfos,this.calcActiveBox(),this.refreshRender(),!0}moveKey(e,t,s){const i=this.curve.moveKey(e,t,s);if(-1===i)return!1;this.changeType="move-keys";const n=Object.assign(this.ctrlKeys[s],this.calcCtrl(this.curve.keyframes[i],this.ctrlKeys[s].raw||this._rawKeyFrames[s]));return this.ctrlKeys.splice(s,1),this.ctrlKeys.splice(i,0,n),this.selectedKeyInfos=[{keys:[this.ctrlKeys[i]],key:this.currentCurveKey}],this.mouseDownPoint.keys=this.selectedKeyInfos,this.currentKeyIndex=i,this.refreshRender(),!0}registerHandler(){this.eventHandlers||(this.eventHandlers={mousemove:this.onMouseMove.bind(this),mouseup:this.onMouseUp.bind(this),mousedown:this.onMouseDown.bind(this),wheel:this.onWheel.bind(this),scaleMouseDown:this.onScaleMouseDown.bind(this),editKeyConfirm:this.onEditKeyConfirm.bind(this)},this.canvas.addEventListener("mousemove",this.eventHandlers.mousemove),document.addEventListener("mouseup",this.eventHandlers.mouseup),this.canvas.addEventListener("mousedown",this.eventHandlers.mousedown),this.canvas.addEventListener("wheel",this.eventHandlers.wheel),this.scaleCtrl.main.addEventListener("mousedown",this.eventHandlers.scaleMouseDown),this.editBox.box.addEventListener("confirm",this.eventHandlers.editKeyConfirm))}unregisterHandler(){this.eventHandlers&&(this.canvas.removeEventListener("mousemove",this.eventHandlers.mousemove),document.removeEventListener("mouseup",this.eventHandlers.mouseup),this.canvas.removeEventListener("mousedown",this.eventHandlers.mousedown),this.canvas.removeEventListener("wheel",this.eventHandlers.wheel),this.scaleCtrl.main.removeEventListener("mousedown",this.eventHandlers.scaleMouseDown),this.scaleCtrl.main.removeEventListener("mousemove",this.eventHandlers.scaleMouseMove),this.editBox.box.removeEventListener("confirm",this.eventHandlers.editKeyConfirm),this.eventHandlers=null)}onScaleMouseDown(e){const t=e.target;e.stopPropagation(),e.preventDefault();const s=t.getAttribute("name")+"Scale",{offsetX:i,offsetY:n}=e;this.mouseDownPoint={offsetX:i,offsetY:n,button:0===e.button?"left":"right",dbClick:!!(this.lastMousedown&&Date.now()-this.lastMousedown<300),type:s,startInfo:this.activeBoxInfo.box}}onScaleMouseMove(e){if(!(this.mouseDownPoint&&this.mouseDownPoint.startInfo&&this.activeBoxInfo&&this.activeBoxInfo.box))return;const{w:t,h:s,x:i,y:n}=this.mouseDownPoint.startInfo,{offsetX:r,offsetY:o}=e,h={scale:1,changeValue:"x",base:0},a=this.mouseDownPoint.type;switch(this.mouseDownPoint.type){case"topScale":this.activeBoxInfo.box.y=o,this.activeBoxInfo.box.h+=n-o,h.base=n+s,h.scale=this.activeBoxInfo.box.h/s;break;case"bottomScale":this.activeBoxInfo.box.h=o-n,h.scale=this.activeBoxInfo.box.h/s,h.base=n;break;case"rightScale":this.activeBoxInfo.box.w=r-i,h.scale=this.activeBoxInfo.box.w/t,h.base=i;break;case"leftScale":this.activeBoxInfo.box.x=r,this.activeBoxInfo.box.w+=i-r,h.scale=this.activeBoxInfo.box.w/t,h.base=i+t}1!==h.scale&&0!==h.scale&&(["topScale","bottomScale"].includes(a)&&(h.changeValue="y"),this.selectedKeyInfos.forEach(e=>{this.editCurveInfo[e.key].curve.scaleKeys(e.keys.map(e=>e.key),h)}),this.changeType="scale-keys",this.mouseDownPoint.keys=this.selectedKeyInfos,this.paintScaleCtrl(),this.refreshRender())}onEditKeyConfirm(e){if(!this.editKeyInfo)return;const t=e.target.getAttribute("name");this.editKeyInfo[t]=e.target.value}applyEditKeyInfo(){const e=this.ctrlKeys[this.currentKeyIndex].key.point;if(e.x===this.editKeyInfo.x&&e.y===this.editKeyInfo.y)return!1;const t=this.curve.editKey(this.currentKeyIndex,this.editKeyInfo);if(-1===t)return!1;const s=Object.assign(this.ctrlKeys[this.currentKeyIndex],this.calcCtrl(this.curve.keyframes[t],this.ctrlKeys[this.currentKeyIndex].raw||this._rawCurveInfo[this.currentCurveKey].keys[this.currentKeyIndex]));return this.ctrlKeys.splice(this.currentKeyIndex,1),this.ctrlKeys.splice(t,0,s),this.selectedKeyInfos=[{key:this.currentCurveKey,keys:[this.ctrlKeys[t]]}],this.currentKeyIndex=t,this.refreshRender(),!0}onWheel(e){e.stopPropagation(),e.preventDefault();let t=!0;const s="darwin"===process.platform,i=s?e.metaKey:e.ctrlKey,n=e.shiftKey&&s?e.deltaX:e.deltaY;(t=e.shiftKey&&i?this.scaleTimeLineX(e.offsetX,-n):e.altKey&&i?this.scaleTimeLineY(e.offsetY,-n):e.shiftKey?!!this.moveTimeLineX(n):e.altKey?!!this.moveTimeLineY(n):Math.abs(e.deltaX)>Math.abs(e.deltaY)?!!this.moveTimeLineX(e.deltaY):this.scaleTimeLine(e.offsetX,e.offsetY,-e.deltaY))&&(this.rePaint(),this.emit("transform"))}onMouseDown(e){e.stopPropagation(),this.canvas.setAttribute("focused","");const{r:t}=this.config,{offsetX:s,offsetY:i}=e;if(this.mouseDownPoint={offsetX:s,offsetY:i,button:0===e.button?"left":"right",dbClick:!!(this.lastMousedown&&Date.now()-this.lastMousedown<300),type:"empty"},this.lastMousedown=Date.now(),this.selectedKeyInfos&&this.activeBoxInfo&&this.activeBoxInfo.box){const{x:e,y:t,w:n,h:r}=this.activeBoxInfo.box;if(s>e&&s<e+n&&i>t&&i<t+r)return this.mouseDownPoint.type="activeBox",this.mouseDownPoint.keys=this.selectedKeyInfos,void(this.mouseDownPoint.startInfo={startKey:JSON.parse(JSON.stringify(this.currentSelectKeys[0].key.canvas))})}if(this.ctrlState.showCtrlHandle&&this.ctrlKeys[this.currentKeyIndex]){const e=this.ctrlKeys[this.currentKeyIndex];for(const n of["outCanvas","inCanvas"]){const r=e[n];if(!r)continue;const{x:o,y:h}=r;if(Math.abs(s-o)<CLICK_RANGE+t&&Math.abs(i-h)<CLICK_RANGE+t)return this.mouseDownPoint.keys=this.selectedKeyInfos,void(this.mouseDownPoint.type="outCanvas"===n?"outTangent":"inTangent")}}const n=[],r=[-1,-1];for(let e=0;e<this.curveKeyQueue.length;e++){const t=this.editCurveInfo[this.curveKeyQueue[e]];let o=t.curve.isPointInCurve({x:s,y:i},2*this.config.r);const h=t.curve.checkPointInKeys({x:s,y:i},2*this.config.r);if(o=o||-1!==h){n.push(t.key),r[0]=n.length-1,r[1]=h;break}}if(n.length){if(this.mouseDownPoint.type="curve",this.changeEditCurve(r[0]>-1?n[r[0]]:n[0]),this.emitOperate("select-curve",[{key:this.currentCurveKey,keys:[this.ctrlKeys[0]]}]),2!==e.button&&(this.resetCtrl("reset"),this.lightCurve(),this.canvas.style.cursor="ns-resize"),r[1]>-1){this.currentKeyIndex=r[1];const t=n[r[0]],s=this.editCurveInfo[t].ctrlKeys[r[1]];if(this.selectedKeyInfos=[{key:t,keys:[s]}],this.mouseDownPoint.type="key",this.mouseDownPoint.keys=this.selectedKeyInfos,2===e.button)return;return this.canvas.style.cursor="move",this.emitOperate(this.mouseDownPoint.dbClick?"db-select":"select",this.selectedKeyInfos),void this.showCtrl(s,this.currentKeyIndex)}this.mouseDownPoint.startInfo={startKey:JSON.parse(JSON.stringify(this.curve.keyframes[0]))}}this.currentKeyIndex=null}selectKeys(e){if(!e)return this.selectedKeyInfos=null,void this.refreshRender();const t=[];e.forEach(e=>{if(!this.editCurveInfo[e.key])return;const s=this.editCurveInfo[e.key].ctrlKeys.filter(t=>e.frames.includes(t.key.point.x));s.length&&t.push({key:e.key,keys:s})}),this.selectedKeyInfos=t,this.refreshRender()}changeEditCurve(e){if(!this.editCurveInfo[e])return!1;const t=this.editCurveInfo[e];return t.curve.canvas.style.zIndex="1",this.curve=t.curve,this.ctrlKeys=t.ctrlKeys,this._rawKeyFrames=this._rawCurveInfo[e].keys,this.currentCurveKey===e||(this.currentCurveKey&&this.editCurveInfo[this.currentCurveKey]&&(this.editCurveInfo[this.currentCurveKey].curve.canvas.style.zIndex="0"),this.currentCurveKey=e,this.selectedKeyInfos=null,this.activeBoxInfo=null,this.currentKeyIndex=null,this.ctrlState={showAuxin:!1,showCtrlHandle:!1,lightCurve:!1},this.changeType="",!0)}getCopyKeys(){const e=Editor.Clipboard.read("curve-editor.keys");return Array.isArray(e)?e:[]}pasteCopyKeys(e,t){const s=this.getCopyKeys();if(!s.length)return;let i=0,n=0;this.activeBoxInfo.box&&this.activeBoxInfo.box.w&&(i=e-this.activeBoxInfo.box.x,t&&(n=t-this.activeBoxInfo.box.y));const r=[];let o=this.grid.pixelToValueX(e);this.grid.xFormat&&(o=Number(this.grid.xFormat(o))),s.forEach(s=>{const o=this.editCurveInfo[s.key];if(!o)return;const h=s.keys[0].key.canvas||this.grid.valueToPixel(s.keys[0].key.point);i=i||e-h.x,t&&(n=n||t-h.y),h.x+=i,h.y+=n;const a=this.grid.pixelToValue(h);o.curve.pasteKeys(s.keys.map(e=>e.key),a.x,a.y).forEach((e,t)=>{const i=o.ctrlKeys.findIndex(t=>this.grid.xFormat(t.key.point.x)===this.grid.xFormat(e.point.x)),n=this.calcCtrl(e,s.keys[t].key);if(r.push({keys:[n],key:s.key}),-1!==i)return void o.ctrlKeys.splice(i,1,n);const h=o.curve.keyframes.findIndex(t=>t.point.x===e.point.x);o.ctrlKeys.splice(h,0,n)})}),this.selectedKeyInfos=r.length?r:null,this.refreshRender(),this.emitOperate("create-keys",this.selectedKeyInfos,o),this.emitChange(),this.emitConfirm()}copySelectedKeys(){return!!this.selectedKeyInfos&&(Editor.Clipboard.write("curve-editor.keys",this.selectedKeyInfos),this.emitOperate("copy",this.selectedKeyInfos),!0)}onMouseMove(e){if(!this.mouseDownPoint||this.readonly)return;e.stopPropagation(),e.preventDefault();const{offsetX:t,offsetY:s,movementY:i,movementX:n,x:r,y:o}=e,{offsetX:h,offsetY:a,type:c,button:l}=this.mouseDownPoint;if(!(Math.abs(t-h)<=1||Math.abs(s-a)<=1)){if(c.endsWith("Scale"))return this.onScaleMouseMove(e),void this.emitChange();if("activeBox"===c)return this.moveSelectedKeys(t,s),this.changeType="move-keys",void this.emitChange();if("inTangent"===c||"outTangent"===c)return this.changeType="tangent",this.moveHandleCtrl(t,s,c),this.mouseDownPoint.keys=this.selectedKeyInfos,void this.emitChange();if("key"===c&&"number"==typeof this.currentKeyIndex)return this.moveKey(t,s,this.currentKeyIndex),this.changeType="move-keys",void this.emitChange();if("curve"===c&&this.mouseDownPoint.startInfo){const{canvas:e}=this.mouseDownPoint.startInfo.startKey,{canvas:t}=this.curve.keyframes[0],i=s-a+e.y-t.y;if(!this.curve.moveAllY(i))return;return this.mouseDownPoint.keys=[{keys:this.ctrlKeys,key:this.currentCurveKey}],this.changeType="move-curve",this.emitChange(),this.rePaint(),void this.lightCurve()}if(["timeline","empty"].includes(c)&&"right"===l)return this.mouseDownPoint.type="timeline",e.target.style.cursor="-webkit-grabbing",void requestAnimationFrame(()=>{const e=this.grid.transfer(n,i);(e.x||e.y)&&(Object.values(this.editCurveInfo).forEach(e=>{e.curve.keyframes.forEach(e=>{e.canvas=this.grid.valueToPixel(e.point)})}),this.rePaint()),this.emit("transform")});if("empty"===c&&"left"===l){const e=Math.abs(t-h),i=Math.abs(s-a),n=t<h?t:h,r=s<a?s:a;this.selectedKeyInfos=[],this.curveKeyQueue.forEach(t=>{const s=[],o=this.editCurveInfo[t];for(const t of o.ctrlKeys)t.key.canvas.x>n&&t.key.canvas.x<n+e&&t.key.canvas.y>r&&t.key.canvas.y<r+i&&s.push(t);s.length&&this.selectedKeyInfos.push({key:t,keys:s})}),this.activeBoxInfo={selectBox:{x:n,y:r,w:e,h:i}},this.clear(),this.paintAssistBox(this.activeBoxInfo.selectBox),this.paintCtrlPoint()}}}onMouseUp(e){this.canvas.style.cursor="default";const t=this.mouseDownPoint&&this.mouseDownPoint.type;if(!e.path.find(e=>e===this.editBox.box)&&(this.editBox.main.style.display="none",this.editKeyInfo&&this.selectedKeyInfos&&this.selectedKeyInfos.length&&this.currentKeyIndex)){this.applyEditKeyInfo()&&this.emitOperate("move-keys",this.selectedKeyInfos),this.emitConfirm(),this.editKeyInfo=null}if(this.readonly)this.mouseDownPoint=null;else{if(this.mouseDownPoint&&"right"===this.mouseDownPoint.button&&"timeline"!==t&&this.onPopMenu({x:e.pageX,y:e.pageY}),this.activeBoxInfo&&this.activeBoxInfo.selectBox&&this.selectedKeyInfos)return this.activeBoxInfo.selectBox&&this.emitOperate("select",this.selectedKeyInfos),this.activeBoxInfo.selectBox=void 0,this.rePaint(),void(this.mouseDownPoint=null);if(this.changeType&&(this.mouseDownPoint.keys&&this.emitOperate(this.changeType,this.mouseDownPoint.keys),this.emitConfirm(),this.changeType=""),"empty"===t)return this.mouseDownPoint=null,this.selectedKeyInfos=null,this.emitOperate("unselect"),void this.resetCtrl("reset");this.mouseDownPoint=null}}onPopMenu(e){const{type:t,offsetX:s,offsetY:i}=this.mouseDownPoint,n=[];let r=this.grid.pixelToValueX(s);this.grid.xFormat&&(r=Number(this.grid.xFormat(r)));const o=this.ctrlKeys[this.currentKeyIndex];let h=String(o?o.key.point.x:r);this.currentSelectKeys&&this.currentSelectKeys.length>1&&(h=this.currentSelectKeys.map(e=>this.grid.xFormat(e.key.point.x)).toString()),this.getCopyKeys().length&&n.push({label:Editor.I18n.t("ui-kit.curve_editor.paste"),accelerator:"CmdOrCtrl+V",click:()=>{this.pasteCopyKeys(s,i)}}),["curve"].includes(t)?n.push({label:Editor.I18n.t("ui-kit.curve_editor.createKeyInCurve"),click:()=>{this.createKeyInCurveAt(r)}}):["key","activeBox"].includes(t)&&this.selectedKeyInfos&&this.selectedKeyInfos.length?(n.push({label:Editor.I18n.t("ui-kit.curve_editor.delete"),accelerator:"Delete",click:()=>{this.delSelectedKeys()}}),n.push({label:Editor.I18n.t("ui-kit.curve_editor.copy"),accelerator:"CmdOrCtrl+C",click:()=>{this.copySelectedKeys()}}),1===this.currentSelectKeys.length&&n.push({label:Editor.I18n.t("ui-kit.curve_editor.edit"),click:()=>{const e=this.currentSelectKeys[0].key;this.editKeyInfo={x:e.point.x,y:e.point.y},this.updateEditBoxPosition(),this.editBox.main.style.display="block"}}),this.currentSelectKeys.length>1&&(n.push({label:Editor.I18n.t("ui-kit.curve_editor.spacingKey")+` (${this.config.spacingFrame})`,click:()=>{this.spacingSelectedKeys()}}),n.push({type:"separator"})),n.push({label:Editor.I18n.t("ui-kit.curve_editor.flat"),click:()=>{this.flatSelectedKeys()}}),n.push({type:"separator"}),n.push({label:Editor.I18n.t(`${I18N_HEADER}.realCurve.RealInterpMode.label`)||"InterpMode",subLabel:Editor.I18n.t(`${I18N_HEADER}.realCurve.RealInterpMode.tip`)||"InterpMode",submenu:this.showInterpMethodMenu()}),n.push({label:Editor.I18n.t(`${I18N_HEADER}.realCurve.TangentWeightMode.label`)||"TangentWeightMode",subLabel:Editor.I18n.t(`${I18N_HEADER}.realCurve.TangentWeightMode.tip`)||"TangentWeightMode",submenu:this.showTangentWeightMenu()})):1===this.curveKeyQueue.length&&n.push({label:Editor.I18n.t("ui-kit.curve_editor.createKey"),click:()=>{this.createNewKey({x:s,y:i})}}),n.push({type:"separator"}),n.push({label:`Keys: ${h}`,enabled:!1}),require("electron").remote.Menu.buildFromTemplate(n).popup({x:e.x,y:e.y})}showTangentWeightMenu(){let e=this.currentSelectKeys[0].key.tangentWeightMode;return this.selectedKeyInfos.length>1&&(e=null),CurveCtrl.tangentWeightModeList.map(t=>({label:Editor.I18n.t(`${I18N_HEADER}.realCurve.TangentWeightMode.${t.name}.label`)||t.name,subLabel:Editor.I18n.t(`${I18N_HEADER}.realCurve.TangentWeightMode.${t.name}.tip`)||t.name,type:"checkbox",click:()=>{this.changeTangentWeight(t.value)},checked:e===t.value}))}showInterpMethodMenu(){let e=this.selectedKeyInfos[0].keys[0].key.interpMode;return this.selectedKeyInfos.length>1&&(e=null),CurveCtrl.interpModeList.map(t=>({label:Editor.I18n.t(`${I18N_HEADER}.realCurve.RealInterpMode.${t.name}.label`)||t.name,subLabel:Editor.I18n.t(`${I18N_HEADER}.realCurve.RealInterpMode.${t.name}.tip`)||t.name,type:"checkbox",click:()=>{this.changeInterpMode(t.value)},checked:e===t.value}))}changeTangentWeight(e){this.currentSelectKeys&&(this.currentSelectKeys.forEach(t=>{const s=this.ctrlKeys.findIndex(e=>e===t);this.curve.changeTangentWeight(s,e),this.ctrlKeys[s]=Object.assign(t,this.calcCtrl(this.ctrlKeys[s].key,this.curve.keyframes[s]))}),this.refreshRender(),this.emitOperate("change-tangent-weight",this.selectedKeyInfos),this.emitChange(),this.emitConfirm())}resetScale(){this.grid.resetScale(),this.rePaint(),this.emit("transform")}setDisplayRange(e,t){this.grid.setDisplayRange(e,t),this.grid.clear(),this.rePaint(),this.emit("transform")}changeInterpMode(e){this.selectedKeyInfos&&(this.currentSelectKeys.forEach(t=>{const s=this.ctrlKeys.findIndex(e=>e===t);this.curve.changeInterpMode(s,e),this.ctrlKeys[s]=Object.assign(t,this.calcCtrl(this.ctrlKeys[s].key,this.curve.keyframes[s]))}),this.refreshRender(),this.emitOperate("change-interp-mode",this.selectedKeyInfos),this.emitChange(),this.emitConfirm())}showCurveWrapMode(e){const t=this.curve.config[e];return CurveCtrl.extrapModeList.map(s=>({label:Editor.I18n.t(`${I18N_HEADER}.realCurve.ExtrapMode.${s.name}.label`)||s.name,subLabel:Editor.I18n.t(`${I18N_HEADER}.realCurve.ExtrapMode.${s.name}.tip`)||s.name,type:"checkbox",click:()=>{this.changeCurveWrapMode(e,s.value)},checked:t===s.value}))}changeCurveWrapMode(e,t){}showPoint(e){this.ctrlState.showCtrlHandle=!0,this.showKeyValueInfo(e)}paintAssistBox(e){const{x:t,y:s,w:i,h:n}=e;this.ctx.save(),this.ctx.strokeStyle=this.colors.selectBoxLine,this.ctx.setLineDash([4,5]),this.ctx.lineWidth=1,this.ctx.strokeRect(t,s,i,n),this.ctx.restore()}lightCurve(){this.ctrlState.lightCurve||(this.ctx.strokeStyle=this.colors.light,this.curve.paintWithCache(this.ctx),this.ctrlState.lightCurve=!0)}showCtrl(e,t){"number"==typeof this.currentKeyIndex&&(this.resetCtrl(),this.lightCurve()),this.drawCtrl(),this.ctx.strokeStyle=this.colors.defaultLine,this.ctx.fillStyle=this.curve.config.strokeStyle,this.paintSingleCtrlPoint(this.currentSelectKeys[0])}drawCtrl(){if(!this.ctrlKeys[this.currentKeyIndex])return;const e=this.ctrlKeys[this.currentKeyIndex],t=this.ctx;this.ctrlState.showCtrlHandle=!0;const{key:{canvas:s}}=e;t.save(),this.selectedKeyInfos=[{key:this.currentCurveKey,keys:[e]}],this.paintSelectedKeys(),this.showKeyCtrlHand(e),t.restore(),this.showPoint(s)}paintSelectedKeys(){const e=this.selectedKeyInfos;e&&e.length?this.mouseDownPoint&&this.mouseDownPoint.startInfo?this.paintActiveCtrlBox():(this.calcActiveBox(),this.paintActiveCtrlBox(),e.forEach(e=>{e.keys.forEach(e=>{this.ctx.fillStyle="gold",this.paintSingleCtrlPoint(e)})}),this.ctrlKeys[this.currentKeyIndex]&&this.showPoint(this.ctrlKeys[this.currentKeyIndex].key.canvas)):this.scaleCtrl.main.style.visibility="hidden"}calcActiveBox(){const e=[];if(this.selectedKeyInfos.forEach(t=>{e.push(...t.keys)}),!e||!e.length)return void(this.scaleCtrl.main.style.visibility="hidden");this.activeBoxInfo=this.activeBoxInfo||{};const t=Array.from(e);if(1===t.length){const e=t[0].key.canvas;this.activeBoxInfo.box={x:e.x,y:e.y,w:0,h:0},this.ctrlKeys[this.currentKeyIndex]&&this.showKeyCtrlHand(this.ctrlKeys[this.currentKeyIndex])}else{const t=[],s=[];for(const i of e)t.push(i.key.canvas.x),s.push(i.key.canvas.y);t.sort((e,t)=>e-t),s.sort((e,t)=>e-t);const i=Math.min(...t),n=Math.min(...s),r={x:Math.round(i),y:Math.round(n),w:Math.round(Math.max(...t)-i),h:Math.round(Math.max(...s)-n)};this.activeBoxInfo.box=r,this.paintScaleCtrl(e)}}paintScaleCtrl(e){if(!this.activeBoxInfo||!this.activeBoxInfo.box||!this.selectedKeyInfos)return void(this.scaleCtrl.main.style.visibility="hidden");if(e||(e=e||[],this.selectedKeyInfos.forEach(t=>{e.push(...t.keys)})),e.length<1)return void(this.scaleCtrl.main.style.visibility="hidden");const{r:t}=this.config,s=this.activeBoxInfo.box;this.scaleCtrl.main.style.width=`${s.w+2*t}px`,this.scaleCtrl.main.style.height=`${s.h+2*t}px`,this.scaleCtrl.main.style.top=`${s.y-t}px`,this.scaleCtrl.main.style.left=`${s.x-t}px`,this.scaleCtrl.main.style.visibility="visible"}updateEditBoxPosition(){if(!this.editKeyInfo||!this.currentSelectKeys)return;const e=this.currentSelectKeys[0].key;this.editBox.x.value=e.point.x,this.editBox.y.value=e.point.y;const t=Editor.Utils.Math.clamp(e.canvas.y,10,this.canvas.height-70),s=Editor.Utils.Math.clamp(e.canvas.x,10,this.canvas.width-110);this.editBox.box.style.top=t+"px",this.editBox.box.style.left=s+"px"}paintActiveCtrlBox(){if(!this.activeBoxInfo||!this.activeBoxInfo.box)return;const e=this.ctx;e.save();const{x:t,y:s,w:i,h:n}=this.activeBoxInfo.box,{r:r}=this.config;e.fillStyle=this.colors.selectBoxFill,e.fillRect(t-r,s-r,i+2*r,n+2*r),e.restore()}showKeyCtrlHand(e){const t=this.ctx;t.save();const{key:{canvas:s},inCanvas:i,outCanvas:n}=e,{r:r}=this.config;t.fillStyle=this.colors.handler,t.strokeStyle=this.colors.defaultLine,i&&2===e.key.interpMode&&(CurveCtrl.drawLine(s,i,this.ctx),CurveCtrl.drawArc(i,r,this.ctx)),n&&2===e.key.interpMode&&(CurveCtrl.drawLine(s,n,this.ctx),CurveCtrl.drawArc(n,r,this.ctx)),t.restore()}showKeyValueInfo(e){const{x:t,y:s}=e;this.ctx.save(),this.ctx.strokeStyle=this.colors.selectBoxLine,this.ctx.setLineDash([4,8]),this.ctx.moveTo(t,this.canvas.height-this.grid.axisMargin),this.ctx.lineTo(t,s),this.ctx.lineTo(this.grid.axisMargin,s),this.ctx.stroke();const i=this.curve.config.strokeStyle;this.grid.ctx.clearRect(0,s-10,15,15),this.ctx.fillStyle=i,this.ctx.fillText(String(this.grid.yFormat(this.grid.pixelToValueY(s))),0,s),this.ctx.fillText(String(this.grid.xFormat(this.grid.pixelToValueX(t))),t-this.grid.axisMargin/2,this.canvas.height-this.grid.axisMargin/2),this.ctx.restore()}resetCtrl(e){(this.ctrlState.showCtrlHandle||this.ctrlState.showAuxin||e)&&(this.ctrlState.showAuxin=!1,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.clear(),this.paintCtrlPoint(),this.paintSelectedKeys())}paintCtrlPoint(){this.ctx.strokeStyle=this.colors.defaultLine,Object.values(this.editCurveInfo).forEach(e=>{this.ctx.fillStyle=e.curve.config.strokeStyle;const t=e.ctrlKeys;for(const e of t)this.paintSingleCtrlPoint(e)}),this.paintSelectedKeys()}paintSingleCtrlPoint(e){const{r:t}=this.config;this.ctx.beginPath();const{x:s,y:i}=e.key.canvas;this.ctx.moveTo(s,i+t),this.ctx.lineTo(s+t,i),this.ctx.lineTo(s,i-t),this.ctx.lineTo(s-t,i),this.ctx.lineTo(s,i+t),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill()}paintSettingIcon(){const e=this.editCurveInfo[this.currentCurveKey].ctrlKeys;e&&e[0]&&e[e.length-1]&&(this.settingsIconInfo={pre:utils_1.createPoint(-6,-6,e[0].key.canvas),post:utils_1.createPoint(6,-6,e[e.length-1].key.canvas)},this.ctx.save(),this.paintIcon(ICON_U16.settings,this.settingsIconInfo.pre),this.paintIcon(ICON_U16.settings,this.settingsIconInfo.post),this.ctx.restore())}paintIcon(u16,position){const icon=eval(('("'+u16).replace("&#x","\\u").replace(";","")+'")');this.ctx.font=`${ICON_FONT_SIZE}px ${ICON_FONT_NAME}`,this.ctx.fillText(icon,position.x,position.y)}emitOperate(e,t,...s){const i=[];t&&JSON.parse(JSON.stringify(t)).forEach(e=>{const t=e.keys;i.push(Object.assign(e,{keys:t}))}),this.emit("operate",e,i,...s)}}exports.CurveCtrl=CurveCtrl,CurveCtrl.interpModeList=utils_1.getEnumList({LINEAR:0,CONSTANT:1,CUBIC:2}),CurveCtrl.tangentWeightModeList=utils_1.getEnumList({NONE:curve_base_1.TangentWeightMode.NONE,LEFT:curve_base_1.TangentWeightMode.LEFT,RIGHT:curve_base_1.TangentWeightMode.RIGHT,BOTH:curve_base_1.TangentWeightMode.BOTH}),CurveCtrl.extrapModeList=utils_1.getEnumList({LINEAR:0,CLAMP:1,LOOP:2,PING_PONG:3});