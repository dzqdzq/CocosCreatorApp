"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CurveCtrl=void 0;const events_1=require("events"),grid_1=require("./grid"),hermite_1=require("./hermite"),utils_1=require("./utils"),PIXEL_RANGE=20,UINT8_COLOR_DEFAULT=Array(4*PIXEL_RANGE*PIXEL_RANGE).fill(0).toString(),DEFAULT_CTRL_COLOR="rgba(255, 0, 0, 0.1)",AUX_LINE_COLOR="rgba(255, 0, 0, 0.3)",CLICK_RANGE=5,lodash=require("lodash");class CurveCtrl extends events_1.EventEmitter{constructor(t,e){var i,s,n,r,o,a;super(),this.readonly=!1,this.ctrlKeys=[],this.multi=1,this.ctrlConfig={handlerSize:20,r:3,strokeStyle:DEFAULT_CTRL_COLOR,fillColor:"gold",focusColor:"#f5ee0c7a",precision:2,keyframes:[],showPreWrapMode:!0,showPostWrapMode:!0},this.changeType="",this.isShowCtrl=!1,this.isShowPoint=!1,this.isShowAuxin=!1,this.ctrlPoints=null,this.currentKeyIndex=null,this.activeBoxInfo=null,this.activeKeysInfos=null,this.mouseDownPoint=null,this.eventHandlers=null,this.canvas=t,this.ctx=t.getContext("2d"),this.ctx.strokeStyle=this.ctrlConfig.strokeStyle;const h=t.cloneNode();h.className="grid";const l=t.cloneNode();l.className="curve",null===(i=t.parentNode)||void 0===i||i.insertBefore(l,t),null===(s=t.parentNode)||void 0===s||s.insertBefore(h,l),this.ctrlConfig.handlerSize=e.handlerSize||25,this.ctrlConfig.precision=e.precision||2,this.ctrlConfig.showPostWrapMode=null===(n=e.showPostWrapMode)||void 0===n||n,this.ctrlConfig.showPreWrapMode=null===(r=e.showPreWrapMode)||void 0===r||r,this.ctrlConfig.showPostWrapMode&&(e.curveConfig.postWrapMode=null!==(o=e.curveConfig.postWrapMode)&&void 0!==o?o:0),this.ctrlConfig.showPreWrapMode&&(e.curveConfig.preWrapMode=null!==(a=e.curveConfig.preWrapMode)&&void 0!==a?a:0),this.grid=new grid_1.Grid(h,e.gridConfig||{}),this.curve=new hermite_1.Hermite(l,this.grid,e.curveConfig||{}),this.emitChange=lodash.throttle(()=>{this.emit("change"),console.debug("change")},60),this.emitConfirm=lodash.throttle(()=>{this.emit("confirm"),console.debug("confirm")},60),this.registerHandler()}static drawLine(t,e,i){i.beginPath(),i.moveTo(t.x,t.y),i.lineTo(e.x,e.y),i.closePath(),i.stroke()}static drawArc(t,e,i){i.beginPath(),i.moveTo(t.x,t.y),i.arc(t.x,t.y,e,0,2*Math.PI),i.closePath(),i.stroke(),i.fill()}resetConfig(t){var e,i,s,n;this.ctrlConfig.handlerSize=t.handlerSize||25,this.ctrlConfig.precision=t.precision||2,this.ctrlConfig.showPostWrapMode=null===(e=t.showPostWrapMode)||void 0===e||e,this.ctrlConfig.showPreWrapMode=null===(i=t.showPreWrapMode)||void 0===i||i,this.ctrlConfig.showPostWrapMode&&(t.curveConfig.postWrapMode=null!==(s=t.curveConfig.postWrapMode)&&void 0!==s?s:0),this.ctrlConfig.showPreWrapMode&&(t.curveConfig.preWrapMode=null!==(n=t.curveConfig.preWrapMode)&&void 0!==n?n:0),this.grid=new grid_1.Grid(this.grid.canvas,t.gridConfig||{}),this.curve=new hermite_1.Hermite(this.curve.canvas,this.grid,t.curveConfig||{})}setGridFormat(t,e){this.grid[`${e}Format`]=t}getCurrentKeyframes(){return this.transGridToValue(this.curve.keyframes)}paint(t){this.activeBoxInfo=null,this.activeKeysInfos=null,this.clear(),t=this.transValueToGrid(t),this.grid.render(),this.curve.clear(),this.curve.paint(t),this.curve.paintWithCache(this.ctx),this.ctrlKeys=this.transToCtrlKey(this.curve.keyframes),this.painCtrlPoint()}transValueToGrid(t){const e=this.grid.xMaxValue,i=this.grid.axisXConfig.maxValue,s=this.grid.yMaxValue,n=this.grid.axisYConfig.maxValue;return t.map(t=>{const r={outTangent:t.outTangent,inTangent:t.inTangent,point:{x:0,y:0},broken:t.outTangent!==t.inTangent};return r.point.x=e/i*t.point.x,r.point.y=s/n*t.point.y,r.outTangent&&(r.outTangent*=s/n/(e/i)),r.inTangent&&(r.inTangent*=s/n/(e/i)),r})}transGridToValue(t){const e=this.grid.xMaxValue,i=this.grid.axisXConfig.maxValue,s=this.grid.yMaxValue,n=this.grid.axisYConfig.maxValue;return t.map(t=>{const r={outTangent:t.outTangent,inTangent:t.inTangent,point:{x:0,y:0}};return r.point.x=utils_1.toFixed(t.point.x/e*i,2),r.point.y=utils_1.toFixed(t.point.y/s*n,2),r.outTangent&&(r.outTangent*=e/i/(s/n)),r.inTangent&&(r.inTangent*=e/i/(s/n)),r})}rePaint(){this.clear(),this.grid.render(),this.curve.rePaint(),this.ctrlKeys.forEach((t,e)=>{const i=this.curve.keyframes[e];t.key=i,t.canvas=this.grid.valueToPixel(i.point),i.outTangent&&(t.outCanvas=this.grid.valueToPixel(this.calcCtrlPoint(i.point,i.outTangent,"outTangent"))),i.inTangent&&(t.inCanvas=this.grid.valueToPixel(this.calcCtrlPoint(i.point,i.inTangent,"inTangent")))}),this.painCtrlPoint()}updateWrapMode(t,e){this.curve.config[t]=e,"preWrapMode"===t?this.curve.paintPreWrapMode():this.curve.paintPostWrapMode()}moveTimeLine(t,e){return this.grid.transferX&&this.grid.transferX(t),this.grid.transferY&&this.grid.transferY(e),{x:this.grid.transferX&&this.grid.transferX(t)||0,y:this.grid.transferY&&this.grid.transferY(e)||0}}moveTimeLineX(t){return this.grid.transferX(t)}moveTimeLineY(t){return this.grid.transferY(t)}scaleTimeLine(t,e,i){return e>0?this.scaleTimeLineY(e,i)&&this.scaleTimeLineX(t,i):this.scaleTimeLineX(t,i)}scaleTimeLineY(t,e){let{yAxisScale:i}=this.grid;return this.grid.yAxisScaleAt(t,utils_1.smoothScale(e,this.grid.yAxisScale)),i!==this.grid.yAxisScale}scaleTimeLineX(t,e){let{xAxisScale:i}=this.grid;return this.grid.xAxisScaleAt(t,utils_1.smoothScale(e,this.grid.xAxisScale)),i!==this.grid.xAxisScale}addKeyFrame(t){const e=this.grid.pixelToValue(t),i=this.curve.addKeyFrame(e);null!==i?(this.ctrlKeys.splice(i,0,this.calcCtrl(this.curve.keyframes[i])),this.rePaint(),this.emitChange(),this.emitConfirm()):console.warn("添加点无效",e)}addKeyFrameInCurveAt(t){t=this.grid.pixelToValueX(t);const e=this.curve.addKeyFrameInCurveAt(t);if(null===e)return void console.warn("添加点无效",t);this.ctrlKeys.splice(e,0,this.calcCtrl(this.curve.keyframes[e]));const i=this.ctrlKeys[e];this.painCtrlPoint(),this.drawCtrl(i),this.emitChange(),this.emitConfirm()}transToCtrlKey(t){return t.map(t=>this.calcCtrl(t))}calcCtrl(t,e){let i,s;if("outTangent"!==e&&t.inTangent){const e=this.calcCtrlPoint(t.point,t.inTangent,"inTangent");s=this.grid.valueToPixel(e)}if("inTangent"!==e&&t.outTangent){const e=this.calcCtrlPoint(t.point,t.outTangent,"outTangent");i=this.grid.valueToPixel(e)}return{canvas:this.grid.valueToPixel(t.point),outCanvas:i,inCanvas:s,key:t}}calcCtrlPoint(t,e,i){if("number"!=typeof e)throw new Error("k should be number.");const{handlerSize:s}=this.ctrlConfig;let n=0,r=0;return e!==Number.POSITIVE_INFINITY?(n=Math.sqrt(s*s/(1+e*e)),n="inTangent"===i?t.x-n:t.x+n,r=t.y-e*(t.x-n)):(n=t.x,r="inTangent"===i?t.y+s:t.y-s),{x:n,y:r,type:i}}delActiveKeys(){if(this.activeKeysInfos){for(const t of this.activeKeysInfos){const e=this.ctrlKeys.findIndex(e=>e===t);this.curve.delKeyFrame(e),this.ctrlKeys.splice(e,1)}this.activeKeysInfos=null,this.currentKeyIndex=null,this.clear(),this.refreshRender(),this.painCtrlPoint()}}delKeyFrame(t){this.curve.delKeyFrame(t),this.ctrlPoints=null,this.ctrlKeys.splice(t,1),this.clear(),this.refreshRender(),this.painCtrlPoint()}refreshRender(){this.curve.rePaint(),this.resetCtrl(),this.lightCurve(),"number"==typeof this.currentKeyIndex&&this.ctrlKeys[this.currentKeyIndex]&&(this.ctrlPoints=this.ctrlKeys[this.currentKeyIndex],this.drawCtrl(this.ctrlPoints))}clear(){const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e)}clearAll(){this.clear(),this.curve.clear(),this.grid.clear()}updateTan(t,e,i){const s=this.currentKeyIndex,{canvas:n,key:r}=this.ctrlPoints;let o=0;o=Math.abs(t-n.x)-10<0?Number.POSITIVE_INFINITY:-(e-n.y)/this.grid.yAxisScale/((t-n.x)/this.grid.xAxisScale),r.broken?(this.curve.updateTan(s,o,i),this.ctrlKeys[s]=this.calcCtrl(this.curve.keyframes[s])):(this.curve.updateTan(s,o,"inTangent"),this.curve.updateTan(s,o,"outTangent"),this.ctrlKeys[s]=this.calcCtrl(this.curve.keyframes[s])),this.refreshRender(),this.drawCtrl(this.ctrlPoints)}moveActiveKeys(t,e){if(!this.activeKeysInfos||!t||!e)return!1;return!!this.curve.moveKeys(this.activeKeysInfos.map(t=>t.key),{x:t,y:-e})&&(this.rePaint(),!0)}moveKey(t,e,i){this.changeType="keyframe";const s=this.curve.moveKey(t,e,i);if(-1===s)return!1;this.ctrlKeys.splice(i,1);const n=this.curve.keyframes[s];return!!n&&(this.ctrlKeys.splice(s,0,this.calcCtrl(JSON.parse(JSON.stringify(n)))),this.currentKeyIndex=s,this.refreshRender(),!0)}registerHandler(){this.eventHandlers||(this.eventHandlers={mousemove:this.onMouseMove.bind(this),mouseup:this.onMouseUp.bind(this),mousedown:this.onMouseDown.bind(this),wheel:this.onWheel.bind(this),keydown:this.onKeyDown.bind(this)},this.canvas.addEventListener("mousemove",this.eventHandlers.mousemove),document.addEventListener("mouseup",this.eventHandlers.mouseup),this.canvas.addEventListener("mousedown",this.eventHandlers.mousedown),this.canvas.addEventListener("wheel",this.eventHandlers.wheel),this.canvas.addEventListener("keydown",this.eventHandlers.keydown))}unregisterHandler(){this.eventHandlers||(this.canvas.removeEventListener("mousemove",this.eventHandlers.mousemove),document.removeEventListener("mouseup",this.eventHandlers.mouseup),this.canvas.removeEventListener("mousedown",this.eventHandlers.mousedown),this.canvas.removeEventListener("wheel",this.eventHandlers.wheel),this.canvas.removeEventListener("keydown",this.eventHandlers.keydown),this.eventHandlers=null)}onKeyDown(t){switch(t.code){case"Delete":this.delActiveKeys()}}onWheel(t){t.stopPropagation(),t.preventDefault();let e=!0;(e=Math.abs(t.deltaX)>Math.abs(t.deltaY)?!!this.moveTimeLineX(t.deltaY):this.scaleTimeLine(t.offsetX,t.clientY,-t.deltaY))&&this.rePaint()}onMouseDown(t){var e;t.stopPropagation(),t.preventDefault(),this.canvas.setAttribute("focused","");const{r:i}=this.ctrlConfig,{offsetX:s,offsetY:n}=t,r=this.ctx.getImageData(s-PIXEL_RANGE/2,n-PIXEL_RANGE/2,PIXEL_RANGE,PIXEL_RANGE);if(this.mouseDownPoint={x:t.y,y:t.x,offsetX:s,offsetY:n,button:0===t.button?"left":"right"},this.activeKeysInfos&&this.activeBoxInfo&&(null===(e=this.activeBoxInfo)||void 0===e?void 0:e.box)){const{x:t,y:e,w:i,h:r}=this.activeBoxInfo.box;if(s>t&&s<t+i&&n>e&&n<e+r)return void(this.mouseDownPoint.type="activeBox")}for(let e=0;e<this.ctrlKeys.length;e++){const r=this.ctrlKeys[e],{x:o,y:a}=r.canvas;if(Math.abs(s-o)<2*CLICK_RANGE+i&&Math.abs(n-a)<2*CLICK_RANGE+i){if(this.activeKeysInfos=[r],this.currentKeyIndex=e,2===t.button)return;return this.mouseDownPoint.type="key",this.canvas.style.cursor="move",void this.showCtrl(r,e)}}if(this.isShowCtrl&&this.ctrlPoints)for(const t of["outCanvas","inCanvas"]){const e=this.ctrlPoints[t];if(!e)continue;const{x:r,y:o}=e;if(Math.abs(s-r)<CLICK_RANGE+i&&Math.abs(n-o)<CLICK_RANGE+i)return void(this.mouseDownPoint.type="outCanvas"===t?"outTangent":"inTangent")}if(r.data.toString()!==UINT8_COLOR_DEFAULT){if(this.mouseDownPoint.type="curve",2===t.button)return;this.lightCurve(),this.canvas.style.cursor="ns-resize"}this.mouseDownPoint.type||(this.mouseDownPoint.type="empty","left"===this.mouseDownPoint.button?(this.activeKeysInfos=null,this.activeBoxInfo=null):setTimeout(()=>{t.target.style.cursor="-webkit-grabbing"},200),this.resetCtrl("hideCtrl"))}onMouseMove(t){if(!this.mouseDownPoint||this.readonly)return;t.stopPropagation(),t.preventDefault();const{offsetX:e,offsetY:i,movementY:s,movementX:n,x:r,y:o}=t,{offsetX:a,offsetY:h,type:l,button:c}=this.mouseDownPoint;if(!(Math.abs(e-a)<.5||Math.abs(i-h)<.5))if("activeBox"!==l){if("inTangent"===l||"outTangent"===l)return this.changeType=l,this.updateTan(e,i,l),void this.emitChange();if("key"!==l||"number"!=typeof this.currentKeyIndex){if("curve"===l&&0!==s){if(!this.curve.moveAllY(s))return;return this.ctrlKeys=this.transToCtrlKey(this.curve.keyframes),this.changeType=l,this.emitChange(),this.resetCtrl(),void this.lightCurve()}if(["timeline","empty"].includes(l)&&"right"===c)return this.mouseDownPoint.type="timeline",void requestAnimationFrame(()=>{const t=this.grid.transfer(n,s);(t.x||t.y)&&this.rePaint()});if("empty"===l&&"left"===c){const t=Math.abs(e-a),s=Math.abs(i-h),n=e<a?e:a,r=i<h?i:h;this.activeBoxInfo={selectBox:{x:n,y:r,w:t,h:s}},this.clear(),this.paintAssistBox(this.activeBoxInfo.selectBox);const o=[];for(const e of this.ctrlKeys)e.canvas.x>n&&e.canvas.x<n+t&&e.canvas.y>r&&e.canvas.y<r+s&&o.push(e);this.activeKeysInfos=o,this.painCtrlPoint()}}else requestAnimationFrame(()=>{this.moveKey(e,i,this.currentKeyIndex)&&(this.emitChange(),this.changeType="key")})}else requestAnimationFrame(()=>{this.moveActiveKeys(n,s)&&(this.changeType="key",this.emitChange())})}onMouseUp(t){var e;this.canvas.style.cursor="default",this.readonly?this.mouseDownPoint=null:(this.mouseDownPoint&&"right"===this.mouseDownPoint.button&&this.onPopMenu({x:t.pageX,y:t.pageY}),this.mouseDownPoint=null,(this.activeBoxInfo||(null===(e=this.activeKeysInfos)||void 0===e?void 0:e.length))&&(this.activeBoxInfo=null,this.painCtrlPoint()),this.changeType&&(this.emitConfirm(),this.changeType=""))}onPopMenu(t){const{type:e,offsetX:i,offsetY:s}=this.mouseDownPoint,n=[];if(["curve"].includes(e)&&n.push({label:"Add Key in curve",click:()=>{this.addKeyFrameInCurveAt(i)}}),"empty"===e&&n.push({label:"Add Key",click:()=>{this.addKeyFrame({x:i,y:s})}}),["key","activeBox"].includes(e)&&n.push({label:"Delete Key",click:()=>{this.delActiveKeys()}}),n.length){require("electron").remote.Menu.buildFromTemplate(n).popup({x:t.x,y:t.y})}}showPoint(t){this.isShowPoint=!0,this.showKeyValueInfo(t)}paintAssistBox(t){const{x:e,y:i,w:s,h:n}=t;this.ctx.save(),this.ctx.strokeStyle="rgba(0, 255, 0, 0.2)",this.ctx.strokeRect(e,i,s,n),this.ctx.restore()}lightCurve(){const{focusColor:t}=this.ctrlConfig;this.ctx.strokeStyle=t,this.curve.paintWithCache(this.ctx),this.isShowAuxin=!0}showCtrl(t,e){this.currentKeyIndex!==t.index&&("number"==typeof this.currentKeyIndex&&(this.resetCtrl(),this.lightCurve()),this.ctrlPoints=t,this.drawCtrl(t))}drawCtrl(t){const e=this.ctx;this.isShowCtrl=!0;const{canvas:i}=t;e.save(),this.activeKeysInfos=[t],this.activeKeys(),this.showKeyCtrlHand(t),e.restore(),this.showPoint(i)}activeKeys(t=this.activeKeysInfos||[]){if(!t||!t.length)return;if(this.activeBoxInfo=this.activeBoxInfo||{},1===Array.from(t).length){const e=Array.from(t)[0].canvas;this.activeBoxInfo.box={x:e.x-CLICK_RANGE,y:e.y-CLICK_RANGE,w:2*CLICK_RANGE,h:2*CLICK_RANGE}}else{const e=[],i=[];for(const s of t)e.push(s.canvas.x),i.push(s.canvas.y);e.sort((t,e)=>t-e),i.sort((t,e)=>t-e);const s=Math.min(...e)-CLICK_RANGE,n=Math.min(...i)-CLICK_RANGE;this.activeBoxInfo.box={x:s,y:n,w:Math.max(...e)-s+CLICK_RANGE,h:Math.max(...i)-n+CLICK_RANGE}}this.paintActiveCtrlBox()}paintActiveCtrlBox(){if(!this.activeBoxInfo||!this.activeBoxInfo.box)return;const t=this.ctx;t.save();const{x:e,y:i,w:s,h:n}=this.activeBoxInfo.box;t.fillStyle="rgba(0, 255, 0, 0.2)",t.fillRect(e,i,s,n),t.restore()}showKeyCtrlHand(t){const e=this.ctx,{canvas:i,inCanvas:s,outCanvas:n}=t,{r:r,fillColor:o}=this.ctrlConfig;e.fillStyle=o,e.strokeStyle="white",s&&(CurveCtrl.drawLine(i,s,this.ctx),CurveCtrl.drawArc(s,r,this.ctx)),n&&(CurveCtrl.drawLine(i,n,this.ctx),CurveCtrl.drawArc(n,r,this.ctx))}showKeyValueInfo(t){const{x:e,y:i}=t;this.ctx.save(),this.ctx.strokeStyle="rgba(0, 255, 0, 0.2)",this.ctx.setLineDash([4,8]),this.ctx.moveTo(e,this.canvas.height-this.grid.axisMargin),this.ctx.lineTo(e,i),this.ctx.lineTo(this.grid.axisMargin,i),this.ctx.stroke(),this.ctx.fillStyle="gold",this.ctx.fillText(String(this.grid.yFormat(this.grid.pixelToValueY(i))),0,i),this.ctx.fillText(String(this.grid.xFormat(this.grid.pixelToValueX(e))),e-this.grid.axisMargin/2,this.canvas.height-this.grid.axisMargin/2),this.ctx.restore()}resetCtrl(t){(this.isShowCtrl||this.isShowAuxin||t)&&(this.isShowAuxin=!1,this.isShowCtrl=!1,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle=DEFAULT_CTRL_COLOR,this.clear(),this.curve.paintWithCache(this.ctx),this.painCtrlPoint(),t&&(this.currentKeyIndex=null,this.ctrlPoints=null))}painCtrlPoint(){var t;const{r:e,fillColor:i,strokeStyle:s}=this.ctrlConfig;this.ctx.fillStyle=i,this.ctx.strokeStyle=s;for(const t of this.ctrlKeys)this.ctx.beginPath(),this.ctx.arc(t.canvas.x,t.canvas.y,e,0,2*Math.PI),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill();(null===(t=this.activeKeysInfos)||void 0===t?void 0:t.length)&&this.activeKeys(this.activeKeysInfos)}}exports.CurveCtrl=CurveCtrl;