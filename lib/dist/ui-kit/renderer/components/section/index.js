"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Section=void 0;const path=require("path"),fs=require("fs"),base_1=require("../base"),{domUtils:domUtils}=require("../../utils");let customStyle="";const CUSTOM_STYLE='<style id="custom-style"></style>',STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./section.css"),"utf8")}</style>`,HTML=`${fs.readFileSync(path.join(__dirname,"./section.html"),"utf8")}`,instanceArray=[];class Section extends base_1.Base{constructor(){super(),this._noFocusFlag=!1,this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.expand=null!==this.getAttribute("expand"),this.$header=this.shadowRoot.querySelector("#header"),this.$headerSlot=this.shadowRoot.querySelector('slot[name="header"]'),this.$content=this.shadowRoot.querySelector(".content"),this.$contentSlot=this.shadowRoot.querySelector(".content > slot"),this.$scrollHeight=this.shadowRoot.querySelector(".scroll-height"),this.$header.$root=this.$content.$root=this.$contentSlot.$root=this,this.resizeObserver=new window.ResizeObserver(()=>{this.recoverScroll(this)}))}static importStyle(e){fs.existsSync(e)&&(customStyle=fs.readFileSync(e,"utf8"),instanceArray.map(e=>{e.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.$header.addEventListener("click",this._onHeaderClick),this.shadowRoot){const e=this.shadowRoot.querySelector("#custom-style");e&&(e.innerHTML=customStyle)}this.$content.addEventListener("scroll",this._onContentScroll),this.resizeObserver.observe(this.$content)}disconnectedCallback(){super.disconnectedCallback();const e=instanceArray.indexOf(this);instanceArray.splice(e,1),this.$header.removeEventListener("click",this._onHeaderClick),this.$content.removeEventListener("scroll",this._onContentScroll),this.resizeObserver.unobserve(this.$content)}static get observedAttributes(){return["focused","readonly","disabled","header","expand","scroll"]}attributeChangedCallback(e,t,s){switch(e){case"header":if(t===s)break;this._updateHeader(s);break;case"readonly":s=null!==s,this.updateUIAttr("readonly",s,this);break;case"disabled":s=null!==s,this.updateUIAttr("disabled",s,this);break;case"scroll":this.recoverScroll(this);break;default:return}}get expand(){return this.hasAttribute("expand")}set expand(e){e?this.setAttribute("expand",""):this.removeAttribute("expand"),this.dispatch("expand")}get header(){return this.getAttribute("header")}set header(e){e?this.setAttribute("header",e):this.removeAttribute("header")}_onContentScroll(){const e=this.$root;window.clearTimeout(e._recoverScrollHeightTimeId),e._recoverScrollHeightTimeId=window.setTimeout(()=>{e.dispatch("uiscroll")},300)}recoverScroll(e){window.clearTimeout(e._recoverScrollHeightTimeId),window.clearTimeout(e._clearScrollHeightTimeId),e._recoverScrollHeightTimeId=window.setTimeout(()=>{if(!e.getAttribute("scroll"))return;const t=JSON.parse(e.getAttribute("scroll"));t&&void 0!==t.scrollHeight&&(e.$scrollHeight.style.height=`${t.scrollHeight}px`,e.$content.scrollTo(t.scrollLeft,t.scrollTop),e._clearScrollHeightTimeId=setTimeout(()=>{e.$scrollHeight.style.height="0px",e.removeAttribute("scroll")},500))},100)}updateUIAttr(e,t,s){if(s.childNodes)for(let o of s.childNodes)domUtils.isUIComponent(o)&&(o[e]=!!t)}_onHeaderClick(e){const t=e.target.tagName.toLowerCase();["ui-num-input","input","ui-select","select","ui-checkbox","checkbox"].includes(t)||(this.$root.expand=!this.$root.expand)}_onFocus(){this._noFocusFlag||(this.focused=!0)}_onMouseDown(e){e.target===this||this.$header.contains(e.target)||"header"===e.target.slot?this._noFocusFlag=!1:this._noFocusFlag=!0}_updateHeader(e){e&&e.startsWith("i18n:")&&(e=e.replace(/i18n:([^\s]+)/g,(e,t)=>{let s=Editor.I18n.t(t);return s||(s=t),s})),this.$headerSlot.innerHTML=e}}exports.Section=Section;