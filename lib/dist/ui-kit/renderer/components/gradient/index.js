"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Gradient=void 0;const fs=require("fs"),path=require("path"),base_1=require("../base");let customStyle="";const Chroma=require("chroma-js"),CUSTOM_STYLE='<style id="custom-style"></style>',STYLE=`<style>${fs.readFileSync(path.join(__dirname,"./gradient.css"),"utf8")}</style>`,HTML=`${fs.readFileSync(path.join(__dirname,"./gradient.html"),"utf8")}`,instanceArray=[];class Gradient extends base_1.Base{constructor(){super(),this.shadowRoot&&(this.shadowRoot.innerHTML=`${STYLE}${CUSTOM_STYLE}${HTML}`,this.$colorWrap=this.shadowRoot.querySelector(".color-wrap"),this.$color=this.shadowRoot.querySelector(".color"),this.addEventListener("click",this._onClick))}static importStyle(t){fs.existsSync(t)&&(customStyle=fs.readFileSync(t,"utf8"),instanceArray.map(t=>{t.shadowRoot.querySelector("#custom-style").innerHTML=customStyle}))}get value(){const t=this.getAttribute("value");if(!t)return t;try{return JSON.parse(t)}catch(t){return console.warn(t),null}}set value(t){if(t){"object"!=typeof t&&(t={alpha:[],color:[]});try{this.setAttribute("value",JSON.stringify(t)),this.invalid&&(this.invalid=!1)}catch(t){console.warn(t),this.removeAttribute("value"),this.invalid=!0}}else this.removeAttribute("value")}connectedCallback(){if(super.connectedCallback(),instanceArray.push(this),this.readonly=null!==this.getAttribute("readonly"),this.disabled=null!==this.getAttribute("disabled"),this.shadowRoot){const t=this.shadowRoot.querySelector("#custom-style");t&&(t.innerHTML=customStyle)}}disconnectedCallback(){super.disconnectedCallback();const t=instanceArray.indexOf(this);instanceArray.splice(t,1)}static get observedAttributes(){return["focused","readonly","disabled","invalid","value","path"]}attributeChangedCallback(t,e,r){switch(super.attributeChangedCallback(t,e,r),t){case"invalid":case"value":this._updateColor()}}_updateColor(){const t=this.invalid?{color:[],alpha:[]}:this.value||{color:[],alpha:[]},e=t.alpha||[{value:1,progress:0}],r=t.color||[{value:"#ffffff",progress:0}],a=this._map={0:{r:255,g:255,b:255,a:255},1:{r:255,g:255,b:255,a:255}};e.forEach((t,r)=>{(a[t.progress]=a[t.progress]||{}).a=255*t.value|0,r===e.length-1&&(a[1].a=255*t.value|0),0===r&&(a[0].a=255*t.value|0)}),r.forEach((t,e)=>{const s=Chroma(t.value).rgb(),o=a[t.progress]=a[t.progress]||{};o.r=s[0],o.g=s[1],o.b=s[2],e===r.length-1&&(a[1].r=s[0],a[1].g=s[1],a[1].b=s[2]),0===e&&(a[0].r=s[0],a[0].g=s[1],a[0].b=s[2])});const s=Object.keys(a).sort();function o(t,e){const r=s[t];let o,i,n;o=t;do{i=a[s[o-=1]]}while(void 0===i[e]);o=t;do{n=a[s[o+=1]]}while(void 0===n[e]);const l=(r-s[t-1])/(s[t+1]-s[t-1]);return(n[e]-i[e])*l+i[e]}let i="linear-gradient(to right";s.forEach((t,e)=>{const r=a[t];void 0===r.r&&(r.r=Math.round(o(e,"r"))),void 0===r.g&&(r.g=Math.round(o(e,"g"))),void 0===r.b&&(r.b=Math.round(o(e,"b"))),void 0===r.a&&(r.a=Math.round(o(e,"a"))),r.progress=t}),s.forEach((t,e)=>{const r=a[t];if(i+=`, rgba(${r.r}, ${r.g}, ${r.b}, ${r.a/255}) ${100*t|0}%`,this.fixed&&s[e+1]){const r=a[s[e+1]];i+=`, rgb(${r.r}, ${r.g}, ${r.b}, ${r.a/255}) ${(100*t|0)-.01}%`}r.progress=t}),i+=")",this.$color.style.background=i}_onDisconnected(){this.dispatch("confirm")}_onClick(t){if(t.target.disabled||t.target.readonly)return;const e=this;Editor.Panel._kitControl.open({$kit:e,name:"ui-kit.gradient-picker",value:e.value,events:{confirm:t=>{e.value=t,e.dispatch("confirm",t)},change:t=>{e.value=t,e.dispatch("change",t)},cancel:t=>{e.value=t,e.dispatch("cancel",t)}}})}}exports.Gradient=Gradient;