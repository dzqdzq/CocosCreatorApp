"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),message_1=require("../../message"),ipc=require("@base/electron-base-ipc");class Selection extends events_1.EventEmitter{constructor(){super(...arguments),this._cache={},this._hoverTimer={},this._activatedTimer={}}_broadcastActivated(e){clearTimeout(this._hoverTimer[e]),this._hoverTimer[e]=setTimeout(()=>{const t=this._cache[e]=this._cache[e]||[];message_1.Message.broadcast("selection:activated",e,t.map(e=>e.id))},50)}_select(e,t){if("string"!=typeof t)return;const s=this._cache[e]=this._cache[e]||[];for(let e=s.length-1;e>=0;e--){const i=s[e];if(i&&i.id===t){s.splice(e,1);break}}s.push({id:t,time:Date.now()}),message_1.Message.broadcast("selection:select",e,t)}select(e,t){if("string"==typeof e){if(!Array.isArray(t))return this._select(e,t),void this._broadcastActivated(e);t.forEach(t=>{this._select(e,t)}),this._broadcastActivated(e)}}_unselect(e,t){const s=this._cache[e];if(s)for(let i=s.length-1;i>=0;i--){const c=s[i];if(c&&c.id===t){s.splice(i,1),message_1.Message.broadcast("selection:unselect",e,t);break}}}unselect(e,t){if("string"==typeof e){if(!Array.isArray(t))return this._unselect(e,t),void this._broadcastActivated(e);t.forEach(t=>{this._unselect(e,t)}),this._broadcastActivated(e)}}clear(e){this._cache[e]&&(this._cache[e].forEach(t=>{message_1.Message.broadcast("selection:unselect",e,t.id)}),this._cache[e].length=0)}update(e,t){const s=[],i=this._cache[e];t.forEach(t=>{if("string"!=typeof t)return;const c={id:t,time:Date.now()};s.push(c),i.find((e,t)=>e.id===c.id&&(i.splice(t,1),!0))||message_1.Message.broadcast("selection:select",e,c.id)});for(let t=0;t<i.length;t++)message_1.Message.broadcast("selection:unselect",e,i[t].id);this._cache[e]=s,this._broadcastActivated(e)}hover(e,t){"string"==typeof e&&(clearTimeout(this._hoverTimer[e]),this._hoverTimer[e]=setTimeout(()=>{"string"!=typeof t&&message_1.Message.broadcast("selection:hover",e),message_1.Message.broadcast("selection:hover",e,t)},50))}getLastSelectedType(){let e;return Object.keys(this._cache).forEach(t=>{const s=this._cache[t];if(!s)return;const i=s[s.length-1];i&&(!e||e.time<i.time)&&(e={type:t,uuid:i.id,time:i.time})}),e?e.type:""}getLastSelected(e){if("string"!=typeof e||!this._cache[e])return"";const t=this._cache[e],s=t[t.length-1];return s?s.id:""}getSelected(e){return"string"!=typeof e?[]:(this._cache[e]||[]).map(e=>e.id)}}module.exports=new Selection,ipc.on("editor-lib-selection:call",(e,t,s=[])=>{if(module.exports[t]){let i=module.exports[t](...s);return e.reply(null,i),i}});