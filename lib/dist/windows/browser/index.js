"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.restore=exports.open=void 0;const fs=require("fs"),fse=require("fs-extra"),ps=require("path"),electron_1=require("electron"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),file=ps.join(setting.PATH.HOME,"editor/window.json"),oldFile=ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"editor/window.json");!fse.existsSync(file)&&fse.existsSync(oldFile)&&fse.copySync(oldFile,file);const mainHTML=ps.join(__dirname,"../static/main.html"),startUpTime=Date.now();let save=function(){let e=windows.dump();e.windows=e.windows.filter(Boolean);let o=e.windows;o.forEach(e=>{e.url=ps.basename(e.url)});for(let e=0;e<o.length;e++){if(o[e].userData.panel){const n=panel.queryInfo(o[e].userData.panel);n&&n.userData.flags&&n.userData.flags.save||(o.splice(e,1),e--);continue}if(!o[e].userData.layout){o.splice(e,1),e--;continue}function n(e){if(e.panels){return e.panels.some(e=>{const o=panel.queryInfo(e);return!(!o||!o.userData.flags)&&!!o.userData.flags.save})}return e.children.some(e=>n(e))}n(o[e].userData.layout.layout)||(o.splice(e,1),e--)}try{fse.outputJSONSync(file,e,{spaces:2})}catch(e){}};function open(){windows.open(mainHTML,{center:!0,width:1100,height:700,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},{})}async function restore(){if(!fs.existsSync(file))return void await open();let e;try{(e=fse.readJSONSync(file)).windows.forEach(e=>{e.options||(e.options={}),e.options.webPreferences||(e.options.webPreferences={}),e.options.webPreferences.nodeIntegration=!0,e.options.webPreferences.webviewTag=!0,e.options.webPreferences.enableRemoteModule=!0,e.options.webPreferences.contextIsolation=!1,e.options.webPreferences.backgroundThrottling=!1})}catch(e){return console.warn(`Recovery window failed: ${file} read error.`),console.warn(e),console.warn(fse.copyFileSync(file,file+".error")),void await open()}let o=!0;e.windows.forEach(e=>{o=!1,e.url=ps.join(__dirname,"../static",ps.basename(e.url)),e.options||(e.options={}),e.options.webPreferences||(e.options.webPreferences={}),e.options.webPreferences.nodeIntegration=!0,e.options.webPreferences.webviewTag=!0,e.options.webPreferences.enableRemoteModule=!0,e.options.webPreferences.contextIsolation=!1,e.options.webPreferences.backgroundThrottling=!1}),o?await open():await windows.restore(e)}windows.on("change",save),windows.on("close",save),windows.on("clear",()=>{let e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),process.exit(0)}),windows.on("clear",()=>{worker.clear()}),exports.open=open,exports.restore=restore,ipc.on("editor-lib-windows:focus",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);if(o){o!==electron_1.BrowserWindow.getFocusedWindow()&&o.focus()}});