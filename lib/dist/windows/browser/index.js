"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.restore=exports.open=void 0;const fs=require("fs"),fse=require("fs-extra"),ps=require("path"),electron_1=require("electron"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc"),file=ps.join(setting.PATH.HOME,"editor/window.json"),mainHTML=ps.join(__dirname,"../static/main.html"),startUpTime=Date.now();let saveLock=!1;const save=function(){if(saveLock)return;const e=windows.dump();e.windows=e.windows.filter(Boolean);const o=e.windows;o.forEach(e=>{e.url=ps.basename(e.url)});for(let e=0;e<o.length;e++){if(o[e].userData.panel){const n=panel.queryInfo(o[e].userData.panel);n&&n.userData.flags&&n.userData.flags.save||(o.splice(e,1),e--);continue}if(!o[e].userData.layout){o.splice(e,1),e--;continue}function n(e){if(e.panels){return e.panels.some(e=>{const o=panel.queryInfo(e);return!(!o||!o.userData.flags)&&!!o.userData.flags.save})}return e.children.some(e=>n(e))}n(o[e].userData.layout.layout)||(o.splice(e,1),e--)}try{fse.outputJSONSync(file,e,{spaces:2})}catch(e){}};function open(){saveLock=!0;const e=windows.open(mainHTML,{center:!0,width:1100,height:700,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1}},{});return saveLock=!1,e}async function restore(){if(!fs.existsSync(file)){saveLock=!0;const e=await open();return saveLock=!1,[e]}let e;try{(e=fse.readJSONSync(file)).windows.forEach(e=>{e.options||(e.options={}),e.options.webPreferences||(e.options.webPreferences={}),e.options.webPreferences.nodeIntegration=!0,e.options.webPreferences.webviewTag=!0,e.options.webPreferences.enableRemoteModule=!0,e.options.webPreferences.contextIsolation=!1,e.options.webPreferences.backgroundThrottling=!1})}catch(e){saveLock=!0,console.warn(`Recovery window failed: ${file} read error.`),console.warn(e),console.warn(fse.copyFileSync(file,file+".error"));const o=await open();return saveLock=!1,[o]}let o=!0;if(e.windows.forEach(e=>{o=!1,e.url=ps.join(__dirname,"../static",ps.basename(e.url)),e.options||(e.options={}),e.options.webPreferences||(e.options.webPreferences={}),e.options.webPreferences.nodeIntegration=!0,e.options.webPreferences.webviewTag=!0,e.options.webPreferences.enableRemoteModule=!0,e.options.webPreferences.contextIsolation=!1,e.options.webPreferences.backgroundThrottling=!1}),o){saveLock=!0;const e=await open();return saveLock=!1,[e]}saveLock=!0;const n=await windows.restore(e);return saveLock=!1,n}windows.on("change",save),windows.on("close",save),windows.on("clear",()=>{const e=String((Date.now()-startUpTime)/1e3|0);Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,eventId:"CreatorLogout",projectId:Editor.Project.uuid,onlineDuration:e}),Editor.Metrics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:e}),setTimeout(()=>{process.exit(0)},1e3)}),windows.on("clear",()=>{worker.clear()}),exports.open=open,exports.restore=restore,ipc.on("editor-lib-windows:focus",e=>{const o=electron_1.BrowserWindow.fromWebContents(e.sender);if(o){o!==electron_1.BrowserWindow.getFocusedWindow()&&o.focus()}});