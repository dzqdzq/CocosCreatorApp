"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.disable=exports.enable=exports.unregister=exports.register=exports.startup=exports.scan=exports.getPackages=void 0;const path_1=require("path"),url_1=require("url"),events_1=require("events"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../module/index"),register_1=require("./register"),Profile=require("@base/electron-profile"),semver_1=require("semver"),{app:app,protocol:protocol}=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),i18n=require("@base/electron-i18n"),profile={builtin:{get:()=>({}),set(){},save(){}},default:Profile.load("defaultPreferences://editor/packages.json"),local:Profile.load("local://editor/packages.json"),global:Profile.load("global://editor/packages.json")};profile.default.set("disable-packages",{}),packageManager.debugRely(path_1.join(__dirname,"../renderer/debug.js"));const eventEmitter=new events_1.EventEmitter,nameMap={};function getPackages(e){e=e||{};const a=[];return Object.keys(packageManager.path2pkg).forEach(r=>{const t=packageManager.path2pkg[r];"name"in e&&e.name!==t.name||"debug"in e&&e.debug!==t.debug||"path"in e&&e.path!==t.path||"enable"in e&&e.enable!==t.enabled||t.invalid||a.push(t.generateInfo())}),a}async function scan(e){if(!fs_extra_1.existsSync(e))return[];if(!fs_extra_1.statSync(e).isDirectory())return[];const a=fs_extra_1.readdirSync(e),r=[];for(let t=0;t<a.length;t++){const n=a[t],o=path_1.join(e,n);try{if(!fs_extra_1.statSync(o).isDirectory()&&".asar"!==path_1.extname(o))continue}catch(e){continue}fs_extra_1.existsSync(path_1.join(o,"./package.json"))&&await register(o),r.push(o)}return r.filter(Boolean)}async function startup(e){for(const a in nameMap){const r=nameMap[a];let t=!1;if(r.local)for(const a of r.local){if(!(profile.local.get("disable-packages")||{})[a.path]){try{await e(a.name,a.path)}catch(e){console.error(e)}t=!0;break}}if(!1===t&&r.global)for(const a of r.global){if(!(profile.global.get("disable-packages")||{})[a.path]){try{await e(a.name,a.path)}catch(e){console.error(e)}t=!0;break}}if(!1===t&&r.builtin)for(const a of r.builtin){try{await e(a.name,a.path)}catch(e){console.error(e)}t=!0;break}}}function register(e){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=utils_1.getPosition(e);if(!a||packageManager.path2pkg[e])return!1;try{const r=packageManager.register(e);if("string"!=typeof r.name)return console.warn(`Invalid name: The extension name is not defined \n  ${e}.`),!1;r.name=r.name.toLowerCase();const t=packageManager.path2pkg[e];return register_1.profile(r),nameMap[r.name]=nameMap[r.name]||{builtin:[],global:[],local:[]},nameMap[r.name][a]=nameMap[r.name][a]||[],nameMap[r.name][a].push(t),!0}catch(a){return console.error(`[Extension] Register error: ${e}`),console.error(a),!1}}async function unregister(e){if("win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),!utils_1.getPosition(e))return;const a=packageManager.path2pkg[e];if(a){a.enabled&&await disable(e);try{await packageManager.unregister(e)}catch(e){console.error(e)}if(!packageManager.path2pkg[e]){const r=utils_1.getPosition(e);r&&nameMap[a.name][r]&&nameMap[a.name][r].find((e,t)=>a===e&&(nameMap[a.name][r].splice(t,1),!0))}}}async function enable(e){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":"));const a=utils_1.getPosition(e),r=packageManager.path2pkg[e];if(!r)return void console.warn(`[Package] Unknown and unable to start\n  ${e}`);if(/\./.test(r.name))return void console.warn(`[Package] The extension name is invalid: ${r.name}\n  ${e}`);if(r.json.editor&&!semver_1.satisfies(semver_1.valid(semver_1.coerce(Editor.App.version)),r.json.editor))return void console.warn(`[Package] Skip ${r.json.name}: Require the editor version ${r.json.editor}`);if(r.json.package_version){if(2!==r.json.package_version)return void console.warn(`[Package] Skip ${r.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${r.json.name}: package_version is not defined`);const t=nameMap[r.name];async function n(){if(t&&t.builtin)for(const e of t.builtin)e.enabled&&(await packageManager.disable(e.path),e.panels.forEach(e=>{Editor.Panel.close(e)}))}async function o(e){if(t&&t.global)for(const a of t.global)if(a.enabled&&(await packageManager.disable(a.path),a.panels.forEach(e=>{Editor.Panel.close(e)})),e){const e=profile.global.get("disable-packages")||{};e[a.path]||(e[a.path]={name:a.name,time:(new Date).getTime()},profile.global.set("disable-packages",e),profile.global.save())}}async function i(e){if(t&&t.local)for(const a of t.local)if(a.enabled&&(await packageManager.disable(a.path),a.panels.forEach(e=>{Editor.Panel.close(e)})),e){const e=profile.local.get("disable-packages")||{};e[a.path]||(e[a.path]={name:a.name,time:(new Date).getTime()},profile.local.set("disable-packages",e),profile.local.save())}}switch(a){case"builtin":await i(!0),await o(!0);break;case"global":await i(!0),await n();break;case"local":await o(!0),await n();break;default:await i(!0),await o(!0),await n()}try{await packageManager.enable(e)}catch(a){console.error(`[Package] Enable error: ${e}`),console.error(a)}if(profile[a]){const r=profile[a].get("disable-packages")||{};profile[a]&&r[e]&&(delete r[e],profile[a].set("disable-packages",r),profile[a].save())}}async function disable(e,a){"win32"===process.platform&&(e=e.replace(/^([a-z]):/,(e,a)=>a.toUpperCase()+":")),a=a||{};const r=utils_1.getPosition(e);if(!r)return;const t=packageManager.path2pkg[e];if(!t)return;if(t.panels.forEach(e=>{Editor.Panel.close(e)}),await packageManager.disable(e),profile[r]){const a=profile[r].get("disable-packages")||{};a[e]={name:t.name,time:(new Date).getTime()},profile[r].set("disable-packages",a),profile[r].save()}if(!1===a.replacement)return;const n=nameMap[t.name];let o=!1;switch(r){case"local":if(!1===o&&n.global)for(const e of n.global){if(!(profile.global.get("disable-packages")||{})[e.path]){try{await packageManager.enable(e.path)}catch(e){console.error(e)}o=!0;break}}case"global":if(!1===o&&n.builtin)for(const e of n.builtin){try{await packageManager.enable(e.path)}catch(e){console.error(e)}o=!0;break}}}function on(e,a){return eventEmitter.on(e,a)}function removeListener(e,a){return eventEmitter.removeListener(e,a)}exports.getPackages=getPackages,exports.scan=scan,exports.startup=startup,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.on=on,exports.removeListener=removeListener,packageManager.on("register",e=>{if(/^[a-z0-9][a-z0-9-_.]*$/.test(e.name)||console.warn(`The plug-in name is illegal: ${e.name}`),e.info.hooks){const a=e.info.hooks;if(a.register)try{const r=path_1.join(e.path,a.register||"");index_1.Module.requireFile(r).run(e.info)}catch(e){console.error(e)}}eventEmitter.emit("register",e)}),packageManager.on("unregister",e=>{eventEmitter.emit("unregister",e)}),packageManager.on("before-enable",e=>{try{const a=path_1.join(e.path,"i18n");if(!fs_extra_1.existsSync(a))return;if(!fs_extra_1.statSync(a).isDirectory())return;fs_extra_1.readdirSync(a).forEach(r=>{try{const t=path_1.join(a,r),n=index_1.Module.requireFile(t),o={};o[e.name]=n,i18n.register(o,path_1.basename(r,".js"))}catch(e){console.warn(e)}})}catch(e){console.error(e)}}),packageManager.on("before-disable",e=>{}),packageManager.on("enable",e=>{console.log(`[Package] ${e.name}@${e.version} enable`),eventEmitter.emit("enable",e)}),packageManager.on("disable",e=>{console.log(`[Package] ${e.name}@${e.version} disable`),eventEmitter.emit("disable",e);try{const a=path_1.join(e.path,"i18n");if(!fs_extra_1.existsSync(a))return;if(!fs_extra_1.statSync(a).isDirectory())return;fs_extra_1.readdirSync(a).forEach(r=>{const t=path_1.join(a,r),n=index_1.Module.requireFile(t),o={};o[e.name]=n,i18n.unregister(o,path_1.basename(r,".js")),index_1.Module.removeCache(t)})}catch(e){console.error(e)}}),app.once("ready",()=>{protocol.registerFileProtocol("packages",(e,a)=>{const r=url_1.parse(e.url),t=packageManager.find(r.host);a(t?path_1.join(t.path,r.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",async(e,a,...r)=>{try{const t=await module.exports[a](...r),n=JSON.stringify(t);return e.reply(null,n),n}catch(a){throw e.reply(a,null),a}});