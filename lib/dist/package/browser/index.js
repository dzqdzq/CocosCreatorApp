"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.disable=exports.enable=exports.unregister=exports.register=exports.startup=exports.scan=exports.getPackages=void 0;const path_1=require("path"),url_1=require("url"),events_1=require("events"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),register_1=require("./register"),Profile=require("@base/electron-profile"),semver_1=require("semver"),{app:app,protocol:protocol}=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),i18n=require("@base/electron-i18n"),profile={builtin:{get:()=>({}),set(){}},default:Profile.load("defaultPreferences://editor/packages.json"),local:Profile.load("local://editor/packages.json"),global:Profile.load("global://editor/packages.json")};profile.default.set("disable-packages",{}),packageManager.debugRely(path_1.join(__dirname,"../renderer/debug.js"));const eventEmitter=new events_1.EventEmitter,nameMap={};function getPackages(e){e=e||{};const a=[];return Object.keys(packageManager.path2pkg).forEach(t=>{const r=packageManager.path2pkg[t];"name"in e&&e.name!==r.name||"debug"in e&&e.debug!==r.debug||"path"in e&&e.path!==r.path||"enable"in e&&e.enable!==r.enabled||r.invalid||a.push(r.generateInfo())}),a}async function scan(e){if(!fs_extra_1.existsSync(e))return[];if(!fs_extra_1.statSync(e).isDirectory())return[];const a=fs_extra_1.readdirSync(e),t=[];for(let r=0;r<a.length;r++){const n=a[r],o=path_1.join(e,n);try{if(!fs_extra_1.statSync(o).isDirectory()&&".asar"!==path_1.extname(o))continue}catch(e){continue}await register(o),t.push(o)}return t.filter(Boolean)}async function startup(e){for(const a in nameMap){const t=nameMap[a];let r=!1;if(t.local)for(const a of t.local){if(!(profile.local.get("disable-packages")||{})[a.path]){try{await e(a.name,a.path)}catch(e){console.error(e)}r=!0;break}}if(!1===r&&t.global)for(const a of t.global){if(!(profile.global.get("disable-packages")||{})[a.path]){try{await e(a.name,a.path)}catch(e){console.error(e)}r=!0;break}}if(!1===r&&t.builtin)for(const a of t.builtin){try{await e(a.name,a.path)}catch(e){console.error(e)}r=!0;break}}}async function register(e){"win32"===process.platform&&(e=e.replace(/^([a-z])\:/,(e,a)=>a.toUpperCase()+":"));const a=utils_1.getPosition(e);if(a&&!packageManager.path2pkg[e])try{const t=await packageManager.register(e);if("string"!=typeof t.name)return void console.warn(`Invalid name: The extension name is not defined \n  ${e}.`);t.name=t.name.toLowerCase();const r=packageManager.path2pkg[e];register_1.profile(t),nameMap[t.name]=nameMap[t.name]||{builtin:[],global:[],local:[]},nameMap[t.name][a]=nameMap[t.name][a]||[],nameMap[t.name][a].push(r)}catch(a){console.error(`[Extension] Register error: ${e}`),console.error(a)}}async function unregister(e){if("win32"===process.platform&&(e=e.replace(/^([a-z])\:/,(e,a)=>a.toUpperCase()+":")),!utils_1.getPosition(e))return;const a=packageManager.path2pkg[e];if(a){a.enabled&&await disable(e);try{await packageManager.unregister(e)}catch(e){console.error(e)}if(!packageManager.path2pkg[e]){const t=utils_1.getPosition(e);t&&nameMap[a.name][t]&&nameMap[a.name][t].find((e,r)=>a===e&&(nameMap[a.name][t].splice(r,1),!0))}}}async function enable(e){"win32"===process.platform&&(e=e.replace(/^([a-z])\:/,(e,a)=>a.toUpperCase()+":"));const a=utils_1.getPosition(e);if(!a)return void console.warn(`[Package] Unknown and unable to start\n  ${e}`);const t=packageManager.path2pkg[e];if(!t)return void console.warn(`[Package] Unknown and unable to start\n  ${e}`);if(t.json.editor&&!semver_1.satisfies(semver_1.valid(semver_1.coerce(Editor.App.version)),t.json.editor))return void console.warn(`[Package] Skip ${t.json.name}: Require the editor version ${t.json.editor}`);if(t.json.package_version){if(2!==t.json.package_version)return void console.warn(`[Package] Skip ${t.json.name}: The package_version does not match.`)}else console.warn(`[Package] ${t.json.name}: package_version is not defined`);const r=nameMap[t.name];async function n(e){if(r&&r.builtin)for(const e of r.builtin)e.enabled&&await packageManager.disable(e.path),e.panels.forEach(e=>{Editor.Panel.close(e)})}async function o(e){if(r&&r.global)for(const a of r.global){a.enabled&&await packageManager.disable(a.path),a.panels.forEach(e=>{Editor.Panel.close(e)});const t=utils_1.getPosition(a.path);if(e&&t){const e=profile[t].get("disable-packages")||{};profile[t]&&(e[a.path]={name:a.name,time:(new Date).getTime()},profile[t].set("disable-packages",e),profile[t].save())}}}async function i(e){if(r.local)for(const a of r.local){a.enabled&&await packageManager.disable(a.path),a.panels.forEach(e=>{Editor.Panel.close(e)});const t=utils_1.getPosition(a.path);if(e&&t){const e=profile[t].get("disable-packages")||{};profile[t]&&(e[a.path]={name:a.name,time:(new Date).getTime()},profile[t].set("disable-packages",e),profile[t].save())}}}switch(a){case"builtin":await i(!0),await o(!0);break;case"global":await i(!0),await o(!0),await n();break;case"local":await i(!0),await o(!1),await n()}try{await packageManager.enable(e)}catch(a){console.error(`[Package] Enable error: ${e}`),console.error(a)}if(profile[a]){const t=profile[a].get("disable-packages")||{};profile[a]&&t[e]&&(delete t[e],profile[a].set("disable-packages",t),profile[a].save())}}async function disable(e,a){"win32"===process.platform&&(e=e.replace(/^([a-z])\:/,(e,a)=>a.toUpperCase()+":")),a=a||{};const t=utils_1.getPosition(e);if(!t)return;const r=packageManager.path2pkg[e];if(!r)return;if(r.panels.forEach(e=>{Editor.Panel.close(e)}),await packageManager.disable(e),profile[t]){const a=profile[t].get("disable-packages")||{};a[e]={name:r.name,time:(new Date).getTime()},profile[t].set("disable-packages",a),profile[t].save()}if(!1===a.replacement)return;const n=nameMap[r.name];let o=!1;switch(t){case"local":if(!1===o&&n.global)for(const e of n.global){if(!(profile.global.get("disable-packages")||{})[e.path]){try{await packageManager.enable(e.path)}catch(e){console.error(e)}o=!0;break}}case"global":if(!1===o&&n.builtin)for(const e of n.builtin){try{await packageManager.enable(e.path)}catch(e){console.error(e)}o=!0;break}}}function on(e,a){return eventEmitter.on(e,a)}function removeListener(e,a){return eventEmitter.removeListener(e,a)}exports.getPackages=getPackages,exports.scan=scan,exports.startup=startup,exports.register=register,exports.unregister=unregister,exports.enable=enable,exports.disable=disable,exports.on=on,exports.removeListener=removeListener,packageManager.on("register",e=>{if(e.info.hooks){const a=e.info.hooks;if(a.register)try{const t=path_1.join(e.path,a.register||"");require(t).run(e.info)}catch(e){console.error(e)}}(()=>{try{const a=path_1.join(e.path,"i18n");if(!fs_extra_1.existsSync(a))return;if(!fs_extra_1.statSync(a).isDirectory())return;fs_extra_1.readdirSync(a).forEach(t=>{const r=path_1.join(a,t),n=require(r),o={};o[e.name]=n,i18n.register(o,path_1.basename(t,".js"))})}catch(e){console.error(e)}})(),eventEmitter.emit("register",e)}),packageManager.on("unregister",e=>{eventEmitter.emit("unregister",e)}),packageManager.on("enable",e=>{console.log(`[Package] ${e.name}@${e.version} enable`),eventEmitter.emit("enable",e)}),packageManager.on("disable",e=>{console.log(`[Package] ${e.name}@${e.version} disable`),eventEmitter.emit("disable",e)}),app.once("ready",()=>{protocol.registerFileProtocol("packages",(e,a)=>{const t=url_1.parse(e.url),r=packageManager.find(t.host);a(r?path_1.join(r.path,t.pathname||""):"")})}),ipc.on("editor3d-lib-package:call",async(e,a,...t)=>{try{const r=await module.exports[a](...t),n=JSON.stringify(r);return e.reply(null,n),n}catch(a){throw e.reply(a,null),a}});