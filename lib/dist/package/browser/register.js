"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../profile/browser/index"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")};function getJsonPath(e,o){switch(e){case"local":return path_1.join(Editor.Project.path,"profiles","v2","packages",o+".json");case"project":return path_1.join(Editor.Project.path,"settings","v2","packages",o+".json");case"global":return path_1.join(Editor.App.home,"profiles","v2","packages",o+".json")}}async function profile(e){const o=e.info,r=["global","local","project"].map(async r=>{const s=index_1.ensureProfiles(e.name),t=s[r].get("__version__");if(s[r].set("__version__",t),t){if(e.version!==t&&Array.isArray(o.migrations)){const t=o.migrations;let a=0;for(;a<t.length;a++){const s=t[a];if(s[r]&&utils_1.compareVersion(s.version,e.version)<=0)try{console.log(`[Package] Migrate: ${e.name}@${o.author}(${s.version})`),require(path_1.join(e.path,s[r])).run(o)}catch(r){return console.error(`[Package] Migrate error: ${e.name}@${o.author}(${s.version})`),void console.error(r)}}s[r].set("__version__",e.version),s[r].save()}}else if(o.hooks&&o.hooks[r]){try{const s=require(path_1.join(e.path,o.hooks[r]));await s.run(o)}catch(r){console.error(`[Package] Migrate error: ${e.name}@${o.author}(0.0.0)`),console.log(r)}s[r].set("__version__",e.version),s[r].save()}else{s[r].set("__version__",e.version);const o=getJsonPath(r,e.name);o&&fs_extra_1.existsSync(o)&&s[r].save()}});return Promise.all(r)}exports.profile=profile;