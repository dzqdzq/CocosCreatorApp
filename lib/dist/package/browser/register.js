"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../profile/browser/index"),profileMigrationManager=require("./../../profile/browser/migration"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")},MigrationType={global:"migrateGlobal",local:"migrateLocal",project:"migrateProject"};function getJsonPath(r,o){switch(r){case"local":return path_1.join(Editor.Project.path,"profiles","v2","packages",o+".json");case"project":return path_1.join(Editor.Project.path,"settings","v2","packages",o+".json");case"global":return path_1.join(Editor.App.home,"profiles","v2","packages",o+".json")}}async function profile(r){const o=r.info;let e=[];Array.isArray(o.migrations)&&(o.migrations.forEach(o=>{o.profile&&(o.profile=path_1.join(r.path,o.profile)),o.custom&&(o.custom=path_1.join(r.path,o.custom))}),o.migrations.sort((r,o)=>utils_1.compareVersion(r.version,o.version||"")),profileMigrationManager._registerMigration(r.name,o.migrations),e=o.migrations.filter(r=>r.version&&r.custom));const i=["global","local","project"].map(async i=>{const a=index_1.ensureProfiles(r.name),t=a[i].get("__version__");if(void 0!==t){if(r.version!==t){a[i].set("__version__",r.version);const o=getJsonPath(i,r.name);o&&fs_extra_1.existsSync(o)&&a[i].save()}if(Array.isArray(o.migrations)&&(t||o.migrations.find(r=>"0.0.0"===r.version))&&r.version!==t){console.log(`[Package] Profile Migrate: ${r.name}@${o.author}...`);const s=a[i].get("")||{};try{const e=await profileMigrationManager[MigrationType[i]](r.name,t,s);a[i].set("",s),e&&(console.error(`[Package] Custom Migrate error(${i} profile): ${r.name}@${o.author}(${r.version})`),console.error(e))}catch(e){console.error(`[Package] Custom Migrate error(${i} profile): ${r.name}@${o.author}(${r.version})`),console.error(e)}for(const a of e){if(utils_1.compareVersion(a.version,r.version||"")<=0)try{console.log(`[Package] Custom Migrate: ${r.name}@${o.author}(${a.version})`);const e=require(a.custom);e[MigrationType[i]]&&await e[MigrationType[i]]()}catch(e){return console.error(`[Package] Custom Migrate error(${i}): ${r.name}@${o.author}(${a.version})`),void console.error(e)}}a[i].save()}}});return Promise.all(i)}exports.profile=profile;