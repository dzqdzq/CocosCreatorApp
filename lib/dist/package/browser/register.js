"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.profile=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../public/utils"),index_1=require("../../profile/browser/index"),profileMigrationManager=require("./../../profile/browser/migration"),Profile=require("@base/electron-profile"),data={global:Profile.load("global://editor/package.json"),local:Profile.load("local://editor/package.json"),project:Profile.load("project://editor/package.json")},MigrationType={global:"migrateGlobal",local:"migrateLocal",project:"migrateProject"};function getJsonPath(e,r){switch(e){case"local":return path_1.join(Editor.Project.path,"profiles","v2","packages",r+".json");case"project":return path_1.join(Editor.Project.path,"settings","v2","packages",r+".json");case"global":return path_1.join(Editor.App.home,"profiles","v2","packages",r+".json")}}async function profile(e){const r=e.info;let o=[];Array.isArray(r.migrations)&&(r.migrations.forEach(r=>{r.profile&&(r.profile=path_1.join(e.path,r.profile)),r.custom&&(r.custom=path_1.join(e.path,r.custom))}),r.migrations.sort((e,r)=>utils_1.compareVersion(e.version,r.version||"")),profileMigrationManager._registerMigration(e.name,r.migrations),o=r.migrations.filter(e=>e.version&&e.custom));const i=["global","local","project"].map(async i=>{const a=index_1.ensureProfiles(e.name),t=a[i].get("__version__");if(a[i].set("__version__",t),Array.isArray(r.migrations))if(t||r.migrations.find(e=>"0.0.0"===e.version)){if(e.version!==t){console.log(`[Package] Profile Migrate: ${e.name}@${r.author}...`);const s=a[i].get("")||{};try{const o=await profileMigrationManager[MigrationType[i]](e.name,t,s);a[i].set("",s),o&&(console.error(`[Package] Custom Migrate error(${i} profile): ${e.name}@${r.author}(${e.version})`),console.error(o))}catch(o){console.error(`[Package] Custom Migrate error(${i} profile): ${e.name}@${r.author}(${e.version})`),console.error(o)}for(const a of o){if(utils_1.compareVersion(a.version,e.version||"")<=0)try{console.log(`[Package] Custom Migrate: ${e.name}@${r.author}(${a.version})`);const o=require(a.custom);o[MigrationType[i]]&&await o[MigrationType[i]]()}catch(o){return console.error(`[Package] Custom Migrate error(${i}): ${e.name}@${r.author}(${a.version})`),void console.error(o)}}a[i].set("__version__",e.version),a[i].save()}}else{a[i].set("__version__",e.version);const r=getJsonPath(i,e.name);r&&fs_extra_1.existsSync(r)&&a[i].save()}});return Promise.all(i)}exports.profile=profile;