"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const metrics_observer_base_1=require("./metrics-observer-base"),encrypt=require("./cocos-encrypt"),https=require("https"),uuid=require("node-uuid");function createParam(e,t){return{appVersion:Editor.App.version,versionCode:"v1",uniqueID:t.uid,appID:"681395864",channelID:"100000",platform:"darwin"===process.platform?"Mac":"Windows",engine:"electron",userID:t.uid,resolution:"unknown",osVersion:require("os").release(),language:"unknown",manufacturer:"",store:"unknown",age:0,sex:0,callNumber:"creator.cocos.com",model:null,msgID:uuid.v4(),chargeTime:String(Date.now()/1e3|0),language:Editor.I18n.getLanguage()||"unknown"}}function sendData(e,t=!1){https.get(e,e=>{e.on("data",e=>{t&&console.log("receive analytics data --\x3e",e.toString())})}).on("error",e=>{t&&console.error("send analytics data fail",e)})}class CocosMetricsObserver extends metrics_observer_base_1.MetricsObserverBase{constructor(){super(),this._caURL="https://logstorage.cocos.com/log/v2?"}trackEvent(e,t){t.cid?e.sendToCocosAnalyticsOnly?this.trackCocosEvent(e,t):this.trackNormalEvent(e,t):console.warn("Metrics: no valid client ID")}trackNormalEvent(e,t){const n=Object.assign({},e.opts||{});n.action=e.action,e.label&&(n.label=e.label);let o="succeed";e.opts&&e.opts.eventTag&&(o=e.opts.eventTag,delete n.eventTag);const a=createParam(e,t);a.eventID=e.category,a.eventValue=n,a.eventTag=o,e.exitTag&&(a.exitTag=e.exitTag,a.eventTag=e.exitTag),e.onlineDuration&&(a.onlineDuration=e.onlineDuration),delete e.onlineDuration,t.debug&&console.log("send analytics ---\x3e",JSON.stringify(a)),sendData(this._caURL+encodeURIComponent(encrypt.encryptPostData(JSON.stringify(a))),t.debug)}trackCocosEvent(e,t){if(!e.eventId)return void console.error("Metrics: no valid eventId");delete e.sendToCocosAnalyticsOnly;const n=createParam(e,t);e.store&&(n.store=e.store,delete e.store),e.packageName&&(n.packageName=e.packageName,delete e.packageName);let o=e.eventId;delete e.eventId,n.eventID=o,n.eventValue=e,n.eventTag="succeed",e.onlineDuration&&(n.onlineDuration=e.onlineDuration),delete e.onlineDuration,t.debug&&console.log("send analytics ---\x3e",JSON.stringify(n)),sendData(this._caURL+encodeURIComponent(encrypt.encryptPostData(JSON.stringify(n))),t.debug)}trackException(e,t){if(!t.cid)return void console.warn("Metrics: no valid client ID");const n=createParam({},t);n.eventID="exception",n.eventValue={code:e.code,desc:e.message},n.eventTag="succeed",sendData(this._caURL+encodeURIComponent(JSON.stringify(n)))}sendAppInfo(e){}}module.exports=new CocosMetricsObserver;