"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeBroadcastListener=exports.addBroadcastListener=exports.broadcast=exports.send=exports.request=exports.unregister=exports.register=void 0;const electron_1=require("electron"),ipc=require("@base/electron-base-ipc"),packageManager=require("@editor/package"),panelManager=require("@editor/panel"),messageMap={},broadcastWindowMap={},broadcastListenerMap={};function register(e,s){for(const a in s){const t=s[a];t.methods?Array.isArray(t.methods)||(console.warn(`Invalid message definition: ${e}(${a}) 'methods' must be an array`),s[a].methods=[]):s[a].methods=[]}messageMap[e]=s}function unregister(e){delete messageMap[e]}async function request(e,s,...a){if(!messageMap[e]||!messageMap[e][s])throw new Error(`Message does not exist: ${e} - ${s}`);const t=messageMap[e][s];if(!t.methods.length)throw new Error(`No methods specified for current message: ${e} - ${s}`);for(let r=0;r<t.methods.length-1;r++){const o=t.methods[r].split(".");1===o.length?packageManager.exec(e,s,...a):panelManager.exec(e+"."+o[0],o[1],...a)}const r=t.methods[t.methods.length-1].split(".");return new Promise((s,t)=>{1===r.length?packageManager.exec(e,r[0],...a).callback((e,a)=>{if(e)return t(e);s(a)}):panelManager.exec("default"===r[0]?e:e+"."+r[0],r[1],...a).then(e=>{s(e)}).catch(e=>{t(e)})})}function send(e,s,...a){if(!messageMap[e]||!messageMap[e][s])throw new Error(`Message does not exist: ${e} - ${s}`);messageMap[e][s].methods.forEach(s=>{const t=s.split(".");1===t.length?packageManager.exec(e,s,...a):panelManager.exec("default"===t[0]?e:e+"."+t[0],t[1],...a)})}function broadcast(e,...s){for(const a in messageMap){if(!messageMap[a][e])continue;const t=messageMap[a][e];t.methods&&t.methods.forEach(e=>{const t=e.split(".");if(1===t.length)packageManager.exec(a,e,...s);else{const e="default"===t[0]?a:a+"."+t[0];(panelManager.getWindow(e)||[]).length>0&&panelManager.exec(e,t[1],...s)}})}if(broadcastWindowMap[e]){const a=broadcastWindowMap[e];for(let t=0;t<a.length;t++){const r=a[t],o=electron_1.webContents.fromId(r);o?ipc.sendToWin(electron_1.BrowserWindow.fromWebContents(o),"editor-lib-message:emit-broadcast-listener",e,...s):(a.splice(t,1),t--)}}if(broadcastListenerMap[e]){const a=broadcastListenerMap[e];for(const e of a)try{e(...s)}catch(e){console.error(e)}}}function addBroadcastListener(e,s){var a;broadcastListenerMap[e]=null!==(a=broadcastListenerMap[e])&&void 0!==a?a:[],broadcastListenerMap[e].push(s)}function removeBroadcastListener(e,s){if(broadcastListenerMap[e]){const a=broadcastListenerMap[e].indexOf(s);-1!==a&&broadcastListenerMap[e].splice(a,1)}}exports.register=register,exports.unregister=unregister,exports.request=request,exports.send=send,exports.broadcast=broadcast,exports.addBroadcastListener=addBroadcastListener,exports.removeBroadcastListener=removeBroadcastListener,ipc.on("editor-lib-message:call",async(e,s,...a)=>{if(module.exports[s])try{const t=await module.exports[s](...a);e.reply(null,t)}catch(s){e.reply(s,null)}}),ipc.on("editor-lib-message:add-broadcast-listener",async(e,s)=>{const a=e.sender.id;broadcastWindowMap[s]=broadcastWindowMap[s]||[],broadcastWindowMap[s].includes(a)||broadcastWindowMap[s].push(a)}),ipc.on("editor-lib-message:remove-broadcast-listener",async(e,s)=>{const a=e.sender.id;if(broadcastWindowMap[s]){const e=broadcastWindowMap[s].indexOf(a);-1!==e&&broadcastWindowMap[s].splice(e,1)}});