"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.removeTemp=exports.setTemp=exports.getTemp=exports.removeProject=exports.setProject=exports.getProject=exports.removeConfig=exports.setConfig=exports.getConfig=exports.ensureProfiles=exports.profileMap=void 0;const ps=require("path"),fse=require("fs-extra"),config_1=require("../public/config"),{EventEmitter:EventEmitter}=require("events"),semver=require("semver"),profile=require("@base/electron-profile"),setting=require("@editor/setting"),packageManager=require("@editor/package"),ipc=require("@base/electron-base-ipc"),eventManager=new EventEmitter;function ensureProfiles(e){return exports.profileMap[e]?exports.profileMap[e]:exports.profileMap[e]={defaultPreferences:profile.load(`defaultPreferences://packages/${e}.json`),global:profile.load(`global://packages/${e}.json`),local:profile.load(`local://packages/${e}.json`),defaultProject:profile.load(`defaultProject://packages/${e}.json`),project:profile.load(`project://packages/${e}.json`),temp:profile.load(`temp://packages/${e}.json`)}}async function getConfig(e,t,r){const o=ensureProfiles(e),s=!r;if(r||(r="local"),"default"===r){return o.defaultPreferences.get(t)}const n=o[r];return n?n.get(t,{type:s?"deep":"current"}):null}async function setConfig(e,t,r,o="local"){const s=ensureProfiles(e);if("default"===o){const e=s.defaultPreferences;return void await e.set(t,r)}const n=s[o];n&&(await n.set(t,r),n.save())}async function removeConfig(e,t,r){const o=ensureProfiles(e);r?"default"===r?await o.defaultPreferences.remove(t):o[r]&&(await o[r].remove(t),o[r].save()):(await o.local.remove(t),await o.global.remove(t),o.local.save(),o.global.save())}async function getProject(e,t,r){const o=ensureProfiles(e),s=!r;if(r||(r="project"),"default"===r)return o.defaultProject.get(t);const n=o[r];return n?n.get(t,{type:s?"deep":"current"}):null}async function setProject(e,t,r,o="project"){const s=ensureProfiles(e);if("default"===o)return void s.defaultProject.set(t,r);const n=s[o];n&&(await n.set(t,r),n.save())}async function removeProject(e,t,r){const o=ensureProfiles(e);r?"default"===r?await o.defaultPreferences.remove(t):o[r]&&(await o[r].remove(t),o[r].save()):(await o.project.remove(t),o.project.save())}async function getTemp(e,t){return ensureProfiles(e).temp.get(t)}async function setTemp(e,t,r){const o=ensureProfiles(e);o.temp.set(t,r),o.temp.save()}async function removeTemp(e,t){ensureProfiles(e).temp.remove(t)}function on(e,t){eventManager.on(e,t)}function removeListener(e,t){eventManager.removeListener(e,t)}function migrateFolder(e,t){if(!fse.existsSync(t))return;const r=fse.readdirSync(t).filter(e=>semver.valid(e)&&semver.lt(e,"3.0.1")).sort((e,t)=>semver.gt(e,t)?-1:1)[0];if(r)try{fse.copySync(ps.join(t,r),e)}catch(e){}else{try{fse.copySync(ps.join(t,"packages"),ps.join(e,"packages"))}catch(e){}try{fse.copySync(ps.join(t,"editor"),ps.join(e,"editor"))}catch(e){}}}if(exports.profileMap={},exports.ensureProfiles=ensureProfiles,exports.getConfig=getConfig,exports.setConfig=setConfig,exports.removeConfig=removeConfig,exports.getProject=getProject,exports.setProject=setProject,exports.removeProject=removeProject,exports.getTemp=getTemp,exports.setTemp=setTemp,exports.removeTemp=removeTemp,exports.on=on,exports.removeListener=removeListener,profile.on("change",(...e)=>{eventManager.emit("change",...e)}),ps.isAbsolute(setting.PATH.HOME)){const e=ps.join(setting.PATH.HOME,"./profiles",config_1.VERSION);if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles"))}const t=ps.join(e,"./default-profiles");fse.ensureDirSync(t),fse.emptyDirSync(t),profile.register("defaultPreferences",t),fse.ensureDirSync(e),profile.register("global",e),profile.inherit("global","defaultPreferences")}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./profiles",config_1.VERSION);if(fse.ensureDirSync(e),ps.isAbsolute(setting.PATH.PROJECT)){if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.PROJECT,"./profiles"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.PROJECT,"./profiles"))}fse.ensureDirSync(e),profile.register("local",e),profile.inherit("local","global")}}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./settings",config_1.VERSION);if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.PROJECT,"./settings"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.PROJECT,"./settings"))}const t=ps.join(e,"./default-profiles");fse.ensureDirSync(t),fse.emptyDirSync(t),profile.register("defaultProject",t),fse.ensureDirSync(e),profile.register("project",e),profile.inherit("project","defaultProject")}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./temp/profiles");fse.existsSync(e)||fse.mkdirsSync(e),profile.register("temp",e)}ipc.on("editor3d-lib-profile:call",async(e,t,...r)=>{try{const o=await module.exports[t](...r);return e.reply(null,o),o}catch(t){throw e.reply(t,null),t}});