"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeListener=exports.on=exports.removeTemp=exports.setTemp=exports.getTemp=exports.removeProject=exports.setProject=exports.getProject=exports.removeConfig=exports.setConfig=exports.getConfig=exports.ensureProfiles=exports.profileMap=exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=void 0;const ps=require("path"),fse=require("fs-extra"),config_1=require("../public/config"),{EventEmitter:EventEmitter}=require("events"),semver=require("semver"),lodash=require("lodash"),profile=require("@base/electron-profile"),setting=require("@editor/setting"),packageManager=require("@editor/package"),ipc=require("@base/electron-base-ipc"),eventManager=new EventEmitter;var migration_1=require("./migration");function ensureProfiles(e){return exports.profileMap[e]?exports.profileMap[e]:exports.profileMap[e]={defaultPreferences:profile.load(`defaultPreferences://packages/${e}.json`),global:profile.load(`global://packages/${e}.json`),local:profile.load(`local://packages/${e}.json`),defaultProject:profile.load(`defaultProject://packages/${e}.json`),project:profile.load(`project://packages/${e}.json`),temp:profile.load(`temp://packages/${e}.json`)}}async function getConfig(e,r,t){const o=ensureProfiles(e),s=!t;if(t||(t="local"),"default"===t){return o.defaultPreferences.get(r)}const i=o[t];return i?i.get(r,{type:s?"deep":"current"}):null}async function setConfig(e,r,t,o="local"){const s=ensureProfiles(e);if("default"===o){const e=s.defaultPreferences;return void await e.set(r,t)}const i=s[o];i&&(await i.set(r,t),i.save())}async function removeConfig(e,r,t){const o=ensureProfiles(e);t?"default"===t?await o.defaultPreferences.remove(r):o[t]&&(await o[t].remove(r),o[t].save()):(await o.local.remove(r),await o.global.remove(r),o.local.save(),o.global.save())}async function getProject(e,r,t){const o=ensureProfiles(e),s=!t;if(t||(t="project"),"default"===t)return o.defaultProject.get(r);const i=o[t];return i?i.get(r,{type:s?"deep":"current"}):null}async function setProject(e,r,t,o="project"){const s=ensureProfiles(e);if("default"===o)return void s.defaultProject.set(r,t);const i=s[o];i&&(await i.set(r,t),i.save())}async function removeProject(e,r,t){const o=ensureProfiles(e);t?"default"===t?await o.defaultPreferences.remove(r):o[t]&&(await o[t].remove(r),o[t].save()):(await o.project.remove(r),o.project.save())}async function getTemp(e,r){return ensureProfiles(e).temp.get(r)}async function setTemp(e,r,t){const o=ensureProfiles(e);o.temp.set(r,t),o.temp.save()}async function removeTemp(e,r){ensureProfiles(e).temp.remove(r)}function on(e,r){eventManager.on(e,r)}function removeListener(e,r){eventManager.removeListener(e,r)}function migrateFolder(e,r){if(!fse.existsSync(r))return;const t=fse.readdirSync(r).filter(e=>semver.valid(e)&&semver.lt(e,"3.0.1")).sort((e,r)=>semver.gt(e,r)?-1:1)[0];if(t)try{fse.copySync(ps.join(r,t),e)}catch(e){}else{try{fse.copySync(ps.join(r,"packages"),ps.join(e,"packages"))}catch(e){}try{fse.copySync(ps.join(r,"editor"),ps.join(e,"editor"))}catch(e){}}}if(Object.defineProperty(exports,"migrateGlobal",{enumerable:!0,get:function(){return migration_1.migrateGlobal}}),Object.defineProperty(exports,"migrateLocal",{enumerable:!0,get:function(){return migration_1.migrateLocal}}),Object.defineProperty(exports,"migrateProject",{enumerable:!0,get:function(){return migration_1.migrateProject}}),exports.profileMap={},exports.ensureProfiles=ensureProfiles,exports.getConfig=getConfig,exports.setConfig=setConfig,exports.removeConfig=removeConfig,exports.getProject=getProject,exports.setProject=setProject,exports.removeProject=removeProject,exports.getTemp=getTemp,exports.setTemp=setTemp,exports.removeTemp=removeTemp,exports.on=on,exports.removeListener=removeListener,profile.on("change",(...e)=>{eventManager.emit("change",...e)}),ps.isAbsolute(setting.PATH.HOME)){const e=ps.join(setting.PATH.HOME,"./profiles",config_1.VERSION);if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"./profiles"))}const r=ps.join(e,"./default-profiles");fse.ensureDirSync(r),fse.emptyDirSync(r),profile.register("defaultPreferences",r),fse.ensureDirSync(e),profile.register("global",e),profile.inherit("global","defaultPreferences")}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./profiles",config_1.VERSION);if(fse.ensureDirSync(e),ps.isAbsolute(setting.PATH.PROJECT)){if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.PROJECT,"./profiles"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.PROJECT,"./profiles"))}fse.ensureDirSync(e),profile.register("local",e),profile.inherit("local","global")}}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./settings",config_1.VERSION);if(fse.existsSync(e))try{if(0===fse.readdirSync(e).length){fse.removeSync(e),migrateFolder(e,ps.join(setting.PATH.PROJECT,"./settings"))}}catch(e){}else{migrateFolder(e,ps.join(setting.PATH.PROJECT,"./settings"))}const r=ps.join(e,"./default-profiles");fse.ensureDirSync(r),fse.emptyDirSync(r),profile.register("defaultProject",r),fse.ensureDirSync(e),profile.register("project",e),profile.inherit("project","defaultProject")}if(ps.isAbsolute(setting.PATH.PROJECT)){const e=ps.join(setting.PATH.PROJECT,"./temp/profiles");fse.existsSync(e)||fse.mkdirsSync(e),profile.register("temp",e)}ipc.on("editor3d-lib-profile:call",async(e,r,...t)=>{try{const o=await module.exports[r](...t);return e.reply(null,o),o}catch(r){throw e.reply(r,null),r}});