"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrateProject=exports.migrateLocal=exports.migrateGlobal=exports._unregisterMigration=exports._registerMigration=void 0;const utils_1=require("../../package/public/utils"),index_1=require("../../module/index"),migrationsMap={};function _registerMigration(r,e){e=e.filter(r=>r.profile),migrationsMap[r]=e}function _unregisterMigration(r){migrationsMap[r]&&(migrationsMap[r].forEach(r=>{index_1.Module.removeCache(r.profile)}),delete migrationsMap[r])}async function migrateGlobal(r,e,i){if(migrationsMap[r])return await runMigrateHandle("migrateGlobal",r,e,i)}async function migrateLocal(r,e,i){if(migrationsMap[r])return await runMigrateHandle("migrateLocal",r,e,i)}async function migrateProject(r,e,i){if(migrationsMap[r])return await runMigrateHandle("migrateProject",r,e,i)}async function runMigrateHandle(r,e,i,t){const a=migrationsMap[e].filter(r=>utils_1.compareVersion(r.version,i)>0);for(const i of a){console.debug(`[Package] Profile Migrate: ${e}(${i.version})`);const a=index_1.Module.requireFile(i.profile);if(a[r])try{await a[r](t)}catch(r){return r}}}exports._registerMigration=_registerMigration,exports._unregisterMigration=_unregisterMigration,exports.migrateGlobal=migrateGlobal,exports.migrateLocal=migrateLocal,exports.migrateProject=migrateProject;