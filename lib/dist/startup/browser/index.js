"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),app_1=require("../../app"),task_1=require("../../task"),i18n_1=require("../../i18n"),Package=require("../../package/browser/index"),Windows=require("../../windows/browser/index"),Metrics=require("../../metrics/browser/index"),{EventEmitter:EventEmitter}=require("events"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),windows=require("@base/electron-windows"),pkg=require("@editor/package"),Project=require("../../project/browser/index"),User=require("../../user/browser/index"),preBuiltin=["menu","profile","project","messages","program","device","ui-kit","tester","preferences","engine","programming"],postBuiltin=["asset-db","console","scene","about","server","utils","assets","inspector","hierarchy","preview","animator","builder","node-library","shortcuts","package-asset","reference-image","animation-graph","channel-upload-tools","runtime-dev-tools"];class Startup extends EventEmitter{constructor(){super(),this.ready={window:!1,package:!1}}async window(){task_1.Task.addSyncTask("Waiting windows");try{const e=await Windows.restore(),a=windows.uuid2win[e[0]];a&&(app_1.App.__userAgent=a.webContents.getUserAgent())}catch(e){console.error(e)}finally{this.ready.window=!0,this.emit("window-ready"),ipc.broadcast("editor3d-lib-startup:emit","window")}task_1.Task.removeSyncTask("Waiting windows")}async manager(e){task_1.Task.addSyncTask("Starting Manager"),await Project.init(),e?User.skip():await User.init();try{await Metrics.init()}catch(e){console.error(e)}Metrics.trackEvent({category:"Editor",action:"Cocos Creator Open"}),task_1.Task.removeSyncTask("Starting Manager")}async package(){task_1.Task.addSyncTask("Starting Package");try{for(let e=0;e<preBuiltin.length;e++){const a=preBuiltin[e],t=ps.join(__dirname,`../../../../builtin/${a}`);try{task_1.Task.addSyncTask(`startup.${a}`,i18n_1.I18n.t("startup.load_package",{name:a})),await Package.register(t),await Package.enable(t),task_1.Task.removeSyncTask(`startup.${a}`)}catch(e){console.error(`[Package] Register error: ${t}`),console.error(e)}}await Package.scan(ps.join(__dirname,"../../../../modules/engine-extensions/extensions"));for(let e=0;e<postBuiltin.length;e++){const a=ps.join(__dirname,`../../../../builtin/${postBuiltin[e]}`);try{await Package.register(a)}catch(e){console.error(`[Package] Register error: ${a}`),console.error(e)}}await Package.scan(ps.join(__dirname,"../../../../modules/editor-extensions/extensions")),await Package.scan(ps.join(__dirname,"../../../../platforms/internal")),await Package.scan(ps.join(__dirname,"../../../../platforms/runtime/platforms")),await Package.scan(ps.join(__dirname,"../../../../extension")),await Package.scan(ps.join(Editor.App.home,"extensions")),await Package.scan(ps.join(setting.PATH.PROJECT,"extensions")),await Package.startup(async function(e,a){task_1.Task.addSyncTask(`startup.${e}`,i18n_1.I18n.t("startup.load_package",{name:e})),await new Promise(e=>{setTimeout(e,20)}),await Package.enable(a),task_1.Task.removeSyncTask(`startup.${e}`)})}catch(e){console.error(e)}finally{this.ready.package=!0,this.emit("package-ready"),ipc.broadcast("editor3d-lib-startup:emit","package")}task_1.Task.removeSyncTask("Starting Package")}async build(e,a){return new Promise((t,r)=>{pkg.exec("builder","command-build",e,a).callback((e,a)=>{if(e)return r(e);t(a)})})}}module.exports=new Startup,ipc.on("editor3d-lib-startup:ready",(e,a)=>module.exports.ready[a]);