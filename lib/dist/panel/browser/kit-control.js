"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),{EventEmitter:EventEmitter}=require("events"),ps=require("path"),kitHTML=ps.join(__dirname,"../../windows/static/kit.html"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc");class KitControl extends EventEmitter{constructor(){super(),this.window=null,this.parentWindow=null,this.name="",this.options=null,this.isHold=!1,this.timer=null,this.__hide=(()=>{this.isHold=!1,clearTimeout(this.timer),this.window.hide()})}getOptionsCache(){return this.options}async init(){return this.window=new electron_1.BrowserWindow({x:0,y:0,width:100,height:100,show:!1,autoHideMenuBar:!0,frame:!1,resizable:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1},fullscreenable:!1}),this.window.loadFile(kitHTML),this.window.addListener("blur",()=>{clearTimeout(this.timer),this.timer=setTimeout(()=>{this.isHold||this.hide()},100)}),this.window.setAlwaysOnTop(!0),this.window.addListener("focus",()=>{clearTimeout(this.timer)}),new Promise(e=>{this.window.once("ready-to-show",e)})}register(e){const i=panel.queryInfo(e);ipc.sendToWin(this.window,"editor-lib-panel:register-kit-panel",i.name)}open(e,i){e&&i&&this.window?(clearTimeout(this.timer),i.removeListener("close",this.__hide),this.options=e,this.name=e.name,this.parentWindow=i,this.window.setParentWindow(this.parentWindow),this.parentWindow.on("close",this.__hide),this.transform(),this.show(),this.window.setParentWindow(null),panel.exec(this.name,"reset")):console.warn("Invalid argument")}show(){this.window&&(this.register(this.name),this.window.show(),ipc.sendToWin(this.window,"editor-lib-panel:open-kit-panel",this.name),this.window.focus())}transform(){if(!this.window)return!1;const e=panel.queryInfo(this.name),i=0|e.userData.size.width,t=0|e.userData.size.height;this.window.setContentSize(i,t);const{x:n,y:s,screen:o}=this.options,r=this.parentWindow.getContentBounds();let h=r.x+n,d=r.y+s;return h<o.x&&(h=o.x),h+i>o.x+o.width&&(h=o.x+o.width-i),d<o.y&&(d=o.y),d+t>o.y+o.height&&(d=o.y+o.height-t),h|=0,d|=0,this.window.setPosition(h,d),this.window.setPosition(h,d),!0}async hide(){ipc.sendToWin(this.window,"editor-lib-panel:hide-kit-panel",this.name),await panel.exec(this.name,"clear"),this.isHold=!1,this.removeAllListeners(),this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:hide"),clearTimeout(this.timer),this.timer=setTimeout(()=>{clearTimeout(this.timer),this.window.hide(),this.parentWindow.removeListener("close",this.__hide)},50)}hold(){this.isHold=!0,this.window.setAlwaysOnTop(!1)}emit(e,i,...t){this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:emit",e,i,...t)}}module.exports=new KitControl,ipc.on("editor-lib-panel-kit:call",async(e,i,...t)=>{if(!module.exports[i])return;let n=null;if("open"===i){const s=electron_1.BrowserWindow.fromWebContents(e.sender);n=await module.exports[i](...t,s)}else n=await module.exports[i](...t);e.reply(null,n)});