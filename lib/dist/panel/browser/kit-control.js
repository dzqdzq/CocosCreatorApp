"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),{EventEmitter:EventEmitter}=require("events"),ps=require("path"),kitHTML=ps.join(__dirname,"../../windows/static/kit.html"),panel=require("@editor/panel"),ipc=require("@base/electron-base-ipc");class KitControl extends EventEmitter{constructor(){super(),this.window=null,this.parentWindow=null,this.name="",this.options=null,this.isHold=!1,this.timer=null,this.__hide=(()=>{this.isHold=!1,clearTimeout(this.timer),this.window.hide()})}getOptionsCache(){return this.options}async init(){return this.window=new electron_1.BrowserWindow({x:0,y:0,width:100,height:100,show:!1,autoHideMenuBar:!0,frame:!1,resizable:!1,webPreferences:{nodeIntegration:!0,webviewTag:!0,enableRemoteModule:!0,contextIsolation:!1,backgroundThrottling:!1},fullscreenable:!1}),this.window.loadFile(kitHTML),this.window.addListener("blur",()=>{clearTimeout(this.timer),this.timer=setTimeout(()=>{this.isHold||this.hide()},100)}),this.window.setAlwaysOnTop(!0),this.window.addListener("focus",()=>{clearTimeout(this.timer)}),new Promise(e=>{this.window.once("ready-to-show",e)})}async register(e){const i=panel.queryInfo(e);this.window&&this.window.setContentSize(0|i.userData.size.width,0|i.userData.size.height),ipc.sendToWin(this.window,"editor-lib-panel:open-kit-panel",i.name)}open(e,i){if(!e||!i||!this.window)return void console.warn("Invalid argument");this.options=e,this.name=e.name,i.removeListener("close",this.__hide),this.parentWindow=i,this.window.setParentWindow(this.parentWindow);const t=this.parentWindow.getContentBounds();this.parentWindow.on("close",this.__hide);const s=panel.queryInfo(this.name);let n=t.x+e.x,o=t.y+e.y;n<e.screen.x&&(n=e.screen.x),n+s.userData.size.width>e.screen.x+e.screen.width&&(n=e.screen.x+e.screen.width-s.userData.size.width),o<e.screen.y&&(o=e.screen.y),o+s.userData.size.height>e.screen.y+e.screen.height&&(o=e.screen.y+e.screen.height-s.userData.size.height),this.move(n,o),this.show(e.name),this.window.setParentWindow(null),panel.exec(this.name,"reset")}show(e){this.window&&(this.register(e),this.window.show(),clearTimeout(this.timer),this.window.focus())}move(e,i){return!!this.window&&(e|=0,i|=0,this.window.setPosition(e,i),this.window.setPosition(e,i),!0)}hide(){panel.exec(this.name,"clear"),clearTimeout(this.timer),this.isHold=!1,this.removeAllListeners(),this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:hide"),this.timer=setTimeout(()=>{clearTimeout(this.timer),this.window.hide(),this.parentWindow.removeListener("close",this.__hide)},150)}hold(){this.isHold=!0,this.window.setAlwaysOnTop(!1)}emit(e,i,...t){this.parentWindow&&ipc.sendToWin(this.parentWindow,"editor-lib-panel-kit:emit",e,i,...t)}}module.exports=new KitControl,ipc.on("editor-lib-panel-kit:call",async(e,i,...t)=>{if(!module.exports[i])return;let s=null;if("open"===i){const n=electron_1.BrowserWindow.fromWebContents(e.sender);s=await module.exports[i](...t,n)}else s=await module.exports[i](...t);e.reply(null,s)});