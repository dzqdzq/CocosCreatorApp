"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unregisterTemplate=exports.registerTemplate=exports.apply=exports.removeGroup=exports.addGroup=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),menu_template_1=require("./menu-template"),i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc"),menuMap={},templateMap={};function add(e,t){if(menuMap[e]&&menuMap[t.label]&&remove(e,t),menuMap[e]=menuMap[e]||{},menuMap[e][t.label]=t,t.template){templateMap[t.template]={path:e,option:t};const p=menu_template_1.query(t.template);p&&p.forEach(p=>{const r=utils_1.mergeOption(t,p);r.__template__=t.template,main_menu_1.add(e,r)})}else main_menu_1.add(e,t)}function remove(e,t){if(menuMap[e]&&delete menuMap[e][t.label],t.template){const p=menu_template_1.query(t.template);p&&p.forEach(t=>{main_menu_1.remove(e,t)})}else main_menu_1.remove(e,t)}exports.add=add,exports.remove=remove;const groupMap={};function addGroup(e,t,p){const r=utils_1.translationPath(e),n=menu.get(r);groupMap[e]=groupMap[e]||{},groupMap[e][t]=p,n&&n.group(t,p)}function removeGroup(e,t){const p=utils_1.translationPath(e),r=menu.get(p);groupMap[e]&&delete groupMap[e][t],r._groups.some((e,p)=>{if(e.name===t)return r._groups.splice(p,1),!0})}exports.addGroup=addGroup,exports.removeGroup=removeGroup;let timer=null;function apply(){clearTimeout(timer),menu.apply()}function registerTemplate(e,t){const p=templateMap[e];p&&remove(p.path,p.option),menu_template_1.register(e,t),p&&(add(p.path,p.option),apply())}function unregisterTemplate(e){const t=templateMap[e];t&&(remove(t.path,t.option),apply()),menu_template_1.unregister(e)}exports.apply=apply,exports.registerTemplate=registerTemplate,exports.unregisterTemplate=unregisterTemplate,i18n.on("switch",async()=>{menu.clear();for(let e in menuMap){const t=menuMap[e];for(let p in t)add(e,t[p])}for(let e in groupMap){const t=groupMap[e];for(let p in t)addGroup(e,p,t[p])}apply()});let _popupMenuTemplate=null;ipc.on("editor-lib-menu:popup",(e,t)=>{const p=[];t.menu.forEach(t=>{if(t.template){const r=menu_template_1.query(t.template);r&&r.forEach(r=>{const n=utils_1.mergeOption(t,r);n.__template__=t.template,p.push(utils_1.translationOption(n,{click:(t,p)=>(delete p.menu,e.reply(null,p.__path__,t),!1)}))})}else p.push(utils_1.translationOption(t,{click:(t,p)=>(delete p.menu,e.reply(null,p.__path__,t),!1)}))});const r=electron_1.Menu.buildFromTemplate(p);_popupMenuTemplate=r;const n=electron_1.BrowserWindow.fromWebContents(e.sender);r.popup({window:n,x:t.x,y:t.y})});