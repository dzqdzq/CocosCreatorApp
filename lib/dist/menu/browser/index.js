"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unregisterTemplate=exports.registerTemplate=exports.apply=exports.removeGroup=exports.addGroup=exports.remove=exports.add=void 0;const electron_1=require("electron"),utils_1=require("./utils"),main_menu_1=require("./main-menu"),menu_template_1=require("./menu-template"),i18n=require("@base/electron-i18n"),menu=require("@base/electron-menu"),ipc=require("@base/electron-base-ipc"),menuMap={},templateMap={};function add(e,p){if(menuMap[e]&&menuMap[p.label]&&remove(e,p),menuMap[e]=menuMap[e]||{},menuMap[e][p.label]=p,p.template){templateMap[p.template]={path:e,option:p};const t=menu_template_1.query(p.template);t&&t.forEach(t=>{const n=utils_1.mergeOption(p,t);n.__template__=p.template,main_menu_1.add(e,n)})}else main_menu_1.add(e,p)}function remove(e,p){if(menuMap[e]&&delete menuMap[e][p.label],p.template){const t=menu_template_1.query(p.template);t&&t.forEach(p=>{main_menu_1.remove(e,p)})}else main_menu_1.remove(e,p)}exports.add=add,exports.remove=remove;const groupMap={};function addGroup(e,p,t){const n=utils_1.translationPath(e),u=menu.get(n);groupMap[e]=groupMap[e]||{},groupMap[e][p]=t,u&&u.group(p,t)}function removeGroup(e,p){const t=utils_1.translationPath(e),n=menu.get(t);groupMap[e]&&delete groupMap[e][p],n._groups.some((e,t)=>{if(e.name===p)return n._groups.splice(t,1),!0})}exports.addGroup=addGroup,exports.removeGroup=removeGroup;let timer=null;function apply(){clearTimeout(timer),menu.apply()}function registerTemplate(e,p){const t=templateMap[e];t&&remove(t.path,t.option),menu_template_1.register(e,p),t&&(add(t.path,t.option),apply())}function unregisterTemplate(e){const p=templateMap[e];p&&(remove(p.path,p.option),apply()),menu_template_1.unregister(e)}exports.apply=apply,exports.registerTemplate=registerTemplate,exports.unregisterTemplate=unregisterTemplate,i18n.on("switch",async()=>{menu.clear();for(let e in menuMap){const p=menuMap[e];for(let t in p)add(e,p[t])}for(let e in groupMap){const p=groupMap[e];for(let t in p)addGroup(e,t,p[t])}apply()});let _popupMenu=null,_popupMenuOptions=null;ipc.on("editor-lib-menu:popup",(e,p)=>{_popupMenuOptions=p;const t=[];p.menu.forEach(p=>{if(p.template){const n=menu_template_1.query(p.template);n&&n.forEach(n=>{const u=utils_1.mergeOption(p,n);u.__template__=p.template,t.push(utils_1.translationOption(u,{click:(p,t)=>(delete t.menu,e.reply(null,t.__path__,p),!1)}))})}else t.push(utils_1.translationOption(p,{click:(p,t)=>(delete t.menu,e.reply(null,t.__path__,p),!1)}))});const n=electron_1.Menu.buildFromTemplate(t),u=electron_1.BrowserWindow.fromWebContents(e.sender);n.popup({window:u,x:p.x,y:p.y}),_popupMenu=n,_popupMenuOptions=p,n.once("menu-will-close",()=>{_popupMenu=null,_popupMenuOptions=null})}),ipc.on("editor-lib-menu:query-popup",e=>{if(!_popupMenu)return e.reply(null,null);const p={};!function e(p,t){for(let n of t.items)p[n.__path__]={path:n.__path__,label:n.label,enabled:n.enabled},n.submenu&&(p[n.__path__].submenu={},e(p[n.__path__].submenu,n.submenu))}(p,_popupMenu),e.reply(null,p)}),ipc.on("editor-lib-menu:click-popup",(e,p)=>{if(!_popupMenu)return e.reply(null,!1),!1;const t=p.split("/");let n={submenu:_popupMenu},u="";for(let p=0;p<t.length;p++){const l=t[p];if(u+=l,!n.submenu)return e.reply(null,!1),!1;if(n=n.submenu.items.find(e=>e.__path__===u),u+="/",!n)return e.reply(null,!1),!1}return n.click(),_popupMenu.closePopup(),_popupMenuOptions=null,_popupMenu=null,e.reply(null,!0),!0}),ipc.on("editor-lib-menu:query-main",e=>{const p={};return function e(p,t){for(let n of t.items)p[n.__path__]={path:n.__path__,label:n.label,enabled:n.enabled},n.submenu&&(p[n.__path__].submenu={},e(p[n.__path__].submenu,n.submenu))}(p,electron_1.Menu.getApplicationMenu()),e.reply(null,p),p}),ipc.on("editor-lib-menu:click-main",(e,p)=>{const t=p.split("/");let n={submenu:electron_1.Menu.getApplicationMenu()};if(t.forEach(e=>{n=n&&n.submenu?n.submenu.items.find(p=>p.__path__===e):null}),!n){const p=new Error(`Menu is missing: ${t.join("/")}`);throw e.reply(null,p),p}n.click(),e.reply(null)});