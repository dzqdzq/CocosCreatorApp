"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const os_1=require("os"),events_1=require("events"),fse=require("fs-extra"),ps=require("path"),Stream=require("stream"),v_stacks_1=require("v-stacks"),ipc=require("@base/electron-base-ipc"),setting=require("@editor/setting"),logger=require("@base/electron-logger"),utils=require("./utils");logger.setLogHandler(e=>{if(e.message="[Editor] "+e.message,("warn"===e.type||"error"===e.type)&&0===e.stack.length){const r=new Error("Unknown warning");e.stack=v_stacks_1.ignoreStack(r.stack,3)}});class Logger extends events_1.EventEmitter{constructor(){super(),this.dirname=ps.join(setting.PATH.HOME,"log"),fse.ensureDirSync(this.dirname),this.clear(),this.file=ps.join(this.dirname,`editor-${(new Date).getTime()}.txt`);const e=fse.createWriteStream(this.file,{flags:"a"});this._readStream=new Stream.Readable({read(){}}),this._readStream.pipe(e,{end:!1})}clear(){const e=fse.readdirSync(this.dirname);e&&e.forEach(e=>{if(!e.startsWith("editor-"))return;const r=ps.join(this.dirname,e);try{fse.removeSync(r)}catch(e){}}),logger.clear&&logger.clear()}query(){return logger.query()}}module.exports=new Logger;const cyptoDeprecated=/crypto\.createDecipher is deprecated\.$/;logger.setLogHandler(e=>!cyptoDeprecated.test(e.message)),logger.on("record",e=>{module.exports.emit("record",e);const r=utils.formatLog(e)+os_1.EOL,t=module.exports._readStream;t&&t.push(r)}),logger.on("clear",()=>{module.exports.emit("clear")}),ipc.on("editor-lib-logger:call",(e,r,t=[])=>{if(!module.exports[r])return;const s=module.exports[r](...t);e.reply(null,s)}),process.on("unhandledRejection",e=>{console.error(e)});