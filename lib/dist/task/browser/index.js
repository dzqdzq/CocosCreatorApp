"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),ipc=require("@base/electron-base-ipc");let ID=0;class Task extends events_1.EventEmitter{constructor(){super(),this.syncTasks=[],this.syncTaskMap={},this.syncTaskTimer=null,this.noticeTasks=[],this.noticeTaskMap={}}_syncRendererMask(){const e=this.syncTasks[this.syncTasks.length-1];e?ipc.broadcast("editor-lib-task:show",e.title,e.describe,e.message):ipc.broadcast("editor-lib-task:show",null)}syncRendererMask(){null===this.syncTaskTimer&&(this._syncRendererMask(),this.syncTaskTimer=null)}addSyncTask(e,s,t){let i=this.syncTaskMap[e];i||(i={title:e,describe:s,message:t},this.syncTaskMap[e]=i,this.syncTasks.push(i),this.syncRendererMask())}updateSyncTask(e,s,t){let i=this.syncTaskMap[e];i&&(i.describe=s,i.message=t,this.syncRendererMask())}removeSyncTask(e){const s=this.syncTaskMap[e];if(!s)return;const t=this.syncTasks.indexOf(s);-1!==t&&this.syncTasks.splice(t,1),delete this.syncTaskMap[e],this.syncRendererMask()}addNotice(e){void 0===e.timeout&&(e.timeout=-1);const s=ID++,t=Object.assign({id:s},e);return this.noticeTasks.push(t),this.noticeTaskMap[s]=t,this.emit("add-notice",t),ipc.broadcast("editor-lib-task:emit","add-notice",t),e.timeout>0&&(t.timer=setTimeout(()=>{this.removeNotice(s)},e.timeout)),s}changeNoticeTimeout(e,s){const t=this.noticeTaskMap[e];t&&(clearTimeout(t.timer),(s=s||0)>0?(t.timeout=s,t.timer=setTimeout(()=>{this.removeNotice(e)},t.timeout)):t.timeout=s=0)}removeNotice(e){const s=this.noticeTaskMap[e];if(!s)return;const t=this.noticeTasks.indexOf(s);-1!==t&&this.noticeTasks.splice(t,1),delete this.noticeTaskMap[e],delete s.timer,this.emit("remove-notice",s),ipc.broadcast("editor-lib-task:emit","remove-notice",s)}queryNotices(){return this.noticeTasks}}module.exports=new Task,ipc.on("editor-lib-task:call",async(e,s,...t)=>{try{const i=await module.exports[s](...t);return e.reply(null,i),i}catch(s){e.reply(s)}return null}),ipc.on("editor-lib-task:query",e=>{const s=module.exports.syncTasks[0];s?e.reply(null,s.title,s.describe,s.message):e.reply(null,"")});