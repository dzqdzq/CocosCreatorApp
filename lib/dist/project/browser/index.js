"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ps=require("path"),fse=require("fs-extra"),node_uuid_1=require("node-uuid"),path_1=require("../../utils/source/path"),setting=require("@editor/setting"),ipc=require("@base/electron-base-ipc"),project=require("@editor/project"),configFile=ps.join(setting.PATH.HOME,"editor/project.json"),oldFile=ps.join(setting.PATH.HOME.replace(".CocosCreator",".CocosEditor3D"),"editor/project.json");function save(){const e=project.dump();fse.outputJSONSync(configFile,e,{spaces:2}),ipc.broadcast("editor3d-lib-project:update")}function checkProjectJson(e){return e.projects&&e.projects.forEach((t,r)=>{fse.existsSync(t.path)||e.projects.splice(r,1)}),e}!fse.existsSync(configFile)&&fse.existsSync(oldFile)&&fse.copySync(oldFile,configFile),(()=>{if(!fse.existsSync(configFile))return;let e;try{e=fse.readJsonSync(configFile)}catch(t){console.error(t),e={}}e=checkProjectJson(e),fse.outputJSONSync(configFile,e),project.init(e)})(),project.on("add",save).on("remove",save).on("open",save);class ProjectManager{constructor(){this._type="3d",this._path=null,this._uuid="",project.setOpenHandler(e=>{if(!process.send){const e=require("../../dialog"),t=require("../../i18n");return e.Dialog.error("Project warnning",{detail:t.I18n.t("menu.dashboard_missing"),type:"warn",defaultId:0,cancelId:0,buttons:["Cancel"]})}process.send({channel:"open-project",path:e})})}async init(){if(!setting.PATH.PROJECT)return;const e=ps.join(setting.PATH.PROJECT,"package.json");if("darwin"===process.platform&&Editor.App.path.startsWith("/private")){const e=require("../../dialog").Dialog;await e.error(Editor.I18n.t("project.macSandbox")),process.exit(1)}if(!fse.existsSync(setting.PATH.PROJECT)||!fse.existsSync(e)){const e=require("../../dialog").Dialog;await e.error(Editor.I18n.t("project.notExists")),process.exit(1)}const t=fse.readJSONSync(e);let r=!1;process.env.COCOS_DASHBOARD_VERSION||(t.creator=t.creator||{},t.creator.version!==Editor.App.version&&(t.creator.version=Editor.App.version,r=!0)),t.uuid||(r=!0,t.uuid=node_uuid_1.v4()),r&&fse.outputJSONSync(e,t,{spaces:2}),this._path=path_1.normalize(setting.PATH.PROJECT),this._uuid=t.uuid,this._name=t.name||""}get path(){return this._path}get name(){return this._name}get uuid(){return this._uuid}get tmpDir(){if(!this._path)return null;const e=ps.join(this._path,"temp");return fse.ensureDirSync(e),e}get type(){return this._type}create(){if(!process.send){const e=require("../../dialog"),t=require("../../i18n");return e.error("Project warnning",{detail:t.t("menu.dashboard_missing"),type:"warn",defaultId:0,cancelId:0,buttons:["Cancel"]})}process.send({channel:"show-dashboard",options:{host:"creator-project"}})}open(e){if(!process.send){const e=require("../../dialog"),t=require("../../i18n");return e.error("Project warnning",{detail:t.t("menu.dashboard_missing"),type:"warn",defaultId:0,cancelId:0,buttons:["Cancel"]})}process.send({channel:"open-project",options:{path:e,tab:0,type:"3d"}})}add(e){project.add(e)}}module.exports=new ProjectManager,ipc.on("editor3d-lib-project:call",(e,t,...r)=>module.exports[t](...r)),ipc.on("editor3d-lib-project:get",(e,t)=>module.exports[t]);