"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.findSignIdentify=exports.renameXcodeResource=exports.updateXcodeproject=exports.modifyPackageName=exports.checkPackageNameValidity=exports.changePackageName=exports.updateOrientation=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),plist=require("plist"),Editor=__importStar(require("editor")),child_process_1=require("child_process");async function updateOrientation(e,t){if(!t)return;const a=path_1.join(e,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist");if(fs_extra_1.existsSync(a)){let e=await fs_extra_1.readFile(a,"utf8");const i=plist.parse(e),r=[];t.landscapeRight&&r.push("UIInterfaceOrientationLandscapeRight"),t.landscapeLeft&&r.push("UIInterfaceOrientationLandscapeLeft"),t.portrait&&r.push("UIInterfaceOrientationPortrait"),t.upsideDown&&r.push("UIInterfaceOrientationPortraitUpsideDown"),i.UISupportedInterfaceOrientations=r,e=plist.build(i),await fs_extra_1.writeFile(a,e)}}async function changePackageName(e,t){const a=path_1.join(e,".cocos-project.json");if(!fs_extra_1.existsSync(a))return void console.error(`Can't find project json [${a}]`);const i=await fs_extra_1.readJSON(a);checkPackageNameValidity(t=t||i.packageName)||(console.warn("The package name is illegal(iOS). It can only contain these characters: [0-9], [a-z], [A-Z], [_]."),t=modifyPackageName(t));let r=i.packageName;i.mac&&i.mac.packageName&&(r=i.mac.packageName);const n=r!==t;if(!n)return;const o=path_1.join(e,"cocos-project-template.json");if(!fs_extra_1.existsSync(o))return void console.error(`Can't find template json [${o}]`);const c=(await fs_extra_1.readJSON(o)).do_add_native_support;let s;if(n){s=c.project_replace_ios_bundleid.files;for(const a of s){const i=path_1.join(e,a);if(!fs_extra_1.existsSync(i)){console.error(`Can't not find file [${a}], replace package name failed`);continue}let n=await fs_extra_1.readFile(i,"utf8");n=n.replace(new RegExp(r,"gm"),t),await fs_extra_1.writeFile(i,n)}}i.ios||(i.ios={}),i.ios.packageName=t,await fs_extra_1.writeFile(a,JSON.stringify(i,null,2))}function checkPackageNameValidity(e){return!0}function modifyPackageName(e){return e}async function updateXcodeproject(e,t){const a=path_1.join(Editor.App.path,"../resources/3d/engine-native"),i=t.packages.native.template,r=path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj`);if("link"===i&&fs_extra_1.existsSync(r)){const e=path_1.join(r,"project.pbxproj");let t=(await fs_extra_1.readFile(e)).toString();t=t.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,path_1.normalize(a)),await fs_extra_1.writeFile(e,t)}const n=path_1.join(r,"xcshareddata/xcschemes/HelloJavascript-clip.xcscheme");if(fs_extra_1.existsSync(n)){let e=(await fs_extra_1.readFile(n)).toString();e=e.replace(/HelloJavascript/g,t.name),await fs_extra_1.writeFile(n,e)}}async function renameXcodeResource(e,t){const a=[path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/HelloJavascript-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/${t.name}-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios/HelloJavascript-mobileRelease.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios/${t.name}-mobileRelease.entitlements`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios_appclip/HelloJavascript.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios_appclip/${t.name}.entitlements`)];for(let e=0;e<a.length;e+=2)fs_extra_1.existsSync(a[e])?await fs_extra_1.rename(a[e],a[e+1]):console.log(`notice: file ${a[e]} not found!`)}function readOrganizationUnit(e){const t=child_process_1.execSync(`xcrun security find-certificate -c "${e}" -p`),a=/OU=(\w+),/,i=child_process_1.execSync("openssl x509 -inform PEM -noout -text",{input:t}).toString("utf8").split("\n").filter(t=>t.indexOf(e)>=0).map(e=>e.match(a)).filter(e=>null!==e).map(e=>e[1]);return 0===i.length?"":i[0]}async function findSignIdentify(){try{const e=child_process_1.execSync("xcrun security find-identity -v -p codesigning").toString("utf8").split("\n"),t=/(\w+\)) ([0-9A-Z]+) "([^"]+)"/;return e.map(e=>e.match(t)).filter(e=>null!==e).map(e=>{const t=e[3].split(":");return{idx:e[1].substr(0,e[1].length-1),hash:e[2],kind:t[0],displayValue:t[1],outputValue:readOrganizationUnit(e[3]),fullValue:e[3]}})}catch(e){return console.warn("ios:"+Editor.I18n.t("ios.tips.developerTeamListError")),console.warn(e),[]}}exports.updateOrientation=updateOrientation,exports.changePackageName=changePackageName,exports.checkPackageNameValidity=checkPackageNameValidity,exports.modifyPackageName=modifyPackageName,exports.updateXcodeproject=updateXcodeproject,exports.renameXcodeResource=renameXcodeResource,exports.findSignIdentify=findSignIdentify;