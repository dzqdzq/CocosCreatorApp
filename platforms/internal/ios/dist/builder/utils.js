"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareVersion=exports.checkTargetVersion=exports.findSignIdentify=exports.renameXcodeResource=exports.updateXcodeproject=exports.modifyPackageName=exports.checkPackageNameValidity=exports.changePackageName=exports.updateOrientation=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),plist=require("plist"),child_process_1=require("child_process");async function updateOrientation(e,t){if(!t)return;const a=path_1.join(e,"frameworks/runtime-src/proj.ios_mac/ios/Info.plist");if(fs_extra_1.existsSync(a)){let e=await fs_extra_1.readFile(a,"utf8");const r=plist.parse(e),i=[];t.landscapeRight&&i.push("UIInterfaceOrientationLandscapeRight"),t.landscapeLeft&&i.push("UIInterfaceOrientationLandscapeLeft"),t.portrait&&i.push("UIInterfaceOrientationPortrait"),t.upsideDown&&i.push("UIInterfaceOrientationPortraitUpsideDown"),r.UISupportedInterfaceOrientations=i,e=plist.build(r),await fs_extra_1.writeFile(a,e)}}async function changePackageName(e,t){const a=path_1.join(e,".cocos-project.json");if(!fs_extra_1.existsSync(a))return void console.error(`Can't find project json [${a}]`);const r=await fs_extra_1.readJSON(a);if(!checkPackageNameValidity(t=t||r.packageName))return void console.error("The package name is illegal(iOS). It can only contain these characters: [0-9], [a-z], [A-Z], [_].");let i=r.packageName;r.mac&&r.mac.packageName&&(i=r.mac.packageName);const o=i!==t;if(!o)return;const n=path_1.join(e,"cocos-project-template.json");if(!fs_extra_1.existsSync(n))return void console.error(`Can't find template json [${n}]`);const s=(await fs_extra_1.readJSON(n)).do_add_native_support;let c;if(o){c=s.project_replace_ios_bundleid.files;for(const a of c){const r=path_1.join(e,a);if(!fs_extra_1.existsSync(r)){console.error(`Can't not find file [${a}], replace package name failed`);continue}let o=await fs_extra_1.readFile(r,"utf8");o=o.replace(new RegExp(i,"gm"),t),await fs_extra_1.writeFile(r,o)}}r.ios||(r.ios={}),r.ios.packageName=t,await fs_extra_1.writeFile(a,JSON.stringify(r,null,2))}function checkPackageNameValidity(e){return!!e}function modifyPackageName(e){return e}async function updateXcodeproject(e,t){const a=path_1.join(Editor.App.path,"../resources/3d/engine-native"),r=t.packages.native.template,i=path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj`);if("link"===r&&fs_extra_1.existsSync(i)){const e=path_1.join(i,"project.pbxproj");let t=(await fs_extra_1.readFile(e)).toString();t=t.replace(/\/Applications\/CocosCreator.app\/Contents\/Resources\/cocos2d-x/g,path_1.normalize(a)),await fs_extra_1.writeFile(e,t)}const o=path_1.join(i,"xcshareddata/xcschemes/HelloJavascript-clip.xcscheme");if(fs_extra_1.existsSync(o)){let e=(await fs_extra_1.readFile(o)).toString();e=e.replace(/HelloJavascript/g,t.name),await fs_extra_1.writeFile(o,e)}}async function renameXcodeResource(e,t){const a=[path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/HelloJavascript-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`${t.name}.xcodeproj/xcshareddata/xcschemes/${t.name}-clip.xcscheme`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios/HelloJavascript-mobileRelease.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios/${t.name}-mobileRelease.entitlements`),path_1.join(e,"frameworks/runtime-src/proj.ios_mac","ios_appclip/HelloJavascript.entitlements"),path_1.join(e,"frameworks/runtime-src/proj.ios_mac",`ios_appclip/${t.name}.entitlements`)];for(let e=0;e<a.length;e+=2)fs_extra_1.existsSync(a[e])?await fs_extra_1.rename(a[e],a[e+1]):console.log(`notice: file ${a[e]} not found!`)}function readOrganizationUnit(e){const t=child_process_1.execSync(`xcrun security find-certificate -c "${e}" -p`),a=/OU=(\w+),/,r=child_process_1.execSync("openssl x509 -inform PEM -noout -text",{input:t}).toString("utf8").split("\n").filter(t=>t.indexOf(e)>=0).map(e=>e.match(a)).filter(e=>null!==e).map(e=>e[1]);return 0===r.length?"":r[0]}async function findSignIdentify(){try{const e=child_process_1.execSync("xcrun security find-identity -v -p codesigning").toString("utf8").split("\n"),t=/(\w+\)) ([0-9A-Z]+) "([^"]+)"/;return e.map(e=>e.match(t)).filter(e=>null!==e).map(e=>{const t=e[3].split(":");return{idx:e[1].substr(0,e[1].length-1),hash:e[2],kind:t[0],displayValue:t[1],outputValue:readOrganizationUnit(e[3]),fullValue:e[3]}})}catch(e){return console.warn("ios:"+Editor.I18n.t("ios.tips.developerTeamListError")),console.warn(e),[]}}function checkTargetVersion(e,t){const a={error:"",newValue:""};let r="10.0";return"taskFlow"===t.packages.native.JobSystem&&(compareVersion(e,r="12.0")||(a.error="i18n:ios.tips.targetVersionErrorWithTaskFlow",a.newValue=r)),a.error||compareVersion(e,r)||(a.error="i18n:ios.tips.targetVersionError",a.newValue=r),a}function compareVersion(e,t,a="."){if("string"!=typeof e||"string"!=typeof t)return!0;const r=Math.max(e.length,t.length);return e=e.replace(a,"").padEnd(r,"0"),t=t.replace(a,"").padEnd(r,"0"),Number(e)>Number(t)||Number(e)===Number(t)}exports.updateOrientation=updateOrientation,exports.changePackageName=changePackageName,exports.checkPackageNameValidity=checkPackageNameValidity,exports.modifyPackageName=modifyPackageName,exports.updateXcodeproject=updateXcodeproject,exports.renameXcodeResource=renameXcodeResource,exports.findSignIdentify=findSignIdentify,exports.checkTargetVersion=checkTargetVersion,exports.compareVersion=compareVersion;