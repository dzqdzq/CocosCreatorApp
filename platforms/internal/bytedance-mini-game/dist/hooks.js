"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(n,a){function r(e){try{p(s.next(e))}catch(e){a(e)}}function o(e){try{p(s.throw(e))}catch(e){a(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,o)}p((s=s.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),OPEN_DATA_CONTEXT_ROOT="openDataContext";function onAfterInit(e,t,i){return __awaiter(this,void 0,void 0,function*(){const s=e.packages["bytedance-mini-game"];if(-1!==e.includeModules.indexOf("gfx-webgl2")&&e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1,"gfx-webgl"),e.assetSerializeOptions.exportCCON=!0,"physX"===s.physX.use){const t=e.includeModules.findIndex(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"));-1!==t&&e.includeModules.splice(t,1,"physics-physx")}e.includeModules.includes("physics-physx")&&!s.appid&&console.error(Editor.I18n.t("bytedance-mini-game.tips.require_appid")),e.moveRemoteBundleScript=!0,e.includeModules=Array.from(new Set(e.includeModules));let n=s.remoteServerAddress||"";n&&!n.endsWith("/")&&(n+="/"),Object.assign(e.appTemplateData,{isSetOrientation:!0,showFPS:!1,server:n}),Object.assign(e.buildEngineParam,{platform:"BYTEDANCE",moduleStyle:"cjs"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},e.buildScriptParam.flags.NOT_PACK_PHYSX_LIBS=!!s.physX.notPackPhysXLibs,Object.assign(e.physicsConfig,{physX:s.physX}),delete e.physicsConfig.physX.use;const a=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),r=path_1.join(Editor.Project.tmpDir,"builder/bytedance-mini-game",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(a)&&(fs_extra_1.existsSync(r)&&fs_extra_1.removeSync(r),fs_extra_1.copySync(a,r));const o={orientation:s.orientation,appid:s.appid,remoteServerAddress:s.remoteServerAddress};if(i.__addStaticsInfo(o),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(r))fs_extra_1.moveSync(r,a);else if(s.buildOpenDataContextTemplate){const e=(yield Editor.Message.request("engine","query-info")).path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,a)}})}function onBeforeCompressSettings(e,t){return __awaiter(this,void 0,void 0,function*(){t.paths.dir&&(yield buildAdapters(t.paths.dir))})}function onAfterBuild(e,t,i,s){return __awaiter(this,void 0,void 0,function*(){const i=path_1.join(t.paths.dir,`src/${e.buildScriptParam.outputName}`);fs_extra_1.existsSync(i)||fs_extra_1.outputFileSync(i,"console.log('There is no script in project.')","utf-8"),yield copyResFiles(e,t,s)})}function buildAdapters(e){return __awaiter(this,void 0,void 0,function*(){const t=(yield Editor.Message.request("engine","query-info")).path,i=path_1.join(t,"platforms/minigame"),s=yield globby(path_1.join(i,"common/**/*"),{nodir:!0});yield Promise.all(s.map(t=>{let s=fs_extra_1.readFileSync(t,"utf-8");s=compileJS(s,t);const n=path_1.relative(i,t),a=path_1.join(e,"libs",n);fs_extra_1.outputFileSync(a,s,"utf-8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)});const n=yield globby(path_1.join(i,"platforms/bytedance/wrapper/**/*"),{nodir:!0});yield Promise.all(n.map(t=>{let s=fs_extra_1.readFileSync(t,"utf-8");s=compileJS(s,t);const n=path_1.relative(path_1.join(i,"platforms/bytedance/"),t),a=path_1.join(e,"libs",n);fs_extra_1.outputFileSync(a,s,"utf-8")})).catch(e=>{e.stack=`BuildByteDanceLibTemplate error: ${e.stack}`,console.error(e)})})}function copyResFiles(e,t,i){return __awaiter(this,void 0,void 0,function*(){const s=e.packages["bytedance-mini-game"],n=e.buildEngineParam.engineName,a=path_1.join(templateDir,"build-template"),r=path_1.join(a,"game.ejs"),o={engineName:n,polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),appid:s.appid,isUsePhysX:e.includeModules.includes("physics-physx")},p=yield ejs_1.default.renderFile(r,o);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),p,"utf-8");const c=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(c)&&fs_extra_1.copySync(c,t.paths.dir),buildGameJson(a,t,e,i,c),buildProjectJson(a,t.paths.dir,e,c)})}function buildGameJson(e,t,i,s,n){const a=t.paths.dir,r=i.packages["bytedance-mini-game"],o=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));"landscapeRight"!==r.orientation&&"landscapeLeft"!==r.orientation||(r.orientation="landscape"),o.deviceOrientation=r.orientation,r.buildOpenDataContextTemplate?o.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete o.openDataContext;const p=path_1.join(n,"game.json");if(fs_extra_1.existsSync(p)){const e=fs_extra_1.readJSONSync(p);Object.assign(o,e)}const c=[];for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t,c.push({name:e.name,root:`subpackages/${e.name}/`})}c.length>0&&(o.subpackages=c);const l=path_1.join(a,"game.json");fs_extra_1.outputJSONSync(l,o,{spaces:4})}function buildProjectJson(e,t,i,s){const n=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));n.appid=i.packages["bytedance-mini-game"].appid||"testappid",n.projectname=i.name;const a=path_1.join(t,"project.config.json"),r=path_1.join(s,"project.config.json");if(fs_extra_1.existsSync(r)){const e=fs_extra_1.readJSONSync(r);Object.assign(n,e)}fs_extra_1.outputJSONSync(a,n)}function compileJS(e,t){let i;try{i=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return i.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;