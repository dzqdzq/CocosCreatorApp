"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,a){void 0===a&&(a=i),e[a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))(function(n,s){function r(e){try{p(a.next(e))}catch(e){s(e)}}function o(e){try{p(a.throw(e))}catch(e){s(e)}}function p(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,o)}p((a=a.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),separate_engine_1=require("./separate-engine"),stats_query_1=require("@cocos/build-engine/dist/stats-query"),index_1=require("@cocos/build-engine/dist/index"),ccBuild=__importStar(require("@cocos/build-engine")),enumerate_dependent_chunks_js_1=require("@cocos/build-engine/dist/enumerate-dependent-chunks.js"),globby=require("globby"),templateDir=path_1.join(__dirname,"../static"),userTemplateDir=path_1.join(Build.buildTemplateDir,"wechatgame"),OPEN_DATA_CONTEXT_ROOT="openDataContext";function onAfterInit(e,t,i){return __awaiter(this,void 0,void 0,function*(){const a=e.packages.wechatgame;-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1);let n=a.remoteServerAddress||"";if(n&&!n.endsWith("/")&&(n+="/"),Object.assign(e.appTemplateData,{isSetOrientation:!0,showFPS:!1,server:n}),e.moveRemoteBundleScript=!0,/\d*\.\d*\.\d*$/.test(Editor.App.version)||Editor.App.dev){a.separateEngine&&e.debug&&console.warn(Editor.I18n.t("builder.tips.separate_engine_with_debug"));const t=yield Editor.Message.request("engine","query-info");(yield Editor.Profile.getConfig("engine",`${Editor.Project.type}.javascript.builtin`,"default"))===t.path?a.separateEngine=a.separateEngine&&!e.debug:console.warn(Editor.I18n.t("builder.tips.separate_engine_with_custom_engine"))}else console.log(Editor.I18n.t("builder.tips.separate_engine_only_in_normal_version"));"js"===a.wasm?a.wasm=!1:"wasm"===a.wasm&&(a.wasm=!0),Object.assign(e.buildEngineParam,{platform:"WECHAT",sourceMaps:!a.separateEngine&&e.sourceMaps,split:a.separateEngine,skip:a.separateEngine,ammoJsWasm:a.wasm}),e.buildEngineParam.assetURLFormat="relative-from-out",e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"};const s=path_1.join(t.paths.dir,OPEN_DATA_CONTEXT_ROOT),r=path_1.join(Editor.Project.tmpDir,"builder/wechatagame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.existsSync(s)&&(fs_extra_1.existsSync(r)&&fs_extra_1.removeSync(r),fs_extra_1.copySync(s,r));const o={orientation:a.orientation,appid:a.appid,remoteServerAddress:a.remoteServerAddress};if(i.__addStaticsInfo(o),window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),fs_extra_1.existsSync(r))fs_extra_1.moveSync(r,s);else if(a.buildOpenDataContextTemplate){const e=(yield Editor.Message.request("engine","query-info")).path,t=path_1.join(e,"platforms/minigame",OPEN_DATA_CONTEXT_ROOT);fs_extra_1.copySync(t,s)}})}function onBeforeCompressSettings(e,t,i){return __awaiter(this,void 0,void 0,function*(){t.paths.dir&&sortSubPackage(e,t,i)})}function onAfterBuild(e,t,i,a){return __awaiter(this,void 0,void 0,function*(){e.packages.wechatgame.separateEngine&&(yield buildSeparateEngine(e,t)),yield _buildWeChatTemplate(e,t,a)})}function buildSeparateEngine(e,t){return __awaiter(this,void 0,void 0,function*(){const i=path_1.join(t.paths.dir,"cocos");fs_extra_1.ensureDirSync(t.paths.engineDir),yield separate_engine_1.buildCocos(!Editor.App.dev),Build.Utils.copyDirSync(separate_engine_1.separateEnginPaths.plugin,i);const a=e.buildEngineParam.includeModules,n=yield stats_query_1.StatsQuery.create(separate_engine_1.separateEnginPaths.internalEngine),s=n.getUnitsOfFeatures(a),r=separate_engine_1.getWechatPluginFeatures(),o=n.getUnitsOfFeatures(r),p=fs_extra_1.readJSONSync(path_1.join(separate_engine_1.separateEnginPaths.outDir,"meta.json")),c=path_1.join(t.paths.engineDir,"cc.js"),l=yield index_1.build.transform(n.evaluateIndexModuleSource(s,e=>o.includes(e)?`plugin:cocos/${e}.js`:(fs_extra_1.copySync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,`${e}.js`),path_1.join(t.paths.engineDir,`${e}.js`)),`./${e}.js`)),ccBuild.ModuleOption.system);fs_extra_1.writeFileSync(c,l.code,"utf8");const u=enumerate_dependent_chunks_js_1.enumerateDependentChunks(p,r),_=a.filter(e=>!r.includes(e)),d={};enumerate_dependent_chunks_js_1.enumerateDependentChunks(p,_).forEach(e=>{u.includes(e)?d[`../${path_1.basename(t.paths.engineDir)}/${path_1.basename(e)}`]=`plugin:cocos/${path_1.basename(e)}`:fs_extra_1.copyFileSync(path_1.join(separate_engine_1.separateEnginPaths.cacheCocos,e),path_1.join(t.paths.engineDir,e))});const m=path_1.join(t.paths.dir,"src","import-map.js");d.cc=`./${Build.Utils.relativeUrl(path_1.dirname(m),t.paths.engineDir)}/cc.js`,a.includes("physics-ammo")&&(d["wait-for-ammo-instantiation"]=`./${Build.Utils.relativeUrl(path_1.dirname(m),t.paths.engineDir)}/wait-for-ammo-instantiation.js`);let f=`export default ${JSON.stringify({imports:d})}`;f=yield Build.Utils.transformCode(f,{importMapFormat:"commonjs"}),fs_extra_1.writeFileSync(m,f),fs_extra_1.copyFileSync(path_1.join(templateDir,"cocos","plugin.json"),path_1.join(i,"plugin.json"))})}function sortSubPackage(e,t,i){for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),"game.js");fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,`console.log('${name}: no script in subPackage.')`,"utf8"),e.scriptDest=t}}function _buildWeChatTemplate(e,t,i){return __awaiter(this,void 0,void 0,function*(){const i=(yield Editor.Message.request("engine","query-info")).path,a=path_1.join(i,"platforms/minigame"),n=e.buildEngineParam.engineName,s=yield globby(path_1.join(a,"common/**/*"),{nodir:!0});yield Promise.all(s.map(e=>{let i=fs_extra_1.readFileSync(e,"utf8");i=compileJS(i,e);const n=path_1.relative(a,e),s=path_1.join(t.paths.dir,"libs",n);fs_extra_1.outputFileSync(s,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)}),console.debug("Compile common adapter success!");const r=yield globby(path_1.join(a,"platforms/wechat/wrapper/**/*"),{nodir:!0});yield Promise.all(r.map(e=>{let i=fs_extra_1.readFileSync(e,"utf8");i=compileJS(i,e);const n=path_1.relative(path_1.join(a,"platforms/wechat/"),e),s=path_1.join(t.paths.dir,"libs",n);fs_extra_1.outputFileSync(s,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)}),console.debug("Compile wrapper adapter success!");const o=path_1.join(templateDir,"build-template");let p=path_1.join(Build.buildTemplateDir,e.platform,"game.ejs"),c=!0;if(fs_extra_1.existsSync(p)){const e=path_1.join(Build.buildTemplateDir,".wechatgame");try{fs_extra_1.readJSONSync(e).version!==Editor.App.version&&console.warn("The version of build-template is not equal to this editor, that may cause some error, please update your build template.")}catch(e){console.debug(e)}}else p=path_1.join(o,"game.ejs"),c=!1;const l={engineName:n,cocosTemplate:path_1.join(o,"cocos-script.ejs"),polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS),engineDir:Build.Utils.relativeUrl(t.paths.dir,t.paths.engineDir)},u=yield ejs_1.default.renderFile(p,l);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,"game.js"),u,"utf8"),fs_extra_1.existsSync(userTemplateDir)&&(fs_extra_1.copySync(userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${userTemplateDir})}.`)),c&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"game.ejs")),buildGameJson(o,t.paths.dir,e,t),buildProjectConfig(o,t.paths.dir,e)})}function buildProjectConfig(e,t,i){const a=i.packages.wechatgame,n=fs_extra_1.readJSONSync(path_1.join(e,"project.config.json"));n.appid=a.appid||"wx6ac3f5090a6b99c5",n.projectname=i.name;const s=path_1.join(userTemplateDir,"project.config.json");if(fs_extra_1.existsSync(s)){const e=fs_extra_1.readJSONSync(s);Object.assign(n,e)}const r=path_1.join(t,"project.config.json");fs_extra_1.outputJSONSync(r,n)}function buildGameJson(e,t,i,a){const n=i.packages.wechatgame,s=fs_extra_1.readJSONSync(path_1.join(e,"game.json"));if(s.deviceOrientation=n.orientation,n.separateEngine){const t=path_1.join(e,"patch.json");let i=Editor.App.version;if(fs_extra_1.existsSync(t)){i=fs_extra_1.readJSONSync(t)["plugin-version"]}s.plugins={cocos:{version:i,provider:"wx7095f7fa398a2f30",path:"cocos"}}}n.buildOpenDataContextTemplate?s.openDataContext=OPEN_DATA_CONTEXT_ROOT:delete s.openDataContext;const r=[];for(const e of a.bundles)e.isSubpackage&&r.push({name:e.name,root:`subpackages/${e.name}/`});r.length>0&&(s.subpackages=r);const o=path_1.join(userTemplateDir,"game.json");if(fs_extra_1.existsSync(o)){const e=fs_extra_1.readJSONSync(o);Object.assign(s,e)}const p=path_1.join(t,"game.json");fs_extra_1.outputJSONSync(p,s,{spaces:4})}function compileJS(e,t){let i;try{i=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return i.code}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild;