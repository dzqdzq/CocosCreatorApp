"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,a){function s(e){try{c(o.next(e))}catch(e){a(e)}}function r(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,r)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.update=exports.$=exports.data=exports.template=exports.style=exports.buttonConfig=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),iconv=require("iconv-lite"),PKG_NAME="wechatgame";let panel;exports.buttonConfig={configs:{run:{label:"i18n:wechatgame.run.label",click(e,t){return __awaiter(this,void 0,void 0,function*(){t.buildPath=Editor.UI.File.resolveToRaw(t.buildPath);const e=path_1.join(t.buildPath,t.outputName),n=e.match(/([`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、])/im);n&&console.warn(Editor.I18n.t("wechatgame.tips.build_path_contains_symbol",{symbol:n[1]}));let o=yield Editor.Profile.getConfig("program","wechat_devtools");if(!o||!fs_extra_1.existsSync(o)){return console.warn(`${Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty",{wechatgamePath:o})}`),1===(yield Editor.Dialog.warn(Editor.I18n.t("wechatgame.tips.wechatgame_app_path_empty"),{buttons:["Cancel","Set Wechat DevTools"]})).response&&Editor.Message.send("preferences","open-settings","program"),!1}fs_extra_1.statSync(o).isDirectory()||"win32"!==process.platform||(o=path_1.dirname(o));const i={stdio:"pipe"};let a;if("darwin"===process.platform?(a=path_1.join(o,"Contents/Resources/app.nw/bin/cli"),fs_extra_1.existsSync(a)||(a=path_1.join(o,"Contents/MacOS/cli"))):(a=path_1.join(o,"cli.bat"),i.shell=!0),!fs_extra_1.existsSync(a))return yield Editor.Dialog.error(Editor.I18n.t("builder.wechat_game.client_path_error")),!1;const s=["-o",e,"-f","cocos"];console.log(`Run command : ${s.join(" ")}`);const r=child_process_1.spawn(a,s);return r&&r.stdout&&r.stdout.on("data",function(e){console.log(`${iconv.decode(e,"utf8").toString()}`)}),r&&r.stderr&&r.stderr.on("data",function(e){console.error(`${iconv.decode(e,"utf8").toString()}`)}),!0})}}}},exports.style="\n.warning-tip {\n    color: var(--color-warn-fill);\n    font-size： 11px;\n    line-height: 16px;\n    margin-bottom: 2px;\n}\n\n.jump {\n    cursor: pointer;\n    text-decoration: underline;\n}\n\n.jump:hover {\n    color: var(--color-focus-fill-weakest)\n}\n",exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../static/view.html"),"utf8");const component={data:()=>({pkgOptions:{},includeModules:[]}),computed:{physics3D(){return!!this.includeModules.filter(e=>e.startsWith("physics-")&&!e.startsWith("physics-2d")).length}},methods:{t:e=>Editor.I18n.t("wechatgame.options."+e),init(){return __awaiter(this,void 0,void 0,function*(){this.pkgOptions=panel.options.packages.wechatgame,yield this.updateEngineModules()})},onConfirm(e){const t=e.target.value;this.pkgOptions.wasm=t,panel.dispatch("update","packages.wechatgame.wasm",t,null)},openProjectSettings(){Editor.Message.send("project","open-settings","engine","modules")},updateEngineModules(){return __awaiter(this,void 0,void 0,function*(){this.includeModules=yield Editor.Profile.getProject("engine","modules.includeModules")})}},mounted(){this.init(),Editor.Message.addBroadcastListener("engine:engine-modules-config-changed",this.updateEngineModules)},beforeDestroy(){Editor.Message.removeBroadcastListener("engine:engine-modules-config-changed",this.updateEngineModules)}};function update(e,t){return __awaiter(this,void 0,void 0,function*(){panel=this,t&&!t.startsWith(`packages.${panel.pkgName}`)||(panel.options=e,panel.vm.init())})}function ready(e){panel=this;const t=require("vue/dist/vue.js");panel.options=e,panel.vm=new t(Object.assign({el:panel.$.root},component))}exports.data={vm:null,options:{}},exports.$={root:".wechatgame"},exports.update=update,exports.ready=ready;