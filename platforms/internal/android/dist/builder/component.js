"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAPILevel=exports.mounted=exports.methods=exports.data=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),options_1=require("./options"),lodash=require("lodash");function data(){return{verifyRes:{},pkgOptions:{},apiLevels:[],appABIList:["armeabi-v7a","arm64-v8a","x86"]}}async function mounted(){this.apiLevels=await getAndroidAPILevels(),this.init()}exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/builder/view.html"),"utf8"),exports.data=data,exports.methods={async onSetAndroidSDK(){Editor.Message.send("preferences","open-settings","program")},getDefaultPackageName:()=>options_1.defaultOptions.packageName,onNewKeyStore(){Editor.Panel.open("android.certificate")},onChangeDebugKeystore(e){const t=this;t.onUpdateOptions("useDebugKeystore",e),!0===e?(t.verifyRes.keystorePath=null,t.verifyRes.keystorePassword=null,t.verifyRes.keystoreAlias=null,t.verifyRes.keystoreAliasPassword=null):(t.verifyRes.keystorePath=options_1.verificationFunc("keystorePath",t.pkgOptions.keystorePath,t.options),t.verifyRes.keystorePassword=options_1.verificationFunc("keystorePassword",t.pkgOptions.keystorePassword,t.options),t.verifyRes.keystoreAlias=options_1.verificationFunc("keystoreAlias",t.pkgOptions.keystoreAlias,t.options),t.verifyRes.keystoreAliasPassword=options_1.verificationFunc("keystoreAliasPassword",t.pkgOptions.keystoreAliasPassword,t.options))},async onUpdateOptions(e,t){if(!e)return;const o=this;o.$emit("update",o.pkgName,e,t),o.verifyRes[e]=options_1.verificationFunc(e,o.pkgOptions[e],o.options),lodash.set(o.pkgOptions,`${e}`,t),lodash.set(o.options,`packages.${o.pkgName}.${e}`,t),Editor.Profile.setConfig("android",`options.${o.pkgName}.${e}`,t,"local");const s=await options_1.verificationFunc(e,t,o.options);s&&o.$set(o.verifyRes,e,s)},onChangeABI(e,t){const o=this,s=e.target.value;Array.isArray(o.pkgOptions.appABIs)||(o.pkgOptions.appABIs=[]),s?o.pkgOptions.appABIs.push(t):o.pkgOptions.appABIs.splice(o.pkgOptions.appABIs.indexOf(t),1),o.onUpdateOptions("appABIs",o.pkgOptions.appABIs)},async init(){const e=this;let t={};e.options.packages?t=e.options.packages[e.pkgName]:e.options.packages={};let o=await Editor.Profile.getConfig(e.pkgName,`options.${e.options.platform}`),s=await getAndroidAPILevels();s.length>0&&(options_1.defaultOptions.apiLevel=s[s.length-1]),(o=Object.assign({},options_1.defaultOptions,o)).sdkPath=await Editor.Profile.getConfig("program","android_sdk")||"",o.ndkPath=await Editor.Profile.getConfig("program","android_ndk")||"",e.pkgOptions=Object.assign(o,t),lodash.set(e.options.packages,e.pkgName,e.pkgOptions);const i={};for(const t of Object.keys(o)){let o=e.pkgOptions[t];const s=await options_1.verificationFunc(t,o,e.options);s&&(i[t]=s)}e.verifyRes=i},async changeInstantValue(e){this.pkgOptions.androidInstant=e,this.verifyRemoteUrl()},async verifyRemoteUrl(){let e=this;const t=await options_1.verificationFunc("remoteUrl",e.pkgOptions.remoteUrl,e.options);t&&(e.verifyRes.remoteUrl=t)}},exports.mounted=mounted;const MIN_COMPILE_LEVEL=26;async function getAndroidAPILevels(){const e=await Editor.Profile.getConfig("program","android_sdk");if(!e||!fs_1.existsSync(e))return[];const t=path_1.join(e,"platforms");return fs_1.readdirSync(t).filter(e=>{const o=getAPILevel(e),s=fs_1.statSync(path_1.join(t,e));return!!/^android-/.test(e)&&!!(o>=MIN_COMPILE_LEVEL&&s.isDirectory())})}function getAPILevel(e){const t=(e=e||"").match("android-([0-9]+)$");let o=-1;return t&&(o=parseInt(t[1])),o}exports.getAPILevel=getAPILevel;