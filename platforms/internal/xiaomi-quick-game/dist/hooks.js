"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onBeforeCompressSettings=exports.onAfterInit=exports.throwError=void 0;const child_process_1=require("child_process"),ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),cli_1=require("./utils/cli"),Editor=__importStar(require("editor")),globby=require("globby"),SUB_PACKAGE_JS_NAME="main.js",ICON_NAME="image/icon",Paths={temp:path_1.join(Build.projectTempDir,"xiaomi-quick-game"),packPath:path_1.join(Editor.App.path,"../tools","xiaomi-pack-tools"),userTemplateDir:path_1.join(Build.buildTemplateDir,"xiaomi-quick-game")},templateDir=path_1.join(__dirname,"../static/build-template");function getTemplatePath(e){return path_1.join(templateDir,e)}async function onAfterInit(e,t,a){const i=e.packages["xiaomi-quick-game"];window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.moveRemoteBundleScript=!0,e.generateCompileConfig=!0,e.packages["xiaomi-quick-game"].makeAfterBuild&&(e.nextTasks=["make"]),-1!==e.includeModules.indexOf("gfx-webgl2")&&(e.includeModules.splice(e.includeModules.indexOf("gfx-webgl2"),1),e.assetSerializeOptions["cc.EffectAsset"].glsl3=!1);let s=i.tinyPackageServer||"";s&&!s.endsWith("/")&&(s+="/"),Object.assign(e.appTemplateData,{isSetOrientation:!0,showFPS:!1,server:s}),Object.assign(e.buildEngineParam,{platform:"XIAOMI",engineName:"src/cocos-js"}),e.buildScriptParam.importMapFormat="commonjs",e.buildScriptParam.system={preset:"commonjs-like"},t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS));const r={orientation:i.deviceOrientation,remoteServerAddress:i.tinyPackageServer};a.__addStaticsInfo(r)}async function onBeforeCompressSettings(e,t,a){sortSubPackage(e,t,a),t.settings.orientation=e.packages["xiaomi-quick-game"].deviceOrientation}async function onAfterBuild(e,t,a,i){const s=e.packages["xiaomi-quick-game"];if(!t.paths.dir)return;if(await buildAdapters(t.paths.dir),await copyResFiles(e,t),s.encapsulation||void 0===s.encapsulation)for(const e of t.bundles){if(!fs_extra_1.existsSync(e.scriptDest))continue;const t=await fs_extra_1.readFile(e.scriptDest,"utf8");fs_extra_1.outputFileSync(e.scriptDest,`(function() { \n${t}\n })()`)}fs_extra_1.existsSync(Paths.userTemplateDir)&&(fs_extra_1.copySync(Paths.userTemplateDir,t.paths.dir),console.debug(`Use build-template {link(${Paths.userTemplateDir})}.`)),writeConfigFile(t.paths.dir,e,t);let r=fs_extra_1.readFileSync(t.paths.importMap,"utf-8");const n=path_1.basename(t.paths.engineDir);r=r.replace(new RegExp(`./${n}`,"g"),`no-schema:/src/${path_1.basename(t.paths.engineDir)}`),fs_extra_1.writeFileSync(t.paths.importMap,r)}async function make(e,t){const a={name:t.name,tinyPackageServer:t.packages["xiaomi-quick-game"].tinyPackageServer,useDebugKey:t.packages["xiaomi-quick-game"].useDebugKey};if(fs_extra_1.existsSync(Paths.packPath))await initPackFiles();else{console.debug("start unzip pack tools");const e=require("v-unzip"),t=Paths.packPath+".zip";await e.unzip(t,Paths.packPath)}if(console.debug("Check is install nodejs"),!await Build.Utils.isInstallNodeJs())return void console.error("Please install nodejs in global first!");console.debug("Check is install pack tools"),fs_extra_1.copySync(e,Paths.packPath),await buildRpk(a);const i=path_1.join(Paths.packPath,"dist");if(!fs_extra_1.existsSync(i))throw new Error("compile rpk failed!");fs_extra_1.copySync(i,path_1.join(e,"dist"));const s=path_1.join(e,"dist",`${t.name}${a.useDebugKey?".debug.":".release."}rpk`);console.debug(`compile rpk success {link(${s})}`)}async function copyResFiles(e,t){const a=e.packages["xiaomi-quick-game"],i=path_1.join(t.paths.dir,"src","system.bundle.js");fs_extra_1.writeFileSync(i,"var self=window; var navigator=window.navigator;"+fs_extra_1.readFileSync(i,"utf8")),await buildGameJs(e,t);const s=path_1.join(t.paths.dir,ICON_NAME+path_1.extname(a.icon));fs_extra_1.ensureDirSync(path_1.dirname(s)),fs_extra_1.existsSync(a.icon)?fs_extra_1.copyFileSync(a.icon,s):console.warn("Icon is missing");const{useDebugKey:r,privatePemPath:n,certificatePemPath:o}=a;handleSign(t.paths.dir,r,n,o)}async function initPackFiles(){if(cli_1.isInit(Paths.packPath))console.debug("use the cache xiaomi pack tools");else{fs_extra_1.existsSync(path_1.join(Paths.packPath,"package.json"))||(fs_extra_1.copySync(path_1.join(templateDir,"package.json"),path_1.join(Paths.packPath,"package.json")),fs_extra_1.copySync(path_1.join(templateDir,"babel.config.js"),path_1.join(Paths.packPath,"babel.config.js"))),console.debug("start install xiaomi pack tools");const e=await cli_1.install(Paths.packPath);if(!0!==e)throw e}fs_extra_1.removeSync(path_1.join(Paths.packPath,"src")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"libs")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"assets")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"remote")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"dist")),fs_extra_1.removeSync(path_1.join(Paths.packPath,"image")),fs_extra_1.existsSync(path_1.join(Paths.packPath,"subpackages"))&&fs_extra_1.removeSync(path_1.join(Paths.packPath,"subpackages"))}async function buildRpk(e){const t="win32"===process.platform?"npm.cmd":"npm";let a=e.useDebugKey?"build":"release";e.tinyPackageServer&&(a+="-ignore-res");const i=["run",a,"--cocos-wx-game"];return await new Promise((e,a)=>{const s=child_process_1.spawn(t,i,{cwd:Paths.packPath});s.stdout.on("data",e=>{console.log(e.toString())}),s.stderr.on("data",e=>{console.error(e.toString())}),s.on("close",t=>{t?a(t):e()})})}async function buildAdapters(e){const t=(await Editor.Message.request("engine","query-info")).path,a=path_1.join(t,"platforms/minigame"),i=await globby(path_1.join(a,"common/**/*"),{nodir:!0});await Promise.all(i.map(t=>{let i=fs_extra_1.readFileSync(t,"utf8");i=compileJS(i,t);const s=path_1.relative(a,t),r=path_1.join(e,"libs",s);fs_extra_1.outputFileSync(r,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)});const s=await globby(path_1.join(a,"platforms/xiaomi/wrapper/**/*"),{nodir:!0});await Promise.all(s.map(t=>{let i=fs_extra_1.readFileSync(t,"utf8");i=compileJS(i,t);const s=path_1.relative(path_1.join(a,"platforms/xiaomi/"),t),r=path_1.join(e,"libs",s);fs_extra_1.outputFileSync(r,i,"utf8")})).catch(e=>{e.stack=`BuildWechatLibTemplate error: ${e.stack}`,console.error(e)})}async function buildGameJs(e,t){e.packages["xiaomi-quick-game"],e.buildEngineParam.engineName;const a={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:t.paths.systemJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},i=await ejs_1.default.renderFile(path_1.join(templateDir,"game.ejs"),a);fs_extra_1.writeFileSync(path_1.join(t.paths.dir,SUB_PACKAGE_JS_NAME),i,"utf8")}function compileJS(e,t){let a;try{a=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${name} error: ${e.stack}`,e}return a.code}function sortSubPackage(e,t,a){for(const e of t.bundles){if(!e.isSubpackage)continue;const t=path_1.join(path_1.dirname(e.scriptDest),SUB_PACKAGE_JS_NAME);fs_extra_1.existsSync(e.scriptDest)?fs_extra_1.renameSync(e.scriptDest,t):fs_extra_1.outputFileSync(t,""),e.scriptDest=t}}function writeConfigFile(e,t,a){const i=t.packages["xiaomi-quick-game"],s=path_1.join(e,"manifest.json"),{versionName:r,versionCode:n,minPlatformVersion:o,logLevel:c,icon:p,deviceOrientation:l}=i,u={package:i.package,name:t.name,versionName:r,versionCode:n,minPlatformVersion:o,icon:"/"+ICON_NAME+path_1.extname(p),orientation:l,type:"game",config:{logLevel:c},display:{}},_=[];for(const e of a.bundles)e.isSubpackage&&_.push({name:"usr_"+e.name,root:`subpackages/${e.name}/`});_.length>0&&(u.subpackages=_);const m=s.replace(e,Paths.userTemplateDir);if(fs_extra_1.existsSync(m)){const e=fs_extra_1.readJSONSync(m);Object.assign(u,e)}fs_extra_1.outputJSONSync(s,u)}function handleSign(e,t,a,i){const s=path_1.join(e,"sign");if(fs_extra_1.emptyDirSync(s),!t){const e=path_1.join(s,"release");return fs_extra_1.ensureDirSync(e),fs_extra_1.existsSync(a)&&fs_extra_1.copySync(a,path_1.join(e,"private.pem")),void(fs_extra_1.existsSync(i)&&fs_extra_1.copySync(i,path_1.join(e,"certificate.pem")))}const r=path_1.join(s,"debug");fs_extra_1.ensureDirSync(r),fs_extra_1.copySync(getTemplatePath("certificate/certificate.pem"),path_1.join(r,"certificate.pem")),fs_extra_1.copySync(getTemplatePath("certificate/private.pem"),path_1.join(r,"private.pem"))}async function run(e,t){const a=t.packages["xiaomi-quick-game"],i=path_1.join(e,"dist",`${a.package}${a.useDebugKey?".debug.":".release."}rpk`);return fs_extra_1.existsSync(i)?(await Editor.Panel.open("xiaomi-quick-game.preview"),Editor.Message.send("xiaomi-quick-game","update-rpk-path",i),!0):(console.error(`xiaomi rpk (${i}) does not exist, please build before preview!`),!1)}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;