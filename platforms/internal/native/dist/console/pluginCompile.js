"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(i,e,t,o){void 0===o&&(o=t),Object.defineProperty(i,o,{enumerable:!0,get:function(){return e[t]}})}:function(i,e,t,o){void 0===o&&(o=t),i[o]=e[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),__importStar=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(null!=i)for(var t in i)"default"!==t&&Object.prototype.hasOwnProperty.call(i,t)&&__createBinding(e,i,t);return __setModuleDefault(e,i),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CCPluginCOMPILE=void 0;const cocosCli_1=require("./cocosCli"),path=__importStar(require("path")),cocosConfig_1=require("./cocosConfig"),fs=__importStar(require("fs-extra")),default_1=require("./default"),PackageNewConfig="cocos-project-template.json";class CCPluginCOMPILE extends cocosCli_1.CCPlugin{depends(){return default_1.PLUGIN_NAME_ENUM.GENERATE}init(){return!0}async run(){return await this.compilePlatform(this.getPlatform()),!0}async compilePlatform(i){let e=this.getCurrentPlatform(),t=cocosConfig_1.cocosConfig.availableTargetPlatforms[e];t?t.indexOf(i)<0?console.error(`target platform "${i}" is not listed [${t.join(", ")}]`):i===default_1.PLATFORM_ENUM.MAC?await this.compileMac():i==default_1.PLATFORM_ENUM.IOS?await this.compileIos():i==default_1.PLATFORM_ENUM.WIN32?await this.compileWin32():i==default_1.PLATFORM_ENUM.ANDROID?await this.compileAndroid():i==default_1.PLATFORM_ENUM["HUAWEI-AGC"]&&await this.compileAndroid():console.error(`current host platform ${e} is not supported.`)}async compileAndroid(){await new AndroidCompileCMD(this).compile()}async compileIos(){await new IOSCompileCMD(this).compile()}async compileMac(){await new MacCompileCMD(this).compile()}async compileWin32(){await new Win32CompileCMD(this).compile()}}exports.CCPluginCOMPILE=CCPluginCOMPILE;class PlatformCompileCmd{constructor(i){this.plugin=i}}class IOSCompileCMD extends PlatformCompileCmd{async compile(){let i=this.plugin.getBuildDir();return await this.plugin.runCmake(["--build",`${i}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-allowProvisioningUpdates","-quiet","-sdk iphonesimulator","-arch x86_64"]),!0}}class MacCompileCMD extends PlatformCompileCmd{async compile(){let i=this.plugin.getBuildDir();return await this.plugin.runCmake(["--build",`${i}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-quiet"]),!0}}class Win32CompileCMD extends PlatformCompileCmd{async compile(){let i=this.plugin.getBuildDir();return await this.plugin.runCmake(["--build",`${cocosCli_1.cchelper.fixPath(i)}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-verbosity:quiet"]),!0}}class AndroidCompileCMD extends PlatformCompileCmd{async compile(){this.plugin.getBuildDir();let i=path.join(this.plugin.projectDir,"proj");if(!fs.existsSync(i))return console.error(`dir ${i} not exits`),!1;let e="gradlew";"win32"==this.plugin.getCurrentPlatform()&&(e+=".bat"),e=path.join(i,e);let t="",o=this.plugin.args.debug?"Debug":"Release";return t=`${this.plugin.args.projectName}:assemble${o}`,await cocosCli_1.cchelper.runCmd(e,[t],!1,i),this.plugin.args.android.androidInstant&&(t=`assemble${o}`,await cocosCli_1.cchelper.runCmd(e,[t],!1,i)),this.plugin.args.android.appBundle&&(t=`bundle${o}`,await cocosCli_1.cchelper.runCmd(e,[t],!1,i)),await this.copyToDist()}async copyToDist(){let i=this.plugin.args.debug?"debug":"release",e=path.join(this.plugin.projectDir,"publish",i);fs.ensureDirSync(e);let t=`${this.plugin.args.projectName}-${i}.apk`,o=path.join(this.plugin.projectDir,`proj/build/${this.plugin.args.projectName}/outputs/apk/${i}/${t}`);if(!fs.existsSync(o))return console.error("apk not found at ",o),!1;if(fs.copyFileSync(o,path.join(e,t)),this.plugin.args.android.androidInstant){if(t=`instantapp-${i}.apk`,o=path.join(this.plugin.projectDir,`proj/build/instantapp/outputs/apk/${i}/${t}`),!fs.existsSync(o))return console.error("instant apk not found at ",o),!1;fs.copyFileSync(o,path.join(e,t))}if(this.plugin.args.android.appBundle){if(t=`${this.plugin.args.projectName}-${i}.aab`,o=path.join(this.plugin.projectDir,`proj/build/${this.plugin.args.projectName}/outputs/bundle/${i}/${t}`),!fs.existsSync(o))return console.error("instant apk not found at ",o),!1;fs.copyFileSync(o,path.join(e,t))}return!0}}