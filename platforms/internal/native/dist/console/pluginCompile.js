"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,o){void 0===o&&(o=t),Object.defineProperty(e,o,{enumerable:!0,get:function(){return i[t]}})}:function(e,i,t,o){void 0===o&&(o=t),e[o]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CCPluginCOMPILE=void 0;const cocosCli_1=require("./cocosCli"),path=__importStar(require("path")),cocosConfig_1=require("./cocosConfig"),fs=__importStar(require("fs-extra")),default_1=require("./default"),PackageNewConfig="cocos-project-template.json";class CCPluginCOMPILE extends cocosCli_1.CCPlugin{depends(){return default_1.PLUGIN_NAME_ENUM.GENERATE}init(){return!0}async run(){return await this.compilePlatform(this.getPlatform()),!0}async compilePlatform(e){const i=this.getCurrentPlatform(),t=cocosConfig_1.cocosConfig.availableTargetPlatforms[i];t?t.indexOf(e)<0?console.error(`target platform "${e}" is not listed [${t.join(", ")}]`):e===default_1.PLATFORM_ENUM.MAC?await this.compileMac():e===default_1.PLATFORM_ENUM.IOS?await this.compileIos():e===default_1.PLATFORM_ENUM.WIN32?await this.compileWin32():e===default_1.PLATFORM_ENUM.ANDROID?await this.compileAndroid():e===default_1.PLATFORM_ENUM["HUAWEI-AGC"]?await this.compileAndroid():e===default_1.PLATFORM_ENUM.OHOS&&await this.compileOHOS():console.error(`current host platform ${i} is not supported.`)}async compileAndroid(){await new AndroidCompileCMD(this).compile()}async compileIos(){await new IOSCompileCMD(this).compile()}async compileMac(){await new MacCompileCMD(this).compile()}async compileWin32(){await new Win32CompileCMD(this).compile()}async compileOHOS(){await new OHOSCompileCMD(this).compile()}}exports.CCPluginCOMPILE=CCPluginCOMPILE;class PlatformCompileCmd{constructor(e){this.plugin=e}}class IOSCompileCMD extends PlatformCompileCmd{async compile(){const e=this.plugin.getBuildDir(),i=require("os").cpus(),t=i&&i[0]&&i[0].model?i[0].model:"",o=/Apple/.test(t)?"-arch arm64":"-arch x86_64";return await this.plugin.runCmake(["--build",`${e}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-allowProvisioningUpdates","-quiet","-sdk iphonesimulator",o]),!0}}class MacCompileCMD extends PlatformCompileCmd{async compile(){const e=this.plugin.getBuildDir(),i=require("os").cpus(),t=i&&i[0]&&i[0].model?i[0].model:"",o=/Apple/.test(t)?"-arch arm64":"-arch x86_64";return await this.plugin.runCmake(["--build",`${e}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-quiet",o]),!0}}class Win32CompileCMD extends PlatformCompileCmd{async compile(){const e=this.plugin.getBuildDir();return await this.plugin.runCmake(["--build",`${cocosCli_1.cchelper.fixPath(e)}`,"--config",this.plugin.args.debug?"Debug":"Release","--","-verbosity:quiet"]),!0}}class AndroidCompileCMD extends PlatformCompileCmd{async compile(){this.plugin.getBuildDir();const e=path.join(this.plugin.projectDir,"proj");if(!fs.existsSync(e))return console.error(`dir ${e} not exits`),!1;let i="gradlew";"win32"===this.plugin.getCurrentPlatform()&&(i+=".bat"),i=path.join(e,i);let t="";const o=this.plugin.args.debug?"Debug":"Release";return t=`${this.plugin.args.projectName}:assemble${o}`,await cocosCli_1.cchelper.runCmd(i,[t],!1,e),this.plugin.args.android.androidInstant&&(t=`instantapp:assemble${o}`,await cocosCli_1.cchelper.runCmd(i,[t],!1,e)),this.plugin.args.android.appBundle&&(t=this.plugin.args.android.androidInstant?`bundle${o}`:`${this.plugin.args.projectName}:bundle${o}`,await cocosCli_1.cchelper.runCmd(i,[t],!1,e)),await this.copyToDist()}async copyToDist(){const e=this.plugin.args.debug?"debug":"release",i=path.join(this.plugin.projectDir,"publish",e);fs.ensureDirSync(i);let t=`${this.plugin.args.projectName}-${e}.apk`,o=path.join(this.plugin.projectDir,`proj/build/${this.plugin.args.projectName}/outputs/apk/${e}/${t}`);if(!fs.existsSync(o))return console.error("apk not found at ",o),!1;if(fs.copyFileSync(o,path.join(i,t)),this.plugin.args.android.androidInstant){if(t=`instantapp-${e}.apk`,o=path.join(this.plugin.projectDir,`proj/build/instantapp/outputs/apk/${e}/${t}`),!fs.existsSync(o))return console.error("instant apk not found at ",o),!1;fs.copyFileSync(o,path.join(i,t))}if(this.plugin.args.android.appBundle){if(t=`${this.plugin.args.projectName}-${e}.aab`,o=path.join(this.plugin.projectDir,`proj/build/${this.plugin.args.projectName}/outputs/bundle/${e}/${t}`),!fs.existsSync(o))return console.error("instant apk not found at ",o),!1;fs.copyFileSync(o,path.join(i,t))}return!0}}class OHOSCompileCMD extends PlatformCompileCmd{async compile(){cocosCli_1.cchelper.checkJavaHome();const e=this.plugin.platformTemplatePath;let i="gradlew";"win32"===this.plugin.getCurrentPlatform()&&(i+=".bat"),i=path.join(e,i);try{fs.accessSync(i,fs.constants.X_OK)}catch(e){fs.chmodSync(i,508)}let t="";return t=`assemble${this.plugin.args.debug?"Debug":"Release"}`,await cocosCli_1.cchelper.runCmd(i,[t],!1,e),!0}}