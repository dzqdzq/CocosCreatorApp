"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,a){void 0===a&&(a=i),e[a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CCPluginGENERATE=void 0;const cocosCli_1=require("./cocosCli"),os=__importStar(require("os")),cocosConfig_1=require("./cocosConfig"),childProcess=__importStar(require("child_process")),afs_1=require("./afs"),default_1=require("./default"),path=__importStar(require("path")),fs=__importStar(require("fs-extra")),PackageNewConfig="cocos-project-template.json";class CCPluginGENERATE extends cocosCli_1.CCPlugin{depends(){return null}init(){return cocosConfig_1.cocosConfig.platforms.indexOf(this.getPlatform())<0&&console.error(`invalidate platform "${this.getPlatform()}"`),!0}async run(){const e=this.parser.platform;if(e)await this.generatePlatform(e);else{const e=cocosConfig_1.cocosConfig.defaultGeneratePlatforms[this.getCurrentPlatform()];for(const t of e)await this.generatePlatform(t)}return!0}async generatePlatform(e){const t=this.getCurrentPlatform();e===default_1.PLATFORM_ENUM.IOSSIMULATOR&&(e=default_1.PLATFORM_ENUM.IOS,this.setPlatform(default_1.PLATFORM_ENUM.IOS),this.extendArgv(["--ios-simulator"]),this.args.ios.simulator=!0);const i=cocosConfig_1.cocosConfig.availableTargetPlatforms[t];i?i.indexOf(e)<0?console.error(`target platform "${e}" is not listed [${i.join(", ")}]`):e===default_1.PLATFORM_ENUM.MAC?await this.generateMac():e===default_1.PLATFORM_ENUM.IOS?await this.generateIos():e===default_1.PLATFORM_ENUM.WINDOWS?await this.generateWindows():e===default_1.PLATFORM_ENUM.ANDROID?await this.generateAndroid():e===default_1.PLATFORM_ENUM["HUAWEI-AGC"]&&await this.generateAndroid():console.error(`current host platform ${t} is not supported.`)}async generateAndroid(){console.log("generate android")}async generateIos(){await new IOSGenerateCMD(this).generate()}async generateMac(){await new MacGenerateCMD(this).generate()}async generateWindows(){await new WindowsGenerateCMD(this).generate()}}exports.CCPluginGENERATE=CCPluginGENERATE;class PlatformGenerateCmd{constructor(e){this.plugin=e}get projectSrcDir(){return path.join(this.plugin.projectDir,"..",`common-${this.plugin.args.templateName}`)}appendCmakeResDirArgs(e){e.push(`-DRES_DIR="${cocosCli_1.cchelper.fixPath(this.plugin.projectDir)}"`)}}class IOSGenerateCMD extends PlatformGenerateCmd{async generate(){const e=this.plugin.getBuildDir(),t=path.join(this.plugin.platformTemplatePath,"CMakeLists.txt");if(!fs.existsSync(t))throw new Error(`CMakeLists.txt not found in ${t}`);fs.existsSync(e)||cocosCli_1.cchelper.makeDirectoryRecursive(e);const i=["-DCMAKE_CXX_COMPILER=clang++","-DCMAKE_C_COMPILER=clang"],a=this.plugin.getAppTeamId();a&&i.push(`-DDEVELOPMENT_TEAM=${a}`),this.appendCmakeResDirArgs(i);return await this.plugin.runCmake(["-S",`${this.plugin.platformTemplatePath}`,"-GXcode",`-B${e}`,"-DCMAKE_SYSTEM_NAME=iOS"].concat(i)),!0}}class MacGenerateCMD extends PlatformGenerateCmd{async generate(){const e=this.plugin.getBuildDir(),t=path.join(this.plugin.platformTemplatePath,"CMakeLists.txt");if(!fs.existsSync(t))throw new Error(`CMakeLists.txt not found in ${t}`);fs.existsSync(e)||cocosCli_1.cchelper.makeDirectoryRecursive(e);const i=["-S",`${this.plugin.platformTemplatePath}`,"-GXcode",`-B${e}`,"-DCMAKE_SYSTEM_NAME=Darwin"];return this.appendCmakeResDirArgs(i),await this.plugin.runCmake(i),!0}}class WindowsGenerateCMD extends PlatformGenerateCmd{async windowsSelectCmakeGeneratorArgs(){console.log("selecting visual studio generator ...");const e=cocosConfig_1.cocosConfig.cmake.windows.generators,t=await afs_1.afs.mkdtemp(path.join(os.tmpdir(),"cmakeTest_")),i=path.join(t,"CMakeLists.txt"),a=path.join(t,"test.cpp");{const e="\n            cmake_minimum_required(VERSION 3.8)\n            set(APP_NAME test-cmake)\n            project(${APP_NAME} CXX)\n            add_library(${APP_NAME} test.cpp)\n            ",t='\n            #include<iostream>\n            int main(int argc, char **argv)\n            {\n                std::cout << "Hello World" << std::endl;\n                return 0;\n            }\n            ';await afs_1.afs.writeFile(i,e),await afs_1.afs.writeFile(a,t)}const r=(e,t)=>new Promise((i,a)=>{childProcess.spawn(this.plugin.getCmakePath(),e,{cwd:t,env:process.env,shell:!0}).on("close",(e,t)=>{i(0===e)})}),s=[];for(const i of e){const e=path.join(t,`build_${i.G.replace(/ /g,"_")}`),a=[`-S"${t}"`,`-G"${i.G}"`,`-B"${e}"`];if(a.push("-A",this.plugin.args.win.targetPlatform),await afs_1.afs.mkdir(e),await r(a,e)){s.push(i.G);break}await cocosCli_1.cchelper.removeDirectoryRecursive(e)}await cocosCli_1.cchelper.removeDirectoryRecursive(t);const n=[];if(0===s.length)return[];const o=e.filter(e=>e.G===s[0])[0];return n.push("-A",this.plugin.args.win.targetPlatform),console.log(` using ${o.G}`),n}async generate(){const e=this.plugin.getBuildDir(),t=path.join(this.plugin.platformTemplatePath,"CMakeLists.txt");if(!fs.existsSync(t))throw new Error(`CMakeLists.txt not found in ${t}`);fs.existsSync(e)||cocosCli_1.cchelper.makeDirectoryRecursive(e);let i=[];if(!fs.existsSync(path.join(e,"CMakeCache.txt"))){const e=this.plugin.getCmakeGenerator();if(e){const t=cocosConfig_1.cocosConfig.cmake.windows.generators.filter(t=>t.G.toLowerCase()===e.toLowerCase());if(0===t.length)i.push(`-G"${e}"`);else{t[0];i.push("-A",this.plugin.args.win.targetPlatform)}}else i=i.concat(await this.windowsSelectCmakeGeneratorArgs());this.appendCmakeResDirArgs(i)}return await this.plugin.runCmake([`-S"${cocosCli_1.cchelper.fixPath(this.plugin.platformTemplatePath)}"`,`-B"${cocosCli_1.cchelper.fixPath(e)}"`].concat(i)),!0}}