"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeConsole=exports.cchelper=exports.EXT_LIST=exports.CCPlugin=exports.pa=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),ml=__importStar(require("./multiLanguage")),cocosConfig_1=require("./cocosConfig"),os=__importStar(require("os")),afs_1=require("./afs"),childProcess=__importStar(require("child_process")),default_1=require("./default"),editor=__importStar(require("editor")),iconv=require("iconv-lite");var ArgumentItemType;!function(e){e[e.BOOLFLAG=0]="BOOLFLAG",e[e.STRINGVALUE=1]="STRINGVALUE",e[e.ACTION=2]="ACTION",e[e.ENUM=3]="ENUM"}(ArgumentItemType||(ArgumentItemType={})),exports.pa={help:{short:"-h",long:"--help",help:"show this message",argType:ArgumentItemType.ACTION},srcDir:{short:"-s",long:"--src",help:ml.getString("COCOSHELPARGSRC"),argType:ArgumentItemType.STRINGVALUE},quiet:{short:"-q",long:"--quiet",help:ml.getString("COCOSHELPARGPLATFORM"),argType:ArgumentItemType.BOOLFLAG},platform:{short:"-p",long:"--platform",help:ml.getString("COCOSHELPARGPLATFORM"),argType:ArgumentItemType.ENUM,enumValues:cocosConfig_1.cocosConfig.platforms},doListPlatforms:{short:"",long:"--list-platforms",help:"list available platforms",argType:ArgumentItemType.ACTION},projDir:{short:"",long:"--proj-dir",help:ml.getString("COCOSHELPARGPROJDIR"),argType:ArgumentItemType.STRINGVALUE},buildDir:{short:"",long:"--build-dir",help:"specify directory where to build project",argType:ArgumentItemType.STRINGVALUE},packageName:{short:"-p",long:"--package",help:ml.getString("NEWARGPACKAGE"),argType:ArgumentItemType.STRINGVALUE},directory:{short:"-d",long:"--directory",help:ml.getString("NEWARGDIR"),argType:ArgumentItemType.STRINGVALUE},iosBundleid:{short:"",long:"--ios-bundleid",help:ml.getString("NEWARGIOSBUNDLEID"),argType:ArgumentItemType.STRINGVALUE},macBundleid:{short:"",long:"--mac-bundleid",help:ml.getString("NEWARGMACBUNDLEID"),argType:ArgumentItemType.STRINGVALUE},enginePath:{short:"-e",long:"--engine-path",help:ml.getString("NEWARGENGINEPATH"),argType:ArgumentItemType.STRINGVALUE},portrait:{short:"",long:"--portrait",help:ml.getString("NEWARGPORTRAIT"),argType:ArgumentItemType.BOOLFLAG},noNative:{short:"",long:"--no-native",help:ml.getString("NEWARGNONATIVE"),argType:ArgumentItemType.BOOLFLAG},language:{short:"-l",long:"--language",help:ml.getString("NEWARGLANG"),argType:ArgumentItemType.ENUM,enumValues:cocosConfig_1.cocosConfig.languages},doListTemplates:{short:"",long:"--list-templates",help:"List available templates. To be used with --template option.",argType:ArgumentItemType.ACTION},templateName:{short:"-k",long:"--template-name",help:"Name of the template to be used to create the game. To list available names, use --list-templates.",argType:ArgumentItemType.STRINGVALUE},cmakeGenerator:{short:"-G",long:"--cmake-generator",help:"Set cmake generator",argType:ArgumentItemType.STRINGVALUE},cmakePath:{short:"",long:"--cmake-path",help:"path to cmake.exe or cmake",argType:ArgumentItemType.STRINGVALUE},iosSimulator:{short:"",long:"--ios-simulator",help:"enable iOS simulator support",argType:ArgumentItemType.BOOLFLAG},teamid:{short:"",long:"--team-id",help:"Apple developer team id",argType:ArgumentItemType.STRINGVALUE},sharedDir:{short:"",long:"--shared-dir",help:"Shared source directory",argType:ArgumentItemType.STRINGVALUE}};class CCPlugin{constructor(e){this._cocos2dPath=null,this._templatePath=null,this._pluginName=null,this.extArgs=[],this.parser=e,this.nativeTemplateDir=path.join(Editor.Project.path,"native","engine"),this.platformTemplatePath=path.join(this.nativeTemplateDir,this.parser.platform)}extendArgv(e){this.extArgs=this.extArgs.concat(e)}getCocosRoot(){let e=this.getEnginePath();return e||(this._cocos2dPath||(this._cocos2dPath=path.join(__dirname,"../../.."),fs.existsSync(path.join(this._cocos2dPath,"cocos"))||(console.warn(ml.getString("COCOS_WARNING_ENGINE_NOT_FOUND")),this._cocos2dPath=null)),this._cocos2dPath)}getConsleRoot(){let e=this.getEnginePath();return e?path.join(e,"tools/cocos-console"):path.join(__dirname,"..")}getTemplatesRootPath(){let e=this.getEnginePath();if(e)return path.join(e,"templates");if(!this._templatePath){let e=this.getCocosRoot();this._templatePath=e?path.join(e,"templates"):null}return this._templatePath}get projectDir(){let e=this.args.directory;return cchelper.replaceEnvVariables(e)}getCmakeGenerator(){return this.args.cmakeGenerator}getBuildDir(){return this.args.buildDir}getCmakePath(){let e=this.args.cmakePath;return e||`${path.join(editor.App.path,"../tools/cmake/bin/cmake")}${"win32"===process.platform?".exe":""}`}enableIosSimulator(){return this.args.ios.simulator}getAppTeamId(){return this.args.teamid}async runCmake(e){return new Promise((t,r)=>{console.log(`run cmake with ${e.join(" ")}`);let a=childProcess.spawn(this.getCmakePath(),e,{stdio:["pipe","pipe","pipe"],env:process.env,shell:!0});a.stdout.on("data",e=>{console.log(`[cmake] ${iconv.decode(e,"gbk").toString()}`)}),a.stderr.on("data",e=>{console.error(`[cmake-err] ${iconv.decode(e,"gbk").toString()}`)}),a.on("close",(a,i)=>{0===a?t():r(new Error(`run cmake failed "cmake ${e.join(" ")}", code: ${a}, signal: ${i}`))})})}doListPlatforms(){console.log("support platforms:");for(let e of cocosConfig_1.cocosConfig.platforms)console.log(` - ${e}`)}doShowHelp(){this.parser}setEnv(e,t){process.env[e]=t}getEnv(e){return process.env[e]}getCurrentPlatform(){let e=os.platform();return"darwin"===e?default_1.PLATFORM_ENUM.MAC:"win32"==e?default_1.PLATFORM_ENUM.WIN32:(console.warn(`platform ${e} is not supported!`),default_1.PLATFORM_ENUM.UNKNOWN)}getEnginePath(){return this.args.enginePath}getTemplatesDirNames(){let e=this.getTemplatesRootPath(),t=[];return e&&(t=(t=fs.readdirSync(e).filter(e=>!e.startsWith("."))).filter(t=>{let r=path.join(e,t);return fs.statSync(r).isDirectory()})),t}getTemplateDirPaths(){let e=this.getTemplatesRootPath();return this.getTemplatesDirNames().map(t=>path.join(e,t))}getPlatform(){let e=this.parser.platform;return e||(e=this.getCurrentPlatform(),console.log(`platform not specified, use current platform ${e}`)),e}setPlatform(e){this.parser.platform=e}getPluginName(){return this._pluginName}setPluginName(e){this._pluginName=e}async exec(){console.log(`[plugin ${this.getPluginName()}]: running ...`),this.init(),await this.run(),console.log(`  [plugin ${this.getPluginName()}]: done!`)}get args(){return this.parser}}exports.CCPlugin=CCPlugin,exports.EXT_LIST=[".js",".ccc",".ccd",".jsg",".jsc"];class cchelper{static replaceEnvVariables(e){return e.replace(/\$\{([^\}]*)\}/g,(e,t)=>void 0==process.env[t]?e:process.env[t]).replace(/(\~)/g,(e,t)=>process.env.HOME)}static fixPath(e){return e=this.replaceEnvVariables(e),"win32"==os.platform()?(e.indexOf(" ")>=0&&console.error(`space found in path "${e}"`),e.replace(/\\/g,"/").replace(/\/+/,"/")):e}static async delay(e){return new Promise((t,r)=>{setTimeout(async()=>{t()},e)})}static join(e,...t){let r=t.map(e=>this.replaceEnvVariables(e));return path.isAbsolute(r[r.length-1])?r[r.length-1]:path.join(this.replaceEnvVariables(e),...t)}static copyFileSync(e,t,r,a){e=this.replaceEnvVariables(e),t=this.replaceEnvVariables(t),r=this.replaceEnvVariables(r),a=this.replaceEnvVariables(a);let i=path.isAbsolute(t)?t:path.join(e,t),s=path.isAbsolute(a)?a:path.join(r,a);this.makeDirectoryRecursive(path.dirname(s)),fs.copyFileSync(i,s)}static async copyFileAsync(e,t){this.makeDirectoryRecursive(path.parse(t).dir),await afs_1.afs.copyFile(e,t)}static async copyRecursiveAsync(e,t){e=this.replaceEnvVariables(e),t=this.replaceEnvVariables(t);let r=[],a=await afs_1.afs.stat(e);if(a){if(a.isDirectory()){this.makeDirectoryRecursive(t);let a=await afs_1.afs.readdir(e);for(let i of a){if("."==i||".."==i)continue;let a=path.join(e,i),s=this.copyRecursiveAsync(a,path.join(t,i));r.push(s)}await Promise.all(r)}else if(a.isFile())try{await this.copyFileAsync(e,t)}catch(r){await this.delay(10),await this.copyFileAsync(e,t)}}else console.error(`failed to stat ${e}`)}static prepareDirsForFiles(e,t,r){let a={};for(let e of t){let t=e.split("/"),r=a;for(let e of t)r=e in r?r[e]:r[e]={}}let i=(e,t,r)=>{if(fs.statSync(e).isDirectory()){fs.existsSync(r)||fs.mkdirSync(r);for(let a in t)"."!==a&&".."!==a&&i(path.join(e,a),t[a],path.join(r,a))}};i(e,a,r)}static parallelCopyFiles(e,t,r,a){let i=0;return a=this.replaceEnvVariables(a),cchelper.prepareDirsForFiles(t,r,a),new Promise((s,o)=>{let n=async(e,t)=>{i+=1,await this.copyRecursiveAsync(e,t),i-=1,l()},l=()=>{if(r.length>0&&i<e){let e=r.shift(),i=path.join(t,e);fs.existsSync(i)?n(i,path.join(a,e)):console.warn(`warning: copyFile: ${i} not exists!`)}0==r.length&&0==i&&s()};for(let t=0;t<e;t++)l()})}static makeDirectoryRecursive(e){if(0==e.length)return;let t=[],r=e;for(;!fs.existsSync(r);)t.push(r),r=path.join(r,"..");for(;t.length>0;)fs.mkdirSync(t[t.length-1]),t.length=t.length-1}static async removeDirectoryRecursive(e){let t=await afs_1.afs.stat(e);if(t.isFile())await afs_1.afs.unlink(e);else if(t.isDirectory()){let t=await afs_1.afs.readdir(e),r=[];for(let a of t){if("."==a||".."==a)continue;let t=path.join(e,a);r.push(this.removeDirectoryRecursive(t))}await Promise.all(r),await afs_1.afs.rmdir(e)}}static async copyFilesWithConfig(e,t,r){if(!fs.existsSync(t))return void console.error(`copy file srcRoot ${t} is not exists!`);t=this.replaceEnvVariables(t),r=this.replaceEnvVariables(r);let a=this.replaceEnvVariables(e.from),i=this.replaceEnvVariables(e.to);path.isAbsolute(a)&&(t=a,a="."),path.isAbsolute(i)&&(r=i,i=".");let s=e=>{let t={},r=e.map(e=>Array.from(e));for(;r.length>0;){let e=r.shift(),a=t;for(;e.length>0;){let t=e.shift();t in a||(a[t]={}),a=a[t]}}return t},o=(e,t)=>{if(null==t)return!1;let r=Array.from(e),a=0,i=t;for(;r[a]in i;)i=i[r[a]],a++;return a==r.length&&0==Object.keys(i).length},n=e.include?s(e.include):null,l=e.exclude?s(e.exclude):null,p=async(e,t,r)=>{let a=path.join(e,t),i=await afs_1.afs.stat(a);if(i.isDirectory()){let i=await afs_1.afs.readdir(a),s=[];for(let a of i){if("."==a||".."==a)continue;let i=path.join(t,a);!l||!o(i,l)||n&&o(i,n)?s.push(p(e,i,r)):console.log(` - skip copy ${e} ${i} to ${r}`)}await Promise.all(s)}else i.isFile()&&await this.copyFileAsync(a,path.join(r,t))},c=(this.replaceEnvVariables(path.normalize(path.join(t,a))),this.replaceEnvVariables(path.normalize(path.join(r,i))));await p(t,a,c)}static async replaceInFile(e,t){if(t=this.replaceEnvVariables(t),!fs.existsSync(t))return;let r=(await afs_1.afs.readFile(t)).toString("utf8").split("\n").map(t=>(e.forEach(e=>{t=t.replace(new RegExp(e.reg),this.replaceEnvVariables(e.text))}),t)).join("\n");await afs_1.afs.writeFile(t,r)}static exactValueFromFile(e,t,r){if(!fs.existsSync(t))return void console.error(`file ${t} not exist!`);let a=fs.readFileSync(t).toString("utf-8").split("\n");for(let t of a){let a=t.match(e);if(a)return a[r]}}static async runCmd(e,t,r,a){return new Promise((i,s)=>{console.log(`[runCmd]: ${e} ${t.join(" ")}`);let o=childProcess.spawn(e,t,{shell:!0,env:process.env,cwd:a||process.cwd()});r||(o.stdout.on("data",t=>{console.log(`[runCmd ${e}] ${t}`)}),o.stderr.on("data",t=>{console.log(`[runCmd ${e} - error] ${t}`)})),o.on("close",(a,o)=>{if(0!=a&&!r)return s(`faile to exec ${e} ${t.join(" ")}`);i()})})}static existsSync(e){let t=path.extname(e),r=path.basename(e,t);return e=path.join(path.dirname(e),r),!!exports.EXT_LIST.find(t=>fs.existsSync(e+t))}}exports.cchelper=cchelper;class NativeConsole{constructor(e){this._params=e}loadPlugin(e){let t=null,r=path.join(__dirname,`plugin${e}`);if(!cchelper.existsSync(r))return console.error(`Plugin ${e} is not defined!`),t;let a=require(r),i=`CCPlugin${e.toUpperCase()}`;return i in a?((t=new a[i](this._params)).setPluginName(e),t):(console.error(`${i} not defined in plugin_${e}.js`),t)}async run(){let e,t=this._params.pluginName,r=[];do{e=this.loadPlugin(t),r.push(e)}while(null!==(t=e.depends()));for(let e=r.length-1;e>=0;e--)await r[e].exec()}}exports.NativeConsole=NativeConsole,process.on("unhandledRejection",(e,t)=>{console.error("----unhandledRejection---"),console.error(e)});