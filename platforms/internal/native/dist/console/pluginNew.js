"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TemplateCreator=exports.CCPluginNEW=void 0;const cocosCli_1=require("./cocosCli"),path=__importStar(require("path")),fs=__importStar(require("fs-extra")),cocosConfig_1=require("./cocosConfig"),afs_1=require("./afs"),default_1=require("./default"),URL=__importStar(require("url")),PackageNewConfig="cocos-project-template.json";let projectCONFIG={projectType:"js",hasNative:!0,customStepScript:null},COCOS2D_FILES_PATH="templates/cocos2dx_files.json";class CCPluginNEW extends cocosCli_1.CCPlugin{depends(){return null}init(){return this.setEnv("PROJECT_NAME",this.projectName),this.setEnv("COMMON_DIR",cocosCli_1.cchelper.join(this.sharedDir,this.commonDir)),this.setEnv("NATIVE_DIR",cocosCli_1.cchelper.join(this.sharedDir,this.args.platform)),this.projectDir&&!fs.existsSync(this.projectDir)&&cocosCli_1.cchelper.makeDirectoryRecursive(this.projectDir),!0}get commonDir(){return"common"}async run(){let e=new TemplateCreator(this);return await e.run(),!0}getEnginePath(){return this.args.enginePath}doListTemplates(){console.log("templates:");let e=this.getTemplatesDirNames();for(let t of e)console.log(` - ${t}/`)}get projectName(){return this.args.projectName}get projectDir(){return this.args.directory}get sharedDir(){return path.join(Editor.Project.path,"native","engine")}get enginePath(){return this.args.enginePath}get selectedTemplateDirName(){let e=this.args.templateName,t=this.getTemplatesDirNames();if(1==t.length)return t[0];let i=t.filter(t=>t===`template-${e}`);return 0==i.length&&console.error(`can not find template ${e} in ${t.join(",")}`),i[0]}get selectedTemplatePath(){if(!this.selectedTemplateDirName)return null;let e=cocosCli_1.cchelper.join(this.getTemplatesRootPath(),this.selectedTemplateDirName);fs.existsSync(e)||console.error(`selected template path not exists: ${e}`),fs.statSync(e).isDirectory()||console.error(`selected template path is not directory: ${e}`);let t=["main.js","project.json",PackageNewConfig,"frameworks"];for(let i of t)fs.existsSync(cocosCli_1.cchelper.join(e,i))||console.warn(`warning: file "${i}" does not exists in ${e}, template path can be incorrect setting!`);return e}}exports.CCPluginNEW=CCPluginNEW;class TemplateCreator{constructor(e){this.excludes=[],this.plugin=e;let t=e.args,i=e.getTemplatesRootPath();this.lang=t.language,this.cocosRoot=e.getCocosRoot(),this.projectName=t.projectName,this.projectDir=e.projectDir,this.packageName=t.android.packageName,this.tpName=t.templateName,this.enginePath=t.enginePath,this.tpDir=i,cocosConfig_1.cocosConfig.supportTemplates.indexOf(this.tpName)<0&&console.error(`template name "${this.tpName}" is not supported!`),fs.existsSync(cocosCli_1.cchelper.join(this.tpDir,PackageNewConfig))?this.templateInfo=JSON.parse(fs.readFileSync(cocosCli_1.cchelper.join(this.tpDir,PackageNewConfig)).toString("utf8")):console.error(`can not find ${PackageNewConfig} in ${this.tpDir}`)}async doPostSteps(){await this.setOrientation(),await this.updateAndroidGradleValues(),await this.configAndroidInstant()}async configAndroidInstant(){if(!this.plugin.args.android.androidInstant)return void console.log("android instant not configured");let e=this.plugin.args.android.remoteUrl;if(!e)return;let t=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"instantapp/AndroidManifest.xml");if(!fs.existsSync(t))return void console.error(`${t} not found`);let i=URL.parse(e);if(!i.host)return void console.error(`parse url ${e} fail`);let r=fs.readFileSync(t,"utf8");r=r.replace(/<category\s*android:name="android.intent.category.DEFAULT"\s*\/>/,e=>{let t='<category android:name="android.intent.category.DEFAULT" />';return t+=`\n                <data android:host="${i.host}" android:pathPattern="${i.path}" android:scheme="https"/>`+'\n                <data android:scheme="http"/>'}),fs.writeFileSync(t,r,"utf8")}async run(){let e=this.plugin.args.platform,t=path.join(this.plugin.nativeTemplateDir,this.plugin.commonDir);fs.copySync(path.join(this.tpDir,"common"),t,{overwrite:!1}),e===default_1.PLATFORM_ENUM["HUAWEI-AGC"]&&(e=default_1.PLATFORM_ENUM.ANDROID);let i=path.join(this.tpDir,e);if(e===default_1.PLATFORM_ENUM.ANDROID){i=path.join(i,"template");let t=path.join(this.projectDir,"proj");fs.copySync(path.join(this.tpDir,e,"build"),t,{overwrite:!1})}e&&!fs.existsSync(this.plugin.platformTemplatePath)&&fs.copySync(i,this.plugin.platformTemplatePath,{overwrite:!1});for(let e in this.templateInfo)await this.execute(this.templateInfo[e]);await this.doPostSteps(),this.generateCMakeConfig()}generateCMakeConfig(){const e=path.join(this.plugin.projectDir,"proj","cfg.cmake");let t="";const i=this.plugin.args.cMakeConfig;Object.keys(i).forEach(e=>{t+=i[e]+"\n"}),console.debug(`generateCMakeConfig, ${JSON.stringify(i)}`),fs.outputFileSync(e,t)}async setOrientation(){let e=this.plugin.args;if((e.platform==default_1.PLATFORM_ENUM.IOS||e.platform===default_1.PLATFORM_ENUM.IOSSIMULATOR)&&e.ios){let t=e.ios.orientation,i=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"Info.plist");if(fs.existsSync(i)){let e=[];t.landscapeRight&&e.push("UIInterfaceOrientationLandscapeRight"),t.landscapeLeft&&e.push("UIInterfaceOrientationLandscapeLeft"),t.portrait&&e.push("UIInterfaceOrientationPortrait"),t.upsideDown&&e.push("UIInterfaceOrientationPortraitUpsideDown");let r=`\t<key>UISupportedInterfaceOrientations</key>\n\t<array>\n${e.map(e=>`\t\t<string>${e}</string>\n`).join("")}\n\t</array>`,o=[],a=fs.readFileSync(i).toString("utf-8").split("\n"),n=0,s=0;for(let e=0;e<a.length;e++)if(a[e].indexOf("UISupportedInterfaceOrientations")>=0){for(n+=1,e++;e<a.length&&a[e].indexOf("</array>")<0;)e++;a[e].indexOf("</array>")>=0&&(s+=1),o.push(r)}else o.push(a[e]);1!=n||1!=s?console.error("error occurs while setting orientations for iOS"):await afs_1.afs.writeFile(i,o.join("\n"))}}if(e.platform==default_1.PLATFORM_ENUM.ANDROID&&e.android){let t=e.android.orientation,i=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"app/AndroidManifest.xml"),r=cocosCli_1.cchelper.join(this.plugin.platformTemplatePath,"instantapp/AndroidManifest.xml");if(fs.existsSync(i)&&fs.existsSync(r)){let e=/android:screenOrientation=\"[^"]*\"/,o='android:screenOrientation="unspecified"';if(t.landscapeRight&&t.landscapeLeft&&t.portrait&&t.upsideDown)o='android:screenOrientation="fullSensor"';else if(t.landscapeRight&&!t.landscapeLeft)o='android:screenOrientation="landscape"';else if(!t.landscapeRight&&t.landscapeLeft)o='android:screenOrientation="reverseLandscape"';else if(t.landscapeRight&&t.landscapeLeft)o='android:screenOrientation="sensorLandscape"';else if(t.portrait&&!t.upsideDown)o='android:screenOrientation="portrait"';else if(!t.portrait&&t.upsideDown){o=`android:screenOrientation="${"reversePortrait"}"`}else if(t.portrait&&t.upsideDown){o=`android:screenOrientation="${"sensorPortrait"}"`}let a=await afs_1.afs.readFile(i,"utf8");a=a.replace(e,o);let n=await afs_1.afs.readFile(r,"utf8");n=n.replace(e,o),await afs_1.afs.writeFile(i,a),await afs_1.afs.writeFile(r,n)}}}async updateAndroidGradleValues(){let e=this.plugin.args;if(!e)return;console.log("update gradle.prperties");let t=cocosCli_1.cchelper.join(this.projectDir,"proj/gradle.properties");if(fs.existsSync(t)){let i=e.android.keyStorePath;this.plugin.getCurrentPlatform()==default_1.PLATFORM_ENUM.WIN32&&(i=cocosCli_1.cchelper.fixPath(i));let r=e.android.apiLevel;r||(r=27),console.log(`AndroidAPI level ${r}`);let o=fs.readFileSync(t,"utf-8");o=(o=(o=(o=(o=(o=i?(o=(o=(o=o.replace(/.*RELEASE_STORE_FILE=.*/,`RELEASE_STORE_FILE=${i}`)).replace(/.*RELEASE_STORE_PASSWORD=.*/,`RELEASE_STORE_PASSWORD=${e.android.keystorePassword}`)).replace(/.*RELEASE_KEY_ALIAS=.*/,`RELEASE_KEY_ALIAS=${e.android.keystoreAlias}`)).replace(/.*RELEASE_KEY_PASSWORD=.*/,`RELEASE_KEY_PASSWORD=${e.android.keystoreAliasPassword}`):(o=(o=(o=o.replace(/.*RELEASE_STORE_FILE=.*/,`# RELEASE_STORE_FILE=${i}`)).replace(/.*RELEASE_STORE_PASSWORD=.*/,`# RELEASE_STORE_PASSWORD=${e.android.keystorePassword}`)).replace(/.*RELEASE_KEY_ALIAS=.*/,`# RELEASE_KEY_ALIAS=${e.android.keystoreAlias}`)).replace(/.*RELEASE_KEY_PASSWORD=.*/,`# RELEASE_KEY_PASSWORD=${e.android.keystoreAliasPassword}`)).replace(/PROP_TARGET_SDK_VERSION=.*/,`PROP_TARGET_SDK_VERSION=${r}`)).replace(/PROP_COMPILE_SDK_VERSION=.*/,`PROP_COMPILE_SDK_VERSION=${r}`)).replace(/RES_PATH=.*/,`RES_PATH=${cocosCli_1.cchelper.fixPath(this.projectDir)}`)).replace(/COCOS_ENGINE_PATH=.*/,`COCOS_ENGINE_PATH=${cocosCli_1.cchelper.fixPath(this.plugin.getEnginePath())}`)).replace(/APPLICATION_ID=.*/,`APPLICATION_ID=${this.plugin.args.android.packageName}`),"win32"===process.platform&&(e.android.ndkPath=e.android.ndkPath.replace(/\\/g,"\\\\")),o=o.replace(/PROP_NDK_PATH=.*/,`PROP_NDK_PATH=${e.android.ndkPath}`);let a=e.android.appABIs&&e.android.appABIs.length>0?e.android.appABIs.join(":"):"armeabi-v7a";o=o.replace(/PROP_APP_ABI=.*/g,`PROP_APP_ABI=${a}`),fs.writeFileSync(t,o),o="",o+=`sdk.dir=${e.android.sdkPath}`,"win32"===process.platform&&(o=(o=o.replace(/\\/g,"\\\\")).replace(/:/g,"\\:")),fs.writeFileSync(cocosCli_1.cchelper.join(path.dirname(t),"local.properties"),o)}else console.log(`warning: ${t} not found!`)}get cocos2dxFiles(){return fs.readJSONSync(path.join(this.enginePath,COCOS2D_FILES_PATH))}async execute(e){e.appendFile&&(e.appendFile.forEach(e=>{let t=cocosCli_1.cchelper.replaceEnvVariables(e.to);fs.ensureDirSync(path.dirname(t)),fs.copySync(path.join(this.cocosRoot,e.from),t)}),delete e.appendFile),e.excludeFromTemplate&&delete e.excludeFromTemplate;let t=e.appendXEngine;if(e.appendXEngine&&"link"!=this.tpName){let t=cocosCli_1.cchelper.replaceEnvVariables(e.appendXEngine.to),i=path.isAbsolute(t)?t:cocosCli_1.cchelper.join(this.projectDir,t);this.cocos2dxFiles.common.forEach(e=>{let t=path.join(i,e);fs.ensureDirSync(path.dirname(t)),fs.copySync(path.join(this.cocosRoot,e),t)}),this.lang===default_1.LANGUAGE.JS&&this.cocos2dxFiles.js.forEach(e=>{let t=path.join(i,e);fs.ensureDirSync(path.dirname(t)),fs.copySync(path.join(this.cocosRoot,e),t)})}delete e.appendXEngine;let i={};if(e.projectReplaceProjectName){let t=e.projectReplaceProjectName;t.files.forEach(e=>{let r=cocosCli_1.cchelper.join(this.projectDir,e);i[r]=i[r]||[],i[r].push({reg:t.srcProjectName,content:this.projectName})}),delete e.projectReplaceProjectName}if(e.projectReplacePackageName){let t=e.projectReplacePackageName,r=t.srcPackageName.replace(/\./g,"\\.");t.files.forEach(e=>{let t=cocosCli_1.cchelper.join(this.projectDir,e);i[t]=i[t]||[],i[t].push({reg:r,content:this.packageName})}),delete e.projectReplacePackageName}if(e.projectReplaceMacBundleid){let t=e.projectReplaceMacBundleid,r=t.srcBundleId.replace(/\./g,"\\.");t.files.forEach(e=>{let t=cocosCli_1.cchelper.join(this.projectDir,e);i[t]=i[t]||[],i[t].push({reg:r,content:this.plugin.args.mac.bundleId})}),delete e.projectReplaceMacBundleid}if(e.projectReplaceIosBundleid){let t=e.projectReplaceIosBundleid,r=t.srcBundleId.replace(/\./g,"\\.");t.files.forEach(e=>{let t=cocosCli_1.cchelper.join(this.projectDir,e);i[t]=i[t]||[],i[t].push({reg:r,content:this.plugin.args.ios.bundleId})}),delete e.projectReplaceIosBundleid}if(e.projectReplaceCocosRoot){let r=e.projectReplaceCocosRoot,o=path.normalize(this.cocosRoot),a=path.normalize(cocosCli_1.cchelper.join(this.projectDir,t.to));for(let e of r.files){let t="string"==typeof e?e:e.file,n=cocosCli_1.cchelper.join(this.projectDir,t),s=i[n]=i[n]||[];if("link"==this.tpName){let t="string"==typeof e.link?e.link:o;t=cocosCli_1.cchelper.fixPath(t),s.push({reg:r.pattern,content:t})}else{let t=path.relative(n,a),i=e.default?e.default:t;i=cocosCli_1.cchelper.fixPath(i),s.push({reg:r.pattern,content:i})}}delete e.projectReplaceCocosRoot}if(e.projectReplaceTemplatePath){let t=e.projectReplaceTemplatePath;for(let e in t.files){let r=t.files[e];r=cocosCli_1.cchelper.join(this.projectDir,r),(i[r]=i[r]||[]).push({reg:t.pattern,content:cocosCli_1.cchelper.fixPath(this.plugin.platformTemplatePath)})}delete e.projectReplaceTemplatePath}if(e.projectReplaceProjectCommon){let t=e.projectReplaceProjectCommon,r=(path.normalize(this.cocosRoot),cocosCli_1.cchelper.join(this.projectDir,this.plugin.commonDir));for(let e of t.files){let o="string"==typeof e?e:e.file,a=cocosCli_1.cchelper.join(this.projectDir,o),n=i[a]=i[a]||[],s=path.relative(a,r);n.push({reg:t.pattern,content:cocosCli_1.cchelper.fixPath(s)})}delete e.projectReplaceProjectCommon}if(e.commonReplace){for(let t of e.commonReplace)for(let e of t.files){let r=cocosCli_1.cchelper.join(this.projectDir,e);i[r]=i[r]||[],i[r].push({reg:t.pattern,content:t.value})}delete e.commonReplace}for(let e in i){let t=i[e];await cocosCli_1.cchelper.replaceInFile(t.map(e=>({reg:e.reg,text:e.content})),e)}if(Object.keys(e).length>0)for(let t in e)console.error(`command "${t}" is not parsed in ${PackageNewConfig}`)}}exports.TemplateCreator=TemplateCreator;