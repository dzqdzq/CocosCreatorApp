"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.replaceTeaKeyForGame=exports.run=exports.make=exports.encryptJsForNative=exports.setEncryptConfig=exports.onAfterBuild=exports.generateNativeProject=exports.copyNativeTemplates=exports.onBeforeBuild=exports.throwError=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),zlib_1=require("zlib"),index_1=require("./native-utils/index"),Editor=__importStar(require("editor")),ejs_1=__importDefault(require("ejs")),default_1=require("../../console/default"),cocosCli_1=require("../../console/cocosCli"),os_1=__importDefault(require("os")),xxtea=require("xxtea-node"),path=require("path");function fixPath(e){return"win32"==os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}async function onBeforeBuild(e,t){const{nativePath:a}=await Editor.Message.request("engine","query-info");let i;index_1.Path._root=e.packages.native.engine||a,console.debug("Native engine root:"+index_1.Path._root),e.includeModules=e.includeModules.filter(e=>!["gfx-webgl2","gfx-webgl"].includes(e)),Object.assign(e.appTemplateData,{isSetOrientation:!0,showFPS:!1}),Object.assign(e.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const r=await getBrowserslistQuery(index_1.Path._root);r&&(i=r),e.buildScriptParam.polyfills=e.packages.native.polyfills,i&&(e.buildEngineParam.targets=i,e.buildScriptParam.targets=i,e.buildScriptParam.polyfills||(e.buildScriptParam.polyfills={}),e.buildScriptParam.polyfills.targets=i,"asyncFunctions"in e.buildScriptParam.polyfills&&delete e.buildScriptParam.polyfills.asyncFunctions),e.buildScriptParam.system={preset:"commonjs-like"},t.paths.dir=path_1.join(t.paths.dir,"assets");const o=t.paths.dir;t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS)),window.__manager.taskManager.debug||await fs_extra_1.emptyDirSync(o),await index_1.outputJSBAdapter(o,{targets:i})}async function genConsoleParams(e,t,a){let i=new default_1.ConsoleParams;i.pluginName=a;const r=t.paths.dir,o=path_1.dirname(r),n=e.name;i.enginePath=await index_1.Path.queryNativeEnginePath(),i.projectName=n,i.cMakeConfig.APP_NAME=`set(APP_NAME ${n})`,i.cMakeConfig.COCOS_X_PATH=`set(COCOS_X_PATH "${fixPath(i.enginePath)}")`;const s=e.packages;let l=`com.cocos.${n}`;const d=[];let p;i.debug=e.debug,s.android&&(s["huawei-agc"]?d.push("huawei-agc"):d.push("android"),i.android.ndkPath=s.android.ndkPath,i.android.sdkPath=s.android.sdkPath,i.android.androidInstant=s.android.androidInstant,i.android.remoteUrl=s.android.remoteUrl,i.android.packageName=s.android.packageName),s.ios&&d.push("ios"),s.windows&&d.push("win32"),s.mac&&d.push("mac"),s.android&&s.android.packageName&&(l=s.android.packageName,i.android.appBundle=s.android.appBundle,i.android.orientation=s.android.orientation,i.android.appABIs=s.android.appABIs,s.android.useDebugKeystore?(i.android.keyStorePath=path_1.join(Editor.App.path,"../tools/keystore/debug.keystore"),i.android.keystoreAlias="debug_keystore",i.android.keystorePassword="123456",i.android.keystoreAliasPassword="123456"):(i.android.keyStorePath=s.android.keystorePath,i.android.keystoreAliasPassword=s.android.keystoreAliasPassword,i.android.keystorePassword=s.android.keystorePassword,i.android.keystoreAlias=s.android.keystoreAlias)),1===d.length?p=d[0]:console.error(`Invalidate platform count ${d}`);const c=e.packages.native.template;let u=e.packages[e.platform].renderBackEnd;if("huawei-agc"===e.platform){let t="android";u=e.packages[t].renderBackEnd}u&&Object.keys(u).forEach(e=>{i.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=`set(CC_USE_${e.toUpperCase()} ${u[e]?"ON":"OFF"})`});const _=await Editor.Profile.getConfig("engine","modules.moduleConfig","default");Object.keys(_).forEach(t=>{_[t].native&&(i.cMakeConfig[_[t].native]=`set(${_[t].native} ${e.includeModules.includes(t)?"ON":"OFF"})`)});const f=o;return fs_extra_1.existsSync(f)||await fs_extra_1.mkdir(f),i.language=default_1.LANGUAGE.JS,i.directory=f,i.templateName=c,i.buildDir=path_1.join(o,"proj"),s.ios&&s.ios.packageName&&(i.ios.orientation=s.ios.orientation,i.ios.bundleId=s.ios.packageName,i.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${i.ios.bundleId})`),i.sharedDir=path_1.join(f,".."),p&&(i.platform=default_1.PLATFORM_ENUM[p.toUpperCase()]),s.mac&&s.mac.packageName&&(i.mac.bundleId=s.mac.packageName,i.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${i.mac.bundleId})`),i}async function copyNativeTemplates(e,t){let a=await genConsoleParams(e,t,default_1.PLUGIN_NAME_ENUM.NEW);await new cocosCli_1.NativeConsole(a).run()}async function generateNativeProject(e,t){let a=await genConsoleParams(e,t,default_1.PLUGIN_NAME_ENUM.GENERATE);await new cocosCli_1.NativeConsole(a).run(),t.compileOptions=a.toJSON(),fs_extra_1.outputJSONSync(path_1.join(a.directory,"cocos.compile.config.json"),a.toJSON())}async function onAfterBuild(e,t){const a=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(a)&&(fs_extra_1.copySync(a,path_1.dirname(t.paths.dir)),console.debug(`Use user build-template in {link(${a})}`)),fs_extra_1.ensureDirSync(path_1.join(t.paths.dir,"src"));const i=path_1.join(__dirname,"../../../static/build-template/index.ejs"),r={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},o=(await ejs_1.default.renderFile(i,r)).toString();await fs_extra_1.writeFile(path_1.join(t.paths.dir,"main.js"),o,"utf8")}async function setEncryptConfig(e,t){t.bundles.forEach(e=>{e.config.encrypted=!0})}async function encryptJsForNative(e,t){let a=path.join(Editor.Project.path,e.buildPath,e.outputName),i=path.join(a,"script-backup");fs_extra_1.ensureDirSync(i),fs_extra_1.emptyDirSync(i),t.bundles.forEach(a=>{let r=fs_extra_1.readFileSync(a.scriptDest,"utf8");e.packages.native.compressZip?(r=zlib_1.gzipSync(r),r=xxtea.encrypt(r,xxtea.toBytes(e.packages.native.xxteaKey))):r=xxtea.encrypt(xxtea.toBytes(r),xxtea.toBytes(e.packages.native.xxteaKey)),fs_extra_1.writeFileSync(path.join(path.dirname(a.scriptDest),path.basename(a.scriptDest,path.extname(a.scriptDest))+".jsc"),r),fs_extra_1.copySync(a.scriptDest,path.join(i,path.relative(t.paths.dir,a.scriptDest))),fs_extra_1.removeSync(a.scriptDest)})}async function make(e,t){t.pluginName=default_1.PLUGIN_NAME_ENUM.COMPILE,await new cocosCli_1.NativeConsole(t).run()}async function run(e,t){t.pluginName=default_1.PLUGIN_NAME_ENUM.RUN,await new cocosCli_1.NativeConsole(t).run()}async function getBrowserslistQuery(e){const t=path_1.join(e,".browserslistrc");let a;try{a=await fs_extra_1.readFile(t,"utf8")}catch(e){return}const i=function(e){const t=[];for(const a of e.split("\n")){const e=a.indexOf("#"),i=(e<0?a:a.substr(0,e)).trim();0!==i.length&&t.push(i)}return t}(a);if(0!==i.length)return i.join(" or ")}function replaceTeaKeyForGame(e,t){let a=path.join(Editor.Project.path,"native/engine/common","Classes/Game.cpp");if(!fs_extra_1.existsSync(a))return void console.warn(`Can't find path [${a}]`);let i=fs_extra_1.readFileSync(a,"utf8").split("\n");for(let t=0;t<i.length;t++){-1!==i[t].indexOf("jsb_set_xxtea_key")&&(i[t]=`    jsb_set_xxtea_key("${e.packages.native.xxteaKey}");`)}fs_extra_1.writeFileSync(a,i.join("\n"))}exports.throwError=!0,exports.onBeforeBuild=onBeforeBuild,exports.copyNativeTemplates=copyNativeTemplates,exports.generateNativeProject=generateNativeProject,exports.onAfterBuild=onAfterBuild,exports.setEncryptConfig=setEncryptConfig,exports.encryptJsForNative=encryptJsForNative,exports.make=make,exports.run=run,exports.replaceTeaKeyForGame=replaceTeaKeyForGame;