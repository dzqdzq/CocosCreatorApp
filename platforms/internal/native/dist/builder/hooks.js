"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.make=exports.onAfterBuild=exports.onAfterBuildAssets=exports.onBeforeBuildAssets=exports.onAfterInit=exports.throwError=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),index_1=require("./native-utils/index"),Editor=__importStar(require("editor")),ejs_1=__importDefault(require("ejs")),default_1=require("../console/default"),cocosCli_1=require("../console/cocosCli"),os_1=__importDefault(require("os")),encrypted_1=require("./encrypted"),path=require("path");function fixPath(e){return"win32"===os_1.default.platform()?e.replace(/\\/g,"/").replace(/\/+/,"/"):e}async function genConsoleParams(e,t,a){const i=new default_1.ConsoleParams;i.pluginName=a;const o=t.paths.dir,r=path_1.dirname(o),s=e.name;i.enginePath=await index_1.Path.queryNativeEnginePath(),i.projectName=s,i.cMakeConfig.APP_NAME=`set(APP_NAME ${s})`,i.cMakeConfig.COCOS_X_PATH=`set(COCOS_X_PATH "${fixPath(i.enginePath)}")`;const n=e.packages;let d=`com.cocos.${s}`;const c=[];let l;i.debug=e.debug,i.cMakeConfig.USE_JOB_SYSTEM_TASKFLOW="taskFlow"===n.native.JobSystem,i.cMakeConfig.USE_JOB_SYSTEM_TBB="tbb"===n.native.JobSystem,n.android&&(n["huawei-agc"]?c.push("huawei-agc"):c.push("android"),i.android.ndkPath=n.android.ndkPath,i.android.sdkPath=n.android.sdkPath,i.android.androidInstant=n.android.androidInstant,i.android.remoteUrl=n.android.remoteUrl,i.android.packageName=n.android.packageName,i.android.apiLevel=Number(n.android.apiLevel.match(/[1-9][0-9]/)[0])),n.ios&&(c.push("ios"),n.ios.developerTeam&&(i.cMakeConfig.DEVELOPMENT_TEAM=`set(DEVELOPMENT_TEAM ${n.ios.developerTeam})`),i.cMakeConfig.TARGET_IOS_VERSION=`set(TARGET_IOS_VERSION ${n.ios.targetVersion||"12.0"})`),n.windows&&(c.push("windows"),i.cMakeConfig.USE_SERVER_MODE=`set(USE_SERVER_MODE ${e.packages.windows.serverMode?"ON":"OFF"})`,i.win.targetPlatform=n.windows.targetPlatform),n.mac&&(c.push("mac"),i.cMakeConfig.TARGET_OSX_VERSION=`set(TARGET_OSX_VERSION ${n.mac.targetVersion||"10.14"})`),n.ohos&&(c.push("ohos"),i.ohos.ndkPath=n.ohos.ndkPath,i.ohos.sdkPath=n.ohos.sdkPath,i.ohos.packageName=n.ohos.packageName,i.ohos.orientation=n.ohos.orientation),n.android&&n.android.packageName&&(d=n.android.packageName,i.android.appBundle=n.android.appBundle,i.android.orientation=n.android.orientation,i.android.appABIs=n.android.appABIs,n.android.useDebugKeystore?(i.android.keyStorePath=path_1.join(Editor.App.path,"../tools/keystore/debug.keystore"),i.android.keystoreAlias="debug_keystore",i.android.keystorePassword="123456",i.android.keystoreAliasPassword="123456"):(i.android.keyStorePath=n.android.keystorePath,i.android.keystoreAliasPassword=n.android.keystoreAliasPassword,i.android.keystorePassword=n.android.keystorePassword,i.android.keystoreAlias=n.android.keystoreAlias)),n.ohos&&(i.ohos=n.ohos),1===c.length?l=c[0]:console.error(`Invalidate platforms "${c}", size ${c.length}.`);let p=e.packages[e.platform].renderBackEnd;if("huawei-agc"===e.platform){const t="android";p=e.packages[t].renderBackEnd}p&&Object.keys(p).forEach(e=>{i.cMakeConfig[`CC_USE_${e.toUpperCase()}`]=p[e]});const u=await Editor.Profile.getConfig("engine","modules.moduleConfig","default");Object.keys(u).forEach(t=>{u[t].native&&(i.cMakeConfig[u[t].native]=`set(${u[t].native} ${e.includeModules.includes(t)?"ON":"OFF"})`)});const _=r;return fs_extra_1.existsSync(_)||await fs_extra_1.mkdir(_),i.language=default_1.LANGUAGE.JS,i.directory=_,i.templateName="link",i.buildDir=path_1.join(r,"proj"),n.ios&&n.ios.packageName&&(i.ios.orientation=n.ios.orientation,i.ios.bundleId=n.ios.packageName,i.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${i.ios.bundleId})`),i.sharedDir=path_1.join(_,".."),l&&(i.platform=default_1.PLATFORM_ENUM[l.toUpperCase()]),n.mac&&n.mac.packageName&&(i.mac.bundleId=n.mac.packageName,i.cMakeConfig.MACOSX_BUNDLE_GUI_IDENTIFIER=`set(MACOSX_BUNDLE_GUI_IDENTIFIER ${i.mac.bundleId})`),i}async function copyNativeTemplates(e,t){const a=await genConsoleParams(e,t,default_1.PLUGIN_NAME_ENUM.NEW);await new cocosCli_1.NativeConsole(a).run()}async function generateNativeProject(e,t){const a=await genConsoleParams(e,t,default_1.PLUGIN_NAME_ENUM.GENERATE);await new cocosCli_1.NativeConsole(a).run(),e.packages.native.params=a.toJSON(),fs_extra_1.outputJSONSync(path_1.join(a.directory,"cocos.compile.config.json"),e)}async function getBrowserslistQuery(e){const t=path_1.join(e,".browserslistrc");let a;try{a=await fs_extra_1.readFile(t,"utf8")}catch(e){return}const i=function(e){const t=[];for(const a of e.split("\n")){const e=a.indexOf("#"),i=(e<0?a:a.substr(0,e)).trim();0!==i.length&&t.push(i)}return t}(a);if(0!==i.length)return i.join(" or ")}async function onAfterInit(e,t){if(e.assetSerializeOptions.exportCCON=!0,e.assetSerializeOptions.allowCCONExtension=!0,"mac"===e.platform&&e.packages.mac.supportM1&&e.includeModules.includes("physics-physx"))throw new Error(Editor.I18n.t("mac.error.m1_with_physic_x"));let a=e.packages.native.remoteServerAddress||"";a&&!a.endsWith("/")&&(a+="/"),Object.assign(e.appTemplateData,{server:a}),e.packages.native.makeAfterBuild&&(e.nextTasks=["make"]),e.packages.native.runAfterMake&&(e.nextTasks=["run"]);const{nativePath:i}=await Editor.Message.request("engine","query-info");let o;index_1.Path._root=e.packages.native.engine||i,console.debug("Native engine root:"+index_1.Path._root),e.includeModules=e.includeModules.filter(e=>!["gfx-webgl2","gfx-webgl"].includes(e)),Object.assign(e.appTemplateData,{isSetOrientation:!0,showFPS:!1}),Object.assign(e.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const r=await getBrowserslistQuery(index_1.Path._root);r&&(o=r),e.buildScriptParam.polyfills=e.packages.native.polyfills,o&&(e.buildEngineParam.targets=o,e.buildScriptParam.targets=o,e.buildScriptParam.polyfills||(e.buildScriptParam.polyfills={}),e.buildScriptParam.polyfills.targets=o,"asyncFunctions"in e.buildScriptParam.polyfills&&delete e.buildScriptParam.polyfills.asyncFunctions),e.buildScriptParam.system={preset:"commonjs-like"},t.paths.dir=path_1.join(t.paths.dir,"assets");const s=t.paths.dir;t.paths.applicationJS=path_1.join(t.paths.dir,"src",path_1.basename(t.paths.applicationJS)),window.__manager.taskManager.debug||await fs_extra_1.emptyDirSync(s),await index_1.outputJSBAdapter(s,{targets:o})}async function onBeforeBuildAssets(e,t,a){for(const e of a.scriptUuids){const i=a.getAssetInfo(e),o=await a.getMeta(e);i?o?o.userData.isPlugin&&o.userData.loadPluginInNative&&t.addPlugin(i):console.error(`Get meta of script {asset(${i.url})} failed!`):console.error(`Get asset info of script {asset(${e})} failed!`)}}async function onAfterBuildAssets(e,t){if(t.bundles.forEach(e=>{e.configOutPutName="cc.config"}),await copyNativeTemplates(e,t),!e.debug){if(!e.packages.native.xxteaKey)return Promise.reject(Error(Editor.I18n.t("native.encrypt.xxtea_key_empty")));if(e.packages.native.encrypted&&await encrypted_1.setEncryptConfig(t),!e.debug&&e.packages.native.encrypted){if(!e.packages.native.xxteaKey)return Promise.reject(Error(Editor.I18n.t("native.encrypt.xxtea_key_empty")));t.bundles.map(e=>e.scriptDest);await encrypted_1.encryptJs(t,{encrypted:e.packages.native.encrypted,compressZip:e.packages.native.compressZip,xxteaKey:e.packages.native.xxteaKey})}}}async function onAfterBuild(e,t){if((e.packages.native.remoteServerAddress||"")&&fs_extra_1.existsSync(t.paths.remote)){const e=path_1.resolve(t.paths.dir,"../remote");fs_extra_1.moveSync(t.paths.remote,e),t.paths.remote=e}const a=path_1.join(Build.buildTemplateDir,e.platform);fs_extra_1.existsSync(a)&&(fs_extra_1.copySync(a,path_1.dirname(t.paths.dir)),console.debug(`Use user build-template in {link(${a})}`)),fs_extra_1.ensureDirSync(path_1.join(t.paths.dir,"src"));const i=path_1.join(__dirname,"../../static/build-template/index.ejs"),o={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),applicationJs:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)},r=(await ejs_1.default.renderFile(i,o)).toString();await fs_extra_1.writeFile(path_1.join(t.paths.dir,"main.js"),r,"utf8"),await generateNativeProject(e,t),e.packages.native.encrypted&&encrypted_1.replaceTeaKeyForGame(e)}async function make(e,t){const a=t.packages.native.params;a.pluginName=default_1.PLUGIN_NAME_ENUM.COMPILE,await new cocosCli_1.NativeConsole(a).run()}async function run(e,t){const a=t.packages.native.params;a.pluginName=default_1.PLUGIN_NAME_ENUM.RUN,await new cocosCli_1.NativeConsole(a).run()}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onBeforeBuildAssets=onBeforeBuildAssets,exports.onAfterBuildAssets=onAfterBuildAssets,exports.onAfterBuild=onAfterBuild,exports.make=make,exports.run=run;