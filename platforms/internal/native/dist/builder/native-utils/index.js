"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createBundle=exports.checkLiteVersion=exports.compileJsbAdapter=exports.outputJSBAdapter=exports.clearDest=exports.cocos=exports.NATIVE_MODULES=exports.PATH=exports.Path=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),child_process_1=require("child_process"),fs_1=require("fs"),plist=require("plist"),babelify=require("babelify"),browserify=require("browserify"),Editor=__importStar(require("editor"));class Path{get COCOS2DX(){return Path._root}get COCOS(){return path_1.join(Path._root,"tools/cocos-console/bin")}get TEMPLATE(){return path_1.join(Path._root,"templates")}get COCOS_CMD(){return path_1.join(this.COCOS,"win32"===process.platform?"cocos_cli.js":"cocos")}get NODEJS(){return"node"}static async queryNativeEnginePath(){const e=await Editor.Message.request("engine","query-info",Editor.Project.type);return e&&e.nativePath}}async function cocos(e,t){if(-1!==exports.PATH.COCOS_CMD.indexOf(" "))throw new Error(`Cocos2dx root [${exports.PATH.COCOS_CMD}] can't include space.`);const r=[exports.PATH.COCOS_CMD,...e];console.warn(`cocos ${r.join(" ")}`);const o=child_process_1.spawn("win32"===process.platform?exports.PATH.NODEJS:"sh",r,t);o.stdout.on("data",e=>{let t;(t=e.toString()).length>1&&(t=t.replace(/\n*$/g,"")),t.split("\n").forEach(e=>{console.log(`[Cocos]: ${e}`)})}),o.stderr.on("data",e=>{e.toString().split("\n").forEach(e=>{-1!==(e=`[Cocos]: ${e}`).toLowerCase().indexOf("warning")?console.warn(e):console.error(e)})}),await new Promise((t,r)=>{o.on("close",(o,n)=>{0!==o?(console.error(`[error] run cocos ${exports.PATH.NODEJS} ${exports.PATH.COCOS_CMD} ${e.join(" ")}`),console.error(`[error] return code ${o}, signal ${n}`),r(new Error("cocos 命令执行失败，详情请查看构建控制台。"))):t(o)}),o.on("error",e=>{r(e)})})}async function clearDest(e){try{await fs_extra_1.remove(path_1.join(e,"assets"))}catch(e){console.error(e)}}async function outputJSBAdapter(e,t){const{targets:r}=t||{},o=await Editor.Message.request("engine","query-info",Editor.Project.type),n=path_1.join(o.path,"platforms/native/builtin/index.js"),s=path_1.join(o.path,"platforms/native/engine/index.js");await createBundle(n,path_1.join(e,"jsb-adapter","jsb-builtin.js"),{targets:r}),await createBundle(s,path_1.join(e,"jsb-adapter","jsb-engine.js"),{targets:r})}async function compileJsbAdapter(){const e=await Editor.Message.request("engine","query-info",Editor.Project.type),t=path_1.join(e.path,"platforms/native"),r=path_1.join(e.path,"bin/.cache/dev/native-preview-adapter");if(!hasChanged(t,r))return;const o=path_1.join(t,"builtin/index.js"),n=path_1.join(t,"engine/index.js");await createBundle(o,path_1.join(r,"jsb-builtin.js"),{targets:"chrome 80"}),await createBundle(n,path_1.join(r,"jsb-engine.js"),{targets:"chrome 80"})}async function checkLiteVersion(e){const t=path_1.join(e,".cocos-project.json");if(!fs_extra_1.existsSync(t))return void console.error(`Can't find project json [{link(${t})}]`);(await fs_extra_1.readJSON(t)).engine_version}function checkFileStat(e,t){return fs_1.readdirSync(e).some(r=>{const o=path_1.join(e,r),n=fs_1.statSync(o);return n.isDirectory()?checkFileStat(o,t):n.mtime.getTime()>t||void 0})}function hasChanged(e,t){if(!fs_extra_1.existsSync(t))return!0;const r=path_1.join(t,"jsb-builtin.js"),o=path_1.join(t,"jsb-engine.js");if(!fs_extra_1.existsSync(r)||!fs_extra_1.existsSync(o))return!0;const n=fs_1.statSync(t);return checkFileStat(path_1.dirname(e),n.mtime.getTime())}async function createBundle(e,t,r){let o,n;Array.isArray(r)?o=r:r&&(o=r.excludes,n=r.targets);const s=browserify(e);return o&&o.forEach(function(e){s.exclude(e)}),await fs_extra_1.ensureDir(path_1.dirname(t)),new Promise((e,r)=>{s.transform(babelify,{presets:[[require("@babel/preset-env"),{targets:n}]]}).bundle((o,n)=>{if(o)return console.error(o),void r(o);fs_extra_1.writeFileSync(t,n,"utf8"),e()})})}exports.Path=Path,Path._root=path_1.join(Editor.App.path,"../resources/3d/engine-native"),exports.PATH=new Path,exports.NATIVE_MODULES=[["USE_VIDEO","VideoPlayer"],["USE_WEBVIEW","WebView"],["USE_EDIT_BOX","EditorBox"],["USE_AUDIO","AudioSource"],["USE_SPINE","Spine Skeleton"],["USE_DRAGONBONES","DragonBones"],["USE_SOCKET","Native Socket"]],exports.cocos=cocos,exports.clearDest=clearDest,exports.outputJSBAdapter=outputJSBAdapter,exports.compileJsbAdapter=compileJsbAdapter,exports.checkLiteVersion=checkLiteVersion,exports.createBundle=createBundle;