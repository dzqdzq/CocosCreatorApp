const path=require("path"),fs=require("fs"),gulp=require("gulp"),babelify=require("babelify"),browserify=require("browserify"),source=require("vinyl-source-stream"),buffer=require("vinyl-buffer");function checkFileStat(e,t){return fs.readdirSync(e).some(n=>{let i=path.join(e,n),r=fs.statSync(i);return r.isDirectory()?checkFileStat(i,t):r.mtime.getTime()>t||void 0})}function hasChanged(e,t){if(!fs.existsSync(t))return!0;let n=fs.statSync(t);return checkFileStat(path.dirname(e),n.mtime.getTime())}function createBundleTask(e,t,n){let i=path.basename(t);t=path.dirname(t);let r=browserify(e);return n&&n.forEach(function(e){r.exclude(e)}),r.transform(babelify,{presets:[require("@babel/preset-env")]}).bundle().pipe(source(i)).pipe(buffer()).pipe(gulp.dest(t))}function createCopyTask(e,t){return gulp.src(e).pipe(gulp.dest(t))}async function prebuild(e){let{rootPath:t,dstPath:n}=e;if(!t)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{let i=path.join(t,"./builtin/index.js"),r=path.join(n,"./jsb-builtin.js");hasChanged(i,r)?createBundleTask(i,r).on("end",e):e()}),await new Promise(e=>{let i=path.join(t,"./engine/index.js"),r=path.join(n,"./jsb-engine.js");hasChanged(i,r)?createBundleTask(i,r).on("end",e):e()}),console.timeEnd("build jsb-adapter")}async function build(e){let{rootPath:t,dstPath:n,excludedModules:i}=e;if(!t)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(e=>{createCopyTask(path.join(t,"./bin/jsb-builtin.js"),n).on("end",e)}),await new Promise(e=>{if(i&&i.length>0){let r=[],a=require(Editor.url("packages://jsb-adapter/modules.json"));i.forEach(function(e){a.some(function(n){if(n.name===e&&n.entries)return n.entries.forEach(function(e){r.push(path.join(t,e))}),!0})}),createBundleTask(path.join(t,"./engine/index.js"),path.join(n,"./jsb-engine.js"),r).on("end",e)}else{createCopyTask(path.join(t,"./bin/jsb-engine.js"),n).on("end",e)}}),console.timeEnd("build jsb-adapter")}const jsbAdapterBuilder={prebuild:prebuild,build:build,createBundleTask:createBundleTask};module.exports=jsbAdapterBuilder;