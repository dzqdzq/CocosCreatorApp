"use strict";"use-strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,o)}l((r=r.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ejs_1=__importDefault(require("ejs")),Editor=__importStar(require("editor")),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),buildStaticDir=path_1.join(__dirname,"../../static/build-template");function onAfterInit(e,t){window.__manager.taskManager.debug||fs_extra_1.emptyDirSync(t.paths.dir),e.buildScriptParam.polyfills=e.packages["web-desktop"].polyfills,e.buildScriptParam.system={preset:"web"},e.buildEngineParam.ammoJsWasm="fallback",e.buildEngineParam.assetURLFormat="runtime-resolved";let i=e.packages["web-desktop"].remoteServerAddress||"";i&&!i.endsWith("/")&&(i+="/"),Object.assign(e.appTemplateData,{server:i})}function onAfterBuild(e,t,i,r){return __awaiter(this,void 0,void 0,function*(){const i=e.packages["web-desktop"],r=buildStaticDir,a=yield ejs_1.default.renderFile(path_1.join(r,"index.js.ejs"),{applicationJS:"./"+Build.Utils.relativeUrl(t.paths.dir,t.paths.applicationJS)}),s=yield babel.transformAsync(a,{presets:[[preset_env_1.default,{modules:"systemjs"}]]});if(!s||!s.code)throw new Error("无法生成 index.js");let n="";e.md5Cache&&(n="."+Build.Utils.calcMd5(s.code));const o=path_1.join(t.paths.dir,`index${n}.js`);fs_extra_1.outputFileSync(o,s.code,"utf8");let l=path_1.join(Build.buildTemplateDir,e.platform,"index.ejs"),p=!0;fs_extra_1.existsSync(l)||(l=path_1.join(r,"index.ejs"),p=!1);const d={polyfillsBundleFile:t.paths.polyfillsJs&&Build.Utils.relativeUrl(t.paths.dir,t.paths.polyfillsJs)||!1,systemJsBundleFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.systemJs),projectName:e.name,engineName:e.buildEngineParam.engineName,previewWidth:i.resolution.designWidth,previewHeight:i.resolution.designHeight,cocosTemplate:path_1.join(r,"index-plugin.ejs"),importMapFile:Build.Utils.relativeUrl(t.paths.dir,t.paths.importMap),indexJsName:path_1.basename(o)},u=yield ejs_1.default.renderFile(l,d);fs_extra_1.outputFileSync(path_1.join(t.paths.dir,"index.html"),u,"utf8"),fs_extra_1.copyFileSync(path_1.join(r,"style.css"),path_1.join(t.paths.dir,"style.css")),fs_extra_1.copyFileSync(path_1.join(r,"favicon.ico"),path_1.join(t.paths.dir,"favicon.ico"));const _=path_1.join(Editor.Project.path,"build-templates",e.platform);fs_extra_1.existsSync(_)&&(fs_extra_1.copySync(_,t.paths.dir),console.debug(`Use build-template {link(${_})}.`)),p&&fs_extra_1.removeSync(path_1.join(t.paths.dir,"index.ejs")),Editor.Message.request("web-desktop","set-preview-path",t.paths.dir)})}exports.throwError=!0,exports.onAfterInit=onAfterInit,exports.onAfterBuild=onAfterBuild;