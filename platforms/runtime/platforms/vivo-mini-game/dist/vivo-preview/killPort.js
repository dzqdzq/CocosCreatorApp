"use strict";var childProcess=require("child_process"),spawn=childProcess.spawn,exec=childProcess.exec,execSync=childProcess.execSync,spawnSync=childProcess.spawnSync;function killAll(c,e,n){var i={};try{Object.keys(c).forEach(function(n){c[n].forEach(function(c){i[c]||(killPid(c,e),i[c]=1)}),i[n]||(killPid(n,e),i[n]=1)})}catch(c){if(n)return n(c);throw c}if(n)return n()}function killPid(c,e){try{process.kill(parseInt(c,10),e)}catch(c){if("ESRCH"!==c.code)throw c}}function Uint8ArrayToString(c){for(var e="",n=0;n<c.length;n++)e+=String.fromCharCode(c[n]);return e}function killInMac(c){var e;Uint8ArrayToString(spawnSync("lsof",["-i",`:${c}`]).stdout).split(/[\n|\r]/).forEach(c=>{if(-1!==c.indexOf("LISTEN")&&!e){let n=c.split(/\s+/);/\d+/.test(n[1])&&(e=n[1])}}),e?execSync(`kill -9 ${e}`):Editor.log(`port:${c} close!`)}function buildProcessTree(c,e,n,i,r){var t=i(c),o="";t.stdout.on("data",function(c){c=c.toString("ascii");o+=c});t.on("close",function(t){delete n[c],0==t?o.match(/\d+/g).forEach(function(t){t=parseInt(t,10),e[c].push(t),e[t]=[],n[t]=1,buildProcessTree(t,e,n,i,r)}):0==Object.keys(n).length&&r()})}module.exports=function(c,e,n,i){var r={},t={};switch(r[c]=[],t[c]=1,"function"==typeof n&&void 0===i&&(i=n,n=void 0),process.platform){case"win32":execSync("taskkill /pid "+c+" /T /F");break;case"darwin":killInMac(e);break;default:buildProcessTree(c,r,t,function(c){return spawn("ps",["-o","pid","--no-headers","--ppid",c])},function(){killAll(r,n,i)})}};