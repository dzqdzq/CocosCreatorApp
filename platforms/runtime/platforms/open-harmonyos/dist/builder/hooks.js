"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterInit=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function generateOptions(t){var e,a,n,r,o,i;const s=t.packages["open-harmonyos"];if(s.orientation=s.orientation||{},s.sdkPath=await Editor.Profile.getConfig("program","ohos_sdk")||"",s.ndkPath=await Editor.Profile.getConfig("program","ohos_ndk")||"",!s.sdkPath||!s.ndkPath)throw new Error(Editor.I18n.t("ohos.tips.ohos_sdk_error"));return{packageName:s.packageName||"",orientation:{landscapeRight:null===(e=s.orientation.landscapeRight)||void 0===e||e,landscapeLeft:null===(a=s.orientation.landscapeLeft)||void 0===a||a,portrait:null!==(n=s.orientation.portrait)&&void 0!==n&&n,upsideDown:null!==(r=s.orientation.upsideDown)&&void 0!==r&&r},apiLevel:s.apiLevel||"7",sdkPath:s.sdkPath||"",ndkPath:s.ndkPath||"",renderBackEnd:{gles3:null===(i=null===(o=s.renderBackEnd)||void 0===o?void 0:o.gles3)||void 0===i||i}}}async function onAfterInit(t,e,a){var n;fs_extra_1.emptyDirSync(e.paths.dir);const r=await generateOptions(t);t.packages["open-harmonyos"]=r;const o=r.renderBackEnd;t.assetSerializeOptions["cc.EffectAsset"].glsl3=null===(n=o.gles3)||void 0===n||n;const i={packageName:r.packageName,orientation:r.orientation};let s;a.__addStaticsInfo(i),t.assetSerializeOptions.exportCCON=!0,t.assetSerializeOptions.allowCCONExtension=!0,Object.assign(t.appTemplateData,{showFPS:!1}),Object.assign(t.buildEngineParam,{platform:"NATIVE",engineName:"src/cocos-js"});const{nativePath:c}=await Editor.Message.request("engine","query-info"),l=await getBrowserslistQuery(c);l&&(s=l),s&&(t.buildEngineParam.targets=s,t.buildScriptParam.targets=s),t.buildScriptParam.system={preset:"commonjs-like"},await fs_extra_1.emptyDirSync(e.paths.dir)}async function getBrowserslistQuery(t){const e=path_1.join(t,".browserslistrc");let a;try{a=await fs_extra_1.readFile(e,"utf8")}catch(t){return}const n=function(t){const e=[];for(const a of t.split("\n")){const t=a.indexOf("#"),n=(t<0?a:a.substr(0,t)).trim();0!==n.length&&e.push(n)}return e}(a);if(0!==n.length)return n.join(" or ")}exports.throwError=!0,exports.onAfterInit=onAfterInit;