<% if(polyfillsBundleFile) { %>
// Polyfills bundle.
require("<%= polyfillsBundleFile %>");
<% } %>

// SystemJS support.
window.self = window;
require("<%= systemJsBundleFile %>");

const importMapJson = loadRuntime().getFileSystemManager().readFileSync("<%= importMapFile%>", 'utf8');
const importMap = JSON.parse(importMapJson);
System.warmup({
    importMap,
    importMapUrl: '<%= importMapFile%>',
    defaultHandler: (urlNoSchema) => {
        require(urlNoSchema.startsWith('/') ? urlNoSchema.substr(1) : urlNoSchema);
    },
});

// HACK: jsb.setPreferredFramesPerSecond not defined
let rt = loadRuntime();
jsb.setPreferredFramesPerSecond = rt.setPreferredFramesPerSecond.bind(rt);

System.import('<%= applicationJs %>').then(({ createApplication }) => {
    return createApplication({
        loadJsListFile: (url) => require(url),
    });
}).then((application) => {
    return onApplicationCreated(application);
}).catch((err) => {
    console.error(err);
});

function onApplicationCreated(application) {
    return application.import('cc').then((cc) => {
        cc.macro.CLEANUP_IMAGE_CACHE = false;
        <% if (optionDebug) { %>
        require('runtime-adapter/jsb.js');
        require('runtime-adapter/engine-adapter.js');
        <% } else { %>
        require('runtime-adapter/jsb.min.js');
        require('runtime-adapter/engine-adapter.min.js');
        <% } %>
        cc.sys.__init();
        return application.start({
            findCanvas: () => {
                var container = document.createElement('div');
                var frame = container.parentNode === document.body ? document.documentElement : container.parentNode;
                var canvas = window.__canvas;
                return { frame, canvas, container };
            },
        });
    });
}
