const e=require("electron"),{ipcMain:t,ipcRenderer:s}=e,i=require("md5"),{promisify:r}=require("util"),{dirname:n,join:o}=require("path"),{statSync:c,readFileSync:a,ensureDirSync:l,writeFileSync:u,writeJSONSync:p,readJSONSync:h}=require("fire-fs"),{sendPostRequest:m}=require("../../network"),{publicEncrypt:d,publicDecrypt:_}=require("crypto"),g=process.send?require("@editor/user/dist/platform/child"):require("@editor/user"),f=!1;const y={ok:0,not_add:461,no_permission:462,license_expired:463},w={0:"成功",461:"帐号尚未加入公司",462:"帐号无权限",463:"证书权限到期"};module.exports=new class{constructor(){this.keys=["taobao-creativeapp"],this.licenses=new Map}getLicensePath(e){return o(Editor.App.home,"local",e?`creator_${e}`:"creator")}get pubKey(){try{const e="license_rsa_creator";return a(Editor.url(`app://share/user/rsa/${e}.pub`),"utf8")}catch(e){return""}}convertToPublicEncrypt(e){return d(this.pubKey,Buffer.from(e)).toString("base64")}convertToPublicDecrypt(e,t){const s=t?e.split(t):[e];let i="";for(let e=0;e<s.length;++e)i+=_(this.pubKey,Buffer.from(s[e],"base64")).toString("utf8");return JSON.parse(i)}getMID(){let e="",t=require("os").networkInterfaces(),s=!1;for(const r in t){let n=t[r];for(let t=0;t<n.length;++t){let r=n[t];if(!r.internal&&r.mac){e=i(r.mac),s=!0;break}}if(s)break}return s||(e=i("00:00:00:00:00:00")),e}async getLicenseInOffline(e){let t;try{t=h(this.getLicensePath(e))}catch(e){throw{status:y.no_permission,message:w[y.no_permission]}}let{d:s,i:i,l:r,m:n}=t;if(i!==this.getMID())throw{status:y.no_permission,message:w[y.no_permission]};{let e=this.convertToPublicDecrypt(r,n);if(Math.round(new Date/1e3)>e.grant_e_time)throw{status:y.license_expired,message:w[y.license_expired]}}Editor.Ipc.sendToAll("license:pass");const o={status:y.ok,message:w[y.ok]};return this.licenses.set(e,o),o}async getLicenseInOnline(e,t=!1){const{cocos_uid:s,session_id:r}=await g.getData();let o="";o=e?`COCOS_UID::${s}::${e}`:`COCOS_UID::${s}`;const c=await m(function(e){return f?new URL(e,"https://test-creator-api.cocos.com").toString():new URL(e,"https://creator-api.cocos.com").toString()}("api/account/get_license"),{session_id:r,client_type:1,terminal_id:i(o),plugin_name:e});if(0!==c.status)throw{status:a.status,message:a.msg};const a=c.data;if(t&&0===a.company_member)throw{status:y.not_add,message:w[y.not_add]};if(!a.license)throw{status:y.no_permission,message:w[y.no_permission]};const u=this.convertToPublicDecrypt(a.license,a.license_mark);if(u.terminal_info!==o)throw{status:y.no_permission,message:w[y.no_permission]};if(Math.round(new Date/1e3)>u.grant_e_time)throw{status:y.license_expired,message:w[y.license_expired]};const h=this.getLicensePath(e);l(n(h)),p(h,{l:a.license,m:a.license_mark,i:this.getMID()}),Editor.Ipc.sendToAll("license:pass");const d={status:y.ok,message:w[y.ok]};return this.licenses.set(e,d),d}async syncLicenses(){for(let e=0;e<this.keys.length;e++)try{await this.queryLicense(this.keys[e])}catch(e){}}hasLicense(e){return!!this.licenses.get(e)}async queryLicense(e,t=!1){return await Editor.Network.update(),this.licenses.delete(e),Editor.Network.isOnline?await this.getLicenseInOnline(e,t):await this.getLicenseInOffline(e)}};