"use strict";const e=require("fire-path"),r=require("fire-fs");let o={};module.exports=o,o.create=function(o,n,i){let t=Editor.dev?Editor.url("app://"):e.join(Editor.url("app://"),"..","..");if(Editor.log("install path: "+t),e.contains(t,o))return i&&i(new Error(Editor.T("DASHBOARD.error_project_in_install"))),void 0;if(r.existsSync(o))return i&&i(new Error("The path "+o+" already exists.")),void 0;function s(n){let i;try{let n=Editor.url("unpack://utils"),t=e.join(o,"jsconfig.json"),s=e.join(o,"tsconfig.json"),c=e.join(o,".gitignore");r.copySync(e.join(n,"api/creator.d.ts"),e.join(o,"creator.d.ts")),r.existsSync(t)||r.copySync(e.join(n,"vscode-extension/jsconfig.json"),t),r.existsSync(s)||r.copySync(e.join(n,"vscode-extension/tsconfig.json"),s),r.existsSync(c)||r.copySync(Editor.url("unpack://static/git-workflow/gitignore"),c)}catch(e){i=e}n(i)}const c=require("node-uuid");let a=e.join(o,"project.json");if(n)process.env.checkedVersion=!0,r.copy(n,o,e=>{e&&console.log(e);try{let e=r.readFileSync(a,"utf8");(e=JSON.parse(e)).id=c.v4(),e.isNew=!0,r.writeFileSync(a,JSON.stringify(e,null,2))}catch(e){console.error(e)}s(i)});else{r.mkdirsSync(o),r.mkdirSync(e.join(o,"settings")),r.mkdirSync(e.join(o,"local")),r.mkdirSync(e.join(o,"packages")),r.mkdirSync(e.join(o,"assets")),r.mkdirSync(e.join(o,"library"));let n={engine:"cocos-creator-js",packages:"packages",version:Editor.versions.CocosCreator,id:c.v4(),isNew:!0};r.writeFileSync(a,JSON.stringify(n,null,2)),s(i)}},o.add=async function(e){const r=Editor.Profile.load("global://settings.json");await r.reset();let o=r.get("recently-opened"),n=o.indexOf(e);-1!==n&&o.splice(n,1),o.unshift(e),r.set("recently-opened",o),r.save()},o.delete=function(e){o.remove(e);const{shell:r}=require("electron");r.trashItem(e)},o.remove=async function(e){const r=Editor.Profile.load("global://settings.json");await r.reset();let o=r.get("recently-opened");require("lodash").remove(o,function(r){return r===e}),r.set("recently-opened",o),r.save()},o.check=function(n,i){if(!1===r.existsSync(n))return i&&i(new Error("Project not exists!")),void 0;let t=Editor.dev?Editor.url("app://"):e.join(Editor.url("app://"),"..","..");if(e.contains(t,n))return i&&i(new Error(Editor.T("DASHBOARD.error_project_in_install_open"))),void 0;o.getInfo(n,function(o){if(!o)return i&&i(new Error("Can not find project.json")),void 0;if(o.error)return i&&i(new Error(o.error)),void 0;let t=o.project;if(t&&(!process.env.checkedVersion||"false"===process.env.checkedVersion)&&!Editor.argv.force){const e=require("semver");let r=t.version,s=!r,c=s||e.satisfies(r,"<"+Editor.versions.CocosCreator,{includePrerelease:!0}),a=r&&e.satisfies(r,">"+Editor.versions.CocosCreator,{includePrerelease:!0});if(c||a){let e="MESSAGE.check_project_version.degrade";if(c&&(e=s?"MESSAGE.check_project_version.upgrade_before_v2_1_2":"MESSAGE.check_project_version.upgrade"),1===Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.confirm"),Editor.T("SHARED.exit")],message:Editor.T(e,{projectVer:r,editorVer:Editor.versions.CocosCreator,projectPath:n}),defaultId:1,cancelId:1,noLink:!0}))return o.abort=!0,i&&i(null,o),void 0}}process.env.checkedVersion=!0;let s=e.join(n,"settings");r.existsSync(s)||r.mkdirSync(s),s=e.join(n,"local"),r.existsSync(s)||r.mkdirSync(s),s=e.join(n,"packages"),r.existsSync(s)||r.mkdirSync(s),s=e.join(n,"assets"),r.existsSync(s)||r.mkdirSync(s),s=e.join(n,"library"),r.existsSync(s)||r.mkdirSync(s),i&&i(null,o)})},o.getInfo=function(o,n){let i,t=e.join(o,"project.json");if(!1===r.existsSync(t))return n&&n(),void 0;try{i=JSON.parse(r.readFileSync(t,"utf8"))}catch(r){return n&&n({path:o,name:e.basename(o),engine:"unknown",project:i,error:"project.json broken: "+r.message,abort:!1}),void 0}n&&n({id:i.id||"",path:o,name:e.basename(o),project:i,abort:!1})};