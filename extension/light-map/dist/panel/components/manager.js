"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),fs_1=__importDefault(require("fs")),image_1=__importDefault(require("../operation/image")),vue_1=__importDefault(require("vue/dist/vue")),Chroma=require("chroma-js");var Modes;function delDir(t,e=!1){let s=[];fs_1.default.existsSync(t)&&((s=fs_1.default.readdirSync(t)).forEach((e,s)=>{const i=t+"/"+e;fs_1.default.statSync(i).isDirectory()?delDir(i,!0):fs_1.default.unlinkSync(i)}),e&&fs_1.default.rmdirSync(t))}!function(t){t[t.SCENE=0]="SCENE",t[t.BAKED=1]="BAKED"}(Modes||(Modes={})),exports.default=vue_1.default.extend({data:()=>({mode:Modes.SCENE,progress:0,logInfos:[],picInfos:[],selectInfos:{},isGenerate:!1,msaa:4,path:"",size:1024,gamma:2.2,giScale:.5,giSamples:25,giPathLength:4,aoLevel:0,aoStrength:.5,aoRadius:1,aoColor:"#888",tab:0,r:!0,g:!0,b:!0}),methods:{changeColor(t){this.aoColor=Chroma(t.target.value).hex(),this.saveEdit()},saveEdit(){Editor.Profile.setConfig("lightmap","lightmap",{msaa:this.msaa,size:this.size,gamma:this.gamma,giScale:this.giScale,giSamples:this.giSamples,giPathLength:this.giPathLength,aoLevel:this.aoLevel,aoStrength:this.aoStrength,aoRadius:this.aoRadius,aoColor:this.aoColor}),this.onItemClick(0)},t(t){const e=`lightmap.${t}`;return Editor.I18n.t(e)},changeMode(t){this.mode=t},async onClear(){const t=await Editor.Message.request("lightmap","unstaging");""===t.currPath||this.isGenerate||(delDir(t.currPath),this.selectInfos={},this.picInfos=[],this.logInfos=[],await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"clear",args:[]}),await Editor.Message.request("lightmap","clear"),await Editor.Message.request("asset-db","refresh-asset","db://assets"))},async onCancel(){this.isGenerate=!1,this.logInfos=[],await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"cancel",args:[]})},async onBakerEnd(){this.isGenerate=!1;const t=await Editor.Message.request("lightmap","unstaging");this.picInfos=await image_1.default(path_1.join(t.currPath,"output")),this.saveEdit()},pushLog(t){this.logInfos.push(t)},setLogs(t){this.logInfos=[];for(let e=0;e<t.length;e++)this.logInfos.push(t[e])},onItemClick(t){this.selectInfos={};for(const e in this.picInfos[t])"path"!==e&&"uuid"!==e&&(this.selectInfos[e]=this.picInfos[t][e])},async onConfirm(){this.r=this.g=this.b=!0,this.progress=0,this.logInfos=[];const t=await Editor.Dialog.select({type:"directory",title:this.t("title"),path:path_1.join(Editor.Project.path,"assets"),multi:!1,filters:[{name:"Lightmap",extensions:["png"]}]});let e=t.filePaths?t.filePaths[0]:[];if(Array.isArray(e)&&(e=e[0]),!e)return!1;e=`${e}/LightFX`,this.path=e,await Editor.Message.request("lightmap","savePicPath",e),fs_1.default.existsSync(e)&&(delDir(e),await Editor.Message.request("asset-db","refresh-asset",e)),this.logInfos.push(this.t("start")+"\n"),this.isGenerate=!0,await Editor.Message.request("scene","execute-scene-script",{name:"lightmap",method:"apply",args:[this.$data,Editor.App.path]})}},computed:{channel(){return(this.r?"r":"")+(this.g?"g":"")+(this.b?"b":"")||void 0}},async mounted(){const t=await Editor.Message.request("lightmap","unstaging");t.isStart&&!t.isEnd&&(this.isGenerate=!0,this.progress=t.progress),this.setLogs(t.logInfos),t.isEnd&&(fs_1.default.existsSync(path_1.join(t.currPath,"output"))?this.picInfos=await image_1.default(path_1.join(t.currPath,"output")):this.picInfos=[],this.saveEdit())}});