"use strict";const fs=require("fs"),os=require("os"),net=require("net"),path=require("path"),_async=require("async"),debug=require("debug"),mkdirp=require("mkdirp").mkdirp,debugTestPort=debug("portfinder:testPort"),debugGetPort=debug("portfinder:getPort"),debugDefaultHosts=debug("portfinder:defaultHosts"),internals={testPort:function(t,e){function r(){debugTestPort("done w/ testPort(): OK",t.host,"port",t.port),t.server.removeListener("error",o),t.server.close(),e(null,t.port)}function o(o){if(debugTestPort("done w/ testPort(): failed",t.host,"w/ port",t.port,"with error",o.code),t.server.removeListener("listening",r),"EADDRINUSE"!=o.code&&"EACCES"!=o.code)return e(o);const s=exports.nextPort(t.port);if(s>exports.highestPort)return e(new Error("No open ports available"));internals.testPort({port:s,host:t.host,server:t.server},e)}e||(e=t,t={}),t.server=t.server||net.createServer(function(){}),debugTestPort("entered testPort(): trying",t.host,"port",t.port),t.server.once("error",o),t.server.once("listening",r),t.host?t.server.listen(t.port,t.host):t.server.listen(t.port)}};exports.basePort=8e3,exports.highestPort=65535,exports.basePath="/tmp/portfinder",exports.getPort=function(t,e){if(e||(e=t,t={}),t.port=Number(t.port)||Number(exports.basePort),t.host=t.host||null,t.stopPort=Number(t.stopPort)||Number(exports.highestPort),!t.startPort){if(t.startPort=Number(t.port),t.startPort<0)throw Error("Provided options.startPort("+t.startPort+") is less than 0, which are cannot be bound.");if(t.stopPort<t.startPort)throw Error("Provided options.stopPort("+t.stopPort+"is less than options.startPort ("+t.startPort+")")}if(t.host){let e;for(let r=0;r<exports._defaultHosts.length;r++)if(exports._defaultHosts[r]===t.host){e=!0;break}e||exports._defaultHosts.push(t.host)}let r,o=[];return _async.eachSeries(exports._defaultHosts,function(e,s){return debugGetPort("in eachSeries() iteration callback: host is",e),internals.testPort({host:e,port:t.port},function(t,n){return t?(debugGetPort("in eachSeries() iteration callback testPort() callback","with an err:",t.code),r=e,s(t)):(debugGetPort("in eachSeries() iteration callback testPort() callback","with a success for port",n),o.push(n),s())})},function(s){if(s){if(debugGetPort("in eachSeries() result callback: err is",s),"EADDRNOTAVAIL"===s.code||"EINVAL"===s.code){if(t.host===r){var n="Provided host "+t.host+" could NOT be bound. Please provide a different host address or hostname";return e(Error(n))}{const o=exports._defaultHosts.indexOf(r);return exports._defaultHosts.splice(o,1),exports.getPort(t,e)}}return e(s)}if(o.sort(function(t,e){return t-e}),debugGetPort("in eachSeries() result callback: openPorts is",o),o[0]===o[o.length-1]){if(o[0]<=t.stopPort)return e(null,o[0]);n="No open ports found in between "+t.startPort+" and "+t.stopPort;return e(Error(n))}return exports.getPort({port:o.pop(),host:t.host,startPort:t.startPort,stopPort:t.stopPort},e)})},exports.getPortPromise=function(t){if("function"!=typeof Promise)throw Error("Native promise support is not available in this version of node.Please install a polyfill and assign Promise to global.Promise before calling this method");return t||(t={}),new Promise(function(e,r){exports.getPort(t,function(t,o){if(t)return r(t);e(o)})})},exports.getPorts=function(t,e,r){r||(r=e,e={});let o=null;_async.timesSeries(t,function(t,r){o&&(e.port=exports.nextPort(o)),exports.getPort(e,function(t,e){t?r(t):(o=e,r(null,e))})},r)},exports.getSocket=function(t,e){function r(){fs.stat(t.path,function(r){r?"ENOENT"==r.code?e(null,t.path):e(r):(t.path=exports.nextSocket(t.path),exports.getSocket(t,e))})}return e||(e=t,t={}),t.mod=t.mod||parseInt("755",8),t.path=t.path||exports.basePath+".sock",t.exists?r():function(){const o=path.dirname(t.path);fs.stat(o,function(s,n){if(s||!n.isDirectory())return function(o){mkdirp(o,t.mod,function(o){if(o)return e(o);t.exists=!0,r()})}(o);t.exists=!0,r()})}()},exports.nextPort=function(t){return t+1},exports.nextSocket=function(t){let e=path.dirname(t),r=path.basename(t,".sock").match(/^([a-zA-z]+)(\d*)$/i),o=parseInt(r[2]),s=r[1];return isNaN(o)&&(o=0),o+=1,path.join(e,s+o+".sock")},exports._defaultHosts=function(){let t={};try{t=os.networkInterfaces()}catch(t){if("uv_interface_addresses"!==t.syscall)throw t}const e=Object.keys(t),r=["0.0.0.0"];for(let o=0;o<e.length;o++){const s=t[e[o]];for(let t=0;t<s.length;t++){const e=s[t];r.push(e.address)}}return r.push(null),debugDefaultHosts("exports._defaultHosts is: %o",r),r}();