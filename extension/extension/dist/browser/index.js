"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.contributions=void 0;const requestProgress=require("request-progress"),request=require("request"),electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../public/utils"),contribution_1=require("./contribution"),downloader_1=require("./downloader"),store_1=require("./store"),vscode_workflow_1=require("./vscode-workflow");async function enable(e,t,o){if(o=o||{},!0===t){const t=await Editor.Package.enable(e);if(o.showInExtensionManager&&exports.methods.showInManager(e),o.addNotification){await Editor.Task.addNotice({type:"log",message:e,title:Editor.I18n.t("extension.extension.enable")})}return t}if(!1===t){const t=await Editor.Package.disable(e,o);if(o.showInExtensionManager&&exports.methods.showInManager(e),o.addNotification){await Editor.Task.addNotice({type:"log",message:e,title:Editor.I18n.t("extension.extension.disable")})}return utils_1.recursive(e,e=>{".js"===path_1.extname(e)&&delete require.cache[e]}),t}}async function load(){await downloader_1.init(),store_1.addUserListener()}function unload(){store_1.removeUserListener()}exports.contributions={enable(e,t){contribution_1.register(e.name,e.path,t)},disable(e,t){contribution_1.unregister(e.name)}},exports.methods={importPackage:utils_1.importPackage,async showInManager(e){await Editor.Panel.has("extension.manager")?(await Editor.Message.request("extension","refresh-package",e),Editor.Message.send("extension","select-package",e)):Editor.Panel.open("extension.manager",e)},openManager(){Editor.Panel.open("extension.manager")},async openStore(){await Editor.User.isLoggedIn()?Editor.Panel.open("extension.store"):Editor.Dialog.warn(Editor.I18n.t("extension.store.please_login"))},openCreate(){Editor.Panel.open("extension.create")},async addChromeDebugSetting(){vscode_workflow_1.addChromeDebugSetting()},async addCompileTask(){vscode_workflow_1.addCompileTask()},enable:enable,async remove(e){try{await Editor.Package.unregister(e),await electron_1.shell.trashItem(e)}catch(e){return console.error(e),!1}return!0},async reload(e){const t=Editor.Package.getPackages({path:e});if(!t||!t[0])return;const o=t[0].enable;await enable(e,!1,{replacement:!1}),await Editor.Package.unregister(e),await Editor.Package.register(e),o&&await enable(e,!0)},async scanning(e){let t;if("project"===e)t=path_1.join(Editor.Project.path,"extensions");else{if("global"!==e)return;t=path_1.join(Editor.App.home,"extensions")}await fs_extra_1.ensureDir(t);const o=(await fs_extra_1.readdir(t)).map(e=>path_1.join(t,e)),n=(await Editor.Package.getPackages()).filter(e=>Editor.Utils.Path.contains(t,e.path));for(const e of n)fs_extra_1.existsSync(e.path)||(e.enable&&await enable(e.path,!1),await Editor.Package.unregister(e.path));for(const e of o){(await fs_extra_1.stat(e)).isDirectory()&&await Editor.Package.register(e)}return!0},async downloadItem(e){const t=contribution_1.getInfoFromTypeID(e.type_id);if(downloader_1.getDownloadInfo(e.version_id,e.production_id))return Editor.Dialog.warn(Editor.I18n.t("extension.store.download_exists_error")),null;if(!e.version_id||!e.production_id)return Editor.Dialog.warn("empty version id or prodduction id"),null;const o=downloader_1.generateDownloadItem(e);o.downloadProgress=0,downloader_1.pushDownloadList(o),downloader_1.onItemUpdate(o);try{for(let e=0;e<t.length;e++){const n=t[e];if(!n.module)continue;const a=require(n.module);if(n.check){if(!1===await a.methods[n.check](o))continue}if(a.methods[n.download])await a.methods[n.download](o,()=>{downloader_1.onItemUpdate(o)}).catch(e=>{throw e});else{const e=require(contribution_1.defaultDownloadTypeInfoMap.module);await e.methods[contribution_1.defaultDownloadTypeInfoMap.download](o,()=>{downloader_1.onItemUpdate(o)}).catch(e=>{throw e})}return o.downloadProgress=1,downloader_1.onItemUpdate(o),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_successful"),type:"success",source:"extension",timeout:5e3}),o}}catch(e){return"cancel"===e.message?Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_cancel"),message:e.message||e,type:"log",source:"extension",timeout:5e3}):Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_failed"),message:e.message||e,type:"error",source:"extension",timeout:5e3}),null}return Editor.Task.addNotice({title:Editor.I18n.t("extension.store.download_failed"),type:"error",source:"extension",timeout:5e3}),null},async installItem(e,t){const o=downloader_1.getDownloadInfo(e,t);if(!o)return null;const n=contribution_1.getInfoFromTypeID(o.type);o.installProgress=0,downloader_1.onItemUpdate(o);try{for(let e=0;e<n.length;e++){const t=n[e];if(!t.module)continue;const a=require(t.module);if(!t.check||!1!==await a.methods[t.check](o)){if(a.methods[t.install])await a.methods[t.install](o,()=>{downloader_1.onItemUpdate(o)}).catch(e=>{throw e});else{const e=require(contribution_1.defaultDownloadTypeInfoMap.module);await e.methods[contribution_1.defaultDownloadTypeInfoMap.install](o,()=>{downloader_1.onItemUpdate(o)}).catch(e=>{throw e})}return o.installProgress=1,downloader_1.onItemUpdate(o),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_successful"),type:"success",source:"extension",timeout:8e3}),Editor.Dialog.info(Editor.I18n.t("extension.store.install_successful"),{buttons:[Editor.I18n.t("extension.store.confirm")]}),o}}}catch(e){return"cancel"===e.message?utils_1.handleCancelImport():"manual install"===e.message?utils_1.handleManualInstall():utils_1.handleUnexpectedImportError(e),null}return utils_1.handleUnexpectedImportError(),null},removeItem:async(e,t)=>await downloader_1.removeDownloadItem(e,t),removeAllItem:async()=>await downloader_1.removeDownloadList(),queryDownloaderList:async()=>downloader_1.downloadList,async updateExtension(e,t,o="local"){e=encodeURI(e);const n=path_1.join(Editor.Project.tmpDir,"extension/download",t+".zip");await fs_extra_1.ensureDir(path_1.dirname(n)),await new Promise((t,o)=>{requestProgress(request(e),{delay:300}).on("progreass",function(e){}).on("error",function(e){o(e)}).on("end",function(e,o){t(null)}).pipe(fs_extra_1.createWriteStream(n))});let a="",r="";"local"===o?(r="project",a=path_1.join(Editor.Project.path,"extensions",t)):(r="global",a=path_1.join(Editor.App.home,"extensions",t));const i=path_1.basename(a,".zip");try{await utils_1.importPackage(r,n,{forceImport:!0}),await enable(a,!0)}catch(e){switch(e.message){case"cancel":utils_1.handleCancelImport();break;case"decompress fail":utils_1.handleDecompressFail(a,i,!0);break;case"invalid path":utils_1.handleInvalidPath(a);break;default:utils_1.handleUnexpectedImportError(e)}}await fs_extra_1.remove(n)},getExtensionInfoMap:()=>contribution_1.getExtensionInfoMap()},exports.load=load,exports.unload=unload;