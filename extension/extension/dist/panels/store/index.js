"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const electron_1=require("electron"),fs_1=require("fs"),path_1=require("path"),querystring=__importStar(require("querystring")),url_1=require("url"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;const openExternal=e=>electron_1.shell.openExternal(e),getJumpUrl=(e,t)=>`https://creator-api.cocos.com/api/account/client_signin?session_id=${e}&client_type=2&redirect_url=${encodeURIComponent(t)}`;function ready(){vm=new Vue({el:(panel=this).$.store,data:{isloading:!0,show:{slider:!1},domReady:!1,language:Editor.I18n.getLanguage(),list:[]},computed:{sortList(){return this.list.sort((e,t)=>t.date-e.date)}},components:{item:require("./package-item")},async mounted(){const e=Buffer.from(await Editor.Network.get("https://creator-api.cocos.com/api/service/get_store_setting")).toString(),t=JSON.parse(e),r=this.$refs.webview,s=await Editor.User.getData();var o;requestAnimationFrame(async()=>{r.setAttribute("useragent",Editor.App.userAgent),r.setAttribute("preload",`file://${(0,path_1.join)(__dirname,"/preload.js")}`),vm.domReady=!1,r.setAttribute("src",getJumpUrl(s.session_id,`${t.data.entry_url}/creator/index/#/c?language=${Editor.I18n.getLanguage()}`))}),r.addEventListener("ipc-message",e=>{switch(e.channel){case"_selectFile":!async function(e){const t=await Editor.Dialog.select(JSON.parse(e.args[0]));r.send("_selectFileFinished",t)}(e);break;case"_translate":e=e,r.send("_translate_finished",Editor.I18n.t(e.args[0]));break;case"__cocos_jump":!function(e){openExternal(getJumpUrl(s.session_id,e.args[0]))}(e);break;case"__normal_jump":!function(e){openExternal(e.args[0])}(e)}}),r.addEventListener("did-navigate-in-page",async e=>{const t=await Editor.User.getData();if(console.debug(`本地导航 - ${e.url}`),vm.domReady=!0,/app/.test(e.url)&&(this.isloading=!1),/order_pay/.test(e.url))return electron_1.shell.openExternal(getJumpUrl(t.session_id,e.url)),e.stopPropagation(),void e.preventDefault()}),r.addEventListener("dom-ready",async()=>{}),r.addEventListener("new-window",async e=>{const t=await Editor.User.getData();if(e.stopPropagation(),e.preventDefault(),console.debug(`打开新页面 - ${e.url}`),/pay/.test(e.url))electron_1.shell.openExternal(getJumpUrl(t.session_id,e.url));else{if(/\/creator\/download/.test(e.url)){const t=(0,url_1.parse)(e.url),r=querystring.parse(t.query||""),s=JSON.parse(Buffer.from(await Editor.Network.get(e.url,r))+"");return vm&&(vm.show.slider=!0),await Editor.Message.request("extension","download-item",s),void(vm&&(vm.show.slider=!0))}/cocos\.[com|org|net]/.test(e.url)?electron_1.shell.openExternal(getJumpUrl(t.session_id,e.url)):/cocos\.[com|org|net]/.test(e.url)||openExternal(e.url)}}),this.refreshList()},methods:{i18n:e=>Editor.I18n.t(e),toggleSilder(e){this.show.slider=!!e},async removeAll(){1!==(await Editor.Dialog.info(`${Editor.I18n.t("extension.menu.removeAllConfirm")}`,{title:Editor.I18n.t("extension.menu.confirm"),default:0,cancel:1,buttons:[Editor.I18n.t("extension.store.confirm"),Editor.I18n.t("extension.store.cancel")]})).response&&await Editor.Message.request("extension","remove-all-item")},async refreshList(e){if(e)this.list.find(t=>{if(t.version_id===e.version_id&&t.production_id&&e.production_id)for(const r in e)t[r]=e[r]});else{const e=await Editor.Message.request("extension","query-downloader-list");this.list=e}},goBack(){this.$refs.webview.goBack()},goForward(){this.$refs.webview.goForward()},refresh(){this.$refs.webview.reload()},async goHome(){const e=await Editor.User.getData(),t=JSON.parse(Buffer.from(await Editor.Network.get("https://creator-api.cocos.com/api/service/get_store_setting"))+""),r=this.$refs.webview;vm.domReady=!1,r.setAttribute("src",getJumpUrl(e.session_id,`${t.data.entry_url}/creator/index/#/c?language=${Editor.I18n.getLanguage()}`))}}})}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../store.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/store/index.html"),"utf8"),exports.$={store:".store",uiLoader:"ui-loading"},exports.methods={downloaderUpdate(e){if(vm)return vm.refreshList(e)}},exports.ready=ready;