"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.component=void 0;const fs_1=require("fs"),path_1=require("path"),pkg_node_1=__importDefault(require("./pkg-node")),utils_1=require("../../public/utils"),vue_1=__importDefault(require("vue/dist/vue"));let vm;vue_1.default.config.productionTip=!1,vue_1.default.config.devtools=!1,exports.component=vue_1.default.extend({data:()=>({ready:!0,packages:[],packagesMap:[],tabs:["internal","project","global","develop"],active:"internal",search:"",dev:Editor.App.dev,onScroll:null}),mounted(){this.refresh(),this.onScroll=(()=>{this.$children.forEach(e=>e.$emit("scroll"))}),this.$refs.main.addEventListener("scroll",this.onScroll)},destroyed(){this.$refs.main.removeEventListener("scroll",this.onScroll)},components:{"pkg-node":pkg_node_1.default},methods:{t:e=>Editor.I18n.t(`extension.menu.${e}`),refresh(){const e=Editor.Package.getPackages().sort((e,t)=>e.name.localeCompare(t.name));this.packages=e.map(e=>{return{info:e.info,path:e.path,type:(0,utils_1.getPackageType)(e.path),enable:e.enable}}).filter(Boolean),this.doSearch()},doSearch(){this.search=this.$refs.search.value,this.search?this.packagesMap=this.packages.filter(e=>-1!==e.info.name.search(this.search)):this.packagesMap=this.packages},async scanning(e){await Editor.Message.request("extension","scanning",e),this.refresh()},async install(e){if("develop"===e){const e=await Editor.Dialog.select({type:"directory",multi:!1,title:Editor.I18n.t("extension.menu.selectDirectory")});if(!e||!e.filePaths[0])return;const t=e.filePaths[0],a=(0,path_1.join)(Editor.Project.path,"extensions"),i=(0,path_1.join)(Editor.App.home,"extensions");if(Editor.Utils.Path.contains(a,t)||Editor.Utils.Path.contains(i,t))return void Editor.Dialog.error(this.t("customImportError"));await Editor.Package.register(t)?this.refresh():Editor.Dialog.error(this.t("customImportError"))}else{const t=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.selectDirectory"),filters:[{name:"ZIP",extensions:["zip"]}]});if(!t||!t.filePaths[0])return;const a=(0,path_1.basename)(t.filePaths[0],".zip");try{const i=await(0,utils_1.importPackage)(e,t.filePaths[0]);await Editor.Message.request("extension","scanning",e),await Editor.Message.request("extension","enable",i,!0),this.refresh()}catch(e){switch(e.message){case"cancel":(0,utils_1.handleCancelImport)();break;case"decompress fail":(0,utils_1.handleDecompressFail)(t.filePaths[0],a,!0);break;case"invalid path":(0,utils_1.handleInvalidPath)(t.filePaths[0]);break;default:(0,utils_1.handleUnexpectedImportError)(e)}}}}}}),module.exports=Editor.Panel.define({style:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../manager.css"),"utf8"),template:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/manager/index.html"),"utf8"),$:{content:".extension"},methods:{selectPackage(e){vm.active=(0,utils_1.getPackageType)(e),setTimeout(()=>{const t=vm.$refs[e]&&vm.$refs[e][0].$el;t&&(t.scrollIntoView(!0),t.setAttribute("blink","blink"))},200)},async refresh(e){let t=vm.active;"string"==typeof e&&(t=(0,utils_1.getPackageType)(e)),"project"!==t&&"global"!==t||await vm.scanning(t)}},ready(e){let t="internal";e&&(t=(0,utils_1.getPackageType)(e)),(vm=new exports.component({el:this.$.content})).active=t,e&&this.selectPackage(e),Editor.Package.on("register",vm.refresh),Editor.Package.on("unregister",vm.refresh)},close(){Editor.Package.removeListener("register",vm.refresh),Editor.Package.removeListener("unregister",vm.refresh)}});