"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.$=exports.style=exports.template=void 0;const electron_1=require("electron"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),semver_1=require("semver"),DistVue=require("vue/dist/vue");DistVue.config.productionTip=!1,DistVue.config.devtools=!1,exports.template='<div id="app"></div>',exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../create.css"),"utf8");const TempKeyMap={author:"create_package_author",showInManager:"create_package_show_in_manager",showInFolder:"create_package_show_in_folder"},LocationType={"extension.create_package.local":"0","extension.create_package.global":"1"};async function ready(){const e=await Editor.Message.request("extension","get-extension-info-map"),t=await Editor.Profile.getTemp("extension",TempKeyMap.author)||"Cocos Creator",s=await Editor.Profile.getTemp("extension",TempKeyMap.showInManager),a=null===s||Boolean(s),i=await Editor.Profile.getTemp("extension",TempKeyMap.showInFolder),o=null===i||Boolean(i);new DistVue({data:{extensionInfoMap:e,currentWorkflow:"typescript",currentLocation:"0",LocationType:LocationType,name:`simple-${Date.now()}`,currentTemplate:e.extension[0],author:t,showInManager:a,showInFolder:o,editorVersion:`>=${Editor.App.version}`,extensionExist:!1},template:fs_1.readFileSync(path_1.join(__dirname,"../../../static","/template/create/index.html"),"utf8"),el:this.$.app,methods:{isEmptyObject:e=>0===Object.keys(e).length,t:(...e)=>Editor.I18n.t(...e),async apply(){const e=path_1.join(Editor.Project.tmpDir,"extension/create",this.name);try{fs_1.existsSync(e)&&fs_extra_1.removeSync(e),fs_extra_1.ensureDirSync(e),await Editor.Profile.setTemp("extension",TempKeyMap.author,this.author),await Editor.Profile.setTemp("extension",TempKeyMap.showInManager,this.showInManager),await Editor.Profile.setTemp("extension",TempKeyMap.showInFolder,this.showInFolder),Editor.Utils.File.copy(this.currentTemplate.path,e);const t=this.distPath,s=path_1.join(e,"package.json"),a=fs_1.readFileSync(s,{encoding:"utf-8"}),i=JSON.parse(a.replace(/{name}/g,this.name));Object.assign(i,{name:this.name,package_version:2,version:"1.0.0",author:this.author,editor:this.editorVersion,scripts:{build:"tsc -b",watch:"tsc -w"}}),i.devDependencies.typescript="^4.3.4",await fs_extra_1.writeJSON(s,i,{spaces:4});const o=path_1.join(e,"README-CN.md"),n=path_1.join(e,"README-EN.md");if(fs_1.existsSync(o)){const e=fs_1.readFileSync(o,{encoding:"utf-8"});fs_1.writeFileSync(o,e.replace(/{name}/g,this.name))}if(fs_1.existsSync(n)){const e=fs_1.readFileSync(n,{encoding:"utf-8"});fs_1.writeFileSync(n,e.replace(/{name}/g,this.name))}if(await Editor.Message.request("utils","export-dts",e,!1),fs_extra_1.moveSync(e,t),await Editor.Package.register(t),Editor.Task.addNotice({type:"log",message:Editor.I18n.t("extension.create_package.create_extension_successful"),title:this.name}),this.showInFolder){const e=path_1.join(t,"README-CN.md"),s=path_1.join(t,"package.json");fs_1.existsSync(e)?electron_1.shell.showItemInFolder(e):electron_1.shell.showItemInFolder(s)}this.showInManager&&await Editor.Message.request("extension","show-in-manager",t),Editor.Panel.close("extension.create")}catch(t){fs_1.existsSync(e)&&fs_extra_1.removeSync(e),t instanceof Error&&Editor.Dialog.error(t.message,{title:t.name,detail:t.stack})}}},computed:{wrongName(){return!new RegExp("^(?:@[a-z0-9-*~][a-z0-9-*._~]*/)?[a-z0-9-~][a-z0-9-._~]*$").test(this.name)||/[.]/g.test(this.name)},wrongAuthor(){return!this.author},wrongEditorVersion(){return!semver_1.valid(semver_1.coerce(this.editorVersion))||semver_1.satisfies(semver_1.valid(semver_1.coerce(this.editorVersion))||"","< 3.0.0")},distPath(){return path_1.join(this.currentLocation===LocationType["extension.create_package.global"]?Editor.App.home:Editor.Project.path,"extensions",this.name)}},watch:{name(e,t){e!==t&&(this.extensionExist=fs_1.existsSync(this.distPath)&&""!==this.name)},currentLocation(e,t){e!==t&&(this.extensionExist=fs_1.existsSync(this.distPath)&&""!==this.name)}}})}exports.$={app:"#app"},exports.ready=ready;