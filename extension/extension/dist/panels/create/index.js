"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),semver_1=require("semver"),DistVue=require("vue/dist/vue");DistVue.config.productionTip=!1,DistVue.config.devtools=!1;const TempKeyMap={author:"create_package_author",showInManager:"create_package_show_in_manager",showInFolder:"create_package_show_in_folder"},LocationType={"extension.create_package.local":"0","extension.create_package.global":"1"},supportedWorkflows=["typescript"];module.exports=Editor.Panel.define({template:'<div id="app"></div>',style:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../create.css"),"utf8"),$:{app:"#app"},async ready(){const e=await Editor.Message.request("extension","get-extension-info-map"),t=await Editor.Profile.getTemp("extension",TempKeyMap.author)||"Cocos Creator",s=await Editor.Profile.getTemp("extension",TempKeyMap.showInManager),i=null===s||Boolean(s),n=await Editor.Profile.getTemp("extension",TempKeyMap.showInFolder),o=null===n||Boolean(n);new DistVue({data:{supportedWorkflows:supportedWorkflows,extensionInfoMap:e,currentWorkflow:"typescript",currentLocation:"0",LocationType:LocationType,name:`simple-${Date.now()}`,currentTemplate:e.extension[0],author:t,showInManager:i,showInFolder:o,editorVersion:`>=${Editor.App.version}`,extensionExist:!1},template:(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/create/index.html"),"utf8"),el:this.$.app,methods:{isEmptyObject:e=>0===Object.keys(e).length,t:(...e)=>Editor.I18n.t(...e),async apply(){var e;const t=(0,path_1.join)(Editor.Project.tmpDir,"extension/create",this.name);try{(0,fs_1.existsSync)(t)&&(0,fs_extra_1.removeSync)(t),(0,fs_extra_1.ensureDirSync)(t),await Editor.Profile.setTemp("extension",TempKeyMap.author,this.author),await Editor.Profile.setTemp("extension",TempKeyMap.showInManager,this.showInManager),await Editor.Profile.setTemp("extension",TempKeyMap.showInFolder,this.showInFolder),Editor.Utils.File.copy(this.currentTemplate.path,t);const s=this.distPath,i=(0,path_1.join)(t,"package.json"),n=(0,fs_1.readFileSync)(i,{encoding:"utf-8"}),o=JSON.parse(n.replace(/{name}/g,this.name)),a={name:this.name,package_version:2,version:"1.0.0",author:this.author,editor:this.editorVersion};"typescript"!==this.currentWorkflow||o.scripts||(a.scripts={build:"tsc -b",watch:"tsc -w"}),void 0===(null===(e=o.devDependencies)||void 0===e?void 0:e.typescript)&&(o.devDependencies.typescript="^4.3.4"),Object.assign(o,a),await(0,fs_extra_1.writeJSON)(i,o,{spaces:4});const r=(0,path_1.join)(t,"README-CN.md"),c=(0,path_1.join)(t,"README-EN.md");if((0,fs_1.existsSync)(r)){const e=(0,fs_1.readFileSync)(r,{encoding:"utf-8"});(0,fs_1.writeFileSync)(r,e.replace(/{name}/g,this.name))}if((0,fs_1.existsSync)(c)){const e=(0,fs_1.readFileSync)(c,{encoding:"utf-8"});(0,fs_1.writeFileSync)(c,e.replace(/{name}/g,this.name))}const p=(0,path_1.join)(t,o.main);if(!(0,fs_1.existsSync)(p)){const e=`exports.load = function(){\n\tconsole.warn("${this.name} is not compiled yet.")\n}`;(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(p)),(0,fs_1.writeFileSync)(p,e)}if(await Editor.Message.request("utils","export-dts",t,!1),(0,fs_extra_1.moveSync)(t,s),await Editor.Package.register(s),Editor.Task.addNotice({type:"log",message:Editor.I18n.t("extension.create_package.create_extension_successful"),title:this.name}),this.showInFolder){const e=(0,path_1.join)(s,"README-CN.md"),t=(0,path_1.join)(s,"package.json");(0,fs_1.existsSync)(e)?electron_1.shell.showItemInFolder(e):electron_1.shell.showItemInFolder(t)}this.showInManager&&await Editor.Message.request("extension","show-in-manager",s),Editor.Panel.close("extension.create")}catch(e){(0,fs_1.existsSync)(t)&&(0,fs_extra_1.removeSync)(t),e instanceof Error&&Editor.Dialog.error(e.message,{title:e.name,detail:e.stack})}}},computed:{wrongName(){return!new RegExp("^(?:@[a-z0-9-*~][a-z0-9-*._~]*/)?[a-z0-9-~][a-z0-9-._~]*$").test(this.name)||/[.]/g.test(this.name)},wrongAuthor(){return!this.author},wrongEditorVersion(){return!(0,semver_1.valid)((0,semver_1.coerce)(this.editorVersion))||(0,semver_1.satisfies)((0,semver_1.valid)((0,semver_1.coerce)(this.editorVersion))||"","< 3.0.0")},distPath(){return(0,path_1.join)(this.currentLocation===LocationType["extension.create_package.global"]?Editor.App.home:Editor.Project.path,"extensions",this.name)}},watch:{name(e,t){e!==t&&(this.extensionExist=(0,fs_1.existsSync)(this.distPath)&&""!==this.name)},currentLocation(e,t){e!==t&&(this.extensionExist=(0,fs_1.existsSync)(this.distPath)&&""!==this.name)}}})}});