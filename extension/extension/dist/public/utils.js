"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.recursive=exports.importPackage=exports.handleUnexpectedImportError=exports.handleManualInstall=exports.handleInvalidPath=exports.handleCancelImport=exports.handleDecompressFail=void 0;const child_process_1=require("child_process"),electron_1=require("electron"),fix_path_1=__importDefault(require("fix-path")),fs_extra_1=require("fs-extra"),path_1=require("path");async function handleDecompressFail(e,t,n){if((await Editor.Dialog.info(Editor.I18n.t("extension.menu.decompressFail"),{cancel:0,buttons:[Editor.I18n.t("extension.store.cancel"),Editor.I18n.t("extension.store.confirm")]})).response){const o=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.copyPackageTitle",{extensionName:t+".zip"}),type:"directory"});if(o.canceled){if(!n)throw new Error("cancel");handleCancelImport()}else if(o.filePaths[0]){const r=path_1.join(o.filePaths[0],t+".zip");if(await Editor.Utils.File.copy(e,r),console.log(`[extension] copy ${t}.zip to ${r}`),!n)throw new Error("manual install");handleManualInstall()}}else{if(!n)throw new Error("cancel");handleCancelImport()}}function handleCancelImport(){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_cancel"),type:"log",source:"extension",timeout:8e3})}function handleInvalidPath(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.invalidPath",{path:e}),type:"error",source:"extension",timeout:8e3})}function handleManualInstall(){console.log(Editor.I18n.t("extension.store.install_manual_guide",{url:Editor.App.urls.manual})),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_manual_title"),message:Editor.I18n.t("extension.store.install_manual_content"),source:"extension",type:"warn"})}function handleUnexpectedImportError(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_fail"),message:null===e||void 0===e?void 0:e.message,type:"error",source:"extension"})}async function importPackage(e="project",t,n){const o=(null===n||void 0===n?void 0:n.extensionDisplayName)||path_1.basename(t,".zip"),r=null===n||void 0===n?void 0:n.forceImport,a="project"===e?Editor.Project.path:Editor.App.home,i=path_1.join(a,"./extensions");if(fs_extra_1.existsSync(i)||await fs_extra_1.ensureDir(i),!t||t===i)throw new Error("invalid path");let s;s="win32"===process.platform?unzipOfWin32:unzipOfDarwin;const l=Editor.App.temp,c=path_1.join(l,`extension_${o}_temp`);let d="";try{const e=Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.decompressingNow",{extensionName:o}),type:"log",source:"extension"});await new Promise((n,r)=>{s(t,c,t=>{if(Editor.Task.removeNotice(e),t)return console.error(t),r(t.message);n(null),Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.decompressSuccess",{extensionName:o}),message:Editor.I18n.t("extension.menu.importingNow",{extensionName:o}),type:"success",source:"extension",timeout:5e3})})})}catch(e){throw new Error("decompress fail")}const p=path_1.join(c,"package.json"),u=async()=>{if(r)return!0;return 1!==(await Editor.Dialog.info(Editor.I18n.t("extension.menu.reinstall",{extensionName:o}),{buttons:[Editor.I18n.t("extension.menu.confirm"),Editor.I18n.t("extension.menu.cancel")],cancel:1})).response};if(fs_extra_1.existsSync(p)){const e=(await fs_extra_1.readJson(p)).name;if(d=path_1.join(i,e),fs_extra_1.existsSync(d)){if(!await u())throw await fs_extra_1.remove(c),new Error("cancel");await Editor.Package.disable(d,{replacement:!1}),await Editor.Package.unregister(d),await electron_1.shell.trashItem(d)}await fs_extra_1.move(c,d)}else{Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.zipDirectoryWarnTitle",{extensionName:o}),message:Editor.I18n.t("extension.menu.zipDirectoryWarnContent"),type:"warn",source:"extension",timeout:5e3});const e=fs_extra_1.readdirSync(c);for(const t of e){const e=path_1.join(c,t,"package.json");if(!fs_extra_1.existsSync(e))continue;const n=(await fs_extra_1.readJson(e)).name;if(d=path_1.join(i,n),fs_extra_1.existsSync(d)){if(!await u())throw await fs_extra_1.remove(c),new Error("cancel");await Editor.Package.disable(d,{replacement:!1}),await Editor.Package.unregister(d),await electron_1.shell.trashItem(d)}await fs_extra_1.move(path_1.join(c,t),d);break}}return fs_extra_1.existsSync(c)&&await fs_extra_1.remove(c),Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.importSuccess"),message:o,type:"success",source:"extension",timeout:5e3}),d}exports.handleDecompressFail=handleDecompressFail,exports.handleCancelImport=handleCancelImport,exports.handleInvalidPath=handleInvalidPath,exports.handleManualInstall=handleManualInstall,exports.handleUnexpectedImportError=handleUnexpectedImportError,exports.importPackage=importPackage;const unzipOfDarwin=function(e,t,n){const o=path_1.dirname(t);fs_extra_1.ensureDirSync(o),fix_path_1.default();const r=child_process_1.spawn("unzip",["-n",e,"-d",t]);let a="";r.stderr.on("data",e=>{a+=e});let i="";r.stdout.on("data",e=>{i+=e}),r.on("error",e=>{i&&console.log(i),a&&console.warn(a),n(e)}),r.on("close",e=>{i&&console.log(i),a&&console.warn(a);let t=null;0!==e&&(t=new Error(Editor.I18n.t("extension.menu.decompressFail"))),n(t)})},unzipOfWin32=function(e,t,n){const o=path_1.dirname(t);fs_extra_1.ensureDirSync(o);const r=child_process_1.spawn(path_1.join(Editor.App.path,"../tools/unzip.exe"),["-n",e,"-d",t]);let a="";r.stderr.on("data",e=>{a+=e});let i="";r.stdout.on("data",e=>{i+=e}),r.on("error",e=>{i&&console.log(i),a&&console.warn(a),n(e)}),r.on("close",e=>{i&&console.log(`[extension] ${i}`),a&&console.warn(`[extension] ${a}`);let t=null;0!==e&&(t=new Error(Editor.I18n.t("extension.menu.decompressFail"))),n(t)})};function recursive(e,t){!function e(n){if(!fs_extra_1.existsSync(n))return;fs_extra_1.statSync(n).isDirectory()?fs_extra_1.readdirSync(n).forEach(t=>{e(path_1.join(n,t))}):t(n)}(e)}exports.recursive=recursive;