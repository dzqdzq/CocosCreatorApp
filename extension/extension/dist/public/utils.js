"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.recursive=exports.importPackage=exports.handleUnexpectedImportError=exports.handleManualInstall=exports.handleInvalidPath=exports.handleCancelImport=exports.handleDecompressFail=exports.addPackage=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path");async function addPackage(e="project"){const t="project"===e?Editor.Project.path:Editor.App.home,n=path_1.join(t,"./extensions");fs_extra_1.existsSync(n)||await fs_extra_1.ensureDir(n);const a=await Editor.Dialog.save({title:Editor.I18n.t("extension.menu.add"),path:n,button:Editor.I18n.t("extension.menu.addLabel")});if(!a||a.filePath===n)return"";try{const e={browser:fs_extra_1.readFileSync(path_1.join(__dirname,"../static/package/browser.js"),"utf8"),package:fs_extra_1.readFileSync(path_1.join(__dirname,"../static/package/package.json"),"utf8")};a.filePath&&(e.package=e.package.replace("{{name}}",path_1.basename(a.filePath)),e.package=e.package.replace("{{user}}","unknown"),await fs_extra_1.outputFile(path_1.join(a.filePath,"browser.js"),e.browser),await fs_extra_1.outputFile(path_1.join(a.filePath,"package.json"),e.package))}catch(e){return console.warn(`${Editor.I18n.t("extension.menu.addError")} \n${a.filePath}`),console.warn(e),""}return a.filePath}async function handleDecompressFail(e,t,n){if((await Editor.Dialog.info(Editor.I18n.t("extension.menu.decompressFail"),{cancel:0,buttons:[Editor.I18n.t("extension.store.cancel"),Editor.I18n.t("extension.store.confirm")]})).response){const a=await Editor.Dialog.select({title:Editor.I18n.t("extension.menu.copyPackageTitle",{extensionName:t+".zip"}),type:"directory"});if(a.canceled){if(!n)throw new Error("cancel");handleCancelImport()}else if(a.filePaths[0]){const o=path_1.join(a.filePaths[0],t+".zip");if(await Editor.Utils.File.copy(e,o),console.log(`[extension] copy ${t}.zip to ${o}`),!n)throw new Error("manual install");handleManualInstall()}}else{if(!n)throw new Error("cancel");handleCancelImport()}}function handleCancelImport(){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_cancel"),type:"log",source:"extension",timeout:8e3})}function handleInvalidPath(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.invalidPath",{path:e}),type:"error",source:"extension",timeout:8e3})}function handleManualInstall(){console.log(Editor.I18n.t("extension.store.install_manual_guide",{url:Editor.App.urls.manual})),Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_manual_title"),message:Editor.I18n.t("extension.store.install_manual_content"),source:"extension",type:"warn"})}function handleUnexpectedImportError(e){Editor.Task.addNotice({title:Editor.I18n.t("extension.store.install_fail"),message:null===e||void 0===e?void 0:e.message,type:"error",source:"extension"})}async function importPackage(e="project",t,n){const a=(null===n||void 0===n?void 0:n.extensionDisplayName)||path_1.basename(t,".zip"),o=null===n||void 0===n?void 0:n.forceImport,r="project"===e?Editor.Project.path:Editor.App.home,i=path_1.join(r,"./extensions");if(fs_extra_1.existsSync(i)||await fs_extra_1.ensureDir(i),!t||t===i)throw new Error("invalid path");let s;s="win32"===process.platform?unzipOfWin32:unzipOfDarwin;const c=path_1.join(i,".temp");let l="";try{const e=Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.decompressingNow",{extensionName:a}),type:"log",source:"extension"});await new Promise((n,o)=>{s(t,c,t=>{if(Editor.Task.removeNotice(e),t)return o(t.message);n(null),Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.decompressSuccess",{extensionName:a}),message:Editor.I18n.t("extension.menu.importingNow",{extensionName:a}),type:"success",source:"extension",timeout:5e3})})})}catch(e){throw new Error("decompress fail")}const d=path_1.join(c,"package.json"),p=async()=>{if(o)return!0;return 1!==(await Editor.Dialog.info(Editor.I18n.t("extension.menu.reinstall",{extensionName:a}),{buttons:[Editor.I18n.t("extension.menu.confirm"),Editor.I18n.t("extension.menu.cancel")],cancel:1})).response};if(fs_extra_1.existsSync(d)){const e=(await fs_extra_1.readJson(d)).name;if(l=path_1.join(i,e),fs_extra_1.existsSync(l)){if(!await p())throw await fs_extra_1.remove(c),new Error("cancel");await Editor.Package.disable(l,{replacement:!1}),await Editor.Package.unregister(l),await fs_extra_1.remove(l)}await fs_extra_1.rename(c,l)}else{Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.zipDirectoryWarnTitle",{extensionName:a}),message:Editor.I18n.t("extension.menu.zipDirectoryWarnContent"),type:"warn",source:"extension",timeout:5e3});const e=fs_extra_1.readdirSync(c);for(const t of e){const e=path_1.join(c,t,"package.json");if(!fs_extra_1.existsSync(e))continue;const n=(await fs_extra_1.readJson(e)).name;if(l=path_1.join(i,n),fs_extra_1.existsSync(l)){if(!await p())throw await fs_extra_1.remove(c),new Error("cancel");await Editor.Package.disable(l,{replacement:!1}),await Editor.Package.unregister(l),await fs_extra_1.remove(l)}await fs_extra_1.copy(path_1.join(c,t),l);break}}return await fs_extra_1.remove(c),Editor.Task.addNotice({title:Editor.I18n.t("extension.menu.importSuccess"),message:a,type:"success",source:"extension",timeout:5e3}),l}exports.addPackage=addPackage,exports.handleDecompressFail=handleDecompressFail,exports.handleCancelImport=handleCancelImport,exports.handleInvalidPath=handleInvalidPath,exports.handleManualInstall=handleManualInstall,exports.handleUnexpectedImportError=handleUnexpectedImportError,exports.importPackage=importPackage;const unzipOfDarwin=function(e,t,n){const a=path_1.dirname(t);fs_extra_1.ensureDirSync(a);const o=child_process_1.spawn("unzip",["-n",e,"-d",t]);let r="";o.stderr.on("data",e=>{r+=e});let i="";o.stdout.on("data",e=>{i+=e}),o.on("close",e=>{i&&console.log(i),r&&console.warn(r);let t=null;0!==e&&(t=new Error(Editor.I18n.t("extension.menu.decompressFail"))),n(t)})},unzipOfWin32=function(e,t,n){const a=path_1.dirname(t);fs_extra_1.ensureDirSync(a);const o=child_process_1.spawn(path_1.join(Editor.App.path,"../tools/unzip.exe"),["-n",e,"-d",t]);let r="";o.stderr.on("data",e=>{r+=e});let i="";o.stdout.on("data",e=>{i+=e}),o.on("close",e=>{i&&console.log(`[extension] ${i}`),r&&console.warn(`[extension] ${r}`);let t=null;0!==e&&(t=new Error(Editor.I18n.t("extension.menu.decompressFail"))),n(t)})};function recursive(e,t){!function e(n){if(!fs_extra_1.existsSync(n))return;fs_extra_1.statSync(n).isDirectory()?fs_extra_1.readdirSync(n).forEach(t=>{e(path_1.join(n,t))}):t(n)}(e)}exports.recursive=recursive;