"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.unload=exports.load=void 0;const requestProgress=require("request-progress"),request=require("request"),fs_extra_1=require("fs-extra"),path_1=require("path"),semver_1=require("semver"),utils_1=require("../public/utils");function load(){}function unload(){}exports.load=load,exports.unload=unload,exports.methods={async isCreator3DPackage(e){if(e.dependency)return semver_1.gte(semver_1.valid(semver_1.coerce(e.dependency)),"3.0.0")},downloadZip:async(e,r)=>(await fs_extra_1.ensureDir(path_1.dirname(e.file)),new Promise((t,o)=>{const n=encodeURI(e.url);requestProgress(request(n),{delay:300}).on("progreass",function(t){e.downloadProgress=t.percent,r()}).on("error",function(e){o(e)}).on("end",function(o,n){e.downloadProgress=1,r(),t(null)}).pipe(fs_extra_1.createWriteStream(e.file))})),async installExtension(e,r){const t="en"===Editor.I18n.getLanguage()&&e.name_en||e.name;if(!fs_extra_1.existsSync(e.file))throw new Error(Editor.I18n.t("extension.store.install_exists_error"));if(".zip"!==path_1.extname(e.file))throw new Error(Editor.I18n.t("extension.store.install_exname_error"));const o="zh"===Editor.I18n.getLanguage()?e.name:e.name_en,n=await Editor.Dialog.info(Editor.I18n.t("extension.store.install_package",{name:o}),{cancel:2,buttons:[Editor.I18n.t("extension.create_package.global"),Editor.I18n.t("extension.create_package.local"),Editor.I18n.t("extension.create_package.cancel")]});if(2===n.response)throw new Error("cancel");try{const r=await utils_1.importPackage(0===n.response?"global":"project",e.file,{extensionDisplayName:t});return Editor.Package.register(r),void await Editor.Message.request("extension","enable",r,!0)}catch(r){const o=r.message;switch(o){case"decompress fail":utils_1.handleDecompressFail(e.file,t,!1);break;default:throw new Error(o)}}},async copyZip(e,r){const t="zh"===Editor.I18n.getLanguage()?e.name:e.name_en,o=await Editor.Dialog.select({title:Editor.I18n.t("cloud-component.store.copy_to_directory"),type:"directory"});if(!o||!o.filePaths[0])throw new Error("cancel");await fs_extra_1.copy(e.file,path_1.join(o.filePaths[0],t+".zip"))}};