"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,a){function _(e){try{s(o.next(e))}catch(e){a(e)}}function r(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(_,r)}s((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Canvas=exports.RENDER2D=exports.CANVAS=void 0;const Node_1=require("./Node"),UITransform_1=require("./UITransform"),Widget_1=require("./Widget"),utlis_1=require("../common/utlis"),Camera_1=require("./Camera");exports.CANVAS={__type__:"cc.Canvas",_name:"",_objFlags:0,node:null,_enabled:!0,_cameraComponent:null,_alignCanvasWithScreen:!0,_id:"e6QojeC9FOBZjtx9CZWAUA"};const NAME="RenderRoot2D";exports.RENDER2D={__type__:`cc.${NAME}`,_name:"",_objFlags:0,node:null,_enabled:!0};class Canvas{static checkDesignResolution(e,t){return __awaiter(this,void 0,void 0,function*(){const n=e.map(e=>"cc.Canvas"===e.__type__?e.node.__id__:null).filter(Boolean);for(let o of n){const n=e[o]&&e[o]._name,i=(0,utlis_1.getComponentByType)(o,"cc.UITransform",e);if(i){const{width:e,height:o}=yield(0,utlis_1.getDesignResolution)();i._contentSize.width===e&&i._contentSize.height===o||console.warn(Editor.I18n.t("importer.canvas_tips",{scene:t+".scene",name:n}))}}})}static getCameraIDByCanvasChildren(e,t){const n=t[e.node.__id__];for(let e of n._children){const n=t[e.__id__];if("Main Camera"===n._name)for(let e of n._components){if("cc.Camera"===t[e.__id__].__type__)return e}}return null}static updateCameraComponent(e,t){return __awaiter(this,void 0,void 0,function*(){for(let n=0;n<e.length;++n){const o=e[n];if("cc.Canvas"===o.__type__){const n=Canvas.getCameraIDByCanvasChildren(o,e);if(n){o._cameraComponent=n;const e=t[n.__id__];o._alignCanvasWithScreen=e._alignWithScreen}else Camera_1.Camera.addToScene(o,e)}}})}static insert(e){return __awaiter(this,void 0,void 0,function*(){const t=e[1],n=t._children.slice();let o,i;for(const a of n){const n=e[a.__id__];if(!(0,utlis_1.hasComponent)(n,e,"cc.Canvas")&&(0,utlis_1.hasUIRenderComponent)(n,e)){const _=yield Editor.Profile.getProject("project","general.designResolution.width"),r=yield Editor.Profile.getProject("project","general.designResolution.height");if(!o){o=Node_1.Node.create(NAME,1),e.push(o),i=e.length-1,t._children.push({__id__:i});const n=Canvas.create(i,NAME,!0);e.push(n);const a=e.length-1;Node_1.Node.addComponents(o,a);const s=UITransform_1.UITransform.create(i);s._contentSize.width=_,s._contentSize.height=r,s._anchorPoint.x=0,s._anchorPoint.y=0,e.push(s),Node_1.Node.addComponents(o,e.length-1);const c=Widget_1.Widget.create(i);c._alignFlags=45,e.push(c),Node_1.Node.addComponents(o,e.length-1)}n._parent={__id__:i},Node_1.Node.addChildren(o,a.__id__);const s=t._children.indexOf(a);t._children.splice(s,1)}}})}static create(e,t,n){let o;return o=n?JSON.parse(JSON.stringify(exports.RENDER2D)):JSON.parse(JSON.stringify(exports.CANVAS)),t&&(o._name=t),e&&(o.node={__id__:e}),o}static migrate(e){return __awaiter(this,void 0,void 0,function*(){const t=JSON.parse(JSON.stringify(exports.CANVAS));for(const n in e){const o=e[n];"__type__"!==n&&void 0!==o&&null!==o&&("node"===n?(t.node=o,(0,utlis_1.setColor)(t,o.__id__,e)):"_name"!==n&&"_id"!==n&&"_objFlags"!==n&&"_enabled"!==n||(t[n]=o))}return t})}static apply(e,t,n){return __awaiter(this,void 0,void 0,function*(){const o=yield Canvas.migrate(t[e]);return n.splice(e,1,o),o})}}exports.Canvas=Canvas;