"use strict";var __awaiter=this&&this.__awaiter||function(t,e,s,r){return new(s||(s=Promise))(function(i,a){function n(t){try{_(r.next(t))}catch(t){a(t)}}function o(t){try{_(r.throw(t))}catch(t){a(t)}}function _(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(n,o)}_((r=r.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImporterBase=void 0;const node_uuid_1=require("node-uuid"),utlis_1=require("./utlis"),path_1=require("path"),fs_extra_1=require("fs-extra"),utlis_2=require("./utlis"),diff_1=require("./diff"),convertor_1=require("../convertor");class ImporterBase{constructor(){this.type="",this.destFsPath="",this.destMetaFsPath="",this.sourceFsPath="",this.pathInfo=null,this._2dMeta=null,this._3dMeta=null,this._2dTo3dSource=null}checkUuid(t){return __awaiter(this,void 0,void 0,function*(){const e=yield Editor.Message.request("asset-db","query-path",t.uuid);if(e&&e!==this.destFsPath){const e=(0,node_uuid_1.v4)();return(0,utlis_2.saveUuid)(t.uuid,e),e}if("sprite"===t.type&&t.subMetas)for(const e in t.subMetas){const s=t.subMetas[e];(0,utlis_2.saveUuid)(s.uuid,s.rawTextureUuid)}return t.uuid})}get3DUuid(){try{return(0,fs_extra_1.readJSONSync)(this.destMetaFsPath).uuid}catch(t){return(0,node_uuid_1.v4)()}}reset(){this.destFsPath="",this.sourceFsPath="",this.pathInfo=null,this._2dMeta=null,this._3dMeta=null,this._2dTo3dSource=null}static getPathInfo(t,e){let s=(0,path_1.relative)(t,e);s.startsWith("assets")||(s=(0,path_1.join)("assets",s));let r=(0,path_1.join)(Editor.Project.path,s);if(r.endsWith(".fire"))r=r.replace(/.fire+$/g,".scene");else if(r.endsWith(".js")){(0,fs_extra_1.readJSONSync)(e+".meta").isPlugin||(r=r.replace(/.js+$/g,".ts"))}return{to:r,toMeta:r+".meta",from:e,fromMeta:e+".meta",pathInfo:(0,path_1.parse)(e)}}static isNew(t,e){try{if(e.endsWith("assets"))return!1;const s=ImporterBase.getPathInfo(t,e);if((0,fs_extra_1.existsSync)(s.to)&&(0,fs_extra_1.existsSync)(s.toMeta)){const t=(0,fs_extra_1.readJSONSync)(s.toMeta);return"directory"!==t.importer&&(0,fs_extra_1.readJSONSync)(s.fromMeta).uuid!==t.uuid}return!0}catch(t){return!0}}beforeImport(t,e){return __awaiter(this,void 0,void 0,function*(){this.reset(),this.sourceFsPath=e;const s=ImporterBase.getPathInfo(t,e);this.destFsPath=s.to,this.destMetaFsPath=s.toMeta,this.pathInfo=s.pathInfo,this._2dMeta=this.read2dMeta(e);const r=this._2dMeta?yield this.checkUuid(this._2dMeta):this.get3DUuid();return this._3dMeta=this.createNewMeta(r),this._3dMeta.uuid=r,this._2dMeta&&utlis_2.importProjectAssets.set(this._2dMeta.uuid,{type:(0,path_1.extname)(e),basePath:e,outPath:this.destMetaFsPath,outUuid:this._2dMeta.uuid,meta:this._2dMeta}),!0})}needImport(){let t=!0;if((0,fs_extra_1.existsSync)(this.destFsPath)&&(0,fs_extra_1.existsSync)(this.destMetaFsPath)){const e=(0,fs_extra_1.readJSONSync)(this.destMetaFsPath);t=this._3dMeta.uuid!==e.uuid}return t}import(t){return __awaiter(this,void 0,void 0,function*(){return!0})}afterImport(){return __awaiter(this,void 0,void 0,function*(){if(this.copySync(this.sourceFsPath),this._2dTo3dSource)try{this.destFsPath.endsWith(".ts")||this.destFsPath.endsWith(".plist")||this.destFsPath.endsWith(".effect")?(0,fs_extra_1.writeFileSync)(this.destFsPath,this._2dTo3dSource,{encoding:"utf8"}):(0,fs_extra_1.writeJSONSync)(this.destFsPath,this._2dTo3dSource,{spaces:2})}catch(t){console.error(t)}this.saveMeta()})}createNewMeta(t){return{uuid:t||"",imported:!1,importer:"*",files:[],subMetas:{},userData:{},ver:"0.0.1"}}read2dMeta(t){try{return t.endsWith(".meta")||(t+=".meta"),(0,fs_extra_1.existsSync)(t)?(0,fs_extra_1.readJSONSync)(t):null}catch(t){return console.error(t),null}}copySync(t,e){try{if(!(0,fs_extra_1.existsSync)(t))return 0;e?((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(e)),(0,fs_extra_1.copyFileSync)(t,e)):((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(this.destFsPath)),(0,fs_extra_1.copyFileSync)(t,this.destFsPath))}catch(t){console.error(t)}}saveMeta(){return __awaiter(this,void 0,void 0,function*(){this.destMetaFsPath.endsWith(".meta")||(this.destMetaFsPath+=".meta");try{(0,fs_extra_1.writeJSONSync)(this.destMetaFsPath,this._3dMeta,{spaces:2})}catch(t){console.error(t)}})}writeFileSync(t,e){try{(0,fs_extra_1.writeFileSync)(t,e,{encoding:"utf8"})}catch(t){console.error(t)}}readJSONSync(t){try{return(0,fs_extra_1.readJSONSync)(t||this.sourceFsPath)}catch(t){return console.error(t),null}}readFileSync(t){try{return(0,fs_extra_1.readFileSync)(t||this.sourceFsPath,"utf8")}catch(t){return console.error(t),null}}migratePlatformSettings(t){return __awaiter(this,void 0,void 0,function*(){return yield(0,utlis_2.migratePlatformSettings)(t)})}static getUuid(t,e){return __awaiter(this,void 0,void 0,function*(){if(diff_1.UUID_2D_TO_3D.has(t))return diff_1.UUID_2D_TO_3D.get(t);if(diff_1.UUID_UI_2D_TO_3D.has(t))return diff_1.UUID_UI_2D_TO_3D.get(t);if(diff_1.UUID_SKIP_EFFECT.has(t)&&console.warn(Editor.I18n.t("importer.effect_warn_tips",{name:diff_1.UUID_SKIP_EFFECT.get(t)})),t=yield ImporterBase.ensureDefaultAssets2DFor3D(t),t=(0,utlis_2.getNewUuid)(t),e&&!t.includes("@")){const s=`@${ImporterBase.getNameByID(e)}`;t.endsWith(s)||(t+=s)}return t})}static getNewUuid(t){return(0,utlis_2.getNewUuid)(t)}static getNameByID(t){return(0,utlis_1.nameToId)(t)}static getDefaultAssets2D(t){return(0,utlis_2.getDefaultAssets2D)(t)}static ensureDefaultAssets2DFor3D(t){return __awaiter(this,void 0,void 0,function*(){const e=utlis_2.importSubAssets.get(t);if(e)t=e.baseUuid;else{const e=utlis_2.importProjectAssets.get(t);e&&(t=e.outUuid)}const s=(0,utlis_2.getDefaultAssets2D)(t);if(s&&s.path){if(diff_1.UUID_UI_2D_TO_3D.has(s.baseUuid))return diff_1.UUID_UI_2D_TO_3D.get(s.baseUuid);if(diff_1.UUID_2D_TO_3D.has(s.baseUuid))return diff_1.UUID_2D_TO_3D.get(s.baseUuid);const t=(0,path_1.join)(__dirname,"../../static");let r=(0,path_1.relative)(t,s.path);r.startsWith("assets")||(r=(0,path_1.join)("assets",r));const i=(0,path_1.join)(Editor.Project.path,r);try{if(!(0,fs_extra_1.existsSync)(i)){(i.endsWith(".mtl")||i.endsWith(".effect"))&&(yield(0,utlis_2.import2DChunks)(!1));const e=(0,convertor_1.getConverter)((0,path_1.extname)(s.path));if(e){yield e.beforeImport(t,s.path),(yield e.import())&&(yield e.afterImport())}const r=(0,path_1.join)(Editor.Project.path,"asset","migrate-resources","README.md");(0,fs_extra_1.existsSync)(r)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r)),(0,fs_extra_1.writeFileSync)(r,(0,fs_extra_1.readFileSync)((0,path_1.join)(t,"migrate-resources","README.md"),{encoding:"utf8"})))}}catch(t){console.error(t)}return e?e.uuid:s.baseUuid}return e?e.uuid:t})}queryCCClass(t,e){return __awaiter(this,void 0,void 0,function*(){return t.contentWindow.postMessage(e,"*"),new Promise((t,e)=>{window.addEventListener("message",function e(s){window.removeEventListener("message",e,!1),t(s.data)},!1)})})}replaceScript(t){try{const e=(0,path_1.join)(__dirname,"../../static/migrate-resources/default-assets-2d/scripts"),s=(0,path_1.join)(e,t),r=(0,path_1.join)(Editor.Project.path,"assets","default-assets-2d","scripts",t);(0,fs_extra_1.existsSync)(r)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r)),(0,fs_extra_1.copyFileSync)(s,r));const i=s+".meta",a=r+".meta";(0,fs_extra_1.existsSync)(a)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(a)),(0,fs_extra_1.copyFileSync)(i,a));const n=(0,fs_extra_1.readJSONSync)(i);return require("@base/electron-module").require("EditorExtends").UuidUtils.compressUuid(n.uuid,!1)}catch(t){return console.error(t),""}}ensureDefaultSprite2DFor3D(t){for(const e in t){const s=t[e];"cc.StudioComponent"===s.__type__?s.__type__=this.replaceScript("studio-component.ts"):"cc.StudioWidget"===s.__type__&&(s.__type__=this.replaceScript("studio-widget.ts"))}return t}}exports.ImporterBase=ImporterBase;