"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(r,o){function a(e){try{p(s.next(e))}catch(e){o(e)}}function n(e){try{p(s.throw(e))}catch(e){o(e)}}function p(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,n)}p((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSImporter=void 0;const base_1=require("../common/base"),utlis_1=require("../common/utlis"),parseCode_1=require("../common/parseCode");class JSImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="script"}beforeImport(e,t){const i=Object.create(null,{beforeImport:{get:()=>super.beforeImport}});return __awaiter(this,void 0,void 0,function*(){return!utlis_1.SKIPS_SCRIPT.find(e=>t.endsWith(e))&&(yield i.beforeImport.call(this,e,t))})}import(e){return __awaiter(this,void 0,void 0,function*(){this._3dMeta.ver="4.0.21",this._3dMeta.importer="javascript";let t=this.pathInfo.name;t=yield utlis_1.scriptName.getValidClassName(t);const i=this.readFileSync();if(i){let s="";i.trim().split("\n").forEach(e=>{s+="// "+e+"\n"});let r="";if(this._2dMeta&&this._2dMeta.isPlugin)this._3dMeta.userData={isPlugin:this._2dMeta.isPlugin,loadPluginInWeb:this._2dMeta.loadPluginInWeb,loadPluginInNative:this._2dMeta.loadPluginInNative,loadPluginInEditor:this._2dMeta.loadPluginInEditor,importAsPlugin:this._2dMeta.isPlugin};else{const o=yield parseCode_1.parseJSCode(this.sourceFsPath,t);if(i.includes("cc.Class(")){const s=yield this.queryCCClass(e.$.engine2D,{type:"js",path:this.destFsPath,name:t,code:i,classCount:1,ccKeys:o.ccKeys,importCodeMap:o.importCodeMap,otherCodeMap:o.otherCodeMap,classCodeMap:o.classCodeMap,endCodeMap:o.endCodeMap,replaceScriptList:utlis_1.replaceScriptList});s&&(t!==s.name&&console.warn(Editor.I18n.t("importer.script_rename_tips",{old:t,new:s.name})),utlis_1.updateReplaceScriptList(s.replaceScriptList),r=s.classCode)}else console.warn(Editor.I18n.t("importer.skip_script_warn",{name:this.pathInfo.name}));r+="/**\n",r+=` * ${Editor.I18n.t("importer.plugin_js_tips")}\n`,r+=" */\n",r+=s,this._2dTo3dSource=r,utlis_1.scriptList.set(this.pathInfo.name,this.destFsPath)}}return!0})}}exports.JSImporter=JSImporter;