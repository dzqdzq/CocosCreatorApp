"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))(function(s,i){function u(e){try{n(a.next(e))}catch(e){i(e)}}function o(e){try{n(a.throw(e))}catch(e){i(e)}}function n(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(u,o)}n((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlistImporter=void 0;const base_1=require("../common/base"),fs_extra_1=require("fs-extra"),path_1=require("path"),utlis_1=require("../common/utlis"),plist=require("plist");class PlistImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="plist"}import(){return __awaiter(this,void 0,void 0,function*(){return!this._2dMeta||("Texture Packer"===this._2dMeta.type?(this._3dMeta.ver="1.0.6",this._3dMeta.importer="sprite-atlas",this.importTexturePacker()):(this._3dMeta.ver="1.0.2",this._3dMeta.importer="particle",this.importParticle()))})}importTexturePacker(){return __awaiter(this,void 0,void 0,function*(){try{let e=this._3dMeta.userData;const t=yield(0,fs_extra_1.readFile)(this.sourceFsPath,"utf8"),r=plist.parse(t);e.atlasTextureName=r.metadata.realTextureFileName,e.format=r.metadata.format,e.textureUuid=`${this._2dMeta.rawTextureUuid}@${base_1.ImporterBase.getNameByID("texture")}`,e=this._3dMeta.userData;for(const t in r.frames){const r=this._2dMeta.subMetas[t],a=base_1.ImporterBase.getNameByID((0,path_1.parse)(t).name),s=this.createNewMeta();s.importer="sprite-frame";for(const e in r)switch(e){case"ver":case"uuid":case"subMetas":case"spriteType":break;case"rawTextureUuid":s.userData.atlasUuid=r[e];break;default:s.userData[e]=r[e]}s.imageUuidOrDatabaseUri=e.textureUuid,this._3dMeta.subMetas[a]=s;for(let e in this._2dMeta.subMetas){const t=this._2dMeta.subMetas[e];t&&(e=(0,path_1.basename)(e,(0,path_1.extname)(e)),utlis_1.importSubAssets.set(t.uuid,{baseUuid:this._2dMeta.uuid,uuid:`${this._2dMeta.uuid}@${base_1.ImporterBase.getNameByID(e)}`}))}const i=utlis_1.importProjectAssets.get(this._2dMeta.rawTextureUuid);if(i){const e=this.readJSONSync(i.outPath);"texture"!==e.userData.type&&(e.userData.type="texture",(0,fs_extra_1.writeJSONSync)(i.outPath,e,{spaces:2}))}}return!0}catch(e){return console.error(e),!1}})}importParticle(){return __awaiter(this,void 0,void 0,function*(){try{const e=yield(0,fs_extra_1.readFile)(this.sourceFsPath,"utf8"),t=plist.parse(e);return t.spriteFrameUuid?t.spriteFrameUuid=yield base_1.ImporterBase.getUuid(t.spriteFrameUuid,"spriteFrame"):t.textureUuid&&(t.spriteFrameUuid=yield base_1.ImporterBase.getUuid(t.textureUuid,"spriteFrame"),delete t.textureUuid),t.blendFuncSource&&(t.blendFuncSource=(0,utlis_1.getBlendFactor2DTo3D)(t.blendFuncSource)),t.blendFuncDestination&&(t.blendFuncDestination=(0,utlis_1.getBlendFactor2DTo3D)(t.blendFuncDestination)),this._2dTo3dSource=plist.build(t),!0}catch(e){return console.log(e),!1}})}}exports.PlistImporter=PlistImporter;