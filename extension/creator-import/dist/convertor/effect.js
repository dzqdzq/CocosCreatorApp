"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,c){function s(e){try{o(n.next(e))}catch(e){c(e)}}function a(e){try{o(n.throw(e))}catch(e){c(e)}}function o(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}o((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EffectImporter=void 0;const base_1=require("../common/base"),utlis_1=require("../common/utlis"),path_1=require("path"),fs_extra_1=require("fs-extra");class EffectImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="effect"}import(e){return __awaiter(this,void 0,void 0,function*(){let e=this.readFileSync();return e&&(e=this._replaceKeyword(e),e=this._replace(e)),this._2dTo3dSource=e,this._3dMeta.ver="1.3.7",this._3dMeta.importer="effect",console.warn(Editor.I18n.t("importer.effect_tips",{name:(0,path_1.basename)(this.destFsPath),uuid:this._3dMeta.uuid})),!0})}_replaceKeyword(e){return e=(e=(e=(e=(e=e.replace(/texture:/g,"mainTexture:")).replace(/texture;/g,"mainTexture;")).replace(/texture,/g,"mainTexture,")).replace(/vs/g,"unlit-vs")).replace(/fs/g,"unlit-fs")}_replace(e){const t=e.match(/#include +[<]([^>]+)[>]/g)||[];for(const r of t){const t=r.match(/(?<=#include <)(.*)(?=>)/g);if(t&&t[0]){const n=t[0];utlis_1.chunksCacheBy2D.get(n)&&(e=e.replace(r,r))}}return e}_writeChunksSync(e,t){const r=this.readFileSync(e);if(r){const e=r.match(/#include +[<]([^>]+)[>]/g)||[];for(const t of e){const e=t.match(/(?<=#include <)(.*)(?=>)/g);if(e&&e[0]){const t=e[0],r=utlis_1.chunksCacheBy2D.get(t);r&&this._writeChunksSync(r.from,r.to)}}(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(t)),this.writeFileSync(t,r)}}}exports.EffectImporter=EffectImporter;