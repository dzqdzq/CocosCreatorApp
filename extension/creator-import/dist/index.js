"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(s,o){function n(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(n,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),convertor_1=require("./convertor"),utlis_1=require("./common/utlis"),MigrateManager_1=require("./components/MigrateManager"),base_1=require("./common/base");exports.style=fs_extra_1.readFileSync(path_1.join(__dirname,"../creator/index.css"),"utf8");const{I18n:I18n,Dialog:Dialog,Message:Message}=Editor,MANUAL="https://github.com/cocos-creator/migrate-cocos-creator2.x-plugin";exports.linteners={resize(){this.$.tree.render(!0)}},exports.template='\n    <header>\n        <h1>\n            <ui-label value="i18n:importer.title"></ui-label>\n        </h1>\n        \n        <ui-progress></ui-progress>        \n\n        <ui-file \n            class="project" \n            type="directory"\n            placeholder="i18n:importer.select_dialog.title"\n        ></ui-file>\n    </header>\n    <section>\n        <ui-tree></ui-tree>\n    </section>\n                \n    <footer>\n        \n        <ui-button class="btn_notes">\n            <ui-label value="i18n:importer.btn_notes"></ui-label>\n        </ui-button>\n\x3c!--        <ui-input class="search" placeholder="i18n:importer.search"></ui-input>--\x3e\n\n\x3c!--        <ui-button class="serialize" style="display: none">--\x3e\n\x3c!--            <ui-label value="serialize"></ui-label>--\x3e\n\x3c!--        </ui-button>--\x3e\n        \n        <ui-button class="import">\n            <ui-label value="i18n:importer.btnImport"></ui-label>\n        </ui-button>       \n    </footer>\n    \n    <ui-label class="tips" value="i18n:importer.tips"></ui-label>\n    \n    <iframe class="engine2D" style="display: none"></iframe>\n',exports.$={tree:"ui-tree",project:".project",import:".import",progress:"ui-progress",search:".search",engine2D:".engine2D",notes:".btn_notes"},exports.methods={updateTreeState(){this.$.tree.list.forEach(e=>{const t=e.detail;t.isNew=base_1.ImporterBase.isNew(this.projectRoot,t.file)}),this.$.tree.render(!0)},updateTree(e){return __awaiter(this,void 0,void 0,function*(){const t=[];!function t(r,i){try{if(r.endsWith(".DS_Store"))return;if(utlis_1.SKIPS_SCRIPT.includes(path_1.basename(r)))return;const s=fs_extra_1.statSync(r),o=path_1.extname(r),n=r.split("assets");let a="";n&&(a="db://assets"+n[1].replace(o,""));const c={detail:{value:path_1.basename(r),file:r,checked:!0,extname:o,isDirectory:s.isDirectory(),legal:!!convertor_1.getConverter(o)&&!s.isDirectory(),isNew:base_1.ImporterBase.isNew(e,r),path:a},showArrow:!1,children:[]};s.isDirectory()?(c.showArrow=!0,fs_extra_1.readdirSync(r).forEach(i=>{const s=path_1.join(r,i);i.endsWith(".meta")?utlis_1.addImportProjectAssets(e,s):t(s,c.children)}),c.children.length>0&&i.push(c)):c.detail.legal&&i.push(c)}catch(e){}}(path_1.join(e,"assets"),t);const r=yield Editor.Message.request("assets","unstaging");let i="type";r&&(i=r.sortType),this.sortTree(t,i),this.$.tree.tree=this.baseTree=t})},sortTree(e,t){e.sort((e,r)=>{const i=e.detail,s=r.detail;return i.isDirectory&&!s.isDirectory?-1:!i.isDirectory&&s.isDirectory?1:"type"===t&&i.extname!==s.extname?utlis_1.collator.compare(i.extname,s.extname):utlis_1.collator.compare(i.path,s.path)});for(const r of e)this.sortTree(r.children,t)},scanProject(e){return __awaiter(this,void 0,void 0,function*(){if(!e)return;const t=path_1.join(e,"assets"),r=path_1.join(e,"project.json");if(!fs_extra_1.existsSync(t)||!fs_extra_1.existsSync(r))return Dialog.warn(I18n.t("importer.warn_dialog.message"),{detail:I18n.t("importer.warn_dialog.detail",{path:e})}),!1;const i=fs_extra_1.readJSONSync(r);return i.version&&-1!==utlis_1.compareVersion(i.version,"2.4.3")||Dialog.warn(I18n.t("importer.warn_dialog.title"),{detail:I18n.t("importer.warn_dialog.version",{version:i.version})}),this.projectRoot=e,this.$.import.removeAttribute("disabled"),utlis_1.uuidList.clear(),utlis_1.importProjectAssets.clear(),utlis_1.importSubAssets.clear(),utlis_1.initGroupList(t),utlis_1.scanningDefaultAssets2D(),yield this.updateTree(this.projectRoot),this.updateList(),!0})},updateList(){this.totalTree=[],this.list=[],this.$.tree.list.forEach(e=>{if(e.detail.checked){if(!e.detail.legal)return;this.list.push(e)}this.totalTree.push(e)}),this.progressCurrentIdx=0,this.$.progress.message=I18n.t("importer.import_message_init",{current:this.progressCurrentIdx,total:this.list.length}),0===this.list.length?this.$.import.setAttribute("disabled",""):this.$.import.removeAttribute("disabled")},getScripts(){const e=new Map;return function t(r){fs_extra_1.readdirSync(r).forEach(i=>{const s=path_1.join(r,i),o=fs_extra_1.statSync(s);if(o.isDirectory()&&t(s),!o.isDirectory()&&s.endsWith(".ts"))try{const t=fs_extra_1.readFileSync(s,"utf8").match(/@ccclass\('(.*)'\)/),r=t&&t[1];r&&e.set(path_1.basename(s,path_1.extname(s)),{className:r,path:s})}catch(e){console.error(e+",\n this file path: "+s)}})}(path_1.join(Editor.Project.path,"assets")),e.size>0?e:utlis_1.scriptList},replaceScript(){const e=this.getScripts();for(const t of utlis_1.replaceScriptList){const r=void 0!==t.extendClassName,i=(r?t.extendClassName:t.importPath).replace(/[.|\\/]/g,""),s=e.get(i);if(s&&s.className){let e=fs_extra_1.readFileSync(t.path,"utf8");const i=path_1.dirname(t.path),o=path_1.dirname(s.path);let n=path_1.relative(path_1.dirname(t.path),s.path);if(i===o&&(n="./"+n),r)e=(e=e.replace(t.extendClassName,n.replace(".ts",""))).replace(/@@@@@@/g,s.className);else{const r=`from '${n.replace(".ts","")}'`;e=(e=e.replace(`from '${t.importPath}'`,r)).replace(`from "${t.importPath}"`,r)}fs_extra_1.writeFileSync(t.path,e,{encoding:"utf8"})}}},replaceFbx(){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,t)=>{try{let r=0;0===utlis_1.replaceFbxUuidMap.size&&e(!0),utlis_1.replaceFbxUuidMap.forEach((t,i)=>{let s=!1;const o=fs_extra_1.readJSONSync(i);if(o)for(const e of t){const t=o.subMetas[e.name];t&&(t.uuid=e.uuid,s=!0)}s&&fs_extra_1.writeJSONSync(i,o,{spaces:2}),++r===utlis_1.replaceFbxUuidMap.size&&e(!0)})}catch(e){t(e),console.error(e)}})})},importProject(){return __awaiter(this,void 0,void 0,function*(){let e=this.list;e=e.filter(e=>e.detail.checked),convertor_1.bubbleSort(e),utlis_1.clear(),this.progressCurrentIdx=0,this.progressCurrentName="";for(let t=0;t<e.length;t++){const r=e[t].detail;this.progressCurrentIdx=t+1,this.progressCurrentName=r.value,this.$.progress.value=this.progressCurrentIdx/e.length*100,this.$.progress.message=I18n.t("importer.import_message",{current:this.progressCurrentIdx,total:e.length,name:r.value});const i=convertor_1.getConverter(r.extname);if(i){"mtl"!==i.type&&"effect"!==i.type||(yield utlis_1.import2DChunks());let s=yield i.beforeImport(this.projectRoot,r.file);s&&(s=yield i.import(this)),s&&(yield i.afterImport());const o=e[t+1];if(o){const e=o.detail.extname,t=convertor_1.getConverter(e);if(t&&t.type!==i.type){if("script"===i.type||"script"===t.type)continue;yield Message.request("asset-db","refresh-asset","db://assets")}}}}this.replaceScript(),console.log(Editor.I18n.t("importer.import_refresh")),yield Message.request("asset-db","refresh-asset","db://assets"),console.log(Editor.I18n.t("importer.import_refreshend"));try{yield this.replaceFbx()}catch(e){}MigrateManager_1.MigrateManager.logs.length>0&&console.log(I18n.t("importer.no_support_type",{type:MigrateManager_1.MigrateManager.logs.toString()})),this.$.progress.value=100,this.$.progress.message=I18n.t("importer.complete_message")})},onSerializeComponent(){return __awaiter(this,void 0,void 0,function*(){yield Editor.Message.request("scene","execute-scene-script",{name:"importer",method:"onSerializeComponent"})})}},exports.ready=function(){return __awaiter(this,void 0,void 0,function*(){this.$.engine2D.src=path_1.join(__dirname,"../creator/engine/engine2D.html"),convertor_1.registerConverter(),Message.addBroadcastListener("i18n:change",()=>{if(this.$.progress.message){const e=this.list.length;this.progressCurrentIdx===e?this.$.progress.message=I18n.t("importer.complete_message"):0===this.progressCurrentIdx?this.$.progress.message=I18n.t("importer.import_message_init",{current:0,total:e}):(this.$.progress.value=this.progressCurrentIdx/e*100,this.$.progress.message=I18n.t("importer.import_message",{current:this.progressCurrentIdx,total:e,name:this.progressCurrentName}))}}),this.$.tree.setTemplateInit("item",e=>{e.addEventListener("contextmenu",()=>{Editor.Menu.popup({menu:[{label:I18n.t("importer.menu.popup_open"),click(){electron_1.shell.showItemInFolder(e.data.detail.file)}}]})})});const e=path_1.join(__dirname,"../creator/icon/new.png");this.$.tree.setTemplate("text",'<ui-checkbox></ui-checkbox><ui-icon></ui-icon><span class="name"></span><image class="new" ></image>'),this.$.tree.setTemplateInit("text",t=>{t.$checkbox=t.querySelector("ui-checkbox"),t.$icon=t.querySelector("ui-icon"),t.$name=t.querySelector(".name"),t.$new=t.querySelector(".new"),t.$new.style.display="none",t.$new.src=e,t.$checkbox.addEventListener("confirm",()=>{const e=t.data;e.detail.checked=!e.detail.checked,function e(t,r){t.detail.checked=r,t.children&&t.children.forEach(t=>{e(t,r)})}(e,e.detail.checked),function e(t){if(!t)return;const r=t.children.some(e=>e.detail.checked);r!==t.detail.checked&&(t.detail.checked=r,e(t.parent))}(e.parent),this.updateList(),this.$.tree.render(!0)})}),this.$.tree.setRender("text",(e,t)=>{e.$checkbox.value=t.detail.checked,e.$name.innerHTML=t.detail.value,t.detail.isDirectory?e.$icon.setAttribute("value","folder"):e.$icon.setAttribute("value","file"),e.$new.style.display=t.detail.isNew?"":"none"}),this.$.tree.setRender("item",e=>{e.data.detail.legal?e.removeAttribute("disabled"):e.setAttribute("disabled","")}),this.$.tree.css=fs_extra_1.readFileSync(path_1.join(__dirname,"../creator/tree.css"),"utf8"),this.$.serialize&&this.$.serialize.addEventListener("confirm",()=>{this.onSerializeComponent()}),this.$.search&&this.$.search.addEventListener("change",e=>{const t=e.target.value;this.$.tree.tree=t?this.totalTree.map(e=>e.detail.value.toLocaleLowerCase().indexOf(t.toLocaleLowerCase())>-1&&e).filter(Boolean):this.baseTree,this.$.tree.render(!0)}),this.$.import.setAttribute("disabled",""),this.$.project.addEventListener("change",e=>__awaiter(this,void 0,void 0,function*(){const t=e.target.value;(yield this.scanProject(t))?Editor.Profile.setConfig("importer","import-path",t):this.$.project.value=this.projectRoot})),this.$.import.addEventListener("confirm",()=>__awaiter(this,void 0,void 0,function*(){this.$.import.setAttribute("disabled",""),yield this.importProject(),console.log(Editor.I18n.t("importer.complete_message")),setTimeout(()=>__awaiter(this,void 0,void 0,function*(){this.updateTreeState(),this.$.import.removeAttribute("disabled")}))})),this.$.notes&&this.$.notes.addEventListener("confirm",()=>{require("electron").shell.openExternal(MANUAL)});const t=yield Editor.Profile.getConfig("importer","import-path");this.$.project.value=t,yield this.scanProject(t)})},exports.beforeClose=function(){},exports.close=function(){};