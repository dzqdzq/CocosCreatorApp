"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(s,r){function n(e){try{_(o.next(e))}catch(e){r(e)}}function a(e){try{_(o.throw(e))}catch(e){r(e)}}function _(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,a)}_((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimImporter=void 0;const base_1=require("../common/base"),AnimationClip_1=require("../components/AnimationClip");class AnimImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="anim"}mergersCommonTarget(e,t,i,o){const s={modifiers:[]};if(o&&s.modifiers.push(o),"x"===e||"y"===e||"z"===e){s.modifiers.push("position");const o=i.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(s.modifiers));-1===o?(t.commonTarget=i.length,i.push(s)):t.commonTarget=o,t.modifiers.push(this.getModifier(e))}else if("scaleX"===e||"scaleY"===e||"scaleZ"===e){s.modifiers.push("scale");const o=i.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(s.modifiers));-1===o?(t.commonTarget=i.length,i.push(s)):t.commonTarget=o,t.modifiers.push(this.getModifier(e))}else o&&t.modifiers.push(o),t.modifiers.push(this.getModifier(e))}getModifier(e){return"angle"===e||"rotation"===e?"eulerAngles":"scaleX"===e?"x":"scaleY"===e?"y":"scaleZ"===e?"z":"top"===e||"bottom"===e||"left"===e||"right"===e||"horizontalCenter"===e||"verticalCenter"===e?"editor"+e.substring(0,1).toLocaleUpperCase()+e.substring(e.length,1):e}getValue(e,t){return __awaiter(this,void 0,void 0,function*(){return"angle"===e||"rotation"===e?{__type__:"cc.Vec3",x:0,y:0,z:void 0!==t?t:0}:"scale"===e?{__type__:"cc.Vec3",x:void 0!==t.x?t.x:1,y:void 0!==t.y?t.y:1,z:void 0!==t.z?t.z:1}:"position"===e?{__type__:"cc.Vec3",x:void 0!==t[0]?t[0]:0,y:void 0!==t[1]?t[1]:0,z:0}:t&&t.__uuid__?{__uuid__:t="spriteFrame"===e||"texture"===e?yield base_1.ImporterBase.getUuid(t.__uuid__,e):yield base_1.ImporterBase.getUuid(t.__uuid__)}:t})}getPropsForCurveData(e,t,i){return __awaiter(this,void 0,void 0,function*(){const o=Array.isArray(t)?t[0]:t;for(const s in e){const r=e[s],n=[],a=[],_={modifiers:[],data:{keys:o._keys.length,values:a,easingMethods:{}}};if("opacity"===s){const e={__type__:"cc.animation.ComponentPath",component:"cc.UIOpacity"};i&&_.modifiers.push(i),_.modifiers.push({__id__:t.length}),_.modifiers.push(this.getModifier(s)),t.push(e)}else if("width"===s||"height"===s){const e={__type__:"cc.animation.ComponentPath",component:"cc.UITransform"};let r=t.findIndex(t=>t.__type__===e.__type__&&t.component===e.component);-1===r&&(r=t.length,t.push(e));const n={modifiers:[]};i&&n.modifiers.push(i),n.modifiers.push({__id__:r}),n.modifiers.push("contentSize");let a=o._commonTargets.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(n.modifiers));-1===a&&(a=o._commonTargets.length,o._commonTargets.push(n)),_.commonTarget=a,_.modifiers.push(this.getModifier(s))}else this.mergersCommonTarget(s,_,o._commonTargets,i);for(let e=0;e<r.length;e++){const t=r[e];n.push(t.frame);const i=yield this.getValue(s,t.value);_.data.values.push(i),t.curve&&(_.data.easingMethods[e]=t.curve)}o._keys.push(n),o._curves.push(_)}return t.length>1?t:o})}getCurveDataForComps(e,t,i){return __awaiter(this,void 0,void 0,function*(){for(const o in e){const s=e[o],r={__type__:"cc.animation.ComponentPath",component:o};for(const e in s){const o=s[e],r=[],n=[],a={modifiers:[],data:{keys:t[0]._keys.length,values:n,easingMethods:{}}};i&&a.modifiers.push(i),a.modifiers.push({__id__:t.length}),a.modifiers.push(this.getModifier(e));for(let t=0;t<o.length;t++){const i=o[t];r.push(i.frame);const s=yield this.getValue(e,i.value);a.data.values.push(s),i.curve&&(a.data.easingMethods[t]=i.curve)}t[0]._keys.push(r),t[0]._curves.push(a)}t.push(r)}return t})}getCurveDataForPaths(e,t){return __awaiter(this,void 0,void 0,function*(){for(const i in e){const o={__type__:"cc.animation.HierarchyPath",path:i};t.push(o);const s=e[i];if(s.props&&(t=yield this.getPropsForCurveData(s.props,t,{__id__:t.length-1})),s.comps){const e=t.findIndex(e=>e.path===i);t=yield this.getCurveDataForComps(s.comps,t,{__id__:e})}}return t})}getCurveData(e,t){return __awaiter(this,void 0,void 0,function*(){return e.props&&(t=Array.isArray(t)?t:[t],t=yield this.getPropsForCurveData(e.props,t)),e.comps&&(t=Array.isArray(t)?t:[t],t=yield this.getCurveDataForComps(e.comps,t)),e.paths&&(t=Array.isArray(t)?t:[t],t=yield this.getCurveDataForPaths(e.paths,t)),t})}import(){return __awaiter(this,void 0,void 0,function*(){const e=this.readJSONSync(),t=AnimationClip_1.AnimationClip.create();return t._name=e._name,t.sample=e.sample,t.speed=e.speed,t.wrapMode=e.wrapMode,t.events=e.events,t._duration=e._duration,this._2dTo3dSource=yield this.getCurveData(e.curveData,t),this._3dMeta.ver="1.0.6",this._3dMeta.importer="animation-clip",!0})}}exports.AnimImporter=AnimImporter;