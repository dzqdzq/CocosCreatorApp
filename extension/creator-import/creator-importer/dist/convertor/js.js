"use strict";var __awaiter=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))(function(r,o){function a(t){try{p(s.next(t))}catch(t){o(t)}}function n(t){try{p(s.throw(t))}catch(t){o(t)}}function p(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(a,n)}p((s=s.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSImporter=void 0;const base_1=require("../common/base"),utlis_1=require("../common/utlis"),parseCode_1=require("../common/parseCode");class JSImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="script"}beforeImport(t,e){const i=Object.create(null,{beforeImport:{get:()=>super.beforeImport}});return __awaiter(this,void 0,void 0,function*(){return!utlis_1.SKIPS_SCRIPT.find(t=>e.endsWith(t))&&(yield i.beforeImport.call(this,t,e))})}import(t){return __awaiter(this,void 0,void 0,function*(){this._3dMeta.ver="4.0.21",this._3dMeta.importer="javascript";let e=this.pathInfo.name;e=yield utlis_1.scriptName.getValidClassName(e);const i=this.readFileSync();if(i){let s="";i.trim().split("\n").forEach(t=>{s+="// "+t+"\n"});let r="";if(this._2dMeta&&this._2dMeta.isPlugin)this._3dMeta.userData={isPlugin:this._2dMeta.isPlugin,loadPluginInWeb:this._2dMeta.loadPluginInWeb,loadPluginInNative:this._2dMeta.loadPluginInNative,loadPluginInEditor:this._2dMeta.loadPluginInEditor,importAsPlugin:this._2dMeta.isPlugin};else{const o=yield(0,parseCode_1.parseJSCode)(this.sourceFsPath,e);if(r+=o.topNote,i.includes("cc.Class(")){const s=yield this.queryCCClass(t.$.engine2D,{type:"js",path:this.destFsPath,name:e,code:i,classCount:1,ccKeys:o.ccKeys,importCodeMap:o.importCodeMap,otherCodeMap:o.otherCodeMap,classCodeMap:o.classCodeMap,endCodeMap:o.endCodeMap,replaceScriptList:utlis_1.replaceScriptList});s&&(e!==s.name&&console.warn(Editor.I18n.t("importer.script_rename_tips",{old:e,new:s.name})),(0,utlis_1.updateReplaceScriptList)(s.replaceScriptList),r+=s.classCode)}else console.warn(Editor.I18n.t("importer.skip_script_warn",{name:this.pathInfo.name}));r+="/**\n",r+=` * ${Editor.I18n.t("importer.plugin_js_tips")}\n`,r+=" */\n",r+=s,this._2dTo3dSource=r,utlis_1.scriptList.set(this.pathInfo.name,this.destFsPath)}}return!0})}}exports.JSImporter=JSImporter;