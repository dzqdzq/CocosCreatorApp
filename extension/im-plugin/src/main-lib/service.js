"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const http_utils_1=require("./http-utils"),apiBaseUrl="https://creator-api.cocos.com/api";class Service{constructor(){this.sessionId=null,this.sessionCode=null,this.sessionToken=null,this.imSetting=null}static async getInstance(){var e;return Service.instance&&!await Service.instance.sessionChanged()?Service.instance:(await(e=new Service).init(),Service.instance=e)}async sessionChanged(){return(await this.getUserData()).session_id!==this.sessionId}async getUserData(){let e=null;return e=(e=Editor.User.getData()).then?e:Editor.remote.User.getData()}async init(){var e=await this.getUserData();if(this.sessionId=e.session_id,this.sessionId)try{this.sessionCode=await this.getSessionCode(this.sessionId),this.sessionToken=await this.getSessionToken(this.sessionCode)}catch(e){console.error("get session failed"),console.error(e)}else console.error("init failedd, cannot get session i")}async getImSetting(){try{var e=await this.requestService(apiBaseUrl+"/service/get_im_setting",{session_token:this.sessionToken});return this.imSetting=e.data,e.data}catch(e){return null}}cleanImSetting(){this.imSetting=null}async getButtonTitle(){var e=await this.getImSetting();return e?e.button_title:""}async isVip(){var e=await this.getImSetting();return!!e&&!!e.user_licnese}async getNewMsgCount(){var e=await this.getImSetting();if(!e)return 0;try{var t=await http_utils_1.postData(e.msg_api_url);return t.data?t.data:0}catch(e){return 0}}async shouldShowEntrance(){var e=await this.getImSetting();return!!e&&!!e.show_entrance}async getSignInUrl(){var e=await this.getImSetting();return e?this.getRedirectUrl(e.entry_url):null}getRedirectUrl(e){e=e+(0<=e.indexOf("?")?"&":"?")+"lang="+Editor.I18n.getLanguage();return`${apiBaseUrl}/account/client_signin?session_id=${this.sessionId}&redirect_url=`+encodeURIComponent(e)}async getSessionCode(e){return(await this.requestService(apiBaseUrl+"/session/code",{session_id:e})).data.session_code}async getSessionToken(e){return(await this.requestService(apiBaseUrl+"/session/token",{session_code:e})).data.session_token}async requestService(e,t){return http_utils_1.postData(e,http_utils_1.encodeParams(t))}}(exports.default=Service).instance=null;