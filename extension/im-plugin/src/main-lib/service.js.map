{"version":3,"sources":["../src/main-lib/service.ts"],"names":[],"mappings":"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","file":"service.js","sourcesContent":["'use strict';\n\nimport { postData, encodeParams } from './http-utils';\n\nconst apiBaseUrl = 'https://creator-api.cocos.com/api';\n\ninterface ImSetting {\n  // The newest version of the plugin, optional, may not exists.\n  plugin_version?: string | undefined;\n  // The download URL of the newest plugin, optional, may not exists.\n  plugin_url?: string;\n  show_entrance: boolean;\n  button_title: string;\n  entry_url: string;\n  msg_api_url: string;\n  // user_licnese should be user_license. Unfortunately,\n  // back-end API is already fixed.\n  user_licnese: boolean;\n  start_time: string;\n  expire_time: string;\n}\n\nexport default class Service {\n  private constructor() {}\n\n  private static instance: Service | null = null;\n\n  private sessionId: string | null = null;\n  private sessionCode: string | null = null;\n  private sessionToken: string | null = null;\n\n  private imSetting: ImSetting | null = null;\n\n  static async getInstance(): Promise<Service> {\n    if (Service.instance && !(await Service.instance.sessionChanged())) {\n      return Service.instance;\n    }\n\n    const service = new Service();\n    await service.init();\n    Service.instance = service;\n\n    return service;\n  }\n\n  async sessionChanged() {\n    const userData = await this.getUserData();\n    return userData.session_id !== this.sessionId;\n  }\n\n  private async getUserData() {\n    let userData: any = null;\n    userData = Editor.User.getData();\n    if (!userData.then) {\n      // Old version of Cocos Creator returns non-Promise result, and the\n      // result is outdated, in that case, we should call Editor.remote.User.getData() instead.\n      userData = Editor.remote.User.getData();\n    }\n    return userData;\n  }\n\n  private async init() {\n    const userData = await this.getUserData();\n    this.sessionId = userData.session_id;\n    if (!this.sessionId) {\n      console.error('init failedd, cannot get session i');\n      return;\n    }\n\n    try {\n      this.sessionCode = await this.getSessionCode(this.sessionId);\n      this.sessionToken = await this.getSessionToken(this.sessionCode);\n    } catch (e) {\n      console.error('get session failed');\n      console.error(e);\n    }\n  }\n\n  async getImSetting(): Promise<ImSetting | null> {\n    try {\n      const result = await this.requestService(\n        `${apiBaseUrl}/service/get_im_setting`,\n        {\n          session_token: this.sessionToken,\n        }\n      );\n      this.imSetting = result.data;\n      return result.data;\n    } catch (e) {\n      // console.error('getImSetting failed');\n      return null;\n    }\n  }\n\n  cleanImSetting(): void {\n    this.imSetting = null;\n  }\n\n  async getButtonTitle(): Promise<string> {\n    const imSetting = await this.getImSetting();\n    if (!imSetting) {\n      return '';\n    }\n    return imSetting.button_title;\n  }\n\n  async isVip(): Promise<boolean> {\n    const imSetting = await this.getImSetting();\n    if (!imSetting) {\n      return false;\n    }\n    return !!imSetting.user_licnese;\n  }\n\n  async getNewMsgCount(): Promise<number> {\n    const imSetting = await this.getImSetting();\n    if (!imSetting) {\n      return 0;\n    }\n    try {\n      const result = await postData(imSetting.msg_api_url);\n      if (!result.data) return 0;\n      return result.data;\n    } catch {\n      return 0;\n    }\n  }\n\n  async shouldShowEntrance(): Promise<boolean> {\n    const imSetting = await this.getImSetting();\n    if (!imSetting) {\n      return false;\n    }\n    return !!imSetting.show_entrance;\n  }\n\n  async getSignInUrl(): Promise<string | null> {\n    const imSetting = await this.getImSetting();\n    if (!imSetting) {\n      return null;\n    }\n    return this.getRedirectUrl(imSetting.entry_url);\n  }\n\n  getRedirectUrl(redirectUrl: string): string {\n    const targetUrl =\n      redirectUrl +\n      (redirectUrl.indexOf('?') >= 0 ? '&' : '?') +\n      `lang=${Editor.I18n.getLanguage()}`;\n\n    return `${apiBaseUrl}/account/client_signin\\\n?session_id=${this.sessionId}\\\n&redirect_url=${encodeURIComponent(targetUrl)}`;\n  }\n\n  private async getSessionCode(sessionId: string): Promise<string> {\n    return (\n      await this.requestService(`${apiBaseUrl}/session/code`, {\n        session_id: sessionId,\n      })\n    ).data.session_code;\n  }\n\n  private async getSessionToken(sessionCode: string): Promise<string> {\n    return (\n      await this.requestService(`${apiBaseUrl}/session/token`, {\n        session_code: sessionCode,\n      })\n    ).data.session_token;\n  }\n\n  private async requestService(url: string, params: any): Promise<any> {\n    return postData(url, encodeParams(params));\n  }\n}\n"]}