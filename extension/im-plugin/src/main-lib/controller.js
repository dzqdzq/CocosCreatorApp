"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=__importDefault(require("path")),electron_1=require("electron"),update_toolbar_1=require("../common-lib/update-toolbar"),namespace_1=require("../constant/namespace"),new_msg_count_timer_1=__importDefault(require("./new-msg-count-timer")),service_1=__importDefault(require("./service")),compare_versions_1=__importDefault(require("compare-versions")),newMsgCountTimer=new_msg_count_timer_1.default.getInstance();class Controller{constructor(){this.onUserLogin=this.onUserLogin.bind(this),this.onUserLogout=this.onUserLogout.bind(this),this.onLanguageChanged=this.onLanguageChanged.bind(this),this.onPanelReady=this.onPanelReady.bind(this)}static getInstance(){return this.instance||(this.instance=new Controller),this.instance}async init(){0<=compare_versions_1.default(Editor.App.version,"3.8.5")&&electron_1.app.on("web-contents-created",(e,t)=>{"webview"===t.getType()&&t.setWindowOpenHandler(({url:e})=>(Editor.Message.request(namespace_1.ns,"get-redirect-url",e).then(e=>{electron_1.shell.openExternal(e)}),{action:"deny"}))}),Editor.User.on("login",this.onUserLogin),Editor.User.on("logout",this.onUserLogout),Editor.Message.addBroadcastListener("i18n:change",this.onLanguageChanged),electron_1.ipcMain.on(namespace_1.ns+":panel-ready",this.onPanelReady),await Editor.User.isLoggedIn()?this.dispatchLoggedInState():(this.onNotLoggedInState(),setTimeout(()=>{this.setMenuVisibility(!1)},500))}uninit(){Editor.User.removeListener("login",this.onUserLogin),Editor.User.removeListener("logout",this.onUserLogout),Editor.Message.removeBroadcastListener("i18n:change",this.onLanguageChanged),electron_1.ipcMain.removeListener(namespace_1.ns+":panel-ready",this.onPanelReady)}onShowPanel(){newMsgCountTimer.cleanUp(),update_toolbar_1.updateToolbar({newMsgCount:0},!0),update_toolbar_1.setPanelBlurred(!1)}onHidePanel(){update_toolbar_1.setPanelBlurred(!0)}onClosePanel(){update_toolbar_1.setPanelBlurred(!0)}onUserLogin(){this.dispatchLoggedInState()}onUserLogout(){this.onNotLoggedInState()}async onLanguageChanged(){await Editor.User.isLoggedIn()&&this.dispatchLoggedInState()}async dispatchLoggedInState(){var e=await service_1.default.getInstance(),e=(e.cleanImSetting(),await e.shouldShowEntrance());e?this.onLoggedInShouldShowState():this.onLoggedInShouldNotShowState()}onNotLoggedInState(){Editor.Message.broadcast(namespace_1.ns+":force-close-panel"),this.setMenuVisibility(!1),update_toolbar_1.updateToolbar({showToolbar:!1}),newMsgCountTimer.cleanUp()}async onLoggedInShouldShowState(){var e=await service_1.default.getInstance(),t=await e.isVip(),e=await e.getButtonTitle();this.setMenuVisibility(!0),update_toolbar_1.updateToolbar({showToolbar:!0,isVip:t,buttonTitle:e}),newMsgCountTimer.setUp()}onLoggedInShouldNotShowState(){this.onNotLoggedInState()}onPanelReady(t){var e=electron_1.BrowserWindow.fromWebContents(t.sender);function n(e){t.sender.send(namespace_1.ns+":panel-win-state-changed",e)}e?(e.on("blur",n.bind(null,"blur")),e.on("focus",n.bind(null,"focus")),e.on("show",n.bind(null,"show")),e.on("hide",n.bind(null,"hide")),e.on("minimize",n.bind(null,"minimize")),e.on("restore",n.bind(null,"restore")),e.on("blur",()=>{update_toolbar_1.setPanelBlurred(!0)}),e.on("focus",()=>{update_toolbar_1.updateToolbar({newMsgCount:0},!0),update_toolbar_1.setPanelBlurred(!1)})):console.error("panel window is undefined")}setMenuVisibility(e){var t=Editor.Package.getPackages({name:namespace_1.ns}),t=t[t.length-1];const n=t.name,o=null==(t=t.info.contributions)?void 0:t.menu[0];o&&(e?Editor.Menu.add(o.path,Object.assign(Object.assign({},o),{icon:path_1.default.join(__dirname,"../../resources/images/icon.png"),click:()=>{Editor.Message.send(n,"string"==typeof o.message?o.message:o.message.name)}})):Editor.Menu.remove(o.path,o),Editor.Menu.apply())}}(exports.default=Controller).instance=null;