{"version":3,"sources":["../src/main-lib/http-utils.ts"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;AAEb,gDAAwB;AACxB,sDAA8B;AAE9B,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,cAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC,CAAC;AAEhE,8CAAsB;AACtB,gEAAuC;AACvC,uDAA6C;AAC7C,iDAA4C;AAE5C,IAAI,uBAAuB,GAAG,KAAK,CAAC;AAEpC,SAAgB,YAAY,CAAC,MAAW;IACtC,SAAS,iBAAiB,CAAC,MAAW;QACpC,MAAM,WAAW,GAAG;YAClB,SAAS,EAAE,MAAM;YACjB,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,WAAW,EAAE;YAC/B,WAAW,EAAE,CAAC;YACd,OAAO,EAAE,MAAM,CAAC,GAAG,CAAC,OAAO;YAC3B,UAAU,EAAE,MAAM,CAAC,GAAG,CAAC,OAAO;YAG9B,UAAU,EAAE,IAAI;SACjB,CAAC;QACF,OAAO,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,EAAE,WAAW,CAAC,CAAC;IAChD,CAAC;IAED,SAAS,aAAa,CAAC,iBAAyB;QAC9C,MAAM,YAAY,GAAG,0CAA0C,CAAC;QAChE,OAAO,aAAG,CAAC,iBAAiB,GAAG,GAAG,GAAG,YAAY,CAAC,CAAC;IACrD,CAAC;IAED,MAAM,cAAc,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAC;IACjD,MAAM,iBAAiB,GAAG,sBAAW,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;IAChE,cAAc,CAAC,IAAI,GAAG,aAAa,CAAC,iBAAiB,CAAC,CAAC;IACvD,OAAO,cAAc,CAAC;AACxB,CAAC;AAxBD,oCAwBC;AAED,SAAgB,QAAQ,CACtB,GAAW,EACX,IAAsC;IAEtC,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QACrC,IAAI;YACF,iBAAO,CAAC,IAAI,CACV;gBACE,GAAG,EAAE,GAAG;gBACR,IAAI,EAAE,IAAI;gBACV,IAAI,EAAE,IAAI;gBACV,YAAY,EAAE;oBAEZ,OAAO,EAAE,KAAK;iBACf;aACF,EACD,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;gBACjB,IAAI,CAAC,GAAG,IAAI,GAAG,CAAC,UAAU,KAAK,GAAG,EAAE;oBAClC,IAAI,IAAI,CAAC,MAAM,EAAE;wBACf,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE;4BACrB,uBAAuB,GAAG,KAAK,CAAC;yBACjC;6BAAM,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,EAAE;4BAE9B,IAAI,CAAC,uBAAuB,EAAE;gCAC5B,aAAI,CAAC,cAAE,CAAC,iBAAiB,CAAC,EAAE;oCAC1B,KAAK,EAAE,cAAE,CAAC,YAAY,CAAC;iCACxB,CAAC,CAAC;gCACH,uBAAuB,GAAG,IAAI,CAAC;6BAChC;yBACF;qBACF;oBACD,OAAO,CAAC,IAAI,CAAC,CAAC;iBACf;qBAAM,IAAI,CAAC,GAAG,EAAE;oBACf,MAAM,CAAC;wBACL,GAAG;wBACH,IAAI;qBACL,CAAC,CAAC;iBACJ;qBAAM;oBACL,MAAM,CAAC;wBACL,GAAG;qBACJ,CAAC,CAAC;iBACJ;YACH,CAAC,CACF,CAAC;SACH;QAAC,OAAO,CAAC,EAAE;YACV,MAAM,CAAC;gBACL,GAAG,EAAE,CAAC;aACP,CAAC,CAAC;SACJ;IACH,CAAC,CAAC,CAAC;AACL,CAAC;AAlDD,4BAkDC","file":"http-utils.js","sourcesContent":["'use strict';\n\nimport path from 'path';\nimport request from 'request';\n\nmodule.paths.push(path.join(Editor.App.path, './node_modules'));\n\nimport md5 from 'md5';\nimport queryString from 'query-string';\nimport { tr } from '../common-lib/translate';\nimport { info } from '../common-lib/dialog';\n\nlet sessionExpiredWarnShown = false;\n\nexport function encodeParams(params: any): any {\n  function getCompleteParams(params: any): any {\n    const fixedParams = {\n      plugin_id: '1026',\n      lang: Editor.I18n.getLanguage(),\n      client_type: 1,\n      version: Editor.App.version,\n      cc_version: Editor.App.version,\n      // Pass cs_require: '3x' to tell the server we want the new\n      // version of 3.x plugin, not the plugin of Cocos Creator 2.x.\n      cs_require: '3x',\n    };\n    return Object.assign({}, params, fixedParams);\n  }\n\n  function getParamsSign(stringifiedParams: string) {\n    const pluginSecret = 'fc81d0f39ca8157f9fb6324912aa2cf3573a5a41';\n    return md5(stringifiedParams + '&' + pluginSecret);\n  }\n\n  const completeParams = getCompleteParams(params);\n  const stringifiedParams = queryString.stringify(completeParams);\n  completeParams.sign = getParamsSign(stringifiedParams);\n  return completeParams;\n}\n\nexport function postData(\n  url: string,\n  data?: { [key: string]: any } | string\n): Promise<any> {\n  return new Promise((resolve, reject) => {\n    try {\n      request.post(\n        {\n          url: url,\n          json: true,\n          form: data,\n          agentOptions: {\n            // Avoid EPROTO error.\n            ciphers: 'ALL',\n          },\n        },\n        (err, res, body) => {\n          if (!err && res.statusCode === 200) {\n            if (body.status) {\n              if (body.status === 0) {\n                sessionExpiredWarnShown = false;\n              } else if (body.status === 406) {\n                // Session expired, inform user to re-login.\n                if (!sessionExpiredWarnShown) {\n                  info(tr('session-expired'), {\n                    title: tr('info-title'),\n                  });\n                  sessionExpiredWarnShown = true;\n                }\n              }\n            }\n            resolve(body);\n          } else if (!err) {\n            reject({\n              res,\n              body,\n            });\n          } else {\n            reject({\n              err,\n            });\n          }\n        }\n      );\n    } catch (e) {\n      reject({\n        err: e,\n      });\n    }\n  });\n}\n"]}