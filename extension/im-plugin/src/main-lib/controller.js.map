{"version":3,"sources":["../src/main-lib/controller.ts"],"names":[],"mappings":"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","file":"controller.js","sourcesContent":["'use strict';\n\nimport path from 'path';\nimport { shell, app, ipcMain, BrowserWindow } from 'electron';\nimport { setPanelBlurred, updateToolbar } from '../common-lib/update-toolbar';\nimport { ns } from '../constant/namespace';\nimport NewMsgCountTimer from './new-msg-count-timer';\nimport Service from './service';\nimport compareVersions from 'compare-versions';\n\nconst newMsgCountTimer = NewMsgCountTimer.getInstance();\n\nexport default class Controller {\n  private static instance: Controller | null = null;\n\n  public static getInstance(): Controller {\n    if (this.instance) {\n      return this.instance;\n    }\n    this.instance = new Controller();\n    return this.instance;\n  }\n\n  private constructor() {\n    this.onUserLogin = this.onUserLogin.bind(this);\n    this.onUserLogout = this.onUserLogout.bind(this);\n    this.onLanguageChanged = this.onLanguageChanged.bind(this);\n    this.onPanelReady = this.onPanelReady.bind(this);\n  }\n\n  async init() {\n    // 3.8.5升级了electron，只能通过这种方式在系统浏览器中打开链接\n    if (compareVersions(Editor.App.version, '3.8.5') >= 0) {\n      app.on('web-contents-created', (event, contents: Electron.WebContents) => {\n        if (contents.getType() === 'webview') {\n          contents.setWindowOpenHandler(({url}) => {\n            Editor.Message.request(ns, 'get-redirect-url', url).then(res => {\n              shell.openExternal(res);\n            })\n\n            return {action: 'deny'};\n          })\n        }\n      })\n    }\n\n    Editor.User.on('login', this.onUserLogin);\n    Editor.User.on('logout', this.onUserLogout);\n    Editor.Message.addBroadcastListener('i18n:change', this.onLanguageChanged);\n    ipcMain.on(`${ns}:panel-ready`, this.onPanelReady);\n\n    if (await Editor.User.isLoggedIn()) {\n      this.dispatchLoggedInState();\n    } else {\n      this.onNotLoggedInState();\n      // In Cocos Creator 3.0, menus will be added after the plugin's load()\n      // callback, thus the menu we removed here will be added back after load()\n      // callback finished. As a workaround, set a short timeout to hide the\n      // menu. The timeout should short enough to avoid user to disrupt states.\n      setTimeout(() => {\n        this.setMenuVisibility(false);\n      }, 500);\n    }\n  }\n\n  uninit() {\n    Editor.User.removeListener('login', this.onUserLogin);\n    Editor.User.removeListener('logout', this.onUserLogout);\n    Editor.Message.removeBroadcastListener(\n      'i18n:change',\n      this.onLanguageChanged\n    );\n    ipcMain.removeListener(`${ns}:panel-ready`, this.onPanelReady);\n  }\n\n  onShowPanel() {\n    newMsgCountTimer.cleanUp();\n    updateToolbar(\n      {\n        newMsgCount: 0,\n      },\n      true\n    );\n    // If the user hide the panel before panelReady is called, a blur event will\n    // be triggered later, thus it harmless to setPanelBlurred(false) in here.\n    setPanelBlurred(false);\n  }\n\n  onHidePanel() {\n    // After panel is hidden, the panel window won't trigger blur event until\n    // user click the other UIs, so we need to set panel state to blurred in\n    // here manually.\n    setPanelBlurred(true);\n  }\n\n  onClosePanel() {\n    setPanelBlurred(true);\n  }\n\n  onUserLogin() {\n    this.dispatchLoggedInState();\n  }\n\n  onUserLogout() {\n    this.onNotLoggedInState();\n  }\n\n  async onLanguageChanged() {\n    if (!(await Editor.User.isLoggedIn())) {\n      // The user is in not logged in state. Menu and toolbar are hidden, timer is not set.\n      // We don't need to do anything.\n      return;\n    }\n\n    this.dispatchLoggedInState();\n  }\n\n  async dispatchLoggedInState() {\n    const service = await Service.getInstance();\n    // When language is changed, clean the cache of imSetting, we want to know\n    // the newest information about whether we should show the entrance.\n    service.cleanImSetting();\n    const shouldShowEntrance = await service.shouldShowEntrance();\n    if (shouldShowEntrance) {\n      this.onLoggedInShouldShowState();\n    } else {\n      this.onLoggedInShouldNotShowState();\n    }\n  }\n\n  onNotLoggedInState() {\n    Editor.Message.broadcast(`${ns}:force-close-panel`);\n    this.setMenuVisibility(false);\n    updateToolbar({\n      showToolbar: false,\n    });\n    newMsgCountTimer.cleanUp();\n  }\n\n  async onLoggedInShouldShowState() {\n    const service = await Service.getInstance();\n    const isVip = await service.isVip();\n    const buttonTitle = await service.getButtonTitle();\n\n    this.setMenuVisibility(true);\n    updateToolbar({\n      showToolbar: true,\n      isVip,\n      buttonTitle: buttonTitle,\n    });\n    newMsgCountTimer.setUp();\n  }\n\n  onLoggedInShouldNotShowState() {\n    // Same as not logged in state, completely hidden.\n    this.onNotLoggedInState();\n  }\n\n  onPanelReady(event: Electron.IpcMainEvent) {\n    const win = BrowserWindow.fromWebContents(event.sender);\n    if (!win) {\n      console.error('panel window is undefined');\n      return;\n    }\n\n    function informWindowStateChangedListener(eventName: string) {\n      event.sender.send(`${ns}:panel-win-state-changed`, eventName);\n    }\n\n    win.on('blur', informWindowStateChangedListener.bind(null, 'blur'));\n    win.on('focus', informWindowStateChangedListener.bind(null, 'focus'));\n    win.on('show', informWindowStateChangedListener.bind(null, 'show'));\n    win.on('hide', informWindowStateChangedListener.bind(null, 'hide'));\n    win.on('minimize', informWindowStateChangedListener.bind(null, 'minimize'));\n    win.on('restore', informWindowStateChangedListener.bind(null, 'restore'));\n\n    win.on('blur', () => {\n      setPanelBlurred(true);\n    });\n\n    win.on('focus', () => {\n      updateToolbar(\n        {\n          newMsgCount: 0,\n        },\n        true\n      );\n      setPanelBlurred(false);\n    });\n  }\n\n  setMenuVisibility(visible: boolean) {\n    // There may be two versions of Cocos Assistant: built-in version and dev\n    // version, The built-in version is packaged into Cocos Creator, the dev\n    // version is put inside ~/.CocosEditor3D_Develop/packages.\n    // Editor.Package.getPackages returns the built-in version before the dev\n    // version, we need the last one (is the built-in version if the dev version\n    // not exists, otherwise, is the dev version).\n    const packageInfos = Editor.Package.getPackages({\n      name: ns,\n    });\n    const packageInfo = packageInfos[packageInfos.length - 1];\n    const packageName = packageInfo.name;\n\n    const menuDesc = packageInfo.info.contributions?.menu[0];\n    if (!menuDesc) {\n      return;\n    }\n\n    if (visible) {\n      Editor.Menu.add(menuDesc.path, {\n        ...menuDesc,\n        icon: path.join(__dirname, '../../resources/images/icon.png'),\n        click: () => {\n          Editor.Message.send(packageName, typeof menuDesc.message === 'string' ? menuDesc.message : menuDesc.message.name);\n        },\n      });\n    } else {\n      Editor.Menu.remove(menuDesc.path, menuDesc);\n    }\n    Editor.Menu.apply();\n  }\n}\n"]}