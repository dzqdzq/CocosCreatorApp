{"version":3,"sources":["../src/browser.ts"],"names":[],"mappings":"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","file":"browser.js","sourcesContent":["'use strict';\nimport os from 'os';\nimport path, { dirname, join } from 'path';\nimport compareVersions from 'compare-versions';\nimport { BrowserWindow, ipcMain } from 'electron';\nimport Service from './main-lib/service';\nimport { ns } from './constant/namespace';\nimport { ToolbarNewInfo } from './toolbar/toolbar-new-info';\nimport { updateToolbar } from './common-lib/update-toolbar';\nimport Controller from './main-lib/controller';\nimport { createWriteStream } from 'fs';\nimport { postData } from './main-lib/http-utils';\nimport { inject } from './common-lib/inject';\n\nconst requestProgress = require('request-progress');\nconst request = require('request');\n\nmodule.paths.push(path.join(Editor.App.path, './node_modules'));\nconst windows = require('@base/electron-windows');\nconst fse = require('fs-extra');\nconst publicIpApi = require('public-ip');\n\nconst controller = Controller.getInstance();\n\nlet panelWin: BrowserWindow | null = null;\n\n// 上报信息\nconst reportOptions = {\n  url:'http://k.cocosgame.net:58511',\n  method: 'POST',\n  json:true,\n}\n\n//IP转成整型\nfunction _ip2int(ip:any){\n  let num = 0;\n  ip = ip.split(\".\");\n  num = Number(ip[0]) * 256 * 256 * 256 + Number(ip[1]) * 256 * 256 + Number(ip[2]) * 256 + Number(ip[3]);\n  num = num >>> 0;\n  return num;\n}\n// common 字段上报\nasync function commonFields(){\n  // 公网ip地址\n  // @ts-ignore\n  let publicIp = '';\n  let city = '';\n  let country = '';\n  let province = '';\n  let address = '';\n  let district = '';\n\n  try{\n    publicIp =  await publicIpApi.v4();\n    if(publicIp){\n      const result = await postData('https://im.cocos.com/welcome/query',{ip: publicIp});\n      if(result?.code == 'success'){\n        city = result?.data?.city;\n        country = result?.data?.country;\n        province = result?.data?.province;\n        district = result?.data?.district;\n        address = `${country}-${province}-${city}`;\n      }\n    }\n  } catch {\n    publicIp = '';\n  }\n  // 上报内容\n  const env = process.env;\n  // 标识app\n  const appType = 'secretary';\n  // 时间\n  const time = new Date().toUTCString();\n  // Dashboard 版本号\n  const dashBoardVersion = env.dashboard;\n  // Creator 版本号\n  const creatorVersion = await Editor.App.version;\n  // 语言类型\n  const locate = await Editor.I18n.getLanguage();\n  // 当前Cocos账号信息，昵称，邮箱，cocos_uid\n  const userData = await Editor.User.getData();\n  const nickName = userData.nickname;\n  const email = userData.email;\n  const cocos_uid = userData.cocos_uid;\n  // IPs\n  const ips = await Editor.Network.queryIPList();\n  // 返回操作系统名\n  const osType = os.type();\n  // 返回编译时的操作系统名字\n  const osPlatform = os.platform();\n  // 返回操作系统的主机名。\n  const osHostname = os.hostname();\n  // 返回操作系统的默认临时文件夹。\n  const osTmpdir = os.tmpdir();\n  // 返回操作系统 CPU 架构，可能的值有 \"x64\"、\"arm\" 和 \"ia32\"。\n  const osArch = os.arch();\n  // 当前项目名称、当前项目包名\n  // @ts-ignore\n  const currentPjName =  Editor.Project.name;\n  return  {\n    appType,\n    time,\n    dashBoardVersion,\n    creatorVersion,\n    city,\n    country,\n    district,\n    province,\n    address,\n    locate,\n    userData,\n    nickName,\n    email,\n    cocos_uid,\n    ips,\n    osType,\n    osPlatform,\n    osHostname,\n    osTmpdir,\n    publicIp,\n    osArch,\n    currentPjName,\n  }\n}\n\n// 启动本地信息上报\nasync function reportInformation(){\n  // 时区\n  const timeZone = new Date().getTimezoneOffset()/60\n  // 插件版本号\n  const pluginVersion = getVersion();\n  // 构建类型\n  const type = '';\n  // 入口类型（plugin or Web）\n  const entryType = 'plugin'\n  // 启动还是更新\n  const reportType = 'Start'\n\n  const  {\n    time,\n    dashBoardVersion,\n    creatorVersion,\n    locate,\n    userData,\n    city,\n    country,\n    district,\n    province,\n    address,\n    nickName,\n    email,\n    cocos_uid,\n    ips,\n    osType,\n    osPlatform,\n    osHostname,\n    osTmpdir,\n    appType,\n    osArch,\n    publicIp,\n    currentPjName,\n  } = await commonFields();\n\n  const body = {\n    timeZone,\n    time,\n    dashBoardVersion,\n    creatorVersion,\n    pluginVersion,\n    district,\n    locate,\n    userData,\n    nickName,\n    email,\n    cocos_uid,\n    ips,\n    osType,\n    osPlatform,\n    osHostname,\n    osTmpdir,\n    appType,\n    osArch,\n    publicIp,\n    city,\n    country,\n    province,\n    address,\n    currentPjName,\n    entryType,\n    reportType\n  }\n  request( Object.assign({},reportOptions,{ body:body}),()=>{});\n}\n\n// 更新上报\nasync function updateReportInformation(preVersion:string,newVersion: string,updateStatus: boolean, error:any){\n  const reportType = 'Update'\n\n  const  {\n    time,\n    dashBoardVersion,\n    creatorVersion,\n    locate,\n    userData,\n    nickName,\n    city,\n    country,\n    province,\n    address,\n    email,\n    appType,\n    cocos_uid,\n    ips,\n    district,\n    osType,\n    osPlatform,\n    osHostname,\n    publicIp,\n    osTmpdir,\n    osArch,\n    currentPjName,\n  } = await commonFields();\n\n  const body = {\n    time,\n    preVersion,\n    newVersion,\n    updateStatus,\n    dashBoardVersion,\n    creatorVersion,\n    publicIp,\n    district,\n    locate,\n    city,\n    country,\n    province,\n    address,\n    userData,\n    nickName,\n    email,\n    cocos_uid,\n    appType,\n    ips,\n    osType,\n    osPlatform,\n    osHostname,\n    osTmpdir,\n    osArch,\n    currentPjName,\n    reportType,\n  }\n  if(error){\n    Object.assign(body,{errorName: error.name, errorMessage: error.message})\n  }\n\n  request( Object.assign({},reportOptions,{ body:body}),()=>{\n    return;\n  });\n}\n\nasync function load() {\n  ipcMain.on(`${ns}:hide-panel`, hidePanel);\n  ipcMain.on(`${ns}:get-version`, getVersion_);\n  controller.init();\n\n  //加载 builder-wasm 代码\n  compareVersions(Editor.App.version, '3.8.2') < 0 && await inject()\n\n  // 静默更新\n  isVersionMore331() && silentCheckAndUpdate();\n  // 上报信息\n\n  setTimeout(()=>{\n    reportInformation();\n  },1000);\n}\n\nfunction unload() {\n  ipcMain.removeListener(`${ns}:hide-panel`, hidePanel);\n  ipcMain.removeListener(`${ns}:get-version`, getVersion_);\n  controller.uninit();\n}\n\nlet savedInfo: ToolbarNewInfo | null = null;\n\n\n// 下载解压包\nconst downloadZip = async (url: string | undefined, temp:string) =>{\n  await fse.ensureDir(dirname(temp));\n  await new Promise((resolve, reject) => {\n    requestProgress(request(url), {\n      delay: 300,\n    }).on('progreass', function(state: any) {})\n      .on('error', function(error: Error) {reject(error);})\n      .on('end', function(a: any, b: any) {\n        resolve(null);\n      }).pipe(createWriteStream(temp));\n  });\n}\n\n// 键值格式化\nconst formatVersion = (version:string) =>{\n  return version.replace(/\\./g,\"-\")\n}\n\nconst isVersionMore331 = () =>{\n  // 判断编辑器版本低于3.3.1 不进行更新\n  const currentEditorVersion = Editor.App.version;\n  if(compareVersions(currentEditorVersion, '3.3.1') <= 0){\n    console.warn('[Im-plugin] The editor does not support automatic updates of versions below 3.3.1.If im-plugin has new version, you need to download it manually from the store.')\n    return false;\n  }\n\n  // 编辑器版本>=3.7.0 不进行更新\n  if(compareVersions(currentEditorVersion, '3.7.0') >= 0){\n    return false;\n  }\n\n  return true;\n}\n\n// 检测版本\nconst silentCheck = async () =>{\n  console.log('[Im-plugin] Check im-plugin version.');\n  // 3.3.1 及以下不支持热更新\n  if(!isVersionMore331()){\n    return;\n  }\n  // 用户相关\n  const service = await Service.getInstance();\n  // 获取设置\n  const imSetting = await service.getImSetting();\n  // 无更新版本\\更新路径信息 不执行更新\n  if (!imSetting || !imSetting.plugin_version || !imSetting.plugin_url) {\n    console.log('[Im-plugin] No online info of im-plugin.');\n    return;\n  }\n  // 新版本格式校验 && 版本大小检验 线上版本低于当前版本则不进行更新\n  const newVersion = imSetting.plugin_version;\n  // 判断是否本地记录有问题版本 不进行更新\n  const flag = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion',formatVersion(newVersion), 'global');\n  if(flag === true){\n    console.log(`[Im-plugin] Im-plugin online version has something wrong, don't update.`);\n    return;\n  }\n\n  // 判断是否间隔十分钟，如果间隔未有10分钟不进行更新\n  const lastErrorTime = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion','lastErrorTime','global');\n  if(new Date().getTime() - lastErrorTime < 10 * 60 * 1000){\n    return;\n  }\n\n  // 判断当天是否已经达到指定次数的更新，如果达到，则不进行更新\n  const currentDayTime = getCurrentErrorTime();\n  const dayTime = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion',currentDayTime,'global');\n  if(parseInt(dayTime) <= 0){\n    console.log(`[Im-plugin] The number of errors reached online on the day, 5 times.`);\n    return;\n  }\n\n  if (!compareVersions.validate(newVersion)) {\n    console.log(`[Im-plugin] Im-plugin online version is error, ${newVersion}.`);\n    return;\n  }\n  console.log(`[Im-plugin] Im-plugin online version is ${newVersion}.`);\n  const curVersion = getVersion();\n  console.log(`[Im-plugin] Im-plugin local version is ${curVersion}.`);\n  if (compareVersions(newVersion, curVersion) <= 0) {\n    console.log(`[Im-plugin] Im-plugin need not update.`);\n    return;\n  }\n\n  return { imSetting,newVersion,curVersion}\n}\n\n// 解压安装\nconst unZipAndInstall = async (temp:string,target:string) =>{\n\n  return await new Promise(async (resolve)=>{\n    await Editor.Message.request(\n      'extension',\n      'import-package',\n      'global',\n      temp,\n      { forceImport: true }\n    ).then(async ()=>{\n      await fse.remove(temp);\n      await Editor.Message.request(\n        'extension',\n        'enable',\n        target,\n        true,\n      );\n      resolve(true);\n    }).catch(()=>{\n      resolve(false);\n    })\n  })\n}\n// 返回当天更新失败键值\nconst getCurrentErrorTime = () =>{\n  const date = new Date();\n  const year = date.getFullYear();\n  const month = date.getMonth() + 1;\n  const dates = date.getDate();\n  return `${year}-${month}-${dates}-error`;\n}\n\n// 静默更新\nconst silentCheckAndUpdate = async () =>{\n  // 是否需要更新检测\n  const checkRes = await silentCheck();\n  if(!checkRes){\n    return;\n  }\n  const { imSetting,newVersion,curVersion} = checkRes;\n  // 进行插件更新\n  // ① 将本地旧版本放到全局目录的extension路径下\n  const targetRemovePath = join(Editor.App.home,'extension-callback', 'im-plugin.callback');\n  await fse.ensureDir(targetRemovePath);\n  console.log(`[Im-plugin] Remove your old im-plugin to ${targetRemovePath}`);\n  let currentImPlugin = join(Editor.App.home, 'extensions', 'im-plugin');\n  let currentImPluginRes = await Editor.Package.getPackages({name:'im-plugin',enable:true});\n  if(currentImPluginRes[0]){\n    currentImPlugin = currentImPluginRes[0].path;\n  }\n  const target = join(Editor.App.home, 'extensions', 'im-plugin');\n  // zip 存放下载的路径\n  const temp = join(Editor.App.home, 'download', 'im-plugin' + '.zip');\n  try{\n    await fse.copy(currentImPlugin,targetRemovePath).then( async ()=>{\n      console.log('[Im-plugin] Remove Succeed.');\n      // ② 下载zip包\n      let isDownload = true;\n      const tempUrl = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion','download-url','global');\n      if(tempUrl === imSetting.plugin_url){\n        // 判断本地是否有文件，如果有不进行下载\n        try{\n          await fse.realpath(temp);\n          console.log('[Im-plugin] Im-plugin zip exists.');\n          isDownload = false;\n        }catch (e){\n          isDownload = true\n        }\n      }\n      // 记录最新下载地址信息\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion','download-url',imSetting.plugin_url,'global');\n      if(isDownload){\n        console.log('[Im-plugin] Download im-plugin zip.');\n        await downloadZip(imSetting.plugin_url,temp)\n      }\n      // ③ 解压zip包进行安装替换\n      // 面板开启 return\n      if(await Editor.Panel.has('default')){\n        console.log('[Im-plugin] You need to update in panel due to you opening it.');\n        return;\n      }\n      // 解压并安装插件\n      const res = await unZipAndInstall(temp,target)\n      if(res){\n        updateReportInformation(curVersion,newVersion, true,null);\n      }else{\n        throw new Error('[Im-plugin] Unzip installation failed .')\n      }\n    });\n  }catch(e) {\n    // 上报\n    updateReportInformation(curVersion,newVersion, false, e);\n    console.error(`[Im-plugin] Update ${newVersion} failed.`);\n    // 本地记录有问题的版本 记录第一次有问题的更新时间\n    const firstErrorTime = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion','firstErrorTime','global');\n    // 记录当前发生错误的时间\n    await Editor.Profile.setConfig('im-plugin.IgnoreImVersion','lastErrorTime',new Date().getTime(),'global');\n    // 如果没有才进行添加\n    if(!firstErrorTime){\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion','firstErrorTime',new Date().getTime(),'global');\n    }\n\n    // 获取当天的可更新次数;\n    const currentDayTime = getCurrentErrorTime();\n    const dayTime = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion',currentDayTime,'global');\n    // 如果不存在则设置当天次数 5 - 1次\n    if(!dayTime){\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion',currentDayTime,4,'global');\n    }else{\n      // 存在当天次数 - 1次\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion',currentDayTime,dayTime - 1,'global');\n    }\n\n    // 累计错误次数+1\n    const sumErrorTime = await Editor.Profile.getConfig('im-plugin.IgnoreImVersion','sumErrorTime','global');\n    if(!sumErrorTime){\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion','sumErrorTime',1,'global');\n    }else{\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion','sumErrorTime',sumErrorTime + 1,'global');\n    }\n\n\n    // 检查累计错误次数大于等于15次 或者已经经过三天时间还更新失败 则标记本地版本有问题\n    const isThanThreeDay = (new Date().getTime() - firstErrorTime) >= 3 * 24 * 60 * 60 * 10000\n    if( sumErrorTime >= 15 || isThanThreeDay){\n      await Editor.Profile.setConfig('im-plugin.IgnoreImVersion',formatVersion(newVersion),true,'global');\n    }\n\n    // 回退旧版本\n    console.log('[Im-plugin] Go back to old version.' + curVersion);\n    // await fse.emptyDir(currentImPlugin);\n    await fse.copy(targetRemovePath,currentImPlugin).then( async ()=>{\n      console.log('[Im-plugin] Go back ok.');\n      await Editor.Message.request(\n        'extension',\n        'reload',\n        currentImPlugin,\n      ).then(()=>{\n        // 删除callback\n        fse.remove(targetRemovePath);\n        // 删除本地下载的zip\n        fse.remove(temp);\n        console.log('[Im-plugin] Remove callback folder.');\n      })\n    });\n  }\n}\n\nconst methods = {\n  showPanel() {\n    console.log('[im-plugin] Current version is ' + getVersion());\n    if (panelWin) {\n      panelWin.show();\n      isVersionMore331() && Editor.Message.broadcast('im-plugin:check');\n      panelWin = null;\n    } else {\n      Editor.Panel.open(ns);\n    }\n    controller.onShowPanel();\n  },\n  silentCheckAndUpdate,\n  silentCheck,\n  unZipAndInstall,\n\n  closePanel() {\n    Editor.Panel.close(ns);\n    panelWin = null;\n\n    controller.onClosePanel();\n  },\n\n  whetherClose() {\n    return windows._waitClosedMain;\n  },\n\n  async getSignInUrl() {\n    const service = await Service.getInstance();\n    return service.getSignInUrl();\n  },\n\n  async getRedirectUrl(url: string) {\n    const service = await Service.getInstance();\n    return service.getRedirectUrl(url);\n  },\n\n  updateToolbarMain(newInfo: ToolbarNewInfo, force?: boolean) {\n    updateToolbar(newInfo, force);\n  },\n\n  saveToolbarInfo(infoToSave: ToolbarNewInfo) {\n    savedInfo = infoToSave;\n  },\n\n  getSavedToolbarInfo() {\n    return savedInfo;\n  },\n};\n\nfunction hidePanel(event: Electron.IpcMainEvent) {\n  panelWin = BrowserWindow.fromWebContents(event.sender);\n  if (!panelWin) {\n    console.error('cannot hide panel, panelWin is undefined');\n    return;\n  }\n  panelWin.hide();\n  controller.onHidePanel();\n}\n\nfunction getVersion_(event: Electron.IpcMainEvent) {\n  event.returnValue = getVersion();\n}\n\nfunction getVersion() {\n  const packageInfos = Editor.Package.getPackages({ name: ns, enable:true });\n  return packageInfos[0].version;\n}\n\nexport { methods, load, unload };\n"]}