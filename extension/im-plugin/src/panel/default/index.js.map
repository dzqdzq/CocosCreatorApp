{"version":3,"sources":["../src/panel/default/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\nimport path from 'path';\nimport fs from 'fs';\nimport { shell, ipcRenderer } from 'electron';\nimport download from 'download';\nimport fileUrl from 'file-url';\nimport compareVersions from 'compare-versions';\n\nimport { tr } from '../../common-lib/translate';\nimport { select, save, info } from '../../common-lib/dialog';\nimport { ns } from '../../constant/namespace';\nimport os from 'os';\nconst pluginVersion = ipcRenderer.sendSync(`${ns}:get-version`);\nvar utc = require('dayjs/plugin/utc');\nvar timezone = require('dayjs/plugin/timezone');\nvar dayjs = require('dayjs');\ndayjs.extend(utc);\ndayjs.extend(timezone);\n\nmodule.paths.push(path.join(Editor.App.path, './node_modules'));\n\nconst element = require('@editor/panel/lib/element');\nconst windowsPkg = require('@base/electron-windows/package.json');\nconst ipcFlag = `${windowsPkg.name}@${windowsPkg.version}`;\n\nlet forceClose = false;\n\nlet tplFile = path.join(__dirname, './index.html');\n// creator3.8.5升级了electron，webview需要设置一些属性才能支持a标签新开窗口\nif (compareVersions(Editor.App.version, '3.8.5') >= 0) {\n  tplFile = path.join(__dirname, './index-3.8.5.html');\n}\nconst template = fs.readFileSync(tplFile, 'utf8');\n\nconst style = fs.readFileSync(path.join(__dirname, './style.css'), 'utf8');\n\nconst selector = {\n  webview: '#webview',\n  loadingPage: '#loading-page',\n  updateBtn:'#btn-4'\n};\n\nlet action = 'refresh';\n\nasync function controlUpdateBtn(that: {\n   $: { webview: Electron.WebviewTag; loadingPage: HTMLElement;updateBtn:HTMLElement  };\n }){\n  /**\n   * 更新按钮插入，如果需要更新则显示\n   */\n  const flag = await Editor.Message.request('im-plugin','silent-check');\n  if(flag){\n    that.$.updateBtn.style.display = 'block';\n    that.$.updateBtn.innerText = tr('update-btn') || 'update';\n    that.$.updateBtn.addEventListener('click', async ()=>{\n      // 按钮消失防止二次点击\n      that.$.updateBtn.style.display = 'none';\n      Editor.Message.send('im-plugin','silent-check-and-update');\n    })\n  }else{\n    that.$.updateBtn.style.display = 'none';\n    that.$.updateBtn.removeEventListener('click',()=>{});\n  }\n}\n\nlet that: { $: { webview: Electron.WebviewTag; loadingPage: HTMLElement; updateBtn: HTMLElement; } | { webview: Electron.WebviewTag; loadingPage: HTMLElement; updateBtn: HTMLElement; }; } | null = null;\n\n\nasync function ready(this: {\n  $: { webview: Electron.WebviewTag; loadingPage: HTMLElement;updateBtn:HTMLElement  };\n})\n{\n  that = this;\n  await controlUpdateBtn(that);\n  forceClose = false;\n\n  Editor.Panel.kitControl\n\n  Editor.Message.addBroadcastListener(\n    `${ns}:force-close-panel`,\n    forceClosePanel\n  );\n\n  if (!(await Editor.User.isLoggedIn())) {\n    await info(tr('info-non-logged-in'), {\n      title: tr('info-title'),\n      buttons: [tr('ok')],\n      default: 0,\n    });\n    Editor.Message.broadcast(`${ns}:force-close-panel`);\n    return;\n  }\n\n  // this.$.webview.addEventListener('dom-ready', () => {\n  //   this.$.webview.openDevTools();\n  // });\n\n  this.$.webview.addEventListener('dom-ready', () => {\n    Editor.Message.send(ns, 'dom-ready');\n  });\n\n  this.$.webview.setAttribute('webpreferences', 'contextIsolation=false');\n  this.$.webview.setAttribute(\n    'preload',\n    fileUrl(path.join(__dirname, './host-api.js'))\n  );\n  this.$.webview.addEventListener(\n    'ipc-message',\n    (event: Electron.IpcMessageEvent) => {\n      onIpcMessage(event, this.$.webview, this.$.loadingPage);\n    }\n  );\n\n  const signInUrl: string | null = await Editor.Message.request(\n    ns,\n    'get-sign-in-url'\n  );\n\n  if (!signInUrl) {\n    info(tr('get-sign-in-url-failed'), {\n      title: tr('info-title'),\n    });\n    Editor.Message.broadcast(`${ns}:force-close-panel`);\n    return;\n  }\n\n  this.$.webview.src = signInUrl;\n\n  // creator3.8.5升级了electron，新的electron移除了new-window事件\n  if (compareVersions(Editor.App.version, '3.8.5') < 0) {\n    this.$.webview.addEventListener(\n      'new-window',\n      async (event:any) => {\n        shell.openExternal(\n          await Editor.Message.request(ns, 'get-redirect-url', event.url)\n        );\n      }\n    );\n  }\n\n  // When user try to close the window, main process will inform our renderer\n  // process, then we change the action to 'close' to let beforeClose know about\n  // that and hide the panel instead of close it.\n  ipcRenderer.on(`${ipcFlag}:close`, () => {\n    action = 'close';\n  });\n\n  ipcRenderer.on(`${ns}:panel-win-state-changed`, (_, eventName: string) => {\n    try {\n      this.$.webview.send(`${ns}:panel-win-state-changed`, eventName);\n    } catch (_) {}\n  });\n  ipcRenderer.send(`${ns}:panel-ready`);\n}\n\nasync function beforeClose(options: any = {}) {\n  if (\n    forceClose ||\n    options.move || // it's a move panel?\n    (element.panels && element.panels.length > 1) // there are more than one panels?\n  ) {\n    return true;\n  }\n\n  if (action === 'refresh') {\n    // allow refresh.\n    return true;\n  }\n\n  // Action is not refresh, we reset it to refresh.\n  action = 'refresh';\n\n  try {\n    // If whole editor is closing, then we need to allow close the panel.\n    const closingMain = await Editor.Message.request(ns, 'whether-close');\n    if (closingMain) {\n      return true;\n    }\n\n    // If there is only our panel, hide it instead of close it.\n    ipcRenderer.send(`${ns}:hide-panel`);\n    return false;\n  } catch (error) {\n    return true;\n  }\n}\n\nfunction close() {\n  Editor.Message.removeBroadcastListener(\n    `${ns}:force-close-panel`,\n    forceClosePanel\n  );\n}\n\nfunction onIpcMessage(\n  event: Electron.IpcMessageEvent,\n  webview: Electron.WebviewTag,\n  loadingPage: HTMLElement\n)\n{\n  function handleNewMsg() {\n    Editor.Message.send(ns, 'update-toolbar', {\n      newMsgCount: event.args[0].newMsgCount,\n    });\n  }\n\n  function handleIsReady() {\n    loadingPage.style.display = 'none';\n  }\n\n  async function handleDownload(needDetailResult: boolean) {\n    const type = event.args[0].type;\n    const fileName = event.args[0].fileName;\n    let options = null;\n    if (type === 'image') {\n      options = {\n        title: tr('save-image'),\n        path: fileName,\n        filters: [\n          {\n            name: tr('image-filter-name'),\n            extensions: ['jpg', 'jpeg', 'png', 'gif'],\n          },\n        ],\n      };\n    } else {\n      options = {\n        title: tr('save-file'),\n        path: fileName,\n        filters: [{ name: tr('file-filter-name'), extensions: ['*'] }],\n      };\n    }\n\n    const result = await save(options);\n    if (!result.filePath) {\n      if (needDetailResult) {\n        webview.send('download-canceled', event.args[0].callId);\n      }\n      return;\n    }\n\n    const url = event.args[0].url;\n    const outputDir = path.dirname(result.filePath);\n    const downloadStream = download(url, outputDir, {\n      filename: path.basename(result.filePath),\n    });\n    if (needDetailResult) {\n      downloadStream.on('downloadProgress', (progress) => {\n        webview.send('download-progress', {\n          callId: event.args[0].callId,\n          percent: progress.percent,\n          transferred: progress.transferred,\n          total: progress.total,\n        });\n      });\n\n      try {\n        await downloadStream;\n        webview.send('download-succeeded', event.args[0].callId);\n      } catch (e) {\n        webview.send('download-failed', {\n          callId: event.args[0].callId,\n          errorStr: e.toString(),\n        });\n      }\n    }\n  }\n\n  async function handleSelectFile() {\n    function showOpenDialog(): Promise<{\n      canceled: boolean;\n      filePaths: string[];\n    }> {\n      const type = event.args[0].type;\n      let options: Parameters<typeof select>[0] = undefined;\n      if (type === 'image') {\n        options = {\n          title: tr('select-image'),\n          filters: [\n            {\n              name: tr('image-filter-name'),\n              extensions: ['jpg', 'jpeg', 'png', 'gif'],\n            },\n          ],\n        };\n      } else {\n        options = {\n          title: tr('select-file'),\n          filters: [\n            {\n              name: tr('file-filter-name'),\n              extensions: ['*'],\n            },\n          ],\n        };\n      }\n\n      return select(options);\n    }\n\n    const result = await showOpenDialog();\n    if (result.canceled) {\n      webview.send('file-selected', '');\n    } else {\n      webview.send('file-selected', result.filePaths[0]);\n    }\n  }\n\n  async function handleRequestData() {\n    // 编辑器信息\n    const data = {\n      entry:'plugin',\n      languageType:Editor.I18n.getLanguage(),\n      osTimeZone: `UTC${-new Date().getTimezoneOffset()>=0?'+':''}${-new Date().getTimezoneOffset()/60} ${dayjs.tz.guess()}`,\n      dashBoardVersion:process.env.COCOS_DASHBOARD_VERSION,\n      creatorVersion:Editor.App.version,\n      pluginVersion: pluginVersion,\n      osType:os.type(),\n      osVersion: os.release()\n    }\n    webview.send('get-data', {\n      ...data\n    });\n  }\n\n  switch (event.channel) {\n    case 'new-msg':\n      handleNewMsg();\n      break;\n    case 'is-ready':\n      handleIsReady();\n      break;\n    case 'download':\n      handleDownload(false);\n      break;\n    case 'select-file':\n      handleSelectFile();\n      break;\n    case 'download-with-progress':\n      handleDownload(true);\n      break;\n    case 'request-data':\n      handleRequestData();\n      break;\n    default:\n      break;\n  }\n}\n\nfunction forceClosePanel() {\n  forceClose = true;\n  Editor.Message.send(ns, 'close-panel');\n}\n\n\nconst methods = {\n  async check() {\n    if(that){\n      await controlUpdateBtn(that);\n    }\n  },\n};\n\nexport { template, style,selector as $, ready, beforeClose, close,methods};\n"]}