{"version":3,"sources":["../src/panel/default/host-api.ts"],"names":[],"mappings":"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","file":"host-api.js","sourcesContent":["'use strict';\n\nimport fs from 'fs';\nconst fsPromises = fs.promises;\nimport path from 'path';\nimport { ns } from '../../constant/namespace';\nimport { ipcRenderer } from 'electron';\nimport { IpcRendererEvent } from 'electron/main';\n\nconst pluginVersion = ipcRenderer.sendSync(`${ns}:get-version`);\n\nconst globalAny: any = global;\n\ninterface PanelWinStateChangedListener {\n  (eventName: string): void;\n}\n\nlet panelWinStateChangedListener: PanelWinStateChangedListener | null = null;\n\nipcRenderer.on(`${ns}:panel-win-state-changed`, (_, eventName) => {\n  panelWinStateChangedListener && panelWinStateChangedListener(eventName);\n});\n\nfunction uuid(): string {\n  let d = Date.now();\n  if (\n    typeof performance !== 'undefined' &&\n    typeof performance.now === 'function'\n  )\n    d += performance.now(); // use high-precision timer if available.\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = (d + Math.random() * 16) % 16 | 0;\n    d = Math.floor(d / 16);\n    return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16);\n  });\n}\n\nglobalAny.hostAPI = {\n  imPluginVersion: pluginVersion,\n\n  async getData(){\n    return new Promise((resolve)=>{\n      function resolveData(_:any,param:any){\n        resolve(param);\n      }\n      ipcRenderer.once('get-data', resolveData);\n      ipcRenderer.sendToHost('request-data');\n    })\n  },\n\n  sendToHost: (channel: string, param: any) => {\n    function handleNewMsg() {\n      ipcRenderer.sendToHost('new-msg', {\n        newMsgCount: param,\n      });\n    }\n\n    function handleDownload() {\n      ipcRenderer.sendToHost('download', {\n        url: param.url,\n        type: param.type,\n        fileName: param.fileName,\n      });\n    }\n\n    if (channel === 'new-msg') {\n      handleNewMsg();\n    } else if (channel === 'download') {\n      handleDownload();\n    }\n  },\n\n  isReady(isReady: boolean) {\n    ipcRenderer.sendToHost('is-ready', isReady);\n  },\n\n  setWindowListener(listener: PanelWinStateChangedListener) {\n    panelWinStateChangedListener = listener;\n  },\n\n  async selectFile(type: string) {\n    return new Promise((resolve, _) => {\n      async function openFile(filePath: string) {\n        const fileName = path.basename(filePath);\n        const fileBuffer = await fsPromises.readFile(filePath);\n        return new File([fileBuffer], fileName);\n      }\n\n      function onFileSelected(_: IpcRendererEvent, filePath: string) {\n        if (!filePath) {\n          resolve('');\n          return;\n        }\n        openFile(filePath).then(resolve);\n      }\n\n      ipcRenderer.once('file-selected', onFileSelected);\n\n      ipcRenderer.sendToHost('select-file', {\n        type,\n      });\n    });\n  },\n\n  /**\n   * 下载文件（带进度）\n   * @param params - 下载参数\n   * @param params.url - 下载地址\n   * @param params.type - 文件类型，决定了弹出的选择文件对话框的过滤器\n   * 类型，如果为'image'，则对话框只能选择图片文件，如果为'file'，则对\n   * 话框可以选择任意类型的文件\n   * @param params.fileName - 保存的默认文件名，当用户没有输入文件名的时候使用\n   * @param params.progressCallback [可选] - 进度回调函数，用于通知调\n   * 用者下载进度，该回调函数接收一个叫progress的参数，progress为一个\n   * 对象，该对象有三个属性，分别是percent（数字，范围0-1）、\n   * transferred（数字，当前传输的字节数量）、total（数字，总字节数量），需要\n   * 注意的是，如果reponse没有content-length，则无法确定total，此时传\n   * 入的total为undefined，并且由于没有total，无法计算percent，此时\n   * percent永远为0，但是transferred的值是正常的（已传输的字节数量），\n   * 有没有可能出现reponse没有content-length的情况，需要和后端确认，或\n   * 者进行下防御性编程。\n   * @returns 返回一个Promise，下载成功或者失败后，Promise resolved，\n   * 值为一个对象result，result.status记录了最终下载状态，'succeeded'\n   * （下载成功）、'failed'（下载失败）、'canceled'（下载被取消，即用\n   * 户在弹出保存文件的对话框后，点击了取消），result.errorStr则只有在\n   * status是failed的情况下才会有值，值是一个错误字符串，记录了下载失\n   * 败的原因，比如'RequestError: getaddrinfo ENOTFOUND\n   * download.cocos.org'，注：该Promise不会rejected\n   * @example\n   *\n   *  const result = await hostAPI.downloadWithProgress({\n   *    url: 'https://download.cocos.org/CocosIM/Msg/375d1ba2df1cf4a33d22b8e70dd4725716317.zip',\n   *    type: 'file',\n   *    fileName: '4.zip',\n   *    progressCallback: ({ percent, transferred, total }) => {\n   *      if (total) {\n   *        console.log(\n   *          `percent: ${percent}, transferred: ${transferred}, total: ${total}`\n   *        );\n   *      } else {\n   *        // 当total为undefined的时候，percent永远为0，有意义的值只有transferred\n   *        console.log(`transferred: ${progress.transferred}`);\n   *      }\n   *    }\n   *  });\n   *\n   *  switch (result.status) {\n   *    case 'succeeded':\n   *      console.log('download succeeded');\n   *      break;\n   *    case 'failed':\n   *      console.log(`download failed: ${result.errorStr}`);\n   *      break;\n   *    case 'canceled':\n   *      console.log('download canceled');\n   *      break;\n   *  }\n   *\n   *  结果1(succeeded):\n   *\n   *  console:\n   *     percent: 0, transferred: 0, total: 75119629\n   *     percent: 0.00021199518969935275, transferred: 15925, total: 75119629\n   *     percent: 0.0004301006332179835, transferred: 32309, total: 75119629\n   *     ...\n   *     percent: 0.9997953530894036, transferred: 75104256, total: 75119629\n   *     percent: 1, transferred: 75119629, total: 75119629\n   *\n   *  resolved的值:\n   *     {status: \"succeeded\"}\n   *\n   *  结果2(canceled):\n   *\n   *  resolved的值:\n   *     {status: \"canceled\"}\n   *\n   *  结果3(failed):\n   *\n   *  resolved的值:\n   *     {status: \"failed\", errorStr: \"RequestError: getaddrinfo ENOTFOUND download.cocos.org\"}\n   *\n   */\n  async downloadWithProgress(params: {\n    url: string;\n    type: string;\n    fileName: string;\n    progressCallback?: (progress: {\n      percent: number;\n      transferred: number;\n      total?: number;\n    }) => any;\n  }): Promise<{\n    status: 'succeeded' | 'failed' | 'canceled';\n    errorStr?: string;\n  }> {\n    return new Promise((resolve, _) => {\n      // We need a callId to distinguish between different callbacks of\n      // downloadWithProgress.\n      const callId = uuid();\n      ipcRenderer.sendToHost('download-with-progress', {\n        url: params.url,\n        type: params.type,\n        fileName: params.fileName,\n        callId,\n      });\n\n      function onDownloadProgress(\n        _: IpcRendererEvent,\n        progress: {\n          callId: string;\n          percent: number;\n          transferred: number;\n          total?: number;\n        }\n      ) {\n        if (progress.callId !== callId) return;\n\n        // Download failed: percent = 1, progress.transferred !=\n        // progress.total, don't report this to caller, because it is\n        // a weak abstraction (consider the case we don't have\n        // content-length, we cannot use this to determinte whether\n        // download failed).\n        if (progress.percent == 1 && progress.transferred !== progress.total)\n          return;\n\n        if (params.progressCallback) {\n          params.progressCallback({\n            percent: progress.percent,\n            transferred: progress.transferred,\n            total: progress.total,\n          });\n        }\n      }\n\n      function onDownloadSucceeded(_: IpcRendererEvent, resultCallId: string) {\n        if (resultCallId !== callId) return;\n        resolveResult({ status: 'succeeded' });\n      }\n\n      function onDownloadFailed(\n        _: IpcRendererEvent,\n        error: {\n          callId: string;\n          errorStr: string;\n        }\n      ) {\n        if (error.callId !== callId) return;\n        resolveResult({ status: 'failed', errorStr: error.errorStr });\n      }\n\n      function onDownloadCanceled(_: IpcRendererEvent, resultCallId: string) {\n        if (resultCallId !== callId) return;\n        resolveResult({ status: 'canceled' });\n      }\n\n      function resolveResult(result: {\n        status: 'succeeded' | 'failed' | 'canceled';\n        errorStr?: string;\n      }) {\n        resolve(result);\n        ipcRenderer.off('download-progress', onDownloadProgress);\n        ipcRenderer.off('download-succeeded', onDownloadSucceeded);\n        ipcRenderer.off('download-failed', onDownloadFailed);\n        ipcRenderer.off('download-canceled', onDownloadCanceled);\n      }\n\n      ipcRenderer.on('download-progress', onDownloadProgress);\n\n      ipcRenderer.on('download-succeeded', onDownloadSucceeded);\n\n      ipcRenderer.on('download-failed', onDownloadFailed);\n\n      ipcRenderer.on('download-canceled', onDownloadCanceled);\n    });\n  },\n};\n"]}