"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=__importDefault(require("fs")),fsPromises=fs_1.default.promises,path_1=__importDefault(require("path")),namespace_1=require("../../constant/namespace"),electron_1=require("electron"),pluginVersion=electron_1.ipcRenderer.sendSync(namespace_1.ns+":get-version"),globalAny=global;let panelWinStateChangedListener=null;function uuid(){let r=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(r+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?n:3&n|8).toString(16)})}electron_1.ipcRenderer.on(namespace_1.ns+":panel-win-state-changed",(e,n)=>{panelWinStateChangedListener&&panelWinStateChangedListener(n)}),globalAny.hostAPI={imPluginVersion:pluginVersion,async getData(){return new Promise(r=>{electron_1.ipcRenderer.once("get-data",function(e,n){r(n)}),electron_1.ipcRenderer.sendToHost("request-data")})},sendToHost:(e,n)=>{"new-msg"===e?electron_1.ipcRenderer.sendToHost("new-msg",{newMsgCount:n}):"download"===e&&electron_1.ipcRenderer.sendToHost("download",{url:n.url,type:n.type,fileName:n.fileName})},isReady(e){electron_1.ipcRenderer.sendToHost("is-ready",e)},setWindowListener(e){panelWinStateChangedListener=e},async selectFile(n){return new Promise((r,e)=>{electron_1.ipcRenderer.once("file-selected",function(e,n){n?async function(e){var n=path_1.default.basename(e),e=await fsPromises.readFile(e);return new File([e],n)}(n).then(r):r("")}),electron_1.ipcRenderer.sendToHost("select-file",{type:n})})},async downloadWithProgress(c){return new Promise((n,e)=>{const r=uuid();function t(e,n){n.callId!==r||1==n.percent&&n.transferred!==n.total||c.progressCallback&&c.progressCallback({percent:n.percent,transferred:n.transferred,total:n.total})}function o(e,n){n===r&&s({status:"succeeded"})}function a(e,n){n.callId===r&&s({status:"failed",errorStr:n.errorStr})}function l(e,n){n===r&&s({status:"canceled"})}function s(e){n(e),electron_1.ipcRenderer.off("download-progress",t),electron_1.ipcRenderer.off("download-succeeded",o),electron_1.ipcRenderer.off("download-failed",a),electron_1.ipcRenderer.off("download-canceled",l)}electron_1.ipcRenderer.sendToHost("download-with-progress",{url:c.url,type:c.type,fileName:c.fileName,callId:r}),electron_1.ipcRenderer.on("download-progress",t),electron_1.ipcRenderer.on("download-succeeded",o),electron_1.ipcRenderer.on("download-failed",a),electron_1.ipcRenderer.on("download-canceled",l)})}};