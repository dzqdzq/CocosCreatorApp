"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.close=exports.beforeClose=exports.ready=exports.$=exports.style=exports.template=void 0;const path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),electron_1=require("electron"),download_1=__importDefault(require("download")),file_url_1=__importDefault(require("file-url")),compare_versions_1=__importDefault(require("compare-versions")),translate_1=require("../../common-lib/translate"),dialog_1=require("../../common-lib/dialog"),namespace_1=require("../../constant/namespace"),os_1=__importDefault(require("os")),pluginVersion=electron_1.ipcRenderer.sendSync(namespace_1.ns+":get-version");var utc=require("dayjs/plugin/utc"),timezone=require("dayjs/plugin/timezone"),dayjs=require("dayjs");dayjs.extend(utc),dayjs.extend(timezone),module.paths.push(path_1.default.join(Editor.App.path,"./node_modules"));const element=require("@editor/panel/lib/element"),windowsPkg=require("@base/electron-windows/package.json"),ipcFlag=windowsPkg.name+"@"+windowsPkg.version;let forceClose=!1,tplFile=path_1.default.join(__dirname,"./index.html");0<=compare_versions_1.default(Editor.App.version,"3.8.5")&&(tplFile=path_1.default.join(__dirname,"./index-3.8.5.html"));const template=fs_1.default.readFileSync(tplFile,"utf8"),style=(exports.template=template,fs_1.default.readFileSync(path_1.default.join(__dirname,"./style.css"),"utf8")),selector=(exports.style=style,{webview:"#webview",loadingPage:"#loading-page",updateBtn:"#btn-4"});exports.$=selector;let action="refresh";async function controlUpdateBtn(e){await Editor.Message.request("im-plugin","silent-check")?(e.$.updateBtn.style.display="block",e.$.updateBtn.innerText=translate_1.tr("update-btn")||"update",e.$.updateBtn.addEventListener("click",async()=>{e.$.updateBtn.style.display="none",Editor.Message.send("im-plugin","silent-check-and-update")})):(e.$.updateBtn.style.display="none",e.$.updateBtn.removeEventListener("click",()=>{}))}let that=null;async function ready(){var e;await controlUpdateBtn(that=this),forceClose=!1,Editor.Panel.kitControl,Editor.Message.addBroadcastListener(namespace_1.ns+":force-close-panel",forceClosePanel),await Editor.User.isLoggedIn()?(this.$.webview.addEventListener("dom-ready",()=>{Editor.Message.send(namespace_1.ns,"dom-ready")}),this.$.webview.setAttribute("webpreferences","contextIsolation=false"),this.$.webview.setAttribute("preload",file_url_1.default(path_1.default.join(__dirname,"./host-api.js"))),this.$.webview.addEventListener("ipc-message",e=>{onIpcMessage(e,this.$.webview,this.$.loadingPage)}),(e=await Editor.Message.request(namespace_1.ns,"get-sign-in-url"))?(this.$.webview.src=e,compare_versions_1.default(Editor.App.version,"3.8.5")<0&&this.$.webview.addEventListener("new-window",async e=>{electron_1.shell.openExternal(await Editor.Message.request(namespace_1.ns,"get-redirect-url",e.url))}),electron_1.ipcRenderer.on(ipcFlag+":close",()=>{action="close"}),electron_1.ipcRenderer.on(namespace_1.ns+":panel-win-state-changed",(e,t)=>{try{this.$.webview.send(namespace_1.ns+":panel-win-state-changed",t)}catch(e){}}),electron_1.ipcRenderer.send(namespace_1.ns+":panel-ready")):(dialog_1.info(translate_1.tr("get-sign-in-url-failed"),{title:translate_1.tr("info-title")}),Editor.Message.broadcast(namespace_1.ns+":force-close-panel"))):(await dialog_1.info(translate_1.tr("info-non-logged-in"),{title:translate_1.tr("info-title"),buttons:[translate_1.tr("ok")],default:0}),Editor.Message.broadcast(namespace_1.ns+":force-close-panel"))}async function beforeClose(e={}){if(forceClose||e.move||element.panels&&1<element.panels.length)return!0;if("refresh"===action)return!0;action="refresh";try{return await Editor.Message.request(namespace_1.ns,"whether-close")?!0:(electron_1.ipcRenderer.send(namespace_1.ns+":hide-panel"),!1)}catch(e){return!0}}function close(){Editor.Message.removeBroadcastListener(namespace_1.ns+":force-close-panel",forceClosePanel)}function onIpcMessage(r,o,e){async function t(e){var t=r.args[0].type,a=r.args[0].fileName;let s=null;s="image"===t?{title:translate_1.tr("save-image"),path:a,filters:[{name:translate_1.tr("image-filter-name"),extensions:["jpg","jpeg","png","gif"]}]}:{title:translate_1.tr("save-file"),path:a,filters:[{name:translate_1.tr("file-filter-name"),extensions:["*"]}]};t=await dialog_1.save(s);if(t.filePath){var a=r.args[0].url,n=path_1.default.dirname(t.filePath),a=download_1.default(a,n,{filename:path_1.default.basename(t.filePath)});if(e){a.on("downloadProgress",e=>{o.send("download-progress",{callId:r.args[0].callId,percent:e.percent,transferred:e.transferred,total:e.total})});try{await a,o.send("download-succeeded",r.args[0].callId)}catch(e){o.send("download-failed",{callId:r.args[0].callId,errorStr:e.toString()})}}}else e&&o.send("download-canceled",r.args[0].callId)}async function a(){var e=await function(){var e=r.args[0].type;let t=void 0;return t="image"===e?{title:translate_1.tr("select-image"),filters:[{name:translate_1.tr("image-filter-name"),extensions:["jpg","jpeg","png","gif"]}]}:{title:translate_1.tr("select-file"),filters:[{name:translate_1.tr("file-filter-name"),extensions:["*"]}]},dialog_1.select(t)}();e.canceled?o.send("file-selected",""):o.send("file-selected",e.filePaths[0])}switch(r.channel){case"new-msg":Editor.Message.send(namespace_1.ns,"update-toolbar",{newMsgCount:r.args[0].newMsgCount});break;case"is-ready":e.style.display="none";break;case"download":t(!1);break;case"select-file":a();break;case"download-with-progress":t(!0);break;case"request-data":!async function(){var e={entry:"plugin",languageType:Editor.I18n.getLanguage(),osTimeZone:`UTC${0<=-(new Date).getTimezoneOffset()?"+":""}${-(new Date).getTimezoneOffset()/60} `+dayjs.tz.guess(),dashBoardVersion:process.env.COCOS_DASHBOARD_VERSION,creatorVersion:Editor.App.version,pluginVersion:pluginVersion,osType:os_1.default.type(),osVersion:os_1.default.release()};o.send("get-data",Object.assign({},e))}()}}function forceClosePanel(){forceClose=!0,Editor.Message.send(namespace_1.ns,"close-panel")}exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;const methods={async check(){that&&await controlUpdateBtn(that)}};exports.methods=methods;