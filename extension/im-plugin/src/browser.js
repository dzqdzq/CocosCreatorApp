const _0x5495=["onShowPanel","https://restapi.amap.com/v3/ip?ip=","warn","[Im-plugin] Download im-plugin zip.","join","@base/electron-windows","createWriteStream","getData","toUTCString","extension","getInstance","hostname",":hide-panel","POST","remove","getMonth","dirname","get","catch","home","call","[Im-plugin] The number of errors reached online on the day, 5 times.","[Im-plugin] Go back ok.","getDate","_waitClosedMain","getSignInUrl","create","global","[Im-plugin] Remove callback folder.","message","cocos_uid","https://api-open.cocos.com/open/ip/query","methods","-error","electron","realpath","Update","ensureDir","[Im-plugin] Im-plugin need not update.","request-progress","[Im-plugin] Update ","getPackages","reload","log","getLanguage","Panel","extensions","address","lastErrorTime","plugin_version","./common-lib/update-toolbar","import-package","extension-callback","hasOwnProperty","hide"," failed.","tmpdir","getRedirectUrl","I18n","data","assign","success","copy","uninit","getTimezoneOffset","province","./constant/namespace","error_code","plugin","postData","setConfig","BrowserWindow","[Im-plugin] Im-plugin online version is error, ","has","[Im-plugin] Remove Succeed.","im-plugin.IgnoreImVersion","sumErrorTime","platform","getFullYear","im-plugin:check","axios","paths","App","getConfig","broadcast","[Im-plugin] Im-plugin online version is ","3.3.1","show","replace","./main-lib/http-utils","version","plugin_url","defineProperty","Package","fs-extra","Profile","progreass","firstErrorTime","split","unload","email","then","Message","__importDefault","nickname","request","im-plugin","__setModuleDefault","type","removeListener","close","onClosePanel","load","[Im-plugin] Unzip installation failed .","im-plugin.zip","city",":get-version","./main-lib/service","getImSetting","pipe","__esModule","download-url","path","default","__createBinding","error","updateToolbar","env","sender","enable","queryIPList","dashboard","[Im-plugin] No online info of im-plugin.","ipcMain","./main-lib/controller","download","[Im-plugin] Im-plugin local version is ","status","public-ip","getTime"];!function(e,o){!function(o){for(;--o;)e.push(e.shift())}(++o)}(_0x5495,121);const _0x425e=function(e,o){return _0x5495[e-=279]},_0x11f8d8=_0x425e;var __createBinding=this&&this[_0x11f8d8(282)]||(Object.create?function(e,o,n,t){void 0===t&&(t=n),Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[n]}})}:function(e,o,n,t){void 0===t&&(t=n),e[t]=o[n]}),__setModuleDefault=this&&this[_0x11f8d8(405)]||(Object[_0x11f8d8(324)]?function(e,o){const n=_0x11f8d8;Object[n(390)](e,n(281),{enumerable:!0,value:o})}:function(e,o){e[_0x11f8d8(281)]=o}),__importStar=this&&this.__importStar||function(e){const o=_0x11f8d8;if(e&&e[o(418)])return e;var n={};if(null!=e)for(var t in e)o(281)!==t&&Object.prototype[o(351)][o(318)](e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n},__importDefault=this&&this[_0x11f8d8(401)]||function(e){return e&&e[_0x11f8d8(418)]?e:{default:e}};Object[_0x11f8d8(390)](exports,_0x11f8d8(418),{value:!0}),exports[_0x11f8d8(397)]=exports[_0x11f8d8(410)]=exports[_0x11f8d8(330)]=void 0;const os_1=__importDefault(require("os")),path_1=__importStar(require(_0x11f8d8(280))),compare_versions_1=__importDefault(require("compare-versions")),electron_1=require(_0x11f8d8(332)),service_1=__importDefault(require(_0x11f8d8(415))),namespace_1=require(_0x11f8d8(364)),update_toolbar_1=require(_0x11f8d8(348)),controller_1=__importDefault(require(_0x11f8d8(292))),fs_1=require("fs"),http_utils_1=require(_0x11f8d8(387)),axios_1=__importDefault(require(_0x11f8d8(378))),requestProgress=require(_0x11f8d8(337)),request=require("request");module[_0x11f8d8(379)].push(path_1[_0x11f8d8(281)][_0x11f8d8(302)](Editor[_0x11f8d8(380)][_0x11f8d8(280)],"./node_modules"));const windows=require(_0x11f8d8(303)),fse=require(_0x11f8d8(392)),publicIpApi=require(_0x11f8d8(296)),controller=controller_1[_0x11f8d8(281)][_0x11f8d8(308)]();let panelWin=null;const reportOptions={url:"http://k.cocosgame.net:58511",method:_0x11f8d8(311),json:!0};function _ip2int(e){let o=0;return e=e[_0x11f8d8(396)]("."),o=256*Number(e[0])*256*256+256*Number(e[1])*256+256*Number(e[2])+Number(e[3]),o>>>=0}async function commonFields(){const e=_0x11f8d8;var o,n,t,i;let r="",a="",s="",l="",c="";try{if(r=await publicIpApi.v4()){const d=await http_utils_1[e(367)](e(329),{ip:_ip2int(r)});if(e(359)==(null==d?void 0:d[e(365)])&&(a=null===(o=null==d?void 0:d[e(357)])||void 0===o?void 0:o[e(413)],s=null===(n=null==d?void 0:d.data)||void 0===n?void 0:n.country,l=null===(t=null==d?void 0:d.data)||void 0===t?void 0:t.province,c=null===(i=null==d?void 0:d[e(357)])||void 0===i?void 0:i[e(345)],!("中国"!==s||a&&l))){const o=(await axios_1.default[e(315)](e(299)+r+"&output=json&key=26041aa0d18a23da7945afd4998ad5e5"))[e(357)];"1"==o[e(295)]&&(c=s+"-"+(l=o[e(363)])+"-"+(a=o[e(413)]))}}}catch(e){r=""}const d=process[e(285)],p=(new Date)[e(306)](),u=d[e(289)],m=await Editor.App[e(388)],f=await Editor[e(356)][e(342)](),_=await Editor.User[e(305)]();return{appType:"secretary",time:p,dashBoardVersion:u,creatorVersion:m,city:a,country:s,province:l,address:c,locate:f,userData:_,nickName:_[e(402)],email:_[e(398)],cocos_uid:_[e(328)],ips:await Editor.Network[e(288)](),osType:os_1[e(281)][e(406)](),osPlatform:os_1.default[e(375)](),osHostname:os_1[e(281)][e(309)](),osTmpdir:os_1[e(281)][e(354)](),publicIp:r,osArch:os_1.default.arch(),currentPjName:Editor.Project.name}}async function reportInformation(){const e=_0x11f8d8,o=(new Date)[e(362)]()/60,n=getVersion(),{time:t,dashBoardVersion:i,creatorVersion:r,locate:a,userData:s,city:l,country:c,province:d,address:p,nickName:u,email:m,cocos_uid:f,ips:_,osType:g,osPlatform:h,osHostname:w,osTmpdir:x,appType:v,osArch:I,publicIp:y,currentPjName:b}=await commonFields(),E={timeZone:o,time:t,dashBoardVersion:i,creatorVersion:r,pluginVersion:n,locate:a,userData:s,nickName:u,email:m,cocos_uid:f,ips:_,osType:g,osPlatform:h,osHostname:w,osTmpdir:x,appType:v,osArch:I,publicIp:y,city:l,country:c,province:d,address:p,currentPjName:b,entryType:e(366),reportType:"Start"};request(Object.assign({},reportOptions,{body:E}),()=>{})}async function updateReportInformation(e,o,n,t){const i=_0x11f8d8,{time:r,dashBoardVersion:a,creatorVersion:s,locate:l,userData:c,nickName:d,city:p,country:u,province:m,address:f,email:_,appType:g,cocos_uid:h,ips:w,osType:x,osPlatform:v,osHostname:I,publicIp:y,osTmpdir:b,osArch:E,currentPjName:V}=await commonFields(),P={time:r,preVersion:e,newVersion:o,updateStatus:n,dashBoardVersion:a,creatorVersion:s,publicIp:y,locate:l,city:p,country:u,province:m,address:f,userData:c,nickName:d,email:_,cocos_uid:h,appType:g,ips:w,osType:x,osPlatform:v,osHostname:I,osTmpdir:b,osArch:E,currentPjName:V,reportType:i(334)};t&&Object[i(358)](P,{errorName:t.name,errorMessage:t[i(327)]}),request(Object[i(358)]({},reportOptions,{body:P}),()=>{})}function load(){const e=_0x11f8d8;electron_1[e(291)].on(namespace_1.ns+e(310),hidePanel),electron_1[e(291)].on(namespace_1.ns+":get-version",getVersion_),controller.init(),isVersionMore331()&&silentCheckAndUpdate(),setTimeout(()=>{reportInformation()},1e3)}function unload(){const e=_0x11f8d8;electron_1[e(291)].removeListener(namespace_1.ns+e(310),hidePanel),electron_1[e(291)][e(407)](namespace_1.ns+e(414),getVersion_),controller[e(361)]()}exports.load=load,exports.unload=unload;let savedInfo=null;const downloadZip=async(e,o)=>{const n=_0x11f8d8;await fse.ensureDir(path_1[n(314)](o)),await new Promise((t,i)=>{const r=n;requestProgress(request(e),{delay:300}).on(r(394),function(e){}).on(r(283),function(e){i(e)}).on("end",function(e,o){t(null)})[r(417)](fs_1[r(304)](o))})},formatVersion=e=>e[_0x11f8d8(386)](/\./g,"-"),isVersionMore331=()=>{const e=_0x11f8d8,o=Editor.App[e(388)];if(!(compare_versions_1.default(o,e(384))<=0))return!0;console[e(300)]("[Im-plugin] The editor does not support automatic updates of versions below 3.3.1.If im-plugin has new version, you need to download it manually from the store.")},silentCheck=async()=>{const e=_0x11f8d8;if(console[e(341)]("[Im-plugin] Check im-plugin version."),!isVersionMore331())return;const o=await service_1[e(281)].getInstance(),n=await o[e(416)]();if(!n||!n.plugin_version||!n[e(389)])return void console[e(341)](e(290));const t=n[e(347)];if(!0===await Editor[e(393)].getConfig(e(373),formatVersion(t),e(325)))return void console[e(341)]("[Im-plugin] Im-plugin online version has something wrong, don't update.");const i=await Editor[e(393)][e(381)](e(373),e(346),e(325));if((new Date)[e(297)]()-i<6e5)return;const r=getCurrentErrorTime(),a=await Editor[e(393)][e(381)]("im-plugin.IgnoreImVersion",r,"global");if(parseInt(a)<=0)return void console[e(341)](e(319));if(!compare_versions_1[e(281)].validate(t))return void console[e(341)](e(370)+t+".");console.log(e(383)+t+".");const s=getVersion();if(console.log(e(294)+s+"."),!(compare_versions_1[e(281)](t,s)<=0))return{imSetting:n,newVersion:t,curVersion:s};console.log(e(336))},unZipAndInstall=async(e,o)=>await new Promise(async n=>{const t=_0x11f8d8;await Editor[t(400)][t(403)](t(307),t(349),t(325),e,{forceImport:!0})[t(399)](async()=>{const i=t;await fse[i(312)](e),await Editor.Message[i(403)](i(307),i(287),o,!0),n(!0)})[t(316)](()=>{n(!1)})}),getCurrentErrorTime=()=>{const e=_0x11f8d8,o=new Date;return o[e(376)]()+"-"+(o[e(313)]()+1)+"-"+o[e(321)]()+e(331)},silentCheckAndUpdate=async()=>{const e=_0x11f8d8,o=await silentCheck();if(!o)return;const{imSetting:n,newVersion:t,curVersion:i}=o,r=path_1[e(302)](Editor[e(380)][e(317)],e(350),"im-plugin.callback");await fse[e(335)](r),console.log("[Im-plugin] Remove your old im-plugin to "+r);let a=path_1[e(302)](Editor[e(380)][e(317)],"extensions",e(404)),s=await Editor[e(391)][e(339)]({name:e(404),enable:!0});s[0]&&(a=s[0].path);const l=path_1.join(Editor.App[e(317)],e(344),e(404)),c=path_1.join(Editor[e(380)][e(317)],e(293),e(412));try{await fse[e(360)](a,r)[e(399)](async()=>{const o=e;console[o(341)](o(372));let r=!0;if(await Editor[o(393)][o(381)]("im-plugin.IgnoreImVersion",o(279),"global")===n[o(389)])try{await fse[o(333)](c),console[o(341)]("[Im-plugin] Im-plugin zip exists."),r=!1}catch(e){r=!0}if(await Editor[o(393)][o(368)](o(373),o(279),n[o(389)],o(325)),r&&(console[o(341)](o(301)),await downloadZip(n.plugin_url,c)),await Editor[o(343)][o(371)](o(281)))console[o(341)]("[Im-plugin] You need to update in panel due to you opening it.");else{if(!await unZipAndInstall(c,l))throw new Error(o(411));updateReportInformation(i,t,!0,null)}})}catch(o){updateReportInformation(i,t,!1,o),console[e(283)](e(338)+t+e(353));const n=await Editor.Profile[e(381)](e(373),e(395),e(325));await Editor[e(393)][e(368)]("im-plugin.IgnoreImVersion",e(346),(new Date)[e(297)](),"global"),n||await Editor[e(393)][e(368)](e(373),e(395),(new Date)[e(297)](),"global");const s=getCurrentErrorTime(),l=await Editor[e(393)][e(381)](e(373),s,"global");l?await Editor.Profile[e(368)]("im-plugin.IgnoreImVersion",s,l-1,e(325)):await Editor.Profile[e(368)](e(373),s,4,e(325));const d=await Editor[e(393)].getConfig(e(373),"sumErrorTime",e(325));d?await Editor[e(393)].setConfig("im-plugin.IgnoreImVersion","sumErrorTime",d+1,e(325)):await Editor[e(393)][e(368)](e(373),e(374),1,e(325));const p=(new Date).getTime()-n>=2592e6;(d>=15||p)&&await Editor.Profile[e(368)]("im-plugin.IgnoreImVersion",formatVersion(t),!0,e(325)),console[e(341)]("[Im-plugin] Go back to old version."+i),await fse[e(360)](r,a)[e(399)](async()=>{const o=e;console[o(341)](o(320)),await Editor[o(400)].request(o(307),o(340),a)[o(399)](()=>{const e=o;fse[e(312)](r),fse[e(312)](c),console[e(341)](e(326))})})}},methods={showPanel(){const e=_0x11f8d8;console.log("[im-plugin] Current version is "+getVersion()),panelWin?(panelWin[e(385)](),isVersionMore331()&&Editor[e(400)][e(382)](e(377)),panelWin=null):Editor[e(343)].open(namespace_1.ns),controller[e(298)]()},silentCheckAndUpdate:silentCheckAndUpdate,silentCheck:silentCheck,unZipAndInstall:unZipAndInstall,closePanel(){const e=_0x11f8d8;Editor.Panel[e(408)](namespace_1.ns),panelWin=null,controller[e(409)]()},whetherClose:()=>windows[_0x11f8d8(322)],getSignInUrl:async()=>(await service_1[_0x11f8d8(281)].getInstance())[_0x11f8d8(323)](),getRedirectUrl:async e=>(await service_1[_0x11f8d8(281)][_0x11f8d8(308)]())[_0x11f8d8(355)](e),updateToolbarMain(e,o){update_toolbar_1[_0x11f8d8(284)](e,o)},saveToolbarInfo(e){savedInfo=e},getSavedToolbarInfo:()=>savedInfo};function hidePanel(e){const o=_0x11f8d8;(panelWin=electron_1[o(369)].fromWebContents(e[o(286)]))?(panelWin[o(352)](),controller.onHidePanel()):console[o(283)]("cannot hide panel, panelWin is undefined")}function getVersion_(e){e.returnValue=getVersion()}function getVersion(){const e=_0x11f8d8;return Editor[e(391)].getPackages({name:namespace_1.ns,enable:!0})[0][e(388)]}exports[_0x11f8d8(330)]=methods;