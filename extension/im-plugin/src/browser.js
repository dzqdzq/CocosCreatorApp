"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return o[i]}})}:function(e,o,i,n){e[n=void 0===n?i:n]=o[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(o,e,i);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const os_1=__importDefault(require("os")),path_1=__importStar(require("path")),compare_versions_1=__importDefault(require("compare-versions")),electron_1=require("electron"),service_1=__importDefault(require("./main-lib/service")),namespace_1=require("./constant/namespace"),update_toolbar_1=require("./common-lib/update-toolbar"),controller_1=__importDefault(require("./main-lib/controller")),fs_1=require("fs"),http_utils_1=require("./main-lib/http-utils"),inject_1=require("./common-lib/inject"),requestProgress=require("request-progress"),request=require("request"),windows=(module.paths.push(path_1.default.join(Editor.App.path,"./node_modules")),require("@base/electron-windows")),fse=require("fs-extra"),publicIpApi=require("public-ip"),controller=controller_1.default.getInstance();let panelWin=null;const reportOptions={url:"http://k.cocosgame.net:58511",method:"POST",json:!0};function _ip2int(e){var o=0;return e=e.split("."),o=256*Number(e[0])*256*256+256*Number(e[1])*256+256*Number(e[2])+Number(e[3]),o>>>=0}async function commonFields(){let o="",e="",i="",n="",r="",t="";try{(o=await publicIpApi.v4())&&"success"==(null==(u=await http_utils_1.postData("https://im.cocos.com/welcome/query",{ip:o}))?void 0:u.code)&&(e=null==(a=null==u?void 0:u.data)?void 0:a.city,i=null==(s=null==u?void 0:u.data)?void 0:s.country,n=null==(l=null==u?void 0:u.data)?void 0:l.province,t=null==(p=null==u?void 0:u.data)?void 0:p.district,r=`${i}-${n}-`+e)}catch(e){o=""}var a=process.env,s=(new Date).toUTCString(),l=a.dashboard,u=await Editor.App.version,p=await Editor.I18n.getLanguage(),a=await Editor.User.getData(),c=a.nickname,d=a.email,m=a.cocos_uid,g=await Editor.Network.queryIPList(),f=os_1.default.type(),_=os_1.default.platform(),h=os_1.default.hostname(),I=os_1.default.tmpdir(),w=os_1.default.arch(),v=Editor.Project.name;return{appType:"secretary",time:s,dashBoardVersion:l,creatorVersion:u,city:e,country:i,district:t,province:n,address:r,locate:p,userData:a,nickName:c,email:d,cocos_uid:m,ips:g,osType:f,osPlatform:_,osHostname:h,osTmpdir:I,publicIp:o,osArch:w,currentPjName:v}}async function reportInformation(){var e=(new Date).getTimezoneOffset()/60,o=getVersion(),{time:i,dashBoardVersion:n,creatorVersion:r,locate:t,userData:a,city:s,country:l,district:u,province:p,address:c,nickName:d,email:m,cocos_uid:g,ips:f,osType:_,osPlatform:h,osHostname:I,osTmpdir:w,appType:v,osArch:b,publicIp:y,currentPjName:P}=await commonFields(),e={timeZone:e,time:i,dashBoardVersion:n,creatorVersion:r,pluginVersion:o,district:u,locate:t,userData:a,nickName:d,email:m,cocos_uid:g,ips:f,osType:_,osPlatform:h,osHostname:I,osTmpdir:w,appType:v,osArch:b,publicIp:y,city:s,country:l,province:p,address:c,currentPjName:P,entryType:"plugin",reportType:"Start"};request(Object.assign({},reportOptions,{body:e}),()=>{})}async function updateReportInformation(e,o,i,n){var{time:r,dashBoardVersion:t,creatorVersion:a,locate:s,userData:l,nickName:u,city:p,country:c,province:d,address:m,email:g,appType:f,cocos_uid:_,ips:h,district:I,osType:w,osPlatform:v,osHostname:b,publicIp:y,osTmpdir:P,osArch:V,currentPjName:E}=await commonFields(),r={time:r,preVersion:e,newVersion:o,updateStatus:i,dashBoardVersion:t,creatorVersion:a,publicIp:y,district:I,locate:s,city:p,country:c,province:d,address:m,userData:l,nickName:u,email:g,cocos_uid:_,appType:f,ips:h,osType:w,osPlatform:v,osHostname:b,osTmpdir:P,osArch:V,currentPjName:E,reportType:"Update"};n&&Object.assign(r,{errorName:n.name,errorMessage:n.message}),request(Object.assign({},reportOptions,{body:r}),()=>{})}async function load(){electron_1.ipcMain.on(namespace_1.ns+":hide-panel",hidePanel),electron_1.ipcMain.on(namespace_1.ns+":get-version",getVersion_),controller.init(),compare_versions_1.default(Editor.App.version,"3.8.2")<0&&await inject_1.inject(),isVersionMore331()&&silentCheckAndUpdate(),setTimeout(()=>{reportInformation()},1e3)}function unload(){electron_1.ipcMain.removeListener(namespace_1.ns+":hide-panel",hidePanel),electron_1.ipcMain.removeListener(namespace_1.ns+":get-version",getVersion_),controller.uninit()}exports.load=load,exports.unload=unload;let savedInfo=null;const downloadZip=async(e,n)=>{await fse.ensureDir(path_1.dirname(n)),await new Promise((i,o)=>{requestProgress(request(e),{delay:300}).on("progreass",function(e){}).on("error",function(e){o(e)}).on("end",function(e,o){i(null)}).pipe(fs_1.createWriteStream(n))})},formatVersion=e=>e.replace(/\./g,"-"),isVersionMore331=()=>{var e=Editor.App.version;return compare_versions_1.default(e,"3.3.1")<=0?(console.warn("[Im-plugin] The editor does not support automatic updates of versions below 3.3.1.If im-plugin has new version, you need to download it manually from the store."),!1):!(0<=compare_versions_1.default(e,"3.7.0"))},silentCheck=async()=>{if(console.log("[Im-plugin] Check im-plugin version."),isVersionMore331()){var e=await(await service_1.default.getInstance()).getImSetting();if(e&&e.plugin_version&&e.plugin_url){var o=e.plugin_version;if(!0===await Editor.Profile.getConfig("im-plugin.IgnoreImVersion",formatVersion(o),"global"))console.log("[Im-plugin] Im-plugin online version has something wrong, don't update.");else{var i=await Editor.Profile.getConfig("im-plugin.IgnoreImVersion","lastErrorTime","global");if(!((new Date).getTime()-i<6e5)){i=getCurrentErrorTime(),i=await Editor.Profile.getConfig("im-plugin.IgnoreImVersion",i,"global");if(parseInt(i)<=0)console.log("[Im-plugin] The number of errors reached online on the day, 5 times.");else if(compare_versions_1.default.validate(o)){console.log(`[Im-plugin] Im-plugin online version is ${o}.`);i=getVersion();if(console.log(`[Im-plugin] Im-plugin local version is ${i}.`),!(compare_versions_1.default(o,i)<=0))return{imSetting:e,newVersion:o,curVersion:i};console.log("[Im-plugin] Im-plugin need not update.")}else console.log(`[Im-plugin] Im-plugin online version is error, ${o}.`)}}}else console.log("[Im-plugin] No online info of im-plugin.")}},unZipAndInstall=async(o,i)=>new Promise(async e=>{await Editor.Message.request("extension","import-package","global",o,{forceImport:!0}).then(async()=>{await fse.remove(o),await Editor.Message.request("extension","enable",i,!0),e(!0)}).catch(()=>{e(!1)})}),getCurrentErrorTime=()=>{var e=new Date;return e.getFullYear()+`-${e.getMonth()+1}-${e.getDate()}-error`},silentCheckAndUpdate=async()=>{var i=await silentCheck();if(i){const{imSetting:e,newVersion:t,curVersion:a}=i,s=path_1.join(Editor.App.home,"extension-callback","im-plugin.callback");await fse.ensureDir(s),console.log("[Im-plugin] Remove your old im-plugin to "+s);let o=path_1.join(Editor.App.home,"extensions","im-plugin");i=await Editor.Package.getPackages({name:"im-plugin",enable:!0});i[0]&&(o=i[0].path);const l=path_1.join(Editor.App.home,"extensions","im-plugin"),u=path_1.join(Editor.App.home,"download","im-plugin.zip");try{await fse.copy(o,s).then(async()=>{console.log("[Im-plugin] Remove Succeed.");let o=!0;if(await Editor.Profile.getConfig("im-plugin.IgnoreImVersion","download-url","global")===e.plugin_url)try{await fse.realpath(u),console.log("[Im-plugin] Im-plugin zip exists."),o=!1}catch(e){o=!0}if(await Editor.Profile.setConfig("im-plugin.IgnoreImVersion","download-url",e.plugin_url,"global"),o&&(console.log("[Im-plugin] Download im-plugin zip."),await downloadZip(e.plugin_url,u)),await Editor.Panel.has("default"))console.log("[Im-plugin] You need to update in panel due to you opening it.");else{if(!await unZipAndInstall(u,l))throw new Error("[Im-plugin] Unzip installation failed .");updateReportInformation(a,t,!0,null)}})}catch(e){updateReportInformation(a,t,!1,e),console.error(`[Im-plugin] Update ${t} failed.`);var i=await Editor.Profile.getConfig("im-plugin.IgnoreImVersion","firstErrorTime","global"),n=(await Editor.Profile.setConfig("im-plugin.IgnoreImVersion","lastErrorTime",(new Date).getTime(),"global"),i||await Editor.Profile.setConfig("im-plugin.IgnoreImVersion","firstErrorTime",(new Date).getTime(),"global"),getCurrentErrorTime()),r=await Editor.Profile.getConfig("im-plugin.IgnoreImVersion",n,"global"),r=(r?await Editor.Profile.setConfig("im-plugin.IgnoreImVersion",n,r-1,"global"):await Editor.Profile.setConfig("im-plugin.IgnoreImVersion",n,4,"global"),await Editor.Profile.getConfig("im-plugin.IgnoreImVersion","sumErrorTime","global")),n=(r?await Editor.Profile.setConfig("im-plugin.IgnoreImVersion","sumErrorTime",r+1,"global"):await Editor.Profile.setConfig("im-plugin.IgnoreImVersion","sumErrorTime",1,"global"),2592e6<=(new Date).getTime()-i);(15<=r||n)&&await Editor.Profile.setConfig("im-plugin.IgnoreImVersion",formatVersion(t),!0,"global"),console.log("[Im-plugin] Go back to old version."+a),await fse.copy(s,o).then(async()=>{console.log("[Im-plugin] Go back ok."),await Editor.Message.request("extension","reload",o).then(()=>{fse.remove(s),fse.remove(u),console.log("[Im-plugin] Remove callback folder.")})})}}},methods={showPanel(){console.log("[im-plugin] Current version is "+getVersion()),panelWin?(panelWin.show(),isVersionMore331()&&Editor.Message.broadcast("im-plugin:check"),panelWin=null):Editor.Panel.open(namespace_1.ns),controller.onShowPanel()},silentCheckAndUpdate:silentCheckAndUpdate,silentCheck:silentCheck,unZipAndInstall:unZipAndInstall,closePanel(){Editor.Panel.close(namespace_1.ns),panelWin=null,controller.onClosePanel()},whetherClose(){return windows._waitClosedMain},async getSignInUrl(){return(await service_1.default.getInstance()).getSignInUrl()},async getRedirectUrl(e){return(await service_1.default.getInstance()).getRedirectUrl(e)},updateToolbarMain(e,o){update_toolbar_1.updateToolbar(e,o)},saveToolbarInfo(e){savedInfo=e},getSavedToolbarInfo(){return savedInfo}};function hidePanel(e){(panelWin=electron_1.BrowserWindow.fromWebContents(e.sender))?(panelWin.hide(),controller.onHidePanel()):console.error("cannot hide panel, panelWin is undefined")}function getVersion_(e){e.returnValue=getVersion()}function getVersion(){return Editor.Package.getPackages({name:namespace_1.ns,enable:!0})[0].version}exports.methods=methods;