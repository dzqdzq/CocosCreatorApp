const _0x879a=["city","[Im-plugin] Im-plugin online version is error, ","__setModuleDefault","extensions","getConfig","path","pipe","prototype","User","success","import-package","catch","fromWebContents","hostname","paths","request-progress","im-plugin:check","getRedirectUrl","sender","[im-plugin] Current version is ","platform","download-url","public-ip","push","-error","removeListener","extension","reload","code","./common-lib/update-toolbar","./constant/namespace","log","getDate","Project","getLanguage","[Im-plugin] Download im-plugin zip.","[Im-plugin] Check im-plugin version.","tmpdir","compare-versions","open","show","then","getData","ensureDir","onClosePanel","init","[Im-plugin] No online info of im-plugin.","[Im-plugin] Im-plugin online version has something wrong, don't update.","updateToolbar","Update","queryIPList","unload","[Im-plugin] Remove Succeed.","im-plugin","[Im-plugin] Remove your old im-plugin to ","[Im-plugin] Unzip installation failed .","close","sumErrorTime","progreass","[Im-plugin] The editor does not support automatic updates of versions below 3.3.1.If im-plugin has new version, you need to download it manually from the store.","plugin","call","create","province","returnValue","arch","default","lastErrorTime","getTimezoneOffset","_waitClosedMain","[Im-plugin] Im-plugin zip exists.","enable","has","home","split",":hide-panel","toUTCString","3.3.1","Network","request","methods","electron","Profile","global","__importDefault","error","broadcast"," failed.","App","[Im-plugin] The number of errors reached online on the day, 5 times.","join","./main-lib/service","firstErrorTime","__createBinding","Package","@base/electron-windows","message","data","dashboard","plugin_url","setConfig","getTime","onShowPanel",":get-version","./main-lib/http-utils","remove","cocos_uid","Message","im-plugin.zip","fs-extra","Panel","onHidePanel","__esModule","createWriteStream","assign","country","defineProperty","[Im-plugin] Go back to old version.","dirname","getPackages","[Im-plugin] Go back ok.","im-plugin.IgnoreImVersion","[Im-plugin] Update ","I18n","load","copy","plugin_version","http://k.cocosgame.net:58511","ipcMain","getImSetting","BrowserWindow","nickname","version","secretary","env","im-plugin.callback","[Im-plugin] Im-plugin online version is ","getFullYear","hide","getInstance"];!function(e,o){!function(o){for(;--o;)e.push(e.shift())}(++o)}(_0x879a,471);const _0x397a=function(e,o){return _0x879a[e-=184]},_0x468768=_0x397a;var __createBinding=this&&this[_0x468768(226)]||(Object[_0x468768(195)]?function(e,o,n,t){void 0===t&&(t=n),Object[_0x468768(249)](e,t,{enumerable:!0,get:function(){return o[n]}})}:function(e,o,n,t){void 0===t&&(t=n),e[t]=o[n]}),__setModuleDefault=this&&this[_0x468768(275)]||(Object[_0x468768(195)]?function(e,o){const n=_0x468768;Object[n(249)](e,n(199),{enumerable:!0,value:o})}:function(e,o){e[_0x468768(199)]=o}),__importStar=this&&this.__importStar||function(e){const o=_0x468768;if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)"default"!==t&&Object[o(280)].hasOwnProperty[o(194)](e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n},__importDefault=this&&this[_0x468768(217)]||function(e){return e&&e.__esModule?e:{default:e}};Object[_0x468768(249)](exports,_0x468768(245),{value:!0}),exports[_0x468768(184)]=exports[_0x468768(257)]=exports[_0x468768(213)]=void 0;const os_1=__importDefault(require("os")),path_1=__importStar(require(_0x468768(278))),compare_versions_1=__importDefault(require(_0x468768(311))),electron_1=require(_0x468768(214)),service_1=__importDefault(require(_0x468768(224))),namespace_1=require(_0x468768(303)),update_toolbar_1=require(_0x468768(302)),controller_1=__importDefault(require("./main-lib/controller")),fs_1=require("fs"),http_utils_1=require(_0x468768(237)),requestProgress=require(_0x468768(288)),request=require(_0x468768(212));module[_0x468768(287)][_0x468768(296)](path_1.default[_0x468768(223)](Editor[_0x468768(221)][_0x468768(278)],"./node_modules"));const windows=require(_0x468768(228)),fse=require(_0x468768(242)),publicIpApi=require(_0x468768(295)),controller=controller_1[_0x468768(199)][_0x468768(272)]();let panelWin=null;const reportOptions={url:_0x468768(260),method:"POST",json:!0};function _ip2int(e){let o=0;return e=e[_0x468768(207)]("."),o=256*Number(e[0])*256*256+256*Number(e[1])*256+256*Number(e[2])+Number(e[3]),o>>>=0}async function commonFields(){const e=_0x468768;var o,n,t,i;let r="",a="",s="",l="",c="",u="";try{if(r=await publicIpApi.v4()){const p=await http_utils_1.postData("https://im.cocos.com/welcome/query",{ip:r});e(282)==(null==p?void 0:p[e(301)])&&(a=null===(o=null==p?void 0:p[e(230)])||void 0===o?void 0:o[e(273)],s=null===(n=null==p?void 0:p.data)||void 0===n?void 0:n[e(248)],l=null===(t=null==p?void 0:p[e(230)])||void 0===t?void 0:t[e(196)],u=null===(i=null==p?void 0:p[e(230)])||void 0===i?void 0:i.district,c=s+"-"+l+"-"+a)}}catch(e){r=""}const p=process[e(267)],d=(new Date)[e(209)](),m=p[e(231)],_=await Editor[e(221)][e(265)],g=await Editor[e(256)][e(307)](),f=await Editor[e(281)][e(315)]();return{appType:e(266),time:d,dashBoardVersion:m,creatorVersion:_,city:a,country:s,district:u,province:l,address:c,locate:g,userData:f,nickName:f[e(264)],email:f.email,cocos_uid:f[e(239)],ips:await Editor[e(211)][e(323)](),osType:os_1[e(199)].type(),osPlatform:os_1[e(199)][e(293)](),osHostname:os_1[e(199)][e(286)](),osTmpdir:os_1[e(199)][e(310)](),publicIp:r,osArch:os_1.default[e(198)](),currentPjName:Editor[e(306)].name}}async function reportInformation(){const e=_0x468768,o=(new Date)[e(201)]()/60,n=getVersion(),{time:t,dashBoardVersion:i,creatorVersion:r,locate:a,userData:s,city:l,country:c,district:u,province:p,address:d,nickName:m,email:_,cocos_uid:g,ips:f,osType:h,osPlatform:w,osHostname:x,osTmpdir:I,appType:v,osArch:y,publicIp:b,currentPjName:E}=await commonFields(),V={timeZone:o,time:t,dashBoardVersion:i,creatorVersion:r,pluginVersion:n,district:u,locate:a,userData:s,nickName:m,email:_,cocos_uid:g,ips:f,osType:h,osPlatform:w,osHostname:x,osTmpdir:I,appType:v,osArch:y,publicIp:b,city:l,country:c,province:p,address:d,currentPjName:E,entryType:e(193),reportType:"Start"};request(Object[e(247)]({},reportOptions,{body:V}),()=>{})}async function updateReportInformation(e,o,n,t){const i=_0x468768,{time:r,dashBoardVersion:a,creatorVersion:s,locate:l,userData:c,nickName:u,city:p,country:d,province:m,address:_,email:g,appType:f,cocos_uid:h,ips:w,district:x,osType:I,osPlatform:v,osHostname:y,publicIp:b,osTmpdir:E,osArch:V,currentPjName:T}=await commonFields(),P={time:r,preVersion:e,newVersion:o,updateStatus:n,dashBoardVersion:a,creatorVersion:s,publicIp:b,district:x,locate:l,city:p,country:d,province:m,address:_,userData:c,nickName:u,email:g,cocos_uid:h,appType:f,ips:w,osType:I,osPlatform:v,osHostname:y,osTmpdir:E,osArch:V,currentPjName:T,reportType:i(322)};t&&Object[i(247)](P,{errorName:t.name,errorMessage:t[i(229)]}),request(Object[i(247)]({},reportOptions,{body:P}),()=>{})}function load(){const e=_0x468768;electron_1[e(261)].on(namespace_1.ns+e(208),hidePanel),electron_1[e(261)].on(namespace_1.ns+e(236),getVersion_),controller[e(318)](),isVersionMore331()&&silentCheckAndUpdate(),setTimeout(()=>{reportInformation()},1e3)}function unload(){const e=_0x468768;electron_1[e(261)].removeListener(namespace_1.ns+":hide-panel",hidePanel),electron_1[e(261)][e(298)](namespace_1.ns+e(236),getVersion_),controller.uninit()}exports[_0x468768(257)]=load,exports[_0x468768(184)]=unload;let savedInfo=null;const downloadZip=async(e,o)=>{const n=_0x468768;await fse[n(316)](path_1[n(251)](o)),await new Promise((t,i)=>{const r=n;requestProgress(request(e),{delay:300}).on(r(191),function(e){}).on(r(218),function(e){i(e)}).on("end",function(e,o){t(null)})[r(279)](fs_1[r(246)](o))})},formatVersion=e=>e.replace(/\./g,"-"),isVersionMore331=()=>{const e=_0x468768,o=Editor[e(221)].version;return compare_versions_1.default(o,e(210))<=0?(console.warn(e(192)),!1):!(compare_versions_1[e(199)](o,"3.7.0")>=0)},silentCheck=async()=>{const e=_0x468768;if(console.log(e(309)),!isVersionMore331())return;const o=await service_1.default[e(272)](),n=await o[e(262)]();if(!n||!n[e(259)]||!n[e(232)])return void console[e(304)](e(319));const t=n[e(259)];if(!0===await Editor[e(215)][e(277)](e(254),formatVersion(t),"global"))return void console[e(304)](e(320));const i=await Editor[e(215)].getConfig(e(254),e(200),e(216));if((new Date).getTime()-i<6e5)return;const r=getCurrentErrorTime(),a=await Editor.Profile[e(277)]("im-plugin.IgnoreImVersion",r,e(216));if(parseInt(a)<=0)return void console[e(304)](e(222));if(!compare_versions_1[e(199)].validate(t))return void console[e(304)](e(274)+t+".");console[e(304)](e(269)+t+".");const s=getVersion();if(console[e(304)]("[Im-plugin] Im-plugin local version is "+s+"."),!(compare_versions_1[e(199)](t,s)<=0))return{imSetting:n,newVersion:t,curVersion:s};console[e(304)]("[Im-plugin] Im-plugin need not update.")},unZipAndInstall=async(e,o)=>await new Promise(async n=>{const t=_0x468768;await Editor[t(240)][t(212)](t(299),t(283),t(216),e,{forceImport:!0})[t(314)](async()=>{const i=t;await fse[i(238)](e),await Editor[i(240)][i(212)](i(299),i(204),o,!0),n(!0)})[t(284)](()=>{n(!1)})}),getCurrentErrorTime=()=>{const e=_0x468768,o=new Date;return o[e(270)]()+"-"+(o.getMonth()+1)+"-"+o[e(305)]()+e(297)},silentCheckAndUpdate=async()=>{const e=_0x468768,o=await silentCheck();if(!o)return;const{imSetting:n,newVersion:t,curVersion:i}=o,r=path_1[e(223)](Editor.App.home,"extension-callback",e(268));await fse[e(316)](r),console[e(304)](e(187)+r);let a=path_1[e(223)](Editor[e(221)][e(206)],e(276),e(186)),s=await Editor[e(227)][e(252)]({name:e(186),enable:!0});s[0]&&(a=s[0][e(278)]);const l=path_1[e(223)](Editor[e(221)].home,e(276),"im-plugin"),c=path_1[e(223)](Editor.App[e(206)],"download",e(241));try{await fse[e(258)](a,r)[e(314)](async()=>{const o=e;console[o(304)](o(185));let r=!0;if(await Editor[o(215)][o(277)]("im-plugin.IgnoreImVersion",o(294),o(216))===n[o(232)])try{await fse.realpath(c),console[o(304)](o(203)),r=!1}catch(e){r=!0}if(await Editor[o(215)][o(233)](o(254),o(294),n[o(232)],"global"),r&&(console[o(304)](o(308)),await downloadZip(n.plugin_url,c)),await Editor[o(243)][o(205)]("default"))console.log("[Im-plugin] You need to update in panel due to you opening it.");else{if(!await unZipAndInstall(c,l))throw new Error(o(188));updateReportInformation(i,t,!0,null)}})}catch(o){updateReportInformation(i,t,!1,o),console.error(e(255)+t+e(220));const n=await Editor[e(215)][e(277)]("im-plugin.IgnoreImVersion",e(225),e(216));await Editor[e(215)][e(233)](e(254),e(200),(new Date)[e(234)](),"global"),n||await Editor[e(215)].setConfig("im-plugin.IgnoreImVersion",e(225),(new Date).getTime(),e(216));const s=getCurrentErrorTime(),l=await Editor[e(215)][e(277)]("im-plugin.IgnoreImVersion",s,e(216));l?await Editor.Profile.setConfig("im-plugin.IgnoreImVersion",s,l-1,e(216)):await Editor[e(215)][e(233)](e(254),s,4,"global");const u=await Editor[e(215)][e(277)](e(254),"sumErrorTime",e(216));u?await Editor[e(215)][e(233)](e(254),e(190),u+1,e(216)):await Editor.Profile[e(233)]("im-plugin.IgnoreImVersion",e(190),1,e(216));const p=(new Date)[e(234)]()-n>=2592e6;(u>=15||p)&&await Editor[e(215)][e(233)](e(254),formatVersion(t),!0,e(216)),console.log(e(250)+i),await fse[e(258)](r,a).then(async()=>{const o=e;console[o(304)](o(253)),await Editor[o(240)][o(212)]("extension",o(300),a).then(()=>{const e=o;fse[e(238)](r),fse.remove(c),console[e(304)]("[Im-plugin] Remove callback folder.")})})}},methods={showPanel(){const e=_0x468768;console.log(e(292)+getVersion()),panelWin?(panelWin[e(313)](),isVersionMore331()&&Editor[e(240)][e(219)](e(289)),panelWin=null):Editor[e(243)][e(312)](namespace_1.ns),controller[e(235)]()},silentCheckAndUpdate:silentCheckAndUpdate,silentCheck:silentCheck,unZipAndInstall:unZipAndInstall,closePanel(){const e=_0x468768;Editor[e(243)][e(189)](namespace_1.ns),panelWin=null,controller[e(317)]()},whetherClose:()=>windows[_0x468768(202)],getSignInUrl:async()=>(await service_1[_0x468768(199)].getInstance()).getSignInUrl(),getRedirectUrl:async e=>(await service_1[_0x468768(199)][_0x468768(272)]())[_0x468768(290)](e),updateToolbarMain(e,o){update_toolbar_1[_0x468768(321)](e,o)},saveToolbarInfo(e){savedInfo=e},getSavedToolbarInfo:()=>savedInfo};function hidePanel(e){const o=_0x468768;(panelWin=electron_1[o(263)][o(285)](e[o(291)]))?(panelWin[o(271)](),controller[o(244)]()):console.error("cannot hide panel, panelWin is undefined")}function getVersion_(e){e[_0x468768(197)]=getVersion()}function getVersion(){const e=_0x468768;return Editor[e(227)][e(252)]({name:namespace_1.ns,enable:!0})[0][e(265)]}exports[_0x468768(213)]=methods;