const _0x4e1d=["district","then","getData","end","Profile","_waitClosedMain","Package","fromWebContents","updateToolbar","name","im-plugin.zip","plugin","fs-extra","-error","[Im-plugin] Remove your old im-plugin to ","[Im-plugin] Remove callback folder.","warn","[Im-plugin] Update ","push","__importStar","https://im.cocos.com/welcome/query","reload","[Im-plugin] Go back ok.","close","Message","queryIPList","dashboard","getInstance","./main-lib/http-utils","remove","./constant/namespace","./node_modules","secretary","unload","load","home",":hide-panel","postData","im-plugin","error","arch","sumErrorTime","path","[Im-plugin] Im-plugin online version is ","call","getDate","[Im-plugin] The number of errors reached online on the day, 5 times.","App","request-progress","[Im-plugin] The editor does not support automatic updates of versions below 3.3.1.If im-plugin has new version, you need to download it manually from the store.","create","tmpdir","log","./main-lib/controller","data","open","./main-lib/service","progreass","getTimezoneOffset","Update","catch","Start","prototype","extensions","onShowPanel","paths","User","[Im-plugin] Im-plugin need not update.","country","im-plugin.IgnoreImVersion","methods","getFullYear","getConfig","lastErrorTime","getPackages","type","POST","./common-lib/update-toolbar","getRedirectUrl","cannot hide panel, panelWin is undefined","I18n","message","__createBinding","copy","__esModule","ipcMain","ensureDir","firstErrorTime","defineProperty","dirname","[Im-plugin] You need to update in panel due to you opening it.","hide","setConfig","join","http://k.cocosgame.net:58511","download-url","default","getImSetting","[Im-plugin] Remove Succeed.","email","[Im-plugin] Go back to old version.","[Im-plugin] Im-plugin online version is error, ","global","realpath","pipe","getMonth","assign","getLanguage","__importDefault","Network","[Im-plugin] Im-plugin local version is ","removeListener","replace","env","extension-callback","broadcast","Panel","plugin_version","[Im-plugin] Unzip installation failed .","extension","split","getTime","province","version","plugin_url","getSignInUrl","init","success","request","[Im-plugin] Check im-plugin version.","onHidePanel","enable","createWriteStream","nickname","[Im-plugin] Download im-plugin zip."];!function(e,o){!function(o){for(;--o;)e.push(e.shift())}(++o)}(_0x4e1d,268);const _0x1ec3=function(e,o){return _0x4e1d[e-=311]},_0x456a02=_0x1ec3;var __createBinding=this&&this[_0x456a02(395)]||(Object[_0x456a02(363)]?function(e,o,n,t){void 0===t&&(t=n),Object[_0x456a02(401)](e,t,{enumerable:!0,get:function(){return o[n]}})}:function(e,o,n,t){void 0===t&&(t=n),e[t]=o[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object[_0x456a02(363)]?function(e,o){Object[_0x456a02(401)](e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this[_0x456a02(332)]||function(e){const o=_0x456a02;if(e&&e[o(397)])return e;var n={};if(null!=e)for(var t in e)o(409)!==t&&Object[o(375)].hasOwnProperty[o(357)](e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n},__importDefault=this&&this[_0x456a02(421)]||function(e){return e&&e[_0x456a02(397)]?e:{default:e}};Object[_0x456a02(401)](exports,_0x456a02(397),{value:!0}),exports[_0x456a02(346)]=exports[_0x456a02(347)]=exports[_0x456a02(383)]=void 0;const os_1=__importDefault(require("os")),path_1=__importStar(require(_0x456a02(355))),compare_versions_1=__importDefault(require("compare-versions")),electron_1=require("electron"),service_1=__importDefault(require(_0x456a02(369))),namespace_1=require(_0x456a02(343)),update_toolbar_1=require(_0x456a02(390)),controller_1=__importDefault(require(_0x456a02(366))),fs_1=require("fs"),http_utils_1=require(_0x456a02(341)),requestProgress=require(_0x456a02(361)),request=require(_0x456a02(441));module[_0x456a02(378)][_0x456a02(331)](path_1.default[_0x456a02(406)](Editor[_0x456a02(360)][_0x456a02(355)],_0x456a02(344)));const windows=require("@base/electron-windows"),fse=require(_0x456a02(325)),publicIpApi=require("public-ip"),controller=controller_1[_0x456a02(409)][_0x456a02(340)]();let panelWin=null;const reportOptions={url:_0x456a02(407),method:_0x456a02(389),json:!0};function _ip2int(e){let o=0;return e=e[_0x456a02(433)]("."),o=256*Number(e[0])*256*256+256*Number(e[1])*256+256*Number(e[2])+Number(e[3]),o>>>=0}async function commonFields(){const e=_0x456a02;var o,n,t,i;let r="",a="",s="",l="",c="",u="";try{if(r=await publicIpApi.v4()){const p=await http_utils_1[e(350)](e(333),{ip:r});e(440)==(null==p?void 0:p.code)&&(a=null===(o=null==p?void 0:p[e(367)])||void 0===o?void 0:o.city,s=null===(n=null==p?void 0:p[e(367)])||void 0===n?void 0:n[e(381)],l=null===(t=null==p?void 0:p.data)||void 0===t?void 0:t[e(435)],u=null===(i=null==p?void 0:p[e(367)])||void 0===i?void 0:i[e(313)],c=s+"-"+l+"-"+a)}}catch(e){r=""}const p=process[e(426)],d=(new Date).toUTCString(),m=p[e(339)],_=await Editor[e(360)][e(436)],g=await Editor[e(393)][e(420)](),f=await Editor[e(379)][e(315)]();return{appType:e(345),time:d,dashBoardVersion:m,creatorVersion:_,city:a,country:s,district:u,province:l,address:c,locate:g,userData:f,nickName:f[e(311)],email:f[e(412)],cocos_uid:f.cocos_uid,ips:await Editor[e(422)][e(338)](),osType:os_1[e(409)][e(388)](),osPlatform:os_1[e(409)].platform(),osHostname:os_1.default.hostname(),osTmpdir:os_1.default[e(364)](),publicIp:r,osArch:os_1[e(409)][e(353)](),currentPjName:Editor.Project[e(322)]}}async function reportInformation(){const e=_0x456a02,o=(new Date)[e(371)]()/60,n=getVersion(),{time:t,dashBoardVersion:i,creatorVersion:r,locate:a,userData:s,city:l,country:c,district:u,province:p,address:d,nickName:m,email:_,cocos_uid:g,ips:f,osType:h,osPlatform:w,osHostname:x,osTmpdir:v,appType:I,osArch:y,publicIp:b,currentPjName:E}=await commonFields(),V={timeZone:o,time:t,dashBoardVersion:i,creatorVersion:r,pluginVersion:n,district:u,locate:a,userData:s,nickName:m,email:_,cocos_uid:g,ips:f,osType:h,osPlatform:w,osHostname:x,osTmpdir:v,appType:I,osArch:y,publicIp:b,city:l,country:c,province:p,address:d,currentPjName:E,entryType:e(324),reportType:e(374)};request(Object[e(419)]({},reportOptions,{body:V}),()=>{})}async function updateReportInformation(e,o,n,t){const i=_0x456a02,{time:r,dashBoardVersion:a,creatorVersion:s,locate:l,userData:c,nickName:u,city:p,country:d,province:m,address:_,email:g,appType:f,cocos_uid:h,ips:w,district:x,osType:v,osPlatform:I,osHostname:y,publicIp:b,osTmpdir:E,osArch:V,currentPjName:P}=await commonFields(),T={time:r,preVersion:e,newVersion:o,updateStatus:n,dashBoardVersion:a,creatorVersion:s,publicIp:b,district:x,locate:l,city:p,country:d,province:m,address:_,userData:c,nickName:u,email:g,cocos_uid:h,appType:f,ips:w,osType:v,osPlatform:I,osHostname:y,osTmpdir:E,osArch:V,currentPjName:P,reportType:i(372)};t&&Object[i(419)](T,{errorName:t.name,errorMessage:t[i(394)]}),request(Object.assign({},reportOptions,{body:T}),()=>{})}function load(){const e=_0x456a02;electron_1.ipcMain.on(namespace_1.ns+e(349),hidePanel),electron_1.ipcMain.on(namespace_1.ns+":get-version",getVersion_),controller[e(439)](),isVersionMore331()&&silentCheckAndUpdate(),setTimeout(()=>{reportInformation()},1e3)}function unload(){const e=_0x456a02;electron_1[e(398)][e(424)](namespace_1.ns+e(349),hidePanel),electron_1[e(398)].removeListener(namespace_1.ns+":get-version",getVersion_),controller.uninit()}exports[_0x456a02(347)]=load,exports[_0x456a02(346)]=unload;let savedInfo=null;const downloadZip=async(e,o)=>{const n=_0x456a02;await fse[n(399)](path_1[n(402)](o)),await new Promise((t,i)=>{const r=n;requestProgress(request(e),{delay:300}).on(r(370),function(e){}).on(r(352),function(e){i(e)}).on(r(316),function(e,o){t(null)})[r(417)](fs_1[r(445)](o))})},formatVersion=e=>e[_0x456a02(425)](/\./g,"-"),isVersionMore331=()=>{const e=_0x456a02,o=Editor[e(360)][e(436)];if(!(compare_versions_1[e(409)](o,"3.3.1")<=0))return!0;console[e(329)](e(362))},silentCheck=async()=>{const e=_0x456a02;if(console[e(365)](e(442)),!isVersionMore331())return;const o=await service_1.default[e(340)](),n=await o[e(410)]();if(!n||!n.plugin_version||!n[e(437)])return void console[e(365)]("[Im-plugin] No online info of im-plugin.");const t=n[e(430)];if(!0===await Editor.Profile.getConfig(e(382),formatVersion(t),"global"))return void console[e(365)]("[Im-plugin] Im-plugin online version has something wrong, don't update.");const i=await Editor[e(317)][e(385)]("im-plugin.IgnoreImVersion",e(386),e(415));if((new Date).getTime()-i<6e5)return;const r=getCurrentErrorTime(),a=await Editor[e(317)][e(385)]("im-plugin.IgnoreImVersion",r,e(415));if(parseInt(a)<=0)return void console[e(365)](e(359));if(!compare_versions_1[e(409)].validate(t))return void console[e(365)](e(414)+t+".");console[e(365)](e(356)+t+".");const s=getVersion();if(console[e(365)](e(423)+s+"."),!(compare_versions_1[e(409)](t,s)<=0))return{imSetting:n,newVersion:t,curVersion:s};console[e(365)](e(380))},unZipAndInstall=async(e,o)=>await new Promise(async n=>{const t=_0x456a02;await Editor[t(337)][t(441)](t(432),"import-package",t(415),e,{forceImport:!0})[t(314)](async()=>{const i=t;await fse.remove(e),await Editor.Message[i(441)](i(432),i(444),o,!0),n(!0)})[t(373)](()=>{n(!1)})}),getCurrentErrorTime=()=>{const e=_0x456a02,o=new Date;return o[e(384)]()+"-"+(o[e(418)]()+1)+"-"+o[e(358)]()+e(326)},silentCheckAndUpdate=async()=>{const e=_0x456a02,o=await silentCheck();if(!o)return;const{imSetting:n,newVersion:t,curVersion:i}=o,r=path_1.join(Editor[e(360)].home,e(427),"im-plugin.callback");await fse.ensureDir(r),console[e(365)](e(327)+r);let a=path_1.join(Editor.App[e(348)],e(376),e(351)),s=await Editor.Package[e(387)]({name:"im-plugin",enable:!0});s[0]&&(a=s[0][e(355)]);const l=path_1[e(406)](Editor.App.home,e(376),e(351)),c=path_1[e(406)](Editor[e(360)][e(348)],"download",e(323));try{await fse.copy(a,r)[e(314)](async()=>{const o=e;console.log(o(411));let r=!0;if(await Editor.Profile[o(385)]("im-plugin.IgnoreImVersion","download-url",o(415))===n[o(437)])try{await fse[o(416)](c),console[o(365)]("[Im-plugin] Im-plugin zip exists."),r=!1}catch(e){r=!0}if(await Editor.Profile.setConfig(o(382),o(408),n[o(437)],"global"),r&&(console.log(o(312)),await downloadZip(n[o(437)],c)),await Editor[o(429)].has(o(409)))console[o(365)](o(403));else{if(!await unZipAndInstall(c,l))throw new Error(o(431));updateReportInformation(i,t,!0,null)}})}catch(o){updateReportInformation(i,t,!1,o),console[e(352)](e(330)+t+" failed.");const n=await Editor[e(317)][e(385)](e(382),e(400),e(415));await Editor[e(317)][e(405)](e(382),e(386),(new Date)[e(434)](),e(415)),n||await Editor[e(317)].setConfig(e(382),e(400),(new Date)[e(434)](),e(415));const s=getCurrentErrorTime(),l=await Editor.Profile.getConfig(e(382),s,e(415));l?await Editor[e(317)].setConfig(e(382),s,l-1,e(415)):await Editor[e(317)][e(405)](e(382),s,4,e(415));const u=await Editor[e(317)][e(385)](e(382),e(354),e(415));u?await Editor[e(317)][e(405)](e(382),e(354),u+1,e(415)):await Editor[e(317)].setConfig(e(382),e(354),1,e(415));const p=(new Date)[e(434)]()-n>=2592e6;(u>=15||p)&&await Editor[e(317)][e(405)](e(382),formatVersion(t),!0,e(415)),console[e(365)](e(413)+i),await fse[e(396)](r,a)[e(314)](async()=>{const o=e;console[o(365)](o(335)),await Editor[o(337)][o(441)]("extension",o(334),a)[o(314)](()=>{const e=o;fse[e(342)](r),fse[e(342)](c),console[e(365)](e(328))})})}},methods={showPanel(){const e=_0x456a02;console[e(365)]("[im-plugin] Current version is "+getVersion()),panelWin?(panelWin.show(),isVersionMore331()&&Editor[e(337)][e(428)]("im-plugin:check"),panelWin=null):Editor[e(429)][e(368)](namespace_1.ns),controller[e(377)]()},silentCheckAndUpdate:silentCheckAndUpdate,silentCheck:silentCheck,unZipAndInstall:unZipAndInstall,closePanel(){const e=_0x456a02;Editor[e(429)][e(336)](namespace_1.ns),panelWin=null,controller.onClosePanel()},whetherClose:()=>windows[_0x456a02(318)],getSignInUrl:async()=>(await service_1[_0x456a02(409)][_0x456a02(340)]())[_0x456a02(438)](),getRedirectUrl:async e=>(await service_1[_0x456a02(409)][_0x456a02(340)]())[_0x456a02(391)](e),updateToolbarMain(e,o){update_toolbar_1[_0x456a02(321)](e,o)},saveToolbarInfo(e){savedInfo=e},getSavedToolbarInfo:()=>savedInfo};function hidePanel(e){const o=_0x456a02;(panelWin=electron_1.BrowserWindow[o(320)](e.sender))?(panelWin[o(404)](),controller[o(443)]()):console[o(352)](o(392))}function getVersion_(e){e.returnValue=getVersion()}function getVersion(){const e=_0x456a02;return Editor[e(319)][e(387)]({name:namespace_1.ns,enable:!0})[0][e(436)]}exports[_0x456a02(383)]=methods;