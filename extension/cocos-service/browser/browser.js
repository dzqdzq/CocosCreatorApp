"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const electron_1=require("electron"),utils_1=require("../utils"),plugin_1=__importDefault(require("./plugin")),protocol_1=__importDefault(require("./protocol")),_inner_1=require("../utils/_inner");let popupWindows=new Map,firstRun=!0;async function load(){Editor.User.on("login",exports.methods.userChanged),Editor.User.on("logout",exports.methods.userChanged),electron_1.ipcMain.on("cocos-service:popup-show",exports.methods.popupShow),await plugin_1.default.registerPluginsI18n()}function unload(){Editor.User.removeListener("login",exports.methods.userChanged),Editor.User.removeListener("logout",exports.methods.userChanged),electron_1.ipcMain.removeListener("cocos-service:popup-show",exports.methods.popupShow)}exports.methods={async openServicePanel(e){await Editor.Panel.has("cocos-service")?(await Editor.Panel.focus("cocos-service"),utils_1.csEditor.sendMsg(utils_1.csEditor.plugin,"plugin-msg","service","service:handle-penetrate-param",e)):await Editor.Panel.open("cocos-service",e)},openPopup(e,i,s){try{if(!popupWindows.has(e))return void Editor.Panel.open("cocos-service.simple",e,i);{let i=popupWindows.get(e);null===i||void 0===i||i.focus()}}catch(i){popupWindows.delete(e)}},closePopup(e){try{if(popupWindows.has(e)){let i=popupWindows.get(e);null===i||void 0===i||i.close(),popupWindows.delete(e)}}catch(i){popupWindows.delete(e)}},printLog(e,i){"error"===e&&console.error(i),"info"===e&&console.info(i),"log"===e&&console.log(i),"warn"===e&&console.warn(i)},popupShow(e,i){let s=electron_1.BrowserWindow.fromWebContents(e.sender),t=i.pluginName;null!==s&&t&&popupWindows.set(t,s)},async userChanged(){await Editor.Panel.has("cocos-service")&&Editor.Message.send("cocos-service","plugin-msg","service","service:userChanged")},apiRequest:async(e,i={})=>"redirect_url"===e?await protocol_1.default.getRedirectUrl(i.redirect_url):new Promise((s,t)=>protocol_1.default.apiPost(e,i).then(s).catch(e=>t(new Error(JSON.stringify(e))))),async enableService(e,i,s=""){e.startsWith("service-")||(e=`service-${e}`);let t=(await utils_1.csConfig.readServiceList()).find(i=>i.service_component_name===e);if(void 0===t)throw new Error(utils_1.csEditor.tr("service_name_error"));let o=(await utils_1.csConfig.readBindGame()||{app_id:"UNKNOW"}).app_id;if("UNKNOW"===o)try{let e=await _inner_1.silenceCreateGame();o=e.app_id,await utils_1.csConfig.writeBindGame(e);let i=await utils_1.csConfig.readConfigSet();i&&(s=i.config_id)}catch(e){return e.message}try{let e=await utils_1.csProtocol.getGameDetail(o);i&&"0"!==t.service_type&&!e.service.includes(t.service_id)&&await utils_1.csProtocol.openService(o,t.service_id),await utils_1.csConfig.wirteEnableService(t.service_id,i,s).catch(utils_1.csLogger.debug),utils_1.csLogger.info(utils_1.csEditor.tr(i?"silence_open_service":"silence_disable_service").replace("${name}",t.service_name))}catch(e){return e.message}return plugin_1.default.pluginExists(e)?"success":(await plugin_1.default.installPlugin(e,t.package_download_url,(e,i)=>{i&&utils_1.csEditor.tr("installed")}),"success")},pluginMsg:async(e,i,s={})=>"service"===e&&await Editor.Panel.has("cocos-service")?await utils_1.csEditor.requestMsg(utils_1.csEditor.plugin,"plugin-msg-service",i,s):"popup"===e&&popupWindows.size>0?await utils_1.csEditor.requestMsg(utils_1.csEditor.plugin,"plugin-msg-popup",i,s):"target not exist!",serviceReady(){firstRun&&(firstRun=!1,setTimeout(async()=>{let e=await utils_1.csProtocol.getCustomPlugin();if(1===utils_1.csUtil.compareVersion(e.dependency,utils_1.csEditor.getCreatorVersion()))return;if(1!==utils_1.csUtil.compareVersion(e.version,utils_1.csEditor.getServiceVersion()))return;if(0!==await utils_1.csEditor.dialogMsgBox("info",utils_1.csEditor.tr("browser.update_tips"),utils_1.csEditor.tr("dialog_title"),[utils_1.csEditor.tr("browser.update_now"),utils_1.csEditor.tr("browser.cancel")],0))return;let i=await utils_1.csHttp.get(e.download_url,{});utils_1.csLogger.info(utils_1.csEditor.tr("browser.updating_tips")),utils_1.csEditor.sendMsg("extension","update-extension",i.download_url,utils_1.csEditor.plugin,"global"),Editor.Panel.close(utils_1.csEditor.plugin)},5e3))},async i18nChange(){utils_1.csEditor.broadcastMsg("cocos-service:service-data-change"),await Editor.Panel.has("cocos-service")&&Editor.Message.send("cocos-service","plugin-msg","service","service:i18nChange")},async onServiceStatusChanged(e){var i;try{let s=utils_1.csPlugin.getServicePluginInfo(e.service_component_name);if(void 0===s||!(null===(i=s.builder)||void 0===i?void 0:i.main))return;let t={};t.service_id=e.service_id,t.service_component_name=e.service_component_name,t.enable=e.enable||!1,t.params=await utils_1.csConfig.readServiceParam(e.service_id);let o=utils_1.csUtil.require(s.path,s.builder.main);o.onServiceStatusChanged&&await o.onServiceStatusChanged(utils_1.csEditor.getProjectPath(),t)}catch(e){utils_1.csLogger.debug(e)}}},exports.load=load,exports.unload=unload;