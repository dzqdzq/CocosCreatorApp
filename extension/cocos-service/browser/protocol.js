"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editor_1=__importDefault(require("../utils/editor")),http_1=__importDefault(require("../utils/http")),domain="https://creator-api.cocos.com/api/",not_require_token_urls=["session/code","session/token","service/lists"];exports.default={is_refresh_token:!1,session_token:"",parseParamter:function(e){let t=JSON.parse(JSON.stringify(e));t.plugin_id="1028",t.ip="127.0.0.1",t.lang=editor_1.default.getLang(),t.cs_version=editor_1.default.getServiceVersion(),t.cc_version=editor_1.default.getCreatorVersion(),t.cs_require="3x",t=http_1.default.objectSortByKey(t);let s=http_1.default.paramEncode(t)+"&0c234adac31fdec28ac45df0b1c42d532b06321c";return t.sign=require("md5")(s.substr(1)),t},apiPost:async function(e,t={}){return void 0===not_require_token_urls.find(t=>t===e)&&(""===this.session_token&&await this.getSessionToken(),t.session_token=this.session_token),new Promise((s,i)=>{http_1.default.post(domain+e,this.parseParamter(t)).then(async t=>{0===t.status?s(t.data):406===t.status?(this.is_refresh_token=!0,await this.getSessionToken()):(t.status,i({status:t.status,msg:t.msg,path:e}))}).catch(i)})},getSessionToken:async function(){let e=await editor_1.default.getUserData(),t=await this.apiPost("session/code",{session_id:e.session_id}),s=await this.apiPost("session/token",{session_code:t.session_code});this.session_token=s.session_token},getRedirectUrl:async function(e){let t=await editor_1.default.getUserData();return`${domain}account/client_signin?session_id=${t.session_id}&redirect_url=${encodeURIComponent(e)}`}};