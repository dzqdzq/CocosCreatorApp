"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const plugin_1=__importDefault(require("./plugin")),utils_1=require("../../utils"),_inner_1=require("../../utils/_inner");exports.default={userInfo:{},games:[],services:[],urls:{},inited:!1,isLogin:!1,unfoldGroups:new Set,devMode:!1,init:async function(e=!1){utils_1.csLogger.debug(`Cocos Service ${utils_1.csEditor.getServiceVersion()} base on Cocos Creator ${utils_1.csEditor.getCreatorVersion()}`),this.inited&&!e||(this.isLogin=await utils_1.csEditor.isLogin(),this.isLogin?(this.userInfo=await this.getUserInfo(!0),this.urls=await utils_1.csProtocol.getServiceUrls()):this.userInfo={corporation_id:"0"},this.services=await this.getServices(!0),this.devMode=await utils_1.csConfig.readDevMode(),plugin_1.default.scanfServicePluginInfos(),plugin_1.default.scanfServicePlugins(),await plugin_1.default.loadAllServicePlugins(),this.inited=!0)},getUserInfo:async function(e=!1){return new Promise(async(i,s)=>{if(e||"{}"===JSON.stringify(this.userInfo)){this.userInfo=await utils_1.csProtocol.getUserInfo();let e=utils_1.csEditor.getUserData();for(var t in e)this.userInfo[t]=e[t]}i(this.userInfo)})},getGames:async function(e=!1){return new Promise(async(i,s)=>{(e||0===this.games.length)&&(this.games=await utils_1.csProtocol.getGameList()),i(this.games)})},getServices:async function(e=!1){return new Promise(async(i,s)=>{(e||0===this.services.length)&&(this.services=await utils_1.csProtocol.getServiceList().catch(async e=>i(await utils_1.csConfig.readServiceList())),this.services=this.services.map(e=>Object.assign(e,{service_price:_inner_1.replaceTagAtoUILink(e.service_price),service_protocol:_inner_1.replaceTagAtoUILink(e.service_protocol),service_desc:_inner_1.replaceTagAtoUILink(e.service_desc)})),await utils_1.csConfig.writeServiceList(this.services)),i(this.services)})},async getUrl(e,i={}){return"{}"===JSON.stringify(this.urls)?"":this.urls[e]+("{}"!==JSON.stringify(i)?`?${utils_1.csHttp.paramEncode(i).substring(1)}`:"")}};