"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=__importStar(require("../../utils"));exports.default={pluginInfoMap:new Map,pluginMap:new Map,isInstall:!1,isUpdate:!1,scanfServicePluginInfos:function(){let e=utils_1.csEditor.getServiceHomePath();if(!fs_extra_1.existsSync(e))return;this.pluginInfoMap.clear(),fs_extra_1.readdirSync(e).forEach(e=>{this.insertServicePluginInfo(e)});let t=path_1.join(__dirname,"../../builtin");fs_extra_1.readdirSync(t).forEach(e=>{this.insertServicePluginInfo(e)})},insertServicePluginInfo:function(e){let t=utils_1.csPlugin.getServicePluginInfo(e);void 0!==t&&this.pluginInfoMap.set(t.name,t)},getServicePluginInfo:function(e){return!this.pluginInfoMap.has(e)&&utils_1.csPlugin.pluginExists(e)&&this.insertServicePluginInfo(e),this.pluginInfoMap.get(e)},scanfServicePlugins:function(){this.pluginMap.clear();for(let e of this.pluginInfoMap.values())this.insertServicePlugin(e)},insertServicePlugin:function(e){void 0!==e&&void 0!==e.contents&&null!==typeof e.contents&&(e.contents.detail&&this.pluginMap.set(`${e.name}:detail`,utils_1.csUtil.require(e.path,e.contents.detail.main)),e.contents.item&&this.pluginMap.set(`${e.name}:item`,utils_1.csUtil.require(e.path,e.contents.item.main)))},getServicePlugin:function(e,t){return this.pluginInfoMap.has(e)||this.pluginMap.has(`${e}:${t}`)||this.reloadPlugin(e),this.pluginMap.get(`${e}:${t}`)},loadAllServicePlugins:async function(){for(let e of this.pluginInfoMap.keys())await this.loadServicePlugin(e)},loadServicePlugin:async function(e){this.registerI18n(e);for(let[t,i]of this.pluginMap)e===t.split(":")[0]&&(await this._loadServicePlugin(t,i),this.pluginMap.set(t,i))},_loadServicePlugin:async function(e,t){if(t.load&&await t.load(utils_1.default),t.methods)for(let i in t.methods)utils_1.csEvent.on(`plugin:${e}:${i}`,t.methods[i].bind(t))},createInnterHTML:function(e,t,i,n){t.innerHTML=e.template;let l=document.createElement("style");if(l.setAttribute("type","text/css"),l.textContent=utils_1.csFile.readFile(__dirname,"../assets/creator.css")+utils_1.csFile.readFile(__dirname,"../assets/panel.css"),t.insertBefore(l,t.firstChild),e.style){let i=document.createElement("style");i.setAttribute("type","text/css"),i.textContent=e.style,t.insertBefore(i,l.nextSibling)}if(e.$){let i=JSON.parse(JSON.stringify(e.$));for(let n of Object.keys(i)){if("string"!=typeof e.$[n])return;e.$[n]=t.querySelector(i[n])}}this.pluginMap.set(`${i}:${n}`,e)},unloadAllServicePlugins:async function(){for(let e of this.pluginInfoMap.keys())await this.unloadServicePlugin(e)},unloadServicePlugin:async function(e){for(let[t,i]of this.pluginMap)e===t.split(":")[0]&&await this._unloadServicePlugin(t,i);this.pluginInfoMap.has(e)&&this.pluginInfoMap.delete(e)},_unloadServicePlugin:async function(e,t){if(t.unload&&await t.unload(),t.methods)for(let i in t.methods)utils_1.csEvent.removeAllListeners(`plugin:${e}:${i}`);this.pluginMap.delete(e)},registerI18n:function(e){utils_1.csPlugin.registerI18n(e)},pluginExists:function(e){return this.pluginInfoMap.has(e)},uninstallPlugin:async function(e){await this.unloadServicePlugin(e),this.pluginInfoMap.delete(e),utils_1.csFile.remove(path_1.join(utils_1.csEditor.getServiceHomePath(),e.replace("service-","")))},installPlugin:function(e,t,i){return utils_1.csPlugin.installPlugin(e,t,i)},reloadPlugin:async function(e){await this.unloadServicePlugin(e);let t=path_1.join(utils_1.csEditor.getServiceHomePath(),e.replace("service-",""));utils_1.csUtil.deleteCache(t),this.insertServicePluginInfo(t);let i=this.getServicePluginInfo(e);void 0!==i&&(this.insertServicePlugin(i),await this.loadServicePlugin(e))},getPluginVerByURL:function(e){if(""!==e){let t=e.split("/");return t[t.length-1].replace(".zip","")}return""},getPluginUrlByVer:async function(e,t){return(await utils_1.csProtocol.getVersionDesc(e,t)).package_download_url}};