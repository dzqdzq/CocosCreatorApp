"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,s){void 0===s&&(s=t),Object.defineProperty(e,s,{enumerable:!0,get:function(){return i[t]}})}:function(e,i,t,s){void 0===s&&(s=t),e[s]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.listeners=exports.methods=exports.closePanel=exports.beforeClosePanel=exports.createVue=void 0;const vue_1=__importDefault(require("../../vue")),fs_extra_1=require("fs-extra"),mixin_1=__importDefault(require("./mixin")),core_1=__importDefault(require("../core")),plugin_1=__importDefault(require("../core/plugin")),utils_1=__importStar(require("../../utils")),UNKNOW_APP_ID="UNKNOW";async function createVue(e,i){return await utils_1.csConfig.updateConfigFile(),await core_1.default.init(!0),vue_1.default.mixin(mixin_1.default),new vue_1.default({el:e.$.cocos_service,data:{message:"Hello Cocos Service!",refresh:!0,loading:!1,popupInfo:{show:!1,mh:void 0,mw:void 0,closed:void 0,html:"",src:"",data:{}},confirmInfo:{show:!1,title:"",msg:"msg",btns:["OK","Cancel"],high:0,callback:e=>{}},menuInfo:{show:!1,position:{top:0,right:0},items:[],callback:e=>{}},vermInfo:{show:!1,action:"change"},configSetInfo:{show:!1,action:"add"},filterInfo:{show:!1,filter:{}},game:{name:utils_1.csEditor.tr("unknow_name"),app_id:"UNKNOW",c_id:"0"},user:{},service:{},config:{},configs:[],services:[],isBindGame:!1,isCompanyGame:!1,isCompanyUser:!1,isLogin:!1,isShowServiceList:!1,isShowServiceDetail:!1,isShowBindGame:!1,bindSouuce:"list",monitor:{}},watch:{async game(){await utils_1.csConfig.writeBindGame(this.game),await this.readConfigSet(),await this.readEnableService(),await utils_1.csEditor.isLogin(),this.refreshPanel(),utils_1.csEditor.broadcastMsg("cocos-service:service-data-change")}},async created(){let e=await utils_1.csConfig.readBindGame();e&&e.app_id!==UNKNOW_APP_ID&&await this.checkGameOwner(e)?(this.game=e,this.isBindGame=!0,this.isCompanyGame="0"!==e.c_id):(this.game={name:utils_1.csEditor.tr("unknow_game"),app_id:UNKNOW_APP_ID,c_id:"0"},this.isBindGame=!1,this.isCompanyGame=!1),this.services=await core_1.default.getServices(),this.filterInfo.filter=await utils_1.csConfig.readServiceFilter(),this.user=await core_1.default.getUserInfo(),this.isCompanyUser=0!==this.user.corporation_id,this.isLogin=await utils_1.csEditor.isLogin(),this.readEnableService();let t=utils_1.csEditor.getServiceHomePath();fs_extra_1.existsSync(t)||utils_1.csFile.mkdirs(t),this.addServiceListners(),this.addVueListeners(),utils_1.csFile.watch(t,e=>{this.monitor=e,e.on("removed",e=>{if(plugin_1.default.isUpdate)return;let i=e.substr(t.length+1);if(i.indexOf("/")>-1)return;let s=this.getServiceByServiceName(i);void 0!==s&&(this._enableService(s.service_id,!1),this.jumpServiceList())})}),this.jumpServiceList(),this.hideServiceLoading(),await utils_1.csAnalytics.openServicePanel(this.user.cocos_uid,this.game,void 0),void 0!==i&&this.handlePenetrateParam(i)},mounted(){},methods:{hideServiceLoading(){e.$.loader_wrapper.hidden=!0},showLoading(e){this.message=e,this.loading=!0,this.$nextTick(()=>this.loading=!0)},hideLoading(){this.loading=!1,this.$nextTick(()=>this.loading=!1)},showMenu(e,i,t){this.menuInfo.position=e,this.menuInfo.items=i,this.menuInfo.callback=t,this.menuInfo.show=!0},hideMenu(){this.menuInfo.show=!1},showConfirm(e,i,t,s,n){this.confirmInfo.title=e,this.confirmInfo.msg=i,this.confirmInfo.btns=t,this.confirmInfo.high=s,this.confirmInfo.callback=n,this.confirmInfo.show=!0},hideConfirm(){this.confirmInfo.show=!1},showBindGame(e="list"){this.isShowBindGame=!0,this.bindSouuce=e,utils_1.csAnalytics.enterBindCocosAppID()},hideBindGame(){this.isShowBindGame=!1},showPopup(e,i){0!==e.length&&(this.popupInfo.html=e,this.popupInfo.mh=null===i||void 0===i?void 0:i.mh,this.popupInfo.mw=null===i||void 0===i?void 0:i.mw,this.popupInfo.closed=null===i||void 0===i?void 0:i.closed,this.popupInfo.show=!0,(null===i||void 0===i?void 0:i.duration)&&setTimeout(()=>this.popupInfo.show=!1,i.duration))},hidePopup(){this.popupInfo.show=!1},showPopupPanel(e,i,t){0!==e.length&&(this.popupInfo.src=e,this.popupInfo.data=i,this.popupInfo.mh=null===t||void 0===t?void 0:t.mh,this.popupInfo.mw=null===t||void 0===t?void 0:t.mw,this.popupInfo.show=!0,(null===t||void 0===t?void 0:t.duration)&&setTimeout(()=>this.popupInfo.show=!1,t.duration))},hidePopupPanel(){this.popupInfo.show=!1},showVerm(e="switch"){this.service.service_id&&this.isShowServiceDetail&&(this.vermInfo.action=e,this.vermInfo.show=!0)},hideVerm(){this.vermInfo.show=!1},showConfigSet(e="add"){this.configSetInfo.action=e,this.configSetInfo.show=!0},hideConfigSet(){this.configSetInfo.show=!1},showServiceFilter(){this.filterInfo.show=!0},hideServiceFilter(){this.filterInfo.show=!1},refreshPanel(){this.refresh=!1,this.$nextTick(()=>this.refresh=!0)},async readConfigSet(){this.configs=await utils_1.csConfig.readConfigSets();let e=await utils_1.csConfig.readConfigSet();void 0===e&&(0===this.configs.length?(e=utils_1.csConfig.generateConfigSet("Default"),this.configs.push(e)):e=this.configs[0],await utils_1.csConfig.writeConfigSet(e)),this.config=e},checkGameOwner:async e=>(await core_1.default.getGames()).filter(i=>i.app_id==e.app_id).length>0,async readEnableService(){try{let e=await utils_1.csConfig.readEnableServices();for(let i of this.services)vue_1.default.set(i,"enable",e.indexOf(i.service_id)>=0),vue_1.default.set(i,"hovered",!0),i.enable&&(plugin_1.default.pluginExists(i.service_component_name)||(utils_1.csLogger.warn(i.service_name+utils_1.csEditor.tr("service_not_install")),utils_1.csEvent.emit("show-loading",""),await plugin_1.default.installPlugin(i.service_component_name,i.package_download_url,(e,i)=>{utils_1.csEvent.emit("show-loading",e),i&&("failed"===e&&utils_1.csLogger.warn(utils_1.csEditor.tr("download-failed")),utils_1.csEvent.emit("hide-loading"))}),await plugin_1.default.reloadPlugin(i.service_component_name)))}catch(e){utils_1.csLogger.debug(e)}},backHome(){this.jumpServiceList()},handleItemClick(e){this.jumpServiceDetail(e)},async handleSaveConfig(e,i){"copy"===i&&await utils_1.csConfig.copyConfigSet(e).catch(utils_1.csLogger.debug),await this.handleConfirmConfig(e),utils_1.csEditor.broadcastMsg("cocos-service:service-data-change"),utils_1.csLogger.info(utils_1.csEditor.tr(`config_set.${i}_success`))},async handleConfirmConfig(e){await utils_1.csConfig.writeConfigSet(e),await this.readConfigSet(),await this.readEnableService(),this.refreshPanel()},async enableService(e,i,t=!1,s){let n=await this._enableService(e,i);t&&await utils_1.csEditor.requestMsg(utils_1.csEditor.plugin,"service-status-changed",n),utils_1.csEditor.broadcastMsg("cocos-service:service-data-change"),s&&s()},async _enableService(e,i){for(let t of this.services)if(t.service_id==e)return t.enable=i,await utils_1.csConfig.wirteEnableService(e,t.enable).catch(utils_1.csLogger.debug),t},jumpServiceList(){this.isShowServiceList=!1,this.isShowServiceDetail=!1,this.$nextTick(()=>this.isShowServiceList=!0)},async jumpServiceDetail(e){this.service=e,await plugin_1.default.reloadPlugin(this.service.service_component_name),this.isShowServiceList=!1,this.isShowServiceDetail=!1,this.$nextTick(()=>this.isShowServiceDetail=!0),utils_1.csAnalytics.init(this.user.cocos_uid,this.game,this.service),utils_1.csAnalytics.enterService()},getServiceByServiceName(e){return/^service-[a-z]+/.test(e)||(e=`service-${e}`),this.services.find(i=>i.service_component_name===e)},addVueListeners(){utils_1.csEvent.removeAllListeners("show-menu"),utils_1.csEvent.on("show-menu",this.showMenu),utils_1.csEvent.removeAllListeners("hide-menu"),utils_1.csEvent.on("hide-menu",this.hideMenu),utils_1.csEvent.removeAllListeners("show-loading"),utils_1.csEvent.on("show-loading",this.showLoading),utils_1.csEvent.removeAllListeners("hide-loading"),utils_1.csEvent.on("hide-loading",this.hideLoading),utils_1.csEvent.removeAllListeners("show-bind-game"),utils_1.csEvent.on("show-bind-game",this.showBindGame),utils_1.csEvent.removeAllListeners("hide-bind-game"),utils_1.csEvent.on("hide-bind-game",this.hideBindGame),utils_1.csEvent.removeAllListeners("show-confirm"),utils_1.csEvent.on("show-confirm",this.showConfirm),utils_1.csEvent.removeAllListeners("hide-confirm"),utils_1.csEvent.on("hide-confirm",this.hideConfirm),utils_1.csEvent.removeAllListeners("show-popup"),utils_1.csEvent.on("show-popup",this.showPopup),utils_1.csEvent.removeAllListeners("hide-popup"),utils_1.csEvent.on("hide-popup",this.hidePopup),utils_1.csEvent.removeAllListeners("show-popup-panel"),utils_1.csEvent.on("show-popup-panel",this.showPopupPanel),utils_1.csEvent.removeAllListeners("hide-popup-panel"),utils_1.csEvent.on("hide-popup-panel",this.hidePopupPanel),utils_1.csEvent.removeAllListeners("show-verm"),utils_1.csEvent.on("show-verm",this.showVerm),utils_1.csEvent.removeAllListeners("hide-verm"),utils_1.csEvent.on("hide-verm",this.hideVerm),utils_1.csEvent.removeAllListeners("show-config-set"),utils_1.csEvent.on("show-config-set",this.showConfigSet),utils_1.csEvent.removeAllListeners("hide-config-set"),utils_1.csEvent.on("hide-config-set",this.hideConfigSet),utils_1.csEvent.removeAllListeners("enter-service-detail"),utils_1.csEvent.on("enter-service-detail",this.jumpServiceDetail),utils_1.csEvent.removeAllListeners("enter-service-list"),utils_1.csEvent.on("enter-service-list",this.jumpServiceList),utils_1.csEvent.removeAllListeners("show-service-filter"),utils_1.csEvent.on("show-service-filter",this.showServiceFilter),utils_1.csEvent.removeAllListeners("hide-service-filter"),utils_1.csEvent.on("hide-service-filter",this.hideServiceFilter)},addServiceListners(){utils_1.csEvent.removeAllListeners("service-list-menu"),utils_1.csEvent.on("service-list-menu",this.handleServiceListMenu),utils_1.csEvent.removeAllListeners("service:query-service-enable"),utils_1.csEvent.on("service:query-service-enable",(e,i)=>{if(!this.isBindGame)return i&&i(null,!1);let t=this.getServiceByServiceName(e.service_name);i&&i(null,void 0!==t&&t.enable)}),utils_1.csEvent.removeAllListeners("service:i18nChange"),utils_1.csEvent.on("service:i18nChange",async(e,i)=>this.handleReloadAllData()),utils_1.csEvent.removeAllListeners("service:userChanged"),utils_1.csEvent.on("service:userChanged",async(e,i)=>this.handleReloadAllData()),utils_1.csEvent.removeAllListeners("service:refresh-panel"),utils_1.csEvent.on("service:refresh-panel",async(e,i)=>{this.game=await utils_1.csConfig.readBindGame(),this.game.app_id!=UNKNOW_APP_ID&&(this.isBindGame=!0),i&&i(null,"refresh success")}),utils_1.csEvent.removeAllListeners("service:goto-service"),utils_1.csEvent.on("service:goto-service",(e,i)=>{let t=this.getServiceByServiceName(e.service_name);if(void 0===t)return i&&i(new Error("Service name not extits!"),"");this.jumpServiceDetail(t),i&&i(null,"")}),utils_1.csEvent.removeAllListeners("service:filter-changed"),utils_1.csEvent.on("service:filter-changed",async e=>{this.filterInfo.filter=e,await utils_1.csConfig.writeServiceFilter(e),this.jumpServiceList()}),utils_1.csEvent.removeAllListeners("service:save-param"),utils_1.csEvent.on("service:save-param",(e,i,t=!0)=>{var s;let n=this.services.find(i=>e===i.service_id);n&&(i.plugin_version=(null===(s=plugin_1.default.getServicePluginInfo(n.service_component_name))||void 0===s?void 0:s.version)||""),utils_1.csConfig.writeServiceParam(e,i).catch(utils_1.csLogger.debug),t&&utils_1.csAnalytics.saveParameter(),utils_1.csEditor.broadcastMsg("cocos-service:service-data-change")}),utils_1.csEvent.removeAllListeners("service:handle-penetrate-param"),utils_1.csEvent.on("service:handle-penetrate-param",async(e,i)=>await this.handlePenetrateParam(e))},async handleReloadAllData(){utils_1.csEvent.emit("show-loading",utils_1.csEditor.tr("common.reloading_data")),await core_1.default.init(!0),this.services=await core_1.default.getServices(!0),this.service=this.getServiceByServiceName(this.service.service_component_name)||this.service,await this.readEnableService(),this.refreshPanel(),utils_1.csEvent.emit("hide-loading")},async handlePenetrateParam(e){if(e.service_name&&utils_1.csEvent.emit("service:goto-service",e),e.config_id)do{if(this.config.config_id!==e.config_id){let i=this.configs.find(i=>e.config_id===i.config_id);if(void 0===i)break;if(0!==await utils_1.csEditor.dialogMsgBox("info",utils_1.csEditor.tr("config_set.switch",{name:i.config_name}),utils_1.csEditor.tr("dialog_title"),[utils_1.csEditor.tr("btn_ok"),utils_1.csEditor.tr("btn_cancel")],0))break;this.handleConfirmConfig(i)}}while(0)},async handleServiceListMenu(e){if(void 0!==e&&null!==e&&""!==e)if("associate_app"===e||"exchange_app"===e)utils_1.csEvent.emit("show-bind-game","list");else if("edit_app"===e)utils_1.default.openCocosUrl(utils_1.csUtil.replaceAppIdOnUrl(await core_1.default.getUrl("cocos_game_detail_url"),this.game.app_id));else if("app_detail"===e)utils_1.default.openCocosUrl(utils_1.csUtil.replaceAppIdOnUrl(await core_1.default.getUrl("cocos_game_detail_url"),this.game.app_id));else if("unassociate_app"===e){let e=utils_1.csEditor.getProjectID();if(""!==e)try{await utils_1.csProtocol.associateProjectID(this.game.app_id,e,0)}catch(e){return void utils_1.csLogger.warn(utils_1.csUtil.validateString(e.msg)?`${e.msg} err_code: ${e.status}`:`${utils_1.csEditor.tr("bind_game_failed")} err_code: ${e.status}`)}this.game={app_id:UNKNOW_APP_ID,name:utils_1.csEditor.tr("unknow_game"),c_id:"0"},this.readEnableService(),utils_1.csAnalytics.unassociateAppID(),utils_1.csAnalytics.init(this.user.cocos_uid,this.game,this.service)}else if(e.startsWith("config_set_")){let i=e.substr("config_set_".length);if("delete"===i){if(0!==await utils_1.csEditor.dialogMsgBox("warn",utils_1.csEditor.tr("config_set.delete"),utils_1.csEditor.tr("dialog_title"),[utils_1.csEditor.tr("btn_ok"),utils_1.csEditor.tr("btn_cancel")],0))return;if(this.configs.length<=1)return utils_1.csLogger.warn(utils_1.csEditor.tr("config_set.cannot_delete")),void utils_1.csEditor.dialogMsgBox("warn",utils_1.csEditor.tr("config_set.cannot_delete"),utils_1.csEditor.tr("dialog_title"),[utils_1.csEditor.tr("config_set.i_know")],0);try{let e=await utils_1.csConfig.deleteConfigSet(this.config.config_id);utils_1.csLogger.info(utils_1.csEditor.tr("config_set.delete_success",{name:this.config.config_name})),this.handleConfirmConfig(e),utils_1.csEditor.broadcastMsg("cocos-service:service-data-change")}catch(e){utils_1.csLogger.debug(e)}}else utils_1.csEvent.emit("show-config-set",i,this.config)}},checkServiceWithGame(e,i){let t=async e=>{utils_1.csLogger.warn(e),0===await utils_1.csEditor.dialogMsgBox("warn",e,utils_1.csEditor.tr("dialog_title"),[utils_1.csEditor.tr("btn_ok"),utils_1.csEditor.tr("btn_cancel")],0)&&utils_1.csEvent.emit("show-bind-game","detail")};return"0"===e.c_id&&"2"===i.service_type?(t(utils_1.csEditor.tr("select_company_service")),!1):"0"===e.c_id||"1"!==i.service_type||(t(utils_1.csEditor.tr("select_person_service")),!1)},async handleBindGame(e){let i=utils_1.csEditor.getProjectID();if(""!==i)try{await utils_1.csProtocol.associateProjectID(e.app_id,i,1)}catch(e){return void utils_1.csLogger.warn(utils_1.csUtil.validateString(e.msg)?`${e.msg} err_code: ${e.status}`:`${utils_1.csEditor.tr("bind_game_failed")} err_code: ${e.status}`)}("detail"!==this.bindSouuce||this.checkServiceWithGame(e,this.service))&&(this.game=e,e.app_id!==UNKNOW_APP_ID&&(this.isBindGame=!0),utils_1.csAnalytics.init(this.user.cocos_uid,this.game,this.service),utils_1.csAnalytics.associateAppID(),this.isCompanyGame="0"!==this.game.c_id,this.readEnableService(),utils_1.csEvent.emit("hide-bind-game"))}}})}async function beforeClosePanel(){return!plugin_1.default.isInstall||(utils_1.csEditor.tr("cannot_close_panel"),!1)}async function closePanel(){await plugin_1.default.unloadAllServicePlugins(),utils_1.csEvent.removeAllListeners()}vue_1.default.config.productionTip=!1,vue_1.default.config.devtools=!1,exports.createVue=createVue,exports.beforeClosePanel=beforeClosePanel,exports.closePanel=closePanel,exports.methods={pluginMsg:async(e,i={})=>new Promise((t,s)=>{if(void 0===utils_1.csEvent.eventNames().find(i=>i===e))return s(new Error("msg not exist!"));utils_1.csEvent.emit(e,i,(e,i)=>e?s(e instanceof Error?e:new Error(JSON.stringify(e))):t(i))})},exports.listeners={async show(){let e=(await utils_1.csEditor.getUserData()).cocos_uid,i=await utils_1.csConfig.readBindGame();await utils_1.csAnalytics.openServicePanel(e,i,void 0),utils_1.csEditor.sendMsg(utils_1.csEditor.plugin,"service-ready")}};