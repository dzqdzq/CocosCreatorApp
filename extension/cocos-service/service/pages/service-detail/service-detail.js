"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,s){void 0===s&&(s=t),Object.defineProperty(e,s,{enumerable:!0,get:function(){return i[t]}})}:function(e,i,t,s){void 0===s&&(s=t),e[s]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const vue_1=__importDefault(require("../../../vue")),core_1=__importDefault(require("../../core")),plugin_1=__importDefault(require("../../core/plugin")),utils_1=__importStar(require("../../../utils"));exports.default=vue_1.default.extend({template:utils_1.csFile.readFile(__dirname,"./service-detail.html"),props:{game:{type:Object,default:()=>({app_id:"UNKNOW",name:utils_1.csEditor.tr("unknow_game"),c_id:"0"})},service:{type:Object}},data(){return{enable:!1,srv:this.service,serviceInfo:void 0,servicePlugin:void 0,service_price:this.service.service_price,param:{},serviceVersion:"",hasUpdate:!1,hasSwitch:!0,shows:{all:!0,name:!0,version:!0,description:!0,jump:!0,price:!0,platform:!0}}},watch:{async game(e){this.configDevUrl()}},async created(){this.srv.enable&&(this.enable=this.srv.enable&&plugin_1.default.pluginExists(this.srv.service_component_name)),await this.readPluginInfo();try{this.param=await utils_1.csConfig.readServiceParam(this.srv.service_id)}catch(e){utils_1.csLogger.debug(e)}this.calcShows(),this.$emit("enable-service",this.srv.service_id,this.enable),this.clacVersion(),utils_1.csEvent.removeAllListeners("service:switch-version"),utils_1.csEvent.on("service:switch-version",this.switchVersion),this.configDevUrl()},async mounted(){await this.pluginReady()},async destroyed(){await this.pluginClose()},methods:{async pluginReady(){if(await plugin_1.default.reloadPlugin(this.srv.service_component_name),this.servicePlugin=plugin_1.default.getServicePlugin(this.srv.service_component_name,"detail"),this.servicePlugin){let e=this.$refs.detail;if(e.shadowRoot||(e.attachShadow({mode:"open"}),e.shadowRoot&&plugin_1.default.createInnterHTML(this.servicePlugin,e.shadowRoot,this.srv.service_component_name,"detail")),this.servicePlugin.ready)try{await this.servicePlugin.ready({game:this.game,service:this.srv,param:await utils_1.csConfig.readServiceParam(this.srv.service_id)})}catch(e){utils_1.csLogger.debug(e)}}},async pluginClose(){var e;(null===(e=this.servicePlugin)||void 0===e?void 0:e.close)&&await this.servicePlugin.close()},async readPluginInfo(){this.serviceInfo=plugin_1.default.getServicePluginInfo(this.service.service_component_name),this.servicePlugin=plugin_1.default.getServicePlugin(this.service.service_component_name,"detail"),this.serviceVersion=this.serviceInfo?this.serviceInfo.version:utils_1.csEditor.tr("not_installed")},getRealPath:e=>`${__dirname}/../../assets/`+e,configDevUrl(){this.srv.service_dev_url=utils_1.csUtil.replaceAppIdOnUrl(this.srv.service_dev_url,this.game.app_id)},calcShows(){if(this.serviceInfo&&this.serviceInfo.contents&&this.serviceInfo.contents.detail){let e=this.serviceInfo.contents.detail.disables;this.shows.all=void 0===(null===e||void 0===e?void 0:e.find(e=>"all"===e)),this.shows.name=void 0===(null===e||void 0===e?void 0:e.find(e=>"name"===e)),this.shows.version=void 0===(null===e||void 0===e?void 0:e.find(e=>"version"===e)),this.shows.description=void 0===(null===e||void 0===e?void 0:e.find(e=>"description"===e)),this.shows.jump=void 0===(null===e||void 0===e?void 0:e.find(e=>"jump"===e)),this.shows.price=void 0===(null===e||void 0===e?void 0:e.find(e=>"price"===e)),this.shows.platform=void 0===(null===e||void 0===e?void 0:e.find(e=>"platform"===e))}},versionClick(){utils_1.csEvent.emit("show-verm","switch")},updateClick(){utils_1.csEvent.emit("show-verm","update")},async switchVersion(e,i){let t=this.enable;this.enableService(!1),plugin_1.default.isUpdate=!0,this.hasSwitch=!1,await plugin_1.default.uninstallPlugin(this.srv.service_component_name),this.hasSwitch=!0;try{await this.installPlugin(this.srv.service_component_name,e)}catch(e){return void utils_1.csEvent.emit("hide-loading")}t?setTimeout(async()=>{await this.enableService(!0),utils_1.csEvent.emit("hide-loading"),plugin_1.default.isUpdate=!1},1e3):utils_1.csEvent.emit("hide-loading")},clacVersion(){if(!this.serviceInfo)return void(this.hasUpdate=!1);let e=plugin_1.default.getPluginVerByURL(this.srv.package_download_url),i=this.serviceInfo.version;this.hasUpdate=1===utils_1.csUtil.compareVersion(e,i),this.param.plugin_version&&this.param.plugin_version!==this.serviceInfo.version&&this.enable&&utils_1.csLogger.warn(`${this.srv.service_name} - ${utils_1.csEditor.tr("service_version_warnning")}`)},async checkServiceOnGame(){if("0"===this.srv.service_type)return!0;return(await utils_1.csProtocol.getGameDetail(this.game.app_id)).service.indexOf(this.srv.service_id)>=0},async checkAllowOpenService(){if("UNKNOW"===this.game.app_id&&"0"!==this.srv.service_type)return utils_1.csEvent.emit("show-bind-game","detail"),!1;if(!this.$root.checkServiceWithGame(this.game,this.srv))return!1;if("0"!==this.srv.service_type){let e=await utils_1.csProtocol.getUserInfo(),i=1==(1&e.verification_status),t=2==(2&e.verification_status),s=4==(4&e.verification_status),r="",n="",a="",l=!0;return"0"!==this.game.c_id?1===this.srv.require_verify&&0===e.is_mobile_company?(r=await core_1.default.getUrl("cocos_mobile_bind_company_url"),n=utils_1.csEditor.tr("realname_company_tips"),a=utils_1.csEditor.tr("realname"),l=!1):2!==this.srv.require_verify||t?3!==this.srv.require_verify||s||(r=await core_1.default.getUrl("cocos_company_verify_url",{corporation_id:e.corporation_id,verifyLevel:1}),n=utils_1.csEditor.tr("high_verify_tips"),a=utils_1.csEditor.tr("certificate"),l=!1):(r=await core_1.default.getUrl("cocos_company_verify_url",{corporation_id:e.corporation_id}),n=utils_1.csEditor.tr("verify_tips"),a=utils_1.csEditor.tr("certificate"),l=!1):1===this.service.require_verify&&0===e.is_mobile?(r=await core_1.default.getUrl("cocos_mobile_bind_personal_url"),n=utils_1.csEditor.tr("realname_person_tips"),a=utils_1.csEditor.tr("realname"),l=!1):1===this.service.require_verify||i||(r=await core_1.default.getUrl("cocos_personal_verify_url"),n=utils_1.csEditor.tr("verify_person_tips"),a=utils_1.csEditor.tr("certificate"),l=!1),l?!0:(0===await utils_1.csEditor.dialogMsgBox("warn",n,utils_1.csEditor.tr("dialog_title"),[a,utils_1.csEditor.tr("btn_cancel")],0)&&utils_1.default.openCocosUrl(r),!1)}return!0},async installPlugin(e,i){return new Promise((t,s)=>{let r=utils_1.csEditor.tr("installed");plugin_1.default.isInstall=!0,plugin_1.default.installPlugin(e,i,async(i,n)=>{if(utils_1.csEvent.emit("show-loading",i),!n&&"fail"===i)return utils_1.csLogger.warn(utils_1.csEditor.tr("download_failed")),s(i);i===r&&(await plugin_1.default.reloadPlugin(e),await this.readPluginInfo(),await this.pluginReady(),this.clacVersion(),t(!0)),plugin_1.default.isInstall=!1}).catch(e=>(utils_1.csLogger.warn(utils_1.csEditor.tr("download_failed")),s(e)))})},async enableService(e){return new Promise((i,t)=>{this.$emit("enable-service",this.srv.service_id,e,!0,()=>{e?utils_1.csAnalytics.enableService():utils_1.csAnalytics.disableService(),this.enable=e,i()})})},async doOpenService(){return utils_1.csAnalytics.openService(),new Promise((e,i)=>{utils_1.csProtocol.openService(this.game.app_id,this.srv.service_id).then(i=>{e()}).catch(async e=>{var t;this.servicePlugin&&this.servicePlugin.failureOpenService&&await(null===(t=this.servicePlugin)||void 0===t?void 0:t.failureOpenService({service:this.srv,reason:e})),i(e)})})},async openServiceRequestServer(){return new Promise((e,i)=>{0!==this.srv.service_protocol.length?utils_1.csEvent.emit("show-confirm",utils_1.csEditor.tr("service_protocol"),this.srv.service_protocol,[utils_1.csEditor.tr("open_service_btn"),utils_1.csEditor.tr("btn_cancel")],0,t=>{if(0!==t)return i(new Error("Cancel Open!"));utils_1.csEvent.emit("show-loading",utils_1.csEditor.tr("opening_service")),this.doOpenService().then(e).catch(i)}):this.doOpenService().then(e).catch(i)})},async handleEnabelService(e){var i,t,s,r;if(e.target.checked=this.enable,this.enable)return utils_1.csEvent.emit("show-loading",utils_1.csEditor.tr("closing_service")),await this.enableService(!1),void utils_1.csEvent.emit("hide-loading");if(await this.checkAllowOpenService()){if(!plugin_1.default.pluginExists(this.srv.service_component_name))try{await this.installPlugin(this.srv.service_component_name,this.srv.package_download_url),utils_1.csEvent.emit("hide-loading")}catch(e){return void utils_1.csEvent.emit("hide-loading")}if(null===(i=this.servicePlugin)||void 0===i||!i.beforeOpenService||await(null===(t=this.servicePlugin)||void 0===t?void 0:t.beforeOpenService(this.srv))){if(await this.checkServiceOnGame())utils_1.csEvent.emit("show-loading",utils_1.csEditor.tr("opening_service"));else try{await this.openServiceRequestServer()}catch(e){return void utils_1.csEvent.emit("hide-loading")}await this.enableService(!0),(null===(s=this.servicePlugin)||void 0===s?void 0:s.afterOpenService)&&await(null===(r=this.servicePlugin)||void 0===r?void 0:r.afterOpenService(this.srv)),utils_1.csEvent.emit("hide-loading")}}},async handleGotoLink(e){var i,t;switch(e){case"guide":t=this.service.service_guide_url,utils_1.csAnalytics.gotoGuideUrl(t);break;case"dev":t=this.service.service_dev_url,utils_1.csAnalytics.gotoDashboardUrl(t);break;case"sample":t=this.service.service_sample_url,utils_1.csAnalytics.gotoSampleUrl(t)}this.servicePlugin&&this.servicePlugin.beforeClickGotoLink&&!await(null===(i=this.servicePlugin)||void 0===i?void 0:i.beforeClickGotoLink(t))||utils_1.default.openCocosUrl(t)},async gotoService(){let e=this.$root.$data.game.app_id,i=this.$root.$data.game.c_id||0;utils_1.default.openCocosUrl(await core_1.default.getUrl("cocos_service_open_url",{app_id:e,target:i}))}}});