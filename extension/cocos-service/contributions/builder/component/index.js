"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(i,e,s,t){void 0===t&&(t=s),Object.defineProperty(i,t,{enumerable:!0,get:function(){return e[s]}})}:function(i,e,s,t){void 0===t&&(t=s),i[t]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),__importStar=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(null!=i)for(var s in i)"default"!==s&&Object.prototype.hasOwnProperty.call(i,s)&&__createBinding(e,i,s);return __setModuleDefault(e,i),e},__importDefault=this&&this.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.$=exports.style=exports.template=void 0;const utils_1=__importStar(require("../../../utils")),common_1=require("../common"),vue_1=__importDefault(require("../../../vue")),sdkhub_helper_1=require("../sdkhub-helper");function serviceDataChange(){utils_1.csEvent.emit("service-data-change")}const isNewUpdate=-1!==utils_1.csUtil.compareVersion(utils_1.csEditor.getCreatorVersion(),"3.1.0");function ready(i,e,s){this.vm=this.vm||createVue(this,i),Editor.Message.addBroadcastListener("cocos-service:service-data-change",serviceDataChange)}function close(){Editor.Message.removeBroadcastListener("cocos-service:service-data-change",serviceDataChange),utils_1.csEvent.removeAllListeners("service-data-change")}exports.template=utils_1.csFile.readFile(__dirname,"./index.html"),exports.style=utils_1.csFile.readFile(__dirname,"./index.css"),exports.$={csBuilder:"#cocos-service-builder"},exports.ready=ready,exports.close=close;let protocolLinkMap={user_protocol:"https://download.cocos.com/CocosUdc/agreement/Cocos_User_Service_Agreement_cn_20200904.html",privacy_policy:"https://download.cocos.com/CocosUdc/agreement/Cocos_Privacy_Policy_cn_20200904.html"},platformToStoreIdMap={android:"Android",ios:"iOS","huawei-agc":"161221","alipay-mini-game":"161248","bytedance-mini-game":"161251","oppo-mini-game":"160694","huawei-quick-game":"160690","cocos-play":"161249","vivo-mini-game":"160691","xiaomi-quick-game":"160697","baidu-mini-game":"160675",wechatgame:"160564",qtt:"161252","web-desktop":"H5","web-mobile":"H5"};function createVue(i,e){return new vue_1.default({el:i.$.csBuilder,data:{refresh:!0,pkgOptions:{},configs:[],services:[],config_id:"",serviceTips:"",showAnalytics:!1,showAnalyticsProtocol:!1,enableServices:[],showSDKHub:!1,supportSDKHub:!1,showSDKHubPlugins:!1,sdkhub_config_id:"",sdkHubConfigs:[],sdkHubConfig:{},goToStyle:{"margin-left":"en"===utils_1.csEditor.getLang()?"0px":"-3px"}},created(){utils_1.csEvent.removeAllListeners("service-data-change"),utils_1.csEvent.on("service-data-change",async()=>{await this.fetchData(),this.refreshPanel()})},async mounted(){this.supportSDKHub=["android","huawei-agc"].includes(e.platform),e.packages||(e.packages={"cocos-service":{}}),this.pkgOptions=JSON.parse(JSON.stringify(e.packages["cocos-service"]||{})),"{}"===JSON.stringify(e.packages["cocos-service"]||{})&&(this.pkgOptions=await Editor.Profile.getConfig(utils_1.csEditor.plugin,"builder-options")||{}),await this.fetchData()},watch:{async config_id(i,e){i!==e&&await this.changeEnableServiceTips(i)},async sdkhub_config_id(i,e){i!==e&&(this.showSDKHubPlugins=""!==this.sdkhub_config_id,this.sdkHubConfig=this.sdkHubConfigs.find(i=>i.id===this.sdkhub_config_id)||this.sdkHubConfigs[0],await this.emitChange("sdkHubConfigID",this.sdkhub_config_id),await this.emitChange("sdkHubConfig",this.sdkHubConfig))}},methods:{tr:(i,e)=>utils_1.csEditor.tr(i,e),refreshPanel(){this.refresh=!1,this.$nextTick(()=>this.refresh=!0)},async fetchData(){this.configs=await utils_1.csConfig.readConfigSets(),this.services=await utils_1.csConfig.readServiceList(),this.sdkHubConfigs=await sdkhub_helper_1.readSDKHubConfigSet(),this.config_id=this.pkgOptions.configID,0!==this.configs.length&&(utils_1.csUtil.validateString(this.pkgOptions.configID)?this.configs.findIndex(i=>i.config_id===this.pkgOptions.configID)<0&&(this.config_id=this.configs[0].config_id):this.config_id=this.configs[0].config_id,""===this.sdkhub_config_id?this.sdkhub_config_id=this.pkgOptions.sdkHubConfigID||(this.sdkHubConfigs[0]?this.sdkHubConfigs[0].id:""):this.sdkHubConfigs.find(i=>i.id===this.sdkhub_config_id)||(this.sdkhub_config_id=this.sdkHubConfigs[0]?this.sdkHubConfigs[0].id:""),await this.changeEnableServiceTips(this.config_id))},async emitChange(e,s){i.dispatch("update",isNewUpdate?`packages.cocos-service.${e}`:e,s),this.pkgOptions[e]=s,await Editor.Profile.setConfig(utils_1.csEditor.plugin,"builder-options",this.pkgOptions)},changeAnalyticsStatus(i){let e=this.services.find(i=>"service-analytics"===i.service_component_name);void 0!==e&&(this.showAnalyticsProtocol=i.has(e.service_id)||!1,this.showAnalytics=!i.has(e.service_id))},changeSDKHubStatus(i){let e=this.services.find(i=>"service-sdkhub"===i.service_component_name);void 0!==e&&(this.showSDKHub=i.has(e.service_id),0!==this.sdkHubConfigs.length&&(this.showSDKHubPlugins=!0,this.sdkHubConfig=this.sdkHubConfigs.find(i=>i.id===this.sdkhub_config_id)||this.sdkHubConfigs[0]))},getTypeStr:i=>sdkhub_helper_1.getComplexType(i),async changeEnableServiceTips(i){try{this.config_id=i;let e=new Set(await utils_1.csConfig.readEnableServices(i));this.enableServices=this.services.filter(i=>e.has(i.service_id)),this.serviceTips="",0===this.enableServices.length?this.serviceTips=utils_1.csEditor.tr("builder.config_set.no_use_service"):this.serviceTips=utils_1.csEditor.tr("builder.config_set.used_service",{count:`${this.enableServices.length}`}),this.serviceTips+=utils_1.csEditor.tr("builder.config_set.want_edit"),await this.emitChange("configID",i),await this.emitChange("services",await common_1.generateServiceConfigInfo(this.services,e,i)),this.changeAnalyticsStatus(e),this.changeSDKHubStatus(e)}catch(i){utils_1.csLogger.debug(i)}},async handleEnableAnalytics(i){let s=i.target.checked,t=await utils_1.csEditor.requestMsg(utils_1.csEditor.plugin,"enable-service","service-analytics",s,this.config_id);if("success"===t){this.showAnalyticsProtocol=!0;do{if(!s)break;let i=this.services.find(i=>"service-analytics"===i.service_component_name);if(void 0===i)break;let t=await utils_1.csConfig.readConfigSet();if(void 0===t)break;let o=await utils_1.csConfig.readServiceParam(i.service_id,t.config_id);o||(o={}),o.app_id||(o.app_id=(await utils_1.csConfig.readBindGame()).app_id),o.store_id||(o.store_id=platformToStoreIdMap[e.platform]),await utils_1.csConfig.writeServiceParam(i.service_id,o,t.config_id)}while(0)}else setTimeout(()=>this.$refs.enableAnalytics.checked=this.showAnalyticsProtocol,10),utils_1.csLogger.warn(t);await this.fetchData(),await this.changeEnableServiceTips(this.config_id),utils_1.csEditor.sendMsg(utils_1.csEditor.plugin,"plugin-msg","service","service:refresh-panel",{config_id:this.config_id})},handleGotoService(){utils_1.csEditor.sendMsg(utils_1.csEditor.plugin,"open-service-panel",{config_id:this.config_id})},handleTplEvent(i){let e=protocolLinkMap[i.target.id];e&&""!==e&&utils_1.default.openCocosUrl(e)}}})}vue_1.default.config.productionTip=!1,vue_1.default.config.devtools=!1;