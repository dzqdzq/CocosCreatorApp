"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.onAfterBuild=exports.onAfterCompressSettings=exports.onBeforeCompressSettings=exports.onBeforeBuild=exports.throwError=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../utils"),common_1=require("./common");exports.throwError=!0;let buildCache=new Map,processServiceHooks=async(e,s,i)=>{let o=e.packages["cocos-service"],t=common_1.getPlatformID(e);if(void 0!==o&&0!==o.services.length){"onBeforeBuild"===i&&buildCache.clear();for(const r of o.services){if(!fs_extra_1.existsSync(r.builder))break;let o=(await utils_1.csConfig.readServiceList()).find(e=>e.service_id===r.service_id);buildCache.has(r.service_component_name)||buildCache.set(r.service_component_name,utils_1.csUtil.require(r.builder));let n=buildCache.get(r.service_component_name);if(void 0===n)break;try{switch(i){case"onBeforeBuild":n.onBeforeBuild&&await n.onBeforeBuild(e,s);break;case"onBeforeCompressSettings":n.onBeforeCompressSettings&&await n.onBeforeCompressSettings(e,s);break;case"onAfterCompressSettings":n.onAfterCompressSettings&&await n.onAfterCompressSettings(e,s);break;case"onAfterBuild":n.onAfterBuild&&await n.onAfterBuild(e,s),o&&processServiceIntegration(t,o,e)}}catch(s){throw o&&processServiceIntegration(t,o,e,(s instanceof Error?s.message:JSON.stringify(s))||""),s}}}};async function onBeforeBuild(e,s){await common_1.checkCocosService(e)&&(await common_1.updateConfigInfos(e),await processServiceHooks(e,s,"onBeforeBuild"))}async function onBeforeCompressSettings(e,s){await common_1.checkCocosService(e)&&await processServiceHooks(e,s,"onBeforeCompressSettings")}async function onAfterCompressSettings(e,s){await common_1.checkCocosService(e)&&(common_1.processCommonNativeModule(s),await processServiceHooks(e,s,"onAfterCompressSettings"))}async function onAfterBuild(e,s){await common_1.checkCocosService(e)&&await processServiceHooks(e,s,"onAfterBuild")}async function processServiceIntegration(e,s,i,o){let t=(await utils_1.csEditor.getUserData()).cocos_uid,r=await utils_1.csConfig.readBindGame(),n="",c=path_1.join(utils_1.csEditor.getProjectPath(),"settings/agconnect-services.json");/^service-(agc|hms|sdkhub)/.test(s.service_component_name)&&fs_extra_1.existsSync(c)&&(n=utils_1.csFile.readJson(c).client.app_id);let a="";if("service-sdkhub"===s.service_component_name){let e=i.packages["cocos-service"].sdkHubConfig;if(e&&"{}"!==JSON.stringify(e))for(let s of e.plugins)a+=`,${s.packageName}:${s.pUseType}`}void 0===o?/^service-(agc|hms)/.test(s.service_component_name)?utils_1.csAnalytics.huaweiServiceIntegrationSuccess(t,r,s,e,n,"Building Time"):"service-sdkhub"===s.service_component_name?utils_1.csAnalytics.sdkhUbServiceIntegrationSuccess(t,r,s,e,n,"Building Time",`sdkhub$$${a.substr(1)}`):utils_1.csAnalytics.serviceIntegrationSuccess(t,r,s,e,"Building Time"):/^service-(agc|hms)/.test(s.service_component_name)?utils_1.csAnalytics.huaweiServiceIntegrationFailed(t,r,s,e,n,"Building Time",o):"service-sdkhub"===s.service_component_name?utils_1.csAnalytics.sdkhUbServiceIntegrationFailed(t,r,s,e,n,"Building Time",`sdkhub$$${a.substr(1)}`,o):utils_1.csAnalytics.serviceIntegrationFailed(t,r,s,e,"Building Time",o)}exports.onBeforeBuild=onBeforeBuild,exports.onBeforeCompressSettings=onBeforeCompressSettings,exports.onAfterCompressSettings=onAfterCompressSettings,exports.onAfterBuild=onAfterBuild;