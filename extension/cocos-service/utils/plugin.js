"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),file_1=__importDefault(require("./file")),editor_1=__importDefault(require("./editor")),util_1=__importDefault(require("./util")),http_1=__importDefault(require("./http"));exports.default={pluginExists:function(e){return fs_extra_1.existsSync(path_1.join(editor_1.default.getServiceHomePath(),e.replace("service-","")))||fs_extra_1.existsSync(path_1.join("../builtin",e))},getServicePluginInfo:function(e){let t=path_1.join(editor_1.default.getServiceHomePath(),e.replace("service-",""));fs_extra_1.existsSync(t)||(t=path_1.join(__dirname,"../builtin",e));let i=path_1.join(t,"package.json");if(!fs_extra_1.existsSync(i))return;let r=file_1.default.readJson(i);if(r.name!==`service-${path_1.basename(t)}`&&r.name!==path_1.basename(t))return;let n="";if(r.upgrade&&fs_extra_1.existsSync(path_1.join(t,r.upgrade))){let e=util_1.default.require(t,r.upgrade);n="zh"===editor_1.default.getLang()?e.zh:e.en}return{path:t,name:r.name,version:r.version,author:r.author,contents:r.contents,builder:r.builder,upgrade:n}},installPlugin:function(e,t,i){let r=editor_1.default.getServiceHomePath(),n=path_1.join(editor_1.default.getCreatorHomePath(),"download");!fs_extra_1.existsSync(r)&&file_1.default.mkdirs(r),!fs_extra_1.existsSync(n)&&file_1.default.mkdirs(n);let a=path_1.join(n,`${e}.zip`),o=0;return new Promise((e,n)=>{let u=(e="fail")=>{i&&i(e,!0),n(e)};if(!t.match(/^(http|https):\/\/[^\s]*.zip$/))return u();http_1.default.download(t,a,(t,n)=>{if(t||null===n)return u();let l=`${editor_1.default.tr("downloading")} ${n.progress}%`;if(o!==n.progress&&(o=n.progress,i&&i(l,!1)),"complete"===n.status){if(100!==n.progress)return u();file_1.default.unzip(a,r).then(()=>{fs_extra_1.existsSync(a)&&fs_extra_1.unlinkSync(a),i&&i(editor_1.default.tr("installed"),!0),e(!0)}).catch(()=>u())}})})},openPopup:function(e,t){var i,r;let n=this.getServicePluginInfo(e);void 0!==n&&(null===(r=null===(i=n.contents)||void 0===i?void 0:i.popup)||void 0===r?void 0:r.main)&&editor_1.default.sendMsg(editor_1.default.plugin,"open-popup",e,t)},closePopup:function(e){var t,i;let r=this.getServicePluginInfo(e);void 0!==r&&(null===(i=null===(t=r.contents)||void 0===t?void 0:t.popup)||void 0===i?void 0:i.main)&&editor_1.default.sendMsg(editor_1.default.plugin,"close-popup",e)},registerI18n:function(e){let t=this.getServicePluginInfo(e);void 0!==t&&(fs_extra_1.existsSync(path_1.join(t.path,"i18n/zh.js"))&&editor_1.default.registerI18n("zh",e,util_1.default.require(t.path,"i18n/zh.js")),fs_extra_1.existsSync(path_1.join(t.path,"i18n/en.js"))&&editor_1.default.registerI18n("en",e,util_1.default.require(t.path,"i18n/en.js")))}};