"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editor_1=__importDefault(require("./editor")),util_1=__importDefault(require("./util")),path_1=require("path"),fs_extra_1=require("fs-extra");let generateConfigItem=(e,i,r=[])=>({app_id:e,config_id:i.config_id,config_name:i.config_name,config_remarks:i.config_remarks,services:r}),getConfigSetByConfig=e=>({config_id:e.config_id,config_name:e.config_name,config_remarks:e.config_remarks});exports.default={updateConfigFile:async function(){return new Promise(async(e,i)=>{let r=async e=>{e.map(e=>{if(void 0!==e.config_id)return;let i=this.generateConfigSet("Default");e.config_id=i.config_id,e.config_name=i.config_name,e.config_remarks=i.config_remarks}),await editor_1.default.writeProjectProfile("configs",e)},t=async e=>{if(void 0!==e&&null!==e){if(void 0!==e.configs&&e.configs instanceof Array&&await r(e.configs),void 0!==e.game){let i=e.game;this.writeBindGame({app_id:i.appid||i.app_id||"UNKNOW",name:i.name,c_id:i.cid||"0"})}let i=await editor_1.default.readProjectProfile("game.app_id"),t=await this.readConfigSets(i);t.length>0&&await editor_1.default.writeProjectProfile("appConfigMaps",[{app_id:i,config_id:t[0].config_id}]),await editor_1.default.writeProjectProfile("cscv","2.0.0")}},a=await editor_1.default.readProjectProfile("cscv");if(void 0!==a&&0===util_1.default.compareVersion(a,"2.0.0"))return e();let o=path_1.join(editor_1.default.getProjectPath(),"settings/service.json");if(fs_extra_1.existsSync(o)&&(void 0===await editor_1.default.readProjectProfile("game")||null===await editor_1.default.readProjectProfile("game")))try{t(fs_extra_1.readJsonSync(o))}catch(i){return e()}e()})},generateConfigSet:function(e,i=""){return{config_id:util_1.default.generateID(e),config_name:e,config_remarks:i}},copyConfigSet:async function(e,i="",r=""){return new Promise(async(t,a)=>{if(""===r&&(r=await editor_1.default.readProjectProfile("game.app_id")),""===i){let e=(await editor_1.default.readProjectProfile("appConfigMaps")||[]).find(e=>e.app_id===r);if(void 0===e)return a("Config file error! (copyConfigSet => appConfigMaps.find)");i=e.config_id}let o=await editor_1.default.readProjectProfile("configs")||[],n=o.find(e=>e.app_id==r&&e.config_id===i);if(void 0===n)return a("Config file error! (copyConfigSet => configs.find)");let f=generateConfigItem(r,e,n.services||[]);o.push(f),await editor_1.default.writeProjectProfile("configs",o),t()})},deleteConfigSet:async function(e,i=""){return new Promise(async(r,t)=>{""===i&&(i=await editor_1.default.readProjectProfile("game.app_id"));let a=await editor_1.default.readProjectProfile("configs");a||(a=[]);let o=a.findIndex(r=>r.app_id==i&&r.config_id===e);if(o<0)return t("Config file error! (deleteConfigSet => configs.findIndex)");a.splice(o,1),await editor_1.default.writeProjectProfile("configs",a);let n=a.filter(e=>e.app_id===i);r(n[Math.max(Math.min(n.length-1,o-1),0)])})},readServiceList:async function(){return await editor_1.default.readGlobalProfile("services")||[]},writeServiceList:async function(e){return await editor_1.default.writeGlobalProfile("lang",editor_1.default.getLang()),await editor_1.default.writeGlobalProfile("services",e)},readServiceGroupList:async function(){return await editor_1.default.readGlobalProfile("groups")||[]},writeServiceGroupList:async function(e){return await editor_1.default.writeGlobalProfile("lang",editor_1.default.getLang()),await editor_1.default.writeGlobalProfile("groups",e)},readServiceFilter:async function(){return await editor_1.default.readGlobalProfile(`filter.${editor_1.default.getLang()}`)||{status:"All",platforms:["All"]}},writeServiceFilter:async function(e){return await editor_1.default.writeGlobalProfile(`filter.${editor_1.default.getLang()}`,e)},readBindGame:async function(){return await editor_1.default.readProjectProfile("game")},writeBindGame:async function(e){return new Promise(async(i,r)=>{await editor_1.default.writeProjectProfile("game",e);let t=await this.readConfigSet(e.app_id);if(void 0===t){let i=await this.readConfigSets(e.app_id);i.length>0&&(t=i[0])}void 0===t&&(t=this.generateConfigSet("Default")),await this.writeConfigSet(t,e.app_id),i()})},readConfigSet:async function(e=""){return new Promise(async(i,r)=>{""===e&&(e=await editor_1.default.readProjectProfile("game.app_id"));let t=await editor_1.default.readProjectProfile("appConfigMaps")||[],a=void 0;do{let i=t.find(i=>i.app_id===e),r=await editor_1.default.readProjectProfile("configs");if(void 0===i||null===r)break;let o=r.find(r=>r.app_id==e&&r.config_id==(null===i||void 0===i?void 0:i.config_id));if(void 0===o)break;a=getConfigSetByConfig(o)}while(0);i(a)})},writeConfigSet:async function(e,i=""){return new Promise(async(r,t)=>{""===i&&(i=await editor_1.default.readProjectProfile("game.app_id"));let a=await editor_1.default.readProjectProfile("appConfigMaps")||[],o=a.find(e=>e.app_id===i);void 0===o?(o={app_id:i,config_id:e.config_id},a.push(o)):o.config_id=e.config_id,await editor_1.default.writeProjectProfile("appConfigMaps",a);let n=await editor_1.default.readProjectProfile("configs");n||(n=[]);let f=n.find(r=>r.app_id==i&&r.config_id===e.config_id);void 0===f?n.push(generateConfigItem(i,e)):(f.config_id=e.config_id,f.config_name=e.config_name,f.config_remarks=e.config_remarks),await editor_1.default.writeProjectProfile("configs",n),r()})},readConfigSets:async function(e=""){return new Promise(async(i,r)=>{""===e&&(e=await editor_1.default.readProjectProfile("game.app_id"));let t=await editor_1.default.readProjectProfile("configs");t||(t=[]);let a=[];t.filter(i=>i.app_id===e).forEach(e=>e.config_id&&a.push(getConfigSetByConfig(e))),i(a)})},readEnableServices:async function(e=""){return new Promise(async(i,r)=>{let t=await editor_1.default.readProjectProfile("game.app_id");if(""===e){let i=await this.readConfigSet();if(void 0===i)return r("Config file error! (readEnableServices => readConfigSet)");e=i.config_id}let a=await editor_1.default.readProjectProfile("configs");a||(a=[]);let o=[];do{let i=a.find(i=>i.app_id==t&&i.config_id===e);if(void 0===i||void 0===i.services||0===i.services.length)break;i.services.filter(e=>e.enable).forEach(e=>o.push(e.service_id))}while(0);i(o)})},wirteEnableService:async function(e,i,r=""){return new Promise(async(t,a)=>{let o=await editor_1.default.readProjectProfile("game.app_id");if(""===r){let e=await this.readConfigSet();if(void 0===e)return a("Config file error! (wirteEnableService => readConfigSet)");r=e.config_id}let n=await editor_1.default.readProjectProfile("configs");n||(n=[]);let f=n.find(e=>e.app_id==o&&e.config_id===r);if(void 0===f)return a("Config file error! (wirteEnableService => config.find)");void 0===f.services&&(f.services=[]);let d=f.services.find(i=>i.service_id===e);void 0===d?(d={service_id:e,enable:i,param:{}},f.services.push(d)):d.enable=i,await editor_1.default.writeProjectProfile("configs",n),t()})},readServiceParam:async function(e,i=""){return new Promise(async(r,t)=>{let a=await editor_1.default.readProjectProfile("game.app_id");if(""===i){let e=await this.readConfigSet();if(void 0===e)return t("Config file error! (readServiceParam => readConfigSet)");i=e.config_id}let o=await editor_1.default.readProjectProfile("configs");o||(o=[]);let n={};do{let r=o.find(e=>e.app_id==a&&e.config_id===i);if(void 0===r||void 0===r.services||0===r.services.length)break;let t=r.services.find(i=>i.service_id===e);void 0!==t&&void 0!==t.param&&null!==t.param&&(n=t.param)}while(0);r(n)})},writeServiceParam:async function(e,i,r=""){return new Promise(async(t,a)=>{let o=await editor_1.default.readProjectProfile("game.app_id");if(""===r){let e=await this.readConfigSet();if(void 0===e)return a("Config file error! (writeServiceParam => readConfigSet)");r=e.config_id}let n=await editor_1.default.readProjectProfile("configs");n||(n=[]);let f=n.find(e=>e.app_id==o&&e.config_id===r);if(void 0===f)return a("Config file error! (writeServiceParam => readConfigSet)");void 0===f.services&&(f.services=[]);let d=f.services.find(i=>i.service_id===e);void 0===d?(d={service_id:e,enable:!1,param:i},f.services.push(d)):d.param=i,await editor_1.default.writeProjectProfile("configs",n),t()})},readDevMode:async function(){return 0!==(await this.readServiceList()).filter(e=>/service-cocosads/.test(e.service_component_name)).length}};