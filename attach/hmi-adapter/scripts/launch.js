"use strict";const __StartTime__=Date.now(),{readJSONSync,existsSync}=require("fs-extra"),join=require("path")["join"],{app,crashReporter,shell}=require("electron");function logLaunchArgs(t){existsSync(join(t.PATH.HOME,"debug"))&&(console.debug("Arguments:"),Object.keys(t.args).forEach(e=>{console.debug(`  ${e}: `+t.args[e])}),console.debug(" "))}exports.launch=async function(){var e=require("@editor/setting");if(logLaunchArgs(e),e.PATH.PROJECT&&e.args.hmi){var{editorProcessManager:t,ProcessMainManager:i}=require("@editor/process-message"),t=(t("DASHBOARD_STORE_EXTENSION_INSTALL",new i(process)),join(e.PATH.PROJECT,"temp/crash"));app.setPath("crashDumps",t),crashReporter.start({uploadToServer:!1});try{await require("./dashboard/script/util").installProjectDepend(e.PATH.PROJECT)}catch(e){console.error(e)}var i=require("./inject")["inject"];if(await i(),e.args.build){await Editor.Startup.__protected__.manager(!0,!!e.args.metric);const n=await scanPrePackage(),r=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:n,list:r});t=e.args.build.split(";");const a={};t.forEach(e=>{e&&(e=e.split("="),a[e[0].trim()]=e[1])});i=await Editor.Startup.__protected__.build(a,e.args.dev);app.exit(i),void process.exit(i)}else{const o=await useNativeScene(e);let a=!1;await Promise.all([Editor.Startup.__protected__.manager(!!e.args.test||!!e.args.nologin,!!e.args.metric),Editor.Startup.__protected__.window({async beforeOpen(e,t){var i=checkLayout(t.layout);a||(a=!0,o?("win32"===process.platform&&(e.transparent=!0,e.resizable=!0,e.frame=!1),i||(t.layout=readJSONSync(join(__dirname,"./static/layout-native.json")))):i&&(t.layout=readJSONSync(join(__dirname,"./static/layout-web.json"))))},async afterOpen(e){Editor.Metrics.trackTimeEnd("main-window:start-up",{value:Date.now()-__StartTime__})}})]);const n=await scanPrePackage(),r=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:n,list:r}),await runTest(e)}}else 1!==(await Editor.Dialog.warn("请从 Dashboard 打开车机版编辑器",{buttons:["确定","取消"],default:0,cancel:1})).response&&(t=join(__dirname,"../../"),i="win32"===process.platform?join(t,"../../CocosCreatorHMI.exe"):join(t,"../../MacOS/CocosCreatorHMI"),await shell.openExternal("cocos-dashboard-hmi://open/"+i)),app.exit(0)};let nativeSceneOriConfig=void 0;async function useNativeScene(e){return void 0!==e.args.testScene?(nativeSceneOriConfig=await Editor.Profile.getConfig("scene","scene.native-engine","global"),e="native"===e.args.testScene,await Editor.Profile.setConfig("scene","scene.native-engine",e,"global"),!0):void 0!==(e=await Editor.Profile.getConfig("scene","scene.native-engine","global"))&&e}async function runTest(e){var t;if(void 0!==e.args.testScene)return Editor.Dialog.__protected__.setMode("command"),t={useNative:"native"===e.args.testScene},t=await Editor.Startup.__protected__.test(t,e.args.dev),await Editor.Profile.setConfig("scene","scene.native-engine",!!nativeSceneOriConfig,"global"),console.log("测试结果",t),e.args.dev?void 0:void("success"===t?app.exit(1):app.exit(-1));e.args.test&&(Editor.Dialog.__protected__.setMode("command"),t="string"==typeof e.args.test?function(e){const t={};return e.forEach(e=>{e&&(e=e.split("="),t[e[0].trim()]=["true","false"].includes(e[1])?JSON.parse(e[1]):e[1])}),t}(e.args.test.split(";")):{},t=await Editor.Startup.__protected__.test(t,e.args.dev),app.exit(t))}function checkLayout(e){let i=!1;return e&&function e(t){if(t.panels&&t.panels.includes("scene.preview"))return i=!0;t.children&&t.children.some(e)}(e.layout),i}async function scanPrePackage(){const t=[];return["./builtin/metrics","./builtin/menu","./builtin/profile","./builtin/project","./builtin/messages","./builtin/utils","./builtin/program","./builtin/tester","./builtin/information","./builtin/preferences","./builtin/engine","./builtin/programming","./builtin/window","./modules/editor-extensions/extensions/device","./modules/editor-extensions/extensions/ui-kit"].forEach(e=>{t.push(join(Editor.App.path,e))}),t}async function scanPackage(){var e={editor:join(Editor.App.path,"./modules/editor-extensions/extensions"),engine:join(Editor.App.path,"./modules/engine-extensions/extensions"),platform:join(Editor.App.path,"./modules/platform-extensions/extensions"),builtinOthers:join(Editor.App.path,"./extension"),globalBuiltin:join(Editor.App.home,"./builtin-extensions/"+Editor.App.version),project:join(Editor.Project.path,"extensions")};const t=[];["./builtin/asset-db","./builtin/scene","./builtin/server","./builtin/preview","./builtin/animator","./builtin/builder","./builtin/shortcuts","./builtin/animation-graph"].forEach(e=>{t.push(join(Editor.App.path,e))});for(const a in e){var i=e[a],i=await Editor.Package.__protected__.scan(i);t.push(...i)}return t.push(join(Editor.App.path,"./builtin/placeholder")),t}