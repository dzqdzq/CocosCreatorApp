"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),electron_1=require("electron"),simple_plist_1=require("simple-plist");let programConfig={};const NOT_UNDERLINE=["cmake","browser"];function executeProgram(r,e){return new Promise((o,t)=>{var n,a;e=e||[];let i="";if("darwin"===process.platform){if(r.endsWith(".app"))try{r=(0,path_1.join)(r,"/Contents/MacOS/");const e=(0,simple_plist_1.readFileSync)((0,path_1.join)(r,"../Info.plist")),o=(0,path_1.join)(r,e.CFBundleExecutable);r=o}catch(r){return t(`[execute program error] Probably the program's Info.plist error: ${r}`)}i="open",e?(e.splice(0,0,r),e.splice(0,0,"-a")):e=["-a",r]}else i=r;console.debug(`program command : ${i} ${e.join(" ")}`);const s=(0,child_process_1.spawn)(i,e,{detached:!0,stdio:"ignore"});null===(n=s.stdout)||void 0===n||n.on("data",r=>{console.log(`[execute program] ${r}`)}),null===(a=s.stderr)||void 0===a||a.on("data",r=>{console.error(`[execute program error] ${r}`)}),s.on("error",e=>{t(`${r} exit with error: ${e.message}`)}),s.on("close",e=>{0!==e?t(`${r} exit width code ${e}`):o()}),s.unref()})}function handleArguments(r,e){if(!e||"object"!=typeof e)return[];let o=r.commandArgument?r.commandArgument.replace(/}\s+/g,"}@#").replace(/\s+\${/g,"@#${"):"";const t=r.arguments||{};let n=[];for(const r in e)if(t[r]){if("boolean"==typeof e[r]){o=o.replace(`\${${r}}`,e[r]?r:"");continue}o.includes(`\${${r}}`)?o=o.replace(`\${${r}}`,`${e[r]}`):o+=`@#${e[r]}`}return o&&(n=o.replace(/\${(.+?)}/g,"@#").replace(/(@#){2,}/g,"@#").replace(/^(\s|@#)+|(\s|@#)+$/g,"").split("@#")),e._args&&n.push(...e._args),n}async function load(){Editor.Package.getPackages({enable:!0}).forEach(exports.methods.attach),Editor.Package.__protected__.on("enable",exports.methods.attach)}function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach)}exports.methods={async queryProgramInfo(r){if(!r)return null;NOT_UNDERLINE.includes(r)&&(r=`${r}V2`);for(const e in programConfig)for(const o in programConfig[e])if(o===r){const r=await Editor.Profile.getConfig(e,`${o}.path`)||await Editor.Profile.getConfig(e,`${o}.path`,"default"),t=await Editor.Profile.getConfig(e,`${o}.commandArgument`)||await Editor.Profile.getConfig(e,`${o}.commandArgument`,"default"),n=programConfig[e][o];return{label:n.label,description:n.description,arguments:n.arguments,path:r||"",commandArgument:t||""}}return null},async queryPrograms(){const r={};for(const e in programConfig)for(const o in programConfig[e]){const t=await Editor.Profile.getConfig(e,`${o}.path`)||await Editor.Profile.getConfig(e,`${o}.path`,"default"),n=await Editor.Profile.getConfig(e,`${o}.commandArgument`)||await Editor.Profile.getConfig(e,`${o}.commandArgument`,"default"),a=programConfig[e][o],i={label:a.label,description:a.description,arguments:a.arguments,path:t||"",commandArgument:n||""};let s=o;"program"===e&&o.endsWith("V2")&&NOT_UNDERLINE.includes(s.replace(/(V2)?$/g,""))&&(s=s.replace(/(V2)?$/g,"")),r[e]=Object.assign({},r[e]),r[e][s]=i}return r},queryProgramConfig:()=>programConfig||{},async openProgram(r,e){if(!r||"string"!=typeof r)return console.log(Editor.I18n.t("program.console.programErr")),!1;try{const o=await exports.methods.queryProgramInfo(r);if(!o)return console.debug(Editor.I18n.t("program.console.noProgram",{program:r})),!1;if(!o.path)return console.debug(Editor.I18n.t("program.console.noProgramPath",{program:o.label?Editor.I18n.t(o.label.split("i18n:")[1]):r})),!1;{if(!(0,fs_extra_1.existsSync)(o.path))return console.log(Editor.I18n.t("program.console.programPathErr",{program:o.label?Editor.I18n.t(o.label.split("i18n:")[1]):r,path:o.path||""})),!1;const t=handleArguments(o,e);await executeProgram(o.path,t)}}catch(r){return console.error(r),!1}return!0},async openUrl(r,e){if(!r||"string"!=typeof r)return console.log(Editor.I18n.t("program.console.urlErr")),!1;try{if(r.startsWith("http")){if(await exports.methods.openProgram("browser",{_args:[r]}))return!0}electron_1.shell.openExternal(r,e)}catch(r){return console.error(r),!1}return!0},async attach(r){if(!r.invalid&&r.info.contributions&&r.info.contributions.program){r.name,r.info;try{const e=r.info.contributions.program,o={};for(const r in e)o[r]={label:e[r].label,description:e[r].description,render:e[r].render,arguments:e[r].arguments};programConfig=Object.assign({},programConfig,{[r.name]:o})}catch(e){console.error(`[program] ${r.name} register program failed.`),console.error(e)}}}},exports.load=load,exports.unload=unload;