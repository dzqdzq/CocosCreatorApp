"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),parse=require("plist").parse;let programConfig={};const NOT_UNDERLINE=["cmake","browser"];function executeProgram(r,e){return new Promise((o,t)=>{var n,a;e=e||[];let i="";if("darwin"===process.platform){if(r.endsWith(".app")){r=(0,path_1.join)(r,"/Contents/MacOS/");const e=parse((0,fs_extra_1.readFileSync)((0,path_1.join)(r,"../Info.plist"),"utf8")),o=(0,path_1.join)(r,e.CFBundleExecutable);r=o}i="open",e?(e.splice(0,0,r),e.splice(0,0,"-a")):e=["-a",r]}else i=r;console.debug(`program command : ${i} ${e.join(" ")}`);const s=(0,child_process_1.spawn)(i,e,{detached:!0,stdio:"ignore"});null===(n=s.stdout)||void 0===n||n.on("data",r=>{console.log(`[execute program] ${r}`)}),null===(a=s.stderr)||void 0===a||a.on("data",r=>{console.error(`[execute program error] ${r}`)}),s.on("error",e=>{t(`${r} exit with error: ${e.message}`)}),s.on("close",e=>{0!==e?t(`${r} exit width code ${e}`):o()}),s.unref()})}function handleArguments(r,e){if(!e||"object"!=typeof e)return[];let o=r.commandArgument?r.commandArgument.replace(/}\s+/g,"}@#").replace(/\s+\${/g,"@#${"):"";const t=r.arguments||{};let n=[];for(const r in e)if(t[r]){if("boolean"==typeof e[r]){o=o.replace(`\${${r}}`,e[r]?r:"");continue}o.includes(`\${${r}}`)?o=o.replace(`\${${r}}`,`${e[r]}`):o+=`@#${e[r]}`}return n=o.replace(/\${(.+?)}/g,"@#").replace(/(@#){2,}/g,"@#").replace(/^(\s|@#)+|(\s|@#)+$/g,"").split("@#"),e._args&&n.push(...e._args),n}async function load(){Editor.Package.getPackages({enable:!0}).forEach(exports.methods.attach),Editor.Package.__protected__.on("enable",exports.methods.attach)}function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach)}exports.methods={async queryProgramInfo(r){if(!r)return null;NOT_UNDERLINE.includes(r)&&(r=`${r}V2`);for(const e in programConfig)for(const o in programConfig[e])if(o===r){const r=programConfig[e][o];return{label:r.label,description:r.description,arguments:r.arguments,path:await Editor.Profile.getConfig(e,`${o}.path`)||"",commandArgument:await Editor.Profile.getConfig(e,`${o}.commandArgument`)||""}}return null},async queryPrograms(){const r={};for(const e in programConfig)for(const o in programConfig[e]){const t=programConfig[e][o],n={label:t.label,description:t.description,arguments:t.arguments,path:await Editor.Profile.getConfig(e,`${o}.path`)||"",commandArgument:await Editor.Profile.getConfig(e,`${o}.commandArgument`)||""};let a=o;"program"===e&&o.endsWith("V2")&&NOT_UNDERLINE.includes(a.replace(/(V2)?$/g,""))&&(a=a.replace(/(V2)?$/g,"")),r[e]=Object.assign({},r[e]),r[e][a]=n}return r},queryProgramConfig:()=>(NOT_UNDERLINE.forEach(r=>{programConfig.program[r]&&(programConfig.program[`${r}V2`]=programConfig.program[r],delete programConfig.program[r])}),programConfig||{}),async execute(r,e){if(r)try{const o=await exports.methods.queryProgramInfo(r);if(!o||!o.path)return console.warn(Editor.I18n.t("program.console.noProgram",{program:r}));if(!(0,fs_extra_1.existsSync)(o.path))throw new Error(Editor.I18n.t("program.console.programPathErr"));console.log("program startup..."),await executeProgram(o.path,handleArguments(o,e))}catch(r){console.error(r)}},async attach(r){if(!r.invalid&&r.info.contributions&&r.info.contributions.program){r.name,r.info;try{const e=r.info.contributions.program,o={};for(const r in e)o[r]={label:e[r].label,description:e[r].description,render:e[r].render,arguments:e[r].arguments};programConfig=Object.assign({},programConfig,{[r.name]:o})}catch(e){console.log(`[program] ${r.name} register program failed.`),console.error(e)}}}},exports.load=load,exports.unload=unload;