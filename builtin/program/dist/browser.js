"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),electron_1=require("electron"),simple_plist_1=require("simple-plist");let programConfig={};function executeProgram(r,e){return new Promise((o,t)=>{var n,a;e=e||[];let i="";if("darwin"===process.platform){if(r.endsWith(".app"))try{r=(0,path_1.join)(r,"/Contents/MacOS/");const e=(0,simple_plist_1.readFileSync)((0,path_1.join)(r,"../Info.plist")),o=(0,path_1.join)(r,e.CFBundleExecutable);r=o}catch(r){return t(`[execute program error] Probably the program's Info.plist error: ${r}`)}i="open",e?(e.splice(0,0,r),e.splice(0,0,"-a")):e=["-a",r]}else i=r;console.debug(`program command : ${i} ${e.join(" ")}`);const s=(0,child_process_1.spawn)(i,e,{detached:!0,stdio:"ignore"});null===(n=s.stdout)||void 0===n||n.on("data",r=>{console.log(`[execute program] ${r}`)}),null===(a=s.stderr)||void 0===a||a.on("data",r=>{console.error(`[execute program error] ${r}`)}),s.on("error",e=>{t(`${r} exit with error: ${e.message}`)}),s.on("close",e=>{0!==e?t(`${r} exit width code ${e}`):o()}),s.unref()})}function handleArguments(r,e){if(!e||"object"!=typeof e)return[];let o=r.commandArgument?r.commandArgument.replace(/}\s+/g,"}@#").replace(/\s+\${/g,"@#${"):"";const t=r.arguments||{};let n=[];for(const r in e)if(t[r]){if("boolean"==typeof e[r]){o=o.replace(`\${${r}}`,e[r]?r:"");continue}o.includes(`\${${r}}`)?o=o.replace(`\${${r}}`,`${e[r]}`):o+=`@#${e[r]}`}return o&&(n=o.replace(/\${(.+?)}/g,"@#").replace(/(@#){2,}/g,"@#").replace(/^(\s|@#)+|(\s|@#)+$/g,"").split("@#")),e._args&&n.push(...e._args),n}async function load(){Editor.Package.getPackages({enable:!0}).forEach(exports.methods.attach),Editor.Package.__protected__.on("enable",exports.methods.attach)}function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach)}exports.methods={async queryProgramInfo(r){var e,o;if(!r)return null;"browser"===r&&(r=`${r}V2`);for(const t in programConfig){if(!programConfig[t].properties[r])continue;const n=null!==(e=await Editor.Profile.getConfig(t,`${r}.path`,"local"))&&void 0!==e?e:await Editor.Profile.getConfig(t,`${r}.path`,"global"),a=null!==(o=await Editor.Profile.getConfig(t,`${r}.commandArgument`,"local"))&&void 0!==o?o:await Editor.Profile.getConfig(t,`${r}.commandArgument`,"global");if(null!=n||null!=a)return{path:n||"",commandArgument:a||""}}return null},queryProgramConfig:()=>programConfig||{},async openProgram(r,e){if(!r||"string"!=typeof r)return console.log(Editor.I18n.t("program.console.programErr")),!1;try{let o=null,t=r;for(const e in programConfig)if(programConfig[e].properties){for(const n in programConfig[e].properties){if("browser"===r&&(t=`${r}V2`),n===t){const r=programConfig[e].properties[n];o={label:r.label,description:r.description,arguments:r.arguments};break}if(o)break}if(o)break}if(!o)return console.debug(Editor.I18n.t("program.console.noProgram",{program:r})),!1;{const t=await exports.methods.queryProgramInfo(r);if(null===t||void 0===t||!t.path)return console.debug(Editor.I18n.t("program.console.noProgramPath",{program:(null===o||void 0===o?void 0:o.label)?Editor.I18n.t(o.label.split("i18n:")[1]):r})),!1;{if(!(0,fs_extra_1.existsSync)(t.path))return console.log(Editor.I18n.t("program.console.programPathErr",{program:(null===o||void 0===o?void 0:o.label)?Editor.I18n.t(o.label.split("i18n:")[1]):r,path:t.path||""})),!1;const n=handleArguments(o=Object.assign({},o,t),e);await executeProgram(t.path,n)}}}catch(r){return console.error(r),!1}return!0},async openUrl(r,e){if(!r||"string"!=typeof r)return console.log(Editor.I18n.t("program.console.urlErr")),!1;try{if(r.startsWith("http")){if(await exports.methods.openProgram("browser",{_args:[r]}))return!0}electron_1.shell.openExternal(r,e)}catch(r){return console.error(r),!1}return!0},async attach(r){if(!r.invalid&&r.info.contributions&&r.info.contributions.program)try{const e=r.info.contributions.program,o={title:r.info.title||r.name,properties:null,custom:e.custom?(0,path_1.join)(r.path,e.custom):""};if(e.properties)for(const r in e.properties)o.properties=o.properties||{},o.properties[r]={label:e.properties[r].label,description:e.properties[r].description,render:e.properties[r].render,arguments:e.properties[r].arguments};programConfig=Object.assign({},programConfig,{[r.name]:o})}catch(e){console.error(`[program] ${r.name} register program failed.`),console.error(e)}}},exports.load=load,exports.unload=unload;