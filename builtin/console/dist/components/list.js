"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.methods=exports.watch=exports.data=exports.props=exports.name=exports.template=void 0;const fs_1=require("fs"),iclipboard_1=require("iclipboard"),path_1=require("path"),url_1=require("url"),manager=require("../manager"),outputList=manager.outputList;let isOperating=!1;const renderTypes={link:(t,e)=>`<ui-link value="${e=e.replace(/:\d+/g,"")}">${t||e}</ui-link>`,asset:(t,e)=>`<ui-link type="${e.startsWith("db://")?"assetUrl":"assetUuid"}" value="${e}">${t||e}</ui-link>`,node:(t,e)=>`<ui-link type="nodeUuid" value="${e}">${t||e}</ui-link>`,image:(t,e)=>`\n        <ui-link value="${e}">\n            <ui-image value="${e}" max-height>${t||e}</ui-image>\n        </ui-link>\n        `,i18n:(t,e)=>Editor.I18n.t(e)};function data(){return{change:this.value,timer:null,cacheListLength:0,showList:[],wrapperStyle:{height:0}}}async function beforeClose(){}async function close(){}exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/list.html"),"utf8"),exports.name="console-list",exports.props={value:{type:Boolean},fontSize:{type:Number},lineHeight:{type:Number}},exports.data=data,exports.watch={value(t){this.change=t},change(t){t&&(this.renderList(),this.$emit("input",!1))},lineHeight(t){t&&this.renderList()}},exports.methods={toggleContent(t){const e=outputList.findIndex(e=>e.translateY===t),i=outputList[e];if(!i.rows)return;const s=i.rows*(this.lineHeight-2)+14-this.lineHeight;for(let t=e+1;t<outputList.length;t++){const e=outputList[t];e.translateY+=e.fold?s:0-s}i.fold=!i.fold,this.wrapperStyle.height=`${this.getHeight()}px`,manager.update()},createItem:()=>({content:[],rows:0,message:"",type:"",title:"",texture:"",count:1,fold:!0,show:!1,stack:[],translateY:-1e3}),getHeight(){let t=0;return outputList.forEach(e=>{e.fold?t+=this.lineHeight:t+=e.rows*(this.lineHeight-2)+14}),t},getScrollPosition(t,e){let i=0,s=0;return outputList.some((o,r)=>{if(o.fold?i+=e:i+=o.rows*(e-2)+14,i>t)return s=r-1,!0}),s},renderList(){const t=this.getHeight();this.wrapperStyle.height=`${t}px`;const e=this.lineHeight,i=Math.ceil(this.$el.clientHeight/e)+3;this.showList.splice(i);const s=this.$el.scrollTop,o=this.$el.clientHeight,r=outputList.length-this.cacheListLength,n=t-o-s<=r*e;this.cacheListLength=outputList.length;for(let t=0;t<i;t++){const e=this.showList[t];e?(e.show=!1,e.translateY=-1e3):this.showList.push(this.createItem())}n&&requestAnimationFrame(()=>{this.$el.scrollTop=t-o}),this.onScroll()},onScroll(){if(isOperating)return;isOperating=!0;const t=this.$el.scrollTop,e=this.lineHeight,i=this.getScrollPosition(t,e);this.showList.forEach((t,e)=>{const s=outputList[i+e];s?(t.date=s.date,t.type=s.type,t.rows=s.rows,t.title=s.title,t.content=s.content,t.count=s.count,t.fold=s.fold,t.translateY=s.translateY,t.texture=(i+e)%2==0?"dark":"light",t.stack=s.stack,t.show=!0):(t.translateY=-1e3,t.show=!1)}),isOperating=!1},showMenuPast(t,e){let i=e.title;e.rows>1&&e.content.forEach(t=>{i+=t}),Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:[{label:Editor.I18n.t("console.copy"),click(){iclipboard_1.copy(i)}}]})},renderText:t=>t?t=(t=(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/\((file:\/\/\/[^)]+)\)/g,(t,e)=>{const i=url_1.fileURLToPath(e);return`{link[${i}](${i})}`})).replace(/\{([\w]+)(?:\[([^[]*)\])?(?:\(([^()]*)\))\}/gi,(t,e,i,s)=>{const o=e.toLowerCase();return renderTypes[o]?renderTypes[o](i,s):t}):t,onTextClick(t){if(!t.target)return;null===t.target.getAttribute("bubble")&&this.$el!==t.target&&(t.stopPropagation(),t.preventDefault());const e=t.target.getRootNode().getSelection();e&&e.baseOffset!==e.focusOffset&&(t.stopPropagation(),t.preventDefault())}},exports.beforeClose=beforeClose,exports.close=close;