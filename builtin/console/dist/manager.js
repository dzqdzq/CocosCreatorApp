"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),list=exports.list=[],outputList=exports.outputList=[];let updateFn,lineHeight,animationId,collapse=!0,filterType="",filterText="",filterRegex=!1,isShowDate=!1;const saveLogs=[];let saveLogAnimationId,savingLogToFile=!1;const logPath=path_1.join(Editor.Project.path,"local","logs","project.log");exports.logPath=logPath,exports.setUpdateFn=(t=>{updateFn=t}),exports.setLineHeight=(t=>{lineHeight=exports.lineHeight=t,exports.update()}),exports.reset=(t=>{fs_extra_1.outputFileSync(logPath,"","utf-8"),exports.clear();for(const e of t)exports.addItem(e);exports.update()}),exports.addItem=(t=>{t.dateTime=dateFormat(t.time),saveLog(t);const e={},o=t.message.toString().split("\n").filter(t=>""!==t.trim());e.type=t.type,t.stack&&"string"==typeof t.stack?(e.stack=t.stack.split(/(\r\n|\r|\n)/).filter(t=>/^[^\n|\r]+$/.test(t)),e.stack.shift()):e.stack=[],e.rows=o.length+e.stack.length,e.title=o[0]||"",e.content=o.splice(1),e.fold=!0,e.count=1,e.time=t.time,e.dateTime=t.dateTime,list.push(e)}),exports.setCollapse=(t=>{collapse=t,exports.update()}),exports.setFilterType=(t=>{filterType="all"===t?"":t,Editor.Message.broadcast("console:update-log-level",t),exports.update()}),exports.setFilterText=(t=>{filterText=t,exports.update()}),exports.setFilterRegex=(t=>{filterRegex=t,exports.update()}),exports.showDate=(t=>{isShowDate=t,exports.update()}),exports.clear=(()=>{list.length=0,exports.update()});let updateLocker=!1;function saveLog(t){saveLogs.push(t),savingLogToFile||stepSaveLog()}function stepSaveLog(){if(savingLogToFile=!0,saveLogs.length){let t="";for(let e=0;e<5e3;e++){const e=saveLogs.shift();e&&(t+=`${e.dateTime}-${e.type}: ${e.message}\n`)}t&&fs_1.appendFile(logPath,t,()=>{}),setTimeout(()=>{stepSaveLog()},200)}else savingLogToFile=!1}function dateFormat(t){const e=new Date(t);return e.getFullYear()+"-"+((e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"-")+((e.getDate()<10?"0"+e.getDate():e.getDate())+" ")+((e.getHours()<10?"0"+e.getHours():e.getHours())+":")+((e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":")+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())}exports.update=(()=>{updateLocker||(updateLocker=!0,window.cancelAnimationFrame(animationId),animationId=requestAnimationFrame(()=>{let t=filterText,e=0;if(outputList.length=0,filterRegex)try{t=new RegExp(t)}catch(e){t=/.*/}list.filter(e=>{const o=!!e.title,s=!filterType||e.type===filterType,i=filterRegex?t.test(e.title):-1!==e.title.indexOf(t);return o&&s&&i}).forEach(t=>{const o=outputList[outputList.length-1],s=o&&o.title===t.title&&o.type===t.type&&o.content.join("\n")===t.content.join("\n")&&o.stack.join("\n")===t.stack.join("\n");collapse&&s?o.count+=1:(t.count=1,t.translateY=e,t.date=isShowDate?t.dateTime:null,outputList.push(t),e+=t.fold?lineHeight:t.rows*(lineHeight-2)+14)}),"function"==typeof updateFn&&updateFn(),updateLocker=!1}))});