"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,r){void 0===r&&(r=t),Object.defineProperty(e,r,{enumerable:!0,get:function(){return a[t]}})}:function(e,a,t,r){void 0===r&&(r=t),e[r]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;let pkg=null;const tasks_1=require("./tasks"),worker_1=require("./worker"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),platforms_options_1=require("../share/platforms-options"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),textureCompressConfig=__importStar(require("../share/texture-compress")),migration_1=require("./migration"),electron_1=require("electron"),worker=require("@base/electron-worker");let commandBuildOptions,commandBuildResolve=null,buildWorker=null;const logLevelMap={error:1,warn:2,log:3,all:4};async function load(){pkg=this,await Editor.Profile.setConfig("builder","common.name",Editor.Project.name||path_1.basename(Editor.Project.path),"default"),buildWorker=await worker_1.createWorker(),tasks_1.manager.init(),tasks_1.TaskManager.supportTaskQueue=await getSupportTaskQueue(),await plugin_1.pluginManager.init();const e=await Editor.Profile.getConfig("console","panel.filterType");await Editor.Profile.getConfig("builder","log.level")!==logLevelMap[e]&&Editor.Profile.setConfig("builder","log.level",logLevelMap[e])}async function unload(){await tasks_1.manager.save()}async function getSupportTaskQueue(){if(!(await Editor.Package.getPackages({name:"builder"}))[0].path.includes("app.asar")){if(await Editor.Profile.getConfig("builder","supportTaskQueue"))return!0}return!1}exports.methods={open(){Editor.Panel.open("builder")},"open-devtools"(){buildWorker&&buildWorker.debug(!0)},async createBuildPluginTemplate(){const e=await Editor.Dialog.info(Editor.I18n.t("builder.create_package.create_to"),{buttons:[Editor.I18n.t("builder.create_package.global"),Editor.I18n.t("builder.create_package.local"),Editor.I18n.t("builder.create_package.cancel")]});if(2===e.response)return;const a=path_1.join(0===e.response?Editor.App.home:Editor.Project.path,"extensions","cocos-build-template");if(fs_1.existsSync(a)){if(0!==(await Editor.Dialog.warn(Editor.I18n.t("builder.create_package_conflict.title"),{buttons:[Editor.I18n.t("builder.create_package_conflict.overwrite"),Editor.I18n.t("builder.create_package_conflict.cancel")],default:0,cancel:-1})).response)return}const t=path_1.join(__dirname,"../../build-plugin-template");await Editor.Utils.File.copy(t,a),await Editor.Message.request("utils","export-dts",a,!1);const r=path_1.join(a,"@types/index.d.ts");fs_extra_1.outputFileSync(r,fs_1.readFileSync(r,"utf8")+"\n/// <reference path=\"./packages/builder/@types/public/global.d.ts\"/>\nexport * from './packages/builder/@types/public';"),Editor.Package.register(a),console.log(`Create build plugin template in {link(${a})}.`)},openDocs(){electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl("editor/publish/build-panel.html"))},"query-worker-ready":()=>tasks_1.manager.workerReady,async"generate-preview-setting"(e){const a=worker.query("Build");return e.platform=e.platform||"web-desktop",await a.send("build-worker:generate-preview-setting",(new Date).getTime(),e)},"query-tasks-info"(){const e={};return Object.values(tasks_1.manager.map).map(a=>{e[a.id]=a.toJSON()}),{queue:e,free:tasks_1.manager.free}},"add-task":async(e,a)=>!!e&&new Promise(t=>{tasks_1.manager.push(e,a?t:void 0),a||t(!1)}),"recompile-task":async(e,a,t)=>tasks_1.manager.map[e]?new Promise(r=>{tasks_1.manager.recompile(e,a,t?r:void 0),t||r(36)}):34,async"remove-task"(e,a){if(!tasks_1.manager.map[e])return!1;if(a)try{const{buildPath:a,outputName:t,platform:r}=tasks_1.manager.map[e].options;a&&t?fs_extra_1.removeSync(path_1.join(Editor.UI.File.resolveToRaw(a),t)):console.warn(`Package ${t} has invalid options.`);const o=path_1.join(Editor.Project.tmpDir,"builder","log",r+utils_1.changeToLocalTime(e).replace(":","-")+".log");fs_1.existsSync(o)&&fs_extra_1.removeSync(o)}catch(e){return console.error("Remove build task failed!"),console.error(e),!1}return await tasks_1.manager.pop(e),!0},"query-task"(e){const a=tasks_1.manager.map[e];return a?a.toJSON():null},"update-task"(e,a,t){e&&a&&tasks_1.manager.map[e]&&(tasks_1.manager.map[e].options=a,tasks_1.manager.map[e].rawOptions=t,tasks_1.manager.map[e].dirty=!!t)},migrateOptions:async e=>(await migration_1.migrateOptions(e),e),"preview-pac":async e=>await buildWorker.send("build-worker:preview-pac",e),"query-atlas-files":async e=>await buildWorker.send("build-worker:query-atlas-files",e),async"run-button-task"(e,a,t,r){e&&a&&t&&buildWorker.send("build-worker:run-button-task",e,a,t,r)},"command-build":(e,a=!1)=>new Promise(async t=>{(buildWorker=worker.query("Build"))&&buildWorker.debug(a),commandBuildResolve=t,commandBuildOptions=e;const r=await Editor.Message.request("asset-db","query-ready"),o=await Editor.Message.request("programming","packer-driver/ready","editor");if(r&&o)try{await tasks_1.buildWithCommand(e,commandBuildResolve)}catch(e){console.error(e),commandBuildResolve(34)}}),async"programming:pack-build-end"(e){if("editor"===e)if(tasks_1.manager.scriptReady=!0,commandBuildResolve&&tasks_1.manager.dbReady){try{await tasks_1.buildWithCommand(commandBuildOptions,commandBuildResolve)}catch(e){console.error(e),commandBuildResolve(34)}tasks_1.manager.step()}else;},async createApplicationTemplate(){const e=path_1.join(__dirname,"../../static/build-templates/application.ejs").replace("app.asar","app.asar.unpacked"),a=path_1.join(Editor.Project.path,"build-templates","common",path_1.basename(e));if(fs_1.existsSync(a)){if(1===(await Editor.Dialog.warn("Do you want to overwrite the source file?",{buttons:["Yes","Cancel"],default:0,cancel:1})).response)return}fs_extra_1.copySync(e,a),console.log(`builder ${Editor.I18n.t("builder.tips.creat_application_template_success")}({link(${a})})`)},"request-to-build-worker":async(e,...a)=>await buildWorker.send(e,...a),async"preferences-changed"(e,a){switch(e){case"log.level":buildWorker.send("build-worker:change-log-level",a-0);break;case"supportTaskQueue":tasks_1.TaskManager.supportTaskQueue=await getSupportTaskQueue()}},async"query-compress-config"(){const e=await Editor.Profile.getProject("builder","textureCompressConfig.customConfigs"),a=textureCompressConfig.formatsInfo,t={};if(e&&Object.keys(e).length)for(const r of Object.values(e))t[r.id]=Object.assign(Object.assign({},a[r.format]),{displayName:r.name,value:r.id,custom:!0});return Object.assign(Object.assign({},textureCompressConfig),{formatsInfo:Object.assign(Object.assign({},a),t),customFormats:t,platformConfig:plugin_1.pluginManager.getPlatformConfig()})},"query-platform-config":async()=>({order:platforms_options_1.PLATFORMS,config:plugin_1.pluginManager.platformConfig}),"query-bundle-config":async()=>plugin_1.pluginManager.bundleConfig,"open-platform-debug-tools"(){Editor.Panel.open("builder.platform-debug-tools")},async"asset-db:ready"(){if(tasks_1.manager.dbReady=!0,commandBuildResolve&&tasks_1.manager.scriptReady)try{await tasks_1.buildWithCommand(commandBuildOptions,commandBuildResolve)}catch(e){console.error(e),commandBuildResolve(34)}else tasks_1.manager.step()},"console:update-log-level"(e){Editor.Profile.setConfig("builder","log.level",logLevelMap[e])}},exports.load=load,exports.unload=unload;