"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,r){void 0===r&&(r=t);var o=Object.getOwnPropertyDescriptor(a,t);o&&("get"in o?a.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,r,o)}:function(e,a,t,r){void 0===r&&(r=t),e[r]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;let pkg=null;const tasks_1=require("./tasks"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),platforms_options_1=require("../share/platforms-options"),plugin_1=require("./plugin"),textureCompressConfig=__importStar(require("../share/texture-compress")),migration_1=require("./migration"),worker_1=require("./worker"),message_1=require("./message"),bundle_utils_1=require("../share/bundle-utils");let commandBuildResolve=null;const logLevelMap={error:1,warn:2,log:3,all:4};async function load(){pkg=this,await plugin_1.pluginManager.init(),await tasks_1.manager.init();const e=await Editor.Profile.getConfig("console","panel.filterType");await Editor.Profile.getConfig("builder","log.level")!==logLevelMap[e]&&Editor.Profile.setConfig("builder","log.level",logLevelMap[e]),await Editor.Profile.setProject("builder","splash-setting.logo.image",(0,path_1.join)(Editor.App.path,"builtin/builder/static/logo/logo.png").replace("app.asar","app.asar.unpacked"),"default")}async function unload(){await tasks_1.manager.save(),await tasks_1.manager.destroy(),await worker_1.workerManager.destroy()}exports.methods={async open(e="",...a){""!==e&&"default"!==e?Editor.Panel.open(`builder.${e}`,...a):await Editor.Panel.has("builder")?(Editor.Message.send("builder","open-page",...a),Editor.Panel.focus("builder")):await Editor.Panel.open("builder",...a)},openBundle(e){Editor.Panel.open("builder.build-bundle",e)},openWorkerDevTool:message_1.openWorkerDevTool,openPanelDevTools:message_1.openPanelDevTools,openDocs:message_1.openDocs,clearAllCache:message_1.clearAllCache,clearEngineCache:message_1.clearEngineCache,clearProjectAssetsCache:message_1.clearProjectAssetsCache,async createBuildPluginTemplate(){await Editor.Panel.open("extension.create",{selectedTemplate:{packageName:"builder",templatePath:"./build-plugin-template"}})},"query-worker-ready":()=>tasks_1.manager.workerReady,"generate-preview-setting":async e=>(e.platform=e.platform||"web-desktop",await worker_1.workerManager.send("build-worker:generate-preview-setting",(new Date).getTime(),e)),"query-tasks-info"(e){const a={};Object.values(tasks_1.manager.map).map(t=>{e&&e.type&&t.type!==e.type||(a[t.id]=t.toJSON())});const t=Object.keys(a).sort().map(e=>a[e]);return{queue:a,list:t,free:tasks_1.manager.free}},"add-task":async(e,a)=>e?new Promise(t=>{const r=tasks_1.manager.add("build",e,a?t:void 0);a||t(r)}):2,"add-bundle-task":async(e,a)=>e?a?new Promise(a=>tasks_1.manager.add("bundle",e,a)):await tasks_1.manager.add("bundle",e):2,"recompile-task":async(e,a,t)=>new Promise(r=>{tasks_1.manager.recompile(e,a,t?r:void 0),t||r(36)}),"remove-task":async(e,a)=>"string"==typeof e?await tasks_1.manager.remove(e,a):await Promise.all(e.map(e=>tasks_1.manager.remove(e,a))),async"break-task"(e){await tasks_1.manager.break(e,"cancel")},"query-task":e=>tasks_1.manager.queryTaskInfo(e),"update-task":e=>tasks_1.manager.updateTaskInfo(e),"save-task":async()=>await tasks_1.manager.save(),"copy-build-notice"(e){e&&Editor.Clipboard.write("text",e)},migrateOptions:async e=>(await(0,migration_1.migrateOptions)(e),e),"preview-pac":async(e,a)=>await worker_1.workerManager.send("build-worker:preview-pac",e,a),"query-atlas-files":async e=>await worker_1.workerManager.send("build-worker:query-atlas-files",e),async"execute-build-stage"(e,a){e&&a&&await tasks_1.manager.add(e,a)},"command-build":(e,a=!1)=>new Promise(async t=>{commandBuildResolve=t,worker_1.workerManager.debug(a);try{await(0,tasks_1.buildWithCommand)(e,t)}catch(e){console.error(e),commandBuildResolve(34)}}),async"programming:pack-build-end"(e){"editor"===e&&(tasks_1.manager.scriptReady=!0)},async createApplicationTemplate(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,a=(0,path_1.join)(e,"templates/launcher/application.ejs"),t=(0,path_1.join)(Editor.Project.path,"build-templates","common",(0,path_1.basename)(a));if((0,fs_1.existsSync)(t)){if(1===(await Editor.Dialog.warn("Do you want to overwrite the source file?",{buttons:["Yes","Cancel"],default:0,cancel:1})).response)return}(0,fs_extra_1.copySync)(a,t),console.log(`builder ${Editor.I18n.t("builder.tips.create_application_template_success")}({link(${t})})`)},"request-to-build-worker":async(e,...a)=>await worker_1.workerManager.send(e,...a),async"preferences-changed"(e,a){switch(e){case"log.level":worker_1.workerManager.send("build-worker:change-log-level",a-0)}},async"query-compress-config"(){const e=await Editor.Profile.getProject("builder","textureCompressConfig.customConfigs"),a=textureCompressConfig.formatsInfo,t={};if(e&&Object.keys(e).length)for(const r of Object.values(e))t[r.id]=Object.assign(Object.assign({},a[r.format]),{displayName:r.name,value:r.id,custom:!0});return Object.assign(Object.assign({},textureCompressConfig),{formatsInfo:Object.assign(Object.assign({},a),t),customFormats:t,platformConfig:plugin_1.pluginManager.getPlatformConfig()})},"query-platform-config":async()=>({order:platforms_options_1.PLATFORMS,config:plugin_1.pluginManager.platformConfig}),"preview-bundle-config":async e=>(0,bundle_utils_1.transformPlatformSettings)(e,plugin_1.pluginManager.getPlatformConfig()),"query-bundle-config":async()=>(0,bundle_utils_1.genBundleRenderConfig)(plugin_1.pluginManager.bundleConfigs,plugin_1.pluginManager.platformMap),"open-platform-debug-tools"(){Editor.Panel.open("builder.platform-debug-tools")},async"asset-db:ready"(){tasks_1.manager.dbReady=!0},"asset-db:close"(){worker_1.workerManager.reset()},"console:update-log-level"(e){Editor.Profile.setConfig("builder","log.level",logLevelMap[e])},"check-and-complete-options":async e=>await plugin_1.pluginManager.checkOptions(e)},exports.load=load,exports.unload=unload;