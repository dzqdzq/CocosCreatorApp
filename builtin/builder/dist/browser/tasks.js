"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkOptionsBeforeCommand=exports.buildWithCommand=exports.manager=exports.TaskManager=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),migration_1=require("./migration"),os=__importStar(require("os")),worker_1=require("./worker"),electron_windows_1=__importDefault(require("@base/electron-windows"));let MainWin;const CRASH_LOG_DIR=(0,path_1.join)(Editor.Project.tmpDir,"builder","crash-log");class TaskItemBase extends events_1.EventEmitter{constructor(e){super(),this.state="waiting",this.progress=0,this.message="",this.time="",this.isCommand=!1,this.free=!0,this.stage="build",this.breakType="",this.dirty=!1,this.id=e||String(Date.now())}async break(e="interrupted"){this.update(1,"failure",`The build task was ${this.breakType||"interrupted"}`),this.breakType=e,"interrupted"!==e&&"cancel"!==e||await worker_1.workerManager.send("build-worker:break",this.id,e),Editor.Message.send("asset-db","resume")}reset(){this.progress=0,this.state="waiting",this.message="",this.breakType="",this.emitChange()}update(e,t,s){this.breakType||(this.progress=Editor.Utils.Math.clamp01(e),this.state="string"==typeof t?t:this.state,this.message="string"==typeof s?s:this.message,["success","failure"].includes(this.state)&&(this.free=!0,"success"!==this.state?this.resolve&&this.resolve(34):this.resolve&&this.resolve(36)),this.emitChange())}emitChange(){this.emit("update",this.id,this.toJSON(),this.free)}}class BuildTaskItem extends TaskItemBase{constructor(e,t,s){super(e),this.dirty=!1,this.type="build",this.options=t,s&&(this.resolve=s)}run(e){return new Promise(async t=>{if("build"!==e)return await this.runBuildStageTask(e),void t();let s;this.stage="build",this.time=(0,utils_1.getCurrentTime)(),console.debug("Check and complete build options",this.options),this.options.taskName||(this.options.taskName=this.options.outputName);try{s=await plugin_1.pluginManager.checkOptions(this.options)}catch(e){console.error(e)}if(!s)return this.update(0,"failure",Editor.I18n.t("builder.error.check_options_failed")),this.resolve&&this.resolve(32),void t();this.options=s,this.dirty=!1,delete this.rawOptions,this.isCommand||this.resolve||(this.resolve=t),this.options.logDest||(this.options.logDest=(0,utils_1.getTaskLogDest)(this.options.platform,this.id));const i=await worker_1.workerManager.send("build-worker:build",this.id,Object.assign({nextStages:this.options.buildStageGroup&&this.options.buildStageGroup.build},this.options),!!this.isCommand);this.state=i?"success":"failure",this.free=!0,t()})}async runBuildStageTask(e){const t=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),this.options.outputName);this.currentStageTask=new StageTaskItem(this.id,e,{root:t,nextStages:this.options.buildStageGroup&&this.options.buildStageGroup[e],platform:this.options.platform,buildTaskOptions:this.options}),this.stage=e;const s=await this.currentStageTask.run(e);this.state=s?"success":"failure",this.free=!0}toJSON(){return{type:"build",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time,dirty:this.dirty,rawOptions:this.rawOptions}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.options=e.options,this.time=e.time?e.time:(0,utils_1.changeToLocalTime)(e.id),this.dirty=e.dirty,this.rawOptions=e.rawOptions}}class StageTaskItem extends TaskItemBase{constructor(e,t,s,i,a=!1){super(e),this.type="stage",this.stage=t,this.options=s,this.isCommand=a,i&&(this.resolve=i)}async run(e){return this.stage=e,this.options.taskId=this.id,this.options.taskName||(this.options.taskName=this.stage+" build"),await worker_1.workerManager.send("build-worker:execute-build-stage",this.stage,this.options)}toJSON(){return{type:"build-stage",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.options=e.options,this.time=e.time?e.time:(0,utils_1.changeToLocalTime)(e.id)}}class BundleTaskItem extends TaskItemBase{constructor(e,t,s){super(e),this.type="bundle",this.options=t,s&&(this.resolve=s)}async run(){if(!this.options.optionList||!this.options.optionList.length)return void console.warn(`Invalid bundle options ${JSON.stringify(this.options)}`);this.options.taskName||(this.options.taskName="Build Bundle");const e=this.options.logDest||(0,utils_1.getTaskLogDest)("build-bundle-",Date.now()),t=this.options.optionList.map(t=>Object.assign(Object.assign({},t),{dest:(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.dest),t.outputName),bundleConfigs:this.options.bundleConfigs,buildBundleOnly:!0,taskName:this.options.taskName,id:this.id,logDest:e}));await worker_1.workerManager.send("build-worker:build-bundles",t)}toJSON(){return{id:this.id,progress:this.progress,state:this.state,message:this.message,options:{dest:this.options.dest,buildTaskIds:this.options.buildTaskIds,taskName:this.options.taskName,bundleConfigs:this.options.bundleConfigs},time:this.time,type:"bundle"}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.message=e.message,this.options=e.options,this.time=e.time?e.time:(0,utils_1.changeToLocalTime)(e.id)}update(e,t,s){super.update(e,t,s)}}class TaskManager extends events_1.EventEmitter{constructor(){super(...arguments),this.command=!1,this.currentTaskId="",this.worker=null,this._workerReady=!1,this._dbReady=!1,this._scriptReady=!1,this.map={},this.waitingTaskIDs=[],this.crashNum=0,this.dbPauseNoticeId=0,this.hasInit=!1}get ready(){return this._workerReady&&this._dbReady&&this._scriptReady}get free(){return TaskManager.supportTaskQueue||!this.waitingTaskIDs.length}set workerReady(e){e!==this._workerReady&&(this._workerReady=e,this.step())}get workerReady(){return this._workerReady}set scriptReady(e){e!==this._scriptReady&&(this._scriptReady=e,this.step())}get scriptReady(){return this._scriptReady}set dbReady(e){e!==this._dbReady&&(this._dbReady=e,e&&worker_1.workerManager.init())}get dbReady(){return this._dbReady}async init(){if(this.hasInit)return;this.dbReady=await Editor.Message.request("asset-db","query-ready"),this.scriptReady=await Editor.Message.request("programming","packer-driver/ready","editor");const e=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.keys(e).sort((e,t)=>e.localeCompare(t,"en",{numeric:!0})).forEach(t=>{const s=e[t];let i;s.options||s.rawOptions?(s.options=s.options||s.rawOptions,"build-stage"!==s.type&&"bundle"!==s.type&&((i=new BuildTaskItem(s.id,s.options)).updateFromJSON(s),i.addListener("update",this._onTaskProgress),1!==s.progress&&(i.state="failure"),1===s.progress&&"processing"===i.state&&(i.state="success"),this.map[s.id]?console.warn("The same task name has exists!"):this.map[s.id]=i)):console.debug("Invalid build task with empty options!")}),plugin_1.pluginManager.packageRegisterInfo.forEach(e=>{this.onAfterPackageRegister(e)}),plugin_1.pluginManager.on("register",this.onAfterPackageRegister),plugin_1.pluginManager.on("unregister",this.onAfterPackageUnRegister),MainWin=electron_windows_1.default.uuid2win[electron_windows_1.default.uuids[0]],this.hasInit=!0}destroy(){this.hasInit=!1,plugin_1.pluginManager.removeListener("register",this.onAfterPackageRegister),plugin_1.pluginManager.removeListener("unregister",this.onAfterPackageUnRegister)}initWorker(e){!this.worker&&e&&(this.worker=e,this.worker.on("refresh",()=>{console.debug("builder refresh"),this.breakAll("refreshed"),Editor.Message.broadcast("build-worker:closed")}),this.worker.on("closed",()=>{this.workerReady=!1,Editor.Message.broadcast("build-worker:closed")}),this.worker.ipc.on("build-worker:update-progress",async(e,t,s,i,a)=>{const o=this.map[t];o&&(o.update(s,i,a),await this.save(),o.isCommand&&console.log(`building ${i} ${(100*o.progress).toFixed(2)}% ${a}`))}),this.worker.ipc.on("build-worker:update-build-stage-progress",async(e,t,s,i,a)=>{if(!t||!this.map[t])return;const o=this.map[t];o.update(s,i,a),await this.save(),o.isCommand&&console.log(`building ${i} ${(100*o.progress).toFixed(2)}% ${a}`)}),this.worker.ipc.on("build-worker:stdout",(e,t,s)=>{t.startsWith("group")&&(t="debug"),console[t](s)}),this.worker.on("render-process-gone",(e,t)=>{this.onProcessGone(e,t)}))}onProcessGone(e,t){if(console.error(Editor.I18n.t("builder.error.builder_crash")),console.error(e,t),worker_1.workerManager.reset(),!this.workerReady)return;this.workerReady=!1;const s=this.map[this.currentTaskId];if(s){const i="crashed"===t.reason||"oom"===t.reason;if(s.break(i?"crashed":"refreshed"),!i)return;this.crashNum++;const a="Builder Process Creashed when build platform: "+s.options.platform;try{const s=(0,path_1.join)(CRASH_LOG_DIR,String(Date.now()));(0,fs_extra_1.outputJSONSync)(s,{type:"render-process-gone",event:e,detail:t,message:a,sysInfo:{freemem:formatByteSize(os.freemem()),totalmem:formatByteSize(os.totalmem())}})}catch(e){console.log(e)}if(this.crashNum>3)return void Editor.Dialog.error(Editor.I18n.t("builder.error.builder_crash"));Editor.Task.addNotice({title:s.options.taskName,message:a,source:"builder",type:"error"}),console.error(a)}}updateTaskInfo(e){if(!(e&&e.id&&e.options&&this.map[e.id]))return;const t=this.map[e.id];t.options=e.options,t.rawOptions=e.rawOptions,t.dirty=e.dirty}async checkCanAddTask(e){return e&&this.waitingTaskIDs.includes(e)?(console.log(Editor.I18n.t("builder.tips.task_exist")),!1):!(this.waitingTaskIDs.length&&!TaskManager.supportTaskQueue)||(console.warn(Editor.I18n.t("builder.tips.task_busy")),!1)}async save(){if(this.command)return;const e={};for(const t of Object.values(this.map)){if(t.options.packages)for(const e of Object.keys(t.options.packages))await Editor.Profile.setConfig(e,`builder.taskOptionsMap.${t.id}`,t.options.packages[e],"local"),await Editor.Profile.setConfig(e,"builder.__version__",require("../../package.json").version,"local");e[t.id]=JSON.parse(JSON.stringify(t.toJSON())),e[t.id].options.packages={}}await Editor.Profile.setConfig("builder","BuildTaskManager.taskMap",e,"local"),await new Promise(e=>{setTimeout(()=>{e()},800)})}async add(e,t,s){return Editor.App.args.build?await this._addTaskInCommand(e,t,s):"build"===e?await this._addBuildTask(t,s):"bundle"===e?await this._addBundleTask(t,s):await this._addStageTask(e,t,s)}async _addBundleTask(e,t){const s=e.id||"buildBundle";if(!await this.checkCanAddTask())return t&&t(37),0;let i=this.map[s];return i&&i instanceof BundleTaskItem?"processing"===i.state&&await i.break("interrupted"):((i=new BundleTaskItem(s,e,t)).addListener("update",(e,t,s)=>{this._onTaskProgress(e,t,s,"builder:bundle-task-changed")}),Editor.Message.broadcast("builder:task-add",i.id,i.toJSON())),i.options=e,this._initBundleTaskOption(i),i.options.optionList.length?(this._addTaskToQueue(i),1):2}_initBundleTaskOption(e){const t=[];e.options.buildTaskIds.forEach(e=>{this.map[e]?t.push(this.map[e].options):console.warn(`Invalid task ${e} in bundle build options`)}),e.options.optionList=JSON.parse(JSON.stringify(t))}async _addBuildTask(e,t){if(!await this.checkCanAddTask())return t&&t(37),0;let s=e.taskId||this._getId();-1!==this.waitingTaskIDs.indexOf(s)&&(s=this._getId(),console.debug(`duplicate build id ${e.taskId} has be overwrite with ${s}`),e.taskId=s);const i=new BuildTaskItem(s,e,t);return i.addListener("update",this._onTaskProgress),this._addTaskToQueue(i),Editor.Message.broadcast("builder:task-add",i.id,i.toJSON()),1}async _addStageTask(e,t,s){const i=t.taskId;if(!i||!this.map[i])return console.error("Please run build task first!"),s&&s(32),2;if(this.waitingTaskIDs.includes(i))return console.error("Build task is busy!"),s&&s(37),0;const a=this.map[i];return a.stage=e,Editor.Message.broadcast("builder:task-add",a.id,a.toJSON()),this._addTaskToQueue(a),1}async _addTaskInCommand(e,t,s){const i=t.taskId||this._getId(),a=this.waitingTaskIDs.indexOf(i);let o;if(-1!==a&&(console.debug("duplicate build id will be remove from this.waitingTaskIDs"),this.waitingTaskIDs.splice(a,1)),"build"===e){const e=t.platform;if(!await plugin_1.pluginManager.checkPlatformsInformation(e,exports.manager.command))return console.warn(Editor.I18n.t("builder.tips.platformInformationInvalid",{platform:e})),s&&s(34),2;(o=new BuildTaskItem(i,t,s)).addListener("update",this._onTaskProgress)}else if("bundle"===e)(o=new BundleTaskItem("buildBundle",t,s)).addListener("update",(e,t,s)=>{this._onTaskProgress(e,t,s,"builder:bundle-task-changed")}),this._initBundleTaskOption(o);else{let i=t.taskId;(o=i&&this.map[i])||(i=i||this._getId(),(o=new StageTaskItem(i,e,t,s)).addListener("update",this._onTaskProgress),this.map[i]=o),o.stage=e}return this._addTaskToQueue(o),1}_addTaskToQueue(e){this.waitingTaskIDs.push(e.id),this.map[e.id]=e,e.update(0,"waiting","Wait a moment, build task is busy"),this.step()}async remove(e,t){if(!this.map[e])return!1;const s=this.map[e];if(this.currentTaskId===e&&await this.break(e,"interrupted"),t)try{const{buildPath:t,outputName:s}=this.map[e].options;t&&s?(0,fs_extra_1.removeSync)((0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(t),s)):console.warn(`Package ${s} has invalid options.`)}catch(e){return console.error("Remove build task failed!"),console.error(e),!1}delete this.map[e],Editor.Message.broadcast("builder:task-delete",s.id,s.toJSON());const i=this.waitingTaskIDs.indexOf(e);-1!==i&&this.waitingTaskIDs.splice(i,1),await this.save();try{const e=Editor.UI.__protected__.File.resolveToRaw(s.options.logDest||(0,utils_1.getTaskLogDest)(s.options.platform,s.id));(0,fs_extra_1.existsSync)(e)&&(0,fs_extra_1.removeSync)(e)}catch(e){console.debug(e)}return!0}queryTaskInfo(e){const t=this.map[e];return t?t.toJSON():null}async recompile(e,t,s){const i=this.map[e];return i?await this.checkCanAddTask(e)?(i.removeAllListeners(),i.addListener("update",this._onTaskProgress),i.breakType="",i.resolve=s,i.options=t||i.options,i.stage="build",i.update(0,"waiting","Wait a moment, build task is busy"),this.waitingTaskIDs.push(e),this.currentTaskId?void 0:await this.step()):37:32}async break(e,t){this.currentTaskId===e?(this.currentTaskId="",await this.map[e].break(t)):this.waitingTaskIDs.includes(e)&&(this.waitingTaskIDs.splice(this.waitingTaskIDs.findIndex(t=>e===t),1),this.map[e].update(0,"cancel",Editor.I18n.t("builder.tips.buildTaskCanceled")))}async breakAll(e){await Promise.all(this.waitingTaskIDs.map(t=>{const s=this.map[t];if(s.free=!0,"processing"===s.state)return!this.command||this.currentTaskId===s.id&&this.command?s.break(e):void 0})),this.currentTaskId="",this.waitingTaskIDs=[],Editor.Message.broadcast("builder:task-changed")}async step(){if(0===this.waitingTaskIDs.length)return;const e=this.waitingTaskIDs[0],t=this.map[e];t&&t.free&&(this.ready?(t.free=!1,t.reset(),this.currentTaskId=e,await t.run(t.stage),await this.save(),"success"===t.state&&(this.crashNum=0),this.waitingTaskIDs.shift(),this.currentTaskId="",t.free=!0,await this.step()):t.update(0,"waiting","Wait Asset DB or Builder worker ready"))}_getId(){return String((new Date).getTime())}_onTaskProgress(e,t,s,i="builder:task-changed"){if(MainWin&&MainWin.setProgressBar(t.progress),["success","failure"].includes(t.state)){MainWin&&MainWin.setProgressBar(-1),Editor.Task.removeNotice(this.dbPauseNoticeId);const e=[{label:"i18n:builder.notice.copyMessage",target:"builder",message:"copy-build-notice",params:[t.message]}];"build"===t.type&&e.unshift({label:"i18n:builder.notice.open",target:"builder",message:"open",params:["","highlight",t.id]}),Editor.Task.addNotice({title:t.options.taskName,message:t.message,source:"i18n:builder.title",type:"success"===t.state?"success":"error",buttons:e})}Editor.Message.broadcast(i,e,t,TaskManager.supportTaskQueue||s)}async onAfterPackageRegister(e){const t=await Editor.Profile.getConfig(e.name,"","local");t.builder=t.builder||{};let s=!1;if(t.common&&!t.builder.common&&(t.builder.common=t.common,delete t.common,s=!0),t.options&&!t.builder.options&&(t.builder.options=t.options,delete t.options,s=!0),s&&await Editor.Profile.setConfig(e.name,"",t,"local"),t.builder.taskOptionsMap&&Object.keys(t.builder.taskOptionsMap).length)for(const s of Object.keys(t.builder.taskOptionsMap)){const i=exports.manager.map[s];if(!i){delete exports.manager.map[s];continue}const a=t.builder.taskOptionsMap[s];a&&(i.options.packages=i.options.packages||{},i.options.packages[e.name]=a,Editor.Message.broadcast("builder:task-changed",s,i.toJSON(),TaskManager.supportTaskQueue||this.free))}}async onAfterPackageUnRegister(e){for(const t of Object.keys(exports.manager.map)){const s=exports.manager.map[t];s.options.packages&&s.options.packages[e.name]&&(await Editor.Profile.setConfig(e.name,`builder.taskOptionsMap.${t}}`,s.options.packages[e.name]),await Editor.Profile.setConfig(e.name,"builder.__version__",require("../../package.json").version),delete s.options.packages[e.name],Editor.Message.broadcast("builder:task-changed",t,s.toJSON(),TaskManager.supportTaskQueue||this.free))}}}async function buildWithCommand(e,t){console.debug(`Start enter command build with options ${JSON.stringify(e)}`);const s=await checkOptionsBeforeCommand(e);if(s){if(plugin_1.pluginManager.disablePlatforms.includes(s.platform))return console.error(Editor.I18n.t("builder.tips.disablePlatformForBuildCommand",{platform:s.platform})),void t(34);if(await checkProjectSettingsBeforeCommand(e),"bundle"!==e.stage)if(e.stage&&"build"!==e.stage){const s=e.root||(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e.buildPath),e.outputName);exports.manager.add(e.stage,{platform:e.platform,root:s,nextStages:e.nextStages||e.buildStageGroup&&e.buildStageGroup[e.stage],buildTaskOptions:e},t)}else exports.manager.command=!0,exports.manager.add("build",e,t);else exports.manager.add("bundle",e,t)}else t(32)}async function checkProjectSettingsBeforeCommand(e){var t,s,i,a,o,r,n,d,u,l,p,c;if(e.projectSettingsPath){if(!(0,fs_extra_1.existsSync)(e.projectSettingsPath))return void console.error(`${e.projectSettingsPath} is not exist!`);const h=await Editor.Message.request("project","query-configs-from-path",e.projectSettingsPath);if(!e.includeModules&&(null===(s=null===(t=h.engine)||void 0===t?void 0:t.modules)||void 0===s?void 0:s.includeModules)&&(e.includeModules=h.engine.modules.includeModules||[]),!e.designResolution&&(null===(a=null===(i=h.project)||void 0===i?void 0:i.general)||void 0===a?void 0:a.designResolution)&&(e.designResolution=h.project.general.designResolution),!e.renderPipeline&&(null===(r=null===(o=h.project)||void 0===o?void 0:o.general)||void 0===r?void 0:r.renderPipeline)&&(e.renderPipeline=h.project.general.renderPipeline),!e.physicsConfig&&(null===(n=h.project)||void 0===n?void 0:n.physics)&&(e.physicsConfig=h.project.physics,e.physicsConfig.defaultMaterial||(e.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448")),!e.flags&&(null===(u=null===(d=h.engine)||void 0===d?void 0:d.modules)||void 0===u?void 0:u.flags)){e.flags={};const t=null===(p=null===(l=h.engine)||void 0===l?void 0:l.modules)||void 0===p?void 0:p.flags;t&&Object.keys(t).length&&Object.keys(t).forEach(s=>{e.includeModules&&e.includeModules.includes(s)&&e.flags&&Object.assign(e.flags,t[s])})}if(!e.customLayers&&(null===(c=h.project)||void 0===c?void 0:c.layer)&&(e.customLayers=h.project.layer),!e.sortingLayers&&h.project&&h.project["sorting-layer"]){const t=h.project["sorting-layer"]||{};e.sortingLayers=t.layers||[]}}}async function checkOptionsBeforeCommand(e){if("string"==typeof e.scenes){e.scenes=e.scenes.split(",");const t=[];for(const s of e.scenes){const e=await Editor.Message.request("asset-db","query-asset-info",s.trim());e&&t.push({uuid:s,url:e.url})}e.scenes=t}if(e.configPath){if(!(0,fs_extra_1.existsSync)(e.configPath))return console.error(`${e.configPath} is not exist!`),null;console.debug(`Read config from path ${e.configPath}...`);let t=(0,fs_extra_1.readJSONSync)(e.configPath);t=Object.assign(t,e),Object.assign(e,t),delete e.configPath}if(e.packages&&"string"==typeof e.packages)try{e.packages=JSON.parse(e.packages)}catch(t){e.packages={}}return!1===e.migrate||e.stage&&"build"!==e.stage||await(0,migration_1.migrateOptions)(e,!0),e.platform||(e.platform=await Editor.Profile.getConfig("builder","common.platform")),e.outputName||(e.outputName=e.platform),e.taskName||(e.taskName=e.outputName),e}function formatByteSize(e){return(e/1024/1024).toFixed(2)+"MB"}exports.TaskManager=TaskManager,TaskManager.supportTaskQueue=!0,exports.manager=new TaskManager,exports.buildWithCommand=buildWithCommand,exports.checkOptionsBeforeCommand=checkOptionsBeforeCommand;