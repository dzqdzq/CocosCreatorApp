"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildWithCommand=exports.manager=exports.TaskManager=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),migration_1=require("./migration"),common_options_validator_1=require("../share/common-options-validator"),worker=require("@base/electron-worker");class TaskItem{constructor(e,s,t,i=!1){this.state="waiting",this.progress=0,this.message="",this.time="",this.dirty=!1,this.isCommandBuild=!1,this.free=!0,this.type="build",this.breakType="",this.options=s,this.id=e||String(Date.now()),this.isCommandBuild=i,t&&(this.resolve=t)}build(){return new Promise(async e=>{let s;this.time=utils_1.getCurrentTime(),console.debug("Check and complete build options",this.options);let t=!0;try{const e=await common_options_validator_1.checkBuildCommondOptions(this.options);for(const s of Object.keys(e)){const i=e[s].newValue;e[s].error&&(null!==i?console.warn(e[s].error,`will use the new value ${e[s].newValue}`):(console.error(e[s].error),t=!1)),null!==i&&void 0!==i&&(this.options[s]=i)}s=await plugin_1.pluginManager.checkOptions(this.options)}catch(e){console.error(e)}if(!s||!t)return this.update(0,"failure",Editor.I18n.t("builder.error.check_options_failed")),this.resolve&&this.resolve(32),void e();this.options=s,this.dirty=!1,delete this.rawOptions;const i=worker.query("Build");this.isCommandBuild||this.resolve||(this.resolve=e);const a=await i.send("build-worker:build",this.id,this.options,!!this.isCommandBuild);this.state=a?"success":"failure",this.free=!0,e()})}async compile(){this.dirty=!1,this.time=utils_1.getCurrentTime();const e=worker.query("Build"),s=path_1.join(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName);await e.send("build-worker:compile",s,this.id,!!this.isCommandBuild)}break(e){this.breakType=e?"crashed":"",this.message=`The build process was ${this.breakType||"interrupted"}`,this.state="failure",this.free=!0,this.emitChange()}reset(){this.progress=0,this.state="waiting",this.message="",this.emitChange()}update(e,s,t){this.progress=Editor.Utils.Math.clamp01(e),this.state="string"==typeof s?s:this.state,this.message="string"==typeof t?t:this.message,["success","failure"].includes(this.state)&&(Editor.Task.addNotice({title:this.options.outputName,message:this.time+" "+this.message,source:"builder",type:"success"===this.state?"success":"error"}),this.free=!0,"success"!==this.state?this.resolve&&this.resolve(34):this.resolve&&this.resolve(36)),this.emitChange()}toJSON(){return{id:this.id,progress:this.progress,state:this.state,message:this.message,options:this.options,time:this.time,dirty:this.dirty,rawOptions:this.rawOptions}}emitChange(){Editor.Message.broadcast("builder:task-changed",this.id,this.toJSON(),TaskManager.supportTaskQueue||this.free)}}class TaskManager extends events_1.EventEmitter{constructor(){super(...arguments),this.command=!1,this.currentTaskId="",this.hasBuildNum=0,this.workerReady=!1,this.dbReady=!1,this.scriptReady=!1,this.queue=[],this.map={},this.waitingTaskIDs=[],this.crashNum=0}get ready(){return this.workerReady&&this.dbReady}get free(){return TaskManager.supportTaskQueue||!this.waitingTaskIDs.length}async init(){const e=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.keys(e).sort((e,s)=>e.localeCompare(s,"en",{numeric:!0})).forEach(s=>{const t=e[s],i=new TaskItem(t.id,t.options);i.state=t.state||"waiting",1!==t.progress&&(i.state="failure"),i.rawOptions=t.rawOptions,i.progress=t.progress,i.message=t.message,i.time=t.time?t.time:utils_1.changeToLocalTime(t.id),this.map[t.id]?console.warn("The same task name has exists!"):(this.map[t.id]=i,this.queue.push(i))})}waitingForReady(){return new Promise(e=>{if(isM1()&&this.hasBuildNum){const s=worker.query("Build");this.waitingForReadyResolve=e,s.win.webContents.reload()}else this.waitingForReadyResolve=null,e()})}async checkCanAddTask(e){if(e&&this.waitingTaskIDs.includes(e))return console.log(Editor.I18n.t("builder.tips.task_exist")),!1;if(this.waitingTaskIDs.length&&!TaskManager.supportTaskQueue)return console.warn(Editor.I18n.t("builder.tips.task_busy")),!1;if(!this.command){if(!await checkSceneSaved())return!1}return!0}async save(){if(this.command)return;const e={};this.queue.map(s=>{e[s.id]=s.toJSON()}),await Editor.Profile.setConfig("builder","BuildTaskManager.taskMap",e,"local"),await new Promise(e=>{setTimeout(()=>{e()},800)})}async push(e,s,t){if(!await this.checkCanAddTask())return;const i=e.id||this._getId(),a=this.queue.indexOf(this.map[i]);-1!==a&&this.queue.splice(a,1);const r=new TaskItem(i,e,s,t);r.type="build",this.map[i]=r,this.queue.push(r),this.waitingTaskIDs.push(i),await this.step()}async pop(e){if(!this.map[e])return;const s=this.map[e];delete this.map[e];const t=this.queue.indexOf(s);-1!==t&&this.queue.splice(t,1);const i=this.waitingTaskIDs.indexOf(e);-1!==i&&this.waitingTaskIDs.splice(i,1),await this.save(),fs_extra_1.removeSync(path_1.join(Editor.Project.path,"temp","build-log",s.id+".log")),Editor.Message.broadcast("builder:task-changed",e,null)}async recompile(e,s,t){if(!await this.checkCanAddTask(e))return;const i=this.map[e];i&&(this.waitingTaskIDs.includes(e)?i.update(0,"waiting","Wait a moment, build task is busy"):(i.resolve=t,i.options=s||i.options,i.type="build",this.waitingTaskIDs.push(e),this.currentTaskId||await this.step()))}async compile(e,s){if(!await this.checkCanAddTask(e))return;if(!this.map[e])return;if(this.waitingTaskIDs.includes(e))return void console.log("Wait a moment, build task is busy");this.map[e].type="compile",this.waitingTaskIDs.push(e),await this.step()}async run(e){this.map[e]}break(e){this.currentTaskId="",!e&&this.waitingForReadyResolve||(this.queue.forEach(s=>{s.free=!0,1!==s.progress&&(!this.command||this.currentTaskId===s.id&&this.command)&&s.break(e)}),this.waitingTaskIDs=[],Editor.Message.broadcast("builder:task-changed"))}async step(){if(0===this.waitingTaskIDs.length||!this.ready)return;const e=this.waitingTaskIDs[0],s=this.map[e];s&&s.free&&(this.ready?(s.free=!1,s.reset(),this.currentTaskId=e,"build"===s.type?await s.build():await s.compile(),this.hasBuildNum++,await this.save(),"success"===s.state&&(this.crashNum=0),this.waitingTaskIDs.shift(),this.currentTaskId="",s.free=!0,await this.step()):s.update(0,"waiting","Wait DB or worker ready"))}_getId(){return String((new Date).getTime())}}async function buildWithCommand(e,s){if(e.configPath){if(!fs_extra_1.existsSync(e.configPath))return console.error(`${e.configPath} is not exist!`),void(s&&s(32));const t=fs_extra_1.readJSONSync(e.configPath);e=Object.assign(e,t)}if(e.packages&&"string"==typeof e.packages)try{e.packages=JSON.parse(e.packages)}catch(s){e.packages={}}if(!e.platform)return console.error("build failed! Please to specify a packaging platform"),void(s&&s(32));!1!==e.migrate&&await migration_1.migrateOptions(e);const t=await common_options_validator_1.checkBuildCommonOptionsByKey("buildPath",e.buildPath,e);if(t.error&&!t.newValue)return console.error(t.error),void(s&&s(32));e.buildPath=t.newValue,e.outputName||(e.outputName=e.platform),exports.manager.command=!0,exports.manager.push(e,s,!0)}function isM1(){const e=require("os").cpus(),s=e&&e[0]&&e[0].model?e[0].model:"";return/Apple/.test(s)}async function checkSceneSaved(){if(await Editor.Message.request("scene","query-dirty")){const e=Editor.I18n.t,s=await Editor.Dialog.warn(e("builder.is_save_scene.message"),{title:e("builder.is_save_scene.title"),default:0,cancel:1,buttons:[e("builder.is_save_scene.save"),e("builder.is_save_scene.ignore"),e("builder.is_save_scene.cancel")]});if(2===s.response)return!1;0===s.response&&await Editor.Message.request("scene","save-scene")}return!0}exports.TaskManager=TaskManager,TaskManager.supportTaskQueue=!1,exports.manager=new TaskManager,exports.buildWithCommand=buildWithCommand;