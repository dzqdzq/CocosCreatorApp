"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkOptionsBeforeCommand=exports.buildWithCommand=exports.manager=exports.TaskManager=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),migration_1=require("./migration"),os=__importStar(require("os")),worker_1=require("./worker"),metric_1=require("./metric"),winManager=require("@base/electron-windows");let MainWin;const CRASH_LOG_DIR=(0,path_1.join)(Editor.Project.tmpDir,"builder","crash-log");class TaskItemBase extends events_1.EventEmitter{constructor(e){super(),this.state="waiting",this.progress=0,this.message="",this.time="",this.isCommand=!1,this.free=!0,this.stage="build",this.breakType="",this.dirty=!1,this.id=e||String(Date.now())}async break(e="interrupted"){this.update(1,"failure",`The build task was ${this.breakType||"interrupted"}`),this.breakType=e,"interrupted"!==e&&"cancel"!==e||await worker_1.workerManager.send("build-worker:break",this.id,e),Editor.Message.send("asset-db","resume")}reset(){this.progress=0,this.state="waiting",this.message="",this.breakType="",this.emitChange()}update(e,t,s){this.breakType||(this.progress=Editor.Utils.Math.clamp01(e),this.state="string"==typeof t?t:this.state,this.message="string"==typeof s?s:this.message,["success","failure"].includes(this.state)&&(this.free=!0,"success"!==this.state?this.resolve&&this.resolve(34):this.resolve&&this.resolve(36)),this.emitChange())}emitChange(){this.emit("update",this.id,this.toJSON(),this.free)}}class BuildTaskItem extends TaskItemBase{constructor(e,t,s){super(e),this.dirty=!1,this.options=t,s&&(this.resolve=s)}run(e){return new Promise(async t=>{if("build"!==e)return await this.runBuildStageTask(e),void t();let s;this.stage="build",this.time=(0,utils_1.getCurrentTime)(),console.debug("Check and complete build options",this.options);try{s=await plugin_1.pluginManager.checkOptions(this.options)}catch(e){console.error(e)}if(!s)return this.update(0,"failure",Editor.I18n.t("builder.error.check_options_failed")),this.resolve&&this.resolve(32),void t();this.options=s,this.dirty=!1,delete this.rawOptions,this.isCommand||this.resolve||(this.resolve=t);const i=await worker_1.workerManager.send("build-worker:build",this.id,Object.assign({nextStages:this.options.buildStageGroup&&this.options.buildStageGroup.build},this.options),!!this.isCommand);this.state=i?"success":"failure",this.free=!0,t()})}async runBuildStageTask(e){const t=(0,path_1.join)(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName);this.currentStageTask=new StageTaskItem(this.id,e,{root:t,nextStages:this.options.buildStageGroup&&this.options.buildStageGroup[e],platform:this.options.platform,buildTaskOptions:this.options}),this.stage=e;const s=await this.currentStageTask.run(e);this.state=s?"success":"failure",this.free=!0}toJSON(){return{type:"build",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time,dirty:this.dirty,rawOptions:this.rawOptions}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.options=e.options,this.time=e.time?e.time:(0,utils_1.changeToLocalTime)(e.id),this.dirty=e.dirty,this.rawOptions=e.rawOptions}}class StageTaskItem extends TaskItemBase{constructor(e,t,s,i,a=!1){super(e),this.stage=t,this.options=s,this.isCommand=a,i&&(this.resolve=i)}async run(e){return this.stage=e,this.options.taskId=this.id,await worker_1.workerManager.send("build-worker:excute-build-stage",this.stage,this.options)}toJSON(){return{type:"build-stage",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time}}updateFromJSON(e){this.id=e.id,this.progress=e.progress,this.state=e.state||"waiting",this.stage=e.stage,this.message=e.message,this.options=e.options,this.time=e.time?e.time:(0,utils_1.changeToLocalTime)(e.id)}}class TaskManager extends events_1.EventEmitter{constructor(){super(...arguments),this.command=!1,this.currentTaskId="",this.worker=null,this._workerReady=!1,this._dbReady=!1,this._scriptReady=!1,this.map={},this.waitingTaskIDs=[],this.crashNum=0,this.dbPauseNoticeId=0,this.hasInit=!1}get ready(){return this._workerReady&&this._dbReady&&this._scriptReady}get free(){return TaskManager.supportTaskQueue||!this.waitingTaskIDs.length}set workerReady(e){e!==this._workerReady&&(this._workerReady=e,this.step())}get workerReady(){return this._workerReady}set scriptReady(e){e!==this._scriptReady&&(this._scriptReady=e,this.step())}get scriptReady(){return this._scriptReady}set dbReady(e){e!==this._dbReady&&(this._dbReady=e,e&&worker_1.workerManager.init())}get dbReady(){return this._dbReady}async init(){if(this.hasInit)return;this.dbReady=await Editor.Message.request("asset-db","query-ready"),this.scriptReady=await Editor.Message.request("programming","packer-driver/ready","editor");const e=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.keys(e).sort((e,t)=>e.localeCompare(t,"en",{numeric:!0})).forEach(t=>{const s=e[t];let i;s.options||s.rawOptions?(s.options=s.options||s.rawOptions,"build-stage"!==s.type&&((i=new BuildTaskItem(s.id,s.options)).updateFromJSON(s),i.addListener("update",this._onTaskProgress),1!==s.progress&&(i.state="failure"),1===s.progress&&"processing"===i.state&&(i.state="success"),this.map[s.id]?console.warn("The same task name has exists!"):this.map[s.id]=i)):console.debug("Invalid build task with empty options!")}),plugin_1.pluginManager.packageRegisterInfo.forEach(e=>{this.onAfterPackageRegister(e)}),plugin_1.pluginManager.on("register",this.onAfterPackageRegister),plugin_1.pluginManager.on("unregister",this.onAfterPackageUnRegister),MainWin=winManager.uuid2win[winManager.uuids[0]],this.hasInit=!0}destroy(){this.hasInit=!1,plugin_1.pluginManager.removeListener("register",this.onAfterPackageRegister),plugin_1.pluginManager.removeListener("unregister",this.onAfterPackageUnRegister)}initWorker(e){!this.worker&&e&&(this.worker=e,this.worker.on("refresh",()=>{console.debug("builder refresh"),this.breakAll("refreshed"),Editor.Message.broadcast("build-worker:closed")}),this.worker.on("closed",()=>{this.workerReady=!1,Editor.Message.broadcast("build-worker:closed")}),this.worker.on("build-worker:update-progress",async(e,t,s,i,a)=>{const r=this.map[t];r&&(r.update(s,i,a),await this.save(),r.isCommand&&console.log(`building...${(100*r.progress).toFixed(2)}% ${a}`))}),this.worker.on("build-worker:update-build-stage-progress",async(e,t,s,i,a)=>{if(!t||!this.map[t])return;this.map[t].update(s,i,a),await this.save()}),this.worker.on("build-worker:add-statistics",async(e,t)=>{(0,metric_1.sendBuildMetric)(t)}),this.worker.on("build-worker:stdout",(e,t,s)=>{t.startsWith("group")&&(t="debug"),console[t](s)}),this.worker.on("render-process-gone",(e,t)=>{this.onProcessGone(e,t)}))}onProcessGone(e,t){if(console.error(Editor.I18n.t("builder.error.builder_crash")),console.error(e,t),worker_1.workerManager.reset(),!this.workerReady)return;this.workerReady=!1;const s=this.map[this.currentTaskId];if(s){const i="crashed"===t.reason||"oom"===t.reason;if(s.break(i?"crashed":"refreshed"),!i)return;this.crashNum++;const a="Builder Process Creashed when build platform: "+s.options.platform;try{const s=(0,path_1.join)(CRASH_LOG_DIR,String(Date.now()));(0,fs_extra_1.outputJSONSync)(s,{type:"render-process-gone",event:e,detail:t,message:a,sysInfo:{freemem:formatByteSize(os.freemem()),totalmem:formatByteSize(os.totalmem())}})}catch(e){console.log(e)}if(this.crashNum>3)return void Editor.Dialog.error(Editor.I18n.t("builder.error.builder_crash"));Editor.Task.addNotice({title:s.options.outputName,message:a,source:"builder",type:"error"}),console.error(a)}}updateTaskInfo(e){if(!(e&&e.id&&e.options&&this.map[e.id]))return;const t=this.map[e.id];t.options=e.options,t.rawOptions=e.rawOptions,t.dirty=e.dirty}async checkCanAddTask(e){return e&&this.waitingTaskIDs.includes(e)?(console.log(Editor.I18n.t("builder.tips.task_exist")),!1):!(this.waitingTaskIDs.length&&!TaskManager.supportTaskQueue)||(console.warn(Editor.I18n.t("builder.tips.task_busy")),!1)}async save(){if(this.command)return;const e={};for(const t of Object.values(this.map)){if(t.options.packages)for(const e of Object.keys(t.options.packages))await Editor.Profile.setConfig(e,`builder.taskOptionsMap.${t.id}`,t.options.packages[e],"local"),await Editor.Profile.setConfig(e,"builder.__version__",require("../../package.json").version,"local");e[t.id]=JSON.parse(JSON.stringify(t.toJSON())),e[t.id].options.packages={}}await Editor.Profile.setConfig("builder","BuildTaskManager.taskMap",e,"local"),await new Promise(e=>{setTimeout(()=>{e()},800)})}async add(e,t,s){return await plugin_1.pluginManager.checkPlatformsInformation(t.platform,exports.manager.command)?Editor.App.args.command?await this._addTaskInCommand(e,t,s):"build"===e?await this._addBuildTask(t,s):await this._addStageTask(e,t,s):(console.warn(Editor.I18n.t("builder.tips.invalidPlatformInformation")),s&&s(34),null)}async _addBuildTask(e,t){if(!await this.checkCanAddTask())return t&&t(37),null;let s=e.taskId||this._getId();-1!==this.waitingTaskIDs.indexOf(s)&&(s=this._getId(),console.debug(`duplicate build id ${e.taskId} has be overwrite with ${s}`),e.taskId=s);const i=new BuildTaskItem(s,e,t);return i.addListener("update",this._onTaskProgress),this._addTaskToQueue(i),i}async _addStageTask(e,t,s){const i=t.taskId;if(!i||!this.map[i])return console.error("Please run build task first!"),s&&s(32),null;if(this.waitingTaskIDs.includes(i))return console.error("Build task is busy!"),s&&s(37),null;const a=this.map[i];return a.stage=e,this._addTaskToQueue(a),a}async _addTaskInCommand(e,t,s){const i=t.taskId||this._getId(),a=this.waitingTaskIDs.indexOf(i);let r;if(-1!==a&&(console.debug("duplicate build id will be remove from this.waitingTaskIDs"),this.waitingTaskIDs.splice(a,1)),"build"===e)(r=new BuildTaskItem(i,t,s)).addListener("update",this._onTaskProgress);else{let i=t.taskId;(r=i&&this.map[i])||(i=i||this._getId(),(r=new StageTaskItem(i,e,t,s)).addListener("update",this._onTaskProgress),this.map[i]=r),r.stage=e}return this._addTaskToQueue(r),r}_addTaskToQueue(e){this.waitingTaskIDs.push(e.id),this.map[e.id]=e,e.update(0,"waiting","Wait a moment, build task is busy"),this.step()}async remove(e,t){if(!this.map[e])return!1;const s=this.map[e];if(this.currentTaskId===e&&await this.break(e,"interrupted"),t)try{const{buildPath:t,outputName:s,platform:i}=this.map[e].options;t&&s?(0,fs_extra_1.removeSync)((0,path_1.join)(Editor.UI.File.resolveToRaw(t),s)):console.warn(`Package ${s} has invalid options.`);const a=(0,path_1.join)(Editor.Project.tmpDir,"builder","log",i+(0,utils_1.changeToLocalTime)(e).replace(":","-")+".log");(0,fs_extra_1.existsSync)(a)&&(0,fs_extra_1.removeSync)(a)}catch(e){return console.error("Remove build task failed!"),console.error(e),!1}delete this.map[e];const i=this.waitingTaskIDs.indexOf(e);-1!==i&&this.waitingTaskIDs.splice(i,1),await this.save();const a=(0,path_1.join)(Editor.Project.tmpDir,"builder","log",s.options.platform+(0,utils_1.changeToLocalTime)(e).replace(":","-")+".log");return(0,fs_extra_1.existsSync)(a)&&(0,fs_extra_1.removeSync)(a),Editor.Message.broadcast("builder:task-changed",e,null),!0}queryTaskInfo(e){const t=this.map[e];return t?t.toJSON():null}async recompile(e,t,s){const i=this.map[e];return i?await this.checkCanAddTask(e)?await plugin_1.pluginManager.checkPlatformsInformation(t.platform,exports.manager.command)?(i.removeAllListeners(),i.addListener("update",this._onTaskProgress),i.breakType="",i.resolve=s,i.options=t||i.options,i.stage="build",i.update(0,"waiting","Wait a moment, build task is busy"),this.waitingTaskIDs.push(e),this.currentTaskId?void 0:await this.step()):(console.warn(Editor.I18n.t("builder.tips.invalidPlatformInformation")),34):37:32}async break(e,t){this.waitingTaskIDs.includes(e)&&(this.currentTaskId===e?(this.currentTaskId="",await this.map[e].break(t)):(this.waitingTaskIDs.splice(this.waitingTaskIDs.findIndex(t=>e===t),1),this.map[e].update(0,"cancel",Editor.I18n.t("builder.tips.buildTaskCanceled"))))}async breakAll(e){await Promise.all(this.waitingTaskIDs.map(t=>{const s=this.map[t];if(s.free=!0,1!==s.progress)return!this.command||this.currentTaskId===s.id&&this.command?s.break(e):void 0})),this.waitingTaskIDs=[],Editor.Message.broadcast("builder:task-changed")}async step(){if(0===this.waitingTaskIDs.length||!this.ready)return;const e=this.waitingTaskIDs[0],t=this.map[e];t&&t.free&&(this.ready?(t.free=!1,t.reset(),this.currentTaskId=e,await t.run(t.stage),await this.save(),"success"===t.state&&(this.crashNum=0),this.waitingTaskIDs.shift(),this.currentTaskId="",t.free=!0,await this.step()):t.update(0,"waiting","Wait Asset DB or Builder worker ready"))}_getId(){return String((new Date).getTime())}_onTaskProgress(e,t,s){MainWin&&MainWin.setProgressBar(t.progress),["success","failure"].includes(t.state)&&(MainWin&&MainWin.setProgressBar(-1),Editor.Task.removeNotice(this.dbPauseNoticeId),Editor.Task.addNotice({title:t.options.outputName,message:t.message,source:Editor.I18n.t("builder.title"),type:"success"===t.state?"success":"error"})),Editor.Message.broadcast("builder:task-changed",e,t,TaskManager.supportTaskQueue||s)}async onAfterPackageRegister(e){const t=await Editor.Profile.getConfig(e.name,"","local");t.builder=t.builder||{};let s=!1;if(t.common&&!t.builder.common&&(t.builder.common=t.common,delete t.common,s=!0),t.options&&!t.builder.options&&(t.builder.options=t.options,delete t.options,s=!0),s&&await Editor.Profile.setConfig(e.name,"",t,"local"),t.builder.taskOptionsMap&&Object.keys(t.builder.taskOptionsMap).length)for(const s of Object.keys(t.builder.taskOptionsMap)){const i=exports.manager.map[s];if(!i){delete exports.manager.map[s];continue}const a=t.builder.taskOptionsMap[s];a&&(i.options.packages=i.options.packages||{},i.options.packages[e.name]=a,Editor.Message.broadcast("builder:task-changed",s,i.toJSON(),TaskManager.supportTaskQueue||this.free))}}async onAfterPackageUnRegister(e){for(const t of Object.keys(exports.manager.map)){const s=exports.manager.map[t];s.options.packages&&s.options.packages[e.name]&&(await Editor.Profile.setConfig(e.name,`builder.taskOptionsMap.${t}}`,s.options.packages[e.name]),await Editor.Profile.setConfig(e.name,"builder.__version__",require("../../package.json").version),delete s.options.packages[e.name],Editor.Message.broadcast("builder:task-changed",t,s.toJSON(),TaskManager.supportTaskQueue||this.free))}}}async function buildWithCommand(e,t){console.debug(`Start enter command build with options ${JSON.stringify(e)}`);const s=await checkOptionsBeforeCommand(e);if(s){if(plugin_1.pluginManager.disablePlatforms.includes(s.platform))return console.error(Editor.I18n.t("builder.tips.disablePlatformForBuildCommand",{platform:s.platform})),void t(34);if(e.stage&&"build"!==e.stage){const s=e.root||(0,path_1.join)(Editor.UI.File.resolveToRaw(e.buildPath),e.outputName);exports.manager.add(e.stage,{platform:e.platform,root:s,nextStages:e.nextStages||e.buildStageGroup&&e.buildStageGroup[e.stage],buildTaskOptions:e},t)}else exports.manager.command=!0,exports.manager.add("build",e,t)}else t(32)}async function checkOptionsBeforeCommand(e){if("string"==typeof e.scenes){e.scenes=e.scenes.split(",");const t=[];for(const s of e.scenes){const e=await Editor.Message.request("asset-db","query-asset-info",s.trim());e&&t.push({uuid:s,url:e.url})}e.scenes=t}if(e.configPath){if(!(0,fs_extra_1.existsSync)(e.configPath))return console.error(`${e.configPath} is not exist!`),null;console.debug(`Read config from path ${e.configPath}...`);let t=(0,fs_extra_1.readJSONSync)(e.configPath);t=Object.assign(t,e),Object.assign(e,t),delete e.configPath}if(e.packages&&"string"==typeof e.packages)try{e.packages=JSON.parse(e.packages)}catch(t){e.packages={}}return!1!==e.migrate&&await(0,migration_1.migrateOptions)(e,!0),e.platform||(e.platform=await Editor.Profile.getConfig("builder","common.platform")),e.outputName||(e.outputName=e.platform),e}function formatByteSize(e){return(e/1024/1024).toFixed(2)+"MB"}exports.TaskManager=TaskManager,TaskManager.supportTaskQueue=!0,exports.manager=new TaskManager,exports.buildWithCommand=buildWithCommand,exports.checkOptionsBeforeCommand=checkOptionsBeforeCommand;