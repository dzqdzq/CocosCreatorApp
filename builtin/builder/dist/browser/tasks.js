"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkOptionsBeforeCommand=exports.buildWithCommand=exports.manager=exports.TaskManager=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("./plugin"),utils_1=require("../share/utils"),migration_1=require("./migration"),options_1=require("./migration/options"),worker=require("@base/electron-worker");class TaskItemBase extends events_1.EventEmitter{constructor(s){super(),this.state="waiting",this.progress=0,this.message="",this.time="",this.isCommand=!1,this.free=!0,this.stage="build",this.breakType="",this.dirty=!1,this.id=s||String(Date.now())}break(s){this.breakType=s?"crashed":"",this.message=`The build process was ${this.breakType||"interrupted"}`,this.state="failure",this.progress=1,this.free=!0,this.emitChange()}reset(){this.progress=0,this.state="waiting",this.message="",this.breakType="",this.emitChange()}update(s,t,e){this.breakType||(this.progress=Editor.Utils.Math.clamp01(s),this.state="string"==typeof t?t:this.state,this.message="string"==typeof e?e:this.message,["success","failure"].includes(this.state)&&(this.free=!0,"success"!==this.state?this.resolve&&this.resolve(34):this.resolve&&this.resolve(36)),this.emitChange())}emitChange(){this.emit("update",this.id,this.toJSON(),this.free)}}class BuildTaskItem extends TaskItemBase{constructor(s,t,e){super(s),this.dirty=!1,this.options=t,e&&(this.resolve=e)}run(s){return new Promise(async t=>{if("build"!==s)return await this.runBuildStageTask(s),void t();let e;this.stage="build",this.time=(0,utils_1.getCurrentTime)(),console.debug("Check and complete build options",this.options);try{e=await plugin_1.pluginManager.checkOptions(this.options)}catch(s){console.error(s)}if(!e)return this.update(0,"failure",Editor.I18n.t("builder.error.check_options_failed")),this.resolve&&this.resolve(32),void t();this.options=e,this.dirty=!1,delete this.rawOptions;const i=worker.query("Build");this.isCommand||this.resolve||(this.resolve=t);const a=await i.send("build-worker:build",this.id,Object.assign({nextStages:this.options.buildStageGroup&&this.options.buildStageGroup.build},this.options),!!this.isCommand);this.state=a?"success":"failure",this.free=!0,t()})}async runBuildStageTask(s){const t=(0,path_1.join)(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName);this.currentStageTask=new StageTaskItem(this.id,s,{root:t,nextStages:this.options.buildStageGroup&&this.options.buildStageGroup[s],platform:this.options.platform,buildTaskOptions:this.options}),this.stage=s;const e=await this.currentStageTask.run(s);this.state=e?"success":"failure",this.free=!0}toJSON(){return{type:"build",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time,dirty:this.dirty,rawOptions:this.rawOptions}}updateFromJSON(s){this.id=s.id,this.progress=s.progress,this.state=s.state||"waiting",this.stage=s.stage,this.message=s.message,this.options=s.options,this.time=s.time?s.time:(0,utils_1.changeToLocalTime)(s.id),this.dirty=s.dirty,this.rawOptions=s.rawOptions}}class StageTaskItem extends TaskItemBase{constructor(s,t,e,i,a=!1){super(s),this.stage=t,this.options=e,this.isCommand=a,i&&(this.resolve=i)}async run(s){this.stage=s,this.options.buildTaskId=this.id;const t=worker.query("Build");return await t.send("build-worker:excute-build-stage",this.stage,this.options)}toJSON(){return{type:"build-stage",id:this.id,progress:this.progress,state:this.state,stage:this.stage,message:this.message,options:this.options,time:this.time}}updateFromJSON(s){this.id=s.id,this.progress=s.progress,this.state=s.state||"waiting",this.stage=s.stage,this.message=s.message,this.options=s.options,this.time=s.time?s.time:(0,utils_1.changeToLocalTime)(s.id)}}class TaskManager extends events_1.EventEmitter{constructor(){super(...arguments),this.command=!1,this.currentTaskId="",this.hasBuildNum=0,this.workerReady=!1,this.dbReady=!1,this.scriptReady=!1,this.queue=[],this.map={},this.waitingTaskIDs=[],this.crashNum=0}get ready(){return this.workerReady&&this.dbReady}get free(){return TaskManager.supportTaskQueue||!this.waitingTaskIDs.length}async init(){const s=await Editor.Profile.getConfig("builder","BuildTaskManager.taskMap")||{};Object.keys(s).sort((s,t)=>s.localeCompare(t,"en",{numeric:!0})).forEach(t=>{const e=s[t];let i;e.options||e.rawOptions?(e.options=e.options||e.rawOptions,"build-stage"!==e.type&&((i=new BuildTaskItem(e.id,e.options)).updateFromJSON(e),i.addListener("update",this._onTaskProgress),1!==e.progress&&(i.state="failure"),1===e.progress&&"processing"===i.state&&(i.state="success"),this.map[e.id]?console.warn("The same task name has exists!"):(this.map[e.id]=i,this.queue.push(i)))):console.debug("Invalid build task with empty options!")}),plugin_1.pluginManager.packageRegisterInfo.forEach(s=>{this.onAfterPackageRegister(s)}),plugin_1.pluginManager.on("register",(s,t,e)=>{this.onAfterPackageRegister(e)})}updateTaskInfo(s){if(!(s&&s.id&&s.options&&this.map[s.id]))return;const t=this.map[s.id];t.options=s.options,t.rawOptions=s.rawOptions,t.dirty=s.dirty}waitingForReady(){return new Promise(s=>{if(isM1()&&this.hasBuildNum){const t=worker.query("Build");this.waitingForReadyResolve=s,t.win.webContents.reload()}else this.waitingForReadyResolve=null,s()})}async checkCanAddTask(s){if(s&&this.waitingTaskIDs.includes(s))return console.log(Editor.I18n.t("builder.tips.task_exist")),!1;if(this.waitingTaskIDs.length&&!TaskManager.supportTaskQueue)return console.warn(Editor.I18n.t("builder.tips.task_busy")),!1;if(!this.command){if(!await checkSceneSaved())return!1}return!0}async save(){if(this.command)return;const s={};this.queue.map(t=>{s[t.id]=t.toJSON()}),await Editor.Profile.setConfig("builder","BuildTaskManager.taskMap",s,"local"),await new Promise(s=>{setTimeout(()=>{s()},800)})}async add(s,t,e){if(!await this.checkCanAddTask())return null;const i=t.id||this._getId(),a=this.queue.indexOf(this.map[i]);let r;return-1!==a&&this.queue.splice(a,1),(r="build"===s?new BuildTaskItem(i,t,e):new StageTaskItem(i,s,t,e)).addListener("update",this._onTaskProgress),this.map[i]=r,this.queue.push(r),this.waitingTaskIDs.push(i),this.step(),r}async remove(s,t){if(!this.map[s])return!1;const e=this.map[s];if(t)try{const{buildPath:t,outputName:e,platform:i}=this.map[s].options;t&&e?(0,fs_extra_1.removeSync)((0,path_1.join)(Editor.UI.File.resolveToRaw(t),e)):console.warn(`Package ${e} has invalid options.`);const a=(0,path_1.join)(Editor.Project.tmpDir,"builder","log",i+(0,utils_1.changeToLocalTime)(s).replace(":","-")+".log");(0,fs_extra_1.existsSync)(a)&&(0,fs_extra_1.removeSync)(a)}catch(s){return console.error("Remove build task failed!"),console.error(s),!1}delete this.map[s];const i=this.queue.indexOf(e);-1!==i&&this.queue.splice(i,1);const a=this.waitingTaskIDs.indexOf(s);-1!==a&&this.waitingTaskIDs.splice(a,1),await this.save();const r=(0,path_1.join)(Editor.Project.tmpDir,"builder","log",e.options.platform+(0,utils_1.changeToLocalTime)(s).replace(":","-")+".log");return(0,fs_extra_1.existsSync)(r)&&(0,fs_extra_1.removeSync)(r),Editor.Message.broadcast("builder:task-changed",s,null),!0}queryTaskInfo(s){const t=this.map[s];return t?t.toJSON():null}async recompile(s,t,e){const i=this.map[s];return i?await this.checkCanAddTask(s)?this.waitingTaskIDs.includes(s)?(i.update(0,"waiting","Wait a moment, build task is busy"),37):(i.removeAllListeners(),i.addListener("update",this._onTaskProgress),i.resolve=e,i.options=t||i.options,i.stage="build",this.waitingTaskIDs.push(s),this.currentTaskId?void 0:await this.step()):37:32}break(s){this.currentTaskId="",!s&&this.waitingForReadyResolve||(this.queue.forEach(t=>{t.free=!0,1!==t.progress&&(!this.command||this.currentTaskId===t.id&&this.command)&&t.break(s)}),this.waitingTaskIDs=[],Editor.Message.broadcast("builder:task-changed"))}async step(){if(0===this.waitingTaskIDs.length||!this.ready)return;const s=this.waitingTaskIDs[0],t=this.map[s];t&&t.free&&(this.ready?(t.free=!1,t.reset(),this.currentTaskId=s,await t.run(t.stage),this.hasBuildNum++,await this.save(),"success"===t.state&&(this.crashNum=0),this.waitingTaskIDs.shift(),this.currentTaskId="",t.free=!0,await this.step()):t.update(0,"waiting","Wait DB or worker ready"))}_getId(){return String((new Date).getTime())}_onTaskProgress(s,t,e){!this.command&&["success","failure"].includes(t.state)&&Editor.Task.addNotice({title:t.options.outputName,message:t.time+" "+t.message,source:"builder",type:"success"===t.state?"success":"error"}),Editor.Message.broadcast("builder:task-changed",s,t,TaskManager.supportTaskQueue||e)}async onAfterPackageRegister(s){for(const t of Object.keys(this.map)){const e=this.map[t],i=e.options.packages&&e.options.packages[s.name];i&&(i.__version__&&await(0,options_1.migratePkgOptions)(i,s.name,e.options),i.__version__=s.version)}}}async function buildWithCommand(s,t){if(checkOptionsBeforeCommand(s)||t(32),s.stage&&"build"!==s.stage){const e=s.root||(0,path_1.join)(Editor.UI.File.resolveToRaw(s.buildPath),s.outputName);exports.manager.add(s.stage,{platform:s.platform,root:e,nextStages:s.nextStages||s.buildStageGroup&&s.buildStageGroup[s.stage],buildTaskOptions:s},t)}else exports.manager.command=!0,exports.manager.add("build",s,t)}function isM1(){const s=require("os").cpus(),t=s&&s[0]&&s[0].model?s[0].model:"";return/Apple/.test(t)}async function checkSceneSaved(){if(await Editor.Message.request("scene","query-dirty")){const s=Editor.I18n.t,t=await Editor.Dialog.warn(s("builder.is_save_scene.message"),{title:s("builder.is_save_scene.title"),default:0,cancel:1,buttons:[s("builder.is_save_scene.save"),s("builder.is_save_scene.ignore"),s("builder.is_save_scene.cancel")]});if(2===t.response)return!1;0===t.response&&await Editor.Message.request("scene","save-scene")}return!0}async function checkOptionsBeforeCommand(s){if("string"==typeof s.scenes){s.scenes=s.scenes.split(",");const t=[];for(const e of s.scenes){const s=await Editor.Message.request("asset-db","query-asset-info",e.trim());s&&t.push({uuid:e,url:s.url})}s.scenes=t}if(s.configPath){if(!(0,fs_extra_1.existsSync)(s.configPath))return console.error(`${s.configPath} is not exist!`),null;const t=(0,fs_extra_1.readJSONSync)(s.configPath);s=Object.assign(s,t)}if(s.packages&&"string"==typeof s.packages)try{s.packages=JSON.parse(s.packages)}catch(t){s.packages={}}return!1!==s.migrate&&await(0,migration_1.migrateOptions)(s,!0),s.platform||(s.platform=await Editor.Profile.getConfig("builder","common.platform")),s.outputName||(s.outputName=s.platform),s}exports.TaskManager=TaskManager,TaskManager.supportTaskQueue=!1,exports.manager=new TaskManager,exports.buildWithCommand=buildWithCommand,exports.checkOptionsBeforeCommand=checkOptionsBeforeCommand;