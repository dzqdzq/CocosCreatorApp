"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),utils_1=require("../share/utils"),common_options_validator_1=require("../share/common-options-validator"),fs_extra_1=require("fs-extra"),global_1=require("../share/global"),lodash=require("lodash");class PluginManager extends plugin_manager_1.PluginManagerBase{builderPathsMap={};customBuildStagesMap={};customBuildIconMap={};configMap;platformConfig={};buildTemplateConfigMap={};constructor(){super();const t={};platforms_options_1.PLATFORMS.forEach(e=>{this.disablePlatforms.includes(e)||(t[e]={})}),this.configMap=t,this.platformConfig=JSON.parse(JSON.stringify(t))}async init(){Editor.Menu.__protected__.add("i18n:menu.project/i18n:builder.create_user_template",{label:"application.ejs",order:1,message:{target:"builder",name:"create-application-template"}}),await super.init()}async register(e){return!!await super.register(e)&&(this.emit("register",this.packageRegisterInfo.get(e.name),this.getWorkerPluginInfo(e.name)),!0)}async internalRegister(e,t){await super.internalRegister(e,t);const{platform:r,config:o}=e;var i,{name:e,buildPath:a}=t;o.internal&&"object"==typeof o.textureCompressConfig&&((i=texture_compress_1.configGroups[o.textureCompressConfig.platformType])?(i.support.rgb=lodash.union(i.support.rgb,o.textureCompressConfig.support.rgb),i.support.rgba=lodash.union(i.support.rgba,o.textureCompressConfig.support.rgba),i.defaultSupport&&(o.textureCompressConfig.support.rgb=lodash.union(o.textureCompressConfig.support.rgb,i.defaultSupport.rgb),o.textureCompressConfig.support.rgba=lodash.union(o.textureCompressConfig.support.rgba,i.defaultSupport.rgba))):console.error("Invalid platformType "+o.textureCompressConfig.platformType),this.platformConfig[r].texture=o.textureCompressConfig),o.internal&&e===r&&o.platformName&&(this.platformConfig[r].name=o.platformName,this.platformConfig[r].platformType=o.platformType),o.internal&&this.bundleConfigs[r]&&(this.platformConfig[r].type=this.bundleConfigs[r].platformType),o.customBuildStages&&lodash.set(this.customBuildStagesMap,e+"."+r,o.customBuildStages),"object"==typeof o.options&&Editor.Profile.setConfig(e,"builder.options."+r,(0,utils_1.getOptionsDefault)(o.options),"default"),o.commonOptions&&this.commonOptionConfig[r]&&Object.keys(this.commonOptionConfig[r]).forEach(e=>{var t=this.commonOptionConfig[r][e];Editor.Profile.setConfig(r,"builder.common."+e,t.default,"default")}),!Editor.App.dev&&"win32"===process.platform&&["mac","ios"].includes(e)||!Editor.App.dev&&"darwin"===process.platform&&"windows"===e||(this.pkgPriorities[e]=o.priority||0,"string"==typeof(this.configMap[r][e]=o).hooks&&(o.hooks=(0,utils_1.resolveToRaw)(o.hooks,(0,path_1.dirname)(a)),lodash.set(this.builderPathsMap,e+"."+r,o.hooks)),o.internal&&o.buildTemplateConfig&&o.buildTemplateConfig.templates.length&&(o.buildTemplateConfig.pkgName=e,i=o.displayName||o.platformName||t.displayName||t.name,this.platformConfig[r].createTemplateLabel=i,this.buildTemplateConfigMap[i]=o.buildTemplateConfig,Editor.Menu.__protected__.add("i18n:menu.project/i18n:builder.create_user_template",{label:o.displayName||o.platformName||t.displayName||t.name,order:1,message:{target:"builder",name:"create-build-template",params:[i,r]}})),console.debug(`[Build] internalRegister pkg(${e}) in ${r} platform success!`))}async unregister(t){try{var e=this.packageRegisterInfo.get(t.name);if(e){var r=JSON.parse(JSON.stringify(this.getWorkerPluginInfo(t.name)));await super.unregister(t);const o=[];platforms_options_1.PLATFORMS.forEach(e=>{delete this.configMap[e][t.name],this.builderPathsMap[t.name]&&this.builderPathsMap[t.name][e]&&(o.push(this.builderPathsMap[t.name][e]),Editor.Module.__protected__.removeCache(this.builderPathsMap[t.name][e]),delete this.builderPathsMap[t.name][e])}),Editor.Module.__protected__.removeCache((0,path_1.join)(t.path,t.info.contributions.builder)),this.emit("unregister",e,r)}}catch(e){console.error(e)}}getAllWorkerPluginInfos(){return Object.keys(this.pkgPriorities).map(e=>this.getWorkerPluginInfo(e))}getWorkerPluginInfo(e){return{pkgName:e,priority:this.pkgPriorities[e],internal:platforms_options_1.builtinPlugins.includes(e),assetHandlers:this.assetHandlerPaths[e],hooks:this.builderPathsMap[e],customBuildStages:this.customBuildStagesMap[e]}}async checkOptions(e){let t=!0;this.bundleConfigs[e.platform]?(s=this.bundleConfigs[e.platform].supportOptions.compressionType,s=await checkBundleCompressionSetting(e.mainBundleCompressionType,s),(r=validator_manager_1.validator.checkWithInternalRule("valid",s.newValue))&&lodash.set(e,"mainBundleCompressionType",s.newValue),s.error&&r&&console.warn(Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:"mainBundleCompressionType",value:e.mainBundleCompressionType,error:Editor.I18n.t(s.error.replace("i18n:",""))||s.error,newValue:JSON.stringify(s.newValue)}))):console.debug("Can not find bundle config with platform "+e.platform);var r=await this.getOptionsByPlatform(e.platform),o=(0,utils_1.defaultsDeep)(JSON.parse(JSON.stringify(e)),r);"buildStageGroup"in e&&(o.buildStageGroup=e.buildStageGroup);for(const n of Object.keys(o))if("packages"!==n){var i=await this.checkCommonOptionByKey(n,o[n],o);if(i&&i.error&&"error"===i.level){var a=Editor.I18n.t(i.error.replace("i18n:",""))||i.error;if(!validator_manager_1.validator.checkWithInternalRule("valid",i.newValue))return t=!1,void console.error(Editor.I18n.t("builder.error.checkFailed",{key:n,value:JSON.stringify(o[n]),error:a}));console.warn(Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:n,value:JSON.stringify(o[n]),error:a,newValue:JSON.stringify(i.newValue)}))}o[n]=i.newValue}var s=await this.checkPluginOptions(o);if(t=s?t:!1)return o}async checkPluginOptions(t){if("object"!=typeof t.packages)return!1;let r=!0;for(const l of Object.keys(t.packages)){var o=t.packages[l];if(o){var i=exports.pluginManager.configMap[t.platform][l];if(i&&i.options)for(const p of Object.keys(o))if(i.options[p]&&i.options[p].verifyRules){var a=o[p],s=await validator_manager_1.validatorManager.check(a,i.options[p].verifyRules,t,exports.pluginManager.commonOptionConfig[t.platform][p]?.verifyKey||t.platform+l);if(s){let e=validator_manager_1.validator.checkWithInternalRule("valid",i.options[p].default);e=e&&!await validator_manager_1.validatorManager.check(i.options[p].default,i.options[p].verifyRules,t,exports.pluginManager.commonOptionConfig[t.platform][p]?.verifyKey||t.platform+l);var n=i.options[p].verifyLevel||"error",s="string"==typeof s&&Editor.I18n.t(s.replace("i18n:",""))||s;e||"error"!==n?(n="error"!==n&&console[n]?n:"warn",console[n](Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:`options.packages.${l}.`+p,value:JSON.stringify(a),error:s,newValue:JSON.stringify(i.options[p].default)})),lodash.set(o,p,i.options[p].default)):(console.error(Editor.I18n.t("builder.error.checkFailed",{key:`options.packages.${l}.`+p,value:JSON.stringify(a),error:s})),r=!1)}}}}return r}async getDefaultOptionsByPlatform(e){var t={packages:{},...await(0,common_options_validator_1.getCommonOptions)(e)};for(const r of Object.keys(this.configMap[e]))t.packages[r]=await Editor.Profile.getConfig(r,"builder.options."+e,"default");return t}async getOptionsByPlatform(e){var t={packages:{},...await(0,common_options_validator_1.getCommonOptions)(e)};for(const r of Object.keys(this.configMap[e]))t.packages[r]=await Editor.Profile.getConfig(r,"builder.options."+e);return t}async createBuildTemplate(t){if(platforms_options_1.PLATFORMS.includes(t)){if(!this.platformConfig[t])return void console.error(`platform ${t} not found`);t=this.platformConfig[t].createTemplateLabel}var r=this.buildTemplateConfigMap[t];if(r){var o=global_1.BuildGlobalInfo.buildTemplateDir;const n=(0,path_1.join)(o,r.dirname||r.pkgName||t);await Promise.all(r.templates.map(async e=>Editor.Utils.File.copy(e.path,(0,path_1.join)(n,e.destUrl))));var i=r.pkgName||t;let e={[i]:r.version};var a,s=(0,path_1.join)(o,"templates-version.json");(0,fs_extra_1.existsSync)(s)?(a=await(0,fs_extra_1.readJSON)(s))[i]!==r.version&&(e=Object.assign({},a,e),await(0,fs_extra_1.outputJSON)(s,e,{spaces:4})):await(0,fs_extra_1.outputJSON)(s,e,{spaces:4}),console.log(`${i} ${Editor.I18n.t("builder.tips.createTemplateSuccess")}({link(${(0,path_1.join)(o,i)})})`)}else console.debug("no build template for "+t)}getTexturePlatformConfigs(){const t={};return Object.keys(this.platformConfig).forEach(e=>{t[e]={name:this.platformConfig[e].name,textureCompressConfig:this.platformConfig[e].texture}}),t}queryPlatformConfig(){var e=platforms_options_1.PLATFORMS.filter(e=>{var t=!this.disablePlatforms.includes(e)&&this.platformConfig[e]&&this.platformConfig[e].name;return t||delete this.platformConfig[e],t});return{order:e,native:e.filter(e=>platforms_options_1.NATIVE_PLATFORM.includes(e)),config:this.platformConfig}}queryPlatformOrder(){return platforms_options_1.PLATFORMS.filter(e=>!this.disablePlatforms.includes(e)&&this.platformConfig[e]&&this.platformConfig[e].name)}}function checkBundleCompressionSetting(e,t){var r={error:"",newValue:e};return t&&-1===t.indexOf(e)&&(r.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,r.error=` compression type(${e}) is invalid for this platform!`),r}exports.pluginManager=new PluginManager;