"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const events_1=require("events"),path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),platforms_options_1=require("../share/platforms-options"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),lodash=require("lodash"),worker=require("@base/electron-worker");class PluginManager extends events_1.EventEmitter{constructor(){super(),this.bundleConfig={},this.builderPathsMap={},this.assetHandlerPaths={},this.pkgPriorities={},this.platformConfig={},this.pkgLock={},this.tasks=[];const e={};platforms_options_1.PLATFORMS.forEach(t=>{e[t]={}}),this.configMap=e,this.platformConfig=JSON.parse(JSON.stringify(e))}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(async e=>await this.addTask("register",e))),Editor.Package.on("enable",async e=>this.addTask("register",e)),Editor.Package.on("disable",e=>this.addTask("unregister",e))}async addTask(e,t){if(!(t&&t.info&&t.info.contributions&&t.info.contributions.builder))return!1;this.tasks.push({type:e,pkg:t}),await this.step()}async step(){if(!this.tasks.length)return;const e=this.tasks.findIndex(e=>!this.pkgLock[e.pkg.name]);if(-1===e)return;const t=this.tasks[e];this.pkgLock[t.pkg.name]=!0,this.tasks.splice(e,1),await this[t.type](t.pkg),this.pkgLock[t.pkg.name]=!1,this.step()}async register(e){if(!e.enable)return;let t=!1;if(platforms_options_1.builtinPlugins.includes(e.name)&&(Editor.Utils.Path.contains(Editor.App.path,e.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(e.name))?t=!0:platforms_options_1.builtinPlugins.includes(e.name)&&console.error(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:e.name})),"string"==typeof e.info.contributions.builder&&void 0===this.pkgPriorities[e.name]){try{const o=path_1.join(e.path,e.info.contributions.builder);if(!require.resolve(o))return;const s=Editor.Module.requireFile(o);if(s.assetHandlers&&(this.assetHandlerPaths[e.name]=path_1.isAbsolute(s.assetHandlers)?s.assetHandlers:path_1.join(path_1.dirname(o),s.assetHandlers)),!s.configs)return;s.load&&await s.load();const i=s.configs;if(!i)return;for(const s of Object.keys(i)){const r=s,a=i[r];if(a.internal=t,"*"!==s)platforms_options_1.builtinPlugins.includes(r)&&await this.internalRegister(r,a,e.name,o);else for(const t of platforms_options_1.PLATFORMS)await this.internalRegister(t,a,e.name,o)}this.emit("register",e.name)}catch(t){return console.error(t),console.error(`builder package ${e.name} registration failed!`),!1}return!0}}internalRegister(e,t,o,s){var i;if(t.internal&&"object"==typeof t.textureCompressConfig){const o=texture_compress_1.configGroups[t.textureCompressConfig.platformType];o?(o.support.rgb=lodash.union(o.support.rgb,t.textureCompressConfig.support.rgb),o.support.rgba=lodash.union(o.support.rgba,t.textureCompressConfig.support.rgba),o.defaultSupport&&(t.textureCompressConfig.support.rgb=lodash.union(t.textureCompressConfig.support.rgb,o.defaultSupport.rgb),t.textureCompressConfig.support.rgba=lodash.union(t.textureCompressConfig.support.rgba,o.defaultSupport.rgba))):console.error(`Invalid platformType ${t.textureCompressConfig.platformType}`),this.platformConfig[e].textureCompressConfig=t.textureCompressConfig}if(t.internal&&o===e&&(this.platformConfig[e].name=t.platformName,(null===(i=t.debugConfig)||void 0===i?void 0:i.custom)&&(t.debugConfig.custom=path_1.join(path_1.dirname(s),t.debugConfig.custom)),this.platformConfig[e].debugConfig=t.debugConfig,!this.bundleConfig[e]&&t.assetBundleConfig&&(this.bundleConfig[e]=Object.assign({platformName:t.platformName},t.assetBundleConfig))),"object"==typeof t.options&&Editor.Profile.setConfig(o,`options.${e}`,getOptionsDefault(t.options),"default"),!("win32"===process.platform&&["mac","ios"].includes(o)||"darwin"===process.platform&&"windows"===o)){if(this.configMap[e][o]&&console.warn(`platform ${e} config in ${o} has exist!`),this.pkgPriorities[o]=t.priority||0,this.configMap[e][o]=t,"object"==typeof t.verifyRuleMap)for(const s of Object.keys(t.verifyRuleMap)){const i=t.verifyRuleMap[s];i&&i.func&&validator_manager_1.validatorManager.addRule(s,i.func,e+o),i&&i.message&&validator_manager_1.validatorManager.addMessage(s,i.message,e+o)}"string"==typeof t.hooks&&(t.hooks=path_1.isAbsolute(t.hooks)?t.hooks:path_1.join(path_1.dirname(s),t.hooks),lodash.set(this.builderPathsMap,`${o}.${e}`,t.hooks))}}async unregister(e){try{const t=Editor.Module.requireFile(path_1.join(e.path,e.info.contributions.builder));"function"==typeof t.unload&&await t.unload();const o=[];platforms_options_1.PLATFORMS.forEach(t=>{delete this.configMap[t][e.name],delete this.pkgPriorities[e.name],this.builderPathsMap[e.name]&&(o.push(this.builderPathsMap[e.name][t]),Editor.Module.removeCache(this.builderPathsMap[e.name][t]),delete this.builderPathsMap[e.name][t])}),delete this.assetHandlerPaths[e.name],Editor.Module.removeCache(path_1.join(e.path,e.info.contributions.builder)),worker.query("Build").send("build-worker:unregister-build-hook",o),this.emit("unregister",e.name)}catch(e){console.error(e)}}getAllWorkerPluginInfos(){return Object.keys(this.pkgPriorities).map(e=>this.getWorkerPluginInfo(e))}getWorkerPluginInfo(e){return{pkgName:e,priority:this.pkgPriorities[e],internal:platforms_options_1.builtinPlugins.includes(e),assetHandlers:this.assetHandlerPaths[e],hooks:this.builderPathsMap[e]}}async checkOptions(e){let t=!0;if(this.bundleConfig[e.platform]){const t=this.bundleConfig[e.platform].supportedCompressionTypes,o=await checkBundleCompressionSetting(e.mainBundleCompressionType,t),s=validator_manager_1.validator.check("valid",o.newValue);s&&lodash.set(e,"mainBundleCompressionType",o.newValue),o.error&&s&&console.error(`${o.error} 将会使用新值 ${o.newValue}`)}else console.error("Invaild platform: "+e.platform);const o=await this.getDefaultOptionsByPlatform(e.platform),s=lodash.defaultsDeep(e,o);if(await this.checkPluginOptions(s)||(t=!1),t)return s}async checkPluginOptions(e){if("object"!=typeof e.packages)return!1;let t=!0;for(const o of Object.keys(e.packages)){const s=e.packages[o];if(!s)continue;const i=exports.pluginManager.configMap[e.platform][o];if(i&&i.options)for(const r of Object.keys(s)){if(!i.options[r]||!i.options[r].verifyRules)continue;const a=s[r],n=await validator_manager_1.validatorManager.check(a,e,i.options[r].verifyRules,e.platform+o);if(!n)continue;let l=!validator_manager_1.validator.check("valid",i.options[r].default);validator_manager_1.validator.check("valid",i.options[r].default)&&(l=!await validator_manager_1.validatorManager.check(i.options[r].default,e,i.options[r].verifyRules,e.platform+o)),l?(console.error(`${n}，options.packages.${o}.${r} will use default value ${i.options[r].default}`),lodash.set(s,r,i.options[r].default)):(console.error(`[Build check failed] ( ${o} )${n}`),t=!1)}}return t}async getDefaultOptionsByPlatform(e){const t={packages:{}},o=Object.keys(this.configMap[e]);for(const s of o)t.packages[s]=await Editor.Profile.getConfig(s,`options.${e}`,"default");return t}getPlatformConfig(){const e=JSON.parse(JSON.stringify(this.platformConfig));for(const t of Object.values(e))t.support&&(t.support.rgb&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgb),t.support.rgba&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgba));return e}}function checkBundleCompressionSetting(e,t){const o={error:"",newValue:e};return t&&-1===t.indexOf(e)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${e}) is invalid for this platform!`),o}function getOptionsDefault(e){const t={};return Object.keys(e).forEach(o=>{setConfigDefault(e[o],t,o)}),t}function setConfigDefault(e,t,o=""){if(e){if(void 0===e.default||null===e.default)return"array"===e.type&&Array.isArray(e.itemConfigs)?(t[o]=[],void e.itemConfigs.forEach((e,s)=>{setConfigDefault(e,t[o],`[${s}]`)})):void("object"===e.type&&"object"==typeof e.itemConfigs&&(t[o]={},Object.keys(e.itemConfigs).forEach(s=>{setConfigDefault(e.itemConfigs[s],t[o],s)})));lodash.set(t,o,e.default)}}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;