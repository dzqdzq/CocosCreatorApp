"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),utils_1=require("../share/utils"),common_options_validator_1=require("../share/common-options-validator"),fs_extra_1=require("fs-extra"),global_1=require("../share/global"),lodash=require("lodash");class PluginManager extends plugin_manager_1.PluginManagerBase{constructor(){super(),this.builderPathsMap={},this.buildTemplateMap={},this.customBuildStagesMap={},this.platformConfig={};const t={};platforms_options_1.PLATFORMS.forEach(e=>{t[e]={}}),this.configMap=t,this.platformConfig=JSON.parse(JSON.stringify(t))}async init(){Editor.Menu.__protected__.add("i18n:menu.project/i18n:builder.create_user_template",{label:"application.ejs",order:1,message:{target:"builder",name:"create-application-template"}}),await super.init()}async register(e){return!!await super.register(e)&&(this.emit("register",this.packageRegisterInfo.get(e.name),this.getWorkerPluginInfo(e.name)),!0)}async internalRegister(e,t){await super.internalRegister(e,t);const{platform:r,config:o}=e;var i,{name:e,buildPath:a}=t;o.internal&&"object"==typeof o.textureCompressConfig&&((i=texture_compress_1.configGroups[o.textureCompressConfig.platformType])?(i.support.rgb=lodash.union(i.support.rgb,o.textureCompressConfig.support.rgb),i.support.rgba=lodash.union(i.support.rgba,o.textureCompressConfig.support.rgba),i.defaultSupport&&(o.textureCompressConfig.support.rgb=lodash.union(o.textureCompressConfig.support.rgb,i.defaultSupport.rgb),o.textureCompressConfig.support.rgba=lodash.union(o.textureCompressConfig.support.rgba,i.defaultSupport.rgba))):console.error("Invalid platformType "+o.textureCompressConfig.platformType),this.platformConfig[r].texture=o.textureCompressConfig),o.icon&&(o.icon=(0,utils_1.resolveToRaw)(o.icon,(0,path_1.dirname)(a))),o.internal&&e===r&&o.platformName&&(this.platformConfig[r].name=o.platformName),o.internal&&this.bundleConfigs[r]&&(this.platformConfig[r].type=this.bundleConfigs[r].platformType),o.internal&&o.buildTemplateConfig&&(i=o.platformName?r:e,this.buildTemplateMap[i]=o.buildTemplateConfig,o.buildTemplateConfig.templates.length)&&Editor.Menu.__protected__.add("i18n:menu.project/i18n:builder.create_user_template",{label:o.displayName||o.platformName||t.displayName||t.name,order:1,message:{target:"builder",name:"create-build-template",params:[i]}}),o.customBuildStages&&lodash.set(this.customBuildStagesMap,e+"."+r,o.customBuildStages),"object"==typeof o.options&&Editor.Profile.setConfig(e,"builder.options."+r,(0,utils_1.getOptionsDefault)(o.options),"default"),o.commonOptions&&this.commonOptionConfig[r]&&Object.keys(this.commonOptionConfig[r]).forEach(e=>{var t=this.commonOptionConfig[r][e];Editor.Profile.setConfig(r,"builder.common."+e,t.default,"default")}),!Editor.App.dev&&"win32"===process.platform&&["mac","ios"].includes(e)||!Editor.App.dev&&"darwin"===process.platform&&"windows"===e||(this.pkgPriorities[e]=o.priority||0,"string"==typeof(this.configMap[r][e]=o).hooks&&(o.hooks=(0,utils_1.resolveToRaw)(o.hooks,(0,path_1.dirname)(a)),lodash.set(this.builderPathsMap,e+"."+r,o.hooks)),console.debug(`[Build] internalRegister pkg(${e}) in ${r} platform success!`))}async unregister(t){try{var e=this.packageRegisterInfo.get(t.name);if(e){var r=JSON.parse(JSON.stringify(this.getWorkerPluginInfo(t.name)));await super.unregister(t);const o=[];platforms_options_1.PLATFORMS.forEach(e=>{delete this.configMap[e][t.name],this.builderPathsMap[t.name]&&this.builderPathsMap[t.name][e]&&(o.push(this.builderPathsMap[t.name][e]),Editor.Module.__protected__.removeCache(this.builderPathsMap[t.name][e]),delete this.builderPathsMap[t.name][e])}),Editor.Module.__protected__.removeCache((0,path_1.join)(t.path,t.info.contributions.builder)),this.emit("unregister",e,r)}}catch(e){console.error(e)}}getAllWorkerPluginInfos(){return Object.keys(this.pkgPriorities).map(e=>this.getWorkerPluginInfo(e))}getWorkerPluginInfo(e){return{pkgName:e,priority:this.pkgPriorities[e],internal:platforms_options_1.builtinPlugins.includes(e),assetHandlers:this.assetHandlerPaths[e],hooks:this.builderPathsMap[e],buildTemplate:this.buildTemplateMap[e],customBuildStages:this.customBuildStagesMap[e]}}async checkOptions(e){let t=!0;this.bundleConfigs[e.platform]?(s=this.bundleConfigs[e.platform].supportOptions.compressionType,s=await checkBundleCompressionSetting(e.mainBundleCompressionType,s),(r=validator_manager_1.validator.checkWithInternalRule("valid",s.newValue))&&lodash.set(e,"mainBundleCompressionType",s.newValue),s.error&&r&&console.warn(Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:"mainBundleCompressionType",value:e.mainBundleCompressionType,error:Editor.I18n.t(s.error.replace("i18n:",""))||s.error,newValue:JSON.stringify(s.newValue)}))):console.debug("Can not find bundle config with platform "+e.platform);var r=await this.getOptionsByPlatform(e.platform),o=(0,utils_1.defaultsDeep)(JSON.parse(JSON.stringify(e)),r);"buildStageGroup"in e&&(o.buildStageGroup=e.buildStageGroup);for(const n of Object.keys(o))if("packages"!==n){var i=await this.checkCommonOptionByKey(n,o[n],o);if(i&&i.error&&"error"===i.level){var a=Editor.I18n.t(i.error.replace("i18n:",""))||i.error;if(!validator_manager_1.validator.checkWithInternalRule("valid",i.newValue))return t=!1,void console.error(Editor.I18n.t("builder.error.checkFailed",{key:n,value:JSON.stringify(o[n]),error:a}));console.warn(Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:n,value:JSON.stringify(o[n]),error:a,newValue:JSON.stringify(i.newValue)}))}o[n]=i.newValue}var s=await this.checkPluginOptions(o);if(t=s?t:!1)return o}async checkPluginOptions(t){if("object"!=typeof t.packages)return!1;let r=!0;for(const p of Object.keys(t.packages)){var o=t.packages[p];if(o){var i=exports.pluginManager.configMap[t.platform][p];if(i&&i.options)for(const u of Object.keys(o))if(i.options[u]&&i.options[u].verifyRules){var a=o[u],s=await validator_manager_1.validatorManager.check(a,i.options[u].verifyRules,t,(null==(s=exports.pluginManager.commonOptionConfig[t.platform][u])?void 0:s.verifyKey)||t.platform+p);if(s){let e=validator_manager_1.validator.checkWithInternalRule("valid",i.options[u].default);e=e&&!await validator_manager_1.validatorManager.check(i.options[u].default,i.options[u].verifyRules,t,(null==(l=exports.pluginManager.commonOptionConfig[t.platform][u])?void 0:l.verifyKey)||t.platform+p);var n,l=i.options[u].verifyLevel||"error",s="string"==typeof s&&Editor.I18n.t(s.replace("i18n:",""))||s;e||"error"!==l?(n="error"!==l&&console[l]?l:"warn",console[n](Editor.I18n.t("builder.warn.checkFailedWithNewValue",{key:`options.packages.${p}.`+u,value:JSON.stringify(a),error:s,newValue:JSON.stringify(i.options[u].default)})),lodash.set(o,u,i.options[u].default)):(console.error(Editor.I18n.t("builder.error.checkFailed",{key:`options.packages.${p}.`+u,value:JSON.stringify(a),error:s})),r=!1)}}}}return r}async getDefaultOptionsByPlatform(e){var t=await(0,common_options_validator_1.getCommonOptions)(e),r=Object.assign({packages:{}},t);for(const o of Object.keys(this.configMap[e]))r.packages[o]=await Editor.Profile.getConfig(o,"builder.options."+e,"default");return r}async getOptionsByPlatform(e){var t=await(0,common_options_validator_1.getCommonOptions)(e),r=Object.assign({packages:{}},t);for(const o of Object.keys(this.configMap[e]))r.packages[o]=await Editor.Profile.getConfig(o,"builder.options."+e);return r}async createBuildTemplate(t){var r=this.buildTemplateMap[t];if(r){var o=global_1.BuildGlobalInfo.buildTemplateDir;const s=(0,path_1.join)(o,t);await Promise.all(r.templates.map(async e=>Editor.Utils.File.copy(e.path,(0,path_1.join)(s,e.destUrl))));let e={[t]:r.version};var i,a=(0,path_1.join)(o,"templates-version.json");(0,fs_extra_1.existsSync)(a)?(i=await(0,fs_extra_1.readJSON)(a))[t]!==r.version&&(e=Object.assign({},i,e),await(0,fs_extra_1.outputJSON)(a,e,{spaces:4})):await(0,fs_extra_1.outputJSON)(a,e,{spaces:4}),console.log(`${t} ${Editor.I18n.t("builder.tips.createTemplateSuccess")}({link(${(0,path_1.join)(o,t)})})`)}else console.debug("no build template for "+t)}getTexturePlatformConfigs(){const t={};return Object.keys(this.platformConfig).forEach(e=>{t[e]={name:this.platformConfig[e].name,textureCompressConfig:this.platformConfig[e].texture}}),t}}function checkBundleCompressionSetting(e,t){var r={error:"",newValue:e};return t&&-1===t.indexOf(e)&&(r.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,r.error=` compression type(${e}) is invalid for this platform!`),r}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;