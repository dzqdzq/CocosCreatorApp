"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),utils_1=require("../share/utils"),common_options_validator_1=require("../share/common-options-validator"),lodash=require("lodash");class PluginManager extends plugin_manager_1.PluginManagerBase{constructor(){super(),this.builderPathsMap={},this.customBuildStagesMap={},this.platformConfig={};const e={};platforms_options_1.PLATFORMS.forEach(t=>{e[t]={}}),this.configMap=e,this.platformConfig=JSON.parse(JSON.stringify(e))}async register(e){return!!await super.register(e)&&(this.emit("register",this.packageRegisterInfo.get(e.name),this.getWorkerPluginInfo(e.name)),!0)}async internalRegister(e,t){await super.internalRegister(e,t);const{platform:o,config:r}=e,{name:i,buildPath:s}=t;if(r.internal&&"object"==typeof r.textureCompressConfig){const e=texture_compress_1.configGroups[r.textureCompressConfig.platformType];e?(e.support.rgb=lodash.union(e.support.rgb,r.textureCompressConfig.support.rgb),e.support.rgba=lodash.union(e.support.rgba,r.textureCompressConfig.support.rgba),e.defaultSupport&&(r.textureCompressConfig.support.rgb=lodash.union(r.textureCompressConfig.support.rgb,e.defaultSupport.rgb),r.textureCompressConfig.support.rgba=lodash.union(r.textureCompressConfig.support.rgba,e.defaultSupport.rgba))):console.error(`Invalid platformType ${r.textureCompressConfig.platformType}`),this.platformConfig[o].textureCompressConfig=r.textureCompressConfig}if(r.internal&&i===o&&r.platformName&&(this.platformConfig[o].name=r.platformName),r.internal&&r.customBuildStages&&lodash.set(this.customBuildStagesMap,`${i}.${o}`,r.customBuildStages),"object"==typeof r.options&&Editor.Profile.setConfig(i,`builder.options.${o}`,(0,utils_1.getOptionsDefault)(r.options),"default"),r.internal&&"object"==typeof r.commonOptions){const e=(0,utils_1.getOptionsDefault)(r.commonOptions);Object.keys(e).forEach(t=>{Editor.Profile.setConfig(o,`builder.common.${t}`,e[t],"default")})}!Editor.App.dev&&"win32"===process.platform&&["mac","ios"].includes(i)||(Editor.App.dev||"darwin"!==process.platform||"windows"!==i)&&(this.configMap[o][i]&&console.warn(`platform ${o} config in ${i} has exist!`),this.pkgPriorities[i]=r.priority||0,this.configMap[o][i]=r,"string"==typeof r.hooks&&(r.hooks=(0,path_1.isAbsolute)(r.hooks)?r.hooks:(0,path_1.join)((0,path_1.dirname)(s),r.hooks),lodash.set(this.builderPathsMap,`${i}.${o}`,r.hooks)),console.debug(`[Build] internalRegister pkg(${i}) in ${o} platform success!`))}async unregister(e){try{const t=this.packageRegisterInfo.get(e.name);if(!t)return;const o=JSON.parse(JSON.stringify(this.getWorkerPluginInfo(e.name)));await super.unregister(e);const r=[];platforms_options_1.PLATFORMS.forEach(t=>{delete this.configMap[t][e.name],this.builderPathsMap[e.name]&&this.builderPathsMap[e.name][t]&&(r.push(this.builderPathsMap[e.name][t]),Editor.Module.__protected__.removeCache(this.builderPathsMap[e.name][t]),delete this.builderPathsMap[e.name][t])}),Editor.Module.__protected__.removeCache((0,path_1.join)(e.path,e.info.contributions.builder)),this.emit("unregister",t,o)}catch(e){console.error(e)}}getAllWorkerPluginInfos(){return Object.keys(this.pkgPriorities).map(e=>this.getWorkerPluginInfo(e))}getWorkerPluginInfo(e){return{pkgName:e,priority:this.pkgPriorities[e],internal:platforms_options_1.builtinPlugins.includes(e),assetHandlers:this.assetHandlerPaths[e],hooks:this.builderPathsMap[e],customBuildStages:this.customBuildStagesMap[e]}}async checkOptions(e){let t=!0;if(this.bundleConfigs[e.platform]){const t=this.bundleConfigs[e.platform].supportOptions.compressionType,o=await checkBundleCompressionSetting(e.mainBundleCompressionType,t),r=validator_manager_1.validator.checkWithInternalRule("valid",o.newValue);r&&lodash.set(e,"mainBundleCompressionType",o.newValue),o.error&&r&&console.debug(`${o.error} 将会使用新值 ${o.newValue}`)}else console.debug(`Can not find bundle config with platform ${e.platform}`);const o=await this.getOptionsByPlatform(e.platform),r=(0,utils_1.defaultsDeep)(JSON.parse(JSON.stringify(e)),o);"buildStageGroup"in e&&(r.buildStageGroup=e.buildStageGroup);for(const e of Object.keys(r)){if("packages"===e)continue;const o=await this.checkCommonOptionByKey(e,r[e],r);if(o&&o.error&&"error"===o.level&&!validator_manager_1.validator.checkWithInternalRule("valid",o.newValue)){t=!1,console.error(`check ${e}`+(Editor.I18n.t(o.error.replace("i18n:",""))||o.error));break}r[e]=o.newValue}if(await this.checkPluginOptions(r)||(t=!1),t)return r}async checkPluginOptions(e){var t,o;if("object"!=typeof e.packages)return!1;let r=!0;for(const i of Object.keys(e.packages)){const s=e.packages[i];if(!s)continue;const n=exports.pluginManager.configMap[e.platform][i];if(n&&n.options)for(const a of Object.keys(s)){if(!n.options[a]||!n.options[a].verifyRules)continue;const p=s[a],l=await validator_manager_1.validatorManager.check(p,n.options[a].verifyRules,e,(null===(t=exports.pluginManager.commonOptionConfig[e.platform][a])||void 0===t?void 0:t.verifyKey)||e.platform+i);if(!l)continue;let u=validator_manager_1.validator.checkWithInternalRule("valid",n.options[a].default);u&&(u=!await validator_manager_1.validatorManager.check(n.options[a].default,n.options[a].verifyRules,e,(null===(o=exports.pluginManager.commonOptionConfig[e.platform][a])||void 0===o?void 0:o.verifyKey)||e.platform+i));const c=n.options[a].verifyLevel||"error";if(u||"error"!==c){const e="error"!==c?c:"warn";console[e]&&console[e](`${l}，options.packages.${i}.${a} will use default value ${n.options[a].default}`),lodash.set(s,a,n.options[a].default)}else console.error(`[Build check failed] ( ${i} )${l}`),r=!1}}return r}async getDefaultOptionsByPlatform(e){const t=await(0,common_options_validator_1.getCommonOptions)(e),o=Object.assign({packages:{}},t),r=Object.keys(this.configMap[e]);for(const t of r)o.packages[t]=await Editor.Profile.getConfig(t,`builder.options.${e}`,"default");return o}async getOptionsByPlatform(e){const t=await(0,common_options_validator_1.getCommonOptions)(e),o=Object.assign({packages:{}},t),r=Object.keys(this.configMap[e]);for(const t of r)o.packages[t]=await Editor.Profile.getConfig(t,`builder.options.${e}`);return o}getPlatformConfig(){return JSON.parse(JSON.stringify(this.platformConfig))}}function checkBundleCompressionSetting(e,t){const o={error:"",newValue:e};return t&&-1===t.indexOf(e)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${e}) is invalid for this platform!`),o}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;