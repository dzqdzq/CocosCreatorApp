"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),platforms_options_1=require("../share/platforms-options"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),lodash=require("lodash"),worker=require("@base/electron-worker");class PluginManager{constructor(){this.bundleConfig={},this.pkgPriorities={},this.platformConfig={},this.pkgLock={},this.tasks=[];const e={},t={};platforms_options_1.PLATFORMS.forEach(o=>{e[o]={},t[o]={}}),this.configMap=t,this.platformConfig=JSON.parse(JSON.stringify(t)),this.builderPathsMap=e}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(async e=>await this.addTask("register",e))),Editor.Package.on("enable",async e=>this.addTask("register",e)),Editor.Package.on("disable",e=>this.addTask("unregister",e))}async addTask(e,t){if(!(t&&t.info&&t.info.contributions&&t.info.contributions.builder))return!1;this.tasks.push({type:e,pkg:t}),await this.step()}async step(){if(!this.tasks.length)return;const e=this.tasks.findIndex(e=>!this.pkgLock[e.pkg.name]);if(-1===e)return;const t=this.tasks[e];this.pkgLock[t.pkg.name]=!0,this.tasks.splice(e,1),await this[t.type](t.pkg),this.pkgLock[t.pkg.name]=!1,this.step()}async register(e){if(!e.enable)return;let t=!1;if(platforms_options_1.builtinPlugins.includes(e.name)&&(Editor.Utils.Path.contains(Editor.App.path,e.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(e.name))?t=!0:platforms_options_1.builtinPlugins.includes(e.name)&&console.error(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:e.name})),"string"==typeof e.info.contributions.builder&&void 0===this.pkgPriorities[e.name]){try{const o=path_1.join(e.path,e.info.contributions.builder);if(!require.resolve(o))return;const i=require(o);if(!i.configs)return;i.load&&await i.load();const s=i.configs;if(!s)return;for(const i of Object.keys(s)){const r=i,n=s[r];if(n.internal=t,"*"!==i)platforms_options_1.builtinPlugins.includes(r)&&await this.internalRegister(r,n,e.name,o);else for(const t of platforms_options_1.PLATFORMS)await this.internalRegister(t,n,e.name,o)}}catch(t){return console.error(t),console.error(`builder package ${e.name} registration failed!`),!1}return!0}}internalRegister(e,t,o,i){var s;if(t.internal&&"object"==typeof t.textureCompressConfig){const o=texture_compress_1.configGroups[t.textureCompressConfig.platformType];o?(o.support.rgb=lodash.union(o.support.rgb,t.textureCompressConfig.support.rgb),o.support.rgba=lodash.union(o.support.rgba,t.textureCompressConfig.support.rgba),t.textureCompressConfig.support=o.support):console.error(`Invalid platformType ${t.textureCompressConfig.platformType}`),this.platformConfig[e].textureCompressConfig=t.textureCompressConfig}if(t.internal&&o===e&&(this.platformConfig[e].name=t.platformName,(null===(s=t.debugConfig)||void 0===s?void 0:s.custom)&&(t.debugConfig.custom=path_1.join(path_1.dirname(i),t.debugConfig.custom)),this.platformConfig[e].debugConfig=t.debugConfig,!this.bundleConfig[e]&&t.assetBundleConfig&&(this.bundleConfig[e]=Object.assign({platformName:t.platformName},t.assetBundleConfig))),"object"==typeof t.options&&Editor.Profile.setConfig(o,`options.${e}`,getOptionsDefault(t.options),"default"),!("win32"===process.platform&&["mac","ios"].includes(o)||"darwin"===process.platform&&"windows"===o)){if(this.configMap[e][o]&&console.warn(`platform ${e} config in ${o} has exist!`),this.pkgPriorities[o]=t.priority||0,this.configMap[e][o]=t,"object"==typeof t.verifyRuleMap)for(const i of Object.keys(t.verifyRuleMap)){const s=t.verifyRuleMap[i];s&&s.func&&validator_manager_1.validatorManager.addRule(i,s.func,e+o),s&&s.message&&validator_manager_1.validatorManager.addMessage(i,s.message,e+o)}"string"==typeof t.hooks&&(t.hooks=path_1.isAbsolute(t.hooks)?t.hooks:path_1.join(path_1.dirname(i),t.hooks),this.builderPathsMap[e][o]=t.hooks)}}async unregister(e){try{const t=worker.query("Build"),o=require(path_1.join(e.path,e.info.contributions.builder));"function"==typeof o.unload&&await o.unload();const i=[];platforms_options_1.PLATFORMS.forEach(t=>{delete require.cache[this.builderPathsMap[t][e.name]],i.push(this.builderPathsMap[t][e.name]),delete this.builderPathsMap[t][e.name],delete this.configMap[t][e.name],delete this.pkgPriorities[e.name]}),delete require.cache[path_1.join(e.path,e.info.contributions.builder)],t.send("build-worker:unregister-build-hook",i)}catch(e){console.error(e)}}getHooksInfo(e){const t={pkgNameOrder:[],infos:{}};return Object.keys(this.builderPathsMap[e]).forEach(o=>{t.infos[o]={path:this.builderPathsMap[e][o],internal:platforms_options_1.builtinPlugins.includes(o)}}),t.pkgNameOrder=Object.keys(t.infos).sort((e,t)=>!platforms_options_1.platformPlugins.includes(e)&&platforms_options_1.platformPlugins.includes(t)?1:platforms_options_1.platformPlugins.includes(e)&&!platforms_options_1.platformPlugins.includes(t)?-1:this.pkgPriorities[t]-this.pkgPriorities[e]),t}async checkOptions(e){let t=!0;if(this.bundleConfig[e.platform]){const t=this.bundleConfig[e.platform].supportedCompressionTypes,o=await checkBundleCompressionSetting(e.mainBundleCompressionType,t),i=validator_manager_1.validator.check("valid",o.newValue);i&&lodash.set(e,"mainBundleCompressionType",o.newValue),o.error&&i&&console.warn(`${o.error} 将会使用新值 ${o.newValue}`)}else console.error("Invaild platform: "+e.platform);const o=await this.getDefaultOptionsByPlatform(e.platform),i=lodash.defaultsDeep(e,o);if(this.checkPluginOptions(i)||(t=!1),t)return i}checkPluginOptions(e){var t;if("object"!=typeof e.packages)return!1;let o=!0;for(const i of Object.keys(e.packages)){const s=e.packages[i];if(!s)continue;const r=exports.pluginManager.configMap[e.platform][i];if(r&&r.options)for(const n of Object.keys(s)){if(!r.options[n]||!r.options[n].verifyRules)continue;const a=s[n],p=validator_manager_1.validatorManager.check(a,e,r.options[n].verifyRules,e.platform+i);p&&(validator_manager_1.validator.check("valid",r.options[n].default)||null===(t=r.options[n].verifyRules)||void 0===t||!t.includes("required")?(console.warn(`${p}，options.packages.${i}.${n} will use default value ${r.options[n].default}`),lodash.set(s,n,r.options[n].default)):(console.error(`[Build check failed] ( ${i} )${p}`),o=!1))}}return o}async getDefaultOptionsByPlatform(e){const t={packages:{}},o=Object.keys(this.configMap[e]);for(const i of o)t.packages[i]=await Editor.Profile.getConfig(i,`options.${e}`,"default");return t}getPlatformConfig(){const e=JSON.parse(JSON.stringify(this.platformConfig));for(const t of Object.values(e))t.support&&(t.support.rgb&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgb),t.support.rgba&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgba));return e}}function checkBundleCompressionSetting(e,t){const o={error:"",newValue:e};return t&&-1===t.indexOf(e)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${e}) is invalid for this platform!`),o}function getOptionsDefault(e){const t={};return Object.keys(e).forEach(o=>{setConfigDefault(e[o],t,o)}),t}function setConfigDefault(e,t,o=""){if(e){if(void 0===e.default||null===e.default)return"array"===e.type&&Array.isArray(e.itemConfigs)?(t[o]=[],void e.itemConfigs.forEach((e,i)=>{setConfigDefault(e,t[o],`[${i}]`)})):void("object"===e.type&&"object"==typeof e.itemConfigs&&(t[o]={},Object.keys(e.itemConfigs).forEach(i=>{setConfigDefault(e.itemConfigs[i],t[o],i)})));lodash.set(t,o,e.default)}}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;