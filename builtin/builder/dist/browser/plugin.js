"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),platforms_options_1=require("../share/platforms-options"),texture_compress_1=require("../share/texture-compress"),validator_manager_1=require("../share/validator-manager"),lodash=require("lodash");class PluginManager{constructor(){this.bundleConfig={},this.pkgPriorities={},this.platformConfig={};const o={},t={};platforms_options_1.PLATFORMS.forEach(e=>{o[e]={},t[e]={}}),this.configMap=t,this.platformConfig=JSON.parse(JSON.stringify(t)),this.builderPathsMap=o}async init(){const o=Editor.Package.getPackages({enable:!0});await Promise.all(o.map(async o=>await this.register(o))),Editor.Package.on("enable",async o=>await this.register(o)),Editor.Package.on("disable",o=>this.unregister(o))}async register(o){if(!(o&&o.enable&&o.info&&o.info.contributions&&o.info.contributions.builder))return!1;let t=!1;if(platforms_options_1.builtinPlugins.includes(o.name)&&(Editor.Utils.Path.contains(Editor.App.path,o.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(o.name))?t=!0:platforms_options_1.builtinPlugins.includes(o.name)&&console.error(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:o.name})),"string"==typeof o.info.contributions.builder&&void 0===this.pkgPriorities[o.name]){try{const e=path_1.join(o.path,o.info.contributions.builder);if(!require.resolve(e))return;const i=require(e);if(!i.configs)return;i.load&&await i.load();const r=i.configs;if(!r)return;for(const i of Object.keys(r)){const s=i,n=r[s];if(n.internal=t,"*"!==i)platforms_options_1.builtinPlugins.includes(s)&&await this.internalRegister(s,n,o.name,e);else for(const t of platforms_options_1.PLATFORMS)await this.internalRegister(t,n,o.name,e)}}catch(t){return console.error(t),console.error(`builder package ${o.name} registration failed!`),!1}return!0}}async internalRegister(o,t,e,i){var r;if(t.internal&&"object"==typeof t.textureCompressConfig){const e=texture_compress_1.configGroups[t.textureCompressConfig.platformType];e?(e.support.rgb=lodash.union(e.support.rgb,t.textureCompressConfig.support.rgb),e.support.rgba=lodash.union(e.support.rgba,t.textureCompressConfig.support.rgba),t.textureCompressConfig.support=e.support):console.error(`Invalid platformType ${t.textureCompressConfig.platformType}`),this.platformConfig[o].textureCompressConfig=t.textureCompressConfig}t.internal&&e===o&&(this.platformConfig[o].name=t.platformName,(null===(r=t.debugConfig)||void 0===r?void 0:r.custom)&&(t.debugConfig.custom=path_1.join(path_1.dirname(i),t.debugConfig.custom)),this.platformConfig[o].debugConfig=t.debugConfig,!this.bundleConfig[o]&&t.assetBundleConfig&&(this.bundleConfig[o]=Object.assign({platformName:t.platformName},t.assetBundleConfig))),"object"==typeof t.options&&Editor.Profile.setConfig(e,`options.${o}`,getOptionsDefault(t.options),"default"),"win32"===process.platform&&["mac","ios"].includes(e)||"darwin"===process.platform&&"windows"===e||(this.configMap[o][e]&&console.warn(`platform ${o} config in ${e} has exist!`),this.pkgPriorities[e]=t.priority||0,this.configMap[o][e]=t,"string"==typeof t.hooks&&(t.hooks=path_1.isAbsolute(t.hooks)?t.hooks:path_1.join(path_1.dirname(i),t.hooks),this.builderPathsMap[o][e]=t.hooks))}async unregister(o){if(!(o&&o.info&&o.info.contributions&&o.info.contributions.builder))return!1;try{const t=require(path_1.join(o.path,o.info.contributions.builder));"function"==typeof t.unload&&await t.unload(),platforms_options_1.PLATFORMS.forEach(t=>{delete require.cache[this.builderPathsMap[t][o.name]],delete this.builderPathsMap[t][o.name],delete this.configMap[t][o.name],delete this.pkgPriorities[o.name]}),delete require.cache[path_1.join(o.path,o.info.contributions.builder)]}catch(o){console.error(o)}}getHooksInfo(o){const t={pkgNameOrder:[],infos:{}};return Object.keys(this.builderPathsMap[o]).forEach(e=>{t.infos[e]={path:this.builderPathsMap[o][e],internal:platforms_options_1.builtinPlugins.includes(e)}}),t.pkgNameOrder=Object.keys(t.infos).sort((o,t)=>!platforms_options_1.platformPlugins.includes(o)&&platforms_options_1.platformPlugins.includes(t)?1:platforms_options_1.platformPlugins.includes(o)&&!platforms_options_1.platformPlugins.includes(t)?-1:this.pkgPriorities[t]-this.pkgPriorities[o]),t}async checkOptions(o){let t=!0;for(const e of Object.keys(o)){if("packages"===e)continue;const i=o[e],r=await platforms_options_1.checkBuildCommonOptions(e,i,o),s=validator_manager_1.validator.check("valid",r.newValue);s&&lodash.set(o,e,r.newValue),!r.error||s?r.error&&s&&console.warn(`${r.error} 将会使用新值 ${r.newValue}`):(console.error(r.error),t=!1)}const e=this.bundleConfig[o.platform].supportedCompressionTypes,i=await platforms_options_1.checkBundleCompressionSetting(o.mainBundleCompressionType,e),r=validator_manager_1.validator.check("valid",i.newValue);r&&lodash.set(o,"mainBundleCompressionType",i.newValue),i.error&&r&&console.warn(`${i.error} 将会使用新值 ${i.newValue}`);const s=await this.getDefaultOptionsByPlatform(o.platform),n=Object.assign(JSON.parse(JSON.stringify(s)),o);if(this.checkPluginOptions(n)||(t=!1),t)return n}checkPluginOptions(o){var t;if("object"!=typeof o.packages)return!1;let e=!0;for(const i of Object.keys(o.packages)){const r=o.packages[i];if(!r)continue;const s=exports.pluginManager.configMap[o.platform][i];if(s&&s.options)for(const n of Object.keys(r)){if(!s.options[n]||!s.options[n].verifyRules)continue;const a=r[n],p=validator_manager_1.validatorManager.check(a,o,s.options[n].verifyRules,i);p&&(validator_manager_1.validator.check("valid",s.options[n].default)||null===(t=s.options[n].verifyRules)||void 0===t||!t.includes("required")?(console.warn(`${p}，options.packages.${i}.${n} will use default value ${s.options[n].default}`),lodash.set(r,n,s.options[n].default)):(console.error(`[Build check failed] ( ${i} )${p}`),e=!1))}}return e}async getDefaultOptionsByPlatform(o){const t=await platforms_options_1.getDefaultOptions(),e=Object.keys(this.configMap[o]);for(const i of e)t.packages[i]=await Editor.Profile.getConfig(i,`options.${o}`,"default");return t}getPlatformConfig(){const o=JSON.parse(JSON.stringify(this.platformConfig));for(const t of Object.values(o))t.support&&(t.support.rgb&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgb),t.support.rgba&&t.support.rgb.push(...texture_compress_1.defaultSupport.rgba));return o}}function getOptionsDefault(o){const t={};return Object.keys(o).forEach(e=>{setConfigDefault(o[e],t,e)}),t}function setConfigDefault(o,t,e=""){if(o){if(void 0===o.default||null===o.default)return"array"===o.type&&Array.isArray(o.itemConfigs)?(t[e]=[],void o.itemConfigs.forEach((o,i)=>{setConfigDefault(o,t[e],`[${i}]`)})):void("object"===o.type&&"object"==typeof o.itemConfigs&&(t[e]={},Object.keys(o.itemConfigs).forEach(i=>{setConfigDefault(o.itemConfigs[i],t[e],i)})));lodash.set(t,e,o.default)}}exports.pluginManager=new PluginManager;