"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createWorker=void 0;const path_1=require("path"),tasks_1=require("./tasks"),worker=require("@base/electron-worker"),Editor=require("editor");let buildWorker=null;async function createWorker(){function e(e){return Object.keys(e).map(r=>`${r}:${e[r]}`).join(",")}return buildWorker=worker.create("Build"),await buildWorker.init({preload:path_1.join(__dirname,"../../../../lib/require")}),buildWorker.require(path_1.join(__dirname,"../worker")),buildWorker.debug(!1),buildWorker.on("refresh",()=>{console.debug("builder refresh"),tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("closed",()=>{tasks_1.manager.workerReady=!1,tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("build-worker:startup",()=>{buildWorker.send("build-worker:init")}),buildWorker.on("build-worker:ready",()=>{tasks_1.manager.workerReady=!0,tasks_1.manager.step(),Editor.Message.broadcast("build-worker:ready")}),buildWorker.on("build-worker:update-progress",async(e,r,o,t,a)=>{const i=tasks_1.manager.map[r];i&&(i.update(o,t,a),await tasks_1.manager.save(),i.isCommandBuild&&console.log(`building...${(100*i.progress).toFixed(2)}% ${a}`))}),buildWorker.on("build-worker:update-button-task-progress",async(e,r,o,t,a,i)=>{if(i){const e=tasks_1.manager.map[i];if(!e)return;return e.update(o,t,a),void await tasks_1.manager.save()}}),buildWorker.on("build-worker:add-statistics",async(r,o)=>{o?(Editor.Metrics.trackEvent({category:"Build",label:e(o),action:"build"}),Editor.Metrics.trackEvent({category:"Project",label:e({platform:o.platform}),action:"build"}),Editor.Metrics.trackEvent({category:"Project",label:e({includeModules:o.includeModules}),action:"build"}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:o.platform,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:o.gameName,scenes:o.scenesNum+"",scripts:o.scriptNum+"",resources:o.assetsNum+"",moduleConf:o.includeModules&&o.includeModules.toString(),size:o.size+"",orientation:o.orientation,resUrl:o.remoteServerAddress,appd:o.appid,dimension:o.includeModules.includes("3d")?2:1})):console.error("add-statistics failed!")}),buildWorker.on("build-worker:stdout",(e,r,o)=>{console[r](o)}),buildWorker}exports.createWorker=createWorker;