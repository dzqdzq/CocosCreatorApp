"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerManager=void 0;const tasks_1=require("./tasks"),plugin_1=require("./plugin"),worker=require("@base/electron-worker");class WorkerManager{constructor(){this.worker=null,this.hasInit=!1,this._debug=!1,this.listenerMap={}}async create(){return this.worker?this.worker:(this.worker=worker.query("Assets"),this.worker?this.worker:void console.error(new Error("Can not get [Assets] worker")))}async init(){await this.create(),this.hasInit||(await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"initWorkerMessage"}),tasks_1.manager.initWorker(this.worker),this.listenerMap.register=((e,r)=>{this.worker.send("build-worker:build-plugin-changed","register",r)}),this.listenerMap.unregister=((e,r)=>{this.worker.send("build-worker:build-plugin-changed","unregister",r)}),plugin_1.pluginManager.on("register",this.listenerMap.register),plugin_1.pluginManager.on("unregister",this.listenerMap.unregister),await this.worker.send("build-worker:init",plugin_1.pluginManager.getAllWorkerPluginInfos(),!!Editor.App.args.build),tasks_1.manager.workerReady=!0,this.hasInit=!0,Editor.Message.broadcast("build-worker:ready"))}async destroy(){plugin_1.pluginManager.removeListener("register",this.listenerMap.register),plugin_1.pluginManager.removeListener("unregister",this.listenerMap.unregister)}async send(e,...r){if(this.hasInit)return await this.worker.send(e,...r)}debug(e){this._debug=e,this.worker&&this.worker.debug(e)}reset(){this.hasInit=!1,tasks_1.manager.dbReady=!1,tasks_1.manager.workerReady=!1}}exports.workerManager=new WorkerManager;