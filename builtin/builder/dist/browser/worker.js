"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,o,t){void 0===t&&(t=o),Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[o]}})}:function(e,r,o,t){void 0===t&&(t=o),e[t]=r[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(r,e,o);return __setModuleDefault(r,e),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createWorker=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),tasks_1=require("./tasks"),os=__importStar(require("os")),plugin_1=require("./plugin"),worker=require("@base/electron-worker"),CRASH_LOG_DIR=path_1.join(Editor.Project.tmpDir,"builder","crash-log");let buildWorker=null;async function createWorker(){function e(e,r){if(console.error(Editor.I18n.t("builder.error.builder_crash")),console.error(e,r),!tasks_1.manager.workerReady)return;tasks_1.manager.workerReady=!1;const o=tasks_1.manager.map[tasks_1.manager.currentTaskId];if(o){o.break(!0),tasks_1.manager.crashNum++;const t="Builder Process Creashed when build platform: "+o.options.platform;try{const o=path_1.join(CRASH_LOG_DIR,String(Date.now()));fs_extra_1.outputJSONSync(o,{type:"render-process-gone",event:e,detail:r,message:t,sysInfo:{freemem:formatByteSize(os.freemem()),totalmem:formatByteSize(os.totalmem())}})}catch(e){console.log(e)}if(tasks_1.manager.crashNum>3)return void Editor.Dialog.error(Editor.I18n.t("builder.error.builder_crash"));Editor.Task.addNotice({title:o.options.outputName,message:t,source:"builder",type:"error"}),console.error(t)}}return buildWorker=worker.create("Build"),await buildWorker.init({preload:path_1.join(__dirname,"../../../../lib/require")}),buildWorker.require(path_1.join(__dirname,"../worker")),buildWorker.debug(!1),buildWorker.on("refresh",()=>{console.debug("builder refresh"),tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("closed",()=>{tasks_1.manager.workerReady=!1,tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("build-worker:startup",()=>{buildWorker.send("build-worker:init",plugin_1.pluginManager.getAllWorkerPluginInfos())}),plugin_1.pluginManager.on("register",e=>{buildWorker.send("build-worker:build-plugin-changed","register",plugin_1.pluginManager.getWorkerPluginInfo(e))}),plugin_1.pluginManager.on("unregister",e=>{buildWorker.send("build-worker:build-plugin-changed","unregister",plugin_1.pluginManager.getWorkerPluginInfo(e))}),buildWorker.on("build-worker:ready",()=>{tasks_1.manager.workerReady=!0,tasks_1.manager.waitingForReadyResolve?(tasks_1.manager.waitingForReadyResolve(),tasks_1.manager.waitingForReadyResolve=null):tasks_1.manager.step(),Editor.Message.broadcast("build-worker:ready")}),buildWorker.on("build-worker:update-progress",async(e,r,o,t,a)=>{const i=tasks_1.manager.map[r];i&&(i.update(o,t,a),await tasks_1.manager.save(),i.isCommandBuild&&console.log(`building...${(100*i.progress).toFixed(2)}% ${a}`))}),buildWorker.on("build-worker:update-button-task-progress",async(e,r,o,t,a,i)=>{if(i){const e=tasks_1.manager.map[i];if(!e)return;return e.update(o,t,a),void await tasks_1.manager.save()}}),buildWorker.on("build-worker:add-statistics",async(e,r)=>{r?(Editor.Metrics.trackEvent({category:"Project",action:"Build 3.3",label:r.platform}),Editor.Metrics.trackEvent({category:"Project",action:"Build",label:r.platform}),r.includeModules.forEach(e=>{Editor.Metrics.trackEvent({category:"Project",action:"Modules 3.4",label:e})}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:r.platform,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:r.gameName,packageName:r.packageName||"",scenes:r.scenesNum+"",scripts:r.scriptNum+"",resources:r.assetsNum+"",moduleConf:r.includeModules&&r.includeModules.toString(),size:r.size+"",orientation:r.orientation,resUrl:r.remoteServerAddress,appd:r.appid,dimension:r.includeModules.includes("3d")?2:1})):console.error("add-statistics failed!")}),buildWorker.on("build-worker:stdout",(e,r,o)=>{console[r](o)}),buildWorker.on("render-process-gone",(r,o,t)=>{e(r,o)}),buildWorker.win.webContents.on("render-process-gone",(r,o)=>{e(r,o)}),buildWorker}function formatByteSize(e){return(e/1024/1024).toFixed(2)+"MB"}exports.createWorker=createWorker;