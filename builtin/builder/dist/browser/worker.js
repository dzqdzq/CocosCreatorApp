"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t),Object.defineProperty(e,o,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createWorker=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),tasks_1=require("./tasks"),os=__importStar(require("os")),worker=require("@base/electron-worker"),CRASH_LOG_DIR=path_1.join(Editor.Project.tmpDir,"builder","crash-log");let buildWorker=null;async function createWorker(){function e(e){return Object.keys(e).map(r=>`${r}:${e[r]}`).join(",")}function r(e,r){if(console.error(e,r),!tasks_1.manager.workerReady)return;tasks_1.manager.workerReady=!1;const t=tasks_1.manager.map[tasks_1.manager.currentTaskId];if(t){t.break(!0),tasks_1.manager.crashNum++;let o="Builder Process Creashed when build platform: "+t.options.platform;try{const t=path_1.join(CRASH_LOG_DIR,String(Date.now()));fs_extra_1.outputJSONSync(t,{type:"render-process-gone",event:e,detail:r,message:o,sysInfo:{freemem:formatByteSize(os.freemem()),totalmem:formatByteSize(os.totalmem())}})}catch(e){console.log(e)}if(tasks_1.manager.crashNum>3)return void Editor.Dialog.error(Editor.I18n.t("builder.error.builder_crash"));Editor.Task.addNotice({title:t.options.outputName,message:o,source:"builder",type:"error"}),console.error(o)}}return buildWorker=worker.create("Build"),await buildWorker.init({preload:path_1.join(__dirname,"../../../../lib/require")}),buildWorker.require(path_1.join(__dirname,"../worker")),buildWorker.debug(!1),buildWorker.on("refresh",()=>{console.debug("builder refresh"),tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("closed",()=>{tasks_1.manager.workerReady=!1,tasks_1.manager.break(),Editor.Message.broadcast("build-worker:closed")}),buildWorker.on("build-worker:startup",()=>{buildWorker.send("build-worker:init")}),buildWorker.on("build-worker:ready",()=>{tasks_1.manager.workerReady=!0,tasks_1.manager.waitingForReadyResolve?(tasks_1.manager.waitingForReadyResolve(),tasks_1.manager.waitingForReadyResolve=null):tasks_1.manager.step(),Editor.Message.broadcast("build-worker:ready")}),buildWorker.on("build-worker:update-progress",async(e,r,t,o,a)=>{const s=tasks_1.manager.map[r];s&&(s.update(t,o,a),await tasks_1.manager.save(),s.isCommandBuild&&console.log(`building...${(100*s.progress).toFixed(2)}% ${a}`))}),buildWorker.on("build-worker:update-button-task-progress",async(e,r,t,o,a,s)=>{if(s){const e=tasks_1.manager.map[s];if(!e)return;return e.update(t,o,a),void await tasks_1.manager.save()}}),buildWorker.on("build-worker:add-statistics",async(r,t)=>{t?(Editor.Metrics.trackEvent({category:"Build",label:e(t),action:"build"}),Editor.Metrics.trackEvent({category:"Project",label:e({platform:t.platform}),action:"build"}),Editor.Metrics.trackEvent({category:"Project",label:e({includeModules:t.includeModules}),action:"build"}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:t.platform,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:t.gameName,packageName:t.packageName||"",scenes:t.scenesNum+"",scripts:t.scriptNum+"",resources:t.assetsNum+"",moduleConf:t.includeModules&&t.includeModules.toString(),size:t.size+"",orientation:t.orientation,resUrl:t.remoteServerAddress,appd:t.appid,dimension:t.includeModules.includes("3d")?2:1})):console.error("add-statistics failed!")}),buildWorker.on("build-worker:stdout",(e,r,t)=>{console[r](t)}),buildWorker.on("render-process-gone",(e,t,o)=>{r(e,t)}),buildWorker.win.webContents.on("render-process-gone",(e,t)=>{r(e,t)}),buildWorker}function formatByteSize(e){return(e/1024/1024).toFixed(2)+"MB"}exports.createWorker=createWorker;