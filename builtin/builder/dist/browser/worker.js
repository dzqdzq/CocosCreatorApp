"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createWorker=void 0;const path_1=require("path"),tasks_1=require("./tasks"),worker=require("@base/electron-worker"),Editor=require("editor");let buildWorker=null;async function createWorker(){return buildWorker=worker.create("Build"),await buildWorker.init({preload:path_1.join(__dirname,"../../../../lib/require")}),buildWorker.require(path_1.join(__dirname,"../worker")),buildWorker.debug(!1),buildWorker.on("refresh",()=>{tasks_1.manager.break()}),buildWorker.on("closed",()=>{tasks_1.manager.workerReady=!1,tasks_1.manager.break()}),buildWorker.on("build-worker:startup",()=>{buildWorker.send("build-worker:init")}),buildWorker.on("build-worker:ready",()=>{tasks_1.manager.workerReady=!0,tasks_1.manager.step()}),buildWorker.on("build-worker:update-progress",async(e,r,o,t,i)=>{const s=tasks_1.manager.map[r];s&&(s.update(o,t,i),await tasks_1.manager.save(),s.isCommandBuild&&console.log(`building...${(100*s.progress).toFixed(2)}% ${i}`))}),buildWorker.on("build-worker:update-button-task-progress",async(e,r,o,t,i,s)=>{if(s){const e=tasks_1.manager.map[s];if(!e)return;e.update(o,t,i)}else;}),buildWorker.on("build-worker:add-statistics",async(e,r)=>{if(!r)return void console.error("add-statistics failed!");const o=Object.keys(r).map(e=>`${e}:${r[e]}`).join(",");Editor.Metrics.trackEvent({category:"Build",label:o,action:"build"}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:r.platform,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:r.gameName,scenes:r.scenesNum+"",scripts:r.scriptNum+"",resources:r.assetsNum+"",moduleConf:r.includeModules&&r.includeModules.toString(),size:r.size+"",orientation:r.orientation,resUrl:r.remoteServerAddress,appd:r.appid,dimension:r.includeModules.includes("3d")?2:1})}),buildWorker.on("build-worker:stdout",(e,r,o)=>{console[r](o)}),buildWorker}exports.createWorker=createWorker;