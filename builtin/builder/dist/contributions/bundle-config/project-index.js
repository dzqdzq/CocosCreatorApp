"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,n)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.importConfig=exports.exportConfig=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../share/bundle-utils"),utils_1=require("../../share/utils"),BundleConfigGroup=__importStar(require("./bundle-config-group"));let vm,panel=null;const Vue=require("vue/dist/vue.js");async function ready(e){vm&&vm.$destroy(),vm=new Vue({el:(panel=this).$.config,components:{"config-group":BundleConfigGroup},data:{renderConfigs:null,customConfigs:null,renameState:{},mousedownHandle:null,defaultConfig:JSON.parse(JSON.stringify(bundle_utils_1.DefaultBundleConfig))},async mounted(){const t=this;await t.initData(),this.mousedownHandle=this.onMouseDown.bind(this),document.addEventListener("mousedown",this.mousedownHandle),e&&Vue.nextTick(()=>{t.jumpToConfig(e)})},destroyed(){document.removeEventListener("mousedown",this.mousedownHandle)},methods:{async initData(){const e=this;e.renderConfigs=Object.freeze(await Editor.Message.request("builder","query-bundle-config")),e.customConfigs=await Editor.Profile.getProject("builder","bundleConfig.custom"),e.customConfigs.default&&(e.defaultConfig=e.customConfigs.default)},onRename(e,t,i){i.displayName=e||i.displayName,this.$set(this.renameState,t,!1),this.saveConfig()},configMenu(e,t,i){Editor.Menu.popup({x:e.x,y:e.y,menu:[{label:"i18n:builder.copyConfig",click:()=>{this.newConfig(i)}},{label:"i18n:builder.copyID",click:()=>{Editor.Clipboard.write("text",t)}},{label:"i18n:builder.rename",enabled:"default"!==t,click:()=>{this.$set(this.renameState,t,!0),this.$nextTick(()=>{vm.$refs[`renameInput${t}`][0].focus({preventScroll:!0}),vm.$refs[`renameInput${t}`][0].$input.setSelectionRange(0,i.displayName.length)})}},{label:"i18n:builder.delete",enabled:"default"!==t,click:()=>{this.deleteConfig(t)}}]})},newConfig(e){let t=(e=e||bundle_utils_1.DefaultBundleConfig).displayName;t.startsWith("i18n")&&(t=(0,utils_1.transI18nName)(t)),this.customConfigs||(this.customConfigs={});const i=Editor.Utils.UUID.generate();this.$set(this.customConfigs,i,Object.assign(Object.assign({},e),{displayName:t+" Copy"})),this.saveConfig(),Vue.nextTick(()=>{this.jumpToConfig(i)})},saveDefaultConfig(){this.$set(this.customConfigs,"default",this.defaultConfig),this.saveConfig()},saveConfig(){Editor.Profile.setProject("builder","bundleConfig.custom",this.customConfigs)},deleteConfig(e){this.$set(this.customConfigs,e,null),delete this.customConfigs[e],this.saveConfig()},async importConfig(){const e=(await Editor.Dialog.select({title:"i18n:builder.asset_bundle.importConfig",path:Editor.Project.path,filters:[{name:"JSON",extensions:["json"]}]})).filePaths[0];if(!e)return;let t=!0;if(this.customConfigs){t=1===(await Editor.Dialog.warn("i18n:builder.project.texture_compress.import_config_options",{buttons:["Overwrite","merge"],default:1})).response}try{const i=(0,fs_extra_1.readJSONSync)(e);if(t)for(const e of Object.keys(i))this.$set(this.customConfigs,e,i[e]);else this.customConfigs=i;this.customConfigs.default&&(this.defaultConfig=this.customConfigs.default),this.saveConfig()}catch(e){return void console.error(e)}},async exportConfig(){const e=await Editor.Dialog.save({title:"i18n:builder.asset_bundle.exportConfig",path:(0,path_1.join)(Editor.Project.path,"bundle-config.json"),filters:[{name:"JSON",extensions:["json"]}]});e.filePath&&(await(0,fs_extra_1.outputFile)(e.filePath,JSON.stringify(this.customConfigs,null,2)),console.log(`Texture compress config has export in {link(${e.filePath})}.`))},onMouseDown(e){this.renameState={}},jumpToConfig(e){const t=Array.isArray(this.$refs[e])?this.$refs[e][0]:this.$refs[e];t&&(t.scrollIntoView(),t.setAttribute("twinkle","shake"),setTimeout(()=>{t.setAttribute("twinkle","")},900))}}})}function exportConfig(){if(vm)return{bundleConfig:vm.customConfigs}}function importConfig(e){vm&&(vm.customConfigs=e.bundleConfig)}function close(){vm&&(vm.$destroy(),vm=null)}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/bundle-config.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/bundle-config.html"),"utf8"),exports.$={config:"#projectBundleConfig"},exports.ready=ready,exports.exportConfig=exportConfig,exports.importConfig=importConfig,exports.close=close;