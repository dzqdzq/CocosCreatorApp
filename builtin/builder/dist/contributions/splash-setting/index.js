"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),fs_extra_1=require("fs-extra"),preview_container_1=require("./preview-container");let vm,panel=null;const Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;const select_image="i18n:builder.splashSetting.selectImage",SPLASH_DIR=(0,path_1.join)(Editor.Project.path,"settings");async function ready(){vm=new Vue({el:(panel=this).$.splash,components:{PreviewContainer:preview_container_1.PreviewContainer},data:{settings:{},defaultSettings:null,watermarkLocationConfig:[{label:Editor.I18n.t("builder.splashSetting.default"),value:"default"},{label:joindWatermarkPosLabel("top","left"),value:"topLeft"},{label:joindWatermarkPosLabel("top","center"),value:"topCenter"},{label:joindWatermarkPosLabel("top","right"),value:"topRight"},{label:joindWatermarkPosLabel("bottom","left"),value:"bottomLeft"},{label:joindWatermarkPosLabel("bottom","center"),value:"bottomCenter"},{label:joindWatermarkPosLabel("bottom","right"),value:"bottomRight"}],previewContainer:{width:1280,height:720},showMask:!1},computed:{displayRatio(){return this.settings.displayRatio?(100*this.settings.displayRatio).toFixed():100},logoType(){var t;return(null===(t=this.settings.logo)||void 0===t?void 0:t.type)||"default"},backgroundType(){var t;return(null===(t=this.settings.background)||void 0===t?void 0:t.type)||"default"},backgroundColor(){var t;const e=this;if(null===(t=e.settings.background)||void 0===t?void 0:t.color){const t=["x","y","z","w"].map(t=>255*e.settings.background.color[t]);return JSON.stringify(t)}return"[4,9,10,255]"},customLogoSrcLabel(){var t,e;const o=this;return(null===(t=o.settings.logo)||void 0===t?void 0:t.image)&&(null===(e=o.defaultSettings)||void 0===e?void 0:e.logo)&&o.settings.logo.image!==o.defaultSettings.logo.image?(0,path_1.basename)(o.settings.logo.image):select_image},customBackgroundSrcLabel(){var t;const e=this;return(null===(t=e.settings.background)||void 0===t?void 0:t.image)?(0,path_1.basename)(e.settings.background.image):select_image},customLogoDisable(){return this.customLogoSrcLabel===select_image},customBackgroundDisable(){return this.customBackgroundSrcLabel===select_image}},async mounted(){await this.initData()},methods:{async onConfirm(t){const e=t.target.getAttribute("name");if(!e)return;let o=t.target.value;"displayRatio"===e&&o&&(o/=100),this.saveSettings(e,o)},async saveSettings(t,e){this.$set(this.settings,t,e),await Editor.Profile.setProject("builder",`splash-setting.${t}`,e)},async onTypeChange(t,e){const o=e.target.value,s=this;s.$set(s.settings[t],"type",o),await Editor.Profile.setProject("builder",`splash-setting.${t}.type`,o),"logo"===t?s.handleLogoSrc():s.handleBackgroundSrc()},async onBackgroundColorConfirm(t){const e=t.target.value,o={x:e[0]/255,y:e[1]/255,z:e[2]/255,w:e[3]/255};this.$set(this.settings.background,"color",o),await Editor.Profile.setProject("builder","splash-setting.background.color",o),this.handleBackgroundSrc()},async initData(){const t=this;await checkCustomSplash()&&(t.showMask=!0),t.defaultSettings=await Editor.Profile.getProject("builder","splash-setting","default"),t.settings=await Editor.Profile.getProject("builder","splash-setting");const e=await Editor.Profile.getProject("project","general.designResolution");t.previewContainer.width=e.width,t.previewContainer.height=e.height,t.handleBackgroundSrc(),t.handleLogoSrc()},async reset(){this.settings=JSON.parse(JSON.stringify(this.defaultSettings)),await Editor.Profile.removeProject("builder","splash-setting","project"),this.handleBackgroundSrc(),this.handleLogoSrc()},async selectImage(t){const e=(await Editor.Dialog.select({type:"file",multi:!1,filters:[{extensions:["png","jpg","jpeg"],name:"Image"}]})).filePaths[0];if(!e)return;await this.updateImageSrc(t,e)},async updateImageSrc(t,e){const o=this;let s;if((0,fs_1.existsSync)(e))s=e;else{const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return void console.error(`Can't get asset info(${e}) from uuid`);s=t.file}const i=(0,path_1.join)(SPLASH_DIR,(0,path_1.basename)(s));s!==i&&(await(0,fs_extra_1.copy)(s,i,{overwrite:!0}),e=Editor.UI.__protected__.File.resolveToUrl(i,"project"),o.$set(o.settings[t],"image",e),await Editor.Profile.setProject("builder",`splash-setting.${t}.image`,e),"logo"===t?o.handleLogoSrc():o.handleBackgroundSrc())},handleLogoSrc(){const t=this;if("none"===t.settings.logo.type)return void t.$delete(t.settings,"logoSrc");const e="custom"===t.settings.logo.type?t.settings.logo.image:t.defaultSettings.logo.image;t.$set(t.settings,"logoSrc",Editor.UI.__protected__.File.resolveToRaw(e)+`?timestamp=${Date.now()}`)},handleBackgroundSrc(){const t=this;if("custom"!==t.settings.background.type)return void t.$delete(t.settings,"backgroundSrc");const e=t.settings.background.image;t.$set(t.settings,"backgroundSrc",Editor.UI.__protected__.File.resolveToRaw(e)+`?timestamp=${Date.now()}`)},async enableCustomSplash(){const t=this;try{if(await Editor.Message.request("information","has-dialog","customSplash"))return;switch((await Editor.Message.request("information","open-information-dialog","customSplash")).action){case"resolve":t.showMask=!1;break;case"unusual":console.warn(Editor.I18n.t("builder.splashSetting.informationDialogUnusual"))}}catch(t){console.debug(t)}},async previewInBrowser(){Editor.Message.send("preview","open-terminal",{openMode:"browser",splashPreview:!0})}}})}async function exportConfig(){const t={};return t["splash-setting"]=await Editor.Message.request("project","query-config","builder","splash-setting")||{},t}async function importConfig(t){t["splash-setting"]&&await Editor.Message.request("project","set-config","builder","splash-setting",t["splash-setting"])}function joindWatermarkPosLabel(t,e){return`${Editor.I18n.t(`builder.splashSetting.watermarkLocationConfig.${t}`)} - ${Editor.I18n.t(`builder.splashSetting.watermarkLocationConfig.${e}`)}`}async function checkCustomSplash(){try{const t=await Editor.Message.request("information","query-information","customSplash");if(t&&("network_failure"===t.status||"network_exception"===t.status||t.data&&t.data.enable&&!t.data[t.data.id].complete))return!0}catch(t){console.debug(t)}return!1}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/splash-setting.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/splash-setting.html"),"utf8"),exports.$={splash:"#splashSetting"},exports.methods={},exports.ready=ready,exports.exportConfig=exportConfig,exports.importConfig=importConfig;