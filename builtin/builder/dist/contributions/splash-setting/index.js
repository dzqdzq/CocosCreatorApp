"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),fs_extra_1=require("fs-extra"),preview_container_1=require("./preview-container"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let vm,panel=null;const SELECT_IMAGE="i18n:builder.splashSetting.selectImage",SPLASH_DIR=(0,path_1.join)(Editor.Project.path,"settings");function jointWatermarkPosLabel(t,e){return`${Editor.I18n.t(`builder.splashSetting.watermarkLocationConfig.${t}`)} - ${Editor.I18n.t(`builder.splashSetting.watermarkLocationConfig.${e}`)}`}const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/splash-setting.html"),"utf8"),SplashSettingVM=Vue.extend({name:"SplashSettingVM",components:{PreviewContainer:preview_container_1.PreviewContainer},data:()=>({settings:{},defaultSettings:null,watermarkLocationConfig:[{label:Editor.I18n.t("builder.splashSetting.default"),value:"default"},{label:jointWatermarkPosLabel("top","left"),value:"topLeft"},{label:jointWatermarkPosLabel("top","center"),value:"topCenter"},{label:jointWatermarkPosLabel("top","right"),value:"topRight"},{label:jointWatermarkPosLabel("bottom","left"),value:"bottomLeft"},{label:jointWatermarkPosLabel("bottom","center"),value:"bottomCenter"},{label:jointWatermarkPosLabel("bottom","right"),value:"bottomRight"}],previewContainer:{width:1280,height:720},showMask:!1}),computed:{displayRatio(){return this.settings.displayRatio?(100*this.settings.displayRatio).toFixed():"100"},logoType(){var t;return(null===(t=this.settings.logo)||void 0===t?void 0:t.type)||"default"},backgroundType(){var t;return(null===(t=this.settings.background)||void 0===t?void 0:t.type)||"default"},backgroundColor(){var t;if(null===(t=this.settings.background)||void 0===t?void 0:t.color){const t=["x","y","z","w"].map(t=>255*this.settings.background.color[t]);return JSON.stringify(t)}return"[4,9,10,255]"},customLogoSrcLabel(){var t,e;return(null===(t=this.settings.logo)||void 0===t?void 0:t.image)&&(null===(e=this.defaultSettings)||void 0===e?void 0:e.logo)&&this.settings.logo.image!==this.defaultSettings.logo.image?(0,path_1.basename)(this.settings.logo.image):SELECT_IMAGE},customBackgroundSrcLabel(){var t;return(null===(t=this.settings.background)||void 0===t?void 0:t.image)?(0,path_1.basename)(this.settings.background.image):SELECT_IMAGE},customLogoDisable(){return this.customLogoSrcLabel===SELECT_IMAGE},customBackgroundDisable(){return this.customBackgroundSrcLabel===SELECT_IMAGE}},async mounted(){await this.initData()},methods:{async onConfirm(t){const e=t.target.getAttribute("name");if(!e)return;let i=t.target.value;"displayRatio"===e&&i&&(i/=100),this.saveSettings(e,i)},async saveSettings(t,e){this.$set(this.settings,t,e),await Editor.Profile.setProject("builder",`splash-setting.${t}`,e)},async onTypeChange(t,e){const i=e.target.value;this.$set(this.settings[t],"type",i),await Editor.Profile.setProject("builder",`splash-setting.${t}.type`,i),"logo"===t?this.handleLogoSrc():this.handleBackgroundSrc()},async onBackgroundColorConfirm(t){const e=t.target.value,i={x:e[0]/255,y:e[1]/255,z:e[2]/255,w:e[3]/255};this.$set(this.settings.background,"color",i),await Editor.Profile.setProject("builder","splash-setting.background.color",i),this.handleBackgroundSrc()},async initData(){await checkCustomSplash()&&(this.showMask=!0),this.defaultSettings=await Editor.Profile.getProject("builder","splash-setting","default"),this.settings=await Editor.Profile.getProject("builder","splash-setting");const t=await Editor.Profile.getProject("project","general.designResolution");this.previewContainer.width=t.width,this.previewContainer.height=t.height,this.handleBackgroundSrc(),this.handleLogoSrc()},async reset(){this.settings=JSON.parse(JSON.stringify(this.defaultSettings)),await Editor.Profile.removeProject("builder","splash-setting","project"),this.handleBackgroundSrc(),this.handleLogoSrc()},async selectImage(t){const e=(await Editor.Dialog.select({type:"file",multi:!1,filters:[{extensions:["png","jpg","jpeg"],name:"Image"}]})).filePaths[0];e&&await this.updateImageSrc(t,e)},async updateImageSrc(t,e){let i;if((0,fs_1.existsSync)(e))i=e;else{const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return void console.error(`Can't get asset info(${e}) from uuid`);i=t.file}const s=(0,path_1.join)(SPLASH_DIR,(0,path_1.basename)(i));i!==s&&(await(0,fs_extra_1.copy)(i,s,{overwrite:!0}),e=Editor.UI.__protected__.File.resolveToUrl(s,"project"),this.$set(this.settings[t],"image",e),await Editor.Profile.setProject("builder",`splash-setting.${t}.image`,e),"logo"===t?this.handleLogoSrc():this.handleBackgroundSrc())},handleLogoSrc(){var t;if("none"===this.settings.logo.type)return void this.$delete(this.settings,"logoSrc");const e="custom"===this.settings.logo.type?this.settings.logo.image:null===(t=this.defaultSettings)||void 0===t?void 0:t.logo.image;this.$set(this.settings,"logoSrc",Editor.UI.__protected__.File.resolveToRaw(e)+`?timestamp=${Date.now()}`)},handleBackgroundSrc(){if("custom"!==this.settings.background.type)return void this.$delete(this.settings,"backgroundSrc");const t=this.settings.background.image;this.$set(this.settings,"backgroundSrc",Editor.UI.__protected__.File.resolveToRaw(t)+`?timestamp=${Date.now()}`)},async enableCustomSplash(){try{if(await Editor.Message.request("information","has-dialog","customSplash"))return;switch((await Editor.Message.request("information","open-information-dialog","customSplash")).action){case"resolve":this.showMask=!1;break;case"unusual":console.warn(Editor.I18n.t("builder.splashSetting.informationDialogUnusual"))}}catch(t){console.debug(t)}},async previewInBrowser(){Editor.Message.send("preview","open-terminal",{openMode:"browser",splashPreview:!0})}},template:vueTemplate});function ready(){panel=this,null===vm||void 0===vm||vm.$destroy(),(vm=new SplashSettingVM).$mount(panel.$.container)}function close(){null===vm||void 0===vm||vm.$destroy(),vm=null,panel=null}async function exportConfig(){const t={};return t["splash-setting"]=await Editor.Message.request("project","query-config","builder","splash-setting")||{},t}async function importConfig(t){t["splash-setting"]&&await Editor.Message.request("project","set-config","builder","splash-setting",t["splash-setting"])}async function checkCustomSplash(){try{const t=await Editor.Message.request("information","query-information","customSplash");if(t&&("network_failure"===t.status||"network_exception"===t.status||t.data&&t.data.enable&&!t.data[t.data.id].complete))return!0}catch(t){console.debug(t)}return!1}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/splash-setting.css"),"utf8"),exports.template='\n<div class="container"></div>\n',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;