"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.listeners=exports.update=exports.template=void 0;const validator_manager_1=require("../../share/validator-manager"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:"",debug:""};async function update(e){if(!e||!e.itemConfigs&&!e.render)return;const t=this.$this;e.itemConfigs?Object.keys(e.itemConfigs).forEach(r=>{const a=e.itemConfigs[r],i=lodash.get(e.value,r);t.$items[r]?([null,void 0].includes(i)||(a.value=i,t.valueDirty=!0),a.verifyLevel=a.verifyLevel||"error",t.$items[r].dump=a,t.$items[r].render(a)):console.debug(`${r} has not init`)}):([null,void 0].includes(e.value)||(t.$ui.value=e.value),updateRenderUI(t.$ui,e),await checkTargetValue(t,e)),e.verifyLevel=e.verifyLevel||"error",t.dump=e,t.removeAttribute("dump"),t.valueDirty&&(t.dispatch("change"),t.valueDirty=!1)}async function ready(){const e=this.$this,t=e.dump;if(e.className="build-prop",[void 0,null].includes(t.value)&&![void 0,null].includes(t.default)&&(t.value=t.default),t.verifyRules&&t.verifyRules.includes("required")&&(e.innerHTML='<span class="required">*</span>'),t.label){const r=initLabel(t);r.setAttribute("slot","label"),e.appendChild(r)}if(t.itemConfigs){const r=document.createElement("div");r.setAttribute("slot","content"),e.appendChild(r),e.$items={},Object.keys(t.itemConfigs).forEach(a=>{const i=t.itemConfigs[a],n=document.createElement("ui-prop");r.appendChild(n),n.customInfo=e.customInfo,n.setAttribute("type","build"),n.className="build-prop",e.$items[a]=n,i.verifyLevel=i.verifyLevel||"error",n.dump=i,n.addEventListener("change",t=>{t.stopPropagation(),t.stopImmediatePropagation(),lodash.set(e.dump.value,a,n.dump.value),e.dispatch("change")}),n.render(i)})}else{t.verifyLevel=t.verifyLevel||"error";const r=initRenderUI(t);r&&(e.$ui=r,e.appendChild(r)),await checkTargetValue(e,e.dump)}e.valueDirty&&(e.dispatch("change"),e.valueDirty=!1)}function checkDisabledWhen(e,t){try{return new Function("options",`with(options) { return ${e}}`)(t)}catch(e){console.error(e)}return null}function toggleErrorState(e,t,r){if(e.$errorMap=e.$errorMap||{},!(r=r||"")&&!e.$errorMap[t]||!r&&e.$errorMap[t]&&"none"===e.$errorMap[t].style.display)return;e.$errorMap[t]||(e.$errorMap[t]=document.createElement("ui-prop"),e.$errorMap[t].innerHTML=`<ui-label slot="content" value="${r}" tooltip="${r}"></ui-label>`);const a=e.$errorMap[t];e.$errorMap[t].setAttribute("value",r||""),e.$errorMap[t].setAttribute("tooltip",null!==r&&void 0!==r?r:""),a.className="error",a.setAttribute("error",""),r?(e.setAttribute("error",""),a.style.display="block"):(e.removeAttribute("error"),a.style.display="none"),e.appendChild(a),e.$errorMap[t]=a}async function onChange(e,t){t!==e.dump.value&&(e.dump.value=t,await checkTargetValue(e,e.dump),e.dispatch("change"),e.valueDirty=!1)}async function checkTargetValue(e,t){var r,a;if(e.customInfo){const{options:r,pkgKey:a}=e.customInfo;t.message=await checkValue(t,t.value,r,a)}else t.message=await checkValue(t,t.value);e.message!==t.message&&(e.message||t.message)&&(e.valueDirty=!0),e.message=t.message,e.message?e.classList.add(null!==(r=t.verifyLevel&&MessageTypeMap[t.verifyLevel])&&void 0!==r?r:"danger"):e.classList.remove(null!==(a=t.verifyLevel&&MessageTypeMap[t.verifyLevel])&&void 0!==a?a:"danger")}async function checkValue(e,t,r,a){const{verifyRules:i,render:n}=e;if(i&&n){if(validator_manager_1.validator.checkWithInternalRule("valid",t)||!validator_manager_1.validator.checkWithInternalRule("required",t)||i.includes("required")){return await validator_manager_1.validatorManager.check(t,i,r,a)||null}return null}return null}function initLabel(e){const t=document.createElement("ui-label");if(t.value=e.label,e.description&&t.setAttribute("tooltip",e.description),e.experiment){const e=document.createElement("div");return e.appendChild(t),e.innerHTML+='<ui-icon color tooltip="i18n:builder.experiment" value="experiment"></ui-icon>',e}return t}function initRenderUI(e){if(!e.render)return null;const t=document.createElement(e.render.ui);if(t.setAttribute("slot","content"),"ui-select"===e.render.ui&&e.render.items){let r="";e.render.items.forEach(e=>{e.label=transI18nName(e.label),r+=`<option value="${e.value}">${e.label}</option>`}),t.innerHTML=r}return t}function updateRenderUI(e,t){var r,a,i;if(t.render.attributes&&Object.keys(t.render.attributes).forEach(r=>{!1===t.render.attributes[r]?e.removeAttribute(r):e.setAttribute(r,String(t.render.attributes[r]))}),"ui-select"===t.render.ui&&t.render.items){let n="";t.render.items.forEach(e=>{n+=`<option value="${e.value}">${e.label}</option>`}),e.innerHTML=n,e.setAttribute("value",null!==(i=null!==(a=null!==(r=t.value)&&void 0!==r?r:t.default)&&void 0!==a?a:t.render.items[0].value)&&void 0!==i?i:"")}}function transI18nName(e){return"string"!=typeof e?"":e.startsWith("i18n:")?(e=e.replace("i18n:",""),Editor.I18n.t(e)||console.debug(`${e} is not defined in 1i8n`),Editor.I18n.t(e)||e):e}exports.template="",exports.update=update,exports.listeners={change(e){const t=this.$this,r=e.target;r!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),onChange(t,r.value))},confirm(e){const t=this.$this;e.target!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),t.dispatch("confirm"))}},exports.ready=ready;