"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.listeners=exports.template=void 0,exports.update=update,exports.ready=ready;const utils_1=require("../../share/utils"),validator_manager_1=require("../../share/validator-manager"),lodash=require("lodash"),PROP_SPLIT_POSITION="40",PROP_SPLIT_DISABLED=!0,MessageTypeMap={warn:"warn",error:"danger",log:"",debug:""};async function update(a){if(a&&(a.itemConfigs||a.render)){const i=this.$this;var e;a.render&&a.render.ui&&a.render.ui.toLocaleLowerCase()!==i.$ui?.tagName.toLocaleLowerCase()&&(Build.debugMode&&console.debug("ui-prop need reload",a.label),i.$ui&&i.removeChild(i.$ui),e=initRenderUI(a))&&(i.$ui=e,i.appendChild(e)),a.itemConfigs?Object.keys(a.itemConfigs).forEach(e=>{var t=a.itemConfigs[e],r=lodash.get(a.value,e);i.$items[e]?([null,void 0].includes(r)||(t.value=r,i.valueDirty=!0),t.verifyLevel=t.verifyLevel||"error",i.$items[e].dump=t,i.$items[e].render(t)):console.debug(e+" has not init")}):([null,void 0].includes(a.value)||(i.$ui.value=a.value),updateRenderUI(i.$ui,a),await checkTargetValue(i,a)),a.verifyLevel=a.verifyLevel||"error",i.dump=a,i.removeAttribute("dump"),i.valueDirty&&(i.dispatch("change"),i.valueDirty=!1)}}async function ready(){const a=this.$this,i=a.dump;if(a.className="build-prop",a.innerHTML="",[void 0,null].includes(i.value)&&![void 0,null].includes(i.default)&&(i.value=i.default),i.verifyRules&&i.verifyRules.includes("required")&&(a.innerHTML='<span class="required">*</span>'),i.label&&((e=initLabel(i)).setAttribute("slot","label"),a.appendChild(e)),i.itemConfigs){const n=document.createElement("ui-prop-split");n.setAttribute("slot","content"),n.setAttribute("position",PROP_SPLIT_POSITION),PROP_SPLIT_DISABLED&&n.setAttribute("disabled",""),a.appendChild(n),a.$items={},Object.keys(i.itemConfigs).forEach(t=>{var e=i.itemConfigs[t];const r=document.createElement("ui-prop");n.appendChild(r),r.customInfo=a.customInfo,r.setAttribute("type","build"),r.className="build-prop",a.$items[t]=r,e.verifyLevel=e.verifyLevel||"error",r.dump=e,r.addEventListener("change",e=>{e.stopPropagation(),e.stopImmediatePropagation(),lodash.set(a.dump.value,t,r.dump.value),a.dispatch("change")}),r.render(e)})}else{i.verifyLevel=i.verifyLevel||"error";var e=initRenderUI(i);e&&(a.$ui=e,a.appendChild(e)),await checkTargetValue(a,a.dump)}a.valueDirty&&(a.dispatch("change"),a.valueDirty=!1)}function checkDisabledWhen(e,t){try{return new Function("options",`with(options) { return ${e}}`)(t)}catch(e){console.error(e)}return null}function toggleErrorState(e,t,r){var a;e.$errorMap=e.$errorMap||{},!(r=r||"")&&!e.$errorMap[t]||!r&&e.$errorMap[t]&&"none"===e.$errorMap[t].style.display||(e.$errorMap[t]||(e.$errorMap[t]=document.createElement("ui-prop"),e.$errorMap[t].innerHTML=`<ui-label slot="content" value="${r}" tooltip="${r}"></ui-label>`),a=e.$errorMap[t],e.$errorMap[t].setAttribute("value",r||""),e.$errorMap[t].setAttribute("tooltip",r??""),a.className="error",a.setAttribute("error",""),r?(e.setAttribute("error",""),a.style.display="block"):(e.removeAttribute("error"),a.style.display="none"),e.appendChild(a),e.$errorMap[t]=a)}async function onChange(e,t){t!==e.dump.value&&(e.dump.value=t,await checkTargetValue(e,e.dump),e.dispatch("change"),e.valueDirty=!1)}async function checkTargetValue(e,t){var r,a;e.customInfo?({options:r,pkgKey:a}=e.customInfo,t.message=await checkValue(t,t.value,r,a)):t.message=await checkValue(t,t.value),e.message!==t.message&&(e.message||t.message)&&(e.valueDirty=!0),e.message=t.message,e.message?e.classList.add((t.verifyLevel&&MessageTypeMap[t.verifyLevel])??"danger"):e.classList.remove((t.verifyLevel&&MessageTypeMap[t.verifyLevel])??"danger")}async function checkValue(e,t,r,a){var{verifyRules:e,render:i}=e;return e&&i&&(validator_manager_1.validator.checkWithInternalRule("valid",t)||!validator_manager_1.validator.checkWithInternalRule("required",t)||e.includes("required"))&&await validator_manager_1.validatorManager.check(t,e,r,a)||null}function initLabel(e){var t=document.createElement("ui-label");return t.value=e.label,e.description&&t.setAttribute("tooltip",e.description),e.experiment?((e=document.createElement("div")).innerHTML+='<ui-icon color style="margin-right: 2px;" tooltip="i18n:builder.experiment" value="experiment"></ui-icon>',e.appendChild(t),e):t}function initRenderUI(t){if(!t.render)return null;var e=document.createElement(t.render.ui);e.setAttribute("slot","content");let r="";return"ui-select"===t.render.ui&&t.render.items?(t.render.items.forEach(e=>{e.label=(0,utils_1.transI18nName)(e.label),r+=`<option value="${e.value}">${e.label}</option>`}),e.innerHTML=r):"ui-select-pro"===t.render.ui&&t.render.items&&(t.render.items.forEach(e=>{r+=`<ui-select-option-pro
             value="${e.value}" 
             label="${e.label}"
             ${t.value.toString()===e.value?"selected":""}
             ></ui-select-option-pro>`}),e.innerHTML=r),e}function updateRenderUI(t,r){r.render.attributes&&Object.keys(r.render.attributes).forEach(e=>{!1===r.render.attributes[e]?t.removeAttribute(e):t.setAttribute(e,String(r.render.attributes[e]))});let a="";if("ui-select"===r.render.ui&&r.render.items)r.render.items.forEach(e=>{a+=`<option value="${e.value}">${e.label}</option>`}),t.innerHTML=a,t.setAttribute("value",r.value??r.default??r.render.items[0].value??"");else if("ui-select-pro"===r.render.ui&&r.render.items){const i=r.value??r.default??r.render.items[0].value??"";r.render.items.forEach(e=>{a+=`<ui-select-option-pro
             value="${e.value}" 
             label="${e.label}"
             ${i.toString()===e.value?"selected":""}
             ></ui-select-option-pro>`}),t.innerHTML=a}}exports.template="",exports.listeners={change(e){var t=this.$this,r=e.target;r!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),onChange(t,r.value))},confirm(e){var t=this.$this;e.target!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),t.dispatch("confirm"))}};