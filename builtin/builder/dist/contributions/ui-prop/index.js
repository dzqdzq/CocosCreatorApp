"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ready=exports.listeners=exports.update=exports.template=void 0;const utils_1=require("../../share/utils"),validator_manager_1=require("../../share/validator-manager"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:"",debug:""};async function update(e){var t;if(!e||!e.itemConfigs&&!e.render)return;const r=this.$this;if(e.render&&e.render.ui&&e.render.ui.toLocaleLowerCase()!==(null===(t=r.$ui)||void 0===t?void 0:t.tagName.toLocaleLowerCase())){Build.debugMode&&console.debug("ui-prop need reload",e.label),r.$ui&&r.removeChild(r.$ui);const t=initRenderUI(e);t&&(r.$ui=t,r.appendChild(t))}e.itemConfigs?Object.keys(e.itemConfigs).forEach(t=>{const i=e.itemConfigs[t],a=lodash.get(e.value,t);r.$items[t]?([null,void 0].includes(a)||(i.value=a,r.valueDirty=!0),i.verifyLevel=i.verifyLevel||"error",r.$items[t].dump=i,r.$items[t].render(i)):console.debug(`${t} has not init`)}):([null,void 0].includes(e.value)||(r.$ui.value=e.value),updateRenderUI(r.$ui,e),await checkTargetValue(r,e)),e.verifyLevel=e.verifyLevel||"error",r.dump=e,r.removeAttribute("dump"),r.valueDirty&&(r.dispatch("change"),r.valueDirty=!1)}async function ready(){const e=this.$this,t=e.dump;if(e.className="build-prop",[void 0,null].includes(t.value)&&![void 0,null].includes(t.default)&&(t.value=t.default),t.verifyRules&&t.verifyRules.includes("required")&&(e.innerHTML='<span class="required">*</span>'),t.label){const r=initLabel(t);r.setAttribute("slot","label"),e.appendChild(r)}if(t.itemConfigs){const r=document.createElement("div");r.setAttribute("slot","content"),e.appendChild(r),e.$items={},Object.keys(t.itemConfigs).forEach(i=>{const a=t.itemConfigs[i],n=document.createElement("ui-prop");r.appendChild(n),n.customInfo=e.customInfo,n.setAttribute("type","build"),n.className="build-prop",e.$items[i]=n,a.verifyLevel=a.verifyLevel||"error",n.dump=a,n.addEventListener("change",t=>{t.stopPropagation(),t.stopImmediatePropagation(),lodash.set(e.dump.value,i,n.dump.value),e.dispatch("change")}),n.render(a)})}else{t.verifyLevel=t.verifyLevel||"error";const r=initRenderUI(t);r&&(e.$ui=r,e.appendChild(r)),await checkTargetValue(e,e.dump)}e.valueDirty&&(e.dispatch("change"),e.valueDirty=!1)}function checkDisabledWhen(e,t){try{return new Function("options",`with(options) { return ${e}}`)(t)}catch(e){console.error(e)}return null}function toggleErrorState(e,t,r){if(e.$errorMap=e.$errorMap||{},!(r=r||"")&&!e.$errorMap[t]||!r&&e.$errorMap[t]&&"none"===e.$errorMap[t].style.display)return;e.$errorMap[t]||(e.$errorMap[t]=document.createElement("ui-prop"),e.$errorMap[t].innerHTML=`<ui-label slot="content" value="${r}" tooltip="${r}"></ui-label>`);const i=e.$errorMap[t];e.$errorMap[t].setAttribute("value",r||""),e.$errorMap[t].setAttribute("tooltip",null!==r&&void 0!==r?r:""),i.className="error",i.setAttribute("error",""),r?(e.setAttribute("error",""),i.style.display="block"):(e.removeAttribute("error"),i.style.display="none"),e.appendChild(i),e.$errorMap[t]=i}async function onChange(e,t){t!==e.dump.value&&(e.dump.value=t,await checkTargetValue(e,e.dump),e.dispatch("change"),e.valueDirty=!1)}async function checkTargetValue(e,t){var r,i;if(e.customInfo){const{options:r,pkgKey:i}=e.customInfo;t.message=await checkValue(t,t.value,r,i)}else t.message=await checkValue(t,t.value);e.message!==t.message&&(e.message||t.message)&&(e.valueDirty=!0),e.message=t.message,e.message?e.classList.add(null!==(r=t.verifyLevel&&MessageTypeMap[t.verifyLevel])&&void 0!==r?r:"danger"):e.classList.remove(null!==(i=t.verifyLevel&&MessageTypeMap[t.verifyLevel])&&void 0!==i?i:"danger")}async function checkValue(e,t,r,i){const{verifyRules:a,render:n}=e;if(a&&n){if(validator_manager_1.validator.checkWithInternalRule("valid",t)||!validator_manager_1.validator.checkWithInternalRule("required",t)||a.includes("required")){return await validator_manager_1.validatorManager.check(t,a,r,i)||null}return null}return null}function initLabel(e){const t=document.createElement("ui-label");if(t.value=e.label,e.description&&t.setAttribute("tooltip",e.description),e.experiment){const e=document.createElement("div");return e.appendChild(t),e.innerHTML+='<ui-icon color tooltip="i18n:builder.experiment" value="experiment"></ui-icon>',e}return t}function initRenderUI(e){if(!e.render)return null;const t=document.createElement(e.render.ui);if(t.setAttribute("slot","content"),"ui-select"===e.render.ui&&e.render.items){let r="";e.render.items.forEach(e=>{e.label=(0,utils_1.transI18nName)(e.label),r+=`<option value="${e.value}">${e.label}</option>`}),t.innerHTML=r}return t}function updateRenderUI(e,t){var r,i,a;if(t.render.attributes&&Object.keys(t.render.attributes).forEach(r=>{!1===t.render.attributes[r]?e.removeAttribute(r):e.setAttribute(r,String(t.render.attributes[r]))}),"ui-select"===t.render.ui&&t.render.items){let n="";t.render.items.forEach(e=>{n+=`<option value="${e.value}">${e.label}</option>`}),e.innerHTML=n,e.setAttribute("value",null!==(a=null!==(i=null!==(r=t.value)&&void 0!==r?r:t.default)&&void 0!==i?i:t.render.items[0].value)&&void 0!==a?a:"")}}exports.template="",exports.update=update,exports.listeners={change(e){const t=this.$this,r=e.target;r!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),onChange(t,r.value))},confirm(e){const t=this.$this;e.target!==t&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),t.dispatch("confirm"))}},exports.ready=ready;