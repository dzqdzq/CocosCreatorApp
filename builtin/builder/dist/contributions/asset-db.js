"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchAssets=exports.encodeAsset=exports.recursively=exports.queryAssetsByOptions=exports.queryAllAssets=void 0;const message_1=require("./../worker/message");exports.methods={async queryAllAssets(){var e;const s=await Manager.Utils.queryAssets(),t=[];for(let r=0;r<s.length;r++){const a=s[r];a.isDirectory||"database"===a.importer||(a.mtime=null===(e=Manager.assetDBManager.assetDBMap.assets.infoManager.get(a.file))||void 0===e?void 0:e.time,t.push(a))}return t},async queryAssetInfo(e){var s;const t=await Manager.Utils.queryAssetInfo(e);return t&&(t.mtime=null===(s=Manager.assetDBManager.assetDBMap.assets.infoManager.get(t.file))||void 0===s?void 0:s.time),t},queryAssetsByOptions:queryAssetsByOptions,initWorkerMessage:message_1.init};const minimatch=require("minimatch");async function queryAllAssets(){var e;const s=await queryAssetsByOptions(),t=[];for(let r=0;r<s.length;r++){const a=s[r];a.isDirectory||"database"===a.importer||(a.mtime=null===(e=Manager.assetDBManager.assetDBMap.assets.infoManager.get(a.file))||void 0===e?void 0:e.time,recursively(a,e=>{t.push(e)}))}return t}function queryAssetsByOptions(e={}){const s=[];for(const t in Manager.assetDBManager.assetDBMap){if(!(t in Manager.assetDBManager.assetDBMap))continue;const r=Manager.assetDBManager.assetDBMap[t];if("string"==typeof e.pattern&&!e.pattern.startsWith(`db://${t}`))continue;const a=searchAssets(Array.from(r.uuid2asset.values()),e);e.deep?a.forEach(e=>{recursively(e,e=>{s.push(encodeAsset(r,e))})}):s.push(...a.map(e=>encodeAsset(r,e)))}return s}function recursively(e,s){e.subAssets&&(s&&s(e),Object.keys(e.subAssets).forEach(t=>{recursively(e.subAssets[t],s)}))}function encodeAsset(e,s){var t,r;const a=Manager.Utils.encodeAsset(e,s);if(s._parent){const r=Manager.Utils.encodeAsset(e,s._parent);a.fatherInfo={source:r.source,library:r.library,uuid:r.uuid},a.mtime=null===(t=Manager.assetDBManager.assetDBMap.assets.infoManager.get(s._parent.source))||void 0===t?void 0:t.time}else a.mtime=null===(r=Manager.assetDBManager.assetDBMap.assets.infoManager.get(s.source))||void 0===r?void 0:r.time;a.userData=s.meta.userData;const n=s._assetDB.dataManager.dataMap[s.uuid];return n&&n.value&&n.value.depends?a.depends=n.value.depends:a.depends=[],a}function searchAssets(e,s){let t=[];return(t=t.concat(e)).filter(e=>!(s.pattern&&"string"==typeof s.pattern&&!minimatch(e.url,s.pattern))&&(!s.importer||"string"!=typeof s.importer||e.meta.importer===s.importer))}exports.queryAllAssets=queryAllAssets,exports.queryAssetsByOptions=queryAssetsByOptions,exports.recursively=recursively,exports.encodeAsset=encodeAsset,exports.searchAssets=searchAssets;