"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var o=Object.getOwnPropertyDescriptor(t,s);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,o)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.components=exports.beforeDestroy=exports.mounted=exports.created=exports.methods=exports.computed=exports.data=exports.props=exports.template=void 0;const lodash_1=require("lodash"),electron_1=require("electron"),ConfigGroup=__importStar(require("../../texture-compress/comp/config-group")),minimaps_1=require("../../../worker/builder/asset-handler/texture-compress/minimaps"),CONFIG_UPDATED_EVENT="builder:texture-compress-config-updated";function data(){return{textureCompressConfig:null,customConfigs:null,overwriteFormats:{},latestConfigUpdate:null,genMipMaps:!1,imageSize:null}}function created(){this.throttledOnConfigUpdated=(0,lodash_1.throttle)(this.onConfigUpdated.bind(this),250,{trailing:!0})}async function mounted(){Editor.Message.__protected__.addBroadcastListener(CONFIG_UPDATED_EVENT,this.throttledOnConfigUpdated),await this.refresh()}function beforeDestroy(){Editor.Message.__protected__.removeBroadcastListener(CONFIG_UPDATED_EVENT,this.throttledOnConfigUpdated)}exports.template='\n<div>\n    <ui-prop\n        v-if="meta && meta.userData"\n        :readonly="readonly"\n        :disabled="readonly"\n    >\n        <ui-label slot="label" value="i18n:builder.assets.auto_atlas.useCompressTexture" tooltip="Use Compress Texture"></ui-label>\n        <ui-checkbox slot="content"\n            :value="useCompressTexture"\n            :disabled="readonly"\n            :invalid="invalidUseCompressTexture"\n            @confirm="_onCompressSettingsChanged($event, \'useCompressTexture\')"\n        ></ui-checkbox>\n    </ui-prop>\n    <ui-label v-if="disabledMipMapTips" class="warn" :value="disabledMipMapTips"></ui-label>\n\n    <ui-prop\n        v-if="useCompressTexture && !invalidUseCompressTexture"\n        :readonly="readonly"\n    >\n        <ui-label slot="label" tooltip="Preset Id">Preset Id</ui-label>\n        <div slot="content">\n            <ui-select\n                :disabled="readonly"\n                :value="meta.userData.compressSettings && meta.userData.compressSettings.presetId || \'default\'"\n                :invalid="invalidPresetId"\n                @confirm="_onCompressSettingsChanged($event, \'presetId\')"\n            >\n                <option\n                    v-for="(config, id) in textureCompressConfig.userPreset"\n                    v-if="config"\n                    :value="id"\n                    :key="id"\n                >{{config.name}}</option>\n                <option\n                    v-for="(config, id) in textureCompressConfig.defaultConfig"\n                    v-if="config"\n                    :value="id"\n                    :key="id"\n                >{{config.name}}</option>\n            </ui-select>\n            <ui-button value="edit"\n                @confirm.stop="jumpToProjectSettings(meta.userData.compressSettings && meta.userData.compressSettings.presetId || \'default\')"\n                tooltip="i18n:builder.project.texture_compress.tips.jump_to_edit_config"\n            ><ui-label value="i18n:builder.assets.image.edit_preset"></ui-label></ui-button>\n        </div>\n    </ui-prop>\n\n    <config-group readonly="true"\n        class="platform-setting"\n        v-if="userTextureCompress && !invalidUseCompressTexture && !invalidPresetId"\n        :compress-info="textureCompressConfig"\n        :overwrite-formats="overwriteFormats"\n        :config="userTextureCompress.config.options"\n    >\n    </config-group>\n</div>',exports.props=["meta","metas","readonly"],exports.data=data,exports.computed={userTextureCompress(){const e=this.meta||this.metas[0];if(!(this.textureCompressConfig&&this.textureCompressConfig.userPreset&&e.userData.compressSettings&&e.userData.compressSettings.useCompressTexture))return null;const t=e.userData.compressSettings.presetId||"default",s=this.textureCompressConfig.userPreset[t]||this.textureCompressConfig.defaultConfig[t];return s?{name:t,config:s}:null},invalidUseCompressTexture(){const e=this,t=!!e.meta.userData.compressSettings;return e.metas.some(s=>{const r=!!s.userData.compressSettings;return t!==r||t&&s.userData.compressSettings.useCompressTexture!==e.meta.userData.compressSettings.useCompressTexture})},invalidPresetId(){const e=this,t=!!e.meta.userData.compressSettings;return e.metas.some(s=>{const r=!!s.userData.compressSettings;return t!==r||t&&s.userData.compressSettings.presetId!==e.meta.userData.compressSettings.presetId})},useCompressTexture(){const{textureCompressConfig:e,meta:t}=this;return e&&t.userData&&t.userData.compressSettings&&t.userData.compressSettings.useCompressTexture},disabledMipMapTips(){const e=this.meta||this.metas[0];if(!this.genMipMaps||!this.useCompressTexture)return"";if(!(0,minimaps_1.checkHasMipMaps)(e))return"";if("auto-atlas"===e.importer&&!e.userData.powerOfTwo)return"i18n:builder.project.texture_compress.mipmap.noPowerOfTwoWithAtlas";const t=this.imageSize;return!t||(0,minimaps_1.isPowerOfTwo)(t.width)&&(0,minimaps_1.isPowerOfTwo)(t.height)?"":"i18n:builder.project.texture_compress.mipmap.noPowerOfTwo"}},exports.methods={jumpToProjectSettings(e){Editor.Message.send("project","open-settings","builder","compress-texture",e)},_onCompressSettingsChanged(e,t){const s=this;s.metas.forEach(r=>{const o=r.userData.compressSettings&&JSON.parse(JSON.stringify(r.userData.compressSettings))||{};o[t]=e.target.value,s.$set(r.userData,"compressSettings",o)}),s.$emit("confirm")},async refreshCompressConfig(){const e=this,t=Date.now();if(this.latestConfigUpdate=t,this.latestConfigUpdate!==t)return;const{userPreset:s,defaultConfig:r}=await Editor.Profile.getProject("builder","textureCompressConfig");e.customConfigs=await Editor.Profile.getProject("builder","textureCompressConfig.customConfigs")||{},e.customConfigs&&Object.keys(e.customConfigs)&&Object.values(e.customConfigs).forEach(t=>{t.overwrite&&(e.overwriteFormats[t.format]&&(e.customConfigs[e.overwriteFormats[t.format]].overwrite=!1,console.debug(`conflict format config ${t.format}(${e.overwriteFormats[t.format]} is invalid.)`)),e.$set(e.overwriteFormats,t.format,t.id))});const o=await Editor.Message.request("builder","query-compress-config");Object.assign(o,{userPreset:s,defaultConfig:r}),e.$set(e,"textureCompressConfig",o)},async getImageSize(e){const t=this;if(!e||!t.useCompressTexture)return null;if(!t.imageSize){const s=await Editor.Message.request("asset-db","query-asset-info",e);if(!s)return;const r=electron_1.nativeImage.createFromPath(s.file);t.imageSize=r.getSize()}return t.imageSize},async refresh(){const e=this;await e.refreshCompressConfig(),e.genMipMaps=await Editor.Profile.getProject("builder","textureCompressConfig.genMipmaps"),e.imageSize=await e.getImageSize(e.meta.uuid)},onConfigUpdated(){this.refreshCompressConfig()}},exports.created=created,exports.mounted=mounted,exports.beforeDestroy=beforeDestroy,exports.components={"config-group":ConfigGroup};