"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,i,t){void 0===t&&(t=i);var l=Object.getOwnPropertyDescriptor(n,i);l&&("get"in l?n.__esModule:!l.writable&&!l.configurable)||(l={enumerable:!0,get:function(){return n[i]}}),Object.defineProperty(e,t,l)}:function(e,n,i,t){void 0===t&&(t=i),e[t]=n[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(n,e,i);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.methods=exports.update=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),electron_1=require("electron"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),configItem=__importStar(require("./filter-config-item")),bundle_1=require("../../../worker/builder/utils/bundle"),BundleConfigGroup=__importStar(require("../../bundle-config/bundle-config-group")),Vue=require("vue/dist/vue.js");function onProfileChange(e,n,i,t){const l=this;"project"===e&&n.includes("builder")&&i.includes("bundleConfig.custom")&&l.updateBundleConfigs(t)}Vue.config.productionTip=!1,Vue.config.devtools=!1;const vueTemplate='\n<section class="asset-directory">\n    <div class="path" v-for="info in infos">\n        <div class="name">\n            <span>{{info.source}}</span>\n        </div>\n        <div class="button">\n            <ui-button class="blue explore-btn" tabindex="0" tooltip="i18n:builder.open"\n                @confirm.stop="_onOpenDirectory($event, info)"\n                @change.stop\n            >\n                <ui-icon value="folder-open"></ui-icon>\n            </ui-button>\n        </div>\n    </div>\n\n    <div class="content">\n        <ui-prop\n            :readonly="_isResources || info.readonly"\n            @confirm="_onPropertyChanged($event, \'isBundle\')"\n        >\n            <ui-label slot="label" value="i18n:builder.asset_bundle.is_bundle"></ui-label>\n            <div slot="content">\n                <ui-checkbox\n                    :value="_isBundle"\n                    :disabled="_isResources || info.readonly"\n                    :invalid="invalid(\'isBundle\')"\n                ></ui-checkbox>\n                <ui-icon value="help"\n                    :tooltip="bundleTooltip"\n                    @click="openDocs"\n                ></ui-icon>\n            </div>\n        </ui-prop>\n        <div v-if="_isBundle && !invalid(\'isBundle\')">\n            <ui-prop\n                @confirm="_onPropertyChanged($event, \'bundleName\')"\n                :readonly="_isResources || info.readonly || metas.length > 1"\n            >\n                <ui-label slot="label" value="i18n:builder.asset_bundle.bundle_name"></ui-label>\n                <ui-input slot="content" :disabled="_isResources || info.readonly  || metas.length > 1" :value="metas[0].userData.bundleName || defaultValue.bundleName" :placeholder="getDefaultValue()" :invalid="invalid(\'bundleName\')"></ui-input>\n            </ui-prop>\n            <ui-prop\n                tooltip="i18n:builder.asset_bundle.priority_tooltip"\n                :readonly="info.readonly"\n                @confirm="_onPropertyChanged($event, \'priority\')"\n            >\n                <ui-label slot="label" value="i18n:builder.asset_bundle.priority"></ui-label>\n                <ui-num-input slot="content" min="1" max="20" step="1"\n                    :disabled="info.readonly"\n                    :value="metas[0].userData.priority || defaultValue.priority"\n                    :invalid="invalid(\'priority\')"\n                >\n                </ui-num-input>\n            </ui-prop>\n\n            <ui-section expand class="bundle-config">\n                <ui-label slot="header" value="i18n:builder.asset_bundle.targetPlatform"></ui-label>\n                <ui-prop class="header"\n                    :readonly="info.readonly"\n                    @change.stop\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.platformConfig"></ui-label>\n                    <div slot="content">\n                        <ui-select\n                            :disabled="info.readonly"\n                            :value="metas[0].userData.bundleConfigID || defaultValue.bundleConfigID"\n                            @confirm.stop="_onPropertyChanged($event, \'bundleConfigID\')"\n                            @click.stop\n                        >\n                            <option\n                                v-for="(config, key) in bundleConfigs"\n                                :value="key"\n                                :key="key"\n                            >{{config.displayName}}</option>\n                        </ui-select>\n                        <ui-button @click="editBundleConfig(metas[0].userData.bundleConfigID || defaultValue.bundleConfigID)">\n                            <ui-label value="i18n:builder.asset_bundle.editConfig"></ui-label>\n                        </ui-button>\n                    </div>\n                </ui-prop>\n\n                <template v-if="renderConfigs">\n                    <config-group\n                        :custom-config="currentBundleConfig"\n                        :render-config="renderConfigs"\n                        readonly="true"\n                    ></config-group>\n                </template>\n            </ui-section>\n\n            <ui-section expand class="bundle-filter-wrap">\n                <ui-label slot="header" value="i18n:builder.asset_bundle.filterConfig.title"></ui-label>\n                <div class="config-content">\n                    <div class="include">\n                        <div class="filter-header">\n                            <ui-label value="i18n:builder.asset_bundle.filterConfig.include"></ui-label>\n                            <div>\n                                <ui-button class="transparent" type="icon"\n                                    @click="removeConfig(\'include\')"\n                                >\n                                    <ui-icon value="mini"></ui-icon>\n                                </ui-button>\n                                <ui-button class="transparent" type="icon"\n                                    @click="addConfig(\'include\')"\n                                >\n                                    <ui-icon value="add"></ui-icon>\n                                </ui-button>\n                            </div>\n                        </div>\n                        <config-item type="include"\n                            v-for="(config, index) in bundleFilterConfig"\n                            v-if="config.range === \'include\'"\n                            :key="index"\n                            :config="config"\n                            :uuid="meta.uuid"\n                            :asset-url="assetUrl"\n                            :active="selectArr.includes(index)"\n                            @change="onConfigChange(index, config)"\n                            @select="toggleSelect(config, index)"\n                        >\n                        </config-item>\n                    </div>\n                    <div class="exclude">\n                        <div class="filter-header">\n                            <ui-label value="i18n:builder.asset_bundle.filterConfig.exclude"></ui-label>\n                            <div>\n                                <ui-button class="transparent" type="icon"\n                                    @click="removeConfig(\'exclude\')"\n                                >\n                                    <ui-icon value="mini"></ui-icon>\n                                </ui-button>\n                                <ui-button class="transparent" type="icon"\n                                    @click="addConfig(\'exclude\')"\n                                >\n                                    <ui-icon value="add"></ui-icon>\n                                </ui-button>\n                            </div>\n                        </div>\n                        <config-item type="exclude"\n                            v-for="(config, index) in bundleFilterConfig"\n                            v-if="config.range === \'exclude\'"\n                            :config="config"\n                            :key="index"\n                            :uuid="meta.uuid"\n                            :asset-url="assetUrl"\n                            :active="selectArr.includes(index)"\n                            @change="onConfigChange(index, config)"\n                            @select="toggleSelect(config, index)"\n                        >\n                        </config-item>\n                    </div>\n                    <div class="empty" v-if="!bundleFilterConfig || !bundleFilterConfig.length">\n                        <ui-label value="i18n:builder.asset_bundle.filterConfig.emptyConfig"></ui-label>\n                    </div>\n                    <div class="preview">\n                        <div class="header">\n                            <ui-button\n                                :disabled="!bundleFilterConfig || !bundleFilterConfig.length"\n                                @confirm="onPreview"\n                            >\n                                <ui-label value="i18n:builder.asset_bundle.filterConfig.preview"></ui-label>\n                            </ui-button>\n                        </div>\n                        <ui-section expand class="preview-content" v-if="hasPreview">\n                            <div slot="header">\n                                <ui-label value="i18n:builder.asset_bundle.filterConfig.previewList"></ui-label>\n                                <ui-icon value="info-i" tooltip="i18n:builder.asset_bundle.filterConfig.previewTips"></ui-icon>\n                            </div>\n                            <div v-if="previewList.length" class="content">\n                                <div v-for="url in previewList">\n                                    <ui-label :value="url"></ui-label>\n                                </div>\n                            </div>\n                            <div v-else class="content empty">\n                                <ui-label \n                                    tooltip="i18n:builder.asset_bundle.filterConfig.emptyPreviewList"\n                                    value="i18n:builder.asset_bundle.filterConfig.emptyPreviewList"\n                                ></ui-label>\n                            </div>\n                        </ui-section>\n                    </div>\n                </div>\n            </ui-section>\n\n            <div class="build-bundle" v-if="metas.length === 1">\n                <ui-button @click="onBuild">\n                    <ui-icon value="build-bundle"></ui-icon>\n                    <ui-label value="i18n:builder.asset_bundle.buildBundle"></ui-label>\n                </ui-button>\n            </div>\n        </div>\n    </div>\n</section>\n';function update(e,n,...i){const t=this;if(!t.vm){const e=new Vue({components:{"config-item":configItem,"config-group":BundleConfigGroup},data:()=>({infos:[],info:{},metas:[],meta:{},curPlatform:"web-desktop",defaultValue:{isBundle:!1,bundleName:"",priority:1,bundleConfigID:"default"},assetUrl:"",previewList:[],selectArr:[],bundleConfigs:{},renderConfigs:null,hasPreview:!1}),computed:{_isResources(){return!!this.infos&&this.infos.some(e=>"db://assets/resources"===e.url)},_isBundle(){var e;return null===(e=this.meta.userData)||void 0===e?void 0:e.isBundle},_priority(){var e;return null===(e=this.meta.userData)||void 0===e?void 0:e.priority},bundleFilterConfig(){return this.meta.userData.bundleFilterConfig&&this.meta.userData.bundleFilterConfig.length?this.meta.userData.bundleFilterConfig:[]},bundleTooltip(){return this._isResources?'\n                        <ui-label value="i18n:engine.resources_docs_1"></ui-label><br>\n                        <ui-label value="i18n:engine.resources_docs_2"></ui-label>\n                        ':'\n                        <ui-label value="i18n:engine.bundle_docs1"></ui-label><br>\n                        <ui-label value="i18n:engine.bundle_docs2"></ui-label>\n                    '},currentBundleConfig(){var e;const n=this.meta.userData.bundleConfigID||this.defaultValue.bundleConfigID;return null===(e=this.bundleConfigs[n])||void 0===e?void 0:e.configs}},mounted(){t.onProfileChangeBind=onProfileChange.bind(this),Editor.Profile.__protected__.on("change",t.onProfileChangeBind)},destroyed(){Editor.Profile.__protected__.removeListener("change",t.onProfileChangeBind)},methods:{reset(){this.previewList=[]},async refresh(){if(this.meta&&this.meta.uuid){const e=await Editor.Message.request("asset-db","query-asset-info",this.meta.uuid);e&&(this.assetUrl=e.url)}const e=await Editor.Profile.getProject("builder","bundleConfig.custom");e&&await this.updateBundleConfigs(e);const n=await Editor.Message.request("builder","query-bundle-config");n&&(this.renderConfigs=Object.freeze(n))},async updateBundleConfigs(e){e.default||(e.default=bundle_utils_1.DefaultBundleConfig),this.bundleConfigs=e},onBuild(){Editor.Message.send("builder","open","build-bundle",{root:this.assetUrl}),Editor.Message.send("builder","change-build-bundle",{root:this.assetUrl})},t:e=>Editor.I18n.t(`builder.asset_bundle.${e}`),editBundleConfig(e){Editor.Message.send("project","open-settings","builder","bundle-config",e)},_onOpenDirectory(e,n){electron_1.shell.openPath(n.file)},_onPropertyChanged(e,n){let i=e.target.value;i===this.defaultValue[n]&&(i=void 0),this.metas&&this.metas.forEach(e=>{this.$set(e.userData,n,i)}),this._afterPropertyChanged()},_afterPropertyChanged(){t.dispatch("change"),t.dispatch("snapshot")},onConfigChange(){this._afterPropertyChanged()},removeConfig(e){if(this.meta.userData.bundleFilterConfig){if(this.selectArr.length)this.meta.userData.bundleFilterConfig=this.meta.userData.bundleFilterConfig.filter((n,i)=>!this.selectArr.includes(i)||n.range!==e),this.selectArr=[];else for(let n=this.meta.userData.bundleFilterConfig.length-1;n>=0;n--){if(this.meta.userData.bundleFilterConfig[n].range===e){this.meta.userData.bundleFilterConfig.splice(n,1);break}}this._afterPropertyChanged()}},toggleSelect(e,n){this.selectArr.includes(n)?this.selectArr.splice(n,1):this.selectArr.splice(this.selectArr.length,0,n)},addConfig(e){const n=JSON.parse(JSON.stringify(configItem.defaultBundleFilterConfig));if(n.range=e,"include"===e&&n.patchOption&&(n.patchOption.value=this.assetUrl+"/**/*"),!this.meta.userData.bundleFilterConfig)return this.$set(this.meta.userData,"bundleFilterConfig",[n]),void this._afterPropertyChanged();this.meta.userData.bundleFilterConfig.splice(this.meta.userData.bundleFilterConfig.length-1,0,n),this.$set(this.meta.userData,"bundleFilterConfig",this.meta.userData.bundleFilterConfig),this._afterPropertyChanged()},async onPreview(){const e=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAssetsByOptions",args:[{pattern:this.assetUrl+"/**/*",deep:!0}]});this.previewList=(0,bundle_1.filterAssetWithBundleConfig)(e,this.bundleFilterConfig).map(e=>e.url),this.hasPreview=!0},getDefaultValue(){return this.info?(0,bundle_utils_1.getBundleDefaultName)(this.info):""},openDocs(){const e=this._isResources?Editor.Utils.Url.getDocUrl("asset/dynamic-load-resources.html"):Editor.Utils.Url.getDocUrl("asset/bundle.html");Editor.Message.send("program","open-url",e)},async apply(){if(!this._isBundle||!this.meta)return;const e=this.meta.userData.bundleName||this.getDefaultValue();if(!/^[a-zA-Z0-9_-]+$/.test(e))return console.error(`Invalid bundle name(${e}), only numbers, letters, minus sign and underscores can be included in the bundle name.`),!1;const{MAIN:n,START_SCENE:i,RESOURCES:t,INTERNAL:l}=bundle_utils_1.BuiltinBundleName;function s(e,n){return new RegExp(`^${e}$`,"i").test(n)}if(s(t,e)&&!this._isResources||[n,i,l].find(n=>s(n,e)))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_reserved_keyword_message",{name:e})),!1;const u=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});for(const n of u){if(!this.info||n.url===this.info.url)continue;if(s(n.meta.userData.bundleName||(0,path_1.basename)(n.url),e))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_name_message",{name:e,url:n.url})),!1;if(Editor.Utils.Path.contains(n.url,this.info.url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:n.url})),!1;if(Editor.Utils.Path.contains(this.info.url,n.url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:n.url})),!1}},invalid(e){return!this.metas||!this.meta||this.metas.some(n=>n.userData[e]!==this.meta.userData[e])},invalidCompressionType(){return!this.metas||!this.meta||this.metas.some(e=>e.userData.compressionType[this.curPlatform]!==this.meta.userData.compressionType[this.curPlatform])},invalidIsRemoteBundle(){return!this.metas||!this.meta||this.metas.some(e=>e.userData.isRemoteBundle[this.curPlatform]!==this.meta.userData.isRemoteBundle[this.curPlatform])}},template:vueTemplate});e.$mount(t.$.container),t.vm=e}t.vm.infos=e,t.vm.metas=n,t.vm.info=e[0];const l=n[0];t.vm.meta&&l&&t.vm.meta.uuid!==l.uuid&&t.vm.reset(),t.vm.meta=l,t.vm.refresh()}function close(){var e;Editor.Profile.__protected__.removeListener("change",this.onProfileChangeBind),null===(e=this.vm)||void 0===e||e.$destroy(),this.vm=null}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./style.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.update=update,exports.methods={async apply(){return await this.vm.apply()}},exports.close=close;