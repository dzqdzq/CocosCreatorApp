"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,i,t){void 0===t&&(t=i);var l=Object.getOwnPropertyDescriptor(n,i);l&&("get"in l?n.__esModule:!l.writable&&!l.configurable)||(l={enumerable:!0,get:function(){return n[i]}}),Object.defineProperty(e,t,l)}:function(e,n,i,t){void 0===t&&(t=i),e[t]=n[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(n,e,i);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.update=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),electron_1=require("electron"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),configItem=__importStar(require("./filter-config-item")),bundle_1=require("../../../worker/builder/utils/bundle"),BundleConfigGroup=__importStar(require("../../bundle-config/bundle-config-group")),Vue=require("vue/dist/vue.js");function update(e,n,...i){const t=this;t.vm||(t.vm=new Vue({el:t.$.root,components:{"config-item":configItem,"config-group":BundleConfigGroup},data:{infos:[],metas:[],info:{},meta:{},curPlatform:"web-desktop",defaultValue:{isBundle:!1,bundleName:"",priority:1,bundleConfigID:"default"},assetUrl:"",previewList:[],selectArr:[],bundleConfigs:{},renderConfigs:null,hasPreview:!1},computed:{_isResources(){return this.infos.some(e=>"db://assets/resources"===e.url)},_isBundle(){var e,n;return null===(n=null===(e=this.meta)||void 0===e?void 0:e.userData)||void 0===n?void 0:n.isBundle},_priority(){var e,n;return null===(n=null===(e=this.meta)||void 0===e?void 0:e.userData)||void 0===n?void 0:n.priority},bundleFilterConfig(){return this.metas[0].userData.bundleFilterConfig&&this.metas[0].userData.bundleFilterConfig.length?this.metas[0].userData.bundleFilterConfig:[]},bundleTooltip(){return this._isResources?'\n                        <ui-label value="i18n:engine.resources_docs_1"></ui-label><br>\n                        <ui-label value="i18n:engine.resources_docs_2"></ui-label>\n                        ':'\n                        <ui-label value="i18n:engine.bundle_docs1"></ui-label><br>\n                        <ui-label value="i18n:engine.bundle_docs2"></ui-label>\n                    '},currentBundleConfig(){var e;return null===(e=this.bundleConfigs[this.metas[0].userData.bundleConfigID||this.defaultValue.bundleConfigID])||void 0===e?void 0:e.configs}},methods:{reset(){this.previewList=[]},async refresh(){const e=await Editor.Message.request("asset-db","query-asset-info",this.meta.uuid);this.assetUrl=null===e||void 0===e?void 0:e.url,await this.updateBundleConfigs(),this.renderConfigs=Object.freeze(await Editor.Message.request("builder","query-bundle-config"))},async updateBundleConfigs(){const e=await Editor.Profile.getProject("builder","bundleConfig.custom")||{};e.default||(e.default=bundle_utils_1.DefaultBundleConfig),this.bundleConfigs=e},onBuild(){Editor.Message.send("builder","open","build-bundle",{root:this.assetUrl}),Editor.Message.send("builder","change-build-bundle",{root:this.assetUrl})},t:e=>Editor.I18n.t(`builder.asset_bundle.${e}`),editBundleConfig(e){Editor.Message.send("project","open-settings","builder","bundle-config",e)},_onOpenDirectory(e,n){electron_1.shell.openPath(n.file)},_onPropertyChanged(e,n){const i=this;let t=e.target.value;t===i.defaultValue[n]&&(t=void 0),i.metas.forEach(e=>{i.$set(e.userData,n,t)}),i._afterPropertyChanged()},_afterPropertyChanged(){t.dispatch("change"),t.dispatch("snapshot")},onConfigChange(){this._afterPropertyChanged()},removeConfig(e){const n=this;if(n.metas[0].userData.bundleFilterConfig){if(n.selectArr.length)n.metas[0].userData.bundleFilterConfig=n.metas[0].userData.bundleFilterConfig.filter((i,t)=>!n.selectArr.includes(t)||i.range!==e),n.selectArr=[];else for(let i=n.metas[0].userData.bundleFilterConfig.length-1;i>=0;i--){if(n.metas[0].userData.bundleFilterConfig[i].range===e){n.metas[0].userData.bundleFilterConfig.splice(i,1);break}}n._afterPropertyChanged()}},toggleSelect(e,n){const i=this;i.selectArr.includes(n)?i.selectArr.splice(n,1):i.selectArr.splice(i.selectArr.length,0,n)},addConfig(e){const n=this,i=JSON.parse(JSON.stringify(configItem.defaultBundleFilterConfig));if(i.range=e,"include"===e&&i.patchOption&&(i.patchOption.value=n.assetUrl+"/**/*"),!n.metas[0].userData.bundleFilterConfig)return n.$set(n.metas[0].userData,"bundleFilterConfig",[i]),void n._afterPropertyChanged();n.metas[0].userData.bundleFilterConfig.splice(n.metas[0].userData.bundleFilterConfig.length-1,0,i),n.$set(n.metas[0].userData,"bundleFilterConfig",n.metas[0].userData.bundleFilterConfig),n._afterPropertyChanged()},async onPreview(){const e=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAssetsByOptions",args:[{pattern:this.assetUrl+"/**/*",deep:!0}]});this.previewList=(0,bundle_1.filterAssetWithBundleConfig)(e,this.bundleFilterConfig).map(e=>e.url),this.hasPreview=!0},getDefaultValue(){return(0,bundle_utils_1.getBundleDefaultName)(this.infos[0])},openDocs(){const e=this._isResources?Editor.Utils.Url.getDocUrl("asset/dynamic-load-resources.html"):Editor.Utils.Url.getDocUrl("asset/bundle.html");Editor.Message.send("program","open-url",e)},async apply(){const e=this;if(!e._isBundle)return;const n=e.metas[0].userData.bundleName||e.getDefaultValue();if(!/^[a-zA-Z0-9_-]+$/.test(n))return console.error(`Invalid bundle name(${n}), only numbers, letters, minus sign and underscores can be included in the bundle name.`),!1;const{MAIN:i,START_SCENE:t,RESOURCES:l,INTERNAL:u}=bundle_utils_1.BuiltinBundleName;function s(e,n){return new RegExp(`^${e}$`,"i").test(n)}if(s(l,n)&&!e._isResources||[i,t,u].find(e=>s(e,n)))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_reserved_keyword_message",{name:n})),!1;const r=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});for(const i of r){if(i.url===e.infos[0].url)continue;if(s(i.meta.userData.bundleName||(0,path_1.basename)(i.url),n))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_name_message",{name:n,url:i.url})),!1;if(Editor.Utils.Path.contains(i.url,e.infos[0].url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:i.url})),!1;if(Editor.Utils.Path.contains(e.infos[0].url,i.url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:i.url})),!1}},invalid(e){const n=this;return n.metas.some(i=>i.userData[e]!==n.meta.userData[e])},invalidCompressionType(){const e=this;return e.metas.some(n=>n.userData.compressionType[e.curPlatform]!==e.meta.userData.compressionType[e.curPlatform])},invalidIsRemoteBundle(){const e=this;return e.metas.some(n=>n.userData.isRemoteBundle[e.curPlatform]!==e.meta.userData.isRemoteBundle[e.curPlatform])}}})),t.vm.infos=e,t.vm.metas=n,t.vm.info=e[0],t.vm.meta&&t.vm.meta.uuid!==n[0]&&n[0].uuid&&t.vm.reset(),t.vm.meta=n[0],t.vm.refresh()}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./style.css"),"utf8"),exports.template='\n<section class="asset-directory">\n    <div class="path" v-for="info in infos">\n        <div class="name">\n            <span>{{info.source}}</span>\n        </div>\n        <div class="button">\n            <ui-button class="blue explore-btn" tabindex="0" tooltip="i18n:builder.open"\n                @confirm.stop="_onOpenDirectory($event, info)"\n                @change.stop\n            >\n                <ui-icon value="folder-open"></ui-icon>\n            </ui-button>\n        </div>\n    </div>\n\n    <div class="content">\n        <ui-prop\n            :readonly="_isResources || info.readonly"\n            @confirm="_onPropertyChanged($event, \'isBundle\')"\n        >\n            <ui-label slot="label" value="i18n:builder.asset_bundle.is_bundle"></ui-label>\n            <div slot="content">\n                <ui-checkbox\n                    :value="_isBundle"\n                    :disabled="_isResources || info.readonly"\n                    :invalid="invalid(\'isBundle\')"\n                ></ui-checkbox>\n                <ui-icon value="help"\n                    :tooltip="bundleTooltip"\n                    @click="openDocs"\n                ></ui-icon>\n            </div>\n        </ui-prop>\n        <div v-if="_isBundle && !invalid(\'isBundle\')">\n            <ui-prop\n                @confirm="_onPropertyChanged($event, \'bundleName\')"\n                :readonly="_isResources || info.readonly || metas.length > 1"\n            >\n                <ui-label slot="label" value="i18n:builder.asset_bundle.bundle_name"></ui-label>\n                <ui-input slot="content" :disabled="_isResources || info.readonly  || metas.length > 1" :value="metas[0].userData.bundleName || defaultValue.bundleName" :placeholder="getDefaultValue()" :invalid="invalid(\'bundleName\')"></ui-input>\n            </ui-prop>\n            <ui-prop\n                tooltip="i18n:builder.asset_bundle.priority_tooltip"\n                :readonly="info.readonly"\n                @confirm="_onPropertyChanged($event, \'priority\')"\n            >\n                <ui-label slot="label" value="i18n:builder.asset_bundle.priority"></ui-label>\n                <ui-num-input slot="content" min="1" max="20" step="1"\n                    :disabled="info.readonly"\n                    :value="metas[0].userData.priority || defaultValue.priority"\n                    :invalid="invalid(\'priority\')"\n                >\n                </ui-num-input>\n            </ui-prop>\n\n            <ui-section expand class="bundle-config">\n                <ui-label slot="header" value="i18n:builder.asset_bundle.targetPlatform"></ui-label>\n                <ui-prop class="header"\n                    :readonly="info.readonly"\n                    @change.stop\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.platformConfig"></ui-label>\n                    <div slot="content">\n                        <ui-select\n                            :disabled="info.readonly"\n                            :value="metas[0].userData.bundleConfigID || defaultValue.bundleConfigID"\n                            @confirm.stop="_onPropertyChanged($event, \'bundleConfigID\')"\n                            @click.stop="updateBundleConfigs"\n                        >\n                            <option\n                                v-for="(config, key) in bundleConfigs"\n                                :value="key"\n                                :key="key"\n                            >{{config.displayName}}</option>\n                        </ui-select>\n                        <ui-button @click="editBundleConfig(metas[0].userData.bundleConfigID || defaultValue.bundleConfigID)">\n                            <ui-label value="i18n:builder.asset_bundle.editConfig"></ui-label>\n                        </ui-button>\n                    </div>\n                </ui-prop>\n\n                <template v-if="renderConfigs">\n                    <config-group\n                        :custom-config="currentBundleConfig"\n                        :render-config="renderConfigs"\n                        @changeplatform="updateBundleConfigs"\n                        readonly="true"\n                    ></config-group>\n                </template>\n            </ui-section>\n\n            <ui-section expand class="bundle-filter-wrap">\n                <ui-label slot="header" value="i18n:builder.asset_bundle.filterConfig.title"></ui-label>\n                <div class="config-content">\n                    <div class="include">\n                        <div class="filter-header">\n                            <ui-label value="i18n:builder.asset_bundle.filterConfig.include"></ui-label>\n                            <div>\n                                <ui-button class="transparent" type="icon"\n                                    @click="removeConfig(\'include\')"\n                                >\n                                    <ui-icon value="mini"></ui-icon>\n                                </ui-button>\n                                <ui-button class="transparent" type="icon"\n                                    @click="addConfig(\'include\')"\n                                >\n                                    <ui-icon value="add"></ui-icon>\n                                </ui-button>\n                            </div>\n                        </div>\n                        <config-item type="include"\n                            v-for="(config, index) in bundleFilterConfig"\n                            v-if="config.range === \'include\'"\n                            :key="index"\n                            :config="config"\n                            :uuid="meta.uuid"\n                            :asset-url="assetUrl"\n                            :active="selectArr.includes(index)"\n                            @change="onConfigChange(index, config)"\n                            @select="toggleSelect(config, index)"\n                        >\n                        </config-item>\n                    </div>\n                    <div class="exclude">\n                        <div class="filter-header">\n                            <ui-label value="i18n:builder.asset_bundle.filterConfig.exclude"></ui-label>\n                            <div>\n                                <ui-button class="transparent" type="icon"\n                                    @click="removeConfig(\'exclude\')"\n                                >\n                                    <ui-icon value="mini"></ui-icon>\n                                </ui-button>\n                                <ui-button class="transparent" type="icon"\n                                    @click="addConfig(\'exclude\')"\n                                >\n                                    <ui-icon value="add"></ui-icon>\n                                </ui-button>\n                            </div>\n                        </div>\n                        <config-item type="exclude"\n                            v-for="(config, index) in bundleFilterConfig"\n                            v-if="config.range === \'exclude\'"\n                            :config="config"\n                            :key="index"\n                            :uuid="meta.uuid"\n                            :asset-url="assetUrl"\n                            :active="selectArr.includes(index)"\n                            @change="onConfigChange(index, config)"\n                            @select="toggleSelect(config, index)"\n                        >\n                        </config-item>\n                    </div>\n                    <div class="empty" v-if="!bundleFilterConfig || !bundleFilterConfig.length">\n                        <ui-label value="i18n:builder.asset_bundle.filterConfig.emptyConfig"></ui-label>\n                    </div>\n                    <div class="preview">\n                        <div class="header">\n                            <ui-button\n                                :disabled="!bundleFilterConfig || !bundleFilterConfig.length"\n                                @confirm="onPreview"\n                            >\n                                <ui-label value="i18n:builder.asset_bundle.filterConfig.preview"></ui-label>\n                            </ui-button>\n                        </div>\n                        <ui-section expand class="preview-content" v-if="hasPreview">\n                            <div slot="header">\n                                <ui-label value="i18n:builder.asset_bundle.filterConfig.previewList"></ui-label>\n                                <ui-icon value="info-i" tooltip="i18n:builder.asset_bundle.filterConfig.previewTips"></ui-icon>\n                            </div>\n                            <div v-if="previewList.length" class="content">\n                                <div v-for="url in previewList">\n                                    <ui-label :value="url"></ui-label>\n                                </div>\n                            </div>\n                            <div v-else class="content empty">\n                                <ui-label \n                                    tooltip="i18n:builder.asset_bundle.filterConfig.emptyPreviewList"\n                                    value="i18n:builder.asset_bundle.filterConfig.emptyPreviewList"\n                                ></ui-label>\n                            </div>\n                        </ui-section>\n                    </div>\n                </div>\n            </ui-section>\n\n            <div class="build-bundle" v-if="metas.length === 1">\n                <ui-button @click="onBuild">\n                    <ui-icon value="build-bundle"></ui-icon>\n                    <ui-label value="i18n:builder.asset_bundle.buildBundle"></ui-label>\n                </ui-button>\n            </div>\n        </div>\n    </div>\n</section>\n    ',exports.$={root:".asset-directory"},exports.update=update,exports.methods={async apply(){return await this.vm.apply()}};