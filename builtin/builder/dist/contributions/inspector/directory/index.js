"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.update=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),electron_1=require("electron"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),Vue=require("vue/dist/vue.js");function update(e,n,...t){const l=this;if(!l.vm)return l.infos=e,l.metas=n,void(l.vm=new Vue({el:l.$.root,data:{infos:l.infos||[],metas:l.metas||[],info:null,readonly:{value:!1},curPlatform:"web-desktop",platformFeatures:{},platforms:[],defaultValue:{isBundle:!1,bundleName:"",priority:1,compressionType:"merge_dep"}},computed:{_isResources(){return this.infos&&1===this.infos.length&&"db://assets/resources"===this.infos[0].url},_isBundle(){return this.metas[0].userData.isBundle},_priority(){return this.metas[0].userData.priority},_isRemoteLocked(){const e=this.metas[0].userData.compressionType[this.curPlatform];return e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE||e===bundle_utils_1.BundleCompressionTypes.ZIP},compressionTypes(){const e=this;return e.platformFeatures[e.curPlatform]?e.platformFeatures[e.curPlatform].supportedCompressionTypes:[]}},async mounted(){this.info=this.infos[0],await this.init()},methods:{async init(){const e=this;e.platformFeatures=await Editor.Message.request("builder","query-bundle-config");const n=await Editor.Message.request("builder","query-platform-config");e.platforms=n.order.filter(n=>!!e.platformFeatures[n])},t:e=>Editor.I18n.t(`builder.asset_bundle.${e}`),platformName:e=>0===e.indexOf("i18n")?Editor.I18n.t(e.substr(5)):e,_onOpenDirectory(e,n){electron_1.shell.openPath(n.file)},_onPropertyChanged(e,n){let t=e.target.value;t===this.defaultValue[n]&&(t=void 0),this.$set(this.metas[0].userData,n,t),l.dispatch("change")},_platformSettingsChanged(e,n){const t=this;let s=e.target.value;(s===t.defaultValue[n]||"isRemoteBundle"===n&&!1===s)&&(s=void 0),t.$set(t.metas[0].userData[n],t.curPlatform,s),"compressionType"===n&&(e.target.value===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?t.$set(t.metas[0].userData.isRemoteBundle,t.curPlatform,!1):e.target.value===bundle_utils_1.BundleCompressionTypes.ZIP&&t.$set(t.metas[0].userData.isRemoteBundle,t.curPlatform,!0)),l.dispatch("change")},getDefaultValue(){return(0,path_1.basename)(this.infos[0].file)},openDocs(){electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl("asset/dynamic-load-resources.html"))},openBundleDocs(){electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl("asset/bundle.html"))},async apply(){const e=this;if(!e._isBundle)return;const n=e.metas[0].userData.bundleName||e.getDefaultValue();if(!/^[a-zA-Z0-9_-]+$/.test(n))return console.error(`Invalid bundle name(${n}), only numbers, letters, minus sign and underscores can be included in the bundle name.`),!1;const{MAIN:t,START_SCENE:l,RESOURCES:s,INTERNAL:i}=bundle_utils_1.BuiltinBundleName;function o(e,n){return new RegExp(`^${e}$`,"i").test(n)}if(o(s,n)&&!e._isResources||[t,l,i].find(e=>o(e,n)))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_reserved_keyword_message",{name:n})),!1;const a=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});for(const t of a){if(t.url===e.infos[0].url)continue;if(o(t.meta.userData.bundleName||(0,path_1.basename)(t.url),n))return console.error(Editor.I18n.t("builder.asset_bundle.duplicate_name_message",{name:n,url:t.url})),!1;if(Editor.Utils.Path.contains(t.url,e.infos[0].url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:t.url})),!1;if(Editor.Utils.Path.contains(e.infos[0].url,t.url))return console.error(Editor.I18n.t("builder.asset_bundle.nest_bundle",{url:t.url})),!1}}}}));l.vm.infos=e,l.vm.info=e[0],l.vm.metas=n,l.vm.readonly.value=l.vm.info&&l.vm.info.readonly}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./style.css"),"utf8"),exports.template='\n<section class="asset-directory">\n    <div class="path"\n        v-for="info in infos"\n    >\n        <div class="name">\n            <span>{{info.source}}</span>\n        </div>\n        <div class="button">\n            <ui-button class="blue explore-btn" tabindex="0"\n                @confirm.stop="_onOpenDirectory($event, info)"\n                @change.stop\n            >\n                <ui-icon value="folder-open"></ui-icon>\n            </ui-button>\n        </div>\n    </div>\n\n    <div class="content">\n        <template\n            v-if="metas && metas.length === 1"\n        >\n            <ui-prop\n                @confirm="_onPropertyChanged($event, \'isBundle\')"\n            >\n                <ui-label slot="label" value="i18n:builder.asset_bundle.is_bundle"></ui-label>\n                <ui-icon value="lock" slot="label"\n                    v-if="_isResources || readonly.value"\n                ></ui-icon>\n                <ui-checkbox\n                    slot="content"\n                    :disabled="_isResources || readonly.value"\n                    :value="_isBundle"\n                ></ui-checkbox>\n            </ui-prop>\n            <div\n                v-if="_isBundle"\n            >\n                <ui-prop\n                    @confirm="_onPropertyChanged($event, \'bundleName\')"\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.bundle_name"></ui-label>\n                    <ui-icon value="lock" slot="label"\n                        v-if="_isResources || readonly.value"\n                    ></ui-icon>\n                    <ui-input\n                        slot="content"\n                        :disabled="_isResources || readonly.value"\n                        :value="metas[0].userData.bundleName || defaultValue.bundleName"\n                        :placeholder="getDefaultValue()"\n                    ></ui-input>\n                </ui-prop>\n                <ui-prop\n                    @confirm="_onPropertyChanged($event, \'priority\')"\n                    tooltip="i18n:builder.asset_bundle.priority_tooltip"\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.priority"></ui-label>\n                    <ui-icon value="lock" slot="label"\n                        v-if="readonly.value"\n                    ></ui-icon>\n                    <ui-num-input\n                        slot="content"\n                        :disabled="readonly.value"\n                        min="1"\n                        max="20"\n                        step="1"\n                        :value="metas[0].userData.priority || defaultValue.priority"\n                    >\n                    </ui-num-input>\n                </ui-prop>\n                <ui-prop\n                    @confirm.stop="curPlatform = $event.target.value"\n                    @change.stop\n                    tooltip="i18n:builder.asset_bundle.target_platform_tooltip"\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.target_platform"></ui-label>\n                    <ui-icon value="lock" slot="label"\n                        v-if="readonly.value"\n                    ></ui-icon>\n                    <ui-select\n                        slot="content"\n                        :disabled="readonly.value"\n                        :value="curPlatform"\n                    >\n                        <option\n                            v-for="platform in platforms"\n                            v-if="platformFeatures[platform]"\n                            :value="platform"\n                        >{{platformName(platformFeatures[platform].platformName)}}</option>\n                    </ui-select>\n                </ui-prop>\n                <ui-prop tooltip="i18n:builder.asset_bundle.compression_type_tooltip" \n                    @confirm="_platformSettingsChanged($event, \'compressionType\')"\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.compression_type"></ui-label>\n                    <ui-icon value="lock" slot="label"\n                        v-if="readonly.value"\n                    ></ui-icon>\n                    <ui-select\n                        slot="content"\n                        :disabled="readonly.value"\n                        :value="metas[0].userData.compressionType[curPlatform] || defaultValue.compressionType"\n                    >\n                        <option\n                            v-for="(val, key) in compressionTypes"\n                            :value="val"\n                            :title="t(val + \'_tooltip\')">\n                                {{t(val)}}\n                        </option>\n                    </ui-select>\n                </ui-prop>\n                <ui-prop tooltip="i18n:builder.asset_bundle.remote_bundle_invalid_tooltip"\n                    @confirm="_platformSettingsChanged($event, \'isRemoteBundle\')"\n                >\n                    <ui-label slot="label" value="i18n:builder.asset_bundle.is_remote_bundle"></ui-label>\n                    <ui-icon value="lock" slot="label"\n                        v-if="_isRemoteLocked || readonly.value"\n                    ></ui-icon>\n                    <ui-checkbox\n                        slot="content"\n                        :disabled="_isRemoteLocked || readonly.value"\n                        :value="metas[0].userData.isRemoteBundle[curPlatform]"\n                    >\n                    </ui-checkbox>\n                </ui-prop>\n                <template\n                    v-if="!_isResources"\n                >\n                    <p>\n                        <ui-label value="i18n:engine.bundle_docs1"></ui-label>\n                    </p>\n                    <p>\n                        <ui-label value="i18n:engine.bundle_docs2"></ui-label>\n                    </p>\n                    <p>\n                        <ui-label value="i18n:engine.bundle_docs3"></ui-label>\n                        <a\n                            @click="openBundleDocs"\n                        >\n                            Asset Bundle\n                        </a>\n                    </p>\n                </template>\n            </div>\n        </template>\n        <template\n            v-if="_isResources"\n        >\n            <p>\n                <ui-label value="i18n:engine.resources_docs_1"></ui-label>\n            </p>\n            <p>\n                <ui-label value="i18n:engine.resources_docs_2"></ui-label>\n            </p>\n            <p>\n                <ui-label value="i18n:engine.resources_docs_3"></ui-label>\n                <a\n                    @click="openDocs"\n                >\n                    <ui-label value="i18n:engine.resources_docs_4"></ui-label>\n                </a>\n            </p>\n        </template>\n    </div>\n</section>\n\n',exports.$={root:".asset-directory"},exports.update=update,exports.methods={async apply(){return await this.vm.apply()}};