"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.created=exports.methods=exports.computed=exports.props=exports.data=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),compressConfig=__importStar(require("../comp/texture-compress-config")),configToolbar=__importStar(require("../comp//config-toolbar")),utils_1=require("../../../share/utils");exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/compress-presets.html"),"utf8"),exports.components={"compress-config":compressConfig,"config-toolbar":configToolbar};const data=function(){return{configs:null,defaultConfig:null,initialized:!1,newConfigName:"",newConfigNameConfilct:!1,configNameTips:"",mode:"config"}};function created(){this.throttledBroadcastUpdated=this.broadcastUpdated.bind(this)}async function mounted(){console.time("Init presets"),await this.init(),console.timeEnd("Init presets")}exports.data=data,exports.props=["compressConfig","overwriteFormats"],exports.computed={displayConfigs(){const e=this;if("search"!==e.mode)return e.configs;const t={};return Object.keys(e.configs).forEach(o=>{e.configs[o].name.includes(e.newConfigName)&&(t[o]=e.configs[o])}),t}},exports.methods={t:e=>Editor.I18n.t(`builder.project.texture_compress.${e}`),async init(){const e=await Editor.Profile.getProject("builder","textureCompressConfig.userPreset");e&&(this.configs=e),this.defaultConfig=await Editor.Profile.getProject("builder","textureCompressConfig.defaultConfig"),this.mode=await Editor.Profile.getProject("builder","textureCompressConfig.userPresetMode"),this.initialized=!0},async onToolBarChange(e,t){const o=this;switch(e){case"add-config":o.newConfigName=t,o.addConfig();break;case"import-config":o.importConfig();break;case"export-config":o.exportConfig();break;case"config-name":o.newConfigName=t;break;case"mode-change":o.mode=t,await Editor.Profile.setProject("builder","textureCompressConfig.userPresetMode",t),o.throttledBroadcastUpdated()}},async addConfig(){const e=this;if(!e.newConfigName)return e.configNameTips="Invalid config name!",void console.warn("Invalid config name!");const t=Object.keys(e.configs).find(t=>e.configs[t].name===e.newConfigName);if(t){if(0!==(await Editor.Dialog.info(Editor.I18n.t("builder.project.texture_compress.overwriteFormat",{configName:e.newConfigName}),{buttons:[Editor.I18n.t("builder.project.texture_compress.overwrite"),Editor.I18n.t("builder.project.texture_compress.cancel")],cancel:1,default:1})).response)return}const o=t||Editor.Utils.UUID.generate();e.$set(e.configs,o,{name:e.newConfigName,options:{}}),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${o}`,{name:e.newConfigName,options:{}}),e.throttledBroadcastUpdated(),process.nextTick(()=>{e.jumpToConfig(o)})},jumpToConfig(e){if(!this.$refs.wrap)return;const t=this.$refs.wrap.querySelector(`ui-section[id="${e}"]`);t&&(this.$refs.wrap.scrollTop=t.offsetTop-36)},async onUpdateFormatQuality(e,t,o,r){this.configs[e].options[t][o]=r,await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,this.configs[e]),this.throttledBroadcastUpdated()},async onAddFormat(e,t,o){const r=JSON.parse(JSON.stringify(this.configs[e]));r.options[t]||(r.options[t]={});const i=Object.assign(Object.assign({},this.compressConfig.formatsInfo),this.compressConfig.customFormats),s=this.compressConfig.textureFormatConfigs[i[o].formatType].options;r.options[t][o]={},Object.keys(s).forEach(e=>{r.options[t][o][e]=s[e].default}),this.$set(this.configs,e,r),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,r),this.throttledBroadcastUpdated()},onConfigNameChange(e){this.newConfigName=e.target.value},async onRemoveFormat(e,t,o){const r=this;if(!t||!o)return r.$set(r.configs,e,null),delete r.configs[e],void await Editor.Profile.removeProject("builder",`textureCompressConfig.userPreset.${e}`);const i=JSON.parse(JSON.stringify(r.configs[e]));o?delete i.options[t][o]:delete i.options[t],r.$set(r.configs,e,i),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,i),r.throttledBroadcastUpdated()},async onChangeFormatName(e,t){this.configs[e].name=t,await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",this.configs),this.throttledBroadcastUpdated()},async importConfig(){const e=this,t=(await Editor.Dialog.select({title:e.t("import_config"),path:Editor.Project.path,filters:[{name:"JSON",extensions:["json"]}]})).filePaths[0];if(!t)return;const o=await Editor.Dialog.warn(e.t("import_config_options"),{buttons:[e.t("overwrite"),e.t("merge")],default:1});let r;try{if(r=(0,fs_extra_1.readJSONSync)(t),!(0,utils_1.checkCompressOptions)(r))return void console.error(Editor.I18n.t("builder.project.texture_compress.tips.import_failed",{link:Editor.Utils.Url.getDocUrl("editor/project")}));if(1===o.response)for(const t of Object.keys(r))e.$set(e.configs,t,r[t]);else e.configs=r}catch(e){return void console.error(e)}await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",r),console.log(`Import texture compress config from {link(${t})} success!`),e.throttledBroadcastUpdated()},async exportConfig(){const e=await Editor.Dialog.save({title:this.t("export_config"),path:(0,path_1.join)(Editor.Project.path,"texture-compress-config.json"),filters:[{name:"JSON",extensions:["json"]}]});e.filePath&&(await(0,fs_extra_1.outputFile)(e.filePath,JSON.stringify(this.configs,null,2)),console.log(`Texture compress config has export in {link(${e.filePath})}.`))},broadcastUpdated(){Editor.Message.broadcast("builder:texture-compress-config-updated")}},exports.created=created,exports.mounted=mounted;