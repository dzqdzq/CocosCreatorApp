"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.props=exports.data=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),compressConfig=__importStar(require("../comp/texture-compress-config")),configToolbar=__importStar(require("../comp//config-toolbar")),utils_1=require("../../../share/utils");exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../../static/contributions/compress-presets.html"),"utf8"),exports.components={"compress-config":compressConfig,"config-toolbar":configToolbar};const data=function(){return{configs:null,defaultConfig:null,initialized:!1,newConfigName:"",newConfigNameConfilct:!1,configNameTips:"",mode:"config"}};async function mounted(){console.time("Init presets"),await this.init(),console.timeEnd("Init presets")}exports.data=data,exports.props=["compressConfig","overwriteFormats"],exports.computed={displayConfigs(){const e=this;if("search"!==e.mode)return e.configs;const t={};return Object.keys(e.configs).forEach(o=>{e.configs[o].name.includes(e.newConfigName)&&(t[o]=e.configs[o])}),t}},exports.methods={t:e=>Editor.I18n.t(`builder.project.texture_compress.${e}`),async init(){const e=await Editor.Profile.getProject("builder","textureCompressConfig.userPreset");e&&(this.configs=e),this.defaultConfig=await Editor.Profile.getProject("builder","textureCompressConfig.defaultConfig"),this.mode=await Editor.Profile.getProject("builder","textureCompressConfig.userPresetMode"),this.initialized=!0},async onToolBarChange(e,t){const o=this;switch(e){case"add-config":o.newConfigName=t,o.addConfig();break;case"import-config":o.importConfig();break;case"export-config":o.exportConfig();break;case"config-name":o.newConfigName=t;break;case"mode-change":o.mode=t,await Editor.Profile.setProject("builder","textureCompressConfig.userPresetMode",t)}},async addConfig(){const e=this;if(!e.newConfigName)return e.configNameTips="Invalid config name!",void console.warn("Invalid config name!");if(Object.values(e.configs).find(t=>t.name===e.newConfigName)){if(0!==(await Editor.Dialog.info(Editor.I18n.t("builder.project.texture_compress.overwirteFormat",{configName:e.newConfigName}),{buttons:[Editor.I18n.t("builder.project.texture_compress.overwirte"),Editor.I18n.t("builder.project.texture_compress.cancel")],cancel:1,default:1})).response)return}const t=Editor.Utils.UUID.generate();e.$set(e.configs,t,{name:e.newConfigName,options:{}}),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,{name:e.newConfigName,options:{}}),process.nextTick(()=>{e.jumpToConfig(t)})},jumpToConfig(e){if(!this.$refs.wrap)return;const t=this.$refs.wrap.querySelector(`ui-section[id="${e}"]`);t&&(this.$refs.wrap.scrollTop=t.offsetTop-36)},async onUpdateFormatQuality(e,t,o,i){this.configs[e].options[t][o]=i,await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,this.configs[e])},async onAddFormat(e,t,o){const i=JSON.parse(JSON.stringify(this.configs[e]));i.options[t]||(i.options[t]={});const r=Object.assign(Object.assign({},this.compressConfig.formatsInfo),this.compressConfig.customFormats),s=this.compressConfig.textureFormatConfigs[r[o].formatType].options;i.options[t][o]={},Object.keys(s).forEach(e=>{i.options[t][o][e]=s[e].default}),this.$set(this.configs,e,i),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,i)},onConfigNameChange(e){this.newConfigName=e.target.value},async onRemoveFormat(e,t,o){const i=this;if(!t||!o)return i.$set(i.configs,e,null),delete i.configs[e],void await Editor.Profile.removeProject("builder",`textureCompressConfig.userPreset.${e}`);const r=JSON.parse(JSON.stringify(i.configs[e]));o?delete r.options[t][o]:delete r.options[t],i.$set(i.configs,e,r),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${e}`,r)},async onChangeFormatName(e,t){this.configs[e].name=t,await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",this.configs)},async importConfig(){const e=this,t=(await Editor.Dialog.select({title:e.t("import_config"),path:Editor.Project.path,filters:[{name:"JSON",extensions:["json"]}]})).filePaths[0];if(!t)return;const o=await Editor.Dialog.warn(e.t("import_config_options"),{buttons:[e.t("overwrite"),e.t("merge")],default:1});let i;try{if(i=fs_extra_1.readJSONSync(t),!utils_1.checkCompressOptions(i))return void console.error(Editor.I18n.t("builder.project.texture_compress.tips.import_failed",{link:Editor.Utils.Url.getDocUrl("editor/project")}));if(1===o.response)for(const t of Object.keys(i))e.$set(e.configs,t,i[t]);else e.configs=i}catch(e){return void console.error(e)}await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",i),console.log(`Import texture compress config from {link(${t})} success!`)},async exportConfig(){const e=await Editor.Dialog.save({title:this.t("export_config"),path:path_1.join(Editor.Project.path,"texture-compress-config.json"),filters:[{name:"JSON",extensions:["json"]}]});e.filePath&&(await fs_extra_1.outputFile(e.filePath,JSON.stringify(this.configs,null,2)),console.log(`Texture compress config has export in {link(${e.filePath})}.`))}},exports.mounted=mounted;