"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(e,o);i&&("get"in i?e.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return e[o]}}),Object.defineProperty(t,r,i)}:function(t,e,o,r){void 0===r&&(r=o),t[r]=e[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)"default"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&__createBinding(e,t,o);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.created=exports.methods=exports.computed=exports.props=exports.data=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),compressConfig=__importStar(require("../comp/texture-compress-config")),configToolbar=__importStar(require("../comp//config-toolbar")),utils_1=require("../../../share/utils");exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/compress-presets.html"),"utf8"),exports.components={"compress-config":compressConfig,"config-toolbar":configToolbar};const data=function(){return{configs:null,defaultConfig:null,initialized:!1,searchName:""}};function created(){this.throttledBroadcastUpdated=this.broadcastUpdated.bind(this)}async function mounted(){console.time("Init presets"),await this.init(),console.timeEnd("Init presets")}exports.data=data,exports.props=["compressConfig","overwriteFormats"],exports.computed={displayConfigs(){const t=this,e={};return Object.keys(t.configs).forEach(o=>{t.configs[o].name.includes(t.searchName)&&(e[o]=t.configs[o])}),e}},exports.methods={t:t=>Editor.I18n.t(`builder.project.texture_compress.${t}`),async init(){const t=await Editor.Profile.getProject("builder","textureCompressConfig.userPreset");t&&(this.configs=t),this.defaultConfig=await Editor.Profile.getProject("builder","textureCompressConfig.defaultConfig"),this.mode=await Editor.Profile.getProject("builder","textureCompressConfig.userPresetMode"),this.initialized=!0},async onToolBarChange(t,e){const o=this;switch(t){case"add-config":o.addConfig(e);break;case"import-config":o.importConfig();break;case"export-config":o.exportConfig();break;case"search-name":o.searchName=e}},async addConfig(t){const e=this,o=Editor.Utils.UUID.generate();let r;t?(r=t&&JSON.parse(JSON.stringify(e.configs[t]))).name+="(copy)":r={name:"New Compress Config",options:{}},e.$set(e.configs,o,r),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${o}`,r),e.throttledBroadcastUpdated(),process.nextTick(()=>{e.jumpToConfig(o)})},jumpToConfig(t){if(!this.$refs.wrap)return;const e=this.$refs.wrap.querySelector(`ui-section[id="${t}"]`);e&&(e.scrollIntoView(),e.setAttribute("twinkle","shake"),setTimeout(()=>{e.setAttribute("twinkle","")},900))},async onUpdateFormatQuality(t,e,o,r){this.configs[t].options[e][o]=r,await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,this.configs[t]),this.throttledBroadcastUpdated()},async onAddFormat(t,e,o){const r=JSON.parse(JSON.stringify(this.configs[t]));r.options[e]||(r.options[e]={});const i=Object.assign(Object.assign({},this.compressConfig.formatsInfo),this.compressConfig.customFormats),s=this.compressConfig.textureFormatConfigs[i[o].formatType].options;r.options[e][o]={},Object.keys(s).forEach(t=>{r.options[e][o][t]=s[t].default}),this.$set(this.configs,t,r),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,r),this.throttledBroadcastUpdated()},async onRemoveFormat(t,e,o){const r=this;if(!e||!o){if(1===(await Editor.Dialog.info(Editor.I18n.t("builder.project.texture_compress.tips.checkRemoveConfig"),{default:0,cancel:1,buttons:[Editor.I18n.t("builder.confirm"),Editor.I18n.t("builder.cancel")]})).response)return;return r.$set(r.configs,t,null),delete r.configs[t],void await Editor.Profile.removeProject("builder",`textureCompressConfig.userPreset.${t}`)}const i=JSON.parse(JSON.stringify(r.configs[t]));o?delete i.options[e][o]:delete i.options[e],r.$set(r.configs,t,i),await Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,i),r.throttledBroadcastUpdated()},async onChangeFormatName(t,e){this.configs[t].name=e,await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",this.configs),this.throttledBroadcastUpdated()},async importConfig(){const t=this,e=(await Editor.Dialog.select({title:t.t("import_config"),path:Editor.Project.path,filters:[{name:"JSON",extensions:["json"]}]})).filePaths[0];if(!e)return;const o=await Editor.Dialog.warn(t.t("import_config_options"),{buttons:[t.t("overwrite"),t.t("merge")],default:1});let r;try{if(r=(0,fs_extra_1.readJSONSync)(e),!(0,utils_1.checkCompressOptions)(r))return void console.error(Editor.I18n.t("builder.project.texture_compress.tips.import_failed",{link:Editor.Utils.Url.getDocUrl("editor/project")}));if(1===o.response)for(const e of Object.keys(r))t.$set(t.configs,e,r[e]);else t.configs=r}catch(t){return void console.error(t)}await Editor.Profile.setProject("builder","textureCompressConfig.userPreset",r),console.log(`Import texture compress config from {link(${e})} success!`),t.throttledBroadcastUpdated()},async exportConfig(){const t=await Editor.Dialog.save({title:this.t("export_config"),path:(0,path_1.join)(Editor.Project.path,"texture-compress-config.json"),filters:[{name:"JSON",extensions:["json"]}]});t.filePath&&(await(0,fs_extra_1.outputFile)(t.filePath,JSON.stringify(this.configs,null,2)),console.log(`Texture compress config has export in {link(${t.filePath})}.`))},broadcastUpdated(){Editor.Message.broadcast("builder:texture-compress-config-updated")}},exports.created=created,exports.mounted=mounted;