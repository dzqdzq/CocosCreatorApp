"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&("get"in i?r.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,s,i)}:function(e,r,t,s){void 0===s&&(s=t),e[s]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.messageManager=void 0;const builderManager=__importStar(require("./builder/index")),console_1=require("./console"),utils_1=require("./builder/utils"),texture_packer_1=__importDefault(require("./builder/texture-packer")),buildTaskMap={},messageMap={async"build-worker:build"(e,r,t,s){Worker.Ipc.send("build-worker:update-progress",r,.01,"processing","Init build task");try{console_1.newConsole.record(r,t.platform),console.debug("Start build task, options:",t);const e=(new Date).getTime(),s=buildTaskMap[r]=new builderManager.BuildTask(r,t);s.on("update",(e,t)=>{Worker.Ipc.send("build-worker:update-progress",r,t,"processing",e)}),await s.build();const i=(new Date).getTime();if(s.staticsInfo.time=i-e,console_1.newConsole.stopRecord(),s.error){const e=s.error.message+s.error.stack;s.staticsInfo.err=e,console.error("build failed!"+e),Worker.Ipc.send("build-worker:update-progress",r,1,"failure",`${(0,utils_1.getCurrentTime)()} Build failed!`+e)}else console.debug(`build success in ${s.staticsInfo.time} ms!`),Worker.Ipc.send("build-worker:update-progress",r,1,"success",`${(0,utils_1.getCurrentTime)()} Build success in ${s.staticsInfo.time} ms!`);Worker.Ipc.send("build-worker:add-statistics",s.staticsInfo),delete buildTaskMap[r]}catch(e){delete buildTaskMap[r],console_1.newConsole.stopRecord(),console.error(e),Worker.Ipc.send("build-worker:update-progress",r,1,"failure","build failed!"+e.message)}e.reply(null)},async"build-worker:preview-pac"(e,r){try{const t=await texture_packer_1.default.generatePreviewFiles(r);e.reply(null,t)}catch(r){console.error(r),e.reply(r,null)}}};class MessageManager{constructor(){this.waitQueue=[],this.ready=!1}step(){if(!this.ready||!this.waitQueue.length)return;const e=this.waitQueue.shift();e&&messageMap[e.message]&&messageMap[e.message](e.event,...e.args)}push(e,r,t){this.waitQueue.push({message:e,event:r,args:t}),this.step()}}exports.messageManager=new MessageManager;