"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerManager=exports.WorkerManager=void 0;const child_process_1=require("child_process"),path_1=require("path"),workerPath=(0,path_1.join)(__dirname,"../../../static/sub-process-index");class WorkerManager{constructor(e){this.taskMap={},this.pools=new Set,this.runningPoolMap=new WeakMap,this.debug=Editor.App.dev,this.startPort=9220,e&&e.forEach(e=>this.registerTask(e))}async registerTask(e){this.taskMap[e.name]||(this.taskMap[e.name]=e,e.lazy||await this.getWorkerProcess(e.name))}runTask(e,t,s){return new Promise(async(r,o)=>{const n=await this.getWorkerProcess(e),a=this.taskMap[e];console.log(`Run build task(${e}) in child${this.debug?a.port:""}, see: chrome://inspect/#devices`),n&&a?(a.reject=o,a.resolve=r,a.startTime=Date.now(),this.runningPoolMap.set(n,a),n.send({type:"excute-script",path:a.path,method:t||a.method,args:s})):o(new Error("No worker "+e))})}kill(e){var t;const s=this.taskMap[e];null===(t=s._handleProcess)||void 0===t||t.kill(),this.pools.delete(s._handleProcess)}async getWorkerProcess(e){if(!this.taskMap[e])return null;if(!this.taskMap[e]._handleProcess){const t=await Editor.Network.getFreePort(this.startPort+this.pools.size);this.taskMap[e]._handleProcess=await this.createWorkerProcess(t),this.taskMap[e].port=t}return this.taskMap[e]._handleProcess}async createWorkerProcess(e){var t,s;const r=(0,child_process_1.fork)(workerPath,[],{execArgv:this.debug?[`--inspect=${e}`]:[],stdio:["ipc","pipe","pipe","pipe"]});return this.debug&&console.debug(`child ${e} in chrome://inspect/#devices`),this.pools.add(r),r.on("message",e=>{const t=this.runningPoolMap.get(r);e&&"excute-script over"===e.type&&(console.debug(`excute-script over with ${t.name} ${Date.now()-t.startTime}ms`),0===e.code?t.resolve(e.data):t.reject(new Error(`excute-task${t.name} failed!`)))}),r.once("error",e=>{r.kill();const t=this.runningPoolMap.get(r);t&&delete t._handleProcess,this.runningPoolMap.delete(r),t.reject(e)}),r.once("exit",(e,t)=>{const s=this.runningPoolMap.get(r);0===e?(console.debug(`Exit with code:${e}, signal:${t}`),s.resolve(),s&&delete s._handleProcess,this.runningPoolMap.delete(r)):s.reject(new Error(`Exit with code:${e}, signal:${t}`))}),null===(t=r.stdout)||void 0===t||t.on("data",e=>{const t=this.runningPoolMap.get(r);console.log(`[${t.name}]`+e.toString())}),null===(s=r.stderr)||void 0===s||s.on("data",e=>{const t=e.toString();if(!t||t.includes("Debugger")||t.includes("For help, see")||t.includes("Starting inspector on"))return void console.debug(t);const s=this.runningPoolMap.get(r);t.includes("[warning]")?console.warn(`[${s.name}]`+t.replace("[warning]","")):console.error(`[${s.name}]`+t)}),r}}exports.WorkerManager=WorkerManager,exports.workerManager=new WorkerManager;