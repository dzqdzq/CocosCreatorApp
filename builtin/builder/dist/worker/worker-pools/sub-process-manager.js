"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerManager=exports.WorkerManager=void 0;const child_process_1=require("child_process"),path_1=require("path"),workerPath=(0,path_1.join)(__dirname,"../../../static/sub-process-index");class ProcessPool{pool=new Set;runningPool=new Set;add(e){this.pool.add(e)}running(e){this.runningPool.add(e)}notRunning(e){this.runningPool.delete(e)}delete(e){this.notRunning(e),this.pool.delete(e)}killAll(){this.pool.forEach(e=>{e.kill()}),this.pool.clear()}kill(e){e.kill(),this.notRunning(e),this.delete(e)}killRunning(){this.runningPool.forEach(e=>{e.kill(),this.delete(e)}),this.runningPool.clear()}killFree(){this.pool.forEach(e=>{this.runningPool.has(e)||(e.kill(),this.pool.delete(e))})}}const processPool=new ProcessPool;class WorkerTask{path;lazy=!1;busy=!1;_name;_method;get name(){return this._method||this._name}_hasResolve=!1;_hasReject=!1;_resolve;_reject;setResolve=e=>{this._hasResolve=!1,this._resolve=e};setReject=e=>{this._hasReject=!1,this._reject=e};resolve=e=>{!this._hasResolve&&this._method&&this._resolve&&(console.debug(`execute-script-end with ${this.name} ${Date.now()-this.startTime}ms`),this._hasResolve=!0,delete this._method,this._resolve(e))};reject=e=>{!this._hasReject&&this._method&&this._reject?(console.error(e),this._hasReject=!0,delete this._method,this._reject(e)):e&&console.debug(e)};startTime=Date.now();_handleProcess;constructor(e){this._name=e.name,this.path=e.path,this.lazy=e.lazy||!1}async execute(s,o){const t=await this.getWorkerProcess();if(t)return new Promise((e,r)=>{this._method=s,this.setResolve(e),this.setReject(r),this.startTime=Date.now(),t.send({type:"execute-script",path:this.path,method:s,args:o}),processPool.running(t)});throw new Error("No worker "+this.name)}async getWorkerProcess(){return this._handleProcess||(this._handleProcess=await this.createWorkerProcess()),this._handleProcess}async createWorkerProcess(){const r=(0,child_process_1.fork)(workerPath,[],{execArgv:WorkerManager.defaultArgv||[],stdio:["ipc","pipe","pipe","pipe"],cwd:(0,path_1.dirname)(process.resourcesPath)});return r.on("message",e=>{e&&"execute-script-end"===e.type&&(processPool.notRunning(r),0===e.code?this.resolve(e.data):this.reject(new Error(`execute-task ${this.name} failed with code ${e.code}!`)))}),r.on("error",e=>{this.reject(e),this.close()}),r.on("exit",(e,r)=>{0!==e?this.reject(new Error(`Exit process with code:${e}, signal:${r} in task `+this.name)):this.resolve(),this.close()}),r.stdout?.on("data",e=>{console.log(`[${this.name}]`+e.toString())}),r.stderr?.on("data",e=>{e=e.toString();!e||e.includes("Debugger")||e.includes("For help, see")||e.includes("Starting inspector on")?console.debug(e):e.includes("[warning]")?console.warn(`[${this.name}]`+e.replace("[warning]","")):console.error(`[${this.name}]`+e)}),processPool.add(r),r}close(){this.busy=!1,delete this._method,this._handleProcess&&(processPool.kill(this._handleProcess),delete this._handleProcess)}}class WorkerManager{taskMap={};_clearFreeChildTimer;static defaultArgv=[];static async init(){WorkerManager.defaultArgv=await Editor.Profile.getConfig("builder","workerManagerDefaultArgv")||[]}static toggleDebug(){WorkerManager.defaultArgv.includes("--inspect")?WorkerManager.defaultArgv=WorkerManager.defaultArgv.filter(e=>"--inspect"!==e):WorkerManager.defaultArgv.push("--inspect")}constructor(e){e&&e.forEach(e=>this.registerTask(e))}async registerTask(e){this.taskMap[e.name]||(this.taskMap[e.name]=new WorkerTask(e))}async runTask(e,r,s){this.resetClearTimer();var o=this.taskMap[e];if(o)return o.execute(r,s);throw new Error("No worker "+e)}kill(e){e=this.taskMap[e];e&&e.close()}killRunningChilds=processPool.killRunning.bind(processPool);killFreeChilds=processPool.killFree.bind(processPool);resetClearTimer(){this._clearFreeChildTimer&&clearTimeout(this._clearFreeChildTimer),this._clearFreeChildTimer=setTimeout(()=>{this.killFreeChilds()},12e5)}quickSpawn(t,i,n={downGradeLog:!0,prefix:""}){return"npm"===t&&(t="win32"===process.platform?"npm.cmd":"npm"),n.prefix=n.prefix||"",new Promise((r,s)=>{const o=(0,child_process_1.spawn)(t,i,{cwd:n?.cwd||void 0,env:n?.env,shell:!!n?.shell});processPool.add(o),processPool.running(o),n.ignoreLog||o.stdout.on("data",e=>{e=e.toString(),n?.downGradeLog?console.debug(n.prefix+e.toString()):console.log(n.prefix+e.toString())}),o.stderr.on("data",r=>{r=r.toString();if(r&&"\n"!==r&&!/^(?=.*native-pack-tool)(?=.*No repository field)/gi.test(r)){r=n.prefix+r;let e="error";/warn/gi.test(r)?(e="warn",n?.downGradeWaring&&(e="log")):n?.downGradeError&&(e="log"),console[e](r)}}),o.on("close",e=>{processPool.delete(o),0!==e?s(n.prefix+(`Child process exit width code ${e}:${t} `+i.toString())):(r(!0),console.debug(n.prefix+"Child process exit width code "+e))}),o.on("error",e=>{processPool.delete(o),console.error(n.prefix+(`child process error: ${t} `+i.toString())),s(e)}),o.on("exit",e=>{processPool.delete(o),0!==e?s(n.prefix+(`Child process exit width code ${e}:${t} `+i.toString())):(r(!0),console.debug(n.prefix+"Child process exit width code "+e))})})}}exports.WorkerManager=WorkerManager,exports.workerManager=new WorkerManager;