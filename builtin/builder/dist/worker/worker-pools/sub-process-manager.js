"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerManager=exports.WorkerManager=void 0;const child_process_1=require("child_process"),path_1=require("path"),workerPath=(0,path_1.join)(__dirname,"../../../static/sub-process-index");class WorkerManager{constructor(e){this.taskMap={},this.pools=new Set,this.runningPoolMap=new WeakMap,this.debug=Editor.App.dev,this.startPort=9220,this.runningChild=new Set,e&&e.forEach(e=>this.registerTask(e))}async registerTask(e){this.taskMap[e.name]||(this.taskMap[e.name]=e,e.lazy||await this.getWorkerProcess(e.name))}runTask(e,r,t){return new Promise(async(o,s)=>{this.resetClearTimmer();const i=await this.getWorkerProcess(e),n=this.taskMap[e];console.log(`Run build task(${e}) in child${this.debug?n.port:""}, see: chrome://inspect/#devices`),i&&n?(n.reject=s,n.resolve=o,n.startTime=Date.now(),this.runningPoolMap.set(i,n),this.runningChild.add(i),n.busy=!0,i.send({type:"excute-script",path:n.path,method:r||n.method,args:t})):s(new Error("No worker "+e))})}kill(e){var r;const t=this.taskMap[e];t&&(null===(r=t._handleProcess)||void 0===r||r.kill(),this.pools.delete(t._handleProcess),this.runningChild.delete(t._handleProcess),delete t._handleProcess)}killRunningChilds(){0!==this.runningChild.size&&(this.runningChild.forEach(e=>{e.kill(),this.pools.delete(e);const r=this.runningPoolMap.get(e);r&&delete r._handleProcess}),this.runningChild.clear())}killFreeChilds(){this.pools.forEach(e=>{if(this.runningChild.has(e))return;e.kill(),this.pools.delete(e);const r=this.runningPoolMap.get(e);r&&delete r._handleProcess})}resetClearTimmer(){this._clearFreeChildTimmer&&clearTimeout(this._clearFreeChildTimmer),this._clearFreeChildTimmer=setTimeout(()=>{this.killFreeChilds()},12e5)}async getWorkerProcess(e){var r;const t=this.taskMap[e];if(!t)return null;if(!this.taskMap[e]._handleProcess){const o=await Editor.Network.getFreePort(this.startPort+this.pools.size);this.taskMap[e]._handleProcess=await this.createWorkerProcess(o),this.taskMap[e].port=o,Editor.Message.send("process","register-process-info",null===(r=this.taskMap[e]._handleProcess)||void 0===r?void 0:r.pid,"node:"+t.name)}return this.taskMap[e]._handleProcess}async createWorkerProcess(e){var r,t;const o=(0,child_process_1.fork)(workerPath,[],{execArgv:this.debug?[`--inspect=${e}`]:[],stdio:["ipc","pipe","pipe","pipe"]});return this.debug&&console.debug(`child ${e} in chrome://inspect/#devices`),this.pools.add(o),o.on("message",e=>{const r=this.runningPoolMap.get(o);e&&"excute-script over"===e.type&&(console.debug(`excute-script over with ${r.name} ${Date.now()-r.startTime}ms`),0===e.code?r.resolve(e.data):r.reject(new Error(`excute-task${r.name} failed!`)))}),o.once("error",e=>{o.kill();const r=this.runningPoolMap.get(o);r&&delete r._handleProcess,this.runningPoolMap.delete(o),r.busy=!1,r.reject(e)}),o.once("exit",(e,r)=>{const t=this.runningPoolMap.get(o);t.busy=!1,0===e?(console.debug(`Exit with code:${e}, signal:${r}`),t.resolve(),t&&delete t._handleProcess,this.runningPoolMap.delete(o)):t.reject(new Error(`Exit with code:${e}, signal:${r}`))}),null===(r=o.stdout)||void 0===r||r.on("data",e=>{const r=this.runningPoolMap.get(o);console.log(`[${r.name}]`+e.toString())}),null===(t=o.stderr)||void 0===t||t.on("data",e=>{const r=e.toString();if(!r||r.includes("Debugger")||r.includes("For help, see")||r.includes("Starting inspector on"))return void console.debug(r);const t=this.runningPoolMap.get(o);r.includes("[warning]")?console.warn(`[${t.name}]`+r.replace("[warning]","")):console.error(`[${t.name}]`+r)}),o}quickSpawn(e,r,t={downGradeLog:!0,prefix:""}){return"npm"===e&&(e="win32"===process.platform?"npm.cmd":"npm"),t.prefix=t.prefix||"",new Promise((o,s)=>{const i=(0,child_process_1.spawn)(e,r,{cwd:(null===t||void 0===t?void 0:t.cwd)||void 0,env:null===t||void 0===t?void 0:t.env});this.runningChild.add(i),t.ignoreLog||i.stdout.on("data",e=>{e=e.toString(),(null===t||void 0===t?void 0:t.downGradeLog)?console.debug(t.prefix+e.toString()):console.log(t.prefix+e.toString())}),i.stderr.on("data",e=>{const r=e.toString();if(!r||"\n"===r||/^(?=.*native-pack-tool)(?=.*No repository field)/gi.test(r))return;const o=t.prefix+r;let s="error";/warn/gi.test(o)?(s="warn",(null===t||void 0===t?void 0:t.downGradeWaring)&&(s="log")):(null===t||void 0===t?void 0:t.downGradeError)&&(s="log"),console[s](o)}),i.on("close",n=>{this.runningChild.delete(i),0!==n?s(t.prefix+`Child process exit width code ${n}:${e} ${r.toString()}`):(o(!0),console.debug(t.prefix+`Child process exit width code ${n}`))}),i.on("error",o=>{this.runningChild.delete(i),console.error(t.prefix+`child process error: ${e} ${r.toString()}`),s(o)}),i.on("exit",n=>{this.runningChild.delete(i),0!==n?s(t.prefix+`Child process exit width code ${n}:${e} ${r.toString()}`):(o(!0),console.debug(t.prefix+`Child process exit width code ${n}`))})})}}exports.WorkerManager=WorkerManager,exports.workerManager=new WorkerManager;