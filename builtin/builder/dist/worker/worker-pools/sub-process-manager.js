"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerManager=exports.WorkerManager=void 0;const child_process_1=require("child_process"),path_1=require("path"),workerPath=(0,path_1.join)(__dirname,"../../../static/sub-process-index");class WorkerManager{constructor(e){this.taskMap={},this.pools=new Set,this.runningPoolMap=new WeakMap,this.debug=Editor.App.dev,this.startPort=9220,this.runningChild=new Set,e&&e.forEach(e=>this.registerTask(e))}async registerTask(e){this.taskMap[e.name]||(this.taskMap[e.name]=e,e.lazy||await this.getWorkerProcess(e.name))}runTask(e,r,s){return new Promise(async(t,o)=>{this.resetClearTimmer();const i=await this.getWorkerProcess(e),n=this.taskMap[e];console.log(`Run build task(${e}) in child${this.debug?n.port:""}, see: chrome://inspect/#devices`),i&&n?(n.reject=o,n.resolve=t,n.startTime=Date.now(),this.runningPoolMap.set(i,n),this.runningChild.add(i),n.busy=!0,i.send({type:"excute-script",path:n.path,method:r||n.method,args:s})):o(new Error("No worker "+e))})}kill(e){var r;const s=this.taskMap[e];s&&(null===(r=s._handleProcess)||void 0===r||r.kill(),this.pools.delete(s._handleProcess),this.runningChild.delete(s._handleProcess),delete s._handleProcess)}killRunningChilds(){0!==this.runningChild.size&&(this.runningChild.forEach(e=>{e.kill(),this.pools.delete(e);const r=this.runningPoolMap.get(e);r&&delete r._handleProcess}),this.runningChild.clear())}killFreeChilds(){this.pools.forEach(e=>{if(this.runningChild.has(e))return;e.kill(),this.pools.delete(e);const r=this.runningPoolMap.get(e);r&&delete r._handleProcess})}resetClearTimmer(){this._clearFreeChildTimmer&&clearTimeout(this._clearFreeChildTimmer),this._clearFreeChildTimmer=setTimeout(()=>{this.killFreeChilds()},12e5)}async getWorkerProcess(e){var r;const s=this.taskMap[e];if(!s)return null;if(!this.taskMap[e]._handleProcess){const t=await Editor.Network.getFreePort(this.startPort+this.pools.size);this.taskMap[e]._handleProcess=await this.createWorkerProcess(t),this.taskMap[e].port=t,Editor.Message.send("process","register-process-info",null===(r=this.taskMap[e]._handleProcess)||void 0===r?void 0:r.pid,"node:"+s.name)}return this.taskMap[e]._handleProcess}async createWorkerProcess(e){var r,s;const t=(0,child_process_1.fork)(workerPath,[],{execArgv:this.debug?[`--inspect=${e}`]:[],stdio:["ipc","pipe","pipe","pipe"]});return this.debug&&console.debug(`child ${e} in chrome://inspect/#devices`),this.pools.add(t),t.on("message",e=>{const r=this.runningPoolMap.get(t);e&&"excute-script over"===e.type&&(console.debug(`excute-script over with ${r.name} ${Date.now()-r.startTime}ms`),0===e.code?r.resolve(e.data):r.reject(new Error(`excute-task${r.name} failed!`)))}),t.once("error",e=>{t.kill();const r=this.runningPoolMap.get(t);r&&delete r._handleProcess,this.runningPoolMap.delete(t),r.busy=!1,r.reject(e)}),t.once("exit",(e,r)=>{const s=this.runningPoolMap.get(t);s.busy=!1,0===e?(console.debug(`Exit with code:${e}, signal:${r}`),s.resolve(),s&&delete s._handleProcess,this.runningPoolMap.delete(t)):s.reject(new Error(`Exit with code:${e}, signal:${r}`))}),null===(r=t.stdout)||void 0===r||r.on("data",e=>{const r=this.runningPoolMap.get(t);console.log(`[${r.name}]`+e.toString())}),null===(s=t.stderr)||void 0===s||s.on("data",e=>{const r=e.toString();if(!r||r.includes("Debugger")||r.includes("For help, see")||r.includes("Starting inspector on"))return void console.debug(r);const s=this.runningPoolMap.get(t);r.includes("[warning]")?console.warn(`[${s.name}]`+r.replace("[warning]","")):console.error(`[${s.name}]`+r)}),t}quickSpawn(e,r,s={downGradeLog:!0,prefix:""}){return"npm"===e&&(e="win32"===process.platform?"npm.cmd":"npm"),s.prefix=s.prefix||"",new Promise((t,o)=>{const i=(0,child_process_1.spawn)(e,r,{cwd:(null===s||void 0===s?void 0:s.cwd)||void 0,env:null===s||void 0===s?void 0:s.env});this.runningChild.add(i),s.ignoreLog||i.stdout.on("data",e=>{(null===s||void 0===s?void 0:s.downGradeLog)?console.debug(s.prefix+e.toString()):console.log(s.prefix+e.toString())}),i.stderr.on("data",e=>{const r=e.toString();if(!r||"\n"===r||/^(?=.*native-pack-tool)(?=.*No repository field)/gi.test(r))return;const t=s.prefix+r;let o="error";/warn/gi.test(t)?(o="warn",(null===s||void 0===s?void 0:s.downGradeWaring)&&(o="log")):(null===s||void 0===s?void 0:s.downGradeError)&&(o="log"),console[o](t)}),i.on("close",n=>{this.runningChild.delete(i),0!==n?o(s.prefix+`Child process exit width code ${n}:${e} ${r.toString()}`):t(!0)}),i.on("error",t=>{this.runningChild.delete(i),console.error(s.prefix+`child process error: ${e} ${r.toString()}`),o(t)}),i.on("exit",e=>{this.runningChild.delete(i),console.debug(s.prefix+`Child process exit width code ${e}`)})})}}exports.WorkerManager=WorkerManager,exports.workerManager=new WorkerManager;