"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkSplash=exports.formatSplashScreen=exports.getPhysicsConfig=exports.getSplashSettings=exports.patchOptionsToSettings=void 0;const fs_extra_1=require("fs-extra"),lodash_1=require("lodash"),path_1=require("path"),layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function patchOptionsToSettings(e,t){t.launch.launchScene=e.startScene,t.engine.debug=e.debug,t.screen.designResolution=e.resolution,t.engine.platform=e.platform||t.engine.platform,t.assets.server=e.server||"",t.CocosEngine=Editor.App.version,t.engine.customLayers=e.customLayers.map(t=>{var e=layerMask.findIndex(e=>t.value===e);return{name:t.name,bit:e}}),t.engine.customLayers.sort((e,t)=>e.bit-t.bit),t.engine.sortingLayers=e.sortingLayers;var a=await Editor.Profile.getProject("project","general.renderPipeline","default"),a=(t.rendering.renderPipeline=e.renderPipeline===a?"":e.renderPipeline,t.rendering.customPipeline=e.customPipeline,t.animation.customJointTextureLayouts=await Editor.Message.request("project","calc-joint-layout")||[],e.includeModules.includes("custom-pipeline")&&(t.rendering.effectSettingsPath="src/effect.bin"),t.splashScreen=await getSplashSettings(!!e.useSplashScreen,!!e.preview),t.physics=await getPhysicsConfig(e.includeModules,e.physicsConfig),t.engine.macros=e.macroConfig||{},await Editor.Profile.getProject("project","general.downloadMaxConcurrency"));t.assets.downloadMaxConcurrency=a||15}async function getSplashSettings(e,t){var a=await Editor.Profile.getProject("builder","splash-setting","default");let r=await Editor.Profile.getProject("builder","splash-setting");if(!1===e&&!t)return e=formatSplashScreen(a),await checkSplash("removeSplash")?(e.totalTime=0,delete e.logo,delete e.background):console.warn(Editor.I18n.t("builder.warn.invalidRemoveSplash")),e;try{let e=!0;return t||(0,lodash_1.isEqual)(a,r)||await checkSplash("customSplash")||(console.warn(Editor.I18n.t("builder.warn.invalidCustomSplash")),e=!1),r&&e?formatSplashScreen(r=Object.assign({},a,r)):formatSplashScreen(a)}catch(e){return console.error(e),console.error(Editor.I18n.t("builder.error.missingSplashTips",{splashScreen:JSON.stringify(r)})),formatSplashScreen(a)}}async function getPhysicsConfig(t,e){let a="";var r=["physics-cannon","physics-ammo","physics-builtin","physics-physx"];for(let e=0;e<r.length;e++)if(0<=t.indexOf(r[e])){a=r[e];break}return Object.assign({physicsEngine:a},e)}function formatSplashScreen(e){var t;return e.logo&&("custom"===e.logo.type?(t=Editor.UI.__protected__.File.resolveToRaw(e.logo.image),e.logo.base64="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(t).toString("base64")):"default"===e.logo.type&&(t=(0,path_1.join)(Editor.App.path,"builtin/builder/static/logo/logo.png").replace("app.asar","app.asar.unpacked"),e.logo.base64="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(t).toString("base64")),delete e.logo.image),e.background&&("custom"===e.background.type?(t=Editor.UI.__protected__.File.resolveToRaw(e.background.image),e.background.base64="data:image/png;base64,"+(0,fs_extra_1.readFileSync)(t).toString("base64"),delete e.background.color):"default"===e.background.type&&(e.background.color={x:4/255,y:9/255,z:10/255,w:1/255}),delete e.background.image),e}async function checkSplash(e){if(e)try{var t=await Editor.Message.request("information","query-information",e);if(await Editor.Profile.getProject("information",`information.${e}.passByNetworkFailure`))return await Editor.Profile.removeProject("information",`information.${e}.passByNetworkFailure`),!0;if(t&&t.data&&t.data.enable&&!t.data[t.data.id].complete)return!1}catch(e){console.debug(e)}return!0}exports.patchOptionsToSettings=patchOptionsToSettings,exports.getSplashSettings=getSplashSettings,exports.getPhysicsConfig=getPhysicsConfig,exports.formatSplashScreen=formatSplashScreen,exports.checkSplash=checkSplash;