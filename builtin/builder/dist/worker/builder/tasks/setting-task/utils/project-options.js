"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkSplash=exports.formatSplashScreen=exports.getProjectMacro=exports.getPhysicsConfig=exports.getSplashSettings=exports.patchOptionsToSettings=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),lodash_1=require("lodash"),layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function patchOptionsToSettings(e,t){t.launch.launchScene=e.startScene,t.engine.debug=e.debug,t.screen.designResolution=e.resolution,t.engine.platform=e.platform||t.engine.platform,t.assets.server=e.server||"",t.CocosEngine=Editor.App.version,t.engine.customLayers=e.customLayers.map(e=>{const t=layerMask.findIndex(t=>e.value===t);return{name:e.name,bit:t}}),t.engine.customLayers.sort((e,t)=>e.bit-t.bit),t.engine.sortingLayers=e.sortingLayers;const r=await Editor.Profile.getProject("project","general.renderPipeline","default");t.rendering.renderPipeline=e.renderPipeline===r?"":e.renderPipeline,t.animation.customJointTextureLayouts=await Editor.Message.request("project","calc-joint-layout")||[],e.includeModules.includes("custom-pipeline")&&(t.rendering.effectSettingsPath="src/effect.bin"),t.splashScreen=await getSplashSettings(!!e.useSplashScreen,!!e.preview),t.physics=await getPhysicsConfig(e.includeModules,e.physicsConfig),t.engine.macros=await getProjectMacro(e.macroConfig)}async function getSplashSettings(e,t){const r=await Editor.Profile.getProject("builder","splash-setting","default");let s=await Editor.Profile.getProject("builder","splash-setting");const a={};if(!1===e&&!t)return s=formatSplashScreen(r),await checkSplash("removeSplash")?(s.totalTime=0,delete s.base64src,delete s.bgBase64,a.B100039=3):console.warn(Editor.I18n.t("builder.warn.invalidRemoveSplash")),s;try{let e=!0;return t||(0,lodash_1.isEqual)(r,s)||await checkSplash("customSplash")||(console.warn(Editor.I18n.t("builder.warn.invalidCustomSplash")),e=!1),s&&e?(s=Object.assign({},r,s),a.B100039=1,formatSplashScreen(s)):(a.B100039=2,formatSplashScreen(r))}catch(e){return console.error(e),console.error(Editor.I18n.t("builder.error.missingSplashTips",{splashScreen:JSON.stringify(s)})),formatSplashScreen(r)}}async function getPhysicsConfig(e,t){let r="";const s=["physics-cannon","physics-ammo","physics-builtin","physics-physx"];for(let t=0;t<s.length;t++)if(e.indexOf(s[t])>=0){r=s[t];break}return Object.assign({physicsEngine:r},t)}async function getProjectMacro(e){const t=await Editor.Profile.getProject("engine","macroConfig","default");return(e=e||await Editor.Profile.getProject("engine","macroConfig"))&&(Object.keys(e).forEach(r=>{void 0!==e[r]&&e[r]!==t[r]||delete e[r]}),Object.keys(e).length>0)?e:{}}function formatSplashScreen(e){const t=Editor.UI.__protected__.File.resolveToRaw(e.url);e.base64src=`data:image/png;base64,${(0,fs_extra_1.readFileSync)(t).toString("base64")}`,delete e.url;const r=(0,path_1.join)(__dirname,"../../../../../../static/logo/bg.png");return e.bgBase64=e.bgBase64||`data:image/png;base64,${(0,fs_extra_1.readFileSync)(r).toString("base64")}`,e}async function checkSplash(e){if(!e)return!0;try{const t=await Editor.Message.request("information","query-information",e);if(await Editor.Profile.getProject("information",`information.${e}.passByNetworkFailure`))return await Editor.Profile.removeProject("information",`information.${e}.passByNetworkFailure`),!0;if(t&&("network_failure"===t.status||"network_exception"===t.status||t.data&&t.data.enable&&!t.data[t.data.id].complete))return!1}catch(e){console.debug(e)}return!0}exports.patchOptionsToSettings=patchOptionsToSettings,exports.getSplashSettings=getSplashSettings,exports.getPhysicsConfig=getPhysicsConfig,exports.getProjectMacro=getProjectMacro,exports.formatSplashScreen=formatSplashScreen,exports.checkSplash=checkSplash;