"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),script_1=require("../../asset-handler/script"),engine_1=require("../../asset-handler/script/engine"),utils_1=require("../../utils");async function handle(t,i,r){Editor.Metrics.trackTimeStart("builder:build-script-total"),await script_1.ScriptBuilder.buildPolyfills(t.polyfills,i.paths.polyfillsJs)||delete i.paths.polyfillsJs,this.updateProcess("Generate systemJs..."),await script_1.ScriptBuilder.buildSystemJs({dest:i.paths.systemJs,sourceMaps:t.sourceMaps,debug:t.debug,platform:t.platform,hotModuleReload:t.buildScriptParam.hotModuleReload}),this.updateProcess(`${Editor.I18n.t("builder.tasks.build_project_script")} start...`),Editor.Metrics.trackTimeStart("builder:build-project-script");const e=await this.bundleManager.buildScript();e&&(e.scriptPackages&&i.scriptPackages.push(...e.scriptPackages),e.importMappings&&Object.assign(i.importMap.imports,e.importMappings));const a=await Editor.Metrics.trackTimeEnd("builder:build-project-script");if(this.updateProcess(`${Editor.I18n.t("builder.tasks.build_project_script")} in (${a} ms) √`),!t.buildEngineParam.skip){t.buildEngineParam.platform!==t.buildScriptParam.platform&&"HTML5"!==t.buildScriptParam.platform&&(t.buildEngineParam.platform=t.buildScriptParam.platform),t.buildEngineParam.targets=t.buildScriptParam.targets,t.buildEngineParam.flags=t.buildScriptParam.flags,t.buildEngineParam.isNative=script_1.ScriptBuilder.projectOptions.ccEnvConstants.NATIVE,t.buildEngineParam.flags.CULL_MESHOPT=!t.buildEngineParam.includeModules.includes("3d"),this.updateProcess(`${Editor.I18n.t("builder.tasks.build_engine")} start...`),Editor.Metrics.trackTimeStart("builder:build-engine");const{metaFile:r}=await(0,engine_1.buildEngineX)(t.buildEngineParam),e=await(0,engine_1.queryEngineImportMap)(r,i.paths.engineDir,(0,path_1.dirname)(i.paths.importMap));Object.assign(i.importMap.imports,e);const a=await Editor.Metrics.trackTimeEnd("builder:build-engine");this.updateProcess(`${Editor.I18n.t("builder.tasks.build_engine")} in (${a} ms) √`)}this.updateProcess("Copy plugin script ..."),this.bundleManager.bundles.forEach(t=>{for(const e of t.pluginScript){const t=r.getAssetInfo(e),a=(0,utils_1.removeDbHeader)(t.url),s=(0,path_1.join)(i.paths.dir,"src",a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),(0,fs_extra_1.copyFileSync)(t.library[".js"],s),i.paths.plugins[e]=s}}),this.updateProcess("Generate import-map..."),await script_1.ScriptBuilder.outputImportMap(i.importMap,{dest:i.paths.importMap,importMapFormat:t.buildScriptParam.importMapFormat,debug:t.debug})}exports.title="i18n:builder.tasks.build_script",exports.handle=handle;