"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),script_1=require("../../asset-handler/script"),engine_1=require("../../asset-handler/script/engine"),utils_1=require("../../utils");async function handle(t,i,e){Editor.Metrics.trackTimeStart("builder:build-script-total"),await script_1.ScriptBuilder.buildPolyfills(t.polyfills,i.paths.polyfillsJs)||delete i.paths.polyfillsJs,i.emit("update","Generate systemJs..."),await script_1.ScriptBuilder.buildSystemJs({dest:i.paths.systemJs,sourceMaps:t.sourceMaps,debug:t.debug,platform:t.platform,hotModuleReload:t.buildScriptParam.hotModuleReload}),i.emit("update",`${Editor.I18n.t("builder.tasks.build_project_script")} start...`),Editor.Metrics.trackTimeStart("builder:build-project-script");const r=await this.bundleManager.buildScript();r&&(r.scriptPackages&&i.scriptPackages.push(...r.scriptPackages),r.importMappings&&Object.assign(i.importMap.imports,r.importMappings));const a=await Editor.Metrics.trackTimeEnd("builder:build-project-script");if(i.emit("update",`${Editor.I18n.t("builder.tasks.build_project_script")} in (${a} ms) √`),!t.buildEngineParam.skip){t.buildEngineParam.platform!==t.buildScriptParam.platform&&"HTML5"!==t.buildScriptParam.platform&&(t.buildEngineParam.platform=t.buildScriptParam.platform),t.buildEngineParam.targets=t.buildScriptParam.targets,t.buildEngineParam.flags=t.buildScriptParam.flags,t.buildEngineParam.flags.CULL_MESHOPT=!t.buildEngineParam.includeModules.includes("3d"),i.emit("update",`${Editor.I18n.t("builder.tasks.build_engine")} start...`),Editor.Metrics.trackTimeStart("builder:build-engine");const{metaFile:e}=await(0,engine_1.buildEngineX)(t.buildEngineParam),r=await(0,engine_1.queryEngineImportMap)(e,i.paths.engineDir,(0,path_1.dirname)(i.paths.importMap));Object.assign(i.importMap.imports,r);const a=await Editor.Metrics.trackTimeEnd("builder:build-engine");i.emit("update",`${Editor.I18n.t("builder.tasks.build_engine")} in (${a} ms) √`)}i.emit("update","Copy plugin script ..."),this.bundleManager.bundles.forEach(t=>{for(const r of t.pluginScript){const t=e.getAssetInfo(r),a=(0,utils_1.removeDbHeader)(t.url),s=(0,path_1.join)(i.paths.dir,"src",a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),(0,fs_extra_1.copyFileSync)(t.library[".js"],s),i.paths.plugins[r]=s}}),i.emit("update","Generate import-map..."),await script_1.ScriptBuilder.outputImportMap(i.importMap,{dest:i.paths.importMap,importMapFormat:t.buildScriptParam.importMapFormat,debug:t.debug})}exports.title="i18n:builder.tasks.build_script",exports.handle=handle;