"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.title=void 0,exports.handle=handle;const fs_extra_1=require("fs-extra"),path_1=require("path"),script_1=require("../../asset-handler/script"),engine_1=require("../../asset-handler/script/engine"),utils_1=require("../../utils");async function handle(e,t,i){Editor.Metrics.trackTimeStart("builder:build-script-total");await script_1.ScriptBuilder.buildPolyfills(e.polyfills,t.paths.polyfillsJs)||delete t.paths.polyfillsJs,this.updateProcess("Generate systemJs..."),await script_1.ScriptBuilder.buildSystemJs({dest:t.paths.systemJs,sourceMaps:e.sourceMaps,debug:e.debug,platform:e.platform,hotModuleReload:e.buildScriptParam.hotModuleReload});var a=await this.bundleManager.buildScript();if(a&&(a.scriptPackages&&t.scriptPackages.push(...a.scriptPackages),a.importMappings)&&Object.assign(t.importMap.imports,a.importMappings),!e.buildEngineParam.skip){e.buildEngineParam.targets=e.buildScriptParam.targets,e.buildEngineParam.flags=e.buildScriptParam.flags,e.buildEngineParam.platform&&!e.buildEngineParam.platformType&&(e.buildEngineParam.platformType=e.buildEngineParam.platform),this.updateProcess(Editor.I18n.t("builder.tasks.build_engine")+" start...");var a=e.buildEngineParam["separateEngineOptions"];let i=!!a;a&&Editor.App.isPackaged&&a.checkVersionValid&&((e.debug||e.sourceMaps)&&console.warn(Editor.I18n.t("builder.warn.invalidModeInSeparateEngine")),/\d*\.\d*\.\d*$/.test(Editor.App.version)?"custom"===e.engineInfo.typescript.type&&(console.warn(Editor.I18n.t("builder.warn.separateEngineWithCustomEngine")),i=!1):(console.warn(Editor.I18n.t("builder.warn.invalidVersionInSeparateEngine")),i=!1)),Editor.Metrics.trackTimeStart("builder:build-engine"),i&&a?(a=await(0,engine_1.buildSplitEngine)({...e.buildEngineParam,...a,platform:e.platform,engine:e.buildEngineParam.entry,importMapOutFile:t.paths.importMap,useCacheForce:Editor.App.isPackaged}),t.paths.engineMeta=a.paths.meta,Object.assign(t.importMap.imports,a.importMap),t.separateEngineResult=a):(a=(await(0,engine_1.buildEngineX)(e.buildEngineParam,script_1.ScriptBuilder.projectOptions.ccEnvConstants))["metaFile"],t.paths.engineMeta=a,a=await(0,engine_1.queryEngineImportMap)(a,e.buildEngineParam.output,(0,path_1.dirname)(t.paths.importMap)),Object.assign(t.importMap.imports,a));a=await Editor.Metrics.trackTimeEnd("builder:build-engine");this.updateProcess(Editor.I18n.t("builder.tasks.build_engine")+` in (${a} ms) âˆš`)}this.updateProcess("Copy plugin script ...");for(const s of t.pluginScripts){var r=(0,utils_1.removeDbHeader)(s.url),r=(0,path_1.join)(t.paths.dir,"src",r);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r)),(0,fs_extra_1.copyFileSync)(s.file,r),t.paths.plugins[s.uuid]=r}this.updateProcess("Generate import-map..."),await script_1.ScriptBuilder.outputImportMap(t.importMap,{dest:t.paths.importMap,importMapFormat:e.buildScriptParam.importMapFormat,debug:e.debug})}exports.title="i18n:builder.tasks.build_script";