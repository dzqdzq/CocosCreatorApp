"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var a=Object.getOwnPropertyDescriptor(t,i);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,a)}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[i.length]=t);return i})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=a(e),r=0;r<i.length;r++)"default"!==i[r]&&__createBinding(t,e,i[r]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.name=exports.title=void 0,exports.handle=handle;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),utils_1=require("../../utils"),APPLICATION_EJS_VERSION="1.0.0";async function handle(e,t,i){var r=JSON.stringify(t.settings,null,e.debug?4:0),r=((0,fs_extra_1.outputFileSync)(t.paths.settings,r,"utf8"),(await Editor.Message.request("engine","query-engine-info")).typescript.path),r=(0,path_1.join)(r,"templates/launcher"),a=this.buildTemplate.query("application")||(0,path_1.join)(r,"application.ejs"),s=(0,utils_1.relativeUrl)(t.paths.dir,t.paths.settings),a=await ejs_1.default.renderFile(a,Object.assign(e.appTemplateData,{settingsJsonPath:s,hasPhysicsAmmo:e.buildEngineParam.includeModules.includes("physics-ammo"),versionTips:Editor.I18n.t("builder.tips.applicationEjsVersion"),customVersion:APPLICATION_EJS_VERSION,versionCheckTemplate:(0,path_1.join)(r,"version-check.ejs")})),s=await babel.transformAsync(a,{presets:[[preset_env_1.default,{modules:(0,utils_1.toBabelModules)("systemjs"),targets:e.buildScriptParam.targets}]]});if(!s||!s.code)throw new Error("无法生成 application.js");(0,fs_extra_1.outputFileSync)(t.paths.applicationJS,s.code),e.md5CacheOptions.includes.push(Editor.Utils.Path.relative(t.paths.dir,t.paths.applicationJS))}exports.title="i18n:builder.tasks.build_template",exports.name="build-task/template";