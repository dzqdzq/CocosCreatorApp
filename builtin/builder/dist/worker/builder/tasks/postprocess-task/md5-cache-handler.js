"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.md5CacheHandler=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../utils"),minimatch_1=__importDefault(require("minimatch")),globby_1=__importDefault(require("globby")),textFiles=[".js",".ts",".html"];class md5CacheHandler{hashedPathMap={};options;_root;_files=[];_waitingMd5Files=[];_waitingReplaceFiles=[];waitUpdateFiles={};constructor(t,e){this.options=e,this._root=t}async initFiles(){this.options.excludes.push((0,path_1.join)(this._root,"**/*.map")),this.options.excludes.push((0,path_1.join)(this._root,"**.ico")),this.options.excludes.push((0,path_1.join)(this._root,"**.icns")),this.options.includes=[...this.options.replaceOnly,...this.options.includes];var t=await(0,globby_1.default)(this.options.includes,{onlyFiles:!0,ignore:this.options.excludes,deep:0});const e=Object.values(this.hashedPathMap).map(t=>(0,path_1.resolve)(t));this._files=t.map(t=>(0,path_1.resolve)(t)).filter(t=>!e.includes(t)),this.options.replaceOnly.length?this._files.forEach(e=>{(this.options.replaceOnly.find(t=>(0,minimatch_1.default)(e,t))?this._waitingReplaceFiles:this._waitingMd5Files).push(e)}):this._waitingMd5Files=this._files}async run(){await this.initFiles(),await this.addMD5ToFiles(),this._waitingMd5Files.length&&await Promise.all(this._waitingReplaceFiles.map(t=>this.replacePath(t)))}async replacePath(t){var e=await this.readFileDepends(t);e&&e.depends.length&&(await this.replacePathInCode(t,e),await(0,fs_extra_1.outputFile)(t,e.code))}async addMd5ToPath(t,e){var a=(0,utils_1.calcMd5)(e||(0,fs_extra_1.readFileSync)(t,"utf-8")),a=(0,utils_1.patchMd5ToPath)(t,a);return e?(await(0,fs_extra_1.remove)(t),await(0,fs_extra_1.outputFile)(a,e)):await(0,fs_extra_1.rename)(t,a),this.hashedPathMap[t]=a}findFile(t,e){var a;if((0,path_1.extname)(e))return a=(0,path_1.join)(t,e),this.checkPathExist(a)||!e.startsWith(".")&&(a=(0,path_1.join)(this._root,e),this.checkPathExist(a))?a:"";for(const s of[".js",".json","/index.js","/index.json"]){var i=this._joinPath(t,e,s);if(this.checkPathExist(i))return i;if(!e.startsWith(".")&&(i=this._joinPath(this._root,e,s),this.checkPathExist(i)))return i}return""}checkPathExist(t){return this._files.includes(t)||this.hashedPathMap[t]}_joinPath(t,e,a){return a.startsWith(".")?(0,path_1.join)(t,e+a):(0,path_1.join)(t,e,a)}async addMD5ToFiles(){var t=this._waitingMd5Files;await Promise.all(t.map(async t=>{var e;this.hashedPathMap[t]||((e=await this.readFileDepends(t))&&e.depends.length?(await this.replacePathInCode(t,e),e.depends.length?this.waitUpdateFiles[t]=e:await this.addMd5ToPath(t,e.code)):await this.addMd5ToPath(t,e?.code))})),await new Promise(async(t,e)=>{try{for(var a=Object.keys(this.waitUpdateFiles);a.length;){var i=a.shift();if(!i)return;var s=this.waitUpdateFiles[i];await this.replacePathInCode(i,s),0===s.depends.length?(await this.addMd5ToPath(i,s.code),delete this.waitUpdateFiles[i]):a.push(i)}}catch(t){e(t)}t()})}replacePathInCode(a,i){const s=[];return i.depends.forEach((t,e)=>{this.hashedPathMap[t.path]?i.code=i.code.replaceAll(t.matchStr,t.matchStr.replace((0,path_1.basename)(t.fileName),(0,path_1.basename)(this.hashedPathMap[t.path]))):this.waitUpdateFiles[t.path]&&this.waitUpdateFiles[t.path].depends.find(t=>t.path===a)||!this._waitingMd5Files.includes(t.path)||s.push(t)}),i.depends=s,i}async readFileDepends(t){var e=(0,path_1.extname)(t);if(!textFiles.includes(e))return null;var a=(0,fs_extra_1.readFileSync)(t,"utf-8"),i=/(?:'|\")([^\s'"]+)(?:'|\")/g;let s=[];if(".html"===e){s=Array.from(a.matchAll(/(?:href|src)="([^"]*)"/g));e=extractScriptContents(a);if(e.length)for(const l of e)s=s.concat(Array.from(l.matchAll(i)))}else s=Array.from(a.matchAll(i));var h=[],r=(0,path_1.dirname)(t);for(const o of s){var n=this.findFile(r,o[1]);n&&h.push({path:n,matchStr:o[0],fileName:o[1]})}return{depends:h,code:a}}}function extractScriptContents(t){for(var e,a=[],i=/<script\b[^>]*>([\s\S]*?)<\/script>/gm;null!==(e=i.exec(t));)e[1]&&a.push(e[1]);return a}exports.md5CacheHandler=md5CacheHandler;