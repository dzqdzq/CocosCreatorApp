"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),texture_packer_1=__importDefault(require("../texture-packer")),_lodash=require("lodash"),EditorExtends=require("@base/electron-module").require("EditorExtends");async function handle(e,t,s){const a=[];for(const e of s.assetUuids){const t=s.getAssetInfo(e);"auto-atlas"===t.importer&&a.push(t)}a.sort((e,t)=>-e.source.localeCompare(t.source,"en",{numeric:!0}));const r=new texture_packer_1.default;await r.init(a);const i=[];t.bundles.forEach(e=>i.push(...e.assetsWithoutRedirect));const u=await r.pack(Array.from(new Set(i)));if(!u.length)return;let n=new Set;console.group("Pack atlases..."),await Promise.all(u.map(async e=>{if(e.unpackedImages&&(n=new Set([...n,...e.unpackedImages])),0===e.atlases.length)return;const a=new cc.SpriteAtlas;a._uuid=e.pacInfo.asset.uuid,a.name=path_1.basename(e.pacInfo.asset.name,path_1.extname(e.pacInfo.asset.name));const{removeSpriteAtlasInBundle:r,removeImageInBundle:u,removeTextureInBundle:o}=e.options;i.includes(e.pacInfo.asset.uuid)&&!r&&s.addInstance(a);const{useCompressTexture:d,presetId:p}=e.pacInfo.meta.userData.compressSettings||{};for(const i of e.atlases){const n=i.imageUuid,c=i.textureUuid;if(i.compressd&&(i.compressed=i.compressd),!i.compressed)throw new Error("Can't find atlas.compressed.");const l=new cc.ImageAsset;l._setRawAsset(".png"),l._uuid=n,l._width=l._nativeAsset.width=i.width,l._height=l._nativeAsset.height=i.height;const m=new cc.Texture2D;e.pacInfo.meta.userData.textureSetting||console.warn(`meta.userData.textureSetting in asset(${e.pacInfo.asset.uuid}) is missing.`),applyTextureBaseAssetUserData(e.pacInfo.meta.userData.textureSetting,m),m._mipmaps=[l],m._uuid=c,s.addInstance(l),s.addInstance(m),i.spriteFrameInfos&&i.spriteFrameInfos.forEach(e=>{const r=generateSpriteFrame(e,m);delete t.imageTaskMap[e.uuid.replace(/@.+/,"")],a.spriteFrames[e.name]=EditorExtends.serialize.asAsset(r._uuid),s.addInstance(r)});let _=null;for(const l of t.bundles){const m=l.assetsWithoutRedirect,f=new Set(m);if(!f.has(e.pacInfo.asset.uuid)&&!e.pacInfo.spriteFrames.find(e=>f.has(e._uuid)))continue;const h=l.atlasRes;h.atlasToImages[a._uuid]=[];const g=[],T=[],I=[],x=["cc.SpriteFrame","cc.Texture2D"];for(const e of m){const t=s.getAssetInfo(e);if(!t||x.includes(t.type))continue;const a=await s.getDependUuids(t.uuid);for(const e of a)s.getAssetInfo(e)?e.endsWith("@6c48a")?g.push(e):("cc.Image"===s.getAssetInfo(e).type&&T.push(e),"cc.SpriteAtlas"===s.getAssetInfo(e).type&&I.push(e)):console.error(Editor.I18n.t("builder.error.required_asset_missing",{uuid:e,fatherUrl:t.url}))}const A=e.pacInfo.asset.url.startsWith(l.root+"/"),E=[];for(const t of i.spriteFrameInfos)l.getRedirect(t.uuid)||e.options.filterUnused&&!f.has(t.uuid)||(l.addAssetWithUuid(t.uuid),l.removeFromGroups(t.uuid),g.includes(t.textureUuid)||!o&&A?g.includes(t.textureUuid)&&!A&&console.warn(Editor.I18n.t("builder.tips.use_texture_in_atlas",{info:`{asset(${t.textureUuid})}`})):l.removeAsset(t.textureUuid),T.includes(t.imageUuid)||!u&&A?T.includes(t.imageUuid)&&!A&&console.warn(Editor.I18n.t("builder.tips.use_image_in_atlas",{info:`{asset(${t.imageUuid})}`})):l.removeAsset(t.imageUuid),E.push(t.uuid),h.assetsToImage[t.uuid]=n,h.assetsToImage[t.imageUuid]=n);if(l.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?l.groups[0].uuids.push(...E):l.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&l.addGroup("NORMAL",[...E]),_&&_.priority!==l.priority)l.addRedirectWithUuid(c,_.name);else{l.addAssetWithUuid(n),l.addAssetWithUuid(c),l.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?l.groups[0].uuids.push(n,c):l.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&(l.addToGroup("IMAGE",n),l.addToGroup("TEXTURE",c));const s=path_1.join(n.slice(0,2),n+path_1.extname(i.imagePath));fs_extra_1.copySync(i.imagePath,path_1.join(l.dest,l.nativeBase,s)),d&&(t.imageTaskMap[n]?(t.imageTaskMap[n].dest.push(s),t.imageTaskMap[n].bundleNames.push(l.name)):t.imageTaskMap[n]={src:i.imagePath,dest:[s],hasAlpha:!0,presetId:p,mtime:e.mtimeMd5,bundleNames:[l.name]}),_||(_=l)}I.includes(a._uuid)||A&&!r?(I.includes(a._uuid)||A)&&(l.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?l.groups[0].uuids.push(a._uuid):l.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&l.groups[l.groups.length-1].uuids.push(a._uuid)):(l.removeAsset(a._uuid),console.debug(`remove spriteAtlas._uuid : {asset(${a._uuid})}`)),h.imageToAtlas[n]=a._uuid,h.assetsToImage[c]=n,h.atlasToImages[a._uuid].push(n)}}})),console.groupEnd()}function addJSONToBundle(e,t){}function applyTextureBaseAssetUserData(e,t){e=e||{wrapModeS:"repeat",wrapModeT:"repeat",minfilter:"nearest",magfilter:"linear",mipfilter:"none",anisotropy:1};const s=e=>{switch(e){case"clamp-to-edge":return cc.TextureBase.WrapMode.CLAMP_TO_EDGE;case"repeat":return cc.TextureBase.WrapMode.REPEAT;case"mirrored-repeat":return cc.TextureBase.WrapMode.MIRRORED_REPEAT}},a=e=>{switch(e){case"nearest":return cc.TextureBase.Filter.NEAREST;case"linear":return cc.TextureBase.Filter.LINEAR;case"none":return cc.TextureBase.Filter.NONE}};t.setWrapMode(s(e.wrapModeS),s(e.wrapModeT)),t.setFilters(a(e.minfilter),a(e.magfilter)),t.setMipFilter(a(e.mipfilter)),t.setAnisotropy(e.anisotropy)}function generateSpriteFrame(e,t){const s=new cc.SpriteFrame,a=e.spriteFrame;s._name=e.name,s._uuid=a._uuid,s.texture=t;const r=e.trim;return s._rect=cc.rect(r.x,r.y,r.width,r.height),s._offset=a.getOffset(),s._originalSize=cc.size(e.rawWidth,e.rawHeight),s._rotated=e.rotated,s._capInsets=[a.insetLeft,a.insetTop,a.insetRight,a.insetBottom],s}exports.title="i18n:tasks.build_atlas",exports.name="build-task/image",exports.handle=handle;