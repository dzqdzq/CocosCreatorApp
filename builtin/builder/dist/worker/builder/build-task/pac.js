"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const Editor=__importStar(require("editor")),fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),texture_packer_1=__importDefault(require("../texture-packer")),_lodash=require("lodash"),EditorExtends=require("@base/electron-module").require("EditorExtends");async function handle(e,t,s){if(!e.packAutoAtlas)return void console.debug("options.packAutoAtlas is false.");const a=[];for(const e of s.assetUuids){const t=s.getAssetInfo(e);"auto-atlas"===t.importer&&a.push(t)}a.sort((e,t)=>-e.source.localeCompare(t.source,"en",{numeric:!0}));const r=new texture_packer_1.default;await r.init(a);const i=[];t.bundles.forEach(e=>i.push(...e.assetsWithoutRedirect));const n=await r.pack(Array.from(new Set(i)));if(!n.length)return;let u=new Set;console.group("Pack atlases..."),await Promise.all(n.map(async e=>{if(e.unpackedImages&&(u=new Set([...u,...e.unpackedImages])),0===e.atlases.length)return;const a=new cc.SpriteAtlas;a._uuid=e.pacInfo.asset.uuid,a.name=path_1.basename(e.pacInfo.asset.name,path_1.extname(e.pacInfo.asset.name)),i.includes(e.pacInfo.asset.uuid)&&s.addInstance(a);const{useCompressTexture:r,presetId:n}=e.pacInfo.meta.userData.compressSettings||{};for(const i of e.atlases){const u=i.imageUuid,o=i.textureUuid;if(i.compressd&&(i.compressed=i.compressd),!i.compressed)throw new Error("Can't find atlas.compressed.");const d=new cc.ImageAsset;d._setRawAsset(".png"),d._uuid=u,d._width=d._nativeAsset.width=i.width,d._height=d._nativeAsset.height=i.height;const c=new cc.Texture2D;e.pacInfo.meta.userData.textureSetting||console.warn(`meta.userData.textureSetting in asset(${e.pacInfo.asset.uuid}) is missing.`),applyTextureBaseAssetUserData(e.pacInfo.meta.userData.textureSetting,c),c._mipmaps=[d],c._uuid=o,s.addInstance(d),s.addInstance(c),i.spriteFrameInfos&&i.spriteFrameInfos.forEach(e=>{const r=generateSpriteFrame(e,c);delete t.imageTaskMap[e.uuid.replace(/@.+/,"")],a.spriteFrames[e.name]=EditorExtends.serialize.asAsset(r._uuid),s.addInstance(r)});for(const d of t.bundles){const c=d.assetsWithoutRedirect,p=new Set(c);if(!p.has(e.pacInfo.asset.uuid)&&!e.pacInfo.spriteFrames.find(e=>p.has(e._uuid)))continue;const l=d.atlasRes;l.atlasToImages[a._uuid]=[];const m=[],_=[];for(const e of c){const t=s.getAssetInfo(e);if(!t||"cc.SpriteFrame"===t.type||"cc.Texture2D"===t.type)continue;const a=await s.getDependUuids(t.uuid);for(const e of a)s.getAssetInfo(e)?e.endsWith("@6c48a")?m.push(e):"cc.Image"===s.getAssetInfo(e).type&&_.push(e):console.error(Editor.I18n.t("builder.error.required_asset_missing"),{uuid:e,fatherUrl:t.url})}d.addAssetWithUuid(u),d.addAssetWithUuid(o),d.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?d.groups[0].uuids.push(u,o):d.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&d.addGroup("NORMAL",[u,o]);const f=path_1.join(d.dest,d.nativeBase,u.slice(0,2),u+path_1.extname(i.imagePath));fs_extra_1.copySync(i.imagePath,f),r&&(t.imageTaskMap[u]?t.imageTaskMap[u].dest.push(f):t.imageTaskMap[u]={src:i.imagePath,dest:[f],hasAlpha:!0,presetId:n,mtime:e.mtimeMd5});const h=e.pacInfo.asset.url.startsWith(d.root+"/"),g=p.has(a._uuid);for(const e of i.spriteFrameInfos)d.getRedirect(e.uuid)||(g||p.has(e.uuid))&&(d.addAssetWithUuid(e.uuid),d.removeFromGroups(e.uuid),m.includes(e.textureUuid)||_.includes(e.imageUuid)||h||(console.debug(`${e.uuid}, spriteAtlas: ${a._uuid}, image: ${u}, bundle:${d.name}`),d.removeAsset(e.imageUuid),d.removeAsset(e.textureUuid)),m.includes(e.textureUuid)&&console.warn(Editor.I18n.t("builder.tips.use_texture_in_atlas",{info:`{asset(${e.textureUuid})}`})),_.includes(e.imageUuid)&&console.warn(Editor.I18n.t("builder.tips.use_image_in_atlas",{info:`{asset(${e.imageUuid})}`})),d.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?d.groups[0].uuids.push(e.uuid):d.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&d.groups[d.groups.length-1].uuids.push(e.uuid),l.assetsToImage[e.uuid]=u,l.assetsToImage[e.imageUuid]=u);l.imageToAtlas[u]=a._uuid,l.assetsToImage[o]=u,l.atlasToImages[a._uuid].push(u)}}})),console.groupEnd()}function applyTextureBaseAssetUserData(e,t){e=e||{wrapModeS:"repeat",wrapModeT:"repeat",minfilter:"nearest",magfilter:"linear",mipfilter:"none",anisotropy:1};const s=e=>{switch(e){case"clamp-to-edge":return cc.TextureBase.WrapMode.CLAMP_TO_EDGE;case"repeat":return cc.TextureBase.WrapMode.REPEAT;case"mirrored-repeat":return cc.TextureBase.WrapMode.MIRRORED_REPEAT}},a=e=>{switch(e){case"nearest":return cc.TextureBase.Filter.NEAREST;case"linear":return cc.TextureBase.Filter.LINEAR;case"none":return cc.TextureBase.Filter.NONE}};t.setWrapMode(s(e.wrapModeS),s(e.wrapModeT)),t.setFilters(a(e.minfilter),a(e.magfilter)),t.setMipFilter(a(e.mipfilter)),t.setAnisotropy(e.anisotropy)}function generateSpriteFrame(e,t){const s=new cc.SpriteFrame,a=e.spriteFrame;s._name=e.name,s._uuid=a._uuid,s.texture=t;const r=e.trim;return s._rect=cc.rect(r.x,r.y,r.width,r.height),s._offset=a.getOffset(),s._originalSize=cc.size(e.rawWidth,e.rawHeight),s._rotated=e.rotated,s._capInsets=[a.insetLeft,a.insetTop,a.insetRight,a.insetBottom],s}exports.title="i18n:tasks.build_atlas",exports.name="build-task/image",exports.handle=handle;