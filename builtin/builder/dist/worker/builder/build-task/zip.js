"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),JsZip=require("jszip");async function handle(e,t,s){for(const e of t.bundles){if(e.compressionType!==bundle_utils_1.BundleCompressionTypes.ZIP)continue;const t=e.dest,s=[(0,path_1.join)(t,e.nativeBase),(0,path_1.join)(t,e.importBase)].filter(e=>(0,fs_extra_1.existsSync)(e));s.length>0&&(e.isZip=!0,await compressDirs(s,t,(0,path_1.join)(t,Build.BUNDLE_ZIP_NAME)))}}async function compressDirs(e,t,s){await new Promise(r=>{const i=new JsZip,n=[],o=(0,path_1.parse)(Build.BUNDLE_ZIP_NAME).name;e.forEach(e=>{getFilesInDirectory(n,e)});const a={date:new Date("2021.06.21 06:00:00Z"),createFolders:!1};n.forEach(e=>{const s=(0,path_1.relative)(t,e);let r=(0,path_1.join)(o,s);r=r.replace(/\\/g,"/"),i.file(r,(0,fs_extra_1.readFileSync)(e),a)}),i.generateAsync({type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}}).then(t=>{(0,fs_extra_1.writeFileSync)(s,t),e.forEach(e=>{(0,fs_extra_1.removeSync)(e)}),r()})})}function getFilesInDirectory(e,t){(0,fs_extra_1.readdirSync)(t).forEach(s=>{const r=(0,path_1.join)(t,s);(0,fs_extra_1.statSync)(r).isDirectory()?getFilesInDirectory(e,r):e.push(r)})}exports.title="i18n:builder.tasks.build_zip_bundle",exports.handle=handle;