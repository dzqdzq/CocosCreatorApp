"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),JsZip=require("jszip");async function handle(e,t,s){for(const e of t.bundles){if(e.compressionType!==bundle_utils_1.BundleCompressionTypes.ZIP)continue;let t=e.dest,s=[path_1.join(t,e.nativeBase),path_1.join(t,e.importBase)].filter(e=>fs_extra_1.existsSync(e));s.length>0&&(e.isZip=!0,await compressDirs(s,t,path_1.join(t,Build.BUNDLE_ZIP_NAME)))}}async function compressDirs(e,t,s){await new Promise(i=>{const r=new JsZip,n=[],o=path_1.parse(Build.BUNDLE_ZIP_NAME).name;e.forEach(e=>{getFilesInDirectory(n,e)}),n.forEach(e=>{const s=path_1.relative(t,e);let i=path_1.join(o,s);i=i.replace(/\\/g,"/"),r.file(i,fs_extra_1.readFileSync(e))}),r.generateAsync({type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}}).then(t=>{fs_extra_1.writeFileSync(s,t),e.forEach(e=>{fs_extra_1.removeSync(e)}),i()})})}function getFilesInDirectory(e,t){fs_extra_1.readdirSync(t).forEach(s=>{const i=path_1.join(t,s);fs_extra_1.statSync(i).isDirectory()?getFilesInDirectory(e,i):e.push(i)})}exports.title="i18n:tasks.build_zip_bundle",exports.handle=handle;