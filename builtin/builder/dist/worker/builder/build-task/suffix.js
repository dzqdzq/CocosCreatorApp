"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../utils"),Globby=require("globby");async function handle(t,e,s){if(!t.md5Cache)return;let i=0;for(const t of e.bundles)if(t.isZip){const e=path_1.join(t.dest,Build.BUNDLE_ZIP_NAME);if(fs_extra_1.existsSync(e)){const s=await Build.Utils.appendMd5ToPaths([e]);s&&(t.zipVer=s.hash)}}else{const e={native:{},import:{}},s=[],a=Globby.sync(path_1.join(t.dest,t.importBase,"**"),{nodir:!0});for(let t=0;t<a.length;t++){const s=a[t],i=utils_1.getUuidFromPath(s);e.import[i]||(e.import[i]=[]),e.import[i].push(s)}const n=Globby.sync(path_1.join(t.dest,t.nativeBase,"**"),{nodir:!0});for(let t=0;t<n.length;t++){const i=n[t],a=utils_1.getUuidFromPath(i);e.native[a]||(e.native[a]=[]),path_1.basename(path_1.dirname(i))!==a?e.native[a].push(i):s.push(i)}t.assetVer.import={},t.assetVer.native={};for(const s in e.import){const i=await Build.Utils.appendMd5ToPaths(e.import[s]);i&&(t.assetVer.import[s]=i.hash)}for(const s in e.native){const a=await Build.Utils.appendMd5ToPaths(e.native[s]);a&&(t.assetVer.native[s]=a.hash,i++)}for(let e=0;e<s.length;e++){const i=s[e];try{const e=Build.Utils.calcMd5(fs_extra_1.readFileSync(i)),s=Build.Utils.getUuidFromPath(i);fs_extra_1.renameSync(path_1.dirname(i),path_1.dirname(i)+`.${e}`),t.assetVer.native[s]=e}catch(t){console.error(t)}}}e.pluginVers={};for(const t of e.plugins){const a=s.getAssetInfo(t),n=utils_1.removeDbHeader(a.url),o=path_1.join(e.paths.dir,"src",n),r=await Build.Utils.appendMd5ToPaths([o]);r&&(i++,e.pluginVers[a.uuid]=r.hash)}console.debug(`add suffix to assets(${i}) success!`)}exports.title="i18n:tasks.build_suffix",exports.name="build-task/suffix",exports.handle=handle;