"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../utils"),Globby=require("globby");async function handle(t,s,a){if(!t.md5Cache)return;let i=0;for(const t of s.bundles)if(t.isZip){const s=(0,path_1.join)(t.dest,Build.BUNDLE_ZIP_NAME);if((0,fs_extra_1.existsSync)(s)){const a=await Build.Utils.appendMd5ToPaths([s]);a&&(t.zipVer=a.hash)}}else{const s={native:{},import:{}},a=[],e=Globby.sync((0,path_1.join)(t.dest,t.importBase,"**"),{nodir:!0});for(let t=0;t<e.length;t++){const a=e[t],i=(0,utils_1.getUuidFromPath)(a);s.import[i]||(s.import[i]=[]),s.import[i].push(a)}const o=Globby.sync((0,path_1.join)(t.dest,t.nativeBase,"**"),{nodir:!0});for(let t=0;t<o.length;t++){const i=o[t],e=(0,utils_1.getUuidFromPath)(i);s.native[e]||(s.native[e]=[]),(0,path_1.basename)((0,path_1.dirname)(i))!==e?s.native[e].push(i):a.push(i)}t.assetVer.import={},t.assetVer.native={};for(const a in s.import){const i=await Build.Utils.appendMd5ToPaths(s.import[a]);i&&(t.assetVer.import[a]=i.hash)}for(const a in s.native){const e=await Build.Utils.appendMd5ToPaths(s.native[a]);e&&(t.assetVer.native[a]=e.hash,i++)}for(let s=0;s<a.length;s++){const i=a[s];try{const s=Build.Utils.calcMd5((0,fs_extra_1.readFileSync)(i)),a=Build.Utils.getUuidFromPath(i);(0,fs_extra_1.renameSync)((0,path_1.dirname)(i),(0,path_1.dirname)(i)+`.${s}`),t.assetVer.native[a]=s}catch(t){console.error(t)}}}s.pluginVers={};for(const t of s.plugins){const e=a.getAssetInfo(t),o=(0,utils_1.removeDbHeader)(e.url),p=(0,path_1.join)(s.paths.dir,"src",o),r=await Build.Utils.appendMd5ToPaths([p]);r&&(i++,s.pluginVers[e.uuid]=r.hash)}for(const t of Object.keys(s.importMap.imports)){const a=(0,path_1.dirname)(s.paths.importMap),i=s.importMap.imports[t];if(!i.startsWith("."))continue;const e=(0,path_1.join)(a,i),o=await Build.Utils.appendMd5ToPaths([e]);o&&(s.importMap.imports[t]=`./${Build.Utils.relativeUrl(a,o.paths[0])}`)}s.paths.importMap=Build.Utils.patchMd5ToPath(s.paths.importMap,Build.Utils.calcMd5(JSON.stringify(s.importMap))),s.paths.polyfillsJs&&(s.paths.polyfillsJs=(await Build.Utils.appendMd5ToPaths([s.paths.polyfillsJs])).paths[0]),s.paths.systemJs&&(s.paths.systemJs=(await Build.Utils.appendMd5ToPaths([s.paths.systemJs])).paths[0]);for(let t=0;t<s.scriptPackages.length;t++){const a=s.scriptPackages[t],i=await Build.Utils.appendMd5ToPaths([a]);i&&(s.scriptPackages[t]=i.paths[0])}console.debug(`add suffix to assets(${i}) success!`)}exports.title="i18n:builder.tasks.build_suffix",exports.name="build-task/suffix",exports.handle=handle;