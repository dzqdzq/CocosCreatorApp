"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../utils"),Globby=require("globby");async function handle(t,s,a){if(!t.md5Cache)return;let i=0;for(const t of s.bundles)if(t.isZip){const s=path_1.join(t.dest,Build.BUNDLE_ZIP_NAME);if(fs_extra_1.existsSync(s)){const a=await Build.Utils.appendMd5ToPaths([s]);a&&(t.zipVer=a.hash)}}else{const s={native:{},import:{}},a=[],e=Globby.sync(path_1.join(t.dest,t.importBase,"**"),{nodir:!0});for(let t=0;t<e.length;t++){const a=e[t],i=utils_1.getUuidFromPath(a);s.import[i]||(s.import[i]=[]),s.import[i].push(a)}const p=Globby.sync(path_1.join(t.dest,t.nativeBase,"**"),{nodir:!0});for(let t=0;t<p.length;t++){const i=p[t],e=utils_1.getUuidFromPath(i);s.native[e]||(s.native[e]=[]),path_1.basename(path_1.dirname(i))!==e?s.native[e].push(i):a.push(i)}t.assetVer.import={},t.assetVer.native={};for(const a in s.import){const i=await Build.Utils.appendMd5ToPaths(s.import[a]);i&&(t.assetVer.import[a]=i.hash)}for(const a in s.native){const e=await Build.Utils.appendMd5ToPaths(s.native[a]);e&&(t.assetVer.native[a]=e.hash,i++)}for(let s=0;s<a.length;s++){const i=a[s];try{const s=Build.Utils.calcMd5(fs_extra_1.readFileSync(i)),a=Build.Utils.getUuidFromPath(i);fs_extra_1.renameSync(path_1.dirname(i),path_1.dirname(i)+`.${s}`),t.assetVer.native[a]=s}catch(t){console.error(t)}}}s.pluginVers={};for(const t of s.plugins){const e=a.getAssetInfo(t),p=utils_1.removeDbHeader(e.url),o=path_1.join(s.paths.dir,"src",p),r=await Build.Utils.appendMd5ToPaths([o]);r&&(i++,s.pluginVers[e.uuid]=r.hash)}for(const t of Object.keys(s.importMap.imports)){const a=path_1.dirname(s.paths.importMap),i=path_1.join(a,s.importMap.imports[t]),e=await Build.Utils.appendMd5ToPaths([i]);e&&(s.importMap.imports[t]=`./${Build.Utils.relativeUrl(a,e.paths[0])}`)}s.paths.importMap=Build.Utils.patchMd5ToPath(s.paths.importMap,Build.Utils.calcMd5(JSON.stringify(s.importMap))),s.paths.polyfillsJs&&(s.paths.polyfillsJs=(await Build.Utils.appendMd5ToPaths([s.paths.polyfillsJs])).paths[0]),s.paths.systemJs&&(s.paths.systemJs=(await Build.Utils.appendMd5ToPaths([s.paths.systemJs])).paths[0]);for(let t=0;t<s.scriptPackages.length;t++){const a=path_1.join(path_1.dirname(s.paths.applicationJS),s.scriptPackages[t]),i=await Build.Utils.appendMd5ToPaths([a]);i&&(s.scriptPackages[t]=`./${Build.Utils.relativeUrl(path_1.dirname(s.paths.applicationJS),i.paths[0])}`)}console.debug(`add suffix to assets(${i}) success!`)}exports.title="i18n:tasks.build_suffix",exports.name="build-task/suffix",exports.handle=handle;