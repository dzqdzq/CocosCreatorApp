"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),cconb_1=require("./cconb"),LIBRARY_NAME="library";async function handle(e,s,t){for(const r of s.bundles)console.group(`Handle bundle ${r.name}`),await Promise.all(r.assetsWithoutRedirect.map(o=>{if(o.length<=15||s.compressImageResult[o])return Promise.resolve();const n=t.getAssetInfo(o);return"cc.Mesh"===n.type&&t.__addStaticsInfo({dimension:2}),copyAssetFile(n,r,e)})),console.debug(`Asset Bundle(${r.name}) handle assets: ${r.assets.length}`),console.groupEnd()}function copyAssetFile(e,s,t){return Promise.all(Object.keys(e.library).map(r=>{if(".json"===r)return Promise.resolve();if(r.startsWith("__"))return Promise.resolve();const o=".cconb"===r,n=path_1.join(s.dest,o?s.importBase:s.nativeBase),i=e.library[r],a=path_1.relative(path_1.join(Editor.Project.path,LIBRARY_NAME),i);if(!fs_extra_1.existsSync(i))return console.error(Editor.I18n.t("builder.error.missing_import_files",{path:`{link(${i})}`,url:`{asset(${e.url})}`})),Promise.resolve();const l=path_1.join(path_1.join(n,a));return".cconb"===r?cconb_1.exportCCONB(e,{debug:t.debug,dest:l,exportCCON:t.assetSerializeOptions&&t.assetSerializeOptions.exportCCON,allowCCONExtension:t.assetSerializeOptions.allowCCONExtension}):fs_extra_1.existsSync(l)?Promise.resolve():fs_extra_1.copy(i,l)}))}exports.title="i18n:tasks.build_asset",exports.handle=handle;