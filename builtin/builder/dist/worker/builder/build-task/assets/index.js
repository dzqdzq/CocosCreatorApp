"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),cconb_1=require("./cconb"),LIBRARY_NAME="library";async function handle(e,s,t){for(const r of s.bundles)console.group(`Handle bundle ${r.name}`),await Promise.all(r.assetsWithoutRedirect.map(o=>{if(o.length<=15||s.compressImageResult[o])return Promise.resolve();const i=t.getAssetInfo(o);if(i)return"cc.Mesh"===i.type&&t.__addStaticsInfo({dimension:2}),copyAssetFile(i,r,e);console.error(`Can not get asset info with uuid(${o})`)})),console.debug(`Asset Bundle(${r.name}) handle assets: ${r.assets.length}`),console.groupEnd()}function copyAssetFile(e,s,t){return Promise.all(Object.keys(e.library).map(r=>{if(".json"===r)return Promise.resolve();if(r.startsWith("__"))return Promise.resolve();const o=".cconb"===r,i=(0,path_1.join)(s.dest,o?s.importBase:s.nativeBase),n=e.library[r],a=(0,path_1.relative)((0,path_1.join)(Editor.Project.path,LIBRARY_NAME),n);if(!(0,fs_extra_1.existsSync)(n))return console.error(Editor.I18n.t("builder.error.missing_import_files",{path:`{link(${n})}`,url:`{asset(${e.url})}`})),Promise.resolve();const l=(0,path_1.join)((0,path_1.join)(i,a));return".cconb"===r?(0,cconb_1.exportCCONB)(e,{debug:t.debug,dest:l,exportCCON:t.assetSerializeOptions&&t.assetSerializeOptions.exportCCON,allowCCONExtension:t.assetSerializeOptions.allowCCONExtension}):(0,fs_extra_1.existsSync)(l)?Promise.resolve():(0,fs_extra_1.copy)(n,l)}))}exports.title="i18n:builder.tasks.build_asset",exports.handle=handle;