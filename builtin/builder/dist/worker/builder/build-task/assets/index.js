"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),metric_1=require("../../metric"),cconb_1=require("./cconb"),LIBRARY_NAME="library";async function handle(e,t,s){const r=new Set,i={};for(const a of t.bundles)console.group(`Handle bundle ${a.name}`),await Promise.all(a.assetsWithoutRedirect.map(async n=>{if(n.length<=15||t.compressImageResult[n])return Promise.resolve();const o=s.getAssetInfo(n);if(o)return"cc.Mesh"===o.type&&s.__addStaticsInfo({dimension:2}),await(0,metric_1.collectMetricFromAsset)(o,i,s),r.has(n)||(r.add(n),await checkEffectTextureMipmap(s,o,n)),copyAssetFile(o,a,e);console.error(`Can not get asset info with uuid(${n})`)})),console.debug(`Asset Bundle(${a.name}) handle assets: ${a.assets.length}`),console.groupEnd();Object.assign(this.staticsInfo.extras,i),r.clear()}async function checkEffectTextureMipmap(e,t,s){try{if("cc.Material"===t.type){const t=await e.getInstance(s);if(t.effectAsset&&t.effectAsset._uuid){const s=await e.getInstance(t.effectAsset._uuid);s.techniques[t._techIdx].passes.forEach(async(r,i)=>{if(r.properties&&r.properties.mainTexture&&r.properties.mainTexture.requireMipmaps){const r=t._props&&t._props[i];if(r.mainTexture&&r.mainTexture._uuid){const t=await e.getMeta(r.mainTexture._uuid);["nearest","linear"].includes(t.userData.mipfilter)||console.warn(Editor.I18n.t("builder.warn.requireMipmaps",{effectUUID:s._uuid,textureUUID:r.mainTexture._uuid}))}}})}}}catch(e){console.debug(e)}}function copyAssetFile(e,t,s){return Promise.all(Object.keys(e.library).map(r=>{if(".json"===r)return Promise.resolve();if(r.startsWith("__"))return Promise.resolve();const i=".cconb"===r,a=(0,path_1.join)(t.dest,i?t.importBase:t.nativeBase),n=e.library[r],o=(0,path_1.relative)((0,path_1.join)(Editor.Project.path,LIBRARY_NAME),n);if(!(0,fs_extra_1.existsSync)(n))return console.error(Editor.I18n.t("builder.error.missing_import_files",{path:`{link(${n})}`,url:`{asset(${e.url})}`})),Promise.resolve();const c=(0,path_1.join)((0,path_1.join)(a,o));return".cconb"===r?(0,cconb_1.exportCCONB)(e,{debug:s.debug,dest:c,exportCCON:s.assetSerializeOptions&&s.assetSerializeOptions.exportCCON,allowCCONExtension:s.assetSerializeOptions.allowCCONExtension}):(0,fs_extra_1.existsSync)(c)?Promise.resolve():(0,fs_extra_1.copy)(n,c)}))}exports.title="i18n:builder.tasks.build_asset",exports.handle=handle;