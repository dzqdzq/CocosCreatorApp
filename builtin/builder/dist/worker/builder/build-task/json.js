"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const HashUuid=require("../utils/hash-uuid"),fs_extra_1=require("fs-extra"),path_1=require("path");async function handle(e,s,t){console.group("Build Json");for(const a of s.bundles){const s=path_1.join(a.dest,a.importBase);console.group(`Handle all json groups in bundle ${a.name}`);let i=[];const u=[];a.groups.forEach(e=>{i=i.concat(e.uuids),u.push(e.uuids)});const r=new Set(i),l=HashUuid.calculate(u,HashUuid.BuiltinHashType.PackedAssets);console.group("handle json group");for(let i=0;i<a.groups.length;i++){const u=a.groups[i];if(0===u.uuids.length)continue;if(1===u.uuids.length)continue;if(u.name=l[i],u.uuids.sort((e,s)=>e.localeCompare(s,"en",{numeric:!0})),a.addAssetWithUuid(u.name),r.add(u.name),"TEXTURE"===u.type){await o(s,l[i],u);continue}if("NORMAL"!==u.type)continue;let d=[];const c=[];u.uuids.sort();for(let s=0;s<u.uuids.length;s++){const o=await t.getSerializedJSON(u.uuids[s],e);o?(c.push(u.uuids[s]),d.push(o)):console.error(`Get Serialized JSON of {asset(${u.uuids[s]})} failed!`)}u.uuids=c,d=JSON.parse(JSON.stringify(d)),d=EditorExtends.serializeCompiled.packJSONs(d),await n(s,l[i],d),console.debug(`Json group(${exports.name}) compile successï¼Œjson number: ${d.length}`)}console.groupEnd(),console.group("handle single json");for(const o of a.assetsWithoutRedirect){if(r.has(o))continue;const a=await t.getSerializedJSON(o,e),i=t.getAssetInfo(o);let u=o;i&&i.library&&i.library[".json"]&&(u=path_1.basename(i.library[".json"],".json")),await n(s,u,a)}console.groupEnd(),a.groups.forEach(e=>{e.name&&a.addAssetWithUuid(e.name)}),console.groupEnd()}async function o(s,o,a){const i=(await Promise.all(a.uuids.map(async s=>{const o=await t.getSerializedJSON(s,e);return o||console.error(`Can't get SerializedJSON of asset {asset(${s})}`),o}))).map(e=>{const{base:s,mipmaps:t}=EditorExtends.serializeCompiled.getRootData(e);return[s,t]}),u={type:cc.js._getClassId(cc.Texture2D),data:i};await n(s,o,u)}async function n(e,s,t){const o=path_1.join(e,s.substr(0,2),s+".json");await fs_extra_1.outputJSON(o,t)}console.groupEnd()}exports.title="i18n:tasks.build_json",exports.name="build-task/json",exports.handle=handle;