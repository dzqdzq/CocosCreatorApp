"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const HashUuid=require("../utils/hash-uuid"),fs_extra_1=require("fs-extra"),path_1=require("path");async function handle(e,s,t){console.group("Build Json");for(const i of s.bundles){const s=path_1.join(i.dest,i.importBase);console.group(`Handle all json groups in bundle ${i.name}`);let r=[];const u=[];i.groups.forEach(e=>{u.push(e.uuids),e.uuids.length<=1||(r=r.concat(e.uuids))});const l=new Set(r),c=HashUuid.calculate(u,HashUuid.BuiltinHashType.PackedAssets);console.group("handle json group");for(let r=0;r<i.groups.length;r++){const u=i.groups[r];if(u.uuids.length<=1)continue;if(u.name=c[r],u.uuids.sort((e,s)=>e.localeCompare(s,"en",{numeric:!0})),i.addAssetWithUuid(u.name),l.add(u.name),"TEXTURE"===u.type){await a(s,c[r],u);continue}if("IMAGE"===u.type){await o(s,c[r],u);continue}if("NORMAL"!==u.type)continue;let d=[];const p=[];u.uuids.sort();for(let s=0;s<u.uuids.length;s++){const o=await t.getSerializedJSON(u.uuids[s],e);o?(p.push(u.uuids[s]),d.push(o)):console.error(`Get Serialized JSON of {asset(${u.uuids[s]})} failed!`)}u.uuids=p,d=JSON.parse(JSON.stringify(d)),d=EditorExtends.serializeCompiled.packJSONs(d),await n(s,c[r],d),console.debug(`Json group(${exports.name}) compile successï¼Œjson number: ${d.length}`)}console.groupEnd(),console.group("handle single json");for(const o of i.assetsWithoutRedirect){if(l.has(o))continue;const a=await t.getSerializedJSON(o,e),i=t.getAssetInfo(o);let r=o;i&&i.library&&i.library[".json"]&&(r=path_1.basename(i.library[".json"],".json")),await n(s,r,a)}console.groupEnd(),i.groups.forEach(e=>{e.name&&i.addAssetWithUuid(e.name)}),console.groupEnd()}async function o(s,o,a){const i=await Promise.all(a.uuids.map(async s=>{const o=await t.getSerializedJSON(s,e);return o||console.error(`Can't get SerializedJSON of asset {asset(${s})}`),o})),r={type:cc.js._getClassId(cc.ImageAsset),data:i};await n(s,o,r)}async function a(s,o,a){const i=(await Promise.all(a.uuids.map(async s=>{const o=await t.getSerializedJSON(s,e);return o||console.error(`Can't get SerializedJSON of asset {asset(${s})}`),o}))).map(e=>{const{base:s,mipmaps:t}=EditorExtends.serializeCompiled.getRootData(e);return[s,t]}),r={type:cc.js._getClassId(cc.Texture2D),data:i};await n(s,o,r)}async function n(e,s,t){const o=path_1.join(e,s.substr(0,2),s+".json");await fs_extra_1.outputJSON(o,t)}console.groupEnd()}exports.title="i18n:tasks.build_json",exports.name="build-task/json",exports.handle=handle;