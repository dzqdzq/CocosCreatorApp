"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const texture_compress_1=require("./texture-compress"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=require("../../../plugin"),utils_1=require("./utils"),Lodash=require("lodash"),compressCacheDir=(0,path_1.join)(Editor.Project.path,"temp","builder","CompressTexture");async function handle(e,t,s){if(e.skipCompressTexture)return console.debug("skip compress texture");if(0===Object.keys(t.imageTaskMap).length)return;const{platformConfig:r,formatsInfo:o}=await Editor.Message.request("builder","query-compress-config");if(!r[e.platform])return;console.group("Compress image...");const a=await sortImageCompressQueue(t.imageTaskMap,e.platform,t);if(!a)return;const{compressQueueMap:i,suffixMap:n,storedCompressInfo:c}=a;if(Object.keys(i).length){const e=plugin_1.pluginManager.getAssetHandlers("compressTextures");if(e.pkgNameOrder.length){Editor.Metrics.trackTimeStart("builder:custom-compress-texture");const t=JSON.parse(JSON.stringify(i));await customCompressImage(t,e),Object.assign(i,t),await Editor.Metrics.trackTimeEnd("builder:custom-compress-texture",{output:!0})}Editor.Metrics.trackTimeStart("builder:compress-texture"),await Promise.all(Object.keys(i).map(e=>(0,texture_compress_1.compressImageList)(i[e]))),await Editor.Metrics.trackTimeEnd("builder:compress-texture",{output:!0})}let u=0;for(const e of Object.keys(n)){const r=await s.getInstance(e),o=addSuffixToAsset(c[e].dest,t.imageTaskMap[e].dest,n[e],r);t.imageTaskMap[e].bundleNames.forEach(s=>{t.bundleMap[s].compressRes[e]=o}),t.compressImageResult[e]={files:o,formats:n[e]},s.addInstance(r),u++}console.groupEnd(),console.debug(`Num of sorted image asset: ${u}`)}async function customCompressImage(e,t){for(let s=0;s<t.pkgNameOrder.length;s++){const r=t.pkgNameOrder[s],o=t.handles[r];if(o)try{console.debug(`Start custom compress(${r})`),await Promise.all(Object.keys(e).map(t=>{const s=e[t];return o(s)}))}catch(e){console.error(e),console.error(`Custom Compress (${r}) failed!`)}}}async function sortImageCompressQueue(e,t,s){const{userPreset:r,defaultConfig:o,customConfigs:a}=await Editor.Profile.getProject("builder","textureCompressConfig"),{platformConfig:i,customFormats:n,formatsInfo:c,textureFormatConfigs:u}=await Editor.Message.request("builder","query-compress-config");let m={};const p=(0,path_1.join)(compressCacheDir,"compress-info.json");(0,fs_extra_1.existsSync)(p)&&(m=(0,fs_extra_1.readJsonSync)(p));const f=i[t].textureCompressConfig;let l="unknown",d={rgb:[],rgba:[]};f&&(l=f.platformType,d=f.support);const g={},h={},x={};a&&Object.values(a).length&&Object.values(a).forEach(e=>{e.overwrite&&(x[e.format]=e.id,console.debug(`compress format (${e.format}) will be overwrited by custom compress ${e.id}(${e.name})`))});for(const t of Object.keys(e)){const i=e[t],{presetId:p,hasAlpha:f,src:b}=i,_=r[p]||o[p]||o.default;if(!_||!_.options[l]){console.debug(`Invalid compress task: ${JSON.stringify(_)}`);continue}i.dest=i.dest.map((e,t)=>{const r=s.bundleMap[i.bundleNames[t]],o=(0,path_1.join)(r.dest,r.nativeBase),a=(0,path_1.join)(o,e);return(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(a)),a});const y=i.dest,C={};if(Object.keys(_.options[l]).forEach(e=>{([...d.rgba,...d.rgb].includes(e)||Object.keys(n).includes(e))&&(C[e]=JSON.parse(JSON.stringify(_.options[l][e])))}),checkCompressOption(C,f,t),0===Object.keys(C).length)continue;try{await Promise.all(i.dest.map(async e=>{(0,fs_extra_1.existsSync)(e)&&await(0,fs_extra_1.remove)(e)}))}catch(e){console.error(e)}Object.keys(C).forEach(e=>{a[e]&&increaseCustomCompressNum(a[e])});const k=(0,path_1.extname)(y[0]),O=(0,path_1.join)(compressCacheDir,t.substr(0,2),t+k);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(O)),y.forEach(e=>{(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(e))}),Object.keys(x).forEach(e=>{C[e]&&(C[x[e]]=C[e],delete C[e],increaseCustomCompressNum(a[e]))});let E=[];const j={option:{mtime:i.mtime||await Editor.Message.request("asset-db","query-asset-mtime",t)||(new Date).getTime(),src:b,compressOption:C},suffix:E,dest:O};if(!!Lodash.isEqual(m[t]&&m[t].option,j.option)&&checkCacheImageExist(m[t].dest,m[t].suffix))E=m[t].suffix,console.debug(`Use cache compress image of {Asset(${t})} ({link(${O})}). suffix: ${E}`);else{console.debug(`Get cache compress image failed with ${JSON.stringify(j)}`);const e=Object.keys(C);e.forEach(e=>{const s=c[e].formatType;g[s]||(g[s]=[]),g[s].push({format:e,src:b,dest:(0,utils_1.changeSuffix)(O,u[c[e].formatType].suffix),compressOptions:C[e],customConfig:a[e],uuid:t})}),E=e.map(e=>(0,utils_1.getSuffix)(c[e],u[c[e].formatType].suffix))}h[t]=E,j.suffix=E,m[t]=j}return(0,fs_extra_1.outputJSONSync)(p,m),collectCustomCompressInfo(a),{compressQueueMap:g,suffixMap:h,storedCompressInfo:m}}function collectCustomCompressInfo(e){Object.values(e).map(e=>{if(!e.num)return;const t={format:e.format,overwrite:e.overwrite,value:e.num,file:(0,path_1.basename)(e.path),command:e.command};Editor.Metrics.trackEvent({category:"Build",action:"custom-compress",label:(0,utils_1.changeInfoToLabel)(t)})})}function increaseCustomCompressNum(e){e&&(e.num||(e.num=0),e.num++)}function addSuffixToAsset(e,t,s,r){const o=[],a=(0,path_1.extname)(t[0]);if(s&&s.length>0){const i=(0,path_1.extname)(e),n=[];for(const r of s){const s=r.replace(/@.*/,""),c=e.replace(i,s);(0,fs_extra_1.existsSync)(c)?(t.forEach(e=>{o.push(e.replace(a,s)),(0,fs_extra_1.copyFileSync)(c,e.replace(a,s))}),n.push(r)):console.error(Editor.I18n.t("builder.error.cache_compress_texture_missing",{format:r,path:`{link(${c})}`}))}r._exportedExts=n}else r._exportedExts=[a];return o}function checkCacheImageExist(e,t){for(let s of t){s=s.replace(/@.*/,"");const t=e.replace((0,path_1.extname)(e),s);if(!(0,fs_extra_1.existsSync)(t))return!1}return!0}function checkCompressOption(e,t,s){const r=Object.keys(e).filter(e=>e.startsWith("etc")),o=Object.keys(e).filter(e=>e.startsWith("pvr"));if(r.length>1){r.filter(e=>t?e.endsWith("rgb"):!e.endsWith("rgb")).forEach(t=>delete e[t])}if(o.length>1){o.filter(e=>t?e.endsWith("rgb"):!e.endsWith("rgb")).forEach(t=>delete e[t])}else!t&&o[0]&&o[0].endsWith("rgb_a")&&(delete e[o[0]],console.warn(Editor.I18n.t("builder.warn.compress_rgb_a",{uuid:`{asset(${s})}`})))}exports.title="i18n:builder.tasks.build_img",exports.handle=handle;