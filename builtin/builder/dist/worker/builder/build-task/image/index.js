"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const texture_compress_1=require("./texture-compress"),path_1=require("path"),fs_extra_1=require("fs-extra"),Editor=__importStar(require("editor")),Lodash=require("lodash"),compressCacheDir=path_1.join(Editor.Project.path,"temp","builder","CompressTexture");async function handle(e,t,s){if(!e.compressTexture)return console.debug(`${Editor.I18n.t("builder.tasks.compress_img")} false`);if(0===Object.keys(t.imageTaskMap).length)return;const{platformConfig:r}=await Editor.Message.request("builder","query-compress-config");if(!r[e.platform])return;console.group("Compress image...");const o=await sortImageCompressQueue(t.imageTaskMap,e.platform);if(!o)return;const{compressQueueMap:i,suffixMap:n,storedCompressInfo:a}=o;Object.keys(i).length&&await Promise.all(Object.keys(i).map(e=>texture_compress_1.compressImageList(i[e])));let c=0;for(const e of Object.keys(n)){const r=await s.getInstance(e),o=addSuffixToAsset(a[e].dest,t.imageTaskMap[e].dest,n[e],r);t.compressImageResult[e]={files:o,formats:n[e]},s.addInstance(r),c++}console.groupEnd(),console.debug(`Num of sorted image asset: ${c}`)}async function sortImageCompressQueue(e,t){const{userPreset:s,defaultConfig:r}=await Editor.Profile.getProject("builder","textureCompressConfig"),{platformConfig:o}=await Editor.Message.request("builder","query-compress-config");let i={};const n=path_1.join(compressCacheDir,"compress-info.json");fs_extra_1.existsSync(n)&&(i=fs_extra_1.readJsonSync(n));const a=o[t].textureCompressConfig;let c="unknown",u={rgb:[],rgba:[]};a&&(c=a.platformType,u=a.support);const f={},p={};for(const t of Object.keys(e)){const o=e[t],{presetId:n,dest:a,hasAlpha:l,src:d}=o,m=s[n]||r[n]||r.default;if(!m||!m.options[c]){console.debug(`Invalid compress task: ${JSON.stringify(m)}`);continue}const _={};if(Object.keys(m.options[c]).forEach(e=>{[...u.rgba,...u.rgb].includes(e)&&(_[e]=JSON.parse(JSON.stringify(m.options[c][e])))}),checkCompressOption(_,l),0===Object.keys(_).length)continue;const h=path_1.extname(a[0]),g=path_1.join(compressCacheDir,t.substr(0,2),t+h);fs_extra_1.ensureDirSync(path_1.dirname(g)),a.forEach(e=>{fs_extra_1.ensureDirSync(path_1.dirname(e))});let x=[];const b={option:{mtime:o.mtime||await Editor.Message.request("asset-db","query-asset-mtime",t)||(new Date).getTime(),src:d,compressOption:_},suffix:x,dest:g};if(!!Lodash.isEqual(i[t]&&i[t].option,b.option)&&checkCacheImageExist(i[t].dest,i[t].suffix))x=i[t].suffix,console.debug(`Use cache compress image of {Asset(${t})} ({link(${g})}). suffix: ${x}`);else{const e=Object.keys(_);e.forEach(e=>{const t=e.slice(0,3);f[t]||(f[t]=[]),f[t].push({format:e,src:d,dest:g,quality:_[e]})}),x=texture_compress_1.getSuffix(e)}p[t]=x,b.suffix=x,i[t]=b}return fs_extra_1.outputJSONSync(n,i),{compressQueueMap:f,suffixMap:p,storedCompressInfo:i}}function addSuffixToAsset(e,t,s,r){const o=[],i=path_1.extname(t[0]);if(s&&s.length>0){const n=path_1.extname(e),a=[];for(const r of s){const s=r.replace(/@.*/,""),c=e.replace(n,s);fs_extra_1.existsSync(c)?(t.forEach(e=>{o.push(e.replace(i,s)),fs_extra_1.copyFileSync(c,e.replace(i,s))}),a.push(r)):console.error(Editor.I18n.t("builder.error.cache_compress_texture_missing",{format:r,path:`{link(${c})}`}))}a.includes(i)||a.push(i),r._exportedExts=a}else r._exportedExts=[i];return o}function checkCacheImageExist(e,t){for(let s of t){s=s.replace(/@.*/,"");const t=e.replace(path_1.extname(e),s);if(!fs_extra_1.existsSync(t))return!1}return!0}function checkCompressOption(e,t){const s=Object.keys(e).filter(e=>e.startsWith("etc")),r=Object.keys(e).filter(e=>e.startsWith("pvr"));if(s.length>1){s.filter(e=>t?e.endsWith("rgb"):!e.endsWith("rgb")).forEach(t=>delete e[t])}if(r.length>1){r.filter(e=>t?e.endsWith("rgb"):!e.endsWith("rgb")).forEach(t=>delete e[t])}else!t&&r[0]&&r[0].endsWith("rgb_a")&&delete e[r[0]]}exports.title="i18n:tasks.build_img",exports.handle=handle;