"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressMipmapFiles=exports.checkHasMipMaps=exports.genMipmapFiles=exports.getMipLevel=exports.isPowerOfTwo=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),Sharp=require("sharp");function isPowerOfTwo(e){return e>0&&0==(e&e-1)}function getMipLevel(e,t){let s=Math.max(e,t),a=0;for(;s;)s>>=1,a++;return a}async function genMipmapFiles(e,t,s){const a=Sharp(e),i=await a.metadata();if(!isPowerOfTwo(i.width)||!isPowerOfTwo(i.height))throw new Error(Editor.I18n.t("builder.project.texture_compress.mipmap.noPowerOfTwo"));let p=i.width,r=i.height;t=t||(0,path_1.dirname)(e);const o=(0,path_1.extname)(e),n=(0,path_1.basename)(e,o),m=[];for(let e=getMipLevel(p,r);e>0&&(1!==p||1!==r);e--){p=Math.max(p/2,1),r=Math.max(r/2,1);const s=(0,path_1.join)(t,"mipmaps",`${n}@mipmap_${e-1}${o}`);m.push(s),(0,fs_extra_1.existsSync)(s)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s)),await a.resize(p,r).toFile(s))}return m}function checkHasMipMaps(e){let t;return e.subMetas["6c48a"]?t=e.subMetas["6c48a"].userData.mipfilter:e.userData.textureSetting&&(t=e.userData.textureSetting.mipfilter),!!["nearest","linear"].includes(t)}async function compressMipmapFiles(e,t){if(!e.mipmapFiles||["png","jpg","webp"].includes(e.format))return[];console.debug(`Start merge mipmaps file of asset ${e.uuid}`);const s=[];for(let a=0;a<e.mipmapFiles.length;a++){const i=e.mipmapFiles[a],p=(0,path_1.join)((0,path_1.dirname)(e.dest),"mipmaps",(0,path_1.basename)(i,(0,path_1.extname)(i))+(0,path_1.extname)(e.dest));await t(Object.assign(Object.assign({},e),{src:i,dest:p})),s.push((0,fs_extra_1.readFileSync)(p))}return console.debug(`Merge mipmaps file of asset ${e.uuid} success`),s}exports.isPowerOfTwo=isPowerOfTwo,exports.getMipLevel=getMipLevel,exports.genMipmapFiles=genMipmapFiles,exports.checkHasMipMaps=checkHasMipMaps,exports.compressMipmapFiles=compressMipmapFiles;