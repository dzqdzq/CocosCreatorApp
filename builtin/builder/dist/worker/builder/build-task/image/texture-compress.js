"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressImageList=exports.getSuffix=void 0;const child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path"),{ensureDirSync:ensureDirSync,remove:remove}=require("fs-extra"),Path=require("path"),Sharp=require("sharp");function spawnTool(t,e,s){return new Promise((o,a)=>{let r=child_process_1.spawn(t,e,s);r.stdout.on("data",function(t){console.debug(t.toString())}),r.stderr.on("data",function(t){console.debug(t.toString())}),r.on("exit",function(){o()}),r.on("error",function(t){a(t)})})}function spawnToolSync(t,e,s){let o=child_process_1.spawnSync(t,e,s);return o.stdout.length>0&&o.stdout.toString().split("\n").forEach(t=>{console.log(t)}),o.stderr.length>0&&o.stderr.toString().split("\n").forEach(t=>{console.error(t)}),o.error}function changeSuffix(t,e){return Path.join(Path.dirname(t),Path.basename(t,Path.extname(t))+e)}function getSuffix(t){let e=cc.Texture2D.PixelFormat;const s={pvrtc_2bits_rgb:e.RGB_PVRTC_2BPPV1,pvrtc_2bits_rgba:e.RGBA_PVRTC_2BPPV1,pvrtc_2bits_rgb_a:e.RGB_A_PVRTC_2BPPV1,pvrtc_4bits_rgb:e.RGB_PVRTC_4BPPV1,pvrtc_4bits_rgba:e.RGBA_PVRTC_4BPPV1,pvrtc_4bits_rgb_a:e.RGB_A_PVRTC_4BPPV1,etc2_rgb:e.RGB_ETC2,etc2_rgba:e.RGBA_ETC2,etc1_rgb:e.RGB_ETC1,etc1_rgb_a:e.RGBA_ETC1,astc_4x4:e.RGBA_ASTC_4x4,astc_5x5:e.RGBA_ASTC_5x5,astc_6x6:e.RGBA_ASTC_6x6,astc_8x8:e.RGBA_ASTC_8x8,astc_10x5:e.RGBA_ASTC_10x5,astc_10x10:e.RGBA_ASTC_10x10,astc_12x12:e.RGBA_ASTC_12x12};return t.map(t=>t.startsWith("pvrtc_")?`.pvr@${s[t]}`:t.startsWith("etc")?`.pkm@${s[t]}`:t.startsWith("astc")?`.astc@${s[t]}`:"."+t)}async function compressJpgAndPng(t,e,s){return new Promise((o,a)=>{let r=Sharp(t);(r="png"===s.name?r.png({quality:s.quality||100}):r.jpeg({quality:s.quality||100})).toFile(changeSuffix(e,`.${s.name}`)).then(()=>{o()}).catch(t=>{a(t)})})}async function compressWebp(t,e,s){e=changeSuffix(e,".webp"),console.debug("start compress webp",t,e,s);let o=Path.join(Editor.App.path,"../tools/libwebp_darwin/bin/cwebp");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/libwebp_win32/bin/cwebp.exe"));let a=[t,"-o",e,"-q",s.quality,"-quiet"];console.debug(`webp compress command :  ${o} ${a.join(" ")}`),await spawnTool(o,a,{}),console.log("compress webp success "+`{link(${e})}`)}async function compressPVR(t,e,s){if(console.debug("start compress pvr",t,e,s),s.name.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t),s=Path.join(Editor.Project.path,"temp","CompressTexture","pvr_alpha",e);await createAlphaAtlas(t,s),t=s}let o=Path.join(Editor.App.path,"../tools/PVRTexTool_darwin/PVRTexToolCLI");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/PVRTexTool_win32/PVRTexToolCLI.exe"));let a={pvrtc_4bits_rgba:"PVRTC1_4",pvrtc_4bits_rgb:"PVRTC1_4_RGB",pvrtc_4bits_rgb_a:"PVRTC1_4_RGB",pvrtc_2bits_rgba:"PVRTC1_2",pvrtc_2bits_rgb:"PVRTC1_2_RGB",pvrtc_2bits_rgb_a:"PVRTC1_2_RGB"}[s.name],r=["-i",t,"-o",e=changeSuffix(e,".pvr"),"-squarecanvas","+","-potcanvas","+","-q","pvrtc"+s.quality,"-f",`${a},UBN,lRGB`];console.debug(`pvrtc compress command :  ${o} ${r.join(" ")}`),await spawnTool(o,r,{}),console.log("compress pvrtc success "+`{link(${e})}`)}async function compressEtc(t,e,s){if(console.debug("start compress etc",t,e,s),s.name.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t),s=Path.join(Editor.Project.path,"temp","CompressTexture","etc_alpha",e);await createAlphaAtlas(t,s),t=s}let o=Path.join(Editor.App.path,"../tools/mali_darwin/etcpack");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/mali_win32/etcpack.exe"));let a=Path.dirname(o);o="."+Path.sep+Path.basename(o);const{etcFormat:r,compressFormat:c}={etc1_rgb:{etcFormat:"etc1",compressFormat:"RGB"},etc1_rgb_a:{etcFormat:"etc1",compressFormat:"RGB"},etc2_rgba:{etcFormat:"etc2",compressFormat:"RGBA"},etc2_rgb:{etcFormat:"etc2",compressFormat:"RGB"}}[s.name];let n=[Path.normalize(t),Path.dirname(e),"-c",r,"-s",s.quality],i=a,p=Object.assign({},process.env);p.PATH=a+":"+p.PATH;let l={cwd:i,env:p};"etc2"===r&&n.push("-f",c),console.debug(`etc compress command :  ${o} ${n.join(" ")}`),await spawnTool(o,n,l),console.log("compress etc success "+`{link(${e})}`)}async function compressAstc(t,e,s){console.debug("start compress astc",t,e,s);const o=Path.relative(Editor.Project.path,t),a=Path.join(Editor.Project.tmpDir,"builder","CompressTexture","astc",o);await flipImage(t,a),t=a;let r=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc");"win32"===process.platform&&(r=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc.exe"));let c={astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[s.name],n=["-cl",t,e=changeSuffix(e,".astc"),c,s.quality];console.debug(`astc compressed command: ${Path.basename(r)} ${n.join(" ")}`),await spawnTool(r,n,{}),fs_extra_1.existsSync(e)&&console.log("compress astc success "+`{link(${e})}`)}function getCompressFunc(t){switch(t.slice(0,3)){case"jpg":case"png":return compressJpgAndPng;case"pvr":return compressPVR;case"etc":return compressEtc;case"web":return compressWebp;case"ast":return compressAstc}}async function createAlphaAtlas(t,e){const s=new Sharp(t),o=await s.metadata(),a=o.width,r=o.height;let c=roundToPowerOfTwo(a),n=roundToPowerOfTwo(r);n<c/2&&(n=c/2);const i=await s.raw().toBuffer(),p=2*a*n*3;let l,_,m=Buffer.alloc(p,0);for(let t=0;t<r;t++)for(let e=0;e<a;e++){let s=t*a+e,o=4*s;m[l=3*s]=i[o],m[l+1]=i[o+1],m[l+2]=i[o+2];let r=o+3;m[_=3*((t+n)*a+e)]=i[r],m[_+1]=i[r],m[_+2]=i[r]}const u={raw:{width:a,height:2*n,channels:3}};ensureDirSync(Path.dirname(e)),await Sharp(m,u).toFile(e)}function roundToPowerOfTwo(t){let e=2;for(;t>e;)e*=2;return e}async function flipImage(t,e){const s=new Sharp(t);s.flip(),ensureDirSync(Path.dirname(e)),await s.toFile(e),await new Promise(t=>{setTimeout(()=>{t()},100)})}async function compressImageList(t){for(const e of t){let{src:t,dest:s,quality:o}=e;ensureDirSync(Path.dirname(s));const a=getCompressFunc(e.format);if(a){if(".webp"===path_1.extname(t)){const e=Sharp(t);t=t.replace("webp","png"),await e.toFile(t)}await a(t,s,{name:e.format,quality:o})}}}exports.getSuffix=getSuffix,exports.compressImageList=compressImageList;