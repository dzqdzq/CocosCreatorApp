"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressImageList=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),{ensureDirSync:ensureDirSync,remove:remove}=require("fs-extra"),Path=require("path"),Sharp=require("sharp");async function compressJpgAndPng(t){return new Promise((s,e)=>{let o=Sharp(t.src);(o="png"===t.format?o.png({quality:t.compressOptions.quality||100}):o.jpeg({quality:t.compressOptions.quality||100})).toFile(t.dest).then(()=>{s()}).catch(t=>{e(t)})})}async function compressWebp(t){const{src:s,dest:e,format:o,compressOptions:r}=t;console.debug("start compress webp",s,e,o);let c=Path.join(Editor.App.path,"../tools/libwebp_darwin/bin/cwebp");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/libwebp_win32/bin/cwebp.exe"));const a=[s,"-o",e,"-q",String(r.quality),"-quiet","-exact"];console.debug(`webp compress command : ${c} ${a.join(" ")}`),await Build.Utils.quickSpawn(c,a,{prefix:"[compress webp]"}),console.log("compress webp success "+`{link(${e})}`)}async function compressPVR(t){if(console.debug("start compress pvr",t),t.format.endsWith("rgb_a")){const s=Path.relative(Editor.Project.path,t.src),e=Path.join(Editor.Project.path,"temp","CompressTexture","pvr_alpha",s);await createAlphaAtlas(t.src,e),t.src=e}const{src:s,dest:e,format:o,compressOptions:r}=t;let c=Path.join(Editor.App.path,"../tools/PVRTexTool_darwin/PVRTexToolCLI");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/PVRTexTool_win32/PVRTexToolCLI.exe"));const a={pvrtc_4bits_rgba:"PVRTC1_4",pvrtc_4bits_rgb:"PVRTC1_4_RGB",pvrtc_4bits_rgb_a:"PVRTC1_4_RGB",pvrtc_2bits_rgba:"PVRTC1_2",pvrtc_2bits_rgb:"PVRTC1_2_RGB",pvrtc_2bits_rgb_a:"PVRTC1_2_RGB"}[o],n=["-i",s,"-o",e,"-squarecanvas","+","-potcanvas","+","-q","pvrtc"+r.quality,"-f",`${a},UBN,lRGB`];console.debug(`pvrtc compress command :  ${c} ${n.join(" ")}`),await Build.Utils.quickSpawn(c,n,{downGradeWaring:!0,downGradeLog:!0,downGradeError:!0,prefix:"[compress pvrtc]"}),console.log("compress pvrtc success "+`{link(${e})}`)}async function compressEtc(t){const{dest:s,format:e,compressOptions:o}=t;if(console.debug("start compress etc",t.src,s,e),e.endsWith("rgb_a")){const s=Path.relative(Editor.Project.path,t.src),e=Path.join(Editor.Project.path,"temp","CompressTexture","etc_alpha",s);await createAlphaAtlas(t.src,e),t.src=e}let r=Path.join(Editor.App.path,"../tools/mali_darwin/etcpack");"win32"===process.platform&&(r=Path.join(Editor.App.path,"../tools/mali_win32/etcpack.exe"));const c=Path.dirname(r);r="."+Path.sep+Path.basename(r);const{etcFormat:a,compressFormat:n}={etc1_rgb:{etcFormat:"etc1",compressFormat:"RGB"},etc1_rgb_a:{etcFormat:"etc1",compressFormat:"RGB"},etc2_rgba:{etcFormat:"etc2",compressFormat:"RGBA"},etc2_rgb:{etcFormat:"etc2",compressFormat:"RGB"}}[e],i=[Path.normalize(t.src),Path.dirname(s),"-c",a,"-s",o.quality],p=c,m=Object.assign({},process.env);m.PATH=c+":"+m.PATH;const l={cwd:p,env:m,prefix:"[compress etc]"};"etc2"===a&&i.push("-f",n),console.debug(`etc compress command :  ${r} ${i.join(" ")}`),await Build.Utils.quickSpawn(r,i,l),console.log("compress etc success "+`{link(${s})}`)}async function compressAstc(t){const{src:s,dest:e,format:o,compressOptions:r}=t;console.debug("start compress astc",s,e,o);let c=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc.exe"));const a=["-cl",s,e,{astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[o],`-${r.quality}`];console.debug(`astc compressed command: ${Path.basename(c)} ${a.join(" ")}`),await Build.Utils.quickSpawn(c,a,{prefix:"[compress astc]"}),fs_extra_1.existsSync(e)?console.log("Compress astc success "+`{link(${e})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:o,asset:`{asset(${Build.Utils.getUuidFromPath(s)})}`,toolsPath:`{file(${c})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}function getCompressFunc(t){switch(t.slice(0,3)){case"jpg":case"png":return compressJpgAndPng;case"pvr":return compressPVR;case"etc":return compressEtc;case"web":return compressWebp;case"ast":return compressAstc}}function patchCommand(t,s){return new Function("options","with(options){ return String.raw`"+t+"`}")(s)}async function compressCustomFormat(t){const{src:s,dest:e,compressOptions:o}=t,{command:r,path:c}=t.customConfig,a={cwd:Path.dirname(c),prefix:"[custom compress]"},n=patchCommand(r,Object.assign(Object.assign({},o),{src:s,dest:e})),i=n.split(" ").filter(t=>!!t);console.debug(`custom compress command : ${c} ${n}`),await Build.Utils.quickSpawn(c,i,a)}async function createAlphaAtlas(t,s){const e=new Sharp(t),o=await e.metadata(),r=o.width,c=o.height,a=roundToPowerOfTwo(r);let n=roundToPowerOfTwo(c);n<a/2&&(n=a/2);const i=await e.raw().toBuffer(),p=2*r*n*3,m=Buffer.alloc(p,0);let l,u;for(let t=0;t<c;t++)for(let s=0;s<r;s++){const e=t*r+s,o=4*e;m[l=3*e]=i[o],m[l+1]=i[o+1],m[l+2]=i[o+2];const c=o+3;m[u=3*((t+n)*r+s)]=i[c],m[u+1]=i[c],m[u+2]=i[c]}const d={raw:{width:r,height:2*n,channels:3}};ensureDirSync(Path.dirname(s)),await Sharp(m,d).toFile(s)}function roundToPowerOfTwo(t){let s=2;for(;t>s;)s*=2;return s}async function compressImageList(t){for(const s of t){const{dest:t}=s;let e=s.src;ensureDirSync(Path.dirname(t));let o=getCompressFunc(s.format);if(o||s.customConfig){if(".webp"===path_1.extname(e)){const t=Sharp(e);e=e.replace("webp","png"),await t.toFile(e)}if(!o)try{return console.debug(`start custom compress config ${s.format}(${s.customConfig.name})`),await compressCustomFormat(Object.assign(Object.assign({},s),{src:e})),void console.debug("Custom compress config",`${s.format}(${s.customConfig.name})`,"sucess")}catch(t){if(console.error(`Compress {asset(${s.uuid})} with custom config failed!`),console.error(t),!(o=getCompressFunc(s.customConfig.format)))return void console.debug(`Invalid format ${s.customConfig.format}`)}await o(Object.assign(Object.assign({},s),{src:e}))}else console.debug(`Invalid format ${s.format}`)}}exports.compressImageList=compressImageList;