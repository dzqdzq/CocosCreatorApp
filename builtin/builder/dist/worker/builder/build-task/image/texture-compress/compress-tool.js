"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var o=Object.getOwnPropertyDescriptor(e,s);o&&("get"in o?e.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,o)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressCustomFormat=exports.getCompressFunc=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),fs_extra_2=require("fs-extra"),Path=__importStar(require("path")),utils_1=require("./utils"),utils_2=require("../../../utils"),Sharp=require("sharp");async function compressJpgAndPng(t){return new Promise((e,s)=>{let r=Sharp(t.src);r="png"===t.format?r.png({quality:t.compressOptions.quality||100}):r.jpeg({quality:t.compressOptions.quality||100}),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(t.dest)),r.toFile(t.dest).then(()=>{e()}).catch(t=>{s(t)})})}async function compressWebp(t){const{src:e,dest:s,format:r,compressOptions:o}=t;(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s)),console.debug("start compress webp",e,s,r);let a=Path.join(Editor.App.path,"../tools/libwebp_darwin/bin/cwebp");"win32"===process.platform&&(a=Path.join(Editor.App.path,"../tools/libwebp_win32/bin/cwebp.exe"));const c=[e,"-o",s,"-q",String(o.quality),"-quiet","-exact"];console.debug(`webp compress command : ${a} ${c.join(" ")}`),await Build.Utils.quickSpawn(a,c,{prefix:"[compress webp]"}),console.log("compress webp success "+`{link(${s})}`)}async function compressPVR(t){if(console.debug("start compress pvr",t),t.format.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t.src),s=Path.join(Editor.Project.path,"temp","CompressTexture","pvr_alpha",e);await createAlphaAtlas(t.src,s),t.src=s}const{src:e,dest:s,format:r,compressOptions:o}=t;(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s));let a=Path.join(Editor.App.path,"../tools/PVRTexTool_darwin/PVRTexToolCLI");"win32"===process.platform&&(a=Path.join(Editor.App.path,"../tools/PVRTexTool_win32/PVRTexToolCLI.exe"));const c={pvrtc_4bits_rgba:"PVRTC1_4",pvrtc_4bits_rgb:"PVRTC1_4_RGB",pvrtc_4bits_rgb_a:"PVRTC1_4_RGB",pvrtc_2bits_rgba:"PVRTC1_2",pvrtc_2bits_rgb:"PVRTC1_2_RGB",pvrtc_2bits_rgb_a:"PVRTC1_2_RGB"}[r],i=["-i",e,"-o",s,"-squarecanvas","+","-potcanvas","+","-q","pvrtc"+o.quality,"-f",`${c},UBN,lRGB`];console.debug(`pvrtc compress command :  ${a} ${i.join(" ")}`),await Build.Utils.quickSpawn(a,i,{downGradeWaring:!0,downGradeLog:!0,ignoreError:!0,downGradeError:!0,prefix:"[compress pvrtc]"}),(0,fs_extra_1.existsSync)(s)?console.log("compress pvrtc success "+`{link(${s})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:r,asset:`{asset(${Build.Utils.getUuidFromPath(t.src)})}`,toolsPath:`{file(${a})}`,toolHomePage:"https://developer.imaginationtech.com/pvrtextool/"}))}async function compressEtc(t){const{dest:e,format:s,compressOptions:r}=t;if(console.debug("start compress etc",t.src,e,s),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(e)),s.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t.src),s=Path.join(Editor.Project.path,"temp","CompressTexture","etc_alpha",e);await createAlphaAtlas(t.src,s),t.src=s}let o=Path.join(Editor.App.path,"../tools/mali_darwin/etcpack");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/mali_win32/etcpack.exe"));const a=Path.dirname(o);o="."+Path.sep+Path.basename(o);const{etcFormat:c,compressFormat:i}={etc1_rgb:{etcFormat:"etc1",compressFormat:"RGB"},etc1_rgb_a:{etcFormat:"etc1",compressFormat:"RGB"},etc2_rgba:{etcFormat:"etc2",compressFormat:"RGBA"},etc2_rgb:{etcFormat:"etc2",compressFormat:"RGB"}}[s],n=[Path.normalize(t.src),Path.dirname(e),"-c",c,"-s",r.quality],p=a,l=Object.assign({},process.env);l.PATH=a+":"+l.PATH;const m={cwd:p,env:l,prefix:"[compress etc]"};"etc2"===c&&n.push("-f",i),console.debug(`etc compress command :  ${o} ${n.join(" ")}`),await(0,utils_2.quickSpawn)(o,n,m),(0,fs_extra_1.existsSync)(e)?console.log("compress etc success "+`{link(${e})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:s,asset:`{asset(${Build.Utils.getUuidFromPath(t.src)})}`,toolsPath:`{file(${o})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}async function compressAstc(t){const{src:e,dest:s,format:r,compressOptions:o}=t;console.debug("start compress astc",e,s,r),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s));let a=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc");"win32"===process.platform&&(a=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc.exe"));const c={astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[r];"veryfast"===o.quality&&(o.quality="fastest");const i=["-cl",e,s,c,`-${o.quality}`];console.debug(`astc compressed command: ${Path.basename(a)} ${i.join(" ")}`),await Build.Utils.quickSpawn(a,i,{prefix:"[compress astc]"}),(0,fs_extra_1.existsSync)(s)?console.log("Compress astc success "+`{link(${s})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:r,asset:`{asset(${Build.Utils.getUuidFromPath(e)})}`,toolsPath:`{file(${a})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}function getCompressFunc(t){switch(t.slice(0,3)){case"jpg":case"png":return compressJpgAndPng;case"pvr":return compressPVR;case"etc":return compressEtc;case"web":return compressWebp;case"ast":return compressAstc}}function patchCommand(t,e){return new Function("options","with(options){ return String.raw`"+t+"`}")(e)}async function compressCustomFormat(t){const{src:e,dest:s,compressOptions:r}=t,{command:o,path:a}=t.customConfig,c={cwd:Path.dirname(Editor.UI.File.resolveToRaw(a)),prefix:"[custom compress]"},i=patchCommand(o,Object.assign(Object.assign({},r),{src:e,dest:s})),n=i.split(" ").filter(t=>!!t);console.debug(`custom compress command : ${a} ${i}`),await Build.Utils.quickSpawn(a,n,c)}async function createAlphaAtlas(t,e){const s=new Sharp(t),r=await s.metadata(),o=r.width,a=r.height,c=(0,utils_1.roundToPowerOfTwo)(o);let i=(0,utils_1.roundToPowerOfTwo)(a);i<c/2&&(i=c/2);const n=await s.raw().toBuffer(),p=2*o*i*3,l=Buffer.alloc(p,0);let m,u;for(let t=0;t<a;t++)for(let e=0;e<o;e++){const s=t*o+e,r=4*s;l[m=3*s]=n[r],l[m+1]=n[r+1],l[m+2]=n[r+2];const a=r+3;l[u=3*((t+i)*o+e)]=n[a],l[u+1]=n[a],l[u+2]=n[a]}const d={raw:{width:o,height:2*i,channels:3}};(0,fs_extra_2.ensureDirSync)(Path.dirname(e)),await Sharp(l,d).toFile(e)}exports.getCompressFunc=getCompressFunc,exports.compressCustomFormat=compressCustomFormat;