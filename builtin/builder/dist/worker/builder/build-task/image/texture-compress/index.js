"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressImageList=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),minimaps_1=require("../minimaps"),compress_tool_1=require("./compress-tool"),cc_1=require("cc"),Sharp=require("sharp");async function compressImageList(e){for(const s of e){const{dest:e}=s;let t,o=s.src;(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(e));try{if(100===s.compressOptions.quality&&(0,path_1.extname)(s.src).endsWith(s.format)){console.log(`${s.format} with quality is 100, will copy the image from ${s.src} to ${s.dest}`),(0,fs_extra_1.copySync)(s.src,s.dest,{overwrite:!0});continue}}catch(e){console.warn(e)}if(".webp"===(0,path_1.extname)(o)){const e=Sharp(o);o=o.replace("webp","png"),await e.toFile(o)}if(s.customConfig)try{console.debug(`start custom compress config ${s.format}(${s.customConfig.name})`),await(0,compress_tool_1.compressCustomFormat)(Object.assign(Object.assign({},s),{src:o})),console.debug("Custom compress config",`${s.format}(${s.customConfig.name})`,"sucess");continue}catch(e){if(console.warn(`Compress {asset(${s.uuid})} with custom config failed!`),console.warn(e),!(t=(0,compress_tool_1.getCompressFunc)(s.customConfig.format))){console.warn(`Invalid format ${s.customConfig.format}`);continue}}if(t=t||(0,compress_tool_1.getCompressFunc)(s.format)){await t(Object.assign(Object.assign({},s),{src:o}));try{const e=await(0,minimaps_1.compressMipmapFiles)(Object.assign(Object.assign({},s),{src:o}),t);if(e.length){e.splice(0,0,(0,fs_extra_1.readFileSync)(s.dest));const t=cc_1.ImageAsset.mergeCompressedTextureMips(e);await(0,fs_extra_1.outputFile)(s.dest,t)}}catch(e){console.error(e),await(0,fs_extra_1.remove)(s.dest),console.error(`Generate {asset(${s.uuid})} compress texture mipmap files failed!`)}try{if((0,path_1.extname)(s.src).endsWith(s.format)){const e=await(0,fs_extra_1.stat)(s.src),t=await(0,fs_extra_1.stat)(s.dest);t.size>e.size&&(console.log(`The compressed image(${s.src}) size(${t.size}) is larger than the original image(${s.dest}) size(${e.size}), and the original image will be used. To ignore this protection mechanism, please configure it in Project Settings -> Texture Compression Configuration.`),(0,fs_extra_1.copySync)(s.src,s.dest,{overwrite:!0}))}}catch(e){console.warn(e)}}else console.warn(`Invalid format ${s.format}`)}}exports.compressImageList=compressImageList;