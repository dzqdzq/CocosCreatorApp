"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var s=Object.getOwnPropertyDescriptor(r,t);s&&("get"in s?r.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,s)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildScriptCommand=void 0;const fs_extra_1=__importDefault(require("fs-extra")),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),creator_programming_rollup_plugin_mod_lo_1=__importDefault(require("@cocos/creator-programming-rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),path_1=__importStar(require("path")),pack_mods_1=require("../../utils/pack-mods");function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}async function buildScriptCommand(e){var r,t,o,s,n,a;const i={scriptPackages:[],importMappings:{}};if(0===e.bundles.length)return i;const u=Object.entries(e.ccEnvConstants).map(([e,r])=>`export const ${e} = ${r};`).join("\n"),{bundles:l,modulePreservation:c}=e,p={},d=[],m={},_={},f=new Set,h=new Set,g="preserve"===e.modulePreservation,v=e=>{var r;const{facadeModuleId:t}=e;if(!t)return-1;let o="";if(t.startsWith("file:///"))try{o=(0,url_1.fileURLToPath)(t)}catch(e){return-1}else o=t;return null!==(r=_[o])&&void 0!==r?r:-1},M=e=>{const{facadeModuleId:r}=e;return r?f.has(r)?r:h.has(r)?r:"":""};for(let e=0;e<l.length;++e){const r=l[e];for(const t of r.scripts){const r=(0,url_1.pathToFileURL)(t.file).href;m[r]=t.uuid,"facade"!==c&&"preserve"!==c||d.push(r),_[t.file]=e,g&&h.add(r)}const t=`virtual:///prerequisite-imports/${r.id}`;p[t]=r.scripts.map(e=>e.file).sort().map(e=>`import "${(0,url_1.pathToFileURL)(e).href}";`).join("\n"),_[t]=e,d.push(t),f.add(t)}const b=new mod_lo_1.ModLo({targets:e.transform.targets,loose:e.loose,exportsConditions:e.exportsConditions,guessCommonJsExports:e.guessCommonJsExports,useDefineForClassFields:e.useDefineForClassFields,allowDeclareFields:e.allowDeclareFields,_internalTransform:{excludes:null!==(t=null===(r=e.transform)||void 0===r?void 0:r.excludes)&&void 0!==t?t:[],includes:null!==(s=null===(o=e.transform)||void 0===o?void 0:o.includes)&&void 0!==s?s:[]},_compressUUID:r=>e.uuidCompressMap[r],_helperModule:creator_programming_rollup_plugin_mod_lo_1.default.helperModule,hot:e.hotModuleReload}),j=e.importMap,w={},k=j?new url_1.URL(j.url):new url_1.URL("foo:/bar");w.imports={"cc/env":"virtual:/cc/env","cc/userland/macro":"virtual:/cc/userland/macro"};const y=[];for(const r of e.dbInfos){const e=`db://${r.dbID}/`,t=(0,url_1.pathToFileURL)(path_1.default.join(r.target,path_1.default.join(path_1.default.sep))).href;w.imports[e]=t,y.push(t)}if(j&&(j.json.imports&&(w.imports=Object.assign(Object.assign({},w.imports),j.json.imports)),j.json.scopes))for(const[e,r]of Object.entries(j.json.scopes)){const t=null!==(n=w.scopes)&&void 0!==n?n:w.scopes={};t[e]=Object.assign(Object.assign({},null!==(a=t[e])&&void 0!==a?a:{}),r)}b.setImportMap(w,k),b.setAssetPrefixes(y),b.addMemoryModule("virtual:/cc/env",u),b.addMemoryModule("virtual:/cc/userland/macro",e.customMacroList.map(e=>`export const ${e.key} = ${e.value};`).join("\n"));for(const[e,r]of Object.entries(p))b.addMemoryModule(e,r);for(const[e,r]of Object.entries(m))b.setUUID(e,r);const C=[(0,creator_programming_rollup_plugin_mod_lo_1.default)({modLo:b})];"facade"!==c&&"erase"!==c||C.push(rpNamedChunk()),e.sourceMaps&&C.push((0,rollup_plugin_sourcemaps_1.default)()),e.debug||C.push((0,rollup_plugin_terser_1.terser)()),"erase"===c&&C.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:r}){switch(e){default:return;case"url":try{return`'${new url_1.URL(r).href}'`}catch(e){return void console.error(`Can not access import.meta.url of module '${r}'. '${r}' is not a valid URL.`)}}}});const D="preserve"!==e.modulePreservation,U={input:d,plugins:C,preserveModules:"erase"!==c,external:["cc"],onwarn:(e,r)=>{var t;if(D&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code)return;if("string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&(null===(t=e.importer)||void 0===t?void 0:t.includes("node_modules")))return;const o="object"==typeof e&&e.message||e;console.warn(`[[Build.Script.Rollup]] ${o}`)}},x=await rollup.rollup(U),O={sourcemap:e.sourceMaps,exports:"named"};"preserve"===e.modulePreservation?O.format=e.moduleFormat:Object.assign(O,{format:"system",dir:"chunks:///",systemNullSetters:!0});const P=await x.generate(O),$={};if("preserve"===e.modulePreservation){const r=path_1.default.join(e.outDir,"src","chunks");for(const e of P.output)if("chunk"===e.type){const t=e.fileName.match(/\.(js|ts|mjs)$/)?e.fileName:`${e.fileName}.js`,o=path_1.default.join(r,t);await fs_extra_1.default.outputFile(o,e.code,"utf8");const s=M(e);if(s){const e=`./chunks/${t}`.replace(/\\/g,"/");$[s]=e}}}else{const r=path_1.default.join(e.outDir,"src","chunks","bundle.js"),t=new ChunkBundler(r);let o=0;const s=l.map(e=>new ChunkBundler(e.outFile));for(const e of P.output){if("chunk"!==e.type)continue;const r=!!e.facadeModuleId&&d.includes(e.facadeModuleId);if(e.isEntry||r){const r=v(e);if(r<0||void 0===s[r])console.warn(`Unexpected: entry chunk name ${e.name} is not in list.`),t.add(e),++o;else{s[r].add(e);const t=M(e);t&&s[r].addModuleMapping(t,getChunkUrl(e))}}else t.add(e),++o}if(await Promise.all(s.map(async(r,t)=>{await r.write({sourceMaps:e.sourceMaps,wrap:!1})})),o){await t.write({sourceMaps:e.sourceMaps,wrap:!0});const o=r;i.scriptPackages.push(o)}}return i.importMappings=$,i}exports.buildScriptCommand=buildScriptCommand;class ChunkBundler{constructor(e){this._parts=[],this._chunkMappings={},this._out=e}add(e){var r;this._parts.push([e.fileName,{code:e.code,map:null===(r=e.map)||void 0===r?void 0:r.toString()}])}addModuleMapping(e,r){this._chunkMappings[e]=r}async write(e){return await(0,pack_mods_1.packMods)(this._parts.sort(([e],[r])=>e.localeCompare(r)).map(([e,r])=>r),this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,r,t){const o=getChunkUrl(r),s=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:o}]]});return s?{code:s.code,map:s.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return`chunks:///${e.fileName}`}