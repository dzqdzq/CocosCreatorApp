"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var s=Object.getOwnPropertyDescriptor(r,t);s&&("get"in s?r.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,s)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildScriptCommand=void 0;const mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),creator_programming_rollup_plugin_mod_lo_1=__importDefault(require("@cocos/creator-programming-rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),path_1=__importStar(require("path")),pack_mods_1=require("../../utils/pack-mods");function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}async function buildScriptCommand(e){var r,t,o,s,n,a;const i={scriptPackages:[]};if(0===e.bundles.length)return i;const u=Object.entries(e.buildTimeConstants).map(([e,r])=>`export const ${e} = ${r};`).join("\n"),{bundles:l,modulePreservation:c}=e,p={},d=[],m=[],_={},f={},h=[];for(let e=0;e<l.length;++e){const r=l[e];for(const t of r.scripts){const r=(0,url_1.pathToFileURL)(t.file).href;_[r]=t.uuid,"facade"!==c&&"preserve"!==c||m.push(r),"preserve"!==c&&(f[r]=e)}if("preserve"!==c){const t=`virtual:///prerequisite-imports/${r.id}`;p[t]=r.scripts.map(e=>e.file).sort().map(e=>`import "${(0,url_1.pathToFileURL)(e).href}";`).join("\n"),f[t]=e,m.push(t),h.push(t),d.push(t)}}const g=new mod_lo_1.ModLo({targets:e.transform.targets,loose:e.loose,exportsConditions:e.exportsConditions,guessCommonJsExports:e.guessCommonJsExports,useDefineForClassFields:e.useDefineForClassFields,allowDeclareFields:e.allowDeclareFields,_internalTransform:{excludes:null!==(t=null===(r=e.transform)||void 0===r?void 0:r.excludes)&&void 0!==t?t:[],includes:null!==(s=null===(o=e.transform)||void 0===o?void 0:o.includes)&&void 0!==s?s:[]},_compressUUID:r=>e.uuidCompressMap[r],_helperModule:creator_programming_rollup_plugin_mod_lo_1.default.helperModule}),v=e.importMap,b={},M=v?new url_1.URL(v.url):new url_1.URL("foo:/bar");b.imports={"cc/env":"virtual:/cc/env","cc/userland/macro":"virtual:/cc/userland/macro"};const j=[];for(const r of e.dbInfos){const e=`db://${r.dbID}/`,t=(0,url_1.pathToFileURL)(path_1.default.join(r.target,path_1.default.join(path_1.default.sep))).href;b.imports[e]=t,j.push(t)}if(v&&(v.json.imports&&(b.imports=Object.assign(Object.assign({},b.imports),v.json.imports)),v.json.scopes))for(const[e,r]of Object.entries(v.json.scopes)){const t=null!==(n=b.scopes)&&void 0!==n?n:b.scopes={};t[e]=Object.assign(Object.assign({},null!==(a=t[e])&&void 0!==a?a:{}),r)}g.setImportMap(b,M),g.setAssetPrefixes(j),g.addMemoryModule("virtual:/cc/env",u),g.addMemoryModule("virtual:/cc/userland/macro",e.customMacroList.map(e=>`export const ${e.key} = ${e.value};`).join("\n"));for(const[e,r]of Object.entries(p))g.addMemoryModule(e,r);for(const[e,r]of Object.entries(_))g.setUUID(e,r);const w=[(0,creator_programming_rollup_plugin_mod_lo_1.default)({modLo:g})];"facade"!==c&&"erase"!==c||w.push(rpNamedChunk()),e.sourceMaps&&w.push((0,rollup_plugin_sourcemaps_1.default)()),e.debug||w.push((0,rollup_plugin_terser_1.terser)()),"erase"===c&&w.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:r}){switch(e){default:return;case"url":try{return`'${new url_1.URL(r).href}'`}catch(e){return void console.error(`Can not access import.meta.url of module '${r}'. '${r}' is not a valid URL.`)}}}});let k=!1;const C={input:m,plugins:w,preserveModules:"erase"!==c,external:["cc"],onwarn:(e,r)=>{var t;if(k&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code)return;if("string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&(null===(t=e.importer)||void 0===t?void 0:t.includes("node_modules")))return;const o="object"==typeof e&&e.message||e;console.warn(`[[Build.Script.Rollup]] ${o}`)}},y=await rollup.rollup(C),O={sourcemap:e.sourceMaps,exports:"named"};if("preserve"===e.modulePreservation){const r=Object.assign(Object.assign({},O),{format:e.moduleFormat});await y.write(r)}else{const r=Object.assign(Object.assign({},O),{format:"system",dir:"chunks:///",systemNullSetters:!0});k=!0;const t=await y.generate(r),o=path_1.default.join(e.outDir,"src","chunks","bundle.js"),s=new ChunkBundler(o);let n=0;const a=l.map(e=>new ChunkBundler(e.outFile));for(const e of t.output)if("chunk"===e.type)if(e.isEntry){const{facadeModuleId:r}=e,t=r?f[r]:null;null===t||void 0===a[t]?(console.warn(`Unexpected: entry chunk name ${e.name} is not in list.`),s.add(e),++n):(a[t].add(e),r&&d.includes(r)&&a[t].addModuleMapping(r,getChunkUrl(e)))}else s.add(e),++n;if(await Promise.all(a.map(async(r,t)=>{await r.write({sourceMaps:e.sourceMaps,wrap:!1})})),n){await s.write({sourceMaps:e.sourceMaps,wrap:!0});const r=o;i.scriptPackages.push(r)}}return i}exports.buildScriptCommand=buildScriptCommand;class ChunkBundler{constructor(e){this._parts=[],this._chunkMappings={},this._out=e}add(e){var r;this._parts.push([e.fileName,{code:e.code,map:null===(r=e.map)||void 0===r?void 0:r.toString()}])}addModuleMapping(e,r){this._chunkMappings[e]=r}async write(e){return await(0,pack_mods_1.packMods)(this._parts.sort(([e],[r])=>e.localeCompare(r)).map(([e,r])=>r),this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,r,t){const o=getChunkUrl(r),s=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:o}]]});return s?{code:s.code,map:s.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return`chunks:///${e.fileName}`}