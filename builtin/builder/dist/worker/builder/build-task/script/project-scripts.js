"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t),Object.defineProperty(e,s,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,s){void 0===s&&(s=t),e[s]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildProjectScriptsX=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),babel_preset_cc_1=__importDefault(require("@cocos/babel-preset-cc")),path_2=__importDefault(require("path")),pack_mods_1=require("../../utils/pack-mods"),utils_1=require("../../utils"),editor_1=__importDefault(require("editor")),_lodash=require("lodash"),mod_lo_1=require("@editor/lib-programming/dist/mod-assembling/mod-lo/mod-lo"),rollup_plugin_mod_lo_1=__importDefault(require("@editor/lib-programming/dist/mod-assembling/rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url");async function buildProjectScriptsX(e,r,t,s,o){var i,l;r.scriptPackages.length=0;const a={};(null===(i=e.buildScriptParam.polyfills)||void 0===i?void 0:i.asyncFunctions)||(null!==(l=a.excludes)&&void 0!==l?l:a.excludes=[]).push("transform-regenerator"),e.buildScriptParam.targets&&(a.targets=e.buildScriptParam.targets);let u="facade";e.buildScriptParam.experimentalEraseModules&&(u="erase");const[n,c,p,d]=await Promise.all([editor_1.default.Profile.getProject("project","script.useDefineForClassFields"),editor_1.default.Profile.getProject("project","script.allowDeclareFields"),editor_1.default.Profile.getProject("project","script.loose"),!1]);await buildScript({bundles:r.bundles.map(e=>({id:e.name,scripts:e.scripts.map(e=>t.getAssetInfo(e)),outFile:e.scriptDest})),debug:e.debug,sourceMaps:e.sourceMaps,modulePreservation:u,moduleFormat:"system",transform:a,outDir:r.paths.dir,useDefineForClassFields:n,allowDeclareFields:c,loose:p,guessCommonJsExports:null!==d&&void 0!==d&&d},t,r,o);for(let e=0;e<r.plugins.length;e++){const s=t.getAssetInfo(r.plugins[e]),o=utils_1.removeDbHeader(s.url),i=path_1.join(r.paths.dir,"src",o);fs_extra_1.ensureDirSync(path_1.dirname(i)),fs_extra_1.copyFileSync(s.library[".js"],i)}console.debug("Copy externalScripts success!")}async function buildScript(e,r,t,s){var o,i,l,a;if(0===e.bundles.length)return;const u=Object.entries(s).map(([e,r])=>`export const ${e} = ${r};`).join("\n"),{bundles:n,modulePreservation:c}=e,p={},d=[],_=[],m={},f={},h=[];for(let e=0;e<n.length;++e){const r=n[e];for(const t of r.scripts){const r=url_1.pathToFileURL(t.file).href;m[r]=t.uuid,"facade"!==c&&"preserve"!==c||_.push(r),"preserve"!==c&&(f[r]=e)}if("preserve"!==c){const t=`virtual:///prerequisite-imports/${r.id}`;p[t]=r.scripts.map(e=>e.file).map(e=>`import "${url_1.pathToFileURL(e).href}";`).join("\n"),f[t]=e,_.push(t),h.push(t),d.push(t)}}const g=new mod_lo_1.ModLo({targets:e.transform.targets,loose:e.loose,guessCommonJsExports:e.guessCommonJsExports,assetPrefix:url_1.pathToFileURL(path_2.default.join(editor_1.default.Project.path,path_2.default.sep)).href,importMap:{imports:{"cc/env":"virtual:/cc/env"}},_cc:[babel_preset_cc_1.default,{useDefineForClassFields:e.useDefineForClassFields,allowDeclareFields:e.allowDeclareFields}],_internalTransform:{excludes:null!==(i=null===(o=e.transform)||void 0===o?void 0:o.excludes)&&void 0!==i?i:[],includes:null!==(a=null===(l=e.transform)||void 0===l?void 0:l.includes)&&void 0!==a?a:[]},_compressUUID:e=>Build.Utils.compressUuid(e,!1),_helperModule:rollup_plugin_mod_lo_1.default.helperModule});g.addMemoryModule("virtual:/cc/env",u);for(const[e,r]of Object.entries(p))g.addMemoryModule(e,r);for(const[e,r]of Object.entries(m))g.setUUID(e,r);const b=[rollup_plugin_mod_lo_1.default({modLo:g})];"facade"!==c&&"erase"!==c||b.push(rpNamedChunk()),e.sourceMaps&&b.push(rollup_plugin_sourcemaps_1.default()),e.debug||b.push(rollup_plugin_terser_1.terser()),"erase"===c&&b.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:r}){switch(e){default:return;case"url":try{return`'${new url_1.URL(r).href}'`}catch(e){return void console.error(`Can not access import.meta.url of module '${r}'. '${r}' is not a valid URL.`)}}}});let v=!1;const M={input:_,plugins:b,preserveModules:"erase"!==c,external:["cc"],onwarn:(e,r)=>{var t;if(v&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code)return;if("string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&(null===(t=e.importer)||void 0===t?void 0:t.includes("node_modules")))return;const s="object"==typeof e&&e.message||e;console.warn(`[[Build.Script.Rollup]] ${s}`)}},j=await rollup.rollup(M),w={sourcemap:e.sourceMaps,exports:"named"};if("preserve"===e.modulePreservation){const r=Object.assign(Object.assign({},w),{format:e.moduleFormat});await j.write(r)}else{const r=Object.assign(Object.assign({},w),{format:"system",dir:"chunks:///",systemNullSetters:!0});v=!0;const s=await j.generate(r),o=path_2.default.join(e.outDir,"src","chunks","bundle.js"),i=new ChunkBundler(o);let l=0;const a=n.map(e=>new ChunkBundler(e.outFile));for(const e of s.output)if("chunk"===e.type)if(e.isEntry){const{facadeModuleId:r}=e,t=r?f[r]:null;null===t||void 0===a[t]?(console.warn(`Unexpected: entry chunk name ${e.name} is not in list.`),i.add(e),++l):(a[t].add(e),r&&d.includes(r)&&a[t].addModuleMapping(r,getChunkUrl(e)))}else i.add(e),++l;if(await Promise.all(a.map(async(r,t)=>{await r.write({sourceMaps:e.sourceMaps,wrap:!1})})),l){await i.write({sourceMaps:e.sourceMaps,wrap:!0});const r=utils_1.relativeUrl(path_2.default.dirname(t.paths.applicationJS),o);t.scriptPackages.push(`./${r}`)}}}exports.buildProjectScriptsX=buildProjectScriptsX;class ChunkBundler{constructor(e){this._parts=[],this._chunkMappings={},this._out=e}add(e){var r;this._parts.push({code:e.code,map:null===(r=e.map)||void 0===r?void 0:r.toString()})}addModuleMapping(e,r){this._chunkMappings[e]=r}async write(e){return await pack_mods_1.packMods(this._parts,this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,r,t){const s=getChunkUrl(r),o=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:s}]]});return o?{code:o.code,map:o.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return`chunks:///${e.fileName}`}