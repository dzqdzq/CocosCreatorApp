"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildProjectScriptsX=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../utils"),sub_process_manager_1=require("../../../worker-pools/sub-process-manager");async function buildProjectScriptsX(e,s,r,t){var a,i,o;s.scriptPackages.length=0;const c={};(null===(a=e.buildScriptParam.polyfills)||void 0===a?void 0:a.asyncFunctions)||(null!==(i=c.excludes)&&void 0!==i?i:c.excludes=[]).push("transform-regenerator"),e.buildScriptParam.targets&&(c.targets=e.buildScriptParam.targets);let p="facade";e.buildScriptParam.experimentalEraseModules&&(p="erase");const u=null!==(o=e.buildScriptParam.hotModuleReload)&&void 0!==o&&o;u&&(p="preserve");const n=await Editor.Message.request("programming","query-shared-settings"),l=await Editor.Message.request("asset-db","query-db-list"),d=await Promise.all(l.map(async e=>{return{dbID:e,target:(await Editor.Message.request("asset-db","query-db-info",e)).target}})),m=await Editor.Profile.getProject("engine","macroCustom"),g={};r.scriptUuids.forEach(e=>{g[e]=Build.Utils.compressUuid(e,!1)});const b=Object.assign({bundles:s.bundles.map(e=>({id:e.name,scripts:e.scripts.map(e=>r.getAssetInfo(e)).sort((e,s)=>e.name.localeCompare(s.name)),outFile:e.scriptDest})),debug:e.debug,sourceMaps:e.sourceMaps,modulePreservation:p,moduleFormat:"system",transform:c,outDir:s.paths.dir,customMacroList:m,dbInfos:d,ccEnvConstants:t,uuidCompressMap:g,applicationJS:s.paths.applicationJS,hotModuleReload:u},n);for(let e=0;e<b.bundles.length;++e)s.bundles[e].hasPreloadScript="preserve"!==p;await sub_process_manager_1.workerManager.registerTask({name:"build-script",path:(0,path_1.join)(__dirname,"./build-script")});const _=await sub_process_manager_1.workerManager.runTask("build-script","buildScriptCommand",[b]);_&&(_.scriptPackages&&s.scriptPackages.push(..._.scriptPackages),_.importMappings&&Object.assign(s.importMap.imports,_.importMappings));for(let e=0;e<s.plugins.length;e++){const t=r.getAssetInfo(s.plugins[e]),a=(0,utils_1.removeDbHeader)(t.url),i=(0,path_1.join)(s.paths.dir,"src",a);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(i)),(0,fs_extra_1.copyFileSync)(t.library[".js"],i)}sub_process_manager_1.workerManager.kill("build-script"),console.debug("Copy externalScripts success!")}exports.buildProjectScriptsX=buildProjectScriptsX;