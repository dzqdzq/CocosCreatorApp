"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildEngineX=void 0;const crypto_1=require("crypto"),path_1=require("path"),fs_extra_1=require("fs-extra"),ccBuild=__importStar(require("@cocos/build-engine")),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),sub_process_manager_1=require("../../../worker-pools/sub-process-manager"),EngineCacheName="engine-cache",exportsMetaFile="meta.json";async function buildEngineX(e,t,a,i,n,r){const o=(0,path_1.join)(t.paths.dir,`${e.buildEngineParam.engineName}`);if(t.paths.engineDir=o,e.buildEngineParam.skip)return;const{output:s,metaFile:u}=await buildEngine(e,r);await(0,fs_extra_1.emptyDir)(o),await(0,fs_extra_1.copy)(`${s}`,o,{recursive:!0}),await writeImportMapForEngine(u,o,i,n,e.buildEngineParam.baseUrl)}exports.buildEngineX=buildEngineX;const fixedMd5Keys=["debug","sourceMaps","includeModules","engineVersion","platform","split","ammoJsWasm","entry","noDeprecatedFeatures","loose","assetURLFormat","flags"];async function buildEngine(e,t){const a=(await Editor.Message.request("engine","query-engine-info")).typescript,{includeModules:i,debug:n,sourceMaps:r,useCache:o}=e.buildEngineParam;e.buildEngineParam.entry=a.path;const[s,u]=await Promise.all([Editor.Profile.getProject("engine","modules.noDeprecatedFeatures"),Editor.Profile.getProject("project","script.loose")]),l=s.value?!s.version||s.version:void 0,c={noDeprecatedFeatures:l,loose:u},d=0===e.buildEngineParam.md5Map.length?fixedMd5Keys:e.buildEngineParam.md5Map.concat(fixedMd5Keys),p=calcMd5String(Object.assign(c,e.buildEngineParam),d),_=(0,crypto_1.createHash)("md5").update(p).digest("hex"),g=(0,path_1.join)(Editor.App.temp,"builder","engine",_),m=(0,path_1.join)((0,path_1.dirname)(g),`${_}.meta`),f=`${g}.watch-files.json`,b=(0,path_1.join)(m,exportsMetaFile);if(o&&await validateCache(g,f)&&await isValidMeta(b))return console.debug(`Use cache engine: {link(${g})}`),console.debug(e.buildEngineParam),{output:g,metaFile:b};const h={incremental:f,engine:a.path,out:g,moduleFormat:ccBuild.ModuleOption.system,compress:!n,split:e.buildEngineParam.split,ammoJsWasm:e.buildEngineParam.ammoJsWasm,assetURLFormat:e.buildEngineParam.assetURLFormat,noDeprecatedFeatures:l,buildTimeConstants:t,loose:u,features:i,platform:e.buildEngineParam.platform,mode:"BUILD",metaFile:b};return r&&(h.sourceMap=!0),e.buildEngineParam.targets&&(h.targets=e.buildEngineParam.targets),await sub_process_manager_1.workerManager.registerTask({name:"build-engine",path:(0,path_1.join)(__dirname,"./build-engine")}),await sub_process_manager_1.workerManager.runTask("build-engine","buildEngineCommand",[h]),await outputCacheJson(e.buildEngineParam,g),sub_process_manager_1.workerManager.kill("build-engine"),{output:g,metaFile:b}}async function validateCache(e,t){if(!await fs_extra_2.default.pathExists(e))return console.debug(`Engine cache ({link(${e})}) does not exist.`),!1;let a=!1;try{0!==(await fs_extra_2.default.readdir(e)).length&&(a=!0)}catch(e){}return a?!await ccBuild.isSourceChanged(t):(console.warn(`Engine cache directory({link(${e})}) exists but has empty content. It's abnormal.`),!1)}async function isValidMeta(e){if(!await(0,fs_extra_1.pathExists)(e))return!1;let t;try{t=await fs_extra_2.default.readJson(e)}catch(e){return!1}if("object"!=typeof t||null===t)return!1;return"object"==typeof t.exports}function calcMd5String(e,t){let a="";for(const i of t)a+=`${i}=${JSON.stringify(e[i])},`;return a}async function outputCacheJson(e,t){const a=(0,path_1.join)((0,path_1.dirname)(t),`${EngineCacheName}.json`);let i={};await(0,fs_extra_1.pathExists)(a)&&(i=await(0,fs_extra_1.readJson)(a)),(i=i||{})[(0,path_1.basename)(t)]=e,await(0,fs_extra_1.outputJSON)(a,i)}async function writeImportMapForEngine(e,t,a,i,n){let r;try{r=await fs_extra_2.default.readJson(e)}catch(e){throw new Error(`Failed to read engine export meta, engine might not have been build correctly: ${e}`)}const o=n?new URL(n):void 0,s=e=>{let a;return a=o?new URL(e,o).href:`./${Build.Utils.relativeUrl(i,path_2.default.join(t,e))}`};for(const[e,t]of Object.entries(r.exports))a.imports[e]=s(t);for(const[e,t]of Object.entries(r.chunkAliases))a.imports[e]=s(t)}