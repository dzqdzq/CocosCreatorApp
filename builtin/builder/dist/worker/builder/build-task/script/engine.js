"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildEngineX=void 0;const crypto_1=require("crypto"),path_1=require("path"),fs_extra_1=require("fs-extra"),ccBuild=__importStar(require("@cocos/build-engine")),stats_query_1=require("@cocos/build-engine/dist/stats-query"),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),EngineCacheName="engine-cache",exportsMetaFile="meta.json";async function buildEngineX(e,t,a,i,r,n){const o=path_1.join(t.paths.dir,`${e.buildEngineParam.engineName}`);if(t.paths.engineDir=o,e.buildEngineParam.skip)return;const{output:s,metaFile:u}=await buildEngine(e,n);await fs_extra_1.emptyDir(o),await fs_extra_1.copy(`${s}`,o,{recursive:!0}),await writeImportMapForEngine(u,o,i,r,e.buildEngineParam.baseUrl)}exports.buildEngineX=buildEngineX;const fixedMd5Keys=["debug","sourceMaps","includeModules","engineVersion","platform","split","ammoJsWasm","entry","noDeprecatedFeatures","loose","assetURLFormat"];async function buildEngine(e,t){const a=await Editor.Message.request("engine","query-info",Editor.Project.type),{includeModules:i,debug:r,sourceMaps:n,useCache:o}=e.buildEngineParam;e.buildEngineParam.entry=a.path;const[s,u]=await Promise.all([Editor.Profile.getProject("engine","modules.noDeprecatedFeatures"),Editor.Profile.getProject("project","script.loose")]),c=s.value?!s.version||s.version:void 0,l={noDeprecatedFeatures:c,loose:u},d=0===e.buildEngineParam.md5Map.length?fixedMd5Keys:e.buildEngineParam.md5Map.concat(fixedMd5Keys),p=calcMd5String(Object.assign(l,e.buildEngineParam),d),_=crypto_1.createHash("md5").update(p).digest("hex"),f=path_1.join(Editor.App.temp,"builder","engine",_),m=path_1.join(path_1.dirname(f),`${_}.meta`),g=`${f}.watch-files.json`,h=path_1.join(m,exportsMetaFile);if(o&&await validateCache(f,g)&&await isValidMeta(h))return console.debug(`Use cache engine: {link(${f})}`),console.debug(e.buildEngineParam),{output:f,metaFile:h};await fs_extra_2.default.remove(f),await fs_extra_2.default.ensureDir(path_2.default.dirname(f));const b={incremental:g,engine:a.path,out:f,moduleFormat:ccBuild.ModuleOption.system,compress:!r,split:e.buildEngineParam.split,ammoJsWasm:e.buildEngineParam.ammoJsWasm,assetURLFormat:e.buildEngineParam.assetURLFormat,noDeprecatedFeatures:c,buildTimeConstants:t,loose:u,features:i,platform:e.buildEngineParam.platform,mode:"BUILD"};console.debug(b),n&&(b.sourceMap=!0),e.buildEngineParam.targets&&(b.targets=e.buildEngineParam.targets);const x=await ccBuild.build(b);if(e.buildEngineParam.split){const e=await stats_query_1.StatsQuery.create(a.path),t=await ccBuild.build.transform(e.evaluateIndexModuleSource(e.getUnitsOfFeatures(i)),ccBuild.ModuleOption.system),r=path_1.join(f,"cc.js");await fs_extra_1.ensureDir(path_1.dirname(r)),await fs_extra_1.writeFile(r,t.code,"utf8"),x.exports.cc="cc.js"}return await fs_extra_1.ensureDir(path_1.dirname(h)),await fs_extra_1.writeJSON(h,x,{spaces:2}),await outputCacheJson(e.buildEngineParam,f),{output:f,metaFile:h}}async function validateCache(e,t){if(!await fs_extra_2.default.pathExists(e))return console.debug(`Engine cache ({link(${e})}) does not exist.`),!1;let a=!1;try{0!==(await fs_extra_2.default.readdir(e)).length&&(a=!0)}catch(e){}return a?!await ccBuild.isSourceChanged(t):(console.warn(`Engine cache directory({link(${e})}) exists but has empty content. It's abnormal.`),!1)}async function isValidMeta(e){if(!await fs_extra_1.pathExists(e))return!1;let t;try{t=await fs_extra_2.default.readJson(e)}catch(e){return!1}if("object"!=typeof t||null===t)return!1;return"object"==typeof t.exports}function calcMd5String(e,t){let a="";for(const i of t)a+=`${i}=${e[i]},`;return a}async function outputCacheJson(e,t){const a=path_1.join(path_1.dirname(t),`${EngineCacheName}.json`);let i={};await fs_extra_1.pathExists(a)&&(i=await fs_extra_1.readJson(a)),(i=i||{})[path_1.basename(t)]=e,await fs_extra_1.outputJSON(a,i)}async function writeImportMapForEngine(e,t,a,i,r){let n;try{n=await fs_extra_2.default.readJson(e)}catch(e){throw new Error(`Failed to read engine export meta, engine might not have been build correctly: ${e}`)}const o=r?new URL(r):void 0;for(const[e,r]of Object.entries(n.exports)){let n;n=o?new URL(r,o).href:`./${Build.Utils.relativeUrl(i,path_2.default.join(t,r))}`,a.imports[e]=n}}