"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectMetricFromAsset=exports.collectMetricFromBundle=exports.collectMetricFromResult=exports.sendBuildMetric=void 0;const cc_1=require("cc"),utils_1=require("./utils"),deprecatedMap={platform:"B100001",gameName:"B100004",packageName:"B100005",scenesNum:"B100006",scriptNum:"B100007",assetsNum:"B100008",includeModules:"B100009",size:"B100010",orientation:"B100011",remoteServerAddress:"B100012",appid:"B100013",dimension:"B100014",meshNum:"B100015",prefabNum:"B100016",designResolution:"B100017",useSplashScreen:"B100018"};function sendBuildMetric(e){e?(Editor.Metrics.trackEvent({category:"Project",action:"Build 3.3",label:e.platform}),Editor.Metrics.trackEvent({category:"Project",action:"Build",label:e.platform}),e[deprecatedMap.includeModules].forEach(e=>{Editor.Metrics.trackEvent({category:"Project",action:"Modules 3.4",label:e})}),e[deprecatedMap.includeModules]=e[deprecatedMap.includeModules].toString(),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:e[deprecatedMap.platform],eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:e[deprecatedMap.gameName],packageName:e[deprecatedMap.packageName]||"",scenes:e[deprecatedMap.scenesNum]+"",scripts:e[deprecatedMap.scriptNum]+"",resources:e[deprecatedMap.assetsNum]+"",moduleConf:e[deprecatedMap.includeModules],size:e[deprecatedMap.size]+"",orientation:e[deprecatedMap.orientation],resUrl:e[deprecatedMap.remoteServerAddress],appd:e[deprecatedMap.appid],dimension:e[deprecatedMap.dimension]}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"buildSystem",value:Object.assign({},e)})):console.debug("send build statistics failed!")}async function collectMetricFromResult(e,c,t){t.B100004=e.name||"",t.B100001=e.platform||"",t.B100006=e.scenes.length,t.B100012=e.server||"",t.B100009=e.includeModules||[];const r=[];r.push(c.paths.assets),r.push(c.paths.remote),r.push(c.paths.settings),r.push(c.paths.subpackages);let o=0;r.forEach(e=>{o+=(0,utils_1.getFileSizeDeep)(e)}),t.B100010=o;const s=await Editor.Profile.getProject("builder","splash-setting");e.useSplashScreen&&s&&(t.B100018=!0),t.B100017=`${e.designResolution.width} X ${e.designResolution.height}`,t.B100014=2===t.B100014&&e.includeModules.includes("3d");try{const c="adsense-h5g-plugin";if(e.packages&&e.packages[c]&&Editor.Package.getPackages({name:c,enable:!0}).length){const t=e.packages[c];t.adsensePropertyCode&&(Editor.Metrics.trackEvent({category:c,action:"adsensePropertyCode",label:t.adsensePropertyCode}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:c,value:{B100001:t.adsensePropertyCode}}))}}catch(e){console.debug(e)}}function collectMetricFromBundle(e,c){creaseMetric("B100008",e.assetsWithoutRedirect.length,c),creaseMetric("B100007",e.scripts.length,c),creaseMetric("B100006",e.scenes.length,c)}async function collectMetricFromAsset(e,c,t){try{if(["cc.SceneAsset","cc.Prefab"].includes(e.type)){"cc.Prefab"===e.type&&creaseMetric("B100016",1,c),collectMetricFromScene(await t.getInstance(e.uuid),c)}"cc.AudioClip"===e.type&&creaseMetric("B100038",1,c)}catch(e){console.debug(e)}}function collectMetricFromScene(e,c){const t=[{key:"B100027_",comps:[cc_1.Collider,cc_1.RigidBody,cc_1.ConstantForce,cc_1.HingeConstraint]},{key:"B100030_",comps:[cc_1.BoxCollider2D,cc_1.CircleCollider2D,cc_1.PolygonCollider2D]},{key:"B100032_",comps:[cc_1.DirectionalLight,cc_1.SphereLight,cc_1.SpotLight,cc_1.AmbientInfo]},{key:"B100040_",comps:[cc_1.ParticleSystem,cc_1.ParticleSystem2D]}],r=e instanceof cc_1.SceneAsset?e.scene:e.data;t.forEach(e=>{collectCompsFromScene(e,r,c)});collectCompPropertiesFromScene({compName:"RigidBody2D",key:"B100029_",properties:["isStatic","isKinematic","isDynamic"]},r,c);if(collectCompPropertyValuesFromScene({compName:"cc.ReflectionProbe",key:"B100041_",property:"probeType",values:[0,1]},r,c),!(e instanceof cc_1.SceneAsset))return;const o=e.scene.globals;o.skybox.enabled&&(creaseMetric("B100034",1,c),o.skybox.useHDR?creaseMetric("B100035_1",1,c):creaseMetric("B100035_2",1,c)),o.fog.enabled&&(creaseMetric("B100037",1,c),creaseMetric(`B100036_${o.fog.type+1}`,1,c))}function collectCompsFromScene(e,c,t){e.comps.forEach((r,o)=>{const s=c.getComponentsInChildren(r);s.length&&creaseMetric(e.key+(o+1),s.length,t)})}function collectCompPropertiesFromScene(e,c,t){c.getComponentsInChildren(e.compName).forEach(c=>{e.properties.forEach((r,o)=>{c[r]&&creaseMetric(e.key+(o+1),1,t)})})}function collectCompPropertyValuesFromScene(e,c,t){c.getComponentsInChildren(e.compName).forEach(c=>{if(void 0!==c[e.property])for(const r of e.values)if(r===c[e.property]){creaseMetric(e.key+r,1,t);break}})}function creaseMetric(e,c=1,t){t[e]||(t[e]=0),t[e]+=c}exports.sendBuildMetric=sendBuildMetric,exports.collectMetricFromResult=collectMetricFromResult,exports.collectMetricFromBundle=collectMetricFromBundle,exports.collectMetricFromAsset=collectMetricFromAsset;