"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectMetricFromAsset=exports.collectMetricFromBundle=exports.collectMetricFromResult=exports.collectCrashMetric=exports.sendSingleMetric=exports.sendBuildMetric=void 0;const cc_1=require("cc"),asset_library_1=require("./manager/asset-library"),utils_1=require("./utils");function sendBuildMetric(e){if(e)try{Editor.Metrics.trackEvent({category:"Project",action:"Build 3.3",label:e.platform}),Editor.Metrics.trackEvent({category:"Project",action:"Build",label:e.platform}),e.B100009.forEach(e=>{Editor.Metrics.trackEvent({category:"Project",action:"Modules 3.4",label:e})}),e.B100009=e.B100009.toString(),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:e.B100001,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:e.B100004,packageName:e.B100005||"",scenes:e.B100006+"",scripts:e.B100007+"",resources:e.B100008+"",moduleConf:e.B100009,size:e.B100010+"",orientation:e.B100011,resUrl:e.B100012,appd:e.B100013,dimension:e.B100014}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"buildSystem",value:Object.assign({},e)})}catch(e){console.debug(e),console.debug("send metric failed!")}else console.debug("send build statistics failed!")}function sendSingleMetric(e){try{Editor.Metrics.trackEvent(e)}catch(t){console.debug(t),console.debug(`send ${e.category||""} metric failed!`)}}function collectCrashMetric(e,t,c,r){e.B100004=c.staticsInfo.B100005||"",e.B100009=c.staticsInfo.B100013||"";let o=0,s=0;r&&r.forEach(e=>{o+=e.assetsWithoutRedirect.length||0,s+=e.scripts.length||0}),e.B100007=o,e.B100006=s}async function collectMetricFromResult(e,t,c){const r=t.staticsInfo;r.B100004=e.name||"",r.B100001=e.platform||"",r.B100006=e.scenes.length,r.B100012=e.server||"",r.B100009=e.includeModules;const o=[];o.push(t.paths.assets),o.push(t.paths.remote),o.push(t.paths.settings),o.push(t.paths.subpackages);let s=0;o.forEach(e=>{s+=(0,utils_1.getFileSizeDeep)(e)}),r.B100010=s;const i=await Editor.Profile.getProject("builder","splash-setting");e.useSplashScreen&&i&&(r.B100018=!0),r.B100017=`${e.designResolution.width} X ${e.designResolution.height}`,r.B100014=2===r.B100014&&e.includeModules.includes("3d");const n={"fd8ec536-a354-4a17-9c74-4f3883c378c8":1,"5d45ba66-829a-46d3-948e-2ed3fa7ee421":2}[e.renderPipeline]||3;r.B100031=n;const l=await Editor.Message.request("engine","query-engine-info");Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"preferences",value:{B100001:"builtin"===l.typescript.type?1:2}});try{const t="adsense-h5g-plugin";if(e.packages&&e.packages[t]&&Editor.Package.getPackages({name:t,enable:!0}).length){const c=e.packages[t];c.adsensePropertyCode&&(Editor.Metrics.trackEvent({category:t,action:"adsensePropertyCode",label:c.adsensePropertyCode}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:t,value:{B100001:c.adsensePropertyCode}}))}c.forEach(e=>{collectMetricFromBundle(e,r)})}catch(e){console.debug(e)}}function collectMetricFromBundle(e,t){creaseMetric("B100008",e.assetsWithoutRedirect.length,t),creaseMetric("B100007",e.scripts.length,t),e.assetsWithoutRedirect.forEach(e=>{const c=asset_library_1.buildAssetLibrary.getAssetInfo(e);c&&collectMetricFromAsset(c,t)})}async function collectMetricFromAsset(e,t){try{if("cc.Mesh"===e.type&&(t.dimension=2,creaseMetric("B100015",1,t)),["cc.SceneAsset","cc.Prefab"].includes(e.type)){"cc.Prefab"===e.type&&creaseMetric("B100016",1,t),collectMetricFromScene(await asset_library_1.buildAssetLibrary.getInstance(e),t)}"cc.AudioClip"===e.type&&creaseMetric("B100038",1,t)}catch(e){console.debug(e)}}function collectMetricFromScene(e,t){const c=[{key:"B100027_",comps:[cc_1.Collider,cc_1.RigidBody,cc_1.ConstantForce,cc_1.HingeConstraint]},{key:"B100030_",comps:[cc_1.BoxCollider2D,cc_1.CircleCollider2D,cc_1.PolygonCollider2D]},{key:"B100032_",comps:[cc_1.DirectionalLight,cc_1.SphereLight,cc_1.SpotLight,cc_1.AmbientInfo]},{key:"B100040_",comps:[cc_1.ParticleSystem,cc_1.ParticleSystem2D]}],r=e instanceof cc_1.SceneAsset?e.scene:e.data;c.forEach(e=>{collectCompsFromScene(e,r,t)});collectCompPropertiesFromScene({compName:"RigidBody2D",key:"B100029_",properties:["isStatic","isKinematic","isDynamic"]},r,t);if(collectCompPropertyValuesFromScene({compName:"cc.ReflectionProbe",key:"B100041_",property:"probeType",values:[0,1]},r,t),!(e instanceof cc_1.SceneAsset))return;const o=e.scene.globals;o.skybox.enabled&&(creaseMetric("B100034",1,t),o.skybox.useHDR?creaseMetric("B100035_1",1,t):creaseMetric("B100035_2",1,t)),o.fog.enabled&&(creaseMetric("B100037",1,t),creaseMetric(`B100036_${o.fog.type+1}`,1,t))}function collectCompsFromScene(e,t,c){e.comps.forEach((r,o)=>{const s=t.getComponentsInChildren(r);s.length&&creaseMetric(e.key+(o+1),s.length,c)})}function collectCompPropertiesFromScene(e,t,c){t.getComponentsInChildren(e.compName).forEach(t=>{e.properties.forEach((r,o)=>{t[r]&&creaseMetric(e.key+(o+1),1,c)})})}function collectCompPropertyValuesFromScene(e,t,c){t.getComponentsInChildren(e.compName).forEach(t=>{if(void 0!==t[e.property])for(const r of e.values)if(r===t[e.property]){creaseMetric(e.key+r,1,c);break}})}function creaseMetric(e,t=1,c){c[e]||(c[e]=0),c[e]+=t}exports.sendBuildMetric=sendBuildMetric,exports.sendSingleMetric=sendSingleMetric,exports.collectCrashMetric=collectCrashMetric,exports.collectMetricFromResult=collectMetricFromResult,exports.collectMetricFromBundle=collectMetricFromBundle,exports.collectMetricFromAsset=collectMetricFromAsset;