"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectMetricFromAsset=exports.collectMetricFromBundle=exports.collectMetricFromResult=exports.sendBuildMetric=void 0;const cc_1=require("cc"),asset_library_1=require("./manager/asset-library"),utils_1=require("./utils");function sendBuildMetric(e){if(e)try{Editor.Metrics.trackEvent({category:"Project",action:"Build 3.3",label:e.platform}),Editor.Metrics.trackEvent({category:"Project",action:"Build",label:e.platform}),e.B100009.forEach(e=>{Editor.Metrics.trackEvent({category:"Project",action:"Modules 3.4",label:e})}),e.B100009=e.B100009.toString(),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToCocosAnalyticsOnly:!0,store:e.B100001,eventId:"ProjectComplete",projectId:Editor.Project.uuid,projectNm:e.B100004,packageName:e.B100005||"",scenes:e.B100006+"",scripts:e.B100007+"",resources:e.B100008+"",moduleConf:e.B100009,size:e.B100010+"",orientation:e.B100011,resUrl:e.B100012,appd:e.B100013,dimension:e.B100014}),Editor.Project.uuid&&Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"buildSystem",value:Object.assign({},e)})}catch(e){console.debug(e),console.debug("send metric failed!")}else console.debug("send build statistics failed!")}async function collectMetricFromResult(e,c,t){const o=c.staticsInfo;o.B100004=e.name||"",o.B100001=e.platform||"",o.B100006=e.scenes.length,o.B100012=e.server||"",o.B100009=e.includeModules;const r=[];r.push(c.paths.assets),r.push(c.paths.remote),r.push(c.paths.settings),r.push(c.paths.subpackages);let s=0;r.forEach(e=>{s+=(0,utils_1.getFileSizeDeep)(e)}),o.B100010=s;const i=await Editor.Profile.getProject("builder","splash-setting");e.useSplashScreen&&i&&(o.B100018=!0),o.B100017=`${e.designResolution.width} X ${e.designResolution.height}`,o.B100014=2===o.B100014&&e.includeModules.includes("3d");try{const c="adsense-h5g-plugin";if(e.packages&&e.packages[c]&&Editor.Package.getPackages({name:c,enable:!0}).length){const t=e.packages[c];t.adsensePropertyCode&&(Editor.Metrics.trackEvent({category:c,action:"adsensePropertyCode",label:t.adsensePropertyCode}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:c,value:{B100001:t.adsensePropertyCode}}))}t.forEach(e=>{collectMetricFromBundle(e,o)})}catch(e){console.debug(e)}}function collectMetricFromBundle(e,c){creaseMetric("B100008",e.assetsWithoutRedirect.length,c),creaseMetric("B100007",e.scripts.length,c),e.assetsWithoutRedirect.forEach(e=>{const t=asset_library_1.buildAssetLibrary.getAssetInfo(e);t&&collectMetricFromAsset(t,c)})}async function collectMetricFromAsset(e,c){try{if("cc.Mesh"===e.type&&(c.dimension=2,creaseMetric("B100015",1,c)),["cc.SceneAsset","cc.Prefab"].includes(e.type)){"cc.Prefab"===e.type&&creaseMetric("B100016",1,c),collectMetricFromScene(await asset_library_1.buildAssetLibrary.getInstance(e),c)}"cc.AudioClip"===e.type&&creaseMetric("B100038",1,c)}catch(e){console.debug(e)}}function collectMetricFromScene(e,c){const t=[{key:"B100027_",comps:[cc_1.Collider,cc_1.RigidBody,cc_1.ConstantForce,cc_1.HingeConstraint]},{key:"B100030_",comps:[cc_1.BoxCollider2D,cc_1.CircleCollider2D,cc_1.PolygonCollider2D]},{key:"B100032_",comps:[cc_1.DirectionalLight,cc_1.SphereLight,cc_1.SpotLight,cc_1.AmbientInfo]},{key:"B100040_",comps:[cc_1.ParticleSystem,cc_1.ParticleSystem2D]}],o=e instanceof cc_1.SceneAsset?e.scene:e.data;t.forEach(e=>{collectCompsFromScene(e,o,c)});collectCompPropertiesFromScene({compName:"RigidBody2D",key:"B100029_",properties:["isStatic","isKinematic","isDynamic"]},o,c);if(collectCompPropertyValuesFromScene({compName:"cc.ReflectionProbe",key:"B100041_",property:"probeType",values:[0,1]},o,c),!(e instanceof cc_1.SceneAsset))return;const r=e.scene.globals;r.skybox.enabled&&(creaseMetric("B100034",1,c),r.skybox.useHDR?creaseMetric("B100035_1",1,c):creaseMetric("B100035_2",1,c)),r.fog.enabled&&(creaseMetric("B100037",1,c),creaseMetric(`B100036_${r.fog.type+1}`,1,c))}function collectCompsFromScene(e,c,t){e.comps.forEach((o,r)=>{const s=c.getComponentsInChildren(o);s.length&&creaseMetric(e.key+(r+1),s.length,t)})}function collectCompPropertiesFromScene(e,c,t){c.getComponentsInChildren(e.compName).forEach(c=>{e.properties.forEach((o,r)=>{c[o]&&creaseMetric(e.key+(r+1),1,t)})})}function collectCompPropertyValuesFromScene(e,c,t){c.getComponentsInChildren(e.compName).forEach(c=>{if(void 0!==c[e.property])for(const o of e.values)if(o===c[e.property]){creaseMetric(e.key+o,1,t);break}})}function creaseMetric(e,c=1,t){t[e]||(t[e]=0),t[e]+=c}exports.sendBuildMetric=sendBuildMetric,exports.collectMetricFromResult=collectMetricFromResult,exports.collectMetricFromBundle=collectMetricFromBundle,exports.collectMetricFromAsset=collectMetricFromAsset;