"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildLibrary=exports.buildAssetLibrary=void 0;const EditorExtends=require("@base/electron-module").require("EditorExtends"),fs_extra_1=require("fs-extra"),index_1=require("../utils/index"),path_1=require("path"),serialization_1=require("cc/editor/serialization"),cconb_utils_1=require("./cconb-utils"),cc_1=require("cc"),CACHE_VERSION="1.0.1";class BuildAssetLibrary{constructor(){this.asset={},this.depend={},this.meta={},this.cacheTempDir=(0,path_1.join)(Editor.Project.tmpDir,"asset-db"),this.assetMtimeCache={},this.assetMtimeCacheFile=(0,path_1.join)(Editor.Project.tmpDir,"builder","assets-mtime.json"),this.useCache=!0,this.hasMissingClassUuids=new Set,this.hasMissingAsssetsUuids=new Set,this.scriptChanged=!1,this.pathToUuid={},this.defaultSerializedOptions={compressUuid:!0,stringify:!1,dontStripDefault:!1,useCCON:!1,keepNodeUuid:!1}}async initMtimeCache(){if((0,fs_extra_1.existsSync)(this.assetMtimeCacheFile))try{this.assetMtimeCache=await(0,fs_extra_1.readJSON)(this.assetMtimeCacheFile)||{}}catch(e){}}async saveMtimeCache(){await(0,fs_extra_1.outputJSON)(this.assetMtimeCacheFile,this.assetMtimeCache)}async init(){this.reset(),this.defaultSerializedOptions.keepNodeUuid=!!await Editor.Profile.getConfig("builder","serializedOptions.keepNodeUuid"),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache"),console.debug(`init custom config: keepNodeUuid: ${this.defaultSerializedOptions.keepNodeUuid}, useCache: ${this.useCache}`);const e=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAllAssets"});console.debug(`BuildAssetLibrary query-assets with assets ${e.length}`);for(let s=0;s<e.length;s++)"cc.Script"===e[s].type&&e[s].dirty&&(this.scriptChanged=!0),this.addAsset(e[s]);console.debug(`BuildAssetLibrary initialized with asset ${Object.keys(this.asset).length}!`)}getAssetTempDirByUuid(e){if(!this.asset[e].temp){const s=this.asset[e].url.match(/db:\/\/([^/]*)/)[1];this.asset[e].temp=(0,path_1.join)(this.cacheTempDir,s,e.substr(0,2),e,"build"+CACHE_VERSION)}return this.asset[e].temp}addAsset(e){(0,index_1.recursively)(e,e=>{this.asset[e.uuid]=e,e.dirty=e.mtime===this.assetMtimeCache[e.uuid],e.temp||(e.temp=this.getAssetTempDirByUuid(e.uuid))})}clearAsset(e){const s=this.getAssetTempDirByUuid(e);s&&(0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.removeSync)(s),delete this.asset[e],delete this.depend[e],delete this.meta[e],Object.keys(this.depend).forEach(e=>{const s=this.depend[e];s.includes(e)&&s.splice(0,s.indexOf(e))})}async getMeta(e){return void 0!==this.meta[e]?this.meta[e]:(this.meta[e]=await Editor.Message.request("asset-db","query-asset-meta",e),this.meta[e])}async getAssetInfo(e){return void 0!==this.asset[e]?this.asset[e]:(this.asset[e]=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAssetInfo",args:[e]}),this.asset[e])}async getDependUuids(e){const s=this.asset[e];if(!s)return[];if(this.depend[e])return this.depend[e];const t=this.checkUseCache(s),i=(0,path_1.join)(this.getAssetTempDirByUuid(s.uuid),"depend.json");try{if(t&&(0,fs_extra_1.existsSync)(i)){const e=await(0,fs_extra_1.readJSON)(i);this.depend[s.uuid]=(null===e||void 0===e?void 0:e.depend)||[]}}catch(e){console.debug(e)}if(this.depend[e])return this.depend[e];if(await this.getRawInstance(s),t){try{await(0,fs_extra_1.outputJSON)(i,{depend:this.depend[e]},{spaces:4})}catch(e){console.debug(e)}s.mtime&&(this.assetMtimeCache[s.uuid]=s.mtime)}return this.depend[e]||[]}async getInstance(e){if(!e)return[];return(await this.getRawInstance(e)).asset}async getSerializedJSON(e,s){const t=this.asset[e];if(!t||!t.library[".json"])return null;const i=(0,path_1.join)(this.getAssetTempDirByUuid(e),`${s.debug?"debug":"release"}.json`);if(this.checkUseCache(t)&&(0,fs_extra_1.existsSync)(i)){console.debug(`getSerializedJSON: Use cache serialized JSON of asset ({asset(${t.url})})`);try{return await(0,fs_extra_1.readJSON)(i)}catch(e){console.debug(e),console.debug(`get cacheFile in ${i} failed!`)}}else await(0,fs_extra_1.remove)(i);const a=await this.getRawInstance(t);if(!a.asset)return null;if(t.type&&"cc.SceneAsset"===t.type){const e=a.asset.scene.children||[];for(let s=0;s<e.length;s++){const t=e[s].getComponent(cc.LightComponent);if(t&&t.staticSettings){t.staticSettings.editorOnly&&(e.splice(s,1),s--)}}}const r=this.serialize(a.asset,s);return this.checkCanSaveCache(t)&&((0,fs_extra_1.outputJSON)(i,r,{spaces:4}),t.mtime&&(this.assetMtimeCache[t.uuid]=t.mtime)),r}async outputAssets(e,s,t){const i=(0,path_1.join)(this.getAssetTempDirByUuid(e),`${t?"debug":"release"}.json`);try{if(this.checkCanSaveCache(this.asset[e]))return void await(0,fs_extra_1.copy)(i,s)}catch(e){console.debug(e)}const a=this.getSerializedJSON(e,{debug:t});a&&(await(0,fs_extra_1.outputJSON)(i,a),(0,fs_extra_1.copy)(i,s))}async outputCCONBAssets(e,s,t){const i=await this.getRawInstance(this.asset[e]);if(!i||!i.asset)return void console.error(`get instance (${e}) failed!`);const a=exports.buildAssetLibrary.serialize(i.asset,{debug:t.debug,useCCONB:!0,dontStripDefault:!1,_exporting:!0});await(0,fs_extra_1.outputFile)(s,(0,serialization_1.encodeCCONBinary)(a))}async outputCCONAssets(e,s,t){const i=await this.getRawInstance(this.asset[e]);if(!i||!i.asset)return void console.error(`get instance (${e}) failed!`);const a=exports.buildAssetLibrary.serialize(i.asset,{debug:t.debug,useCCONB:!0}),r=s.replace(/.cconb$/,".json"),n=a.chunks.map(()=>".bin");if(await(0,fs_extra_1.outputJSON)(r,(0,serialization_1.encodeCCONJson)(a,n)),a.chunks.length){const e=s.replace(/.cconb$/,".bin");await(0,fs_extra_1.outputFile)(e,a.chunks[0])}}serialize(e,s){return e?(s.useCCONB?EditorExtends.serialize:EditorExtends.serializeCompiled)(e,Object.assign(this.defaultSerializedOptions,{compressUuid:!s.debug,useCCON:s.useCCONB,noNativeDep:!e._native})):null}async getRawInstance(e){const s={asset:null,detail:null};if(e.invalid)return console.error(Editor.I18n.t("builder.error.asset_import_failed",{url:`{asset(${e.url})}`,type:e.type})),s;const t=e.library[".json"],i=e.library[".cconb"];if(!t&&!i)return console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:e.type})),s;const a=t?await(0,fs_extra_1.readJSON)(t):await(0,cconb_utils_1.transformCCON)(i);return this.getRawInstanceFromData(a,e)}getRawInstanceFromData(e,s){const t={asset:null,detail:null},i=new cc.deserialize.Details;i.reset();const a=EditorExtends.MissingReporter.classInstance;a.hasMissingClass=!1;const r=(0,cc_1.deserialize)(e,i,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:a.classFinder});if(!r)return console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${s.url})}`})),t;r._uuid=s.uuid,a.hasMissingClass&&!this.hasMissingClassUuids.has(s.uuid)&&(a.reportMissingClass(r),this.hasMissingClassUuids.add(s.uuid)),a.reset();const n=this;let d=null;return i.assignAssetsBy(function(e,s){return n.asset[e]?EditorExtends.serialize.asAsset(e):(n.hasMissingAsssetsUuids.add(e),s&&s.owner&&((d=d||new EditorExtends.MissingReporter.object(r)).outputLevel="warn",d.stashByOwner(s.owner,s.prop,EditorExtends.serialize.asAsset(e,s.type))),null)}),d&&d.reportByOwner(),["cc.SceneAsset","cc.Prefab"].includes(s.type)&&(r.name=(0,path_1.basename)(s.source,(0,path_1.extname)(s.source))),t.asset=r,t.detail=i,this.depend[s.uuid]=[...new Set(i.uuidList)],t}reset(){this.meta={},this.asset={},this.depend={},this.scriptChanged=!1,this.hasMissingClassUuids.clear(),this.hasMissingAsssetsUuids.clear()}checkUseCache(e){return!(!this.useCache||["cc.SceneAsset"].includes(e.type)&&this.scriptChanged||e.dirty)}checkCanSaveCache(e){return!this.hasMissingClassUuids.has(e.uuid)&&!this.hasMissingClassUuids.has(e.uuid)}}function saveReadJSONSync(e){if(!(0,fs_extra_1.existsSync)(e))return null;try{return(0,fs_extra_1.readJSONSync)(e)}catch(e){console.warn(e)}return null}exports.buildAssetLibrary=new BuildAssetLibrary,exports.buildLibrary={getAssetInfo:exports.buildAssetLibrary.getAssetInfo,getSerializedJSON:exports.buildAssetLibrary.getSerializedJSON,getInstance:exports.buildAssetLibrary.getInstance,getMeta:exports.buildAssetLibrary.getMeta,getDependUuids:exports.buildAssetLibrary.getDependUuids,serialize:exports.buildAssetLibrary.serialize};