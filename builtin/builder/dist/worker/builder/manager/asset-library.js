"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildLibrary=exports.buildAssetLibrary=void 0;const fs_extra_1=require("fs-extra"),index_1=require("../utils/index"),path_1=require("path");class BuildAssetLibrary{constructor(){this.asset={},this.depend={},this.meta={},this.cacheTempDir=path_1.join(Editor.Project.tmpDir,"asset-db"),this.useCache=!0,this.pathToUuid={}}async init(){this.reset(),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache");const e=await Editor.Message.request("asset-db","query-assets");for(let s=0;s<e.length;s++)e[s].isDirectory||"database"===e[s].importer||this.addAsset(e[s]);console.debug(`BuildAssetLibrary initialized with asset ${Object.keys(this.asset).length}!`)}getAssetTempDirByUuid(e){if(!this.asset[e].temp){const s=this.asset[e].url.match(/db:\/\/([^\/]*)/)[1];this.asset[e].temp=path_1.join(this.cacheTempDir,s,e.substr(0,2),e,"build")}return this.asset[e].temp}addAsset(e){index_1.recursively(e,e=>{this.asset[e.uuid]=e,e.temp||(e.temp=this.getAssetTempDirByUuid(e.uuid))})}clearAsset(e){const s=this.getAssetTempDirByUuid(e);s&&fs_extra_1.existsSync(s)&&fs_extra_1.removeSync(s),delete this.asset[e],delete this.depend[e],delete this.meta[e],Object.keys(this.depend).forEach(e=>{const s=this.depend[e];s.includes(e)&&s.splice(0,s.indexOf(e))})}async getMeta(e){return void 0!==this.meta[e]?this.meta[e]:(this.meta[e]=await Editor.Message.request("asset-db","query-asset-meta",e),this.meta[e])}async getAssetInfo(e){return void 0!==this.asset[e]?this.asset[e]:(this.asset[e]=await Editor.Message.request("asset-db","query-asset-info",e),this.asset[e])}async getDependUuids(e){const s=this.asset[e];if(!s)return[];if(this.depend[e])return this.depend[e];const t=path_1.join(this.getAssetTempDirByUuid(e),"depend.json");if(this.useCache&&fs_extra_1.existsSync(t))try{const s=await fs_extra_1.readJSON(t);this.depend[e]=(null===s||void 0===s?void 0:s.depend)||[]}catch(e){console.warn(e)}return this.depend[e]?this.depend[e]:(await this.getRawInstance(s),this.useCache&&await fs_extra_1.outputJSON(t,{depend:this.depend[e]},{spaces:4}),this.depend[e]||[])}async getInstance(e){if(!e)return[];return(await this.getRawInstance(e)).asset}async getSerializedJSON(e,s){const t=this.asset[e];if(!t)return null;const i=path_1.join(this.getAssetTempDirByUuid(e),`${s?"debug":"release"}.json`);if(this.useCache&&fs_extra_1.existsSync(i))return console.debug(`getSerializedJSON: Use cache serialized JSON of asset ({asset(${t.url})})`),await fs_extra_1.readJSON(i);const r=await this.getRawInstance(t);if(!r.asset)return null;const a=this.serialize(r.asset,s);return fs_extra_1.outputJSON(i,a,{spaces:4}),a}async outputAssets(e,s,t){const i=path_1.join(this.getAssetTempDirByUuid(e),`${t?"debug":"release"}.json`);if(this.useCache&&fs_extra_1.existsSync(i))return void await fs_extra_1.copy(i,s);const r=this.getSerializedJSON(e,t);r&&(await fs_extra_1.outputJSON(i,r),fs_extra_1.copy(i,s))}serialize(e,s){return e?EditorExtends.serializeCompiled(e,{compressUuid:!s,stringify:!1,dontStripDefault:!1}):null}async getRawInstance(e){const s={asset:null,detail:null};if(e.invalid)return console.error(Editor.I18n.t("builder.error.asset_import_failed",{url:`{asset(${e.url})}`,type:e.type})),s;if(!e.library[".json"])return console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:e.type})),s;const t=new cc.deserialize.Details;t.reset();const i=EditorExtends.MissingReporter.classInstance;i.hasMissingClass=!1;const r=await fs_extra_1.readJSON(e.library[".json"]);if(!r)return s;const a=cc.deserialize(r,t,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:i.classFinder});if(!a)return console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${e.url})}`})),s;i.hasMissingClass&&i.reportMissingClass(e),a._uuid=e.uuid,i.reset();const n=[];return t.assignAssetsBy(e=>{return this.asset[e]?EditorExtends.serialize.asAsset(e):(n.includes(e)&&n.push(e),null)}),n.length>0&&console.warn(Editor.I18n.t("builder.error.required_asset_missing",{url:`{asset(${e.url})}`,uuid:n.join("\n ")})),["cc.SceneAsset","cc.Prefab"].includes(e.type)&&(a.name=path_1.basename(e.source,path_1.extname(e.source))),s.asset=a,s.detail=t,this.depend[e.uuid]=[...new Set(t.uuidList)],s}reset(){this.meta={},this.asset={},this.depend={}}}function saveReadJSONSync(e){if(!fs_extra_1.existsSync(e))return null;try{return fs_extra_1.readJSONSync(e)}catch(e){console.warn(e)}return null}exports.buildAssetLibrary=new BuildAssetLibrary,exports.buildLibrary={getAssetInfo:exports.buildAssetLibrary.getAssetInfo,getSerializedJSON:exports.buildAssetLibrary.getSerializedJSON,getInstance:exports.buildAssetLibrary.getInstance,getMeta:exports.buildAssetLibrary.getMeta,getDependUuids:exports.buildAssetLibrary.getDependUuids,assetPathToUUID(){}};