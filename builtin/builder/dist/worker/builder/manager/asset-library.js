"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildLibrary=exports.buildAssetLibrary=void 0;const EditorExtends=require("@base/electron-module").require("EditorExtends"),fs_extra_1=require("fs-extra"),index_1=require("../utils/index"),path_1=require("path"),serialization_1=require("cc/editor/serialization"),cconb_utils_1=require("./cconb-utils"),CACHE_VERSION="1.0.1";class BuildAssetLibrary{constructor(){this.asset={},this.depend={},this.meta={},this.cacheTempDir=path_1.join(Editor.Project.tmpDir,"asset-db"),this.assetMtimeCache={},this.assetMtimeCacheFile=path_1.join(Editor.Project.tmpDir,"builder","assets-mtime.json"),this.useCache=!0,this.hasMissingClassUuids=new Set,this.hasMissingAsssetsUuids=new Set,this.scriptChanged=!1,this.pathToUuid={}}async initMtimeCache(){if(fs_extra_1.existsSync(this.assetMtimeCacheFile))try{this.assetMtimeCache=await fs_extra_1.readJSON(this.assetMtimeCacheFile)||{}}catch(e){}}async saveMtimeCache(){await fs_extra_1.outputJSON(this.assetMtimeCacheFile,this.assetMtimeCache)}async init(){this.reset(),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache");const e=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAllAssets"});console.debug(`BuildAssetLibrary query-assets with assets ${e.length}`);for(let s=0;s<e.length;s++)"cc.Script"===e[s].type&&e[s].dirty&&(this.scriptChanged=!0),this.addAsset(e[s]);console.debug(`BuildAssetLibrary initialized with asset ${Object.keys(this.asset).length}!`)}getAssetTempDirByUuid(e){if(!this.asset[e].temp){const s=this.asset[e].url.match(/db:\/\/([^\/]*)/)[1];this.asset[e].temp=path_1.join(this.cacheTempDir,s,e.substr(0,2),e,"build"+CACHE_VERSION)}return this.asset[e].temp}addAsset(e){index_1.recursively(e,e=>{this.asset[e.uuid]=e,e.dirty=e.mtime===this.assetMtimeCache[e.uuid],e.temp||(e.temp=this.getAssetTempDirByUuid(e.uuid))})}clearAsset(e){const s=this.getAssetTempDirByUuid(e);s&&fs_extra_1.existsSync(s)&&fs_extra_1.removeSync(s),delete this.asset[e],delete this.depend[e],delete this.meta[e],Object.keys(this.depend).forEach(e=>{const s=this.depend[e];s.includes(e)&&s.splice(0,s.indexOf(e))})}async getMeta(e){return void 0!==this.meta[e]?this.meta[e]:(this.meta[e]=await Editor.Message.request("asset-db","query-asset-meta",e),this.meta[e])}async getAssetInfo(e){return void 0!==this.asset[e]?this.asset[e]:(this.asset[e]=await Editor.Message.request("asset-db","execute-script",{name:"builder",method:"queryAssetInfo",args:[e]}),this.asset[e])}async getDependUuids(e){const s=this.asset[e];if(!s)return[];if(this.depend[e])return this.depend[e];const t=path_1.join(this.getAssetTempDirByUuid(e),"depend.json");if(this.checkUseCache(s)&&fs_extra_1.existsSync(t))try{const s=await fs_extra_1.readJSON(t);this.depend[e]=(null===s||void 0===s?void 0:s.depend)||[]}catch(e){console.warn(e)}else await fs_extra_1.remove(t);return this.depend[e]?this.depend[e]:(await this.getRawInstance(s),this.checkCanSaveCache(s)&&(await fs_extra_1.outputJSON(t,{depend:this.depend[e]},{spaces:4}),s.mtime&&(this.assetMtimeCache[s.uuid]=s.mtime)),this.depend[e]||[])}async getInstance(e){if(!e)return[];return(await this.getRawInstance(e)).asset}async getSerializedJSON(e,s){const t=this.asset[e];if(!t||!t.library[".json"])return null;const i=path_1.join(this.getAssetTempDirByUuid(e),`${s.debug?"debug":"release"}.json`);if(this.checkUseCache(t)&&fs_extra_1.existsSync(i))return console.debug(`getSerializedJSON: Use cache serialized JSON of asset ({asset(${t.url})})`),await fs_extra_1.readJSON(i);await fs_extra_1.remove(i);const a=await this.getRawInstance(t);if(!a.asset)return null;const r=this.serialize(a.asset,s);return this.checkCanSaveCache(t)&&(fs_extra_1.outputJSON(i,r,{spaces:4}),t.mtime&&(this.assetMtimeCache[t.uuid]=t.mtime)),r}async outputAssets(e,s,t){const i=path_1.join(this.getAssetTempDirByUuid(e),`${t?"debug":"release"}.json`);if(this.checkCanSaveCache(this.asset[e]))return void await fs_extra_1.copy(i,s);const a=this.getSerializedJSON(e,{debug:t});a&&(await fs_extra_1.outputJSON(i,a),fs_extra_1.copy(i,s))}async outputCCONAssets(e,s,t){const i=await this.getRawInstance(this.asset[e]);if(!i||!i.asset)return void console.error(`get instance (${e}) failed!`);const a=exports.buildAssetLibrary.serialize(i.asset,{debug:t.debug,useCCONB:!0}),r=s.replace(/.cconb$/,".json"),n=a.chunks.map(()=>".bin");if(await fs_extra_1.outputJSON(r,serialization_1.encodeCCONJson(a,n)),a.chunks.length){const e=s.replace(/.cconb$/,".bin");await fs_extra_1.outputFile(e,a.chunks[0])}}serialize(e,s){return e?(s.useCCONB?EditorExtends.serialize:EditorExtends.serializeCompiled)(e,{compressUuid:!s.debug,stringify:!1,dontStripDefault:!1,useCCON:s.useCCONB,noNativeDep:!e._native}):null}async getRawInstance(e){const s={asset:null,detail:null};if(e.invalid)return console.error(Editor.I18n.t("builder.error.asset_import_failed",{url:`{asset(${e.url})}`,type:e.type})),s;const t=e.library[".json"],i=e.library[".cconb"];if(!t&&!i)return console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:e.type})),s;const a=t?await fs_extra_1.readJSON(t):await cconb_utils_1.transformCCON(i);return this.getRawInstanceFromData(a,e)}getRawInstanceFromData(e,s){const t={asset:null,detail:null},i=new cc.deserialize.Details;i.reset();const a=EditorExtends.MissingReporter.classInstance;a.hasMissingClass=!1;const r=cc.deserialize(e,i,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:a.classFinder});return r?(r._uuid=s.uuid,a.hasMissingClass&&!this.hasMissingClassUuids.has(s.uuid)&&(a.reportMissingClass(r),this.hasMissingClassUuids.add(s.uuid)),a.reset(),i.assignAssetsBy(e=>{return this.asset[e]?EditorExtends.serialize.asAsset(e):(this.hasMissingAsssetsUuids.add(e),null)}),["cc.SceneAsset","cc.Prefab"].includes(s.type)&&(r.name=path_1.basename(s.source,path_1.extname(s.source))),t.asset=r,t.detail=i,this.depend[s.uuid]=[...new Set(i.uuidList)],t):(console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${s.url})}`})),t)}reset(){this.meta={},this.asset={},this.depend={},this.scriptChanged=!1,this.hasMissingClassUuids.clear(),this.hasMissingAsssetsUuids.clear()}checkUseCache(e){return!(!this.useCache||["cc.SceneAsset"].includes(e.type)&&this.scriptChanged||e.dirty)}checkCanSaveCache(e){return!this.hasMissingClassUuids.has(e.uuid)&&!this.hasMissingClassUuids.has(e.uuid)}}function saveReadJSONSync(e){if(!fs_extra_1.existsSync(e))return null;try{return fs_extra_1.readJSONSync(e)}catch(e){console.warn(e)}return null}exports.buildAssetLibrary=new BuildAssetLibrary,exports.buildLibrary={getAssetInfo:exports.buildAssetLibrary.getAssetInfo,getSerializedJSON:exports.buildAssetLibrary.getSerializedJSON,getInstance:exports.buildAssetLibrary.getInstance,getMeta:exports.buildAssetLibrary.getMeta,getDependUuids:exports.buildAssetLibrary.getDependUuids,serialize:exports.buildAssetLibrary.serialize};