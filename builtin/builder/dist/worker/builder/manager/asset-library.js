"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildLibrary=exports.buildAssetLibrary=void 0;const fs_extra_1=require("fs-extra"),index_1=require("../utils/index"),path_1=require("path"),Editor=__importStar(require("editor"));class BuildAssetLibrary{constructor(){this.asset={},this.depend={},this.meta={},this.cacheTempDir=path_1.join(Editor.Project.tmpDir,"asset-db"),this.useCache=!0,this.pathToUuid={}}async init(){this.reset(),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache");const e=await Editor.Message.request("asset-db","query-assets");for(let t=0;t<e.length;t++)e[t].isDirectory||"database"===e[t].importer||this.addAsset(e[t]);console.debug(`BuildAssetLibrary initialized with asset ${Object.keys(this.asset).length}!`)}getAssetTempDirByUuid(e){if(!this.asset[e].temp){const t=this.asset[e].url.match(/db:\/\/([^\/]*)/)[1];this.asset[e].temp=path_1.join(this.cacheTempDir,t,e.substr(0,2),e,"build")}return this.asset[e].temp}addAsset(e){index_1.recursively(e,e=>{this.asset[e.uuid]=e,e.temp||(e.temp=this.getAssetTempDirByUuid(e.uuid))})}clearAsset(e){const t=this.getAssetTempDirByUuid(e);t&&fs_extra_1.existsSync(t)&&fs_extra_1.removeSync(t),delete this.asset[e],delete this.depend[e],delete this.meta[e],Object.keys(this.depend).forEach(e=>{const t=this.depend[e];t.includes(e)&&t.splice(0,t.indexOf(e))})}async getMeta(e){return void 0!==this.meta[e]?this.meta[e]:(this.meta[e]=await Editor.Message.request("asset-db","query-asset-meta",e),this.meta[e])}async getAssetInfo(e){return void 0!==this.asset[e]?this.asset[e]:(this.asset[e]=await Editor.Message.request("asset-db","query-asset-info",e),this.asset[e])}async getDependUuids(e){const t=this.asset[e];if(!t)return[];if(this.depend[e])return this.depend[e];const s=path_1.join(this.getAssetTempDirByUuid(e),"depend.json");if(this.useCache&&fs_extra_1.existsSync(s))try{const t=await fs_extra_1.readJSON(s);this.depend[e]=(null===t||void 0===t?void 0:t.depend)||[]}catch(e){console.warn(e)}return this.depend[e]?this.depend[e]:(await this.getRawInstance(t),this.useCache&&await fs_extra_1.outputJSON(s,{depend:this.depend[e]},{spaces:4}),this.depend[e]||[])}async getInstance(e){if(!e)return[];return(await this.getRawInstance(e)).asset}async getSerializedJSON(e,t){const s=this.asset[e];if(!s)return null;const i=path_1.join(this.getAssetTempDirByUuid(e),`${t?"debug":"release"}.json`);if(this.useCache&&fs_extra_1.existsSync(i))return console.debug(`getSerializedJSON: Use cache serialized JSON of asset ({asset(${s.url})})`),await fs_extra_1.readJSON(i);const r=await this.getRawInstance(s);if(!r.asset)return null;const a=this.serialize(r.asset,t);return fs_extra_1.outputJSON(i,a,{spaces:4}),a}async outputAssets(e,t,s){const i=path_1.join(this.getAssetTempDirByUuid(e),`${s?"debug":"release"}.json`);if(this.useCache&&fs_extra_1.existsSync(i))return void await fs_extra_1.copy(i,t);const r=this.getSerializedJSON(e,s);r&&(await fs_extra_1.outputJSON(i,r),fs_extra_1.copy(i,t))}serialize(e,t){return e?EditorExtends.serializeCompiled(e,{compressUuid:!t,stringify:!1,dontStripDefault:!1}):null}async getRawInstance(e){const t={asset:null,detail:null};if(!e.library[".json"])return console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:e.type})),t;const s=new cc.deserialize.Details;s.reset();const i=EditorExtends.MissingReporter.classInstance;i.hasMissingClass=!1;const r=await fs_extra_1.readJSON(e.library[".json"]);if(!r)return t;const a=cc.deserialize(r,s,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:i.classFinder});if(!a)return console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${e.url})}`})),t;i.hasMissingClass&&i.reportMissingClass(e),a._uuid=e.uuid,i.reset();const n=[];return s.assignAssetsBy(e=>{return this.asset[e]?EditorExtends.serialize.asAsset(e):(n.includes(e)&&n.push(e),null)}),n.length>0&&console.warn(Editor.I18n.t("builder.error.required_asset_missing",{url:`{asset(${e.url})}`,uuid:n.join("\n ")})),["cc.SceneAsset","cc.Prefab"].includes(e.type)&&(a.name=path_1.basename(e.source,path_1.extname(e.source))),t.asset=a,t.detail=s,this.depend[e.uuid]=[...new Set(s.uuidList)],t}reset(){this.meta={},this.asset={},this.depend={}}}function saveReadJSONSync(e){if(!fs_extra_1.existsSync(e))return null;try{return fs_extra_1.readJSONSync(e)}catch(e){console.warn(e)}return null}exports.buildAssetLibrary=new BuildAssetLibrary,exports.buildLibrary={getAssetInfo:exports.buildAssetLibrary.getAssetInfo,getSerializedJSON:exports.buildAssetLibrary.getSerializedJSON,getInstance:exports.buildAssetLibrary.getInstance,getMeta:exports.buildAssetLibrary.getMeta,getDependUuids:exports.buildAssetLibrary.getDependUuids,assetPathToUUID(){}};