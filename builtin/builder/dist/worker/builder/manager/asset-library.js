"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildAssetLibrary=void 0,exports.requestAssetLibrary=requestAssetLibrary;const EditorExtends=require("@base/electron-module").require("EditorExtends"),fs_extra_1=require("fs-extra"),path_1=require("path"),serialization_1=require("cc/editor/serialization"),cconb_utils_1=require("./cconb-utils"),cc_1=require("cc"),utils_1=require("../../../share/utils"),utils_2=require("../utils"),assert_1=__importDefault(require("assert")),cconb_1=require("../utils/cconb"),render_1=require("@editor/sentry/render"),CACHE_VERSION="1.0.1";class BuildAssetLibrary{assetMap={};assetPropertyMap=new WeakMap;get assets(){var e=Object.values(this.assetMap);return e.length?e:(this.queryAllAssets(),Object.values(this.assetMap))}depend={};dependedMap={};meta={};cacheTempDir=(0,path_1.join)(Editor.Project.tmpDir,"asset-db");assetMtimeCache={};assetMtimeCacheFile=(0,path_1.join)(Editor.Project.tmpDir,"builder","assets-mtime.json");useCache=!0;hasMissingClassUuids=new Set;hasMissingAssetsUuids=new Set;pathToUuid={};defaultSerializedOptions={compressUuid:!0,stringify:!1,dontStripDefault:!1,useCCON:!1,keepNodeUuid:!1};async initMtimeCache(){if((0,fs_extra_1.existsSync)(this.assetMtimeCacheFile))try{this.assetMtimeCache=await(0,fs_extra_1.readJSON)(this.assetMtimeCacheFile)||{}}catch(e){}}async saveMtimeCache(){await(0,fs_extra_1.outputJSON)(this.assetMtimeCacheFile,this.assetMtimeCache)}async init(){this.queryAllAssets(),this.defaultSerializedOptions.keepNodeUuid=!!await Editor.Profile.getConfig("builder","serializedOptions.keepNodeUuid"),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache"),console.debug(`init custom config: keepNodeUuid: ${this.defaultSerializedOptions.keepNodeUuid}, useCache: `+this.useCache),await this.initMtimeCache()}queryAllAssets(){console.time("queryAllAssets");const s={};var e=Manager.assetDBManager.assetDBMap;for(const t in e)for(const a of e[t].uuid2asset.values())(0,utils_2.recursively)(a,e=>{s[e.uuid]=e});return this.assetMap=s,console.timeEnd("queryAllAssets"),this.assets}getAssetTempDirByUuid(e){var s=this.getAsset(e)._assetDB.options.name;return(0,path_1.join)(this.cacheTempDir,s,e.substr(0,2),e,"build"+CACHE_VERSION)}clearAsset(e){var s=this.getAssetTempDirByUuid(e);s&&(0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.removeSync)(s),delete this.depend[e],Object.keys(this.depend).forEach(e=>{var s=this.depend[e];s.includes(e)&&s.splice(0,s.indexOf(e))})}getMeta(e){return void 0!==this.meta[e]?this.meta[e]:this.meta[e]=Manager.assetManager.queryAssetMeta(e)}addMeta(e,s){s&&(this.meta[e]=s)}getAssetInfo(e,s=["subAssets","mtime","meta","depends"]){return Manager.assetManager.queryAssetInfo(e,s)}getAsset(e){return this.assetMap[e]||Manager.assetManager.queryAsset(e)}queryAssetsByOptions(e){return Manager.assetManager.queryAssets(e)}async queryAssetUsers(e){return this.dependedMap[e]||(this.dependedMap[e]=await Manager.assetManager.queryAssetUsers(e)||[]),this.dependedMap[e]}url2uuid(e){return Manager.Utils.url2uuid(e)}getAssetProperty(e,s){return Manager.assetManager.queryAssetProperty(e,s)}async getDependUuids(e){var s;return this.depend[e]||((s=this.getAsset(e))?["cc.SceneAsset","cc.Prefab"].includes(Manager.assetManager.queryAssetProperty(s,"type"))?(await this.getRawInstance(s),this.depend[e]||[]):(this.depend[e]=await Manager.assetManager.queryAssetDependencies(e)||[],this.depend[e]):[])}async getDependUuidsDeep(e){let s=[],t=[];e=await this.getDependUuids(e);if(!e)return[];t=[...e],s=[...e];do{var a=[];for(const r of t){var i=await this.getDependUuids(r);a.push(...i)}t=a.filter(e=>!s.includes(e)),s.push(...t)}while(0<t.length);return Array.from(new Set(s))}async getInstance(e){return e?(await this.getRawInstance(e)).asset:null}async getSerializedJSON(e,s){var t=this.getAsset(e);if(!t||!t.meta.files.includes(".json"))return null;e=(0,path_1.join)(this.getAssetTempDirByUuid(e),`${s.debug?"debug":"release"}.json`);if(this.checkUseCache(t)&&(0,fs_extra_1.existsSync)(e))try{return await(0,fs_extra_1.readJSON)(e)}catch(e){unExpectException(e)}var a=await this.getRawInstance(t);if(!a.asset)return console.error(Editor.I18n.t("builder.error.get_asset_json_failed",{url:t.url,type:exports.buildAssetLibrary.getAssetProperty(t,"type")})),null;a=this.serialize(a.asset,s);try{this.checkCanSaveCache(t.uuid)&&(await(0,fs_extra_1.outputJSON)(e,a,{spaces:4}),this.assetMtimeCache[t.uuid]=Manager.assetManager.queryAssetProperty(t,"mtime"))}catch(e){unExpectException(e)}return a}async outputAssets(s,t,e){var a=(0,path_1.join)(this.getAssetTempDirByUuid(s),`${e?"debug":"release"}.json`);try{if(this.checkCanSaveCache(s))return void await(0,fs_extra_1.copy)(a,t)}catch(e){unExpectException(e)}s=this.getSerializedJSON(s,{debug:e});if(s)try{await(0,fs_extra_1.outputJSON)(a,s),(0,fs_extra_1.copy)(a,t)}catch(e){unExpectException(e),await(0,fs_extra_1.outputJSON)(t,s)}}async outputCCONAsset(s,e,t){var a=await this.getRawInstance(this.getAsset(s));if(a&&a.asset){var i=(0,path_1.extname)(e),i=((0,assert_1.default)(".bin"===i),(0,path_1.basename)(e,i)),e=(0,path_1.join)((0,path_1.dirname)(e),i),i=exports.buildAssetLibrary.serialize(a.asset,{debug:t.debug,useCCONB:!0,dontStripDefault:!1,_exporting:!0});(0,assert_1.default)(i instanceof serialization_1.CCON);try{await(0,cconb_1.outputCCONFormat)(i,e)}catch(e){console.error(e),console.error(`outputCCONFormat with asset:(${s}) failed!`)}}else console.error(`get instance (${s}) failed!`)}serialize(e,s){if(!e)return null;var t;if(e instanceof cc_1.EffectAsset&&(t=Editor.Module.__protected__.requireFile((0,path_1.join)(Editor.App.path,"modules/engine-extensions/extensions/engine-extends/static/effect-compiler/utils.js"))["stripEditorSupport"],e=t(e,s["cc.EffectAsset"])),e instanceof cc_1.SceneAsset){var a=e.scene?.children||[];for(let e=0;e<a.length;e++)a[e].getComponentsInChildren(cc_1.LightComponent).forEach(e=>{e.staticSettings?.editorOnly&&e._destroyImmediate()})}return(s.useCCONB?EditorExtends.serialize:EditorExtends.serializeCompiled)(e,Object.assign(this.defaultSerializedOptions,{compressUuid:!s.debug,useCCON:s.useCCONB,noNativeDep:!e._native}))}async getRawInstance(e){var s,t,a={asset:null,detail:null};return e.invalid?(console.error(Editor.I18n.t("builder.error.asset_import_failed",{url:`{asset(${e.url})}`,type:Manager.assetManager.queryAssetProperty(e,"type")})),a):(t=e.meta.files.includes(".json")?e.library+".json":"",s=(0,cconb_1.getCCONFormatAssetInLibrary)(e),t||s?(t=t?await(0,fs_extra_1.readJSON)(t):await(0,cconb_utils_1.transformCCON)(s),this.getRawInstanceFromData(t,e)):(console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:Manager.assetManager.queryAssetProperty(e,"type")})),a))}getRawInstanceFromData(e,s){var a={asset:null,detail:null},i=new cc.deserialize.Details,r=(i.reset(),EditorExtends.MissingReporter.classInstance);const n=(r.hasMissingClass=!1,cc_1.deserialize)(e,i,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:r.classFinder});if(n){n._uuid=s.uuid,r.hasMissingClass&&!this.hasMissingClassUuids.has(s.uuid)&&(r.reportMissingClass(n),this.hasMissingClassUuids.add(s.uuid)),r.reset();const u=this;let t=null;i.assignAssetsBy(function(e,s){return u.getAsset(e)?EditorExtends.serialize.asAsset(e):(u.hasMissingAssetsUuids.add(e),s&&s.owner&&((t=t||new EditorExtends.MissingReporter.object(n)).outputLevel="warn",t.stashByOwner(s.owner,s.prop,EditorExtends.serialize.asAsset(e,s.type))),null)}),t&&t.reportByOwner(),["cc.SceneAsset","cc.Prefab"].includes(Manager.assetManager.queryAssetProperty(s,"type"))&&(n.name=(0,path_1.basename)(s.source,(0,path_1.extname)(s.source))),a.asset=n,a.detail=i,this.depend[s.uuid]=[...new Set(i.uuidList)]}else console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${s.url})}`}));return a}reset(){this.assetMap={},this.meta={},this.depend={},this.dependedMap={},this.hasMissingClassUuids.clear(),this.hasMissingAssetsUuids.clear()}checkUseCache(e){return!(!this.useCache||["cc.SceneAsset","cc.Prefab","cc.EffectAsset"].includes(Manager.assetManager.queryAssetProperty(e,"type")))}checkCanSaveCache(e){return!this.hasMissingClassUuids.has(e)&&!this.hasMissingClassUuids.has(e)}}function saveReadJSONSync(e){if((0,fs_extra_1.existsSync)(e))try{return(0,fs_extra_1.readJSONSync)(e)}catch(e){console.warn(e)}return null}async function requestAssetLibrary(e,...s){return(0,utils_1.requestModule)(exports.buildAssetLibrary,e,...s)}function unExpectException(e){console.debug(e),render_1.sentry.captureException(e)}exports.buildAssetLibrary=new BuildAssetLibrary;