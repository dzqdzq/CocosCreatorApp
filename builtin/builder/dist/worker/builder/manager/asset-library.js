"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildLibrary=exports.buildAssetLibrary=void 0;const EditorExtends=require("@base/electron-module").require("EditorExtends"),fs_extra_1=require("fs-extra"),index_1=require("../utils/index"),path_1=require("path"),serialization_1=require("cc/editor/serialization"),cconb_utils_1=require("./cconb-utils"),cc_1=require("cc"),CACHE_VERSION="1.0.1";class BuildAssetLibrary{constructor(){this.assets={},this.depend={},this.dependedMap={},this.meta={},this.cacheTempDir=(0,path_1.join)(Editor.Project.tmpDir,"asset-db"),this.assetMtimeCache={},this.assetMtimeCacheFile=(0,path_1.join)(Editor.Project.tmpDir,"builder","assets-mtime.json"),this.useCache=!0,this.hasMissingClassUuids=new Set,this.hasMissingAsssetsUuids=new Set,this.scriptChanged=!1,this.pathToUuid={},this.hasInitAsset=!1,this.dirty=!1,this.defaultSerializedOptions={compressUuid:!0,stringify:!1,dontStripDefault:!1,useCCON:!1,keepNodeUuid:!1}}async initMtimeCache(){if((0,fs_extra_1.existsSync)(this.assetMtimeCacheFile))try{this.assetMtimeCache=await(0,fs_extra_1.readJSON)(this.assetMtimeCacheFile)||{}}catch(e){}}async saveMtimeCache(){await(0,fs_extra_1.outputJSON)(this.assetMtimeCacheFile,this.assetMtimeCache)}async init(){this.defaultSerializedOptions.keepNodeUuid=!!await Editor.Profile.getConfig("builder","serializedOptions.keepNodeUuid"),this.useCache=await Editor.Profile.getConfig("builder","useBuildAssetCache"),console.debug(`init custom config: keepNodeUuid: ${this.defaultSerializedOptions.keepNodeUuid}, useCache: ${this.useCache}`),await this.initAssets(),await this.initMtimeCache()}async initAssets(){const e=await Manager.Utils.queryAssets({},["subAssets","mtime","meta","depends"]);for(let s=0;s<e.length;s++){const t=e[s];t.isDirectory||"database"===t.importer||this.addAsset(t)}return Object.values(this.assets)}getAssetTempDirByUuid(e){const s=this.getAssetInfo(e).url.match(/db:\/\/([^/]*)/)[1];return(0,path_1.join)(this.cacheTempDir,s,e.substr(0,2),e,"build"+CACHE_VERSION)}addAsset(e){this.assets[e.uuid]||(0,index_1.recursively)(e,e=>{("cc.Script"===e.type||e.library[".json"]||e.library[".cconb"])&&(e.url.toLowerCase().endsWith(".d.ts")||(this.assets[e.uuid]=e,e.dirty=e.mtime===this.assetMtimeCache[e.uuid],e.temp||(e.temp=this.getAssetTempDirByUuid(e.uuid))))})}clearAsset(e){const s=this.getAssetTempDirByUuid(e);s&&(0,fs_extra_1.existsSync)(s)&&(0,fs_extra_1.removeSync)(s),delete this.depend[e],Object.keys(this.depend).forEach(e=>{const s=this.depend[e];s.includes(e)&&s.splice(0,s.indexOf(e))})}async forEach(e){this.hasInitAsset||await this.initAssets();const s=Object.values(this.assets);for(let t=0;t<s.length;t++){const i=s[t];e&&await e(i,t)}}getMeta(e){return void 0!==this.meta[e]?this.meta[e]:this.assets[e]&&this.assets.meta?this.assets.meta:this.meta[e]=Manager.Utils.queryAssetMeta(e)}addMeta(e,s){s&&(this.meta[e]=s)}getAssetInfo(e,s=["subAssets","mtime","meta","depends"]){return this.assets[e]||Manager.Utils.queryAssetInfo(e,s)}async queryAssetsByOptions(e,s=["subAssets","mtime","meta","depends"]){return await Manager.Utils.queryAssets(e,s)}async queryAssets(){return this.hasInitAsset||await this.initAssets(),Object.values(this.assets)}async queryAssetDependeds(e){return this.dependedMap[e]?this.dependedMap[e]:(this.dependedMap[e]=await Manager.Utils.queryAssetDependeds(e)||[],this.dependedMap[e])}url2uuid(e){return Manager.Utils.url2uuid(e)}async getDependUuids(e){if(this.depend[e])return this.depend[e];const s=this.getAssetInfo(e);return s?["cc.SceneAsset","cc.Prefab"].includes(s.type)?(await this.getRawInstance(s),this.depend[e]||[]):(s.depends||(s.depends=await Manager.Utils.queryAssetDependencies(e)||[]),s.depends||[]):[]}async getDependUuidsDeep(e){let s=[],t=[];const i=await this.getDependUuids(e);if(!i)return[];t=[...i],s=[...i];do{const e=[];for(const s of t){const t=await this.getDependUuids(s);e.push(...t)}t=e.filter(e=>!s.includes(e)),s.push(...t)}while(t.length>0);return Array.from(new Set(s))}async getInstance(e){if(!e)return null;return(await this.getRawInstance(e)).asset}async getSerializedJSON(e,s){const t=this.getAssetInfo(e);if(!t||!t.library[".json"])return null;const i=(0,path_1.join)(this.getAssetTempDirByUuid(e),`${s.debug?"debug":"release"}.json`);if(this.checkUseCache(t)&&(0,fs_extra_1.existsSync)(i)){console.debug(`getSerializedJSON: Use cache serialized JSON of asset ({asset(${t.url})})`);try{return await(0,fs_extra_1.readJSON)(i)}catch(e){console.debug(e),console.debug(`get cacheFile in ${i} failed!`)}}else await(0,fs_extra_1.remove)(i);const a=await this.getRawInstance(t);if(!a.asset)return null;if(t.type&&"cc.SceneAsset"===t.type){const e=a.asset.scene.children||[];for(let s=0;s<e.length;s++){const t=e[s].getComponent(cc.LightComponent);if(t&&t.staticSettings){t.staticSettings.editorOnly&&(e.splice(s,1),s--)}}}const r=this.serialize(a.asset,s);return this.checkCanSaveCache(t.uuid)&&((0,fs_extra_1.outputJSON)(i,r,{spaces:4}),t.mtime&&(this.assetMtimeCache[t.uuid]=t.mtime)),r}async outputAssets(e,s,t){const i=(0,path_1.join)(this.getAssetTempDirByUuid(e),`${t?"debug":"release"}.json`);try{if(this.checkCanSaveCache(e))return void await(0,fs_extra_1.copy)(i,s)}catch(e){console.debug(e)}const a=this.getSerializedJSON(e,{debug:t});a&&(await(0,fs_extra_1.outputJSON)(i,a),(0,fs_extra_1.copy)(i,s))}async outputCCONBAssets(e,s,t){const i=await this.getRawInstance(this.getAssetInfo(e));if(!i||!i.asset)return void console.error(`get instance (${e}) failed!`);const a=exports.buildAssetLibrary.serialize(i.asset,{debug:t.debug,useCCONB:!0,dontStripDefault:!1,_exporting:!0});await(0,fs_extra_1.outputFile)(s,(0,serialization_1.encodeCCONBinary)(a))}async outputCCONAssets(e,s,t){const i=await this.getRawInstance(this.getAssetInfo(e));if(!i||!i.asset)return void console.error(`get instance (${e}) failed!`);const a=exports.buildAssetLibrary.serialize(i.asset,{debug:t.debug,useCCONB:!0}),r=s.replace(/.cconb$/,".json"),n=a.chunks.map(()=>".bin");if(await(0,fs_extra_1.outputJSON)(r,(0,serialization_1.encodeCCONJson)(a,n)),a.chunks.length){const e=s.replace(/.cconb$/,".bin");await(0,fs_extra_1.outputFile)(e,a.chunks[0])}}serialize(e,s){if(!e)return null;if(e instanceof cc_1.EffectAsset){const{stripEditorSupport:t}=Editor.Module.__protected__.requireFile((0,path_1.join)(Editor.App.path,"modules/engine-extensions/extensions/engine-extends/static/effect-compiler/utils.js"));e=t(e,s["cc.EffectAsset"])}return(s.useCCONB?EditorExtends.serialize:EditorExtends.serializeCompiled)(e,Object.assign(this.defaultSerializedOptions,{compressUuid:!s.debug,useCCON:s.useCCONB,noNativeDep:!e._native}))}async getRawInstance(e){const s={asset:null,detail:null};if(e.invalid)return console.error(Editor.I18n.t("builder.error.asset_import_failed",{url:`{asset(${e.url})}`,type:e.type})),s;const t=e.library[".json"],i=e.library[".cconb"];if(!t&&!i)return console.debug(Editor.I18n.t("builder.warn.no_serialized_json",{url:`{asset(${e.url})}`,type:e.type})),s;const a=t?await(0,fs_extra_1.readJSON)(t):await(0,cconb_utils_1.transformCCON)(i);return this.getRawInstanceFromData(a,e)}getRawInstanceFromData(e,s){const t={asset:null,detail:null},i=new cc.deserialize.Details;i.reset();const a=EditorExtends.MissingReporter.classInstance;a.hasMissingClass=!1;const r=(0,cc_1.deserialize)(e,i,{createAssetRefs:!0,ignoreEditorOnly:!0,classFinder:a.classFinder});if(!r)return console.error(Editor.I18n.t("builder.error.deserialize_failed",{url:`{asset(${s.url})}`})),t;r._uuid=s.uuid,a.hasMissingClass&&!this.hasMissingClassUuids.has(s.uuid)&&(a.reportMissingClass(r),this.hasMissingClassUuids.add(s.uuid)),a.reset();const n=this;let d=null;return i.assignAssetsBy(function(e,s){return n.getAssetInfo(e)?EditorExtends.serialize.asAsset(e):(n.hasMissingAsssetsUuids.add(e),s&&s.owner&&((d=d||new EditorExtends.MissingReporter.object(r)).outputLevel="warn",d.stashByOwner(s.owner,s.prop,EditorExtends.serialize.asAsset(e,s.type))),null)}),d&&d.reportByOwner(),["cc.SceneAsset","cc.Prefab"].includes(s.type)&&(r.name=(0,path_1.basename)(s.source,(0,path_1.extname)(s.source))),t.asset=r,t.detail=i,this.depend[s.uuid]=[...new Set(i.uuidList)],t}reset(){this.assets={},this.meta={},this.depend={},this.scriptChanged=!1,this.hasMissingClassUuids.clear(),this.hasMissingAsssetsUuids.clear(),this.hasInitAsset=!1}checkUseCache(e){return!(!this.useCache||["cc.SceneAsset","cc.Prefab","cc.EffectAsset"].includes(e.type)||e.dirty)}checkCanSaveCache(e){return!this.hasMissingClassUuids.has(e)&&!this.hasMissingClassUuids.has(e)}}function saveReadJSONSync(e){if(!(0,fs_extra_1.existsSync)(e))return null;try{return(0,fs_extra_1.readJSONSync)(e)}catch(e){console.warn(e)}return null}exports.buildAssetLibrary=new BuildAssetLibrary,exports.buildLibrary={getAssetInfo:exports.buildAssetLibrary.getAssetInfo,getSerializedJSON:exports.buildAssetLibrary.getSerializedJSON,getInstance:exports.buildAssetLibrary.getInstance,getMeta:exports.buildAssetLibrary.getMeta,getDependUuids:exports.buildAssetLibrary.getDependUuids,serialize:exports.buildAssetLibrary.serialize};