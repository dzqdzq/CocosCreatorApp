"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderAssetCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("../utils/index"),asset_library_1=require("./asset-library"),Editor=__importStar(require("editor"));class BuilderAssetCache{constructor(t){this.sceneUuids=[],this.scriptUuids=[],this.assetUuids=[],this.dependUuidsMap={},this.instanceMap={},this.__task=t}async init(){asset_library_1.buildAssetLibrary.reset(),await asset_library_1.buildAssetLibrary.init(),Object.keys(asset_library_1.buildAssetLibrary.asset).forEach(t=>{this.addAsset(asset_library_1.buildAssetLibrary.asset[t])})}addAsset(t){if(!t.invalid)switch(t.type){case"cc.SceneAsset":this.sceneUuids.push(t.uuid);break;case"cc.Script":if(t.url.toLowerCase().endsWith(".d.ts"))break;this.scriptUuids.push(t.uuid);break;default:index_1.recursively(t,t=>{t.library[".json"]&&this.assetUuids.push(t.uuid)})}}getAssetInfo(t){return asset_library_1.buildAssetLibrary.asset[t]}addInstance(t){t&&t._uuid&&(this.instanceMap[t._uuid]=t)}clearAsset(t){this.sceneUuids.length=0,this.scriptUuids.length=0,this.assetUuids.length=0,delete this.instanceMap[t]}async getMeta(t){return await asset_library_1.buildAssetLibrary.getMeta(t)}async getDependUuids(t){return void 0!==this.dependUuidsMap[t]?this.dependUuidsMap[t]:await asset_library_1.buildAssetLibrary.getDependUuids(t)}async getDependUuidsDeep(t){let e=[],s=[];const i=await this.getDependUuids(t);if(!i)return[];s=[...i],e=[...i];do{let t=[];for(const e of s){const s=await this.getDependUuids(e);t.push(...s)}s=t.filter(t=>!e.includes(t)),e.push(...s)}while(s.length>0);return Array.from(new Set(e))}async getLibraryJSON(t){const e=this.getAssetInfo(t);return e&&e.library[".json"]?await fs_extra_1.readJSON(e.library[".json"]):null}async getSerializedJSON(t,e){const s=this.instanceMap[t];let i;if(!(i=s?asset_library_1.buildAssetLibrary.serialize(s,e.debug):await asset_library_1.buildAssetLibrary.getSerializedJSON(t,e.debug)))return null;if("cc.EffectAsset"===i.__type__){const{stripEditorSupport:t}=require(path_1.join(Editor.App.path,"builtin/asset-db/static/effect-compiler/utils.js"));i=t(i,e.assetSerializeOptions["cc.EffectAsset"])}return i}async outputAssetJson(t,e,s){const i=asset_library_1.buildAssetLibrary.asset[t],r=this.instanceMap[t];if(r||i)if(r){const t=path_1.join(e,i.library[".json"].replace(path_1.join(Editor.Project.path,"library"),"")),a=asset_library_1.buildAssetLibrary.serialize(r,s.debug);await fs_extra_1.outputJSON(t,a)}else{const i=path_1.join(e,t.substr(0,2),t+".json");await asset_library_1.buildAssetLibrary.outputAssets(t,i,s.debug)}}async forEach(t,e){if(!this[t])return;const s=Object.keys(this[t]);if(s)for(let t=0;t<s.length;t++){const i=s[t];e&&await e(i,t)}}async getInstance(t){if(this.instanceMap[t])return this.instanceMap[t];const e=await this.getAssetInfo(t);return asset_library_1.buildAssetLibrary.getInstance(e)}__addStaticsInfo(t){this.__task.staticsInfo=Object.assign(this.__task.staticsInfo,t)}}exports.BuilderAssetCache=BuilderAssetCache;