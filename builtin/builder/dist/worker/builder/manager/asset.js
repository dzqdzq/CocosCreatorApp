"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderAssetCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("../utils/index"),asset_library_1=require("./asset-library");class BuilderAssetCache{constructor(s){this.sceneUuids=[],this.scriptUuids=[],this.assetUuids=[],this.dependUuidsMap={},this.instanceMap={},this.__task=s}async init(){asset_library_1.buildAssetLibrary.reset(),await asset_library_1.buildAssetLibrary.init(),Object.keys(asset_library_1.buildAssetLibrary.asset).forEach(s=>{this.addAsset(asset_library_1.buildAssetLibrary.asset[s])})}addAsset(s){if(!s.invalid)switch(s.type){case"cc.SceneAsset":this.sceneUuids.push(s.uuid);break;case"cc.Script":if(s.url.toLowerCase().endsWith(".d.ts"))break;this.scriptUuids.push(s.uuid);break;default:index_1.recursively(s,s=>{s.library[".json"]&&this.assetUuids.push(s.uuid)})}}getAssetInfo(s){return asset_library_1.buildAssetLibrary.asset[s]}addInstance(s){s&&s._uuid&&(this.instanceMap[s._uuid]=s)}clearAsset(s){this.sceneUuids.length=0,this.scriptUuids.length=0,this.assetUuids.length=0,delete this.instanceMap[s]}async getMeta(s){return await asset_library_1.buildAssetLibrary.getMeta(s)}async getDependUuids(s){return void 0!==this.dependUuidsMap[s]?this.dependUuidsMap[s]:await asset_library_1.buildAssetLibrary.getDependUuids(s)}async getDependUuidsDeep(s){let t=[],e=[];const i=await this.getDependUuids(s);if(!i)return[];e=[...i],t=[...i];do{let s=[];for(const t of e){const e=await this.getDependUuids(t);s.push(...e)}e=s.filter(s=>!t.includes(s)),t.push(...e)}while(e.length>0);return Array.from(new Set(t))}async getLibraryJSON(s){const t=this.getAssetInfo(s);return t&&t.library[".json"]?await fs_extra_1.readJSON(t.library[".json"]):null}async getSerializedJSON(s,t){const e=this.instanceMap[s];let i;if(!(i=e?asset_library_1.buildAssetLibrary.serialize(e,t.debug):await asset_library_1.buildAssetLibrary.getSerializedJSON(s,t.debug)))return null;if("cc.EffectAsset"===i.__type__){const{stripEditorSupport:s}=require(path_1.join(Editor.App.path,"builtin/asset-db/static/effect-compiler/utils.js"));i=s(i,t.assetSerializeOptions["cc.EffectAsset"])}return i}async outputAssetJson(s,t,e){const i=asset_library_1.buildAssetLibrary.asset[s],a=this.instanceMap[s];if(a||i)if(a){const s=path_1.join(t,i.library[".json"].replace(path_1.join(Editor.Project.path,"library"),"")),r=asset_library_1.buildAssetLibrary.serialize(a,e.debug);await fs_extra_1.outputJSON(s,r)}else{const i=path_1.join(t,s.substr(0,2),s+".json");await asset_library_1.buildAssetLibrary.outputAssets(s,i,e.debug)}}async forEach(s,t){if(!this[s])return;const e=Object.keys(this[s]);if(e)for(let s=0;s<e.length;s++){const i=e[s];t&&await t(i,s)}}async getInstance(s){if(this.instanceMap[s])return this.instanceMap[s];const t=await this.getAssetInfo(s);return asset_library_1.buildAssetLibrary.getInstance(t)}__addStaticsInfo(s){this.__task.staticsInfo=Object.assign(this.__task.staticsInfo,s)}}exports.BuilderAssetCache=BuilderAssetCache;