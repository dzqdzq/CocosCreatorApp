"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderAssetCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("../utils/index"),asset_library_1=require("./asset-library");class BuilderAssetCache{constructor(s){this.__library=asset_library_1.buildAssetLibrary,this.sceneUuids=[],this.scriptUuids=[],this.assetUuids=[],this.dependUuidsMap={},this.instanceMap={},this.__task=s}async init(){this.__task.options.preview&&__manager.currentBuildTask?console.warn("Preview in build may make some errors"):(asset_library_1.buildAssetLibrary.reset(),asset_library_1.buildAssetLibrary.useCache=!1!==this.__task.options.useBuildAssetCache),await asset_library_1.buildAssetLibrary.init(),Object.keys(asset_library_1.buildAssetLibrary.asset).forEach(s=>{this.addAsset(asset_library_1.buildAssetLibrary.asset[s])})}addAsset(s){if(!s.invalid)switch(asset_library_1.buildAssetLibrary.asset[s.uuid]||asset_library_1.buildAssetLibrary.addAsset(s),s.type){case"cc.SceneAsset":this.sceneUuids.push(s.uuid);break;case"cc.Script":if(s.url.toLowerCase().endsWith(".d.ts"))break;this.scriptUuids.push(s.uuid);break;default:(0,index_1.recursively)(s,s=>{(s.library[".json"]||s.library[".cconb"])&&this.assetUuids.push(s.uuid)})}}removeAsset(s){const e=this.getAssetInfo(s);switch(e.type){case"cc.SceneAsset":for(let e=0;e<this.sceneUuids.length;e++)if(this.sceneUuids[e]===s)return void this.sceneUuids.splice(e,1);break;case"cc.Script":for(let e=0;e<this.scriptUuids.length;e++)if(this.scriptUuids[e]===s)return void this.scriptUuids.splice(e,1);break;default:(0,index_1.recursively)(e,s=>{if(s.library[".json"]||s.library[".cconb"])for(let e=0;e<this.assetUuids.length;e++)if(this.assetUuids[e]===s.uuid)return void this.assetUuids.splice(e,1)})}}getAssetInfo(s){return asset_library_1.buildAssetLibrary.asset[s]}addInstance(s){s&&s._uuid&&(this.instanceMap[s._uuid]=s)}clearAsset(s){this.sceneUuids.length=0,this.scriptUuids.length=0,this.assetUuids.length=0,delete this.instanceMap[s]}async getMeta(s){return await asset_library_1.buildAssetLibrary.getMeta(s)}async getDependUuids(s){return void 0!==this.dependUuidsMap[s]?this.dependUuidsMap[s]:await asset_library_1.buildAssetLibrary.getDependUuids(s)}async getDependUuidsDeep(s){let e=[],t=[];const i=await this.getDependUuids(s);if(!i)return[];t=[...i],e=[...i];do{const s=[];for(const e of t){const t=await this.getDependUuids(e);s.push(...t)}t=s.filter(s=>!e.includes(s)),e.push(...t)}while(t.length>0);return Array.from(new Set(e))}async getLibraryJSON(s){const e=this.getAssetInfo(s);return e&&e.library[".json"]?await(0,fs_extra_1.readJSON)(e.library[".json"]):null}async getSerializedJSON(s,e){const t=this.getAssetInfo(s);let i=this.instanceMap[s];if(!t||t&&"cc.EffectAsset"!==t.type){let t;return(t=i?asset_library_1.buildAssetLibrary.serialize(i,{debug:e.debug}):await asset_library_1.buildAssetLibrary.getSerializedJSON(s,{debug:e.debug}))||null}if(i=await this.getInstance(s),t&&"cc.EffectAsset"===t.type){const{stripEditorSupport:s}=Editor.Module.requireFile((0,path_1.join)(Editor.App.path,"modules/engine-extensions/extensions/engine-extends/static/effect-compiler/utils.js"));i=s(i,e.assetSerializeOptions["cc.EffectAsset"])}return asset_library_1.buildAssetLibrary.serialize(i,{debug:e.debug})}async outputAssetJson(s,e,t){const i=asset_library_1.buildAssetLibrary.asset[s],r=this.instanceMap[s];if(r||i)if(r){const s=(0,path_1.join)(e,i.library[".json"].replace((0,path_1.join)(Editor.Project.path,"library"),"")),a=asset_library_1.buildAssetLibrary.serialize(r,{debug:t.debug});await(0,fs_extra_1.outputJSON)(s,a)}else{const i=(0,path_1.join)(e,s.substr(0,2),s+".json");await asset_library_1.buildAssetLibrary.outputAssets(s,i,t.debug)}}async forEach(s,e){if(!this[s])return;const t=Object.keys(this[s]);if(t)for(let s=0;s<t.length;s++){const i=t[s];e&&await e(i,s)}}async getInstance(s){if(this.instanceMap[s])return this.instanceMap[s];const e=await this.getAssetInfo(s);return asset_library_1.buildAssetLibrary.getInstance(e)}__addStaticsInfo(s){this.__task.staticsInfo=Object.assign(this.__task.staticsInfo,s)}}exports.BuilderAssetCache=BuilderAssetCache;