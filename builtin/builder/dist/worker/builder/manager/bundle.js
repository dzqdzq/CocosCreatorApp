"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Bundle=void 0;const path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),utils_1=require("../utils");class Bundle{constructor(s){this.root="",this.dest="",this.importBase=Build.IMPORT_HEADER,this.nativeBase=Build.NATIVE_HEADER,this.scriptDest="",this.name="",this.priority=0,this.compressionType=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,this.assetVer={import:{},native:{}},this.zipVer="",this.version="",this.isRemote=!1,this.isZip=!1,this.redirect={},this.deps=new Set,this.groups=[],this.cache=null,this.config={importBase:"",nativeBase:"",name:"",deps:[],uuids:[],paths:{},scenes:{},packs:{},versions:{import:[],native:[]},redirect:[],debug:!1,extensionMap:{}},this.configOutPutName="",this.atlasRes={assetsToImage:{},imageToAtlas:{},atlasToImages:{}},this.compressRes={},this._rootAssets=new Set,this._scenes=new Set,this._scripts=new Set,this._assets=new Set,this.root=s.root,this.name=s.name,this.dest=s.dest,this.priority=s.priority,this.compressionType=s.compressionType,this.isRemote=s.isRemote,this.scriptDest=s.scriptDest}get scenes(){return Array.from(this._scenes).sort()}get assets(){return Array.from(this._assets).sort()}get assetsWithoutRedirect(){return this.assets.filter(s=>!this.getRedirect(s))}get scripts(){return Array.from(this._scripts).sort()}get rootAssets(){return Array.from(this._rootAssets)}get isSubpackage(){return this.compressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE}addScene(s){s&&(this._scenes.add(s.uuid),this.addAsset(s))}addScript(s){s&&this._scripts.add(s.uuid)}addRootAsset(s){s&&utils_1.recursively(s,s=>{this._rootAssets.add(s.uuid),this.addAsset(s)})}addAsset(s){s&&this._assets.add(s.uuid)}removeAsset(s){s&&(this._assets.delete(s),this._rootAssets.delete(s),this._scenes.delete(s),delete this.redirect[s],this.removeFromGroups(s))}addRedirect(s,t){s&&(this.redirect[s.uuid]=t,this.deps.add(t),this.addAsset(s))}addRedirectWithUuid(s,t){s&&(this.redirect[s]=t,this.deps.add(t),this.addAssetWithUuid(s))}addAssetWithUuid(s){this._assets.add(s)}getRedirect(s){return this.redirect[s]}addGroup(s,t){this.groups.push({type:s,uuids:t})}addToGroup(s,t){const e=this.groups.find(t=>t.type===s);e?e.uuids.push(t):this.addGroup(s,[t])}removeFromGroups(s){this.groups.forEach(t=>{cc.js.array.fastRemove(t.uuids,s)}),this.groups=this.groups.filter(s=>s.uuids.length>1)}getJsonPath(s){var t;return(null===(t=this.getJsonPathInfo(s))||void 0===t?void 0:t.json)||""}getAssetPathInfo(s){if(!this.containsAsset(s))return null;const t=this.getJsonPathInfo(s),e=this.getRawAssetPaths(s);if(!t&&!e)return null;const i={};return t&&(i.json=t.json,t.groupIndex&&(i.groupIndex=t.groupIndex)),e&&(i.raw=e),i}containsAsset(s){return this._scripts.has(s)||this._assets.has(s)||this._scenes.has(s)}getRawAssetPaths(s){if(!this.containsAsset(s))return[];const t=this.cache.getAssetInfo(s);if(!t)return console.error(`Can't get assetInfo of uuid {asset(${s})}`),[];const e=Object.keys(t.library).filter(s=>".json"!==s);if("cc.Script"===t.type)return[this.scriptDest];if(["cc.ImageAsset","cc.Texture2D","cc.SpriteFrame"].includes(t.type)&&this.compressRes[s])return this.compressRes[s];if(["cc.ImageAsset","cc.SpriteFrame","cc.SpriteAltas"].includes(t.type)){const t=this.atlasRes.assetsToImage[s];if(t){if(this.compressRes[t])return this.compressRes[t];const s=this.assetVer.native[t];return[utils_1.getResRawAssetsPath(this.dest,t,s?`.${s}.png`:".png")]}}return"cc.TTFFont"===t.type&&this.assetVer.native[s]?e.map(t=>utils_1.getResRawAssetsPath(this.dest,`${s}.${this.assetVer.native[s]}/`,t)):e.map(s=>this._resolveNativePath(t.library[s],s))}getJsonPathInfo(s){if(!this.containsAsset(s))return null;const t=this.cache.getAssetInfo(s);if(t&&!Object.keys(t.library).includes(".json"))return null;const e=this.groups.find(t=>t.uuids.includes(s));return e?{json:this._resolveImportPath(e.name),groupIndex:e.uuids.indexOf(s)}:{json:this._resolveImportPath(s)}}_resolveImportPath(s){return utils_1.getResImportPath(this.dest,s+(this.assetVer.import[s]?"."+this.assetVer.import[s]:""))}_resolveNativePath(s,t){const e=path_1.basename(s,t),i=this.assetVer.native[e],r=s.replace(path_1.join(Editor.Project.path,Build.LIBRARY_NAME),path_1.join(this.dest,Build.NATIVE_HEADER));return i?r.replace(t,`.${i}${t}`):r}}exports.Bundle=Bundle;