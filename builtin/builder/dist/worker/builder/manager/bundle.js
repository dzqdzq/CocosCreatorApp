"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Bundle=void 0;const path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils"),utils_1=require("../utils");class Bundle{constructor(s){this.hasPreloadScript=!0,this.root="",this.dest="",this.importBase=Build.IMPORT_HEADER,this.nativeBase=Build.NATIVE_HEADER,this.scriptDest="",this.name="",this.priority=0,this.compressionType=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,this.assetVer={import:{},native:{}},this.zipVer="",this.version="",this.isRemote=!1,this.isZip=!1,this.redirect={},this.deps=new Set,this.groups=[],this.cache=null,this.config={importBase:"",nativeBase:"",name:"",deps:[],uuids:[],paths:{},scenes:{},packs:{},versions:{import:[],native:[]},redirect:[],debug:!1,extensionMap:{},hasPreloadScript:!1},this.configOutPutName="",this.atlasRes={assetsToImage:{},imageToAtlas:{},atlasToImages:{}},this.compressRes={},this._rootAssets=new Set,this._scenes=new Set,this._scripts=new Set,this._assets=new Set,this.root=s.root,this.name=s.name,this.dest=s.dest,this.priority=s.priority,this.compressionType=s.compressionType,this.isRemote=s.isRemote,this.scriptDest=s.scriptDest}get scenes(){return Array.from(this._scenes).sort()}get assets(){return Array.from(this._assets).sort()}get assetsWithoutRedirect(){return this.assets.filter(s=>!this.getRedirect(s))}get scripts(){return Array.from(this._scripts).sort()}get rootAssets(){return Array.from(this._rootAssets)}get isSubpackage(){return this.compressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE}addScene(s){s&&(this._scenes.add(s),this.addAsset(s))}addScript(s){s&&this._scripts.add(s)}addRootAsset(s){s&&(0,utils_1.recursively)(s,s=>{this._rootAssets.add(s.uuid),this.addAsset(s.uuid)})}addAsset(s){s&&this._assets.add(s)}removeAsset(s){var t;s&&(this._assets.delete(s),this._rootAssets.delete(s),this._scenes.delete(s),this._scripts.delete(s),delete this.redirect[s],this.removeFromGroups(s),null===(t=this.cache)||void 0===t||t.removeAsset(s))}addRedirect(s,t){s&&(this.redirect[s]=t,this.deps.add(t),this.addAsset(s))}addRedirectWithUuid(s,t){s&&(this.redirect[s]=t,this.deps.add(t),this.addAssetWithUuid(s))}addAssetWithUuid(s){this._assets.add(s)}getRedirect(s){return this.redirect[s]}addGroup(s,t){this.groups.push({type:s,uuids:t})}addToGroup(s,t){const e=this.groups.find(t=>t.type===s);e?e.uuids.push(t):this.addGroup(s,[t])}removeFromGroups(s){this.groups.forEach(t=>{cc.js.array.fastRemove(t.uuids,s)}),this.groups=this.groups.filter(s=>s.uuids.length>1)}getJsonPath(s){var t;return(null===(t=this.getJsonPathInfo(s))||void 0===t?void 0:t.json)||""}getAssetPathInfo(s){if(!this.containsAsset(s,!0))return null;const t=this.getJsonPathInfo(s),e=this.getRawAssetPaths(s);if(!t&&!e.length)return null;const i={};return t&&(i.json=t.json,t.groupIndex&&(i.groupIndex=t.groupIndex)),e&&(i.raw=e),i}containsAsset(s,t=!1){return this._scripts.has(s)||this._assets.has(s)||this._scenes.has(s)||!!t&&!(!this.atlasRes.atlasToImages[s]||!this.atlasRes.atlasToImages[s].length)}getRawAssetPaths(s){if(!this.containsAsset(s,!0))return[];const t=this.cache.getAssetInfo(s);if(!t)return console.error(`Can't get assetInfo of uuid {asset(${s})}`),[];const e=Object.keys(t.library).filter(s=>".json"!==s);if("cc.Script"===t.type)return[this.scriptDest];if("cc.ImageAsset"===t.type&&this.compressRes[s])return this.compressRes[s];if(["cc.ImageAsset","cc.SpriteFrame","cc.SpriteAtlas"].includes(t.type)){const t=(this.atlasRes.assetsToImage[s]?[this.atlasRes.assetsToImage[s]]:this.atlasRes.atlasToImages[s])||[];if(t.length){const s=[];for(const e of t){if(!e)continue;if(this.compressRes[e]){s.push(...this.compressRes[e]);continue}const t=this.assetVer.native[e];s.push((0,utils_1.getResRawAssetsPath)(this.dest,e,t?`.${t}.png`:".png"))}return s}}return"cc.TTFFont"===t.type&&this.assetVer.native[s]?e.map(t=>(0,utils_1.getResRawAssetsPath)(this.dest,`${s}.${this.assetVer.native[s]}/`,t)):e.map(s=>this._resolveNativePath(t.library[s],s))}getJsonPathInfo(s){if(!this.containsAsset(s))return null;const t=this.cache.getAssetInfo(s);if(t&&!Object.keys(t.library).includes(".json"))return null;const e=this.groups.find(t=>t.uuids.includes(s));return e?{json:this._resolveImportPath(e.name),groupIndex:e.uuids.indexOf(s)}:{json:this._resolveImportPath(s)}}_resolveImportPath(s){return(0,utils_1.getResImportPath)(this.dest,s+(this.assetVer.import[s]?"."+this.assetVer.import[s]:""))}_resolveNativePath(s,t){const e=(0,path_1.basename)(s,t),i=this.assetVer.native[e],r=s.replace((0,path_1.join)(Editor.Project.path,Build.LIBRARY_NAME),(0,path_1.join)(this.dest,Build.NATIVE_HEADER));return i?r.replace(t,`.${i}${t}`):r}}exports.Bundle=Bundle;