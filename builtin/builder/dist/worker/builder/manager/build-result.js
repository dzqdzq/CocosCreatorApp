"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,n)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildResult=exports.InternalBuildResult=void 0;const path_1=require("path"),asset_library_1=require("./asset-library"),stage_task_manager_1=require("../stage-task-manager"),BundleUtils=__importStar(require("../asset-handler/bundle/utils")),events_1=__importDefault(require("events")),utils_1=require("../asset-handler/bundle/utils");class Paths{constructor(e){this.cache={},this.plugins={},this.dir=e||"",this.compileConfig=(0,path_1.join)(e,stage_task_manager_1.BuildStageTask.optionsFileName)}get settings(){return this.cache.settings||(0,path_1.join)(this.dir,"src","settings.json")}set settings(e){this.cache.settings=e}get subpackages(){return this.cache.subpackages||(0,path_1.join)(this.dir,Build.SUBPACKAGES_HEADER)}set subpackages(e){this.cache.subpackages=e}get assets(){return this.cache.assets||(0,path_1.join)(this.dir,Build.ASSETS_HEADER)}set assets(e){this.cache.assets=e}get remote(){return this.cache.remote||(0,path_1.join)(this.dir,Build.REMOTE_HEADER)}set remote(e){this.cache.remote=e}get applicationJS(){return this.cache.applicationJS||(0,path_1.join)(this.dir,"application.js")}set applicationJS(e){this.cache.applicationJS=e}get importMap(){return this.cache.importMap||(0,path_1.join)(this.dir,"import-map.js")}set importMap(e){this.cache.importMap=e}get bundleScripts(){return this.cache.bundleScripts||(0,path_1.join)(this.dir,"src",Build.BUNDLE_SCRIPTS_HEADER)}set bundleScripts(e){this.cache.bundleScripts=e}}class InternalBuildResult extends events_1.default{constructor(e,t){super(),this.settings={CocosEngine:"0.0.0",engine:{debug:!0,platform:"web-desktop",customLayers:[],sortingLayers:[],macros:{},builtinAssets:[]},animation:{customJointTextureLayouts:[]},assets:{server:"",remoteBundles:[],subpackages:[],preloadBundles:[],bundleVers:{},preloadAssets:[],projectBundles:[]},plugins:{jsList:[]},scripting:{},launch:{launchScene:""},screen:{exactFitScreen:!0,designResolution:{width:960,height:640,policy:0}},rendering:{renderPipeline:""}},this.scriptPackages=[],this.pluginVers={},this.compressImageResult={},this.importMap={imports:{}},this.compileOptions=null,this.staticsInfo={},this.rawOptions=JSON.parse(JSON.stringify(e.options));let s=(0,path_1.join)(Editor.Project.path,"build","preview");t||(s=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e.options.buildPath),e.options.outputName)),this.paths=new Paths(s),this.__task=e}get dest(){return this.paths.dir}get bundles(){return console.log(Editor.I18n.t("builder.warn.deprecatedTip",{oldName:"result.bundles",newName:"this.bundleManager.bundles"})),this.__task.bundleManager.bundles}get bundleMap(){return console.log(Editor.I18n.t("builder.warn.deprecatedTip",{oldName:"result.bundleMap",newName:"this.bundleManager.bundleMap"})),this.__task.bundleManager.bundleMap}get plugins(){console.log(Editor.I18n.t("builder.warn.deprecatedTip",{oldName:"result.plugins",newName:"this.bundleManager.bundleMap.main.pluginScript"}));const e=new Set;return this.__task.bundleManager.bundles.forEach(t=>{for(const s of t.pluginScript)e.add(s)}),e}}exports.InternalBuildResult=InternalBuildResult;class BuildResult{constructor(e){this.__task=e,this.dest=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e.options.buildPath),e.options.outputName),this.settings=e.result.settings}get paths(){return this.__task.result.paths}containsAsset(e){return!!this.__task.bundleManager.bundles.find(t=>t.containsAsset(e))}getRawAssetPaths(e){if(!asset_library_1.buildAssetLibrary.getAssetInfo(e))return[];const t=this.__task.bundleManager.bundles.filter(t=>t.containsAsset(e,!0));return t.length?t.map(t=>{const s={bundleName:t.name,raw:[]};return t.getRedirect(e)&&(s.redirect=t.getRedirect(e)),s.raw=BundleUtils.getRawAssetPaths(e,t),s}):[]}getAssetPathInfo(e){const t=this.__task.bundleManager.bundles.filter(t=>t.containsAsset(e,!0));return t.length?t.map(t=>{const s={bundleName:t.name};return t.getRedirect(e)?s.redirect=t.getRedirect(e):Object.assign(s,BundleUtils.getAssetPathInfo(e,t)),s}):[]}getJsonPathInfo(e){const t=this.__task.bundleManager.bundles.filter(t=>t.containsAsset(e));return t.length?t.map(t=>{const s={bundleName:t.name};return t.getRedirect(e)?s.redirect=t.getRedirect(e):Object.assign(s,(0,utils_1.getJsonPathInfo)(e,t)),s}):[]}}exports.BuildResult=BuildResult;