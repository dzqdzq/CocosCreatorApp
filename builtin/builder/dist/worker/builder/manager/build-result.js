"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildResult=exports.InternalBuildResult=void 0;const path_1=require("path"),asset_library_1=require("./asset-library"),bundle_utils_1=require("../../../share/bundle-utils"),stage_task_manager_1=require("../stage-task-manager");class Paths{constructor(t){this.cache={},this.dir=t||"",this.compileConfig=(0,path_1.join)(t,stage_task_manager_1.BuildStageTask.optionsFileName)}get settings(){return this.cache.settings||(0,path_1.join)(this.dir,"src","settings.json")}set settings(t){this.cache.settings=t}get subpackages(){return this.cache.subpackages||(0,path_1.join)(this.dir,Build.SUBPACKAGES_HEADER)}set subpackages(t){this.cache.subpackages=t}get assets(){return this.cache.assets||(0,path_1.join)(this.dir,Build.ASSETS_HEADER)}set assets(t){this.cache.assets=t}get remote(){return this.cache.remote||(0,path_1.join)(this.dir,Build.REMOTE_HEADER)}set remote(t){this.cache.remote=t}get applicationJS(){return this.cache.applicationJS||(0,path_1.join)(this.dir,"application.js")}set applicationJS(t){this.cache.applicationJS=t}get importMap(){return this.cache.importMap||(0,path_1.join)(this.dir,"import-map.js")}set importMap(t){this.cache.importMap=t}get bundleScripts(){return this.cache.bundleScripts||(0,path_1.join)(this.dir,"src",Build.BUNDLE_SCRIPTS_HEADER)}set bundleScripts(t){this.cache.bundleScripts=t}}class InternalBuildResult{constructor(t,s){this.settings={debug:!0,CocosEngine:"0.0.0",designResolution:{width:960,height:640,policy:0},platform:"web-desktop",exactFitScreen:!0,bundleVers:{},subpackages:[],remoteBundles:[],hasResourcesBundle:!1,hasStartSceneBundle:!1,launchScene:"",jsList:[],moduleIds:[],renderPipeline:"",engineModules:[],server:"",customLayers:[],preloadAssets:[]},this.plugins=[],this.bundleMap={},this.bundles=[],this.scriptPackages=[],this.pluginVers={},this.imageTaskMap={},this.compressImageResult={},this.importMap={imports:{}},this.compileOptions=null,this.rawOptions=JSON.parse(JSON.stringify(t.options));let e=(0,path_1.join)(Editor.Project.path,"build","preview");s||(e=(0,path_1.join)(Editor.UI.File.resolveToRaw(t.options.buildPath),t.options.outputName)),this.paths=new Paths(e),this._task=t}getOutputSettings(){const t=[];return this.settings.hasStartSceneBundle&&t.push({bundle:"start-scene"}),this.settings.hasResourcesBundle&&t.push({bundle:"resources"}),t.push({bundle:"main"}),{CocosEngine:this.settings.CocosEngine,engine:{debug:this.settings.debug,platform:this.settings.platform,customLayers:this.settings.customLayers,macros:this.settings.macros||{},builtinAssets:Array.from(this.bundleMap[bundle_utils_1.BuiltinBundleName.INTERNAL]._rootAssets)},animation:{customJointTextureLayouts:this.settings.customJointTextureLayouts},assets:{server:this.settings.server,remoteBundles:this.settings.remoteBundles,subpackages:this.settings.subpackages,preloadBundles:t,bundleVers:this.settings.bundleVers,preloadAssets:this.settings.preloadAssets,projectBundles:this.bundles.map(t=>t.name)},plugins:{jsList:this.settings.jsList},scripting:{scriptPackages:this.settings.scriptPackages},launch:{launchScene:this.settings.launchScene},screen:{exactFitScreen:this.settings.exactFitScreen,designResolution:this.settings.designResolution,orientation:this.settings.orientation},physics:this.settings.physics,rendering:{renderPipeline:this.settings.renderPipeline},splashScreen:this.settings.splashScreen}}addBundle(t){this.bundleMap[t.name]||(this.bundleMap[t.name]=t,this.bundles.push(t),t.cache=this._task.cache)}addPlugin(t){t&&(this.plugins.includes(t.uuid)||this.plugins.push(t.uuid))}}exports.InternalBuildResult=InternalBuildResult;class BuildResult{constructor(t){this.__task=t,this.dest=(0,path_1.join)(Editor.UI.File.resolveToRaw(t.options.buildPath),t.options.outputName)}get paths(){return this.__task.result.paths}containsAsset(t){return!!this.__task.result.bundles.find(s=>s.containsAsset(t))}getRawAssetPaths(t){if(!asset_library_1.buildAssetLibrary.asset[t])return[];const s=this.__task.result.bundles.filter(s=>s.containsAsset(t,!0));return s.length?s.map(s=>{const e={bundleName:s.name,raw:[]};return s.getRedirect(t)&&(e.redirect=s.getRedirect(t)),e.raw=s.getRawAssetPaths(t),e}):[]}getAssetPathInfo(t){const s=this.__task.result.bundles.filter(s=>s.containsAsset(t,!0));return s.length?s.map(s=>{const e={bundleName:s.name};return s.getRedirect(t)?e.redirect=s.getRedirect(t):Object.assign(e,s.getAssetPathInfo(t)),e}):[]}getJsonPathInfo(t){const s=this.__task.result.bundles.filter(s=>s.containsAsset(t));return s.length?s.map(s=>{const e={bundleName:s.name};return s.getRedirect(t)?e.redirect=s.getRedirect(t):Object.assign(e,s.getJsonPathInfo(t)),e}):[]}}exports.BuildResult=BuildResult;