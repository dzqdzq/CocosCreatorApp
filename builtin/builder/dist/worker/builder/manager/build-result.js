"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildResult=exports.InternalBuildResult=void 0;const path_1=require("path"),asset_library_1=require("./asset-library");class Paths{constructor(t){this.cache={},this.dir=t||""}get settings(){return this.cache.settings||path_1.join(this.dir,"src","settings.json")}set settings(t){this.cache.settings=t}get subpackages(){return this.cache.subpackages||path_1.join(this.dir,Build.SUBPACKAGES_HEADER)}set subpackages(t){this.cache.subpackages=t}get assets(){return this.cache.assets||path_1.join(this.dir,Build.ASSETS_HEADER)}set assets(t){this.cache.assets=t}get remote(){return this.cache.remote||path_1.join(this.dir,Build.REMOTE_HEADER)}set remote(t){this.cache.remote=t}get applicationJS(){return this.cache.applicationJS||path_1.join(this.dir,"application.js")}set applicationJS(t){this.cache.applicationJS=t}get importMap(){return this.cache.importMap||path_1.join(this.dir,"import-map.js")}set importMap(t){this.cache.importMap=t}get bundleScripts(){return this.cache.bundleScripts||path_1.join(this.dir,"src",Build.BUNDLE_SCRIPTS_HEADER)}set bundleScripts(t){this.cache.bundleScripts=t}}class InternalBuildResult{constructor(t,e){this.settings={debug:!0,CocosEngine:"0.0.0",designResolution:{width:960,height:640,policy:0},platform:"web-desktop",bundleVers:{},subpackages:[],remoteBundles:[],hasResourcesBundle:!1,hasStartSceneBundle:!1,launchScene:"",jsList:[],moduleIds:[],renderPipeline:"",engineModules:[]},this.plugins=[],this.bundleMap={},this.bundles=[],this.scriptPackages=[],this.pluginVers={},this.imageTaskMap={},this.compressImageResult={},this.importMap={},this.compileOptions=null,this.rawOptions=JSON.parse(JSON.stringify(t.options));let s=path_1.join(Editor.Project.path,"build","preview");e||(s=path_1.join(Editor.UI.File.resolveToRaw(t.options.buildPath),t.options.outputName)),this.paths=new Paths(s),this._task=t}addBundle(t){this.bundleMap[t.name]||(this.bundleMap[t.name]=t,this.bundles.push(t),t.cache=this._task.cache)}addPlugin(t){t&&(this.plugins.includes(t.uuid)||this.plugins.push(t.uuid))}}exports.InternalBuildResult=InternalBuildResult;class BuildResult{constructor(t){this.__task=t,this.dest=path_1.join(Editor.UI.File.resolveToRaw(t.options.buildPath),t.options.outputName)}get paths(){return this.__task.result.paths}containsAsset(t){return!!this.__task.result.bundles.find(e=>e.containsAsset(t))}getRawAssetPaths(t){const e=asset_library_1.buildAssetLibrary.asset[t];if(!e||!Object.keys(e.library).filter(t=>".json"!==t).length)return[];const s=this.__task.result,i=s.bundles.filter(e=>e.containsAsset(t));return i.length?i.map(e=>{const i={bundleName:e.name,raw:[]};e.getRedirect(t)&&(i.redirect=e.getRedirect(t));let a=s.compressImageResult[t];if(e.atlasRes.assetsToImage[t]&&(a=s.compressImageResult[e.atlasRes.assetsToImage[t]]),a&&a.files.length){i.raw=a.files.filter(t=>t.startsWith(e.dest));const s=e.assetVer.native[t];s&&(i.raw=i.raw.map(t=>t.replace(path_1.extname(t),`.${s}.${path_1.extname(t)}`)))}else i.raw=e.getRawAssetPaths(t);return i}):[]}getAssetPathInfo(t){const e=this.__task.result.bundles.filter(e=>e.containsAsset(t));return e.length?e.map(e=>{const s={bundleName:e.name};return e.getRedirect(t)?s.redirect=e.getRedirect(t):Object.assign(s,e.getAssetPathInfo(t)),s}):[]}getJsonPathInfo(t){const e=this.__task.result.bundles.filter(e=>e.containsAsset(t));return e.length?e.map(e=>{const s={bundleName:e.name};return e.getRedirect(t)?s.redirect=e.getRedirect(t):Object.assign(s,e.getJsonPathInfo(t)),s}):[]}}exports.BuildResult=BuildResult;