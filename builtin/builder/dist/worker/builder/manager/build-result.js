"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildResult=exports.InternalBuildResult=void 0;const path_1=require("path"),asset_library_1=require("./asset-library"),stage_task_manager_1=require("../stage-task-manager"),minimaps_1=require("../build-task/image/minimaps"),utils_1=require("../build-task/image/texture-compress/utils"),Sharp=require("sharp");class Paths{constructor(s){this.cache={},this.dir=s||"",this.compileConfig=(0,path_1.join)(s,stage_task_manager_1.BuildStageTask.optionsFileName)}get settings(){return this.cache.settings||(0,path_1.join)(this.dir,"src","settings.json")}set settings(s){this.cache.settings=s}get subpackages(){return this.cache.subpackages||(0,path_1.join)(this.dir,Build.SUBPACKAGES_HEADER)}set subpackages(s){this.cache.subpackages=s}get assets(){return this.cache.assets||(0,path_1.join)(this.dir,Build.ASSETS_HEADER)}set assets(s){this.cache.assets=s}get remote(){return this.cache.remote||(0,path_1.join)(this.dir,Build.REMOTE_HEADER)}set remote(s){this.cache.remote=s}get applicationJS(){return this.cache.applicationJS||(0,path_1.join)(this.dir,"application.js")}set applicationJS(s){this.cache.applicationJS=s}get importMap(){return this.cache.importMap||(0,path_1.join)(this.dir,"import-map.js")}set importMap(s){this.cache.importMap=s}get bundleScripts(){return this.cache.bundleScripts||(0,path_1.join)(this.dir,"src",Build.BUNDLE_SCRIPTS_HEADER)}set bundleScripts(s){this.cache.bundleScripts=s}}class InternalBuildResult{constructor(s,e){this.settings={CocosEngine:"0.0.0",engine:{debug:!0,platform:"web-desktop",customLayers:[],sortingLayers:[],macros:{},builtinAssets:[]},animation:{customJointTextureLayouts:[]},assets:{server:"",remoteBundles:[],subpackages:[],preloadBundles:[],bundleVers:{},preloadAssets:[],projectBundles:[]},plugins:{jsList:[]},scripting:{},launch:{launchScene:""},screen:{exactFitScreen:!0,designResolution:{width:960,height:640,policy:0}},rendering:{renderPipeline:""}},this.plugins=[],this.bundleMap={},this.bundles=[],this.scriptPackages=[],this.pluginVers={},this.imageCompressTaskMap={},this.compressImageResult={},this.imageMipmapFiles={},this._presetIdToCompressOption={},this.importMap={imports:{}},this.compileOptions=null,this.rawOptions=JSON.parse(JSON.stringify(s.options));let t=(0,path_1.join)(Editor.Project.path,"build","preview");e||(t=(0,path_1.join)(Editor.UI.File.resolveToRaw(s.options.buildPath),s.options.outputName)),this.paths=new Paths(t),this._task=s}addBundle(s){this.bundleMap[s.name]||(this.bundleMap[s.name]=s,this.bundles.push(s),s.cache=this._task.cache)}addPlugin(s){s&&(this.plugins.includes(s.uuid)||this.plugins.push(s.uuid))}async getMipmapFiles(s,e){if(this.imageMipmapFiles[s])return this.imageMipmapFiles[s];const t=await(0,minimaps_1.genMipmapFiles)(s,e);return this.imageMipmapFiles[s]=t,t}async addImageTask(s,e){const t=await this._getCompressConfig(e.presetId);t&&((0,utils_1.checkCompressOptions)(t.compressOptions,e.hasAlpha,s),this.imageCompressTaskMap[s]?(this.imageCompressTaskMap[s].bundleNames.push(e.bundleName),this.imageCompressTaskMap[s].dest.push(e.dest)):this.imageCompressTaskMap[s]={src:e.src,presetId:e.presetId,compressOptions:t.compressOptions,suffixMap:t.suffixMap,bundleNames:[e.bundleName],dest:[e.dest]})}removeImageTask(s){delete this.imageCompressTaskMap[s]}async _getCompressConfig(s){if(this._presetIdToCompressOption[s])return;const{userPreset:e,defaultConfig:t,customConfigs:i}=await Editor.Profile.getProject("builder","textureCompressConfig"),{platformConfig:a,customFormats:r,formatsInfo:n,textureFormatConfigs:o}=await Editor.Message.request("builder","query-compress-config");if(!a[this.rawOptions.platform])return;const p=a[this.rawOptions.platform].textureCompressConfig;if(!p)return;const u=p.platformType,c=e[s]||t[s]||t.default;if(!c||!c.options[u])return void console.debug(`Invalid compress task: ${JSON.stringify(c)}`);const l=p.support,h={},d={};Object.keys(c.options[u]).forEach(s=>{([...l.rgba,...l.rgb].includes(s)||Object.keys(r).includes(s))&&(h[s]=JSON.parse(JSON.stringify(c.options[u][s])),d[s]=o[n[s].formatType].suffix)});const m={};return i&&Object.values(i).length&&Object.values(i).forEach(s=>{s.overwrite&&(m[s.format]=s.id,console.debug(`compress format (${s.format}) will be overwrited by custom compress ${s.id}(${s.name})`))}),Object.keys(m).forEach(s=>{h[s]&&(h[m[s]]=h[s],delete h[s])}),Object.keys(h).length?{compressOptions:h,suffixMap:d}:void 0}}exports.InternalBuildResult=InternalBuildResult;class BuildResult{constructor(s){this.__task=s,this.dest=(0,path_1.join)(Editor.UI.File.resolveToRaw(s.options.buildPath),s.options.outputName),this.settings=s.result.settings}get paths(){return this.__task.result.paths}containsAsset(s){return!!this.__task.result.bundles.find(e=>e.containsAsset(s))}getRawAssetPaths(s){if(!asset_library_1.buildAssetLibrary.getAssetInfo(s))return[];const e=this.__task.result.bundles.filter(e=>e.containsAsset(s,!0));return e.length?e.map(e=>{const t={bundleName:e.name,raw:[]};return e.getRedirect(s)&&(t.redirect=e.getRedirect(s)),t.raw=e.getRawAssetPaths(s)||[],t}):[]}getAssetPathInfo(s){const e=this.__task.result.bundles.filter(e=>e.containsAsset(s,!0));return e.length?e.map(e=>{const t={bundleName:e.name};return e.getRedirect(s)?t.redirect=e.getRedirect(s):Object.assign(t,e.getAssetPathInfo(s)),t}):[]}getJsonPathInfo(s){const e=this.__task.result.bundles.filter(e=>e.containsAsset(s));return e.length?e.map(e=>{const t={bundleName:e.name};return e.getRedirect(s)?t.redirect=e.getRedirect(s):Object.assign(t,e.getJsonPathInfo(s)),t}):[]}}function isPowerOfTwo(s){return s>0&&0==(s&s-1)}exports.BuildResult=BuildResult;