"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTaskBase=void 0;const events_1=__importDefault(require("events"));class BuildTaskBase extends events_1.default{constructor(e){super(),this.progress=0,this.hookWeight=.4,this.name=e}async break(e){return new Promise(e=>{this.breakResolve=e})}onError(e,t=!0){if(this.error=e,t)throw e}updateProcess(e,t=0){this.progress=Editor.Utils.Math.clamp01(this.progress+t),this.emit("update",e,this.progress)}async runPluginTask(e,t){var s;if(!Object.keys(this.hookMap).length||this.error||(null===(s=this.options)||void 0===s?void 0:s.preview))return;const r=this.hookWeight/Object.keys(this.hookMap).length;for(let t=0;t<this.hooksInfo.pkgNameOrder.length;t++){if(this.breakResolve){this.breakResolve(),this.onError(new Error(`${this.name} task is break!`));break}if(this.error)return;const s=this.hooksInfo.pkgNameOrder[t],o=this.hooksInfo.infos[s];let i;try{const t=`// ---- build task ${s}：${e} ----`;if(Editor.Metrics.trackTimeStart(t),(i=Editor.Module.__protected__.requireFile(o.path))[e]){this.updateProcess(`${s}:(${e}) start...`),console.debug(t),await this.handleHook(i[e],o.internal);const a=await Editor.Metrics.trackTimeEnd(t,{output:!0});this.updateProcess(`${s}:(${e}) in ${a} ms ✓`,r)}}catch(t){const a=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:s,funcName:e});this.updateProcess(a,r),this.updateProcess(t+"",r),(i&&i.throwError||o.internal)&&this.onError(t)}}}}exports.BuildTaskBase=BuildTaskBase;