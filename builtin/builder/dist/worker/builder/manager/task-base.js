"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTaskBase=void 0;const events_1=__importDefault(require("events"));class BuildTaskBase extends events_1.default{constructor(e){super(),this.progress=0,this.hookWeight=.4,this.name=e}async break(e){return new Promise(e=>{this.breakResolve=e})}onError(e,r=!0){if(this.error=e,r)throw e}updateProcess(e,r=0,t="debug"){r&&(this.progress=Editor.Utils.Math.clamp01(this.progress+r)),this.emit("update",e,this.progress),console[t](`${e}, progress: ${(100*this.progress).toFixed(0)}%`)}async runPluginTask(t,e){var r;if(!(!Object.keys(this.hookMap).length||this.error||null!=(r=this.options)&&r.preview)){var s=this.hookWeight/Object.keys(this.hookMap).length;for(let e=0;e<this.hooksInfo.pkgNameOrder.length;e++){if(this.breakResolve){this.breakResolve(),this.onError(new Error(this.name+" task is break!"));break}if(this.error)return;var o=this.hooksInfo.pkgNameOrder[e],i=this.hooksInfo.infos[o];let r;try{var a,h=`// ---- build task ${o}：${t} ----`;Editor.Metrics.trackTimeStart(h),(r=Editor.Module.__protected__.requireFile(i.path))[t]&&(this.updateProcess(o+`:(${t}) start...`),console.debug(h),await this.handleHook(r[t],i.internal),a=await Editor.Metrics.trackTimeEnd(h,{output:!0}),this.updateProcess(o+`:(${t}) in ${a} ms ✓`,s))}catch(e){o=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:o,funcName:t});this.updateProcess(o,s,"error"),this.updateProcess(e+"",s),(r&&r.throwError||i.internal)&&this.onError(e)}}}}}exports.BuildTaskBase=BuildTaskBase;