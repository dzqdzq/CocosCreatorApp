"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils");async function handle(e,s,t){let o=0;const{platformConfig:r,formatsInfo:a}=await Editor.Message.request("builder","query-compress-config");if(!r[e.platform])return;async function n(e,r){const a=e.uuid,n=await t.getMeta(a),i=n.userData.compressSettings;if(!i||!i.useCompressTexture)return;const u=(0,path_1.extname)(e.source),p=e.library[u]||e.library[".png"];if(!p)return void console.warn(`Image asset does not exist: ${e.source}`);const d=(0,path_1.basename)(p);await s.addImageTask(a,{src:p,dest:(0,path_1.join)(a.substr(0,2),d),presetId:i.presetId,hasAlpha:n.userData.hasAlpha,bundleName:r.name}),o++}const i={};for(const e of s.bundles){const s=[];for(const o of e.assetsWithoutRedirect){i[o]=!0;const r=t.getAssetInfo(o);"image"!==r.importer&&"gltf-embeded-image"!==r.importer||(s.push(o),await n(r,e))}e.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&e.compressionType!==bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON&&(s.length>1&&(s.forEach(s=>{e.removeFromGroups(s)}),e.addGroup("IMAGE",s)))}console.debug(`Number of image-compress task: ${o}`)}exports.title="i18n:builder.tasks.sort_image",exports.name="data-task/image",exports.handle=handle;