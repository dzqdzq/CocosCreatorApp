"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const path_1=require("path"),bundle_utils_1=require("../../../share/bundle-utils");async function handle(e,s,t){let a=0;async function o(e,o){const r=e.uuid,{userData:{compressSettings:n,hasAlpha:i}}=await t.getMeta(r);if(!n||!n.useCompressTexture)return;const p=(0,path_1.extname)(e.source),u=e.library[p]||e.library[".png"];if(!u)return void console.warn(`Image asset does not exist: ${e.source}`);const l=(0,path_1.basename)(u);s.imageTaskMap[r]?(s.imageTaskMap[r].dest.push((0,path_1.join)(r.substr(0,2),l)),s.imageTaskMap[r].bundleNames.push(o.name)):s.imageTaskMap[r]={src:u,dest:[(0,path_1.join)(r.substr(0,2),l)],presetId:n.presetId,hasAlpha:i,bundleNames:[o.name]},a++}const r={};for(const e of s.bundles){(0,path_1.join)(e.dest,e.nativeBase);const s=[];for(const a of e.assetsWithoutRedirect){r[a]=!0;const n=t.getAssetInfo(a);"image"!==n.importer&&"gltf-embeded-image"!==n.importer||(s.push(a),await o(n,e))}e.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&e.compressionType!==bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON&&(s.length>1&&(s.sort((e,s)=>e.localeCompare(s,"en",{numeric:!0})),s.forEach(s=>{e.removeFromGroups(s)}),e.addGroup("IMAGE",s)))}console.debug(`Number of image-compress task: ${a}`)}exports.title="i18n:builder.tasks.sort_image",exports.name="data-task/image",exports.handle=handle;