"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const bundle_utils_1=require("../../../share/bundle-utils"),fs_extra_1=require("fs-extra"),path_1=require("path");async function handle(e,s,t){const{MAIN:n,START_SCENE:r,INTERNAL:o}=bundle_utils_1.BuiltinBundleName;console.debug("init bundle assets");try{const n=await queryPreloadAssetList(e.includeModules);console.debug(`Query preload assets from cc.config.json: ${n.toString()}`),n.forEach(e=>{s.bundleMap[o].addRootAsset(t.getAssetInfo(e))})}catch(e){console.error(e)}const a=s.bundleMap[r]||s.bundleMap[n];for(const r of t.scenes){const t=s.bundles.find(e=>r.url.startsWith(e.root+"/"));if(t)t.addScene(r.uuid);else{let t=!0;e.scenes&&Array.isArray(e.scenes)&&(t=e.scenes.some(e=>e.uuid===r.uuid)),t&&s.bundleMap[n].addScene(r.uuid)}e.startScene===r.uuid&&a.addScene(r.uuid)}console.debug(`Number of scenes: ${s.bundleMap[n].scenes.length}`);for(const e of t.assetUuids){const n=t.getAssetInfo(e),r=s.bundles.find(e=>n.url.startsWith(e.root+"/"));r&&r.addRootAsset(n)}if(e.renderPipeline&&a.addRootAsset(t.getAssetInfo(e.renderPipeline)),e.physicsConfig.defaultMaterial){const s=t.getAssetInfo(e.physicsConfig.defaultMaterial);a.addRootAsset(s)}if(e.preview)return;console.debug("Start sort share asset in bundle");const i={};async function d(s,n,r,o){var a,u;if(r.has(s))return;const c=t.getAssetInfo(s);if(!c)return void(o||console.warn(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${s})}`})));if(r.add(s),n.addAsset(s),c.library[".cconb"]){const s=e.assetSerializeOptions.exportCCON?".ccon":".cconb";(null!==(a=(u=n.config.extensionMap)[s])&&void 0!==a?a:u[s]=[]).push(c.uuid)}if(i[s])return void n.addRedirect(s,i[s]);const l=await t.getDependUuids(s);await Promise.all(l.map(async e=>await d(e,n,r,s)))}let u=new Array(21);s.bundles.forEach(e=>{u[e.priority-1]||(u[e.priority-1]=[]),u[e.priority-1].push(e)}),u=u.filter(e=>e).reverse();for(const e of u)await Promise.all(e.map(async e=>{console.debug(`Start sort share asset in bundle ${e.name} with assets ${e.assetsWithoutRedirect.length}}`);const s=new Set;return await Promise.all(e.scenes.concat(e.rootAssets).map(async t=>await d(t,e,s)))})),e.forEach(e=>{e.assetsWithoutRedirect.forEach(s=>{i[s]||(i[s]=e.name)})});console.debug(`Number of assets: ${Object.keys(i).length}`),console.debug(`Number of asset bundle: ${s.bundles.length}`)}exports.title="i18n:builder.tasks.sort_asset",exports.handle=handle;const featuresWithDependencies=[],preloadAssets=[];function traversalDependencies(e,s){e.forEach(e=>{if(s[e]&&!featuresWithDependencies.includes(e)&&(featuresWithDependencies.push(e),s[e].dependentAssets&&preloadAssets.push(...s[e].dependentAssets),s[e].dependentModules)){traversalDependencies(s[e].dependentModules,s)}})}async function queryPreloadAssetList(e){const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=(await(0,fs_extra_1.readJSON)((0,path_1.join)(s,"cc.config.json"))).features;return featuresWithDependencies.length=0,preloadAssets.length=0,traversalDependencies(e,t),Array.from(new Set(preloadAssets))}