"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const bundle_utils_1=require("../../../share/bundle-utils"),fs_extra_1=require("fs-extra"),path_1=require("path");async function handle(e,s,t){const{MAIN:n,START_SCENE:r}=bundle_utils_1.BuiltinBundleName;try{const r=await queryPreloadAssetList(e.includeModules);console.debug(`Query preload assets from cc.config.json: ${r.toString()}`),s.settings.preloadAssets=r,r.forEach(e=>{s.bundleMap[n].addRootAsset(t.getAssetInfo(e))})}catch(e){console.error(e)}const o=s.bundleMap[r]||s.bundleMap[n];for(const r of t.sceneUuids){const a=t.getAssetInfo(r),i=s.bundles.find(e=>a.url.startsWith(e.root+"/"));if(i)i.addScene(a);else{let t=!0;e.scenes&&0!==e.scenes.length&&(t=e.scenes.some(e=>e.uuid===r)),t&&s.bundleMap[n].addScene(a)}e.startScene===r&&o.addScene(a)}console.debug(`Number of scenes: ${s.bundleMap[n].scenes.length}`);for(const e of t.assetUuids){const n=t.getAssetInfo(e),r=s.bundles.find(e=>n.url.startsWith(e.root+"/"));r&&r.addRootAsset(n)}if(e.renderPipeline){const s=t.getAssetInfo(e.renderPipeline);o.addRootAsset(s)}if(e.preview)return;const a={};async function i(s,n,r=new Set,o){var d,c;if(r.has(s))return;const u=t.getAssetInfo(s);if(!u){if(o){const e=t.getAssetInfo(o);console.error(Editor.I18n.t("builder.error.required_asset_missing",{uuid:`{asset(${s})}`,fatherUrl:`{asset(${e.url})}`}))}else console.error(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${s})}`}));return}if(r.add(s),n.addAsset(u),u.library[".cconb"]){const s=e.assetSerializeOptions.exportCCON?".ccon":".cconb";(null!==(d=(c=n.config.extensionMap)[s])&&void 0!==d?d:c[s]=[]).push(u.uuid)}if(a[s])return void n.addRedirect(u,a[s]);const l=await t.getDependUuids(s);await Promise.all(l.map(async e=>await i(e,n,r,s)))}let d=new Array(20);s.bundles.forEach(e=>{d[e.priority-1]||(d[e.priority-1]=[]),d[e.priority-1].push(e)}),d=d.filter(e=>e).reverse();for(const e of d)await Promise.all(e.map(async e=>await Promise.all(e.scenes.concat(e.rootAssets).map(async s=>await i(s,e))))),e.forEach(e=>{e.assetsWithoutRedirect.forEach(s=>{a[s]||(a[s]=e.name)})});e.preview||(console.debug(`Number of assets: ${Object.keys(a).length}`),console.debug(`Number of asset bundle: ${s.bundles.length}`))}async function queryPreloadAssetList(e){const s=(await Editor.Message.request("engine","query-info")).path,t=await fs_extra_1.readJSON(path_1.join(s,"cc.config.json")),n=[];return e.forEach(e=>{t.features[e]&&t.features[e].dependentAssets&&n.push(...t.features[e].dependentAssets)}),Array.from(new Set(n))}exports.title="i18n:tasks.sort_asset",exports.handle=handle;