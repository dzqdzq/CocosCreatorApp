"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const bundle_utils_1=require("../../../share/bundle-utils"),fs_extra_1=require("fs-extra"),path_1=require("path");async function handle(e,s,t){const{MAIN:n,START_SCENE:r,INTERNAL:o}=bundle_utils_1.BuiltinBundleName;try{const n=await queryPreloadAssetList(e.includeModules);console.debug(`Query preload assets from cc.config.json: ${n.toString()}`),n.forEach(e=>{s.bundleMap[o].addRootAsset(t.getAssetInfo(e))})}catch(e){console.error(e)}const a=s.bundleMap[r]||s.bundleMap[n];for(const r of t.sceneUuids){const o=t.getAssetInfo(r),i=s.bundles.find(e=>o.url.startsWith(e.root+"/"));if(i)i.addScene(o);else{let t=!0;e.scenes&&Array.isArray(e.scenes)&&(t=e.scenes.some(e=>e.uuid===r)),t&&s.bundleMap[n].addScene(o)}e.startScene===r&&a.addScene(o)}console.debug(`Number of scenes: ${s.bundleMap[n].scenes.length}`);for(const e of t.assetUuids){const n=t.getAssetInfo(e),r=s.bundles.find(e=>n.url.startsWith(e.root+"/"));r&&r.addRootAsset(n)}if(e.renderPipeline){const s=t.getAssetInfo(e.renderPipeline);a.addRootAsset(s)}if(e.preview)return;const i={};async function d(s,n,r=new Set,o){var a,c;if(r.has(s))return;const u=t.getAssetInfo(s);if(!u){if(o){t.getAssetInfo(o)}else console.warn(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${s})}`}));return}if(r.add(s),n.addAsset(u),u.library[".cconb"]){const s=e.assetSerializeOptions.exportCCON?".ccon":".cconb";(null!==(a=(c=n.config.extensionMap)[s])&&void 0!==a?a:c[s]=[]).push(u.uuid)}if(i[s])return void n.addRedirect(u,i[s]);const l=await t.getDependUuids(s);await Promise.all(l.map(async e=>await d(e,n,r,s)))}let c=new Array(21);s.bundles.forEach(e=>{c[e.priority-1]||(c[e.priority-1]=[]),c[e.priority-1].push(e)}),c=c.filter(e=>e).reverse();for(const e of c)await Promise.all(e.map(async e=>await Promise.all(e.scenes.concat(e.rootAssets).map(async s=>await d(s,e))))),e.forEach(e=>{e.assetsWithoutRedirect.forEach(s=>{i[s]||(i[s]=e.name)})});e.preview||(console.debug(`Number of assets: ${Object.keys(i).length}`),console.debug(`Number of asset bundle: ${s.bundles.length}`))}async function queryPreloadAssetList(e){const s=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=await(0,fs_extra_1.readJSON)((0,path_1.join)(s,"cc.config.json")),n=[];return e.forEach(e=>{t.features[e]&&t.features[e].dependentAssets&&n.push(...t.features[e].dependentAssets)}),Array.from(new Set(n))}exports.title="i18n:builder.tasks.sort_asset",exports.handle=handle;