"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const bundle_utils_1=require("../../../share/bundle-utils");async function handle(e,s,t){const{MAIN:n,START_SCENE:o}=bundle_utils_1.BuiltinBundleName,r=s.bundleMap[o]||s.bundleMap[n];for(const o of t.sceneUuids){const i=t.getAssetInfo(o),a=s.bundles.find(e=>i.url.startsWith(e.root+"/"));if(a)a.addScene(i);else{let t=!0;e.scenes&&0!==e.scenes.length&&(t=e.scenes.some(e=>e.uuid===o)),t&&s.bundleMap[n].addScene(i)}e.startScene===o&&r.addScene(i)}console.debug(`Number of scenes: ${s.bundleMap[n].scenes.length}`);for(const e of t.assetUuids){const n=t.getAssetInfo(e),o=s.bundles.find(e=>n.url.startsWith(e.root+"/"));o&&o.addRootAsset(n)}if(e.renderPipeline){const s=t.getAssetInfo(e.renderPipeline);r.addRootAsset(s)}if(e.preview)return;const i={};async function a(s,n,o=new Set,r){var d,l;if(o.has(s))return;const u=t.getAssetInfo(s);if(!u){if(r){const e=t.getAssetInfo(r);console.error(Editor.I18n.t("builder.error.required_asset_missing",{uuid:`{asset(${s})}`,fatherUrl:`{asset(${e.url})}`}))}else console.error(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${s})}`}));return}if(o.add(s),n.addAsset(u),u.library[".cconb"]){const s=e.assetSerializeOptions.exportCCON?".ccon":".cconb";(null!==(d=(l=n.config.extensionMap)[s])&&void 0!==d?d:l[s]=[]).push(u.uuid)}if(i[s])return void n.addRedirect(u,i[s]);const c=await t.getDependUuids(s);await Promise.all(c.map(async e=>await a(e,n,o,s)))}let d=new Array(20);s.bundles.forEach(e=>{d[e.priority-1]||(d[e.priority-1]=[]),d[e.priority-1].push(e)}),d=d.filter(e=>e).reverse();for(const e of d)await Promise.all(e.map(async e=>await Promise.all(e.scenes.concat(e.rootAssets).map(async s=>await a(s,e))))),e.forEach(e=>{e.assetsWithoutRedirect.forEach(s=>{i[s]||(i[s]=e.name)})});e.preview||(console.debug(`Number of assets: ${Object.keys(i).length}`),console.debug(`Number of asset bundle: ${s.bundles.length}`))}exports.title="i18n:tasks.sort_asset",exports.handle=handle;