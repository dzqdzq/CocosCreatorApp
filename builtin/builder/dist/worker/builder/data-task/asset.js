"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const bundle_utils_1=require("../../../share/bundle-utils");async function handle(e,s,t){const{MAIN:n,START_SCENE:r}=bundle_utils_1.BuiltinBundleName,o=s.bundleMap[r]||s.bundleMap[n];for(const r of t.sceneUuids){const i=t.getAssetInfo(r),a=s.bundles.find(e=>i.url.startsWith(e.root+"/"));if(a)a.addScene(i);else{let t=!0;e.scenes&&0!==e.scenes.length&&(t=e.scenes.some(e=>e.uuid===r)),t&&s.bundleMap[n].addScene(i)}e.startScene===r&&o.addScene(i)}console.debug(`Number of scenes: ${s.bundleMap[n].scenes.length}`);for(const e of t.assetUuids){const n=t.getAssetInfo(e),r=s.bundles.find(e=>n.url.startsWith(e.root+"/"));r&&r.addRootAsset(n)}if(e.renderPipeline){const s=t.getAssetInfo(e.renderPipeline);o.addRootAsset(s)}if(e.preview)return;const i={};async function a(e,s,n=new Set,r){if(n.has(e))return;const o=t.getAssetInfo(e);if(!o){if(r){const s=t.getAssetInfo(r);console.error(Editor.I18n.t("builder.error.required_asset_missing",{uuid:`{asset(${e})}`,fatherUrl:`{asset(${s.url})}`}))}else console.error(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${e})}`}));return}if(n.add(e),s.addAsset(o),i[e])return void s.addRedirect(o,i[e]);const d=await t.getDependUuids(e);await Promise.all(d.map(async t=>await a(t,s,n,e)))}let d=new Array(20);s.bundles.forEach(e=>{d[e.priority-1]||(d[e.priority-1]=[]),d[e.priority-1].push(e)}),d=d.filter(e=>e).reverse();for(const e of d)await Promise.all(e.map(async e=>await Promise.all(e.scenes.concat(e.rootAssets).map(async s=>await a(s,e))))),e.forEach(e=>{e.assetsWithoutRedirect.forEach(s=>{i[s]||(i[s]=e.name)})});console.debug(`Number of assets: ${Object.keys(i).length}`),console.debug(`Number of asset bundle: ${s.bundles.length}`)}exports.title="i18n:tasks.sort_asset",exports.handle=handle;