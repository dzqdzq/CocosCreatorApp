"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var s=Object.getOwnPropertyDescriptor(r,t);s&&("get"in s?r.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,s)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.quickSpawn=exports.getMemorySize=exports.patchMd5ToPath=exports.calcMd5=exports.appendMd5ToPaths=exports.createBundle=exports.getModuleFiles=exports.compileJS=exports.transformCode=exports.toBabelModules=exports.getRealTime=exports.getCurrentTime=exports.getResRawAssetsPath=exports.getResImportPath=exports.nameToSubId=exports.getUuidFromPath=exports.decompressUuid=exports.compressUuid=exports.transI18nName=exports.copyDirSync=exports.getFileSizeDeep=exports.isInstallNodeJs=exports.relativeUrl=exports.dbUrlToRawPath=exports.removeDbHeader=exports.recursively=exports.copyPaths=void 0;const path_1=require("path"),child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),globby_1=__importDefault(require("globby")),sub_process_manager_1=require("../../worker-pools/sub-process-manager"),EditorExtends=require("@base/electron-module").require("EditorExtends"),babelify=require("babelify"),browserify=require("browserify"),{I18n:I18n,Project:Project,Utils:Utils}=require("editor");function copyPaths(e){return Promise.all(e.map(e=>(0,fs_extra_1.copy)(e.src,e.dest)))}function recursively(e,r){e.subAssets&&(r&&r(e),Object.keys(e.subAssets).forEach(t=>{recursively(e.subAssets[t],r)}))}exports.copyPaths=copyPaths,exports.recursively=recursively;const DB_PROTOCOL_HEADER="db://";function removeDbHeader(e){if(!e)return"";if(!e.startsWith(DB_PROTOCOL_HEADER))return console.error("unknown path to build: "+e),e;return e.slice(DB_PROTOCOL_HEADER.length)}function dbUrlToRawPath(e){return(0,path_1.join)(Project.path,removeDbHeader(e))}function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}function isInstallNodeJs(){return new Promise((e,r)=>{(0,child_process_1.exec)("node -v",{env:process.env},r=>{r?(console.error(r),"win32"===process.platform?console.error(new Error(I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(I18n.t("builder.mac_default_npm_path_error"))),e(!1)):e(!0)})})}function getFileSizeDeep(e){if(!(0,fs_1.existsSync)(e))return 0;const r=(0,fs_1.statSync)(e);if(!r.isDirectory())return r.size;let t=0;return(0,fs_1.readdirSync)(e).forEach(r=>{t+=getFileSizeDeep((0,path_1.join)(e,r))}),t}function copyDirSync(e,r){if(!(0,fs_1.existsSync)(e))return 0;if(!(0,fs_1.statSync)(e).isDirectory())return(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r)),(0,fs_1.copyFileSync)(e,r);const t=(0,fs_1.readdirSync)(e);(0,fs_extra_1.ensureDirSync)(r),t.forEach(t=>{copyDirSync((0,path_1.join)(e,t),(0,path_1.join)(r,t))})}function transI18nName(e){return"string"!=typeof e?"":e.startsWith("i18n:")?(e=e.replace("i18n:",""),I18n.t(e)||console.debug(`${e} is not defined in 1i8n`),I18n.t(e)||e):e}function compressUuid(e,r=!0){return EditorExtends.UuidUtils.compressUuid(e,r)}function decompressUuid(e){return EditorExtends.UuidUtils.decompressUuid(e)}function getUuidFromPath(e){return EditorExtends.UuidUtils.getUuidFromLibPath(e)}function nameToSubId(e){return EditorExtends.UuidUtils.nameToSubId(e)}function getResImportPath(e,r,t=".json"){return(0,path_1.join)(e,Build.IMPORT_HEADER,r.substr(0,2),r+t)}function getResRawAssetsPath(e,r,t){return(0,path_1.join)(e,Build.NATIVE_HEADER,r.substr(0,2),r+t)}function getCurrentTime(){return getRealTime().replace(":","-")}function getRealTime(){const e=new Date;return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().slice(0,8)}function toBabelModules(e){return"esm"!==e&&e}async function transformCode(e,r){var t;return null===(t=await babel.transformAsync(e,{presets:[[preset_env_1.default,{modules:r.importMapFormat?toBabelModules(r.importMapFormat):void 0}]],plugins:r.plugins}))||void 0===t?void 0:t.code}function compileJS(e,r){let t;try{t=require("@babel/core").transform(e,{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:r,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]]})}catch(e){throw e.stack=`Compile ${r} error: ${e.stack}`,e}return t.code}async function getModuleFiles(e){const r={};return[].concat(...await Promise.all([e.paths.engineDir?(0,globby_1.default)((0,path_1.join)(e.paths.engineDir,"**/*.js"),r):[],e.paths.applicationJS,(0,globby_1.default)((0,path_1.join)(e.paths.dir,"src/chunks/**/*.js"),r),e.bundles.map(e=>e.scriptDest)]))}async function createBundle(e,r,t){return new Promise((o,s)=>{const n=browserify(e);t&&t.excludes&&t.excludes.forEach(function(e){n.exclude(e)}),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r)),n.transform(babelify,{presets:[require("@babel/preset-env")],plugins:[require("@babel/plugin-proposal-class-properties")]}).bundle((e,t)=>{if(e)return console.error(e),void s(e);(0,fs_1.writeFileSync)(r,t,"utf8"),o()})})}exports.removeDbHeader=removeDbHeader,exports.dbUrlToRawPath=dbUrlToRawPath,exports.relativeUrl=relativeUrl,exports.isInstallNodeJs=isInstallNodeJs,exports.getFileSizeDeep=getFileSizeDeep,exports.copyDirSync=copyDirSync,exports.transI18nName=transI18nName,exports.compressUuid=compressUuid,exports.decompressUuid=decompressUuid,exports.getUuidFromPath=getUuidFromPath,exports.nameToSubId=nameToSubId,exports.getResImportPath=getResImportPath,exports.getResRawAssetsPath=getResRawAssetsPath,exports.getCurrentTime=getCurrentTime,exports.getRealTime=getRealTime,exports.toBabelModules=toBabelModules,exports.transformCode=transformCode,exports.compileJS=compileJS,exports.getModuleFiles=getModuleFiles,exports.createBundle=createBundle;const HASH_LEN=5;async function appendMd5ToPaths(e){if(!Array.isArray(e))return null;const{createHash:r}=require("crypto"),t=r("md5");e=e.sort();for(const r of e){let e;try{e=await(0,fs_extra_1.readFile)(r)}catch(e){console.error(e),console.error(`readFile {link(${r})}`);continue}t.update(e)}const o=t.digest("hex").slice(0,HASH_LEN),s=[];return await Promise.all(e.map((e,r)=>(s[r]=patchMd5ToPath(e,o),(0,fs_extra_1.rename)(e,s[r])))),{paths:s,hash:o}}function calcMd5(e){const{createHash:r}=require("crypto"),t=r("md5");return t.update(e),t.digest("hex").slice(0,HASH_LEN)}function patchMd5ToPath(e,r){const t=(0,path_1.parse)(e);return t.base="",t.name+=`.${r}`,(0,path_1.format)(t)}function getMemorySize(){const e=process.memoryUsage();function r(e){return(e/1024/1024).toFixed(2)+"MB"}return"Process: heapTotal "+r(e.heapTotal)+" heapUsed "+r(e.heapUsed)+" rss "+r(e.rss)}exports.appendMd5ToPaths=appendMd5ToPaths,exports.calcMd5=calcMd5,exports.patchMd5ToPath=patchMd5ToPath,exports.getMemorySize=getMemorySize,exports.quickSpawn=sub_process_manager_1.workerManager.quickSpawn.bind(sub_process_manager_1.workerManager);