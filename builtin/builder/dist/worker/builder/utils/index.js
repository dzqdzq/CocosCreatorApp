"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMemorySize=exports.calcMd5=exports.appendMd5ToPaths=exports.containInBundle=exports.createBundle=exports.getModuleFiles=exports.transformCode=exports.toBabelModules=exports.getCurrentTime=exports.getResRawAssetsPath=exports.getResImportPath=exports.getUuidFromPath=exports.decompressUuid=exports.compressUuid=exports.transI18nName=exports.copyDirSync=exports.getFileSizeDeep=exports.isInstallNodeJs=exports.relativeUrl=exports.dbUrlToRawPath=exports.removeDbHeader=exports.recursively=exports.copyPaths=void 0;const path_1=require("path"),child_process_1=require("child_process"),fs_1=require("fs"),fs_extra_1=require("fs-extra"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),Editor=__importStar(require("editor")),globby_1=__importDefault(require("globby")),babelify=require("babelify"),browserify=require("browserify"),{I18n:I18n,Project:Project,Utils:Utils}=require("editor");function copyPaths(e){return Promise.all(e.map(e=>fs_extra_1.copy(e.src,e.dest)))}function recursively(e,t){e.subAssets&&(t&&t(e),Object.keys(e.subAssets).forEach(r=>{e.subAssets[r].fatherInfo=e,recursively(e.subAssets[r],t)}))}exports.copyPaths=copyPaths,exports.recursively=recursively;const DB_PROTOCOL_HEADER="db://";function removeDbHeader(e){if(!e)return"";if(!e.startsWith(DB_PROTOCOL_HEADER))return console.error("unknown path to build: "+e),e;return e.slice(DB_PROTOCOL_HEADER.length)}function dbUrlToRawPath(e){return path_1.join(Project.path,removeDbHeader(e))}function relativeUrl(e,t){return path_1.relative(e,t).replace(/\\/g,"/")}function isInstallNodeJs(){return new Promise((e,t)=>{child_process_1.exec("node -v",{env:process.env},t=>{t?(console.error(t),"win32"===process.platform?console.error(new Error(I18n.t("builder.window_default_npm_path_error"))):console.error(new Error(I18n.t("builder.mac_default_npm_path_error"))),e(!1)):e(!0)})})}function getFileSizeDeep(e){if(!fs_1.existsSync(e))return 0;const t=fs_1.statSync(e);if(!t.isDirectory())return t.size;let r=0;return fs_1.readdirSync(e).forEach(t=>{r+=getFileSizeDeep(path_1.join(e,t))}),r}function copyDirSync(e,t){if(!fs_1.existsSync(e))return 0;if(!fs_1.statSync(e).isDirectory())return fs_extra_1.ensureDirSync(path_1.dirname(t)),fs_1.copyFileSync(e,t);const r=fs_1.readdirSync(e);fs_extra_1.ensureDirSync(t),r.forEach(r=>{copyDirSync(path_1.join(e,r),path_1.join(t,r))})}function transI18nName(e){return"string"!=typeof e?"":e.startsWith("i18n:")?(e=e.replace("i18n:",""),I18n.t(e)||console.debug(`${e} is not defined in 1i8n`),I18n.t(e)||e):e}exports.removeDbHeader=removeDbHeader,exports.dbUrlToRawPath=dbUrlToRawPath,exports.relativeUrl=relativeUrl,exports.isInstallNodeJs=isInstallNodeJs,exports.getFileSizeDeep=getFileSizeDeep,exports.copyDirSync=copyDirSync,exports.transI18nName=transI18nName;const EditorExtends=require("@base/electron-module").require("EditorExtends");function getResImportPath(e,t){return path_1.join(e,Build.IMPORT_HEADER,t.substr(0,2),t+".json")}function getResRawAssetsPath(e,t,r){return path_1.join(e,Build.NATIVE_HEADER,t.substr(0,2),t+r)}function getCurrentTime(){const e=new Date;return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().slice(0,5).replace(":","-")}function toBabelModules(e){return"esm"!==e&&e}async function transformCode(e,t){var r;return null===(r=await babel.transformAsync(e,{presets:[[preset_env_1.default,{modules:toBabelModules(t.importMapFormat)}]]}))||void 0===r?void 0:r.code}async function getModuleFiles(e){const t={};return[].concat(...await Promise.all([e.paths.engineDir?globby_1.default(path_1.join(e.paths.engineDir,"**/*.js"),t):[],e.paths.applicationJS,globby_1.default(path_1.join(e.paths.dir,"src/chunks/**/*.js"),t),e.bundles.map(e=>e.scriptDest)]))}async function createBundle(e,t,r){return new Promise((s,o)=>{const n=browserify(e);r&&r.excludes&&r.excludes.forEach(function(e){n.exclude(e)}),fs_extra_1.ensureDirSync(path_1.dirname(t)),n.transform(babelify,{presets:[require("@babel/preset-env")],plugins:[require("@babel/plugin-proposal-class-properties")]}).bundle((e,r)=>{if(e)return console.error(e),void o(e);fs_1.writeFileSync(t,r,"utf8"),s()})})}async function containInBundle(e){return(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(t=>e.startsWith(t.path+"/"))}exports.compressUuid=((e,t=!0)=>EditorExtends.UuidUtils.compressUuid(e,t)),exports.decompressUuid=EditorExtends.UuidUtils.decompressUuid,exports.getUuidFromPath=EditorExtends.UuidUtils.getUuidFromLibPath,exports.getResImportPath=getResImportPath,exports.getResRawAssetsPath=getResRawAssetsPath,exports.getCurrentTime=getCurrentTime,exports.toBabelModules=toBabelModules,exports.transformCode=transformCode,exports.getModuleFiles=getModuleFiles,exports.createBundle=createBundle,exports.containInBundle=containInBundle;const HASH_LEN=5;async function appendMd5ToPaths(e){if(!Array.isArray(e))return null;const{createHash:t}=require("crypto"),r=t("md5");e=e.sort();for(const t of e){let e;try{e=await fs_extra_1.readFile(t)}catch(e){console.error(e),console.error(`readFile {link(${t})}`);continue}r.update(e)}const s=r.digest("hex").slice(0,HASH_LEN),o=[];return await Promise.all(e.map((e,t)=>{const r=path_1.parse(e);return r.base="",r.name+=`.${s}`,o[t]=path_1.format(r),fs_extra_1.rename(e,o[t])})),{paths:o,hash:s}}function calcMd5(e){const{createHash:t}=require("crypto"),r=t("md5");return r.update(e),r.digest("hex").slice(0,HASH_LEN)}function getMemorySize(){const e=process.memoryUsage();function t(e){return(e/1024/1024).toFixed(2)+"MB"}return"Process: heapTotal "+t(e.heapTotal)+" heapUsed "+t(e.heapUsed)+" rss "+t(e.rss)}exports.appendMd5ToPaths=appendMd5ToPaths,exports.calcMd5=calcMd5,exports.getMemorySize=getMemorySize;