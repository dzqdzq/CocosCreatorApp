"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./../utils/index"),packer_1=require("./packer"),Editor=__importStar(require("editor")),crypto_1=require("crypto"),config_1=require("./config"),Lodash=require("lodash");class PacInfo{constructor(){this.spriteFrames=[],this.relativePath="",this.relativeDir=""}async init(e){if(this.asset=e,this.meta=await Editor.Message.request("asset-db","query-asset-meta",e.uuid),!this.meta||!this.asset)return console.warn(`Can't get meta info of ${e.uuid} from asset-db.`),this;let t=await Editor.Message.request("asset-db","query-assets",{pattern:path_1.dirname(this.asset.path)+"/**/*",ccType:"cc.SpriteFrame"});if(!t||0===t.length)return console.debug(`There is no spriteFrame in dictionary(${this.asset.path}).`),this;const s=await Editor.Message.request("asset-db","query-assets",{pattern:path_1.dirname(this.asset.path)+"/+(**)/*.pac"}),a=s.map(e=>path_1.dirname(e.file));if(0!==s.length&&0===(t=t.filter(e=>{for(const t of a)if(Editor.Utils.Path.contains(t,Build.Utils.dbUrlToRawPath(e.path)))return!1;return!0})).length)return console.warn(`No SpriteFrame find in folder [{link(${path_1.dirname(this.asset.file)})}]. Please check the AutoAtlas [${this.asset.file}].`),this;let i=await Promise.all(t.map(async t=>new Promise((s,a)=>{cc.assetManager.loadAny(t.uuid,(i,r)=>{if(i)return a(i);r.pacUuid=e.uuid,r.displayName=t.displayName,r.file=index_1.dbUrlToRawPath(t.fatherInfo.source),s(r)})})));i=Lodash.sortBy(i,"_uuid");const r=path_1.join(Editor.Project.path,"assets");return this.spriteFrames=i,this.relativePath=path_1.relative(r,this.asset.file),this.relativeDir=path_1.relative(r,path_1.dirname(this.asset.file)),this}}class TexturePacker{constructor(){this.spriteFrames=[],this.pacInfos=[],this.assetsUuids=[],this.unpackedUuids=[]}static async generatePreviewFiles(e){fs_1.existsSync(config_1.previewTempDir)||fs_extra_1.ensureDirSync(config_1.previewTempDir);const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return console.warn(`query-asset-info failed! can't get asset info of {asset(${t.url})}.`),null;const s=await queryAtlases(t),a=await internalPack({pacInfos:s.pacInfos,destTempDir:config_1.previewTempDir});return 0===a.length?null:{atlasImagePaths:a[0].atlases.map(e=>e.imagePath),unpackedImages:Array.from(a[0].unpackedImages),dirty:Boolean(a[0].dirty)}}static async queryPreviewFiles(e){const t=path_1.join(config_1.previewTempDir,e,"pac-info.json");if(!fs_1.existsSync(t))return;const s=fs_extra_1.readJSONSync(t);return{atlasImagePaths:s.result.atlases.map(e=>e.imagePath),unpackedImages:s.result.unpackedImages}}get spriteFrameUuids(){return this.spriteFrames.map(e=>e._uuid)}async init(e){const t=await queryAtlases(e);this.spriteFrames=t.spriteFrames,this.pacInfos=t.pacInfos,this.assetsUuids=t.assetsUuids}needPack(e){return 0===this.unpackedUuids.length?this.assetsUuids.includes(e):!(!this.assetsUuids.includes(e)||this.unpackedUuids.includes(e))}needResolve(e){return!this.assetsUuids.includes(e)||!(!this.assetsUuids.includes(e)||!this.spriteFrameUuids.includes(e))}async pack(e){console.time("Pack atlas");let t=this.pacInfos;for(const s of t){s.meta.userData.filterUnused&&(s.spriteFrames=s.spriteFrames.filter(t=>e.includes(t._uuid)))}t=t.filter(t=>e.includes(t.meta.uuid)||t.spriteFrames.filter(t=>e.includes(t._uuid)).length>0);const s=await internalPack({pacInfos:t,destTempDir:config_1.buildTempDir});return console.timeEnd("Pack atlas"),s}}async function internalPack(e){const{pacInfos:t,destTempDir:s}=e,a=[];for(const e of t){const t=e.meta.userData,i=await index_1.containInBundle(e.asset.url);i&&console.warn(Editor.I18n.t("builder.tips.atlas_in_resources",{info:`{asset(${e.asset.url})}`,root:i.path})),t.filterUnused&&i&&console.warn(Editor.I18n.t("builder.warn.atlas_in_resources",{url:`{asset(${e.asset.url})}`,root:i.path}));const r=path_1.join(s,e.asset.uuid),n=e.spriteFrames,{storedPacInfoPath:u,newStoredPacInfo:o,storedPacInfo:c}=await getStoredPacInfo(r,e,n);let d,l=c&&!Lodash.isEqual(o.mtimes,c.mtimes);if(!l&&c){d=c.result;for(const e of d.atlases){if(!fs_1.existsSync(e.imagePath)){l=!0;break}e.spriteFrameInfos.forEach(e=>{e.spriteFrame=n.find(t=>t._uuid===e.uuid)})}}if(l||!d){fs_extra_1.emptyDirSync(r);const s=cc.js.mixin({name:path_1.basename(e.asset.file,path_1.extname(e.asset.file)),width:t.maxWidth,height:t.maxHeight,destDir:r},t);(d=await packer_1.packer(n,s)).unpackedImages=Array.from(d.unpackedImages),o.result=d,fs_extra_1.writeJSON(u,o,{spaces:2})}d.pacInfo=e,d.dirty=l,d.mtimeMd5=Build.Utils.calcMd5(JSON.stringify(o.mtimes)),a.push(d)}return a}async function getStoredPacInfo(e,t,s){const a=path_1.join(e,"pac-info.json"),i={mtimes:{},sharpMd5:crypto_1.createHash("md5").update(JSON.stringify(require("sharp").versions)).digest("hex")};let r=[t.meta.uuid];return s.forEach(e=>{r.push(e._uuid),r.push(e.texture._uuid),r.push(e.texture._mipmaps[0]._uuid)}),r=Lodash.uniq(r),await Promise.all(r.map(async e=>{const t=await Editor.Message.request("asset-db","query-asset-mtime",e);i.mtimes[e]=t})),{storedPacInfoPath:a,newStoredPacInfo:i,storedPacInfo:fs_1.existsSync(a)&&fs_extra_1.readJSONSync(a)||null}}async function queryAtlases(e){const t={assetsUuids:[],spriteFrames:[],pacInfos:[]};return e=Array.isArray(e)?e:[e],await Promise.all(e.map(async e=>{const s=await(new PacInfo).init(e);t.assetsUuids.push(s.asset.uuid),0!==s.spriteFrames.length&&(s.spriteFrames.forEach(e=>{const s=e.texture._uuid,a=e.texture._mipmaps[0]._uuid;t.assetsUuids.push(s,e._uuid,a)}),t.spriteFrames=t.spriteFrames.concat(s.spriteFrames),t.pacInfos.push(s))})),t.spriteFrames=Lodash.uniq(t.spriteFrames),t}exports.default=TexturePacker;