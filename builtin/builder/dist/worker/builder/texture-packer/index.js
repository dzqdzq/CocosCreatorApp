"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./../utils/index"),packer_1=require("./packer"),config_1=require("./config"),Lodash=require("lodash"),DB_TEMP_DIR=path_1.join(Editor.Project.tmpDir,"asset-db");class PacInfo{constructor(){this.spriteFrames=[],this.spriteAssets=[],this.relativePath="",this.relativeDir=""}async init(e){if(this.asset=e,this.meta=await Editor.Message.request("asset-db","query-asset-meta",e.uuid),!this.meta||!this.asset)return console.warn(`Can't get meta info of ${e.uuid} from asset-db.`),this;let s=await Editor.Message.request("asset-db","query-assets",{pattern:path_1.dirname(this.asset.path)+"/**/*",ccType:"cc.SpriteFrame"});if(!(s=s.filter(e=>"sprite-frame"===e.importer))||0===s.length)return console.debug(`There is no spriteFrame in dictionary(${this.asset.path}).`),this;const t=await Editor.Message.request("asset-db","query-assets",{pattern:path_1.dirname(this.asset.path)+"/+(**)/*.pac"}),a=t.map(e=>path_1.dirname(e.file));if(0!==t.length&&(s=s.filter(e=>{for(const s of a)if(Editor.Utils.Path.contains(s,Build.Utils.dbUrlToRawPath(e.path)))return!1;return!0})),0===s.length)return console.warn(`No SpriteFrame find in folder [{link(${path_1.dirname(this.asset.file)})}]. Please check the AutoAtlas [${this.asset.file}].`),this;let i=await Promise.all(s.map(async s=>new Promise((t,a)=>{cc.assetManager.loadAny(s.uuid,(i,r)=>{if(i)return a(i);r.pacUuid=e.uuid,r.displayName=s.displayName,r.file=index_1.dbUrlToRawPath(s.fatherInfo.source),this.spriteAssets.push(s),t(r)})})));i=Lodash.sortBy(i,"_uuid");const r=path_1.join(Editor.Project.path,"assets");return this.spriteFrames=i,this.relativePath=path_1.relative(r,this.asset.file),this.relativeDir=path_1.relative(r,path_1.dirname(this.asset.file)),this}}class TexturePacker{constructor(){this.spriteFrames=[],this.pacInfos=[],this.assetsUuids=[],this.unpackedUuids=[]}static async generatePreviewFiles(e){fs_1.existsSync(config_1.previewTempDir)||fs_extra_1.ensureDirSync(config_1.previewTempDir);const s=await Editor.Message.request("asset-db","query-asset-info",e);if(!s)return console.warn(`query-asset-info failed! can't get asset info of {asset(${s.url})}.`),null;const t=await queryAtlases(s),a=await internalPack({pacInfos:t.pacInfos,destTempDir:config_1.previewTempDir});return 0===a.length?null:{atlasImagePaths:a[0].atlases.map(e=>e.imagePath),unpackedImages:Array.from(a[0].unpackedImages),dirty:Boolean(a[0].dirty)}}static async queryPreviewFiles(e){const s=path_1.join(config_1.previewTempDir,e,"pac-info.json");if(!fs_1.existsSync(s))return;const t=fs_extra_1.readJSONSync(s);return{atlasImagePaths:t.result.atlases.map(e=>e.imagePath),unpackedImages:t.result.unpackedImages}}get spriteFrameUuids(){return this.spriteFrames.map(e=>e._uuid)}async init(e){const s=await queryAtlases(e);this.spriteFrames=s.spriteFrames,this.pacInfos=s.pacInfos,this.assetsUuids=s.assetsUuids}needPack(e){return 0===this.unpackedUuids.length?this.assetsUuids.includes(e):!(!this.assetsUuids.includes(e)||this.unpackedUuids.includes(e))}needResolve(e){return!this.assetsUuids.includes(e)||!(!this.assetsUuids.includes(e)||!this.spriteFrameUuids.includes(e))}async pack(e){console.time("Pack atlas");let s=this.pacInfos;for(const t of s){t.meta.userData.filterUnused&&(t.spriteFrames=t.spriteFrames.filter(s=>e.includes(s._uuid)))}s=s.filter(s=>e.includes(s.meta.uuid)||s.spriteFrames.filter(s=>e.includes(s._uuid)).length>0);const t=await internalPack({pacInfos:s,destTempDir:config_1.buildTempDir});return console.timeEnd("Pack atlas"),t}}async function internalPack(e){const{pacInfos:s,destTempDir:t}=e,a=[];for(const e of s){const s=e.meta.userData,i=(await index_1.containInBundle(e.asset.url),path_1.join(t,e.asset.uuid)),r=e.spriteFrames,{storedPacInfoPath:n,newStoredPacInfo:c,storedPacInfo:u}=getStoredPacInfo(i,e);let o,d=u&&c.md5!==u.md5;if(!d&&u){o=u.result;for(const e of o.atlases){if(!fs_1.existsSync(e.imagePath)){d=!0;break}e.spriteFrameInfos.forEach(e=>{e.spriteFrame=r.find(s=>s._uuid===e.uuid)})}}if(d||!o){fs_extra_1.emptyDirSync(i);const t=cc.js.mixin({name:path_1.basename(e.asset.file,path_1.extname(e.asset.file)),width:s.maxWidth,height:s.maxHeight,destDir:i},s);(o=await packer_1.packer(r,t)).unpackedImages=Array.from(o.unpackedImages),c.result=o,fs_extra_1.writeJSON(n,c,{spaces:2}),Object.values(c.cacheFiles).forEach(e=>{fs_extra_1.outputFileSync(e,"")})}o.pacInfo=e,o.dirty=d,o.mtimeMd5=c.md5,a.push(o)}return a}function getStoredPacInfo(e,s){const t=path_1.join(e,"pac-info.json");let a=fs_1.existsSync(t)&&fs_extra_1.readJSONSync(t)||null;const i={cacheFiles:{},sharpMd5:Build.Utils.calcMd5(JSON.stringify(require("sharp").versions)),md5:"",versionDev:config_1.versionDev};let r=[s.meta.uuid];try{const e=path_1.join(DB_TEMP_DIR,s.asset.url.match(/db:\/\/([^\/]*)/)[1],s.asset.uuid.substr(0,2),s.asset.uuid,"build",s.asset.uuid);i.cacheFiles[s.asset.uuid]=e,fs_1.existsSync(e)||a&&(a.cacheFiles[s.asset.uuid]=null),s.spriteAssets.forEach(e=>{const t=path_1.join(DB_TEMP_DIR,e.url.match(/db:\/\/([^\/]*)/)[1],e.uuid.substr(0,2),e.uuid,"build",s.asset.uuid);i.cacheFiles[e.uuid]=t,fs_1.existsSync(t)||a&&(a.cacheFiles[e.uuid]=null)})}catch(e){console.error(e),a=null}return r=Lodash.uniq(r),i.md5=Build.Utils.calcMd5(JSON.stringify({cacheFiles:i.cacheFiles})+i.sharpMd5+config_1.versionDev),a&&(a.md5=Build.Utils.calcMd5(JSON.stringify({cacheFiles:a.cacheFiles})+a.sharpMd5+a.versionDev)),{storedPacInfoPath:t,newStoredPacInfo:i,storedPacInfo:a}}async function queryAtlases(e){const s={assetsUuids:[],spriteFrames:[],pacInfos:[]};return e=Array.isArray(e)?e:[e],await Promise.all(e.map(async e=>{const t=await(new PacInfo).init(e);s.assetsUuids.push(t.asset.uuid),0!==t.spriteFrames.length&&(t.spriteFrames.forEach(e=>{const t=e.texture._uuid,a=e.texture._mipmaps[0]._uuid;s.assetsUuids.push(t,e._uuid,a)}),s.spriteFrames=s.spriteFrames.concat(t.spriteFrames),s.pacInfos.push(t))})),s.spriteFrames=Lodash.uniq(s.spriteFrames),s}exports.default=TexturePacker;