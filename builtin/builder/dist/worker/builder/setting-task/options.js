"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),lodash_1=require("lodash");exports.title="i18n:builder.tasks.settings.options";const layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function handle(e,r,s){const t=r.settings;t.engine.debug=e.debug,t.screen.designResolution=e.appTemplateData.resolution,t.engine.platform=e.platform||t.engine.platform,t.assets.server=e.server||"",t.engine.customLayers=e.customLayers.map(e=>{const r=layerMask.findIndex(r=>e.value===r);return{name:e.name,bit:r}}),t.engine.customLayers.sort((e,r)=>e.bit-r.bit),t.engine.sortingLayers=e.sortingLayers;const n=await Editor.Profile.getProject("project","general.renderPipeline","default");t.rendering.renderPipeline=e.renderPipeline===n?"":e.renderPipeline,t.CocosEngine=Editor.App.version,e.includeModules.includes("custom-pipeline")&&(t.rendering.effectSettingsPath="src/effect.bin");const a=await Editor.Profile.getProject("builder","splash-setting","default");let i=await Editor.Profile.getProject("builder","splash-setting");const o={};if(!1!==e.useSplashScreen||e.preview)try{let r=!0;e.preview||(0,lodash_1.isEqual)(a,i)||await checkSplash("customSplash")||(console.warn(Editor.I18n.t("builder.warn.invalidCustomSplash")),r=!1),i&&r?(i=Object.assign({},a,i),t.splashScreen=formatSplashScreen(i),o.B100039=1):(t.splashScreen=formatSplashScreen(a),o.B100039=2)}catch(e){console.error(e),console.error(Editor.I18n.t("builder.error.missingSplashTips",{splashScreen:JSON.stringify(i)})),t.splashScreen=formatSplashScreen(a)}else t.splashScreen=formatSplashScreen(a),await checkSplash("removeSplash")?(t.splashScreen.totalTime=0,delete t.splashScreen.base64src,delete t.splashScreen.bgBase64,o.B100039=3):console.warn(Editor.I18n.t("builder.warn.invalidRemoveSplash"));for(const s of r.bundles)s.config.debug=e.debug;e.preview||Object.assign(this.staticsInfo.extras,o)}function formatSplashScreen(e){const r=Editor.UI.File.resolveToRaw(e.url);e.base64src=`data:image/png;base64,${(0,fs_extra_1.readFileSync)(r).toString("base64")}`,delete e.url;const s=(0,path_1.join)(__dirname,"../../../../static/logo/bg.png");return e.bgBase64=e.bgBase64||`data:image/png;base64,${(0,fs_extra_1.readFileSync)(s).toString("base64")}`,e}async function checkSplash(e){if(!e)return!0;try{const r=await Editor.Message.request("information","query-information",e);if(r&&r.enable&&!r.complete)return!1}catch(e){console.debug(e)}return!0}exports.handle=handle;