"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.title=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");exports.title="i18n:builder.tasks.settings.options";const layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function handle(e,r,t){const s=r.settings;s.engine.debug=e.debug,s.screen.designResolution=e.appTemplateData.resolution,s.engine.platform=e.platform||s.engine.platform,s.assets.server=e.server||"",s.engine.customLayers=e.customLayers.map(e=>{const r=layerMask.findIndex(r=>e.value===r);return{name:e.name,bit:r}}),s.engine.customLayers.sort((e,r)=>e.bit-r.bit),s.engine.sortingLayers=e.sortingLayers;const n=await Editor.Profile.getProject("project","general.renderPipeline","default");s.rendering.renderPipeline=e.renderPipeline===n?"":e.renderPipeline,s.CocosEngine=Editor.App.version,e.includeModules.includes("custom-pipeline")&&(s.rendering.effectSettingsPath="src/effect.bin");const a=await Editor.Profile.getProject("builder","splash-setting","default");let i=await Editor.Profile.getProject("builder","splash-setting");const o={};if(e.useSplashScreen||e.preview)try{let e=!0;await checkSplash("customSplash")||(console.warn(Editor.I18n.t("builder.warn.invalidCustomSplash")),e=!1),i&&e?(i=Object.assign({},a,i),s.splashScreen=formatSplashScreen(i),o.B100039=1):(s.splashScreen=formatSplashScreen(a),o.B100039=2)}catch(e){console.error(e),console.error(Editor.I18n.t("builder.error.missingSplashTips",{splashScreen:JSON.stringify(i)})),s.splashScreen=formatSplashScreen(a)}else s.splashScreen=formatSplashScreen(a),await checkSplash("removeSplash")?(s.splashScreen.totalTime=0,delete s.splashScreen.base64src,delete s.splashScreen.bgBase64,o.B100039=3):console.warn(Editor.I18n.t("builder.warn.invalidRemoveSplash"));for(const t of r.bundles)t.config.debug=e.debug;e.preview||Object.assign(this.staticsInfo.extras,o)}function formatSplashScreen(e){const r=Editor.UI.File.resolveToRaw(e.url);e.base64src=`data:image/png;base64,${(0,fs_extra_1.readFileSync)(r).toString("base64")}`,delete e.url;const t=(0,path_1.join)(__dirname,"../../../../static/logo/bg.png");return e.bgBase64=e.bgBase64||`data:image/png;base64,${(0,fs_extra_1.readFileSync)(t).toString("base64")}`,e}async function checkSplash(e){if(!e)return!0;try{const r=await Editor.Message.request("information","query-information",e);if(r&&r.enable&&!r.complete)return!1}catch(e){console.debug(e)}return!0}exports.handle=handle;