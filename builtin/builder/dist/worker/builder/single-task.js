"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SingleTask=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),console_1=require("./utils/console"),utils_1=require("./utils"),tempDir=path_1.join(Editor.Project.tmpDir,"builder","compile");class SingleTask extends events_1.EventEmitter{constructor(t,s,e){super(),this.taskInfo={},this.progress=0,this.logDest="",this.name=t,this.hooksInfo=s,this.root=e,this.taskInfo={[`onBefore${t}`]:.2,[t]:.2,[`onAfter${t}`]:.2}}init(){if(this.logDest=path_1.join(Build.projectTempDir,this.name,path_1.basename(this.root)+".log"),fs_extra_1.outputFileSync(this.logDest,""),this.console=new console_1.MessageConsole((t,s)=>{if(!t||!s)return;let e=`${utils_1.getCurrentTime()}-${t}:[${this.name}]`;try{Array.isArray(s)?s.forEach(t=>{e+=`${JSON.stringify(t)}`}):e+=JSON.stringify(s),fs_extra_1.appendFileSync(this.logDest,e)}catch(t){}}),!this.options)try{this.options=fs_extra_1.readJSONSync(path_1.join(this.root,SingleTask.optionsFileName)),console.debug(`Use build file ${SingleTask.optionsFileName} in root(${this.root})`)}catch(t){console.warn("Get cache build options failed!")}this.options.buildPath&&(this.options.buildPath=Editor.UI.File.resolveToRaw(this.options.buildPath))}async run(){this.init(),this.updateProcess("init options success",.1),fs_extra_1.emptyDirSync(tempDir);try{for(const t of Object.keys(this.taskInfo))await this._runPluginTask(t)}catch(t){console.warn(t),this.error=t}}async _runPluginTask(t){for(let s=0;s<this.hooksInfo.pkgNameOrder.length;s++){const e=this.hooksInfo.pkgNameOrder[s],i=this.hooksInfo.infos[e],o=this.taskInfo[t]*(s+1);let r;try{(r=require(i.path))[t]&&(this.updateProcess(`${e}:(${t}) start...`),this.console.debug(`// ---- ${e}:(${t}) ----`),i.internal?await r[t].call(this,this.root,this.options):await r[t](this.root,this.options),this.console.debug(`// ---- ${e}:(${t}) success ----`),this.updateProcess(`${e}:(${t}) âˆš`,o))}catch(s){const i=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:e,funcName:t});if(r&&r.throwError)throw s;this.updateProcess(i,0,"warn"),this.updateProcess(s,0,"warn")}}}updateProcess(t,s=0,e="debug"){this.progress=Editor.Utils.Math.clamp01(this.progress+s),this.emit("update",t,this.progress),this.console[e](t)}}exports.SingleTask=SingleTask,SingleTask.optionsFileName="cocos.compile.config.json";