"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),utils_1=require("../utils"),templateDir=path_1.join(__dirname,"../../../../static/build-templates");async function handle(e,t,a){const i=await ejs_1.default.renderFile(path_1.join(templateDir,"application.ejs"),Object.assign(e.appTemplateData,{settingsJsonPath:utils_1.relativeUrl(t.paths.dir,t.paths.settings),hasPhysicsAmmo:e.buildEngineParam.includeModules.includes("physics-ammo")})),r=await babel.transformAsync(i,{presets:[[preset_env_1.default,{modules:utils_1.toBabelModules("systemjs"),targets:e.buildScriptParam.targets}]]});if(!r||!r.code)throw new Error("无法生成 application.js");if(e.md5Cache){const e=Build.Utils.calcMd5(r.code);e&&(t.paths.applicationJS=t.paths.applicationJS.replace(".js",`.${e}.js`))}fs_extra_1.outputFileSync(t.paths.applicationJS,r.code);const s=path_1.join(Editor.Project.path,"build-templates","common");fs_extra_1.existsSync(s)&&(console.debug(`Use build template in ${s}`),fs_extra_1.copySync(s,t.paths.dir))}exports.title="i18n:tasks.build_template",exports.name="build-task/template",exports.handle=handle;