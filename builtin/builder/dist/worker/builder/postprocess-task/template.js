"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,a,s)}:function(e,t,i,a){void 0===a&&(a=i),e[a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),utils_1=require("../utils"),APPLICATION_EJS_VERSION="1.0.0";async function handle(e,t,i){const a=(0,path_1.join)(Build.buildTemplateDir,"common"),s=(0,path_1.join)(Build.buildTemplateDir,e.platform),r=(await Editor.Message.request("engine","query-engine-info")).typescript.path,n=(0,path_1.join)(r,"templates/launcher");let o=(0,path_1.join)(s,"application.ejs"),l=!0;(0,fs_extra_1.existsSync)(o)?console.debug("use custom application.ejs in project",o):(o=(0,path_1.join)(a,"application.ejs"),(0,fs_extra_1.existsSync)(o)||(l=!1,o=(0,path_1.join)(n,"application.ejs")));const p=await ejs_1.default.renderFile(o,Object.assign(e.appTemplateData,{settingsJsonPath:(0,utils_1.relativeUrl)(t.paths.dir,t.paths.settings),hasPhysicsAmmo:e.buildEngineParam.includeModules.includes("physics-ammo"),versionTips:Editor.I18n.t("builder.tips.applicationEjsVersion"),customVersion:APPLICATION_EJS_VERSION,versionCheckTemplate:(0,path_1.join)(n,"version-check.ejs")})),u=await babel.transformAsync(p,{presets:[[preset_env_1.default,{modules:(0,utils_1.toBabelModules)("systemjs"),targets:e.buildScriptParam.targets}]]});if(!u||!u.code)throw new Error("无法生成 application.js");if(e.md5Cache){const e=Build.Utils.calcMd5(u.code);e&&(t.paths.applicationJS=t.paths.applicationJS.replace(".js",`.${e}.js`))}(0,fs_extra_1.outputFileSync)(t.paths.applicationJS,u.code),(0,fs_extra_1.existsSync)(a)&&(console.debug(`Use build template in ${a}`),(0,fs_extra_1.copySync)(a,t.paths.dir),l&&(0,fs_extra_1.removeSync)((0,path_1.join)((0,path_1.dirname)(t.paths.applicationJS),"application.ejs")))}exports.title="i18n:builder.tasks.build_template",exports.name="build-task/template",exports.handle=handle;