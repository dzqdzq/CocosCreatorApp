"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,a){void 0===a&&(a=i),e[a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handle=exports.name=exports.title=void 0;const ejs_1=__importDefault(require("ejs")),fs_extra_1=require("fs-extra"),path_1=require("path"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env")),utils_1=require("../utils"),templateDir=path_1.join(__dirname,"../../../../static/build-templates"),APPLICATION_EJS_VERSION="1.0.0";async function handle(e,t,i){const a=path_1.join(Build.buildTemplateDir,"common"),s=path_1.join(Build.buildTemplateDir,e.platform);let r=path_1.join(s,"application.ejs"),n=!0;fs_extra_1.existsSync(r)?console.debug("use custom application.ejs in project",r):(r=path_1.join(a,"application.ejs"),fs_extra_1.existsSync(r)||(n=!1,r=path_1.join(templateDir,"application.ejs")));const o=await ejs_1.default.renderFile(r,Object.assign(e.appTemplateData,{settingsJsonPath:utils_1.relativeUrl(t.paths.dir,t.paths.settings),hasPhysicsAmmo:e.buildEngineParam.includeModules.includes("physics-ammo"),versionTips:Editor.I18n.t("builder.tips.applicationEjsVersion"),customVersion:APPLICATION_EJS_VERSION,versionCheckTemplate:path_1.join(templateDir,"version-check.ejs")})),l=await babel.transformAsync(o,{presets:[[preset_env_1.default,{modules:utils_1.toBabelModules("systemjs"),targets:e.buildScriptParam.targets}]]});if(!l||!l.code)throw new Error("无法生成 application.js");if(e.md5Cache){const e=Build.Utils.calcMd5(l.code);e&&(t.paths.applicationJS=t.paths.applicationJS.replace(".js",`.${e}.js`))}fs_extra_1.outputFileSync(t.paths.applicationJS,l.code),fs_extra_1.existsSync(a)&&(console.debug(`Use build template in ${a}`),fs_extra_1.copySync(a,t.paths.dir),n&&fs_extra_1.removeSync(path_1.join(path_1.dirname(t.paths.applicationJS),"application.ejs")))}exports.title="i18n:tasks.build_template",exports.name="build-task/template",exports.handle=handle;