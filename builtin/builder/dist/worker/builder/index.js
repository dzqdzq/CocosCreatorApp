"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(s,t,e,i){void 0===i&&(i=e),Object.defineProperty(s,i,{enumerable:!0,get:function(){return t[e]}})}:function(s,t,e,i){void 0===i&&(i=e),s[i]=t[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(s,t){Object.defineProperty(s,"default",{enumerable:!0,value:t})}:function(s,t){s.default=t}),__importStar=this&&this.__importStar||function(s){if(s&&s.__esModule)return s;var t={};if(null!=s)for(var e in s)"default"!==e&&Object.prototype.hasOwnProperty.call(s,e)&&__createBinding(t,s,e);return __setModuleDefault(t,s),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTask=void 0;const Editor=__importStar(require("editor")),events_1=require("events"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./utils/index"),asset_1=require("./manager/asset"),build_result_1=require("./manager/build-result"),build_result_2=require("./manager/build-result"),task_config_1=require("./task-config"),platforms_options_1=require("../../share/platforms-options"),utils_1=require("../../share/utils"),single_task_1=require("./single-task");class BuildTask extends events_1.EventEmitter{constructor(s,t,e,i){super(),this.errorMsg="",this.progress=0,this.isCommandBuild=!1,this.taskResMap={},this.id=s,this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks"),this.settingTasks=task_config_1.taskManager.getTaskHandle("settingTasks"),this.postprocessTasks=task_config_1.taskManager.getTaskHandle("postprocessTasks"),this.hooksInfo=e,this.options=t,this.cache=new asset_1.BuilderAssetCache(this),this.result=new build_result_1.InternalBuildResult(this),t.preview||(this.isCommandBuild=!!i,this.buildTasks=task_config_1.taskManager.getTaskHandle("buildTasks"),this.staticsInfo={gameName:t.name,platform:t.platform,scenesNum:t.scenes.length,includeModules:t.includeModules,assetsNum:0,scriptNum:0,time:0,err:"",orientation:"",remoteServerAddress:"",appid:"",size:0})}addStatistics(){const s=this.staticsInfo,t=[];t.push(this.result.paths.assets),t.push(this.result.paths.remote),t.push(this.result.paths.settings),t.push(this.result.paths.subpackages);let e=0;t.forEach(s=>{e+=index_1.getFileSizeDeep(s)}),s.size=e,s.includeModules=this.options.includeModules;let i=0,a=0;for(const s of this.result.bundles)i+=s.assetsWithoutRedirect.length,a+=s.scripts.length;s.assetsNum=i,s.scriptNum=a}getTaskResult(s){return this.taskResMap[s]}async init(){this.errorMsg="",console.debug("Query all assets info in project"),await task_config_1.taskManager.init(),await this.initOptions(),cc.assetManager.releaseAll(),await this.cache.init(),console.debug(`  Number of all scenes: ${this.cache.sceneUuids.length}`),console.debug(`  Number of all scripts: ${this.cache.scriptUuids.length}`),console.debug(`  Number of other assets: ${this.cache.assetUuids.length}`)}async build(){const{dir:s}=this.result.paths;if(!s)return console.error("No output path can be built.");if(await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuild),this.buildResult=new build_result_2.BuildResult(this),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeInit),await this.init(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterInit),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuildAssets),await this.runBuildTask(this.buildTasks,task_config_1.taskManager.taskWeight.buildTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuildAssets),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeCompressSettings),await this.runBuildTask(this.postprocessTasks,task_config_1.taskManager.taskWeight.postprocessTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterCompressSettings),this.addStatistics(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuild),this.options.generateCompileConfig&&fs_extra_1.outputJSONSync(path_1.join(this.result.paths.dir,single_task_1.SingleTask.optionsFileName),this.result.compileOptions||this.options),this.options.nextTasks){const s=path_1.join(utils_1.getBuildDist(this.options.buildPath),this.options.outputName);for(const t of this.options.nextTasks){const e=new single_task_1.SingleTask(t,this.hooksInfo,s);e.on("update",(s,t)=>{this.updateProcess(s,.2*t)}),await e.run(),e.errMessage&&(this.errorMsg=e.errMessage)}}}async getPreviewSettings(){return await this.init(),this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks",!0),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),this.result.settings}updateProcess(s,t){t&&(this.progress=Editor.Utils.Math.clamp01(this.progress+t)),console.debug(s,(100*this.progress).toFixed(0)+"%"),this.emit("update",s,this.progress)}async initOptions(){await checkDefaultOptions(this.options,this.isCommandBuild),await platforms_options_1.checkProjectSetting(this.options,this.isCommandBuild),this.options.appTemplateData={debugMode:this.options.debug,renderMode:!1,isSetOrientation:!1,showFPS:!1,resolution:{width:this.options.designResolution.width,height:this.options.designResolution.height,policy:cc.ResolutionPolicy.FIXED_HEIGHT},md5Cache:this.options.md5Cache,cocosTemplate:"",server:"",hasPhysicsAmmo:this.options.includeModules.includes("physics-ammo")};const s=this.options.appTemplateData.resolution;this.options.designResolution.fitHeight?this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.SHOW_ALL:s.policy=cc.ResolutionPolicy.FIXED_HEIGHT:this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.FIXED_WIDTH:s.policy=cc.ResolutionPolicy.NO_BORDER,this.options.preview||(this.options.buildEngineParam={debug:this.options.debug,sourceMaps:this.options.sourceMaps,includeModules:this.options.includeModules,engineVersion:Editor.App.version,platform:"HTML5",md5Map:[],engineName:"cocos-js",useCache:task_config_1.taskManager.cacheConfig.engine},this.options.buildScriptParam={experimentalEraseModules:this.options.experimentalEraseModules,outputName:"project"},this.options.assetSerializeOptions={"cc.EffectAsset":{glsl1:this.options.includeModules.includes("gfx-webgl"),glsl3:this.options.includeModules.includes("gfx-webgl2"),glsl4:!1}},task_config_1.taskManager.cacheConfig.engine||(this.options.compileEngineForce=!0))}async runBuildTask(s,t,...e){this.options.generateCompileConfig&&(t*=.8);for(let i=0;i<s.length;i++){const a=s[i],n=await transTitle(a.title);this.updateProcess(n+" start"),console.time("// ---- "+n+" ----"),console.log("// ---- "+n+" ----"),console.debug(index_1.getMemorySize());try{const i=await a.handle.call(this,this.options,this.result,this.cache,...e);a.name&&i&&(this.taskResMap[a.name]=i),console.timeEnd("// ---- "+n+" ----"),this.updateProcess(n+" âˆš",1/s.length*t)}catch(s){console.error(s),this.errorMsg=s.toString(),this.updateProcess(this.errorMsg);break}}if(this.errorMsg)throw new Error(this.errorMsg)}async runPluginTask(s,...t){let e=task_config_1.taskManager.taskWeight.pluginTasks/Object.keys(task_config_1.taskManager.pluginTasks).length;this.options.generateCompileConfig&&(e*=.8);for(const i of this.hooksInfo.pkgNameOrder){const a=this.hooksInfo.infos[i];let n;try{(n=require(a.path))[s]&&(this.updateProcess(`${i}:(${s}) start...`),console.debug(`// ---- ${i}:(${s}) ----`),console.debug(index_1.getMemorySize()),a.internal?await n[s].call(this,this.options,this.result,this.cache,...t):await n[s](this.result.rawOptions,this.buildResult,...t),console.debug(`// ---- ${i}:(${s}) success ----`),this.updateProcess(`${i}:(${s})`,e))}catch(t){if(n&&n.throwError||a.internal)throw console.error(`Run build plugin ${i}:(${s}) failed!`),t;console.warn(t)}}}}function transTitle(s){return"string"!=typeof s?"":s.startsWith("i18n:")?(s=s.replace("i18n:",""),Editor.I18n.t(`builder.${s}`)||console.debug(`${Editor.I18n.t("builder.warn.no_defined_in_i18n",{name:s})}`),Editor.I18n.t(`builder.${s}`)||s):s}async function checkDefaultOptions(s,t){if(!t&&s.packages)for(const t of Object.keys(s.packages)){const e=await Editor.Profile.getConfig(t,`options.${s.platform}`,"default");e&&(Object.assign(e,s.packages[t]),s.packages[t]=e)}}exports.BuildTask=BuildTask;