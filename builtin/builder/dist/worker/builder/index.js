"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTask=void 0;const events_1=require("events"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./utils/index"),asset_1=require("./manager/asset"),build_result_1=require("./manager/build-result"),build_result_2=require("./manager/build-result"),task_config_1=require("./task-config"),stage_task_manager_1=require("./stage-task-manager"),common_options_validator_1=require("../../share/common-options-validator"),plugin_1=require("../plugin"),sub_process_manager_1=require("../worker-pools/sub-process-manager"),bundle_utils_1=require("../../share/bundle-utils"),msg_util_1=require("../../worker/msg-util");class BuildTask extends events_1.EventEmitter{constructor(s,t){super(),this.progress=0,this.pluginTaskWeight=1,this.taskResMap={},this.id=s,this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks"),this.settingTasks=task_config_1.taskManager.getTaskHandle("settingTasks"),this.postprocessTasks=task_config_1.taskManager.getTaskHandle("postprocessTasks"),this.hooksInfo=plugin_1.pluginManager.getHooksInfo(t.platform),this.options=t,this.cache=new asset_1.BuilderAssetCache(this),this.result=new build_result_1.InternalBuildResult(this,!!t.preview),t.preview||(this.buildTasks=task_config_1.taskManager.getTaskHandle("buildTasks"),this.md5Tasks=task_config_1.taskManager.getTaskHandle("md5Tasks"),this.staticsInfo={gameName:t.name,platform:t.platform,scenesNum:t.scenes.length,includeModules:t.includeModules,assetsNum:0,scriptNum:0,time:0,err:"",orientation:"",remoteServerAddress:"",appid:"",size:0,packageName:"",meshNum:0,prefabNum:0,useSplashScreen:!1,designResolution:"",extras:{}},this.options.nextStages&&(this.pluginTaskWeight=1/(this.options.nextStages.length+1)))}get stage(){return this.currentStageTask?this.currentStageTask.name:"build"}async addStatistics(){const s=this.staticsInfo;s.gameName=this.options.name||"",s.platform=this.options.platform||"",s.scenesNum=this.options.scenes.length,s.remoteServerAddress=this.options.server||"",s.includeModules=this.options.includeModules||[];const t=[];t.push(this.result.paths.assets),t.push(this.result.paths.remote),t.push(this.result.paths.settings),t.push(this.result.paths.subpackages);let e=0;t.forEach(s=>{e+=(0,index_1.getFileSizeDeep)(s)}),s.size=e;let i=0,a=0,o=0,n=0;for(const s of this.result.bundles)i+=s.assetsWithoutRedirect.length,a+=s.scripts.length,s.assetsWithoutRedirect.forEach(s=>{const t=this.cache.getAssetInfo(s);t&&"cc.Mesh"===t.type?o++:t&&"cc.Prefab"===t.type&&n++});const r=await Editor.Profile.getProject("builder","splash-setting");this.options.useSplashScreen&&r&&(s.useSplashScreen=!0),s.assetsNum=i,s.scriptNum=a,s.meshNum=o,s.prefabNum=n,s.designResolution=`${this.options.designResolution.width} X ${this.options.designResolution.height}`;try{const s="adsense-h5g-plugin";if(this.options.packages&&this.options.packages[s]&&Editor.Package.getPackages({name:s,enable:!0}).length){const t=this.options.packages[s];t.adsensePropertyCode&&(Editor.Metrics.trackEvent({category:s,action:"adsensePropertyCode",label:t.adsensePropertyCode}),Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:s,value:{B100001:t.adsensePropertyCode}}))}}catch(s){console.debug(s)}}getTaskResult(s){return this.taskResMap[s]}async init(){console.debug("Query all assets info in project"),await task_config_1.taskManager.init(),await this.initOptions(),cc.assetManager.releaseAll(),await this.cache.init(),console.debug(`  Number of all scenes: ${this.cache.scenes.length}`),console.debug(`  Number of all scripts: ${this.cache.scriptUuids.length}`),console.debug(`  Number of other assets: ${this.cache.assetUuids.length}`)}async build(){const{dir:s}=this.result.paths;if(!s)return console.error("No output path can be built.");await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuild),await this.lockAssetDB(),this.buildResult=new build_result_2.BuildResult(this),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeInit),await this.init(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterInit),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuildAssets),await this.runBuildTask(this.buildTasks,task_config_1.taskManager.taskWeight.buildTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuildAssets),await this.runBuildTask(this.md5Tasks,task_config_1.taskManager.taskWeight.md5Tasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeCompressSettings),await this.runBuildTask(this.postprocessTasks,task_config_1.taskManager.taskWeight.postprocessTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterCompressSettings),this.addStatistics(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuild),this.unLockAssetDB(),this.options.generateCompileConfig&&(0,fs_extra_1.outputJSONSync)((0,path_1.join)(this.result.paths.dir,stage_task_manager_1.BuildStageTask.optionsFileName),this.result.compileOptions||this.options);const t=await Editor.Metrics.trackTimeEnd("builder:build-project-total",{output:!0});if(this.staticsInfo&&(this.staticsInfo.time=t,this.error)){const s="object"==typeof this.error?this.error.stack||this.error.message:this.error;this.staticsInfo.err=s}if(console.debug(`build success in ${t} ms!`),msg_util_1.Message.send("build-worker:add-statistics",this.staticsInfo),Array.isArray(this.options.nextStages)){const s=1-this.pluginTaskWeight;for(const t of this.options.nextStages){const e=plugin_1.pluginManager.getCustomBuildStageTasks(this.options.platform,t);if(!e)continue;const i=(0,path_1.join)(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName),a=new stage_task_manager_1.BuildStageTask(Object.assign(Object.assign({},e),{hooksInfo:this.hooksInfo,root:i,taskId:this.id}));if(this.currentStageTask=a,a.on("update",(t,e)=>{this.updateProcess(t,e*s)}),await a.run(),a.error&&!this.breakResolve){this.error=a.error;break}}}}break(s){return new Promise(async t=>{this.breakResolve=t,sub_process_manager_1.workerManager.killRunningChilds(),this.unLockAssetDB(),this.currentStageTask&&this.currentStageTask.break(s)})}async lockAssetDB(){this.updateProcess("Start lock asset db..."),await Manager.assetDBManager.pause("build"),this.dbPauseNoticeId=Editor.Task.addNotice({title:Editor.I18n.t("builder.tips.pauseAssetImport"),source:Editor.I18n.t("builder.title")})}unLockAssetDB(){Manager.assetDBManager.resume(),this.dbPauseNoticeId&&Editor.Task.removeNotice(this.dbPauseNoticeId)}async getPreviewSettings(){return await this.init(),this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks",!0),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),this.result.settings.engine.builtinAssets=Array.from(this.result.bundleMap[bundle_utils_1.BuiltinBundleName.INTERNAL]._rootAssets),this.result.settings.assets.projectBundles=this.result.bundles.map(s=>s.name),this.result.settings}updateProcess(s,t){t&&(this.progress=Editor.Utils.Math.clamp01(this.progress+t)),console.debug(s+(100*this.progress).toFixed(0)+"%"),this.emit("update",s,this.progress)}async initOptions(){await checkDefaultOptions(this.options,BuildTask.isCommandBuild),await(0,common_options_validator_1.checkProjectSetting)(this.options,BuildTask.isCommandBuild),await(0,common_options_validator_1.checkPreferenceSetting)(this.options,BuildTask.isCommandBuild),this.options.appTemplateData={debugMode:this.options.debug,renderMode:!1,showFPS:this.options.debug,resolution:{width:this.options.designResolution.width,height:this.options.designResolution.height,policy:cc.ResolutionPolicy.FIXED_HEIGHT},md5Cache:this.options.md5Cache,cocosTemplate:""};const s=this.options.appTemplateData.resolution;if(this.options.designResolution.fitHeight?this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.SHOW_ALL:s.policy=cc.ResolutionPolicy.FIXED_HEIGHT:this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.FIXED_WIDTH:s.policy=cc.ResolutionPolicy.NO_BORDER,!this.options.preview)if(this.options.buildEngineParam={debug:this.options.debug,sourceMaps:this.options.sourceMaps,includeModules:this.options.includeModules,engineVersion:Editor.App.version,platform:"HTML5",md5Map:[],engineName:"cocos-js",useCache:!1!==this.options.useBuildEngineCache},this.options.buildScriptParam={experimentalEraseModules:this.options.experimentalEraseModules,outputName:"project",flags:Object.assign({DEBUG:!!this.options.debug},this.options.flags),polyfills:this.options.polyfills,hotModuleReload:!1},this.options.assetSerializeOptions={"cc.EffectAsset":{glsl1:this.options.includeModules.includes("gfx-webgl"),glsl3:this.options.includeModules.includes("gfx-webgl2"),glsl4:!1},exportCCON:!1},task_config_1.taskManager.cacheConfig.engine||(this.options.compileEngineForce=!0),this.options.useBuiltinServer&&this.result.paths.dir===(0,path_1.join)(Editor.Project.path,"build",this.options.outputName)){const s=await Editor.Message.request("preview","query-preview-url");this.options.server=new URL((0,path_1.relative)(Editor.Project.path,this.result.paths.dir),s).href,console.log(`Use builtin remote server: ${this.options.server}`)}else this.options.useBuiltinServer=!1}async runBuildTask(s,t,...e){this.options.generateCompileConfig&&(t*=.8),t=this.pluginTaskWeight*t/s.length;for(let i=0;i<s.length;i++){if(this.breakResolve){this.breakResolve(),await this.onError(new Error(`Build task ${this.options.outputName} is break!`));break}const a=s[i],o=await transTitle(a.title),n=`// ---- build task ${o} ----`;Editor.Metrics.trackTimeStart(n),this.updateProcess(o+" start"),console.debug(n),console.debug((0,index_1.getMemorySize)());try{const s=await a.handle.call(this,this.options,this.result,this.cache,...e);a.name&&s&&(this.taskResMap[a.name]=s);const i=await Editor.Metrics.trackTimeEnd(n,{output:!0});this.updateProcess(`run build task ${o} success in ${i} ms √`,t)}catch(s){return this.updateProcess(`run build task ${o} failed!`,t),void await this.onError(s)}}}async runPluginTask(s,...t){const e=this.pluginTaskWeight*task_config_1.taskManager.taskWeight.pluginTasks/Object.keys(task_config_1.taskManager.pluginTasks).length;let i=1;try{i=this.hooksInfo.pkgNameOrder.filter(t=>{if(Editor.Module.requireFile(this.hooksInfo.infos[t].path)[s])return!0}).length}catch(s){console.warn(s)}for(const a of this.hooksInfo.pkgNameOrder){const o=this.hooksInfo.infos[a];let n;if(this.breakResolve){this.breakResolve(),await this.onError(new Error(`Build task ${this.options.outputName} is break!`));break}try{const r=`// ---- build task ${a}：${s} ----`;if(Editor.Metrics.trackTimeStart(r),(n=Editor.Module.requireFile(o.path))[s]){this.updateProcess(`${a}:(${s}) start...`),console.debug(r),console.debug((0,index_1.getMemorySize)()),o.internal?await n[s].call(this,this.options,this.result,this.cache,...t):await n[s](this.result.rawOptions,this.buildResult,...t);const u=await Editor.Metrics.trackTimeEnd(r,{output:!0});this.updateProcess(`${a}:(${s}) in ${u} ms`,e*(1/i))}}catch(t){if(n&&n.throwError||o.internal)return console.error(new BuildError(`Run build plugin ${a}:(${s}) failed!`).stack),void await this.onError(t);console.warn(t)}}}async onError(s){this.error=s;for(const t of this.hooksInfo.pkgNameOrder){const e=this.hooksInfo.infos[t];let i;try{(i=Editor.Module.requireFile(e.path)).onError&&(this.updateProcess(`${t}:(onError) start...`),console.debug(`// ---- ${t}:(onError) ----`),console.debug((0,index_1.getMemorySize)()),e.internal?await i.onError.call(this,this.options,this.result,this.cache):await i.onError(this.result.rawOptions,this.buildResult),console.debug(`// ---- ${t}:(onError) success ----`),this.updateProcess(`${t}:(onError)`))}catch(s){console.error(new BuildError(`Run build plugin ${t}:(onError) failed!`).stack)}}throw this.unLockAssetDB(),s}}function transTitle(s){return"string"!=typeof s?"":s.startsWith("i18n:")?(s=s.replace("i18n:",""),Editor.I18n.t(`${s}`)||console.debug(`${Editor.I18n.t("builder.warn.no_defined_in_i18n",{name:s})}`),Editor.I18n.t(`${s}`)||s):s}async function checkDefaultOptions(s,t){if(!t&&s.packages)for(const t of Object.keys(s.packages)){const e=await Editor.Profile.getConfig(t,`builder.options.${s.platform}`,"default");e&&(Object.assign(e,s.packages[t]),s.packages[t]=e)}}exports.BuildTask=BuildTask,BuildTask.isCommandBuild=!1;class BuildError{constructor(s){Error.captureStackTrace(this,BuildError),this.message=s}}