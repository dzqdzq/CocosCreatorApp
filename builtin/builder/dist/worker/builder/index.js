"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTask=void 0;const events_1=require("events"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./utils/index"),asset_1=require("./manager/asset"),build_result_1=require("./manager/build-result"),build_result_2=require("./manager/build-result"),task_config_1=require("./task-config"),stage_task_manager_1=require("./stage-task-manager"),common_options_validator_1=require("../../share/common-options-validator"),plugin_1=require("../plugin");class BuildTask extends events_1.EventEmitter{constructor(s,t){super(),this.progress=0,this.pluginTaskWieght=1,this.taskResMap={},this.id=s,this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks"),this.settingTasks=task_config_1.taskManager.getTaskHandle("settingTasks"),this.postprocessTasks=task_config_1.taskManager.getTaskHandle("postprocessTasks"),this.hooksInfo=plugin_1.pluginManager.getHooksInfo(t.platform),this.options=t,this.cache=new asset_1.BuilderAssetCache(this),this.result=new build_result_1.InternalBuildResult(this,!!t.preview),t.preview||(this.buildTasks=task_config_1.taskManager.getTaskHandle("buildTasks"),this.md5Tasks=task_config_1.taskManager.getTaskHandle("md5Tasks"),this.staticsInfo={gameName:t.name,platform:t.platform,scenesNum:t.scenes.length,includeModules:t.includeModules,assetsNum:0,scriptNum:0,time:0,err:"",orientation:"",remoteServerAddress:"",appid:"",size:0,packageName:""})}addStatistics(){const s=this.staticsInfo,t=[];t.push(this.result.paths.assets),t.push(this.result.paths.remote),t.push(this.result.paths.settings),t.push(this.result.paths.subpackages);let i=0;t.forEach(s=>{i+=(0,index_1.getFileSizeDeep)(s)}),s.size=i,s.includeModules=this.options.includeModules;let e=0,a=0;for(const s of this.result.bundles)e+=s.assetsWithoutRedirect.length,a+=s.scripts.length;s.assetsNum=e,s.scriptNum=a}getTaskResult(s){return this.taskResMap[s]}async init(){console.debug("Query all assets info in project"),await task_config_1.taskManager.init(),await this.initOptions(),cc.assetManager.releaseAll(),await this.cache.init(),console.debug(`  Number of all scenes: ${this.cache.sceneUuids.length}`),console.debug(`  Number of all scripts: ${this.cache.scriptUuids.length}`),console.debug(`  Number of other assets: ${this.cache.assetUuids.length}`)}async build(){const{dir:s}=this.result.paths;if(!s)return console.error("No output path can be built.");if(await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuild),this.buildResult=new build_result_2.BuildResult(this),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeInit),await this.init(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterInit),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuildAssets),await this.runBuildTask(this.buildTasks,task_config_1.taskManager.taskWeight.buildTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuildAssets),await this.runBuildTask(this.md5Tasks,task_config_1.taskManager.taskWeight.md5Tasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeCompressSettings),await this.runBuildTask(this.postprocessTasks,task_config_1.taskManager.taskWeight.postprocessTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterCompressSettings),this.addStatistics(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuild),this.options.generateCompileConfig&&(0,fs_extra_1.outputJSONSync)((0,path_1.join)(this.result.paths.dir,stage_task_manager_1.BuildStageTask.optionsFileName),this.result.compileOptions||this.options),Array.isArray(this.options.nextStages)){const s=1-this.pluginTaskWieght;for(const t of this.options.nextStages){const i=plugin_1.pluginManager.getCustomBuildStageTasks(this.options.platform,t);if(!i)continue;const e=(0,path_1.join)(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName),a=new stage_task_manager_1.BuildStageTask(Object.assign(Object.assign({},i),{hooksInfo:this.hooksInfo,root:e}));a.on("update",(t,i)=>{this.updateProcess(t,i*s)}),await a.run(),a.error&&(this.error=a.error)}}}async getPreviewSettings(){return await this.init(),this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks",!0),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),this.result.getOutputSettings()}updateProcess(s,t){t&&(this.progress=Editor.Utils.Math.clamp01(this.progress+t)),console.debug(s+(100*this.progress).toFixed(0)+"%"),this.emit("update",s,this.progress)}async initOptions(){await checkDefaultOptions(this.options,BuildTask.isCommandBuild),await(0,common_options_validator_1.checkProjectSetting)(this.options,BuildTask.isCommandBuild),await(0,common_options_validator_1.checkPreferenceSetting)(this.options,BuildTask.isCommandBuild),this.options.appTemplateData={debugMode:this.options.debug,renderMode:!1,showFPS:this.options.debug,resolution:{width:this.options.designResolution.width,height:this.options.designResolution.height,policy:cc.ResolutionPolicy.FIXED_HEIGHT},md5Cache:this.options.md5Cache,cocosTemplate:""};const s=this.options.appTemplateData.resolution;if(this.options.designResolution.fitHeight?this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.SHOW_ALL:s.policy=cc.ResolutionPolicy.FIXED_HEIGHT:this.options.designResolution.fitWidth?s.policy=cc.ResolutionPolicy.FIXED_WIDTH:s.policy=cc.ResolutionPolicy.NO_BORDER,!this.options.preview){if(this.options.buildEngineParam={debug:this.options.debug,sourceMaps:this.options.sourceMaps,includeModules:this.options.includeModules,engineVersion:Editor.App.version,platform:"HTML5",md5Map:[],engineName:"cocos-js",useCache:!1!==this.options.useBuildEngineCache},this.options.buildScriptParam={experimentalEraseModules:this.options.experimentalEraseModules,outputName:"project",flags:Object.assign({DEBUG:!!this.options.debug},this.options.flags),polyfills:this.options.polyfills},this.options.assetSerializeOptions={"cc.EffectAsset":{glsl1:this.options.includeModules.includes("gfx-webgl"),glsl3:this.options.includeModules.includes("gfx-webgl2"),glsl4:!1},exportCCON:!1},task_config_1.taskManager.cacheConfig.engine||(this.options.compileEngineForce=!0),this.options.useBuiltinServer&&this.result.paths.dir===(0,path_1.join)(Editor.Project.path,"build",this.options.outputName)){const s=await Editor.Message.request("preview","query-preview-url");this.options.server=new URL((0,path_1.relative)(Editor.Project.path,this.result.paths.dir),s).href,console.log(`Use builtin remote server: ${this.options.server}`)}else this.options.useBuiltinServer=!1;this.options.nextStages&&(this.pluginTaskWieght=.6)}}async runBuildTask(s,t,...i){this.options.generateCompileConfig&&(t*=.8);for(let e=0;e<s.length;e++){const a=s[e],o=await transTitle(a.title);this.updateProcess(o+" start"),console.time("// ---- "+o+" ----"),console.log("// ---- "+o+" ----"),console.debug((0,index_1.getMemorySize)());try{const e=await a.handle.call(this,this.options,this.result,this.cache,...i);a.name&&e&&(this.taskResMap[a.name]=e),console.timeEnd("// ---- "+o+" ----"),this.updateProcess(o+" âˆš",1/s.length*t)}catch(s){return this.updateProcess(s.message),void await this.onError(s)}}}async runPluginTask(s,...t){const i=this.pluginTaskWieght*task_config_1.taskManager.taskWeight.pluginTasks/Object.keys(task_config_1.taskManager.pluginTasks).length;for(const e of this.hooksInfo.pkgNameOrder){const a=this.hooksInfo.infos[e];let o;try{(o=Editor.Module.requireFile(a.path))[s]&&(this.updateProcess(`${e}:(${s}) start...`),console.debug(`// ---- ${e}:(${s}) ----`),console.debug((0,index_1.getMemorySize)()),a.internal?await o[s].call(this,this.options,this.result,this.cache,...t):await o[s](this.result.rawOptions,this.buildResult,...t),console.debug(`// ---- ${e}:(${s}) success ----`),this.updateProcess(`${e}:(${s})`,i))}catch(t){if(o&&o.throwError||a.internal)return console.error(new BuildError(`Run build plugin ${e}:(${s}) failed!`).stack),void await this.onError(t);console.warn(t)}}}async onError(s){this.error=s;for(const t of this.hooksInfo.pkgNameOrder){const i=this.hooksInfo.infos[t];let e;try{(e=Editor.Module.requireFile(i.path)).onError&&(this.updateProcess(`${t}:(onError) start...`),console.debug(`// ---- ${t}:(onError) ----`),console.debug((0,index_1.getMemorySize)()),i.internal?await e.onError.call(this,this.options,this.result,this.cache):await e.onError(this.result.rawOptions,this.buildResult),console.debug(`// ---- ${t}:(onError) success ----`),this.updateProcess(`${t}:(onError)`))}catch(s){console.error(new BuildError(`Run build plugin ${t}:(onError) failed!`).stack)}}throw console.error(s),s}}function transTitle(s){return"string"!=typeof s?"":s.startsWith("i18n:")?(s=s.replace("i18n:",""),Editor.I18n.t(`${s}`)||console.debug(`${Editor.I18n.t("builder.warn.no_defined_in_i18n",{name:s})}`),Editor.I18n.t(`${s}`)||s):s}async function checkDefaultOptions(s,t){if(!t&&s.packages)for(const t of Object.keys(s.packages)){const i=await Editor.Profile.getConfig(t,`options.${s.platform}`,"default");i&&(Object.assign(i,s.packages[t]),s.packages[t]=i)}}exports.BuildTask=BuildTask,BuildTask.isCommandBuild=!1;class BuildError{constructor(s){Error.captureStackTrace(this,BuildError),this.message=s}}