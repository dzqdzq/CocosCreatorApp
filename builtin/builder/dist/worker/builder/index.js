"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildTask=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),asset_1=require("./manager/asset"),build_result_1=require("./manager/build-result"),build_result_2=require("./manager/build-result"),task_config_1=require("./task-config"),stage_task_manager_1=require("./stage-task-manager"),common_options_validator_1=require("../../share/common-options-validator"),plugin_1=require("../plugin"),sub_process_manager_1=require("../worker-pools/sub-process-manager"),bundle_1=require("./asset-handler/bundle"),metric_1=require("./metric"),cc_1=require("cc"),task_base_1=require("./manager/task-base"),console_1=require("../console"),utils_1=require("../../share/utils"),build_template_1=require("./manager/build-template"),render_1=require("@editor/sentry/render");class BuildTask extends task_base_1.BuildTaskBase{cache;result;buildTemplate;buildResult;options;hooksInfo;dataTasks;settingTasks;postprocessTasks;buildTasks;md5Tasks;dbPauseNoticeId;mainTaskWeight=1;static isCommandBuild=!1;currentStageTask;bundleManager;hookMap={onBeforeBuild:"onBeforeBuild",onBeforeInit:"onBeforeInit",onAfterInit:"onAfterInit",onBeforeBuildAssets:"onBeforeBuildAssets",onAfterBuildAssets:"onAfterBuildAssets",onBeforeCompressSettings:"onBeforeCompressSettings",onAfterCompressSettings:"onAfterCompressSettings",onAfterBuild:"onAfterBuild",onBeforeCopyBuildTemplate:"onBeforeCopyBuildTemplate",onAfterCopyBuildTemplate:"onAfterCopyBuildTemplate",onError:"onError"};pipeline=[];taskResMap={};hasInitStatistics=!1;crashInfo={};constructor(t,s){super(t,"build"),this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks"),this.settingTasks=task_config_1.taskManager.getTaskHandle("settingTasks"),this.hooksInfo=plugin_1.pluginManager.getHooksInfo(s.platform),this.options=s,this.crashInfo={},this.cache=new asset_1.BuilderAssetCache(this),this.result=new build_result_1.InternalBuildResult(this,!!s.preview),s.preview||"bundle"===s.buildMode||(this.result.addListener("updateProcess",t=>{this.updateProcess(t)}),this.buildTasks=task_config_1.taskManager.getTaskHandle("buildTasks"),this.md5Tasks=task_config_1.taskManager.getTaskHandle("md5Tasks"),this.postprocessTasks=task_config_1.taskManager.getTaskHandle("postprocessTasks"),this.buildResult=new build_result_2.BuildResult(this),this.options.nextStages&&(this.mainTaskWeight=1/(this.options.nextStages.length+1)),this.hookWeight=this.mainTaskWeight*task_config_1.taskManager.taskWeight.pluginTasks,this.buildTemplate=new build_template_1.BuildTemplate(this.options.platform,this.options.taskName,plugin_1.pluginManager.getBuildTemplateConfig(this.options.platform)))}get stage(){return this.currentStageTask?this.currentStageTask.name:"build"}async addStatistics(){if(!this.error&&!this.hasInitStatistics){try{await(0,metric_1.collectMetricFromResult)(this.options,this.result,this.bundleManager&&this.bundleManager.bundles)}catch(t){console.debug(t)}this.hasInitStatistics=!0}}postCrashStatistics(){(0,metric_1.collectCrashMetric)(this.crashInfo,this.options,this.result,this.bundleManager&&this.bundleManager.bundles),this.emit("store-crash-info",this.crashInfo)}getTaskResult(t){return this.taskResMap[t]}async init(){this.error||(console.debug("Query all assets info in project"),await task_config_1.taskManager.init(),await this.initOptions(),cc.assetManager.releaseAll(),await this.cache.init())}async run(){var t=this.result.paths["dir"];return t?("bundle"===this.options.buildMode?await this.buildBundleOnly():(await(0,fs_extra_1.ensureDir)(this.result.paths.dir),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuild),this.options.useCache||(0,fs_extra_1.emptyDirSync)(this.result.paths.dir),await this.lockAssetDB(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeInit),await this.init(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterInit),this.postCrashStatistics(),await this.initBundleManager(),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onBeforeBundleDataTask),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onAfterBundleDataTask),this.postCrashStatistics(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeBuildAssets),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onBeforeBundleBuildTask),await this.runBuildTask(this.buildTasks,task_config_1.taskManager.taskWeight.buildTasks),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onAfterBundleBuildTask),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuildAssets),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeCompressSettings),await this.runBuildTask(this.postprocessTasks,task_config_1.taskManager.taskWeight.postprocessTasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterCompressSettings),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeCopyBuildTemplate),await this.buildTemplate.copyTo(this.result.paths.output),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterCopyBuildTemplate),await this.runBuildTask(this.md5Tasks,task_config_1.taskManager.taskWeight.md5Tasks),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterBuild),await this.postBuild(),await this.handleBuildStageTask()),!0):(console.error("No output path can be built."),!1)}async buildBundleOnly(){await this.lockAssetDB(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onBeforeInit),await this.init(),await this.runPluginTask(task_config_1.taskManager.pluginTasks.onAfterInit),this.bundleManager=new bundle_1.BundleManager(this.options,this),this.bundleManager.options.dest=this.result.paths.assets,this.bundleManager.destDir=this.result.paths.assets,this.bundleManager.on("update",(t,s)=>{this.updateProcess(t,s-this.bundleManager.progress)}),await this.bundleManager.run(),await this.runBuildTask(task_config_1.taskManager.getTaskHandleFromNames(["setting-task/cache","setting-task/asset","setting-task/script"]),task_config_1.taskManager.taskWeight.postprocessTasks);var t=this.bundleManager.bundles.filter(t=>t.output).sort((t,s)=>t.name.localeCompare(s.name));if(this.options.md5Cache)for(const s of t)this.result.settings.assets.bundleVers[s.name]=s.version;t=JSON.stringify(this.result.settings,null,this.options.debug?4:0);(0,fs_extra_1.outputFileSync)(this.result.paths.settings,t,"utf8"),await this.unLockAssetDB()}async postBuild(){this.unLockAssetDB(),this.options.generateCompileConfig&&(0,fs_extra_1.outputJSONSync)(this.result.paths.compileConfig,this.result.compileOptions||this.options);var t=await Editor.Metrics.trackTimeEnd("builder:build-project-total",{output:!0});console.debug(`build task(${this.options.taskName}) in ${t}!`),this.result.staticsInfo&&(this.result.staticsInfo.B100042=t),await this.addStatistics()}async handleBuildStageTask(){if(Array.isArray(this.options.nextStages)){const a=1-this.mainTaskWeight;for(const n of this.options.nextStages){var t=plugin_1.pluginManager.getBuildStageWithHookTasks(this.options.platform,n);if(t){var s=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),this.options.outputName);if(t.message){var{name:i,target:e}=t.message;Editor.Message.send(e,i,s,this.result.rawOptions)}else{e=Date.now(),i=new stage_task_manager_1.BuildStageTask(this.id,{...t,hooksInfo:this.hooksInfo,root:s,buildTaskOptions:this.options});if((this.currentStageTask=i).on("update",(t,s)=>{this.updateProcess(t,s*a)}),await i.run(),"make"===n&&(this.result.staticsInfo.B100043=Number((Date.now()-e)/1e3)),this.error)return void await this.onError(this.error);if(i.error)return void(this.error=i.error)}}else this.updateProcess(`No stage task: ${n} in platform ${this.options.platform}, please check your build options`,a)}}}async initBundleManager(){this.error?await this.onError(this.error):(this.bundleManager=new bundle_1.BundleManager(this.options,this),this.bundleManager.options.dest=this.result.paths.assets,this.bundleManager.destDir=this.result.paths.assets,this.options.preview?await this.bundleManager.initOptions():this.bundleManager.addListener("update",(t,s)=>{this.updateProcess(t)}),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onBeforeBundleInit),await this.bundleManager.initBundle(),await this.bundleManager.runPluginTask(this.bundleManager.hookMap.onAfterBundleInit))}break(t){sub_process_manager_1.workerManager.killRunningChilds(),this.unLockAssetDB(),this.bundleManager&&this.bundleManager.break(t),this.currentStageTask&&this.currentStageTask.break(t),this.onError(new Error(`Build task ${this.options.taskName||this.options.outputName} is break!`),!1)}async lockAssetDB(){this.updateProcess("Start lock asset db..."),await Manager.assetDBManager.pause("build"),this.dbPauseNoticeId=Editor.Task.addNotice({title:Editor.I18n.t("builder.tips.pauseAssetImport"),source:Editor.I18n.t("builder.title")})}unLockAssetDB(){Manager.assetDBManager.resume(),void 0!==this.dbPauseNoticeId&&Editor.Task.removeNotice(this.dbPauseNoticeId)}async getPreviewSettings(){try{return await this.init(),this.result.settings.engine.engineModules=this.options.includeModules,this.dataTasks=task_config_1.taskManager.getTaskHandle("dataTasks"),await this.initBundleManager(),await this.runBuildTask(this.dataTasks,task_config_1.taskManager.taskWeight.dataTasks),await this.runBuildTask(this.settingTasks,task_config_1.taskManager.taskWeight.settingTasks),this.result.settings}catch(t){return console.error(t),render_1.sentry.captureException(t),null}}async initOptions(){this.options.platformType=plugin_1.pluginManager.queryPlatformType(this.options.platform),await checkDefaultOptions(this.options,BuildTask.isCommandBuild),await(0,common_options_validator_1.checkProjectSetting)(this.options),await(0,common_options_validator_1.checkPreferenceSetting)(this.options,BuildTask.isCommandBuild),this.options.resolution={width:this.options.designResolution.width,height:this.options.designResolution.height,policy:cc_1.ResolutionPolicy.SHOW_ALL};var t,s=this.options.resolution,i=(this.options.designResolution.fitHeight?this.options.designResolution.fitWidth?s.policy=cc_1.ResolutionPolicy.SHOW_ALL:s.policy=cc_1.ResolutionPolicy.FIXED_HEIGHT:this.options.designResolution.fitWidth?s.policy=cc_1.ResolutionPolicy.FIXED_WIDTH:s.policy=cc_1.ResolutionPolicy.NO_BORDER,this.options.macroConfig.CUSTOM_PIPELINE_NAME);this.options.customPipeline?(-1!==(t=this.options.includeModules.findIndex(t=>"legacy-pipeline"===t))&&this.options.includeModules.splice(t,1),this.options.includeModules.includes("custom-pipeline")||this.options.includeModules.push("custom-pipeline"),"Builtin"!==i&&i||this.options.includeModules.push("custom-pipeline-builtin-scripts")):(-1!==(t=this.options.includeModules.findIndex(t=>"custom-pipeline"===t))&&this.options.includeModules.splice(t,1),this.options.includeModules.includes("legacy-pipeline")||this.options.includeModules.push("legacy-pipeline")),this.options.preview||(i=await Editor.Message.request("engine","query-engine-info"),this.options.engineInfo||(this.options.engineInfo=i),this.options.appTemplateData={debugMode:this.options.debug,renderMode:!1,showFPS:this.options.debug,resolution:s,md5Cache:this.options.md5Cache,cocosTemplate:""},t=(await Editor.Message.request("engine","query-engine-info")).typescript,this.options.buildEngineParam={entry:t.path,debug:this.options.debug,mangleProperties:this.options.mangleProperties,inlineEnum:this.options.inlineEnum,sourceMaps:this.options.sourceMaps,includeModules:this.options.includeModules,engineVersion:Editor.App.version,md5Map:[],engineName:"cocos-js",output:(0,path_1.join)(this.result.paths.dir,"cocos-js"),platformType:this.options.platformType,useCache:!1!==this.options.useBuildEngineCache,nativeCodeBundleMode:this.options.nativeCodeBundleMode,wasmCompressionMode:this.options.wasmCompressionMode},this.options.buildScriptParam={experimentalEraseModules:this.options.experimentalEraseModules,outputName:"project",flags:{DEBUG:!!this.options.debug,...this.options.flags},polyfills:this.options.polyfills,hotModuleReload:!1,platform:this.options.platformType,commonDir:"",bundleCommonChunk:this.options.bundleCommonChunk??!1,targets:this.options.buildScriptTargets},this.options.polyfills?this.options.polyfills.targets=this.options.buildScriptTargets:this.options.polyfills={targets:this.options.buildScriptTargets},this.options.assetSerializeOptions={"cc.EffectAsset":{glsl1:this.options.includeModules.includes("gfx-webgl"),glsl3:this.options.includeModules.includes("gfx-webgl2"),glsl4:!1}},task_config_1.taskManager.cacheConfig.engine||(this.options.compileEngineForce=!0),this.options.useBuiltinServer&&this.result.paths.dir===(0,path_1.join)(Editor.Project.path,"build",this.options.outputName)?(i=await Editor.Message.request("preview","query-preview-url"),this.options.server=new URL((0,path_1.relative)(Editor.Project.path,this.result.paths.dir),i).href,console.log("Use builtin remote server: "+this.options.server)):this.options.useBuiltinServer=!1)}async runBuildTask(s,i,...e){i=this.mainTaskWeight*i/s.length;for(let t=0;t<s.length;t++){if(this.error)return void this.onError(this.error);var a=s[t],n=await transTitle(a.title),o=`// ---- build task ${n} ----`;Editor.Metrics.trackTimeStart(o),this.updateProcess(n+" start"),console.debug(o),console_1.newConsole.trackMemoryStart(n);try{var r=await a.handle.call(this,this.options,this.result,this.cache,...e),l=(a.name&&r&&(this.taskResMap[a.name]=r),await Editor.Metrics.trackTimeEnd(o,{output:!0}));this.updateProcess(`run build task ${n} success in ${(0,utils_1.formatMSTime)(l)}âˆš`,i,"log")}catch(t){return console_1.newConsole.trackMemoryEnd(n),this.updateProcess(`run build task ${n} failed!`,i,"error"),void await this.onError(t,!0)}console_1.newConsole.trackMemoryEnd(n)}}async handleHook(t,s,...i){s?await t.call(this,this.options,this.result,this.cache,...i):await t(this.result.rawOptions,this.buildResult,...i)}onError(t,s=!0){if(this.error=t,this.bundleManager&&(this.bundleManager.error=t),s)throw t}async runErrorHook(){try{var s="onError";for(const a of this.hooksInfo.pkgNameOrder){var t,i=this.hooksInfo.infos[a],e=a+`:(${s})`;try{(t=Editor.Module.__protected__.requireFile(i.path))[s]&&(this.updateProcess(e+" start..."),console.debug(`// ---- ${a}:(${s}) ----`),console_1.newConsole.trackMemoryStart(e),i.internal?await t[s].call(this,this.options,this.result,this.cache):await t[s](this.result.rawOptions,this.buildResult),console_1.newConsole.trackMemoryEnd(e),console.debug(`// ---- ${a}:(${s}) success ----`),this.updateProcess(a+`:(${s})`))}catch(t){console_1.newConsole.trackMemoryEnd(e),console.error(new BuildError(`Run build plugin ${a}:(${s}) failed!`).stack)}}await this.postBuild()}catch(t){console.debug(t),render_1.sentry.captureException(t)}}}function transTitle(t){return"string"!=typeof t?"":t.startsWith("i18n:")&&(t=t.replace("i18n:",""),Editor.I18n.t(""+t)||console.debug(""+Editor.I18n.t("builder.warn.no_defined_in_i18n",{name:t})),Editor.I18n.t(""+t))||t}async function checkDefaultOptions(t,s){if(!s&&t.packages)for(const e of Object.keys(t.packages)){var i=await Editor.Profile.getConfig(e,"builder.options."+t.platform,"default");i&&(Object.assign(i,t.packages[e]),t.packages[e]=i)}}exports.BuildTask=BuildTask;class BuildError{message;constructor(t){Error.captureStackTrace(this,BuildError),this.message=t}}