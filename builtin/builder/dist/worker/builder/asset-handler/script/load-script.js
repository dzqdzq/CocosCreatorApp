"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){e[o=void 0===o?r:o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var i=function(e){return(i=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),o=0;o<r.length;o++)"default"!==r[o]&&__createBinding(t,e,r[o]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.title=void 0,exports.loadScript=loadScript;const executor_1=require("@editor/lib-programming/dist/executor"),loader_1=require("@cocos/creator-programming-quick-pack/lib/loader");exports.title="i18n:builder.tasks.load_script";let executor=null;class GlobalEnv{async record(o){this.clear(),this._queue.push(async()=>{var e=Object.keys(globalThis),t=(await o(),Object.keys(globalThis));for(const r of t)e.includes(r)||this._incrementalKeys.add(r);console.debug("Incremental keys: "+Array.from(this._incrementalKeys))}),await this.processQueue()}clear(){this._queue.push(async()=>{for(const e of this._incrementalKeys)delete globalThis[e];this._incrementalKeys.clear()})}async processQueue(){for(;0<this._queue.length;){var e=this._queue.shift();e&&await e()}}_incrementalKeys=new Set;_queue=[]}const globalEnv=new GlobalEnv;async function loadScript(e){e.length?(console.debug("reload all scripts."),await globalEnv.record(async()=>{if(!executor){console.log("creating executor ...");var e=await Editor.Message.request("programming","packer-driver/get-loader-context","editor"),e=loader_1.QuickPackLoaderContext.deserialize(e);const r=(await Promise.resolve().then(()=>__importStar(require("cc/preload"))))["loadDynamic"];var t=await Editor.Message.request("programming","packer-driver/query-cc-editor-module-map");(executor=await executor_1.Executor.create({importEngineMod:async e=>r(e),quickPackLoaderContext:e,cceModuleMap:t})).addPolyfillFile(require.resolve("@editor/build-polyfills/prebuilt/editor/bundle"))}executor?(e=await Editor.Message.request("programming","query-sorted-plugins",{loadPluginInEditor:!0}),executor.setPluginScripts(e),await executor.reload()):console.error("Failed to init executor")})):console.debug("No script need reload.")}