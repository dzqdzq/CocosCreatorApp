"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildSeparateEngine=buildSeparateEngine,exports.buildCocos=buildCocos;const fs_extra_1=require("fs-extra"),path_1=require("path"),crypto_1=require("crypto"),ccbuild_1=require("@cocos/ccbuild"),utils_1=require("../../utils");class EngineCachePaths{dir;all;plugin;meta;signatureJSON;pluginJSON;constructor(e,t){this.dir=e,this.all=(0,path_1.join)(e,"all"),this.plugin=(0,path_1.join)(e,t),this.meta=(0,path_1.join)(e,"meta.json"),this.signatureJSON=(0,path_1.join)(this.plugin,"signature.json"),this.pluginJSON=(0,path_1.join)(this.plugin,"plugin.json")}toJSON(){return{dir:this.dir,all:this.all,plugin:this.plugin,meta:this.meta,signatureJSON:this.signatureJSON,pluginJSON:this.pluginJSON}}}function extractMacros(e){return e.split("||").map(e=>e.trim().substring(1))}function intiEngineFeatures(e){e=require((0,path_1.join)(e,"editor","engine-features","render-config.json"));const n=[],i={},a=(e,t)=>{t.envCondition&&(i[e]={envList:extractMacros(t.envCondition),fallback:t.fallback}),t.enginePlugin&&n.push(e)};return Object.entries(e.features).forEach(([e,t])=>{e=e,"options"in(t=t)?Object.entries(t.options).forEach(([e,t])=>{a(e,t)}):a(e,t)}),{envLimitModule:i,pluginFeatures:n}}class EngineFeatureQuery{all=[];allUnit=[];plugin=[];pluginUnit=[];engineStatsQuery;envLimitModule={};_defaultPlugins;_excludeFeatures=["spine-4.2"];env;constructor(e){this.env={mode:"BUILD",platform:e.platformType,flags:{SERVER_MODE:!1,DEBUG:!1,WASM_SUBPACKAGE:!1}};e=intiEngineFeatures(e.engine);this.envLimitModule=e.envLimitModule,this._defaultPlugins=e.pluginFeatures}static async create(e){var t=new EngineFeatureQuery(e);return await t._init(e),t}async _init(e){this.engineStatsQuery=await ccbuild_1.StatsQuery.create(e.engine);var t=this.filterEngineModules(this.engineStatsQuery.getFeatures());this.all=t.filter(e=>!this._excludeFeatures.includes(e)),this.allUnit=this.engineStatsQuery.getUnitsOfFeatures(this.all),"default"===e.pluginFeatures?(this.plugin=this.filterEngineModules(this._defaultPlugins),this.pluginUnit=this.engineStatsQuery.getUnitsOfFeatures(this.plugin)):(this.plugin=this.all,this.pluginUnit=this.allUnit)}filterEngineModules(i){const a=this.engineStatsQuery.constantManager.genCCEnvConstants(this.env),s={};return Object.keys(this.envLimitModule).forEach(e=>{var t,n;i.includes(e)&&({envList:t,fallback:n}=this.envLimitModule[e],t.some(e=>a[e])||(s[e]=n||"",n?i.splice(i.indexOf(e),1,n):i.splice(i.indexOf(e),1)))}),i}getUnitsOfFeatures(e){return this.engineStatsQuery.getUnitsOfFeatures(e)}}class EngineFeatureUnitGenerator{metaInfo;importMap={};engineCachePaths;engineFeatureQuery;options;constructor(e,t,n,i){this.metaInfo=t,this.engineCachePaths=n,this.engineFeatureQuery=i,this.options=e}static async create(e){var t=await EngineFeatureQuery.create({platformType:e.platformType,engine:e.engine,pluginFeatures:e.pluginFeatures}),n=await buildCocos({...e,engineFeatureQuery:t}),i=(0,fs_extra_1.readJSONSync)(n.meta);return new EngineFeatureUnitGenerator(e,i,n,t)}isAliasedChunk(e){return e in this.metaInfo.chunkAliases}getFileName(e){return this.metaInfo.chunkAliases[e]??e}addChunkToPlugin=e=>{var t=this.getFileName(e),e=this.isAliasedChunk(e)?e:`../${(0,path_1.basename)(this.options.output)}/`+t,t=`plugin:${this.options.pluginName}/`+t;this.importMap[e]=t};addToLocal(e){var t=this.getFileName(e),n=(0,path_1.join)(this.options.output,t);(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(n)),(0,fs_extra_1.copyFileSync)((0,path_1.join)(this.engineCachePaths.all,t),n),this.isAliasedChunk(e)&&(this.importMap[e]=`../${(0,path_1.basename)(this.options.output)}/`+t)}async run(){const{options:e,engineFeatureQuery:t,engineCachePaths:n}=this;var i=e.includeModules,i=t.getUnitsOfFeatures(i),a=i.filter(e=>!t.pluginUnit.includes(e)),s=(0,fs_extra_1.readJSONSync)(n.meta),r=i.filter(e=>t.pluginUnit.includes(e)),u=(0,path_1.join)(e.output,"cc.js"),i=await ccbuild_1.buildEngine.transform(t.engineStatsQuery.evaluateIndexModuleSource(i,e=>this.engineFeatureQuery.pluginUnit.includes(e)?`plugin:${this.options.pluginName}/${e}.js`:`./${e}.js`),"system"),u=(await(0,fs_extra_1.outputFile)(u,i.code,"utf8"),ccbuild_1.buildEngine.enumerateDependentChunks(s,a));const l=ccbuild_1.buildEngine.enumerateDependentChunks(s,t.pluginUnit);i=ccbuild_1.buildEngine.enumerateDependentAssets(s,a).concat(ccbuild_1.buildEngine.enumerateDependentAssets(s,r));u.forEach(e=>{l.includes(e)?this.addChunkToPlugin(e):this.addToLocal(e)}),i.forEach(e=>{this.addToLocal(e)}),this.importMap.cc=`./${relativeUrl((0,path_1.dirname)(e.importMapOutFile),e.output)}/cc.js`,e.outputLocalPlugin&&(a=ccbuild_1.buildEngine.enumerateDependentChunks(s,r),await this.generateLocalPlugin(a))}async generateLocalPlugin(e){var t=(0,path_1.join)((0,path_1.dirname)(this.options.output),this.options.pluginName);return EngineFeatureUnitGenerator.generatePlugins(this.engineCachePaths,e,t,this.options.signatureProvider)}static async generatePlugins(a,e,s,t){if(!e.length)return[];const r=(0,fs_extra_1.readJSONSync)(a.meta);(0,fs_extra_1.ensureDirSync)(s);let u=!1;const l=[];return await Promise.all(e.map(async(e,t)=>{var n=(0,path_1.join)(a.all,e),i=(0,path_1.join)(s,e);r.md5Map[e]||(console.debug("patch md5 for "+e),r.md5Map[e]=await calcCodeMd5(n),u=!0),l.push({md5:r.md5Map[e],path:e}),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(i)),(0,fs_extra_1.copyFileSync)(n,i)})),t&&await(0,fs_extra_1.outputJSON)((0,path_1.join)(s,(0,path_1.basename)(a.signatureJSON)),{provider:t,signature:l}),await(0,fs_extra_1.outputJSON)((0,path_1.join)(s,(0,path_1.basename)(a.pluginJSON)),{main:"base.js"}),u&&await(0,fs_extra_1.writeJSONSync)(a.meta,r,{spaces:2}),l}}async function buildSeparateEngine(e){e=await EngineFeatureUnitGenerator.create(e);return await e.run(),{importMap:e.importMap,paths:e.engineCachePaths}}async function buildCocos(e){var t=(0,path_1.join)(e.engine,"bin/.cache/editor-cache/"+e.platform);const n=new EngineCachePaths(t,e.pluginName);if(!e.useCacheForce||!(0,fs_extra_1.existsSync)(n.plugin)){e.engineFeatureQuery=e.engineFeatureQuery||await EngineFeatureQuery.create({platformType:e.platformType,engine:e.engine,pluginFeatures:e.pluginFeatures});var i=e["engineFeatureQuery"],a={engine:e.engine,out:n.all,moduleFormat:"system",compress:!0,split:!0,nativeCodeBundleMode:e.nativeCodeBundleMode,features:i.all,inlineEnum:!1,...i.env},s=(0,path_1.join)(t,"options.json");if((0,fs_extra_1.existsSync)(s)){var r=(0,fs_extra_1.readJSONSync)(s);if((0,utils_1.compareOptions)(r,a))return console.log("use cache engine in "+n.dir),n}else console.log("Can not find options cache in "+s);(0,fs_extra_1.emptyDirSync)(t);r=JSON.parse(JSON.stringify(a));const u=await(0,ccbuild_1.buildEngine)(a),l={};await Promise.all(Object.keys(u.exports).map(async e=>{var t=calcCodeMd5((0,path_1.join)(n.all,u.exports[e]));l[u.exports[e]]=t})),await(0,fs_extra_1.writeJSONSync)(n.meta,Object.assign(u,{md5Map:l}),{spaces:2}),i.plugin.length&&(t=i.getUnitsOfFeatures(i.plugin),a=ccbuild_1.buildEngine.enumerateDependentChunks(u,t),await generatePlugins(n,a,n.plugin,e.signatureProvider)),await(0,fs_extra_1.outputJSON)(s,r,{spaces:4})}return n}function relativeUrl(e,t){return(0,path_1.relative)(e,t).replace(/\\/g,"/")}async function generatePlugins(a,e,s,t){if(!e.length)return[];const r=(0,fs_extra_1.readJSONSync)(a.meta);(0,fs_extra_1.ensureDirSync)(s);let u=!1;const l=[];return await Promise.all(e.map(async(e,t)=>{var n=(0,path_1.join)(a.all,e),i=(0,path_1.join)(s,e);r.md5Map[e]||(console.debug("patch md5 for "+e),r.md5Map[e]=await calcCodeMd5(n),u=!0),l.push({md5:r.md5Map[e],path:e}),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(i)),(0,fs_extra_1.copyFileSync)(n,i)})),t&&await(0,fs_extra_1.outputJSON)(a.signatureJSON,{provider:t,signature:l}),await(0,fs_extra_1.outputJSON)(a.pluginJSON,{main:"base.js"}),u&&await(0,fs_extra_1.writeJSONSync)(a.meta,r,{spaces:2}),l}function calcCodeMd5(e){return(0,crypto_1.createHash)("md5").update((0,fs_extra_1.readFileSync)(e)).digest("hex")}