"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildScriptCommand=void 0;const fs_extra_1=__importDefault(require("fs-extra")),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),creator_programming_rollup_plugin_mod_lo_1=__importDefault(require("@cocos/creator-programming-rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),path_1=__importStar(require("path")),pack_mods_1=require("../../utils/pack-mods"),creator_programming_common_1=require("@cocos/creator-programming-common"),minimatch_1=__importDefault(require("minimatch"));function relativeUrl(e,t){return(0,path_1.relative)(e,t).replace(/\\/g,"/")}let bundleIdToNameChunk;function matchPattern(e,t){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),t.replace(/\\/g,"/"))}const useEditorFolderFeature=!1;function getExternalEditorModules(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}async function genImportRestrictions(e,t){if(!useEditorFolderFeature)return;const r=[];r.length=0;const o=[...t];for(const t of e){const e=t.target;if(e){const t=path_1.default.join(e,"**","editor","**/*");o.push(t)}}for(let t=0;t<e.length;++t){const n=e[t].target;if(n){const e=path_1.default.join(n,"**/*"),s=path_1.default.join(n,"**","editor","**/*");r[t]={importerPatterns:[e,"!"+s],banSourcePatterns:o}}}return r}async function buildScriptCommand(e){var t,r,o,n,s,a,i;const u={scriptPackages:[],importMappings:{}};if(0===e.bundles.length)return u;const l=e.sourceMaps&&e.ccEnvConstants.NATIVE?"inline":e.sourceMaps,c=Object.entries(e.ccEnvConstants).map(([e,t])=>`export const ${e} = ${t};`).join("\n"),{bundles:p,modulePreservation:d}=e,m=e.bundleCommonChunk=null!==(t=e.bundleCommonChunk)&&void 0!==t&&t,f={},_={},h={},g=new Set,v=new Set,b="preserve"===e.modulePreservation,M=e=>{var t;let{facadeModuleId:r}=e;if(!r)return-1;let o="",n=r;n.startsWith("file:///")||(n=(0,url_1.pathToFileURL)(r).href);const s=new url_1.URL(n);if((0,creator_programming_common_1.isCjsInteropUrl)(s)){const e=(0,creator_programming_common_1.getCjsInteropTarget)(s);r=(0,url_1.fileURLToPath)(e.href)}if(r.startsWith("file:///"))try{o=(0,url_1.fileURLToPath)(r)}catch(e){return-1}else o=r;return null!==(t=h[o])&&void 0!==t?t:-1},j=e=>{const{facadeModuleId:t}=e;return t?g.has(t)?t:v.has(t)?t:"":""},C=[],k=e.dbInfos.map(e=>path_1.default.join(e.target,"**/editor/**/*"));for(let e=0;e<p.length;++e){const t=p[e],r=[];for(const o of t.scripts){const t=(0,url_1.pathToFileURL)(o.file).href;_[t]=o.uuid,"facade"!==d&&"preserve"!==d||useEditorFolderFeature&&k.some(e=>matchPattern((0,url_1.fileURLToPath)(t),e))||r.push(t),h[o.file]=e,b&&v.add(t)}const o=`virtual:///prerequisite-imports/${t.id}`;let n=t.scripts.map(e=>e.file);useEditorFolderFeature&&(n=n.filter(e=>!k.some(t=>matchPattern(e,t)))),f[o]=n.sort().map(e=>`import "${(0,url_1.pathToFileURL)(e).href}";`).join("\n"),h[o]=e,r.push(o),C.push(r),g.add(o)}if(!m){const e=[];C.forEach(t=>{e.push(...t)}),C.length=0,C.push(e)}const w=getExternalEditorModules(e.cceModuleMap),y=await genImportRestrictions(e.dbInfos,w),U=new mod_lo_1.ModLo({targets:e.transform.targets,loose:e.loose,exportsConditions:e.exportsConditions,guessCommonJsExports:e.guessCommonJsExports,useDefineForClassFields:e.useDefineForClassFields,allowDeclareFields:e.allowDeclareFields,_internalTransform:{excludes:null!==(o=null===(r=e.transform)||void 0===r?void 0:r.excludes)&&void 0!==o?o:[],includes:null!==(s=null===(n=e.transform)||void 0===n?void 0:n.includes)&&void 0!==s?s:[]},_compressUUID:t=>e.uuidCompressMap[t],_helperModule:creator_programming_rollup_plugin_mod_lo_1.default.helperModule,hot:e.hotModuleReload,importRestrictions:y,preserveSymlinks:e.preserveSymlinks}),I=e.importMap,P={},D=I?new url_1.URL(I.url):new url_1.URL("foo:/bar");P.imports={"cc/env":"virtual:/cc/env","cc/userland/macro":"virtual:/cc/userland/macro"};const F=[];for(const t of e.dbInfos){const e=`db://${t.dbID}/`,r=(0,url_1.pathToFileURL)(path_1.default.join(t.target,path_1.default.join(path_1.default.sep))).href;P.imports[e]=r,F.push(r)}if(I&&(I.json.imports&&(P.imports=Object.assign(Object.assign({},P.imports),I.json.imports)),I.json.scopes))for(const[e,t]of Object.entries(I.json.scopes)){const r=null!==(a=P.scopes)&&void 0!==a?a:P.scopes={};r[e]=Object.assign(Object.assign({},null!==(i=r[e])&&void 0!==i?i:{}),t)}U.setImportMap(P,D),U.setAssetPrefixes(F),U.addMemoryModule("virtual:/cc/env",c),U.addMemoryModule("virtual:/cc/userland/macro",e.customMacroList.map(e=>`export const ${e.key} = ${e.value};`).join("\n"));for(const[e,t]of Object.entries(f))U.addMemoryModule(e,t);for(const[e,t]of Object.entries(_))U.setUUID(e,t);const x=[(0,creator_programming_rollup_plugin_mod_lo_1.default)({modLo:U})];"facade"!==d&&"erase"!==d||x.push(rpNamedChunk()),e.sourceMaps&&x.push((0,rollup_plugin_sourcemaps_1.default)()),e.debug||x.push((0,rollup_plugin_terser_1.terser)()),"erase"===d&&x.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:t}){switch(e){default:return;case"url":try{return`'${new url_1.URL(t).href}'`}catch(e){return void console.error(`Can not access import.meta.url of module '${t}'. '${t}' is not a valid URL.`)}}}});const E="preserve"!==e.modulePreservation,O=(e,t)=>{var r;if(E&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code)return;if("string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&(null===(r=e.importer)||void 0===r?void 0:r.includes("node_modules")))return;const o="object"==typeof e&&e.message||e;console.warn(`[[Build.Script.Rollup]] ${o}`)},R={};for(let t=0;t<C.length;++t){const r=C[t];m&&(bundleIdToNameChunk=p[t].id);const o={input:r,plugins:x,preserveModules:"erase"!==d,external:["cc"],onwarn:O},n=await rollup.rollup(o),s={sourcemap:e.sourceMaps,exports:"named"};"preserve"===e.modulePreservation?s.format=e.moduleFormat:Object.assign(s,{format:"system",strict:!1,systemNullSetters:!0});const a=await n.generate(s);if("preserve"===e.modulePreservation){const t=e.commonDir;for(const e of a.output)if("chunk"===e.type){const r=e.fileName.match(/\.(js|ts|mjs)$/)?e.fileName:`${e.fileName}.js`,o=path_1.default.join(t,r);await fs_extra_1.default.outputFile(o,e.code,"utf8");const n=j(e);if(n){const e=`./chunks/${r}`.replace(/\\/g,"/");R[n]=e}}}else if(m){const e=p[t],r=new ChunkBundler(e.outFile);for(const e of a.output){if("chunk"!==e.type)continue;r.add(e);const t=j(e);t&&r.addModuleMapping(t,getChunkUrl(e))}await r.write({sourceMaps:l,wrap:!1})}else{const t=path_1.default.join(e.commonDir,"bundle.js"),o=new ChunkBundler(t);let n=0;const s=p.map(e=>new ChunkBundler(e.outFile));for(const e of a.output){if("chunk"!==e.type)continue;const t=!!e.facadeModuleId&&r.includes(e.facadeModuleId);if(e.isEntry||t){const t=M(e);if(t<0||void 0===s[t])console.warn(`Unexpected: entry chunk name ${e.name} is not in list.`),o.add(e),++n;else{s[t].add(e);const r=j(e);r&&s[t].addModuleMapping(r,getChunkUrl(e))}}else o.add(e),++n}if(await Promise.all(s.map(async(e,t)=>{await e.write({sourceMaps:l,wrap:!1})})),n){await o.write({sourceMaps:l,wrap:!0});const e=t;u.scriptPackages.push(e)}}}return bundleIdToNameChunk=null,u.importMappings=R,u}exports.buildScriptCommand=buildScriptCommand;class ChunkBundler{constructor(e){this._parts=[],this._chunkMappings={},this._out=e}add(e){var t;this._parts.push([e.fileName,{code:e.code,map:null===(t=e.map)||void 0===t?void 0:t.toString()}])}addModuleMapping(e,t){this._chunkMappings[e]=t}async write(e){return await(0,pack_mods_1.packMods)(this._parts.sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>t),this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,t,r){const o=getChunkUrl(t),n=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:o}]]});return n?{code:n.code,map:n.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return bundleIdToNameChunk?`bundle://${bundleIdToNameChunk}/${e.fileName}`:`chunks:///${e.fileName}`}