"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&("get"in a?r.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,a)}:function(e,r,t,o){e[o=void 0===o?t:o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildPolyfillsCommand=exports.buildSystemJsCommand=exports.buildScriptCommand=void 0;const fs_extra_1=__importStar(require("fs-extra")),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),creator_programming_rollup_plugin_mod_lo_1=__importDefault(require("@cocos/creator-programming-rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),path_1=__importStar(require("path")),pack_mods_1=require("../../utils/pack-mods"),creator_programming_common_1=require("@cocos/creator-programming-common"),minimatch_1=__importDefault(require("minimatch")),module_system_1=require("@cocos/module-system"),build_polyfills_1=__importDefault(require("@editor/build-polyfills"));function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}let bundleIdToNameChunk;function matchPattern(e,r){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),r.replace(/\\/g,"/"))}const useEditorFolderFeature=!1;function getExternalEditorModules(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}async function genImportRestrictions(r,e){if(useEditorFolderFeature){var t=[],o=(t.length=0,[...e]);for(const n of r){var a=n.target;a&&(a=path_1.default.join(a,"**","editor","**/*"),o.push(a))}for(let e=0;e<r.length;++e){var s,l=r[e].target;l&&(s=path_1.default.join(l,"**/*"),l=path_1.default.join(l,"**","editor","**/*"),t[e]={importerPatterns:[s,"!"+l],banSourcePatterns:o})}return t}}async function buildScriptCommand(r){var t={scriptPackages:[],importMappings:{}};if(0!==r.bundles.length){const j=r.sourceMaps;var L=Object.entries(r.ccEnvConstants).map(([e,r])=>`export const ${e} = ${r};`).join("\n"),{bundles:o,modulePreservation:a}=r,s=r.bundleCommonChunk=null!=(e=r.bundleCommonChunk)&&e,N={},q={};const w={},P=new Set,x=new Set;var T="preserve"===r.modulePreservation,l=e=>{e=e.facadeModuleId;return e&&(P.has(e)||x.has(e))?e:""},n=[];const F=r.dbInfos.map(e=>path_1.default.join(e.target,"**/editor/**/*"));for(let r=0;r<o.length;++r){var u=o[r],i=[];for(const U of u.scripts){const D=(0,url_1.pathToFileURL)(U.file).href;q[D]=U.uuid,"facade"!==a&&"preserve"!==a||useEditorFolderFeature&&F.some(e=>matchPattern((0,url_1.fileURLToPath)(D),e))||i.push(D),w[U.file]=r,T&&x.add(D)}var d="virtual:///prerequisite-imports/"+u.id;let e=u.scripts.map(e=>e.file);useEditorFolderFeature&&(e=e.filter(r=>!F.some(e=>matchPattern(r,e)))),N[d]=e.sort().map(e=>`import "${(0,url_1.pathToFileURL)(e).href}";`).join("\n"),w[d]=r,i.push(d),n.push(i),P.add(d)}if(!s){const I=[];n.forEach(e=>{I.push(...e)}),n.length=0,n.push(I)}var $,B,J,A,e=getExternalEditorModules(r.cceModuleMap),e=await genImportRestrictions(r.dbInfos,e),p=new mod_lo_1.ModLo({targets:r.transform.targets,loose:r.loose,exportsConditions:r.exportsConditions,guessCommonJsExports:r.guessCommonJsExports,useDefineForClassFields:r.useDefineForClassFields,allowDeclareFields:r.allowDeclareFields,_internalTransform:{excludes:null!=(c=null==(c=r.transform)?void 0:c.excludes)?c:[],includes:null!=(c=null==(c=r.transform)?void 0:c.includes)?c:[]},_compressUUID:e=>r.uuidCompressMap[e],_helperModule:creator_programming_rollup_plugin_mod_lo_1.default.helperModule,hot:r.hotModuleReload,importRestrictions:e,preserveSymlinks:r.preserveSymlinks}),c=r.importMap,m={},e=c?new url_1.URL(c.url):new url_1.URL("foo:/bar"),W=(m.imports={"cc/env":"virtual:/cc/env","cc/userland/macro":"virtual:/cc/userland/macro"},[]);for(const S of r.dbInfos){var Y=`db://${S.dbID}/`,z=(0,url_1.pathToFileURL)(path_1.default.join(S.target,path_1.default.join(path_1.default.sep))).href;m.imports[Y]=z,W.push(z)}if(c&&(c.json.imports&&(m.imports=Object.assign(Object.assign({},m.imports),c.json.imports)),c.json.scopes))for(var[G,H]of Object.entries(c.json.scopes)){var _=null!=(_=m.scopes)?_:m.scopes={};_[G]=Object.assign(Object.assign({},null!=(_=_[G])?_:{}),H)}p.setImportMap(m,e),p.setAssetPrefixes(W),p.addMemoryModule("virtual:/cc/env",L),p.addMemoryModule("virtual:/cc/userland/macro",r.customMacroList.map(e=>`export const ${e.key} = ${e.value};`).join("\n"));for([$,B]of Object.entries(N))p.addMemoryModule($,B);for([J,A]of Object.entries(q))p.setUUID(J,A);var f=[(0,creator_programming_rollup_plugin_mod_lo_1.default)({modLo:p})];"facade"!==a&&"erase"!==a||f.push(rpNamedChunk()),r.sourceMaps&&f.push((0,rollup_plugin_sourcemaps_1.default)()),r.debug||f.push((0,rollup_plugin_terser_1.terser)()),"erase"===a&&f.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:r}){if("url"===e)try{return`'${new url_1.URL(r).href}'`}catch(e){console.error(`Can not access import.meta.url of module '${r}'. '${r}' is not a valid URL.`)}}});const re="preserve"!==r.modulePreservation;var K=(e,r)=>{var t;re&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code||"string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&null!=(t=e.importer)&&t.includes("node_modules")||(t="object"==typeof e&&e.message||e,console.warn("[[Build.Script.Rollup]] "+t))},Q={};for(let e=0;e<n.length;++e){var V=n[e],h=(s&&(bundleIdToNameChunk=o[e].id),{input:V,plugins:f,preserveModules:"erase"!==a,external:["cc"],onwarn:K}),h=await rollup.rollup(h),g={sourcemap:r.sourceMaps,exports:"named"},h=("preserve"===r.modulePreservation?g.format=r.moduleFormat:Object.assign(g,{format:"system",strict:!1,systemNullSetters:!0}),await h.generate(g));if("preserve"===r.modulePreservation){var b,v,X=r.commonDir;for(const R of h.output)"chunk"===R.type&&(v=R.fileName.match(/\.(js|ts|mjs)$/)?R.fileName:R.fileName+".js",b=path_1.default.join(X,v),await fs_extra_1.default.outputFile(b,R.code,"utf8"),b=l(R))&&(v=("./chunks/"+v).replace(/\\/g,"/"),Q[b]=v)}else if(s){var Z,g=o[e],M=new ChunkBundler(g.outFile);for(const E of h.output)"chunk"===E.type&&(M.add(E),Z=l(E))&&M.addModuleMapping(Z,getChunkUrl(E));await M.write({sourceMaps:j,wrap:!1})}else{var g=path_1.default.join(r.commonDir,"bundle.js"),y=new ChunkBundler(g);let e=0;var C,ee,k=o.map(e=>new ChunkBundler(e.outFile));for(const O of h.output)"chunk"===O.type&&(C=!!O.facadeModuleId&&V.includes(O.facadeModuleId),O.isEntry||C?(C=(e=>{let r=e["facadeModuleId"];if(!r)return-1;let t="",o=r;o.startsWith("file:///")||(o=(0,url_1.pathToFileURL)(r).href);var e=new url_1.URL(o);if((0,creator_programming_common_1.isCjsInteropUrl)(e)&&(e=(0,creator_programming_common_1.getCjsInteropTarget)(e),r=(0,url_1.fileURLToPath)(e.href)),r.startsWith("file:///"))try{t=(0,url_1.fileURLToPath)(r)}catch(e){return-1}else t=r;return null!=(e=w[t])?e:-1})(O))<0||void 0===k[C]?(console.warn(`Unexpected: entry chunk name ${O.name} is not in list.`),y.add(O),++e):(k[C].add(O),(ee=l(O))&&k[C].addModuleMapping(ee,getChunkUrl(O))):(y.add(O),++e));await Promise.all(k.map(async(e,r)=>{await e.write({sourceMaps:j,wrap:!1})})),e&&(await y.write({sourceMaps:j,wrap:!0}),t.scriptPackages.push(g))}}bundleIdToNameChunk=null,t.importMappings=Q}return t}async function buildSystemJsCommand(e){return(0,module_system_1.build)({out:e.dest,sourceMap:e.sourceMaps,minify:!e.debug,platform:e.platform,hmr:e.hotModuleReload})}async function buildPolyfillsCommand(e={},r){r={debug:!1,sourceMap:!1,file:r},e.asyncFunctions&&(r.asyncFunctions=!0),e.coreJs?r.coreJs={modules:["es"],blacklist:[],targets:e.targets}:r.coreJs={modules:["es.global-this"],blacklist:[],targets:e.targets},e=await(0,build_polyfills_1.default)(r);return!(!e||!await(0,fs_extra_1.pathExists)(r.file))}exports.buildScriptCommand=buildScriptCommand,exports.buildSystemJsCommand=buildSystemJsCommand,exports.buildPolyfillsCommand=buildPolyfillsCommand;class ChunkBundler{constructor(e){this._parts=[],this._chunkMappings={},this._out=e}add(e){this._parts.push([e.fileName,{code:e.code,map:null==(e=e.map)?void 0:e.toString()}])}addModuleMapping(e,r){this._chunkMappings[e]=r}async write(e){return(0,pack_mods_1.packMods)(this._parts.sort(([e],[r])=>e.localeCompare(r)).map(([,e])=>e),this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,r,t){r=getChunkUrl(r),e=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:r}]]});return e?{code:e.code,map:e.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return bundleIdToNameChunk?`bundle://${bundleIdToNameChunk}/`+e.fileName:"chunks:///"+e.fileName}