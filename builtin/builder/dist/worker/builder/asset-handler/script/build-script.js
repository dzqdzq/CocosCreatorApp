"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&("get"in a?r.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,a)}:function(e,r,t,o){e[o=void 0===o?t:o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var r,t=[];for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t})(e)};return function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t=a(e),o=0;o<t.length;o++)"default"!==t[o]&&__createBinding(r,e,t[o]);return __setModuleDefault(r,e),r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildScriptCommand=buildScriptCommand,exports.buildSystemJsCommand=buildSystemJsCommand,exports.buildPolyfillsCommand=buildPolyfillsCommand;const fs_extra_1=__importStar(require("fs-extra")),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),creator_programming_rollup_plugin_mod_lo_1=__importDefault(require("@cocos/creator-programming-rollup-plugin-mod-lo")),to_named_register_1=__importDefault(require("../../utils/to-named-register")),url_1=require("url"),babel=__importStar(require("@babel/core")),rollup=__importStar(require("rollup")),rollup_plugin_sourcemaps_1=__importDefault(require("rollup-plugin-sourcemaps")),rollup_plugin_terser_1=require("rollup-plugin-terser"),path_1=__importStar(require("path")),pack_mods_1=require("../../utils/pack-mods"),creator_programming_common_1=require("@cocos/creator-programming-common"),minimatch_1=__importDefault(require("minimatch")),module_system_1=require("@cocos/module-system"),build_polyfills_1=__importDefault(require("@editor/build-polyfills"));function relativeUrl(e,r){return(0,path_1.relative)(e,r).replace(/\\/g,"/")}let bundleIdToNameChunk;function matchPattern(e,r){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),r.replace(/\\/g,"/"))}const useEditorFolderFeature=!1;function getExternalEditorModules(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}async function genImportRestrictions(r,e){if(useEditorFolderFeature){var t=[],o=(t.length=0,[...e]);for(const l of r){var a=l.target;a&&(a=path_1.default.join(a,"**","editor","**/*"),o.push(a))}for(let e=0;e<r.length;++e){var n,s=r[e].target;s&&(n=path_1.default.join(s,"**/*"),s=path_1.default.join(s,"**","editor","**/*"),t[e]={importerPatterns:[n,"!"+s],banSourcePatterns:o})}return t}}async function buildScriptCommand(r){var t={scriptPackages:[],importMappings:{}};if(0!==r.bundles.length){const w=r.sourceMaps;var L=Object.entries(r.ccEnvConstants).map(([e,r])=>`export const ${e} = ${r};`).join("\n"),{bundles:o,modulePreservation:a}=r,n=r.bundleCommonChunk=r.bundleCommonChunk??!1,s={},l={};const j={},P=new Set,F=new Set;var O="preserve"===r.modulePreservation,u=e=>{e=e.facadeModuleId;return e&&(P.has(e)||F.has(e))?e:""},i=[];const U=r.dbInfos.map(e=>path_1.default.join(e.target,"**/editor/**/*"));for(let r=0;r<o.length;++r){var c=o[r],p=[];for(const x of c.scripts){const D=(0,url_1.pathToFileURL)(x.file).href;l[D]=x.uuid,"facade"!==a&&"preserve"!==a||useEditorFolderFeature&&U.some(e=>matchPattern((0,url_1.fileURLToPath)(D),e))||p.push(D),j[x.file]=r,O&&F.add(D)}var d="virtual:///prerequisite-imports/"+c.id;let e=c.scripts.map(e=>e.file);useEditorFolderFeature&&(e=e.filter(r=>!U.some(e=>matchPattern(r,e)))),s[d]=e.sort().map(e=>`import "${(0,url_1.pathToFileURL)(e).href}";`).join("\n"),j[d]=r,p.push(d),i.push(p),P.add(d)}if(!n){const I=[];i.forEach(e=>{I.push(...e)}),i.length=0,i.push(I)}var q,T,$,B,e=getExternalEditorModules(r.cceModuleMap),e=await genImportRestrictions(r.dbInfos,e),m=new mod_lo_1.ModLo({targets:r.transform.targets,loose:r.loose,exportsConditions:r.exportsConditions,guessCommonJsExports:r.guessCommonJsExports,useDefineForClassFields:r.useDefineForClassFields,allowDeclareFields:r.allowDeclareFields,_internalTransform:{excludes:r.transform?.excludes??[],includes:r.transform?.includes??[]},_compressUUID:e=>r.uuidCompressMap[e],_helperModule:creator_programming_rollup_plugin_mod_lo_1.default.helperModule,hot:r.hotModuleReload,importRestrictions:e,preserveSymlinks:r.preserveSymlinks}),e=r.importMap,_={},J=e?new url_1.URL(e.url):new url_1.URL("foo:/bar"),A=(_.imports={"cc/env":"virtual:/cc/env","cc/userland/macro":"virtual:/cc/userland/macro"},[]);for(const R of r.dbInfos){var W=`db://${R.dbID}/`,Y=(0,url_1.pathToFileURL)(path_1.default.join(R.target,path_1.default.join(path_1.default.sep))).href;_.imports[W]=Y,A.push(Y)}if(e&&(e.json.imports&&(_.imports={..._.imports,...e.json.imports}),e.json.scopes))for(var[z,G]of Object.entries(e.json.scopes)){var H=_.scopes??={};H[z]={...H[z]??{},...G}}m.setImportMap(_,J),m.setAssetPrefixes(A),m.addMemoryModule("virtual:/cc/env",L),m.addMemoryModule("virtual:/cc/userland/macro",r.customMacroList.map(e=>`export const ${e.key} = ${e.value};`).join("\n"));for([q,T]of Object.entries(s))m.addMemoryModule(q,T);for([$,B]of Object.entries(l))m.setUUID($,B);var f=[(0,creator_programming_rollup_plugin_mod_lo_1.default)({modLo:m})];"facade"!==a&&"erase"!==a||f.push(rpNamedChunk()),r.sourceMaps&&f.push((0,rollup_plugin_sourcemaps_1.default)()),r.debug||f.push((0,rollup_plugin_terser_1.terser)()),"erase"===a&&f.push({name:"cocos-creator/resolve-import-meta",resolveImportMeta(e,{moduleId:r}){if("url"===e)try{return`'${new url_1.URL(r).href}'`}catch{console.error(`Can not access import.meta.url of module '${r}'. '${r}' is not a valid URL.`)}}});const re="preserve"!==r.modulePreservation;var K=(e,r)=>{re&&"object"==typeof e&&"EMPTY_BUNDLE"===e.code||"string"!=typeof e&&"CIRCULAR_DEPENDENCY"===e.code&&e.importer?.includes("node_modules")||(e="object"==typeof e&&e.message||e,console.warn("[[Build.Script.Rollup]] "+e))},Q={};for(let e=0;e<i.length;++e){var V=i[e],h=(n&&(bundleIdToNameChunk=o[e].id),{input:V,plugins:f,preserveModules:"erase"!==a,external:["cc"],onwarn:K}),h=await rollup.rollup(h),g={sourcemap:r.sourceMaps,exports:"named"},h=("preserve"===r.modulePreservation?g.format=r.moduleFormat:Object.assign(g,{format:"system",strict:!1,systemNullSetters:!0}),await h.generate(g));if("preserve"===r.modulePreservation){var b,v,X=r.commonDir;for(const S of h.output)"chunk"===S.type&&(v=S.fileName.match(/\.(js|ts|mjs)$/)?S.fileName:S.fileName+".js",b=path_1.default.join(X,v),await fs_extra_1.default.outputFile(b,S.code,"utf8"),b=u(S))&&(v=("./chunks/"+v).replace(/\\/g,"/"),Q[b]=v)}else if(n){var Z,g=o[e],M=new ChunkBundler(g.outFile);for(const E of h.output)"chunk"===E.type&&(M.add(E),Z=u(E))&&M.addModuleMapping(Z,getChunkUrl(E));await M.write({sourceMaps:w,wrap:!1})}else{var g=path_1.default.join(r.commonDir,"bundle.js"),y=new ChunkBundler(g);let e=0;var C,ee,k=o.map(e=>new ChunkBundler(e.outFile));for(const N of h.output)"chunk"===N.type&&(C=!!N.facadeModuleId&&V.includes(N.facadeModuleId),N.isEntry||C?(C=(e=>{let r=e["facadeModuleId"];if(!r)return-1;let t="",o=r;o.startsWith("file:///")||(o=(0,url_1.pathToFileURL)(r).href);var e=new url_1.URL(o);if((0,creator_programming_common_1.isCjsInteropUrl)(e)&&(e=(0,creator_programming_common_1.getCjsInteropTarget)(e),r=(0,url_1.fileURLToPath)(e.href)),r.startsWith("file:///"))try{t=(0,url_1.fileURLToPath)(r)}catch{return-1}else t=r;return j[t]??-1})(N))<0||void 0===k[C]?(console.warn(`Unexpected: entry chunk name ${N.name} is not in list.`),y.add(N),++e):(k[C].add(N),(ee=u(N))&&k[C].addModuleMapping(ee,getChunkUrl(N))):(y.add(N),++e));console.debug("Number of non-entry chunks: "+k.length),await Promise.all(k.map(async(e,r)=>{await e.write({sourceMaps:w,wrap:!1})})),e&&(await y.write({sourceMaps:w,wrap:!0}),t.scriptPackages.push(g))}}bundleIdToNameChunk=null,t.importMappings=Q}return t}async function buildSystemJsCommand(e){return(0,module_system_1.build)({out:e.dest,sourceMap:e.sourceMaps,minify:!e.debug,platform:e.platform,hmr:e.hotModuleReload})}async function buildPolyfillsCommand(e={},r){r={debug:!1,sourceMap:!1,file:r},e.asyncFunctions&&(r.asyncFunctions=!0),e.coreJs?r.coreJs={modules:["es"],blacklist:[],targets:e.targets}:r.coreJs={modules:["es.global-this"],blacklist:[],targets:e.targets},e=await(0,build_polyfills_1.default)(r);return!(!e||!await(0,fs_extra_1.pathExists)(r.file))}class ChunkBundler{_out;_parts=[];_chunkMappings={};constructor(e){this._out=e}add(e){this._parts.push([e.fileName,{code:e.code,map:e.map?.toString()}])}addModuleMapping(e,r){this._chunkMappings[e]=r}async write(e){return(0,pack_mods_1.packMods)(this._parts.sort(([e],[r])=>e.localeCompare(r)).map(([,e])=>e),this._chunkMappings,this._out,e)}}function rpNamedChunk(){return{name:"named-chunk",renderChunk:async function(e,r,t){r=getChunkUrl(r),e=await babel.transformAsync(e,{sourceMaps:!0,compact:!1,plugins:[[to_named_register_1.default,{name:r}]]});return e?{code:e.code,map:e.map}:(this.warn("Failed to render chunk."),null)}}}function getChunkUrl(e){return bundleIdToNameChunk?`bundle://${bundleIdToNameChunk}/`+e.fileName:"chunks:///"+e.fileName}