"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(e,r);i&&("get"in i?e.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,i)}:function(t,e,r,s){void 0===s&&(s=r),t[s]=e[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&__createBinding(e,t,r);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScriptBuilder=void 0;const path_1=require("path"),build_time_constants_1=require("./build-time-constants"),build_polyfills_1=__importDefault(require("@editor/build-polyfills")),fs_extra_1=require("fs-extra"),module_system_1=require("@cocos/module-system"),sub_process_manager_1=require("../../../worker-pools/sub-process-manager"),asset_library_1=require("../../manager/asset-library"),babel=__importStar(require("@babel/core")),preset_env_1=__importDefault(require("@babel/preset-env"));class ScriptBuilder{constructor(){this.scriptPackages=[]}initTaskOptions(t){var e,r,s,i;const a={};(null===(e=t.buildScriptParam.polyfills)||void 0===e?void 0:e.asyncFunctions)||(null!==(r=a.excludes)&&void 0!==r?r:a.excludes=[]).push("transform-regenerator"),t.buildScriptParam.targets&&(a.targets=t.buildScriptParam.targets);let o="facade";t.buildScriptParam.experimentalEraseModules&&(o="erase");const n=null!==(s=t.buildScriptParam.hotModuleReload)&&void 0!==s&&s;return n&&(o="preserve"),{scriptOptions:{modulePreservation:o,debug:t.debug,sourceMaps:t.sourceMaps,hotModuleReload:n,transform:a,moduleFormat:"system",commonDir:t.buildScriptParam.commonDir||"",bundleCommonChunk:null!==(i=t.buildScriptParam.bundleCommonChunk)&&void 0!==i&&i},importMapOptions:{format:t.buildScriptParam.importMapFormat,data:{imports:{}},output:""}}}async initProjectOptions(t){const{scriptOptions:e,importMapOptions:r}=this.initTaskOptions(t);this._scriptOptions=e,this._importMapOptions=r;const s=await(0,build_time_constants_1.getCCEnvConstants)({platform:t.buildScriptParam.platform,flags:t.buildScriptParam.flags}),i=await Editor.Message.request("programming","query-shared-settings"),a=await Editor.Message.request("asset-db","query-db-list"),o=await Promise.all(a.map(async t=>{return{dbID:t,target:(await Editor.Message.request("asset-db","query-db-info",t)).target}})),n=await Editor.Profile.getProject("engine","macroCustom");ScriptBuilder.projectOptions=Object.assign({customMacroList:n,dbInfos:o,ccEnvConstants:s},i)}async buildBundleScript(t){const e=[],r={};t.forEach(t=>{t.output&&(t.config.hasPreloadScript=!this._scriptOptions.hotModuleReload,e.push({id:t.name,scripts:t.scripts.map(t=>(r[t]=Build.Utils.compressUuid(t,!1),asset_library_1.buildAssetLibrary.getAssetInfo(t))).sort((t,e)=>t.name.localeCompare(e.name)),outFile:t.scriptDest}))});const s=Editor.Message.request("programming","packer-driver/query-cc-editor-module-map"),i=Object.assign(Object.assign(Object.assign({},this._scriptOptions),ScriptBuilder.projectOptions),{bundles:e,uuidCompressMap:r,applicationJS:"",cceModuleMap:s});await sub_process_manager_1.workerManager.registerTask({name:"build-script",path:(0,path_1.join)(__dirname,"./build-script")});const a=await sub_process_manager_1.workerManager.runTask("build-script","buildScriptCommand",[i]);return a&&(a.scriptPackages&&this.scriptPackages.push(...a.scriptPackages),a.importMappings&&Object.assign(this._importMapOptions.data.imports,a.importMappings)),sub_process_manager_1.workerManager.kill("build-script"),console.debug("Copy externalScripts success!"),a}static async buildPolyfills(t={},e){var r;const s=["es.global-this"],i={debug:!1,sourceMap:!1,file:e};t.asyncFunctions&&(i.asyncFunctions=!0);const a=null!==(r=t.targets)&&void 0!==r?r:"> 0.5%";return void 0!==t.coreJs?i.coreJs={modules:["es"],blacklist:[],targets:a}:i.coreJs={modules:s,blacklist:[],targets:a},!(!await(0,build_polyfills_1.default)(i)||!await(0,fs_extra_1.pathExists)(i.file))}static async buildSystemJs(t){await(0,module_system_1.build)({out:t.dest,sourceMap:t.sourceMaps,minify:!t.debug,platform:t.platform,hmr:t.hotModuleReload})}static async outputImportMap(t,e){const{content:r}=await transformImportMap(t,e);await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(e.dest)),await(0,fs_extra_1.writeFile)(e.dest,r,{encoding:"utf8"})}}async function transformImportMap(t,e){var r;const{importMapFormat:s}=e;let i,a=JSON.stringify(t,void 0,e.debug?2:0);if(void 0===s)i=".json";else{i=".js";const t=`export default ${a}`;a=null===(r=await babel.transformAsync(t,{presets:[[preset_env_1.default,{modules:"esm"!==s&&s}]]}))||void 0===r?void 0:r.code}return{extension:i,content:a}}exports.ScriptBuilder=ScriptBuilder;