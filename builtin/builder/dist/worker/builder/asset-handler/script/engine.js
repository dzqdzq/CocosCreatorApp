"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,n)}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryEngineImportMap=exports.buildEngineX=void 0;const crypto_1=require("crypto"),path_1=require("path"),fs_extra_1=require("fs-extra"),ccBuild=__importStar(require("@cocos/ccbuild")),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),sub_process_manager_1=require("../../../worker-pools/sub-process-manager"),globby_1=__importDefault(require("globby")),EngineCacheName="engine-cache",exportsMetaFile="meta.json";async function buildEngineX(e){const{output:t,metaFile:a}=await buildEngine(e);return await(0,fs_extra_1.emptyDir)(e.output),await(0,fs_extra_1.copy)(`${t}`,e.output,{recursive:!0}),{metaFile:a}}exports.buildEngineX=buildEngineX;const fixedMd5Keys=["debug","sourceMaps","includeModules","engineVersion","platform","split","ammoJsWasm","targets","entry","noDeprecatedFeatures","loose","assetURLFormat","flags","preserveType"];async function buildEngine(e){const t=(await Editor.Message.request("engine","query-engine-info")).typescript;e.entry=t.path;const[a,r]=await Promise.all([Editor.Profile.getProject("engine","modules.noDeprecatedFeatures"),Editor.Profile.getProject("project","script.loose")]),n=a.value?!a.version||a.version:void 0,i={noDeprecatedFeatures:n,loose:r},o=0===e.md5Map.length?fixedMd5Keys:e.md5Map.concat(fixedMd5Keys),s=calcMd5String(Object.assign(i,e),o),u=(0,crypto_1.createHash)("md5").update(s).digest("hex"),c=(0,path_1.join)(Editor.App.temp,"builder","engine",u),l=(0,path_1.join)((0,path_1.dirname)(c),`${u}.meta`),p=`${c}.watch-files.json`,d=(0,path_1.join)(l,exportsMetaFile);if(e.useCache&&await validateCache(c,p)&&await isValidMeta(d))return console.debug(`Use cache engine: {link(${c})}`),console.debug(e),{output:c,metaFile:d};const _=e.isNative&&e.sourceMaps?"inline":e.sourceMaps,f={incremental:p,engine:t.path,out:c,moduleFormat:"system",compress:!e.debug,split:e.split,ammoJsWasm:e.ammoJsWasm,assetURLFormat:e.assetURLFormat,noDeprecatedFeatures:n,sourceMap:_,targets:e.targets,loose:r,features:e.includeModules,platform:e.platform,flags:e.flags,mode:"BUILD",metaFile:d,preserveType:e.preserveType};return await sub_process_manager_1.workerManager.registerTask({name:"build-engine",path:(0,path_1.join)(__dirname,"./build-engine")}),await sub_process_manager_1.workerManager.runTask("build-engine","buildEngineCommand",[f]),await outputCacheJson(e,c),sub_process_manager_1.workerManager.kill("build-engine"),{output:c,metaFile:d}}async function validateCache(e,t){if(!await fs_extra_2.default.pathExists(e))return console.debug(`Engine cache ({link(${e})}) does not exist.`),!1;let a=!1;try{0!==(await(0,globby_1.default)((0,path_1.join)(e,"**/*.js"))).length&&(a=!0)}catch(e){}return a?!await ccBuild.buildEngine.isSourceChanged(t):(console.warn(`Engine cache directory({link(${e})}) exists but has empty content. It's abnormal.`),!1)}async function isValidMeta(e){if(!await(0,fs_extra_1.pathExists)(e))return!1;let t;try{t=await fs_extra_2.default.readJson(e)}catch(e){return!1}if("object"!=typeof t||null===t)return!1;return"object"==typeof t.exports}function calcMd5String(e,t){let a="";for(const r of t)a+=`${r}=${JSON.stringify(e[r])},`;return a}async function outputCacheJson(e,t){const a=(0,path_1.join)((0,path_1.dirname)(t),`${EngineCacheName}.json`);let r={};await(0,fs_extra_1.pathExists)(a)&&(r=await(0,fs_extra_1.readJson)(a)),(r=r||{})[(0,path_1.basename)(t)]=e,await(0,fs_extra_1.outputJSON)(a,r)}async function queryEngineImportMap(e,t,a,r){let n;try{n=await fs_extra_2.default.readJson(e)}catch(e){throw new Error(`Failed to read engine export meta, engine might not have been build correctly: ${e}`)}const i=r?new URL(r):void 0,o=e=>{let r;return r=i?new URL(e,i).href:`./${Build.Utils.relativeUrl(a,path_2.default.join(t,e))}`},s={};for(const[e,t]of Object.entries(n.exports))s[e]=o(t);for(const[e,t]of Object.entries(n.chunkAliases))s[e]=o(t);return s}exports.queryEngineImportMap=queryEngineImportMap;