"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,i)}:function(e,t,n,a){e[a=void 0===a?n:a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryEngineImportMap=exports.buildEngineX=void 0;const crypto_1=require("crypto"),path_1=require("path"),fs_extra_1=require("fs-extra"),ccBuild=__importStar(require("@cocos/ccbuild")),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),sub_process_manager_1=require("../../../worker-pools/sub-process-manager"),globby_1=__importDefault(require("globby")),mangle_config_parser_1=require("./mangle-config-parser"),default_mangle_config_1=require("./default-mangle-config"),EngineCacheName="engine-cache",exportsMetaFile="meta.json";async function buildEngineX(e){var{output:t,metaFile:n}=await buildEngine(e);return await(0,fs_extra_1.emptyDir)(e.output),await(0,fs_extra_1.copy)(""+t,e.output,{recursive:!0}),{metaFile:n}}exports.buildEngineX=buildEngineX;const fixedMd5Keys=["debug","sourceMaps","includeModules","engineVersion","platform","split","nativeCodeBundleMode","targets","entry","noDeprecatedFeatures","loose","assetURLFormat","flags","preserveType","wasmCompressionMode","enableNamedRegisterForSystemJSModuleFormat","mangleProperties","inlineEnum"],nativePlatforms=["ANDROID","WINDOWS","IOS","MAC","OHOS","OPEN_HARMONY","LINUX"];function isNativePlatform(e){return nativePlatforms.includes(e)}async function buildEngine(n){var a=(await Editor.Message.request("engine","query-engine-info")).typescript,i=(n.entry=a.path,null!=(i=null==(i=await Editor.Message.request("engine","query-engine-modules-profile"))?void 0:i.noDeprecatedFeatures)?i:{value:!1,version:""}),r=await Editor.Profile.getProject("project","script.loose"),i=i.value?i.version||!0:void 0,o={noDeprecatedFeatures:i,loose:r},s=(0,path_1.join)(Editor.Project.path,"engine-mangle-config.json"),l=(n.mangleProperties&&!await fs_extra_2.default.pathExists(s)?(console.debug("mangleProperties is enabled, but engine-mangle-config.json not found, create default mangle configuration"),default_mangle_config_1.defaultMangleConfig.__doc_url__=Editor.Utils.Url.getDocUrl("advanced-topics/mangle-properties.html"),await fs_extra_2.default.writeJson(s,default_mangle_config_1.defaultMangleConfig,{spaces:2})):console.debug("mangleProperties is enabled, found engine-mangle-config.json, use it"),0===n.md5Map.length?fixedMd5Keys:n.md5Map.concat(fixedMd5Keys));let u=calcMd5String(Object.assign(o,n),l);n.mangleProperties&&(u+=`projectPath=${Editor.Project.path},`,console.debug("Found mangle config, append projectPath to md5String: "+u.split(",").join(",\n")));var o=(0,crypto_1.createHash)("md5").update(u).digest("hex"),l=(0,path_1.join)(Editor.App.temp,"builder","engine",o),o=(0,path_1.join)((0,path_1.dirname)(l),o+".meta"),c=l+".watch-files.json",o=(0,path_1.join)(o,exportsMetaFile);if(n.useCache&&await validateCache(l,c)&&await isValidMeta(o))console.debug(`Use cache engine: {link(${l})}`),console.debug("Use cache, md5String: "+u.split(",").join(",\n")),console.debug("Use cache, options: "+JSON.stringify(n,null,2));else{let e=0,t=!1;n.mangleProperties?isNativePlatform(n.platform)?console.warn("Currently, mangling internal properties is not supported on native platforms, current platform: "+n.platform):void 0===(t=(0,mangle_config_parser_1.parseMangleConfig)(s,n.platform))?(console.debug("engine-mangle-config.json not found, but mangleProperties is enabled, so enable mangleProperties with default mangle configuration"),t=!0):(e=(await fs_extra_2.default.stat(s)).mtimeMs,console.debug("mangleProperties: "+JSON.stringify(t,null,2))):console.debug("mangleProperties is disabled, platform: "+n.platform);s={incremental:c,engine:a.path,out:l,moduleFormat:"system",compress:!n.debug,split:n.split,nativeCodeBundleMode:n.nativeCodeBundleMode,assetURLFormat:n.assetURLFormat,noDeprecatedFeatures:i,sourceMap:n.sourceMaps,targets:n.targets,loose:r,features:n.includeModules,platform:n.platform,flags:n.flags,mode:"BUILD",metaFile:o,preserveType:n.preserveType,wasmCompressionMode:n.wasmCompressionMode,enableNamedRegisterForSystemJSModuleFormat:n.enableNamedRegisterForSystemJSModuleFormat,inlineEnum:n.inlineEnum,mangleProperties:t,mangleConfigJsonMtime:e};await sub_process_manager_1.workerManager.registerTask({name:"build-engine",path:(0,path_1.join)(__dirname,"./build-engine")}),console.debug("Cache is invalid, start build engine with options: "+JSON.stringify(s,null,2)),console.debug("md5String: "+u.split(",").join(",\n")),await sub_process_manager_1.workerManager.runTask("build-engine","buildEngineCommand",[s]),await outputCacheJson(n,l),sub_process_manager_1.workerManager.kill("build-engine"),console.debug("build engine done: output: "+l)}return{output:l,metaFile:o}}async function validateCache(e,t){if(!await fs_extra_2.default.pathExists(e))return console.debug(`Engine cache (${e}) does not exist.`),!1;let n=!1;try{0!==(await(0,globby_1.default)((0,path_1.join)(e,"**/*.js"))).length&&(n=!0)}catch(e){}return n?!await ccBuild.buildEngine.isSourceChanged(t):(console.warn(`Engine cache directory({link(${e})}) exists but has empty content. It's abnormal.`),!1)}async function isValidMeta(e){if(!await(0,fs_extra_1.pathExists)(e))return!1;let t;try{t=await fs_extra_2.default.readJson(e)}catch(e){return!1}if("object"!=typeof t||null===t)return!1;if("object"!=typeof t.exports)return!1;e=(0,path_1.join)(Editor.Project.path,"engine-mangle-config.json");if(await fs_extra_2.default.pathExists(e)){var e=(await fs_extra_2.default.stat(e)).mtimeMs,n=new Date(e).toLocaleString(),a=t.mangleConfigJsonMtime,i=void 0!==a?new Date(a).toLocaleString():0;if(e!==a)return console.debug(`engine-mangle-config.json mtime changed: now: ${n} !== old: `+i),!1;console.debug(`engine-mangle-config.json mtime isn't changed: now: ${n} === old: `+i)}return!0}function calcMd5String(e,t){let n="";for(const a of t)n+=`${a}=${JSON.stringify(e[a])},`;return n}async function outputCacheJson(e,t){var n=(0,path_1.join)((0,path_1.dirname)(t),EngineCacheName+".json");let a={};a=(a=await(0,fs_extra_1.pathExists)(n)?await(0,fs_extra_1.readJson)(n):a)||{};t=(0,path_1.basename)(t);a[t]=e,await(0,fs_extra_1.outputJSON)(n,a)}async function queryEngineImportMap(e,n,a,t){let i;try{i=await fs_extra_2.default.readJson(e)}catch(e){throw new Error("Failed to read engine export meta, engine might not have been build correctly: "+e)}const r=t?new URL(t):void 0;var o,s,l,u,c=e=>{let t;return t=r?new URL(e,r).href:"./"+Build.Utils.relativeUrl(a,path_2.default.join(n,e))},d={};for([o,s]of Object.entries(i.exports))d[o]=c(s);for([l,u]of Object.entries(i.chunkAliases))d[l]=c(u);return d}exports.queryEngineImportMap=queryEngineImportMap;