"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,r)}:function(e,t,n,a){e[a=void 0===a?n:a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var r=function(e){return(r=Object.getOwnPropertyNames||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),a=0;a<n.length;a++)"default"!==n[a]&&__createBinding(t,e,n[a]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildEngineX=buildEngineX,exports.buildSplitEngine=buildSplitEngine,exports.queryEngineImportMap=queryEngineImportMap;const crypto_1=require("crypto"),path_1=require("path"),fs_extra_1=require("fs-extra"),ccBuild=__importStar(require("@cocos/ccbuild")),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),sub_process_manager_1=require("../../../worker-pools/sub-process-manager"),fast_glob_1=__importDefault(require("fast-glob")),mangle_config_parser_1=require("./mangle-config-parser"),default_mangle_config_1=require("./default-mangle-config"),EngineCacheName="engine-cache",exportsMetaFile="meta.json";async function buildEngineX(e,t){var{output:t,metaFile:n}=await buildEngine(e,t);return await(0,fs_extra_1.emptyDir)(e.output),await(0,fs_extra_1.copy)(""+t,e.output,{recursive:!0}),{metaFile:n}}const fixedMd5Keys=["debug","sourceMaps","includeModules","engineVersion","platformType","split","nativeCodeBundleMode","targets","entry","noDeprecatedFeatures","loose","assetURLFormat","flags","preserveType","wasmCompressionMode","enableNamedRegisterForSystemJSModuleFormat","mangleProperties","inlineEnum"];async function buildEngine(n,a){var r=(await Editor.Message.request("engine","query-engine-modules-profile"))?.noDeprecatedFeatures??{value:!1,version:""},i=await Editor.Profile.getProject("project","script.loose"),r=r.value?r.version||!0:void 0,o={noDeprecatedFeatures:r,loose:i},s=(0,path_1.join)(Editor.Project.path,"engine-mangle-config.json"),l=(n.mangleProperties&&!await fs_extra_2.default.pathExists(s)?(console.debug("mangleProperties is enabled, but engine-mangle-config.json not found, create default mangle configuration"),default_mangle_config_1.defaultMangleConfig.__doc_url__=Editor.Utils.Url.getDocUrl("advanced-topics/mangle-properties.html"),await fs_extra_2.default.writeJson(s,default_mangle_config_1.defaultMangleConfig,{spaces:2})):console.debug("mangleProperties is enabled, found engine-mangle-config.json, use it"),0===n.md5Map.length?fixedMd5Keys:n.md5Map.concat(fixedMd5Keys));let u=calcMd5String(Object.assign(o,n),l);n.mangleProperties&&(u+=`projectPath=${Editor.Project.path},`,console.debug("Found mangle config, append projectPath to md5String: "+u.split(",").join(",\n")));var o=(0,crypto_1.createHash)("md5").update(u).digest("hex"),l=(0,path_1.join)(Editor.App.temp,"builder","engine",o),o=(0,path_1.join)((0,path_1.dirname)(l),o+".meta"),c=l+".watch-files.json",o=(0,path_1.join)(o,exportsMetaFile);if(n.useCache&&await validateCache(l,c)&&await isValidMeta(o))console.debug(`Use cache engine: {link(${l})}`),console.debug("Use cache, md5String: "+u.split(",").join(",\n")),console.debug("Use cache, options: "+JSON.stringify(n,null,2));else{let e=0,t=!1;n.mangleProperties?a.NATIVE?console.warn("Currently, mangling internal properties is not supported on native platforms, current platform: "+n.platformType):void 0===(t=(0,mangle_config_parser_1.parseMangleConfig)(s,n.platformType))?(console.debug("engine-mangle-config.json not found, but mangleProperties is enabled, so enable mangleProperties with default mangle configuration"),t=!0):(e=(await fs_extra_2.default.stat(s)).mtimeMs,console.debug("mangleProperties: "+JSON.stringify(t,null,2))):console.debug("mangleProperties is disabled, platform: "+n.platformType);a={incremental:c,engine:n.entry,out:l,moduleFormat:"system",compress:!n.debug,nativeCodeBundleMode:n.nativeCodeBundleMode,assetURLFormat:n.assetURLFormat,noDeprecatedFeatures:r,sourceMap:n.sourceMaps,targets:n.targets,loose:i,features:n.includeModules,platform:n.platformType,flags:n.flags,mode:"BUILD",metaFile:o,preserveType:n.preserveType,wasmCompressionMode:n.wasmCompressionMode,enableNamedRegisterForSystemJSModuleFormat:n.enableNamedRegisterForSystemJSModuleFormat,inlineEnum:n.inlineEnum,mangleProperties:t,mangleConfigJsonMtime:e};await sub_process_manager_1.workerManager.registerTask({name:"build-engine",path:(0,path_1.join)(__dirname,"./build-engine")}),console.debug("Cache is invalid, start build engine with options: "+JSON.stringify(a,null,2)),console.debug("md5String: "+u.split(",").join(",\n")),await sub_process_manager_1.workerManager.runTask("build-engine","buildEngineCommand",[a]),await outputCacheJson(n,l),sub_process_manager_1.workerManager.kill("build-engine"),console.debug("build engine done: output: "+l)}return{output:l,metaFile:o}}async function buildSplitEngine(e){return await sub_process_manager_1.workerManager.registerTask({name:"build-engine",path:(0,path_1.join)(__dirname,"./build-engine")}),sub_process_manager_1.workerManager.runTask("build-engine","buildSeparateEngine",[e])}async function validateCache(e,t){if(!await fs_extra_2.default.pathExists(e))return console.debug(`Engine cache (${e}) does not exist.`),!1;let n=!1;try{0!==(await(0,fast_glob_1.default)("**/*.js",{cwd:e})).length&&(n=!0)}catch{}return n?!await ccBuild.buildEngine.isSourceChanged(t):(console.warn(`Engine cache directory({link(${e})}) exists but has empty content. It's abnormal.`),!1)}async function isValidMeta(e){if(!await(0,fs_extra_1.pathExists)(e))return!1;let t;try{t=await fs_extra_2.default.readJson(e)}catch(e){return!1}if("object"!=typeof t||null===t)return!1;if("object"!=typeof t.exports)return!1;e=(0,path_1.join)(Editor.Project.path,"engine-mangle-config.json");if(await fs_extra_2.default.pathExists(e)){var e=(await fs_extra_2.default.stat(e)).mtimeMs,n=new Date(e).toLocaleString(),a=t.mangleConfigJsonMtime,r=void 0!==a?new Date(a).toLocaleString():0;if(e!==a)return console.debug(`engine-mangle-config.json mtime changed: now: ${n} !== old: `+r),!1;console.debug(`engine-mangle-config.json mtime isn't changed: now: ${n} === old: `+r)}return!0}function calcMd5String(e,t){let n="";for(const a of t)n+=`${a}=${JSON.stringify(e[a])},`;return n}async function outputCacheJson(e,t){var n=(0,path_1.join)((0,path_1.dirname)(t),EngineCacheName+".json");let a={};a=(a=await(0,fs_extra_1.pathExists)(n)?await(0,fs_extra_1.readJson)(n):a)||{};t=(0,path_1.basename)(t);a[t]=e,await(0,fs_extra_1.outputJSON)(n,a)}async function queryEngineImportMap(e,n,a,t){let r;try{r=await fs_extra_2.default.readJson(e)}catch(e){throw new Error("Failed to read engine export meta, engine might not have been build correctly: "+e)}const i=t?new URL(t):void 0;var o,s,l,u,c=e=>{let t;return t=i?new URL(e,i).href:"./"+Build.Utils.relativeUrl(a,path_2.default.join(n,e))},g={};for([o,s]of Object.entries(r.exports))g[o]=c(s);for([l,u]of Object.entries(r.chunkAliases))g[l]=c(u);return g}