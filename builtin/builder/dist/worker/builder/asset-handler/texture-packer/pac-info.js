"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(e,i);r&&("get"in r?e.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,s,r)}:function(t,e,i,s){void 0===s&&(s=i),t[s]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateSpriteFrame=exports.applyTextureBaseAssetUserData=exports.createTextureFromAtlas=exports.createApriteAtlasFromAtlas=exports.createAssetInstance=exports.SpriteFrameInfo=exports.AtlasInfo=exports.PacInfo=exports.DefaultPackOption=void 0;const cc_1=require("cc"),path_1=require("path"),asset_library_1=require("../../manager/asset-library"),utils_1=require("../../utils"),HashUuid=__importStar(require("../../utils/hash-uuid")),Lodash=require("lodash"),EditorExtends=require("@base/electron-module").require("EditorExtends");exports.DefaultPackOption={maxWidth:1024,maxHeight:1024,padding:2,allowRotation:!0,forceSquared:!1,powerOfTwo:!1,algorithm:"MaxRects",format:"png",quality:80,contourBleed:!0,paddingBleed:!0,filterUnused:!0,removeTextureInBundle:!0,removeImageInBundle:!0,removeSpriteAtlasInBundle:!0,compressSettings:{},bleed:0,mode:"build"};class PacInfo{constructor(t,e){this.spriteFrameInfos=[],this.spriteFrames=[],this.relativePath="",this.relativeDir="",this.path="",this.uuid="",this.imagePath="",this.imageUuid="",this.textureUuid="",this.name="autoatlas",this.width=1024,this.height=1024,this.dirty=!1,this.packOptions=JSON.parse(JSON.stringify(exports.DefaultPackOption)),this.uuid=t.uuid;let i=JSON.parse(JSON.stringify(t.meta.userData));i=e?Object.assign(i,e):i,this.packOptions=Object.assign(this.packOptions,i),this.packOptions.bleed=this.packOptions.paddingBleed?1:0,this.path=t.path,this.storeInfo={pac:{uuid:t.uuid,mtime:t.mtime},sprites:[],options:this.packOptions};const s=(0,path_1.join)(Editor.Project.path,"assets");this.relativePath=(0,path_1.relative)(s,t.file),this.relativeDir=(0,path_1.relative)(s,(0,path_1.dirname)(t.file)),this.name=t.displayName||t.name}async initSpriteFramesWithRange(t){const e=await this.queryInvalidSpriteAssets(t);return 0===e.length&&"build"===this.packOptions.mode?(console.warn(`No SpriteFrame found in folder [{link(${(0,path_1.dirname)(this.path)})}]. Please check the AutoAtlas [${this.path}].`),this):(await this.initSpriteFrames(e),this)}async initSpriteFrames(t){let e=await Promise.all(t.map(async t=>new Promise((e,i)=>{cc.assetManager.loadAny(t.uuid,(i,s)=>{const r=new SpriteFrameInfo(s,t,this.packOptions);r._pacUuid=this.uuid,this.spriteFrames.push(s),e(r)})})));return e=Lodash.sortBy(e,"uuid"),this.spriteFrameInfos=e,this.storeInfo.sprites=this.spriteFrameInfos.map(t=>t.toJSON()),this}async queryInvalidSpriteAssets(t){const e=await asset_library_1.buildAssetLibrary.queryAssetsByOptions({pattern:(0,path_1.dirname)(this.path)+"/**/*",importer:"sprite-frame",deep:!0});let i=[];for(const s of e)s.meta.userData.packable&&(this.packOptions.filterUnused&&(!this.packOptions.filterUnused||t&&!t.includes(s.uuid))||i.push(s));if(!i||0===i.length)return[];const s=await asset_library_1.buildAssetLibrary.queryAssetsByOptions({pattern:(0,path_1.dirname)(this.path)+"/+(**)/*.pac"}),r=s.map(t=>(0,path_1.dirname)(t.file));return 0!==s.length&&(i=i.filter(t=>{for(const e of r)if(Editor.Utils.Path.contains(e,Build.Utils.dbUrlToRawPath(t.path)))return!1;return!0})),i}toJSON(){const t=Object.assign({},this);delete t.spriteFrames,delete t.storeInfo}}exports.PacInfo=PacInfo;class AtlasInfo{constructor(t,e,i,s,r){this.imageUuid="",this.textureUuid="",this.compressed={imagePathNoExt:"",suffixs:[]};const a=t.map(t=>t.uuid);this.imageUuid=HashUuid.calculate([a],HashUuid.BuiltinHashType.AutoAtlasImage)[0],this.textureUuid=this.imageUuid+"@"+require("@editor/asset-db/libs/utils").nameToId("texture"),this.spriteFrameInfos=t,this.width=e,this.height=i,this.name=s,this.imagePath=r.replace(s,this.imageUuid),this.compressed.suffixs.push((0,path_1.extname)(r))}toJSON(){return{spriteFrameInfos:this.spriteFrameInfos.map(t=>t.toJSON()),width:this.width,height:this.height,name:this.name,imagePath:this.imagePath,imageUuid:this.imageUuid,textureUuid:this.textureUuid,compressed:this.compressed}}}exports.AtlasInfo=AtlasInfo;class SpriteFrameInfo{constructor(t,e,i){this.name="",this.uuid="",this.imageUuid="",this.textureUuid="",this.trim={width:0,height:0,rotatedWidth:0,rotatedHeight:0,x:0,y:0},this.rawWidth=0,this.rawHeight=0,this.width=0,this.height=0,this.originalPath="",this.rotated=!1,this._file="",this._libraryPath="",this._pacUuid="";const s=t.rect;this.spriteFrame=t;const r=t.rotated?s.height:s.width,a=t.rotated?s.width:s.height;this.name=e.displayName||"",t.packable=!1,this.rotated=t.rotated,this.uuid=e.uuid,this.imageUuid=t.texture._mipmaps[0]._uuid,this.textureUuid=t.texture._uuid,this._file=(0,utils_1.dbUrlToRawPath)(e.fatherInfo.source),this._libraryPath=(0,path_1.normalize)(t.texture._mipmaps[0].url),this.trim={rotatedWidth:r,rotatedHeight:a,x:s.x,y:s.y,width:s.width,height:s.height},this.rawWidth=t.originalSize.width,this.rawHeight=t.originalSize.height,this.width=s.width+2*(i.padding+i.bleed),this.height=s.height+2*(i.padding+i.bleed)}toJSON(){const t=Object.assign({},this);return delete t._libraryPath,delete t._file,delete t._pacUuid,delete t.spriteFrame,t}}function createAssetInstance(t,e,i){const s=createApriteAtlasFromAtlas(t,e,i);return[s.spriteAtlas,...s.images,...s.spriteFrames,...s.textures]}function createApriteAtlasFromAtlas(t,e,i){const s=new cc_1.SpriteAtlas;s._uuid=e.uuid,s.name=(0,path_1.basename)(e.name,(0,path_1.extname)(e.name));const r=[],a=[],n=[];for(const o of t){const{image:t,texture:h}=createTextureFromAtlas(o,e);r.push(t),a.push(h),o.spriteFrameInfos&&o.spriteFrameInfos.forEach(t=>{let e=i.find(e=>e._uuid===t.uuid);e=generateSpriteFrame(t,e,h),n.push(e),s.spriteFrames[t.name]=EditorExtends.serialize.asAsset(t.uuid)})}return{spriteAtlas:s,textures:a,images:r,spriteFrames:n}}function createTextureFromAtlas(t,e){const i=t.imageUuid,s=t.textureUuid;if(t.compressd&&(t.compressed=t.compressd),!t.compressed)throw new Error("Can't find atlas.compressed.");const r=new cc_1.ImageAsset;r._setRawAsset(".png"),r._uuid=i,r._width=r._nativeAsset.width=t.width,r._height=r._nativeAsset.height=t.height;const a=new cc_1.Texture2D;return e.meta.userData.textureSetting||console.warn(`meta.userData.textureSetting in asset(${e.uuid}) is missing.`),applyTextureBaseAssetUserData(e.meta.userData.textureSetting,a),a._mipmaps=[r],a._uuid=s,{texture:a,image:r}}function applyTextureBaseAssetUserData(t,e){t=t||{wrapModeS:"repeat",wrapModeT:"repeat",minfilter:"nearest",magfilter:"linear",mipfilter:"none",anisotropy:1};const i=t=>{switch(t){case"clamp-to-edge":return cc.TextureBase.WrapMode.CLAMP_TO_EDGE;case"repeat":return cc.TextureBase.WrapMode.REPEAT;case"mirrored-repeat":return cc.TextureBase.WrapMode.MIRRORED_REPEAT}},s=t=>{switch(t){case"nearest":return cc.TextureBase.Filter.NEAREST;case"linear":return cc.TextureBase.Filter.LINEAR;case"none":return cc.TextureBase.Filter.NONE}};e.setWrapMode(i(t.wrapModeS),i(t.wrapModeT)),e.setFilters(s(t.minfilter),s(t.magfilter)),e.setMipFilter(s(t.mipfilter)),e.setAnisotropy(t.anisotropy)}function generateSpriteFrame(t,e,i){const s=new cc.SpriteFrame;s._name=t.name,s._uuid=e._uuid,s.texture=i;const r=t.trim;return s._rect=cc.rect(r.x,r.y,r.width,r.height),s._offset=e.getOffset(),s._originalSize=cc.size(t.rawWidth,t.rawHeight),s._rotated=t.rotated,s._capInsets=[e.insetLeft,e.insetTop,e.insetRight,e.insetBottom],s}exports.SpriteFrameInfo=SpriteFrameInfo,exports.createAssetInstance=createAssetInstance,exports.createApriteAtlasFromAtlas=createApriteAtlasFromAtlas,exports.createTextureFromAtlas=createTextureFromAtlas,exports.applyTextureBaseAssetUserData=applyTextureBaseAssetUserData,exports.generateSpriteFrame=generateSpriteFrame;