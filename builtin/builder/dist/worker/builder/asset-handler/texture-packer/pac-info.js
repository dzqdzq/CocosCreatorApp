"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=a(e),i=0;i<r.length;i++)"default"!==r[i]&&__createBinding(t,e,r[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpriteFrameInfo=exports.AtlasInfo=exports.PacInfo=exports.DefaultPackOption=void 0,exports.createAssetInstance=createAssetInstance,exports.createApriteAtlasFromAtlas=createApriteAtlasFromAtlas,exports.createTextureFromAtlas=createTextureFromAtlas,exports.applyTextureBaseAssetUserData=applyTextureBaseAssetUserData,exports.generateSpriteFrame=generateSpriteFrame;const cc_1=require("cc"),path_1=require("path"),asset_library_1=require("../../manager/asset-library"),HashUuid=__importStar(require("../../utils/hash-uuid")),Lodash=require("lodash"),EditorExtends=require("@base/electron-module").require("EditorExtends");exports.DefaultPackOption={maxWidth:1024,maxHeight:1024,padding:2,allowRotation:!0,forceSquared:!1,powerOfTwo:!1,algorithm:"MaxRects",format:"png",quality:80,contourBleed:!0,paddingBleed:!0,filterUnused:!0,removeTextureInBundle:!0,removeImageInBundle:!0,removeSpriteAtlasInBundle:!0,compressSettings:{},bleed:0,mode:"build"};class PacInfo{spriteFrameInfos=[];spriteFrames=[];relativePath="";relativeDir="";path="";uuid="";imagePath="";imageUuid="";textureUuid="";name="autoatlas";width=1024;height=1024;dirty=!1;packOptions=JSON.parse(JSON.stringify(exports.DefaultPackOption));storeInfo;result;constructor(e,t){this.uuid=e.uuid;var r=JSON.parse(JSON.stringify(e.meta.userData)),r=t?Object.assign(r,t):r,t=(this.packOptions=Object.assign(this.packOptions,r),this.packOptions.bleed=this.packOptions.paddingBleed?1:0,this.path=e.url,this.storeInfo={pac:{uuid:e.uuid,mtime:asset_library_1.buildAssetLibrary.getAssetProperty(e,"mtime")},sprites:[],options:this.packOptions},(0,path_1.join)(Editor.Project.path,"assets"));this.relativePath=(0,path_1.relative)(t,e.source),this.relativeDir=(0,path_1.relative)(t,(0,path_1.dirname)(e.source)),this.name=asset_library_1.buildAssetLibrary.getAssetProperty(e,"name")}async initSpriteFramesWithRange(e){e=await this.queryInvalidSpriteAssets(e);return e.length&&await this.initSpriteFrames(e),this}async initSpriteFrames(e){let t=await Promise.all(e.map(async a=>(cc_1.assetManager.assets.has(a.uuid)&&cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(a.uuid)),new Promise((i,e)=>{cc_1.assetManager.loadAny(a.uuid,(e,t)=>{if(e||!t)console.error(`sprite frame can't be load:${a.uuid}, will remove it from atlas.`),e&&console.error(e),i(null);else try{var r=new SpriteFrameInfo(t,a,this.packOptions);r._pacUuid=this.uuid,this.spriteFrames.push(t),i(r)}catch(e){console.error("packer: load sprite frame failed:"+a.uuid),console.error(e),i(null)}})}))));return t=t.filter(e=>null!=e),t=Lodash.sortBy(t,"uuid"),this.spriteFrameInfos=t,this.storeInfo.sprites=this.spriteFrameInfos.map(e=>e.toJSON()),this}async queryInvalidSpriteAssets(e){let t=[];for(const a of await asset_library_1.buildAssetLibrary.queryAssetsByOptions({pattern:(0,path_1.dirname)(this.path)+"/**/*",importer:"sprite-frame"}))!a.meta.userData.packable||this.packOptions.filterUnused&&(!this.packOptions.filterUnused||e&&!e.includes(a.uuid))||t.push(a);if(!t||0===t.length)return[];var r=await asset_library_1.buildAssetLibrary.queryAssetsByOptions({pattern:(0,path_1.dirname)(this.path)+"/*/**/*.pac"});const i=r.map(e=>(0,path_1.dirname)(e.source));return t=0!==r.length?t.filter(e=>{for(const t of i)if(Editor.Utils.Path.contains(t,e.source))return!1;return!0}):t}toJSON(){var e=Object.assign({},this);delete e.spriteFrames,delete e.storeInfo}}exports.PacInfo=PacInfo;class AtlasInfo{imagePath;imageUuid="";textureUuid="";name;spriteFrameInfos;width;height;compressed={imagePathNoExt:"",suffixs:[]};constructor(e,t,r,i,a){var s=e.map(e=>e.uuid);this.imageUuid=HashUuid.calculate([s],HashUuid.BuiltinHashType.AutoAtlasImage)[0],this.textureUuid=this.imageUuid+"@"+require("@editor/asset-db/libs/utils").nameToId("texture"),this.spriteFrameInfos=e,this.width=t,this.height=r,this.name=i,this.imagePath=a.replace(i,this.imageUuid),this.compressed.suffixs.push((0,path_1.extname)(a))}toJSON(){return{spriteFrameInfos:this.spriteFrameInfos.map(e=>e.toJSON()),width:this.width,height:this.height,name:this.name,imagePath:this.imagePath,imageUuid:this.imageUuid,textureUuid:this.textureUuid,compressed:this.compressed}}}exports.AtlasInfo=AtlasInfo;class SpriteFrameInfo{name="";uuid="";imageUuid="";textureUuid="";spriteFrame;trim={width:0,height:0,rotatedWidth:0,rotatedHeight:0,x:0,y:0};rawWidth=0;rawHeight=0;width=0;height=0;originalPath="";rotated=!1;_file="";_libraryPath="";_pacUuid="";_mtime=0;constructor(e,t,r){var i=e.rect,a=(this.spriteFrame=e).rotated?i.height:i.width,s=e.rotated?i.width:i.height;this.name=t.displayName||"",e.packable=!1,this.rotated=e.rotated,this.uuid=t.uuid,this.imageUuid=e.texture._mipmaps[0]._uuid,this.textureUuid=e.texture._uuid,this._file=t.parent.source,this._libraryPath=(0,path_1.normalize)(e.texture._mipmaps[0].url),this.trim={rotatedWidth:a,rotatedHeight:s,x:i.x,y:i.y,width:i.width,height:i.height},this.rawWidth=e.originalSize.width,this.rawHeight=e.originalSize.height,this.width=i.width+2*(r.padding+r.bleed),this.height=i.height+2*(r.padding+r.bleed),this._mtime=t._assetDB.infoManager.get(t.parent.source).time}toJSON(){var e=Object.assign({},this);return delete e._libraryPath,delete e._file,delete e._pacUuid,delete e.spriteFrame,e}}function createAssetInstance(e,t,r){e=createApriteAtlasFromAtlas(e,t,r);return[e.spriteAtlas,...e.images,...e.spriteFrames,...e.textures]}function createApriteAtlasFromAtlas(e,t,r){const i=new cc_1.SpriteAtlas;i._uuid=t.uuid,i.name=(0,path_1.basename)(t.source,(0,path_1.extname)(t.source));var a=[],s=[];const n=[];for(const o of e){const{image:u,texture:p}=createTextureFromAtlas(o,t);a.push(u),s.push(p),o.spriteFrameInfos&&o.spriteFrameInfos.forEach(t=>{var e=r.find(e=>e._uuid===t.uuid),e=generateSpriteFrame(t,e,p);n.push(e),i.spriteFrames[t.name]=EditorExtends.serialize.asAsset(t.uuid)})}return{spriteAtlas:i,textures:s,images:a,spriteFrames:n}}function createTextureFromAtlas(e,t){var r,i=e.imageUuid,a=e.textureUuid;if(e.compressd&&(e.compressed=e.compressd),e.compressed)return(r=new cc_1.ImageAsset)._setRawAsset(".png"),r._uuid=i,r._width=r._nativeAsset.width=e.width,r._height=r._nativeAsset.height=e.height,i=new cc_1.Texture2D,t.meta.userData.textureSetting||console.warn(`meta.userData.textureSetting in asset(${t.uuid}) is missing.`),applyTextureBaseAssetUserData(t.meta.userData.textureSetting,i),i._mipmaps=[r],i._uuid=a,{texture:i,image:r};throw new Error("Can't find atlas.compressed.")}function applyTextureBaseAssetUserData(e,t){var r=e=>{switch(e){case"clamp-to-edge":return cc_1.Texture2D.WrapMode.CLAMP_TO_EDGE;case"repeat":return cc_1.Texture2D.WrapMode.REPEAT;case"mirrored-repeat":return cc_1.Texture2D.WrapMode.MIRRORED_REPEAT}},i=e=>{switch(e){case"nearest":return cc_1.Texture2D.Filter.NEAREST;case"linear":return cc_1.Texture2D.Filter.LINEAR;case"none":return cc_1.Texture2D.Filter.NONE}};t.setWrapMode(r((e=e||{wrapModeS:"repeat",wrapModeT:"repeat",minfilter:"nearest",magfilter:"linear",mipfilter:"none",anisotropy:1}).wrapModeS),r(e.wrapModeT)),t.setFilters(i(e.minfilter),i(e.magfilter)),t.setMipFilter(i(e.mipfilter)),t.setAnisotropy(e.anisotropy)}function generateSpriteFrame(e,t,r){var i=new cc_1.SpriteFrame;return i.texture=r,i.rect=new cc_1.Rect(e.trim.x,e.trim.y,e.trim.width,e.trim.height),i.originalSize=new cc_1.Size(e.rawWidth,e.rawHeight),i.offset=t.offset,i.name=e.name,i.rotated=e.rotated,i.insetBottom=t.insetBottom,i.insetTop=t.insetTop,i.insetRight=t.insetRight,i.insetLeft=t.insetLeft,i._uuid=t.uuid,i}exports.SpriteFrameInfo=SpriteFrameInfo;