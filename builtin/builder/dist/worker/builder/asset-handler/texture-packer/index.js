"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryAutoAtlasFileCache=exports.packAutoAtlas=exports.TexturePacker=void 0;const fs_extra_1=require("fs-extra"),lodash_1=__importDefault(require("lodash")),path_1=require("path"),asset_library_1=require("../../manager/asset-library"),config_1=require("./config"),pac_info_1=require("./pac-info"),packer_1=require("./packer");class TexturePacker{constructor(){this.pacInfos=[]}static getCacheDirWithUuid(e,t="build"){return(0,path_1.join)(asset_library_1.buildAssetLibrary.getAssetTempDirByUuid(e),t,"texture-packer",t)}static async packSingle(e,t){const r=await new pac_info_1.PacInfo(e,t).initSpriteFramesWithRange();return TexturePacker.internalPack(r)}static queryPacStoredPath(e){const t=TexturePacker.getCacheDirWithUuid(e.uuid,e.packOptions.mode);return(0,path_1.join)(t,"pac-info.json")}async init(e,t){const r=[];return await Promise.all(e.map(async e=>{const a=await new pac_info_1.PacInfo(e).initSpriteFramesWithRange(t);0!==a.spriteFrameInfos.length&&r.push(a)})),this.pacInfos=r,this}async pack(){return await Promise.all(this.pacInfos.map(e=>TexturePacker.internalPack(e)))}static async internalPack(e){let t=null;const r=TexturePacker.queryPacStoredPath(e);if(TexturePacker.useCache){const a=TexturePacker.getPacResFromCache(e,r);if(a.result)return e.result=a.result,e.dirty=!1,e;t=a,e.dirty=!0}const a=this.getCacheDirWithUuid(e.uuid,e.packOptions.mode);if((0,fs_extra_1.emptyDirSync)(a),e.spriteFrameInfos&&e.spriteFrameInfos.length){const s=await(0,packer_1.packer)(e.spriteFrameInfos,Object.assign(Object.assign({},e.packOptions),{destDir:a,name:e.name}));if(e.result=s,TexturePacker.useCache){(t=t||TexturePacker.genNewStoredInfo(e)).result=s;try{(0,fs_extra_1.outputJSONSync)(r,t,{spaces:2})}catch(e){console.debug("write pac info cache failed"),console.error(e)}}}return e}static getStoredPacInfo(e,t){t=t||TexturePacker.queryPacStoredPath(e);const r={newStoredPacInfo:TexturePacker.genNewStoredInfo(e),storedPacInfo:null};return(0,fs_extra_1.existsSync)(t)?(r.storedPacInfo=(0,fs_extra_1.readJSONSync)(t),r):r}static genNewStoredInfo(e){const t={md5:"",versionDev:config_1.versionDev,sharpMd5:Build.Utils.calcMd5(JSON.stringify(require("sharp").versions))};return e.storeInfo.sprites=lodash_1.default.sortBy(e.storeInfo.sprites,"uuid"),t.md5=Build.Utils.calcMd5(JSON.stringify({packStoreInfo:e.storeInfo,versionDev:config_1.versionDev,sharpMd5:t.sharpMd5})),t}static getPacResFromCache(e,t){const{storedPacInfo:r,newStoredPacInfo:a}=TexturePacker.getStoredPacInfo(e,t);let s=!r||a.md5!==r.md5;if(s)return a;try{for(const e of r.result.atlases)if(!(0,fs_extra_1.existsSync)(e.imagePath)){s=!0;break}a.result=r.result}catch(t){console.warn(`Get Cache info of pac failed {asset(${e.uuid})}`),console.warn(t)}return a}static async queryPacCache(e){const t=new pac_info_1.PacInfo(asset_library_1.buildAssetLibrary.getAssetInfo(e));t.packOptions.mode="preview",await t.initSpriteFramesWithRange();const r=TexturePacker.getStoredPacInfo(t);return r&&r.storedPacInfo&&r.storedPacInfo.result?{unpackedImages:r.storedPacInfo.result.unpackedImages,dirty:!1,atlasImagePaths:r.storedPacInfo.result.atlases.map(e=>e.imagePath)}:null}}async function packAutoAtlas(e,t){t&&(t.mode="preview");try{const r=await TexturePacker.packSingle(asset_library_1.buildAssetLibrary.getAssetInfo(e),t);return r.result?{atlasImagePaths:r.result.atlases.map(e=>e.imagePath),unpackedImages:r.result.unpackedImages,dirty:r.dirty}:null}catch(e){console.error(e)}return null}function queryAutoAtlasFileCache(e){return TexturePacker.queryPacCache(e)}exports.TexturePacker=TexturePacker,TexturePacker.useCache=!0,exports.packAutoAtlas=packAutoAtlas,exports.queryAutoAtlasFileCache=queryAutoAtlasFileCache;