"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.hasGroups=exports.walk=exports.splitGroups=void 0;const asset_library_1=require("../manager/asset-library"),_=require("lodash");function splitGroups(e,t=!1){if(e.length<2)return e;const r=[e[0]];e:for(let t=1;t<e.length;t++){let s=e[t];const n=r.length;for(let e=0;e<n;e++){let t=r[e];const n=_.intersection(t,s),i=t.length,u=s.length,o=n.length;if(0!==o)if(o===i){if(i===u)continue e;s=_.difference(s,n)}else{if(o===u){i!==u&&(t=_.difference(t,n),r[e]=t,r.push(n));continue e}s=_.difference(s,n),t=_.difference(t,n),r[e]=t,r.push(n)}}r.push(s)}if(t){const t=_.flatten(r),s=_.uniq(t);if(s.length<t.length)return console.warn("Internal error: SizeMinimized.transformGroups: res not unique, transform canceled"),e;{const t=_.flatten(e);if(_.difference(t,s).length>0)return console.warn("Internal error: SizeMinimized.transformGroups: not have the same members, transform canceled"),e}}return r}async function walk(e,t){const r=[],s=new Set,n=e;return await async function e(i){if(s.add(i.uuid),t.getRedirect(i.uuid))return;if(r.includes(i.uuid))return;i.library[".json"]&&r.push(i.uuid);const u=(await asset_library_1.buildAssetLibrary.getDependUuids(i.uuid)||[]).filter(e=>{const t=asset_library_1.buildAssetLibrary.getAssetInfo(e);return!(!t||!t.type)&&"cc.Texture2D"!==t.type&&cc.js.getClassByName(t.type)});for(let r=0;r<u.length;r++){const o=u[r];if(s.has(o)){if(o===i.uuid||o===n.uuid){console.debug(`[json-group] check self or raw asset, skip. ${o} depended by ${i.uuid} has checked in raw asset ${n.uuid}/bundle(${t.name})}`);continue}}else await e(asset_library_1.buildAssetLibrary.getAssetInfo(o))}}(e),!r||r.length<1?e.library[".json"]?[e.uuid]:[]:(!r.includes(e.uuid)&&e.library[".json"]&&r.push(e.uuid),[...new Set(r)])}function hasGroups(e,t){for(let r=0;r<t.length;r++){const s=t[r];for(let t=0;t<s.length;t++)if(s[t]===e)return!0}return!1}exports.splitGroups=splitGroups,exports.walk=walk,exports.hasGroups=hasGroups;