"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){e[r=void 0===r?s:r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var t,s=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(s[s.length]=t);return s})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s=a(e),r=0;r<s.length;r++)"default"!==s[r]&&__createBinding(t,e,s[r]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleJsonGroup=handleJsonGroup,exports.outputJsonGroup=outputJsonGroup;const path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),json_group_1=require("../json-group"),HashUuid=__importStar(require("../../utils/hash-uuid")),fs_extra_1=require("fs-extra"),utils_1=require("../../../../share/utils"),cc_1=require("cc"),EditorExtends=require("@base/electron-module").require("EditorExtends");async function handleJsonGroup(s){if(console.debug("handle json group in bundle "+s.name),s.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE){if(s.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON)s.addGroup("NORMAL",s.assetsWithoutRedirect);else{const r={},a=[];var e=[];for(const i of s.assetsWithoutRedirect){var t=asset_library_1.buildAssetLibrary.getAsset(i);if("cc.Texture2D"==asset_library_1.buildAssetLibrary.getAssetProperty(t,"type"))e.push(t.uuid);else{let e=await(0,json_group_1.walk)(t,s);e.length<=1||(e=e.filter(e=>!a.includes(e))).length<=1||(a.push(...e),r[i]=e)}}1<e.length&&(e.sort(utils_1.compareUUID),s.addGroup("TEXTURE",e)),Object.keys(r).forEach(t=>{var e=r[t];e&&JSON.parse(JSON.stringify(e)).forEach(e=>{t!==e&&r[e]&&(console.debug("remove group uuid "+e),delete r[e])})}),Object.values(r).forEach((e,t)=>{e.length<=1||s.addGroup("NORMAL",e)})}console.debug(`handle json group in bundle ${s.name} success`)}}async function outputJsonGroup(t,s){var r=(0,path_1.join)(t.dest,t.importBase);console.debug("Handle all json groups in bundle "+t.name);let a=[];const i=[];t.groups.forEach(e=>{i.push(e.uuids),e.uuids.length<=1||(a=a.concat(e.uuids))});var u=new Set(a),o=HashUuid.calculate(i,HashUuid.BuiltinHashType.PackedAssets);console.debug("handle json group");const n={debug:s.options.debug,...s.options.assetSerializeOptions};for(let e=0;e<t.groups.length;e++){var l=t.groups[e];if(!(l.uuids.length<=1))if(l.name=o[e],l.uuids.sort(utils_1.compareUUID),t.addAssetWithUuid(l.name),u.add(l.name),"TEXTURE"===l.type){p=c=d=void 0;var d=r,c=o[e],p=l;p=(p=await Promise.all(p.uuids.map(async e=>{var t=await s.cache.getSerializedJSON(e,n);return t||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),t}))).map(e=>{var{base:e,mipmaps:t}=EditorExtends.serializeCompiled.getRootData(e);return[e,t]}),p={type:cc_1.js.getClassId(cc_1.Texture2D),data:p},!await y(d,c,p)}else if("IMAGE"===l.type){p=c=d=void 0;d=r,c=o[e],p=l;p=await Promise.all(p.uuids.map(async e=>{var t=await s.cache.getSerializedJSON(e,n);return t||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),t})),p={type:cc_1.js.getClassId(cc_1.ImageAsset),data:p},!await y(d,c,p)}else if("NORMAL"===l.type){let t=[];var _=[];l.uuids.sort();for(let e=0;e<l.uuids.length;e++){var g,h=asset_library_1.buildAssetLibrary.getAsset(l.uuids[e]);h&&!h.meta.files.includes(".json")||((g=await s.cache.getSerializedJSON(l.uuids[e],n))?(_.push(l.uuids[e]),t.push(g)):console.error(Editor.I18n.t("builder.error.get_asset_json_failed",{url:h.url,type:asset_library_1.buildAssetLibrary.getAssetProperty(h,"type")})))}l.uuids=_,t=JSON.parse(JSON.stringify(t)),t=EditorExtends.serializeCompiled.packJSONs(t),await y(r,o[e],t),console.debug(`Json group(${l.name}) compile successï¼Œjson number: `+t.length)}}console.debug("handle single json");for(const m of t.assetsWithoutRedirect)if(!u.has(m)){var f=await s.cache.getSerializedJSON(m,n);if(f){var b=asset_library_1.buildAssetLibrary.getAsset(m);let e=m;await y(r,e=b&&b.library&&b.meta.files.includes(".json")?(0,path_1.basename)(b.library):e,f)}}async function y(e,t,s){e=(0,path_1.join)(e,t.substr(0,2),t+".json");await(0,fs_extra_1.outputJSON)(e,s)}t.groups.forEach(e=>{e.name&&t.addAssetWithUuid(e.name)})}