"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,n)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.outputJsonGroup=exports.handleJsonGroup=void 0;const path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),json_group_1=require("../json-group"),HashUuid=__importStar(require("../../utils/hash-uuid")),fs_extra_1=require("fs-extra"),EditorExtends=require("@base/electron-module").require("EditorExtends");async function handleJsonGroup(e){if(console.debug(`handle json group in bundle ${e.name}`),e.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE){if(e.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON)e.addGroup("NORMAL",e.assetsWithoutRedirect);else{const t={},s=[],o=[];for(const n of e.assetsWithoutRedirect){const a=asset_library_1.buildAssetLibrary.getAssetInfo(n);if("cc.Texture2D"==a.type){o.push(a.uuid);continue}let i=await(0,json_group_1.walk)(a,e);i.length<=1||((i=i.filter(e=>!s.includes(e))).length<=1||(s.push(...i),t[n]=i))}o.length>1&&(o.sort((e,t)=>e.localeCompare(t,"en",{numeric:!0})),e.addGroup("TEXTURE",o)),Object.keys(t).forEach(e=>{const s=t[e];s&&JSON.parse(JSON.stringify(s)).forEach(s=>{e!==s&&t[s]&&(console.debug(`remove group uuid ${s}`),delete t[s])})}),Object.values(t).forEach((t,s)=>{t.length<=1||e.addGroup("NORMAL",t)})}console.debug(`handle json group in bundle ${e.name} success`)}}async function outputJsonGroup(e,t){const s=(0,path_1.join)(e.dest,e.importBase);console.debug(`Handle all json groups in bundle ${e.name}`);let o=[];const n=[];e.groups.forEach(e=>{n.push(e.uuids),e.uuids.length<=1||(o=o.concat(e.uuids))});const a=new Set(o),i=HashUuid.calculate(n,HashUuid.BuiltinHashType.PackedAssets);console.debug("handle json group");const r=Object.assign({debug:t.options.debug},t.options.assetSerializeOptions);for(let o=0;o<e.groups.length;o++){const n=e.groups[o];if(n.uuids.length<=1)continue;if(n.name=i[o],n.uuids.sort((e,t)=>e.localeCompare(t,"en",{numeric:!0})),e.addAssetWithUuid(n.name),a.add(n.name),"TEXTURE"===n.type){await c(s,i[o],n);continue}if("IMAGE"===n.type){await u(s,i[o],n);continue}if("NORMAL"!==n.type)continue;let d=[];const p=[];n.uuids.sort();for(let e=0;e<n.uuids.length;e++){const s=t.cache.getAssetInfo(n.uuids[e]);if(s&&!s.library[".json"])continue;const o=await t.cache.getSerializedJSON(n.uuids[e],r);o?(p.push(n.uuids[e]),d.push(o)):console.error(Editor.I18n.t("builder.error.get_asset_json_failed",{url:s.url,type:s.type}))}n.uuids=p,d=JSON.parse(JSON.stringify(d)),d=EditorExtends.serializeCompiled.packJSONs(d),await l(s,i[o],d),console.debug(`Json group(${n.name}) compile successï¼Œjson number: ${d.length}`)}console.debug("handle single json");for(const o of e.assetsWithoutRedirect){if(a.has(o))continue;const e=await t.cache.getSerializedJSON(o,r);if(!e)continue;const n=t.cache.getAssetInfo(o);let i=o;n&&n.library&&n.library[".json"]&&(i=(0,path_1.basename)(n.library[".json"],".json")),await l(s,i,e)}async function u(e,s,o){const n=await Promise.all(o.uuids.map(async e=>{const s=await t.cache.getSerializedJSON(e,r);return s||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),s})),a={type:cc.js.getClassId(cc.ImageAsset),data:n};await l(e,s,a)}async function c(e,s,o){const n=(await Promise.all(o.uuids.map(async e=>{const s=await t.cache.getSerializedJSON(e,r);return s||console.error(`Can't get SerializedJSON of asset {asset(${e})}`),s}))).map(e=>{const{base:t,mipmaps:s}=EditorExtends.serializeCompiled.getRootData(e);return[t,s]}),a={type:cc.js.getClassId(cc.Texture2D),data:n};await l(e,s,a)}async function l(e,t,s){const o=(0,path_1.join)(e,t.substr(0,2),t+".json");await(0,fs_extra_1.outputJSON)(o,s)}e.groups.forEach(t=>{t.name&&e.addAssetWithUuid(t.name)})}exports.handleJsonGroup=handleJsonGroup,exports.outputJsonGroup=outputJsonGroup;