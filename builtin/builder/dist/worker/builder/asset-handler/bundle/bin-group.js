"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){e[i=void 0===i?r:i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=a(e),i=0;i<r.length;i++)"default"!==r[i]&&__createBinding(t,e,r[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.previewBinGroup=previewBinGroup,exports.handleBinGroup=handleBinGroup,exports.outputBinGroup=outputBinGroup;const path_1=require("path"),asset_library_1=require("../../manager/asset-library"),cconb_1=require("../../utils/cconb"),fs_extra_1=require("fs-extra"),HashUuid=__importStar(require("../../utils/hash-uuid")),utils_1=require("../../../../share/utils"),bin_package_pack_1=require("./bin-package-pack"),PACK_FILE_TYPE_LIST=["cc.AnimationClip"],KB=1024;async function previewBinGroup(e,t){const r=[],i=[];let a=0;return(await Promise.all(e.assetsWithoutRedirect.map(e=>analyzePack(e,t)))).forEach(e=>{e.shouldPack&&(r.push(e.uuid),i.push(e.size),a+=e.size)}),{uuidList:r,sizeList:i,totalSize:a}}async function handleBinGroup(e,t){t&&t.enable&&(console.debug(`Handle binary group in bundle ${e.name}: start`),(t=(await previewBinGroup(e,t.threshold*KB)).uuidList).length<=1?console.debug(`Handle binary group in bundle ${e.name}: no need to handle`):(t.sort(utils_1.compareUUID),e.addGroup("BIN",t,HashUuid.calculate([t],HashUuid.BuiltinHashType.PackedAssets)[0]),console.debug(`Handle binary group in bundle ${e.name}: success`)))}async function outputBinGroup(e,t){t&&t.enable&&(t=e.groups.find(e=>"BIN"==e.type))&&await outputOneBinGroup(t,e)}async function getAssetSize(e){e=(0,cconb_1.getCCONFormatAssetInLibrary)(e);return(await(0,fs_extra_1.stat)(e)).size}async function analyzePack(e,t){var r=asset_library_1.buildAssetLibrary.getAsset(e),i=asset_library_1.buildAssetLibrary.getAssetProperty(r,"type");return PACK_FILE_TYPE_LIST.includes(i)?{uuid:e,shouldPack:(i=await getAssetSize(r))<=t,size:i}:{uuid:e,shouldPack:!1,size:0}}function getOutputFilePath(e,t){return(0,path_1.join)(e.dest,e.importBase,t.slice(0,2),t+".bin")}async function outputOneBinGroup(e,t){console.debug(`output bin groups in bundle ${t.name} start`),t.addAssetWithUuid(e.name);var r=await Promise.all(e.uuids.map(e=>{e=asset_library_1.buildAssetLibrary.getAsset(e),e=(0,cconb_1.getCCONFormatAssetInLibrary)(e);return(0,fs_extra_1.readFile)(e)})),r=(0,bin_package_pack_1.binPackagePack)(r.map(e=>new Uint8Array(e).buffer));await(0,fs_extra_1.outputFile)(getOutputFilePath(t,e.name),new Uint8Array(r))}