"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BundleManager=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),texture_compress_1=require("../texture-compress"),bundle_1=require("./bundle"),texture_compress_2=require("./texture-compress"),index_1=require("../texture-packer/index"),pac_info_1=require("../texture-packer/pac-info"),pac_1=require("./pac"),cconb_1=require("./cconb"),script_1=require("../script"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),asset_1=require("../../manager/asset"),utils_1=require("../../utils"),global_1=require("./../../../global"),json_group_1=require("./json-group"),utils_2=require("../../../../share/utils"),common_options_validator_1=require("../../../../share/common-options-validator"),plugin_1=require("../../../plugin"),task_base_1=require("../../manager/task-base"),load_script_1=require("../script/load-script"),{MAIN:MAIN,START_SCENE:START_SCENE,INTERNAL:INTERNAL,RESOURCES:RESOURCES}=bundle_utils_1.BuiltinBundleName;class BundleManager extends task_base_1.BuildTaskBase{constructor(e,t){super("Bundle Task"),this.bundleMap={},this.bundles=[],this._pacAssets=[],this.packResults=[],this.hookMap={onBeforeBundleInit:"onBeforeBundleInit",onAfterBundleInit:"onAfterBundleInit",onBeforeBundleDataTask:"onBeforeBundleDataTask",onAfterBundleDataTask:"onAfterBundleDataTask",onBeforeBundleBuildTask:"onBeforeBundleBuildTask",onAfterBundleBuildTask:"onAfterBundleBuildTask"},this.pipeline=[this.initOptions,this.hookMap.onBeforeBundleInit,this.loadScript,this.initBundle,this.hookMap.onAfterBundleInit,this.hookMap.onBeforeBundleDataTask,this.initAsset,this.bundleDataTask,this.hookMap.onAfterBundleDataTask,this.hookMap.onBeforeBundleBuildTask,this.clearBundleDest,this.buildScript,this.buildAsset,this.hookMap.onAfterBundleBuildTask,this.outputBundle],this.options=e,e.skipCompressTexture||(this.updateProcess("Skip compress image"),this.imageCompressManager=new texture_compress_1.TextureCompress(e.platform)),this._task=t,this.destDir=e.dest&&Editor.UI.__protected__.File.resolveToRaw(e.dest)||(0,path_1.join)(Editor.Project.path,"build","assetBundle"),this.scriptBuilder=new script_1.ScriptBuilder,this.cache=t?t.cache:new asset_1.BuilderAssetCache,this.hooksInfo=t?t.hooksInfo:plugin_1.pluginManager.getHooksInfo(e.platform)}get bundleGroupInPriority(){if(this._bundleGroupInPriority)return this._bundleGroupInPriority;let e=new Array(21);return this.bundles.forEach(t=>{e[t.priority-1]||(e[t.priority-1]=[]),e[t.priority-1].push(t)}),e=e.filter(e=>e).reverse(),this._bundleGroupInPriority=e,e}async loadScript(){await(0,load_script_1.loadScript)(this.cache)}async initStaticBundleConfig(){const e=await Editor.Profile.getProject("builder","bundleConfig.custom")||{},t=await Editor.Message.request("builder","query-bundle-config");e.default||(e.default=bundle_utils_1.DefaultBundleConfig);const s={};Object.keys(e).forEach(i=>{const n=e[i].configs;s[i]={},Object.keys(n).forEach(e=>{if(!t[e])return;const a=(0,bundle_utils_1.transformPlatformSettings)(n[e],t[e].platformConfigs);Object.assign(s[i],a)})}),BundleManager.BundleConfigs=s}getUserConfig(e="default"){const t=BundleManager.BundleConfigs[e];return t?t[this.options.platform]:null}async initOptions(){var e;await(0,common_options_validator_1.checkProjectSetting)(this.options),this.options.buildScriptParam={experimentalEraseModules:this.options.experimentalEraseModules,outputName:"project",flags:Object.assign({DEBUG:!!this.options.debug},this.options.flags),polyfills:this.options.polyfills,hotModuleReload:!1,platform:"HTML5",commonDir:"",bundleCommonChunk:null!==(e=this.options.bundleCommonChunk)&&void 0!==e&&e},this.options.assetSerializeOptions={"cc.EffectAsset":{glsl1:this.options.includeModules.includes("gfx-webgl"),glsl3:this.options.includeModules.includes("gfx-webgl2"),glsl4:!1},exportCCON:!1}}clearBundleDest(){this.bundles.forEach(e=>{e.output&&(0,fs_extra_1.emptyDirSync)(e.dest)})}async initAsset(){await this.initBundleRootAssets(),await this.initBundleShareAssets(),await this.initBundleConfig()}async initBundleConfig(){for(const e of this.bundles)e.initConfig(),this.options.preview&&await e.initAssetPaths()}async buildAsset(){await this.packImage(),await this.compressImage(),await this.outputAssets()}async run(){return this.options.bundleCommonChunk=!0,await this.runAllTask(),!0}async outputBundle(){this.updateProcess("Output asset in bundles start"),await Promise.all(this.bundles.map(async e=>{e.output&&await e.build()})),this.updateProcess("Output asset in bundles success")}addBundle(e){if(this.bundleMap[e.name]){const t=e.name+Date.now();console.error(Editor.I18n.t("builder.asset_bundle.duplicate_name_messaged_auto_rename",{name:e.name,newName:t,url:this.bundleMap[e.name].root,newUrl:e.root})),e.name=t}this.bundleMap[e.name]=new bundle_1.Bundle(e)}getDefaultBundleConfig(e){const t=(0,path_1.join)(this.destDir,e),s=BundleManager.internalBundlePriority[e];return{name:e,dest:t,root:"",scriptDest:(0,path_1.join)(t,global_1.BuildGlobalInfo.SCRIPT_NAME),priority:s||1,compressionType:bundle_utils_1.BundleCompressionTypes.MERGE_DEP,isRemote:!1,md5Cache:this.options.md5Cache,debug:this.options.debug}}async initBundle(){await this.initStaticBundleConfig();const e=this.options,t=[MAIN,START_SCENE,INTERNAL],s={};this.updateProcess("Init all bundles start...");const i=await asset_library_1.buildAssetLibrary.queryAssetsByOptions({isBundle:!0});e.bundleConfigs=e.bundleConfigs||[],e.bundleConfigs.length&&e.bundleConfigs.forEach(e=>{if(t.includes(e.name))return void(s[e.name]=e);const i=this.patchProjectBundleConfig(e);i?this.addBundle(i):console.warn("Invalid bundle config: ",e)});const n=!e.bundleConfigs.length&&!!this._task;if(e.buildBundleOnly||i.forEach(e=>{const t=this.patchProjectBundleConfig({root:e.url,name:""});t&&!this.bundleMap[t.name]&&(t.output=n,this.addBundle(t))}),e.buildBundleOnly&&!Object.keys(s).length||this.initInternalBundleConfigs(s),this.bundles=Object.values(this.bundleMap).sort((e,t)=>t.priority-e.priority||e.name.localeCompare(t.name,"en",{numeric:!0})),!this.bundles.length)throw new Error("Invalid bundle config, please check your bundle config");this.updateProcess(`Num of bundles: ${this.bundles.length}...`)}initInternalBundleConfigs(e){const t=[MAIN,START_SCENE,INTERNAL],s=!this.options.buildBundleOnly;t.forEach(t=>{var i,n;if(t===START_SCENE&&!this.options.startSceneAssetBundle&&!e[t])return;if(this.options.buildBundleOnly&&!e[t])return;let a=this.getDefaultBundleConfig(t);const o=e[t]||{name:t};if(a=(0,utils_2.defaultsDeep)(Object.assign({},o),a),e[t]=a,a.output=null!==(i=o.output)&&void 0!==i?i:s,o.name===MAIN){const e=this.options.mainBundleIsRemote;!e||this.options.server||this.options.preview||console.warn(Editor.I18n.t("builder.warn.assetBundleIsRemoteInvalid",{directoryName:"main"})),a.isRemote=o.isRemote||e,a.compressionType=o.compressionType||this.options.mainBundleCompressionType}else a.isRemote=!!(null!==(n=o.isRemote)&&void 0!==n?n:!this.options.startSceneAssetBundle&&e[MAIN].isRemote),o.compressionType||(a.compressionType=this.options.startSceneAssetBundle||e[MAIN].compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_DEP?bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON:e[MAIN].compressionType);o.dest||"subpackage"!==a.compressionType?o.dest||(a.dest=a.isRemote?(0,path_1.join)((0,path_1.dirname)(this.destDir),global_1.BuildGlobalInfo.REMOTE_HEADER,a.name):(0,path_1.join)(this.destDir,a.name),a.scriptDest=(0,path_1.join)(a.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)):(a.dest=(0,path_1.join)((0,path_1.dirname)(this.destDir),global_1.BuildGlobalInfo.SUBPACKAGES_HEADER,a.name),a.scriptDest=(0,path_1.join)(a.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)),this.options.moveRemoteBundleScript&&a.isRemote&&!o.scriptDest&&(a.scriptDest=this._task?(0,path_1.join)(this._task.result.paths.bundleScripts,a.name,Build.SCRIPT_NAME):(0,path_1.join)(a.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)),this.addBundle(a)})}patchProjectBundleConfig(e){if(!e.root)return console.debug(`Invalid Bundle config with bundle root:${e.root}`),null;const t=asset_library_1.buildAssetLibrary.url2uuid(e.root);if(!t)return console.debug(`Invalid Bundle config with bundle ${e.root}`),null;const s=asset_library_1.buildAssetLibrary.getAssetInfo(t);if(!s)return console.debug(`Invalid Bundle config with bundle ${e.root}`),null;const{bundleFilterConfig:i,priority:n,bundleConfigID:a,bundleName:o}=s.meta.userData,r=e.name||o||(0,bundle_utils_1.getBundleDefaultName)(s),u=this.getUserConfig(a);let l=this.getDefaultBundleConfig(r);const d=(0,utils_2.defaultsDeep)({compressionType:u&&u.compressionType,isRemote:u&&u.isRemote,priority:n,bundleFilterConfig:i,name:r},e);return l=(0,utils_2.defaultsDeep)(d,l),u||console.warn(`Invalid Bundle config ID ${a} in bundle ${e.root}, the bundle config will use the default config ${l}`),!l.isRemote||this.options.server||this.options.preview||console.warn(Editor.I18n.t("builder.warn.assetBundleIsRemoteInvalid",{directoryName:r})),e.dest||"subpackage"!==l.compressionType?!e.dest&&l.isRemote&&(l.dest=(0,path_1.join)((0,path_1.dirname)(this.destDir),global_1.BuildGlobalInfo.REMOTE_HEADER,l.name),l.scriptDest=(0,path_1.join)(l.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)):(l.dest=(0,path_1.join)((0,path_1.dirname)(this.destDir),global_1.BuildGlobalInfo.SUBPACKAGES_HEADER,l.name),l.scriptDest=(0,path_1.join)(l.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)),this.options.moveRemoteBundleScript&&l.isRemote&&!e.scriptDest&&(l.scriptDest=this._task?(0,path_1.join)(this._task.result.paths.bundleScripts,l.name,Build.SCRIPT_NAME):(0,path_1.join)(l.dest,global_1.BuildGlobalInfo.SCRIPT_NAME)),l}async initBundleRootAssets(){if(this.updateProcess("Init bundle root assets start..."),this.bundleMap[INTERNAL]){const e=await queryPreloadAssetList(this.options.includeModules);console.debug(`Query preload assets from cc.config.json: ${e.toString()}`),e.forEach(e=>{this.bundleMap[INTERNAL].addRootAsset(asset_library_1.buildAssetLibrary.getAssetInfo(e))})}const e=this.bundleMap[START_SCENE]||this.bundleMap[MAIN],t=await asset_library_1.buildAssetLibrary.initAssets();for(let s=0;s<t.length;s++){const i=t[s];let n=this.bundles.find(e=>i.url.startsWith(e.root+"/"));if("cc.Script"!==i.type)if("cc.SceneAsset"!==i.type||this.options.scenes&&!this.options.scenes.find(e=>e.uuid===i.uuid))"auto-atlas"===i.importer&&this._pacAssets.push(i.uuid),n&&"cc.SceneAsset"!==i.type&&n.addRootAsset(i);else{if(e&&this.options.startScene===i.uuid){e.addRootAsset(i);continue}n?n.addRootAsset(i):this.bundleMap[MAIN]&&this.bundleMap[MAIN].addRootAsset(i)}else(n=n||this.bundleMap[MAIN])&&n.addAsset(i)}if(e&&(this.options.renderPipeline&&e.addRootAsset(asset_library_1.buildAssetLibrary.getAssetInfo(this.options.renderPipeline)),this.options.physicsConfig.defaultMaterial)){const t=asset_library_1.buildAssetLibrary.getAssetInfo(this.options.physicsConfig.defaultMaterial);e.addRootAsset(t)}this.updateProcess("Init bundle root assets success...")}async initBundleShareAssets(){if(1===this.bundles.length)return;this.updateProcess("Init bundle share assets start...");const e={},t=this;async function s(i,n,a,o){var r,u;if(a.has(i))return;const l=asset_library_1.buildAssetLibrary.getAssetInfo(i);if(!l)return void(o||console.warn(Editor.I18n.t("builder.error.missing_asset",{uuid:`{asset(${i})}`})));if(a.add(i),n.addAsset(l),l.library[".cconb"]){const e=t.options.assetSerializeOptions.exportCCON?".ccon":".cconb";(null!==(r=(u=n.config.extensionMap)[e])&&void 0!==r?r:u[e]=[]).push(l.uuid)}if(e[i])return void n.addRedirect(i,e[i]);const d=await asset_library_1.buildAssetLibrary.getDependUuids(i);await Promise.all(d.map(async e=>await s(e,n,a,i)))}const i=this.bundleGroupInPriority;for(const t of i)await Promise.all(t.map(async e=>{const t=new Set;return await Promise.all(e.rootAssets.map(async i=>await s(i,e,t)))})),t.forEach(t=>{t.assetsWithoutRedirect.forEach(s=>{e[s]||(e[s]=t.name)})});this.updateProcess("Init bundle share assets success...")}async bundleDataTask(){const e=this.imageCompressManager;e&&await e.init(),await Promise.all(this.bundles.map(async t=>{t.output&&(await(0,json_group_1.handleJsonGroup)(t),e&&await(0,texture_compress_2.bundleDataTask)(t,e))}))}async compressImage(){this.imageCompressManager&&(this.updateProcess("Compress image start..."),await this.imageCompressManager.run(),this.updateProcess("Compress image success..."))}async packImage(){this.updateProcess("Pack Images start"),Editor.Metrics.trackTimeStart("builder:pack-auto-atlas-image");let e=[];this.options.buildBundleOnly?this._pacAssets.reduce((e,t)=>{const s=asset_library_1.buildAssetLibrary.getAssetInfo(t);return this.bundles.some(e=>!!e.output&&(!(!Editor.Utils.Path.contains(s.url,e.root)&&!Editor.Utils.Path.contains(e.root,s.url))||void 0))&&e.push(s),e},e):e=this._pacAssets.map(e=>asset_library_1.buildAssetLibrary.getAssetInfo(e));const t=new Set;this.bundles.forEach(e=>e.assets.forEach(e=>t.add(e))),this.packResults=await(await(new index_1.TexturePacker).init(e,Array.from(t))).pack();const s=this.imageCompressManager,i=[];this.bundles.map(e=>i.push(...e._assets));const n={};await Promise.all(this.packResults.map(async e=>{const t=e.result.atlases,a=asset_library_1.buildAssetLibrary.getAssetInfo(e.uuid);(0,pac_info_1.createAssetInstance)(t,a,e.spriteFrames).forEach(e=>{this.cache.addInstance(e)}),await collectDependAssets(e.uuid,i,n);for(const t of e.spriteFrameInfos)await collectDependAssets(t.uuid,i,n),await collectDependAssets(t.textureUuid,i,n),n[t.textureUuid]&&(n[t.textureUuid]=n[t.textureUuid].filter(e=>e!==t.uuid),n[t.textureUuid].length||delete n[t.textureUuid]),await collectDependAssets(t.imageUuid,i,n),n[t.imageUuid]&&(n[t.imageUuid]=n[t.imageUuid].filter(e=>e!==t.textureUuid),n[t.imageUuid].length||delete n[t.imageUuid],s&&s.removeTask((0,utils_1.queryImageAssetFromSubAssetByUuid)(t.uuid)));await Promise.all(t.map(async t=>{await(0,pac_1.sortBundleInPac)(this.bundles,t,e,n,s)}))})),await Editor.Metrics.trackTimeEnd("builder:pack-auto-atlas-image",{output:!0}),this.updateProcess("Pack Images success")}async buildScript(){this.updateProcess("Build script in bundle start"),this.options.buildScriptParam&&!this.options.buildScriptParam.commonDir&&(this.options.buildScriptParam.commonDir=(0,path_1.join)(this.destDir,"src","chunks")),await this.scriptBuilder.initProjectOptions(this.options);const e=await this.scriptBuilder.buildBundleScript(this.bundles);return this.updateProcess("Build script in bundle success"),e}async outputAssets(){this.updateProcess("Ouput asset in bundles start");const e=new Set;await Promise.all(this.bundles.map(async t=>{t.output&&(this.imageCompressManager&&await(0,texture_compress_2.bundleOutputTask)(t,this.cache),await(0,json_group_1.outputJsonGroup)(t,this),await Promise.all(t.assetsWithoutRedirect.map(async s=>{if(s.length<=15||t.compressTask[s])return Promise.resolve();const i=asset_library_1.buildAssetLibrary.getAssetInfo(s);i?(e.has(s)||(e.add(s),await checkEffectTextureMipmap(i,s)),await copyAssetFile(i,t,this.options)):console.error(`Can not get asset info with uuid(${s})`)})))})),this.updateProcess("Output asset in bundles success")}async handleHook(e,t,...s){t?await e.call(this,this.options,this.bundles,this.cache):await e()}async runAllTask(){const e=1/this.pipeline.length;for(const t of this.pipeline)"string"==typeof t?await this.runPluginTask(t,e):"function"==typeof t&&await this.runBuildTask(t,e)}async runBuildTask(e,t){if(this.breakResolve)return this.breakResolve(),void await this.onError(new Error(`Build task ${this.options.taskName||this.options.outputName} is break!`));try{await e.bind(this)(),this.updateProcess(`run bundle task ${e.name} success!`,t)}catch(e){this.updateProcess("run bundle task failed!",t),await this.onError(e)}}}async function collectDependAssets(e,t,s){if(t.includes(e)){const t=await asset_library_1.buildAssetLibrary.queryAssetDependeds(e);t&&t.length&&(s[e]=t)}}exports.BundleManager=BundleManager,BundleManager.BuiltinBundleName=bundle_utils_1.BuiltinBundleName,BundleManager.BundleConfigs={},BundleManager.internalBundlePriority={[MAIN]:7,[START_SCENE]:20,[INTERNAL]:21,[RESOURCES]:8};const featuresWithDependencies=[],preloadAssets=[],LIBRARY_NAME="library";function copyAssetFile(e,t,s){const i=[".json"];return Promise.all(Object.keys(e.library).map(n=>{if(i.includes(n))return Promise.resolve();if(n.startsWith("__"))return Promise.resolve();const a=".cconb"===n,o=(0,path_1.join)(t.dest,a?t.importBase:t.nativeBase),r=e.library[n],u=(0,path_1.relative)((0,path_1.join)(Editor.Project.path,LIBRARY_NAME),r);if(!(0,fs_extra_1.existsSync)(r))return console.error(Editor.I18n.t("builder.error.missing_import_files",{path:`{link(${r})}`,url:`{asset(${e.url})}`})),Promise.resolve();const l=(0,path_1.join)((0,path_1.join)(o,u));return".cconb"===n?(0,cconb_1.exportCCONB)(e,{debug:s.debug,dest:l,exportCCON:s.assetSerializeOptions&&s.assetSerializeOptions.exportCCON,allowCCONExtension:s.assetSerializeOptions.allowCCONExtension}):(0,fs_extra_1.existsSync)(l)?Promise.resolve():(0,fs_extra_1.copy)(r,l)}))}function traversalDependencies(e,t){e.forEach(e=>{if(t[e]&&!featuresWithDependencies.includes(e)&&(featuresWithDependencies.push(e),t[e].dependentAssets&&preloadAssets.push(...t[e].dependentAssets),t[e].dependentModules)){traversalDependencies(t[e].dependentModules,t)}})}async function queryPreloadAssetList(e){const t=(await Editor.Message.request("engine","query-engine-info")).typescript.path,s=(await(0,fs_extra_1.readJSON)((0,path_1.join)(t,"cc.config.json"))).features;return featuresWithDependencies.length=0,preloadAssets.length=0,traversalDependencies(e,s),Array.from(new Set(preloadAssets))}async function checkEffectTextureMipmap(e,t){try{if("cc.Material"===e.type){const t=await asset_library_1.buildAssetLibrary.getInstance(e);if(t.effectAsset&&t.effectAsset._uuid){const e=await asset_library_1.buildAssetLibrary.getInstance(asset_library_1.buildAssetLibrary.getAssetInfo(t.effectAsset._uuid));e.techniques[t._techIdx].passes.forEach(async(s,i)=>{if(s.properties&&s.properties.mainTexture&&s.properties.mainTexture.requireMipmaps){const s=t._props&&t._props[i];if(s.mainTexture&&s.mainTexture._uuid){const t=await asset_library_1.buildAssetLibrary.getMeta(s.mainTexture._uuid);["nearest","linear"].includes(t.userData.mipfilter)||console.warn(Editor.I18n.t("builder.warn.requireMipmaps",{effectUUID:e._uuid,textureUUID:s.mainTexture._uuid}))}}})}}}catch(e){console.debug(e)}}