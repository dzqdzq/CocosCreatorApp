"use strict";var __importDefault=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Bundle=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),utils_1=require("../../utils"),bundle_1=require("../../utils/bundle"),zip_1=require("../../utils/zip"),cconb_1=require("../../utils/cconb"),asset_db_2=require("../../../../contributions/asset-db"),globby_1=__importDefault(require("globby"));class Bundle{get scenes(){return Array.from(Object.values(this._scenes)).sort()}get assets(){return Array.from(this._assets).sort()}get assetsWithoutRedirect(){return this.assets.filter(s=>!this.getRedirect(s))}get scripts(){return Array.from(this._scripts).sort()}get rootAssets(){return Array.from(this._rootAssets)}get isSubpackage(){return this.compressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE}root="";dest="";importBase=Build.IMPORT_HEADER;nativeBase=Build.NATIVE_HEADER;scriptDest="";name="";priority=0;compressionType=bundle_utils_1.BundleCompressionTypes.MERGE_DEP;assetVer={import:{},native:{}};zipVer="";version="";isRemote=!1;isZip=!1;redirect={};deps=new Set;groups=[];bundleFilterConfig;output;hasPreloadScript=!0;extensionMap={};packs={};paths={};md5Cache=!1;debug=!1;config={importBase:Build.IMPORT_HEADER,nativeBase:Build.NATIVE_HEADER,name:"",deps:[],uuids:[],paths:{},scenes:{},packs:{},versions:{import:[],native:[]},redirect:[],debug:!1,extensionMap:{},hasPreloadScript:!0,dependencyRelationships:{}};configOutPutName="";atlasRes={assetsToImage:{},imageToAtlas:{},atlasToImages:{}};compressRes={};_rootAssets=new Set;_scenes={};_scripts=new Set;_assets=new Set;compressTask={};_jsonAsset=new Set;_cconAsset=new Set;_pacAssets=new Set;constructor(s){this.root=s.root,this.name=s.name,this.dest=s.dest,this.md5Cache=s.md5Cache,this.debug=s.debug,this.priority=s.priority,this.compressionType=s.compressionType,this.isRemote=s.isRemote,this.scriptDest=s.scriptDest,this.bundleFilterConfig=(0,asset_db_2.initBundleConfig)(s.bundleFilterConfig),this.output=s.output??!0}addRootAsset(s){s&&(0,utils_1.recursively)(s,s=>{"cc.Script"===asset_library_1.buildAssetLibrary.getAssetProperty(s,"type")?this.addScript(s):s.meta?.files&&!s.meta.files.includes(".json")&&!(0,cconb_1.hasCCONFormatAssetInLibrary)(s)||((0,bundle_1.checkAssetWithFilterConfig)(s,this.bundleFilterConfig)?(this._rootAssets.add(s.uuid),this.addAsset(s)):console.debug(`asset {asset(${s.url})} can not match the bundler filter config(${this.name})`))})}addScript(s){!s||this._scripts.has(s.uuid)||s.url.toLowerCase().endsWith(".d.ts")||s.meta.userData.isPlugin||this._scripts.add(s.uuid)}addAsset(s){if(s&&!this._assets.has(s.uuid))switch(s.meta.files.includes(".json")&&this._jsonAsset.add(s.uuid),(0,cconb_1.hasCCONFormatAssetInLibrary)(s)&&this._cconAsset.add(s.uuid),asset_library_1.buildAssetLibrary.getAssetProperty(s,"type")){case"cc.Script":return void this.addScript(s);case"cc.SceneAsset":return this._scenes[s.uuid]={uuid:s.uuid,url:s.url},void this._assets.add(s.uuid);default:this._assets.add(s.uuid)}}removeAsset(s){s&&(this._assets.delete(s),this._rootAssets.delete(s),delete this._scenes[s],this._jsonAsset.delete(s),this._scripts.delete(s),delete this.redirect[s],this.removeFromGroups(s),delete this.compressTask[s],delete this.compressRes[s])}addRedirect(s,t){s&&(this.redirect[s]=t,this.deps.add(t),this.addAssetWithUuid(s))}addScriptWithUuid(s){this._scripts.add(s)}addAssetWithUuid(s){this._assets.add(s)}getRedirect(s){return this.redirect[s]}addGroup(s,t,e=""){this.groups.push({type:s,uuids:t,name:e})}addToGroup(t,s){var e=this.groups.find(s=>s.type===t);e?e.uuids.push(s):this.addGroup(t,[s])}removeFromGroups(t){this.groups.forEach(s=>{cc.js.array.fastRemove(s.uuids,t)}),this.groups=this.groups.filter(s=>1<s.uuids.length)}initConfig(){this.config.importBase=this.importBase,this.config.nativeBase=this.nativeBase,this.config.name=this.name,this.config.debug=this.debug,this.config.hasPreloadScript=this.hasPreloadScript,this.config.deps=Array.from(this.deps).sort(),this.config.uuids=this.assets.sort();var s=this.config.redirect=[];for(const t of Object.keys(this.redirect).sort())s.push(t,String(this.config.deps.indexOf(this.redirect[t])));this.scenes.forEach(s=>{this.config.scenes[s.url]=s.uuid})}async initAssetPaths(){const n={};this.rootAssets.forEach(s=>{var t,e,s=asset_library_1.buildAssetLibrary.getAssetInfo(s),i=[s.path.replace(this.root+"/","").replace((0,path_1.extname)(s.url),""),s.type];{var r,a,o;this.name!==bundle_utils_1.BuiltinBundleName.INTERNAL&&(r=s.uuid,a=i[0],o=i[1],n[a]||(n[a]={}),n[a][o]||(n[a][o]=r),(o=n[a][o])!==r)&&(t=asset_library_1.buildAssetLibrary.getAsset(o),e=asset_library_1.buildAssetLibrary.getAsset(r),console.warn(Editor.I18n.t("builder.warn.same_load_url",{urlA:`{asset(${t.url})} uuid: `+o,urlB:`{asset(${e.url})} uuid: `+r,url:a})))}s instanceof asset_db_1.Asset||i.push(1),this.config.paths[s.uuid]=i})}async outputConfigs(){if(this.output){this.isZip&&(this.config.isZip=!0,this.config.zipVersion=this.zipVer),console.debug("output config of bundle "+this.name);let s=(0,path_1.join)(this.dest,(this.configOutPutName||(0,path_1.parse)(Build.CONFIG_NAME).name)+".json");this.version&&(s=(0,path_1.join)(this.dest,`${this.configOutPutName||(0,path_1.parse)(Build.CONFIG_NAME).name}.${this.version}.json`));var t=JSON.stringify(this.config,null,this.config.debug?4:0);(0,fs_extra_1.outputFileSync)(s,t,"utf8"),console.debug(`output config of bundle ${this.name} success`)}}async build(){await this.initConfig(),await this.genPackedAssetsConfig(),this.md5Cache?(await this.createAssetsMd5(),await this.compress(),await this.zipBundle(),await this.md5Bundle()):(await this.compress(),await this.zipBundle()),await this.outputConfigs()}async md5Bundle(){var s,t;this.md5Cache&&(t=(0,utils_1.calcMd5)([JSON.stringify(this.config),(0,fs_extra_1.readFileSync)(this.scriptDest)]),this.isSubpackage||(s=(0,path_1.join)((0,path_1.dirname)(this.scriptDest),(0,path_1.parse)(this.scriptDest).name+"."+t+(0,path_1.extname)(this.scriptDest)),(0,fs_extra_1.renameSync)(this.scriptDest,s),this.scriptDest=s),this.version=t,this.isZip)&&(s=(0,path_1.join)(this.dest,Build.BUNDLE_ZIP_NAME),(0,fs_extra_1.existsSync)(s))&&(t=await Build.Utils.appendMd5ToPaths([s]))&&(this.zipVer=t.hash)}async createAssetsMd5(){if(this.md5Cache&&!this.isZip&&(this.assetVer.import={},this.assetVer.native={},this.assets.length)){console.debug(`add md5 to bundle ${this.name}...`);var t={native:{},import:{}},e=[],i=await(0,globby_1.default)((0,path_1.join)(this.dest,this.importBase,"**"),{onlyFiles:!0});for(let s=0;s<i.length;s++){var r=i[s],a=(0,utils_1.getUuidFromPath)(r);t.import[a]||(t.import[a]=[]),t.import[a].push(r)}var o=await(0,globby_1.default)((0,path_1.join)(this.dest,this.nativeBase,"**"),{onlyFiles:!0});for(let s=0;s<o.length;s++){var n=o[s],u=(0,utils_1.getUuidFromPath)(n);t.native[u]||(t.native[u]=[]),(0,path_1.basename)((0,path_1.dirname)(n))===u?e.push(n):t.native[u].push(n)}for(const l in t.import){var s=await Build.Utils.appendMd5ToPaths(t.import[l]);s&&(this.assetVer.import[l]=s.hash)}for(const f in t.native){var h=await(0,utils_1.appendMd5ToPaths)(t.native[f]);h&&(this.assetVer.native[f]=h.hash)}for(let s=0;s<e.length;s++){var d=e[s];try{var c=(0,utils_1.calcMd5)((0,fs_extra_1.readFileSync)(d)),p=(0,utils_1.getUuidFromPath)(d);(0,fs_extra_1.renameSync)((0,path_1.dirname)(d),(0,path_1.dirname)(d)+"."+c),this.assetVer.native[p]=c}catch(s){console.error(s)}}for(const _ of Object.keys(this.assetVer.import).sort())this.config.uuids.includes(_)||(console.error(`Can not find import asset(${_}) in bundle ${this.root}.`),this.config.uuids.push(_)),this.config.versions.import.push(_,this.assetVer.import[_]);for(const g of Object.keys(this.assetVer.native).sort())this.config.uuids.includes(g)||(console.error(`Can not find native asset(${g}) in bundle ${this.root}.`),this.config.uuids.push(g)),this.config.versions.native.push(g,this.assetVer.native[g]);console.debug(`add md5 to bundle ${this.name} success`)}}async zipBundle(){var s,t;this.compressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&this.output&&(console.debug(`zip bundle ${this.name}...`),s=this.dest,0<(t=[(0,path_1.join)(s,this.nativeBase),(0,path_1.join)(s,this.importBase)].filter(s=>(0,fs_extra_1.existsSync)(s))).length&&(this.isZip=!0,await(0,zip_1.compressDirs)(t,s,(0,path_1.join)(s,Build.BUNDLE_ZIP_NAME))),console.debug(`zip bundle ${this.name} success...`))}compress(){if(!this.debug){console.debug(`compress config of bundle ${this.name}...`);var s=this.config,t=function(s){const e={},i={};function t(s){var t=(e[s]||0)+1;e[s]=t,s in i||(i[s]=s)}for(const u in s.paths)t(u);var r=s.scenes;for(const h in r)t(r[h]);for(const d in s.extensionMap)s.extensionMap[d].forEach(t);var a={};for(const c of Object.keys(s.packs).sort())s.packs[c].forEach(t),a[c]=s.packs[c];s.packs=a;var o=s.versions;for(const p of Object.values(o))for(let s=0;s<p.length;s+=2)t(p[s]);var n=s.redirect;for(let s=0;s<n.length;s+=2)t(n[s]);return s.uuids.sort((s,t)=>e[t]-e[s]),s.uuids.forEach((s,t)=>i[s]=t),s.uuids=s.uuids.map(s=>Editor.Utils.UUID.compressUUID(s,!0)),i}(s),e=s.paths,i=s.paths={},r=s.types=[];for(const b in e){var a=e[b],o=t[b];let s=r.indexOf(a[1]);-1===s&&(s=r.length,r.push(a[1])),a[1]=s,i[o]=a}var n=s.scenes;for(const v in n){var u=t[n[v]];n[v]=Number(u)}for(const y in s.extensionMap){var h=s.extensionMap[y];for(let s=0;s<h.length;++s){var d=t[h[s]];h[s]=d}h.sort()}var c=s.packs;for(const A in c){var p=c[A];for(let s=0;s<p.length;++s){var l=t[p[s]];p[s]=l}}var f=s.redirect;for(let s=0;s<f.length;s+=2){var _=t[f[s]];f[s]=Number(_)}if(!this.debug){var g=this.config.versions;for(const B of Object.values(g))for(let s=0;s<B.length;s+=2){var m=t[B[s]];B[s]=Number(m)}}console.debug(`compress config of bundle ${this.name} success`)}}async genPackedAssetsConfig(){this.config.uuids=this.assets.sort();var s=this.config.redirect=[];for(const e of Object.keys(this.redirect).sort())s.push(e,String(this.config.deps.indexOf(this.redirect[e])));Object.keys(this.config.extensionMap).forEach(s=>{this.config.extensionMap[s].sort()});const t=[];for(const i of this.groups)i.name&&0!==i.uuids.length&&(this.config.packs[i.name]=JSON.parse(JSON.stringify(i.uuids)),i.uuids.forEach(s=>{t.push(s)}));await this.initAssetPaths()}containsAsset(s,t=!1){return this._scripts.has(s)||this._assets.has(s)||!!this._scenes[s]||!!t&&!(!this.atlasRes.atlasToImages[s]||!this.atlasRes.atlasToImages[s].length)}}exports.Bundle=Bundle;