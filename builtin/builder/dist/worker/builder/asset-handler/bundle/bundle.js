"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Bundle=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library"),utils_1=require("../../utils"),bundle_1=require("../../utils/bundle"),zip_1=require("../../utils/zip"),cconb_1=require("./cconb");class Bundle{constructor(s){var t;this.pluginScript=new Set,this.root="",this.dest="",this.importBase=Build.IMPORT_HEADER,this.nativeBase=Build.NATIVE_HEADER,this.scriptDest="",this.name="",this.priority=0,this.compressionType=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,this.assetVer={import:{},native:{}},this.zipVer="",this.version="",this.isRemote=!1,this.isZip=!1,this.redirect={},this.deps=new Set,this.groups=[],this.hasPreloadScript=!0,this.extensionMap={},this.packs={},this.paths={},this.md5Cache=!1,this.debug=!1,this.config={importBase:Build.IMPORT_HEADER,nativeBase:Build.NATIVE_HEADER,name:"",deps:[],uuids:[],paths:{},scenes:{},packs:{},versions:{import:[],native:[]},redirect:[],debug:!1,extensionMap:{},hasPreloadScript:!0,dependencyRelationships:{}},this.configOutPutName="",this.atlasRes={assetsToImage:{},imageToAtlas:{},atlasToImages:{}},this.compressRes={},this._rootAssets=new Set,this._scenes={},this._scripts=new Set,this._assets=new Set,this.compressTask={},this._jsonAsset=new Set,this._cconAsset=new Set,this._pacAssets=new Set,this.root=s.root,this.name=s.name,this.dest=s.dest,this.md5Cache=s.md5Cache,this.debug=s.debug,this.priority=s.priority,this.compressionType=s.compressionType,this.isRemote=s.isRemote,this.scriptDest=s.scriptDest,this.bundleFilterConfig=s.bundleFilterConfig,this.output=null===(t=s.output)||void 0===t||t}get scenes(){return Array.from(Object.values(this._scenes)).sort()}get assets(){return Array.from(this._assets).sort()}get assetsWithoutRedirect(){return this.assets.filter(s=>!this.getRedirect(s))}get scripts(){return Array.from(this._scripts).filter(s=>!this.pluginScript.has(s)).sort()}get rootAssets(){return Array.from(this._rootAssets)}get isSubpackage(){return this.compressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE}addRootAsset(s){s&&(0,utils_1.recursively)(s,s=>{if("cc.Script"===s.type)return;(0,bundle_1.checkAssetWithFilterConfig)(s,this.bundleFilterConfig)?(this._rootAssets.add(s.uuid),this.addAsset(s)):console.debug(`asset {asset(${s.url})} can not match the bundler filter config(${this.name})`)})}addAsset(s){if(s&&!this._assets.has(s.uuid))switch(s.library[".json"]&&this._jsonAsset.add(s.uuid),(0,cconb_1.hasCCONFormatAssetInLibrary)(s)&&this._cconAsset.add(s.uuid),s.type){case"cc.Script":if(s.url.toLowerCase().endsWith(".d.ts"))return;return this._scripts.add(s.uuid),void(s.meta.userData.isPlugin&&this.pluginScript.add(s.uuid));case"cc.SceneAsset":return this._scenes[s.uuid]={uuid:s.uuid,url:s.url},void this._assets.add(s.uuid);default:this._assets.add(s.uuid)}}removeAsset(s){s&&(this._assets.delete(s),this._rootAssets.delete(s),delete this._scenes[s],this._jsonAsset.delete(s),this._scripts.delete(s),delete this.redirect[s],this.removeFromGroups(s),delete this.compressTask[s],delete this.compressRes[s])}addRedirect(s,t){s&&(this.redirect[s]=t,this.deps.add(t),this.addAssetWithUuid(s))}addScriptWithUuid(s){this._scripts.add(s)}addAssetWithUuid(s){this._assets.add(s)}getRedirect(s){return this.redirect[s]}addGroup(s,t){this.groups.push({type:s,uuids:t,name:""})}addToGroup(s,t){const e=this.groups.find(t=>t.type===s);e?e.uuids.push(t):this.addGroup(s,[t])}removeFromGroups(s){this.groups.forEach(t=>{cc.js.array.fastRemove(t.uuids,s)}),this.groups=this.groups.filter(s=>s.uuids.length>1)}initConfig(){this.config.importBase=this.importBase,this.config.nativeBase=this.nativeBase,this.config.name=this.name,this.config.debug=this.debug,this.config.hasPreloadScript=this.hasPreloadScript,this.config.deps=Array.from(this.deps).sort(),this.config.uuids=this.assets.sort();const s=this.config.redirect=[],t=Object.keys(this.redirect).sort();for(const e of t)s.push(e,String(this.config.deps.indexOf(this.redirect[e])));this.scenes.forEach(s=>{this.config.scenes[s.url]=s.uuid})}async initAssetPaths(){const s={};this.rootAssets.forEach(t=>{const e=asset_library_1.buildAssetLibrary.getAssetInfo(t),i=[e.path.replace(this.root+"/","").replace((0,path_1.extname)(e.url),""),e.type];this.name!==bundle_utils_1.BuiltinBundleName.INTERNAL&&function(t,e,i){s[e]||(s[e]={});s[e][i]||(s[e][i]=t);const n=s[e][i];if(n===t)return;const o=asset_library_1.buildAssetLibrary.getAssetInfo(n),r=asset_library_1.buildAssetLibrary.getAssetInfo(t);console.warn(Editor.I18n.t("builder.warn.same_load_url",{urlA:`{asset(${o.url})} uuid: ${n}`,urlB:`{asset(${r.url})} uuid: ${t}`,url:e}))}(e.uuid,i[0],i[1]),e.source||i.push(1),this.config.paths[e.uuid]=i});for(const s of this.assetsWithoutRedirect){const t=await asset_library_1.buildAssetLibrary.getDependUuids(s);t.length&&(this.config.dependencyRelationships[s]=t)}}async ouputConfigs(){if(!this.output)return;this.isZip&&(this.config.isZip=!0,this.config.zipVersion=this.zipVer),console.debug(`ouput config of bundle ${this.name}`);let s=(0,path_1.join)(this.dest,(this.configOutPutName||(0,path_1.parse)(Build.CONFIG_NAME).name)+".json");this.version&&(s=(0,path_1.join)(this.dest,`${this.configOutPutName||(0,path_1.parse)(Build.CONFIG_NAME).name}.${this.version}.json`));const t=JSON.stringify(this.config,null,this.config.debug?4:0);(0,fs_extra_1.outputFileSync)(s,t,"utf8"),console.debug(`output config of bundle ${this.name} success`)}async build(){await this.initConfig(),await this.genPackedAssetsConfig(),await this.createAssetsMd5(),await this.compress(),await this.createBundleVersion(),await this.zipBundle(),await this.ouputConfigs()}async createBundleVersion(){if(!this.md5Cache||this.isZip)return;const s=(0,utils_1.calcMd5)([JSON.stringify(this.config),(0,fs_extra_1.readFileSync)(this.scriptDest)]);if(!this.isSubpackage){const t=(0,path_1.join)((0,path_1.dirname)(this.scriptDest),`${(0,path_1.parse)(this.scriptDest).name}.${s}${(0,path_1.extname)(this.scriptDest)}`);(0,fs_extra_1.renameSync)(this.scriptDest,t),this.scriptDest=t}this.version=s}async createAssetsMd5(){if(!this.md5Cache||this.isZip)return;console.debug(`add md5 to bundle ${this.name}...`);const s=require("globby"),t={native:{},import:{}},e=[],i=s.sync((0,path_1.join)(this.dest,this.importBase,"**"),{nodir:!0});for(let s=0;s<i.length;s++){const e=i[s],n=(0,utils_1.getUuidFromPath)(e);t.import[n]||(t.import[n]=[]),t.import[n].push(e)}const n=s.sync((0,path_1.join)(this.dest,this.nativeBase,"**"),{nodir:!0});for(let s=0;s<n.length;s++){const i=n[s],o=(0,utils_1.getUuidFromPath)(i);t.native[o]||(t.native[o]=[]),(0,path_1.basename)((0,path_1.dirname)(i))!==o?t.native[o].push(i):e.push(i)}this.assetVer.import={},this.assetVer.native={};for(const s in t.import){const e=await Build.Utils.appendMd5ToPaths(t.import[s]);e&&(this.assetVer.import[s]=e.hash)}for(const s in t.native){const e=await(0,utils_1.appendMd5ToPaths)(t.native[s]);e&&(this.assetVer.native[s]=e.hash)}for(let s=0;s<e.length;s++){const t=e[s];try{const s=(0,utils_1.calcMd5)((0,fs_extra_1.readFileSync)(t)),e=(0,utils_1.getUuidFromPath)(t);(0,fs_extra_1.renameSync)((0,path_1.dirname)(t),(0,path_1.dirname)(t)+`.${s}`),this.assetVer.native[e]=s}catch(s){console.error(s)}}for(const s in this.assetVer.import)this.config.uuids.includes(s)||(console.error(`Can not find import asset(${s}) in bundle ${this.root}.`),this.config.uuids.push(s)),this.config.versions.import.push(s,this.assetVer.import[s]);for(const s in this.assetVer.native)this.config.uuids.includes(s)||(console.error(`Can not find native asset(${s}) in bundle ${this.root}.`),this.config.uuids.push(s)),this.config.versions.native.push(s,this.assetVer.native[s]);console.debug(`add md5 to bundle ${this.name} success`)}async zipBundle(){if(this.compressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||!this.output)return;console.debug(`zip bundle ${this.name}...`);const s=this.dest,t=[(0,path_1.join)(s,this.nativeBase),(0,path_1.join)(s,this.importBase)].filter(s=>(0,fs_extra_1.existsSync)(s));if(t.length>0&&(this.isZip=!0,await(0,zip_1.compressDirs)(t,s,(0,path_1.join)(s,Build.BUNDLE_ZIP_NAME))),this.md5Cache){const s=(0,path_1.join)(this.dest,Build.BUNDLE_ZIP_NAME);if((0,fs_extra_1.existsSync)(s)){const t=await Build.Utils.appendMd5ToPaths([s]);t&&(this.zipVer=t.hash)}}console.debug(`zip bundle ${this.name} success...`)}compress(){var s;if(this.debug)return;console.debug(`compress config of bundle ${this.name}...`);const t=this.config,e=function(s){const t={},e={};function i(s){const i=(t[s]||0)+1;t[s]=i,s in e||(e[s]=s)}const n=s.paths;for(const s in n)i(s);const o=s.scenes;for(const s in o)i(o[s]);for(const t in s.extensionMap)s.extensionMap[t].forEach(i);const r=Object.keys(s.packs).sort(),a={};for(const t of r)s.packs[t].forEach(i),a[t]=s.packs[t];s.packs=a;const h=s.versions;for(const s of Object.values(h))for(let t=0;t<s.length;t+=2)i(s[t]);const c=s.redirect;for(let s=0;s<c.length;s+=2)i(c[s]);return s.uuids.sort((s,e)=>t[e]-t[s]),s.uuids.forEach((s,t)=>e[s]=String(t)),s.uuids=s.uuids.map(s=>Editor.Utils.UUID.compressUUID(s,!0)),e}(t),i=t.paths,n=t.paths={},o=t.types=[];for(const s in i){const t=i[s],r=e[s];let a=o.indexOf(t[1]);-1===a&&(a=o.length,o.push(t[1])),t[1]=a,n[r]=t}const r={};for(const i in t.dependencyRelationships){let n=t.dependencyRelationships[i];const o=null!==(s=e[i])&&void 0!==s?s:Editor.Utils.UUID.compressUUID(i,!0);n=n.map(s=>{var t;return null!==(t=e[s])&&void 0!==t?t:Editor.Utils.UUID.compressUUID(s,!0)}),r[o]=n}t.dependencyRelationships=r;const a=t.scenes;for(const s in a){const t=a[s],i=e[t];a[s]=Number(i)}for(const s in t.extensionMap){const i=t.extensionMap[s];for(let s=0;s<i.length;++s){const t=e[i[s]];i[s]=t}i.sort()}const h=t.packs;for(const s in h){const t=h[s];for(let s=0;s<t.length;++s){const i=e[t[s]];t[s]=i}}const c=t.versions;for(const s of Object.values(c))for(let t=0;t<s.length;t+=2){const i=e[s[t]];s[t]=Number(i)}const u=t.redirect;for(let s=0;s<u.length;s+=2){const t=e[u[s]];u[s]=Number(t)}console.debug(`compress config of bundle ${this.name} success`)}async genPackedAssetsConfig(){this.config.uuids=this.assets.sort();const s=this.config.redirect=[],t=Object.keys(this.redirect).sort();for(const e of t)s.push(e,String(this.config.deps.indexOf(this.redirect[e])));Object.keys(this.config.extensionMap).forEach(s=>{this.config.extensionMap[s].sort()});const e=[];for(const s of this.groups)s.name&&0!==s.uuids.length&&(this.config.packs[s.name]=JSON.parse(JSON.stringify(s.uuids)),s.uuids.forEach(s=>{e.push(s)}));await this.initAssetPaths()}containsAsset(s,t=!1){return this._scripts.has(s)||this._assets.has(s)||!!this._scenes[s]||!!t&&!(!this.atlasRes.atlasToImages[s]||!this.atlasRes.atlasToImages[s].length)}}exports.Bundle=Bundle;