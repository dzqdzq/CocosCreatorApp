"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sortBundleInPac=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library");function sortBundleInPac(e,s,t,u,i){const{removeTextureInBundle:o,removeImageInBundle:a,removeSpriteAtlasInBundle:r}=t.packOptions;let d=null;const n=[],l=s.imageUuid,p=s.textureUuid;for(const m of e){if(!m.output)continue;const e=m.atlasRes,c=m.assetsWithoutRedirect,g=new Set(c);if(!g.has(t.uuid)&&!t.spriteFrames.find(e=>g.has(e._uuid)))continue;const _=[],I=t.path.startsWith(m.root+"/");I&&console.debug(`Asset {asset(${t.path})} is Bundle`);for(const t of s.spriteFrameInfos)m.getRedirect(t.uuid)||m.getRedirect(t.uuid)||(m.addAssetWithUuid(t.uuid),m.removeFromGroups(t.uuid),u[t.textureUuid]||!o&&I?u[t.textureUuid]&&!I&&console.warn(Editor.I18n.t("builder.tips.use_texture_in_atlas",{info:`{asset(${t.textureUuid})}`,useInfo:`{asset(${u[t.textureUuid].toString()})}`})):m.removeAsset(t.textureUuid),u[t.imageUuid]||!a&&I?u[t.imageUuid]&&!I&&console.warn(Editor.I18n.t("builder.tips.use_image_in_atlas",{info:`{asset(${t.imageUuid})}`,useInfo:`{asset(${u[t.imageUuid].toString()})}`})):(m.removeAsset(t.imageUuid),i&&i.removeTask(t.imageUuid)),_.push(t.uuid),e.assetsToImage[t.uuid]=l,e.assetsToImage[t.imageUuid]=l);if(d&&d.priority!==m.priority)m.addRedirect(p,d.name);else{m.addAssetWithUuid(l),m.addAssetWithUuid(p),m.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?m.groups[0]?m.groups[0].uuids.push(l,p):m.addGroup("NORMAL",[l,p]):m.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&(m.addToGroup("IMAGE",l),m.addToGroup("TEXTURE",p));const e=(0,path_1.join)(m.dest,m.nativeBase,l.slice(0,2),l+(0,path_1.extname)(s.imagePath));(0,fs_extra_1.copySync)(s.imagePath,e);const u=asset_library_1.buildAssetLibrary.getAssetInfo(t.uuid);if(u.meta.userData.compressSettings&&i){const t=i.genTaskInfoFromAssetInfo(u);t&&(m.compressTask[s.imageUuid]=i.addTask(s.imageUuid,Object.assign(Object.assign({},t),{src:e})))}d?n.push(m.root):d=m}const T=[..._];u[t.uuid]||I&&!r?(u[t.uuid]||I)&&T.push(t.uuid):(m.removeAsset(t.uuid),console.debug(`remove spriteAtlas._uuid : {asset(${t.uuid})}`)),m.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?m.groups[0]?m.groups[0].uuids.push(...T):m.addGroup("NORMAL",T):m.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&m.addGroup("NORMAL",T),e.imageToAtlas[l]=t.uuid,e.assetsToImage[p]=l,e.atlasToImages[t.uuid]||(e.atlasToImages[t.uuid]=[]),e.atlasToImages[t.uuid].push(l)}d&&n.length&&console.warn(Editor.I18n.t("builder.warn.repeatAtlasInBundle",{imageUuid:l,bundle1:d.root,bundle2:n.toString()}))}exports.sortBundleInPac=sortBundleInPac;