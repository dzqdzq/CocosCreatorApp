"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sortBundleInPac=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library");function sortBundleInPac(e,s,t,u,i){var{removeTextureInBundle:a,removeImageInBundle:r,removeSpriteAtlasInBundle:o}=t.packOptions;let d=null;var n=[],l=s.imageUuid,p=s.textureUuid;for(const h of e)if(h.output){var m=h.atlasRes,g=h.assetsWithoutRedirect;const T=new Set(g);if(T.has(t.uuid)||t.spriteFrames.find(e=>T.has(e._uuid))){var _=[],c=t.path.startsWith(h.root+"/");c&&console.debug(`Asset {asset(${t.path})} is Bundle`);for(const I of s.spriteFrameInfos)h.getRedirect(I.uuid)||(h.addAssetWithUuid(I.uuid),h.removeFromGroups(I.uuid),u[I.textureUuid]||!a&&c?u[I.textureUuid]&&!c&&console.warn(Editor.I18n.t("builder.tips.use_texture_in_atlas",{info:`{asset(${I.textureUuid})}`,useInfo:`{asset(${u[I.textureUuid].toString()})}`})):h.removeAsset(I.textureUuid),u[I.imageUuid]||!r&&c||u[I.textureUuid]?u[I.imageUuid]&&!c&&console.warn(Editor.I18n.t("builder.tips.use_image_in_atlas",{info:`{asset(${I.imageUuid})}`,useInfo:`{asset(${u[I.imageUuid].toString()})}`})):(h.removeAsset(I.imageUuid),i&&i.removeTask(I.imageUuid)),_.push(I.uuid),m.assetsToImage[I.uuid]=l,m.assetsToImage[I.imageUuid]=l);if(d&&d.priority!==h.priority)h.addRedirect(p,d.name);else{h.addAssetWithUuid(l),h.addAssetWithUuid(p),h.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?h.groups[0]?h.groups[0].uuids.push(l,p):h.addGroup("NORMAL",[l,p]):h.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&(h.addToGroup("IMAGE",l),h.addToGroup("TEXTURE",p));var g=asset_library_1.buildAssetLibrary.getAsset(t.uuid);let e=null;g.meta.userData.compressSettings&&i&&(e=i.genTaskInfoFromAssetInfo(g))&&(e.mtime=(0,fs_extra_1.statSync)(s.imagePath).mtime.getTime(),h.compressTask[s.imageUuid]=i.addTask(s.imageUuid,Object.assign(Object.assign({},e),{src:s.imagePath}))),e||(g=(0,path_1.join)(h.dest,h.nativeBase,l.slice(0,2),l+(0,path_1.extname)(s.imagePath)),(0,fs_extra_1.copySync)(s.imagePath,g)),d?n.push(h.root):d=h}g=[..._];u[t.uuid]||c&&!o?(u[t.uuid]||c)&&g.push(t.uuid):(h.removeAsset(t.uuid),console.debug(`remove spriteAtlas._uuid : {asset(${t.uuid})}`)),h.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?h.groups[0]?h.groups[0].uuids.push(...g):h.addGroup("NORMAL",g):h.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&h.addGroup("NORMAL",g),m.imageToAtlas[l]=t.uuid,m.assetsToImage[p]=l,m.atlasToImages[t.uuid]||(m.atlasToImages[t.uuid]=[]),m.atlasToImages[t.uuid].push(l)}}d&&n.length&&console.warn(Editor.I18n.t("builder.warn.repeatAtlasInBundle",{imageUuid:l,bundle1:d.root,bundle2:n.toString()}))}exports.sortBundleInPac=sortBundleInPac;