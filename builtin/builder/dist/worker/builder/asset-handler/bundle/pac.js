"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sortBundleInPac=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),bundle_utils_1=require("../../../../share/bundle-utils"),asset_library_1=require("../../manager/asset-library");function sortBundleInPac(e,s,t,u,i){const{removeTextureInBundle:o,removeImageInBundle:a,removeSpriteAtlasInBundle:r}=t.packOptions;let d=null;const n=s.imageUuid,p=s.textureUuid;for(const l of e){if(!l.output)continue;const e=l.atlasRes,m=l.assetsWithoutRedirect,c=new Set(m);if(!c.has(t.uuid)&&!t.spriteFrames.find(e=>c.has(e._uuid)))continue;const g=[],_=t.path.startsWith(l.root+"/");_&&console.debug(`Asset {asset(${t.path})} is Bundle`);for(const t of s.spriteFrameInfos)l.getRedirect(t.uuid)||l.getRedirect(t.uuid)||(l.addAssetWithUuid(t.uuid),l.removeFromGroups(t.uuid),u[t.textureUuid]||!o&&_?u[t.textureUuid]&&!_&&console.warn(Editor.I18n.t("builder.tips.use_texture_in_atlas",{info:`{asset(${t.textureUuid})}`,useInfo:`{asset(${u[t.textureUuid].toString()})}`})):l.removeAsset(t.textureUuid),u[t.imageUuid]||!a&&_?u[t.imageUuid]&&!_&&console.warn(Editor.I18n.t("builder.tips.use_image_in_atlas",{info:`{asset(${t.imageUuid})}`,useInfo:`{asset(${u[t.imageUuid].toString()})}`})):l.removeAsset(t.imageUuid),g.push(t.uuid),e.assetsToImage[t.uuid]=n,e.assetsToImage[t.imageUuid]=n);if(d&&d.priority!==l.priority)l.addRedirect(p,d.name);else{l.addAssetWithUuid(n),l.addAssetWithUuid(p),l.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?l.groups[0]?l.groups[0].uuids.push(n,p):l.addGroup("NORMAL",[n,p]):l.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&(l.addToGroup("IMAGE",n),l.addToGroup("TEXTURE",p));const e=asset_library_1.buildAssetLibrary.getAssetInfo(t.uuid);if(e.meta.userData.compressSettings&&i){const t=i.genTaskInfoFromAssetInfo(e);t&&(l.compressTask[s.imageUuid]=i.addTask(s.imageUuid,Object.assign(Object.assign({},t),{src:s.imagePath})))}const u=(0,path_1.join)(n.slice(0,2),n+(0,path_1.extname)(s.imagePath));(0,fs_extra_1.copySync)(s.imagePath,(0,path_1.join)(l.dest,l.nativeBase,u)),d||(d=l)}const h=[...g];u[t.uuid]||_&&!r?(u[t.uuid]||_)&&h.push(t.uuid):(l.removeAsset(t.uuid),console.debug(`remove spriteAtlas._uuid : {asset(${t.uuid})}`)),l.compressionType===bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON?l.groups[0]?l.groups[0].uuids.push(...h):l.addGroup("NORMAL",h):l.compressionType!==bundle_utils_1.BundleCompressionTypes.NONE&&l.addGroup("NORMAL",h),e.imageToAtlas[n]=t.uuid,e.assetsToImage[p]=n,e.atlasToImages[t.uuid]||(e.atlasToImages[t.uuid]=[]),e.atlasToImages[t.uuid].push(n)}}exports.sortBundleInPac=sortBundleInPac;