"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPowerOfTwo=isPowerOfTwo,exports.getMipLevel=getMipLevel,exports.genMipmapFiles=genMipmapFiles,exports.checkHasMipMaps=checkHasMipMaps,exports.compressMipmapFiles=compressMipmapFiles;const path_1=require("path"),fs_extra_1=require("fs-extra"),Sharp=require("sharp");function isPowerOfTwo(e){return 0<e&&0==(e&e-1)}function getMipLevel(e,t){let a=Math.max(e,t),i=0;for(;a;)a>>=1,i++;return i}async function genMipmapFiles(e,t,a){var i=Sharp(e),r=await i.metadata();if(!isPowerOfTwo(r.width)||!isPowerOfTwo(r.height))throw new Error(Editor.I18n.t("builder.project.texture_compress.mipmap.noPowerOfTwo"));let s=r.width,p=r.height;t=t||(0,path_1.dirname)(e);var n=(0,path_1.extname)(e),o=(0,path_1.basename)(e,n),m=[];for(let e=getMipLevel(s,p);0<e&&(1!==s||1!==p);e--){s=Math.max(s/2,1),p=Math.max(p/2,1);var u=(0,path_1.join)(t,"mipmaps",o+"@mipmap_"+(e-1)+n);m.push(u),(0,fs_extra_1.existsSync)(u)||((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(u)),await i.resize(s,p).toFile(u))}return m}function checkHasMipMaps(e){let t;return e.subMetas["6c48a"]?t=e.subMetas["6c48a"].userData.mipfilter:e.userData.textureSetting&&(t=e.userData.textureSetting.mipfilter),!!["nearest","linear"].includes(t)}async function compressMipmapFiles(t,a){if(!t.mipmapFiles||!t.mipmapFiles.length||["png","jpg","webp"].includes(t.format))return[];console.debug("Start merge mipmaps file of asset "+t.uuid);var i=[];for(let e=0;e<t.mipmapFiles.length;e++){var r=t.mipmapFiles[e],s=(0,path_1.join)((0,path_1.dirname)(t.dest),"mipmaps",(0,path_1.basename)(r,(0,path_1.extname)(r))+(0,path_1.extname)(t.dest));await a({...t,src:r,dest:s}),i.push((0,fs_extra_1.readFileSync)(s))}return console.debug(`Merge mipmaps file of asset ${t.uuid} success`),i}