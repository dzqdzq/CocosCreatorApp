"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var o=Object.getOwnPropertyDescriptor(e,s);o&&("get"in o?e.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,o)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressCustomFormat=exports.getCompressFunc=exports.compressAstc=exports.compressEtc=exports.compressPVR=exports.compressWebp=exports.compressJpgAndPng=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),fs_extra_2=require("fs-extra"),Path=__importStar(require("path")),utils_1=require("./utils"),utils_2=require("../../utils"),Sharp=require("sharp");async function compressJpgAndPng(t){return new Promise((e,s)=>{let r=Sharp(t.src);r="png"===t.format?r.png({quality:t.compressOptions.quality||100}):r.jpeg({quality:t.compressOptions.quality||100}),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(t.dest)),r.toFile(t.dest).then(()=>{e()}).catch(t=>{s(t)})})}async function compressWebp(t){const{src:e,dest:s,format:r,compressOptions:o}=t;(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s)),console.debug("start compress webp",e,s,r);let c=Path.join(Editor.App.path,"../tools/libwebp_darwin/bin/cwebp");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/libwebp_win32/bin/cwebp.exe"));const a=[e,"-o",s,"-q",String(o.quality),"-quiet","-exact"];console.debug(`webp compress command : ${c} ${a.join(" ")}`),await(0,utils_2.quickSpawn)(c,a,{prefix:"[compress webp]"}),console.log("compress webp success "+`{link(${s})}`)}async function compressPVR(t){if(console.debug("start compress pvr",t),t.format.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t.src),s=Path.join(Editor.Project.path,"temp","CompressTexture","pvr_alpha",e);await createAlphaAtlas(t.src,s),t.src=s}const{src:e,dest:s,format:r,compressOptions:o}=t;(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s));let c=Path.join(Editor.App.path,"../tools/PVRTexTool_darwin/PVRTexToolCLI");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/PVRTexTool_win32/PVRTexToolCLI.exe"));const a={pvrtc_4bits_rgba:"PVRTC1_4",pvrtc_4bits_rgb:"PVRTC1_4_RGB",pvrtc_4bits_rgb_a:"PVRTC1_4_RGB",pvrtc_2bits_rgba:"PVRTC1_2",pvrtc_2bits_rgb:"PVRTC1_2_RGB",pvrtc_2bits_rgb_a:"PVRTC1_2_RGB"}[r],n=["-i",e,"-o",s,"-squarecanvas","+","-potcanvas","+","-q","pvrtc"+o.quality,"-f",`${a},UBN,lRGB`];console.debug(`pvrtc compress command :  ${c} ${n.join(" ")}`),await(0,utils_2.quickSpawn)(c,n,{downGradeWaring:!0,downGradeLog:!0,ignoreError:!0,downGradeError:!0,prefix:"[compress pvrtc]"}),(0,fs_extra_1.existsSync)(s)?console.log("compress pvrtc success "+`{link(${s})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:r,asset:`{asset(${Build.Utils.getUuidFromPath(t.src)})}`,toolsPath:`{file(${c})}`,toolHomePage:"https://developer.imaginationtech.com/pvrtextool/"}))}async function compressEtc(t){const{dest:e,format:s,compressOptions:r}=t;if(console.debug("start compress etc",t.src,e,s),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(e)),s.endsWith("rgb_a")){const e=Path.relative(Editor.Project.path,t.src),s=Path.join(Editor.Project.path,"temp","CompressTexture","etc_alpha",e);await createAlphaAtlas(t.src,s),t.src=s}let o=Path.join(Editor.App.path,"../tools/mali_darwin/etcpack");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/mali_win32/etcpack.exe"));const c=Path.dirname(o);o="."+Path.sep+Path.basename(o);const{etcFormat:a,compressFormat:n}={etc1_rgb:{etcFormat:"etc1",compressFormat:"RGB"},etc1_rgb_a:{etcFormat:"etc1",compressFormat:"RGB"},etc2_rgba:{etcFormat:"etc2",compressFormat:"RGBA"},etc2_rgb:{etcFormat:"etc2",compressFormat:"RGB"}}[s],i=[Path.normalize(t.src),Path.dirname(e),"-c",a,"-s",r.quality],p=c,m=Object.assign({},process.env);m.PATH=c+":"+m.PATH;const l={cwd:p,env:m,prefix:"[compress etc]"};"etc2"===a&&i.push("-f",n),console.debug(`etc compress command :  ${o} ${i.join(" ")}`),await(0,utils_2.quickSpawn)(o,i,l),(0,fs_extra_1.existsSync)(e)?console.log("compress etc success "+`{link(${e})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:s,asset:`{asset(${Build.Utils.getUuidFromPath(t.src)})}`,toolsPath:`{file(${o})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}async function compressAstc(t){const{src:e,dest:s,format:r,compressOptions:o}=t;console.debug("start compress astc",e,s,r),(0,fs_extra_2.ensureDirSync)((0,path_1.dirname)(s));let c=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc");"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc.exe"));const a={astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[r];"veryfast"===o.quality&&(o.quality="fastest");const n=["-cl",e,s,a,`-${o.quality}`];console.debug(`astc compressed command: ${Path.basename(c)} ${n.join(" ")}`),await(0,utils_2.quickSpawn)(c,n,{prefix:"[compress astc]"}),(0,fs_extra_1.existsSync)(s)?console.log("Compress astc success "+`{link(${s})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:r,asset:`{asset(${Build.Utils.getUuidFromPath(e)})}`,toolsPath:`{file(${c})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}function getCompressFunc(t){switch(t.slice(0,3)){case"jpg":case"png":return compressJpgAndPng;case"pvr":return compressPVR;case"etc":return compressEtc;case"web":return compressWebp;case"ast":return compressAstc}}function patchCommand(t,e){return new Function("options","with(options){ return String.raw`"+t+"`}")(e)}async function compressCustomFormat(t){const{src:e,dest:s,compressOptions:r}=t,{command:o,path:c}=t.customConfig,a=Editor.UI.__protected__.File.resolveToRaw(c),n={cwd:Path.dirname(a),prefix:"[custom compress]"},i=patchCommand(o,Object.assign(Object.assign({},r),{src:e,dest:s})),p=i.split(" ").filter(t=>!!t);console.debug(`custom compress command : ${a} ${i}`),await(0,utils_2.quickSpawn)(a,p,n)}async function createAlphaAtlas(t,e){const s=new Sharp(t),r=await s.metadata(),o=r.width,c=r.height,a=(0,utils_1.roundToPowerOfTwo)(o);let n=(0,utils_1.roundToPowerOfTwo)(c);n<a/2&&(n=a/2);const i=await s.raw().toBuffer(),p=2*o*n*3,m=Buffer.alloc(p,0);let l,u;for(let t=0;t<c;t++)for(let e=0;e<o;e++){const s=t*o+e,r=4*s;m[l=3*s]=i[r],m[l+1]=i[r+1],m[l+2]=i[r+2];const c=r+3;m[u=3*((t+n)*o+e)]=i[c],m[u+1]=i[c],m[u+2]=i[c]}const _={raw:{width:o,height:2*n,channels:3}};(0,fs_extra_2.ensureDirSync)(Path.dirname(e)),await Sharp(m,_).toFile(e)}exports.compressJpgAndPng=compressJpgAndPng,exports.compressWebp=compressWebp,exports.compressPVR=compressPVR,exports.compressEtc=compressEtc,exports.compressAstc=compressAstc,exports.getCompressFunc=getCompressFunc,exports.compressCustomFormat=compressCustomFormat;