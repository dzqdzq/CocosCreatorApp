"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,o)}:function(e,t,r,s){e[s=void 0===s?r:s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var o=function(e){return(o=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=o(e),s=0;s<r.length;s++)"default"!==r[s]&&__createBinding(t,e,r[s]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.compressJpgAndPng=compressJpgAndPng,exports.compressWebp=compressWebp,exports.compressPVR=compressPVR,exports.compressEtc=compressEtc,exports.compressAstc=compressAstc,exports.getCompressFunc=getCompressFunc,exports.compressCustomFormat=compressCustomFormat;const fs_extra_1=require("fs-extra"),path_1=require("path"),Path=__importStar(require("path")),utils_1=require("./utils"),utils_2=require("../../utils"),Sharp=require("sharp");async function compressJpgAndPng(s){return new Promise((e,t)=>{let r=Sharp(s.src);r="png"===s.format?r.png({quality:s.compressOptions.quality||100}):r.jpeg({quality:s.compressOptions.quality||100}),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(s.dest)),r.toFile(s.dest).then(()=>{e()}).catch(e=>{t(e)})})}async function compressWebp(e){var{src:e,dest:t,format:r,compressOptions:s}=e;(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(t)),console.debug("start compress webp",e,t,r);let o=Path.join(Editor.App.path,"../tools/libwebp_darwin/bin/cwebp");"win32"===process.platform&&(o=Path.join(Editor.App.path,"../tools/libwebp_win32/bin/cwebp.exe"));r=[e,"-o",t,"-q",String(s.quality),"-quiet","-exact"];console.debug(`webp compress command : ${o} `+r.join(" ")),await(0,utils_2.quickSpawn)(o,r,{prefix:"[compress webp]"}),console.log("compress webp success "+`{link(${t})}`)}async function compressPVR(e){console.debug("start compress pvr",e);let t=e.src;e.format.endsWith("rgb_a")&&(r=Path.join(Editor.Project.tmpDir,"builder","CompressTexture","pvr_alpha",e.uuid+Path.extname(t)),await createAlphaAtlas(t,r),t=r);var{dest:r,format:s,compressOptions:o}=e;(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r));let a=Path.join(Editor.App.path,"../tools/PVRTexTool_darwin/PVRTexToolCLI");"win32"===process.platform&&(a=Path.join(Editor.App.path,"../tools/PVRTexTool_win32/PVRTexToolCLI.exe"));var c={pvrtc_4bits_rgba:"PVRTC1_4",pvrtc_4bits_rgb:"PVRTC1_4_RGB",pvrtc_4bits_rgb_a:"PVRTC1_4_RGB",pvrtc_2bits_rgba:"PVRTC1_2",pvrtc_2bits_rgb:"PVRTC1_2_RGB",pvrtc_2bits_rgb_a:"PVRTC1_2_RGB"}[s];c?(o="pvrtc"+o.quality,o=["-i",t,"-o",r,"-squarecanvas","+","-potcanvas","+","-q",o,"-f",c+",UBN,lRGB"],console.debug(`pvrtc compress command :  ${a} `+o.join(" ")),await(0,utils_2.quickSpawn)(a,o,{downGradeWaring:!0,downGradeLog:!0,ignoreError:!0,downGradeError:!0,prefix:"[compress pvrtc]"}),(0,fs_extra_1.existsSync)(r)?console.log("compress pvrtc success "+`{link(${r})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:s,asset:`{asset(${e.uuid})}`,toolsPath:`{file(${a})}`,toolHomePage:"https://developer.imaginationtech.com/pvrtextool/"}))):console.error("Invalid pvr compress format "+s)}async function compressEtc(e){var{dest:t,format:r,compressOptions:s,uuid:o}=e;console.debug("start compress etc",e.src,t,r);let a=e.src,c=((0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(t)),r.endsWith("rgb_a")&&(e=Path.join(Editor.Project.tmpDir,"builder","CompressTexture","etc_alpha",o,Path.basename(t,Path.extname(t))+Path.extname(a)),await createAlphaAtlas(a,e),a=e),Path.join(Editor.App.path,"../tools/mali_darwin/etcpack"));"win32"===process.platform&&(c=Path.join(Editor.App.path,"../tools/mali_win32/etcpack.exe"));var e=Path.dirname(c),{etcFormat:n,compressFormat:i}=(c="."+Path.sep+Path.basename(c),{etc1_rgb:{etcFormat:"etc1",compressFormat:"RGB"},etc1_rgb_a:{etcFormat:"etc1",compressFormat:"RGB"},etc2_rgba:{etcFormat:"etc2",compressFormat:"RGBA"},etc2_rgb:{etcFormat:"etc2",compressFormat:"RGB"}}[r]),s=[Path.normalize(a),Path.dirname(t),"-c",n,"-s",s.quality],p=e,m=Object.assign({},process.env),e=(m.PATH=e+":"+m.PATH,{cwd:p,env:m,prefix:"[compress etc]"});"etc2"===n&&s.push("-f",i),console.debug(`etc compress command :  ${c} `+s.join(" ")),await(0,utils_2.quickSpawn)(c,s,e),(0,fs_extra_1.existsSync)(t)?console.log("compress etc success "+`{link(${t})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:r,asset:`{asset(${o})}`,toolsPath:`{file(${c})}`,toolHomePage:"https://imagemagick.org/script/command-line-processing.php"}))}async function compressAstc(e){var{src:t,dest:r,format:s,compressOptions:o}=e;console.debug("start compress astc",t,r,s),(0,fs_extra_1.ensureDirSync)((0,path_1.dirname)(r));let a=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc");"win32"===process.platform&&(a=Path.join(Editor.App.path,"../tools/astc-encoder/astcenc.exe"));var c={astc_4x4:"4x4",astc_5x5:"5x5",astc_6x6:"6x6",astc_8x8:"8x8",astc_10x5:"10x5",astc_10x10:"10x10",astc_12x12:"12x12"}[s],t=("veryfast"===o.quality&&(o.quality="fastest"),["-cl",t,r,c,"-"+o.quality]);console.debug(`astc compressed command: ${Path.basename(a)} `+t.join(" ")),await(0,utils_2.quickSpawn)(a,t,{prefix:"[compress astc]"}),(0,fs_extra_1.existsSync)(r)?console.log("Compress astc success "+`{link(${r})}`):console.error(Editor.I18n.t("builder.error.texture_compress_failed",{type:s,asset:`{asset(${e.uuid})}`,toolsPath:`{file(${a})}`,toolHomePage:"https://github.com/ARM-software/astc-encoder"}))}function getCompressFunc(e){switch(e.slice(0,3)){case"jpg":case"png":return compressJpgAndPng;case"pvr":return compressPVR;case"etc":return compressEtc;case"web":return compressWebp;case"ast":return compressAstc}}function patchCommand(e,t){return new Function("options","with(options){ return String.raw`"+e+"`}")(t)}async function compressCustomFormat(e){var{src:t,dest:r,compressOptions:s}=e,{command:e,path:o}=e.customConfig,o=Editor.UI.__protected__.File.resolveToRaw(o),a={cwd:Path.dirname(o),prefix:"[custom compress]"},e=patchCommand(e,{...s,src:t,dest:r}),s=e.split(" ").filter(e=>!!e);console.debug(`custom compress command : ${o} `+e),await(0,utils_2.quickSpawn)(o,s,a)}async function createAlphaAtlas(e,t){var e=new Sharp(e),r=await e.metadata(),s=r.width,o=r.height,r=(0,utils_1.roundToPowerOfTwo)(s);let a=(0,utils_1.roundToPowerOfTwo)(o);a<r/2&&(a=r/2);var c=await e.raw().toBuffer(),r=2*s*a*3,n=Buffer.alloc(r,0);for(let t=0;t<o;t++)for(let e=0;e<s;e++){var i=t*s+e,p=4*i;n[i=3*i]=c[p],n[1+i]=c[1+p],n[2+i]=c[2+p];i=3+p;n[p=3*((t+a)*s+e)]=c[i],n[1+p]=c[i],n[2+p]=c[i]}e={raw:{width:s,height:2*a,channels:3}};(0,fs_extra_1.ensureDirSync)(Path.dirname(t)),await Sharp(n,e).toFile(t)}