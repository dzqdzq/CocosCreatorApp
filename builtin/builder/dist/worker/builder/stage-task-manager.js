"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildStageTask=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),console_1=require("./utils/console"),utils_1=require("./utils"),tempDir=(0,path_1.join)(Editor.Project.tmpDir,"builder","compile");class BuildStageTask extends events_1.EventEmitter{constructor(t){super(),this.taskInfo={},this.progress=0,this.logDest="",this.name=t.name,this.hooksInfo=t.hooksInfo,this.root=t.root,t.buildTaskOptions&&(this.options=t.buildTaskOptions),this.taskInfo={[`onBefore${this.name}`]:.2,[this.name]:.2,[`onAfter${this.name}`]:.2}}init(){this.logDest=(0,path_1.join)(Build.projectTempDir,this.name,(0,path_1.basename)(this.root)+".log"),(0,fs_extra_1.outputFileSync)(this.logDest,""),this.console=new console_1.MessageConsole((t,s)=>{if(!t||!s)return;let e=`${(0,utils_1.getCurrentTime)()}-${t}:[${this.name}]`;try{Array.isArray(s)?s.forEach(t=>{e+=`${JSON.stringify(t)}`}):e+=JSON.stringify(s),(0,fs_extra_1.appendFileSync)(this.logDest,e)}catch(t){}});try{const t=(0,path_1.join)(this.root,BuildStageTask.optionsFileName);(0,fs_extra_1.existsSync)(t)&&(this.options=(0,fs_extra_1.readJSONSync)(t),console.debug(`Use build file ${BuildStageTask.optionsFileName} in root(${this.root})`))}catch(t){console.warn("Get cache build options failed!")}this.options&&this.options.buildPath&&(this.options.buildPath=Editor.UI.File.resolveToRaw(this.options.buildPath))}async run(){Editor.Metrics.trackTimeStart(`builder:run-build-stage-${this.name}`),this.init(),this.updateProcess("init options success",.1),(0,fs_extra_1.emptyDirSync)(tempDir);try{for(const t of Object.keys(this.taskInfo))await this._runPluginTask(t)}catch(t){console.warn(t),this.error=t}Editor.Metrics.trackTimeEnd(`builder:run-build-stage-${this.name}`,{output:!0})}async _runPluginTask(t){for(let s=0;s<this.hooksInfo.pkgNameOrder.length;s++){const e=this.hooksInfo.pkgNameOrder[s],i=this.hooksInfo.infos[e],o=this.taskInfo[t]*(s+1);let r;try{(r=Editor.Module.requireFile(i.path))[t]&&(this.updateProcess(`${e}:(${t}) start...`),this.console.debug(`// ---- ${e}:(${t}) ----`),i.internal?await r[t].call(this,this.root,this.options):await r[t](this.root,this.options),this.console.debug(`// ---- ${e}:(${t}) success ----`),this.updateProcess(`${e}:(${t}) âˆš`,o))}catch(s){const i=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:e,funcName:t});if(r&&r.throwError)throw s;this.updateProcess(i,0,"warn"),this.updateProcess(s+"",0,"warn")}}}updateProcess(t,s=0,e="debug"){this.progress=Editor.Utils.Math.clamp01(this.progress+s),this.emit("update",t,this.progress),this.console[e](t)}}exports.BuildStageTask=BuildStageTask,BuildStageTask.optionsFileName="cocos.compile.config.json";