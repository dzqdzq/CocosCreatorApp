"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildStageTask=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),sub_process_manager_1=require("../worker-pools/sub-process-manager"),task_base_1=require("./manager/task-base"),tempDir=(0,path_1.join)(Editor.Project.tmpDir,"builder","compile");class BuildStageTask extends task_base_1.BuildTaskBase{constructor(t){super(t.name),this.hooksInfo=t.hooksInfo,this.root=t.root,t.buildTaskOptions&&(this.options=t.buildTaskOptions);const s=t.name[0].toUpperCase()+t.name.slice(1,t.name.length);this.hookMap={[`onBefore${s}`]:`onBefore${s}`,[this.name]:this.name,[`onAfter${s}`]:`onAfter${s}`}}init(){try{const t=(0,path_1.join)(this.root,BuildStageTask.optionsFileName);(0,fs_extra_1.existsSync)(t)&&(this.options=(0,fs_extra_1.readJSONSync)(t),console.debug(`Use build file ${BuildStageTask.optionsFileName} in root(${this.root})`))}catch(t){console.warn("Get cache build options failed!")}this.options&&this.options.buildPath&&(this.options.buildPath=Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath))}async run(){const t=`// ---- builder:run-build-stage-${this.name} ----`;console.debug(t),Editor.Metrics.trackTimeStart(t),this.init(),this.updateProcess("init options success",.1),(0,fs_extra_1.emptyDirSync)(tempDir);try{for(const t of Object.keys(this.hookMap))await this.runPluginTask(t)}catch(t){console.warn(t),this.error=t}return await Editor.Metrics.trackTimeEnd(t,{output:!0}),!0}async break(t){sub_process_manager_1.workerManager.killRunningChilds(),await super.break(t)}async handleHook(t,s){s?await t.call(this,this.root,this.options):await t(this.root,this.options)}}exports.BuildStageTask=BuildStageTask,BuildStageTask.optionsFileName="cocos.compile.config.json";