"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildStageTask=void 0;const events_1=require("events"),path_1=require("path"),fs_extra_1=require("fs-extra"),console_1=require("./utils/console"),utils_1=require("./utils"),sub_process_manager_1=require("../worker-pools/sub-process-manager"),tempDir=(0,path_1.join)(Editor.Project.tmpDir,"builder","compile");class BuildStageTask extends events_1.EventEmitter{constructor(t){super(),this.taskInfo={},this.progress=0,this.logDest="",this.name=t.name,this.hooksInfo=t.hooksInfo,this.root=t.root,t.buildTaskOptions&&(this.options=t.buildTaskOptions);const s=t.name[0].toUpperCase()+t.name.slice(1,t.name.length);this.taskInfo={[`onBefore${s}`]:.2,[this.name]:.2,[`onAfter${s}`]:.2}}init(){this.logDest=(0,path_1.join)(Build.projectTempDir,this.name,(0,path_1.basename)(this.root)+".log"),(0,fs_extra_1.outputFileSync)(this.logDest,""),this.console=new console_1.MessageConsole((t,s)=>{if(!t||!s)return;let e=`${(0,utils_1.getCurrentTime)()}-${t}:[${this.name}]`;try{Array.isArray(s)?s.forEach(t=>{e+=`${JSON.stringify(t)}`}):e+=JSON.stringify(s),(0,fs_extra_1.appendFileSync)(this.logDest,e)}catch(t){}});try{const t=(0,path_1.join)(this.root,BuildStageTask.optionsFileName);(0,fs_extra_1.existsSync)(t)&&(this.options=(0,fs_extra_1.readJSONSync)(t),console.debug(`Use build file ${BuildStageTask.optionsFileName} in root(${this.root})`))}catch(t){console.warn("Get cache build options failed!")}this.options&&this.options.buildPath&&(this.options.buildPath=Editor.UI.File.resolveToRaw(this.options.buildPath))}async run(){const t=`// ---- builder:run-build-stage-${this.name} ----`;console.debug(t),Editor.Metrics.trackTimeStart(t),this.init(),this.updateProcess("init options success",.1),(0,fs_extra_1.emptyDirSync)(tempDir);try{for(const t of Object.keys(this.taskInfo))await this._runPluginTask(t)}catch(t){console.warn(t),this.error=t}Editor.Metrics.trackTimeEnd(t,{output:!0})}async break(t){return new Promise(t=>{this.breakResolve=t,sub_process_manager_1.workerManager.killRunningChilds()})}async _runPluginTask(t){const s=1/this.hooksInfo.pkgNameOrder.length;for(let e=0;e<this.hooksInfo.pkgNameOrder.length;e++){if(this.breakResolve){this.breakResolve(),this.onError(new Error(`${this.name} task is break!`));break}const o=this.hooksInfo.pkgNameOrder[e],i=this.hooksInfo.infos[o],r=this.taskInfo[t]*s*e;let a;try{const s=`// ---- build task ${o}：${t} ----`;if((a=Editor.Module.requireFile(i.path))[t]){this.updateProcess(`${o}:(${t}) start...`),this.console.debug(s),i.internal?await a[t].call(this,this.root,this.options):await a[t](this.root,this.options);const e=await Editor.Metrics.trackTimeEnd(s,{output:!0});this.updateProcess(`${o}:(${t}) in ${e} ms √`,r)}}catch(s){const e=Editor.I18n.t("builder.error.run_hooks_failed",{pkgName:o,funcName:t});a&&a.throwError&&this.onError(s),this.updateProcess(e,0,"warn"),this.updateProcess(s+"",0,"warn")}}}onError(t){throw this.error=t,t}updateProcess(t,s=0,e="debug"){this.progress=Editor.Utils.Math.clamp01(this.progress+s),this.emit("update",t,this.progress),this.console[e](t)}}exports.BuildStageTask=BuildStageTask,BuildStageTask.optionsFileName="cocos.compile.config.json";