"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildStageTask=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),sub_process_manager_1=require("../worker-pools/sub-process-manager"),task_base_1=require("./manager/task-base"),global_1=require("../../share/global"),tempDir=(0,path_1.join)(Editor.Project.tmpDir,"builder","compile");class BuildStageTask extends task_base_1.BuildTaskBase{options;buildTaskOptions;hooksInfo;root;hookMap;constructor(t,o){super(t,o.name),this.hooksInfo=o.hooksInfo,this.root=o.root,o.buildTaskOptions&&(this.buildTaskOptions=o.buildTaskOptions);t=o.name[0].toUpperCase()+o.name.slice(1,o.name.length);this.hookMap={["onBefore"+t]:"onBefore"+t,[this.name]:this.name,["onAfter"+t]:"onAfter"+t}}init(){var o=(0,path_1.join)(this.root,global_1.BuildGlobalInfo.buildOptionsFileName);try{(0,fs_extra_1.existsSync)(o)&&(this.options=(0,fs_extra_1.readJSONSync)(o),console.debug(`Use build file ${global_1.BuildGlobalInfo.buildOptionsFileName} in root(${this.root})`))}catch(t){console.debug(`Get cache build options form ${o} failed!`)}if(!this.options&&this.buildTaskOptions&&(this.options=this.buildTaskOptions),!this.options)throw new Error(`Get cache build options form ${o} failed! Please recompile the build task again.`)}async run(){var t=`// ---- builder:run-build-stage-${this.name} ----`;console.debug(t),Editor.Metrics.trackTimeStart(t),this.init(),this.updateProcess("init options success",.1),(0,fs_extra_1.emptyDirSync)(tempDir);try{for(const o of Object.keys(this.hookMap))await this.runPluginTask(o)}catch(t){this.error=t}if(await Editor.Metrics.trackTimeEnd(t,{output:!0}),this.error)throw this.error;return!0}break(t){sub_process_manager_1.workerManager.killRunningChilds(),super.break(t)}async handleHook(t,o){o?await t.call(this,this.root,this.options):await t(this.root,this.options)}async saveOptions(){await(0,fs_extra_1.outputJSON)((0,path_1.join)(this.root,global_1.BuildGlobalInfo.buildOptionsFileName),this.options)}}exports.BuildStageTask=BuildStageTask;