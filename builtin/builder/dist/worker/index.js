"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t);var o=Object.getOwnPropertyDescriptor(r,t);o&&("get"in o?r.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,s,o)}:function(e,r,t,s){void 0===s&&(s=t),e[s]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildBundleOnly=exports.updateLogLevel=exports.changeDebugMode=exports.updatePlugin=exports.excuteBuildStageTask=exports.getPreviewSettings=exports.breakTask=exports.build=exports.initBuildEnv=exports.Build=void 0,console.time("builder:startup");const fixPath=require("fix-path");fixPath(),window.Editor=require("editor");const Utils=__importStar(require("./builder/utils/index")),task_config_1=require("./builder/task-config"),console_1=require("./console"),index_1=require("./builder/utils/index"),plugin_1=require("./plugin"),stage_task_manager_1=require("./builder/stage-task-manager"),sub_process_manager_1=require("./worker-pools/sub-process-manager"),asset_library_1=require("./builder/manager/asset-library"),msg_util_1=require("./msg-util"),index_2=require("./builder/index"),global_1=require("./global"),metric_1=require("./builder/metric"),bundle_1=require("./builder/asset-handler/bundle"),path_1=require("path"),script_1=require("./builder/asset-handler/script"),utils_1=require("../share/utils"),buildTaskMap={};async function initBuildEnv(e,r){Editor.Metrics.trackTimeStart("builder:worker-init"),console_1.newConsole.trackMemoryStart("builder:worker-init"),window.__manager={__taskId:"",taskManager:task_config_1.taskManager,currentCompileTask:null,currentBuildTask:null,buildAssetLibrary:asset_library_1.buildAssetLibrary,pluginManager:plugin_1.pluginManager,workerManager:sub_process_manager_1.workerManager},window.Build.isCommand=r,index_2.BuildTask.isCommandBuild=r,window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),buildTaskMap[__manager.__taskId]&&(buildTaskMap[__manager.__taskId].error=e.reason)}),console_1.newConsole.command=r,await plugin_1.pluginManager.init(e),console_1.newConsole.trackMemoryEnd("builder:worker-init"),window.Build.init=!0,Editor.Metrics.trackTimeEnd("builder:worker-init",{output:!0})}async function build(e,r){if(!window.Build.init)return;__manager.__taskId=e;let t=!0;const s=Date.now();let o="build";r.buildStageGroup&&r.buildStageGroup.build&&r.buildStageGroup.build.length&&(o=o+" -> "+r.buildStageGroup.build.join(" -> "));const i=new index_1.MemoryTrack;let a=null;try{const{BuildTask:n}=await Promise.resolve().then(()=>__importStar(require("./builder/index")));if(console_1.newConsole.record(e,r.logDest),console.debug(`=================================== ${o} Task (${r.taskName||r.outputName}) Start ================================`),console.debug("Start build task, options:",r),console.debug("Build with Cocos Creator "+Editor.App.version),Editor.Metrics.trackTimeStart("builder:build-project-total"),i.start(),console_1.newConsole.trackMemoryStart("builder:build-project-total"),a=buildTaskMap[e]=new n(e,r),__manager.currentBuildTask=a,a.on("update",(r,t)=>{msg_util_1.Message.send("build-worker:update-progress",e,t,"processing",r)}),await a.run(),i.stop(),console_1.newConsole.trackMemoryEnd("builder:build-project-total"),t=!a.error,a.error){const r="object"==typeof a.error?a.error.stack||a.error.message:a.error;msg_util_1.Message.send("build-worker:update-progress",e,1,"failure",(0,utils_1.getCurrentTime)()+` ${a.stage} task failed! `+r)}else msg_util_1.Message.send("build-worker:update-progress",e,1,"success",(0,utils_1.getCurrentTime)()+` ${o} success in ${Date.now()-s} ms!`);const{buildAssetLibrary:l}=await Promise.resolve().then(()=>__importStar(require("./builder/manager/asset-library")));await l.saveMtimeCache()}catch(r){if(i.stop(),console_1.newConsole.trackMemoryEnd("builder:build-project-total"),a&&(r&&a.error!==r&&(a.error=r),await a.runErrorHook()),t=!1,sub_process_manager_1.workerManager.killRunningChilds(),!a||!a.breakResolve){console.error(r);const t=a&&a.stage||"build";msg_util_1.Message.send("build-worker:update-progress",e,1,"failure",(0,utils_1.getCurrentTime)()+` ${t} task failed! `+(r.message||r))}}if(a){if(a.error){const e="object"==typeof a.error?a.error.stack||a.error.message:a.error;a.result.staticsInfo.err=e}"normal"===a.options.buildMode&&(0,metric_1.sendBuildMetric)(a.result.staticsInfo)}return __manager.currentBuildTask=null,delete buildTaskMap[e],await window.__manager.buildAssetLibrary.saveMtimeCache(),console.debug(`================================ ${o} Task (${r.taskName||r.outputName}) Finished in (${Date.now()-s})ms ================================`),console_1.newConsole.stopRecord(),asset_library_1.buildAssetLibrary.reset(),Utils.getMemorySize(),t}async function breakTask(e){__manager.currentBuildTask?await __manager.currentBuildTask.break():__manager.currentCompileTask&&await __manager.currentCompileTask.break()}async function getPreviewSettings(e,r){r.preview=!0;const{BuildTask:t}=await Promise.resolve().then(()=>__importStar(require("./builder/index"))),s=new t(e,r);s.on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress","preview",e,"processing",r)}),console.time("Get settings.js in preview");const o=await s.getPreviewSettings(),i={};for(const e of s.cache.scriptUuids){const r=s.cache.getAssetInfo(e);i[(0,index_1.removeDbHeader)(r.source).replace(/.ts$/,".js")]=r.library[".js"]}return console.timeEnd("Get settings.js in preview"),{settings:o,script2library:i,bundleConfigs:s.bundleManager.bundles.map(e=>e.config)}}async function excuteBuildStageTask(e,r){var t;if(__manager.currentCompileTask&&__manager.currentCompileTask.root===r.root||__manager.currentBuildTask&&__manager.currentBuildTask.result.paths.dir===r.root)return console.error("The current directory is busy, please try again later"),msg_util_1.Message.send("build-worker:update-build-stage-progress",r.taskId,1,"failed","The current directory is busy, please try again later"),!1;let s=!0;function o(e,t,s){msg_util_1.Message.send("build-worker:update-build-stage-progress",r.taskId,e,t,s)}try{const i=(null===(t=r.buildTaskOptions)||void 0===t?void 0:t.logDest)||(0,path_1.join)(Editor.Project.tmpDir,r.platform+`-${e}.log`);console_1.newConsole.record(r.taskId,i);const a=r.nextStages?[e,...r.nextStages]:[e];let n=1/a.length;const l=a.map(e=>plugin_1.pluginManager.getCustomBuildStageTasks(r.platform,e));for(let t=0;t<l.length;t++){const i=l[t];if(n*=t+1,!i)return console.error(`No Build stage ${e}`),o(1,"failure",(0,utils_1.getCurrentTime)()+`No Build stage ${e}`),!1;console_1.newConsole.trackMemoryStart(`builder:build-stage-total ${e}`);const u=new stage_task_manager_1.BuildStageTask(Object.assign({hooksInfo:plugin_1.pluginManager.getHooksInfo(r.platform),root:r.root,taskId:r.taskId},i));__manager.currentCompileTask=u;let d=i.name;if(u.on("update",(e,r)=>{o(r*n,"processing",e),console.log(`[task:${d}]: ${e}, ${100*r}%`)}),await u.run(),console_1.newConsole.trackMemoryEnd(`builder:build-stage-total ${e}`),u.error){console.error(`${d} package ${r.root} failed!`),o(1*n,"failure",(0,utils_1.getCurrentTime)()+` ${d} package ${r.root} failed!`),console.log(`[task:${d}]: failed!`),s=!1;break}1===n&&(d=a.join(" -> ")),o(1*n,"success",(0,utils_1.getCurrentTime)()+` ${d} package ${r.root} success!`),console.log(`[task:${d}]: success!`)}}catch(t){console_1.newConsole.trackMemoryEnd(`builder:build-stage-total ${e}`),__manager.currentCompileTask&&__manager.currentCompileTask.breakResolve||(console.error(`Run build stage[${e}] in package ${r.root} failed!`),o(1,"failure",(0,utils_1.getCurrentTime)()+` Run build stage[${e}] in package ${r.root} failed!`)),console.error(t),s=!1}return console_1.newConsole.stopRecord(),__manager.currentCompileTask=null,s}async function updatePlugin(e,r){return await plugin_1.pluginManager[e](r)}async function changeDebugMode(e){return global_1.BuildGlobalInfo.debugMode=e}async function buildBundleOnly(e){if(!window.Build.init)return!1;let r=!0;const t=e[0].id||"buildBundle";function s(){delete buildTaskMap[t],console_1.newConsole.stopRecord(),__manager.currentBuildTask=null,Utils.getMemorySize()}const o=1/e.length,i=Date.now();for(let i=0;i<e.length;i++){const a=e[i];__manager.__taskId=t;const n=a.taskName||"bundle Build",l=Date.now(),u=new index_1.MemoryTrack;try{console_1.newConsole.record(t,a.logDest),console.debug(`=================================== ${n} Task (${a.platform}) Start ================================`),console.debug("Start build task, options:",a),console.debug("Build with Cocos Creator "+Editor.App.version),u.start(),console_1.newConsole.trackMemoryStart("builder:build-bundle-total");const e=new bundle_1.BundleManager(a);if(__manager.currentBuildTask=e,buildTaskMap[t]=e,e.on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress",t,(r+i)*o,"processing",e)}),await e.run(),console_1.newConsole.trackMemoryEnd("builder:build-bundle-total"),u.stop(),console.log(`${n} (${a.platform}) in {link(${e.destDir})} success!`),r=!e.error,e.error){const s="object"==typeof e.error?e.error.stack||e.error.message:e.error;msg_util_1.Message.send("build-worker:update-progress",t,1,"failure",(0,utils_1.getCurrentTime)()+` ${n} failed! `+s),r=!1}else console.debug((0,utils_1.getCurrentTime)()+`Build Bundle success in ${Date.now()-l} ms!`)}catch(e){u.stop(),buildTaskMap[t]&&buildTaskMap[t].error!==e&&await buildTaskMap[t].onError(e,!1),r=!1,buildTaskMap[t]&&buildTaskMap[t].breakResolve||(sub_process_manager_1.workerManager.killRunningChilds(),console.error(e),msg_util_1.Message.send("build-worker:update-progress",t,1,"failure",(0,utils_1.getCurrentTime)()+` ${n} task failed! `+(e.message||e)))}if(console.debug(`================================ ${n} Task (${a.taskName}) Finished in (${Date.now()-l})ms ================================`),!r)return s(),r}return s(),msg_util_1.Message.send("build-worker:update-progress",t,1,"success",(0,utils_1.getCurrentTime)()+`Build Bundle success in ${Date.now()-i} ms!`),r}exports.Build=Object.assign({Utils:Utils,ScriptBuilder:script_1.ScriptBuilder},global_1.BuildGlobalInfo),window.Build=exports.Build,exports.initBuildEnv=initBuildEnv,exports.build=build,exports.breakTask=breakTask,exports.getPreviewSettings=getPreviewSettings,exports.excuteBuildStageTask=excuteBuildStageTask,exports.updatePlugin=updatePlugin,exports.changeDebugMode=changeDebugMode,exports.updateLogLevel=console_1.NewConsole.updateLogLevel,exports.buildBundleOnly=buildBundleOnly;