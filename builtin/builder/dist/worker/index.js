"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var s=Object.getOwnPropertyDescriptor(r,t);s&&("get"in s?r.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,s)}:function(e,r,t,a){e[a=void 0===a?t:a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var s=function(e){return(s=Object.getOwnPropertyNames||function(e){var r,t=[];for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t})(e)};return function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t=s(e),a=0;a<t.length;a++)"default"!==t[a]&&__createBinding(r,e,t[a]);return __setModuleDefault(r,e),r}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.updateLogLevel=exports.Build=void 0,exports.initBuildEnv=initBuildEnv,exports.build=build,exports.breakTask=breakTask,exports.getPreviewSettings=getPreviewSettings,exports.executeBuildStageTask=executeBuildStageTask,exports.executeHookTask=executeHookTask,exports.updatePlugin=updatePlugin,exports.changeDebugMode=changeDebugMode,exports.buildBundleOnly=buildBundleOnly,console.time("builder:startup");const fixPath=require("fix-path"),Utils=(fixPath(),__importStar(require("./builder/utils/index"))),task_config_1=require("./builder/task-config"),console_1=require("./console"),index_1=require("./builder/utils/index"),plugin_1=require("./plugin"),stage_task_manager_1=require("./builder/stage-task-manager"),sub_process_manager_1=require("./worker-pools/sub-process-manager"),asset_library_1=require("./builder/manager/asset-library"),msg_util_1=require("./msg-util"),index_2=require("./builder/index"),global_1=require("../share/global"),metric_1=require("./builder/metric"),bundle_1=require("./builder/asset-handler/bundle"),path_1=require("path"),script_1=require("./builder/asset-handler/script"),utils_1=require("../share/utils"),console_2=require("./builder/utils/console"),memory_track_1=require("./builder/utils/memory-track"),buildTaskMap={};async function initBuildEnv(e,r,t,a){Editor.Metrics.trackTimeStart("builder:worker-init"),console_1.newConsole.trackMemoryStart("builder:worker-init"),window.__manager={__taskId:"",taskManager:task_config_1.taskManager,currentStageTask:null,currentBuildTask:null,buildAssetLibrary:asset_library_1.buildAssetLibrary,pluginManager:plugin_1.pluginManager,workerManager:sub_process_manager_1.workerManager,get currentTask(){return this.currentBuildTask||this.currentStageTask},get currentTaskName(){try{return this.currentTask.options.taskName}catch(e){}}},window.Build.isCommand=a,index_2.BuildTask.isCommandBuild=a,process.on("unhandledrejection",e=>{console.warn(`Catch unhandledrejection when build task ${__manager.currentTaskName&&__manager.currentTaskName} running`),console.warn(e)}),process.on("uncaughtException",e=>{console.warn(`Catch uncaughtException when build task ${__manager.currentTaskName&&__manager.currentTaskName} running`),console.warn(e)}),console_1.newConsole.command=a,await plugin_1.pluginManager.init(e,r,t),sub_process_manager_1.WorkerManager.defaultArgv=await Editor.Profile.getConfig("builder","workerManagerDefaultArgv")||[],console_1.newConsole.trackMemoryEnd("builder:worker-init"),window.Build.init=!0,Editor.Metrics.trackTimeEnd("builder:worker-init",{output:!0})}async function build(o,n){if(window.Build.init){__manager.__taskId=o;let r=!0,t="";var i=Date.now();let a="build";n.buildStageGroup&&n.buildStageGroup.build&&n.buildStageGroup.build.length&&(a=a+" -> "+n.buildStageGroup.build.join(" -> "));var l=new memory_track_1.MemoryTrack;let s=null,e=null;try{var u=(await Promise.resolve().then(()=>__importStar(require("./builder/index"))))["BuildTask"];console_1.newConsole.record(o,n.logDest),e=(0,console_2.onDetailMessagePolling)(()=>{var e=(0,console_2.handleDetailMessage)(console_1.newConsole.messages);e&&msg_util_1.Message.send("build-worker:update-detail-message",o,e)}),console.debug(`=================================== ${a} Task (${n.taskName||n.outputName}) Start ================================`),console.debug("Start build task, options:",n),console.debug("Build with Cocos Creator "+Editor.App.version),Editor.Metrics.trackTimeStart("builder:build-project-total"),l.start(),console_1.newConsole.trackMemoryStart("builder:build-project-total"),s=buildTaskMap[o]=new u(o,n),(__manager.currentBuildTask=s).on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress",o,r,"processing",e)}),s.on("store-crash-info",e=>{msg_util_1.Message.send("builder-worker:store-crash-info",o,e)}),await s.run(),l.stop(),console_1.newConsole.trackMemoryEnd("builder:build-project-total"),r=!s.error,s.error&&(t="object"==typeof s.error?s.error.stack||s.error.message:s.error)}catch(e){l.stop(),console_1.newConsole.trackMemoryEnd("builder:build-project-total"),s&&(e&&s.error!==e&&(s.error=e),await s.runErrorHook()),r=!1,sub_process_manager_1.workerManager.killRunningChilds(),s&&s.breakReason||(console.error(e),a=s&&s.stage||"build",t=e.message||e)}return s&&(s.error&&(t="object"==typeof s.error?s.error.stack||s.error.message:s.error,s.result.staticsInfo.err=t),s.options.buildMode&&"normal"!==s.options.buildMode||(0,metric_1.sendBuildMetric)(s.result.staticsInfo)),__manager.currentBuildTask=null,delete buildTaskMap[o],console.debug(`================================ ${a} Task (${n.taskName||n.outputName}) Finished in (${(0,utils_1.formatMSTime)(Date.now()-i)})ms ================================`),console_1.newConsole.stopRecord(),e&&e(),asset_library_1.buildAssetLibrary.reset(),(0,memory_track_1.getMemorySize)(),r?msg_util_1.Message.send("build-worker:update-progress",o,1,"success",(0,utils_1.getCurrentTime)()+` ${a} success in ${(0,utils_1.formatMSTime)(Date.now()-i)}!`):(msg_util_1.Message.send("build-worker:update-progress",o,1,"failure",(0,utils_1.getCurrentTime)()+` ${a} task failed! `+t),(0,metric_1.sendSingleMetric)({sendToNewCocosAnalyticsOnly:!0,category:"buildSystem",value:{B100044:t}})),r}}function breakTask(r,e){var t=[__manager.currentBuildTask,__manager.currentStageTask].find(e=>e&&e.id===r);t?t.break(e):console.warn(`Cannot find task(${r}) to break`)}async function getPreviewSettings(e,r){r.preview=!0;var t=(await Promise.resolve().then(()=>__importStar(require("./builder/index"))))["BuildTask"],t=new t(e,r),e=(t.on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress","preview",e,"processing",r)}),console.time("Get settings.js in preview"),await t.getPreviewSettings()),a={};for(const o of t.cache.scriptUuids){var s=asset_library_1.buildAssetLibrary.getAsset(o);a[(0,index_1.removeDbHeader)(s.url).replace(/.ts$/,".js")]=s.library+".js"}return console.timeEnd("Get settings.js in preview"),{settings:e,script2library:a,bundleConfigs:t.bundleManager.bundles.map(e=>e.config)}}async function executeBuildStageTask(s,r,o){var e=__manager.currentBuildTask;if(__manager.currentStageTask&&__manager.currentStageTask.root===o.root||e&&e.result&&e.result.paths.dir===o.root)return console.error("The current directory is busy, please try again later"),msg_util_1.Message.send("build-worker:update-build-stage-progress",s,1,"failure","The current directory is busy, please try again later"),!1;let n=!0,t=null;function i(e,r,t){msg_util_1.Message.send("build-worker:update-build-stage-progress",s,e,r,t)}try{var l=o.buildTaskOptions?.logDest||(0,path_1.join)(Editor.Project.tmpDir,o.platform+`-${r}.log`),u=(console_1.newConsole.record(s,l),t=(0,console_2.onDetailMessagePolling)(()=>{var e=(0,console_2.handleDetailMessage)(console_1.newConsole.messages);e&&msg_util_1.Message.send("build-worker:update-detail-message",s,e)}),o.nextStages?[r,...o.nextStages]:[r]);let a=1/u.length;var d=u.map(e=>plugin_1.pluginManager.getBuildStageWithHookTasks(o.platform,e));for(let e=0;e<d.length;e++){var c=d[e];if(a*=e+1,!c)return console.error("No Build stage "+r),i(1,"failure",(0,utils_1.getCurrentTime)()+"No Build stage "+r),!1;if("message"===c.type){var{name:g,target:_,params:p}=c.message;await Editor.Message.request(_,g,...p||[])}else{console_1.newConsole.trackMemoryStart("builder:build-stage-total "+r);var b=new stage_task_manager_1.BuildStageTask(s,{hooksInfo:plugin_1.pluginManager.getHooksInfo(o.platform),root:o.root,buildTaskOptions:o.buildTaskOptions,...c});__manager.currentStageTask=b;let t=c.name;if(b.on("update",(e,r)=>{i(r*a,"processing",e),console.log(`[task:${t}]: ${e}, ${100*r}%`)}),await b.run(),console_1.newConsole.trackMemoryEnd("builder:build-stage-total "+r),b.error){console.error(`${t} package ${o.root} failed!`),i(+a,"failure",(0,utils_1.getCurrentTime)()+` ${t} package ${o.root} failed!`),console.log(`[task:${t}]: failed!`),n=!1;break}1===a&&(t=u.join(" -> ")),i(+a,"success",(0,utils_1.getCurrentTime)()+` ${t} package ${o.root} success!`),console.log(`[task:${t}]: success!`)}}}catch(e){console_1.newConsole.trackMemoryEnd("builder:build-stage-total "+r),__manager.currentStageTask&&__manager.currentStageTask.breakResolve||(console.error(`Run build stage[${r}] in package ${o.root} failed!`),i(1,"failure",(0,utils_1.getCurrentTime)()+` Run build stage[${r}] in package ${o.root} failed!`)),console.error(e),n=!1}return console_1.newConsole.stopRecord(),t&&t(),__manager.currentStageTask=null,n}async function executeHookTask(r,t,e,...a){var s=plugin_1.pluginManager.getHookPath(e.platform,r);if(s)try{await require(s)[t](e,...a)}catch(e){console.error(`Run hook[${t}] in package ${r} failed!`),console.error(e)}}async function updatePlugin(e,r,t){await plugin_1.pluginManager[e](r),t&&(plugin_1.pluginManager.platformConfigs=t)}async function changeDebugMode(e){return global_1.BuildGlobalInfo.debugMode=e}async function buildBundleOnly(e){if(!window.Build.init)return!1;let r=!0;const a=e[0].id||"buildBundle",t=(0,console_2.onDetailMessagePolling)(()=>{var e=(0,console_2.handleDetailMessage)(console_1.newConsole.messages);e&&msg_util_1.Message.send("build-worker:update-detail-message",a,e)});function s(){delete buildTaskMap[a],console_1.newConsole.stopRecord(),t&&t(),(__manager.currentBuildTask=null,memory_track_1.getMemorySize)()}const o=1/e.length,n=Date.now();for(let t=0;t<e.length;t++){var i=e[t],l=(__manager.__taskId=a,i.taskName||"bundle Build");const n=Date.now();var u=new memory_track_1.MemoryTrack;try{console_1.newConsole.record(a,i.logDest),console.debug(`=================================== ${l} Task (${i.platform}) Start ================================`),console.debug("Start build task, options:",i),console.debug("Build with Cocos Creator "+Editor.App.version),u.start(),console_1.newConsole.trackMemoryStart("builder:build-bundle-total");var d,c=new bundle_1.BundleManager(i);__manager.currentBuildTask=c,(buildTaskMap[a]=c).on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress",a,(r+t)*o,"processing",e)}),await c.run(),console_1.newConsole.trackMemoryEnd("builder:build-bundle-total"),u.stop(),console.log(`${l} (${i.platform}) in {link(${c.destDir})} success!`),r=!c.error,c.error?(d="object"==typeof c.error?c.error.stack||c.error.message:c.error,msg_util_1.Message.send("build-worker:update-progress",a,1,"failure",(0,utils_1.getCurrentTime)()+` ${l} failed! `+d),r=!1):console.debug((0,utils_1.getCurrentTime)()+`Build Bundle success in ${(0,utils_1.formatMSTime)(Date.now()-n)}!`)}catch(e){u.stop(),buildTaskMap[a]&&buildTaskMap[a].error!==e&&await buildTaskMap[a].onError(e,!1),r=!1,buildTaskMap[a]&&buildTaskMap[a].breakReason||(sub_process_manager_1.workerManager.killRunningChilds(),console.error(e),msg_util_1.Message.send("build-worker:update-progress",a,1,"failure",(0,utils_1.getCurrentTime)()+` ${l} task failed! `+(e.message||e)))}if(console.debug(`================================ ${l} Task (${i.taskName}) Finished in (${(0,utils_1.formatMSTime)(Date.now()-n)})ms ================================`),!r)return s(),r}return s(),msg_util_1.Message.send("build-worker:update-progress",a,1,"success",(0,utils_1.getCurrentTime)()+`Build Bundle success in ${(0,utils_1.formatMSTime)(Date.now()-n)}!`),r}exports.Build={Utils:Utils,ScriptBuilder:script_1.ScriptBuilder,...global_1.BuildGlobalInfo},window.Build=exports.Build,exports.updateLogLevel=console_1.NewConsole.updateLogLevel;