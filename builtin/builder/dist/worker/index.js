"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&("get"in i?r.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,i)}:function(e,r,t,a){void 0===a&&(a=t),e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.updateLogLevel=exports.changeDebugMode=exports.updatePlugin=exports.queryAltasInfo=exports.generateAltasPreviewFiles=exports.excuteBuildStageTask=exports.getPreviewSettings=exports.breakTask=exports.build=exports.initBuildEnv=void 0,console.time("builder:startup");const fixPath=require("fix-path");fixPath(),window.Editor=require("editor");const path_1=require("path"),Utils=__importStar(require("./builder/utils/index")),texture_packer_1=__importDefault(require("./builder/texture-packer")),task_config_1=require("./builder/task-config"),console_1=require("./console"),index_1=require("./builder/utils/index"),plugin_1=require("./plugin"),stage_task_manager_1=require("./builder/stage-task-manager"),sub_process_manager_1=require("./worker-pools/sub-process-manager"),asset_library_1=require("./builder/manager/asset-library"),msg_util_1=require("./msg-util"),index_2=require("./builder/index"),buildTaskMap={};async function initBuildEnv(e,r){Editor.Metrics.trackTimeStart("builder:worker-init"),await asset_library_1.buildAssetLibrary.initMtimeCache(),window.__manager={__taskId:"",taskManager:task_config_1.taskManager,currentCompileTask:null,currentBuildTask:null,buildAssetLibrary:asset_library_1.buildAssetLibrary,pluginManager:plugin_1.pluginManager,workerManager:sub_process_manager_1.workerManager},window.Build.isCommand=r,index_2.BuildTask.isCommandBuild=r,window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),buildTaskMap[__manager.__taskId]&&(buildTaskMap[__manager.__taskId].errorMsg=e.reason)}),window.requestAnimationFrame=function(e){console.debug("requestAnimationFrame is disabled in worker process, will use setTimeout instead."),setTimeout(e,0)},console_1.newConsole.command=r,await plugin_1.pluginManager.init(e),window.Build.init=!0,Editor.Metrics.trackTimeEnd("builder:worker-init",{output:!0})}async function build(e,r){if(!window.Build.init)return;__manager.__taskId=e;let t=!0;const a=Date.now();async function i(){delete buildTaskMap[e],await window.__manager.buildAssetLibrary.saveMtimeCache(),console.debug(`================================ Build Task (${r.outputName}) Finished in (${Date.now()-a})ms ================================`),console_1.newConsole.stopRecord(),__manager.currentBuildTask=null}try{const{BuildTask:a}=await Promise.resolve().then(()=>__importStar(require("./builder/index")));console_1.newConsole.record(e,r.platform,r.logDest),console.debug(`=================================== Build Task (${r.outputName}) Start ================================`),console.debug("Start build task, options:",r),console.debug("Build with Cocos Creator "+Editor.App.version),Editor.Metrics.trackTimeStart("builder:build-project-total");const s=buildTaskMap[e]=new a(e,r);__manager.currentBuildTask=s,s.on("update",(r,t)=>{msg_util_1.Message.send("build-worker:update-progress",e,t,"processing",r)}),await s.build();const n=await Editor.Metrics.trackTimeEnd("builder:build-project-total",{output:!0});if(s.staticsInfo.time=n,t=!s.error,s.error){const r="object"==typeof s.error?s.error.stack||s.error.message:s.error;s.staticsInfo.err=r,msg_util_1.Message.send("build-worker:update-progress",e,1,"failure",(0,index_1.getRealTime)()+` ${s.stage} task failed! `+r)}else console.debug(`build success in ${s.staticsInfo.time} ms!`),await i(),msg_util_1.Message.send("build-worker:update-progress",e,1,"success",(0,index_1.getRealTime)()+` Build success in ${s.staticsInfo.time} ms!`,console_1.newConsole.logDest);msg_util_1.Message.send("build-worker:add-statistics",s.staticsInfo);const{buildAssetLibrary:o}=await Promise.resolve().then(()=>__importStar(require("./builder/manager/asset-library")));await o.saveMtimeCache()}catch(r){if(buildTaskMap[e]&&buildTaskMap[e].error!==r&&await buildTaskMap[e].onError(r),t=!1,!buildTaskMap[e]||!buildTaskMap[e].breakResolve){sub_process_manager_1.workerManager.killRunningChilds(),console.error(r);const t=__manager.currentBuildTask&&__manager.currentBuildTask.stage;msg_util_1.Message.send("build-worker:update-progress",e,1,"failure",(0,index_1.getRealTime)()+` ${t} task failed! `+(r.message||r))}await i()}return delete buildTaskMap[e],asset_library_1.buildAssetLibrary.reset(),Utils.getMemorySize(),t}async function breakTask(e){__manager.currentBuildTask?await __manager.currentBuildTask.break():__manager.currentCompileTask&&await __manager.currentCompileTask.break()}async function getPreviewSettings(e,r){r.preview=!0;const{BuildTask:t}=await Promise.resolve().then(()=>__importStar(require("./builder/index"))),a=new t(e,r);a.on("update",(e,r)=>{msg_util_1.Message.send("build-worker:update-progress","preview",e,"processing",r)}),console.time("Get settings.js in preview");const i=await a.getPreviewSettings(),s={};for(const e of a.cache.scriptUuids){const r=a.cache.getAssetInfo(e);s[(0,index_1.removeDbHeader)(r.source).replace(/.ts$/,".js")]=r.library[".js"]}return console.timeEnd("Get settings.js in preview"),{settings:i,script2library:s,bundleConfigs:a.result.bundles.map(e=>e.config)}}async function excuteBuildStageTask(e,r){if(__manager.currentCompileTask&&__manager.currentCompileTask.root===r.root||__manager.currentBuildTask&&__manager.currentBuildTask.result.paths.dir===r.root)return console.error("The current directory is busy, please try again later"),!1;let t=!0;function a(e,t,a){msg_util_1.Message.send("build-worker:update-build-stage-progress",r.taskId,e,t,a)}try{console_1.newConsole.record(r.taskId,r.platform);const i=r.nextStages?[e,...r.nextStages]:[e];let s=1/i.length;const n=i.map(e=>plugin_1.pluginManager.getCustomBuildStageTasks(r.platform,e));for(let i=0;i<n.length;i++){const o=n[i];if(s*=i+1,!o)return console.error(`No Build stage ${e}`),a(1,"failure",(0,index_1.getRealTime)()+`No Build stage ${e}`),!1;const u=new stage_task_manager_1.BuildStageTask(Object.assign({hooksInfo:plugin_1.pluginManager.getHooksInfo(r.platform),root:r.root,taskId:r.taskId},o));__manager.currentCompileTask=u,u.on("update",(e,r)=>{a(r*s,"processing",e),console.log(`[task:${o.name}]: ${e}, ${100*r}%`)}),await u.run(),u.error?(console.error(`${o.name} package ${r.root} failed!`),a(1*s,"failure",(0,index_1.getRealTime)()+` ${o.name} package ${r.root} failed!`),console.log(`[task:${o.name}]: failed!`),t=!1):(a(1*s,"success",(0,index_1.getRealTime)()+` ${o.name} package ${r.root} success!`),console.log(`[task:${o.name}]: success!`),t=!0)}}catch(i){__manager.currentCompileTask&&__manager.currentCompileTask.breakResolve||(console.error(`Run build stage[${e}] in package ${r.root} failed!`),a(1,"failure",(0,index_1.getRealTime)()+` Run build stage[${e}] in package ${r.root} failed!`)),console.error(i),t=!1}return console_1.newConsole.stopRecord(),__manager.currentCompileTask=null,t}async function generateAltasPreviewFiles(e){try{return await texture_packer_1.default.generatePreviewFiles(e)}catch(r){console.error(`Generate auto atlas ${e} failed!`),console.error(r)}return null}async function queryAltasInfo(e){try{return await texture_packer_1.default.queryPreviewFiles(e)}catch(r){console.error(`Query info of auto atlas(${e}) failed!`),console.error(r)}return null}async function updatePlugin(e,r){return await plugin_1.pluginManager[e](r)}async function changeDebugMode(e){return Build.debugMode=e}window.Build={Utils:Utils,LIBRARY_NAME:"library",IMPORT_HEADER:"import",RESOURCES:"resources",SUBPACKAGES_HEADER:"subpackages",ASSETS_HEADER:"assets",REMOTE_HEADER:"remote",NATIVE_HEADER:"native",BUNDLE_SCRIPTS_HEADER:"bundle-scripts",SCRIPT_NAME:"index.js",CONFIG_NAME:"config.json",BUNDLE_ZIP_NAME:"res.zip",buildTemplateDir:(0,path_1.join)(Editor.Project.path,"build-templates"),projectTempDir:(0,path_1.join)(Editor.Project.tmpDir,"builder"),globalTempDir:(0,path_1.join)(Editor.App.temp,"builder"),debugMode:!1,init:!1,isCommand:!1},exports.initBuildEnv=initBuildEnv,exports.build=build,exports.breakTask=breakTask,exports.getPreviewSettings=getPreviewSettings,exports.excuteBuildStageTask=excuteBuildStageTask,exports.generateAltasPreviewFiles=generateAltasPreviewFiles,exports.queryAltasInfo=queryAltasInfo,exports.updatePlugin=updatePlugin,exports.changeDebugMode=changeDebugMode,exports.updateLogLevel=console_1.NewConsole.updateLogLevel;