"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t),Object.defineProperty(e,a,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,a){void 0===a&&(a=t),e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fixPath=require("fix-path");fixPath(),window.Editor=require("editor");const path_1=require("path"),builderManager=__importStar(require("./builder/index")),Utils=__importStar(require("./builder/utils/index")),asset_library_1=require("./builder/manager/asset-library"),texture_packer_1=__importDefault(require("./builder/texture-packer")),task_config_1=require("./builder/task-config"),console_1=require("./console"),redefine_1=require("./redefine"),index_1=require("./builder/utils/index"),single_task_1=require("./builder/single-task"),plugin_1=require("./plugin");console.time("Build worker init"),window.Build={Utils:Utils,LIBRARY_NAME:"library",IMPORT_HEADER:"import",RESOURCES:"resources",SUBPACKAGES_HEADER:"subpackages",ASSETS_HEADER:"assets",REMOTE_HEADER:"remote",NATIVE_HEADER:"native",BUNDLE_SCRIPTS_HEADER:"bundle-scripts",SCRIPT_NAME:"index.js",CONFIG_NAME:"config.json",BUNDLE_ZIP_NAME:"res.zip",buildTemplateDir:path_1.join(Editor.Project.path,"build-templates"),projectTempDir:path_1.join(Editor.Project.tmpDir,"builder"),globalTempDir:path_1.join(Editor.App.temp,"builder")},window.__manager={__taskId:"",taskManager:task_config_1.taskManager,currentCompileTask:null,currentBuildTask:null,buildAssetLibrary:asset_library_1.buildAssetLibrary,pluginManager:plugin_1.pluginManager};const buildTaskMap={};window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),buildTaskMap[__manager.__taskId]&&(buildTaskMap[__manager.__taskId].errorMsg=e.reason)}),Worker.Ipc.send("build-worker:startup"),Worker.Ipc.on("build-worker:init",async(e,r)=>{await console_1.NewConsole.updateLogLevel(),Build.Utils=Object.assign({},Utils);const t=require("cc");window.cc.debug._resetDebugSetting(t.DebugMode.INFO),await redefine_1.overwriteAssetManager(),await asset_library_1.buildAssetLibrary.initMtimeCache(),await plugin_1.pluginManager.init(r),Worker.Ipc.send("build-worker:ready"),console.timeEnd("Build worker init")}),Worker.Ipc.on("build-worker:build",async(e,r,t,a)=>{Worker.Ipc.send("build-worker:update-progress",r,.01,"processing","Init build task"),__manager.__taskId=r;let i=!0;try{console_1.newConsole.command=a,console_1.newConsole.record(r,t.platform,t.logDest),console.debug(`=================================== Build Task (${t.outputName}) Start ================================`),console.debug("Start build task, options:",t),console.debug("Build with Cocos Creator "+Editor.App.version);const e=(new Date).getTime(),s=buildTaskMap[r]=new builderManager.BuildTask(r,t,a);__manager.currentBuildTask=s,s.on("update",(e,t)=>{Worker.Ipc.send("build-worker:update-progress",r,t,"processing",e)}),await s.build();const o=(new Date).getTime();if(s.staticsInfo.time=o-e,i=!s.error,s.error){const e=s.error.stack||s.error.message;s.staticsInfo.err=e,Worker.Ipc.send("build-worker:update-progress",r,1,"failure",index_1.getRealTime()+" Build failed!"+e)}else console.debug(`build success in ${s.staticsInfo.time} ms!`),Worker.Ipc.send("build-worker:update-progress",r,1,"success",index_1.getRealTime()+` Build success in ${s.staticsInfo.time} ms!`,console_1.newConsole.logDest);Worker.Ipc.send("build-worker:add-statistics",s.staticsInfo),delete buildTaskMap[r],await asset_library_1.buildAssetLibrary.saveMtimeCache()}catch(e){delete buildTaskMap[r],console.error(e),i=!1,Worker.Ipc.send("build-worker:update-progress",r,1,"failure",index_1.getRealTime()+" build failed!"+e.message)}console_1.newConsole.stopRecord(),console.debug(`================================ Build Task (${t.outputName}) Finished ================================`),__manager.currentBuildTask=null,e.reply(null,i)}),Worker.Ipc.on("build-worker:run-button-task",async(e,r,t,a,i)=>{(__manager.currentCompileTask&&__manager.currentCompileTask.root===t||__manager.currentBuildTask&&__manager.currentBuildTask.result.paths.dir===t)&&(console.error("The current directory is busy, please try again later"),e.reply(null));try{console_1.newConsole.record(i,a);const e=new single_task_1.SingleTask(r,plugin_1.pluginManager.getHooksInfo(a),t);__manager.currentCompileTask=e,e.on("update",(e,a)=>{Worker.Ipc.send("build-worker:update-button-task-progress",t,a,"processing",e,i),console.log(`[task:${r}]: ${e}, ${100*a}%`)}),await e.run(),e.error?(console.error(`${r} package ${t} failed!`),Worker.Ipc.send("build-worker:update-button-task-progress",t,1,"failure",index_1.getRealTime()+` ${r} package ${t} failed!`,i),console.log(`[task:${r}]: failed!`)):(Worker.Ipc.send("build-worker:update-button-task-progress",t,1,"success",index_1.getRealTime()+` ${r} package ${t} success!`,i),console.log(`[task:${r}]: success!`))}catch(e){console.error(e),console.error(`${r} package ${t} failed!`),Worker.Ipc.send("build-worker:update-button-task-progress",t,1,"failure",index_1.getRealTime()+` ${r} package ${t} failed!`,i)}console_1.newConsole.stopRecord(),__manager.currentCompileTask=null,e.reply(null)}),Worker.Ipc.on("build-worker:preview-pac",async(e,r)=>{try{const t=await texture_packer_1.default.generatePreviewFiles(r);e.reply(null,t)}catch(r){console.error(r),e.reply(r,null)}}),Worker.Ipc.on("build-worker:query-atlas-files",async(e,r)=>{try{const t=await texture_packer_1.default.queryPreviewFiles(r);e.reply(null,t)}catch(r){console.error(r),e.reply(r,null)}}),Worker.Ipc.on("build-worker:generate-preview-setting",async(e,r,t)=>{try{t.preview=!0;const a=new builderManager.BuildTask(r,t);a.on("update",(e,r)=>{Worker.Ipc.send("build-worker:update-progress","preview",e,"processing",r)}),console.time("Get settings.js in preview");const i=await a.getPreviewSettings(),s={};for(const e of a.cache.scriptUuids){const r=a.cache.getAssetInfo(e);s[index_1.removeDbHeader(r.source).replace(/.ts$/,".js")]=r.library[".js"]}console.timeEnd("Get settings.js in preview"),e.reply(null,{settings:i,script2library:s,bundleConfigs:a.result.bundles.map(e=>e.config)})}catch(r){e.reply(r,null)}}),Worker.Ipc.on("build-worker:change-log-level",async(e,r)=>{await console_1.NewConsole.updateLogLevel(r),e.reply(null,!0)}),Worker.Ipc.on("build-worker:build-plugin-changed",async(e,r,t)=>{await plugin_1.pluginManager[r](t),e.reply(null,!0)}),Worker.Ipc.on("build-worker:query-task-map",async e=>{e.reply(null,task_config_1.taskManager.tasks)}),Worker.Ipc.on("build-worker:change-debug-mode",async(e,r)=>{task_config_1.taskManager._internalDebug=r,e.reply(null,task_config_1.taskManager.tasks)}),Worker.Ipc.on("build-worker:change-cache-config",async(e,r,t)=>{task_config_1.taskManager.cacheConfig[r]=t});