"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&("get"in i?r.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,i)}:function(e,r,t,a){void 0===a&&(a=t),e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),console.time("builder:startup");const fixPath=require("fix-path");fixPath(),window.Editor=require("editor");const path_1=require("path"),Utils=__importStar(require("./builder/utils/index")),texture_packer_1=__importDefault(require("./builder/texture-packer")),task_config_1=require("./builder/task-config"),console_1=require("./console"),redefine_1=require("./redefine"),index_1=require("./builder/utils/index"),plugin_1=require("./plugin"),stage_task_manager_1=require("./builder/stage-task-manager"),sub_process_manager_1=require("./worker-pools/sub-process-manager");window.Build={Utils:Utils,LIBRARY_NAME:"library",IMPORT_HEADER:"import",RESOURCES:"resources",SUBPACKAGES_HEADER:"subpackages",ASSETS_HEADER:"assets",REMOTE_HEADER:"remote",NATIVE_HEADER:"native",BUNDLE_SCRIPTS_HEADER:"bundle-scripts",SCRIPT_NAME:"index.js",CONFIG_NAME:"config.json",BUNDLE_ZIP_NAME:"res.zip",buildTemplateDir:(0,path_1.join)(Editor.Project.path,"build-templates"),projectTempDir:(0,path_1.join)(Editor.Project.tmpDir,"builder"),globalTempDir:(0,path_1.join)(Editor.App.temp,"builder"),debugMode:!1},window.__manager={__taskId:"",taskManager:task_config_1.taskManager,currentCompileTask:null,currentBuildTask:null,buildAssetLibrary:null,pluginManager:plugin_1.pluginManager,isCommand:!1,workerManager:sub_process_manager_1.workerManager};const buildTaskMap={};window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),buildTaskMap[__manager.__taskId]&&(buildTaskMap[__manager.__taskId].errorMsg=e.reason)}),Worker.Ipc.send("build-worker:startup"),Worker.Ipc.on("build-worker:init",async(e,r,t)=>{Editor.Metrics.trackTimeStart("builder:worker-init"),await console_1.NewConsole.updateLogLevel(),Build.Utils=Object.assign({},Utils);const{default:a}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await a({requiredModules:["cc","cc/editor/populate-internal-constants","cc/editor/serialization"]});const i=require("cc");window.cc.debug._resetDebugSetting(i.DebugMode.INFO),await(0,redefine_1.overwriteAssetManager)();const{buildAssetLibrary:o}=await Promise.resolve().then(()=>__importStar(require("./builder/manager/asset-library")));await o.initMtimeCache(),window.__manager.buildAssetLibrary=o,window.__manager.isCommand=t,console_1.newConsole.command=t,await plugin_1.pluginManager.init(r),Worker.Ipc.send("build-worker:ready"),Editor.Metrics.trackTimeEnd("builder:worker-init",{output:!0})}),Worker.Ipc.on("build-worker:build",async(e,r,t)=>{Worker.Ipc.send("build-worker:update-progress",r,.01,"processing","Init build task"),__manager.__taskId=r;let a=!0;const i=Date.now();async function o(){delete buildTaskMap[r];const{buildAssetLibrary:e}=await Promise.resolve().then(()=>__importStar(require("./builder/manager/asset-library")));await e.saveMtimeCache(),console.debug(`================================ Build Task (${t.outputName}) Finished in (${Date.now()-i})ms ================================`),console_1.newConsole.stopRecord(),__manager.currentBuildTask=null}try{const{BuildTask:e}=await Promise.resolve().then(()=>__importStar(require("./builder/index")));console_1.newConsole.record(r,t.platform,t.logDest),console.debug(`=================================== Build Task (${t.outputName}) Start ================================`),console.debug("Start build task, options:",t),console.debug("Build with Cocos Creator "+Editor.App.version),Editor.Metrics.trackTimeStart("builder:build-project-total");const i=buildTaskMap[r]=new e(r,t);__manager.currentBuildTask=i,i.on("update",(e,t)=>{Worker.Ipc.send("build-worker:update-progress",r,t,"processing",e)}),await i.build();const s=await Editor.Metrics.trackTimeEnd("builder:build-project-total",{output:!0});if(i.staticsInfo.time=s,a=!i.error,i.error){const e=i.error.stack||i.error.message;i.staticsInfo.err=e,Worker.Ipc.send("build-worker:update-progress",r,1,"failure",(0,index_1.getRealTime)()+" Build failed!"+e)}else console.debug(`build success in ${i.staticsInfo.time} ms!`),await o(),Worker.Ipc.send("build-worker:update-progress",r,1,"success",(0,index_1.getRealTime)()+` Build success in ${i.staticsInfo.time} ms!`,console_1.newConsole.logDest);Worker.Ipc.send("build-worker:add-statistics",i.staticsInfo),delete buildTaskMap[r];const{buildAssetLibrary:n}=await Promise.resolve().then(()=>__importStar(require("./builder/manager/asset-library")));await n.saveMtimeCache()}catch(e){buildTaskMap[r]&&!buildTaskMap[r].error===e?await buildTaskMap[r].onError():console.error(e),delete buildTaskMap[r],a=!1,await o(),Worker.Ipc.send("build-worker:update-progress",r,1,"failure",(0,index_1.getRealTime)()+" build failed!"+e.message)}e.reply(null,a)}),Worker.Ipc.on("build-worker:excute-build-stage",async(e,r,t)=>{if(__manager.currentCompileTask&&__manager.currentCompileTask.root===t.root||__manager.currentBuildTask&&__manager.currentBuildTask.result.paths.dir===t.root)return console.error("The current directory is busy, please try again later"),void e.reply(null,!1);let a=!0;function i(e,r,a){Worker.Ipc.send("build-worker:update-build-stage-progress",t.buildTaskId,e,r,a)}try{console_1.newConsole.record(t.buildTaskId,t.platform);const o=t.nextStages?[r,...t.nextStages]:[r];let s=1/o.length;const n=o.map(e=>plugin_1.pluginManager.getCustomBuildStageTasks(t.platform,e)),l=!!n.find(e=>null===e||void 0===e?void 0:e.showProgressBar);for(let o=0;o<n.length;o++){const u=n[o];if(s*=o+1,!u)return console.error(`No Build stage ${r}`),i(1,"failure",(0,index_1.getRealTime)()+`No Build stage ${r}`),a=!1,void e.reply(null,a);const c=new stage_task_manager_1.BuildStageTask(Object.assign({hooksInfo:plugin_1.pluginManager.getHooksInfo(t.platform),root:t.root},u));__manager.currentCompileTask=c,l&&c.on("update",(e,r)=>{i(r*s,"processing",e),console.log(`[task:${u.name}]: ${e}, ${100*r}%`)}),await c.run(),c.error?(console.error(`${u.name} package ${t.root} failed!`),l&&i(1*s,"failure",(0,index_1.getRealTime)()+` ${u.name} package ${t.root} failed!`),console.log(`[task:${u.name}]: failed!`),a=!1):(l&&i(1*s,"success",(0,index_1.getRealTime)()+` ${u.name} package ${t.root} success!`),console.log(`[task:${u.name}]: success!`),a=!0)}}catch(e){console.error(e),console.error(`Run build stage[${r}] in package ${t.root} failed!`),i(1,"failure",(0,index_1.getRealTime)()+` Run build stage[${r}] in package ${t.root} failed!`),a=!1}console_1.newConsole.stopRecord(),__manager.currentCompileTask=null,e.reply(null,a)}),Worker.Ipc.on("build-worker:preview-pac",async(e,r)=>{try{console.time(`preview pac ${r}`);const t=await texture_packer_1.default.generatePreviewFiles(r);console.timeEnd(`preview pac ${r}`),e.reply(null,t)}catch(r){console.error(r),e.reply(r,null)}}),Worker.Ipc.on("build-worker:query-atlas-files",async(e,r)=>{try{const t=await texture_packer_1.default.queryPreviewFiles(r);e.reply(null,t)}catch(r){console.error(r),e.reply(r,null)}}),Worker.Ipc.on("build-worker:generate-preview-setting",async(e,r,t)=>{try{t.preview=!0;const{BuildTask:a}=await Promise.resolve().then(()=>__importStar(require("./builder/index"))),i=new a(r,t);i.on("update",(e,r)=>{Worker.Ipc.send("build-worker:update-progress","preview",e,"processing",r)}),console.time("Get settings.js in preview");const o=await i.getPreviewSettings(),s={};for(const e of i.cache.scriptUuids){const r=i.cache.getAssetInfo(e);s[(0,index_1.removeDbHeader)(r.source).replace(/.ts$/,".js")]=r.library[".js"]}console.timeEnd("Get settings.js in preview"),e.reply(null,{settings:o,script2library:s,bundleConfigs:i.result.bundles.map(e=>e.config)})}catch(r){e.reply(r,null)}}),Worker.Ipc.on("build-worker:change-log-level",async(e,r)=>{await console_1.NewConsole.updateLogLevel(r),e.reply(null,!0)}),Worker.Ipc.on("build-worker:build-plugin-changed",async(e,r,t)=>{await plugin_1.pluginManager[r](t),e.reply(null,!0)}),Worker.Ipc.on("build-worker:query-task-map",async e=>{e.reply(null,task_config_1.taskManager.tasks)}),Worker.Ipc.on("build-worker:change-debug-mode",async(e,r)=>{Build.debugMode=r,e.reply(null,task_config_1.taskManager.tasks)}),Worker.Ipc.on("build-worker:change-cache-config",async(e,r,t)=>{task_config_1.taskManager.cacheConfig[r]=t}),console.timeEnd("builder:startup");