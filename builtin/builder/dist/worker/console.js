"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.newConsole=exports.rawConsole=exports.NewConsole=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./builder/utils/index"),utils_1=require("../share/utils"),logger=require("@base/electron-logger"),logLevelMap={error:1,warn:2,log:3,debug:4};class NewConsole{constructor(){this.command=!1,this.messages=[],this.id="default",this.logDest=(0,path_1.join)(NewConsole.logDest,"normal.log")}static async updateLogLevel(e){((e=e||await Editor.Profile.getConfig("builder","log.level"))||Object.values(logLevelMap).includes(Number(e)))&&logger.setLevel(3)}record(e,s,t){this.id=e,this.logDest=t||(0,path_1.join)(NewConsole.logDest,`${s+(0,utils_1.changeToLocalTime)(e).replace(":","-")}.log`),(0,fs_1.existsSync)(this.logDest)||(0,fs_extra_1.outputFileSync)(this.logDest,""),exports.rawConsole.debug(`Start record console... {file(${this.logDest})}`)}stopRecord(){exports.rawConsole.debug(`Stop record console. {file(${this.logDest})}`),this.id=""}log(...e){exports.rawConsole.log(...e),this&&this.messages.push({type:"log",value:e}),this&&this.save()}error(e){exports.rawConsole.error(e),this&&this.messages.push({type:"error",value:e}),this&&this.save()}warn(...e){exports.rawConsole.warn(...e),this&&this.messages.push({type:"warn",value:e}),this&&this.save()}debug(...e){exports.rawConsole.log(...e),this&&this.messages.push({type:"debug",value:e}),this&&this.save()}async save(){if(!this.messages.length)return;const e=this.messages.shift();await this.saveLog(e.type,e.value)}async saveLog(e,s){if(!this.id||!s||!(0,fs_1.existsSync)(this.logDest))return;const t=`${(0,index_1.getRealTime)()}-${e}: ${translate(s)}\n`;(0,fs_extra_1.appendFile)(this.logDest,t),this.command&&Worker.Ipc.send("build-worker:stdout",e,t)}}function translate(e){if("string"==typeof e&&!e.includes("\n")||"number"==typeof e)return String(e);if("string"==typeof e&&e.includes("\n"))return translate(e.split("\n"));if("object"==typeof e){if(Array.isArray(e)){let s="";return e.forEach(e=>{s+=`${translate(e)}\r`}),s}try{return e.stack?translate(e.stack):JSON.stringify(e)}catch(e){}}return e&&e.toString&&e.toString()}exports.NewConsole=NewConsole,NewConsole.logDest=(0,path_1.join)(Editor.Project.path,"temp","builder","log"),exports.rawConsole=console,exports.newConsole=new NewConsole,exports.newConsole.__proto__.__proto__=exports.rawConsole,window.console=exports.newConsole;