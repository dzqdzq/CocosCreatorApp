"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.newConsole=exports.NewConsole=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../share/utils"),electron_logger_1=__importDefault(require("@base/electron-logger")),memory_track_1=require("./builder/utils/memory-track"),logLevelMap={error:1,warn:2,log:3,debug:4};let rawConsole;class NewConsole{constructor(){this.command=!1,this.messages=[],this._groupNames=[],this.memoryTrackMap=new Map,this.id="default",this.logDest=(0,path_1.join)(NewConsole.logDest,"normal.log"),this._start=!1,this._hasLogFile=!1,rawConsole=console.__rawConsole?console.__rawConsole:console,this.__proto__.__proto__=rawConsole}static async updateLogLevel(e){((e=e||await Editor.Profile.getConfig("builder","log.level"))||Object.values(logLevelMap).includes(Number(e)))&&electron_logger_1.default.setLevel(3)}switchConsole(e){this._start?this._console=e:e.record()}record(e,s){try{this.logDest=Editor.UI.__protected__.File.resolveToRaw(s),(0,fs_1.existsSync)(this.logDest)||(0,fs_extra_1.outputFileSync)(this.logDest,"")}catch(e){return console.debug(e),void console.debug(`Create log file failed. {file(${this.logDest})}`)}this._start=!0,this.id=e,this._hasLogFile=!0,window.console=this,rawConsole.debug(`Start record console... {file(${this.logDest})}`)}stopRecord(){if(this._start=!1,this._groupNames.length=0,rawConsole.debug(`Stop record console. {file(${this.logDest})}`),window.console=rawConsole,this.id="",this._console)return this._console.record(),void delete this._console}log(...e){rawConsole.log(...e),this&&this.messages.push({type:"log",value:e}),this&&this.save()}error(e){filterErrorToConsole(e)?rawConsole.error(e):rawConsole.debug(e),this&&this.messages.push({type:"error",value:e}),this&&this.save()}warn(...e){rawConsole.warn(...e),this&&this.messages.push({type:"warn",value:e}),this&&this.save()}debug(...e){rawConsole.debug(...e),this&&this.messages.push({type:"debug",value:e}),this&&this.save()}group(e){rawConsole.group(e),this._groupNames.push(e),this&&this.messages.push({type:"group",value:[e]}),this&&this.save()}groupEnd(){rawConsole.groupEnd();const e=this._groupNames.pop();this&&this.messages.push({type:"groupEnd",value:[e]}),this&&this.save()}groupCollapsed(e){rawConsole.groupCollapsed(e),this._groupNames.push(e),this&&this.messages.push({type:"groupCollapsed",value:[e]}),this&&this.save()}async save(){if(!this.messages.length)return;const e=this.messages.shift();e&&await this.saveLog(e.type,e.value)}async saveLog(e,s){if(!this._start||!s||!this._hasLogFile)return;const t=`${(0,utils_1.getCurrentTime)()}-${e}: ${translate(s)}\n`;(0,fs_extra_1.appendFile)(this.logDest,t),this.command&&Worker.Ipc.send("build-worker:stdout",e,t)}trackMemoryStart(e){const s=process.memoryUsage().heapUsed;return this.memoryTrackMap.set(e,s),s}trackMemoryEnd(e,s=!0){const t=this.memoryTrackMap.get(e);if(!t)return 0;const o=process.memoryUsage().heapUsed;this.memoryTrackMap.delete(e);const r=o-t;return s?(console.debug(`[Build Memory track]: ${e} start:${(0,memory_track_1.formateBytes)(t)}, end ${(0,memory_track_1.formateBytes)(o)}, increase: ${(0,memory_track_1.formateBytes)(r)}`),s):r}}function filterErrorToConsole(e){return!(e.toString()||"").match(/^\[build-script\]\[BABEL\].*?it exceeds the max of 500KB.\n$/g)}function translate(e){if("string"==typeof e&&!e.includes("\n")||"number"==typeof e)return String(e);if("string"==typeof e&&e.includes("\n"))return translate(e.split("\n"));if("object"==typeof e){if(Array.isArray(e)){let s="";return e.forEach(e=>{s+=`${translate(e)}\r`}),s}try{return e.stack?translate(e.stack):JSON.stringify(e)}catch(e){}}return e&&e.toString&&e.toString()}exports.NewConsole=NewConsole,NewConsole.logDest=(0,path_1.join)(Editor.Project.path,"temp","builder","log"),exports.newConsole=new NewConsole;