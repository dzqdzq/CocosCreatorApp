"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const platforms_options_1=require("../share/platforms-options"),CustomAssetHandlerTypes=["compressTextures"];class PluginManager{constructor(){this.assetHandlers={},this.pkgPriorities={},this.hookInfos={},this.customBuildStages={},this.hasOnLoaded={},this.hasOnUnloaded={};const s={};platforms_options_1.PLATFORMS.forEach(e=>{s[e]={}}),CustomAssetHandlerTypes.forEach(s=>{this.assetHandlers[s]={}}),this.builderPathsMap=s,this.customBuildStages=JSON.parse(JSON.stringify(s))}async init(s){await Promise.all(s.map(s=>this.register(s)))}async register(s){this.pkgPriorities[s.pkgName]=s.priority,this.hookInfos[s.pkgName]=s;try{if(s.assetHandlers){const e=Editor.Module.requireFile(s.assetHandlers);for(const t of CustomAssetHandlerTypes)e[t]&&(this.assetHandlers[t]?this.assetHandlers[t][s.pkgName]=e[t]:this.assetHandlers[t]={[s.pkgName]:e[t]})}if(s.hooks)for(const e of Object.keys(s.hooks)){const t=s.hooks[e],o=Editor.Module.requireFile(t);o.load&&!this.hasOnLoaded[t]&&(this.hasOnLoaded[t]=!0,this.hasOnUnloaded[t]=!1,await o.load()),this.builderPathsMap[e][s.pkgName]=t}if(s.customBuildStages)for(const e of Object.keys(s.customBuildStages))this.customBuildStages[e][s.pkgName]=s.customBuildStages[e]}catch(e){console.error(e),console.error(`register plugin ${s.pkgName} in build worker failed!`)}}async unregister(s){try{delete this.pkgPriorities[s.pkgName],s.assetHandlers&&Editor.Module.removeCache(s.assetHandlers),CustomAssetHandlerTypes.forEach(e=>{delete this.assetHandlers[e][s.pkgName]});for(const e of platforms_options_1.PLATFORMS){if(this.builderPathsMap[e]&&delete this.builderPathsMap[e][s.pkgName],!s.hooks||!s.hooks[e]||this.hasOnUnloaded[s.hooks[e]])continue;const t=Editor.Module.requireFile(s.hooks[e]);t.unload&&!this.hasOnUnloaded[s.hooks[e]]&&(this.hasOnUnloaded[s.hooks[e]]=!0,this.hasOnLoaded[s.hooks[e]]=!1,await t.unload()),Editor.Module.removeCache(s.hooks[e])}}catch(e){console.error(e),console.error(`unregister plugin ${s.pkgName} in build worker failed!`)}}getAssetHandlers(s){const e=Object.keys(this.assetHandlers[s]);return{pkgNameOrder:this.sortPkgNameWidthPriority(e),handles:this.assetHandlers[s]}}getHooksInfo(s){const e={pkgNameOrder:[],infos:{}};return Object.keys(this.builderPathsMap[s]).forEach(t=>{e.infos[t]={path:this.builderPathsMap[s][t],internal:platforms_options_1.builtinPlugins.includes(t)}}),e.pkgNameOrder=this.sortPkgNameWidthPriority(Object.keys(e.infos)),e}getCustomBuildStageTasks(s,e){const t=this.customBuildStages[s];if(!t)return null;const o=this.sortPkgNameWidthPriority(Object.keys(t));for(const s of o){const o=t[s].find(s=>s.name===e);if(o)return o}return null}sortPkgNameWidthPriority(s){return s.sort((s,e)=>!platforms_options_1.platformPlugins.includes(s)&&platforms_options_1.platformPlugins.includes(e)?1:platforms_options_1.platformPlugins.includes(s)&&!platforms_options_1.platformPlugins.includes(e)?-1:this.pkgPriorities[e]-this.pkgPriorities[s])}}exports.pluginManager=new PluginManager;