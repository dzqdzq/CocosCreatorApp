"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const platforms_options_1=require("../share/platforms-options"),CustomAssetHandlerTypes=["compressTextures"];class PluginManager{constructor(){this.assetHandlers={},this.pkgPriorities={},this.hookInfos={};const s={};platforms_options_1.PLATFORMS.forEach(e=>{s[e]={}}),CustomAssetHandlerTypes.forEach(s=>{this.assetHandlers[s]={}}),this.builderPathsMap=s}async init(s){await Promise.all(s.map(s=>this.register(s)))}async register(s){this.pkgPriorities[s.pkgName]=s.priority,this.hookInfos[s.pkgName]=s;try{if(s.assetHandlers){const e=Editor.Module.requireFile(s.assetHandlers);for(const t of CustomAssetHandlerTypes)e[t]&&(this.assetHandlers[t]?this.assetHandlers[t][s.pkgName]=e[t]:this.assetHandlers[t]={[s.pkgName]:e[t]})}if(s.hooks)for(const e of Object.keys(s.hooks)){const t=Editor.Module.requireFile(s.hooks[e]);t.load&&await t.load(),this.builderPathsMap[e][s.pkgName]=s.hooks[e]}}catch(e){console.error(e),console.error(`register plugin ${s.pkgName} in build worker failed!`)}}async unregister(s){try{delete this.pkgPriorities[s.pkgName],s.assetHandlers&&delete this.pkgPriorities[s.assetHandlers],CustomAssetHandlerTypes.forEach(e=>{delete this.assetHandlers[e][s.pkgName]});for(const e of platforms_options_1.PLATFORMS){if(!s.hooks||!s.hooks[e])continue;const t=Editor.Module.requireFile(s.hooks[e]);await t.unload(),Editor.Module.removeCache(s.hooks[e]),delete this.builderPathsMap[e][s.pkgName]}}catch(e){console.error(e),console.error(`unregister plugin ${s.pkgName} in build worker failed!`)}}getAssetHandlers(s){const e=Object.keys(this.assetHandlers[s]);return e.sort((s,e)=>this.pkgPriorities[s]-this.pkgPriorities[e]),{pkgNameOrder:e,handles:this.assetHandlers[s]}}getHooksInfo(s){const e={pkgNameOrder:[],infos:{}};return Object.keys(this.builderPathsMap[s]).forEach(t=>{e.infos[t]={path:this.builderPathsMap[s][t],internal:platforms_options_1.builtinPlugins.includes(t)}}),e.pkgNameOrder=Object.keys(e.infos).sort((s,e)=>!platforms_options_1.platformPlugins.includes(s)&&platforms_options_1.platformPlugins.includes(e)?1:platforms_options_1.platformPlugins.includes(s)&&!platforms_options_1.platformPlugins.includes(e)?-1:this.pkgPriorities[e]-this.pkgPriorities[s]),e}}exports.pluginManager=new PluginManager;