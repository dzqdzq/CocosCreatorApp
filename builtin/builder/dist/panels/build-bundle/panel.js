"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;const utils_1=require("../../share/utils");let panel=null,vm=null;const LogDestDir=(0,path_1.join)(Editor.Project.tmpDir,"builder","log");async function ready(e){panel=this,initVm(e)}function initVm(e){console.time("vue.init"),e&&(e.output=!0),vm=new Vue({el:panel.$.container,data:()=>({taskInfo:{buildTaskIds:[],dest:"project://build/build-bundle",progress:0,message:"waiting",id:"buildBundle",state:"none"},taskMap:[],buildTaskFree:!0,currentBundle:e,logFile:"",openType:"openFile",bundles:[],isBuildWorkerReady:!1}),computed:{bundleBuildPlatformTips(){return this.currentBundle?Editor.I18n.t("builder.asset_bundle.bundleBuildPlatformTips",{bundleUrl:(0,path_1.basename)(this.currentBundle.root)}):""},maskInfo(){return this.isBuildWorkerReady?this.bundles.length?"":"i18n:builder.asset_bundle.emptyBundle":"i18n:builder.tips.waiting_for_worker_ready"}},async mounted(){this.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),this.initData()},methods:{async initData(){const{free:e,queue:t}=await Editor.Message.request("builder","query-tasks-info");this.taskMap=Object.values(t).filter(e=>"build"===e.type),await this.initBundleInfo(),this.buildTaskFree=e,this.openType=await Editor.Profile.getConfig("builder","log.openType"),this.taskMap.length&&(this.taskInfo.buildTaskIds=[this.taskMap[0].id])},async initBundleInfo(){const e=await Editor.Message.request("asset-db","query-assets",{isBundle:!0},["meta"]);e.length&&(this.bundles=e.map(e=>({root:e.url,name:e.meta.userData.bundleName||(0,path_1.basename)(e.url),output:!0})),this.updateCurrentBundle(this.currentBundle||this.bundles[0]))},onSelectBundle(e){const{value:t}=e.target;this.updateCurrentBundle(this.bundles.find(e=>e.root===t))},updateCurrentBundle(e){e&&this.bundles.find(t=>t.root===e.root)||(e=this.bundles[0]),this.currentBundle=e,this.findLastedLog()},async findLastedLog(){if(!(0,fs_extra_1.existsSync)(LogDestDir))return;const e=(await(0,fs_extra_1.readdir)(LogDestDir)).filter(e=>e.startsWith("build-bundle-"));e.length&&(e.sort((e,t)=>(0,utils_1.transTimeToNumber)(t)-(0,utils_1.transTimeToNumber)(e)),this.logFile=(0,path_1.join)(LogDestDir,e[0]))},onToggleTask(e,t){e?this.taskInfo.buildTaskIds=[...this.taskInfo.buildTaskIds,t]:this.taskInfo.buildTaskIds.splice(this.taskInfo.buildTaskIds.findIndex(e=>e===t),1)},updateTasks(e){this.taskInfo.progress=e.progress,this.taskInfo.state=e.state,this.taskInfo.message=e.message},async openLog(){const e=Editor.UI.__protected__.File.resolveToRaw(this.logFile);if("openFileDir"===this.openType)electron_1.shell.showItemInFolder(e);else{await Editor.Message.request("program","open-program","scriptEditor",{_args:[e]})||electron_1.shell.openPath(e)}},async openBuildPanel(e,t){Editor.Message.send("builder","open","",e,t)},async onBuild(){const e=(0,utils_1.getTaskLogDest)("build-bundle-",Date.now());this.logFile=e;const t=await Editor.Message.request("builder","add-bundle-task",{buildTaskIds:this.taskInfo.buildTaskIds,dest:this.taskInfo.dest,id:this.taskInfo.id,bundleConfigs:[this.currentBundle],taskName:"build bundle "+this.currentBundle.root,logDest:e});1!==t&&(0===t?this.taskInfo.message="i18n:builder.asset_bundle.buildBundleBusy":2===t&&(this.taskInfo.message="i18n:builder.asset_bundle.buildBundleParams"),this.taskInfo.state="failed")},async onButtonClick(){"failure"!==this.taskInfo.state&&await Editor.Message.request("builder","break-task",this.taskInfo.id),this.taskInfo.state="none"}}}),console.timeEnd("vue.init")}async function updateVmAssetInfo(e,t){vm&&("directory"!==t.importer||await vm.initBundleInfo())}async function beforeClose(){if(vm.taskInfo&&"processing"===vm.taskInfo.state){return 1===(await Editor.Dialog.info(Editor.I18n.t("builder.asset_bundle.bundleBuildCloseTip"),{buttons:[Editor.I18n.t("builder.confirm"),Editor.I18n.t("builder.cancelBuild")],cancel:0,default:0})).response&&(Editor.Message.send("builder","break-task",vm.taskInfo.id),!0)}return!0}async function close(){}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/build-bundle.css"),"utf8"),exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/template/build-bundle.html"),"utf8"),exports.$={container:".build-bundle"},exports.methods={async"bundle-task:changed"(e,t,s){vm&&e&&e===vm.taskInfo.id&&await vm.updateTasks(t,s)},"builder:task-add"(e,t){"build"===t.type&&(vm.taskMap.splice(0,0,t),vm.taskInfo.buildTaskIds.length||vm.taskInfo.buildTaskIds.push(t.id))},"builder:task-delete"(e,t){vm.taskMap=vm.taskMap.filter(t=>t.id!==e),vm.taskInfo.buildTaskIds=vm.taskInfo.buildTaskIds.filter(t=>t!==e)},"asset-db:asset-delete":updateVmAssetInfo,"asset-db:asset-add":updateVmAssetInfo,"asset-db:asset-change":updateVmAssetInfo,async onBuildWorkerReady(){vm.isBuildWorkerReady=!0,await vm.initData()},onBuildWorkerClosed(){vm.isBuildWorkerReady=!1,console.debug("onBuildWorkerClosed")},changeBuildBundle(e){e&&vm.updateCurrentBundle(vm.bundles.find(t=>t.root===e.root))}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;