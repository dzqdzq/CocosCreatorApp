"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),axios_1=__importDefault(require("axios"));let vm,panel=null;const Vue=require("vue/dist/vue.js");async function ready(){vm=new Vue({el:(panel=this).$.splash,data:{settings:{url:Editor.App.icon,displayRatio:.4,totalTime:3e3,clearColor:{x:.88,y:.88,z:.88,w:1},displayWatermark:!0},imageSrc:"",clearColor:null,imgDragState:"",loadingImage:!1,dirty:!1,hasSetSplash:!0,questionSrc:`http://creator-web.cocos.org/question3d?projectId=${Editor.Project.uuid}`,netStatus:"loading",tipsInfo:"Loading"},methods:{async onConfirm(e){let t=e.target.getAttribute("name");if(!t)return;let s=e.target.value;const i=this;switch(i.dirty=!0,t){case"clearColor":s={x:s[0]/255,y:s[1]/255,z:s[2]/255,w:s[3]/255};break;case"image":t="url";const e=await Editor.Message.request("asset-db","query-asset-info",s);if(!e)return void console.error(`Can't get asset info(${s}) from uuid`);i.imageSrc=e.file,s=Editor.UI.File.resolveToUrl(i.imageSrc,e.path.startsWith("db://internal")?"app":"project");break;case"image-url":t="url",i.imageSrc=Editor.UI.File.resolveToRaw(s)}i.settings[t]=s,i.saveSettings(t,s)},async saveSettings(e,t){await Editor.Profile.setProject("builder",`splash-setting.${e}`,t),this.dirty=!1},async getQuestionnaire(){const e=this;let t;try{t=await axios_1.default.get(`http://creator-web.cocos.org/api/question3D/getQuestionnaire?projectId=${Editor.Project.uuid}`)}catch(t){return console.error(t),e.tipsInfo=t.toString(),void(e.netStatus="failed")}200===t.status?("SUCCESS"===t.data.code&&(e.hasSetSplash=!0,Editor.Profile.setProject("builder","hasSetSplash",!0)),e.netStatus="success"):e.tipsInfo=t.toString()},async initData(){const e=this,t=await Editor.Profile.getProject("builder","splash-setting");e.settings=Object.assign(e.settings,t),e.imageSrc=Editor.UI.File.resolveToRaw(e.settings.url);const s=["x","y","z","w"].map(t=>255*e.settings.clearColor[t]);e.clearColor=JSON.stringify(s)}},async mounted(){this.netStatus="success",await this.initData()}})}function onWebviewNewWindow(e){Editor.Profile.setProject("builder","hasSetSplash",!0),vm.hasSetSplash=!0}async function beforeClose(){panel.$.webview.removeEventListener("will-navigate",onWebviewNewWindow);const e=function e(t=document){return t.activeElement&&t.activeElement.shadowRoot?e(t.activeElement.shadowRoot):t.activeElement}();return e?(e.blur&&e.blur(),await new Promise(e=>{setTimeout(()=>{e()},30)}),await checkIsSave()):await checkIsSave()}async function close(){}async function checkIsSave(){if(!vm||!vm.dirty)return;const e=Editor.I18n.t,t=await Editor.Dialog.warn(e("builder.splash_setting.is_save_dialog.title"),{buttons:[e("builder.splash_setting.is_save_dialog.save"),e("builder.splash_setting.is_save_dialog.cancel"),e("builder.splash_setting.is_save_dialog.abort")],default:0,cancel:1});return 1!==t.response&&(0===t.response&&await vm.saveSettings(),!0)}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../../dist/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static/template/splash-setting.html"),"utf8"),exports.$={splash:".splash",webview:".webview"},exports.methods={},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;