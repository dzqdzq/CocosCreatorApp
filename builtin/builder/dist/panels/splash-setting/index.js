"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),axios_1=__importDefault(require("axios"));let vm,panel=null;const Vue=require("vue/dist/vue.js");async function ready(){vm=new Vue({el:(panel=this).$.splash,data:{settings:{base64src:"",displayRatio:.4,totalTime:3e3,clearColor:{x:.88,y:.88,z:.88,w:1},displayWatermark:!0},clearColor:null,imgDragState:"",loadingImage:!1,dirty:!1,hasSetSplash:!0,questionSrc:`http://creator-web.cocos.org/question3d?projectId=${Editor.Project.uuid}`,netStatus:"loading",tipsInfo:"Loading"},methods:{async onConfirm(e){const t=e.target.getAttribute("name");if(!t)return;let s=e.target.value;this.dirty=!0,"clearColor"===t&&(s={x:s[0]/255,y:s[1]/255,z:s[2]/255,w:s[3]/255}),this.settings[t]=s,this.saveSettings(t,s)},onAreaDragOver(e){const t=e.target;Editor.UI.DragArea.currentDragInfo&&(this.imgDragState=t.hoving||t.additional?"allow":"refused")},onAreaDragLeave(e){this.imgDragState=""},onAreaDrop(e){const t=e.target,s=this;if(s.imgDragState="",t.additional){const e=t.droppable,a=Editor.UI.DragArea.currentDragInfo.additional;if(a)for(const t of a)if(e.includes(t.type))return void s.setImgBase64(t.value)}s.setImgBase64(e.dataTransfer.getData("value")||e.dataTransfer.files[0])},async setImgBase64(e){if(!e)return;const t=this;let s="";if("string"==typeof e){t.loadingImage=!0;const a=await Editor.Message.request("asset-db","query-asset-info",e);if(!a)return void(t.loadingImage=!1);s=a.file}if((s=e.path||s)&&fs_1.existsSync(s)){t.loadingImage=!0,t.dirty=!0;const e=fs_1.readFileSync(s);t.settings.base64src=`data:image/png;base64,${e.toString("base64")}`,t.saveSettings("base64src",t.settings.base64src),t.loadingImage=!1}},async saveSettings(e,t){await Editor.Profile.setProject("builder",`splash-setting.${e}`,t),this.dirty=!1},async getQuestionnaire(){const e=this;let t;try{t=await axios_1.default.get(`http://creator-web.cocos.org/api/question3D/getQuestionnaire?projectId=${Editor.Project.uuid}`)}catch(t){return console.error(t),e.tipsInfo=t.toString(),void(e.netStatus="failed")}200===t.status?("SUCCESS"===t.data.code&&(e.hasSetSplash=!0,Editor.Profile.setProject("builder","hasSetSplash",!0)),e.netStatus="success"):e.tipsInfo=t.toString()},async initData(){const e=await Editor.Profile.getProject("builder","splash-setting");this.settings=Object.assign(this.settings,e);const t=["x","y","z","w"].map(t=>255*e.clearColor[t]);this.clearColor=JSON.stringify(t)}},async mounted(){this.netStatus="success",await this.initData()}})}function onWebviewNewWindow(e){Editor.Profile.setProject("builder","hasSetSplash",!0),vm.hasSetSplash=!0}async function beforeClose(){panel.$.webview.removeEventListener("will-navigate",onWebviewNewWindow);const e=function e(t=document){return t.activeElement&&t.activeElement.shadowRoot?e(t.activeElement.shadowRoot):t.activeElement}();return e?(e.blur&&e.blur(),await new Promise(e=>{setTimeout(()=>{e()},30)}),await checkIsSave()):await checkIsSave()}async function close(){}async function checkIsSave(){if(!vm||!vm.dirty)return;const e=Editor.I18n.t,t=await Editor.Dialog.warn(e("builder.splash_setting.is_save_dialog.title"),{buttons:[e("builder.splash_setting.is_save_dialog.save"),e("builder.splash_setting.is_save_dialog.cancel"),e("builder.splash_setting.is_save_dialog.abort")],default:0,cancel:1});return 1!==t.response&&(0===t.response&&await vm.saveSettings(),!0)}Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../../dist/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static/template/splash-setting.html"),"utf8"),exports.$={splash:".splash",webview:".webview"},exports.methods={},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;