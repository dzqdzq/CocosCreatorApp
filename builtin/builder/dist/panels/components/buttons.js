"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.name=exports.props=exports.template=void 0;const plugin_1=require("../plugin");function data(){return{buttonConfig:{buttons:[]}}}function mounted(){Object.keys(plugin_1.pluginManager.platformMap).length&&(this.buttonConfig=this.calcBuildConfig())}exports.template='\n<div v-if="task" class="buttons" @dblclick.stop>\n    <template class="options">\n        <template\n            v-for="(configItem, index) in buttonConfig.buttons"\n        >\n            <ui-button\n                v-if="index !== 0"\n                class="transparent icon-button"\n                :disabled="isButtonDisabled(buttonConfig.buttons[index - 1])"\n                @confirm.stop="linkBuildStage(buttonConfig.buttons[index - 1].name, configItem.name)"\n                @mousedown.stop\n            >\n                <ui-icon value="link"></ui-icon>\n            </ui-button>\n            <ui-button class="group"\n                v-if="configItem.groupItems"\n                :key="configItem.name + !!configItem.groupItems"\n                :disabled="isButtonDisabled(configItem)"\n                @confirm.stop="onButtonConfirm(configItem)"\n                @mousedown.stop\n                @mouseover.stop\n            >\n                <ui-label\n                    :tooltip="configItem.description"\n                    :value="configItem.displayName || configItem.name"\n                ></ui-label>\n                <template\n                    v-for="(groupItem, groupIndex) in configItem.groupItems"\n                >\n                    <ui-button class="transparent icon-button"\n                        :disabled="isButtonDisabled(configItem)"\n                        @mousedown.stop\n                        @confirm.stop="unlinkBuildStage(configItem.name, groupItem.name)"\n                    >\n                        <ui-icon value="unlink"></ui-icon>\n                        <ui-icon value="to-right-arrow"></ui-icon>\n                    </ui-button>\n                    <ui-label\n                        :key="groupItem.name + index"\n                        :tooltip="groupItem.description"\n                        :value="groupItem.displayName || groupItem.name"\n                    ></ui-label>\n                </template>\n            </ui-button>\n            <template v-else>\n                <ui-button\n                    class="single"\n                    :key="configItem.name"\n                    :disabled="isButtonDisabled(configItem)"\n                    @mousedown.stop\n                    @confirm.stop="onButtonConfirm(configItem)"\n                >\n                    <ui-label :value="configItem.displayName || configItem.name"></ui-label>\n                </ui-button>\n            </template>\n        </template>\n    </template>\n    <div class="custom" v-if="buttonConfig.custom">\n        <ui-panel :src="buttonConfig.custom"></ui-panel>\n    </div>\n</div>\n',exports.props=["task","type","free","checkRes"],exports.name="buttons",exports.data=data,exports.watch={"task.options.platform"(t,o){this.buttonConfig=this.calcBuildConfig()}},exports.computed={isDisabled(){const t=this.task;return"processing"===t.state||"waiting"===t.state||!t.id||!plugin_1.pluginManager.platformMap[t.options.platform]},isBuildDisabled(){const{task:t,type:o,checkRes:n,free:i}=this;return"list"!==o&&!n||"new"!==o&&(!i||"processing"===t.state||"waiting"===t.state)||!plugin_1.pluginManager.platformMap[t.options.platform]},runDisabled(){return"failure"===this.task.state||this.isDisabled},buildToolTip(){const t=this;return!1===t.checkRes?"i18n:builder.error.check_options_failed":"new"===t.type||t.free&&"processing"!==t.task.state&&"waiting"!==t.task.state?plugin_1.pluginManager.platformMap[t.task.options.platform]?"":Editor.I18n.t("i18n:builder.tips.platform_missing",{platform:t.task.options.platform}):"i18n:builder.tips.task_busy"}},exports.methods={async onButtonConfirm(t){const o=this;"build"===t.name?o.onBuild():(Editor.Message.request("builder","excute-build-stage",t.name,{buildTaskId:o.task.id}),o.$root.showSettings=!1)},checkDelisted(){return new Promise(async t=>{const o=await Editor.Profile.getConfig("utils",`delisted.${this.task.options.platform}`);if(o&&"preDelisted"===o.status){0===(await Editor.Dialog.warn(o.message,{title:Editor.I18n.t("builder.delisted.title"),cancel:0,buttons:[Editor.I18n.t("builder.delisted.confirm")]})).response&&t(!1)}else if(o&&"delisted"===o.status){0===(await Editor.Dialog.error(o.message,{title:Editor.I18n.t("builder.delisted.title"),cancel:0,buttons:[Editor.I18n.t("builder.delisted.confirm")]})).response&&t(!0)}t(!1)})},async onBuild(t){const o=this;if(!await o.checkDelisted()){switch(o.type){case"new":Editor.Message.send("builder","add-task",o.task.options);break;default:Editor.Message.send("builder","recompile-task",o.task.id,o.task.options)}o.$root.showSettings=!1}},isButtonDisabled(t){const o=this;if("build"===t.name)return o.isBuildDisabled;if(o.isDisabled||"new"===o.type||!o.free)return!0;if(o.$root.runningTaskId&&t.lockConfig){const n=o.$root.taskMap[o.$root.runningTaskId];let i=!1;return i=!(!t.lockConfig.platform||"all"!==t.lockConfig.platform&&!t.lockConfig.platform.includes(n.options.platform))||!(!t.lockConfig.stage||"all"!==t.lockConfig.stage&&!t.lockConfig.stage.includes(n.stage))}return!1},linkBuildStage(t,o){const n=this;n.task.options.buildStageGroup=n.task.options.buildStageGroup||{},n.task.options.buildStageGroup[t]=Array.isArray(n.task.options.buildStageGroup[t])?n.task.options.buildStageGroup[t]:[],n.task.options.buildStageGroup[t].push(o),n.task.options.buildStageGroup[o]&&(n.task.options.buildStageGroup[t].push(...n.task.options.buildStageGroup[o]),delete n.task.options.buildStageGroup[o]);const i=Object.keys(n.task.options.buildStageGroup).length?n.task.options.buildStageGroup:void 0;Editor.Profile.setConfig(n.task.options.platform,"common.buildStageGroup",i,"local"),n.task.options.buildStageGroup=i,n.$root.updateTaskOptions(n.task),n.buttonConfig=n.calcBuildConfig()},unlinkBuildStage(t,o){const n=this,i=n.task.options.buildStageGroup[t];if(!Array.isArray(i))return;if(i.length>1){const e=i.splice(i.findIndex(t=>t===o),i.length);e.length>1&&(e.shift(),n.task.options.buildStageGroup[o]=e),i||delete n.task.options.buildStageGroup[t]}else delete n.task.options.buildStageGroup[t];const e=Object.keys(n.task.options.buildStageGroup).length?n.task.options.buildStageGroup:void 0;Editor.Profile.setConfig(n.task.options.platform,"common.buildStageGroup",e,"local"),n.task.options.buildStageGroup=e,n.$root.updateTaskOptions(n.task),n.buttonConfig=n.calcBuildConfig()},calcBuildConfig(){const t=this,o={displayName:"i18n:builder.build",hookHandle:"build",name:"build",description:t.buildToolTip},n=plugin_1.pluginManager.getButtonsConfig(t.task.options.platform);return n&&n.buttons&&0!==n.buttons.length?t.task.options.buildStageGroup&&n.buttons?(n.buttons=JSON.parse(JSON.stringify(n.buttons)),n.buttons.unshift(o),Object.keys(t.task.options.buildStageGroup).forEach(o=>{if(!Array.isArray(t.task.options.buildStageGroup[o]))return;const i=n.buttons.find(t=>t.name===o);if(!i)return;const e=[];t.task.options.buildStageGroup[o].forEach(t=>{const o=n.buttons.findIndex(o=>o.name===t),i=n.buttons[o];if(!i||i&&i.groupItems)return null;n.buttons.splice(o,1),e.push(i)}),e.length&&(i.groupItems=e)}),n):(n.buttons=n.buttons||[],n.buttons.unshift(o),n):{buttons:[o]}}},exports.mounted=mounted;