"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,a){void 0===a&&(a=s),Object.defineProperty(t,a,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,a){void 0===a&&(a=s),t[a]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.created=exports.methods=exports.data=exports.computed=exports.watch=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),electron_1=require("electron"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),utils_1=require("../../browser/migration/utils"),common_options_validator_1=require("../../share/common-options-validator"),globby=require("globby");function data(){return{settingsType:"",taskMap:{},scenes:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0}}async function created(){console.time("Home created");const t=this;t.isDBReady=await Editor.Message.request("asset-db","query-ready"),t.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),await t.initTasks(),t.isDBReady&&(t.scenes=await common_options_validator_1.getCommonOptionDefaultByKey("scenes"),t.scenes.length>0&&0===Object.keys(t.taskMap).length&&t.onNewBuildTask()),t.internalMaskInfo="",console.timeEnd("Home created")}function calcOptionsCheckRes(t,e){if(!t||!e)return!0;for(const s of Object.keys(e))if("packages"===s&&e.packages&&t.packages){for(const s of Object.keys(e.packages))if(!calcOptionsCheckRes(t.packages[s],e.packages[s]))return!1}else if(t[s])return!1;return!0}async function getPakcageVersion(t){const e=await Editor.Package.getPackages({name:t});if(e.length>1){const t=e.find(t=>t.enable);return t&&t.version}return e[0]&&e[0].version}exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../static","/template/components/home.html"),"utf8"),exports.components={task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},exports.watch={"task.options":{deep:!0,handler(t,e){const s=this;"edit"!==s.settingsType||s.task.dirty||s.task.dirty||(s.task.rawOptions=JSON.parse(JSON.stringify(s.options)),s.task.dirty=!0),Editor.Message.send("builder","update-task",s.task.id,s.task.options,s.task.rawOptions)},immediate:!1},async showSettings(t,e){if(!0===t){this.scenes=await common_options_validator_1.getCommonOptionDefaultByKey("scenes")}}},exports.computed={options(){const t=this;return"check"===t.settingsType&&t.task.rawOptions||t.task.options},maskInfo(){return this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?this.internalMaskInfo:"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready"}},exports.data=data,exports.methods={t:Editor.I18n.t,async changeTask(t,e){const s=this;if("boolean"==typeof e&&(s.free=e),!s.taskMap[t])return;s.task=s.taskMap[t];const a=await common_options_validator_1.checkBuildCommondOptions(s.task.options);Object.keys(a).forEach(t=>{a[t]=a[t].error}),s.task.errorMap=a,s.checkRes=calcOptionsCheckRes(s.task.errorMap,s.task.options)},async resetTask(){const t=await Editor.Profile.getConfig("builder","common"),e=await plugin_1.pluginManager.getOptionsByPlatform(t.platform);this.task={progress:0,state:"waiting",options:e,errorMap:{}}},calcOutputName(t,e){if(!t||!e)return"";let s=path_1.join(Editor.UI.File.resolveToRaw(t),e);return s=Editor.Utils.File.getName(s),path_1.basename(s)},updateTasks(t,e,s){const a=this;if(a.free=s,!t||!e)return void this.initTasks();const i=a.taskMap[t];i?a.$set(a.taskMap,t,Object.assign(i,e)):a.$set(a.taskMap,t,e)},async initTasks(){const t=this,{queue:e,free:s}=await Editor.Message.request("builder","query-tasks-info");t.taskMap=e,t.free=s;const a=t.taskMap[t.task.id];if(a&&t.task.id){t.task.state=a.state,t.task.message=a.message,t.task.progress=a.progress,t.task.options=a.options;const e=await common_options_validator_1.checkBuildCommondOptions(t.task.options),s={};Object.keys(e).forEach(t=>{s[t]=e[t].error}),t.task.errorMap=s}},updateTaskOptions(t,e,s){const a=this;t&&e&&(a.$set(a.taskMap[t],"options",e),s&&(a.taskMap[t].rawOptions=s,a.taskMap[t].dirty=!0))},async checkTaskRawOptions(t){(this.taskMap[t].rawOptions||this.taskMap[t].options)&&(this.settingsType="check",await this.changeTask(t),this.showSettings=!0)},async editTaskOptions(t){this.settingsType="edit",await this.changeTask(t),this.showSettings=!0},async onNewBuildTask(){await this.resetTask(),this.settingsType="new",this.showSettings=!0},async clearCache(){const t=await Editor.Dialog.info(Editor.I18n.t("builder.clear_cache.title"),{title:Editor.I18n.t("builder.clear_cache.title"),buttons:[Editor.I18n.t("builder.clear_cache.cancel"),Editor.I18n.t("builder.clear_cache.clear_project_cache"),Editor.I18n.t("builder.clear_cache.clear_global_cache"),Editor.I18n.t("builder.clear_cache.clear_all")],default:1,cancel:0});if(0!==t.response){if(t.response>=1){const t=await globby(path_1.join(Editor.Project.tmpDir,"asset-db/*/*/*/build"),{onlyDirectories:!0});t.push(path_1.join(Editor.Project.path,"temp","builder")),Promise.all(t.map(t=>fs_extra_1.emptyDir(t))).catch(t=>{console.error(t)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")}))})}if(t.response>=2){const t=path_1.join(Editor.App.temp,"builder");fs_extra_1.emptyDir(t).catch(t=>{console.error(t)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")})+`: {link(${t})}`)})}}},onOpenDevTools(){Editor.Message.send("builder","open-devtools")},openDocs(){let t=this.options.platform;t.startsWith("web-")&&(t="web"),electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl(`editor/publish/publish-${t}.html`))},async exportBuildConfig(t){const e=this.options,s=await Editor.Dialog.save({title:this.t("export_build_config"),path:path_1.join(Editor.UI.File.resolveToRaw(e.buildPath),`buildConfig_${e.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(s.filePath){if(e.__version__=require("./../../../package.json").version,e.packages)for(const t of Object.keys(e.packages))e.packages[t].__version__=await getPakcageVersion(t);fs_extra_1.outputFileSync(s.filePath,JSON.stringify(e,null,2)),console.log(`Build config has export in {link(${s.filePath})}`)}},async importBuildConfig(){const t=this,e=await Editor.Dialog.select({title:t.t("import_build_config"),path:Editor.UI.File.resolveToRaw(t.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!e.filePaths||!e.filePaths[0])return;let s;try{s=fs_extra_1.readJSONSync(e.filePaths[0]),s=Object.assign(t.options,s),utils_1.compareVersion(require("./../../../package.json").version,s.__version__)&&(s=await Editor.Message.request("builder","migrate-options",s))}catch(t){return void console.error(t)}t.$set(t.task,"options",s)},updateErrorMap(t,e){const s=this;if(t){require("lodash").set(s.task.errorMap,t,e)}"check"!==s.settingsType&&(s.checkRes=calcOptionsCheckRes(s.task.errorMap,s.task.options))}},exports.created=created;