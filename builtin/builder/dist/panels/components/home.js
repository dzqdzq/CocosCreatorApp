"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.created=exports.methods=exports.data=exports.computed=exports.watch=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),common_options_validator_1=require("../../share/common-options-validator"),utils_1=require("../../share/utils"),message_1=require("../../browser/message"),lodash=require("lodash");function data(){return{settingsType:"",taskMap:{},scenes:[],bundles:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},runningTaskId:"",internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isPluginManagerReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0,activeTask:[],supportPlatformMap:{},scrollPosition:0,editingTaskName:!1,childTaskRenderedCount:0,childTaskRenderCompleted:!1,highLightTaskAfterRendered:!1,openPageSettings:{type:"",id:""}}}async function created(){console.time("Home created");const e=this;e.isPluginManagerReady=plugin_1.pluginManager.ready,plugin_1.pluginManager.addListener("ready",async()=>{e.isPluginManagerReady=!0,await e.onPluginManagerReady()}),plugin_1.pluginManager.ready?await e.onPluginManagerReady():Editor.Startup.ready.package?await plugin_1.pluginManager.init():Editor.Startup.once("package-ready",async()=>{console.debug("package-ready init pluginManager"),await plugin_1.pluginManager.init()}),console.timeEnd("Home created")}exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/components/home.html"),"utf8"),exports.components={task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},exports.watch={async showSettings(e,t){const s=this;if(!0===e)s.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),s.editingTaskName=!1;else{const e=s.scrollPosition||0;s.$nextTick(()=>{s.$refs.taskWrap.scrollTop=e})}},childTaskRenderedCount(e){const t=this;e>=Object.keys(t.taskMap).length&&(t.childTaskRenderCompleted=!0,t.highLightTaskAfterRendered&&(t.highLightTask(),t.highLightTaskAfterRendered=!1))}},exports.computed={options(){const e=this;return"check"===e.settingsType&&e.task.rawOptions||e.task.options},maskInfo(){return this.isPluginManagerReady?this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?Object.keys(this.supportPlatformMap).length?this.internalMaskInfo:"i18n:builder.empty_platforms":"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready":"i18n:builder.tips.waiting_for_plugin_ready"}},exports.data=data,exports.methods={t:Editor.I18n.t,updateTaskOptions(e){const t=this;"edit"!==t.settingsType||e.dirty||(e.rawOptions=JSON.parse(JSON.stringify(t.options)),e.dirty=!0,t.taskMap[e.id].dirty=t.task.dirty=e.dirty,t.taskMap[e.id].rawOptions=e.rawOptions),e.id&&Editor.Message.send("builder","update-task",e)},updateTaskOptionsByKey(e,t,s,a){this.taskMap[e]&&lodash.set(this.taskMap[e],t,s)},renameTask(){const e=this;e.editingTaskName=!0,e.$nextTick(()=>{const t=e.$refs.renameTaskInput;t&&t.setAttribute("focused","")})},submitTaskName(e){const t=this,s=e.target.value&&e.target.value.trim();t.editingTaskName=!1,s&&(t.$set(t.options,"taskName",s),t.taskMap&&t.taskMap[t.task.id]&&(t.task.rawOptions||(t.task.rawOptions=JSON.parse(JSON.stringify(t.options))),t.$set(t.task.rawOptions,"taskName",s),t.taskMap[t.task.id].rawOptions=t.task.rawOptions),t.task.id&&Editor.Message.send("builder","update-task",Object.assign(Object.assign({},t.task),{options:t.options})))},async changeTask(e,t){const s=this;if("boolean"==typeof t&&(s.free=t),!s.taskMap[e])return!1;const a=await plugin_1.pluginManager.checkCommonOptions(s.taskMap[e].options);return Object.keys(a).forEach(e=>{a[e]=a[e].error}),s.task=Object.assign(Object.assign({},s.taskMap[e]),{errorMap:a}),s.checkRes=!(0,utils_1.checkHasError)(s.task.errorMap),!0},toggleSelectTask(e,t){const s=this;e.ctrlKey?s.activeTask.includes(t)?s.activeTask.splice(s.activeTask.findIndex(e=>e===t),1):s.activeTask.push(t):s.activeTask.includes(t)?s.activeTask=[]:s.activeTask=[t]},async resetTask(){const e=await Editor.Profile.getConfig("builder","common");plugin_1.pluginManager.platformMap[e.platform]||(e.platform=Object.keys(plugin_1.pluginManager.platformMap)[0]);const t=await plugin_1.pluginManager.getOptionsByPlatform(e.platform),s=await(0,common_options_validator_1.checkBuildCommonOptions)(t);Object.keys(s).forEach(e=>{s[e]=s[e].error}),t.buildMode="normal",this.task={progress:0,state:"waiting",options:t,errorMap:s}},calcOutputName(e,t){if(!e||!t)return"";let s=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),t);return s=Editor.Utils.File.getName(s),(0,path_1.basename)(s)},updateTasks(e,t,s){const a=this;if(a.free=s,!e||!t)return void this.initTasks();const i=a.taskMap[e];if("processing"===t.state?a.runningTaskId=e:a.runningTaskId="",!i)return a.$set(a.taskMap,e,t),void a.$nextTick(()=>{const e=a.$refs.taskWrap;e.scrollTop=e.scrollHeight-e.offsetHeight});a.$set(a.taskMap,e,Object.assign(i,t))},async initTasks(){const e=this,{queue:t,free:s}=await Editor.Message.request("builder","query-tasks-info"),a={};Object.values(t).forEach(e=>{"build"===e.type&&(a[e.id]=e)}),e.taskMap=a,e.free=s;const i=e.taskMap[e.task.id];if(i&&e.task.id){e.task.state=i.state,e.task.message=i.message,e.task.progress=i.progress,e.task.options=i.options;const t=await(0,common_options_validator_1.checkBuildCommonOptions)(e.task.options),s={};Object.keys(t).forEach(e=>{s[e]=t[e].error}),e.task.errorMap=s}},async checkTaskRawOptions(e){(this.taskMap[e].rawOptions||this.taskMap[e].options)&&(this.settingsType="check",await this.changeTask(e),this.showSettings=!0)},async editTaskOptions(e){await this.changeTask(e)?(this.settingsType="edit",this.showSettings=!0):console.debug(`change task to ${e} failed`)},async runOpenPageTask(){const{type:e,id:t}=this.openPageSettings;if(e&&("new"===e||t))if(this.internalMaskInfo)console.debug("open page: wait for build panel ready");else switch(e){case"new":this.onNewBuildTask();break;case"edit":this.editTaskOptions(t);break;case"highlight":this.showSettings=!1,this.childTaskRenderCompleted?this.highLightTask():this.highLightTaskAfterRendered=!0}},highLightTask(){const e=this,t=e.openPageSettings.id;t&&e.$refs["task_"+t]&&e.$nextTick(()=>{const s=e.$refs["task_"+t][0]&&e.$refs["task_"+t][0].$el;s&&requestAnimationFrame(()=>{s.scrollIntoView({behavior:"smooth",block:"start"}),s.classList.add("shrink"),setTimeout(()=>{s.classList.remove("shrink")},1e3)})})},handleChildTaskRendered(){this.childTaskRenderedCount++},async onNewBuildTask(){this.settingsType="new",await this.resetTask(),this.showSettings=!0},async clearCache(e){(0,utils_1.Metric)("B100022"),Editor.Menu.popup({menu:[{label:"i18n:builder.clear_cache.clear_assets_cache",click:message_1.clearProjectAssetsCache},{label:"i18n:builder.clear_cache.clear_engine_cache",click:message_1.clearEngineCache},{label:"i18n:builder.clear_cache.clear_all",click:message_1.clearAllCache}],x:e.x,y:e.y})},onOpenDevTools(){(0,utils_1.Metric)("B100021"),Editor.Message.send("builder","open-devtools")},async exportBuildConfig(e){const t=JSON.parse(JSON.stringify(this.options)),s=await Editor.Dialog.save({title:this.t("export_build_config"),path:(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(t.buildPath),`buildConfig_${t.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(s.filePath){if(t.packages)for(const e of Object.keys(t.packages))t.packages[e]||delete t.packages[e];t.nextStages=this.task.buildStageGroup&&this.task.buildStageGroup.build,(0,fs_extra_1.outputFileSync)(s.filePath,JSON.stringify(t,null,2)),console.log(`Build config has export in {link(${s.filePath})}`)}},async importBuildConfig(){const e=this,t=await Editor.Dialog.select({title:e.t("import_build_config"),path:Editor.UI.__protected__.File.resolveToRaw(e.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!t.filePaths||!t.filePaths[0])return;let s;try{if((s=(0,fs_extra_1.readJSONSync)(t.filePaths[0])).platform&&s.platform!==e.options.platform)return void console.error(Editor.I18n.t("builder.import_config_limit"));s=await Editor.Message.request("builder","migrate-options",s),s=Object.assign(e.options,s);const a=await(0,common_options_validator_1.checkBuildCommonOptions)(s);for(const t of Object.keys(a)){const i=a[t].newValue;a[t].error?(null!==i&&void 0!==i&&(s[t]=i),null!==i?console.warn(a[t].error,`will use the new value ${a[t].newValue}`):console.error(a[t].error)):Editor.Profile.setConfig("builder",`common.${t}`,s[t],"local"),lodash.set(e.task.errorMap,t,a[t].error)}s.outputName=await(0,common_options_validator_1.calcValidOutputName)(s.buildPath,s.outputName,s.platform),Editor.Profile.setConfig("builder","common.outputName",s.outputName,"local"),s.packages&&Object.keys(s.packages).forEach(e=>{const t=s.packages[e];Editor.Profile.setConfig(e,`builder.options.${s.platform}`,t,"local")}),e.checkRes=!(0,utils_1.checkHasError)(e.task.errorMap)}catch(e){return void console.error(e)}e.task=Object.assign(Object.assign({},e.task),{options:s}),e.$refs.settings.onPluginUpdate("importConfig","",s)},updateErrorMap(e,t){const s=this;e&&lodash.set(s.task.errorMap,e,t),"check"!==s.settingsType&&(s.checkRes=!(0,utils_1.checkHasError)(s.task.errorMap))},async initBundleInfo(){const e=await Editor.Message.request("asset-db","query-assets",{isBundle:!0},["meta"]);e&&(this.bundles=e.map(e=>({root:e.url,name:e.meta.userData.bundleName||(0,path_1.basename)(e.url),output:!0})))},async onPluginManagerReady(){const e=this;e.isDBReady=await Editor.Message.request("asset-db","query-ready"),e.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),await e.initTasks(),e.supportPlatformMap=plugin_1.pluginManager.getSupportPlatformMap(),e.isDBReady&&await e.initAssets(),e.internalMaskInfo="",console.debug("Home onPluginManagerReady"),e.runOpenPageTask()},async initAssets(){const e=this;e.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),await e.initBundleInfo(),e.scenes.length>0&&0===Object.keys(e.taskMap).length&&Object.keys(e.supportPlatformMap).length&&e.onNewBuildTask()},handleScroll(){const e=this;e.showSettings||(e.scrollPosition=e.$refs.taskWrap.scrollTop)}},exports.created=created;