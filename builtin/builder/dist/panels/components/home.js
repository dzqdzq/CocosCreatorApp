"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.created=exports.methods=exports.data=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Settings=__importStar(require("./settings")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),utils_1=require("../../share/utils"),globby=require("globby");function data(){return{settingsType:"",taskMap:{},scenes:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},isDBReady:!1,showSettings:!1,free:!1,maskInfo:""}}async function created(){const e=this;e.isDBReady=await Editor.Message.request("asset-db","query-ready"),e.isDBReady&&await e.updateSceneData(),await e.initTasks(),e.scenes.length>0&&0===Object.keys(e.taskMap).length?e.onNewBuildTask():e.resetTask()}exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../static","/template/components/home.html"),"utf8"),exports.components={task:Task,settings:Settings,"build-mask":Mask},exports.data=data,exports.methods={t:Editor.I18n.t,changeTask(e,t){const s=this;"boolean"==typeof t&&(s.free=t),s.taskMap[e]&&(s.task=JSON.parse(JSON.stringify(s.taskMap[e])))},async resetTask(){const e=this,t=await Editor.Profile.getConfig("builder","common"),s=await Editor.Profile.getConfig("builder",t.platform),a=Object.assign({},t,{packages:s});a.scenes=JSON.parse(JSON.stringify(e.scenes)),a.startScene=t.startScene||e.scenes[0]&&e.scenes[0].uuid,a.outputName=e.calcOutputName(a.buildPath,a.platform),e.task={progress:0,state:"waiting",options:a}},calcOutputName(e,t){if(!e||!t)return"";let s=path_1.join(utils_1.getBuildDist(e),t);return s=Editor.Utils.File.getName(s),path_1.basename(s)},updateTasks(e,t,s){const a=this;if(a.free=s,!e||!t)return void this.initTasks();const i=a.taskMap[e];i?a.$set(a.taskMap,e,Object.assign(i,t)):a.$set(a.taskMap,e,t)},async initTasks(){const e=this,{queue:t,free:s}=await Editor.Message.request("builder","query-tasks-info");e.taskMap=t,e.free=s;const a=e.taskMap[e.task.id];a&&(e.task.state=a.state,e.task.message=a.message,e.task.progress=a.progress,e.task.options=a.options)},updateTaskOptions(e,t,s){const a=this;e&&t&&(a.$set(a.taskMap[e],"options",t),s&&(a.taskMap[e].rawOptions=s,a.taskMap[e].dirty=!0))},async updateSceneData(){const e=await Editor.Message.request("asset-db","query-assets",{type:"scene"});e&&(this.scenes=e.map(e=>({url:e.url,uuid:e.uuid})))},checkTaskRawOptions(e){(this.taskMap[e].rawOptions||this.taskMap[e].options)&&(this.settingsType="check",this.changeTask(e),this.showSettings=!0)},editTaskOptions(e){this.settingsType="edit",this.changeTask(e),this.showSettings=!0},async onNewBuildTask(){await this.resetTask(),this.settingsType="new",this.showSettings=!0},onBuild(e){Editor.Message.send("builder","add-task",e),this.showSettings=!1},onRecompile(e,t){Editor.Message.send("builder","recompile-task",e,t),this.showSettings=!1},async clearCache(){const e=await Editor.Dialog.info(Editor.I18n.t("builder.clear_cache.title"),{title:Editor.I18n.t("builder.clear_cache.title"),buttons:[Editor.I18n.t("builder.clear_cache.cancel"),Editor.I18n.t("builder.clear_cache.clear_project_cache"),Editor.I18n.t("builder.clear_cache.clear_global_cache"),Editor.I18n.t("builder.clear_cache.clear_all")],default:1,cancel:0});if(0!==e.response){if(e.response>=1){const e=await globby(path_1.join(Editor.Project.tmpDir,"asset-db/*/*/*/build"),{onlyDirectories:!0});e.push(path_1.join(Editor.Project.path,"temp","builder")),Promise.all(e.map(e=>fs_extra_1.emptyDir(e))).catch(e=>{console.error(e)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")}))})}if(e.response>=2){const e=path_1.join(Editor.App.temp,"builder");fs_extra_1.emptyDir(e).catch(e=>{console.error(e)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")})+`: {link(${e})}`)})}}},onOpenDevTools(){Editor.Message.send("builder","open-devtools")}},exports.created=created;