"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){e[i=void 0===i?s:i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var a=function(e){return(a=Object.getOwnPropertyNames||function(e){var t,s=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(s[s.length]=t);return s})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s=a(e),i=0;i<s.length;i++)"default"!==s[i]&&__createBinding(t,e,s[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderHomeVM=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),common_options_validator_1=require("../../share/common-options-validator"),utils_1=require("../../share/utils"),message_1=require("../../browser/message"),Vue=require("vue/dist/vue.js"),lodash=require("lodash"),template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/components/home.html"),"utf8");exports.BuilderHomeVM=Vue.extend({name:"BuilderHomeVM",components:{task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},data(){return{settingsType:"",taskMap:{},taskList:[],scenes:[],bundles:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},runningTaskIdId:"",internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isPluginManagerReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0,activeTasks:[],supportPlatformMap:{},platformInfoMap:{},scrollPosition:0,searchName:"",editingTaskName:!1,openPageSettings:{type:"",id:""},sortType:"buildTime"}},computed:{options(){return this.task.options},maskInfo(){return this.isPluginManagerReady?this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?Object.keys(this.platformInfoMap).length?this.internalMaskInfo:"i18n:builder.empty_platforms":"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready":"i18n:builder.tips.waiting_for_plugin_ready"},sortTooltip(){return Editor.I18n.t("builder.sortBy",{type:Editor.I18n.t("builder.options."+this.sortType)})},displayTaskList(){return this.searchName&&"string"==typeof this.searchName?this.taskList.filter(e=>-1<e.options.taskName.toLowerCase().indexOf(this.searchName)):this.taskList}},watch:{async showSettings(e,t){if(!0===e)this.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),this.editingTaskName=!1;else{const s=this.scrollPosition||0;this.$nextTick(()=>{var e=this.$refs.taskWrap;e&&(e.scrollTop=s)})}}},async created(){console.time("Home created"),this.isPluginManagerReady=plugin_1.pluginManager.ready,plugin_1.pluginManager.addListener("ready",async()=>{this.isPluginManagerReady=!0,await this.onPluginManagerReady()}),plugin_1.pluginManager.ready?await this.onPluginManagerReady():Editor.Startup.__protected__.ready.package?await plugin_1.pluginManager.init():Editor.Startup.__protected__.once("package-ready",async()=>{console.debug("package-ready init pluginManager"),await plugin_1.pluginManager.init()}),console.timeEnd("Home created")},methods:{t:Editor.I18n.t,updateTaskOptions(e){e.id&&Editor.Message.send("builder","update-task",e)},updateTaskOptionsByKey(e,t,s,i){this.taskMap[e]&&lodash.set(this.taskMap[e],t,s)},renameTask(){this.editingTaskName=!0,this.$nextTick(()=>{var e=this.$refs.renameTaskInput;e&&e.setAttribute("focused","")})},submitTaskName(e){e=e.target.value&&e.target.value.trim();this.editingTaskName=!1,e&&(this.$set(this.options,"taskName",e),this.task.id)&&Editor.Message.send("builder","update-task",{...this.task,options:this.options})},async changeTask(e,t){if("boolean"==typeof t&&(this.free=t),!this.taskMap[e])return!1;const s=await plugin_1.pluginManager.checkCommonOptions(this.taskMap[e].options);Object.keys(s).forEach(e=>{s[e]=s[e].error});t=await(0,common_options_validator_1.getCommonOptions)(this.taskMap[e].options.platform);return(0,utils_1.defaultsDeep)(this.taskMap[e].options,t),this.task={...this.taskMap[e],errorMap:s},this.checkRes=!(0,utils_1.checkHasError)(s),!0},onSearch(e){this.searchName=e.toLowerCase()},selectAllTask(){this.activeTasks=Object.keys(this.taskMap)},clearSelectedTask(){this.activeTasks=[]},async deleteSelectedTask(){if(this.activeTasks.length){const t=await this.showDeleteRawDir(this.activeTasks.map(e=>this.taskMap[e]));var e;0!==t&&(e=Array.from(this.activeTasks),await Promise.allSettled(e.map(e=>this.removeTask(e,2===t))))}},async removeTask(t,e){var s=this.taskMap[t].options;if(s.buildPath){s=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(s.buildPath),s.outputName);if(!(0,fs_extra_1.existsSync)(s))return void await Editor.Message.request("builder","remove-task",String(t))}if("boolean"!=typeof e){s=await this.showDeleteRawDir([this.taskMap[t]]);if(0===s)return;e=2===s}this.activeTasks.includes(t)&&this.activeTasks.splice(this.activeTasks.findIndex(e=>e===t),1),e?(this.internalMaskInfo="i18n:builder.tips.waiting_for_remove_task",await Editor.Message.request("builder","remove-task",t,!0),this.internalMaskInfo=""):await Editor.Message.request("builder","remove-task",t)},async showDeleteRawDir(e){var t=this.t;let s="";return e.find(e=>"processing"===e.state)&&(s=t("builder.is_remove_task.has_building_task")),s+=t("builder.is_remove_task.message"),(await Editor.Dialog.info(s+(" "+e.map(e=>e.options.taskName).join(", ")),{title:""+t("builder.is_remove_task.title"),buttons:[t("builder.is_remove_task.cancel"),t("builder.is_remove_task.remove"),t("builder.is_remove_task.deep_remove")],default:0,cancel:0})).response},toggleSelectTask(e,t){e.ctrlKey?this.activeTasks.includes(t)?this.activeTasks.splice(this.activeTasks.findIndex(e=>e===t),1):this.activeTasks.push(t):e.shiftKey?this.activeTasks=Array.from(new Set([...this.activeTasks,t])):this.activeTasks.includes(t)?this.activeTasks=[]:this.activeTasks=[t]},async resetTask(){var e=await Editor.Profile.getConfig("builder","common"),e=(plugin_1.pluginManager.platformInfoMap[e.platform]||(e.platform=Object.keys(plugin_1.pluginManager.platformInfoMap)[0]),await plugin_1.pluginManager.getOptionsByPlatform(e.platform));const t=await(0,common_options_validator_1.checkBuildCommonOptions)(e);Object.keys(t).forEach(e=>{t[e]=t[e].error}),e.buildMode="normal",this.task={id:"",progress:0,state:"waiting",message:"waiting",options:e,errorMap:t,time:Date.now().toString()}},calcOutputName(e,t){return e&&t?(e=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),t),e=Editor.Utils.File.getName(e),(0,path_1.basename)(e)):""},async updateTasks(e,t,s){"boolean"==typeof s&&(this.free=!!s),e&&t?(s=this.taskMap[e],"processing"===t.state?this.runningTaskIdId=e:this.runningTaskIdId="",await this.refreshBuildTasks(),s||this.highLightTask(e)):this.initTasks()},async initTasks(){await this.refreshBuildTasks();var e=this.taskMap[this.task.id];if(e&&this.task.id){this.task.state=e.state,this.task.message=e.message,this.task.detailMessage=e.detailMessage,this.task.progress=e.progress,this.task.options=e.options;const t=await(0,common_options_validator_1.checkBuildCommonOptions)(this.task.options),s={};Object.keys(t).forEach(e=>{s[e]=t[e].error}),this.task.errorMap=s}},async editTaskOptions(e){await this.changeTask(e)?(this.settingsType="edit",this.showSettings=!0):console.debug(`change task to ${e} failed`)},runOpenPageTask(){var{type:e,id:t}=this.openPageSettings;if(e&&("new"===e||t))if(this.internalMaskInfo)console.debug("open page: wait for build panel ready");else switch(e){case"new":this.onNewBuildTask();break;case"edit":this.editTaskOptions(t);break;case"highlight":this.showSettings=!1,this.highLightTask()}},highLightTask(s){(s=s||this.openPageSettings.id)&&this.$refs["task_"+s]&&this.$nextTick(()=>{var e=this.$refs["task_"+s];if(Array.isArray(e)){e=e[0];if(e){const t=e.$el;t.scrollIntoView({behavior:"smooth",block:"start"}),t.classList.add("shrink"),setTimeout(()=>{t&&t.classList.remove("shrink")},1e3)}}})},async onNewBuildTask(){this.settingsType="new",await this.resetTask(),this.showSettings=!0},async clearCache(e){(0,utils_1.Metric)("B100022"),Editor.Menu.popup({menu:[{label:"i18n:builder.clear_cache.clear_assets_cache",click:message_1.clearProjectAssetsCache},{label:"i18n:builder.clear_cache.clear_engine_cache",click:message_1.clearEngineCache},{label:"i18n:builder.clear_cache.clear_all",click:message_1.clearAllCache}],x:e.x,y:e.y})},onOpenDevTools(){(0,utils_1.Metric)("B100021"),Editor.Message.send("builder","open-devtools")},openPreferences(){Editor.Message.send("preferences","open-settings","builder")},toggleSort(e){Editor.Menu.popup({menu:["taskName","buildTime"].map(e=>({label:Editor.I18n.t("builder.sortBy",{type:Editor.I18n.t("builder.options."+e)}),checked:this.sortType===e,type:"radio",click:()=>{this.sortType=e,Editor.Profile.setConfig("builder","sortType",e),this.refreshBuildTasks()}}))})},async refreshBuildTasks(){var{queue:e,list:t,free:s}=await Editor.Message.request("builder","query-tasks-info",{type:"build",sortType:this.sortType});this.taskMap=e,this.taskList=t,this.free=s},async exportBuildConfig(){var e=JSON.parse(JSON.stringify(this.options)),t=await Editor.Dialog.save({title:this.t("export_build_config"),path:(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e.buildPath),`buildConfig_${e.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(t.filePath){if(e.packages)for(const s of Object.keys(e.packages))e.packages[s]||delete e.packages[s];e.nextStages=this.task.buildStageGroup&&this.task.buildStageGroup.build,(0,fs_extra_1.outputFileSync)(t.filePath,JSON.stringify(e,null,2)),console.log(`Build config has export in {link(${t.filePath})}`)}},async importBuildConfig(){var e=await Editor.Dialog.select({title:this.t("import_build_config"),path:Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(e.filePaths&&e.filePaths[0]){let s;try{if((s=(0,fs_extra_1.readJSONSync)(e.filePaths[0])).platform&&s.platform!==this.options.platform)return void console.error(Editor.I18n.t("builder.import_config_limit"));s=await Editor.Message.request("builder","migrate-options",s),s=Object.assign(this.options,s);var t=await(0,common_options_validator_1.checkBuildCommonOptions)(s);for(const a of Object.keys(t)){var i=t[a].newValue;t[a].error?(null!=i&&(s[a]=i),null!==i?console.warn(t[a].error,"will use the new value "+t[a].newValue):console.error(t[a].error)):Editor.Profile.setConfig("builder","common."+a,s[a],"local"),lodash.set(this.task.errorMap,a,t[a].error)}s.outputName=await(0,common_options_validator_1.calcValidOutputName)(s.buildPath,s.outputName,s.platform),Editor.Profile.setConfig("builder","common.outputName",s.outputName,"local"),s.packages&&Object.keys(s.packages).forEach(e=>{var t=s.packages[e];Editor.Profile.setConfig(e,"builder.options."+s.platform,t,"local")}),this.checkRes=!(0,utils_1.checkHasError)(this.task.errorMap)}catch(e){return void console.error(e)}this.task={...this.task,options:s};e=this.$refs.settings;e&&e.onPluginUpdate("importConfig","",s)}},updateErrorMap(e,t){e&&lodash.set(this.task.errorMap,e,t),"check"!==this.settingsType&&(this.checkRes=!(0,utils_1.checkHasError)(this.task.errorMap))},async initBundleInfo(){var e=await Editor.Message.request("asset-db","query-assets",{isBundle:!0},["meta"]);e&&(this.bundles=e.map(e=>({root:e.url,name:e.meta.userData.bundleName||(0,path_1.basename)(e.url),output:!0,uuid:e.uuid})))},async onPluginManagerReady(){this.isDBReady=await Editor.Message.request("asset-db","query-ready"),this.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),this.sortType=await Editor.Profile.getConfig("builder","sortType"),await this.initTasks(),this.platformInfoMap=plugin_1.pluginManager.getSupportPlatformInfoMap(),this.isDBReady&&await this.initAssets(),this.internalMaskInfo="",console.debug("Home onPluginManagerReady"),this.runOpenPageTask()},async initAssets(){this.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),await this.initBundleInfo(),0<this.scenes.length&&0===Object.keys(this.taskMap).length&&Object.keys(this.platformInfoMap).length&&this.onNewBuildTask()},handleScroll(){var e;this.showSettings||(e=this.$refs.taskWrap)&&(this.scrollPosition=e.scrollTop)}},template:template});