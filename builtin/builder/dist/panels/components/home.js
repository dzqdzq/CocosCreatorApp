"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,o){void 0===o&&(o=s),Object.defineProperty(t,o,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,o){void 0===o&&(o=s),t[o]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.created=exports.methods=exports.data=exports.computed=exports.watch=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),electron_1=require("electron"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),utils_1=require("../../browser/migration/utils"),common_options_validator_1=require("../../share/common-options-validator"),utils_2=require("../../share/utils"),globby=require("globby"),lodash=require("lodash");function data(){return{settingsType:"",taskMap:{},scenes:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0}}async function created(){console.time("Home created");const t=this;t.isDBReady=await Editor.Message.request("asset-db","query-ready"),t.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),await t.initTasks(),t.isDBReady&&(t.scenes=await common_options_validator_1.getCommonOptionDefaultByKey("scenes"),t.scenes.length>0&&0===Object.keys(t.taskMap).length&&t.onNewBuildTask()),t.internalMaskInfo="",console.timeEnd("Home created")}async function getPakcageVersion(t){const e=await Editor.Package.getPackages({name:t});if(e.length>1){const t=e.find(t=>t.enable);return t&&t.version}return e[0]&&e[0].version}exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../static","/template/components/home.html"),"utf8"),exports.components={task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},exports.watch={"task.options":{deep:!0,handler(t,e){const s=this;"edit"!==s.settingsType||s.task.dirty||s.task.dirty||(s.task.rawOptions=JSON.parse(JSON.stringify(s.options)),s.task.dirty=!0),Editor.Message.send("builder","update-task",s.task.id,s.task.options,s.task.rawOptions)},immediate:!1},async showSettings(t,e){if(!0===t){this.scenes=await common_options_validator_1.getCommonOptionDefaultByKey("scenes")}}},exports.computed={options(){const t=this;return"check"===t.settingsType&&t.task.rawOptions||t.task.options},maskInfo(){return this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?this.internalMaskInfo:"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready"}},exports.data=data,exports.methods={t:Editor.I18n.t,async changeTask(t,e){const s=this;if("boolean"==typeof e&&(s.free=e),!s.taskMap[t])return;const o=await common_options_validator_1.checkBuildCommondOptions(s.taskMap[t].options);Object.keys(o).forEach(t=>{o[t]=o[t].error}),s.task=Object.assign(Object.assign({},s.taskMap[t]),{errorMap:o}),s.checkRes=!utils_2.checkHasError(s.task.errorMap)},async resetTask(){const t=await Editor.Profile.getConfig("builder","common");plugin_1.pluginManager.platformMap[t.platform]||(t.platform=Object.keys(plugin_1.pluginManager.platformMap)[0]);const e=await plugin_1.pluginManager.getOptionsByPlatform(t.platform),s=await common_options_validator_1.checkBuildCommondOptions(e);Object.keys(s).forEach(t=>{s[t]=s[t].error}),this.task={progress:0,state:"waiting",options:e,errorMap:s}},calcOutputName(t,e){if(!t||!e)return"";let s=path_1.join(Editor.UI.File.resolveToRaw(t),e);return s=Editor.Utils.File.getName(s),path_1.basename(s)},updateTasks(t,e,s){const o=this;if(o.free=s,!t||!e)return void this.initTasks();const a=o.taskMap[t];a?o.$set(o.taskMap,t,Object.assign(a,e)):o.$set(o.taskMap,t,e)},async initTasks(){const t=this,{queue:e,free:s}=await Editor.Message.request("builder","query-tasks-info");t.taskMap=e,t.free=s;const o=t.taskMap[t.task.id];if(o&&t.task.id){t.task.state=o.state,t.task.message=o.message,t.task.progress=o.progress,t.task.options=o.options;const e=await common_options_validator_1.checkBuildCommondOptions(t.task.options),s={};Object.keys(e).forEach(t=>{s[t]=e[t].error}),t.task.errorMap=s}},updateTaskOptions(t,e,s){const o=this;t&&e&&(o.$set(o.taskMap[t],"options",e),s&&(o.taskMap[t].rawOptions=s,o.taskMap[t].dirty=!0))},async checkTaskRawOptions(t){(this.taskMap[t].rawOptions||this.taskMap[t].options)&&(this.settingsType="check",await this.changeTask(t),this.showSettings=!0)},async editTaskOptions(t){this.settingsType="edit",await this.changeTask(t),this.showSettings=!0},async onNewBuildTask(){this.settingsType="new",await this.resetTask(),this.showSettings=!0},async clearCache(){const t=await Editor.Dialog.info(Editor.I18n.t("builder.clear_cache.title"),{title:Editor.I18n.t("builder.clear_cache.title"),buttons:[Editor.I18n.t("builder.clear_cache.cancel"),Editor.I18n.t("builder.clear_cache.clear_project_cache"),Editor.I18n.t("builder.clear_cache.clear_global_cache"),Editor.I18n.t("builder.clear_cache.clear_all")],default:1,cancel:0});if(0!==t.response){if(t.response>=1){const t=await globby(path_1.join(Editor.Project.tmpDir,"asset-db/*/*/*/build"),{onlyDirectories:!0});t.push(path_1.join(Editor.Project.path,"temp","builder")),Promise.all(t.map(t=>fs_extra_1.emptyDir(t))).catch(t=>{console.error(t)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")}))})}if(t.response>=2){const t=path_1.join(Editor.App.temp,"builder");fs_extra_1.emptyDir(t).catch(t=>{console.error(t)}).then(()=>{console.log(Editor.I18n.t("builder.clear_cache.clear_cache_success",{position:Editor.I18n.t("builder.clear_cache.clear_project_cache")})+`: {link(${t})}`)})}}},onOpenDevTools(){Editor.Message.send("builder","open-devtools")},openDocs(){let t=this.options.platform;if(t.startsWith("web-")&&(t="web"),["mac","windows","ios","android","ohos"].includes(t))return electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl("editor/publish/native-options.html"));electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl(`editor/publish/publish-${t}.html`))},async exportBuildConfig(t){const e=this.options,s=await Editor.Dialog.save({title:this.t("export_build_config"),path:path_1.join(Editor.UI.File.resolveToRaw(e.buildPath),`buildConfig_${e.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(s.filePath){if(e.__version__=require("./../../../package.json").version,e.packages)for(const t of Object.keys(e.packages))e.packages[t].__version__=await getPakcageVersion(t);fs_extra_1.outputFileSync(s.filePath,JSON.stringify(e,null,2)),console.log(`Build config has export in {link(${s.filePath})}`)}},async importBuildConfig(){const t=this,e=await Editor.Dialog.select({title:t.t("import_build_config"),path:Editor.UI.File.resolveToRaw(t.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!e.filePaths||!e.filePaths[0])return;let s;try{if((s=fs_extra_1.readJSONSync(e.filePaths[0])).platform&&s.platform!==t.options.platform)return void console.error(Editor.I18n.t("builder.import_config_limit"));s=Object.assign(t.options,s),utils_1.compareVersion(require("./../../../package.json").version,s.__version__)&&(s=await Editor.Message.request("builder","migrate-options",s));const o=await common_options_validator_1.checkBuildCommondOptions(s);for(const e of Object.keys(o)){const a=o[e].newValue;o[e].error?(null!==a&&void 0!==a&&(s[e]=a),null!==a?console.warn(o[e].error,`will use the new value ${o[e].newValue}`):console.error(o[e].error)):Editor.Profile.setConfig("builder",`common.${e}`,s[e],"local"),lodash.set(t.task.errorMap,e,o[e].error)}s.outputName=common_options_validator_1.calcValidOutputName(s.buildPath,s.outputName),Editor.Profile.setConfig("builder","common.outputName",s.outputName,"local"),s.packages&&Object.keys(s.packages).forEach(t=>{const e=s.packages[t];Editor.Profile.setConfig(t,`options.${s.platform}`,e,"local")}),t.checkRes=!utils_2.checkHasError(t.task.errorMap)}catch(t){return void console.error(t)}t.task=Object.assign(Object.assign({},t.task),{options:s}),t.$refs.settings.onPluginUpdate("importConfig","")},updateErrorMap(t,e){const s=this;t&&lodash.set(s.task.errorMap,t,e),"check"!==s.settingsType&&(s.checkRes=!utils_2.checkHasError(s.task.errorMap))}},exports.created=created;