"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,i)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.created=exports.methods=exports.data=exports.computed=exports.watch=exports.components=exports.template=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),common_options_validator_1=require("../../share/common-options-validator"),utils_1=require("../../share/utils"),message_1=require("../../browser/message"),globby=require("globby"),lodash=require("lodash");function data(){return{settingsType:"",taskMap:{},scenes:[],task:{id:"",state:"waiting",progress:0,message:"waiting",options:{}},runningTaskId:"",internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isPluginManagerReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0,activeTask:[],supportPlatformMap:plugin_1.pluginManager.platformMap}}async function created(){console.time("Home created");const e=this;e.isPluginManagerReady=plugin_1.pluginManager.ready,plugin_1.pluginManager.addListener("ready",async()=>{e.isPluginManagerReady=!0,await e.onPluginManagerReady()}),Editor.Startup.ready.package?await plugin_1.pluginManager.init():Editor.Startup.once("package-ready",async()=>{console.debug("package-ready init pluginManager"),await plugin_1.pluginManager.init()}),console.timeEnd("Home created")}exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/components/home.html"),"utf8"),exports.components={task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},exports.watch={async showSettings(e,t){if(!0===e){this.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes")}}},exports.computed={options(){const e=this;return"check"===e.settingsType&&e.task.rawOptions||e.task.options},maskInfo(){return this.isPluginManagerReady?this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?Object.keys(this.supportPlatformMap).length?this.internalMaskInfo:"i18n:builder.empty_platforms":"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready":"i18n:builder.tips.waiting_for_plugin_ready"}},exports.data=data,exports.methods={t:Editor.I18n.t,updateTaskOptions(e){const t=this;"edit"!==t.settingsType||e.dirty||e.dirty||(e.rawOptions=JSON.parse(JSON.stringify(t.options)),e.dirty=!0,t.taskMap[e.id].dirty=t.task.dirty,t.taskMap[e.id].rawOptions=t.task.rawOptions),e.id&&Editor.Message.send("builder","update-task",e)},async changeTask(e,t){const a=this;if("boolean"==typeof t&&(a.free=t),!a.taskMap[e])return;const s=await plugin_1.pluginManager.checkCommonOptions(a.taskMap[e].options);Object.keys(s).forEach(e=>{s[e]=s[e].error}),a.task=Object.assign(Object.assign({},a.taskMap[e]),{errorMap:s}),a.checkRes=!(0,utils_1.checkHasError)(a.task.errorMap)},toggleSelectTask(e,t){const a=this;e.ctrlKey?a.activeTask.includes(t)?a.activeTask.splice(a.activeTask.findIndex(e=>e===t),1):a.activeTask.push(t):a.activeTask.includes(t)?a.activeTask=[]:a.activeTask=[t]},async resetTask(){const e=await Editor.Profile.getConfig("builder","common");plugin_1.pluginManager.platformMap[e.platform]||(e.platform=Object.keys(plugin_1.pluginManager.platformMap)[0]);const t=await plugin_1.pluginManager.getOptionsByPlatform(e.platform),a=await(0,common_options_validator_1.checkBuildCommondOptions)(t);Object.keys(a).forEach(e=>{a[e]=a[e].error}),this.task={progress:0,state:"waiting",options:t,errorMap:a}},calcOutputName(e,t){if(!e||!t)return"";let a=(0,path_1.join)(Editor.UI.File.resolveToRaw(e),t);return a=Editor.Utils.File.getName(a),(0,path_1.basename)(a)},updateTasks(e,t,a){const s=this;if(s.free=a,!e||!t)return void this.initTasks();const i=s.taskMap[e];if("processing"===t.state?s.runningTaskId=e:s.runningTaskId="",i)s.$set(s.taskMap,e,Object.assign(i,t));else{s.$set(s.taskMap,e,t);const a=s.$refs.taskWrap;a.scrollTop=a.scrollHeight-a.offsetHeight}},async initTasks(){const e=this,{queue:t,free:a}=await Editor.Message.request("builder","query-tasks-info");e.taskMap=t,e.free=a;const s=e.taskMap[e.task.id];if(s&&e.task.id){e.task.state=s.state,e.task.message=s.message,e.task.progress=s.progress,e.task.options=s.options;const t=await(0,common_options_validator_1.checkBuildCommondOptions)(e.task.options),a={};Object.keys(t).forEach(e=>{a[e]=t[e].error}),e.task.errorMap=a}},async checkTaskRawOptions(e){(this.taskMap[e].rawOptions||this.taskMap[e].options)&&(this.settingsType="check",await this.changeTask(e),this.showSettings=!0)},async editTaskOptions(e){this.settingsType="edit",await this.changeTask(e),this.showSettings=!0},async onNewBuildTask(){this.settingsType="new",await this.resetTask(),this.showSettings=!0},async clearCache(e){(0,utils_1.Metric)("B100022"),Editor.Menu.popup({menu:[{label:"i18n:builder.clear_cache.clear_assets_cache",click:message_1.clearProjectAssetsCache},{label:"i18n:builder.clear_cache.clear_engine_cache",click:message_1.clearEngineCache},{label:"i18n:builder.clear_cache.clear_all",click:message_1.clearAllCache}],x:e.x,y:e.y})},onOpenDevTools(){(0,utils_1.Metric)("B100021"),Editor.Message.send("builder","open-devtools")},async exportBuildConfig(e){const t=JSON.parse(JSON.stringify(this.options)),a=await Editor.Dialog.save({title:this.t("export_build_config"),path:(0,path_1.join)(Editor.UI.File.resolveToRaw(t.buildPath),`buildConfig_${t.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(a.filePath){if(t.packages)for(const e of Object.keys(t.packages))t.packages[e]||delete t.packages[e];t.nextStages=this.task.buildStageGroup&&this.task.buildStageGroup.build,(0,fs_extra_1.outputFileSync)(a.filePath,JSON.stringify(t,null,2)),console.log(`Build config has export in {link(${a.filePath})}`)}},async importBuildConfig(){const e=this,t=await Editor.Dialog.select({title:e.t("import_build_config"),path:Editor.UI.File.resolveToRaw(e.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!t.filePaths||!t.filePaths[0])return;let a;try{if((a=(0,fs_extra_1.readJSONSync)(t.filePaths[0])).platform&&a.platform!==e.options.platform)return void console.error(Editor.I18n.t("builder.import_config_limit"));a=await Editor.Message.request("builder","migrate-options",a),a=Object.assign(e.options,a);const s=await(0,common_options_validator_1.checkBuildCommondOptions)(a);for(const t of Object.keys(s)){const i=s[t].newValue;s[t].error?(null!==i&&void 0!==i&&(a[t]=i),null!==i?console.warn(s[t].error,`will use the new value ${s[t].newValue}`):console.error(s[t].error)):Editor.Profile.setConfig("builder",`common.${t}`,a[t],"local"),lodash.set(e.task.errorMap,t,s[t].error)}a.outputName=(0,common_options_validator_1.calcValidOutputName)(a.buildPath,a.outputName),Editor.Profile.setConfig("builder","common.outputName",a.outputName,"local"),a.packages&&Object.keys(a.packages).forEach(e=>{const t=a.packages[e];Editor.Profile.setConfig(e,`builder.options.${a.platform}`,t,"local")}),e.checkRes=!(0,utils_1.checkHasError)(e.task.errorMap)}catch(e){return void console.error(e)}e.task=Object.assign(Object.assign({},e.task),{options:a}),e.$refs.settings.onPluginUpdate("importConfig","",a)},updateErrorMap(e,t){const a=this;e&&lodash.set(a.task.errorMap,e,t),"check"!==a.settingsType&&(a.checkRes=!(0,utils_1.checkHasError)(a.task.errorMap))},async onPluginManagerReady(){const e=this;e.isDBReady=await Editor.Message.request("asset-db","query-ready"),e.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),await e.initTasks(),e.isDBReady&&(e.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),e.scenes.length>0&&0===Object.keys(e.taskMap).length&&Object.keys(e.supportPlatformMap).length&&e.onNewBuildTask()),e.internalMaskInfo=""}},exports.created=created;