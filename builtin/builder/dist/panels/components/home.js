"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&("get"in a?e.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,i,a)}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuilderHomeVM=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Settings=__importStar(require("./settings/index")),Task=__importStar(require("./task")),Mask=__importStar(require("./mask")),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),common_options_validator_1=require("../../share/common-options-validator"),utils_1=require("../../share/utils"),message_1=require("../../browser/message"),Vue=require("vue/dist/vue.js"),lodash=require("lodash"),template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","/template/components/home.html"),"utf8");exports.BuilderHomeVM=Vue.extend({name:"BuilderHomeVM",components:{task:Task,settings:Settings,"build-mask":Mask,buttons:buttonsComponent},data:()=>({settingsType:"",taskMap:{},taskList:[],scenes:[],bundles:[],task:{id:"",dirty:!1,state:"waiting",progress:0,message:"waiting",options:{}},runningTaskId:"",internalMaskInfo:"i18n:builder.tips.waiting_for_data_ready",isDBReady:!1,isPluginManagerReady:!1,isBuildWorkerReady:!1,showSettings:!1,free:!1,checkRes:!0,activeTask:[],supportPlatformMap:{},scrollPosition:0,editingTaskName:!1,childTaskRenderedCount:0,childTaskRenderCompleted:!1,highLightTaskAfterRendered:!1,openPageSettings:{type:"",id:""}}),computed:{options(){return"check"===this.settingsType&&this.task.rawOptions||this.task.options},maskInfo(){return this.isPluginManagerReady?this.isDBReady?this.isBuildWorkerReady?this.scenes&&this.scenes.length?Object.keys(this.supportPlatformMap).length?this.internalMaskInfo:"i18n:builder.empty_platforms":"i18n:builder.empty_scene":"i18n:builder.tips.waiting_for_worker_ready":"i18n:builder.tips.waiting_for_db_ready":"i18n:builder.tips.waiting_for_plugin_ready"}},watch:{async showSettings(t,e){if(!0===t)this.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),this.editingTaskName=!1;else{const t=this.scrollPosition||0;this.$nextTick(()=>{const e=this.$refs.taskWrap;e&&(e.scrollTop=t)})}},childTaskRenderedCount(t){t>=Object.keys(this.taskMap).length&&(this.childTaskRenderCompleted=!0,this.highLightTaskAfterRendered&&(this.highLightTask(),this.highLightTaskAfterRendered=!1))}},async created(){console.time("Home created"),this.isPluginManagerReady=plugin_1.pluginManager.ready,plugin_1.pluginManager.addListener("ready",async()=>{this.isPluginManagerReady=!0,await this.onPluginManagerReady()}),plugin_1.pluginManager.ready?await this.onPluginManagerReady():Editor.Startup.__protected__.ready.package?await plugin_1.pluginManager.init():Editor.Startup.__protected__.once("package-ready",async()=>{console.debug("package-ready init pluginManager"),await plugin_1.pluginManager.init()}),console.timeEnd("Home created")},methods:{t:Editor.I18n.t,updateTaskOptions(t){if("edit"===this.settingsType&&!t.dirty){t.rawOptions=JSON.parse(JSON.stringify(this.options)),t.dirty=!0,this.task.dirty=t.dirty;const e=this.taskMap[t.id];e&&(e.dirty=t.dirty,t.rawOptions&&(e.rawOptions=t.rawOptions))}t.id&&Editor.Message.send("builder","update-task",t)},updateTaskOptionsByKey(t,e,s,i){this.taskMap[t]&&lodash.set(this.taskMap[t],e,s)},renameTask(){this.editingTaskName=!0,this.$nextTick(()=>{const t=this.$refs.renameTaskInput;t&&t.setAttribute("focused","")})},submitTaskName(t){const e=t.target.value&&t.target.value.trim();this.editingTaskName=!1,e&&(this.$set(this.options,"taskName",e),this.taskMap&&this.taskMap[this.task.id]&&(this.task.rawOptions&&this.$set(this.task.rawOptions,"taskName",e),this.taskMap[this.task.id].rawOptions=this.task.rawOptions),this.task.id&&Editor.Message.send("builder","update-task",Object.assign(Object.assign({},this.task),{options:this.options})))},async changeTask(t,e){if("boolean"==typeof e&&(this.free=e),!this.taskMap[t])return!1;const s=await plugin_1.pluginManager.checkCommonOptions(this.taskMap[t].options);return Object.keys(s).forEach(t=>{s[t]=s[t].error}),this.task=Object.assign(Object.assign({},this.taskMap[t]),{errorMap:s}),this.checkRes=!(0,utils_1.checkHasError)(s),!0},toggleSelectTask(t,e){t.ctrlKey?this.activeTask.includes(e)?this.activeTask.splice(this.activeTask.findIndex(t=>t===e),1):this.activeTask.push(e):this.activeTask.includes(e)?this.activeTask=[]:this.activeTask=[e]},async resetTask(){const t=await Editor.Profile.getConfig("builder","common");plugin_1.pluginManager.platformMap[t.platform]||(t.platform=Object.keys(plugin_1.pluginManager.platformMap)[0]);const e=await plugin_1.pluginManager.getOptionsByPlatform(t.platform),s=await(0,common_options_validator_1.checkBuildCommonOptions)(e);Object.keys(s).forEach(t=>{s[t]=s[t].error}),e.buildMode="normal",this.task={id:"",dirty:!1,progress:0,state:"waiting",message:"waiting",options:e,errorMap:s}},calcOutputName(t,e){if(!t||!e)return"";let s=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(t),e);return s=Editor.Utils.File.getName(s),(0,path_1.basename)(s)},async updateTasks(t,e,s){if("boolean"==typeof s&&(this.free=!!s),!t||!e)return void this.initTasks();const i=this.taskMap[t];"processing"===e.state?this.runningTaskId=t:this.runningTaskId="";const{queue:a,list:o}=await Editor.Message.request("builder","query-tasks-info",{type:"build"});this.taskMap=a,this.taskList=o,i||this.$nextTick(()=>{const t=this.$refs.taskWrap;t&&(t.scrollTop=t.scrollHeight-t.offsetHeight)})},async initTasks(){const{queue:t,free:e,list:s}=await Editor.Message.request("builder","query-tasks-info",{type:"build"});this.taskMap=t,this.taskList=s,this.free=e;const i=this.taskMap[this.task.id];if(i&&this.task.id){this.task.state=i.state,this.task.message=i.message,this.task.progress=i.progress,this.task.options=i.options;const t=await(0,common_options_validator_1.checkBuildCommonOptions)(this.task.options),e={};Object.keys(t).forEach(s=>{e[s]=t[s].error}),this.task.errorMap=e}},async checkTaskRawOptions(t){(this.taskMap[t].rawOptions||this.taskMap[t].options)&&(this.settingsType="check",await this.changeTask(t),this.showSettings=!0)},async editTaskOptions(t){await this.changeTask(t)?(this.settingsType="edit",this.showSettings=!0):console.debug(`change task to ${t} failed`)},runOpenPageTask(){const{type:t,id:e}=this.openPageSettings;if(t&&("new"===t||e))if(this.internalMaskInfo)console.debug("open page: wait for build panel ready");else switch(t){case"new":this.onNewBuildTask();break;case"edit":this.editTaskOptions(e);break;case"highlight":this.showSettings=!1,this.childTaskRenderCompleted?this.highLightTask():this.highLightTaskAfterRendered=!0}},highLightTask(){const t=this.openPageSettings.id;t&&this.$refs["task_"+t]&&this.$nextTick(()=>{const e=this.$refs["task_"+t];if(Array.isArray(e)){const t=e[0];if(t){const e=t.$el;e.scrollIntoView({behavior:"smooth",block:"start"}),e.classList.add("shrink"),setTimeout(()=>{e&&e.classList.remove("shrink")},1e3)}}})},handleChildTaskRendered(){this.childTaskRenderedCount++},async onNewBuildTask(){this.settingsType="new",await this.resetTask(),this.showSettings=!0},async clearCache(t){(0,utils_1.Metric)("B100022"),Editor.Menu.popup({menu:[{label:"i18n:builder.clear_cache.clear_assets_cache",click:message_1.clearProjectAssetsCache},{label:"i18n:builder.clear_cache.clear_engine_cache",click:message_1.clearEngineCache},{label:"i18n:builder.clear_cache.clear_all",click:message_1.clearAllCache}],x:t.x,y:t.y})},onOpenDevTools(){(0,utils_1.Metric)("B100021"),Editor.Message.send("builder","open-devtools")},async exportBuildConfig(){const t=JSON.parse(JSON.stringify(this.options)),e=await Editor.Dialog.save({title:this.t("export_build_config"),path:(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(t.buildPath),`buildConfig_${t.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});if(e.filePath){if(t.packages)for(const e of Object.keys(t.packages))t.packages[e]||delete t.packages[e];t.nextStages=this.task.buildStageGroup&&this.task.buildStageGroup.build,(0,fs_extra_1.outputFileSync)(e.filePath,JSON.stringify(t,null,2)),console.log(`Build config has export in {link(${e.filePath})}`)}},async importBuildConfig(){const t=await Editor.Dialog.select({title:this.t("import_build_config"),path:Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!t.filePaths||!t.filePaths[0])return;let e;try{if((e=(0,fs_extra_1.readJSONSync)(t.filePaths[0])).platform&&e.platform!==this.options.platform)return void console.error(Editor.I18n.t("builder.import_config_limit"));e=await Editor.Message.request("builder","migrate-options",e),e=Object.assign(this.options,e);const s=await(0,common_options_validator_1.checkBuildCommonOptions)(e);for(const t of Object.keys(s)){const i=s[t].newValue;s[t].error?(null!==i&&void 0!==i&&(e[t]=i),null!==i?console.warn(s[t].error,`will use the new value ${s[t].newValue}`):console.error(s[t].error)):Editor.Profile.setConfig("builder",`common.${t}`,e[t],"local"),lodash.set(this.task.errorMap,t,s[t].error)}e.outputName=await(0,common_options_validator_1.calcValidOutputName)(e.buildPath,e.outputName,e.platform),Editor.Profile.setConfig("builder","common.outputName",e.outputName,"local"),e.packages&&Object.keys(e.packages).forEach(t=>{const s=e.packages[t];Editor.Profile.setConfig(t,`builder.options.${e.platform}`,s,"local")}),this.checkRes=!(0,utils_1.checkHasError)(this.task.errorMap)}catch(t){return void console.error(t)}this.task=Object.assign(Object.assign({},this.task),{options:e});const s=this.$refs.settings;s&&s.onPluginUpdate("importConfig","",e)},updateErrorMap(t,e){t&&lodash.set(this.task.errorMap,t,e),"check"!==this.settingsType&&(this.checkRes=!(0,utils_1.checkHasError)(this.task.errorMap))},async initBundleInfo(){const t=await Editor.Message.request("asset-db","query-assets",{isBundle:!0},["meta"]);t&&(this.bundles=t.map(t=>({root:t.url,name:t.meta.userData.bundleName||(0,path_1.basename)(t.url),output:!0})))},async onPluginManagerReady(){this.isDBReady=await Editor.Message.request("asset-db","query-ready"),this.isBuildWorkerReady=await Editor.Message.request("builder","query-worker-ready"),await this.initTasks(),this.supportPlatformMap=plugin_1.pluginManager.getSupportPlatformMap(),this.isDBReady&&await this.initAssets(),this.internalMaskInfo="",console.debug("Home onPluginManagerReady"),this.runOpenPageTask()},async initAssets(){this.scenes=await(0,common_options_validator_1.getCommonOptionDefaultByKey)("scenes"),await this.initBundleInfo(),this.scenes.length>0&&0===Object.keys(this.taskMap).length&&Object.keys(this.supportPlatformMap).length&&this.onNewBuildTask()},handleScroll(){if(!this.showSettings){const t=this.$refs.taskWrap;t&&(this.scrollPosition=t.scrollTop)}}},template:template});