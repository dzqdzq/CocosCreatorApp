"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,s)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.components=exports.props=exports.template=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),platformConfig=__importStar(require("../../../share/platforms-options")),commonOptions=__importStar(require("../../../share/common-options-validator")),bundle_utils_1=require("../../../share/bundle-utils"),plugin_1=require("../../plugin"),buildProp=__importStar(require("../build-prop/index")),buildPlugin=__importStar(require("./build-plugin")),common_options_validator_1=require("../../../share/common-options-validator"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:""};function data(){return{viewTask:!1,platformOrder:platformConfig.PLATFORMS,sceneSearchName:"",dev:!1,compInfos:[],builtinPlugins:platformConfig.builtinPlugins,disabledPkg:["android","huawei-agc","ios","windows","mac","native","ohos"],optionsReady:!1}}async function mounted(){console.time("Settings mounted");const e=this;e.updateOptionScenes();const t=e.options;t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?t.mainBundleIsRemote=!1:t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&(t.mainBundleIsRemote=!0);const n=await plugin_1.pluginManager.checkCommonOptionByKey("name",t.name,e.options);if(e.errorMap.name="error"===n.level?n.error:"",e.compInfos=plugin_1.pluginManager.getPlatformCompInfos(t.platform),t.packages){const t={};for(const n of e.compInfos)t[n.pkgName]={};e.errorMap.packages=t}t.recompileConfig&&delete t.recompileConfig;const o=require("@editor/setting");e.dev=o.dev,e.optionsReady=!0,console.timeEnd("Settings mounted")}function patchDisabledToConfig(e,t,n){return e?((e=JSON.parse(JSON.stringify(e)))[t]||(e[t]={render:{ui:"ui-checkbox",attributes:{disabled:n}}}),e[t].hidden?e:(e[t].render.attributes||(e[t].render.attributes={}),n?(e[t].render.attributes.disabled=!0,delete e[t].verifyRules):e[t].render.attributes.disabled=!1,e)):(console.debug(e,t,n),e)}function sortScenesWithIBundle(e){return e.sort((e,t)=>(e.inBundle?0:-1)-(t.inBundle?0:-1))}exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static","/template/components/settings/index.html"),"utf8"),exports.props=["type","options","free","task","scenes","errorMap","platforms"],exports.components={"build-prop":buildProp,"build-plugin":buildPlugin},exports.data=data,exports.watch={"options.startScene"(e){const t=this;if(!t.options)return;let n=!1;t.options.scenes&&(n=t.options.scenes.some(t=>t.uuid===e));let o=null;for(let n=0;n<t.scenes.length;n++)t.scenes[n].uuid===e&&(o=t.scenes[n]);!n&&o&&t.options.scenes.push(o)},scenes(){this.updateOptionScenes()}},exports.computed={buildBtnState(){const e=this.errorMap;for(const t of Object.keys(e)){if(e[t])return!1}return!0},sceneList(){const e=[],t=[],n=this.sceneSearchName&&new RegExp(`${this.sceneSearchName}`,"i");return this.scenes.forEach((o,s)=>{if(t.push(o.uuid),n&&!n.test(o.url))return e.push(Object.assign({hide:!0},o));e.push(o)}),this.options.scenes?(this.options.scenes.forEach((n,o)=>{if(!t.includes(n.uuid)){const t=Object.assign({missing:!0},n);e.push(t)}}),sortScenesWithIBundle(e)):sortScenesWithIBundle(e)},compressionTypes(){return plugin_1.pluginManager.bundleConfig[this.options.platform]?plugin_1.pluginManager.bundleConfig[this.options.platform].supportedCompressionTypes:[]},optionConfigs(){var e;let t=plugin_1.pluginManager.getCommonOptionConfigs(this.options.platform);return t=patchDisabledToConfig(t,"useBuiltinServer","project://build"!==this.options.buildPath),"project://build"!==this.options.buildPath&&(t.useBuiltinServer.description="i18n:builder.options.use_builtin_server_disabled"),t=patchDisabledToConfig(t,"server",this.options.useBuiltinServer&&"project://build"===this.options.buildPath),"new"!==this.type&&["android"].includes(this.options.platform)?(t.name.render.attributes||(t.name.render.attributes={}),t.name.render.attributes.disabled=!0):null===(e=t.name.render.attributes)||void 0===e||delete e.disabled,t}},exports.methods={calcPropClass(e,t){var n;const o=null!==(n=this.optionConfigs[e].verifyLevel)&&void 0!==n?n:"error";return`${t?MessageTypeMap[o]:""}`},t(e,t=!0){e=e.replace("i18n:","");const n=Editor.I18n.t(`${t?"builder.":""}${e}`);return n&&"string"==typeof n?n:e},_isRemoteLocked(){const e=this.options.mainBundleCompressionType;return e===bundle_utils_1.BundleCompressionTypes.ZIP||e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE},_checkSelectAllScenes:(e,t)=>!e||!t||e.every(e=>t.some(t=>t.uuid===e.uuid)),_checkSelectScene:(e,t)=>!e||!t||t.some(t=>t.uuid===e.uuid||e.inBundle),_onSelectSceneConfirm(e,t){const n=JSON.parse(JSON.stringify(this.options.scenes));n.some((e,o)=>e.uuid===t.uuid&&(n.splice(o,1),!0)),e.target.value&&n.push({url:t.url,uuid:t.uuid}),this.onSettingsChange("scenes",n)},async _onCompressionTypeConfirm(e){const t=this;await t.onSettingsChange("mainBundleCompressionType",e.target.value),t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?await t.onSettingsChange("mainBundleIsRemote",!1):t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&await t.onSettingsChange("mainBundleIsRemote",!0)},_onSelectAllScenesConfirm(e){const t=this;let n=[];if(e.target.value)n=t.scenes.map(e=>({url:e.url,uuid:e.uuid}));else for(let e=0;e<t.scenes.length;e++)(t.scenes[e].uuid===t.options.startScene||t.scenes[e].inBundle)&&n.push(t.scenes[e]);t.onSettingsChange("scenes",n)},async onConfirm(e){const t=e.target.getAttribute("path");if(!t)return;let n=e.target.value;void 0!==e.target.value&&null!==e.target.value||(n=e.target.getAttribute("value")),await this.onSettingsChange(t,n)},async onSettingsChange(e,t){const n=this;let o=!0;t===lodash.get(n.options,e)&&(o=!1);const s=await plugin_1.pluginManager.checkCommonOptionByKey(e,t,n.options);if("platform"===e&&o){const o=await plugin_1.pluginManager.getOptionsByPlatform(t);if(n.options.packages=o.packages,n.compInfos=[],Object.assign(n.options,o),await n.onCommonDataChange("outputName",(0,common_options_validator_1.calcValidOutputName)(n.options.buildPath,t)),t&&plugin_1.pluginManager.bundleConfig[t]){const e=plugin_1.pluginManager.bundleConfig[t].supportedCompressionTypes,o=await(0,plugin_1.checkBundleCompressionSetting)(n.options.mainBundleCompressionType,e);await n.onSettingsChange("mainBundleCompressionType",o.newValue)}return n.$root.updateErrorMap("packages",{}),n.onCommonDataChange(e,t,"error"===s.level?s.error:""),void(n.compInfos=plugin_1.pluginManager.getPlatformCompInfos(t))}n.onCommonDataChange(e,t,"error"===s.level?s.error:"")},async revealInExplorer(){const e=(0,path_1.join)(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName);electron_1.shell.showItemInFolder(e)},onSetSplashSetting(){Editor.Message.send("project","open-settings","builder","splash-setting")},getType(e){return"new"===this.type?"new":["ios","windows","mac","android","ohos"].includes(e)?"check":this.type},async initPlatformOptions(e){const t=await plugin_1.pluginManager.getOptionsByPlatform(e);lodash.defaultsDeep(this.options,t)},onPluginUpdate(e,t,n,o){const s=this;if(s.optionsReady){if(void 0!==o&&s.$root.updateErrorMap(t,o&&JSON.parse(JSON.stringify(o))||null),"importConfig"!==e){if(!!lodash.isEqual(lodash.get(s.options,t),n))return}lodash.set(s.options,t,n&&JSON.parse(JSON.stringify(n))),Editor.Profile.setConfig(e,`options.${s.options.platform}`,lodash.get(s.options,`packages.${e}`),"local"),s.emitPluginUpdate(e,t,n,o)}else console.debug("change before ready",e,t,n,o)},onCommonDataChange(e,t,n){this.errorMap[e]=n,this.$set(this.options,e,t),Editor.Profile.setConfig("builder",`common.${e}`,t,"local"),Editor.Profile.setConfig(this.options.platform,`common.${e}`,t,"local"),this.$root.updateErrorMap(e,n),this.emitPluginUpdate("common",e,t,n)},emitPluginUpdate(e,t,n,o){this.$root.updateTaskOptions(Object.assign(Object.assign({},this.task),{options:this.options})),this.$refs.plugins&&this.$refs.plugins.forEach(o=>{o.update(e,t,n)})},async updateOptionScenes(){const e=this,t=e.options;t.scenes?t.scenes.forEach(t=>{const n=e.scenes.find(e=>e.uuid===t.uuid);n?(t.url=n.url,t.inBundle=n.inBundle):t.missing=!0}):t.scenes=e.scenes;const n=await commonOptions.checkBuildCommonOptionsByKey("startScene",t.startScene,e.options);e.errorMap.startScene=n&&n.error,e.$root.updateErrorMap("startScene",n&&n.error)}},exports.mounted=mounted;