"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.components=exports.props=exports.template=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),platformConfig=__importStar(require("../../../share/platforms-options")),commonOptions=__importStar(require("../../../share/common-options-validator")),bundle_utils_1=require("../../../share/bundle-utils"),plugin_1=require("../../plugin"),buildProp=__importStar(require("../build-prop/index")),buildPlugin=__importStar(require("./build-plugin")),common_options_validator_1=require("../../../share/common-options-validator"),utils_1=require("../../../share/utils"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:""};function data(){return{viewTask:!1,platformOrder:platformConfig.PLATFORMS,sceneSearchName:"",dev:!1,compInfos:[],currentCompPlatform:"",builtinPlugins:platformConfig.builtinPlugins,disabledPkg:["android","huawei-agc","ios","windows","mac","native","ohos"],optionsReady:!1,commonOptionsKeys:["md5Cache","debug","sourceMaps","buildScriptTargets","experimentalEraseModules","polyfills","skipCompressTexture"],mainBundleIsRemoteWarnTip:"",bundleSearchName:"",internalBundleList:{[bundle_utils_1.BuiltinBundleName.MAIN]:{name:bundle_utils_1.BuiltinBundleName.MAIN,root:"",output:!0},[bundle_utils_1.BuiltinBundleName.INTERNAL]:{name:bundle_utils_1.BuiltinBundleName.INTERNAL,root:"",output:!0},[bundle_utils_1.BuiltinBundleName.START_SCENE]:{name:bundle_utils_1.BuiltinBundleName.START_SCENE,root:"",output:!0}}}}async function mounted(){console.time("Settings mounted");const e=this;await e.updateOptionScenes();const t=e.options;t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?t.mainBundleIsRemote=!1:t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&(t.mainBundleIsRemote=!0),e.$refs["build-path"]&&(e.$refs["build-path"].value=t.buildPath),e.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(t);const n=await plugin_1.pluginManager.checkCommonOptionByKey("name",t.name,e.options);if(e.errorMap.name="error"===n.level?n.error:"",e.compInfos=plugin_1.pluginManager.getPlatformCompInfos(t.platform),e.currentCompPlatform=t.platform,t.packages){const t={};for(const n of e.compInfos)t[n.pkgName]={};e.errorMap.packages=t}e.dev=Editor.App.dev,e.optionsReady=!0,console.timeEnd("Settings mounted")}function patchDisabledToConfig(e,t,n){if(!e)return console.debug(e,t,n),e;if((e=JSON.parse(JSON.stringify(e)))[t]||(e[t]={render:{ui:"ui-checkbox",attributes:{disabled:n}}}),e[t].hidden)return e;const o=e[t].render||{ui:""};return o.attributes||(o.attributes={}),n?(o.attributes.disabled=!0,delete e[t].verifyRules):o.attributes.disabled=!1,e}function sortScenesWithIBundle(e){return e.sort((e,t)=>(e.bundle?0:-1)-(t.bundle?0:-1))}function checkMainBundleIsRemote(e){return!e.mainBundleIsRemote||e.useBuiltinServer||e.server?"":Editor.I18n.t("builder.options.mainBundleRemoteTips")}exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static","/template/components/settings/index.html"),"utf8"),exports.props=["type","options","free","task","scenes","bundles","errorMap","platforms"],exports.components={"build-prop":buildProp,"build-plugin":buildPlugin},exports.data=data,exports.watch={"options.startScene"(e){const t=this;if(!t.options)return;let n=!1;t.options.scenes&&(n=t.options.scenes.some(t=>t.uuid===e));let o=null;for(let n=0;n<t.scenes.length;n++)t.scenes[n].uuid===e&&(o=t.scenes[n]);!n&&o&&t.options.scenes.push(o)},scenes(){this.updateOptionScenes()},"options.buildPath":{async handler(e){const t=this;if(t.$refs["build-path"]){if(t.$refs["build-path"].invalid)t.onCommonDataChange("buildPath","","buildPath is invalid!");else{const n=await plugin_1.pluginManager.checkCommonOptionByKey("buildPath",e,t.options);t.$refs["build-path"].value=e,t.onCommonDataChange("buildPath",e,n.error)}}}},"options.platform":{async handler(e){this.optionsReady=!1,await this.changePlatform(e),this.optionsReady=!0}}},exports.computed={buildBtnState(){const e=this.errorMap;for(const t of Object.keys(e)){if(e[t])return!1}return!0},sceneList(){const e=this,t=[],n=[],o=e.sceneSearchName&&new RegExp(`${e.sceneSearchName}`,"i");return e.scenes.forEach((i,s)=>{if(n.push(i.uuid),o&&!o.test(i.url))return t.push(Object.assign({hide:!0},i));if(e.options.bundleConfigs&&e.options.bundleConfigs.length&&i.bundle){if(!e.options.bundleConfigs.find(e=>e.root===i.bundle))return}t.push(i)}),e.options.scenes?(e.options.scenes.forEach((e,o)=>{if(!n.includes(e.uuid)){const n=Object.assign({missing:!0},e);t.push(n)}}),sortScenesWithIBundle(t)):sortScenesWithIBundle(t)},bundleList(){const e=this,t=[],n=[],o=e.bundleSearchName&&new RegExp(`${e.bundleSearchName}`,"i");return Object.values(e.internalBundleList).concat(e.bundles).forEach((i,s)=>{if(i.name!==bundle_utils_1.BuiltinBundleName.START_SCENE||e.options.startSceneAssetBundle){if(n.push(i.root),o&&!o.test(i.root)&&!o.test(i.name))return t.push(Object.assign({hide:!0},i));t.push(Object.assign(Object.assign({},i),{output:!0}))}}),e.options.bundleConfigs&&e.options.bundleConfigs.length?(e.options.bundleConfigs.forEach((o,i)=>{if(!(n.includes(o.root)||o.name in e.internalBundleList)){const e=Object.assign({missing:!0,output:!1},o);t.push(e)}}),t):t},compressionTypes(){return plugin_1.pluginManager.bundleConfigs[this.options.platform]?plugin_1.pluginManager.bundleConfigs[this.options.platform].supportOptions.compressionType:[]},optionConfigs(){var e;let t=plugin_1.pluginManager.getCommonOptionConfigs(this.options.platform);return t=patchDisabledToConfig(t=patchDisabledToConfig(t,"useBuiltinServer","project://build"!==this.options.buildPath),"bundleCommonChunk","bundle"===this.options.buildMode),"project://build"!==this.options.buildPath&&(t.useBuiltinServer.description="i18n:builder.options.use_builtin_server_disabled"),(t=patchDisabledToConfig(t,"server",this.options.useBuiltinServer&&"project://build"===this.options.buildPath)).server.render.attributes.tooltip=this.options.server,"new"!==this.type&&["android"].includes(this.options.platform)?(t.name.render||(t.name.render={ui:""}),t.name.render.attributes||(t.name.render.attributes={}),t.name.render.attributes.disabled=!0):t.name.render&&(null===(e=t.name.render.attributes)||void 0===e||delete e.disabled),t}},exports.methods={calcPropClass(e,t){var n;const o=null!==(n=this.optionConfigs[e].verifyLevel)&&void 0!==n?n:"error";return`${t?MessageTypeMap[o]:""}`},t(e,t=!0){e=e.replace("i18n:","");const n=Editor.I18n.t(`${t?"builder.":""}${e}`);return n&&"string"==typeof n?n:e},_isRemoteLocked(){const e=this.options.mainBundleCompressionType;return e===bundle_utils_1.BundleCompressionTypes.ZIP||e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE},_checkSelectAllScenes:(e,t)=>!e||!t||e.every(e=>t.some(t=>t.uuid===e.uuid)),_checkSelectScene:(e,t)=>!(e&&t&&!e.bundle)||t.some(t=>t.uuid===e.uuid),_onSelectSceneConfirm(e,t){const n=JSON.parse(JSON.stringify(this.options.scenes));n.some((e,o)=>e.uuid===t.uuid&&(n.splice(o,1),!0)),e.target.value&&n.push({url:t.url,uuid:t.uuid,bundle:t.bundle}),this.onSettingsChange("scenes",n)},async _onCompressionTypeConfirm(e){const t=this;await t.onSettingsChange("mainBundleCompressionType",e.target.value),t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?await t.onSettingsChange("mainBundleIsRemote",!1):t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&await t.onSettingsChange("mainBundleIsRemote",!0)},_onSelectAllScenesConfirm(e){const t=this;let n=[];if(e.target.value)n=t.scenes.map(e=>({url:e.url,uuid:e.uuid,bundle:e.bundle}));else for(let e=0;e<t.scenes.length;e++)(t.scenes[e].uuid===t.options.startScene||t.scenes[e].bundle)&&n.push(t.scenes[e]);t.onSettingsChange("scenes",n)},_onSelectAllBundlesConfirm(e){const t=this;let n=JSON.parse(JSON.stringify(t.options.bundleConfigs||[])),o="";e.target.value?n=[]:"bundle"!==t.options.buildMode?n=Object.values(t.internalBundleList):(o="i18n:builder.error.bundleConfigs",n=[]),t.onCommonDataChange("bundleConfigs",n,o)},_onSelectBundleConfirm(e,t){const n=this;let o=JSON.parse(JSON.stringify(n.options.bundleConfigs));e.target.value?o.some(e=>e.root&&e.root===t.root||e.name===t.name)||o.push(Object.assign(Object.assign({},t),{output:!0})):(o&&o.length||(o=n.bundleList),o.some((e,n)=>(e.root===t.root||e.name===t.name)&&(o.splice(n,1),!0)));let i="";o.length||(i="i18n:builder.error.bundleConfigs"),n.onCommonDataChange("bundleConfigs",o,i)},_checkSelectBundle(e){const t=this.options.bundleConfigs;return!(e&&t&&(t.length||this.errorMap.bundleConfigs)&&("bundle"===this.options.buildMode||!this.internalBundleList[e.name]))||t.some(t=>(t.root&&t.root===e.root||t.name===e.name)&&t.output)},_checkSelectAllBundles(e){const t=this.options.bundleConfigs;if(!e||!t||!t.length&&!this.errorMap.bundleConfigs)return!0;if(e.length!==t.length)return!1;const n=e.every(e=>t.some(t=>(t.root&&t.root===e.root||t.name===e.name)&&t.output));return n&&(this.options.bundleConfigs.length=0,this.onCommonDataChange("bundleConfigs",t,"")),n},async onBuildPathConfirm(e){this.$set(this.options,"buildPath",e.target.value)},async onConfirm(e){const t=e.target.getAttribute("path");if(!t)return;let n=e.target.value;void 0!==e.target.value&&null!==e.target.value||(n=e.target.getAttribute("value")),await this.onSettingsChange(t,n)},async onSettingsChange(e,t){const n=this;if("platform"===e)return void await n.changePlatform(t);const o=await plugin_1.pluginManager.checkCommonOptionByKey(e,t,n.options);n.onCommonDataChange(e,t,"error"===o.level?o.error:"")},async changePlatform(e){const t=this;if(!e||e===t.currentCompPlatform)return;const n=await plugin_1.pluginManager.checkCommonOptionByKey("platform",e,t.options);if(t.compInfos=[],"new"===t.type){const n=await plugin_1.pluginManager.getOptionsByPlatform(e);t.options.packages=n.packages,t.options.buildStageGroup=n.buildStageGroup,Object.assign(t.options,n)}t.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(t.options);const o=await plugin_1.pluginManager.checkCommonOptionByKey("buildPath",t.options.buildPath,t.options);if(await t.onCommonDataChange("buildPath",t.options.buildPath,"error"===o.level?o.error:""),await t.onCommonDataChange("outputName",await(0,common_options_validator_1.calcValidOutputName)(t.options.buildPath,e,t.options.platform,t.task.id)),e&&plugin_1.pluginManager.bundleConfigs[e]){const n=plugin_1.pluginManager.bundleConfigs[e].supportOptions.compressionType,o=await(0,plugin_1.checkBundleCompressionSetting)(t.options.mainBundleCompressionType,n);await t.onSettingsChange("mainBundleCompressionType",o.newValue)}t.$root.updateErrorMap("packages",{}),t.compInfos=plugin_1.pluginManager.getPlatformCompInfos(e),t.currentCompPlatform=e,t.onCommonDataChange("platform",e,"error"===n.level?n.error:"")},async revealInExplorer(){const e=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),this.options.outputName);electron_1.shell.showItemInFolder(e)},onSetSplashSetting(){Editor.Message.send("project","open-settings","builder","splash-setting")},getType(e){return"new"===this.type?"new":["ios","windows","mac","android","ohos"].includes(e)?"check":this.type},async initPlatformOptions(e){const t=await plugin_1.pluginManager.getOptionsByPlatform(e);lodash.defaultsDeep(this.options,t)},onPluginUpdate(e,t,n,o){const i=this;if(i.optionsReady){if(void 0!==o&&i.$root.updateErrorMap(t,o&&JSON.parse(JSON.stringify(o))||null),"importConfig"===e)return i.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(i.options),void i.emitPluginUpdate(e,t,n,o);if(!!lodash.isEqual(lodash.get(i.options,t),n))return;lodash.set(i.options,t,n&&JSON.parse(JSON.stringify(n))),Editor.Profile.setConfig(e,`builder.options.${i.options.platform}`,lodash.get(i.options,`packages.${e}`),"local"),i.emitPluginUpdate(e,t,n,o)}else console.debug("change before ready",e,t,n,o)},async onCommonDataChange(e,t,n){const o=this;o.errorMap[e]=n,o.$set(o.options,e,t),Editor.Profile.setConfig("builder",`common.${e}`,t,"local"),Editor.Profile.setConfig(o.options.platform,`builder.common.${e}`,t,"local"),["mainBundleIsRemote","useBuiltinServer","server"].includes(e)&&(o.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(o.options)),o.$root.updateErrorMap(e,n),o.emitPluginUpdate("common",e,t,n),"useBuiltinServer"===e&&!0===t?(0,utils_1.Metric)("B100020"):"skipCompressTexture"===e&&!0===t&&(0,utils_1.Metric)("B100025")},emitPluginUpdate(e,t,n,o){this.$root.updateTaskOptions(Object.assign(Object.assign({},this.task),{options:this.options})),this.$refs.plugins&&this.$refs.plugins.forEach(o=>{o.update(e,t,n)})},async updateOptionScenes(){const e=this,t=e.options;t.scenes?t.scenes.forEach(t=>{const n=e.scenes.find(e=>e.uuid===t.uuid);n?(t.url=n.url,t.bundle=n.bundle):t.missing=!0}):t.scenes=e.scenes;const n=await commonOptions.checkBuildCommonOptionsByKey("startScene",t.startScene,e.options);e.errorMap.startScene=n&&n.error,e.$root.updateErrorMap("startScene",n&&n.error)}},exports.mounted=mounted;