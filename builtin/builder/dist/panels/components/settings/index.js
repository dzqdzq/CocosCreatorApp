"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,t,o){void 0===o&&(o=t);var i=Object.getOwnPropertyDescriptor(n,t);i&&("get"in i?n.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,o,i)}:function(e,n,t,o){void 0===o&&(o=t),e[o]=n[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.components=exports.props=exports.template=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),platformConfig=__importStar(require("../../../share/platforms-options")),commonOptions=__importStar(require("../../../share/common-options-validator")),bundle_utils_1=require("../../../share/bundle-utils"),plugin_1=require("../../plugin"),buildProp=__importStar(require("../build-prop/index")),buildPlugin=__importStar(require("./build-plugin")),common_options_validator_1=require("../../../share/common-options-validator"),utils_1=require("../../../share/utils"),lodash=require("lodash"),MessageTypeMap={warn:"warn",error:"danger",log:""};function data(){return{viewTask:!1,platformOrder:platformConfig.PLATFORMS,sceneSearchName:"",dev:!1,compInfos:[],builtinPlugins:platformConfig.builtinPlugins,disabledPkg:["android","huawei-agc","ios","windows","mac","native","ohos"],optionsReady:!1,commonOptionsKeys:["md5Cache","debug","sourceMaps","experimentalEraseModules","polyfills","skipCompressTexture"],mainBundleIsRemoteWarnTip:"",bundleSearchName:"",internalBundleList:{[bundle_utils_1.BuiltinBundleName.MAIN]:{name:bundle_utils_1.BuiltinBundleName.MAIN,root:"",output:!0},[bundle_utils_1.BuiltinBundleName.INTERNAL]:{name:bundle_utils_1.BuiltinBundleName.INTERNAL,root:"",output:!0},[bundle_utils_1.BuiltinBundleName.START_SCENE]:{name:bundle_utils_1.BuiltinBundleName.START_SCENE,root:"",output:!0}}}}async function mounted(){console.time("Settings mounted");const e=this;await e.updateOptionScenes();const n=e.options;n.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?n.mainBundleIsRemote=!1:n.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&(n.mainBundleIsRemote=!0),e.$refs["build-path"]&&(e.$refs["build-path"].value=n.buildPath),e.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(n);const t=await plugin_1.pluginManager.checkCommonOptionByKey("name",n.name,e.options);if(e.errorMap.name="error"===t.level?t.error:"",e.compInfos=plugin_1.pluginManager.getPlatformCompInfos(n.platform),n.packages){const n={};for(const t of e.compInfos)n[t.pkgName]={};e.errorMap.packages=n}e.dev=Editor.App.dev,e.optionsReady=!0,console.timeEnd("Settings mounted")}function patchDisabledToConfig(e,n,t){if(!e)return console.debug(e,n,t),e;if((e=JSON.parse(JSON.stringify(e)))[n]||(e[n]={render:{ui:"ui-checkbox",attributes:{disabled:t}}}),e[n].hidden)return e;const o=e[n].render||{ui:""};return o.attributes||(o.attributes={}),t?(o.attributes.disabled=!0,delete e[n].verifyRules):o.attributes.disabled=!1,e}function sortScenesWithIBundle(e){return e.sort((e,n)=>(e.bundle?0:-1)-(n.bundle?0:-1))}function checkMainBundleIsRemote(e){return!e.mainBundleIsRemote||e.useBuiltinServer||e.server?"":Editor.I18n.t("builder.options.mainBundleRemoteTips")}exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static","/template/components/settings/index.html"),"utf8"),exports.props=["type","options","free","task","scenes","bundles","errorMap","platforms"],exports.components={"build-prop":buildProp,"build-plugin":buildPlugin},exports.data=data,exports.watch={"options.startScene"(e){const n=this;if(!n.options)return;let t=!1;n.options.scenes&&(t=n.options.scenes.some(n=>n.uuid===e));let o=null;for(let t=0;t<n.scenes.length;t++)n.scenes[t].uuid===e&&(o=n.scenes[t]);!t&&o&&n.options.scenes.push(o)},scenes(){this.updateOptionScenes()},"options.buildPath":{async handler(e){const n=this;if(n.$refs["build-path"]){if(n.$refs["build-path"].invalid)n.onCommonDataChange("buildPath","","buildPath is invalid!");else{const t=await plugin_1.pluginManager.checkCommonOptionByKey("buildPath",e,n.options);n.$refs["build-path"].value=e,n.onCommonDataChange("buildPath",e,t.error)}}}}},exports.computed={buildBtnState(){const e=this.errorMap;for(const n of Object.keys(e)){if(e[n])return!1}return!0},sceneList(){const e=this,n=[],t=[],o=e.sceneSearchName&&new RegExp(`${e.sceneSearchName}`,"i");return e.scenes.forEach((i,s)=>{if(t.push(i.uuid),o&&!o.test(i.url))return n.push(Object.assign({hide:!0},i));if(e.options.bundleConfigs&&e.options.bundleConfigs.length&&i.bundle){if(!e.options.bundleConfigs.find(e=>e.root===i.bundle))return}n.push(i)}),e.options.scenes?(e.options.scenes.forEach((e,o)=>{if(!t.includes(e.uuid)){const t=Object.assign({missing:!0},e);n.push(t)}}),sortScenesWithIBundle(n)):sortScenesWithIBundle(n)},bundleList(){const e=this,n=[],t=[],o=e.bundleSearchName&&new RegExp(`${e.bundleSearchName}`,"i");return Object.values(e.internalBundleList).concat(e.bundles).forEach((i,s)=>{if(i.name!==bundle_utils_1.BuiltinBundleName.START_SCENE||e.options.startSceneAssetBundle){if(t.push(i.root),o&&!o.test(i.root)&&!o.test(i.name))return n.push(Object.assign({hide:!0},i));n.push(Object.assign(Object.assign({},i),{output:!0}))}}),e.options.bundleConfigs&&e.options.bundleConfigs.length?(e.options.bundleConfigs.forEach((o,i)=>{if(!(t.includes(o.root)||o.name in e.internalBundleList)){const e=Object.assign({missing:!0,output:!1},o);n.push(e)}}),n):n},compressionTypes(){return plugin_1.pluginManager.bundleConfigs[this.options.platform]?plugin_1.pluginManager.bundleConfigs[this.options.platform].supportOptions.compressionType:[]},optionConfigs(){var e;let n=plugin_1.pluginManager.getCommonOptionConfigs(this.options.platform);return n=patchDisabledToConfig(n=patchDisabledToConfig(n,"useBuiltinServer","project://build"!==this.options.buildPath),"bundleCommonChunk","bundle"===this.options.buildMode),"project://build"!==this.options.buildPath&&(n.useBuiltinServer.description="i18n:builder.options.use_builtin_server_disabled"),(n=patchDisabledToConfig(n,"server",this.options.useBuiltinServer&&"project://build"===this.options.buildPath)).server.render.attributes.tooltip=this.options.server,"new"!==this.type&&["android"].includes(this.options.platform)?(n.name.render||(n.name.render={ui:""}),n.name.render.attributes||(n.name.render.attributes={}),n.name.render.attributes.disabled=!0):n.name.render&&(null===(e=n.name.render.attributes)||void 0===e||delete e.disabled),n}},exports.methods={calcPropClass(e,n){var t;const o=null!==(t=this.optionConfigs[e].verifyLevel)&&void 0!==t?t:"error";return`${n?MessageTypeMap[o]:""}`},t(e,n=!0){e=e.replace("i18n:","");const t=Editor.I18n.t(`${n?"builder.":""}${e}`);return t&&"string"==typeof t?t:e},_isRemoteLocked(){const e=this.options.mainBundleCompressionType;return e===bundle_utils_1.BundleCompressionTypes.ZIP||e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE},_checkSelectAllScenes:(e,n)=>!e||!n||e.every(e=>n.some(n=>n.uuid===e.uuid)),_checkSelectScene:(e,n)=>!(e&&n&&!e.bundle)||n.some(n=>n.uuid===e.uuid),_onSelectSceneConfirm(e,n){const t=JSON.parse(JSON.stringify(this.options.scenes));t.some((e,o)=>e.uuid===n.uuid&&(t.splice(o,1),!0)),e.target.value&&t.push({url:n.url,uuid:n.uuid,bundle:n.bundle}),this.onSettingsChange("scenes",t)},async _onCompressionTypeConfirm(e){const n=this;await n.onSettingsChange("mainBundleCompressionType",e.target.value),n.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?await n.onSettingsChange("mainBundleIsRemote",!1):n.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&await n.onSettingsChange("mainBundleIsRemote",!0)},_onSelectAllScenesConfirm(e){const n=this;let t=[];if(e.target.value)t=n.scenes.map(e=>({url:e.url,uuid:e.uuid,bundle:e.bundle}));else for(let e=0;e<n.scenes.length;e++)(n.scenes[e].uuid===n.options.startScene||n.scenes[e].bundle)&&t.push(n.scenes[e]);n.onSettingsChange("scenes",t)},_onSelectAllBundlesConfirm(e){const n=this;let t=JSON.parse(JSON.stringify(n.options.bundleConfigs||[])),o="";e.target.value?t=[]:"bundle"!==n.options.buildMode?t=Object.values(n.internalBundleList):(o="i18n:builder.error.bundleConfigs",t=[]),n.onCommonDataChange("bundleConfigs",t,o)},_onSelectBundleConfirm(e,n){const t=this;let o=JSON.parse(JSON.stringify(t.options.bundleConfigs));e.target.value?o.some(e=>e.root&&e.root===n.root||e.name===n.name)||o.push(Object.assign(Object.assign({},n),{output:!0})):(o&&o.length||(o=t.bundleList),o.some((e,t)=>(e.root===n.root||e.name===n.name)&&(o.splice(t,1),!0)));let i="";o.length||(i="i18n:builder.error.bundleConfigs"),t.onCommonDataChange("bundleConfigs",o,i)},_checkSelectBundle(e){const n=this.options.bundleConfigs;return!(e&&n&&(n.length||this.errorMap.bundleConfigs)&&("bundle"===this.options.buildMode||!this.internalBundleList[e.name]))||n.some(n=>(n.root&&n.root===e.root||n.name===e.name)&&n.output)},_checkSelectAllBundles(e){const n=this.options.bundleConfigs;if(!e||!n||!n.length&&!this.errorMap.bundleConfigs)return!0;if(e.length!==n.length)return!1;const t=e.every(e=>n.some(n=>(n.root&&n.root===e.root||n.name===e.name)&&n.output));return t&&(this.options.bundleConfigs.length=0,this.onCommonDataChange("bundleConfigs",n,"")),t},async onBuildPathConfirm(e){this.$set(this.options,"buildPath",e.target.value)},async onConfirm(e){const n=e.target.getAttribute("path");if(!n)return;let t=e.target.value;void 0!==e.target.value&&null!==e.target.value||(t=e.target.getAttribute("value")),await this.onSettingsChange(n,t)},async onSettingsChange(e,n){const t=this;let o=!0;n===lodash.get(t.options,e)&&(o=!1);const i=await plugin_1.pluginManager.checkCommonOptionByKey(e,n,t.options);if("platform"===e&&o){const o=await plugin_1.pluginManager.getOptionsByPlatform(n);t.options.packages=o.packages,t.options.buildStageGroup=o.buildStageGroup,t.compInfos=[],Object.assign(t.options,o),t.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(t.options);const s=await plugin_1.pluginManager.checkCommonOptionByKey("buildPath",t.options.buildPath,t.options);if(await t.onCommonDataChange("buildPath",t.options.buildPath,"error"===s.level?s.error:""),await t.onCommonDataChange("outputName",await(0,common_options_validator_1.calcValidOutputName)(t.options.buildPath,n,t.options.platform)),n&&plugin_1.pluginManager.bundleConfigs[n]){const e=plugin_1.pluginManager.bundleConfigs[n].supportOptions.compressionType,o=await(0,plugin_1.checkBundleCompressionSetting)(t.options.mainBundleCompressionType,e);await t.onSettingsChange("mainBundleCompressionType",o.newValue)}return t.$root.updateErrorMap("packages",{}),t.onCommonDataChange(e,n,"error"===i.level?i.error:""),void(t.compInfos=plugin_1.pluginManager.getPlatformCompInfos(n))}t.onCommonDataChange(e,n,"error"===i.level?i.error:"")},async revealInExplorer(){const e=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(this.options.buildPath),this.options.outputName);electron_1.shell.showItemInFolder(e)},onSetSplashSetting(){Editor.Message.send("project","open-settings","builder","splash-setting")},getType(e){return"new"===this.type?"new":["ios","windows","mac","android","ohos"].includes(e)?"check":this.type},async initPlatformOptions(e){const n=await plugin_1.pluginManager.getOptionsByPlatform(e);lodash.defaultsDeep(this.options,n)},onPluginUpdate(e,n,t,o){const i=this;if(i.optionsReady){if(void 0!==o&&i.$root.updateErrorMap(n,o&&JSON.parse(JSON.stringify(o))||null),"importConfig"===e)return i.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(i.options),void i.emitPluginUpdate(e,n,t,o);if(!!lodash.isEqual(lodash.get(i.options,n),t))return;lodash.set(i.options,n,t&&JSON.parse(JSON.stringify(t))),Editor.Profile.setConfig(e,`builder.options.${i.options.platform}`,lodash.get(i.options,`packages.${e}`),"local"),i.emitPluginUpdate(e,n,t,o)}else console.debug("change before ready",e,n,t,o)},async onCommonDataChange(e,n,t){const o=this;o.errorMap[e]=t,o.$set(o.options,e,n),Editor.Profile.setConfig("builder",`common.${e}`,n,"local"),Editor.Profile.setConfig(o.options.platform,`builder.common.${e}`,n,"local"),["mainBundleIsRemote","useBuiltinServer","server"].includes(e)&&(o.mainBundleIsRemoteWarnTip=checkMainBundleIsRemote(o.options)),o.$root.updateErrorMap(e,t),o.emitPluginUpdate("common",e,n,t),"useBuiltinServer"===e&&!0===n?(0,utils_1.Metric)("B100020"):"skipCompressTexture"===e&&!0===n&&(0,utils_1.Metric)("B100025")},emitPluginUpdate(e,n,t,o){this.$root.updateTaskOptions(Object.assign(Object.assign({},this.task),{options:this.options})),this.$refs.plugins&&this.$refs.plugins.forEach(o=>{o.update(e,n,t)})},async updateOptionScenes(){const e=this,n=e.options;n.scenes?n.scenes.forEach(n=>{const t=e.scenes.find(e=>e.uuid===n.uuid);t?(n.url=t.url,n.bundle=t.bundle):n.missing=!0}):n.scenes=e.scenes;const t=await commonOptions.checkBuildCommonOptionsByKey("startScene",n.startScene,e.options);e.errorMap.startScene=t&&t.error,e.$root.updateErrorMap("startScene",t&&t.error)}},exports.mounted=mounted;