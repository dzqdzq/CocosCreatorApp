"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.components=exports.props=exports.template=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),platformConfig=__importStar(require("../../../share/platforms-options")),commonOptions=__importStar(require("../../../share/common-options-validator")),bundle_utils_1=require("../../../share/bundle-utils"),plugin_1=require("../../plugin"),buildProp=__importStar(require("../build-prop/index")),errorInfo=__importStar(require("../error-info")),buildPlugin=__importStar(require("./build-plugin")),lodash=require("lodash");function data(){return{viewTask:!1,platforms:{},platformOrder:platformConfig.PLATFORMS,sceneSearchName:"",dev:!1,testConfig:{name:{label:"i18n:builder.options.name",ui:"ui-input",options:{placeholder:"Name"}}},compInfos:[],builtinPlugins:platformConfig.builtinPlugins,disabledPkg:["android","huawei-agc","ios","windows","mac","native","ohos"]}}async function mounted(){console.time("Settings mounted");const e=this;e.platforms=plugin_1.pluginManager.platformMap;const t=e.options;if(t.scenes?t.scenes.forEach(t=>{const n=e.scenes.find(e=>e.uuid===t.uuid);n?t.url=n.url:t.missing=!0}):t.scenes=e.scenes,t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?t.mainBundleIsRemote=!1:t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&(t.mainBundleIsRemote=!0),await e.initPlatformOptions(t.platform),e.compInfos=plugin_1.pluginManager.getPlatformCompInfos(t.platform),e.errorMap&&t.packages){const t={};for(const n of e.compInfos)t[n.pkgName]={};e.errorMap.packages=t}t.recompileConfig&&delete t.recompileConfig;const n=require("@editor/setting");e.dev=n.dev,console.timeEnd("Settings mounted")}exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../../static","/template/components/settings/index.html"),"utf8"),exports.props=["type","options","free","scenes","errorMap"],exports.components={"error-info":errorInfo,"build-prop":buildProp,"build-plugin":buildPlugin},exports.data=data,exports.watch={"options.startScene"(e){const t=this;if(!t.options)return;let n=!1;t.options.scenes&&(n=t.options.scenes.some(t=>t.uuid===e));let o=null;for(let n=0;n<t.scenes.length;n++)t.scenes[n].uuid===e&&(o=t.scenes[n]);!n&&o&&t.options.scenes.push(o)}},exports.computed={enableConfig(){return this.platforms[this.options.platform]&&plugin_1.pluginManager.commonOptionConfig[this.options.platform]||{}},buildBtnState(){const e=this.errorMap;for(const t of Object.keys(e)){if(e[t])return!1}return!0},sceneList(){const e=[],t=[],n=this.sceneSearchName&&new RegExp(`${this.sceneSearchName}`,"i");return this.scenes.forEach((o,s)=>{if(t.push(o.uuid),n&&!n.test(o.url))return e.push(Object.assign({hide:!0},o));e.push(o)}),this.options.scenes?(this.options.scenes.forEach((n,o)=>{if(!t.includes(n.uuid)){const t=Object.assign({missing:!0},n);e.push(t)}}),e):e},compressionTypes(){return plugin_1.pluginManager.bundleConfig[this.options.platform]?plugin_1.pluginManager.bundleConfig[this.options.platform].supportedCompressionTypes:[]}},exports.methods={t(e,t=!0){e=e.replace("i18n:","");const n=Editor.I18n.t(`${t?"builder.":""}${e}`);return n&&"string"==typeof n?n:e},_isRemoteLocked(){const e=this.options.mainBundleCompressionType;return e===bundle_utils_1.BundleCompressionTypes.ZIP||e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE},_checkSelectAllScenes:(e,t)=>!e||!t||e.every(e=>t.some(t=>t.uuid===e.uuid)),_checkSelectScene:(e,t)=>!e||!t||t.some(t=>t.uuid===e.uuid||e.inBundle),_onSelectSceneConfirm(e,t){const n=JSON.parse(JSON.stringify(this.options.scenes));n.some((e,o)=>e.uuid===t.uuid&&(n.splice(o,1),!0)),e.target.value&&n.push({url:t.url,uuid:t.uuid}),this.onSettingsChange("scenes",n)},async _onCompressionTypeConfirm(e){const t=this;await t.onSettingsChange("mainBundleCompressionType",e.target.value),t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?await t.onSettingsChange("mainBundleIsRemote",!1):t.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&await t.onSettingsChange("mainBundleIsRemote",!0)},_onSelectAllScenesConfirm(e){const t=this;let n=[];if(e.target.value)n=t.scenes.map(e=>({url:e.url,uuid:e.uuid}));else for(let e=0;e<t.scenes.length;e++)(t.scenes[e].uuid===t.options.startScene||t.scenes[e].inBundle)&&n.push(t.scenes[e]);t.onSettingsChange("scenes",n)},async onConfirm(e){const t=e.target.getAttribute("path");if(!t)return;let n=e.target.value;void 0!==e.target.value&&null!==e.target.value||(n=e.target.getAttribute("value")),this.onSettingsChange(t,n)},async onSettingsChange(e,t){const n=this;let o=await commonOptions.checkBuildCommonOptionsByKey(e,t,n.options);if(n.$root.updateErrorMap(e,o.error),o.error)console.warn(o.error);else{if(t=o.newValue,"platform"===e){if(n.options.packages={},await n.initPlatformOptions(t),await n.onSettingsChange("outputName",n.calcOutputName(n.options.buildPath,t)),t&&plugin_1.pluginManager.bundleConfig[t]){const e=plugin_1.pluginManager.bundleConfig[t].supportedCompressionTypes;o=await plugin_1.checkBundleCompressionSetting(n.options.mainBundleCompressionType,e),await n.onSettingsChange("mainBundleCompressionType",o.newValue)}n.compInfos=plugin_1.pluginManager.getPlatformCompInfos(t)}lodash.set(n.options,e,t),Editor.Profile.setConfig("builder",`common.${e}`,t,"local")}},async revealInExplorer(){const e=path_1.join(Editor.UI.File.resolveToRaw(this.options.buildPath),this.options.outputName);electron_1.shell.showItemInFolder(e)},calcOutputName(e,t){if(!e||!t)return"";let n=path_1.join(Editor.UI.File.resolveToRaw(e),t);return n=Editor.Utils.File.getName(n),path_1.basename(n)},onSetSplashSetting(){Editor.Panel.open("builder.splash-setting")},getType(e){return"new"===this.type?"new":["ios","windows","mac","android","ohos"].includes(e)?"check":this.type},async initPlatformOptions(e){const t=await plugin_1.pluginManager.getOptionsByPlatform(e);this.options.packages=Object.assign(t.packages,this.options.packages)},onPluginUpdate(e,t,n){this.$refs.plugins.forEach(o=>{o.update(e,t,n)})}},exports.mounted=mounted;