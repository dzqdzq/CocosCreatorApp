"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.beforeDestroy=exports.mounted=exports.methods=exports.computed=exports.watch=exports.data=exports.components=exports.props=exports.template=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../../share/utils"),platformConfig=__importStar(require("../../share/platforms-options")),bundle_utils_1=require("../../share/bundle-utils"),buttonsComponent=__importStar(require("./buttons")),plugin_1=require("../plugin"),buildProp=__importStar(require("./build-prop/index")),errorInfo=__importStar(require("./error-info")),lodash=require("lodash"),Vue=require("vue/dist/vue.js");function data(){return{viewTask:!1,platforms:{},platformOrder:platformConfig.PLATFORMS,verifyResult:{},packageVerifyRes:{},disPlayScenes:[],sceneSearchName:"",dev:!1,testConfig:{name:{label:"i18n:builder.options.name",ui:"ui-input",options:{placeholder:"Name"}}},compInfos:[],builtinPlugins:platformConfig.builtinPlugins}}async function mounted(){const e=this;e.platforms=plugin_1.pluginManager.platformMap;const t=e.task.options;t.scenes||(t.scenes=[]),e.updatePluginRender(t.platform);const s=await platformConfig.checkBundleCompressionSetting(t.mainBundleCompressionType,e.compressionTypes);e.$set(e.verifyResult,"mainBundleCompressionType",s);for(const s of Object.keys(t)){const o=t[s],i=await platformConfig.checkBuildCommonOptions(s,o,t);e.$set(e.verifyResult,s,i)}t.recompileConfig&&delete t.recompileConfig;const o=require("@editor/setting");e.dev=o.dev}async function beforeDestroy(){await Editor.Message.send("builder","update-task",this.task.id,this.task.options,this.task.rawOptions),this.$root.updateTaskOptions(this.task.id,this.task.options,this.task.rawOptions)}exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"../../../static","/template/components/settings.html"),"utf8"),exports.props=["type","scenes","task","free"],exports.components={"error-info":errorInfo,"build-prop":buildProp,buttons:buttonsComponent},exports.data=data,exports.watch={"task.options.startScene"(e){const t=this;if(!t.task.options)return;let s=!1;t.task.options.scenes&&(s=t.task.options.scenes.some(t=>t.uuid===e));let o=null;for(let s=0;s<t.scenes.length;s++)t.scenes[s].uuid===e&&(o=t.scenes[s]);!s&&o&&t.task.options.scenes.push(o)}},exports.computed={enableConfig(){return this.platforms[this.task.options.platform]&&plugin_1.pluginManager.commonOptionConfig[this.task.options.platform]||{}},buildBtnState(){const e=this.verifyResult;for(const t of Object.keys(e)){if(e[t].error)return!1}return!0},sceneList(){const e=[],t=[],s=this.sceneSearchName&&new RegExp(`${this.sceneSearchName}`,"i");return this.scenes.forEach((o,i)=>{t.push(o.uuid),!s||s.test(o.url)?e.push(o):e.splice(i,1)}),this.task.options.scenes?(this.task.options.scenes.forEach((s,o)=>{if(!t.includes(s.uuid)){const t=Object.assign({missing:!0},s);e.push(t)}}),e):e},options(){const e=this;return"check"===e.type&&e.task.rawOptions||e.task.options},compressionTypes(){if(plugin_1.pluginManager.bundleConfig[this.task.options.platform])return plugin_1.pluginManager.bundleConfig[this.task.options.platform].supportedCompressionTypes}},exports.methods={t(e,t=!0){e=e.replace("i18n:","");const s=Editor.I18n.t(`${t?"builder.":""}${e}`);return s&&"string"==typeof s?s:e},getPackageVerifyResult(e,t){return t&&t[e]?this.verifyResult.packages[e]:{}},_isRemoteLocked(){const e=this.task.options.mainBundleCompressionType;return e===bundle_utils_1.BundleCompressionTypes.ZIP||e===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE},_checkSelectAllScenes:(e,t)=>!e||!t||e.every(e=>t.some(t=>t.uuid===e.uuid)),_checkSelectScene:(e,t)=>!e||!t||t.some(t=>t.uuid===e.uuid),_onSelectSceneConfirm(e,t){const s=JSON.parse(JSON.stringify(this.task.options.scenes));s.some((e,o)=>e.uuid===t.uuid&&(s.splice(o,1),!0)),e.target.value&&s.push({url:t.url,uuid:t.uuid}),this.onSettingsChange("scenes",s)},_onCompressionTypeConfirm(e){const t=this;t.onSettingsChange("mainBundleCompressionType",e.target.value),t.task.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?t.onSettingsChange("mainBundleIsRemote",!1):t.task.options.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.ZIP&&t.onSettingsChange("mainBundleIsRemote",!0)},_onSelectAllScenesConfirm(e){const t=this;let s=[];if(e.target.value)s=t.scenes.map(e=>({url:e.url,uuid:e.uuid}));else for(let e=0;e<t.scenes.length;e++)if(t.scenes[e].uuid===t.task.options.startScene){s.push(t.scenes[e]);break}t.onSettingsChange("scenes",s)},_onBuildConfirm(){this.$root.onBuild(this.task.options)},_onRecompileConfirm(){this.$root.onRecompile(this.task.id,this.task.options)},async onConfirm(e){const t=e.target.getAttribute("path");if(!t)return;let s=e.target.value;void 0!==e.target.value&&null!==e.target.value||(s=e.target.getAttribute("value")),this.onSettingsChange(t,s)},async onSettingsChange(e,t){const s=this;let o=null;if(o="mainBundleCompressionType"===e?platformConfig.checkBundleCompressionSetting(t,s.compressionTypes):await platformConfig.checkBuildCommonOptions(e,t,s.task.options),s.$set(s.verifyResult,e,o),o.error)console.warn(o.error);else{if(s.beforeOptionsChange(),t=o.newValue,"platform"===e){if(await s.onSettingsChange("outputName",s.calcOutputName(s.task.options.buildPath,t)),t&&plugin_1.pluginManager.bundleConfig[t]){const e=plugin_1.pluginManager.bundleConfig[t].supportedCompressionTypes;o=await platformConfig.checkBundleCompressionSetting(s.task.options.mainBundleCompressionType,e),await s.onSettingsChange("mainBundleCompressionType",o.newValue)}s.updatePluginRender(t)}lodash.set(s.task.options,e,t),Editor.Profile.setConfig("builder",`common.${e}`,t,"local")}},async beforeOptionsChange(){const e=this;e.task.dirty||(e.task.rawOptions=JSON.parse(JSON.stringify(e.task.options)),Editor.Profile.setConfig("builder",`BuildTaskManager.taskMap.${e.task.id}.rawOptions`,e.task.rawOptions,"local"),e.task.dirty=!0)},onRecompileConfig(e,t){this.task.options.recompileConfig[e]=t,this.task.dirty=!0,Editor.Profile.setConfig("builder",`BuildTaskManager.taskMap.${this.task.id}.options.recompileConfig.${e}`,t,"local")},async exportBuildConfig(e){const t=this.task.options;!0===await new Promise(t=>{Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:[{label:this.t("only_build_panel"),click(){t(!1)}},{label:this.t("include_project_setting"),click(){t(!0)}}]})})?await platformConfig.checkProjectSetting(t):(delete t.designResolution,delete t.includeModules,delete t.modules);const s=await Editor.Dialog.save({title:this.t("export_build_config"),path:path_1.join(utils_1.getBuildDist(t.buildPath),`buildConfig_${t.platform}.json`),filters:[{name:"JSON",extensions:["json"]}]});s.filePath&&(t.__version__=require("./../../../package.json").version,fs_extra_1.outputFileSync(s.filePath,JSON.stringify(t,null,2)),console.log(`Build config has export in {link(${s.filePath})}`))},async importBuildConfig(){const e=this,t=await Editor.Dialog.select({title:e.t("import_build_config"),path:utils_1.getBuildDist(e.task.options.buildPath),filters:[{name:"JSON",extensions:["json"]}]});if(!t.filePaths||!t.filePaths[0])return;let s;try{s=fs_extra_1.readJSONSync(t.filePaths[0]),s=Object.assign(e.task.options,s)}catch(e){return void console.error(e)}e.$set(e.task,"options",s)},async revealInExplorer(){const e=path_1.join(utils_1.getBuildDist(this.task.options.buildPath),this.task.options.outputName);electron_1.shell.showItemInFolder(e)},onClose(){this.$root.showSettings=!1},async onChooseBuildPath(){const e=await Editor.Dialog.select({title:"选择发布文件夹",type:"directory"});if(!e.filePaths||!e.filePaths[0])return;this.task.options.buildPath=path_1.relative(Editor.Project.path,e.filePaths[0]),this.onSettingsChange("buildPath",this.task.options.buildPath)},openDocs(){let e=this.task.options.platform;e.startsWith("web-")&&(e="web"),electron_1.shell.openExternal(Editor.Utils.Url.getDocUrl(`editor/publish/publish-${e}.html`))},calcOutputName(e,t){if(!e||!t)return"";let s=path_1.join(utils_1.getBuildDist(e),t);return s=Editor.Utils.File.getName(s),path_1.basename(s)},onSetSplashSetting(){Editor.Panel.open("builder.splash-setting")},updatePluginRender(e){const t=this,s=plugin_1.pluginManager.getPlatformCompInfos(e),o=[];for(const e of s){const s={displayName:e.displayName,pkgName:e.pkgName,wrapWithFold:e.wrapWithFold};if(e.comps&&(s.comps=e.comps),e.panelInfo){const o=document.createElement("ui-panel"),i={};Object.keys(e.panelInfo).forEach(t=>{i[t]=e.panelInfo[t]}),e.panelInfo.ready&&(i.ready=(()=>e.panelInfo.ready.call(o.panelObject,t.task.options,t.type,e.pkgName))),o.config=i,o.setAttribute("name",e.pkgName),s.panel=!0,Vue.nextTick(()=>{const s=Array.isArray(t.$refs[e.pkgName])?t.$refs[e.pkgName][0]:t.$refs[e.pkgName];s?(s.innerHTML="",s.appendChild(o)):Vue.nextTick(()=>{const s=Array.isArray(t.$refs[e.pkgName])?t.$refs[e.pkgName][0]:t.$refs[e.pkgName];s&&(s.innerHTML=""),s&&s.appendChild(o)})})}o.push(s)}t.compInfos=o,t.task.options.packages&&Object.keys(t.task.options.packages).forEach(e=>{-1===o.findIndex(t=>t.pkgName===e)&&delete t.task.options.packages[e]})},async onPlatformConfirm(e,t,s){this.beforeOptionsChange(),lodash.set(this.options,`packages.${e}.${t}`,s),await Editor.Profile.setConfig(e,`options.${this.options.platform}.${t}`,s,"local")},onCheckRawOptions(){this.$root.checkTaskRawOptions(this.task.id)},onEditOptions(){this.$root.editTaskOptions(this.task.id)},onChangeCompileConfig(e){this.task.options.compileImmediately=e},getType(e){return"new"===this.type?"new":this.isDisabledPkg(e)?"check":this.type},isDisabledPkg:e=>["ios","windows","mac","android"].includes(e),onPanelUpdate(e){const t=e.target.getAttribute("name");console.debug("onPanelUpdate",t,e.args),this.onPlatformConfirm(t,...e.args)}},exports.mounted=mounted,exports.beforeDestroy=beforeDestroy;