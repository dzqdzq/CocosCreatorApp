"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager");class PluginManager extends plugin_manager_1.PluginManagerBase{compsMap;customBuildButton={};constructor(){super();const o={};platforms_options_1.builtinPlugins.forEach(t=>{o[t]={}}),this.compsMap=o}async unregister(o){super.unregister(o),Object.keys(this.compsMap).forEach(t=>{delete this.compsMap[t][o.name]})}async internalRegister(t,o){var{platform:e,config:s}=t;const{name:i,buildPath:r,displayName:a}=o;super.internalRegister(t,o),!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(i)||(Editor.App.dev||"darwin"!==process.platform||"windows"!==i)&&(s.doc&&!s.doc.startsWith("http")&&(s.doc=Editor.Utils.Url.getDocUrl(s.doc)),(t=this.customIconConfigs[e][i])&&t.forEach(o=>{if("image"===o.type){let t=o.value;t.startsWith(".")?t=(0,path_1.join)((0,path_1.dirname)(r),t):t.startsWith("project://")&&(t=Editor.UI.__protected__.File.resolveToRaw(t)),t!==o.value&&(o.value=t)}}),o={options:s.options,displayName:a,wrapWithFold:s.wrapWithFold??!0,doc:s.doc},this.compsMap[e][i]=Object.assign(this.compsMap[e][i]||{},o),s.panel)&&(t=(0,path_1.dirname)(r),(o=Editor.Module.__protected__.requireFile(s.panel,{root:t})).template&&(this.compsMap[e][i].panelInfo=o),o.customButton)&&(this.customBuildButton[e]=o.customButton)}getSupportPlatformInfoMap(){const o={};return Object.keys(this.platformInfoMap).forEach(t=>{!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(t)||!Editor.App.dev&&"darwin"===process.platform&&"windows"===t||(o[t]=this.platformInfoMap[t])}),o}getPanelComponent(){const s={};return Object.keys(this.compsMap).forEach(t=>{const e=this.compsMap[t];Object.keys(e).forEach(t=>{var o=e[t].options,o=(o&&(s[o.name]=o),e[t].custom);o&&(s[o.name]=o)})}),s}getPlatformCompInfos(i){if(!i)return[];var t=this.compsMap[i];if(0===Object.keys(t).length)return[];t=Object.keys(t);t.sort((t,o)=>this.pkgPriorities[o]-this.pkgPriorities[t]);const r=[];return t.forEach(t=>{if(Editor.Package.getPackages({name:t,enable:!0}).length){const e=this.compsMap[i][t].options;var o=this.compsMap[i][t].panelInfo;const s={};e&&Object.keys(e).forEach(t=>{(e[t].render||e[t].itemConfigs)&&(s[t]=e[t])}),(Object.keys(s).length||o)&&r.push(Object.assign(this.compsMap[i][t],{pkgName:t,options:s}))}}),r}getButtonsConfig(o){if(!this.customBuildStages[o])return null;const e={};var t;return this.customBuildStages[o]&&(e.buttons=[],(t=Object.keys(this.customBuildStages[o])).length)&&(t.sort((t,o)=>this.pkgPriorities[o]-this.pkgPriorities[t]),t.forEach(t=>{e.buttons.push(...this.customBuildStages[o][t].filter(t=>!t.hidden))})),e}getCustomIconConfigs(t){if(!this.customIconConfigs[t])return null;const e=[];var o;return this.customIconConfigs[t]&&(o=Object.keys(this.customIconConfigs[t])).length&&(o.sort((t,o)=>this.pkgPriorities[o]-this.pkgPriorities[t]),o.forEach(o=>{e.push(...this.customIconConfigs[t][o].map(t=>({...t,pkgName:o})))})),e}async getOptionsByPlatform(t,o=!1){var e=await(0,common_options_validator_1.getCommonOptions)(t,o);for(const i of Object.keys(this.compsMap[t]))e.packages[i]=await Editor.Profile.getConfig(i,"builder.options."+t,o?"default":void 0),e.packages[i]&&(e.packages[i].__version__=this.packageRegisterInfo.get(i)?.version);var s=JSON.parse(JSON.stringify(e));return s.platform=t,s.outputName=await(0,common_options_validator_1.calcValidOutputName)(s.buildPath,t,t),s.taskName||(s.taskName=s.outputName),s.__version__=require((0,path_1.join)(__dirname,"../../package.json")).version,s}}function checkBundleCompressionSetting(t,o){var e={error:"",newValue:t};return o&&-1===o.indexOf(t)&&(e.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,e.error=` compression type(${t}) is invalid for this platform!`),e}exports.pluginManager=new PluginManager;