"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager");class PluginManager extends plugin_manager_1.PluginManagerBase{compsMap;customBuildButton={};constructor(){super();const e={};platforms_options_1.builtinPlugins.forEach(t=>{e[t]={}}),this.compsMap=e}async unregister(e){super.unregister(e),Object.keys(this.compsMap).forEach(t=>{delete this.compsMap[t][e.name]})}async internalRegister(t,e){var{platform:o,config:s}=t,{name:i,buildPath:a,displayName:r}=e;super.internalRegister(t,e),!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(i)||(Editor.App.dev||"darwin"!==process.platform||"windows"!==i)&&(s.doc&&!s.doc.startsWith("http")&&(s.doc=Editor.Utils.Url.getDocUrl(s.doc)),t={options:s.options,displayName:r,wrapWithFold:s.wrapWithFold??!0,doc:s.doc},this.compsMap[o][i]=Object.assign(this.compsMap[o][i]||{},t),s.panel)&&(e=(0,path_1.dirname)(a),(r=Editor.Module.__protected__.requireFile(s.panel,{root:e})).template&&(this.compsMap[o][i].panelInfo=r),r.customButton)&&(this.customBuildButton[o]=r.customButton)}getSupportPlatformMap(){const e={};return Object.keys(this.platformMap).forEach(t=>{!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(t)||!Editor.App.dev&&"darwin"===process.platform&&"windows"===t||(e[t]=this.platformMap[t])}),e}getPanelComponent(){const s={};return Object.keys(this.compsMap).forEach(t=>{const o=this.compsMap[t];Object.keys(o).forEach(t=>{var e=o[t].options,e=(e&&(s[e.name]=e),o[t].custom);e&&(s[e.name]=e)})}),s}getPlatformCompInfos(i){if(!i)return[];var t=this.compsMap[i];if(0===Object.keys(t).length)return[];t=Object.keys(t);t.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]);const a=[];return t.forEach(t=>{if(Editor.Package.getPackages({name:t,enable:!0}).length){const o=this.compsMap[i][t].options;var e=this.compsMap[i][t].panelInfo;const s={};o&&Object.keys(o).forEach(t=>{(o[t].render||o[t].itemConfigs)&&(s[t]=o[t])}),(Object.keys(s).length||e)&&a.push(Object.assign(this.compsMap[i][t],{pkgName:t,options:s}))}}),a}getButtonsConfig(e){if(!this.customBuildStages[e])return null;const o={};var t;return this.customBuildStages[e]&&(o.buttons=[],(t=Object.keys(this.customBuildStages[e])).length)&&(t.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]),t.forEach(t=>{o.buttons.push(...this.customBuildStages[e][t].filter(t=>!t.hidden))})),o}async getOptionsByPlatform(t,e=!1){var o=await(0,common_options_validator_1.getCommonOptions)(t,e);for(const i of Object.keys(this.compsMap[t]))o.packages[i]=await Editor.Profile.getConfig(i,"builder.options."+t,e?"default":void 0),o.packages[i]&&(o.packages[i].__version__=this.packageRegisterInfo.get(i)?.version);var s=JSON.parse(JSON.stringify(o));return s.platform=t,s.outputName=await(0,common_options_validator_1.calcValidOutputName)(s.buildPath,t,t),s.taskName||(s.taskName=s.outputName),s.__version__=require((0,path_1.join)(__dirname,"../../package.json")).version,s}}function checkBundleCompressionSetting(t,e){var o={error:"",newValue:t};return e&&-1===e.indexOf(t)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${t}) is invalid for this platform!`),o}exports.pluginManager=new PluginManager;