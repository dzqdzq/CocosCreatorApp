"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),plugin_manager_1=require("../share/plugin-manager");class PluginManager extends plugin_manager_1.PluginManagerBase{constructor(){super(),this.customBuildButton={};const t={};platforms_options_1.builtinPlugins.forEach(e=>{t[e]={}}),this.compsMap=t}async unregister(t){super.unregister(t),Object.keys(this.compsMap).forEach(e=>{delete this.compsMap[e][t.name]})}async internalRegister(t,e){var o;const{platform:s,config:i}=t,{name:n,buildPath:r,displayName:a}=e;if(super.internalRegister(t,e),!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(n))return;if(!Editor.App.dev&&"darwin"===process.platform&&"windows"===n)return;i.doc&&!i.doc.startsWith("http")&&(i.doc=Editor.Utils.Url.getDocUrl(i.doc));const p={options:i.options,displayName:a,wrapWithFold:null===(o=i.wrapWithFold)||void 0===o||o,doc:i.doc};if(this.compsMap[s][n]=Object.assign(this.compsMap[s][n]||{},p),i.panel){const t=(0,path_1.dirname)(r),e=Editor.Module.__protected__.requireFile(i.panel,{root:t});e.template&&(this.compsMap[s][n].panelInfo=e),e.customButton&&(this.customBuildButton[s]=e.customButton)}}getSupportPlatformMap(){const t={};return Object.keys(this.platformMap).forEach(e=>{!Editor.App.dev&&"win32"===process.platform&&["mac","ios","ios-app-clip"].includes(e)||(Editor.App.dev||"darwin"!==process.platform||"windows"!==e)&&(t[e]=this.platformMap[e])}),t}getPanelComponent(){const t={};return Object.keys(this.compsMap).forEach(e=>{const o=this.compsMap[e];Object.keys(o).forEach(e=>{const s=o[e].options;s&&(t[s.name]=s);const i=o[e].custom;i&&(t[i.name]=i)})}),t}getPlatformCompInfos(t){if(!t)return[];const e=this.compsMap[t];if(0===Object.keys(e).length)return[];const o=Object.keys(e);o.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]);const s=[];return o.forEach(e=>{if(!Editor.Package.getPackages({name:e,enable:!0}).length)return;const o=this.compsMap[t][e].options,i=this.compsMap[t][e].panelInfo,n={};o&&Object.keys(o).forEach(t=>{(o[t].render||o[t].itemConfigs)&&(n[t]=o[t])}),(Object.keys(n).length||i)&&s.push(Object.assign(this.compsMap[t][e],{pkgName:e,options:n}))}),s}getButtonsConfig(t){if(!this.customBuildStages[t])return null;const e={};if(this.customBuildStages[t]){e.buttons=[];const o=Object.keys(this.customBuildStages[t]);o.length&&(o.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]),o.forEach(o=>{e.buttons.push(...this.customBuildStages[t][o])}))}return e}async getOptionsByPlatform(t,e=!1){var o;const s=await(0,common_options_validator_1.getCommonOptions)(t,e),i=Object.keys(this.compsMap[t]);for(const n of i)s.packages[n]=await Editor.Profile.getConfig(n,`builder.options.${t}`,e?"default":void 0),s.packages[n]&&(s.packages[n].__version__=null===(o=this.packageRegisterInfo.get(n))||void 0===o?void 0:o.version);const n=JSON.parse(JSON.stringify(s));return n.platform=t,n.outputName=await(0,common_options_validator_1.calcValidOutputName)(n.buildPath,t,t),n.taskName||(n.taskName=n.outputName),n.__version__=require((0,path_1.join)(__dirname,"../../package.json")).version,n}}function checkBundleCompressionSetting(t,e){const o={error:"",newValue:t};return e&&-1===e.indexOf(t)&&(o.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,o.error=` compression type(${t}) is invalid for this platform!`),o}function transI18nName(t){return"string"!=typeof t?"":t.startsWith("i18n:")?(t=t.replace("i18n:",""),Editor.I18n.t(t)||console.debug(`${t} is not defined in 1i8n`),Editor.I18n.t(t)||t):t}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;