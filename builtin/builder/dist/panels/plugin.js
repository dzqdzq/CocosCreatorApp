"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash=require("lodash"),platforms_options_1=require("../share/platforms-options"),utils_1=require("../share/utils"),validator_manager_1=require("../share/validator-manager");class PluginManager{constructor(){this.platformMap={},this.bundleConfig={},this.commonOptionConfig={},this.pkgPriorities={},this.realInFileExplorerMap={},this.hasInit=!1;const t={};platforms_options_1.builtinPlugins.forEach(e=>{t[e]={}}),this.compsMap=t,this.buttonConfig=JSON.parse(JSON.stringify(t))}async init(){if(this.hasInit)return;this.hasInit=!0;const t=Editor.Package.getPackages({enable:!0});await Promise.all(t.map(t=>(console.debug(`[Build-panel] init: register package ${t.name} in init`),this.register(t)))),Editor.Package.on("enable",async t=>(console.debug(`[Build-panel] onEnable: register package ${t.name} in enable`),await this.register(t)))}async register(t){if(!(t&&t.info&&t.enable&&t.info.contributions&&t.info.contributions.builder))return!1;if("string"!=typeof t.info.contributions.builder)return;console.debug(`[Build-panel] start register pkg ${t.name}`);let e=!1;platforms_options_1.builtinPlugins.includes(t.name)&&(Editor.Utils.Path.contains(Editor.App.path,t.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(t.name))?e=!0:platforms_options_1.builtinPlugins.includes(t.name)&&console.error(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:t.name}));try{const i=path_1.join(t.path,t.info.contributions.builder);if(!require.resolve(i))return;const n=require(i);if(!n.configs)return;n.load&&await n.load();const o=n.configs,s=path_1.dirname(i);for(const i of Object.keys(o)){const n=i,a=o[n];if(a.internal=e,"*"!==i)platforms_options_1.builtinPlugins.includes(n)&&this.internalRegister(n,a,t.name,s,t.info.title);else for(const e of platforms_options_1.PLATFORMS)this.internalRegister(e,a,t.name,s,t.info.title)}}catch(e){console.error(e),console.error(`${t.name} register panelInfo failed!`)}}internalRegister(t,e,i,n,o){var s,a;if(console.debug(`[Build-panel] internalRegister pkg(${i}) in ${t} platform...`),!("win32"===process.platform&&["mac","ios","ios-app-clip"].includes(i)||"darwin"===process.platform&&"windows"===i)){if(this.pkgPriorities[i]=e.priority||(platforms_options_1.builtinPlugins.includes(i)?1:0),"object"==typeof e.verifyRuleMap)for(const n of Object.keys(e.verifyRuleMap)){const o=e.verifyRuleMap[n];o&&o.func&&validator_manager_1.validatorManager.addRule(n,o.func,t+i),o&&o.message&&validator_manager_1.validatorManager.addMessage(n,o.message,t+i)}if(e.options&&(this.compsMap[t][i]={options:createTemplateComp(e.options,t,i),displayName:o,wrapWithFold:null===(s=e.wrapWithFold)||void 0===s||s}),e.panel&&platforms_options_1.builtinPlugins.includes(i)){const s=require(path_1.join(n,e.panel));if(s.component||s.template)if(this.compsMap[t][i]||(this.compsMap[t][i]={displayName:o,wrapWithFold:null===(a=e.wrapWithFold)||void 0===a||a}),s.component){const e=integrateComp(s.component);e.name=t+i+"custom",this.compsMap[t][i].custom=e}else this.compsMap[t][i].panel=s;s.buttonConfig&&(this.buttonConfig[t]=s.buttonConfig)}i===t&&e.platformName&&(this.platformMap[t]=transI18nName(e.platformName),e.commonOptions&&(this.commonOptionConfig[t]=e.commonOptions),e.realInFileExplorer&&(this.realInFileExplorerMap[t]=e.realInFileExplorer),!this.bundleConfig[t]&&e.assetBundleConfig&&(this.bundleConfig[t]=e.assetBundleConfig)),console.debug(`[Build-panel] internalRegister pkg(${i}) in ${t} platform success!`)}}getPanelComponent(){const t={};return Object.keys(this.compsMap).forEach(e=>{const i=this.compsMap[e];Object.keys(i).forEach(e=>{const n=i[e].options;n&&(t[n.name]=n);const o=i[e].custom;o&&(t[o.name]=o)})}),t}getPlatformCompInfos(t){if(!t)return[];const e=this.compsMap[t];if(0===Object.keys(e).length)return[];const i=Object.keys(e);i.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]);const n=[];return i.forEach(e=>{if(!Editor.Package.getPackages({name:e,enable:!0}).length)return;const i=this.compsMap[t][e],o={pkgName:e,displayName:i.displayName||e,wrapWithFold:i.wrapWithFold,comps:[]};i.options&&o.comps.push(i.options.name),i.custom&&o.comps.push(i.custom.name),i.panel&&(o.panelInfo=i.panel),n.push(o)}),n}getButtonsConfig(t){if(!this.buttonConfig[t]||!this.buttonConfig[t].configs)return null;const e={};return Object.keys(this.buttonConfig[t].configs).forEach(i=>{const n=this.buttonConfig[t].configs[i];(n.click||n.hookHandle||"build"===i)&&(e[i]={label:n.label})}),e}runBtn(t,e,i,n){const o=path_1.join(utils_1.getBuildDist(i.buildPath),i.outputName),s=this.buttonConfig[i.platform].configs[e];return s.click?s.click(t,JSON.parse(JSON.stringify(i))):s.hookHandle?Editor.Message.request("builder","run-button-task",e,o,i.platform,n):void 0}getRealInFileExplorer(t){return this.realInFileExplorerMap[t]}}function transI18nName(t){return"string"!=typeof t?"":t.startsWith("i18n:")?(t=t.replace("i18n:",""),Editor.I18n.t(t)||console.debug(`${t} is not defined in 1i8n`),Editor.I18n.t(t)||t):t}function integrateComp(t){return t.mixins=[mixinBase],t}function createDefaultComp(){return{template:'<div class="plugin"><div>'}}function createTemplateComp(t,e,i){return{template:'\n        <div v-if="configs">\n            <build-prop v-for="(config, name) in configs"\n                :key="name"\n                :path="name"\n                :config="config"\n                :value="pkgOptions && pkgOptions[name]"\n                :error="errorMap[name]"\n                @update="onDataUpdate"\n            ></build-prop>\n        </div>',data:()=>({configs:t,pkgOptions:{},errorMap:{}}),methods:{onDataUpdate(t,e){lodash.set(this.pkgOptions,`${t}`,e),this.checkValue(t,e),Editor.Profile.setConfig(this.pkgName,`options.${this.options.platform}`,this.pkgOptions,"local"),this.$emit("update",this.pkgName,t,e)},async init(){const t=this,e=t.options.packages&&t.options.packages[t.pkgName]||{};let i=await Editor.Profile.getConfig(t.pkgName,`options.${t.options.platform}`);"object"!=typeof i&&(i={}),t.pkgOptions=Object.assign(i||{},e),Object.keys(t.pkgOptions).forEach(e=>{t.checkValue(e,t.pkgOptions[e])}),lodash.set(t.options,`packages.${t.pkgName}`,t.pkgOptions)},checkValue(n,o){const s=this;if(!t[n])return;const a=t[n].verifyRules;if(a){if(!validator_manager_1.validator.check("required",o)&&!a.includes("required"))return void(s.errorMap[n]=null);const t=validator_manager_1.validatorManager.check(o,s.options,a,e+i);s.errorMap[n]=t||null}else s.errorMap[n]=null}},async mounted(){await this.init()},props:["options","type","pkgName"],components:{buildProp:require("./components/build-prop/index")},name:e+i+"options"}}exports.pluginManager=new PluginManager;const mixinBase={props:["options","type","pkgName"],components:{buildProp:require("./components/build-prop/index"),errorInfo:require("./components/error-info")}};