"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkBundleCompressionSetting=exports.pluginManager=void 0;const path_1=require("path"),bundle_utils_1=require("../share/bundle-utils"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),validator_manager_1=require("../share/validator-manager");class PluginManager{constructor(){this.platformMap={},this.bundleConfig={},this.commonOptionConfig={},this.pkgPriorities={},this.realInFileExplorerMap={},this.hasInit=!1;const t={};platforms_options_1.builtinPlugins.forEach(e=>{t[e]={}}),this.compsMap=t,this.buttonConfig=JSON.parse(JSON.stringify(t))}async init(){if(this.hasInit)return;this.hasInit=!0;const t=Editor.Package.getPackages({enable:!0});await Promise.all(t.map(t=>(console.debug(`[Build-panel] init: register package ${t.name} in init`),this.register(t)))),Editor.Package.on("enable",async t=>(console.debug(`[Build-panel] onEnable: register package ${t.name} in enable`),await this.register(t))),Editor.Package.on("disable",t=>this.unregister(t))}async register(t){if(!(t&&t.info&&t.enable&&t.info.contributions&&t.info.contributions.builder))return!1;if("string"!=typeof t.info.contributions.builder)return;console.debug(`[Build-panel] start register pkg ${t.name}`);let e=!1;platforms_options_1.builtinPlugins.includes(t.name)&&(Editor.Utils.Path.contains(Editor.App.path,t.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(t.name))?e=!0:platforms_options_1.builtinPlugins.includes(t.name)&&console.error(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:t.name}));try{const i=path_1.join(t.path,t.info.contributions.builder);if(!require.resolve(i))return;const n=require(i);if(!n.configs)return;n.load&&await n.load();const o=n.configs,s=path_1.dirname(i);for(const i of Object.keys(o)){const n=i,r=o[n];if(r.internal=e,"*"!==i)platforms_options_1.builtinPlugins.includes(n)&&this.internalRegister(n,r,t.name,s,t.info.title||t.name);else for(const e of platforms_options_1.PLATFORMS)this.internalRegister(e,r,t.name,s,t.info.title||t.name)}}catch(e){console.error(e),console.error(`${t.name} register panelInfo failed!`)}}async unregister(t){if(!(t&&t.info&&t.enable&&t.info.contributions&&t.info.contributions.builder))return!1;Object.keys(this.compsMap).forEach(e=>{delete this.compsMap[e][t.name]}),delete this.pkgPriorities[t.name]}internalRegister(t,e,i,n,o){var s;if(console.debug(`[Build-panel] internalRegister pkg(${i}) in ${t} platform...`),!("win32"===process.platform&&["mac","ios","ios-app-clip"].includes(i)||"darwin"===process.platform&&"windows"===i)){if(this.pkgPriorities[i]=e.priority||(platforms_options_1.builtinPlugins.includes(i)?1:0),"object"==typeof e.verifyRuleMap)for(const n of Object.keys(e.verifyRuleMap)){const o=e.verifyRuleMap[n];o&&o.func&&validator_manager_1.validatorManager.addRule(n,o.func,t+i),o&&o.message&&validator_manager_1.validatorManager.addMessage(n,o.message,t+i)}if(this.compsMap[t][i]={options:e.options,displayName:o,wrapWithFold:null===(s=e.wrapWithFold)||void 0===s||s},e.panel&&platforms_options_1.builtinPlugins.includes(i)){const o=require(path_1.join(n,e.panel));o.template&&(this.compsMap[t][i].panelInfo=o),o.buttonConfig&&(this.buttonConfig[t]=o.buttonConfig)}i===t&&e.platformName&&(this.platformMap[t]=e.platformName,e.commonOptions&&(this.commonOptionConfig[t]=e.commonOptions),e.realInFileExplorer&&(this.realInFileExplorerMap[t]=e.realInFileExplorer),!this.bundleConfig[t]&&e.assetBundleConfig&&(this.bundleConfig[t]=e.assetBundleConfig)),console.debug(`[Build-panel] internalRegister pkg(${i}) in ${t} platform success!`)}}getPanelComponent(){const t={};return Object.keys(this.compsMap).forEach(e=>{const i=this.compsMap[e];Object.keys(i).forEach(e=>{const n=i[e].options;n&&(t[n.name]=n);const o=i[e].custom;o&&(t[o.name]=o)})}),t}getPlatformCompInfos(t){if(!t)return[];const e=this.compsMap[t];if(0===Object.keys(e).length)return[];const i=Object.keys(e);i.sort((t,e)=>this.pkgPriorities[e]-this.pkgPriorities[t]);const n=[];return i.forEach(e=>{if(!Editor.Package.getPackages({name:e,enable:!0}).length)return;const i=this.compsMap[t][e].options,o=this.compsMap[t][e].panelInfo,s={};i&&Object.keys(i).forEach(t=>{(i[t].render||i[t].itemConfigs)&&(s[t]=i[t])}),(Object.keys(s).length||o)&&n.push(Object.assign(this.compsMap[t][e],{pkgName:e,options:s}))}),n}getButtonsConfig(t){if(!this.buttonConfig[t]||!this.buttonConfig[t].configs)return null;const e={};return Object.keys(this.buttonConfig[t].configs).forEach(i=>{const n=this.buttonConfig[t].configs[i];(n.click||n.hookHandle||"build"===i)&&(e[i]={label:n.label})}),e}runBtn(t,e,i,n){const o=path_1.join(Editor.UI.File.resolveToRaw(i.buildPath),i.outputName),s=this.buttonConfig[i.platform].configs[e];return s.click?s.click(t,JSON.parse(JSON.stringify(i))):s.hookHandle?Editor.Message.request("builder","run-button-task",e,o,i.platform,n):void 0}getRealInFileExplorer(t){return this.realInFileExplorerMap[t]}async getOptionsByPlatform(t,e=!1){const i=await common_options_validator_1.getCommonOptions(e),n=Object.keys(this.compsMap[t]);for(const o of n)i.packages[o]=await Editor.Profile.getConfig(o,`options.${t}`,e?"default":void 0);const o=JSON.parse(JSON.stringify(i));return o.platform=t,o.outputName=common_options_validator_1.calcValidOutputName(o.buildPath,t),o}}function checkBundleCompressionSetting(t,e){const i={error:"",newValue:t};return e&&-1===e.indexOf(t)&&(i.newValue=bundle_utils_1.BundleCompressionTypes.MERGE_DEP,i.error=` compression type(${t}) is invalid for this platform!`),i}function transI18nName(t){return"string"!=typeof t?"":t.startsWith("i18n:")?(t=t.replace("i18n:",""),Editor.I18n.t(t)||console.debug(`${t} is not defined in 1i8n`),Editor.I18n.t(t)||t):t}exports.pluginManager=new PluginManager,exports.checkBundleCompressionSetting=checkBundleCompressionSetting;