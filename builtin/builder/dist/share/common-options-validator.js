"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPreferenceSetting=exports.checkProjectSetting=exports.checkBuildCommondOptions=exports.checkBuildCommonOptionsByKey=exports.getCommonOptionDefaultByKey=exports.getCommonOptions=exports.commonOptionConfigs=exports.calcValidOutputName=exports.checkStartScene=void 0;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_1=require("./validator"),validator_manager_1=require("./validator-manager"),platforms_options_2=require("./platforms-options");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){if(!Array.isArray(e)||!e.length)return!1;for(const t of e){if(!t||!t.uuid)return!1;if(!await checkAssetExsit(t.uuid))return console.debug(` scene(${t.uuid}) does not exist in library!`),!1}return!0}async function checkAssetExsit(e){if("string"!=typeof e)return!1;return!!await Editor.Message.request("asset-db","query-asset-info",e)}async function checkStartScene(e){if("string"!=typeof e||!e)return!1;const t=await Editor.Message.request("asset-db","query-asset-info",e);return!!t&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>t.url.startsWith(e.url+"/"))}function calcValidOutputName(e,t){if(!e||!t)return"";let i=(0,path_1.join)(Editor.UI.File.resolveToRaw(e),t);return i=Editor.Utils.File.getName(i),(0,path_1.basename)(i)}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}async function getCommonOptions(e,t=!1){const i=JSON.parse(JSON.stringify(await Editor.Profile.getConfig("builder","common","default")));if(!t){const r=await Editor.Profile.getConfig(e,"builder.common",t?"default":void 0);r&&Object.keys(r).forEach(e=>{void 0!==r[e]&&(i[e]=r[e])})}return i.scenes=await getCommonOptionDefaultByKey("scenes"),await checkStartScene(i.startScene)||(i.startScene=await getCommonOptionDefaultByKey("startScene")),i.startScene||console.error("获取可用的默认初始场景失败！当前无场景或场景都在 Bundle 内无法作为初始场景"),i.packages={},i.platform=e,i}async function getCommonOptionDefaultByKey(e,t){switch(e){case"scenes":{const e=await Editor.Message.request("asset-db","query-assets",{type:"scene"});if(!e)return[];const t=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return e.map(e=>({url:e.url,uuid:e.uuid,inBundle:!!t.find(t=>e.url.startsWith(t.url+"/"))}))}case"startScene":{const e=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.inBundle);return e[0]&&e[0].uuid}default:return await Editor.Profile.getConfig("builder",`common.${e}`)}}async function checkBuildCommonOptionsByKey(e,t,i){const r={error:"",newValue:t,level:"error"};switch(e){case"scenes":return await checkScenes(t)||!1||(r.error=`scene ${t} is invalid.`),r.error&&(r.newValue=await getCommonOptionDefaultByKey("scenes")),r;case"startScene":return await checkStartScene(t)||!1||(r.error=` startScene (${t}) does not exist in library or is in Bundle!`),r.error&&(r.newValue=await getCommonOptionDefaultByKey("startScene")),r;case"platform":platforms_options_1.PLATFORMS.includes(t)||(r.error="InValid platform!",r.newValue=null);break;case"mainBundleIsRemote":return t&&i.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(r.newValue=!1,r.error=" bundle can not be remote when compression type is subpackage!"):t||i.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(r.newValue=!0,r.error=" bundle must be remote when compression type is zip!"),r;case"outputName":t?platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol"):(r.error=" outputName can not be empty",r.newValue=calcValidOutputName(i.buildPath,i.platform));break;case"buildPath":t&&"project://"!==t?("string"==typeof t&&t.startsWith(".")&&(t="project://"+t),(0,path_1.isAbsolute)(Editor.UI.File.resolveToRaw(t))||(r.error=`buildPath(${t}) is invalid!`,r.newValue="project://build"),platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol")):(r.error=" buildPath can not be empty",r.newValue="project://build");break;case"md5Cache":case"debug":case"sourceMaps":case"useSplashScreen":case"mergeStartScene":case"experimentalEraseModules":case"useBuiltinServer":if("boolean"!=typeof t){r.error=`typeof ${e} should be boolean but get ${t}`,r.newValue="true"===t||"false"!==t&&await getCommonOptionDefaultByKey(e);break}r.newValue=!!t;break;case"server":if(i.useBuiltinServer)break;r.error=await validator_manager_1.validatorManager.check(t,exports.commonOptionConfigs.server.verifyRules,i,i.platform+i.platform);break;default:return null}return r}async function checkBuildCommondOptions(e){const t=await Editor.Profile.getConfig("builder","common","default"),i={};for(const r of Object.keys(t))i[r]=await checkBuildCommonOptionsByKey(r,e[r],e)||{newValue:e[r],error:"",level:"error"};return i}async function checkProjectSetting(e,t=!1){var i;if(e.includeModules&&t||(e.includeModules=await Editor.Profile.getProject("engine","modules.includeModules")||[]),e.designResolution&&t||(e.designResolution=await Editor.Profile.getProject("project","general.designResolution")),e.renderPipeline&&t||(e.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),e.physicsConfig&&t||(e.physicsConfig=await Editor.Profile.getProject("project","physics"),(null===(i=e.physicsConfig)||void 0===i?void 0:i.defaultMaterial)||(e.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448")),!e.flags||!t){e.flags={};const t=await Editor.Profile.getProject("engine","modules.flags");t&&Object.keys(t).length&&Object.keys(t).forEach(i=>{e.includeModules.includes(i)&&e.flags&&Object.assign(e.flags,t[i])})}if(e.customLayers&&t||(e.customLayers=await Editor.Profile.getProject("project","layer")||[]),!e.sortingLayers||!t){const t=await Editor.Profile.getProject("project","sorting-layer")||{};e.sortingLayers=t.layers||[]}}async function checkPreferenceSetting(e,t=!1){"boolean"==typeof e.useBuildAssetCache&&t||(e.useBuildAssetCache=await Editor.Profile.getConfig("builder","useBuildAssetCache")),"boolean"==typeof e.useBuildEngineCache&&t||(e.useBuildEngineCache=await Editor.Profile.getConfig("builder","useBuildEngineCache")),"boolean"==typeof e.useBuildTextureCompressCache&&t||(e.useBuildTextureCompressCache=await Editor.Profile.getConfig("builder","useBuildTextureCompressCache")),"boolean"==typeof e.useBuildAutoAtlasCache&&t||(e.useBuildAutoAtlasCache=await Editor.Profile.getConfig("builder","useBuildAutoAtlasCache"))}exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName,validator_1.Validator.addRule("supportPlatform",{func:supportPlatform,message:"i18n:builder.error.unknown_platform"}),exports.commonOptionConfigs={platform:{label:"i18n:builder.options.platform",default:"web-desktop",verifyRules:["required","supportPlatform"]},name:{label:"i18n:builder.options.name",render:{ui:"ui-input"},default:Editor.Project.name||(0,path_1.basename)(Editor.Project.path),verifyRules:["required"]},polyfills:{label:"i18n:builder.options.polyfills",description:"i18n:builder.options.polyfills_tips",type:"object",hidden:!0,default:{asyncFunctions:!1},itemConfigs:{asyncFunctions:{label:"i18n:builder.options.async_functions",description:"i18n:builder.options.async_functions_tips",render:{ui:"ui-checkbox"}},coreJs:{label:"i18n:builder.options.core_js",description:"i18n:builder.options.core_js_tips",render:{ui:"ui-checkbox"}}}},server:{label:"i18n:builder.options.remote_server_address",description:"i18n:builder.options.remote_server_address_tips",render:{ui:"ui-input",attributes:{placeholder:"i18n:builder.options.remote_server_address_tips"}},verifyRules:["http"]},sourceMaps:{label:"Source Maps",default:!1,render:{ui:"ui-checkbox"}},experimentalEraseModules:{label:"i18n:builder.options.experimental_erase_modules",description:"i18n:builder.options.experimental_erase_modules_tips",default:!1,experiment:!0,render:{ui:"ui-checkbox"}},buildPath:{label:"i18n:builder.options.build_path",default:"project://build",verifyRules:["required"]},debug:{label:"i18n:builder.options.debug",default:!1,render:{ui:"ui-checkbox"}},useBuiltinServer:{label:"i18n:builder.options.use_builtin_server",default:!1,description:"i18n:builder.options.use_builtin_server_tips",experiment:!0,render:{ui:"ui-checkbox"}},md5Cache:{label:"i18n:builder.options.md5_cache",default:!1,render:{ui:"ui-checkbox"}},mainBundleIsRemote:{label:"i18n:builder.options.main_bundle_is_remote",default:!1,render:{ui:"ui-checkbox"}},mainBundleCompressionType:{label:"i18n:builder.options.main_bundle_compression_type",default:"merge_dep"},useSplashScreen:{label:"i18n:builder.use_splash_screen",default:!0,render:{ui:"ui-checkbox"}},skipCompressTexture:{label:"i18n:builder.options.skip_compress_texture",default:!1,render:{ui:"ui-checkbox"}},packAutoAtlas:{label:"i18n:builder.options.pack_autoAtlas",default:!0},startScene:{label:"i18n:builder.options.start_scene",default:""},outputName:{description:"构建的输出目录名，将会作为后续构建任务上的名称",default:"",verifyRules:["required","normalName"]},scenes:{label:"i18n:builder.options.scenes",default:[]}},exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommondOptions=checkBuildCommondOptions,exports.checkProjectSetting=checkProjectSetting,exports.checkPreferenceSetting=checkPreferenceSetting;