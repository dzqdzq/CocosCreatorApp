"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPreferenceSetting=exports.checkProjectSetting=exports.checkBuildCommonOptions=exports.checkBuildCommonOptionsByKey=exports.getCommonOptionDefaultByKey=exports.getCommonOptions=exports.commonOptionConfigs=exports.checkBuildPathIsInvalid=exports.generateNewOutputName=exports.checkConflict=exports.resolveOutputNameConflict=exports.calcValidOutputName=exports.checkStartScene=void 0;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_1=require("./validator"),validator_manager_1=require("./validator-manager"),platforms_options_2=require("./platforms-options");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){if(!Array.isArray(e)||!e.length)return new Error("Scenes is empty");for(const t of e){if(!t||!t.uuid)return!1;if(!await checkAssetExist(t.uuid))return new Error(Editor.I18n.t("builder.error.missingScenes",{url:t.url||t.uuid}))}return!0}async function checkSceneBundle(e,t){const i=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset"});if(!i)return[];const r=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return i.forEach(i=>{var o;const n=null===(o=r.find(e=>i.url.startsWith(e.url+"/")))||void 0===o?void 0:o.url;!n||t.bundleConfigs&&t.bundleConfigs.length&&!t.bundleConfigs.find(e=>e.root===n)||e.find(e=>e.uuid===i.uuid)||e.push({url:i.url,uuid:i.uuid,bundle:n})}),e}async function checkAssetExist(e){if("string"!=typeof e)return!1;return!!await Editor.Message.request("asset-db","query-asset-info",e)}async function checkStartScene(e){if("string"!=typeof e||!e)return!1;const t=await Editor.Message.request("asset-db","query-asset-info",e);return!!t&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>t.url.startsWith(e.url+"/"))}async function calcValidOutputName(e,t,i,r){if(!e||!t)return"";let o=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),t);return o=Editor.Utils.File.getName(o),await resolveOutputNameConflict(o,i,r)}async function resolveOutputNameConflict(e,t,i){let r=(0,path_1.basename)(e);const{queue:o}=await Editor.Message.request("builder","query-tasks-info"),n={};Object.values(o).forEach(e=>{"build"===e.type&&e.options.buildPath&&i&&i===e.id&&(n[e.id]=e)});const s=createBuildPathDict(n),{dir:a,name:u}=(0,path_1.parse)(e);return checkConflict(a,u,s)&&(r=generateNewOutputName(a,t,s)),r}function createBuildPathDict(e){const t={};for(const i in e){const r=e[i],o=Editor.UI.__protected__.File.resolveToRaw(r.options.buildPath);t[o]||(t[o]=[]),t[o].push(r.options.outputName)}return t}function checkConflict(e,t,i){const r=i[e]||[];for(const e of r)if(t===e)return!0;return!1}function generateNewOutputName(e,t,i){const r=i[e]||[];let o=0;for(const e of r)if(e.startsWith(t+"-")){const i=parseInt(e.substring(t.length+1),10);!isNaN(i)&&i>o&&(o=i)}return`${t}-${(o+1).toString().padStart(3,"0")}`}function checkBuildPathIsInvalid(e){if(!e)return!1;if(e.startsWith("project://")){const t=e.match(/^([a-zA-z]*):\/\/(.*)$/);if(t){const e=t[2].replace(/\\/g,"/");if((0,path_1.isAbsolute)(e)||e.includes("../")||e.startsWith("/"))return!0}}else if(!(0,path_1.isAbsolute)(e))return!0;return!1}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}async function getCommonOptions(e,t=!1){const i=JSON.parse(JSON.stringify(await Editor.Profile.getConfig("builder","common","default")));if(!t){const r=await Editor.Profile.getConfig(e,"builder.common",t?"default":void 0);r&&Object.keys(r).forEach(e=>{void 0!==r[e]&&(i[e]=r[e])})}return i.scenes=await getCommonOptionDefaultByKey("scenes"),await checkStartScene(i.startScene)||(i.startScene=await getCommonOptionDefaultByKey("startScene")),i.startScene||console.error(Editor.I18n.t("builder.error.invalidStartScene")),i.packages={},i.platform=e,i}async function getCommonOptionDefaultByKey(e,t){switch(e){case"scenes":{const e=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset"});if(!e)return[];const t=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return e.map(e=>{var i;return{url:e.url,uuid:e.uuid,bundle:null===(i=t.find(t=>e.url.startsWith(t.url+"/")))||void 0===i?void 0:i.url}})}case"startScene":{const e=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.bundle);return e[0]&&e[0].uuid}default:return await Editor.Profile.getConfig("builder",`common.${e}`)}}async function checkBuildCommonOptionsByKey(e,t,i){const r={error:"",newValue:t,level:"error"};switch(e){case"scenes":{const e=await checkScenes(t)||!1;return e instanceof Error?(r.error=e.message,r.newValue=await getCommonOptionDefaultByKey("scenes")):await checkSceneBundle(t,i),r}case"startScene":return await checkStartScene(t)||!1||(r.error="i18n:builder.error.invalidStartScene"),r.error&&(r.newValue=await getCommonOptionDefaultByKey("startScene")),r;case"platform":platforms_options_1.PLATFORMS.includes(t)||(r.error="InValid platform!",r.newValue=null);break;case"mainBundleIsRemote":return t&&i.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(r.newValue=!1,r.error=" bundle can not be remote when compression type is subpackage!"):t||i.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(r.newValue=!0,r.error=" bundle must be remote when compression type is zip!"),r;case"outputName":t?platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol"):(r.error=" outputName can not be empty",r.newValue=await calcValidOutputName(i.buildPath,i.platform,i.platform));break;case"taskName":t||(r.error=" taskName can not be empty",r.newValue=i.outputName);break;case"buildPath":t&&"project://"!==t?checkBuildPathIsInvalid(t)?(r.error="buildPath is invalid!",r.newValue="project://build"):("string"==typeof t&&t.startsWith(".")&&(t="project://"+t),(0,path_1.isAbsolute)(Editor.UI.__protected__.File.resolveToRaw(t))||(r.error=`buildPath(${t}) is invalid!`,r.newValue="project://build"),platforms_options_2.NATIVE_PLATFORM.includes(i.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol")):(r.error=" buildPath can not be empty",r.newValue="project://build");break;case"md5Cache":case"debug":case"sourceMaps":case"useSplashScreen":case"mergeStartScene":case"experimentalEraseModules":case"useBuiltinServer":if("boolean"!=typeof t){r.error=`typeof ${e} should be boolean but get ${t}`,r.newValue="true"===t||"false"!==t&&await getCommonOptionDefaultByKey(e);break}r.newValue=!!t;break;case"server":if(i.useBuiltinServer)break;r.error=await validator_manager_1.validatorManager.check(t,exports.commonOptionConfigs.server.verifyRules||[],i,i.platform+i.platform);break;default:return null}return r}async function checkBuildCommonOptions(e){const t=await Editor.Profile.getConfig("builder","common","default"),i={};for(const r of Object.keys(t))i[r]=await checkBuildCommonOptionsByKey(r,e[r],e)||{newValue:e[r],error:"",level:"error"};return i}async function checkProjectSetting(e){if(e.includeModules||(e.includeModules=await Editor.Profile.getProject("engine","modules.includeModules")||[]),e.designResolution||(e.designResolution=await Editor.Profile.getProject("project","general.designResolution")),e.renderPipeline||(e.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),!e.physicsConfig){const t=await Editor.Profile.getProject("project","physics");t&&(e.physicsConfig=t,e.physicsConfig.defaultMaterial||(e.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448"))}if(!e.flags){e.flags={};const t=await Editor.Profile.getProject("engine","modules.flags");t&&Object.keys(t).length&&Object.keys(t).forEach(i=>{e.includeModules&&e.includeModules.includes(i)&&e.flags&&Object.assign(e.flags,t[i])})}if(e.customLayers||(e.customLayers=await Editor.Profile.getProject("project","layer")||[]),!e.sortingLayers){const t=await Editor.Profile.getProject("project","sorting-layer")||{};e.sortingLayers=t.layers||[]}e.macroConfig||(e.macroConfig=await Editor.Profile.getProject("engine","macroConfig","project")||{})}async function checkPreferenceSetting(e,t=!1){"boolean"==typeof e.useBuildAssetCache&&t||(e.useBuildAssetCache=await Editor.Profile.getConfig("builder","useBuildAssetCache")),"boolean"==typeof e.useBuildEngineCache&&t||(e.useBuildEngineCache=await Editor.Profile.getConfig("builder","useBuildEngineCache")),"boolean"==typeof e.useBuildTextureCompressCache&&t||(e.useBuildTextureCompressCache=await Editor.Profile.getConfig("builder","useBuildTextureCompressCache")),"boolean"==typeof e.useBuildAutoAtlasCache&&t||(e.useBuildAutoAtlasCache=await Editor.Profile.getConfig("builder","useBuildAutoAtlasCache"))}exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName,exports.resolveOutputNameConflict=resolveOutputNameConflict,exports.checkConflict=checkConflict,exports.generateNewOutputName=generateNewOutputName,exports.checkBuildPathIsInvalid=checkBuildPathIsInvalid,validator_1.Validator.addRule("supportPlatform",{func:supportPlatform,message:"i18n:builder.error.unknown_platform"}),exports.commonOptionConfigs={platform:{label:"i18n:builder.options.platform",default:"web-desktop",verifyRules:["required","supportPlatform"]},name:{label:"i18n:builder.options.name",render:{ui:"ui-input"},default:Editor.Project.name||(0,path_1.basename)(Editor.Project.path),verifyRules:["required"]},polyfills:{label:"i18n:builder.options.polyfills",description:"i18n:builder.options.polyfills_tips",type:"object",hidden:!0,default:{asyncFunctions:!1},itemConfigs:{asyncFunctions:{label:"i18n:builder.options.async_functions",description:"i18n:builder.options.async_functions_tips",render:{ui:"ui-checkbox"}},coreJs:{label:"i18n:builder.options.core_js",description:"i18n:builder.options.core_js_tips",render:{ui:"ui-checkbox"}}}},buildScriptTargets:{label:"i18n:builder.options.buildScriptTargets",description:"i18n:builder.options.buildScriptTargetsTips",hidden:!0,render:{ui:"ui-input",attributes:{placeholder:Editor.I18n.t("builder.example",{example:"> 0.4%"})}}},server:{label:"i18n:builder.options.remote_server_address",description:"i18n:builder.options.remote_server_address_tips",default:"",render:{ui:"ui-input"},verifyRules:["http"]},sourceMaps:{label:"Source Maps",default:!1,render:{ui:"ui-checkbox"}},experimentalEraseModules:{label:"i18n:builder.options.experimental_erase_modules",description:"i18n:builder.options.experimental_erase_modules_tips",default:!1,experiment:!0,render:{ui:"ui-checkbox"}},startSceneAssetBundle:{label:"i18n:builder.options.start_scene_asset_bundle",description:"i18n:builder.options.start_scene_asset_bundle_tips",default:!1,hidden:!0,render:{ui:"ui-checkbox"}},bundleConfigs:{label:"i18n:builder.options.includeBundles",default:[],verifyLevel:"warn"},buildPath:{label:"i18n:builder.options.build_path",default:"project://build",verifyRules:["required"]},debug:{label:"i18n:builder.options.debug",default:!1,render:{ui:"ui-checkbox"}},useBuiltinServer:{label:"i18n:builder.options.use_builtin_server",default:!1,description:"i18n:builder.options.use_builtin_server_tips",hidden:!0,render:{ui:"ui-checkbox"}},md5Cache:{label:"i18n:builder.options.md5_cache",default:!1,render:{ui:"ui-checkbox"}},mainBundleIsRemote:{label:"i18n:builder.options.main_bundle_is_remote",default:!1,render:{ui:"ui-checkbox"}},mainBundleCompressionType:{label:"i18n:builder.options.main_bundle_compression_type",default:"merge_dep"},useSplashScreen:{label:"i18n:builder.use_splash_screen",default:!0,render:{ui:"ui-checkbox"}},bundleCommonChunk:{label:"i18n:builder.bundleCommonChunk",default:!1,render:{ui:"ui-checkbox"}},skipCompressTexture:{label:"i18n:builder.options.skip_compress_texture",default:!1,render:{ui:"ui-checkbox"}},packAutoAtlas:{label:"i18n:builder.options.pack_autoAtlas",default:!0},startScene:{label:"i18n:builder.options.start_scene",default:""},outputName:{description:"构建的输出目录名，将会作为后续构建任务上的名称",default:"",verifyRules:["required","normalName"]},taskName:{default:"",verifyRules:["required"]},scenes:{label:"i18n:builder.options.scenes",default:[]}},exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommonOptions=checkBuildCommonOptions,exports.checkProjectSetting=checkProjectSetting,exports.checkPreferenceSetting=checkPreferenceSetting;