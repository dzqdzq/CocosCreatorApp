"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkProjectSetting=exports.checkBuildCommondOptions=exports.checkBuildCommonOptionsByKey=exports.getCommonOptionDefaultByKey=exports.getCommonOptions=exports.calcValidOutputName=exports.checkStartScene=void 0;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_manager_1=require("./validator-manager");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){if(!Array.isArray(e)||!e.length)return!1;for(const t of e){if(!t||!t.uuid)return!1;if(!await checkAssetExsit(t.uuid))return console.debug(` scene(${t.uuid}) does not exist in library!`),!1}return!0}async function checkAssetExsit(e){if("string"!=typeof e)return!1;return!!await Editor.Message.request("asset-db","query-asset-info",e)}async function checkStartScene(e){if("string"!=typeof e)return!1;const t=await Editor.Message.request("asset-db","query-asset-info",e);return!!t&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>t.url.startsWith(e.url+"/"))}function calcValidOutputName(e,t){if(!e||!t)return"";let r=path_1.join(Editor.UI.File.resolveToRaw(e),t);return r=Editor.Utils.File.getName(r),path_1.basename(r)}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName;const commonOptionsCheckRules={name:["required"],buildPath:["required"],platform:["required","supportPlatform"],outputName:["required","normalName"]};async function getCommonOptions(e=!1){const t=await Editor.Profile.getConfig("builder","common",e?"default":void 0);t.scenes=await getCommonOptionDefaultByKey("scenes");const r=await getCommonOptionDefaultByKey("startScene");return t.startScene=e?r:t.startScene||r,r||console.error("获取可用的默认初始场景失败！当前无场景或场景都在 Bundle 内无法作为初始场景"),t.packages={},t}async function getCommonOptionDefaultByKey(e,t){switch(e){case"scenes":{const e=await Editor.Message.request("asset-db","query-assets",{type:"scene"});if(!e)return[];const t=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return e.map(e=>({url:e.url,uuid:e.uuid,inBundle:!!t.find(t=>e.url.startsWith(t.url+"/"))}))}case"startScene":{const e=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.inBundle);return e[0]&&e[0].uuid}default:return await Editor.Profile.getConfig("builder",`common.${e}`)}}async function checkBuildCommonOptionsByKey(e,t,r){const o={error:"",newValue:t};switch(e){case"scenes":return await checkScenes(t)||!1||(o.error=`scene ${t} is invalid.`),o.error&&(o.newValue=await getCommonOptionDefaultByKey("scenes")),o;case"startScene":return await checkStartScene(t)||!1||(o.error=` startScene (${t}) does not exist in library or is in Bundle!`),o.error&&(o.newValue=await getCommonOptionDefaultByKey("startScene")),o;case"platform":platforms_options_1.PLATFORMS.includes(t)||(o.error="InVaild platform!",o.newValue=null);break;case"mainBundleIsRemote":return t&&r.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(o.newValue=!1,o.error=" bundle can not be remote when compression type is subpackage!"):t||r.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(o.newValue=!0,o.error=" bundle must be remote when compression type is zip!"),o;case"outputName":t||(o.error=" outputName can not be empty",o.newValue=calcValidOutputName(r.buildPath,r.platform));break;case"buildPath":t?path_1.isAbsolute(Editor.UI.File.resolveToRaw(t))||(o.error=`buildPath(${t}) is invalid!`,o.newValue="project://build"):(o.error=" buildPath can not be empty",o.newValue="project://build");break;case"md5Cache":case"debug":case"sourceMaps":case"replaceSplashScreen":case"mergeStartScene":case"experimentalEraseModules":"false"===t&&(o.error=`typeof ${e} should be boolean but get ${t}`,o.newValue=!1),o.newValue=!!t;break;default:const a=commonOptionsCheckRules[e];if(a){if(o.error=await validator_manager_1.validatorManager.check(t,r,a)||"",o.error){const t=await getCommonOptionDefaultByKey(e),n=await validator_manager_1.validatorManager.check(t,r,a)||"";o.newValue=n?null:t}return o}}return o}async function checkBuildCommondOptions(e){const t=await Editor.Profile.getConfig("builder","common","default"),r={};for(const o of Object.keys(t))r[o]=await checkBuildCommonOptionsByKey(o,e[o],e);return r}async function checkProjectSetting(e,t=!1){if(e.includeModules&&t||(e.includeModules=await Editor.Profile.getProject("engine","modules.includeModules")||[]),e.designResolution&&t||(e.designResolution=await Editor.Profile.getProject("project","general.designResolution")),e.renderPipeline&&t||(e.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),e.physicsConfig&&t||(e.physicsConfig=await Editor.Profile.getProject("project","physics")),!e.flags||!t){e.flags={};const t=await Editor.Profile.getProject("engine","modules.flags");t&&Object.keys(t).length&&Object.keys(t).forEach(r=>{e.includeModules.includes(r)&&Object.assign(e.flags,t[r])})}e.customLayers&&t||(e.customLayers=await Editor.Profile.getProject("project","layer")||[])}validator_manager_1.validatorManager.addRule("supportPlatform",supportPlatform),validator_manager_1.validatorManager.addRule("checkStartScene",checkStartScene),validator_manager_1.validatorManager.addMessage("supportPlatform","i18n:builder.error.unknown_platform"),validator_manager_1.validatorManager.addMessage("checkStartScene","StartScene is invalid."),exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommondOptions=checkBuildCommondOptions,exports.checkProjectSetting=checkProjectSetting;