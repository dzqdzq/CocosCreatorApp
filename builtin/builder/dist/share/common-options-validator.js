"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPreferenceSetting=exports.checkProjectSetting=exports.checkBuildCommonOptions=exports.checkBuildCommonOptionsByKey=exports.getCommonOptionDefaultByKey=exports.getCommonOptions=exports.commonOptionConfigs=exports.checkBuildPathIsInvalid=exports.generateNewOutputName=exports.checkConflict=exports.resolveOutputNameConflict=exports.calcValidOutputName=exports.checkStartScene=void 0;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_1=require("./validator"),validator_manager_1=require("./validator-manager"),platforms_options_2=require("./platforms-options");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){if(!Array.isArray(e)||!e.length)return new Error("Scenes is empty");for(const t of e){if(!t||!t.uuid)return!1;if(!await checkAssetExist(t.uuid))return new Error(Editor.I18n.t("builder.error.missingScenes",{url:t.url||t.uuid}))}return!0}async function checkAssetExist(e){if("string"!=typeof e)return!1;return!!await Editor.Message.request("asset-db","query-asset-info",e)}async function checkStartScene(e){if("string"!=typeof e||!e)return!1;const t=await Editor.Message.request("asset-db","query-asset-info",e);return!!t&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>t.url.startsWith(e.url+"/"))}async function calcValidOutputName(e,t,r){if(!e||!t)return"";let i=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),t);return i=Editor.Utils.File.getName(i),await resolveOutputNameConflict(i,r)}async function resolveOutputNameConflict(e,t){let r=(0,path_1.basename)(e);const{queue:i}=await Editor.Message.request("builder","query-tasks-info"),o={};Object.values(i).forEach(e=>{"build"===e.type&&e.options.buildPath&&(o[e.id]=e)});const n=createBuildPathDict(o),{dir:s,name:a}=(0,path_1.parse)(e);return checkConflict(s,a,n)&&(r=generateNewOutputName(s,t,n)),r}function createBuildPathDict(e){const t={};for(const r in e){const i=e[r],o=Editor.UI.__protected__.File.resolveToRaw(i.options.buildPath);t[o]||(t[o]=[]),t[o].push(i.options.outputName)}return t}function checkConflict(e,t,r){const i=r[e]||[];for(const e of i)if(t===e)return!0;return!1}function generateNewOutputName(e,t,r){const i=r[e]||[];let o=0;for(const e of i)if(e.startsWith(t+"-")){const r=parseInt(e.substring(t.length+1),10);!isNaN(r)&&r>o&&(o=r)}return`${t}-${(o+1).toString().padStart(3,"0")}`}function checkBuildPathIsInvalid(e){if(!e)return!1;if(e.startsWith("project://")){const t=e.match(/^([a-zA-z]*):\/\/(.*)$/);if(t){const e=t[2].replace(/\\/g,"/");if((0,path_1.isAbsolute)(e)||e.includes("../")||e.startsWith("/"))return!0}}else if(!(0,path_1.isAbsolute)(e))return!0;return!1}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}async function getCommonOptions(e,t=!1){const r=JSON.parse(JSON.stringify(await Editor.Profile.getConfig("builder","common","default")));if(!t){const i=await Editor.Profile.getConfig(e,"builder.common",t?"default":void 0);i&&Object.keys(i).forEach(e=>{void 0!==i[e]&&(r[e]=i[e])})}return r.scenes=await getCommonOptionDefaultByKey("scenes"),await checkStartScene(r.startScene)||(r.startScene=await getCommonOptionDefaultByKey("startScene")),r.startScene||console.error(Editor.I18n.t("builder.error.invalidStartScene")),r.packages={},r.platform=e,r}async function getCommonOptionDefaultByKey(e,t){switch(e){case"scenes":{const e=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset"});if(!e)return[];const t=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return e.map(e=>{var r;return{url:e.url,uuid:e.uuid,bundle:null===(r=t.find(t=>e.url.startsWith(t.url+"/")))||void 0===r?void 0:r.url}})}case"startScene":{const e=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.bundle);return e[0]&&e[0].uuid}default:return await Editor.Profile.getConfig("builder",`common.${e}`)}}async function checkBuildCommonOptionsByKey(e,t,r){const i={error:"",newValue:t,level:"error"};switch(e){case"scenes":{const e=await checkScenes(t)||!1;return e instanceof Error&&(i.error=e.message),i.error&&(i.newValue=await getCommonOptionDefaultByKey("scenes")),i}case"startScene":return await checkStartScene(t)||!1||(i.error="i18n:builder.error.invalidStartScene"),i.error&&(i.newValue=await getCommonOptionDefaultByKey("startScene")),i;case"platform":platforms_options_1.PLATFORMS.includes(t)||(i.error="InValid platform!",i.newValue=null);break;case"mainBundleIsRemote":return t&&r.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(i.newValue=!1,i.error=" bundle can not be remote when compression type is subpackage!"):t||r.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(i.newValue=!0,i.error=" bundle must be remote when compression type is zip!"),i;case"outputName":t?platforms_options_2.NATIVE_PLATFORM.includes(r.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(i.error="i18n:builder.error.buildPathContainsChineseAndSymbol"):(i.error=" outputName can not be empty",i.newValue=await calcValidOutputName(r.buildPath,r.platform,r.platform));break;case"taskName":t||(i.error=" taskName can not be empty",i.newValue=r.outputName);break;case"buildPath":t&&"project://"!==t?checkBuildPathIsInvalid(t)?(i.error="buildPath is invalid!",i.newValue="project://build"):("string"==typeof t&&t.startsWith(".")&&(t="project://"+t),(0,path_1.isAbsolute)(Editor.UI.__protected__.File.resolveToRaw(t))||(i.error=`buildPath(${t}) is invalid!`,i.newValue="project://build"),platforms_options_2.NATIVE_PLATFORM.includes(r.platform)&&/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、\u4e00-\u9fa5]/im.test(t)&&(i.error="i18n:builder.error.buildPathContainsChineseAndSymbol")):(i.error=" buildPath can not be empty",i.newValue="project://build");break;case"md5Cache":case"debug":case"sourceMaps":case"useSplashScreen":case"mergeStartScene":case"experimentalEraseModules":case"useBuiltinServer":if("boolean"!=typeof t){i.error=`typeof ${e} should be boolean but get ${t}`,i.newValue="true"===t||"false"!==t&&await getCommonOptionDefaultByKey(e);break}i.newValue=!!t;break;case"server":if(r.useBuiltinServer)break;i.error=await validator_manager_1.validatorManager.check(t,exports.commonOptionConfigs.server.verifyRules||[],r,r.platform+r.platform);break;default:return null}return i}async function checkBuildCommonOptions(e){const t=await Editor.Profile.getConfig("builder","common","default"),r={};for(const i of Object.keys(t))r[i]=await checkBuildCommonOptionsByKey(i,e[i],e)||{newValue:e[i],error:"",level:"error"};return r}async function checkProjectSetting(e){if(e.includeModules||(e.includeModules=await Editor.Profile.getProject("engine","modules.includeModules")||[]),e.designResolution||(e.designResolution=await Editor.Profile.getProject("project","general.designResolution")),e.renderPipeline||(e.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),!e.physicsConfig){const t=await Editor.Profile.getProject("project","physics");t&&(e.physicsConfig=t,e.physicsConfig.defaultMaterial||(e.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448"))}if(!e.flags){e.flags={};const t=await Editor.Profile.getProject("engine","modules.flags");t&&Object.keys(t).length&&Object.keys(t).forEach(r=>{e.includeModules&&e.includeModules.includes(r)&&e.flags&&Object.assign(e.flags,t[r])})}if(e.customLayers||(e.customLayers=await Editor.Profile.getProject("project","layer")||[]),!e.sortingLayers){const t=await Editor.Profile.getProject("project","sorting-layer")||{};e.sortingLayers=t.layers||[]}e.macroConfig||(e.macroConfig=await Editor.Profile.getProject("engine","macroConfig","project")||{})}async function checkPreferenceSetting(e,t=!1){"boolean"==typeof e.useBuildAssetCache&&t||(e.useBuildAssetCache=await Editor.Profile.getConfig("builder","useBuildAssetCache")),"boolean"==typeof e.useBuildEngineCache&&t||(e.useBuildEngineCache=await Editor.Profile.getConfig("builder","useBuildEngineCache")),"boolean"==typeof e.useBuildTextureCompressCache&&t||(e.useBuildTextureCompressCache=await Editor.Profile.getConfig("builder","useBuildTextureCompressCache")),"boolean"==typeof e.useBuildAutoAtlasCache&&t||(e.useBuildAutoAtlasCache=await Editor.Profile.getConfig("builder","useBuildAutoAtlasCache"))}exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName,exports.resolveOutputNameConflict=resolveOutputNameConflict,exports.checkConflict=checkConflict,exports.generateNewOutputName=generateNewOutputName,exports.checkBuildPathIsInvalid=checkBuildPathIsInvalid,validator_1.Validator.addRule("supportPlatform",{func:supportPlatform,message:"i18n:builder.error.unknown_platform"}),exports.commonOptionConfigs={platform:{label:"i18n:builder.options.platform",default:"web-desktop",verifyRules:["required","supportPlatform"]},name:{label:"i18n:builder.options.name",render:{ui:"ui-input"},default:Editor.Project.name||(0,path_1.basename)(Editor.Project.path),verifyRules:["required"]},polyfills:{label:"i18n:builder.options.polyfills",description:"i18n:builder.options.polyfills_tips",type:"object",hidden:!0,default:{asyncFunctions:!1},itemConfigs:{asyncFunctions:{label:"i18n:builder.options.async_functions",description:"i18n:builder.options.async_functions_tips",render:{ui:"ui-checkbox"}},coreJs:{label:"i18n:builder.options.core_js",description:"i18n:builder.options.core_js_tips",render:{ui:"ui-checkbox"}}}},server:{label:"i18n:builder.options.remote_server_address",description:"i18n:builder.options.remote_server_address_tips",default:"",render:{ui:"ui-input"},verifyRules:["http"]},sourceMaps:{label:"Source Maps",default:!1,render:{ui:"ui-checkbox"}},experimentalEraseModules:{label:"i18n:builder.options.experimental_erase_modules",description:"i18n:builder.options.experimental_erase_modules_tips",default:!1,experiment:!0,render:{ui:"ui-checkbox"}},startSceneAssetBundle:{label:"i18n:builder.options.start_scene_asset_bundle",description:"i18n:builder.options.start_scene_asset_bundle_tips",default:!1,hidden:!0,render:{ui:"ui-checkbox"}},bundleConfigs:{label:"i18n:builder.options.includeBundles",default:[],verifyLevel:"warn"},buildPath:{label:"i18n:builder.options.build_path",default:"project://build",verifyRules:["required"]},debug:{label:"i18n:builder.options.debug",default:!1,render:{ui:"ui-checkbox"}},useBuiltinServer:{label:"i18n:builder.options.use_builtin_server",default:!1,description:"i18n:builder.options.use_builtin_server_tips",hidden:!0,render:{ui:"ui-checkbox"}},md5Cache:{label:"i18n:builder.options.md5_cache",default:!1,render:{ui:"ui-checkbox"}},mainBundleIsRemote:{label:"i18n:builder.options.main_bundle_is_remote",default:!1,render:{ui:"ui-checkbox"}},mainBundleCompressionType:{label:"i18n:builder.options.main_bundle_compression_type",default:"merge_dep"},useSplashScreen:{label:"i18n:builder.use_splash_screen",default:!0,render:{ui:"ui-checkbox"}},bundleCommonChunk:{label:"i18n:builder.bundleCommonChunk",default:!1,render:{ui:"ui-checkbox"}},skipCompressTexture:{label:"i18n:builder.options.skip_compress_texture",default:!1,render:{ui:"ui-checkbox"}},packAutoAtlas:{label:"i18n:builder.options.pack_autoAtlas",default:!0},startScene:{label:"i18n:builder.options.start_scene",default:""},outputName:{description:"构建的输出目录名，将会作为后续构建任务上的名称",default:"",verifyRules:["required","normalName"]},taskName:{default:"",verifyRules:["required"]},scenes:{label:"i18n:builder.options.scenes",default:[]}},exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommonOptions=checkBuildCommonOptions,exports.checkProjectSetting=checkProjectSetting,exports.checkPreferenceSetting=checkPreferenceSetting;