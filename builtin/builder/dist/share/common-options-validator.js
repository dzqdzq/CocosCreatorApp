"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.commonOptionConfigs=exports.overwriteModuleConfig=void 0,exports.checkStartScene=checkStartScene,exports.calcValidOutputName=calcValidOutputName,exports.resolveOutputNameConflict=resolveOutputNameConflict,exports.checkConflict=checkConflict,exports.generateNewOutputName=generateNewOutputName,exports.checkBuildPathIsInvalid=checkBuildPathIsInvalid,exports.getCommonOptions=getCommonOptions,exports.getCommonOptionDefaultByKey=getCommonOptionDefaultByKey,exports.checkBuildCommonOptionsByKey=checkBuildCommonOptionsByKey,exports.checkBuildCommonOptions=checkBuildCommonOptions,exports.checkProjectSetting=checkProjectSetting,exports.handleOverwriteProjectSettings=handleOverwriteProjectSettings,exports.checkPreferenceSetting=checkPreferenceSetting;const path_1=require("path"),bundle_utils_1=require("./bundle-utils"),platforms_options_1=require("./platforms-options"),validator_1=require("./validator"),validator_manager_1=require("./validator-manager"),platforms_options_2=require("./platforms-options"),utils_1=require("./utils");function supportPlatform(e){return e&&!!platforms_options_1.builtinPlugins.includes(e)}async function checkScenes(e){var i;return Array.isArray(e)&&e.length?(i=e.filter(e=>e&&e.uuid)).length!==e.length?new Error(Editor.I18n.t("builder.error.missingScenes")):!!await Editor.Message.request("asset-db","query-ready")&&(-1===(e=(await Editor.Message.request("asset-db","batch-message-handler",i.map(e=>({name:"query-url",args:[e.uuid]})))).findIndex(e=>!e))||new Error(Editor.I18n.t("builder.error.missingScenes",{url:i[e].url}))):new Error("Scenes is empty")}async function checkStartScene(e){if("string"!=typeof e||!e)return!1;const i=await Editor.Message.request("asset-db","query-url",e);return!!i&&!i.startsWith("db://internal")&&!(await Editor.Message.request("asset-db","query-assets",{isBundle:!0})).find(e=>i.startsWith(e.url+"/"))}async function calcValidOutputName(e,i,t,r){return e&&i?(e=(0,path_1.join)(Editor.UI.__protected__.File.resolveToRaw(e),i),await resolveOutputNameConflict(e=Editor.Utils.File.getName(e),t,r)):""}async function resolveOutputNameConflict(e,i,t){let r=(0,path_1.basename)(e);var n=(await Editor.Message.request("builder","query-tasks-info"))["queue"];const o={};Object.values(n).forEach(e=>{"build"===e.type&&e.options.buildPath&&t&&t===e.id&&(o[e.id]=e)});var n=createBuildPathDict(o),{dir:e,name:s}=(0,path_1.parse)(e);return r=checkConflict(e,s,n)?generateNewOutputName(e,i,n):r}function createBuildPathDict(e){var i={};for(const n in e){var t=e[n],r=Editor.UI.__protected__.File.resolveToRaw(t.options.buildPath);i[r]||(i[r]=[]),i[r].push(t.options.outputName)}return i}function checkConflict(e,i,t){for(const r of t[e]||[])if(i===r)return!0;return!1}function generateNewOutputName(e,i,t){var r;let n=0;for(const o of t[e]||[])o.startsWith(i+"-")&&(r=parseInt(o.substring(i.length+1),10),!isNaN(r))&&r>n&&(n=r);return i+"-"+(n+1).toString().padStart(3,"0")}function checkBuildPathIsInvalid(e){if(!e)return!0;if(e.startsWith("project://")){var i=e.match(/^([a-zA-z]*):\/\/(.*)$/);if(i){i=i[2].replace(/\\/g,"/");if((0,path_1.isAbsolute)(i)||i.includes("../")||i.startsWith("/"))return!0}}else if(!(0,path_1.isAbsolute)(e))return!0;return!1}function checkIncludeModules(e){return!!Array.isArray(e)||` includeModules(${e}) should be an array!`}async function getCommonOptions(e,i=!1){const t=JSON.parse(JSON.stringify(await Editor.Profile.getConfig("builder","common","default")));if(!i){const r=await Editor.Profile.getConfig(e,"builder.common",i?"default":void 0);r&&Object.keys(r).forEach(e=>{void 0!==r[e]&&(t[e]=r[e])})}return t.scenes=await getCommonOptionDefaultByKey("scenes"),await checkStartScene(t.startScene)||(t.startScene=await getCommonOptionDefaultByKey("startScene")),t.startScene||console.error(Editor.I18n.t("builder.error.invalidStartScene")),t.packages={},t.platform=e,t.engineModulesConfigKey=await Editor.Profile.getProject("engine","modules.globalConfigKey"),t}async function getCommonOptionDefaultByKey(e,i){switch(e){case"scenes":{var t=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset",pattern:"!db://internal/default_file_content/**/*"});if(!t)return[];const r=await Editor.Message.request("asset-db","query-assets",{isBundle:!0});return t.map(i=>({url:i.url,uuid:i.uuid,bundle:r.find(e=>i.url.startsWith(e.url+"/"))?.url}))}case"startScene":t=(await getCommonOptionDefaultByKey("scenes")).filter(e=>!e.bundle);return t[0]&&t[0].uuid;default:return Editor.Profile.getConfig("builder","common."+e)}}async function checkBuildCommonOptionsByKey(e,i,t){var r={error:"",newValue:i,level:"error"};switch(e){case"scenes":var n=await checkScenes(i)||!1;return n instanceof Error&&(r.error=n.message,r.newValue=await getCommonOptionDefaultByKey("scenes")),r;case"startScene":return await checkStartScene(i)||!1||(r.error="i18n:builder.error.invalidStartScene"),r.error&&(r.newValue=await getCommonOptionDefaultByKey("startScene")),r;case"platform":platforms_options_1.PLATFORMS.includes(i)||(r.error="InValid platform!",r.newValue=null);break;case"mainBundleIsRemote":return i&&t.mainBundleCompressionType===bundle_utils_1.BundleCompressionTypes.SUBPACKAGE?(r.newValue=!1,r.error=" bundle can not be remote when compression type is subpackage!"):i||t.mainBundleCompressionType!==bundle_utils_1.BundleCompressionTypes.ZIP||(r.newValue=!0,r.error=" bundle must be remote when compression type is zip!"),r;case"outputName":i?platforms_options_2.NATIVE_PLATFORM.includes(t.platform)&&checkIncludeChineseAndSymbol(i)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol"):(r.error=" outputName can not be empty",r.newValue=await calcValidOutputName(t.buildPath,t.platform,t.platform));break;case"taskName":i||(r.error=" taskName can not be empty",r.newValue=t.outputName);break;case"buildPath":i&&"project://"!==i?checkBuildPathIsInvalid(i)?(r.error="buildPath is invalid!",r.newValue="project://build"):((i="string"==typeof i&&i.startsWith(".")?"project://"+i:i)&&(0,path_1.isAbsolute)(Editor.UI.__protected__.File.resolveToRaw(i))||(r.error=`buildPath(${i}) is invalid!`,r.newValue="project://build"),platforms_options_2.NATIVE_PLATFORM.includes(t.platform)&&checkIncludeChineseAndSymbol(i)&&(r.error="i18n:builder.error.buildPathContainsChineseAndSymbol")):(r.error=" buildPath can not be empty",r.newValue="project://build");break;case"md5Cache":case"debug":case"useSplashScreen":case"mergeStartScene":case"experimentalEraseModules":case"useBuiltinServer":"boolean"!=typeof i?(r.error=`typeof ${e} should be boolean but get `+i,r.newValue="true"===i||"false"!==i&&await getCommonOptionDefaultByKey(e)):r.newValue=!!i;break;case"sourceMaps":"true"===i?r.newValue=!0:"false"===i&&(r.newValue=!1);break;case"server":t.useBuiltinServer||(r.error=await validator_manager_1.validatorManager.check(i,exports.commonOptionConfigs.server.verifyRules||[],t,t.platform+t.platform));break;default:return null}return r}function checkIncludeChineseAndSymbol(e){return/[`~!#$%^&*+=<>?"{}|,;'·~！#￥%……&*（）+={}|《》？：“”【】、；‘'，。、@\u4e00-\u9fa5]/im.test(e)}async function checkBuildCommonOptions(e){var i=await Editor.Profile.getConfig("builder","common","default"),t={};for(const r of Object.keys(i))t[r]=await checkBuildCommonOptionsByKey(r,e[r],e)||{newValue:e[r],error:"",level:"error"};return t}async function checkProjectSetting(i){i.engineModulesConfigKey||(i.engineModulesConfigKey=await Editor.Profile.getProject("engine","modules.globalConfigKey"));var e={mode:i.preview?"PREVIEW":"BUILD",platform:i.platformType,flags:{}},t=await Editor.Message.request("engine","query-engine-modules-profile",i.engineModulesConfigKey,e);if(i.includeModules){var{includeModules:e,moduleToFallBack:r}=await Editor.Message.request("engine","filter-engine-modules",i.includeModules,e);i.includeModules=e||[],r&&Object.keys(r).length&&(0,utils_1.warnModuleFallBack)(r,i.platform)}else{if(!t)throw new Error(Editor.I18n.t("builder.error.engineModulesConfigKeyMissing",{key:i.engineModulesConfigKey}));i.includeModules=t.includeModules||[],t.moduleToFallBack&&Object.keys(t.moduleToFallBack).length&&(0,utils_1.warnModuleFallBack)(t.moduleToFallBack,i.platform)}if(i.flags)t&&t.flags&&(i.flags=Object.assign(t.flags,i.flags));else{if(!t)throw new Error(Editor.I18n.t("builder.error.engineModulesConfigKeyMissing"));i.flags=t.flags}if(i.designResolution||(i.designResolution=await Editor.Profile.getProject("project","general.designResolution")),i.renderPipeline||(i.renderPipeline=await Editor.Profile.getProject("project","general.renderPipeline")),i.physicsConfig||(e=await Editor.Profile.getProject("project","physics"))&&(i.physicsConfig=e,i.physicsConfig.defaultMaterial||(i.physicsConfig.defaultMaterial="ba21476f-2866-4f81-9c4d-6e359316e448")),i.customLayers||(i.customLayers=await Editor.Profile.getProject("project","layer")||[]),i.sortingLayers||(r=await Editor.Profile.getProject("project","sorting-layer")||{},i.sortingLayers=r.layers||[]),i.macroConfig||(i.macroConfig=await Editor.Profile.getProject("engine","macroConfig","project")||{}),i.macroConfig){const n=await Editor.Profile.getProject("engine","macroConfig","default");Object.keys(i.macroConfig).forEach(e=>{void 0!==i.macroConfig[e]&&i.macroConfig[e]!==n[e]||delete i.macroConfig[e]})}t=i.overwriteProjectSettings?.macroConfig?.cleanupImageCache;return t&&"inherit-project-setting"!==t&&(i.macroConfig=i.macroConfig||{},i.macroConfig.CLEANUP_IMAGE_CACHE="on"===t),handleOverwriteProjectSettings(i),i.customPipeline=i.customPipeline||i.includeModules.includes("custom-pipeline"),i}function handleOverwriteProjectSettings(e){var i=e.overwriteProjectSettings?.includeModules;let t=e.includeModules;if(t&&i&&t.length){for(const n in i)if("inherit-project-setting"!==i[n])switch(i[n]){case"on":t.push(n);break;case"off":t=t.filter(e=>e!==n);break;default:if(exports.overwriteModuleConfig[n]){var r=t.findIndex(exports.overwriteModuleConfig[n].match);if(-1===r)return;t.splice(r,1,i[n])}else console.warn("Invalid overwrite config of engine")}e.includeModules=Array.from(new Set(t))}}async function checkPreferenceSetting(e,i=!1){"boolean"==typeof e.useBuildAssetCache&&i||(e.useBuildAssetCache=await Editor.Profile.getConfig("builder","useBuildAssetCache")),"boolean"==typeof e.useBuildEngineCache&&i||(e.useBuildEngineCache=await Editor.Profile.getConfig("builder","useBuildEngineCache")),"boolean"==typeof e.useBuildTextureCompressCache&&i||(e.useBuildTextureCompressCache=await Editor.Profile.getConfig("builder","useBuildTextureCompressCache")),"boolean"==typeof e.useBuildAutoAtlasCache&&i||(e.useBuildAutoAtlasCache=await Editor.Profile.getConfig("builder","useBuildAutoAtlasCache"))}exports.overwriteModuleConfig={physics:{match:e=>e.startsWith("physics-")&&!e.startsWith("physics-2d"),default:"inherit-project-setting"},"physics-2d":{match:e=>e.startsWith("physics-2d-"),default:"inherit-project-setting"}},validator_1.Validator.addRule("supportPlatform",{func:supportPlatform,message:"i18n:builder.error.unknown_platform"}),exports.commonOptionConfigs={platform:{label:"i18n:builder.options.platform",default:"web-desktop",verifyRules:["required","supportPlatform"]},name:{label:"i18n:builder.options.name",render:{ui:"ui-input",attributes:{placeholder:"i18n:builder.tips.enter_name"}},default:Editor.Project.name||(0,path_1.basename)(Editor.Project.path),verifyRules:["required"]},polyfills:{label:"i18n:builder.options.polyfills",description:"i18n:builder.options.polyfills_tips",type:"object",hidden:!0,default:{asyncFunctions:!1},itemConfigs:{asyncFunctions:{label:"i18n:builder.options.async_functions",description:"i18n:builder.options.async_functions_tips",render:{ui:"ui-checkbox"}},coreJs:{label:"i18n:builder.options.core_js",description:"i18n:builder.options.core_js_tips",render:{ui:"ui-checkbox"}}}},buildScriptTargets:{label:"i18n:builder.options.buildScriptTargets",description:"i18n:builder.options.buildScriptTargetsTips",hidden:!0,render:{ui:"ui-input",attributes:{placeholder:Editor.I18n.t("builder.example",{example:"> 0.4%"})}}},server:{label:"i18n:builder.options.remote_server_address",description:"i18n:builder.options.remote_server_address_tips",default:"",render:{ui:"ui-input",attributes:{placeholder:"https://resources"}},verifyRules:["http"]},sourceMaps:{label:"i18n:builder.options.sourceMap",default:"false",description:"i18n:builder.options.sourceMapTips",render:{ui:"ui-select-pro",items:[{label:"i18n:builder.off",value:"false"},{label:"i18n:builder.options.sourceMapsInline",value:"inline"},{label:"i18n:builder.options.standaloneSourceMaps",value:"true"}]}},experimentalEraseModules:{label:"i18n:builder.options.experimental_erase_modules",description:"i18n:builder.options.experimental_erase_modules_tips",default:!1,experiment:!0,render:{ui:"ui-checkbox"}},startSceneAssetBundle:{label:"i18n:builder.options.start_scene_asset_bundle",description:"i18n:builder.options.start_scene_asset_bundle_tips",default:!1,hidden:!0,render:{ui:"ui-checkbox"}},bundleConfigs:{label:"i18n:builder.options.includeBundles",default:[],verifyLevel:"warn"},buildPath:{label:"i18n:builder.options.build_path",description:"i18n:builder.tips.build_path",default:"project://build",verifyRules:["required"]},debug:{label:"i18n:builder.options.debug",description:"i18n:builder.options.debugTips",default:!1,render:{ui:"ui-checkbox"}},mangleProperties:{label:"i18n:builder.options.mangleProperties",description:"i18n:builder.options.manglePropertiesTip",default:!1,render:{ui:"ui-checkbox"}},inlineEnum:{label:"i18n:builder.options.inlineEnum",description:"i18n:builder.options.inlineEnumTip",default:!0,render:{ui:"ui-checkbox"}},useBuiltinServer:{label:"i18n:builder.options.use_builtin_server",default:!1,description:"i18n:builder.options.use_builtin_server_tips",hidden:!0,render:{ui:"ui-checkbox"}},md5Cache:{label:"i18n:builder.options.md5_cache",description:"i18n:builder.options.md5CacheTips",default:!1,render:{ui:"ui-checkbox"}},md5CacheOptions:{default:{excludes:[],includes:[],replaceOnly:[],handleTemplateMd5Link:!0}},mainBundleIsRemote:{label:"i18n:builder.options.main_bundle_is_remote",description:"i18n:builder.asset_bundle.remote_bundle_invalid_tooltip",default:!1,render:{ui:"ui-checkbox"}},mainBundleCompressionType:{label:"i18n:builder.options.main_bundle_compression_type",description:"i18n:builder.asset_bundle.compression_type_tooltip",default:"merge_dep"},useSplashScreen:{label:"i18n:builder.use_splash_screen",default:!0,render:{ui:"ui-checkbox"}},bundleCommonChunk:{label:"i18n:builder.bundleCommonChunk",description:"i18n:builder.bundleCommonChunkTips",default:!1,render:{ui:"ui-checkbox"}},skipCompressTexture:{label:"i18n:builder.options.skip_compress_texture",default:!1,render:{ui:"ui-checkbox"}},packAutoAtlas:{label:"i18n:builder.options.pack_autoAtlas",default:!0},startScene:{label:"i18n:builder.options.start_scene",description:"i18n:builder.options.startSceneTips",default:""},outputName:{description:"构建的输出目录名，将会作为后续构建任务上的名称",default:"",verifyRules:["required","normalName"]},taskName:{default:"",verifyRules:["required"]},scenes:{label:"i18n:builder.options.scenes",description:"i18n:builder.tips.build_scenes",default:[]},overwriteProjectSettings:{default:{macroConfig:{cleanupImageCache:"inherit-project-setting"},includeModules:{physics:"inherit-project-setting","physics-2d":"inherit-project-setting","gfx-webgl2":"off"}}},nativeCodeBundleMode:{default:"asmjs"},wasmCompressionMode:{hidden:!0,default:!1},binGroupConfig:{default:{threshold:16,enable:!1},label:"i18n:builder.options.bin_group_config",itemConfigs:{enable:{label:"i18n:builder.options.enable_cconb_group",description:"i18n:builder.options.enable_cconb_group_tips",render:{ui:"ui-checkbox"}}}}};