"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginManagerBase=void 0;const events_1=__importDefault(require("events")),path_1=require("path"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),validator_manager_1=require("../share/validator-manager"),utils_1=require("./utils"),lodash=require("lodash");class PluginManagerBase extends events_1.default{get ready(){return this._ready}constructor(){super(),this.bundleConfigs={},this.commonOptionConfig={},this.pkgOptionConfigs={},this.platformMap={},this.assetHandlerPaths={},this.pkgPriorities={},this.pkgLock={},this.tasks=[],this._ready=!1,this.disablePlatforms=[],this.packageRegisterInfo=new Map,this.listenerMap={};const e={};platforms_options_1.builtinPlugins.forEach(t=>{e[t]={}}),this.pkgOptionConfigs=e,this.customBuildStages=JSON.parse(JSON.stringify(e))}async init(){if(!this._ready){var t=Date.now(),e=Editor.Package.getPackages({enable:!0});const i=await Editor.Profile.getConfig("utils","features");void 0!==i["alipay-mini-game-v2"]&&(i["alipay-mini-game"]=i["alipay-mini-game-v2"],delete i["alipay-mini-game-v2"]),Object.keys(i).filter(t=>{i[t]||this.disablePlatforms.push(t)}),await Promise.all(e.map(async t=>!!(t&&t.info&&t.info.contributions&&t.info.contributions.builder)&&this.register(t))),this.listenerMap.enable=async t=>this.addTask("register",t),this.listenerMap.disable=t=>this.addTask("unregister",t),Editor.Package.__protected__.on("enable",this.listenerMap.enable),Editor.Package.__protected__.on("disable",this.listenerMap.disable),this._ready=!0;e=`Builder PluginManager init: ${Date.now()-t}ms`;Editor.Logger.__protected__.record(e),console.debug(e),this.emit("ready")}}async destroy(){Editor.Package.__protected__.removeListener("enable",this.listenerMap.enable),Editor.Package.__protected__.removeListener("disable",this.listenerMap.disable),this._ready=!1}async addTask(t,e){if(!(e&&e.info&&e.info.contributions&&e.info.contributions.builder))return!1;this.tasks.push({type:t,pkg:e}),await this.step()}async step(){var t,e;this.tasks.length&&(-1===(t=this.tasks.findIndex(t=>!this.pkgLock[t.pkg.name]))?console.debug("nextTaskIndex === -1"):(e=this.tasks[t],this.pkgLock[e.pkg.name]=!0,this.tasks.splice(t,1),await this[e.type](e.pkg),this.pkgLock[e.pkg.name]=!1,await this.step()))}async register(e){if(this.disablePlatforms.includes(e.name))return console.debug(Editor.I18n.t("builder.tips.disablePlatform",{platform:e.name})),!1;var t=Date.now();let i=!1;platforms_options_1.builtinPlugins.includes(e.name)&&(Editor.Utils.Path.contains(Editor.App.path,e.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(e.name))?i=!0:platforms_options_1.builtinPlugins.includes(e.name)&&"number"==typeof this.pkgPriorities[e.name]&&!Editor.App.dev&&console.warn(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:e.name}));try{var o=(0,utils_1.resolveToRaw)(e.info.contributions.builder,e.path);if(!require.resolve(o))return!1;var a=Editor.Module.__protected__.requireFile(o);if(!a.configs)return!1;a.load&&await a.load();var n=a.configs,s={path:e.path,displayName:e.info.title||e.name,name:e.name,buildPath:o,version:e.version};for(const m of Object.keys(n))if(checkRegisterPlatformInfo(this.disablePlatforms,m)){var r=m,l=n[r],p=(l.internal=i,{platform:r,config:l});if("*"===m)for(const c of platforms_options_1.PLATFORMS)checkRegisterPlatformInfo(this.disablePlatforms,m)&&(p.platform=c,await this.internalRegister(p,s));else platforms_options_1.builtinPlugins.includes(r)&&await this.internalRegister(p,s)}this.assetHandlerPaths[e.name]=a.assetHandlers&&(0,utils_1.resolveToRaw)(a.assetHandlers,(0,path_1.dirname)(o)),this.packageRegisterInfo.set(e.name,s)}catch(t){return console.error(t),console.error(e.name+" register panelInfo failed!"),!1}a=`[Build-plugin] register pkg ${e.name}: ${Date.now()-t}ms`;return Editor.Logger.__protected__.record(a),console.debug(a),!0}async unregister(t){try{delete this.pkgPriorities[t.name];var e=Editor.Module.__protected__.requireFile(t.info.contributions.builder,{root:t.path});"function"==typeof e.unload&&await e.unload(),delete this.assetHandlerPaths[t.name],this.packageRegisterInfo.delete(t.name),Editor.Module.__protected__.removeCache((0,path_1.join)(t.path,t.info.contributions.builder))}catch(t){console.error(t)}}async internalRegister(t,e){const{platform:i,config:o}=t;var a=e["name"];if(this.pkgPriorities[a]=o.priority||(platforms_options_1.builtinPlugins.includes(a)?1:0),"object"==typeof o.verifyRuleMap)for(var[n,s]of Object.entries(o.verifyRuleMap))validator_manager_1.validatorManager.addRule(n,s,i+a);if(o.doc&&!o.doc.startsWith("http")&&(o.doc=Editor.Utils.Url.getDocUrl(o.doc)),"object"==typeof o.options&&(this.pkgOptionConfigs[t.platform][e.name]=o.options,Object.keys(o.options).forEach(t=>{(0,utils_1.checkConfigDefault)(o.options[t])})),o.internal){if(o.customBuildStages&&(this.customBuildStages[i][a]=o.customBuildStages),o.commonOptions){this.commonOptionConfig[i]?this.commonOptionConfig[i]=(0,utils_1.defaultMerge)({},this.commonOptionConfig[i],o.commonOptions||{}):this.commonOptionConfig[i]=Object.assign({},lodash.defaultsDeep({},o.commonOptions,JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs))));var r=o.commonOptions;for(const l in r)r[l].verifyRules&&(this.commonOptionConfig[i][l]=Object.assign({},this.commonOptionConfig[i][l],{verifyKey:i+a}))}o.assetBundleConfig&&(this.bundleConfigs[i]=Object.assign(this.bundleConfigs[i]||{},{platformType:o.assetBundleConfig.platformType,supportOptions:{compressionType:o.assetBundleConfig.supportedCompressionTypes}}))}a===i&&o.platformName&&(this.platformMap[i]=o.platformName)}getCommonOptionConfigs(t){return this.commonOptionConfig[t]}getCommonOptionConfigByKey(t,e){e=this.commonOptionConfig[e.platform]&&this.commonOptionConfig[e.platform][t]||{};return common_options_validator_1.commonOptionConfigs[t]&&(t=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs[t])),lodash.defaultsDeep(e,t)),e&&e.verifyRules?e:null}getPackageOptionConfigByKey(t,e,i){return t&&e&&(i=this.pkgOptionConfigs[i.platform][e])?lodash.get(i,t):null}getOptionConfigByKey(t,e){var i,o;return t?(i=t&&t.match(/^options.packages.(([^.]*).*)$/))&&i[2]?([,i,o]=i,this.getPackageOptionConfigByKey(i,o,e)):this.getCommonOptionConfigByKey(t,e):null}async checkCommonOptions(t){var e={};for(const i of Object.keys(t))"packages"!==i&&(e[i]=await this.checkCommonOptionByKey(i,t[i],t));return e}async checkCommonOptionByKey(t,e,i){var o=await(0,common_options_validator_1.checkBuildCommonOptionsByKey)(t,e,i);return o||((o=this.getCommonOptionConfigByKey(t,i))?{error:t=await validator_manager_1.validatorManager.check(e,o.verifyRules,i,this.commonOptionConfig[i.platform]&&(null==(t=this.commonOptionConfig[i.platform][t])?void 0:t.verifyKey)||i.platform+i.platform),newValue:t?o.default:e,level:o.verifyLevel||"error"}:{newValue:e,error:"",level:"error"})}async checkPlatformsInformation(t,e){try{var i,o="build-"+t;return await Editor.Message.request("information","has-dialog",o)?!1:!((i=await Editor.Message.request("information","query-information",o))&&i.data&&i.data.enable&&!i.data[i.data.id].complete)||!e&&await openInformationDialog(o)}catch(t){return console.debug("check platform dialog failed!"),console.log(t),!0}}async checkRemoveSplashInformation(t,e){if(!t)try{var i="removeSplash";if(await Editor.Message.request("information","has-dialog",i))return!1;var o=await Editor.Message.request("information","query-information",i);if(o&&o.data&&o.data.enable&&!o.data[o.data.id].complete)return!e&&await openInformationDialog(i)}catch(t){console.debug("Open remove splash information dialog: ",t)}return!0}}function checkRegisterPlatformInfo(t,e){if(t.includes(e)){let t="debug";return platforms_options_1.builtinPlugins.includes(e)||(t="warn"),console[t](Editor.I18n.t("builder.tips.disableRegisterPlatformInfo",{platform:e})),!1}return!0}async function openInformationDialog(t){try{var e=await Editor.Message.request("information","open-information-dialog",t);if("reject"===e.action||"unusual"===e.action)return!1}catch(t){console.debug(t)}return!0}exports.PluginManagerBase=PluginManagerBase;