"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginManagerBase=void 0;const events_1=__importDefault(require("events")),path_1=require("path"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),validator_manager_1=require("../share/validator-manager"),utils_1=require("./utils"),lodash=require("lodash");class PluginManagerBase extends events_1.default{get ready(){return this._ready}constructor(){super(),this.bundleConfigs={},this.commonOptionConfig={},this.pkgOptionConfigs={},this.platformMap={},this.assetHandlerPaths={},this.pkgPriorities={},this.pkgLock={},this.tasks=[],this._ready=!1,this.disablePlatforms=[],this.packageRegisterInfo=new Map,this.listenerMap={};const t={};platforms_options_1.builtinPlugins.forEach(e=>{t[e]={}}),this.pkgOptionConfigs=t,this.customBuildStages=JSON.parse(JSON.stringify(t))}async init(){if(this._ready)return;const t=Date.now(),e=Editor.Package.getPackages({enable:!0}),o=await Editor.Profile.getConfig("utils","features");void 0!==o["alipay-mini-game-v2"]&&(o["alipay-mini-game"]=o["alipay-mini-game-v2"],delete o["alipay-mini-game-v2"]),Object.keys(o).filter(t=>{o[t]||this.disablePlatforms.push(t)}),await Promise.all(e.map(async t=>!!(t&&t.info&&t.info.contributions&&t.info.contributions.builder)&&await this.register(t))),this.listenerMap.enable=(async t=>this.addTask("register",t)),this.listenerMap.disable=(t=>this.addTask("unregister",t)),Editor.Package.__protected__.on("enable",this.listenerMap.enable),Editor.Package.__protected__.on("disable",this.listenerMap.disable),this._ready=!0;const i=`Builder PluginManager init: ${Date.now()-t}ms`;Editor.Logger.__protected__.record(i),console.debug(i),this.emit("ready")}async destroy(){Editor.Package.__protected__.removeListener("enable",this.listenerMap.enable),Editor.Package.__protected__.removeListener("disable",this.listenerMap.disable),this._ready=!1}async addTask(t,e){if(!(e&&e.info&&e.info.contributions&&e.info.contributions.builder))return!1;this.tasks.push({type:t,pkg:e}),await this.step()}async step(){if(!this.tasks.length)return;const t=this.tasks.findIndex(t=>!this.pkgLock[t.pkg.name]);if(-1===t)return void console.debug("nextTaskIndex === -1");const e=this.tasks[t];this.pkgLock[e.pkg.name]=!0,this.tasks.splice(t,1),await this[e.type](e.pkg),this.pkgLock[e.pkg.name]=!1,await this.step()}async register(t){if(this.disablePlatforms.includes(t.name))return console.debug(Editor.I18n.t("builder.tips.disablePlatform",{platform:t.name})),!1;const e=Date.now();let o=!1;platforms_options_1.builtinPlugins.includes(t.name)&&(Editor.Utils.Path.contains(Editor.App.path,t.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(t.name))?o=!0:platforms_options_1.builtinPlugins.includes(t.name)&&"number"==typeof this.pkgPriorities[t.name]&&!Editor.App.dev&&console.warn(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:t.name}));try{const e=(0,path_1.join)(t.path,t.info.contributions.builder);if(!require.resolve(e))return!1;const i=Editor.Module.__protected__.requireFile(e);if(!i.configs)return!1;i.load&&await i.load();const n=i.configs,s={path:t.path,displayName:t.info.title||t.name,name:t.name,buildPath:e,version:t.version};for(const t of Object.keys(n)){if(!checkRegisterPlatformInfo(this.disablePlatforms,t))continue;const e=t,i=n[e];i.internal=o;const a={platform:e,config:i};if("*"!==t)platforms_options_1.builtinPlugins.includes(e)&&await this.internalRegister(a,s);else for(const e of platforms_options_1.PLATFORMS)checkRegisterPlatformInfo(this.disablePlatforms,t)&&(a.platform=e,await this.internalRegister(a,s))}this.assetHandlerPaths[t.name]=i.assetHandlers&&(0,path_1.join)((0,path_1.dirname)(e),i.assetHandlers),this.packageRegisterInfo.set(t.name,s)}catch(e){return console.error(e),console.error(`${t.name} register panelInfo failed!`),!1}const i=`[Build-plugin] register pkg ${t.name}: ${Date.now()-e}ms`;return Editor.Logger.__protected__.record(i),console.debug(i),!0}async unregister(t){try{delete this.pkgPriorities[t.name];const e=Editor.Module.__protected__.requireFile(t.info.contributions.builder,{root:t.path});"function"==typeof e.unload&&await e.unload(),delete this.assetHandlerPaths[t.name],this.packageRegisterInfo.delete(t.name),Editor.Module.__protected__.removeCache((0,path_1.join)(t.path,t.info.contributions.builder))}catch(t){console.error(t)}}async internalRegister(t,e){const{platform:o,config:i}=t,{name:n}=e;if(this.pkgPriorities[n]=i.priority||(platforms_options_1.builtinPlugins.includes(n)?1:0),"object"==typeof i.verifyRuleMap)for(const[t,e]of Object.entries(i.verifyRuleMap))validator_manager_1.validatorManager.addRule(t,e,o+n);if(i.doc&&!i.doc.startsWith("http")&&(i.doc=Editor.Utils.Url.getDocUrl(i.doc)),"object"==typeof i.options&&(this.pkgOptionConfigs[t.platform][e.name]=i.options,Object.keys(i.options).forEach(t=>{(0,utils_1.checkConfigDefault)(i.options[t])})),i.internal){if(i.customBuildStages&&(this.customBuildStages[o][n]=i.customBuildStages),this.commonOptionConfig[o]?this.commonOptionConfig[o]=(0,utils_1.defaultMerge)({},this.commonOptionConfig[o],i.commonOptions||{}):this.commonOptionConfig[o]=Object.assign({},lodash.defaultsDeep({},i.commonOptions,JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs)))),i.commonOptions){const t=i.commonOptions;for(const e in t)t[e].verifyRules&&(this.commonOptionConfig[o][e]=Object.assign({},this.commonOptionConfig[o][e],{verifyKey:o+n}))}Object.keys(this.commonOptionConfig[o]).forEach(t=>{const e=this.commonOptionConfig[o][t];Editor.Profile.setConfig(n,`builder.common.${t}`,e.default,"default")}),i.assetBundleConfig&&(this.bundleConfigs[o]=Object.assign(this.bundleConfigs[o]||{},{platformType:i.assetBundleConfig.platformType,supportOptions:{compressionType:i.assetBundleConfig.supportedCompressionTypes}}))}n===o&&i.platformName&&(this.platformMap[o]=i.platformName)}getCommonOptionConfigs(t){return this.commonOptionConfig[t]}getCommonOptionConfigByKey(t,e){const o=this.commonOptionConfig[e.platform]&&this.commonOptionConfig[e.platform][t]||{};if(common_options_validator_1.commonOptionConfigs[t]){const e=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs[t]));lodash.defaultsDeep(o,e)}return o&&o.verifyRules?o:null}getPackageOptionConfigByKey(t,e,o){if(!t||!e)return null;const i=this.pkgOptionConfigs[o.platform][e];return i?lodash.get(i,t):null}getOptionConfigByKey(t,e){if(!t)return null;const o=t&&t.match(/^options.packages.(([^.]*).*)$/);if(!o||!o[2])return this.getCommonOptionConfigByKey(t,e);const[,i,n]=o;return this.getPackageOptionConfigByKey(i,n,e)}async checkCommonOptions(t){const e={};for(const o of Object.keys(t))"packages"!==o&&(e[o]=await this.checkCommonOptionByKey(o,t[o],t));return e}async checkCommonOptionByKey(t,e,o){var i;const n=await(0,common_options_validator_1.checkBuildCommonOptionsByKey)(t,e,o);if(n)return n;const s=this.getCommonOptionConfigByKey(t,o);if(!s)return{newValue:e,error:"",level:"error"};const a=await validator_manager_1.validatorManager.check(e,s.verifyRules,o,(null===(i=this.commonOptionConfig[o.platform][t])||void 0===i?void 0:i.verifyKey)||o.platform+o.platform);return{error:a,newValue:a?s.default:e,level:s.verifyLevel||"error"}}async checkPlatformsInformation(t,e){const o=`build-${t}`;if(await Editor.Message.request("information","has-dialog",o))return!1;const i=await Editor.Message.request("information","query-information",o);return!(i&&i.data&&i.data.enable&&!i.data[i.data.id].complete)||!e&&await openInformationDialog(o)}async checkRemoveSplashInformation(t,e){if(t)return!0;try{const t="removeSplash";if(await Editor.Message.request("information","has-dialog",t))return!1;const o=await Editor.Message.request("information","query-information",t);if(o&&o.data&&o.data.enable&&!o.data[o.data.id].complete)return!e&&await openInformationDialog(t)}catch(t){console.debug("Open remove splash information dialog: ",t)}return!0}}function checkRegisterPlatformInfo(t,e){if(t.includes(e)){let t="debug";return platforms_options_1.builtinPlugins.includes(e)||(t="warn"),console[t](Editor.I18n.t("builder.tips.disableRegisterPlatformInfo",{platform:e})),!1}return!0}async function openInformationDialog(t){try{const e=await Editor.Message.request("information","open-information-dialog",t);if("reject"===e.action||"unusual"===e.action)return!1}catch(t){console.debug(t)}return!0}exports.PluginManagerBase=PluginManagerBase;