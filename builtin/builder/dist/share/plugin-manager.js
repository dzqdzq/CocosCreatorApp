"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginManagerBase=void 0;const events_1=__importDefault(require("events")),path_1=require("path"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),validator_manager_1=require("../share/validator-manager"),utils_1=require("./utils"),lodash=require("lodash");class PluginManagerBase extends events_1.default{constructor(){super(),this.bundleConfig={},this.commonOptionConfig={},this.pkgOptionConfigs={},this.pkgPriorities={},this.pkgLock={},this.tasks=[],this._ready=!1,this.packageRegisterInfo=new Map;const t={};platforms_options_1.builtinPlugins.forEach(o=>{t[o]={}}),this.pkgOptionConfigs=t,this.customBuildStages=JSON.parse(JSON.stringify(t))}get ready(){return this._ready}async init(){console.time("pluginManager init");const t=Editor.Package.getPackages({enable:!0});await Promise.all(t.map(async t=>!!(t&&t.info&&t.info.contributions&&t.info.contributions.builder)&&await this.register(t))),Editor.Package.on("enable",async t=>this.addTask("register",t)),Editor.Package.on("disable",t=>this.addTask("unregister",t)),this._ready=!0,console.timeEnd("pluginManager init"),this.emit("ready")}async addTask(t,o){if(!(o&&o.info&&o.info.contributions&&o.info.contributions.builder))return!1;this.tasks.push({type:t,pkg:o}),await this.step()}async step(){if(!this.tasks.length)return;const t=this.tasks.findIndex(t=>!this.pkgLock[t.pkg.name]);if(-1===t)return void console.debug("nextTaskIndex === -1");const o=this.tasks[t];this.pkgLock[o.pkg.name]=!0,this.tasks.splice(t,1),await this[o.type](o.pkg),this.pkgLock[o.pkg.name]=!1,await this.step()}async register(t){console.time(`[Build-plugin] register pkg ${t.name}`);let o=!1;platforms_options_1.builtinPlugins.includes(t.name)&&(Editor.Utils.Path.contains(Editor.App.path,t.path)||Editor.App.dev||platforms_options_1.canOverwritePlugins.includes(t.name))?o=!0:!platforms_options_1.builtinPlugins.includes(t.name)||"number"!=typeof this.pkgPriorities[t.name]&&Editor.App.dev||console.warn(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:t.name}));try{const i=(0,path_1.join)(t.path,t.info.contributions.builder);if(!require.resolve(i))return!1;const e=Editor.Module.requireFile(i);if(!e.configs)return!1;e.load&&await e.load();const n=e.configs,s={path:t.path,displayName:t.info.title||t.name,name:t.name,buildPath:i,version:t.version};for(const t of Object.keys(n)){const i=t,e=n[i];e.internal=o;const a={platform:i,config:e};if("*"!==t)platforms_options_1.builtinPlugins.includes(i)&&this.internalRegister(a,s);else for(const t of platforms_options_1.PLATFORMS)a.platform=t,this.internalRegister(a,s)}this.packageRegisterInfo.set(t.name,s)}catch(o){return console.error(o),console.error(`${t.name} register panelInfo failed!`),!1}return console.timeEnd(`[Build-plugin] register pkg ${t.name}`),!0}async unregister(t){try{delete this.pkgPriorities[t.name];const o=Editor.Module.requireFile(t.info.contributions.builder,{root:t.path});"function"==typeof o.unload&&await o.unload(),this.packageRegisterInfo.delete(t.name),Editor.Module.removeCache((0,path_1.join)(t.path,t.info.contributions.builder))}catch(t){console.error(t)}}internalRegister(t,o){const{platform:i,config:e}=t,{name:n}=o;if(this.pkgPriorities[n]=e.priority||(platforms_options_1.builtinPlugins.includes(n)?1:0),"object"==typeof e.verifyRuleMap)for(const t of Object.keys(e.verifyRuleMap)){const o=e.verifyRuleMap[t];validator_manager_1.validatorManager.addRule(t,o,i+n)}if(e.doc&&!e.doc.startsWith("http")&&(e.doc=Editor.Utils.Url.getDocUrl(e.doc)),"object"==typeof e.options&&(this.pkgOptionConfigs[t.platform][o.name]=e.options,Object.keys(e.options).forEach(t=>{(0,utils_1.checkConfigDefault)(e.options[t])})),n===i&&e.platformName){if(e.commonOptions){const t=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs));this.commonOptionConfig[i]=Object.assign(this.commonOptionConfig[i]||{},lodash.defaultsDeep(e.commonOptions,t))}else this.commonOptionConfig[i]=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs));Object.keys(this.commonOptionConfig[i]).forEach(t=>{const o=this.commonOptionConfig[i][t];Editor.Profile.setConfig(n,`common.${n}`,o.default,"default")}),this.bundleConfig[i]=Object.assign(this.bundleConfig[i]||{},{platformName:e.platformName}),e.assetBundleConfig&&(this.bundleConfig[i]=Object.assign(this.bundleConfig[i],e.assetBundleConfig))}e.internal&&e.customBuildStages&&(this.customBuildStages[i][n]=e.customBuildStages)}getCommonOptionConfigs(t){return this.commonOptionConfig[t]}getCommonOptionConfigByKey(t,o){const i=this.commonOptionConfig[o.platform]&&this.commonOptionConfig[o.platform][t]||{};if(common_options_validator_1.commonOptionConfigs[t]){const o=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs[t]));lodash.defaultsDeep(i,o)}return i&&i.verifyRules?i:null}getPackageOptionConfigByKey(t,o,i){if(!t||!o)return null;const e=this.pkgOptionConfigs[i.platform][o];return e?lodash.get(e,t):null}getOptionConfigByKey(t,o){if(!t)return null;const i=t&&t.match(/^options.packages.(([^.]*).*)$/);if(!i||!i[2])return this.getCommonOptionConfigByKey(t,o);const[,e,n]=i;return this.getPackageOptionConfigByKey(e,n,o)}async checkCommonOptions(t){const o={};for(const i of Object.keys(t))"packages"!==i&&(o[i]=await this.checkCommonOptionByKey(i,t[i],t));return o}async checkCommonOptionByKey(t,o,i){const e=await(0,common_options_validator_1.checkBuildCommonOptionsByKey)(t,o,i);if(e)return e;const n=this.getCommonOptionConfigByKey(t,i);if(!n)return{newValue:o,error:"",level:"error"};const s=await validator_manager_1.validatorManager.check(o,n.verifyRules,i,i.platform+i.platform);return{error:s,newValue:s?n.default:o,level:n.verifyLevel||"error"}}}exports.PluginManagerBase=PluginManagerBase;