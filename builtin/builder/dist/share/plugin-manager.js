"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginManagerBase=void 0;const events_1=__importDefault(require("events")),path_1=require("path"),common_options_validator_1=require("../share/common-options-validator"),platforms_options_1=require("../share/platforms-options"),validator_manager_1=require("../share/validator-manager"),utils_1=require("./utils"),lodash=require("lodash");class PluginManagerBase extends events_1.default{bundleConfigs={};commonOptionConfig={};pkgOptionConfigs={};platformMap={};customBuildStages;assetHandlerPaths={};pkgPriorities={};pkgLock={};tasks=[];_ready=!1;disablePlatforms=[];packageRegisterInfo=new Map;listenerMap={};get ready(){return this._ready}constructor(){super();const t={};platforms_options_1.builtinPlugins.forEach(e=>{t[e]={}}),this.pkgOptionConfigs=t,this.customBuildStages=JSON.parse(JSON.stringify(t))}async init(){if(!this._ready){var e=Date.now(),t=Editor.Package.getPackages({enable:!0});const o=await Editor.Profile.getConfig("utils","features");void 0!==o["alipay-mini-game-v2"]&&(o["alipay-mini-game"]=o["alipay-mini-game-v2"],delete o["alipay-mini-game-v2"]),Object.keys(o).filter(e=>{o[e]||this.disablePlatforms.push(e)}),await Promise.all(t.map(async e=>!!(e&&e.info&&e.info.contributions&&e.info.contributions.builder)&&this.register(e))),this.listenerMap.enable=async e=>this.addTask("register",e),this.listenerMap.disable=e=>this.addTask("unregister",e),Editor.Package.__protected__.on("enable",this.listenerMap.enable),Editor.Package.__protected__.on("disable",this.listenerMap.disable),this._ready=!0;t=`Builder PluginManager init: ${Date.now()-e}ms`;Editor.Logger.__protected__.record(t),console.debug(t),this.emit("ready")}}async destroy(){Editor.Package.__protected__.removeListener("enable",this.listenerMap.enable),Editor.Package.__protected__.removeListener("disable",this.listenerMap.disable),this._ready=!1}async addTask(e,t){if(!(t&&t.info&&t.info.contributions&&t.info.contributions.builder))return!1;this.tasks.push({type:e,pkg:t}),await this.step()}async step(){var e,t;this.tasks.length&&(-1===(e=this.tasks.findIndex(e=>!this.pkgLock[e.pkg.name]))?console.debug("nextTaskIndex === -1"):(t=this.tasks[e],this.pkgLock[t.pkg.name]=!0,this.tasks.splice(e,1),await this[t.type](t.pkg),this.pkgLock[t.pkg.name]=!1,await this.step()))}async register(t){if(this.disablePlatforms.includes(t.name))return console.debug(Editor.I18n.t("builder.tips.disablePlatform",{platform:t.name})),!1;var e=Date.now();let o=!1;platforms_options_1.builtinPlugins.includes(t.name)&&(Editor.Utils.Path.contains(Editor.App.path,t.path)||platforms_options_1.canOverwritePlugins.includes(t.name))?o=!0:platforms_options_1.builtinPlugins.includes(t.name)&&"number"==typeof this.pkgPriorities[t.name]&&!Editor.App.dev&&console.warn(Editor.I18n.t("builder.tips.conflict_platform",{pkgName:t.name}));try{var i=(0,utils_1.resolveToRaw)(t.info.contributions.builder,t.path);if(!require.resolve(i))return!1;var a=Editor.Module.__protected__.requireFile(i);if(!a.configs)return!1;a.load&&await a.load();var n=a.configs,s={path:t.path,displayName:t.info.title||t.name,name:t.name,buildPath:i,version:t.version};for(const m of Object.keys(n))if(checkRegisterPlatformInfo(this.disablePlatforms,m)){var r=m,l=n[r],p=(l.internal=o,{platform:r,config:l});if("*"===m)for(const c of platforms_options_1.PLATFORMS)checkRegisterPlatformInfo(this.disablePlatforms,m)&&(p.platform=c,await this.internalRegister(p,s));else platforms_options_1.builtinPlugins.includes(r)&&await this.internalRegister(p,s)}this.assetHandlerPaths[t.name]=a.assetHandlers&&(0,utils_1.resolveToRaw)(a.assetHandlers,(0,path_1.dirname)(i)),this.packageRegisterInfo.set(t.name,s)}catch(e){return console.error(e),console.error(t.name+" register panelInfo failed!"),!1}a=`[Build-plugin] register pkg ${t.name}: ${Date.now()-e}ms`;return Editor.Logger.__protected__.record(a),console.debug(a),!0}async unregister(e){try{delete this.pkgPriorities[e.name];var t=Editor.Module.__protected__.requireFile(e.info.contributions.builder,{root:e.path});"function"==typeof t.unload&&await t.unload(),delete this.assetHandlerPaths[e.name],this.packageRegisterInfo.delete(e.name),Editor.Module.__protected__.removeCache((0,path_1.join)(e.path,e.info.contributions.builder))}catch(e){console.error(e)}}async internalRegister(e,t){const{platform:o,config:i}=e;var a=t["name"];if(this.pkgPriorities[a]=i.priority||(platforms_options_1.builtinPlugins.includes(a)?1:0),"object"==typeof i.verifyRuleMap)for(var[n,s]of Object.entries(i.verifyRuleMap))validator_manager_1.validatorManager.addRule(n,s,o+a);if(i.doc&&!i.doc.startsWith("http")&&(i.doc=Editor.Utils.Url.getDocUrl(i.doc)),"object"==typeof i.options&&(this.pkgOptionConfigs[e.platform][t.name]=i.options,Object.keys(i.options).forEach(e=>{(0,utils_1.checkConfigDefault)(i.options[e])})),i.internal){if(i.customBuildStages&&(this.customBuildStages[o][a]=i.customBuildStages),i.commonOptions){this.commonOptionConfig[o]?this.commonOptionConfig[o]=(0,utils_1.defaultMerge)({},this.commonOptionConfig[o],i.commonOptions||{}):this.commonOptionConfig[o]=Object.assign({},lodash.defaultsDeep({},i.commonOptions,JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs))));var r=i.commonOptions;for(const l in r)r[l].verifyRules&&(this.commonOptionConfig[o][l]=Object.assign({},this.commonOptionConfig[o][l],{verifyKey:o+a}))}i.assetBundleConfig&&(this.bundleConfigs[o]=Object.assign(this.bundleConfigs[o]||{},{platformType:i.assetBundleConfig.platformType,supportOptions:{compressionType:i.assetBundleConfig.supportedCompressionTypes}}))}a===o&&i.platformName&&(this.platformMap[o]=i.platformName)}getCommonOptionConfigs(e){return this.commonOptionConfig[e]}getCommonOptionConfigByKey(e,t){t=this.commonOptionConfig[t.platform]&&this.commonOptionConfig[t.platform][e]||{};return common_options_validator_1.commonOptionConfigs[e]&&(e=JSON.parse(JSON.stringify(common_options_validator_1.commonOptionConfigs[e])),lodash.defaultsDeep(t,e)),t&&t.verifyRules?t:null}getPackageOptionConfigByKey(e,t,o){return e&&t&&(o=this.pkgOptionConfigs[o.platform][t])?lodash.get(o,e):null}getOptionConfigByKey(e,t){var o,i;return e?(o=e&&e.match(/^options.packages.(([^.]*).*)$/))&&o[2]?([,o,i]=o,this.getPackageOptionConfigByKey(o,i,t)):this.getCommonOptionConfigByKey(e,t):null}async checkCommonOptions(e){var t={};for(const o of Object.keys(e))"packages"!==o&&(t[o]=await this.checkCommonOptionByKey(o,e[o],e));return t}async checkCommonOptionByKey(e,t,o){var i=await(0,common_options_validator_1.checkBuildCommonOptionsByKey)(e,t,o);return i||((i=this.getCommonOptionConfigByKey(e,o))?{error:e=await validator_manager_1.validatorManager.check(t,i.verifyRules,o,this.commonOptionConfig[o.platform]&&this.commonOptionConfig[o.platform][e]?.verifyKey||o.platform+o.platform),newValue:e?i.default:t,level:i.verifyLevel||"error"}:{newValue:t,error:"",level:"error"})}async checkPlatformsInformation(e,t){try{var o,i="build-"+e;return await Editor.Message.request("information","has-dialog",i)?!1:!((o=await Editor.Message.request("information","query-information",i))&&o.data&&o.data.enable&&!o.data[o.data.id].complete)||!t&&await openInformationDialog(i)}catch(e){return console.debug("check platform dialog failed!"),console.log(e),!0}}async checkRemoveSplashInformation(e,t){if(!e)try{var o="removeSplash";if(await Editor.Message.request("information","has-dialog",o))return!1;var i=await Editor.Message.request("information","query-information",o);if(i&&i.data&&i.data.enable&&!i.data[i.data.id].complete)return!t&&await openInformationDialog(o)}catch(e){console.debug("Open remove splash information dialog: ",e)}return!0}}function checkRegisterPlatformInfo(e,t){if(e.includes(t)){let e="debug";return platforms_options_1.builtinPlugins.includes(t)||(e="warn"),console[e](Editor.I18n.t("builder.tips.disableRegisterPlatformInfo",{platform:t})),!1}return!0}async function openInformationDialog(e){try{var t=await Editor.Message.request("information","open-information-dialog",e);if("reject"===t.action||"unusual"===t.action)return!1}catch(e){console.debug(e)}return!0}exports.PluginManagerBase=PluginManagerBase;