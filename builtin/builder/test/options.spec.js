const{expect:expect}=require("chai"),{readJSONSync:readJSONSync,existsSync:existsSync,readFileSync:readFileSync,copyFileSync:copyFileSync,emptyDirSync:emptyDirSync,ensureDirSync:ensureDirSync}=require("fs-extra"),{join:join,relative:relative,dirname:dirname,extname:extname}=require("path");function loadScript(e){return new Promise((t,s)=>{const i=document.createElement("script");i.src=join(e,"src","settings.js"),document.body.append(i),i.onload=(e=>{t(!0)})})}function isCompressAndExist(e){if(!existsSync(e))return!1;const t=existsSync(e,"utf-8");return!/\r\n/.test(t)}describe("不同构建参数构建效果测试，请在空项目下测试避免干扰，测试过程会自动创建需要的测试资源",async()=>{const e=require("globby"),t=join(Editor.App.path,"builtin/builder/test/assets/build-test-case");(await e(join(t,"/**/*.meta"),{nodir:!0})).forEach(e=>{const s=join(Editor.Project.path,"assets",relative(t,e));ensureDirSync(dirname(s)),copyFileSync(e,s)});const s=await e(join(t,"/**/*"),{nodir:!0});console.log(s),await Promise.all(s.map(e=>{if(console.log(e),".meta"===extname(e))return;const s="db://assets/"+relative(t,e);return Editor.Message.request("asset-db","create-asset",s,readFileSync(e),{overwrite:!0}).uuid})),emptyDirSync(join(Editor.Project.path,"assets")),describe("测试 web-desktop 非调试模式 960 X 640 sourcemaps compressTexture md5 + options 指定项目设置",async()=>{this.timeout&&this.timeout(6e5);const e=readJSONSync(join(__dirname,"./build-config/buildConfig_web-desktop.json"));await Editor.Message.request("builder","add-task",e.outputName,e,!0);const t=join(Editor.Project.path,e.buildPath,e.outputName),s=join(t,`cocos${Editor.Project.type}-js.min.js`),i=join(t,"src","project.js");it("包体正常生成",()=>{expect(existsSync(t)).to.be.ok}),it("正常生成 settings",()=>{expect(existsSync(join(t,"src","settings.js"))).to.be.true}),it("settings 能正常加载",async()=>{await loadScript(t),expect(_CCSettings).to.be.ok}),describe("settings 数据生成效果测试",()=>{it("debug 与 options 一致",()=>{expect(_CCSettings&&_CCSettings.debug===e.debug).to.be.true}),it("launchScene 与 options 内数据一致",()=>{let t;for(const s of e.scenes)if(s.uuid===e.startScene){t=s.url;break}expect(_CCSettings.launchScene===t).to.be.true}),it("designResolution 与 options 内数据一致",()=>{expect(_CCSettings.designResolution.width).to.be.equal(e.designResolution.width),expect(_CCSettings.designResolution.height).to.be.equal(e.designResolution.height)})}),describe("非调试模式效果测试",()=>{it("settings 文件正常压缩生成",()=>{expect(isCompressAndExist(join(t,"src","settings.js"))).to.be.true}),it("引擎文件正常压缩生成",()=>{expect(isCompressAndExist(s)).to.be.true}),it("project 文件正常压缩生成",()=>{expect(isCompressAndExist(i)).to.be.true})}),describe("sourcemaps 效果测试",()=>{it("引擎文件对应 map 文件正常生成",()=>{expect(existsSync(s+".map")).to.be.true}),it("project 对应 map 文件正常生成",()=>{expect(existsSync(i+".map")).to.be.true})}),describe("MD5 效果测试",()=>{it("settings 内生成了对应的 md5AssetsMap",()=>{expect(_CCSettings.md5AssetsMap&&Object.keys(_CCSettings.md5AssetsMap).length>0).to.be.true})})}),describe("测试 web-mobile 调试模式 项目设置 orientation vconsole packAutoAtlas",async()=>{}),describe("测试 wechatgame 非调试模式 模块设置 orientation packAutoAtlas subPackage",async()=>{})});