"use strict";const{expect:expect}=require("chai"),{existsSync:existsSync}=require("fs-extra"),{join:join}=require("path"),{removeSync:removeSync,readJSONSync:readJSONSync}=require("fs-extra"),migrationConfigBase=join(__dirname,"migration"),{migrateBuilderProfile:migrateBuilderProfile}=require("../dist/browser/migration/index"),{builtinPlugins:builtinPlugins}=require("../dist/config/platforms-options");function delay(e){return new Promise(i=>{setTimeout(i,e)})}describe("构建数据迁移测试",async()=>{const e=await Editor.Profile.getConfig("builder","","local");describe("0 -> 1.2.1 版本数据迁移测试",async()=>{const e=readJSONSync(join(migrationConfigBase,"0.0.0","builder.json"));await Editor.Profile.setConfig("builder","",e,"local"),await migrateBuilderProfile("1.2.1");const i=await Editor.Profile.getConfig("builder","");it("version.builder === 1.2.1",()=>{expect(i.version.builder).to.equal("1.2.1")});const{migrationOptions_1_2_1:t}=require("../dist/browser/migration/version/1.2.1");for(let e of builtinPlugins){let i=await Editor.Profile.getConfig("builder",`${e}.${e}`,"default");await t(i,e,e),e="huawei-quick-game"===e?"huawei-mini-game":e;const a=await Editor.Profile.getConfig("builder",`${e}.${e}`,"local");it(`${e} 配置数据修改成功`,()=>{expect(a).to.exist});const o=await Editor.Profile.getConfig("builder",`version.${e}`,"local");it("平台数据迁移版本号写入成功",()=>{expect(o).to.equal("1.2.1")})}(await Editor.Profile.getConfig("builder","BuildTaskManager.queue","local")).forEach(e=>{const{platform:i}=e.options;it(`${i} 构建任务 packages 数据迁移`,()=>{expect(e.options.packages[i]).to.be.exist})})}),describe("1.2.1 -> 1.2.2 版本数据迁移测试",async()=>{const e=readJSONSync(join(migrationConfigBase,"1.2.1","builder.json"));await Editor.Profile.setConfig("builder","",e,"local"),await migrateBuilderProfile();const i=await Editor.Profile.getConfig("builder","");it("BuildTaskManager.queue -> BuildTaskManager.taskMap",()=>{expect(i.BuildTaskManager.queue).not.exist,expect(i.BuildTaskManager.taskMap).exist}),it("common.taskName -> common.outPutName",()=>{expect(i.common.taskName).not.exist,expect(i.common.outputName).to.exist}),it("common.platform = huawei-mini-game 迁移",()=>{expect(i.common.platform).to.equal("huawei-quick-game")}),it("version.huawei-mini-game 迁移",()=>{expect(i.version["huawei-mini-game"]).not.exist,expect(i.version["huawei-quick-game"]).exist}),it("huawei-mini-game 配置迁移",()=>{expect(i["huawei-quick-game"]["huawei-quick-game"]).exist,expect(i["huawei-mini-game"]).not.exist}),Object.values(e=>{expect("huawei-mini-game"!==e.options.platform).not.exist,expect(e.packages["huawei-mini-game"]).not.exist})}),after(async()=>{await Editor.Profile.setConfig("builder","",e,"local")})}),describe("命令行构建参数兼容测试",()=>{});