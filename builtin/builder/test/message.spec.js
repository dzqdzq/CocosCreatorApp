"use strict";const{expect:expect}=require("chai"),{existsSync:existsSync}=require("fs-extra"),{join:join}=require("path"),{renameSync:renameSync}=require("fs"),{removeSync:removeSync}=require("fs-extra");describe("构建消息测试",()=>{describe("generate-preview-setting",async()=>{const e=await Editor.Message.request("builder","generate-preview-setting",{debug:!0,platform:"web-desktop",physics:"physics-cannon",startScene:"current_scene"});it("正确生成 settings",()=>{expect(e.settings).to.be.not.undefined}),it("正确生成 script2library",()=>{expect(e.script2library).to.be.not.undefined})}),describe("create-build-template",()=>{let e="",t=join(Editor.Project.path,"build-templates");before(()=>{existsSync(t)&&(e=join(Editor.Project.path,"build-templates-temp"),renameSync(t,e))}),it("添加 web-mobile 平台模板",async()=>{await Editor.Message.request("builder","create-build-template","web-mobile"),expect(existsSync(join(Editor.Project.path,"build-templates","web-mobile","index.ejs")))}),it("添加 web-desktop 平台模板",async()=>{await Editor.Message.request("builder","create-build-template","web-desktop"),expect(existsSync(join(Editor.Project.path,"build-templates","web-desktop","index.ejs")))}),it("添加 wechatgame 平台模板",async()=>{await Editor.Message.request("builder","create-build-template","wechatgame"),expect(existsSync(join(Editor.Project.path,"build-templates","wechatgame","game.ejs")))}),after(()=>{removeSync(t),e&&renameSync(e,t)})}),describe("command-build 测试",()=>{const e=join(Editor.Project.path,"buildTest");let t;before(()=>{existsSync(e)&&(t=join(Editor.Project.path,"buildTest-temp"),renameSync(e,t))});const i=["wechatgame","web-desktop","web-mobile"];for(const t of i){const i={platform:t,outputName:`test-${t}`,buildPath:"./buildTest"},s=join(e,i.outputName);describe(`${t}命令行构建`,()=>{it(`${t}构建过程正常无报错`,async function(){let e;this.timeout&&this.timeout(6e4);try{const t=await Editor.Message.request("builder","command-build",i);t&&(e=t)}catch(e){e=e}expect(e).to.be.undefined,expect(existsSync(s)).to.be.true}),it("正确移除任务",async()=>{const e=await Editor.Message.request("builder","remove-task",`test-${t}`,!0);expect(e).to.be.true,expect(existsSync(s)).to.be.not.ok})})}after(()=>{removeSync(e),t&&renameSync(t,e)})})});