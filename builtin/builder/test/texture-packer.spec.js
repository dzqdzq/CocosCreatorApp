const{expect:expect}=require("chai"),{join:join}=require("path"),{ensureDirSync:ensureDirSync,copyFileSync:copyFileSync,emptyDirSync:emptyDirSync,existsSync:existsSync,removeSync:removeSync,readFileSync:readFileSync}=require("fs-extra");describe("自动图集功能测试",()=>{const e=["test.pac","61.png","512.png","back120.jpg","bottom120texture.jpg"],t=join(Editor.Project.path,"assets","resources","atlasTest"),s=join(__dirname,"./assets","texture-packer"),a="fdfe5b67-dc7e-42d1-8162-fc99c7a96fc2",c=join(Editor.Project.path,"temp","TexturePacker","preview",a);before(async()=>{emptyDirSync(t),removeSync(c),e.forEach(e=>{copyFileSync(join(s,e+".meta"),join(t,e+".meta"))});for(const t of e){const e="db://assets/resources/atlasTest/"+t,a=join(s,t);await Editor.Message.request("asset-db","create-asset",e,readFileSync(a),{overwrite:!0})||console.error("create-asset failed!")}}),it("初始查询自动图集信息为空",async()=>{const e=await Editor.Message.request("builder","query-atlas-files",a);expect(e).to.be.not.ok}),describe("自动图集合图生成与预览接口测试",async()=>{const e=await Editor.Message.request("builder","preview-pac",a);it("正常返回值",async()=>{expect(e).to.be.ok}),it("合图正常生成",async()=>{expect(existsSync(e.atlasImagePaths[0])).to.be.true}),it("pac-info 文件正常生成",async()=>{expect(existsSync(join(c,"pac-info.json"))).to.be.true}),it("查询自动图集信息不为空",async()=>{const e=await Editor.Message.request("builder","query-atlas-files",a);expect(e).to.be.ok}),it("首次预览 dirty 状态是 true",async()=>{expect(e.dirty).to.be.true}),it("unpackedImages 数据长度为 1",async()=>{expect(e.unpackedImages.length).to.be.equal(1)}),it("atlasImagePaths 数据长度为 1",async()=>{expect(e.atlasImagePaths.length).to.be.equal(1)}),after(()=>{removeSync(c)})}),after(()=>{removeSync(t)})});