"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.phone=void 0;const adbKit=require("adbkit"),path=__importStar(require("path")),base_1=require("./base"),log_1=require("./log");let ANDROID_SDK_PATH;class Phone extends base_1.Base{constructor(){super(),this.list=[]}init(t){return Promise.resolve().then(async()=>{if(!(ANDROID_SDK_PATH=t)){let t=Editor.I18n.t("runtime-dev-tools.android_sdk_error");return console.error(t),void log_1.log.error(t)}this.adb=adbKit.createClient({bin:this.adbPath,port:process.env.ANDROID_ADB_SERVER_PORT||5037}),await this._initTracker()}).catch(t=>{log_1.log.error(t)})}get adbPath(){return path.join(ANDROID_SDK_PATH,"platform-tools","adb")}async install(t,e){try{await this.adb.install(t,e)}catch(t){}}async shell(t,e){try{return log_1.log.debug("exec shell command =>",e),await this.adb.shell(t,e).then(adbKit.util.readAll).then(t=>t.toString("utf-8").trim())}catch(t){log_1.log.error(t)}}async push(t,e,i){try{return this.adb.push(t,e,i)}catch(t){log_1.log.error(t)}}async _initTracker(){try{let t=await this.adb.trackDevices();t.on("add",async t=>{setTimeout(async()=>{await this._addPhone(t)},500)}),t.on("remove",t=>{this._removePhone(t),setTimeout(()=>{this.emit("remove_device",t.id)},500)}),t.on("end",()=>{})}catch(t){log_1.log.error(t)}}async getPhoneList(){try{let t=await this.adb.listDevices();for(let e=0;e<t.length;e++)await this._addPhone(t[e]);return this.currentPhone=t[0],this.list}catch(t){log_1.log.error(t)}}async getDeviceName(t){let e=await this.shell(t,"getprop ro.product.model");return e||log_1.log.warn("获取不到设备型号"),e}async getDeviceManufacturer(t){let e=await this.shell(t,"getprop ro.product.brand");return e||log_1.log.warn("获取不到设备制造商"),e}async isInstalled(t,e){try{return await this.adb.isInstalled(t,e)}catch(t){log_1.log.error(t)}}async _addPhone(t){this.list.find(e=>e.id===t.id)||(t.name=await this.getDeviceName(t.id),t.cp=await this.getDeviceManufacturer(t.id),this.list.push(t),1===this.list.length&&(this.currentPhone=this.list[0]),this.emit("add_device",t.id))}_removePhone(t){let e=this.list.find(e=>e.id===t.id);e&&(this.list.splice(this.list.indexOf(e),1),-1===this.list.indexOf(this.currentPhone)&&(this.currentPhone=null))}}exports.phone=new Phone;