"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs-extra"),path=require("path"),{spawn:spawn}=require("child_process"),network=require("./network"),pkg=require("../../../../package.json"),phone_1=require("../../../utils/phone"),log_1=require("../../../utils/log"),info_1=require("../../../utils/info"),base_1=require("../../../utils/base"),RUNTIME_DOWNLOAD_PATH=path.join(Editor.App.home,"download/runtime/huawei/"),RUNTIME_REQUEST_URL="https://deveco.huawei.com/FastIDE/update/api/update/engineVersion/",RUNTIME_RPK_PATH="/data/local/tmp/",RUNTIME_PACKAGE_NAME="com.huawei.fastapp.dev";var RUNTIME_STATE;function t(...e){return Editor.I18n.t(...e)}!function(e){e[e.free=0]="free",e[e.downloading=1]="downloading",e[e.installing=2]="installing",e[e.pushing=3]="pushing",e[e.launching=4]="launching"}(RUNTIME_STATE||(RUNTIME_STATE={}));const _compareVersion=function(e,t){let n=!1;const o=e.split("."),i=t.split(".");for(let e=0;e<o.length;e++){let t=o[e],s=i[e];if(e===o.length-1){let r=!1,a=!1;if(o[e].split("_").length>1&&(t=o[e].split("_")[0],r=!0),i[e]&&i[e].split("_").length>1&&(s=i[e].split("_")[0],a=!0),t===s){n=!r&&a;break}}if(t>s){n=!0;break}if(t<s){n=!1;break}}return n};class huawei extends base_1.Base{constructor(){super(),this.RUNTIME_STATE=RUNTIME_STATE,this.state=RUNTIME_STATE.free,this.logList={},this.runtimeApkPath="",this.runtimeVersion=""}async getRpkPath(){return phone_1.phone.options&&phone_1.phone.options.rpkPath||""}requestRuntimeVersion(){return info_1.info.log(t("runtime-dev-tools.check_runtime_version")),network.get(RUNTIME_REQUEST_URL).then(e=>(e=e.toString(),JSON.parse(e))).catch(e=>{console.error("requestRuntimeVersion error",e)})}async checkRuntimeVersion(){const e=await this.requestRuntimeVersion(),n=e.url.split("/"),o=n[n.length-1];this.runtimeVersion=e.version,log_1.log.debug(t("runtime-dev-tools.latest_runtime_version",{version:e.version}));const i=path.join(RUNTIME_DOWNLOAD_PATH,o);fs.existsSync(i)||(info_1.info.log(t("runtime-dev-tools.runtime_not_exists",{version:e})),fs.ensureDirSync(RUNTIME_DOWNLOAD_PATH),this._downloadRuntimeApk(e.url,i)),this.runtimeApkPath=i}_downloadRuntimeApk(e,n){this.state=RUNTIME_STATE.downloading,network.download(e,n,e=>{info_1.info.log(t("runtime-dev-tools.runtime_downloading",{progress:100*e.toFixed(2)}))},e=>{this.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.download_finish"))})}async checkPhoneRuntimeVersion(){if(!this._checkPhoneConnect())return;let e=await phone_1.phone.shell(phone_1.phone.currentPhone.id,`dumpsys package ${RUNTIME_PACKAGE_NAME} | grep versionName`);if(!((e=e.split("=")).length<=0))return e=e[1],log_1.log.debug(t("runtime-dev-tools.now_runtime_version",{version:e})),this.compareRuntime(e);info_1.info.warn(t("runtime-dev-tools.can_not_find_runtime"))}compareRuntime(e){return _compareVersion(this.runtimeVersion,e)}async isRuntimeInstalled(){if(this._checkPhoneConnect())return await phone_1.phone.isInstalled(phone_1.phone.currentPhone.id,RUNTIME_PACKAGE_NAME)}async installRuntime(){this.runtimeApkPath?(this.state=RUNTIME_STATE.installing,info_1.info.log(t("runtime-dev-tools.runtime_installing")),await phone_1.phone.install(phone_1.phone.currentPhone.id,this.runtimeApkPath),this.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.runtime_installed"))):info_1.info.error(t("runtime-dev-tools.can_not_find_apk"))}async checkRuntime(){if(this._checkPhoneConnect())if(await this.isRuntimeInstalled())if(info_1.info.log(t("runtime-dev-tools.check_installed_runtime_version")),await this.checkPhoneRuntimeVersion()){0==(await Editor.Dialog.info(t("runtime-dev-tools.dialog_msg"),{title:t("runtime-dev-tools.runtime_update"),buttons:[t("runtime-dev-tools.confirm"),t("runtime-dev-tools.cancel")]})).response?await this.installRuntime():(log_1.log.warn(t("runtime-dev-tools.cancel_runtime_tips")),info_1.info.warn(t("runtime-dev-tools.cancel_runtime_tips")))}else info_1.info.log(t("runtime-dev-tools.check_latest_runtime_version"));else await this.installRuntime()}_checkPhoneConnect(){return!!phone_1.phone.currentPhone||(info_1.info.warn(t("runtime-dev-tools.lose_phone_connect")),!1)}async pushRpkToPhone(e){const n=this;return this._checkPhoneConnect()?(this.state=RUNTIME_STATE.pushing,new Promise(async(o,i)=>{info_1.info.log(t("runtime-dev-tools.begin_push"));const s=RUNTIME_RPK_PATH+path.basename(e),r=fs.statSync(e).size,a=await phone_1.phone.push(phone_1.phone.currentPhone.id,e,s);a.on("progress",function(e){info_1.info.log(t("runtime-dev-tools.runtime_update",{progress:parseInt(100*e.bytesTransferred/r)}))}),a.on("end",function(){o(),n.state=RUNTIME_STATE.free,info_1.info.log(t("runtime-dev-tools.push_finish"))}),a.on("error",e=>{i(),this.state=RUNTIME_STATE.free,info_1.info.error(t("runtime-dev-tools.push_error"))})})):Promise.reject()}async startRuntimeWithRpk(e,n){if(!this._checkPhoneConnect())return;info_1.info.log(t("runtime-dev-tools.start_runtime")),this.state=RUNTIME_STATE.launching;const o=`am start --es rpkpath ${"file://"+RUNTIME_RPK_PATH+e} ${n} --activity-clear-top com.huawei.fastapp.dev/com.huawei.fastapp.app.RpkRunnerActivity`;await phone_1.phone.shell(phone_1.phone.currentPhone.id,o),info_1.info.log(t("runtime-dev-tools.start_runtime_finish")),this.state=RUNTIME_STATE.free}openLogcat(e){setTimeout(()=>{if(!this._checkPhoneConnect())return;const t=spawn(phone_1.phone.adbPath,["-s",e,"shell","logcat","-s","jsLog"]);this.logList[phone_1.phone.currentPhone.id]=t,t.stdout.on("data",e=>{log_1.log.log(e.toString("utf-8"))}),t.on("close",e=>{log_1.log.log(`logcat exit with code: ${e}`);for(const e in this.logList){let n=this.logList[e];(n=t)&&delete this.logList[e]}})},600)}needToCreatLogcat(e){return!this.logList[e]}async stopRuntime(){this._checkPhoneConnect()&&(info_1.info.log(t("runtime-dev-tools.stop_runtime")),await phone_1.phone.shell(phone_1.phone.currentPhone.id," am force-stop com.huawei.fastapp.dev"))}}module.exports=new huawei;