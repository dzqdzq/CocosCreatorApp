"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,r)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.getRightEngine=exports.rebuildImportMaps=exports.rebuild=exports.compileEngine=void 0;const ccbuild_1=require("@cocos/ccbuild"),utils_1=require("@editor/lib-programming/dist/utils"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=require("path");let compiler=null,nativeCompiler=null,engineDir="",busy=!1,outDir="";const editorFeaturesCache=[],VERSION="3";async function compileEngine(e,t){engineDir=e,outDir=(0,path_1.join)(e,"bin",".cache","dev");const i=(0,path_1.join)(outDir,"VERSION");let o=!1;try{await(0,fs_extra_1.readFile)(i,"utf8")!==VERSION&&(o=!0)}catch(e){o=!0}compiler=await generateCompiler();const r=await getIsSceneNative();let n=!1;r&&(nativeCompiler=await generateCompiler({isNative:!0}),n=await getIsDebugNative()),o?(console.debug("[EditorQuickCompiler]Version information lost."),await(0,fs_extra_1.emptyDir)(outDir)):console.debug("[EditorQuickCompiler]Version information looks good."),(o||n||(null===Editor||void 0===Editor?void 0:Editor.App.dev)||t)&&!process.argv.includes("--no-quick-compile")?await rebuild({isNativeScene:r,debugNative:n}):console.debug("Note, quick compiler does not get launched.")}async function generateCompiler(e){const{QuickCompiler:t}=await Promise.resolve().then(()=>__importStar(require("@editor/quick-compiler"))),i=(null===Editor||void 0===Editor?void 0:Editor.Project.tmpDir)?(0,path_1.join)(engineDir,"bin",".cache","logs","log.txt"):void 0;i&&await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(i));const o=["wait-for-ammo-instantiation"],r=(await ccbuild_1.StatsQuery.create(engineDir)).getFeatures(),n=r.filter(e=>!o.includes(e));editorFeaturesCache.push(...n);if(null===e||void 0===e?void 0:e.isNative){const e=(0,path_1.join)(engineDir,"bin/.editor");return new t({rootDir:engineDir,outDir:e,targets:[{featureUnitPrefix:"cce:/internal/x/cc-fu/",dir:e,format:"systemjs",targets:"node 10",loose:!1,includeEditorExports:!0,includeIndex:{features:r},loader:!0}],logFile:i,platform:"NATIVE"})}return new t({rootDir:engineDir,outDir:outDir,targets:[{featureUnitPrefix:"cce:/internal/x/cc-fu/",dir:(0,path_1.join)(outDir,"editor"),format:"systemjs",usedInElectron509:!0,targets:utils_1.editorBrowserslistQuery,includeIndex:{features:n},loader:!0},{featureUnitPrefix:"cce:/internal/x/cc-fu/",dir:(0,path_1.join)(outDir,"preview"),format:"systemjs",loose:!0}],logFile:i})}async function rebuild(e){if(void 0===(null===e||void 0===e?void 0:e.isNativeScene)&&(null!==e&&void 0!==e||(e={}),e.isNativeScene=await getIsSceneNative(),e.isNativeScene&&(e.debugNative=await getIsDebugNative())),!compiler||(null===e||void 0===e?void 0:e.isNativeScene)&&!nativeCompiler)return void await compileEngine(engineDir,!0);if(busy)return void console.error("Compile engine fails: The compilation is in progress");busy=!0,console.log("Start Quick Compile");const t=Date.now();if(!compiler)return busy=!1,void console.error("Compile engine fails: The compiler does not exist.");try{e.isNativeScene&&(await nativeCompiler.build(),await rebuildNativeImportMap(),await generateEngineAddon(e),await updateAdapter()),await compiler.build(),Editor&&await rebuildImportMaps();const i=(0,path_1.join)(outDir,"VERSION");await(0,fs_extra_1.outputFile)(i,VERSION,{encoding:"utf8"})}catch(e){throw e}finally{console.log("Quick Compile: "+(Date.now()-t)+"ms"),busy=!1}}async function rebuildImportMaps(){if(!compiler)return;const e=await getEditorShippedFeatures();await rebuildTargetImportMap(compiler,0,e);const t=await getPreviewShippedFeatures();await rebuildTargetImportMap(compiler,1,t)}async function rebuildNativeImportMap(){const e=await getEditorShippedFeatures();await rebuildTargetImportMap(nativeCompiler,0,e,"NATIVE","EDITOR")}async function rebuildTargetImportMap(e,t,i,o,r,n){const a=await getConfigurableFlagsOfFeatures(i);await e.buildImportMap(t,i,{mode:r,platform:o,out:n,features:i,configurableFlags:a})}async function getEditorShippedFeatures(){return editorFeaturesCache}async function getPreviewShippedFeatures(){return Editor?await Editor.Profile.getProject("engine","modules.includeModules"):[]}async function getConfigurableFlagsOfFeatures(e){const t={};if(Editor){const i=await Editor.Profile.getProject("engine","modules.flags");if(i)for(const[o,r]of Object.entries(i))e.includes(o)&&Object.assign(t,r)}return t}async function generateEngineAddon(e){let t;if(t=Editor?(0,path_1.join)(Editor.App.path,"../resources/3d/editor-native-scene"):(0,path_1.join)(__dirname,"../../../../../../resources/3d/editor-native-scene"),!(0,fs_extra_1.existsSync)(t))return void console.error(`build failed: editor-native-scene not exist,path: ${t}`);const i=(0,path_1.join)(engineDir,"native");if(!(0,fs_extra_1.existsSync)(i))return void console.error(`build failed: native engine not exist,path: ${i}`);const o="arm64"===process.arch;let r;r=Editor?(0,path_1.join)(Editor.App.path,"../tools/cmake/bin"):(0,path_1.join)(engineDir,"../../../tools/cmake/bin");const n=joinPathEx(__dirname,"../node_modules/cmake-js/bin/cmake-js"),a="win32"===process.platform,s=a?(0,path_1.join)(t,"win"):(0,path_1.join)(t,"mac"),c={};Object.assign(c,process.env),Object.keys(c).filter(e=>e.toLowerCase().startsWith("npm_")).forEach(e=>delete c[e]),a?c.Path=process.env.PATH+";"+r:c.PATH=process.env.PATH+":"+r;let l="";try{const t=`--CDCOCOS_DIR=${(0,path_1.join)(engineDir,"../")}`,i=(0,path_1.join)(s,"build"),r=await getIsDebugLastTime();if("win32"!==process.platform){null!==r&&r!==(null===e||void 0===e?void 0:e.debugNative)&&(0,fs_extra_1.existsSync)(i)&&(console.warn("cmake configure change,now will clean build cache"),(0,fs_extra_1.rmdirSync)(i,{recursive:!0})),await setIsDebugLastTime(!!(null===e||void 0===e?void 0:e.debugNative))}const u=[t];a||(u.push("-x"),u.push("-a"),u.push(o?"arm64":"x64")),(null===e||void 0===e?void 0:e.debugNative)&&u.push("-D"),console.time("cmake build");const d=async e=>{await forkModule(n,["configure",...u],{cwd:s,env:c},{async success(t){var i;await(null===(i=null===e||void 0===e?void 0:e.onSuccess)||void 0===i?void 0:i.call(e,t))},async failed(t){var i;try{await(null===(i=null===e||void 0===e?void 0:e.onError)||void 0===i?void 0:i.call(e,t))}catch(e){e instanceof Error&&(l+=e.message+"\n")}}})};let p=!1;const g=e=>{p=!0,console.log("cmake configure success")};if(await d({onSuccess:g,async onError(e){if(l+=e+"\n",console.error(e),!(0,fs_extra_1.existsSync)(i))throw new Error(`cmake configure failed, output path ${i} is not exist `);console.warn("cmake configure error,now will clean build cache and try again"),await(0,fs_extra_1.remove)(i),await d({onSuccess:g,onError(e){console.error(e),l+=e+"\n"}})}}),!p)throw console.warn("cmake configure failed,skip build native scene"),console.timeEnd("cmake build"),l;await forkModule(n,["build",...u],{cwd:s,env:c},{success(){console.timeEnd("cmake build"),console.log("Native engine cmake build succeeded.")},failed(e){console.timeEnd("cmake build"),console.error("Native engine cmake build failed, the reason is",e)}})}catch(e){let t;e instanceof Error?t=l+=e.message+"\n":"string"==typeof e&&(t=e),console.error(t),outputErrorTxt("build-native-scene-error"+getFormat24HourTime(),t)}}async function updateAdapter(){try{let e=!0;const t=(0,path_1.join)(engineDir,"bin/.editor"),i=(0,path_1.join)(engineDir,"bin/adapter/native/web-adapter.js");if((0,fs_extra_1.existsSync)(i)){const e=(0,path_1.join)(t,"web-adapter.js");(0,fs_extra_1.copyFileSync)(i,e)}else e=!1,console.error(`${i} not exist,please build engine first`);const o=(0,path_1.join)(engineDir,"bin/adapter/native/engine-adapter.js");return(0,fs_extra_1.existsSync)(o)?(0,fs_extra_1.copyFileSync)(o,(0,path_1.join)(t,"engine-adapter.js")):(e=!1,console.error(`${o} not exist,please build engine first`)),e?console.log("update adapter success"):console.error("update adapter failed"),Promise.resolve()}catch(e){return Promise.reject(e)}}function getRightEngine(e,t){const i={version:"builtin",path:t};return e.custom&&(0,fs_extra_1.existsSync)(e.custom)?(i.version="custom",i.path=e.custom,i):i}function forkModule(e,t,i,o={}){return new Promise((r,n)=>{var a,s;null!==(a=i.execArgv)&&void 0!==a||(i.execArgv=["--max-old-space-size=8192"]),i.cwd&&(0,fs_extra_1.ensureDirSync)(i.cwd),null!==(s=i.stdio)&&void 0!==s||(i.stdio="pipe");const c=(0,child_process_1.fork)(e,t,i);let l="",u="";c.stdout&&c.stdout.on("data",e=>{l+=e}),c.stderr&&c.stderr.on("data",e=>{u+=e}),c.on("close",async e=>{0===e?o.success&&await o.success(u||l):o.failed&&await o.failed(u||l),r(e)}),c.on("error",e=>{n(e)})})}async function getIsSceneNative(){var e;let t=!0;return Editor&&(t=null!==(e=await Editor.Profile.getConfig("scene","scene.native-engine","global"))&&void 0!==e&&e),t}async function getIsDebugNative(){return!!await(null===Editor||void 0===Editor?void 0:Editor.Profile.getConfig("scene","scene.debug-native"))}async function getIsDebugLastTime(){return await(null===Editor||void 0===Editor?void 0:Editor.Profile.getConfig("engine","is-debug-native"))}async function setIsDebugLastTime(e){return await(null===Editor||void 0===Editor?void 0:Editor.Profile.setConfig("engine","is-debug-native",e,"global"))}function getFormat24HourTime(){const e=new Date,t=e=>e>9?e:`0${e}`,i=t(e.getDate()),o=t(e.getMonth()+1);return`${e.getFullYear()}-${o}-${i}-${t(e.getHours())}-${t(e.getMinutes())}-${t(e.getSeconds())}`}function outputErrorTxt(e,t,i){try{null!==i&&void 0!==i||(i=(null===Editor||void 0===Editor?void 0:Editor.Project.path)?(0,path_1.join)(Editor.Project.path,"temp/crash/"):(0,path_1.join)(engineDir,"bin",".editor","logs"));const o=(0,path_1.join)(i,e+".txt");(0,fs_extra_1.ensureDirSync)(i),(0,fs_extra_1.writeFileSync)(o,t,{encoding:"utf-8"})}catch(e){e instanceof Error&&console.error(`output error failed,reason is ${e.message}`)}}function joinPathEx(e,t){let i=(0,path_1.join)(e,t);return-1!==i.indexOf("app.asar")&&(i=i.replace("app.asar","app.asar.unpacked")).indexOf("app.asar.unpacked")&&!(0,fs_extra_1.existsSync)(i)&&console.trace(`${i} not exist`),i}exports.compileEngine=compileEngine,exports.rebuild=rebuild,exports.rebuildImportMaps=rebuildImportMaps,exports.getRightEngine=getRightEngine,exports.default=__importStar(require("./index"));