"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,n)}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[i.length]=t);return i})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=n(e),r=0;r<i.length;r++)"default"!==i[r]&&__createBinding(t,e,i[r]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,exports.compileEngine=compileEngine,exports.rebuild=rebuild,exports.rebuildImportMaps=rebuildImportMaps,exports.getCCEnvConstants=getCCEnvConstants,exports.getRightEngine=getRightEngine;const ccbuild_1=require("@cocos/ccbuild"),utils_1=require("@editor/lib-programming/dist/utils"),child_process_1=require("child_process"),os_1=__importDefault(require("os")),fs_extra_1=require("fs-extra"),path_1=require("path");let compiler=null,nativeCompiler=null,engineDir="",busy=!1,outDir="",statsQuery=null;const editorFeaturesCache=[],VERSION="3";async function compileEngine(e,t,i){engineDir=e,outDir=(0,path_1.join)(e,"bin",".cache","dev");e=(0,path_1.join)(outDir,"VERSION");let r=!1;try{await(0,fs_extra_1.readFile)(e,"utf8")!==VERSION&&(r=!0)}catch{r=!0}compiler=await generateCompiler();e=i&&i.isNativeScene&&await getIsSceneNative();let n=!1;e&&(nativeCompiler=await generateCompiler({isNative:!0}),n=await getIsDebugNative()),r?(console.debug("[EditorQuickCompiler]Version information lost."),await(0,fs_extra_1.emptyDir)(outDir)):console.debug("[EditorQuickCompiler]Version information looks good."),(r||n||t)&&!process.argv.includes("--no-quick-compile")?await rebuild({isNativeScene:e,debugNative:n}):console.debug("Note, quick compiler does not get launched."),statsQuery=statsQuery||await ccbuild_1.StatsQuery.create(engineDir)}function extractMacros(e){return e.split("||").map(e=>e.trim().substring(1))}function queryEnvLimitModule(e){e=require((0,path_1.join)(e,"editor","engine-features","render-config.json"));const i={},r=(e,t)=>{t.envCondition&&(i[e]={envList:extractMacros(t.envCondition),fallback:t.fallback})};return Object.entries(e.features).forEach(([e,t])=>{e=e,"options"in(t=t)?Object.entries(t.options).forEach(([e,t])=>{r(e,t)}):r(e,t)}),i}async function filterEngineModules(e,t,r){const n=(await ccbuild_1.StatsQuery.create(e)).constantManager.genCCEnvConstants(t),a=queryEnvLimitModule(e),o={};return Object.keys(a).forEach(e=>{var t,i;r.includes(e)&&({envList:t,fallback:i}=a[e],t.some(e=>n[e])||(o[e]=i||"",i?r.splice(r.indexOf(e),1,i):r.splice(r.indexOf(e),1)))}),r}async function generateCompiler(e){var t=(await Promise.resolve().then(()=>__importStar(require("@editor/quick-compiler"))))["QuickCompiler"],i=Editor?.Project.tmpDir?(0,path_1.join)(engineDir,"bin",".cache","logs","log.txt"):void 0;i&&await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(i));let r=(statsQuery=statsQuery||await ccbuild_1.StatsQuery.create(engineDir)).getFeatures();r=r.filter(e=>!e.startsWith("spine-")),Editor&&(a=(((a=await Editor.Profile.getProject("engine","modules"))?.configs[a.globalConfigKey])?.includeModules??[])?.find(e=>e.startsWith("spine-")))?r.push(a):r.push("spine-3.8");var n,a={platform:"HTML5",mode:"EDITOR",flags:{DEBUG:!0}},o="cce:/internal/x/cc-fu/";return e?.isNative?(a.platform="NATIVE","win32"===process.platform?a.platform="WINDOWS":"darwin"===process.platform?a.platform="MAC":console.error("Unsupported platform: "+process.platform),e=await filterEngineModules(engineDir,a,r),editorFeaturesCache.push(...e),n=(0,path_1.join)(engineDir,"bin/.editor"),new t({rootDir:engineDir,outDir:n,platform:a.platform,targets:[{featureUnitPrefix:o,dir:n,format:"systemjs",targets:"node 10",loose:!0,includeEditorExports:!0,includeIndex:{features:e},loader:!0}],logFile:i})):(n=await filterEngineModules(engineDir,a,r),editorFeaturesCache.push(...n),new t({rootDir:engineDir,outDir:outDir,platform:a.platform,targets:[{featureUnitPrefix:o,dir:(0,path_1.join)(outDir,"editor"),format:"systemjs",usedInElectron509:!0,targets:utils_1.editorBrowserslistQuery,includeIndex:{features:n},loader:!0,loose:!0},{featureUnitPrefix:o,dir:(0,path_1.join)(outDir,"preview"),format:"systemjs",loose:!0}],logFile:i}))}async function rebuild(e){if(void 0===e?.isNativeScene&&((e??={}).isNativeScene=await getIsSceneNative(),e.isNativeScene)&&(e.debugNative=await getIsDebugNative()),!compiler||e?.isNativeScene&&!nativeCompiler)await compileEngine(engineDir,!0);else if(busy)console.error("Compile engine fails: The compilation is in progress");else{busy=!0,console.log("Start Quick Compile");var t=Date.now();if(compiler)try{e.isNativeScene&&(await nativeCompiler.build(),await rebuildNativeImportMap(),await generateEngineAddon(e),await updateAdapter()),await compiler.build(),Editor&&await rebuildImportMaps();var i=(0,path_1.join)(outDir,"VERSION");await(0,fs_extra_1.outputFile)(i,VERSION,{encoding:"utf8"})}catch(e){throw e}finally{console.log("Quick Compile: "+(Date.now()-t)+"ms"),busy=!1}else busy=!1,console.error("Compile engine fails: The compiler does not exist.")}}async function rebuildImportMaps(){var e;compiler&&(e=await getEditorShippedFeatures(),await rebuildTargetImportMap(compiler,0,e),e=await getPreviewShippedFeatures(),await rebuildTargetImportMap(compiler,1,e))}function getCCEnvConstants(e){return statsQuery.constantManager.genCCEnvConstants(e)}async function rebuildNativeImportMap(){var e=await getEditorShippedFeatures();await rebuildTargetImportMap(nativeCompiler,0,e,"NATIVE","EDITOR")}async function rebuildTargetImportMap(e,t,i,r,n,a){var o=await getConfigurableFlagsOfFeatures(i);await e.buildImportMap(t,i,{mode:n,platform:r,out:a,features:i,configurableFlags:o})}async function getEditorShippedFeatures(){return editorFeaturesCache}async function getPreviewShippedFeatures(){var e;return Editor?(e=await Editor.Profile.getProject("engine","modules")).configs[e.globalConfigKey].includeModules:[]}async function getConfigurableFlagsOfFeatures(e){var t={};if(Editor){var i=await Editor.Profile.getProject("engine","modules"),i=i.configs[i.globalConfigKey].flags;if(i)for(var[r,n]of Object.entries(i))e.includes(r)&&Object.assign(t,n)}return t}async function generateEngineAddon(r){let t;if(t=Editor?(0,path_1.join)(Editor.App.path,"../resources/3d/editor-native-scene"):(0,path_1.join)(__dirname,"../../../../../../resources/3d/editor-native-scene"),(0,fs_extra_1.existsSync)(t)){var e=(0,path_1.join)(engineDir,"native");if((0,fs_extra_1.existsSync)(e)){var n="arm64"===process.arch;let e;e=Editor?(0,path_1.join)(Editor.App.path,"../tools/cmake/bin"):(0,path_1.join)(engineDir,"../../../tools/cmake/bin");const u=joinPathEx(__dirname,"../node_modules/cmake-js/bin/cmake-js");var a="win32"===process.platform;const l=a?(0,path_1.join)(t,"win"):(0,path_1.join)(t,"mac"),d={};Object.assign(d,process.env),Object.keys(d).filter(e=>e.toLowerCase().startsWith("npm_")).forEach(e=>delete d[e]),a?d.Path=process.env.PATH+";"+e:d.PATH=process.env.PATH+":"+e;let i="";try{var o="--CDCOCOS_DIR="+(0,path_1.join)(engineDir,"../");const p=(0,path_1.join)(l,"build");var s=await getIsDebugLastTime();"win32"!==process.platform&&(null!==s&&s!==r?.debugNative&&(0,fs_extra_1.existsSync)(p)&&(console.warn("cmake configure change,now will clean build cache"),(0,fs_extra_1.rmdirSync)(p,{recursive:!0})),await setIsDebugLastTime(!!r?.debugNative));const f=[o];a||(f.push("-x"),f.push("-a"),f.push(n?"arm64":"x64"));var c=os_1.default.cpus().length;console.info(">>> cpu core count: "+c),f.push("-j"),f.push(c.toString()),r?.debugNative&&f.push("-D"),console.time("cmake build");const g=async t=>{await forkModule(u,["configure",...f],{cwd:l,env:d},{async success(e){await t?.onSuccess?.(e)},async failed(e){try{await t?.onError?.(e)}catch(e){e instanceof Error&&(i+=e.message+"\n")}}})};let t=!1;const m=e=>{t=!0,console.log("cmake configure success")};if(await g({onSuccess:m,async onError(e){if(i+=e+"\n",console.error(e),!(0,fs_extra_1.existsSync)(p))throw new Error(`cmake configure failed, output path ${p} is not exist `);console.warn("cmake configure error,now will clean build cache and try again"),await(0,fs_extra_1.remove)(p),await g({onSuccess:m,onError(e){console.error(e),i+=e+"\n"}})}}),!t)throw console.warn("cmake configure failed,skip build native scene"),console.timeEnd("cmake build"),i;console.info(">>> cmake with params: "+f.join(" ")),await forkModule(u,["build",...f],{cwd:l,env:d},{success(){console.timeEnd("cmake build"),console.log("Native engine cmake build succeeded.")},failed(e){console.timeEnd("cmake build"),console.error("Native engine cmake build failed, the reason is",e)}})}catch(e){let t;e instanceof Error?(i+=e.message+"\n",t=i):"string"==typeof e&&(t=e),console.error(t),outputErrorTxt("build-native-scene-error"+getFormat24HourTime(),t)}}else console.error("build failed: native engine not exist,path: "+e)}else console.error("build failed: editor-native-scene not exist,path: "+t)}async function updateAdapter(){try{let e=!0;var t,i=(0,path_1.join)(engineDir,"bin/.editor"),r=(0,path_1.join)(engineDir,"bin/adapter/native/web-adapter.js"),n=((0,fs_extra_1.existsSync)(r)?(t=(0,path_1.join)(i,"web-adapter.js"),(0,fs_extra_1.copyFileSync)(r,t)):(e=!1,console.error(r+" not exist,please build engine first")),(0,path_1.join)(engineDir,"bin/adapter/native/engine-adapter.js"));return(0,fs_extra_1.existsSync)(n)?(0,fs_extra_1.copyFileSync)(n,(0,path_1.join)(i,"engine-adapter.js")):(e=!1,console.error(n+" not exist,please build engine first")),e?console.log("update adapter success"):console.error("update adapter failed"),Promise.resolve()}catch(e){return Promise.reject(e)}}function getRightEngine(e,t){t={version:"builtin",path:t};return e.custom&&(0,fs_extra_1.existsSync)(e.custom)&&(t.version="custom",t.path=e.custom),t}function forkModule(a,o,s,c={}){return new Promise((t,i)=>{s.execArgv??=["--max-old-space-size=8192"],"string"==typeof s.cwd&&(0,fs_extra_1.ensureDirSync)(s.cwd),s.stdio??="pipe";var e=(0,child_process_1.fork)(a,o,s);let r="",n="";e.stdout&&e.stdout.on("data",e=>{r+=e}),e.stderr&&e.stderr.on("data",e=>{n+=e}),e.on("close",async e=>{0===e?c.success&&await c.success(n||r):c.failed&&await c.failed(n||r),t(e)}),e.on("error",e=>{i(e)})})}async function getIsSceneNative(){let e=!0;return e=Editor?await Editor.Profile.getConfig("scene","scene.native-engine","global")??!1:e}async function getIsDebugNative(){return!!await Editor?.Profile.getConfig("scene","scene.debug-native")}async function getIsDebugLastTime(){return Editor?.Profile.getConfig("engine","is-debug-native")}async function setIsDebugLastTime(e){return Editor?.Profile.setConfig("engine","is-debug-native",e,"global")}function getFormat24HourTime(){var e=new Date,t=e=>9<e?e:"0"+e,i=t(e.getDate()),r=t(e.getMonth()+1);return e.getFullYear()+`-${r}-${i}-${t(e.getHours())}-${t(e.getMinutes())}-`+t(e.getSeconds())}function outputErrorTxt(e,t,i){try{i??=Editor?.Project.path?(0,path_1.join)(Editor.Project.path,"temp/crash/"):(0,path_1.join)(engineDir,"bin",".editor","logs");var r=(0,path_1.join)(i,e+".txt");(0,fs_extra_1.ensureDirSync)(i),(0,fs_extra_1.writeFileSync)(r,t,{encoding:"utf-8"})}catch(e){e instanceof Error&&console.error("output error failed,reason is "+e.message)}}function joinPathEx(e,t){let i=(0,path_1.join)(e,t);return-1!==i.indexOf("app.asar")&&(i=i.replace("app.asar","app.asar.unpacked")).indexOf("app.asar.unpacked")&&!(0,fs_extra_1.existsSync)(i)&&console.trace(i+" not exist"),i}exports.default=__importStar(require("./index"));