"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,n,t){void 0===t&&(t=n);var r=Object.getOwnPropertyDescriptor(i,n);r&&("get"in r?i.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(e,t,r)}:function(e,i,n,t){e[t=void 0===t?n:t]=i[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(){var r=function(e){return(r=Object.getOwnPropertyNames||function(e){var i,n=[];for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[n.length]=i);return n})(e)};return function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var n=r(e),t=0;t<n.length;t++)"default"!==n[t]&&__createBinding(i,e,n[t]);return __setModuleDefault(i,e),i}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=exports.engineInfo=void 0,exports.load=load,exports.unload=unload;const fs_extra_1=require("fs-extra"),path_1=require("path"),register_modules_1=require("../contributions/project/modules/register-modules"),register_macro_1=require("../contributions/project/register-macro"),utils_1=require("./utils"),engine_1=require("../contributions/preferences/engine"),electron_1=require("electron"),default_config_1=require("../contributions/project/modules/default-config"),ElectronModule=require("@base/electron-module"),ipc=__importStar(require("@base/electron-base-ipc"));let errorDialog=!1;function filterEngineModules(t,e){const r=(0,utils_1.getCCEnvConstants)(e),o={};return Object.keys(register_modules_1.moduleConfigCache.envLimitModule).forEach(e=>{var i,n;t.includes(e)&&({envList:i,fallback:n}=register_modules_1.moduleConfigCache.envLimitModule[e],i.some(e=>r[e])||(o[e]=n||"",n?t.splice(t.indexOf(e),1,n):t.splice(t.indexOf(e),1)))}),{includeModules:t,moduleToFallBack:o}}async function addPipeLineModule(e){var i,n=await Editor.Profile.getProject("engine","modules.graphics")??{};n.pipeline&&("custom-pipeline"===n.pipeline&&(e.push("custom-pipeline"),-1!==(i=e.indexOf("legacy-pipeline")))&&e.splice(i,1),"legacy-pipeline"===n.pipeline&&(e.push("legacy-pipeline"),-1!==(i=e.indexOf("custom-pipeline")))&&e.splice(i,1),n["custom-pipeline-post-process"]?e.push("custom-pipeline-post-process"):-1!==(i=e.indexOf("custom-pipeline-post-process"))&&e.splice(i,1))}function queryEngine(e){var i={version:exports.engineInfo.typescript.type,path:exports.engineInfo.typescript.path,nativeVersion:exports.engineInfo.native.type,nativePath:exports.engineInfo.native.path,editor:Editor.App.path};return e&&e.reply(null,i),i}async function configBuiltinEngine(){var e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,"local"),e=null!=e?"local":"global";await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,!0,e)}function registerEngineI18n(e){try{(0,utils_1.registerI18n)(e),ElectronModule.register("EditorExtends",(0,path_1.join)(__dirname,"../editor-extends/index")),ElectronModule.register("Serialize",(0,path_1.join)(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error("Register engine I18n failed!"),console.error(e)}}async function handleOtherModules(e){try{var i=(await Promise.resolve().then(()=>__importStar(require("cc/preload"))))["default"];await i({root:e,editorExtensions:!1,requiredModules:["cc/editor/macro","cc/editor/populate-internal-constants"]}),await(0,register_macro_1.registerMacroConfig)(e),await(0,register_modules_1.initEngineModules)(e)}catch(e){let i="Load engine modules or register macro config failed!";return console.error(i),console.error(e),afterImportEngineError(i=e instanceof Error?e.stack||e.message:i)}exports.engineInfo.typescript.path=e}async function registerNative(){var e,i=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native`);exports.engineInfo.native.builtin=(0,path_1.join)(exports.engineInfo.typescript.builtin,"native"),exports.engineInfo.typescript.custom&&(e=await getNormalizeCustomPath(),exports.engineInfo.native.custom=(0,path_1.join)(e,"native")),"custom"===exports.engineInfo.typescript.type?exports.engineInfo.native.type=i.builtin?"builtin":"custom":exports.engineInfo.native.type="builtin",exports.engineInfo.native.path=exports.engineInfo.native[exports.engineInfo.native.type],exports.engineInfo.typescript.path===Editor.App.args.engine&&(exports.engineInfo.native.path=(0,path_1.join)(exports.engineInfo.typescript.path,"native")),console.log("Register native engine in "+exports.engineInfo.native.path)}async function getNormalizeCustomPath(){let e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`);var i;return e.startsWith("project://")&&(i=e.replace("project://",""),e=(0,path_1.join)(Editor.Project.path,i)),e}async function load(){if(Editor.Task.__protected__.removeSyncTask("startup.engine"),Editor.Task.__protected__.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.__protected__.type)await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),Editor.App.quit(),process.exit(0);else{createSymlink();let n="",e=!0;var i=(0,path_1.join)(Editor.App.path,"../resources",Editor.Project.__protected__.type,"engine"),t=(exports.engineInfo.typescript.builtin=(0,path_1.normalize)(i),Editor.App.args.engine);if(!await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`)||t){t=t||await getNormalizeCustomPath();if((0,fs_extra_1.existsSync)(t)){var r=(0,fs_extra_1.existsSync)((0,path_1.join)(t,"bin",".cache","dev"))?"engine:compile-custom-engine-with-caching":"engine:compile-custom-engine-without-caching";try{Editor.Metrics.trackTimeStart(r),await(0,utils_1.compileEngine)(t,!0),exports.engineInfo.typescript.custom=(0,path_1.normalize)(t),exports.engineInfo.typescript.type="custom",n=exports.engineInfo.typescript.custom,e=!1,Editor.Metrics.trackTimeEnd(r,{output:!0,label:r+"-success"})}catch(e){n="";let i=Editor.I18n.t("engine.engine_compile_failed");if(console.error(i),console.error(e),e instanceof Error&&(i+=(e.stack,e.stack)),Editor.Metrics.trackTimeEnd(r,{output:!0,label:r+"-fail"}),0!==(await Editor.Dialog.error(i,{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:1,cancel:-1})).response)return Editor.App.quit(),void process.exit(0);await configBuiltinEngine()}}else{if(0!==(await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")],default:1,cancel:-1})).response)return Editor.App.quit(),void process.exit(0);await configBuiltinEngine()}}if(e)try{Editor.Metrics.trackTimeStart("engine:compile-builtin-engine"),await(0,utils_1.compileEngine)(i,Editor.App.dev||!Editor.App.isPackaged),exports.engineInfo.typescript.type="builtin",n=exports.engineInfo.typescript.builtin,Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-success"})}catch(e){n="";let i=Editor.I18n.t("engine.engine_compile_crash");return console.error("Compile builtin engine failed!"),console.error(e),e instanceof Error&&(i+=(e.stack,e.stack)),Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-fail"}),await Editor.Dialog.error(i,{title:"Engine",buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")]}),Editor.App.quit(),void process.exit(0)}if(!n)return afterImportEngineError();console.log("Load engine in "+n),registerEngineI18n(n),Editor.Task.__protected__.removeSyncTask("build-engine"),ipc.on("packages-engine:query-engine-info",queryEngine),await(0,utils_1.rebuildImportMaps)(),await handleOtherModules(n),await(0,utils_1.rebuildImportMaps)(),await registerNative(),await exports.methods.onPipelineConfigChange()}}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}function createSymlink(){var e=(0,path_1.join)(Editor.App.path,"../resources/3d/engine-native"),i=(0,path_1.join)(Editor.App.path,"../resources/3d/engine/native");if(!(0,fs_extra_1.existsSync)(e))try{(0,fs_extra_1.symlinkSync)(i,e,"junction")}catch(e){console.log("error",e)}}async function afterImportEngineError(e){if("custom"===exports.engineInfo.typescript.type){if(1===(await Editor.Dialog.error(Editor.I18n.t("engine.load_custom_engine_failed.title")+(e?"\n"+e:""),{buttons:[Editor.I18n.t("engine.load_custom_engine_failed.exit_editor"),Editor.I18n.t("engine.load_custom_engine_failed.restart_editor")],default:0,cancel:0})).response)return await configBuiltinEngine(),void exports.methods.relaunch()}else await Editor.Dialog.error(Editor.I18n.t("engine.load_builtin_engine_failed.title")+(e?"\n"+e:""),{buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:0,cancel:0});Editor.App.quit(),process.exit(0)}exports.engineInfo={typescript:{type:"builtin",custom:"",builtin:"",path:""},native:{type:"builtin",custom:"",builtin:"",path:""}},exports.methods={async rebuild(){return new Promise((e,i)=>{Editor.Metrics.trackTimeStart("programming:compile-engine-start"),Editor.Message.broadcast("programming:compile-start","engine"),(0,utils_1.rebuild)().then(()=>{Editor.Message.broadcast("programming:compiled","engine"),Editor.Metrics.trackTimeEnd("programming:compile-engine-start"),e(!0)}).catch(e=>{i(e)})})},async importEngineError(e){!1===errorDialog&&(errorDialog=!0,await afterImportEngineError(e))},async"query-info"(){return console.warn(Editor.I18n.t("engine.deprecatedTip",{oldName:"Message: engine(query-info)",newName:"Message: engine(query-engine-info)"})),queryEngine()},async"query-engine-info"(){return exports.engineInfo},relaunch(){process.send&&process.ppid?process.send({channel:"editor-restart"}):(electron_1.app.relaunch(),electron_1.app.exit(0))},async changeCustomEngineConfig(){var e=await Editor.Profile.getConfig("engine","engine."+Editor.App.version.replace(/\./g,""));await(0,engine_1.compareEngineInfo)(exports.engineInfo,e)&&(Editor.Task.addNotice({title:"Custom Engine",message:Editor.I18n.t("engine.preferences.custom_engine_change_info")}),Editor.Message.broadcast("engine:engine-info-changed"))},async onEngineModulesChanged(e,i){await(0,utils_1.rebuildImportMaps)()},onCustomMacroChanged(){Editor.Message.broadcast("engine:engine-custom-macro-changed")},async onPipelineConfigChange(){try{await Editor.Profile.getConfig("engine","deferred_pipeline")||"5d45ba66-829a-46d3-948e-2ed3fa7ee421"===await Editor.Profile.getProject("project","general.renderPipeline")&&(await Editor.Profile.removeProject("project","general.renderPipeline","project"),Editor.Task.addNotice({title:Editor.I18n.t("engine.back_to_default_pipeline.title"),message:Editor.I18n.t("engine.back_to_default_pipeline.message")}),console.log(Editor.I18n.t("engine.back_to_default_pipeline.title")+" "+Editor.I18n.t("engine.back_to_default_pipeline.message")))}catch(e){console.debug(e)}},async"query-modules-config"(){return register_modules_1.moduleConfigCache},async queryEngineModulesProfile(e,i){var n,t=await Editor.Profile.getProject("engine","modules.globalConfigKey")||default_config_1.defaultConfigKey,t=await Editor.Profile.getProject("engine","modules.configs."+(e||t));if(!t)return null;if(await addPipeLineModule(n=Array.from(t.includeModules)),!e&&!i){if(!Object.keys(register_modules_1.moduleConfigCache.envLimitModule).length)return{...t,includeModules:n};i={mode:"EDITOR",platform:"HTML5",flags:{DEBUG:Editor.App.dev}}}return i?(e=filterEngineModules(n,i)["moduleToFallBack"],n=Array.from(new Set(n)),{...t,includeModules:n,moduleToFallBack:e}):{...t,includeModules:n}},filterEngineModules:filterEngineModules};