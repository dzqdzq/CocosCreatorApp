"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.engineInfo=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),register_macro_1=require("../contributions/project/register-macro"),register_modules_1=require("../contributions/project/modules/register-modules"),ElectronModule=require("@base/electron-module"),ipc=require("@base/electron-base-ipc");let errorDialog=!1;async function queryEngine(e){return e.reply(null,exports.engineInfo),exports.engineInfo}async function load(){Editor.Task.removeSyncTask("startup.engine"),Editor.Task.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.type&&(await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),process.exit(-1));const e=path_1.join(Editor.App.path,"../resources",Editor.Project.type,"engine"),i=[{builtin:await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`),custom:await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`)},{builtin:!0}];createSymlink(),Editor.Metrics.trackTimeStart("[Engine] QuickCompile engine");for(let n=0;n<i.length;n++){const t=i[n];if(t.builtin){try{await utils_1.compileEngine(e),exports.engineInfo.path=path_1.normalize(e),exports.engineInfo.version="builtin"}catch(e){exports.engineInfo.path="",console.error(e),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_crash"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}break}if(fs_extra_1.existsSync(t.custom))try{await utils_1.compileEngine(t.custom,!0),exports.engineInfo.path=path_1.normalize(t.custom),exports.engineInfo.version="custom";break}catch(e){exports.engineInfo.path="",console.error(e),1===(await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_failed"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")]})).response&&process.exit(0);continue}else{1===(await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")]})).response&&process.exit(0);const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,"local"),i=void 0!==e&&null!==e?"local":"global";await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,!0,i)}}if(!exports.engineInfo.path)return await afterImportEngineError();try{utils_1.registerI18n(exports.engineInfo.path),ElectronModule.register("EditorExtends",path_1.join(__dirname,"../editor-extends/index")),ElectronModule.register("Serialize",path_1.join(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error(e)}Editor.Task.removeSyncTask("build-engine"),ipc.on("packages-engine:query-engine-info",queryEngine),await utils_1.rebuildImportMaps();try{require("cc/location").set(exports.engineInfo.path),await register_macro_1.registerMacroConfig(exports.engineInfo.path),await register_modules_1.initEngineModules(exports.engineInfo.path),await utils_1.rebuildImportMaps()}catch(e){console.error(e)}Editor.Metrics.trackTimeEnd("[Engine] QuickCompile engine"),await exports.methods.onPipelineConfigChange()}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}function createSymlink(){const e=path_1.join(Editor.App.path,"../resources/3d/engine-native"),i=path_1.join(Editor.App.path,"../resources/3d/engine/native");if(!fs_extra_1.existsSync(e))try{fs_extra_1.symlinkSync(i,e,"junction")}catch(e){console.log("error",e)}}async function afterImportEngineError(e){if("custom"===exports.engineInfo.version){if(1===(await Editor.Dialog.error(Editor.I18n.t("engine.load_custom_engine_failed.title")+` ${e}`,{buttons:[Editor.I18n.t("engine.load_custom_engine_failed.exit_editor"),Editor.I18n.t("engine.load_custom_engine_failed.restart_editor")],default:0,cancel:0})).response){const i=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,"local");if(await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,!0,void 0!==i&&null!==i?"local":"global"),process.send)return process.send("editor-restart",e),void Editor.App.quit()}}else await Editor.Dialog.error(Editor.I18n.t("engine.load_builtin_engine_failed.title")+` ${e}`,{buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:0,cancel:0});Editor.App.quit()}exports.engineInfo={version:"",path:"",nativeVersion:"",nativePath:"",editor:Editor.App.path},exports.methods={async rebuild(){await utils_1.rebuild()},async importEngineError(e){!1===errorDialog&&(errorDialog=!0,await afterImportEngineError(e))},async"query-info"(){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native`),i=path_1.join(Editor.App.path,"../resources/3d/engine/native");"custom"===exports.engineInfo.version&&(e.custom=path_1.join(exports.engineInfo.path,"native"));const n=utils_1.getRightEngine(e,i);return Object.assign(Object.assign({},exports.engineInfo),{nativePath:n.path,nativeVersion:n.version})},changeCustomEngineConfig(){Editor.Task.addNotice({title:"Custom Engine",message:Editor.I18n.t("engine.preferences.custom_engine_change_info")}),Editor.Message.broadcast("engine:engine-info-changed")},async onEngineModulesChanged(e,i){Editor.Message.broadcast("engine:engine-modules-config-changed",i),await utils_1.rebuildImportMaps()},onCustomMacroChanged(){Editor.Message.broadcast("engine:engine-custom-macro-changed")},async onPipelineConfigChange(){try{if(!await Editor.Profile.getConfig("engine","deferred_pipeline")){"5d45ba66-829a-46d3-948e-2ed3fa7ee421"===await Editor.Profile.getProject("project","general.renderPipeline")&&(await Editor.Profile.removeProject("project","general.renderPipeline","project"),Editor.Task.addNotice({title:Editor.I18n.t("engine.back_to_default_pipeline.title"),message:Editor.I18n.t("engine.back_to_default_pipeline.message")}),console.log(Editor.I18n.t("engine.back_to_default_pipeline.title")+" "+Editor.I18n.t("engine.back_to_default_pipeline.message")))}}catch(e){console.debug(e)}}},exports.load=load,exports.unload=unload;