"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.engineInfo=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),register_macro_1=require("../contributions/project/register-macro"),register_modules_1=require("../contributions/project/modules/register-modules"),ElectronModule=require("@base/electron-module"),ipc=require("@base/electron-base-ipc");let errorDialog=!1;async function queryEngine(e){return e.reply(null,exports.engineInfo),exports.engineInfo}async function load(){Editor.Task.removeSyncTask("startup.engine"),Editor.Task.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.type&&(await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),process.exit(-1));const e=path_1.join(Editor.App.path,"../resources",Editor.Project.type,"engine"),i=[{builtin:await Editor.Profile.getConfig("engine",`${Editor.Project.type}.331.javascript.builtin`),custom:await Editor.Profile.getConfig("engine",`${Editor.Project.type}.331.javascript.custom`)},{builtin:!0}];for(let n=0;n<i.length;n++){const t=i[n];if(t.builtin){try{await utils_1.compileEngine(e),exports.engineInfo.path=path_1.normalize(e),exports.engineInfo.version="builtin"}catch(e){exports.engineInfo.path="",console.error(e),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_crash"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}break}if(fs_extra_1.existsSync(t.custom))try{await utils_1.compileEngine(t.custom,!0),exports.engineInfo.path=path_1.normalize(t.custom),exports.engineInfo.version="custom";break}catch(e){exports.engineInfo.path="",console.error(e),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_failed"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}else await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]}),await Editor.Profile.setConfig("engine","3d.331.javascript.builtin",!0)}if(!exports.engineInfo.path)return await afterImportEngineError();try{utils_1.registerI18n(exports.engineInfo.path),ElectronModule.register("EditorExtends",path_1.join(__dirname,"../editor-extends/index")),ElectronModule.register("UuidUtils",path_1.join(__dirname,"../editor-extends/utils/uuid")),ElectronModule.register("Serialize",path_1.join(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error(e)}Editor.Task.removeSyncTask("build-engine"),ipc.on("packages-engine:query-engine-info",queryEngine);try{require("cc/location").set(exports.engineInfo.path),await register_macro_1.registerMacroConfig(exports.engineInfo.path),await register_modules_1.initEngineModules(exports.engineInfo.path)}catch(e){console.error(e)}}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}async function afterImportEngineError(e){if("custom"===exports.engineInfo.version){if(await Editor.Profile.setConfig("engine","3d.331.javascript.builtin",!0),1===await Editor.Dialog.error(Editor.I18n.t("engine.load_custom_engine_failed.title"),{buttons:[Editor.I18n.t("engine.load_custom_engine_failed.exit_editor"),Editor.I18n.t("engine.load_custom_engine_failed.restart_editor")],default:0,cancel:0})&&process.send)return void process.send(e||"editor-restart")}else await Editor.Dialog.error(Editor.I18n.t("engine.load_builtin_engine_failed.title"),{buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:0,cancel:0});Editor.App.quit()}exports.engineInfo={version:"",path:"",nativeVersion:"",nativePath:"",editor:Editor.App.path},exports.methods={async rebuild(){await utils_1.rebuild()},async importEngineError(e){!1===errorDialog&&(errorDialog=!0,await afterImportEngineError(e))},async"query-info"(){const e=await Editor.Profile.getConfig("engine",`${Editor.Project.type}.331.native`),i=path_1.join(Editor.App.path,"../resources/3d/engine-native"),n=utils_1.getRightEngine(e,i);return Object.assign(Object.assign({},exports.engineInfo),{nativePath:n.path,nativeVersion:n.version})},changeCustomEngineConfig(){Editor.Task.addNotice({title:"Custom Engine",message:Editor.I18n.t("engine.preferences.custom_engine_change_info")}),Editor.Message.broadcast("engine:engine-info-changed")},onEngineModulesChanged(){Editor.Message.broadcast("engine:engine-modules-config-changed")}},exports.load=load,exports.unload=unload;