"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.engineInfo=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),register_macro_1=require("../contributions/project/register-macro"),register_modules_1=require("../contributions/project/modules/register-modules"),ElectronModule=require("@base/electron-module"),ipc=require("@base/electron-base-ipc");let errorDialog=!1;async function queryEngine(e){return e.reply(null,exports.engineInfo),exports.engineInfo}async function load(){Editor.Task.removeSyncTask("startup.engine"),Editor.Task.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.type&&(await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),process.exit(-1));const e=path_1.join(Editor.App.path,"../resources",Editor.Project.type,"engine"),t=[{builtin:await Editor.Profile.getConfig("engine",`${Editor.Project.type}.javascript.builtin`),custom:await Editor.Profile.getConfig("engine",`${Editor.Project.type}.javascript.custom`)},{builtin:!0}];for(let n=0;n<t.length;n++){const i=t[n];if(i.builtin){try{await utils_1.compileEngine(e),exports.engineInfo.path=path_1.normalize(e),exports.engineInfo.version="builtin"}catch(e){console.error(e),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_crash"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}break}if(fs_extra_1.existsSync(i.custom))try{await utils_1.compileEngine(i.custom,!0),exports.engineInfo.path=path_1.normalize(i.custom),exports.engineInfo.version="custom";break}catch(e){console.error(e),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_failed"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}else await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}try{utils_1.registerI18n(exports.engineInfo.path),ElectronModule.register("EditorExtends",path_1.join(__dirname,"../editor-extends/index")),ElectronModule.register("UuidUtils",path_1.join(__dirname,"../editor-extends/utils/uuid")),ElectronModule.register("Serialize",path_1.join(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error(e)}Editor.Task.removeSyncTask("build-engine"),require("cc/location").set(exports.engineInfo.path);const n=path_1.join(Editor.Project.path,"temp"),i=path_1.join(n,"declarations","cc.d.ts"),o=`\n/// <reference path="${path_1.join(exports.engineInfo.path,"bin/.declarations/cc.d.ts")}"/>\n\n/**\n * @deprecated Global variable \`cc\` was dropped since 3.0. Use ES6 module syntax to import Cocos Creator APIs.\n */\ndeclare const cc: never;\n`;fs_extra_1.outputFileSync(i,o);const r=path_1.join(n,"declarations","jsb.d.ts"),s=`/// <reference path="${path_1.join(Editor.App.path,"../resources/3d/engine/@types/jsb.d.ts")}"/>\n`;fs_extra_1.outputFileSync(r,s);const a=require("cc/mods-mgr").syncImport("cc/editor/exports/populate-internal-constants"),c=path_1.join(n,"declarations","cce.env.d.ts"),l=`declare module "cc/env" {\n${Object.entries(a).map(([e,t])=>`    export const ${e}: ${typeof t};\n`).join("\n")}\n}\n`;fs_extra_1.outputFileSync(c,l);const p=path_1.join(n,"tsconfig.cocos.json");fs_extra_1.outputJSONSync(p,{$schema:"https://json.schemastore.org/tsconfig",compilerOptions:{target:"ES2015",module:"ES2015",strict:!0,types:["./temp/declarations/cc","./temp/declarations/jsb","./temp/declarations/cce.env"],experimentalDecorators:!0,isolatedModules:!0,moduleResolution:"node",noEmit:!0,forceConsistentCasingInFileNames:!0}},{spaces:2}),ipc.on("packages-engine:query-engine-info",queryEngine),await register_macro_1.registerMacroConfig(exports.engineInfo.path),await register_modules_1.initEngineModules(exports.engineInfo.path)}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}exports.engineInfo={version:"",path:"",nativePath:"",editor:Editor.App.path},exports.methods={async rebuild(){await utils_1.rebuild()},async importEngineError(){!1===errorDialog&&(errorDialog=!0,await Editor.Profile.setConfig("engine","3d.javascript.builtin",!0),await Editor.Dialog.error(Editor.I18n.t("engine.custom_engine_load_failed"),{buttons:["OK"]}),Editor.App.quit())},async"query-info"(){const e=await Editor.Profile.getConfig("engine",`${Editor.Project.type}.native`);let t=path_1.join(Editor.App.path,"../resources/3d/cocos2d-x-lite");return t=utils_1.getRightEngine(e,t),Object.assign(Object.assign({},exports.engineInfo),{nativePath:t})}},exports.load=load,exports.unload=unload;