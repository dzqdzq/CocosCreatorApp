"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,n,t){void 0===t&&(t=n);var o=Object.getOwnPropertyDescriptor(i,n);o&&("get"in o?i.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(e,t,o)}:function(e,i,n,t){void 0===t&&(t=n),e[t]=i[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(i,e,n);return __setModuleDefault(i,e),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.engineInfo=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),register_macro_1=require("../contributions/project/register-macro"),register_modules_1=require("../contributions/project/modules/register-modules"),setting=require("@editor/setting"),ElectronModule=require("@base/electron-module"),ipc=require("@base/electron-base-ipc");let errorDialog=!1;function queryEngine(e){const i={version:exports.engineInfo.typescript.type,path:exports.engineInfo.typescript.path,nativeVersion:exports.engineInfo.native.type,nativePath:exports.engineInfo.native.path,editor:Editor.App.path};return e&&e.reply(null,i),i}async function configBuiltinEngine(){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,"local"),i=void 0!==e&&null!==e?"local":"global";await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`,!0,i)}function registerEngineI18n(e){try{(0,utils_1.registerI18n)(e),ElectronModule.register("EditorExtends",(0,path_1.join)(__dirname,"../editor-extends/index")),ElectronModule.register("Serialize",(0,path_1.join)(__dirname,"../editor-extends/utils/serialize/index"))}catch(e){console.error("Register engine I18n failed!"),console.error(e)}}async function handleOtherModules(e){try{const{default:i}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await i({root:e,editorExtensions:!1,requiredModules:["cc/editor/macro","cc/editor/populate-internal-constants"]}),await(0,register_macro_1.registerMacroConfig)(e),await(0,register_modules_1.initEngineModules)(e)}catch(e){return console.error("Load engine modules or register macro config failed!"),console.error(e),await afterImportEngineError()}exports.engineInfo.typescript.path=e}async function registerNative(){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native`);if(exports.engineInfo.native.builtin=(0,path_1.join)(exports.engineInfo.typescript.builtin,"native"),exports.engineInfo.typescript.custom){const e=await getNormalizeCustomPath();exports.engineInfo.native.custom=(0,path_1.join)(e,"native")}"custom"===exports.engineInfo.typescript.type?exports.engineInfo.native.type=e.builtin?"builtin":"custom":exports.engineInfo.native.type="builtin",exports.engineInfo.native.path=exports.engineInfo.native[exports.engineInfo.native.type],exports.engineInfo.typescript.path===setting.args.engine&&(exports.engineInfo.native.path=(0,path_1.join)(exports.engineInfo.typescript.path,"native")),console.log(`Register native engine in ${exports.engineInfo.native.path}`)}async function getNormalizeCustomPath(){let e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`);if(e.startsWith("project://")){const i=e.replace("project://","");e=(0,path_1.join)(Editor.Project.path,i)}return e}async function load(){if(Editor.Task.removeSyncTask("startup.engine"),Editor.Task.addSyncTask("build-engine",Editor.I18n.t("engine.compile_engine"),Editor.I18n.t("engine.wait_quick_compile")),"3d"!==Editor.Project.type)return await Editor.Dialog.error(Editor.I18n.t("engine.not_support")),process.exit(-1);createSymlink();let e="",i=!0;const n=(0,path_1.join)(Editor.App.path,"../resources",Editor.Project.type,"engine");exports.engineInfo.typescript.builtin=(0,path_1.normalize)(n);const t=setting.args.engine;if(!await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.builtin`)||t){const n=t||await getNormalizeCustomPath();if((0,fs_extra_1.existsSync)(n)){const t=(0,fs_extra_1.existsSync)((0,path_1.join)(n,"bin",".cache","dev"))?"engine:compile-custom-engine-with-caching":"engine:compile-custom-engine-without-caching";try{Editor.Metrics.trackTimeStart(t),await(0,utils_1.compileEngine)(n,!0),exports.engineInfo.typescript.custom=(0,path_1.normalize)(n),exports.engineInfo.typescript.type="custom",e=exports.engineInfo.typescript.custom,i=!1,Editor.Metrics.trackTimeEnd(t,{output:!0,label:`${t}-success`})}catch(i){if(e="",console.error("Compile custom engine failed!"),console.error(i),Editor.Metrics.trackTimeEnd(t,{output:!0,label:`${t}-fail`}),0!==(await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_failed"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")],default:1,cancel:-1})).response)return process.exit(-1);await configBuiltinEngine()}}else{if(0!==(await Editor.Dialog.error(Editor.I18n.t("engine.engine_directory_illegal"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm"),Editor.I18n.t("engine.close")],default:1,cancel:-1})).response)return process.exit(-1);await configBuiltinEngine()}}if(i)try{Editor.Metrics.trackTimeStart("engine:compile-builtin-engine"),await(0,utils_1.compileEngine)(n),exports.engineInfo.typescript.type="builtin",e=exports.engineInfo.typescript.builtin,Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-success"})}catch(i){e="",console.error("Compile builtin engine failed!"),console.error(i),Editor.Metrics.trackTimeEnd("engine:compile-builtin-engine",{output:!0,label:"engine:compile-builtin-engine-fail"}),await Editor.Dialog.error(Editor.I18n.t("engine.engine_compile_crash"),{title:"Engine",buttons:[Editor.I18n.t("engine.confirm")]})}if(!e)return await afterImportEngineError();console.log(`Load engine in ${e}`),registerEngineI18n(e),Editor.Task.removeSyncTask("build-engine"),ipc.on("packages-engine:query-engine-info",queryEngine),await(0,utils_1.rebuildImportMaps)(),await handleOtherModules(e),await(0,utils_1.rebuildImportMaps)(),await registerNative(),await exports.methods.onPipelineConfigChange()}function unload(){ipc.removeListener("packages-engine:query-engine-info",queryEngine)}function createSymlink(){const e=(0,path_1.join)(Editor.App.path,"../resources/3d/engine-native"),i=(0,path_1.join)(Editor.App.path,"../resources/3d/engine/native");if(!(0,fs_extra_1.existsSync)(e))try{(0,fs_extra_1.symlinkSync)(i,e,"junction")}catch(e){console.log("error",e)}}async function afterImportEngineError(e){if("custom"===exports.engineInfo.typescript.type){if(1===(await Editor.Dialog.error(Editor.I18n.t("engine.load_custom_engine_failed.title")+`${e?"\n"+e:""}`,{buttons:[Editor.I18n.t("engine.load_custom_engine_failed.exit_editor"),Editor.I18n.t("engine.load_custom_engine_failed.restart_editor")],default:0,cancel:0})).response&&(await configBuiltinEngine(),process.send))return process.send({channel:"editor-restart"}),void Editor.App.quit()}else await Editor.Dialog.error(Editor.I18n.t("engine.load_builtin_engine_failed.title")+`${e?"\n"+e:""}`,{buttons:[Editor.I18n.t("engine.load_builtin_engine_failed.exit_editor")],default:0,cancel:0});Editor.App.quit()}exports.engineInfo={typescript:{type:"builtin",custom:"",builtin:"",path:""},native:{type:"builtin",custom:"",builtin:"",path:""}},exports.methods={async rebuild(){await(0,utils_1.rebuild)()},async importEngineError(e){!1===errorDialog&&(errorDialog=!0,await afterImportEngineError(e))},"query-info":async()=>(console.warn(Editor.I18n.t("engine.deprecatedTip",{oldName:"Message: engine(query-info)",newName:"Message: engine(query-engine-info)"})),queryEngine()),"query-engine-info":async()=>exports.engineInfo,changeCustomEngineConfig(){Editor.Task.addNotice({title:"Custom Engine",message:Editor.I18n.t("engine.preferences.custom_engine_change_info")}),Editor.Message.broadcast("engine:engine-info-changed")},async onEngineModulesChanged(e,i){Editor.Message.broadcast("engine:engine-modules-config-changed",i),await(0,utils_1.rebuildImportMaps)()},onCustomMacroChanged(){Editor.Message.broadcast("engine:engine-custom-macro-changed")},async onPipelineConfigChange(){try{if(!await Editor.Profile.getConfig("engine","deferred_pipeline")){"5d45ba66-829a-46d3-948e-2ed3fa7ee421"===await Editor.Profile.getProject("project","general.renderPipeline")&&(await Editor.Profile.removeProject("project","general.renderPipeline","project"),Editor.Task.addNotice({title:Editor.I18n.t("engine.back_to_default_pipeline.title"),message:Editor.I18n.t("engine.back_to_default_pipeline.message")}),console.log(Editor.I18n.t("engine.back_to_default_pipeline.title")+" "+Editor.I18n.t("engine.back_to_default_pipeline.message")))}}catch(e){console.debug(e)}}},exports.load=load,exports.unload=unload;