"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,o)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRightEngine=exports.rebuildImportMaps=exports.rebuild=exports.registerI18n=exports.compileEngine=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),i18n=require("@base/electron-i18n"),utils_1=require("@editor/lib-programming/dist/utils"),build_engine_1=require("@cocos/build-engine");let compiler=null,engineDir="";const editorFeaturesCache=[],VERSION="3";async function compileEngine(e,t){engineDir=e;const i=(0,path_1.join)(e,"bin",".cache","dev"),r=(0,path_1.join)(i,"VERSION");let o=!1;try{await(0,fs_extra_1.readFile)(r,"utf8")!==VERSION&&(o=!0)}catch(e){o=!0}o?(console.debug("[EditorQuickCompiler]Version information lost."),await(0,fs_extra_1.emptyDir)(i)):console.debug("[EditorQuickCompiler]Version information looks good.");const{QuickCompiler:n}=await Promise.resolve().then(()=>__importStar(require("@editor/quick-compiler"))),a=Editor.Project.tmpDir?(0,path_1.join)(e,"bin",".cache","logs","log.txt"):void 0;a&&await(0,fs_extra_1.ensureDir)((0,path_1.dirname)(a));const s=["wait-for-ammo-instantiation"],c=(await build_engine_1.StatsQuery.create(e)).getFeatures().filter(e=>!s.includes(e));editorFeaturesCache.push(...c);compiler=new n({rootDir:e,outDir:i,targets:[{featureUnitPrefix:"cce:/internal/x/cc-fu/",dir:(0,path_1.join)(i,"editor"),format:"systemjs",usedInElectron509:!0,targets:utils_1.editorBrowserslistQuery,includeIndex:{features:c},loader:!0},{featureUnitPrefix:"cce:/internal/x/cc-fu/",dir:(0,path_1.join)(i,"preview"),format:"systemjs",loose:!0}],logFile:a}),(o||Editor.App.dev||t)&&!process.argv.includes("--no-quick-compile")?(await rebuild(),await(0,fs_extra_1.outputFile)(r,VERSION,{encoding:"utf8"})):console.debug("Note, quick compiler does not get launched.")}function registerI18n(e){try{const t=(0,path_1.join)(e,"editor","i18n");if(!(0,fs_extra_1.existsSync)(t))return;if(!(0,fs_extra_1.statSync)(t).isDirectory())return;(0,fs_extra_1.readdirSync)(t).map(e=>{const i=(0,path_1.join)(t,e);if(!(0,fs_extra_1.statSync)(i).isDirectory())return;const r=(0,fs_extra_1.readdirSync)(i).reduce((e,t)=>{const r=(0,path_1.join)(i,t);try{const t=require(r);e.ENGINE?e.ENGINE=Object.assign(e.ENGINE,t):e.ENGINE=t}catch(e){}return e},{});i18n.register(r,e)})}catch(e){console.log(`Load I18n files failed: ${e.message}`)}}exports.compileEngine=compileEngine,exports.registerI18n=registerI18n;let busy=!1;async function rebuild(){if(!compiler)return void await compileEngine(engineDir,!0);if(busy)return void console.error("Compile engine fails: The compilation is in progress");busy=!0,console.log("Start Quick Compile");const e=Date.now();if(!compiler)return busy=!1,void console.error("Compile engine fails: The compiler does not exist.");try{await compiler.build(),Editor.Profile.getProject&&await rebuildImportMaps()}catch(e){throw e}finally{console.log("Quick Compile: "+(Date.now()-e)+"ms"),busy=!1}}async function rebuildImportMaps(){if(!compiler)return;const e=await getEditorShippedFeatures();await rebuildTargetImportMap(compiler,0,e),await rebuildTargetImportMap(compiler,0,e,"NATIVE","PREVIEW","native.import-map.json");const t=await getPreviewShippedFeatures();await rebuildTargetImportMap(compiler,1,t)}async function rebuildTargetImportMap(e,t,i,r,o,n){const a=await getConfigurableFlagsOfFeatures(i);await e.buildImportMap(t,i,{mode:o,platform:r,out:n,features:i,configurableFlags:a})}async function getEditorShippedFeatures(){return editorFeaturesCache}async function getPreviewShippedFeatures(){return await Editor.Profile.getProject("engine","modules.includeModules")}async function getConfigurableFlagsOfFeatures(e){const t={},i=await Editor.Profile.getProject("engine","modules.flags");if(i)for(const[r,o]of Object.entries(i))e.includes(r)&&Object.assign(t,o);return t}function getRightEngine(e,t){const i={version:"builtin",path:t};return e.custom&&(0,fs_extra_1.existsSync)(e.custom)?(i.version="custom",i.path=e.custom,i):i}exports.rebuild=rebuild,exports.rebuildImportMaps=rebuildImportMaps,exports.getRightEngine=getRightEngine;