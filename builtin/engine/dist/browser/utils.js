"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRightEngine=exports.rebuild=exports.registerI18n=exports.compileEngine=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),i18n=require("@base/electron-i18n"),utils_1=require("@editor/lib-programming/dist/utils"),stats_query_1=require("@cocos/build-engine/dist/stats-query");let compiler=null,engineDir="";async function compileEngine(e,t){if(engineDir=e,Editor.App.dev||t){const t=path_1.join(e,"bin",".cache","dev");await fs_extra_1.pathExists(path_1.join(t,"__quick_compile__.js"))&&await fs_extra_1.emptyDir(t);const{QuickCompiler:i}=await Promise.resolve().then(()=>__importStar(require("@editor/quick-compiler"))),r=Editor.Project.tmpDir?path_1.join(e,"bin",".cache","logs","log.txt"):void 0;r&&await fs_extra_1.ensureDir(path_1.dirname(r));const n=["physics-2d-builtin","wait-for-ammo-instantiation"],o=(await stats_query_1.StatsQuery.create(e)).getFeatures().filter(e=>!n.includes(e)),s="cce:/internal/x/cc-fu/";compiler=new i({rootDir:e,outDir:t,targets:[{featureUnitPrefix:s,dir:path_1.join(t,"editor"),format:"commonjs",usedInElectron509:!0,targets:utils_1.editorBrowserslistQuery,includeIndex:{features:o}},{featureUnitPrefix:s,dir:path_1.join(t,"preview"),format:"systemjs",loose:!0}],logFile:r}),process.argv.includes("--no-quick-compile")?console.log("Note, quick compiler does not get launched."):await rebuild()}}function registerI18n(e){try{const t=path_1.join(e,"editor","i18n");if(!fs_extra_1.existsSync(t))return;if(!fs_extra_1.statSync(t).isDirectory())return;fs_extra_1.readdirSync(t).map(e=>{const i=path_1.join(t,e);if(!fs_extra_1.statSync(i).isDirectory())return;const r=fs_extra_1.readdirSync(i).reduce((e,t)=>{const r=path_1.join(i,t);try{const t=require(r);e.ENGINE?e.ENGINE=Object.assign(e.ENGINE,t):e.ENGINE=t}catch(e){}return e},{});i18n.register(r,e)})}catch(e){console.log(`Load I18n files failed: ${e.message}`)}}exports.compileEngine=compileEngine,exports.registerI18n=registerI18n;let busy=!1;async function rebuild(){if(!compiler)return void await compileEngine(engineDir,!0);if(busy)return void console.error("Compile engine fails: The compilation is in progress");busy=!0,console.log("Start Quick Compile");const e=Date.now();if(!compiler)return busy=!1,void console.error("Compile engine fails: The compiler does not exist.");try{await compiler.build()}catch(e){throw e}finally{console.log("Quick Compile: "+(Date.now()-e)+"ms"),busy=!1}}function getRightEngine(e,t){const i={version:"buitin",path:t};return e.builtin?i:e.custom&&fs_extra_1.existsSync(e.custom)?(i.version="custom",i.path=e.custom,i):i}exports.rebuild=rebuild,exports.getRightEngine=getRightEngine;