"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkAndStripNode=exports.addPrefabInfo=exports.visitObjTypeReferences=exports.walkNode=void 0;const cc_1=require("cc"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo,DontClearIDComponentNames=["TerrainRenderable"];function walkNode(e,n,o=!1){if(n(e,!!o))return;const t=e.children;for(let e=t.length-1;e>=0;--e)walkNode(t[e],n,!0)}function visitObjTypeReferences(e,n){const o=(e,o)=>{const t=(o=o||e.constructor).__values__;for(let o=0;o<t.length;o++){const r=t[o],c=e[r];if(c&&"object"==typeof c)if(Array.isArray(c))for(let e=0;e<c.length;e++)cc.isValid(c)&&n(c,""+e,c[e]);else cc.isValid(c)&&n(e,r,c)}};for(let n=0;n<e.components.length;++n){o(e.components[n])}}function initNodePrefabInfo(e,n,o){e._prefab||(e._prefab=new PrefabInfo);const t=e._prefab;return t?(t.root=n,t.asset=o,t):null}function isPrefabRoot(e){return!(!e._prefab||!e._prefab.instance)}function addPrefabInfo(e,n,o,t={}){n?walkNode(e,(e,r)=>{if(!e)return;if(e.objFlags&cc.Object.Flags.HideInHierarchy)return;const c=r&&isPrefabRoot(e);let a=e._prefab;if(a){c||(a.asset=o,a.root=n),n._prefab&&a.instance&&(a.instance.prefabRootNode=n)}else a=initNodePrefabInfo(e,n,o);if(a){if(t.nodeFileIdGenerator?a.fileId=t.nodeFileIdGenerator(e):a.fileId=a.fileId?a.fileId:e.uuid,e.components&&e.components.length)for(let n=0;n<e.components.length;n++){const o=e.components[n];o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab&&(t.compFileIdGenerator?o.__prefab.fileId=t.compFileIdGenerator(o,n):o.__prefab.fileId=o.__prefab.fileId?o.__prefab.fileId:o.uuid)}return!!c||void 0}}):console.error("addPrefabInfo without a rootNode")}function checkAndStripNode(e,n){walkNode(e,function(o){if(o.objFlags&cc.Object.Flags.HideInHierarchy){if(o.isPrivatePreview)return;o._id="";for(let e=0;e<o.components.length;++e){const n=o.components[e];DontClearIDComponentNames.includes(cc_1.js.getClassName(n))||(n._id="")}}else{visitObjTypeReferences(o,function(o,t,r){let c=!1;r instanceof cc.Component.EventHandler?r=r.target:r instanceof cc.Component&&(r=r.node),r&&r instanceof cc._BaseNode&&!r.isChildOf(e)&&(c=!0),c&&(o[t]instanceof cc.Component.EventHandler?o[t]=new cc.Component.EventHandler:o[t]=null,n||console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',t,o.name||e.name,r.name))}),o._id="";for(let e=0;e<o.components.length;++e){o.components[e]._id=""}}})}exports.walkNode=walkNode,exports.visitObjTypeReferences=visitObjTypeReferences,exports.addPrefabInfo=addPrefabInfo,exports.checkAndStripNode=checkAndStripNode;