"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,t,o){void 0===o&&(o=t);var r=Object.getOwnPropertyDescriptor(n,t);r&&("get"in r?n.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,o,r)}:function(e,n,t,o){void 0===o&&(o=t),e[o]=n[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.addPrefabInstance=exports.checkAndStripNode=exports.addPrefabInfo=exports.visitObjTypeReferences=exports.walkNode=void 0;const cc_1=require("cc"),Uuid=__importStar(require("./uuid")),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PrefabInstance=cc_1.Prefab._utils.PrefabInstance,DontClearIDComponentNames=["TerrainRenderable"];function walkNode(e,n,t=!1){if(n(e,!!t))return;const o=e.children;for(let e=o.length-1;e>=0;--e)walkNode(o[e],n,!0)}function visitObjTypeReferences(e,n){const t=(e,t)=>{const o=(t=t||e.constructor).__values__;for(let t=0;t<o.length;t++){const r=o[t],a=e[r];if(a&&"object"==typeof a)if(Array.isArray(a))for(let e=0;e<a.length;e++)cc.isValid(a)&&n(a,""+e,a[e]);else cc.isValid(a)&&n(e,r,a)}};for(let n=0;n<e.components.length;++n){t(e.components[n])}}function initNodePrefabInfo(e,n,t){e._prefab||(e._prefab=new PrefabInfo);const o=e._prefab;return o?(o.root=n,o.asset=t,o):null}function isPrefabRoot(e){return!(!e._prefab||!e._prefab.instance)}function addPrefabInfo(e,n,t,o={}){n?walkNode(e,(e,r)=>{if(!e)return;if(e.objFlags&cc.Object.Flags.HideInHierarchy)return;const a=r&&isPrefabRoot(e);let i=e._prefab;if(i){a||(i.asset=t,i.root=n),n._prefab&&i.instance&&(i.instance.prefabRootNode=n)}else i=initNodePrefabInfo(e,n,t);if(i){if(o.nodeFileIdGenerator?i.fileId=o.nodeFileIdGenerator(e):i.fileId=i.fileId?i.fileId:e.uuid,e.components&&e.components.length)for(let n=0;n<e.components.length;n++){const t=e.components[n];t.__prefab||(t.__prefab=new CompPrefabInfo),t.__prefab&&(o.compFileIdGenerator?t.__prefab.fileId=o.compFileIdGenerator(t,n):t.__prefab.fileId=t.__prefab.fileId?t.__prefab.fileId:t.uuid)}return!!a||void 0}}):console.error("addPrefabInfo without a rootNode")}function checkAndStripNode(e,n){const t={};return walkNode(e,function(o){if(o.objFlags&cc.Object.Flags.HideInHierarchy){if(o.isPrivatePreview)return;o._id="";for(let e=0;e<o.components.length;++e){const n=o.components[e];DontClearIDComponentNames.includes(cc_1.js.getClassName(n))||(n._id="")}}else{visitObjTypeReferences(o,function(r,a,i){var f,c;let s=!1;i instanceof cc.Component.EventHandler?i=i.target:i instanceof cc.Component&&(i=i.node),i&&i instanceof cc.Node&&!i.isChildOf(e)&&(s=!0),s&&(r[a]instanceof cc.Component.EventHandler?r[a]=new cc.Component.EventHandler:((null===(f=o._prefab)||void 0===f?void 0:f.fileId)&&(null===(c=r.__prefab)||void 0===c?void 0:c.fileId)&&(t[o._prefab.fileId]={path:a,component:r.__prefab.fileId,value:r[a]}),r[a]=null),n||console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',a,r.name||e.name,i.name))}),o._id="";for(let e=0;e<o.components.length;++e){o.components[e]._id=""}}}),t}function addPrefabInstance(e){const n=e._prefab;if(n&&!n.instance){const e=new PrefabInstance;e.fileId=Uuid.uuid(),n.instance=e}}exports.walkNode=walkNode,exports.visitObjTypeReferences=visitObjTypeReferences,exports.addPrefabInfo=addPrefabInfo,exports.checkAndStripNode=checkAndStripNode,exports.addPrefabInstance=addPrefabInstance;