"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkAndStripNode=exports.addPrefabInfo=exports.visitObjTypeReferences=exports.walkNode=void 0;const cc_1=require("cc"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function walkNode(e,n,o=!1){if(n(e,!!o))return;const t=e.children;for(let e=t.length-1;e>=0;--e)walkNode(t[e],n,!0)}function visitObjTypeReferences(e,n){const o=(e,o)=>{const t=(o=o||e.constructor).__values__;for(let o=0;o<t.length;o++){const r=t[o],f=e[r];if(f&&"object"==typeof f)if(Array.isArray(f))for(let e=0;e<f.length;e++)cc.isValid(f)&&n(f,""+e,f[e]);else cc.isValid(f)&&n(e,r,f)}};for(let n=0;n<e.components.length;++n){o(e.components[n])}}function initNodePrefabInfo(e,n,o){e._prefab||(e._prefab=new PrefabInfo);const t=e._prefab;return t?(t.root=n,t.asset=o,t):null}function isPrefabRoot(e){return!(!e._prefab||!e._prefab.instance)}function addPrefabInfo(e,n,o,t={}){n?walkNode(e,(e,r)=>{if(!e)return;if(e.objFlags&cc.Object.Flags.HideInHierarchy)return;const f=r&&isPrefabRoot(e);let c=e._prefab;if(c){f||(c.asset=o,c.root=n),n._prefab&&c.instance&&(c.instance.prefabRootNode=n)}else c=initNodePrefabInfo(e,n,o);if(c){if(t.nodeFileIdGenerator?c.fileId=t.nodeFileIdGenerator(e):c.fileId=c.fileId?c.fileId:e.uuid,e.components&&e.components.length)for(let n=0;n<e.components.length;n++){const o=e.components[n];o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab&&(t.compFileIdGenerator?o.__prefab.fileId=t.compFileIdGenerator(o,n):o.__prefab.fileId=o.__prefab.fileId?o.__prefab.fileId:o.uuid)}return!!f||void 0}}):console.error("addPrefabInfo without a rootNode")}function checkAndStripNode(e,n){walkNode(e,function(o){if(o.objFlags&cc.Object.Flags.HideInHierarchy){if(o.isPrivatePreview)return;o._id="";for(let e=0;e<o.components.length;++e){o.components[e]._id=""}}else{visitObjTypeReferences(o,function(o,t,r){let f=!1;r instanceof cc.Component.EventHandler?r=r.target:r instanceof cc.Component&&(r=r.node),r&&r instanceof cc._BaseNode&&!r.isChildOf(e)&&(f=!0),f&&(o[t]instanceof cc.Component.EventHandler?o[t]=new cc.Component.EventHandler:o[t]=null,n||console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',t,o.name||e.name,r.name))}),o._id="";for(let e=0;e<o.components.length;++e){o.components[e]._id=""}}})}exports.walkNode=walkNode,exports.visitObjTypeReferences=visitObjTypeReferences,exports.addPrefabInfo=addPrefabInfo,exports.checkAndStripNode=checkAndStripNode;