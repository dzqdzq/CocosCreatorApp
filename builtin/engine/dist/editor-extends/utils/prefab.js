"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,t,r){void 0===r&&(r=t);var o=Object.getOwnPropertyDescriptor(n,t);o&&("get"in o?n.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,r,o)}:function(e,n,t,r){e[r=void 0===r?t:r]=n[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(){var o=function(e){return(o=Object.getOwnPropertyNames||function(e){var n,t=[];for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t})(e)};return function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t=o(e),r=0;r<t.length;r++)"default"!==t[r]&&__createBinding(n,e,t[r]);return __setModuleDefault(n,e),n}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.walkNode=walkNode,exports.visitObjTypeReferences=visitObjTypeReferences,exports.addPrefabInfo=addPrefabInfo,exports.checkAndStripNode=checkAndStripNode,exports.addPrefabInstance=addPrefabInstance;const cc_1=require("cc"),Uuid=__importStar(require("./uuid")),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PrefabInstance=cc_1.Prefab._utils.PrefabInstance,DontClearIDComponentNames=["TerrainRenderable"];function walkNode(e,n,t=!1){t=n(e,!!t);if(!t){var r=e.children;for(let e=r.length-1;0<=e;--e)walkNode(r[e],n,!0)}}function visitObjTypeReferences(n,t){for(let e=0;e<n.components.length;++e){var r=n.components[e],o=(i=a=o=void 0,((i=a=o)||r.constructor).__values__);for(let e=0;e<o.length;e++){var a=o[e],i=r[a];if(i&&"object"==typeof i)if(Array.isArray(i))for(let e=0;e<i.length;e++)cc.isValid(i)&&t(i,""+e,i[e]);else cc.isValid(i)&&t(r,a,i)}}}function initNodePrefabInfo(e,n,t){e._prefab||(e._prefab=new PrefabInfo);e=e._prefab;return e?(e.root=n,e.asset=t,e):null}function isPrefabRoot(e){return!(!e._prefab||!e._prefab.instance)}function addPrefabInfo(e,o,a,i={}){o?walkNode(e,(n,t)=>{if(n&&!(n.objFlags&cc.Object.Flags.HideInHierarchy)){t=t&&isPrefabRoot(n);let e=n._prefab;if(e?(t||(e.asset=a,e.root=o),o._prefab&&e.instance&&(e.instance.prefabRootNode=o)):e=initNodePrefabInfo(n,o,a),e){if(i.nodeFileIdGenerator?e.fileId=i.nodeFileIdGenerator(n):e.fileId=e.fileId||n.uuid,n.components&&n.components.length)for(let e=0;e<n.components.length;e++){var r=n.components[e];r.__prefab||(r.__prefab=new CompPrefabInfo),r.__prefab&&(i.compFileIdGenerator?r.__prefab.fileId=i.compFileIdGenerator(r,e):r.__prefab.fileId=r.__prefab.fileId||r.uuid)}return!!t||void 0}}}):console.error("addPrefabInfo without a rootNode")}function checkAndStripNode(a,i=void 0){const f={};return walkNode(a,function(o){if(o.objFlags&cc.Object.Flags.HideInHierarchy){if(!o.isPrivatePreview){o._id="";for(let e=0;e<o.components.length;++e){var n=o.components[e];DontClearIDComponentNames.includes(cc_1.js.getClassName(n))||(n._id="")}}}else{visitObjTypeReferences(o,function(e,n,t){let r=!1;t instanceof cc.Component.EventHandler?t=t.target:t instanceof cc.Component&&(t=t.node),(r=t&&t instanceof cc.Node&&!t.isChildOf(a)?!0:r)&&(e[n]instanceof cc.Component.EventHandler?e[n]=new cc.Component.EventHandler:(o._prefab?.fileId&&e.__prefab?.fileId&&(f[o._prefab.fileId]={path:n,component:e.__prefab.fileId,value:e[n]}),e[n]=null),i||console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',n,e.name||a.name,t.name))}),o._id="";for(let e=0;e<o.components.length;++e)o.components[e]._id=""}}),f}function addPrefabInstance(e){var n,e=e._prefab;e&&!e.instance&&((n=new PrefabInstance).fileId=Uuid.uuid(),e.instance=n)}