"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkAndStripNode=exports.addPrefabInfo=exports.addPrefabInfoToNode=exports.visitObjTypeReferences=exports.walkNode=void 0;const cc_1=require("cc"),{v5:uuidV5}=require("uuid"),uuid_1=require("./uuid"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo,GLTF_PREFAB_NAMESPACE="8fa06a75-f07a-44d4-82cf-d08c3c986599";function walkNode(e,o){o(e);const n=e.children;for(let e=n.length-1;e>=0;--e)walkNode(n[e],o)}function visitObjTypeReferences(e,o){const n=(e,n)=>{const t=(n=n||e.constructor).__values__;for(let n=0;n<t.length;n++){const r=t[n],c=e[r];if(c&&"object"==typeof c)if(Array.isArray(c))for(let e=0;e<c.length;e++)cc.isValid(c)&&o(c,""+e,c[e]);else cc.isValid(c)&&o(e,r,c)}};for(let o=0;o<e.components.length;++o){n(e.components[o])}}function getCompressedUuid(e){let o=uuidV5(e,GLTF_PREFAB_NAMESPACE);return o=uuid_1.compressUuid(o,!0)}function addPrefabInfoToNode(e,o,n,t={}){if(!e)return;if(e._objFlags&cc.Object.Flags.HideInHierarchy)return;let r=e._prefab;const c=null===r||void 0===r?void 0:r.instance;if(r&&c)c.prefabRootNode=o,e===o&&(r.asset=n);else{if(e._prefab||(e._prefab=new PrefabInfo),!(r=e._prefab))return;r.root=o,r.asset=n}let f="";if(t.useNodePathAsFileId){const o=[];let n=e;for(;n;){let e=n.getSiblingIndex();o.push(n.name+e),n=n.parent}const t=getCompressedUuid(f=o.reverse().join("/"));r.fileId=t}else r.fileId=r.fileId?r.fileId:e.uuid;if(e.components&&e.components.length)for(let o=0;o<e.components.length;o++){const n=e.components[o];if(n.__prefab||(n.__prefab=new CompPrefabInfo),n.__prefab)if(t.useNodePathAsFileId){const e=getCompressedUuid(f+"/comp"+o);n.__prefab.fileId=e}else n.__prefab.fileId=n.__prefab.fileId?n.__prefab.fileId:n.uuid}}function addPrefabInfo(e,o,n,t={}){addPrefabInfoToNode(e,o,n,t),e.children.forEach(e=>{addPrefabInfo(e,o,n,t)})}function checkAndStripNode(e,o){walkNode(e,function(n){if(n._objFlags&cc.Object.Flags.HideInHierarchy){if(n.isPrivatePreview)return;n._id="";for(let e=0;e<n.components.length;++e){n.components[e]._id=""}}else{e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0),visitObjTypeReferences(n,function(n,t,r){let c=!1;r instanceof cc.Component.EventHandler?r=r.target:r instanceof cc.Component&&(r=r.node),r&&r instanceof cc._BaseNode&&!r.isChildOf(e)&&(c=!0),c&&(n[t]instanceof cc.Component.EventHandler?n[t]=new cc.Component.EventHandler:n[t]=null,o||console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',t,n.name||e.name,r.name))}),n._id="";for(let e=0;e<n.components.length;++e){const o=n.components[e];o._id="",o[cc_1.editorExtrasTag]&&(o[cc_1.editorExtrasTag].mountedRoot=void 0)}}})}exports.walkNode=walkNode,exports.visitObjTypeReferences=visitObjTypeReferences,exports.addPrefabInfoToNode=addPrefabInfoToNode,exports.addPrefabInfo=addPrefabInfo,exports.checkAndStripNode=checkAndStripNode;