"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getUintArrayCtor=exports.splitBasedOnJoints=exports.forEachFace=exports.calculateTangents=exports.calculateNormals=void 0;const cc_1=require("cc");function forEachFace(e,t,r){let c=0;const a=[];switch(t){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:c=e.length/3;for(let t=0;t<c;t++)a[0]=e[3*t],a[1]=e[3*t+1],a[2]=e[3*t+2],r(a);break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:c=e.length-2;let i=0;for(let t=0;t<c;t++)a[0]=e[t-i],a[1]=e[t+i+1],a[2]=e[t+2],r(a),i=~i;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:c=e.length-1;const o=e[0];for(let t=1;t<c;t++)a[0]=o,a[1]=e[t],a[2]=e[t+1],r(a);break;case cc_1.gfx.PrimitiveMode.LINE_LIST:c=e.length/2;for(let t=0;t<c;t++)a[0]=e[2*t],a[1]=e[2*t+1],r(a);break;case cc_1.gfx.PrimitiveMode.LINE_STRIP:c=e.length-1;for(let t=0;t<c;t++)a[0]=e[t],a[1]=e[t+1],r(a);break;case cc_1.gfx.PrimitiveMode.LINE_LOOP:c=e.length;for(let t=0;t<c;t++)a[0]=e[t],a[1]=e[t+1===c?0:t+1],r(a);break;case cc_1.gfx.PrimitiveMode.POINT_LIST:c=e.length;for(let t=0;t<c;t++)a[0]=e[t],r(a)}}function getUintArrayCtor(e){return e<1<<8*Uint8Array.BYTES_PER_ELEMENT?Uint8Array:e<1<<8*Uint16Array.BYTES_PER_ELEMENT?Uint16Array:Uint32Array}exports.calculateNormals=(()=>{const{Vec3:e}=cc,t=new e,r=new e,c=new e,a=new e,i=new e,o=new e;return(n,s,l=[])=>{const f=s.length/3,d=n.length/3,m=Array(3*d).fill(0).map(()=>new e);for(let l=0;l<f;++l){const f=s[3*l+0],d=s[3*l+1],_=s[3*l+2];e.fromArray(t,n,3*f),e.fromArray(r,n,3*d),e.fromArray(c,n,3*_),e.subtract(a,r,t),e.subtract(i,c,t),e.cross(o,a,i),e.add(m[f],m[f],o),e.add(m[d],m[d],o),e.add(m[_],m[_],o)}for(let t=0;t<d;++t)e.toArray(l,e.normalize(o,m[t]),3*t);return l}})(),exports.calculateTangents=(()=>{const{Vec2:e,Vec3:t}=cc,r=new t,c=new t,a=new t,i=new t,o=new t,n=new e,s=new e,l=new e,f=new t,d=new t,m=new t,_=new t;return(u,g,y,x,A=[])=>{const I=g.length/3,T=u.length/3,E=Array(T).fill(0).map(()=>new t),P=Array(T).fill(0).map(()=>new t);for(let y=0;y<I;++y){const A=g[3*y+0],I=g[3*y+1],T=g[3*y+2];t.fromArray(r,u,3*A),t.fromArray(c,u,3*I),t.fromArray(a,u,3*T),e.fromArray(n,x,2*A),e.fromArray(s,x,2*I),e.fromArray(l,x,2*T),t.subtract(i,c,r),t.subtract(o,a,r);const L=s.x-n.x,S=l.x-n.x,p=s.y-n.y,h=l.y-n.y;let w=L*h-S*p;0!==w&&(w=1/w),t.multiplyScalar(f,t.subtract(m,t.multiplyScalar(m,i,h),t.multiplyScalar(_,o,p)),w),t.multiplyScalar(d,t.subtract(m,t.multiplyScalar(m,o,L),t.multiplyScalar(_,i,S)),w),t.add(E[A],E[A],f),t.add(E[I],E[I],f),t.add(E[T],E[T],f),t.add(P[A],P[A],d),t.add(P[I],P[I],d),t.add(P[T],P[T],d)}for(let e=0;e<T;++e){const r=E[e],c=P[e],a=t.fromArray(m,y,3*e);t.subtract(_,r,t.multiplyScalar(_,a,t.dot(r,a)/t.dot(a,a))),0==t.dot(_,_)&&(a.x||a.z?t.set(_,a.z,0,-a.x):t.set(_,0,a.x,-a.y)),t.toArray(A,t.normalize(_,_),4*e),A[4*e+3]=t.dot(t.cross(_,c,r),a)>0?1:-1}return A}})(),exports.forEachFace=forEachFace,exports.splitBasedOnJoints=(()=>{class e{constructor(e=cc_1.gfx.PrimitiveMode.TRIANGLE_LIST){this.indices=[],this.jointSet=new Set,this.primitiveMode=e}}return(t,r,c,a)=>{let i;switch(c){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:i=cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;break;case cc_1.gfx.PrimitiveMode.LINE_LIST:case cc_1.gfx.PrimitiveMode.LINE_STRIP:case cc_1.gfx.PrimitiveMode.LINE_LOOP:i=cc_1.gfx.PrimitiveMode.LINE_LIST;break;case cc_1.gfx.PrimitiveMode.POINT_LIST:i=cc_1.gfx.PrimitiveMode.POINT_LIST}if(void 0===i)return[];const o=[new e(i)];let n=o[0];return forEachFace(r,c,r=>{(function(e,t,r,c){let a=0;for(let c=0;c<r.length;c++){const i=r[c];for(let r=0;r<4;r++)e.jointSet.has(t[4*i+r])||a++}return e.jointSet.size+a<=c})(n,t,r,a)||(n=new e(i),o.push(n)),function(e,t,r){for(let c=0;c<r.length;c++){const a=r[c];for(let r=0;r<4;r++)e.jointSet.add(t[4*a+r]);e.indices.push(a)}}(n,t,r)}),o}})(),exports.getUintArrayCtor=getUintArrayCtor;