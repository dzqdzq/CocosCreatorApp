"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,s){void 0===s&&(s=t),Object.defineProperty(e,s,{enumerable:!0,get:function(){return i[t]}})}:function(e,i,t,s){void 0===s&&(s=t),e[s]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.serialize=void 0;const cc=__importStar(require("cc")),uuid_1=require("../uuid"),nicifySerialized=require("./serialize-nicify"),PRESERVE_PROPS_FOR_SYNCABLE_PREFAB=["_objFlags","_parent","_prefab"],PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT=PRESERVE_PROPS_FOR_SYNCABLE_PREFAB.concat("_name","_active","_lpos","_lrot","_euler");class Serializer{constructor(e,i){this.serializedList=[],this._parsingObjs=[],this._parsingData=[],this._objsToResetId=[],i=i||{},this._exporting=!!i.exporting,this._discardInvalid=!("discardInvalid"in i)||i.discardInvalid,this._dontStripDefault=!this._exporting||!("dontStripDefault"in i)||i.dontStripDefault,this._missingClassReporter=i.missingClassReporter,this._missingObjectReporter=i.missingObjectReporter,this._assetExists=this._missingObjectReporter&&{},this.serializedList=[],this._parsingObjs=[],this._parsingData=[],this._objsToResetId=[],this._discardContentsForSyncablePrefab=!(i.reserveContentsForSyncablePrefab||e instanceof cc.Prefab),this._serializeMainObj(e);for(let e=0;e<this._objsToResetId.length;++e)"__id__"in this._objsToResetId[e]&&(this._objsToResetId[e].__id__=void 0);this._parsingObjs=null,this._parsingData=null,this._objsToResetId=null}_serializeMainObj(e){if(e&&(e instanceof cc.CCObject||cc.CCClass._isCCClass(e.constructor)))this._serializeObj(e);else if(e&&"object"==typeof e){let i;if(Array.isArray(e))i=[];else{i={};const t=cc.js._getClassId(e,!1);if(t&&(i.__type__=t),e._serialize)return i.content=e._serialize(),void this.serializedList.push(i)}this._objsToResetId.push(e),this.serializedList.push(i),this._enumerateObject(e,i)}else this.serializedList.push(e||null)}_serializeObj(e){if(e instanceof cc.ValueType)return this._serializePrimitiveObj(e);const i=cc.js._getClassId(e,!1),t=e.constructor,s=e instanceof cc.CCObject,r=null===t||void 0===t?void 0:t.__props__;if(s||cc.CCClass._isCCClass(t)||r){const t=this.serializedList.length;e.__id__=t,this._objsToResetId.push(e);const r={};return this.serializedList.push(r),i&&(r.__type__=i),e._serialize?r.content=e._serialize():(this._enumerateObject(e,r),s&&e._objFlags>0&&(r._objFlags&=cc.CCObject.Flags.PersistentMask)),{__id__:t}}if(ArrayBuffer.isView(e))return{__type__:"TypedArray",ctor:e.constructor.name,array:Array.from(e)};if(!t||t===Object||Array.isArray(e)||i){if(e._serialize)return i?{content:e._serialize(),__type__:i}:{content:e._serialize()};{const t=this._checkCircularReference(e);if(t){const s=this.serializedList.length;return e.__id__=s,this._objsToResetId.push(e),!1===Array.isArray(e)&&i&&(t.__type__=i),this.serializedList.push(t),{__id__:s}}return this._serializePrimitiveObj(e)}}}_enumerateObject(e,i){if(Array.isArray(e)){for(let s=0;s<e.length;++s){var t=this._serializeField(e[s]);void 0!==t&&i.push(t)}return}const s=e.constructor;if(cc.Node&&cc.Node.isNode(e))return void this._serializeNode(e,i,s);const r=s&&s.__props__;if(r){let t;e._onBeforeSerialize&&(t=e._onBeforeSerialize(r)),r.length>0&&("_$erialized"!==r[r.length-1]?this._enumerateByFireClass(e,i,s,t):e._$erialized&&(i.__type__=e._$erialized.__type__,this._enumerateObject(e._$erialized,i),this._missingClassReporter&&this._missingClassReporter(e,i.__type__)))}else for(const t in e)e.hasOwnProperty&&!e.hasOwnProperty(t)||95===t.charCodeAt(0)&&95===t.charCodeAt(1)||(i[t]=this._serializeField(e[t]))}_enumerateByFireClass(e,i,t,s){const r=cc.CCClass.Attr.getClassAttrs(t),n=s||t.__props__;for(let t=0;t<n.length;t++){const s=n[t];if(!1===r[s+cc.CCClass.Attr.DELIMETER+"serializable"])continue;const a=e[s];if(this._exporting){if(r[s+cc.CCClass.Attr.DELIMETER+"editorOnly"])continue;if(!this._dontStripDefault&&equalsToDefault(r[s+cc.CCClass.Attr.DELIMETER+"default"],a))continue}i[s]=this._serializeField(a);const _=r[s+cc.CCClass.Attr.DELIMETER+"formerlySerializedAs"];_&&(i[_]=i[s])}if(cc.BaseNode&&e instanceof cc.BaseNode||cc.Component&&e instanceof cc.Component){if(this._exporting){if(!(e instanceof cc.BaseNode&&e._parent instanceof cc.Scene))return;if(!this._dontStripDefault&&!e._id)return}i._id=e._id}}_serializeField(e){const i=typeof e;if("object"===i){if(!e)return null;const i=e.__id__;if(void 0!==i)return{__id__:i};if(e instanceof cc.CCObject){if(e instanceof cc.Asset){let i=e._uuid;return i?(this.checkMissingAsset(e,i),this._exporting&&(i=uuid_1.compressUuid(i,!0)),{__uuid__:i,__expectedType__:cc.js._getClassId(e.constructor)}):(this.checkMissingAsset(e,""),null)}const i=e._objFlags;if(this._exporting&&i&cc.CCObject.Flags.EditorOnly)return;if(this._discardInvalid){if(i&cc.CCObject.Flags.DontSave)return;if(!e.isValid)return this._missingObjectReporter&&this._missingObjectReporter(e),null}else{if(i&cc.CCObject.Flags.DontSave&&i&cc.CCObject.Flags.DontDestroy)return;if(!e.isRealValid)return null}if(cc.Node&&cc.Node.isNode(e)){if(this._canDiscardByPrefabRoot(e)&&e!==e._prefab.root)return null}}return this._serializeObj(e)}return"function"!==i?e:null}_serializePrimitiveObj(e){let i;if(Array.isArray(e))i=[];else{i={};const t=cc.js._getClassId(e,!1);t&&(i.__type__=t)}const t=this.serializedList.length;if(this._parsingObjs.push(e),this._parsingData.push(i),this._enumerateObject(e,i),this._parsingObjs.pop(),this._parsingData.pop(),this.serializedList.length>t){const e=this.serializedList.indexOf(i,t);if(-1!==e)return{__id__:e}}return i}_serializeNode(e,i,t){if(e._onBeforeSerialize&&e._onBeforeSerialize(),this._canDiscardByPrefabRoot(e)){e._prefab.root===e&&this._enumerateByFireClass(e,i,t,PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT)}else this._enumerateByFireClass(e,i,t)}checkMissingAsset(e,i){if(this._missingObjectReporter){this._assetExists[i]||this._missingObjectReporter(e)}}_canDiscardByPrefabRoot(e){const i=e._prefab;return this._discardContentsForSyncablePrefab&&i&&i.root&&i.root._prefab.sync}_checkCircularReference(e){const i=this._parsingObjs.indexOf(e);if(-1!==i)return this._parsingData[i]}}function isInteger(e){return(0|e)===e}function toFixed(e,i){return parseFloat(e.toFixed(0|i))}function equalsToDefault(e,i){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===i)return!0;if(e&&i){if(e instanceof cc.ValueType&&e.equals(i))return!0;if(Array.isArray(e)&&Array.isArray(i)||e.constructor===Object&&i.constructor===Object)try{return Array.isArray(e)&&Array.isArray(i)&&0===e.length&&0===i.length}catch(e){}}return!1}function serialize(e,i){const t=!("stringify"in(i=i||{}))||i.stringify,s=i.minify,r=s||i.nicify,n=new Serializer(e,i).serializedList;let a;return r&&nicifySerialized(n),a=1!==n.length||Array.isArray(n[0])?n:n[0],!1===t?a:JSON.stringify(a,null,s?0:2)}exports.serialize=serialize,serialize.asAsset=function(e,i=cc.Asset){if(!e)return cc.error("[EditorExtends.serialize.asAsset] The uuid must be non-nil!"),null;const t=new i;return t._uuid=e,t},serialize.setName=function(e,i){Array.isArray(e)?e[0]._name=i:e._name=i},serialize.findRootObject=function(e,i){if(Array.isArray(e))for(let t=0;t<e.length;t++){const s=e[t];if(s.__type__===i)return s}else if(e.__type__===i)return e;return null};