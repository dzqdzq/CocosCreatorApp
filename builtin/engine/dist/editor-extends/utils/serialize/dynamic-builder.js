"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.findRootObject=exports.setName=exports.asAsset=void 0;const cc_1=require("cc"),serialization_1=require("cc/editor/serialization");class DynamicBuilder{constructor(e){var t;this.serializedList=[],this._mainBufferBuilder=new serialization_1.BufferBuilder,e=e||{},this.stringify=!("stringify"in e&&!e.stringify),this.minify=!!e.minify,this.forceInline=!!e.forceInline,this._useCCON=null!==(t=e.useCCON)&&void 0!==t&&t}setProperty_Array(e,t,r,i){return this.addObject(i.writeOnlyArray,t,r,i.formerlySerializedAs,!1)}setProperty_Dict(e,t,r,i){return this.addObject({},t,r,null===i||void 0===i?void 0:i.formerlySerializedAs,!1)}addObject(e,t,r,i,s){let a=-1,n=e;const o=!t;return(!this.forceInline&&s||o)&&(a=this.serializedList.length,this.serializedList.push(e),this.forceInline||(n={__id__:a})),t&&(t.data[r]=n,i&&(t.data[i]=n)),{data:e,id:a}}setProperty_Class(e,t,r,i){var s;const a={__type__:i.type};return this.addObject(a,t,r,i.formerlySerializedAs,!(null!==(s=i.uniquelyReferenced)&&void 0!==s&&s))}setProperty_CustomizedClass(e,t,r,i){const s={__type__:i.type,content:i.content};return this.addObject(s,t,r,i.formerlySerializedAs,!0)}setProperty_ParsedObject(e,t,r,i){!this.forceInline&&r.id>=0?e.data[t]={__id__:r.id}:e.data[t]=r.data,i&&(e.data[i]=e.data[t])}setProperty_Raw(e,t,r,i,s){t.data[r]=i,(null===s||void 0===s?void 0:s.formerlySerializedAs)&&(t.data[s.formerlySerializedAs]=i)}setProperty_ValueType(e,t,r,i,s){const a={__type__:cc_1.js.getClassId(i,!1)},n=i.constructor.__values__;if(n)for(let e=0;e<n.length;e++){const t=n[e];a[t]=i[t]}return t?(t.data[r]=a,(null===s||void 0===s?void 0:s.formerlySerializedAs)&&(t.data[s.formerlySerializedAs]=a),{data:a,id:-1}):(this.serializedList.push(a),{data:a,id:0})}setProperty_TypedArray(e,t,r,i,s){let a;if(this._useCCON){const e=i instanceof DataView;e||this._mainBufferBuilder.alignAs(i.constructor.BYTES_PER_ELEMENT);const t=this._mainBufferBuilder.append(i);a={__type__:"TypedArrayRef",ctor:i.constructor.name,offset:t,length:e?i.byteLength:i.length}}else a={__type__:"TypedArray",ctor:i.constructor.name,array:Array.from(i)};t?(t.data[r]=a,(null===s||void 0===s?void 0:s.formerlySerializedAs)&&(t.data[s.formerlySerializedAs]=a)):this.serializedList.push(a)}setProperty_AssetUuid(e,t,r,i,s){t.data[r]={__uuid__:i},(null===s||void 0===s?void 0:s.formerlySerializedAs)&&(t.data[s.formerlySerializedAs]=t.data[r]),(null===s||void 0===s?void 0:s.expectedType)&&(t.data[r].__expectedType__=s.expectedType)}setRoot(e){console.assert(0===e.id,`Wrong root object to serialize, id is ${e.id}`)}dump(){return this._useCCON?this._dumpAsCCON():this._dumpAsJson()}_dumpAsJson(){const e=this._getMainJsonData();return this.stringify?JSON.stringify(e,null,this.minify?0:2):e}_dumpAsCCON(){const e=this._getMainJsonData(),{_mainBufferBuilder:t}=this,r=0===t.byteLength?[]:[t.get()];return new serialization_1.CCON(e,r)}_getMainJsonData(){const e=this.serializedList;let t;return t=1!==e.length||Array.isArray(e[0])?e:e[0]}}function asAsset(e,t=cc_1.Asset){if(!e)return(0,cc_1.error)("[EditorExtends.serialize.asAsset] The uuid must be non-nil!"),null;const r=new t;return r._uuid=e,r}function setName(e,t){Array.isArray(e)?e[0]._name=t:e._name=t}function findRootObject(e,t){if(Array.isArray(e))for(let r=0;r<e.length;r++){const i=e[r];if(i.__type__===t)return i}else if(e.__type__===t)return e;return null}exports.default=DynamicBuilder,exports.asAsset=asAsset,exports.setName=setName,exports.findRootObject=findRootObject;