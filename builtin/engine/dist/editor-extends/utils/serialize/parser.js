"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const _=require("lodash"),cc_1=require("cc"),cc=__importStar(require("cc")),uuid_1=require("../uuid"),builder_1=__importDefault(require("./compiled/builder")),dynamic_builder_1=__importDefault(require("./dynamic-builder")),{PersistentMask:PersistentMask,DontSave:DontSave,DontDestroy:DontDestroy,EditorOnly:EditorOnly}=cc_1.CCObject.Flags,getDefault=cc_1.CCClass.getDefault,PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT=["_objFlags","_parent","_prefab"],Attr=cc_1.CCClass.Attr,EDITOR_ONLY=Attr.DELIMETER+"editorOnly",DEFAULT=Attr.DELIMETER+"default",FORMERLY_SERIALIZED_AS=Attr.DELIMETER+"formerlySerializedAs";function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof cc_1.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return cc_1.js.isEmptyObject(e)&&cc_1.js.isEmptyObject(t)}return!1}function isSerializableClass(e,t){if(!t)return!1;if(cc_1.CCClass._isCCClass(t))return!0;return t.__values__&&cc_1.js._getClassId(e,!1)}function isSyncPrefab(e){var t,s,r;return null===(r=null===(s=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.root)||void 0===s?void 0:s._prefab)||void 0===r?void 0:r.instance}class Parser{constructor(e,t){this.parsingInfos=new Map,t=t||{},this.exporting=!!t._exporting,this.mustCompresseUuid=!!t.compressUuid,this.discardInvalid=!("discardInvalid"in t)||!!t.discardInvalid,this.dontStripDefault=!(this.exporting&&"dontStripDefault"in t&&!t.dontStripDefault),this.missingClassReporter=t.missingClassReporter,this.missingObjectReporter=t.missingObjectReporter,this.reserveContentsForAllSyncablePrefab=!!t.reserveContentsForSyncablePrefab,this.builder=e,this.assetExists=this.missingObjectReporter&&Object.create(null),this.customExportingCtxCache=this.exporting?{_depends:[],dependsOn(e,t){this._compressUuid&&(t=uuid_1.compressUuid(t,!0)),this._depends.push(e,t)},_compressUuid:this.mustCompresseUuid}:null}parse(e){e instanceof cc.Prefab&&(this.prefabRoot=e.data);const t=this.parseObjField(null,null,"",e,null);this.builder.setRoot(t)}checkMissingAsset(e,t){if(this.missingObjectReporter){this.assetExists[t]||this.missingObjectReporter(e)}}isObjRemoved(e){if(e instanceof cc_1.CCObject){const t=e._objFlags;if(this.exporting&&t&EditorOnly)return!0;if(t&DontSave){if(this.discardInvalid)return!0;if(t&DontDestroy)return!0}}return!1}setParsedObj(e,t,s,r){if(s&&"object"==typeof s){const i=this.parsingInfos.get(s);if(i)return this.builder.setProperty_ParsedObject(e,t,i,r),!0}return!1}verifyNotParsedValue(e,t,s){var r;const i=typeof s;if("object"===i){if(!s)return null;if(s instanceof cc_1.CCObject){if(s instanceof cc_1.Asset){const e=s._uuid;return e?(this.checkMissingAsset(s,e),s):null}if(this.discardInvalid){if(!s.isValid)return null===(r=this.missingObjectReporter)||void 0===r||r.call(this,s),null}else if(!s.isRealValid)return null;if(cc_1.Node&&cc_1.Node.isNode(s)){if(this.canDiscardByPrefabRoot(s)&&s!==s._prefab.root)return null}if(s instanceof cc_1.Component){if(s.node&&this.canDiscardByPrefabRoot(s.node))return null}}return s}return"function"!==i?e instanceof cc_1.CCObject&&"_objFlags"===t&&s>0?s&PersistentMask:s:null}canDiscardByPrefabRoot(e){return!(this.reserveContentsForAllSyncablePrefab||!isSyncPrefab(e)||this.prefabRoot===e)}enumerateClass(e,t,s,r,i){const n=Attr.getClassAttrs(s),o=r||s.__values__;for(let s=0;s<o.length;s++){const r=o[s];let i=e[r];if(this.isObjRemoved(i))continue;if(this.exporting&&n[r+EDITOR_ONLY])continue;const a=n[r+FORMERLY_SERIALIZED_AS];if(this.setParsedObj(t,r,i,a))continue;i=this.verifyNotParsedValue(e,r,i);const l=getDefault(n[r+DEFAULT]);this.exporting&&!this.dontStripDefault&&equalsToDefault(l,i)||this.parseField(e,t,r,i,{formerlySerializedAs:a,defaultValue:l})}if(cc_1.BaseNode&&e instanceof cc_1.BaseNode||cc_1.Component&&e instanceof cc_1.Component){if(this.exporting){if(!(e instanceof cc_1.BaseNode&&e._parent instanceof cc.Scene))return;if(!this.dontStripDefault&&!e._id)return}this.builder.setProperty_Raw(e,t,"_id",e._id)}}static isDefaultTrs(e){return 0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&0===e[5]&&1===e[6]&&1===e[7]&&1===e[8]&&1===e[9]}enumerateNode(e,t,s,r){if(this.canDiscardByPrefabRoot(e)){const r=e._prefab.root===e;r&&this.enumerateClass(e,t,s,PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT,r)}else this.enumerateClass(e,t,s)}parseField(e,t,s,r,i){const n=typeof r;if("object"===n){if(!r)return void this.builder.setProperty_Raw(e,t,s,null,i);if(r instanceof cc_1.Asset&&e){let n=r._uuid;return this.mustCompresseUuid&&(n=uuid_1.compressUuid(n,!0)),void this.builder.setProperty_AssetUuid(e,t,s,n,i)}this.parseObjField(e,t,s,r,i)}else"function"!==n?this.builder.setProperty_Raw(e,t,s,r,i):this.builder.setProperty_Raw(e,t,s,null,i)}parseObjField(e,t,s,r,i){const n=r.constructor;if(isSerializableClass(r,n)){if(r instanceof cc_1.ValueType){const n=this.builder.setProperty_ValueType(e,t,s,r,i);if(n)return n}if(r._serialize){const o=i||{};o.content=r._serialize(this.customExportingCtxCache),o.type=cc.js._getClassId(n,!1);const a=this.builder.setProperty_CustomizedClass(e,t,s,o);if(this.parsingInfos.set(r,a),this.customExportingCtxCache){const e=this.customExportingCtxCache._depends;for(let t=0;t<e.length;t+=2)this.builder.setProperty_AssetUuid(r,a,e[t],e[t+1],null);e.length=0}return a}{let o=n.__values__;r._onBeforeSerialize&&(o=r._onBeforeSerialize(o)||o);const a=i||{};if(a.type=cc.js._getClassId(n,!1),o.length>0){if(cc_1.Node&&cc_1.Node.isNode(r)){const i=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(r,i),this.enumerateNode(r,i,n,o),i}if("_$erialized"!==o[o.length-1]){const i=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(r,i),this.enumerateClass(r,i,n,o),i}if(r._$erialized){const i=r._$erialized,n=i.__type__;a.type=n;const o=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(r,o),this.enumerateDict(i,o),this.missingClassReporter&&this.missingClassReporter(r,n),o}return cc.error(`Lost serialized data of ${r}`),null}{const i=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(r,i),i}}}if(ArrayBuffer.isView(r))return cc_1.Node&&cc_1.Node.isNode(e)&&"_trs"===s&&Parser.isDefaultTrs(r)?null:(this.builder.setProperty_TypedArray(e,t,s,r,i),null);if(n&&n!==Object&&!Array.isArray(r)){if(!e)throw new Error(`Unknown object to serialize: ${r}`);return null}if(Array.isArray(r)){const n=r.filter(e=>!this.isObjRemoved(e)),o=i||{};o.writeOnlyArray=n;const a=this.builder.setProperty_Array(e,t,s,o);this.parsingInfos.set(r,a);for(let e=0;e<n.length;++e){let t=n[e];this.setParsedObj(a,e,t,null)||(t=this.verifyNotParsedValue(r,e,t),this.parseField(r,a,e,t,null))}return a}{const n=this.builder.setProperty_Dict(e,t,s,i);return this.parsingInfos.set(r,n),this.enumerateDict(r,n),n}}enumerateDict(e,t){for(const s in e){if(e.hasOwnProperty&&!e.hasOwnProperty(s)||95===s.charCodeAt(0)&&95===s.charCodeAt(1))continue;let r=e[s];if(this.isObjRemoved(r))r=null;else{if(this.setParsedObj(t,s,r,null))continue;r=this.verifyNotParsedValue(e,s,r)}this.parseField(e,t,s,r,null)}}}function serialize(e,t){let s;return"compiled"===(t=t||{}).builder?(t._exporting=!0,s=new builder_1.default(t)):s=new dynamic_builder_1.default(t),new Parser(s,t).parse(e),e=null,s.dump()}exports.Parser=Parser,exports.default=serialize;