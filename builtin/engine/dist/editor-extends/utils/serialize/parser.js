"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const _=require("lodash"),cc_1=require("cc"),cc=__importStar(require("cc")),uuid_1=require("../uuid"),populate_internal_constants_1=require("cc/editor/populate-internal-constants"),builder_1=__importDefault(require("./compiled/builder")),dynamic_builder_1=__importDefault(require("./dynamic-builder")),{PersistentMask:PersistentMask,DontSave:DontSave,DontDestroy:DontDestroy,EditorOnly:EditorOnly,IsClientLoad:IsClientLoad}=cc_1.CCObject.Flags,getDefault=cc_1.CCClass.getDefault,Attr=cc_1.CCClass.Attr,EDITOR_ONLY=Attr.DELIMETER+"editorOnly",DEFAULT=Attr.DELIMETER+"default",FORMERLY_SERIALIZED_AS=Attr.DELIMETER+"formerlySerializedAs";function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof cc_1.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return cc_1.js.isEmptyObject(e)&&cc_1.js.isEmptyObject(t)}return!1}function isSerializableClass(e,t){if(!t)return!1;if(cc_1.CCClass._isCCClass(t))return!0;return t.__values__&&cc_1.js._getClassId(e,!1)}function isSyncPrefab(e){var t,r,i,s;return(null===(i=null===(r=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.root)||void 0===r?void 0:r._prefab)||void 0===i?void 0:i.instance)&&((null===(s=null===e||void 0===e?void 0:e._prefab)||void 0===s?void 0:s.instance)||!isMountedChild(e))}function isMountedChild(e){var t;return!!(null===(t=e[cc_1.editorExtrasTag])||void 0===t?void 0:t.mountedRoot)}class Parser{constructor(e,t){var r;this.parsingInfos=new Map,t=t||{},this.exporting=!!t._exporting,this.mustCompresseUuid=!!t.compressUuid,this.discardInvalid=!("discardInvalid"in t)||!!t.discardInvalid,this.dontStripDefault=!(this.exporting&&"dontStripDefault"in t&&!t.dontStripDefault),this.missingClassReporter=t.missingClassReporter,this.missingObjectReporter=t.missingObjectReporter,this.reserveContentsForAllSyncablePrefab=!!t.reserveContentsForSyncablePrefab;const i={};i[cc.Node.reserveContentsForAllSyncablePrefabTag]=this.reserveContentsForAllSyncablePrefab,this._serializationContext={root:this.prefabRoot,toCCON:null!==(r=t.useCCON)&&void 0!==r&&r,customArguments:i},this.builder=e,this.keepNodeUuid=!!t.keepNodeUuid,this.assetExists=this.missingObjectReporter&&Object.create(null),this.customExportingCtxCache=this.exporting?{_depends:[],dependsOn(e,t){this._compressUuid&&(t=uuid_1.compressUuid(t,!0)),this._depends.push(e,t)},_compressUuid:this.mustCompresseUuid}:null}parse(e){e instanceof cc.Prefab&&(this.prefabRoot=e.data);const t=this.parseObjField(null,null,"",e,null);this.builder.setRoot(t)}checkMissingAsset(e,t){if(this.missingObjectReporter){this.assetExists[t]||this.missingObjectReporter(e)}}isObjRemoved(e){if(e instanceof cc_1.CCObject){const t=e.objFlags;if(this.exporting&&(t&EditorOnly||populate_internal_constants_1.SERVER_MODE&&!(t|IsClientLoad)))return!0;if(t&DontSave){if(this.discardInvalid)return!0;if(t&DontDestroy)return!0}}return!1}setParsedObj(e,t,r,i){if(r&&"object"==typeof r){const s=this.parsingInfos.get(r);if(s)return this.builder.setProperty_ParsedObject(e,t,s,i),!0}return!1}verifyNotParsedValue(e,t,r){var i,s;const n=typeof r;if("object"===n){if(!r)return null;if(r instanceof cc_1.CCObject){if(r instanceof cc_1.Asset){const e=r._uuid;return e?(this.checkMissingAsset(r,e),r):null}if(this.discardInvalid){if(!r.isValid)return null===(i=this.missingObjectReporter)||void 0===i||i.call(this,r),null}else if(!r.isRealValid)return null;if(cc_1.Node&&cc_1.Node.isNode(r)){if(this.canDiscardByPrefabRoot(r)&&r!==r._prefab.root)return null}if(r instanceof cc_1.Component){if(r.node&&this.canDiscardByPrefabRoot(r.node)&&!(null===(s=r[cc_1.editorExtrasTag])||void 0===s?void 0:s.mountedRoot))return null}}return r}return"function"!==n?e instanceof cc_1.CCObject&&"_objFlags"===t&&r>0?r&PersistentMask:r:null}canDiscardByPrefabRoot(e){return!(this.reserveContentsForAllSyncablePrefab||!isSyncPrefab(e)||this.prefabRoot===e)}enumerateClass(e,t,r,i,s){const n=Attr.getClassAttrs(r),o=i||r.__values__;for(let r=0;r<o.length;r++){const i=o[r];let s=e[i];if(this.isObjRemoved(s))continue;if(this.exporting&&n[i+EDITOR_ONLY])continue;const c=n[i+FORMERLY_SERIALIZED_AS];if(this.setParsedObj(t,i,s,c))continue;s=this.verifyNotParsedValue(e,i,s);const a=getDefault(n[i+DEFAULT]);this.exporting&&!this.dontStripDefault&&equalsToDefault(a,s)||this.parseField(e,t,i,s,{formerlySerializedAs:c,defaultValue:a})}if(cc_1.BaseNode&&e instanceof cc_1.BaseNode||cc_1.Component&&e instanceof cc_1.Component){if(this.exporting){if(!this.keepNodeUuid){if(!(e instanceof cc_1.BaseNode&&e._parent instanceof cc.Scene))return}if(this.prefabRoot)return;if(!this.dontStripDefault&&!e._id)return}this.builder.setProperty_Raw(e,t,"_id",e._id)}}static isDefaultTrs(e){return 0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&0===e[5]&&1===e[6]&&1===e[7]&&1===e[8]&&1===e[9]}parseField(e,t,r,i,s){const n=typeof i;if("object"===n){if(!i)return void this.builder.setProperty_Raw(e,t,r,null,s);if(i instanceof cc_1.Asset&&e){let n=i._uuid;return this.mustCompresseUuid&&(n=uuid_1.compressUuid(n,!0)),(s=s||{}).expectedType=cc_1.js._getClassId(i.constructor),void this.builder.setProperty_AssetUuid(e,t,r,n,s)}this.parseObjField(e,t,r,i,s)}else"function"!==n?this.builder.setProperty_Raw(e,t,r,i,s):this.builder.setProperty_Raw(e,t,r,null,s)}parseObjField(e,t,r,i,s){const n=i.constructor;if(isSerializableClass(i,n)){const o=e=>{let t=n.__values__;i._onBeforeSerialize&&(t=i._onBeforeSerialize(t)||t);try{n!==cc_1.cclegacy._MissingScript||0!==t.length&&"_$erialized"===t[t.length-1]||(cc.error(`The '_$erialized' prop in '${i.name}' is missing. Will force the raw data to be read.`),cc.error(`    Error props: ['${t}'], raw props: ['${n.__values__}']. Please contact jare.`),t.push("_$erialized"))}catch(e){cc.warn(`Error when checking MissingScript 3, ${e}`)}if(0===t.length)return;if("_$erialized"!==t[t.length-1])return void this.enumerateClass(i,e,n,t);try{if(!i._$erialized)return void cc.error(`The formerly serialized data is not found from '${i.name}'. Please check the previous error report.`)}catch(e){cc.warn(`Error when checking MissingScript 2, ${e}`)}const r=i._$erialized,s=r.__type__;this.enumerateDict(r,e),this.missingClassReporter&&this.missingClassReporter(i,s)},c=()=>{var c;const a=s||{},l=i._$erialized?i._$erialized.__type__:cc.js._getClassId(n,!1);a.type=l,a.uniquelyReferenced=null===(c=cc.getSerializationMetadata(n))||void 0===c?void 0:c.uniquelyReferenced;const u=this.builder.setProperty_Class(e,t,r,a);if(this.parsingInfos.set(i,u),!i[cc.serializeTag])return o(u),u;try{if(i instanceof cc_1.cclegacy._MissingScript)return cc.error("Should not declare CustomSerializable on MissingScript. Please contact jare."),o(u),u}catch(e){cc.warn(`Error when checking MissingScript 1, ${e}`)}const d={writeProperty:(e,t)=>{this.isObjRemoved(t)||this.setParsedObj(u,e,t,null)||this.parseField(i,u,e,t,{})},writeThis:()=>o(u),writeSuper:()=>{const e=cc_1.js.getSuper(n);if(!e)return;const t=e.__values__;t&&this.enumerateClass(i,u,n,t)}};return i[cc.serializeTag](d,this._serializationContext),u};if(i instanceof cc_1.ValueType){const n=this.builder.setProperty_ValueType(e,t,r,i,s);if(n)return n}try{i instanceof cc_1.cclegacy._MissingScript&&i._serialize&&(cc.error("Should not declare _serialize on MissingScript. Please contact jare."),i._serialize=void 0)}catch(e){cc.warn(`Error when checking MissingScript 0, ${e}`)}if(i._serialize){const o=s||{};o.content=i._serialize(this.customExportingCtxCache),o.type=cc.js._getClassId(n,!1);const c=this.builder.setProperty_CustomizedClass(e,t,r,o);if(this.parsingInfos.set(i,c),this.customExportingCtxCache){const e=this.customExportingCtxCache._depends;for(let t=0;t<e.length;t+=2)this.builder.setProperty_AssetUuid(i,c,e[t],e[t+1],null);e.length=0}return c}return c()}if(ArrayBuffer.isView(i))return cc_1.Node&&cc_1.Node.isNode(e)&&"_trs"===r&&Parser.isDefaultTrs(i)?null:(this.builder.setProperty_TypedArray(e,t,r,i,s),null);if(n&&n!==Object&&!Array.isArray(i)){if(!e)throw new Error(`Unknown object to serialize: ${i}`);return null}if(Array.isArray(i)){const n=i.filter(e=>!this.isObjRemoved(e)),o=s||{};o.writeOnlyArray=n;const c=this.builder.setProperty_Array(e,t,r,o);this.parsingInfos.set(i,c);for(let e=0;e<n.length;++e){let t=n[e];this.setParsedObj(c,e,t,null)||(t=this.verifyNotParsedValue(i,e,t),this.parseField(i,c,e,t,null))}return c}{const n=this.builder.setProperty_Dict(e,t,r,s);return this.parsingInfos.set(i,n),this.enumerateDict(i,n),n}}enumerateDict(e,t){for(const r in e){if(e.hasOwnProperty&&!e.hasOwnProperty(r)||95===r.charCodeAt(0)&&95===r.charCodeAt(1)&&"__prefab"!==r)continue;let i=e[r];if(this.isObjRemoved(i))i=null;else{if(this.setParsedObj(t,r,i,null))continue;i=this.verifyNotParsedValue(e,r,i)}this.parseField(e,t,r,i,null)}}}function serialize(e,t){let r;return"compiled"===(t=t||{}).builder?(t._exporting=!0,r=new builder_1.default(t)):r=new dynamic_builder_1.default(t),new Parser(r,t).parse(e),e=null,r.dump()}exports.Parser=Parser,exports.default=serialize;