"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const _=require("lodash"),cc_1=require("cc"),cc=__importStar(require("cc")),uuid_1=require("../uuid"),populate_internal_constants_1=require("cc/editor/populate-internal-constants"),builder_1=__importDefault(require("./compiled/builder")),dynamic_builder_1=__importDefault(require("./dynamic-builder")),{PersistentMask:PersistentMask,DontSave:DontSave,DontDestroy:DontDestroy,EditorOnly:EditorOnly,IsClientLoad:IsClientLoad}=cc_1.CCObject.Flags,getDefault=cc_1.CCClass.getDefault,Attr=cc_1.CCClass.Attr,EDITOR_ONLY=Attr.DELIMETER+"editorOnly",DEFAULT=Attr.DELIMETER+"default",FORMERLY_SERIALIZED_AS=Attr.DELIMETER+"formerlySerializedAs";function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof cc_1.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return cc_1.js.isEmptyObject(e)&&cc_1.js.isEmptyObject(t)}return!1}function isSerializableClass(e,t){if(!t)return!1;if(cc_1.CCClass._isCCClass(t))return!0;return t.__values__&&cc_1.js._getClassId(e,!1)}function isSyncPrefab(e){var t,i,r,s;return(null===(r=null===(i=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.root)||void 0===i?void 0:i._prefab)||void 0===r?void 0:r.instance)&&((null===(s=null===e||void 0===e?void 0:e._prefab)||void 0===s?void 0:s.instance)||!isMountedChild(e))}function isMountedChild(e){var t;return!!(null===(t=e[cc_1.editorExtrasTag])||void 0===t?void 0:t.mountedRoot)}class Parser{constructor(e,t){var i;this.parsingInfos=new Map,t=t||{},this.exporting=!!t._exporting,this.mustCompresseUuid=!!t.compressUuid,this.discardInvalid=!("discardInvalid"in t)||!!t.discardInvalid,this.dontStripDefault=!(this.exporting&&"dontStripDefault"in t&&!t.dontStripDefault),this.missingClassReporter=t.missingClassReporter,this.missingObjectReporter=t.missingObjectReporter,this.reserveContentsForAllSyncablePrefab=!!t.reserveContentsForSyncablePrefab;const r={};r[cc.Node.reserveContentsForAllSyncablePrefabTag]=this.reserveContentsForAllSyncablePrefab,this._serializationContext={root:this.prefabRoot,toCCON:null!==(i=t.useCCON)&&void 0!==i&&i,customArguments:r},this.builder=e,this.assetExists=this.missingObjectReporter&&Object.create(null),this.customExportingCtxCache=this.exporting?{_depends:[],dependsOn(e,t){this._compressUuid&&(t=uuid_1.compressUuid(t,!0)),this._depends.push(e,t)},_compressUuid:this.mustCompresseUuid}:null}parse(e){e instanceof cc.Prefab&&(this.prefabRoot=e.data);const t=this.parseObjField(null,null,"",e,null);this.builder.setRoot(t)}checkMissingAsset(e,t){if(this.missingObjectReporter){this.assetExists[t]||this.missingObjectReporter(e)}}isObjRemoved(e){if(e instanceof cc_1.CCObject){const t=e.objFlags;if(this.exporting&&(t&EditorOnly||populate_internal_constants_1.SERVER_MODE&&!(t|IsClientLoad)))return!0;if(t&DontSave){if(this.discardInvalid)return!0;if(t&DontDestroy)return!0}}return!1}setParsedObj(e,t,i,r){if(i&&"object"==typeof i){const s=this.parsingInfos.get(i);if(s)return this.builder.setProperty_ParsedObject(e,t,s,r),!0}return!1}verifyNotParsedValue(e,t,i){var r,s;const n=typeof i;if("object"===n){if(!i)return null;if(i instanceof cc_1.CCObject){if(i instanceof cc_1.Asset){const e=i._uuid;return e?(this.checkMissingAsset(i,e),i):null}if(this.discardInvalid){if(!i.isValid)return null===(r=this.missingObjectReporter)||void 0===r||r.call(this,i),null}else if(!i.isRealValid)return null;if(cc_1.Node&&cc_1.Node.isNode(i)){if(this.canDiscardByPrefabRoot(i)&&i!==i._prefab.root)return null}if(i instanceof cc_1.Component){if(i.node&&this.canDiscardByPrefabRoot(i.node)&&!(null===(s=i[cc_1.editorExtrasTag])||void 0===s?void 0:s.mountedRoot))return null}}return i}return"function"!==n?e instanceof cc_1.CCObject&&"_objFlags"===t&&i>0?i&PersistentMask:i:null}canDiscardByPrefabRoot(e){return!(this.reserveContentsForAllSyncablePrefab||!isSyncPrefab(e)||this.prefabRoot===e)}enumerateClass(e,t,i,r,s){const n=Attr.getClassAttrs(i),o=r||i.__values__;for(let i=0;i<o.length;i++){const r=o[i];let s=e[r];if(this.isObjRemoved(s))continue;if(this.exporting&&n[r+EDITOR_ONLY])continue;const a=n[r+FORMERLY_SERIALIZED_AS];if(this.setParsedObj(t,r,s,a))continue;s=this.verifyNotParsedValue(e,r,s);const l=getDefault(n[r+DEFAULT]);this.exporting&&!this.dontStripDefault&&equalsToDefault(l,s)||this.parseField(e,t,r,s,{formerlySerializedAs:a,defaultValue:l})}if(cc_1.BaseNode&&e instanceof cc_1.BaseNode||cc_1.Component&&e instanceof cc_1.Component){if(this.exporting){if(!(e instanceof cc_1.BaseNode&&e._parent instanceof cc.Scene))return;if(!this.dontStripDefault&&!e._id)return}this.builder.setProperty_Raw(e,t,"_id",e._id)}}static isDefaultTrs(e){return 0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&0===e[5]&&1===e[6]&&1===e[7]&&1===e[8]&&1===e[9]}parseField(e,t,i,r,s){const n=typeof r;if("object"===n){if(!r)return void this.builder.setProperty_Raw(e,t,i,null,s);if(r instanceof cc_1.Asset&&e){let n=r._uuid;return this.mustCompresseUuid&&(n=uuid_1.compressUuid(n,!0)),(s=s||{}).expectedType=cc_1.js._getClassId(r.constructor),void this.builder.setProperty_AssetUuid(e,t,i,n,s)}this.parseObjField(e,t,i,r,s)}else"function"!==n?this.builder.setProperty_Raw(e,t,i,r,s):this.builder.setProperty_Raw(e,t,i,null,s)}parseObjField(e,t,i,r,s){const n=r.constructor;if(isSerializableClass(r,n)){const o=e=>{let t=n.__values__;if(r._onBeforeSerialize&&(t=r._onBeforeSerialize(t)||t),0===t.length)return;if("_$erialized"!==t[t.length-1])return void this.enumerateClass(r,e,n,t);if(!r._$erialized)return cc.error(`Lost serialized data of ${r}`),null;const i=r._$erialized,s=i.__type__;this.enumerateDict(i,e),this.missingClassReporter&&this.missingClassReporter(r,s)},a=()=>{var a;const l=s||{},c=r._$erialized?r._$erialized.__type__:cc.js._getClassId(n,!1);l.type=c,l.uniquelyReferenced=null===(a=cc.getSerializationMetadata(n))||void 0===a?void 0:a.uniquelyReferenced;const u=this.builder.setProperty_Class(e,t,i,l);if(this.parsingInfos.set(r,u),!r[cc.serializeTag])return o(u),u;const d={writeProperty:(e,t)=>{this.isObjRemoved(t)||this.setParsedObj(u,e,t,null)||this.parseField(r,u,e,t,{})},writeThis:()=>o(u),writeSuper:()=>{const e=cc_1.js.getSuper(n);if(!e)return;const t=e.__values__;t&&this.enumerateClass(r,u,n,t)}};return r[cc.serializeTag](d,this._serializationContext),u};if(r instanceof cc_1.ValueType){const n=this.builder.setProperty_ValueType(e,t,i,r,s);if(n)return n}if(r._serialize){const o=s||{};o.content=r._serialize(this.customExportingCtxCache),o.type=cc.js._getClassId(n,!1);const a=this.builder.setProperty_CustomizedClass(e,t,i,o);if(this.parsingInfos.set(r,a),this.customExportingCtxCache){const e=this.customExportingCtxCache._depends;for(let t=0;t<e.length;t+=2)this.builder.setProperty_AssetUuid(r,a,e[t],e[t+1],null);e.length=0}return a}return a()}if(ArrayBuffer.isView(r))return cc_1.Node&&cc_1.Node.isNode(e)&&"_trs"===i&&Parser.isDefaultTrs(r)?null:(this.builder.setProperty_TypedArray(e,t,i,r,s),null);if(n&&n!==Object&&!Array.isArray(r)){if(!e)throw new Error(`Unknown object to serialize: ${r}`);return null}if(Array.isArray(r)){const n=r.filter(e=>!this.isObjRemoved(e)),o=s||{};o.writeOnlyArray=n;const a=this.builder.setProperty_Array(e,t,i,o);this.parsingInfos.set(r,a);for(let e=0;e<n.length;++e){let t=n[e];this.setParsedObj(a,e,t,null)||(t=this.verifyNotParsedValue(r,e,t),this.parseField(r,a,e,t,null))}return a}{const n=this.builder.setProperty_Dict(e,t,i,s);return this.parsingInfos.set(r,n),this.enumerateDict(r,n),n}}enumerateDict(e,t){for(const i in e){if(e.hasOwnProperty&&!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1))continue;let r=e[i];if(this.isObjRemoved(r))r=null;else{if(this.setParsedObj(t,i,r,null))continue;r=this.verifyNotParsedValue(e,i,r)}this.parseField(e,t,i,r,null)}}}function serialize(e,t){let i;return"compiled"===(t=t||{}).builder?(t._exporting=!0,i=new builder_1.default(t)):i=new dynamic_builder_1.default(t),new Parser(i,t).parse(e),e=null,i.dump()}exports.Parser=Parser,exports.default=serialize;