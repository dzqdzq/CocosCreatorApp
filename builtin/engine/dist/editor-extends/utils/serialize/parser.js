"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const _=require("lodash"),cc_1=require("cc"),cc=__importStar(require("cc")),uuid_1=require("../uuid"),builder_1=__importDefault(require("./compiled/builder")),dynamic_builder_1=__importDefault(require("./dynamic-builder")),{PersistentMask:PersistentMask,DontSave:DontSave,DontDestroy:DontDestroy,EditorOnly:EditorOnly}=cc_1.CCObject.Flags,getDefault=cc_1.CCClass.getDefault,PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT=["_objFlags","_parent","_prefab"],Attr=cc_1.CCClass.Attr,EDITOR_ONLY=Attr.DELIMETER+"editorOnly",DEFAULT=Attr.DELIMETER+"default",FORMERLY_SERIALIZED_AS=Attr.DELIMETER+"formerlySerializedAs";function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof cc_1.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return cc_1.js.isEmptyObject(e)&&cc_1.js.isEmptyObject(t)}return!1}function isSerializableClass(e,t){if(!t)return!1;if(cc_1.CCClass._isCCClass(t))return!0;return t.__values__&&cc_1.js._getClassId(e,!1)}function isSyncPrefab(e){var t,s,i,r;return(null===(i=null===(s=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.root)||void 0===s?void 0:s._prefab)||void 0===i?void 0:i.instance)&&((null===(r=null===e||void 0===e?void 0:e._prefab)||void 0===r?void 0:r.instance)||!isMountedChild(e))}function isMountedChild(e){return!!e._mountedRoot}class Parser{constructor(e,t){this.parsingInfos=new Map,t=t||{},this.exporting=!!t._exporting,this.mustCompresseUuid=!!t.compressUuid,this.discardInvalid=!("discardInvalid"in t)||!!t.discardInvalid,this.dontStripDefault=!(this.exporting&&"dontStripDefault"in t&&!t.dontStripDefault),this.missingClassReporter=t.missingClassReporter,this.missingObjectReporter=t.missingObjectReporter,this.reserveContentsForAllSyncablePrefab=!!t.reserveContentsForSyncablePrefab,this.builder=e,this.assetExists=this.missingObjectReporter&&Object.create(null),this.customExportingCtxCache=this.exporting?{_depends:[],dependsOn(e,t){this._compressUuid&&(t=uuid_1.compressUuid(t,!0)),this._depends.push(e,t)},_compressUuid:this.mustCompresseUuid}:null}parse(e){e instanceof cc.Prefab&&(this.prefabRoot=e.data);const t=this.parseObjField(null,null,"",e,null);this.builder.setRoot(t)}checkMissingAsset(e,t){if(this.missingObjectReporter){this.assetExists[t]||this.missingObjectReporter(e)}}isObjRemoved(e){if(e instanceof cc_1.CCObject){const t=e._objFlags;if(this.exporting&&t&EditorOnly)return!0;if(t&DontSave){if(this.discardInvalid)return!0;if(t&DontDestroy)return!0}}return!1}setParsedObj(e,t,s,i){if(s&&"object"==typeof s){const r=this.parsingInfos.get(s);if(r)return this.builder.setProperty_ParsedObject(e,t,r,i),!0}return!1}verifyNotParsedValue(e,t,s){var i;const r=typeof s;if("object"===r){if(!s)return null;if(s instanceof cc_1.CCObject){if(s instanceof cc_1.Asset){const e=s._uuid;return e?(this.checkMissingAsset(s,e),s):null}if(this.discardInvalid){if(!s.isValid)return null===(i=this.missingObjectReporter)||void 0===i||i.call(this,s),null}else if(!s.isRealValid)return null;if(cc_1.Node&&cc_1.Node.isNode(s)){if(this.canDiscardByPrefabRoot(s)&&s!==s._prefab.root)return null}if(s instanceof cc_1.Component){if(s.node&&this.canDiscardByPrefabRoot(s.node)&&!s._mountedRoot)return null}}return s}return"function"!==r?e instanceof cc_1.CCObject&&"_objFlags"===t&&s>0?s&PersistentMask:s:null}canDiscardByPrefabRoot(e){return!(this.reserveContentsForAllSyncablePrefab||!isSyncPrefab(e)||this.prefabRoot===e)}enumerateClass(e,t,s,i,r){const n=Attr.getClassAttrs(s),o=i||s.__values__;for(let s=0;s<o.length;s++){const i=o[s];let r=e[i];if(this.isObjRemoved(r))continue;if(this.exporting&&n[i+EDITOR_ONLY])continue;const a=n[i+FORMERLY_SERIALIZED_AS];if(this.setParsedObj(t,i,r,a))continue;r=this.verifyNotParsedValue(e,i,r);const l=getDefault(n[i+DEFAULT]);this.exporting&&!this.dontStripDefault&&equalsToDefault(l,r)||this.parseField(e,t,i,r,{formerlySerializedAs:a,defaultValue:l})}if(cc_1.BaseNode&&e instanceof cc_1.BaseNode||cc_1.Component&&e instanceof cc_1.Component){if(this.exporting){if(!(e instanceof cc_1.BaseNode&&e._parent instanceof cc.Scene))return;if(!this.dontStripDefault&&!e._id)return}this.builder.setProperty_Raw(e,t,"_id",e._id)}}static isDefaultTrs(e){return 0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&0===e[5]&&1===e[6]&&1===e[7]&&1===e[8]&&1===e[9]}enumerateNode(e,t,s,i){if(this.canDiscardByPrefabRoot(e)){const i=e._prefab.root===e;i&&this.enumerateClass(e,t,s,PRESERVE_PROPS_FOR_SYNCABLE_PREFAB_ROOT,i)}else this.enumerateClass(e,t,s)}parseField(e,t,s,i,r){const n=typeof i;if("object"===n){if(!i)return void this.builder.setProperty_Raw(e,t,s,null,r);if(i instanceof cc_1.Asset&&e){let n=i._uuid;return this.mustCompresseUuid&&(n=uuid_1.compressUuid(n,!0)),(r=r||{}).expectedType=cc_1.js._getClassId(i.constructor),void this.builder.setProperty_AssetUuid(e,t,s,n,r)}this.parseObjField(e,t,s,i,r)}else"function"!==n?this.builder.setProperty_Raw(e,t,s,i,r):this.builder.setProperty_Raw(e,t,s,null,r)}parseObjField(e,t,s,i,r){const n=i.constructor;if(isSerializableClass(i,n)){if(i instanceof cc_1.ValueType){const n=this.builder.setProperty_ValueType(e,t,s,i,r);if(n)return n}if(i._serialize){const o=r||{};o.content=i._serialize(this.customExportingCtxCache),o.type=cc.js._getClassId(n,!1);const a=this.builder.setProperty_CustomizedClass(e,t,s,o);if(this.parsingInfos.set(i,a),this.customExportingCtxCache){const e=this.customExportingCtxCache._depends;for(let t=0;t<e.length;t+=2)this.builder.setProperty_AssetUuid(i,a,e[t],e[t+1],null);e.length=0}return a}{let o=n.__values__;i._onBeforeSerialize&&(o=i._onBeforeSerialize(o)||o);const a=r||{};if(a.type=cc.js._getClassId(n,!1),o.length>0){if(cc_1.Node&&cc_1.Node.isNode(i)){const r=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(i,r),this.enumerateNode(i,r,n,o),r}if("_$erialized"!==o[o.length-1]){const r=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(i,r),this.enumerateClass(i,r,n,o),r}if(i._$erialized){const r=i._$erialized,n=r.__type__;a.type=n;const o=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(i,o),this.enumerateDict(r,o),this.missingClassReporter&&this.missingClassReporter(i,n),o}return cc.error(`Lost serialized data of ${i}`),null}{const r=this.builder.setProperty_Class(e,t,s,a);return this.parsingInfos.set(i,r),r}}}if(ArrayBuffer.isView(i))return cc_1.Node&&cc_1.Node.isNode(e)&&"_trs"===s&&Parser.isDefaultTrs(i)?null:(this.builder.setProperty_TypedArray(e,t,s,i,r),null);if(n&&n!==Object&&!Array.isArray(i)){if(!e)throw new Error(`Unknown object to serialize: ${i}`);return null}if(Array.isArray(i)){const n=i.filter(e=>!this.isObjRemoved(e)),o=r||{};o.writeOnlyArray=n;const a=this.builder.setProperty_Array(e,t,s,o);this.parsingInfos.set(i,a);for(let e=0;e<n.length;++e){let t=n[e];this.setParsedObj(a,e,t,null)||(t=this.verifyNotParsedValue(i,e,t),this.parseField(i,a,e,t,null))}return a}{const n=this.builder.setProperty_Dict(e,t,s,r);return this.parsingInfos.set(i,n),this.enumerateDict(i,n),n}}enumerateDict(e,t){for(const s in e){if(e.hasOwnProperty&&!e.hasOwnProperty(s)||95===s.charCodeAt(0)&&95===s.charCodeAt(1))continue;let i=e[s];if(this.isObjRemoved(i))i=null;else{if(this.setParsedObj(t,s,i,null))continue;i=this.verifyNotParsedValue(e,s,i)}this.parseField(e,t,s,i,null)}}}function serialize(e,t){let s;return"compiled"===(t=t||{}).builder?(t._exporting=!0,s=new builder_1.default(t)):s=new dynamic_builder_1.default(t),new Parser(s,t).parse(e),e=null,s.dump()}exports.Parser=Parser,exports.default=serialize;