"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),types_1=require("./types"),{CLASS_PROP_TYPE_OFFSET:CLASS_PROP_TYPE_OFFSET,MASK_CLASS:MASK_CLASS,OBJ_DATA_MASK:OBJ_DATA_MASK,CUSTOM_OBJ_DATA_CLASS:CUSTOM_OBJ_DATA_CLASS}=cc_1.deserialize._macros;class Type{constructor(e){this.properties=new Map,this.nodes=new Array,this.setNodeProperties(e),this.nodes.push(e)}setNodeProperties(e){const t=this.properties;for(const s of e.simpleKeys)t.set(s,0);for(let s=0;s<e.advanceds.length;s+=2){const n=e.advanceds[s];t.set(n,e.advanceds[s+1])}}addNode(e){const t=this.properties;let s=!1;for(const n of e.simpleKeys)if(t.has(n)){if(0!==t.get(n))return!1}else s=!0;for(let n=0;n<e.advanceds.length;n+=2){const r=e.advanceds[n];if(t.has(r)){if(t.get(r)!==e.advanceds[n+1])return!1}else s=!0}return s?(this.setNodeProperties(e),this.nodes.push(e),!0):(this.nodes.push(e),!0)}static shouldUseSameMask(e){const t=this.simpleKeys,s=e.simpleKeys,n=this.advanceds,r=e.advanceds;if(t.length!==s.length||n.length!==r.length)return!1;for(let e=0;e<t.length;++e)if(t[e]!==s[e])return!1;for(let e=0;e<n.length;e+=2)if(n[e]!==r[e])return!1;return!0}dump(e,t,s){const n=new types_1.TraceableDict,r=new types_1.TraceableDict,o=new Array;for(let e=0;e<this.nodes.length;++e){const c=this.nodes[e],a=o.find(Type.shouldUseSameMask,c);if(a)s.trace(a,c.dumped,OBJ_DATA_MASK);else{const e=[types_1.TraceableDict.PLACEHOLDER];for(let t=0;t<c.simpleKeys.length;++t){const s=c.simpleKeys[t];n.traceString(s,e,e.length),e.push(types_1.TraceableDict.PLACEHOLDER)}const a=e.length;for(let t=0;t<c.advanceds.length;t+=2){const s=c.advanceds[t];r.traceString(s,e,e.length),e.push(types_1.TraceableDict.PLACEHOLDER)}e.push(a),t.trace(this,e,MASK_CLASS),s.trace(c,c.dumped,OBJ_DATA_MASK).result=e,o.push(c)}}const c=n.dump(),a=r.dump(c.length),i=[e,c.concat(a),CLASS_PROP_TYPE_OFFSET+1-c.length,...a.map(e=>this.properties.get(e))];t.get(this).result=i}}function registerType(e,t){for(const s of e)if(s.addNode(t))return;const s=new Type(t);e.push(s)}function default_1(e){const t=new types_1.TraceableDict,s=new types_1.TraceableDict,n=new Map;for(let s=0;s<e.length;++s){const r=e[s],o=r.ctor;if(r instanceof types_1.CustomClassNode){t.traceString(o,r.dumped,CUSTOM_OBJ_DATA_CLASS);continue}let c=n.get(o);c||(c=[],n.set(o,c)),registerType(c,r)}for(const[e,r]of n)for(const n of r)n.dump(e,t,s);return{sharedClasses:t.dump(),sharedMasks:s.dump()}}exports.default=default_1;