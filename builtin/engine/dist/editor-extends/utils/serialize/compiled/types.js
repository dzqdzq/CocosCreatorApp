"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CustomClassNode=exports.ClassNode=exports.DictNode=exports.ArrayNode=exports.Node=exports.TraceableDict=exports.TraceableItem=void 0;const cc_1=require("cc"),{DICT_JSON_LAYOUT,CLASS_TYPE,CLASS_KEYS,CLASS_PROP_TYPE_OFFSET,CUSTOM_OBJ_DATA_CONTENT,MASK_CLASS}=cc_1.deserialize._macros;class TraceableItem{tracers=[];keys=[];static compareByRefCount(e,t){return t.tracers.length-e.tracers.length}static NO_RESULT=Object.create(null);result=TraceableItem.NO_RESULT;constructor(){}traceBy(e,t){this.tracers.push(e),this.keys.push(t)}movedTo(t){for(let e=0;e<this.tracers.length;e++)this.tracers[e][this.keys[e]]=t}}exports.TraceableItem=TraceableItem;class TraceableDict{static PLACEHOLDER=0;values=new Map;trace(e,t,s){let r=this.values.get(e);return r||(r=new TraceableItem,this.values.set(e,r)),r.traceBy(t,s),r}traceString(e,t,s){this.trace(e,t,s).result=e}get(e){return this.values.get(e)}getSortedItems(){var e=Array.from(this.values.values());return e.sort(TraceableItem.compareByRefCount),e}dump(t=0){var s=this.getSortedItems();for(let e=0;e<s.length;e++)s[e].movedTo(t+e);return s.map(e=>e.result)}}exports.TraceableDict=TraceableDict;class Node{selfType;refCount=0;indexed=!1;shouldBeIndexed=!1;_index=-1;get instanceIndex(){return this._index}set instanceIndex(e){if(this.indexed)throw new Error("Should not change instanceIndex on indexed object");this._index=e}get refType(){return this.indexed?1:this.selfType}static compareByRefCount(e,t){return t.refCount-e.refCount}constructor(e){this.selfType=e}setStatic(e,t,s){}setDynamic(e,t){++e.refCount}static AssetPlaceholderType=0;static AssetPlaceholderValue=null;setAssetRefPlaceholderOnIndexed(e){}dumpRecursively(e){}}class ArrayNode extends(exports.Node=Node){types;datas;static DeriveTypes=[[0,0],[4,9],[6,3],[1,2]];constructor(e){super(12),this.types=new Array(e),this.datas=new Array(e)}setStatic(e,t,s){this.types[e]=t,this.datas[e]=s}setDynamic(e,t){super.setDynamic(e),this.types[t]=void 0,this.datas[t]=e}setAssetRefPlaceholderOnIndexed(e){this.types[e]=Node.AssetPlaceholderType,this.datas[e]=Node.AssetPlaceholderValue}dumpRecursively(t){for(let e=0;e<this.datas.length;++e){var s,r=this.datas[e];r instanceof Node&&(r.indexed?(s=t.addRef(this,e,r),isFinite(s)?(this.types[e]=1,this.datas[e]=s):(this.types[e]=0,this.datas[e]=null)):(r.instanceIndex=this.instanceIndex,s=r.dumpRecursively(t),this.types[e]=r.refType,this.datas[e]=s))}for(let e=0;e<ArrayNode.DeriveTypes.length;++e){const[a,i]=ArrayNode.DeriveTypes[e];if(this.types.every(e=>e===a))return this.selfType=i,this.datas}return this.selfType=12,[this.datas,...this.types]}}exports.ArrayNode=ArrayNode;class DictNode extends Node{data=[null];json=Object.create(null);dynamics=Object.create(null);constructor(){super(11),this.data[DICT_JSON_LAYOUT]=this.json}setStatic(e,t,s){0===t?this.json[e]=s:this.data.push(e,t,s)}setDynamic(e,t){super.setDynamic(e),this.dynamics[t]=e}dumpRecursively(e){for(const r in this.dynamics){var t,s=this.dynamics[r];s.indexed?(t=e.addRef(this,r,s),isFinite(t)&&this.data.push(r,1,t)):(s.instanceIndex=this.instanceIndex,t=s.dumpRecursively(e),0===s.refType?this.json[r]=t:this.data.push(r,s.refType,t))}return 1===this.data.length?(this.selfType=0,this.json):this.data}}exports.DictNode=DictNode;class ClassNode extends Node{ctor;simpleKeys=new Array;simpleValues=[];advanceds=new Array;dumped;static fromData(t,s,r){var e=t[CLASS_TYPE],a=new ClassNode(e),i=(a.dumped=r,a.simpleValues=null,t[CLASS_KEYS]),d=t[CLASS_PROP_TYPE_OFFSET],n=s[s.length-1];let c=MASK_CLASS+1;for(;c<n;++c){var o=i[s[c]];a.simpleKeys.push(o)}for(let e=n;e<r.length;++e){var l=i[s[e]],h=t[s[e]+d];a.advanceds.push(l,h)}return a}constructor(e){super(4),this.ctor=e}setStatic(e,t,s){0===t?(this.simpleKeys.push(e),this.simpleValues.push(s)):this.advanceds.push(e,t,s)}setDynamic(e,t){super.setDynamic(e),this.advanceds.push(t,void 0,e)}dumpRecursively(t){var s=this.advanceds;for(let e=s.length-3;0<=e;e-=3){var r,a=s[e+2];a instanceof Node&&(a.indexed?(r=t.addRef(this,s[e],a),isFinite(r)?(s[e+1]=1,s[e+2]=r):s.splice(e,3)):(a.instanceIndex=this.instanceIndex,r=a.dumpRecursively(t),0===a.refType?(this.simpleKeys.push(s[e]),this.simpleValues.push(r),s.splice(e,3)):(s[e+1]=a.refType,s[e+2]=r)))}var e=TraceableDict.PLACEHOLDER;this.dumped=[e].concat(this.simpleValues);for(let e=0;e<s.length;e+=3)this.dumped.push(s[e+2]);return this.simpleValues=null,this.advanceds=this.advanceds.filter((e,t)=>t%3!=2),this.dumped}}exports.ClassNode=ClassNode;class CustomClassNode extends Node{ctor;content;dumped;static fromData(e,t){var s=t[CUSTOM_OBJ_DATA_CONTENT],e=new CustomClassNode(e,s);return e.dumped=t,e}constructor(e,t){super(10),this.ctor=e,this.content=t}setStatic(e,t,s){throw new Error("Should not set property of CustomClass")}setDynamic(e,t){throw new Error("Should not set property of CustomClass")}dumpRecursively(e){var t=TraceableDict.PLACEHOLDER;return this.dumped=[t,this.content],this.dumped}}exports.CustomClassNode=CustomClassNode;