"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),types_1=require("./types"),builder_1=require("./builder"),create_class_mask_1=__importDefault(require("./create-class-mask")),{EMPTY_PLACEHOLDER:EMPTY_PLACEHOLDER,CUSTOM_OBJ_DATA_CLASS:CUSTOM_OBJ_DATA_CLASS,ARRAY_ITEM_VALUES:ARRAY_ITEM_VALUES,CLASS_PROP_TYPE_OFFSET:CLASS_PROP_TYPE_OFFSET,MASK_CLASS:MASK_CLASS,OBJ_DATA_MASK:OBJ_DATA_MASK,DICT_JSON_LAYOUT:DICT_JSON_LAYOUT,PACKED_SECTIONS:PACKED_SECTIONS}=cc_1.deserialize._macros;function genArrayParser(e){return(t,s,r)=>{for(let n=0;n<s.length;++n)e(t,s[n],r)}}function parseArray(e,t,s){const r=t[ARRAY_ITEM_VALUES];for(let n=0;n<r.length;++n){const _=t[n+1],a=PARSERS[_];a&&a(e,r[n],s)}}function parseDict(e,t,s){for(let r=DICT_JSON_LAYOUT+1;r<t.length;r+=3){const n=t[r+1],_=PARSERS[n];if(_){_(e,t[r+2],s)}}}function parseClass(e,t,s){const r=e[4][t[OBJ_DATA_MASK]],n=e[3][r[MASK_CLASS]],_=types_1.ClassNode.fromData(n,r,t);s.push(_);const a=n[CLASS_PROP_TYPE_OFFSET];for(let _=r[r.length-1];_<t.length;++_){const S=n[r[_]+a],A=PARSERS[S];A&&A(e,t[_],s)}}function parseCustomClass(e,t,s){const r=e[3][t[CUSTOM_OBJ_DATA_CLASS]],n=types_1.CustomClassNode.fromData(r,t);s.push(n)}const PARSERS=new Array(13);function parseInstances(e,t){const s=e[3],r=e[5],n=e[6],_=n===EMPTY_PLACEHOLDER?0:n.length,a=r[r.length-1];let S=r.length-_;"number"==typeof a&&--S;let A=0;for(;A<S;++A){parseClass(e,r[A],t)}if(n)for(let a=0;a<_;++a,++A){let _=n[a];const S=r[A];if(_>=0){const e=s[_],r=types_1.CustomClassNode.fromData(e,[_,S]);r.instanceIndex=A,t.push(r),n[a]=r}else{const s=PARSERS[_=~_];s&&s(e,S,t)}}}function parseJSON(e,t,s,r){const n=e[1],_=e[2],a=e[10];for(let e=0;e<a.length;++e){const s=n[a[e]];t.traceString(s,a,e)}if(e[7]){const t=e[7],r=t.length-1;for(let e=0;e<r;e+=3){const r=t[e+1];if(r>=0){const n=_[r];s.traceString(n,t,e+1)}}}const S=e[9];for(let e=0;e<S.length;++e){const t=S[e];if(t>=0){const r=_[t];s.traceString(r,S,e)}}parseInstances(e,r)}function packJSONs(e){const t=new types_1.TraceableDict,s=new types_1.TraceableDict,r=new Array;for(let n=0;n<e.length;++n)parseJSON(e[n],t,s,r);const{sharedClasses:n,sharedMasks:_}=(0,create_class_mask_1.default)(r);for(let t=0;t<e.length;++t){const s=e[t],r=s[6];if(r)for(let e=0;e<r.length;++e){const t=r[e];t instanceof types_1.CustomClassNode&&(r[e]=t.dumped[CUSTOM_OBJ_DATA_CLASS])}s.splice(0,5)}const a=new Array(PACKED_SECTIONS+1);return a[0]=builder_1.FORMAT_VERSION,a[1]=(0,builder_1.reduceEmptyArray)(t.dump()),a[2]=(0,builder_1.reduceEmptyArray)(s.dump()),a[3]=n,a[4]=(0,builder_1.reduceEmptyArray)(_),a[PACKED_SECTIONS]=e,a}PARSERS.fill(null),PARSERS[4]=parseClass,PARSERS[10]=parseCustomClass,PARSERS[12]=parseArray,PARSERS[9]=genArrayParser(parseClass),PARSERS[11]=parseDict,exports.default=packJSONs;