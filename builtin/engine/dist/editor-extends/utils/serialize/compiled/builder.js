"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,n)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRootData=exports.reduceEmptyArray=exports.FORMAT_VERSION=void 0;const cc_1=require("cc"),cc=__importStar(require("cc")),serialization_1=require("cc/editor/serialization"),types_1=require("./types"),create_class_mask_1=__importDefault(require("./create-class-mask")),base_builder_1=require("../base-builder"),{EMPTY_PLACEHOLDER:EMPTY_PLACEHOLDER,CUSTOM_OBJ_DATA_CLASS:CUSTOM_OBJ_DATA_CLASS,CUSTOM_OBJ_DATA_CONTENT:CUSTOM_OBJ_DATA_CONTENT}=cc_1.deserialize._macros;exports.FORMAT_VERSION=1;const INNER_OBJ_PLACEHOLDER=0;var RefsBuilder;function reduceEmptyArray(e){return e&&e.length>0?e:EMPTY_PLACEHOLDER}!function(e){e.Impl=class{constructor(e){this.beforeOffsetRefs=new Array,this.afterOffsetRefs=new Array,this.ctx=e}addRef(e,t,s){if(s.instanceIndex<e.instanceIndex)return s.instanceIndex;const r=[NaN,t,s.instanceIndex];return e.indexed?(r[0]=e.instanceIndex,this.afterOffsetRefs.push(r),NaN):(r[0]=INNER_OBJ_PLACEHOLDER,this.beforeOffsetRefs.push(r),~(this.beforeOffsetRefs.length-1))}build(){if(0===this.beforeOffsetRefs.length&&0===this.afterOffsetRefs.length)return null;const e=this.beforeOffsetRefs.length,t=this.beforeOffsetRefs.concat(this.afterOffsetRefs),s=new Array(3*t.length+1);let r=0;for(const e of t){s[r++]=e[0];const t=e[1];"number"==typeof t?s[r++]=~t:this.ctx.sharedStrings.traceString(t,s,r++),s[r++]=e[2]}return s[r]=e,s}}}(RefsBuilder||(RefsBuilder={})),exports.reduceEmptyArray=reduceEmptyArray;class CompiledBuilder extends base_builder_1.Builder{constructor(e){if(super(e),this.sharedUuids=new types_1.TraceableDict,this.sharedStrings=new types_1.TraceableDict,this.dependAssets=new Array,this.normalNodes=new Array,this.advancedNodes=new Array,this.classNodes=new Array,this.data=new Array(11),e.forceInline)throw new Error("CompiledBuilder doesn't support `forceInline`");this.noNativeDep=!("noNativeDep"in e&&!e.noNativeDep),this.refsBuilder=new RefsBuilder.Impl(this)}setProperty_Array(e,t,s,r){const n=new types_1.ArrayNode(r.writeOnlyArray.length);return this.advancedNodes.push(n),this.setDynamicProperty(t,s,n),n}setProperty_Dict(e,t,s,r){const n=new types_1.DictNode;return this.advancedNodes.push(n),this.setDynamicProperty(t,s,n),n}setProperty_Class(e,t,s,r){const n=new types_1.ClassNode(r.type);return this.normalNodes.push(n),this.classNodes.push(n),this.setDynamicProperty(t,s,n),n}setProperty_CustomizedClass(e,t,s,r){const n=new types_1.CustomClassNode(r.type,r.content);return this.advancedNodes.push(n),this.classNodes.push(n),this.setDynamicProperty(t,s,n),n}setProperty_ParsedObject(e,t,s,r){e.setDynamic(s,t)}setProperty_Raw(e,t,s,r,n){t.setStatic(s,0,r)}setProperty_ValueType(e,t,s,r,n){if(!t)throw new Error("CompiledBulider: Not support serializing ValueType as root object.");const o=(0,serialization_1.serializeBuiltinValueType)(r);if(!o)return null;let i=8;return n&&n.defaultValue instanceof cc.ValueType&&(i=5),t.setStatic(s,i,o),o}setProperty_TypedArray(e,t,s,r,n){if(!(e instanceof cc.Node)||"_trs"!==s)throw new Error("Not support to serialize TypedArray yet. Can only use TypedArray in TRS.");if(10!==r.length)throw new Error(`TRS ${r} should contains 10 elements.`);const o=Array.from(r);t.setStatic(s,7,o)}setProperty_AssetUuid(e,t,s,r,n){const o=t;this.dependAssets.push(o,s,r),o instanceof types_1.CustomClassNode&&(o.shouldBeIndexed=!0)}setRoot(e){this.rootNode=e}setDynamicProperty(e,t,s){e&&e.setDynamic(s,t)}collectInstances(){this.normalNodes=this.normalNodes.filter(e=>e.refCount>1),this.normalNodes.sort(types_1.Node.compareByRefCount),this.advancedNodes=this.advancedNodes.filter(e=>e.shouldBeIndexed||e.refCount>1),this.advancedNodes.sort(types_1.Node.compareByRefCount);const e=this.rootNode;if(e instanceof types_1.ClassNode){const t=this.normalNodes.indexOf(e);-1!==t&&this.normalNodes.splice(t,1),this.normalNodes.unshift(e)}else{-1===this.advancedNodes.indexOf(e)&&(this.advancedNodes.length,this.advancedNodes.push(e))}const t=this.normalNodes.length;for(let e=0;e<t;++e){const t=this.normalNodes[e];t.instanceIndex=e,t.indexed=!0}for(let e=0;e<this.advancedNodes.length;++e){const s=this.advancedNodes[e];s.instanceIndex=t+e,s.indexed=!0}}dumpInstances(){const e=this.normalNodes.length+this.advancedNodes.length,t=new Array(e),s=this.normalNodes.length;for(let e=0;e<s;++e){const s=this.normalNodes[e];t[e]=s.dumpRecursively(this.refsBuilder)}for(let e=0;e<this.advancedNodes.length;++e){const r=this.advancedNodes[e],n=r.dumpRecursively(this.refsBuilder);r instanceof types_1.CustomClassNode?t[s+e]=n[CUSTOM_OBJ_DATA_CONTENT]:t[s+e]=n}if(0!==this.rootNode.instanceIndex||"number"==typeof t[t.length-1]||!this.noNativeDep){const e=this.rootNode.instanceIndex;t.push(this.noNativeDep?e:~e)}this.data[5]=t}dumpInstanceTypes(){const e=this.advancedNodes.map(e=>e instanceof types_1.CustomClassNode?e.dumped[CUSTOM_OBJ_DATA_CLASS]:~e.selfType);this.data[6]=reduceEmptyArray(e)}dumpDependUuids(){const e={owners:new Array,keys:new Array,uuids:new Array},t={owners:new Array,keys:new Array,uuids:new Array},s=this.dependAssets;for(let r=0;r<s.length;r+=3){const n=s[r];let o=s[r+1];const i=s[r+2];let a;n.indexed?(a=t,n.setAssetRefPlaceholderOnIndexed(o),a.owners.push(n.instanceIndex)):(a=e,n.setStatic(o,6,a.owners.length),a.owners.push(INNER_OBJ_PLACEHOLDER)),"number"==typeof o&&(o=~o),a.keys.push(o),a.uuids.push(i)}this.data[8]=e.owners.concat(t.owners);const r=this.data[9]=e.keys.concat(t.keys);for(let e=0;e<r.length;++e){const t=r[e];"string"==typeof t&&this.sharedStrings.traceString(t,r,e)}const n=this.data[10]=e.uuids.concat(t.uuids);for(let e=0;e<n.length;++e){const t=n[e];this.sharedUuids.traceString(t,n,e)}}finalizeJsonPart(){this.collectInstances(),this.dumpDependUuids(),this.dumpInstances(),this.data[0]=exports.FORMAT_VERSION;const{sharedClasses:e,sharedMasks:t}=(0,create_class_mask_1.default)(this.classNodes);this.data[3]=e,this.data[4]=reduceEmptyArray(t),this.dumpInstanceTypes(),this.data[7]=this.refsBuilder.build()||EMPTY_PLACEHOLDER;const s=this.sharedStrings.dump();this.data[2]=reduceEmptyArray(s);const r=this.sharedUuids.dump();return this.data[1]=reduceEmptyArray(r),this.data}}function getRootData(e){const t=e[5];if(Array.isArray(t)){const e=t[t.length-1];return"number"==typeof e?t[e>=0?e:~e]:t[0]}return t}exports.default=CompiledBuilder,exports.getRootData=getRootData;