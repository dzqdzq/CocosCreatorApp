"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingClass=exports.MissingClassReporter=void 0;const ElectronModule=require("@base/electron-module"),pkg=require("@editor/package"),_=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker"),missing_reporter_1=require("./missing-reporter");function report(s,e,r,i){const t=missing_reporter_1.MissingReporter.getObjectType(r),o=i&&ps.basename(i);if(r instanceof cc.SceneAsset||r instanceof cc.Prefab){let r,n,a;s instanceof cc.Component?a=(n=s).node:cc.Node.isNode(s)&&(a=s);const c=o?` in ${t} "${o}"`:"";let l=e,p=!1;if(n){let s=cc.js.getClassName(n);n instanceof cc._MissingScript&&(p=!0,l=s=n._$erialized.__type__),r=`Class "${e}" used by component "${s}"${c} is missing or invalid.`}else{if(!a)return;p=!0,r=`Script "${e}" attached to "${a.name}"${c} is missing or invalid.`}r+=missing_reporter_1.MissingReporter.INFO_DETAILED,i&&(r+=`Asset url: "${i}"\n`);const g=ElectronModule.require("UuidUtils");p&&g.isUuid(l)&&(r+=`Script UUID: "${g.decompressUuid(l)}"\n`,r+=`Class ID: "${l}"\n`),r.slice(0,-1),console.error(r)}}function reportByWalker(s,e,r,i,t,o){let n;o=o||s._$erialized&&s._$erialized.__type__,report(n=e instanceof cc.Component||cc.Node.isNode(e)?e:_.findLast(r,s=>s instanceof cc.Component||cc.Node.isNode(s)),o,i,t)}class MissingClassReporter extends missing_reporter_1.MissingReporter{report(){ObjectWalker.walk(this.root,(s,e,r,i)=>{this.missingObjects.has(r)&&reportByWalker(r,s,i,this.root)})}reportByOwner(){let s;if(this.root instanceof cc.Asset)try{const e=pkg.execSync("asset-db","queryAssetInfo",this.root._uuid);s=e?e.path:null}catch(e){s=null}ObjectWalker.walkProperties(this.root,(e,r,i,t)=>{const o=this.missingOwners.get(e);if(o&&r in o){const n=o[r];reportByWalker(i,e,t,this.root,s,n)}},{dontSkipNull:!0})}}exports.MissingClassReporter=MissingClassReporter,exports.MissingClass={reporter:new MissingClassReporter,classFinder(s,e,r,i){const t=cc.js._getClassById(s);return t||(s&&(console.warn(`Missing class: ${s}`),exports.MissingClass.hasMissingClass=!0,exports.MissingClass.reporter.stashByOwner(r,i,s)),null)},hasMissingClass:!1,reportMissingClass(s){s._uuid&&(exports.MissingClass.hasMissingClass&&(exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner(),exports.MissingClass.hasMissingClass=!1),exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner())},reset(){exports.MissingClass.reporter.reset()}},exports.MissingClass.classFinder.onDereferenced=function(s,e,r,i){const t=exports.MissingClass.reporter.removeStashedByOwner(s,e);t&&exports.MissingClass.reporter.stashByOwner(r,i,t)};