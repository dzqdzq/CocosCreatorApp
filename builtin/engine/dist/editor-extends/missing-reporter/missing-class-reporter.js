"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingClass=exports.MissingClassReporter=void 0;const _=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker"),missing_reporter_1=require("./missing-reporter");async function report(s,e,r,t){const i=missing_reporter_1.MissingReporter.getObjectType(r),n=t&&ps.basename(t);if(r instanceof cc.SceneAsset||r instanceof cc.Prefab){let r,o,a;s instanceof cc.Component?a=(o=s).node:cc.Node.isNode(s)&&(a=s);const c=n?` in ${i} "${n}"`:"";let l=e,p=!1;if(o){let s=cc.js.getClassName(o);o instanceof cc._MissingScript&&(p=!0,l=s=o._$erialized.__type__),r=`Class "${e}" used by component "${s}"${c} is missing or invalid.`}else{if(!a)return;p=!0,r=`Script "${e}" attached to "${a.name}"${c} is missing or invalid.`}r+=missing_reporter_1.MissingReporter.INFO_DETAILED;try{let s=a,e=s.name;for(;s.parent&&!(s.parent instanceof cc.Scene);)e=`${(s=s.parent).name}/${e}`;r+=`Node path: "${e}"\n`}catch(s){}if(t&&(r+=`Asset url: "${t}"\n`),p&&Editor.Utils.UUID.isUUID(l)){const s=Editor.Utils.UUID.decompressUUID(l);try{const e=await Editor.Message.request("asset-db","query-missing-asset-info",s.match(/[^@]*/)[0]);e&&(r+=`Script file: "${e.path}"\n`,r+=`Script deleted time: "${new Date(e.removeTime).toLocaleString()}"\n`)}catch(s){}r+=`Script UUID: "${s}"\n`,r+=`Class ID: "${l}"\n`}r.slice(0,-1),console.error(r)}}async function reportByWalker(s,e,r,t,i,n){let o;n=n||s._$erialized&&s._$erialized.__type__,o=e instanceof cc.Component||cc.Node.isNode(e)?e:_.findLast(r,s=>s instanceof cc.Component||cc.Node.isNode(s)),await report(o,n,t,i)}class MissingClassReporter extends missing_reporter_1.MissingReporter{report(){ObjectWalker.walk(this.root,(s,e,r,t)=>{this.missingObjects.has(r)&&reportByWalker(r,s,t,this.root)})}reportByOwner(){let s,e;if(this.root instanceof cc.Asset){try{globalThis.Manager&&globalThis.Manager.assetDBMap&&(e=globalThis.Manager.Utils.queryAssetInfo(this.root._uuid))}catch(s){console.error(s),e=null}s=e?e.path:null}ObjectWalker.walkProperties(this.root,(e,r,t,i)=>{const n=this.missingOwners.get(e);if(n&&r in n){const o=n[r];reportByWalker(t,e,i,this.root,s,o)}},{dontSkipNull:!0})}}exports.MissingClassReporter=MissingClassReporter,exports.MissingClass={reporter:new MissingClassReporter,classFinder(s,e,r,t){const i=cc.js.getClassById(s);return i||(s&&(console.warn(`Missing class: ${s}`),exports.MissingClass.hasMissingClass=!0,exports.MissingClass.reporter.stashByOwner(r,t,s)),null)},hasMissingClass:!1,reportMissingClass(s){s._uuid&&exports.MissingClass.hasMissingClass&&(exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner(),exports.MissingClass.hasMissingClass=!1)},reset(){exports.MissingClass.reporter.reset()}},exports.MissingClass.classFinder.onDereferenced=function(s,e,r,t){const i=exports.MissingClass.reporter.removeStashedByOwner(s,e);i&&exports.MissingClass.reporter.stashByOwner(r,t,i)};