"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingClass=exports.MissingClassReporter=void 0;const ElectronModule=require("@base/electron-module"),pkg=require("@editor/package");var _=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker");const missing_reporter_1=require("./missing-reporter");function report(s,e,r,i){var t=missing_reporter_1.MissingReporter.getObjectType(r),o=i&&ps.basename(i);if(r instanceof cc.SceneAsset||r instanceof cc.Prefab){var n,a,p;s instanceof cc.Component?p=(a=s).node:cc.Node.isNode(s)&&(p=s);var l=o?` in ${t} "${o}"`:"",c=e,g=!1;if(a){var d=cc.js.getClassName(a);a instanceof cc._MissingScript&&(g=!0,c=d=a._$erialized.__type__),n=`Class "${e}" used by component "${d}"${l} is missing or invalid.`}else{if(!p)return;g=!0,n=`Script "${e}" attached to "${p.name}"${l} is missing or invalid.`}n+=missing_reporter_1.MissingReporter.INFO_DETAILED,i&&(n+=`Asset url: "${i}"\n`);let r=ElectronModule.require("UuidUtils");g&&r.isUuid(c)&&(n+=`Script UUID: "${r.decompressUuid(c)}"\n`,n+=`Class ID: "${c}"\n`),n.slice(0,-1),console.error(n)}}function reportByWalker(s,e,r,i,t,o){o=o||s._$erialized&&s._$erialized.__type__,report(e instanceof cc.Component||cc.Node.isNode(e)?e:_.findLast(r,s=>s instanceof cc.Component||cc.Node.isNode(s)),o,i,t)}class MissingClassReporter extends missing_reporter_1.MissingReporter{report(){ObjectWalker.walk(this.root,(s,e,r,i)=>{this.missingObjects.has(r)&&reportByWalker(r,s,i,this.root)})}reportByOwner(){var s;if(this.root instanceof cc.Asset){const e=pkg.execSync("asset-db","queryAssetInfo",this.root._uuid);s=e?e.path:null}ObjectWalker.walkProperties(this.root,(e,r,i,t)=>{var o=this.missingOwners.get(e);if(o&&r in o){var n=o[r];reportByWalker(i,e,t,this.root,s,n)}},{dontSkipNull:!0})}}exports.MissingClassReporter=MissingClassReporter,exports.MissingClass={reporter:new MissingClassReporter,classFinder(s,e,r,i){var t=cc.js._getClassById(s);return t||(s&&(console.warn(`Missing class: ${s}`),exports.MissingClass.hasMissingClass=!0,exports.MissingClass.reporter.stashByOwner(r,i,s)),null)},hasMissingClass:!1,reportMissingClass(s){exports.MissingClass.hasMissingClass&&(exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner(),exports.MissingClass.hasMissingClass=!1),exports.MissingClass.reporter.root=s,exports.MissingClass.reporter.reportByOwner()},reset(){exports.MissingClass.reporter.reset()}},exports.MissingClass.classFinder.onDereferenced=function(s,e,r,i){var t=exports.MissingClass.reporter.removeStashedByOwner(s,e);t&&exports.MissingClass.reporter.stashByOwner(r,i,t)};