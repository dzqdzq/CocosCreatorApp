"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingObjectReporter=void 0;const missing_reporter_1=require("./missing-reporter"),_=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker");class MissingObjectReporter extends missing_reporter_1.MissingReporter{async doReport(e,s,t,i,n){let r,o,a="";if((r=e instanceof cc.Component||e instanceof cc.Asset?e:_.findLast(t,e=>e instanceof cc.Component||e instanceof cc.Asset))instanceof cc.Component){a=` by ${missing_reporter_1.MissingReporter.getObjectType(r)} "${cc.js.getClassName(r)}"`}else(r=_.findLast(t,e=>e instanceof cc.Node))&&(a=` by node "${r.name}"`);if("string"==typeof s)o=`Asset "${s}" used${a}${n} is missing.`;else{let e=cc.js.getClassName(s);e.startsWith("cc.")&&(e=e.slice(3)),o=s instanceof cc.Asset?`The ${e} used${a}${n} is missing.`:`The ${e} referenced${a}${n} is invalid.`}o+=missing_reporter_1.MissingReporter.INFO_DETAILED,r instanceof cc.Component&&(r=r.node);try{if(r instanceof cc.Node){let e=r,s=e.name;for(;e.parent&&!(e.parent instanceof cc.Scene);)s=`${(e=e.parent).name}/${s}`;o+=`Node path: "${s}"\n`}}catch(e){}if(i&&(o+=`Asset url: "${i}"\n`),s instanceof cc.Asset&&s._uuid){try{const e=await Editor.Message.request("asset-db","query-missing-asset-info",s._uuid.match(/[^@]*/)[0]);e&&(o+=`Asset file: "${e.path}"\n`,o+=`Asset deleted time: "${new Date(e.removeTime).toLocaleString()}"\n`)}catch(e){}o+=`Missing uuid: "${s._uuid}"\n`}o.slice(0,-1),console[this.outputLevel]?console[this.outputLevel](o):console.warn(o)}report(){let e,s;if(this.root instanceof cc.Asset){try{globalThis.Manager&&Manager.assetDBManager.assetDBMap&&(s=globalThis.Manager.Utils.queryAssetInfo(this.root._uuid))}catch(e){console.error(e),s=null}e=s?s.path:null}const t=missing_reporter_1.MissingReporter.getObjectType(this.root),i=e?` in ${t} "${ps.basename(e)}"`:"";ObjectWalker.walk(this.root,(s,t,n,r,o)=>{this.missingObjects.has(n)&&this.doReport(s,n,r,e,i)})}reportByOwner(){let e,s;if(this.root instanceof cc.Asset){try{globalThis.Manager&&globalThis.Manager.assetDBManager.ready&&(s=globalThis.Manager.Utils.queryAssetInfo(this.root._uuid))}catch(e){console.error(e),s=null}e=s?s.path:null}const t=missing_reporter_1.MissingReporter.getObjectType(this.root),i=e?` in ${t} "${ps.basename(e)}"`:"";ObjectWalker.walkProperties(this.root,(s,t,n,r)=>{const o=this.missingOwners.get(s);if(o&&t in o){const a=o[t];this.doReport(s,a||n,r,e,i)}},{dontSkipNull:!0})}}exports.MissingObjectReporter=MissingObjectReporter;