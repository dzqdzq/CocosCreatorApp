"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissingObjectReporter=void 0;const missing_reporter_1=require("./missing-reporter"),_=require("lodash"),ps=require("path"),ObjectWalker=require("./object-walker"),pkg=require("@editor/package");class MissingObjectReporter extends missing_reporter_1.MissingReporter{doReport(e,s,t,i,r){let o,n,c="";if((o=e instanceof cc.Component||e instanceof cc.Asset?e:_.findLast(t,e=>e instanceof cc.Component||e instanceof cc.Asset))instanceof cc.Component){c=` by ${missing_reporter_1.MissingReporter.getObjectType(o)} "${cc.js.getClassName(o)}"`}else(o=_.findLast(t,e=>e instanceof cc.Node))&&(c=` by node "${o.name}"`);if("string"==typeof s)n=`Asset "${s}" used${c}${r} is missing.`;else{let e=cc.js.getClassName(s);e.startsWith("cc.")&&(e=e.slice(3)),n=s instanceof cc.Asset?`The ${e} used${c}${r} is missing.`:`The ${e} referenced${c}${r} is invalid.`}n+=missing_reporter_1.MissingReporter.INFO_DETAILED,o instanceof cc.Component&&(o=o.node),i&&(n+=`Asset url: "${i}"\n`),s instanceof cc.Asset&&s._uuid&&(n+=`Missing uuid: "${s._uuid}"\n`),n.slice(0,-1),console.error(n)}report(){let e,s;if(this.root instanceof cc.Asset){try{s=globalThis.Manager&&globalThis.Manager.AssetWorker?globalThis.Manager.Utils.queryAssetInfo(this.root._uuid):pkg.execSync("asset-db","queryAssetInfo",this.root._uuid)}catch(e){console.error(e),s=null}e=s?s.path:null}const t=missing_reporter_1.MissingReporter.getObjectType(this.root),i=e?` in ${t} "${ps.basename(e)}"`:"";ObjectWalker.walk(this.root,(s,t,r,o,n)=>{this.missingObjects.has(r)&&this.doReport(s,r,o,e,i)})}reportByOwner(){let e,s;if(this.root instanceof cc.Asset){try{s=globalThis.Manager&&globalThis.Manager.AssetWorker?globalThis.Manager.Utils.queryAssetInfo(this.root._uuid):pkg.execSync("asset-db","queryAssetInfo",this.root._uuid)}catch(e){console.error(e),s=null}e=s?s.path:null}const t=missing_reporter_1.MissingReporter.getObjectType(this.root),i=e?` in ${t} "${ps.basename(e)}"`:"";ObjectWalker.walkProperties(this.root,(s,t,r,o)=>{const n=this.missingOwners.get(s);if(n&&t in n){const c=n[t];this.doReport(s,c||r,o,e,i)}},{dontSkipNull:!0})}}exports.MissingObjectReporter=MissingObjectReporter;