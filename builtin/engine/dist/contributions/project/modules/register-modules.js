"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initEngineModules=exports.moduleConfigCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function initEngineModules(e){e=(0,path_1.join)(e,"editor","engine-features","render-config.json");if((0,fs_extra_1.existsSync)(e)){const n=(0,fs_extra_1.readJSONSync)(e);if(n&&n.features){const a=n.categories,d={},r={},l=[],u={};Object.keys(n.features).forEach(e=>{const s=e,o=n.features[s];i(o,s),o.category&&a[o.category]?(null==(e=a[o.category]).modules&&(e.modules={}),a[o.category].modules[s]=o):exports.moduleConfigCache.moduleTreeDump.default[s]=o,o.options&&Object.keys(o.options).forEach(t=>{i(o.options[t],t),o.options[t].default&&(d[s]._option=t,d[s]._value=!0),o.options[t].flags&&Object.entries(o.options[t].flags).forEach(([e,o])=>{var i;d[s]&&(null==(i=d[s])._flags&&(i._flags={}),null==(i=d[s]._flags)[t]&&(i[t]={}),d[s]._flags[t][e]=Boolean(o.default))})})}),exports.moduleConfigCache.moduleTreeDump.categories=a;await Editor.Profile.getConfig("engine","physics-2d-box2d")&&(await Editor.Profile.setConfig("engine","physics-2d-box2d",void 0,"default"),await Editor.Profile.setConfig("engine","physics-2d-box2d",void 0,"local"),await Editor.Profile.setConfig("engine","physics-2d-box2d",void 0,"global"),d["physics-2d"]._option="physics-2d-box2d-wasm",-1!==(e=l.findIndex(e=>"physics-2d-box2d"===e))?l.splice(e,1,"physics-2d-box2d-wasm"):l.push("physics-2d-box2d-wasm")),await Editor.Profile.setProject("engine","modules.includeModules",Array.from(new Set(l)).sort(),"default"),await Editor.Profile.setProject("engine","modules.moduleConfig",r,"default"),await Editor.Profile.setProject("engine","modules.flags",u,"default"),await Editor.Profile.setProject("engine","modules.cache",d,"default");var o,t,s,e=await Editor.Profile.getProject("engine","modules.cache","project");const f=await Editor.Profile.getProject("engine","modules.cache");function i(e,t){d[t]={_value:!!e.default},(exports.moduleConfigCache.features[t]=e).default&&(l.push(t),e.flags)&&Object.entries(e.flags).forEach(([e,o])=>{void 0!==o.default&&(u[e]=o.default)}),e.cmakeConfig&&(r[t]={native:e.cmakeConfig}),e.isNativeModule&&exports.moduleConfigCache.nativeCodeModules.push(t),e.flags&&Object.entries(e.flags).forEach(([e,o])=>{var i;null==(i=d[t])._flags&&(i._flags={}),null==(i=d[t]._flags)[t]&&(i[t]={}),d[t]._flags[t][e]=o.default}),e.dependencies&&(exports.moduleConfigCache.moduleDependMap[t]=e.dependencies,e.dependencies.forEach(e=>{exports.moduleConfigCache.moduleDependedMap[e]=exports.moduleConfigCache.moduleDependedMap[e]||[],exports.moduleConfigCache.moduleDependedMap[e].push(t)}))}e&&(t=n.features,s=e=[],Object.keys(t).forEach(e=>{var o=t[e],i=f[e];(i||o.default)&&(o.default&&!i&&o.required?s.push(e):(!o.default||i||o.required||(f[e]={_value:!1}),i&&(i._option?i._value&&s.push(i._option):i._value&&s.push(e))))}),o=await Editor.Profile.getProject("engine","modules.includeModules"),e=Array.from(new Set(e)),JSON.stringify(o)!==JSON.stringify(e)&&await Editor.Profile.setProject("engine","modules.includeModules",e.sort()),await Editor.Profile.setProject("engine","modules.cache",f,"project"))}else console.error("render-config.json is not exist in engine!")}else console.error("render-config.json is not exist in engine!")}exports.moduleConfigCache={moduleDependMap:{},moduleDependedMap:{},nativeCodeModules:[],features:{},moduleTreeDump:{default:{},categories:{}}},exports.initEngineModules=initEngineModules;