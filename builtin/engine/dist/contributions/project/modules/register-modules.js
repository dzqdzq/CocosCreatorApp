"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initEngineModules=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path");async function initEngineModules(e){const t=path_1.join(e,"editor","engine-features","render-config.json");if(!fs_extra_1.existsSync(t))return void console.error("render-config.json is not exist in engine!");const o=fs_extra_1.readJSONSync(t);if(!o||!o.features)return void console.error("render-config.json is not exist in engine!");const i={},n={},s=[],r={};function a(e,t){i[t]={_value:!!e.default},e.default?s.push(...e.default):e.required&&(s.push(t),i[t]._value=!0),e.native&&(n[t]={native:e.native}),function(e,t){if(!e.flags)return;r[t]||(r[t]={});Object.keys(e.flags).forEach(o=>{const i=e.flags[o];r[t][o]=!!i.default}),i[t].flags=r[t]}(e,t)}Object.keys(o.features).forEach(e=>{const t=o.features[e];a(t,e),t.options&&(t.multi?Object.keys(t.options).forEach(o=>{a(t.options[o],o),t.default&&!t.default.includes(o)&&(i[e]._value=!1),t.default&&t.default.includes(o)&&(i[o]?i[o]._value=!0:i[o]={_value:!0})}):(t.default&&(i[e]._option=t.default[0]),Object.keys(t.options).forEach(e=>{a(t.options[e],e)})))}),await Editor.Profile.setProject("engine","modules.includeModules",Array.from(new Set(s)).sort(),"default"),await Editor.Profile.setConfig("engine","modules.moduleConfig",n,"default"),await Editor.Profile.setConfig("engine","modules.flags",r,"default"),await Editor.Profile.setProject("engine","modules.cache",i,"default");const u=await Editor.Profile.getProject("engine","modules.cache");if(u){const e=[],t={};!function e(t,o,i){Object.keys(t).forEach(n=>{const s=t[n];if(s.options&&s.multi)return void e(s.options,o,i);const r=u[n];r.flags&&(i[n]=r.flags),(r||s.default)&&(!s.default||r?r._option?r._value&&o.push(r._option):r._value&&o.push(n):o.push(s.default[0]))})}(o.features,e,t);const i=await Editor.Profile.getProject("engine","modules.includeModules"),n=Array.from(new Set(e));JSON.stringify(i)!==JSON.stringify(n)&&await Editor.Profile.setProject("engine","modules.includeModules",n.sort());const s=await Editor.Profile.getProject("engine","modules.flags");JSON.stringify(s)!==JSON.stringify(t)&&await Editor.Profile.setProject("engine","modules.flags",t)}}exports.initEngineModules=initEngineModules;