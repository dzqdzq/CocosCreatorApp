"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initEngineModules=exports.moduleConfigCache=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),default_config_1=require("./default-config"),ignoreModules=["custom-pipeline-post-process"];function initRenderConfig2ModuleConfigCache(e){function t(o,e){(exports.moduleConfigCache.features[o]=e).cmakeConfig&&(exports.moduleConfigCache.moduleCmakeConfig[o]={native:e.cmakeConfig}),e.isNativeModule&&exports.moduleConfigCache.nativeCodeModules.push(o),e.dependencies&&(exports.moduleConfigCache.moduleDependMap[o]=e.dependencies,e.dependencies.forEach(e=>{exports.moduleConfigCache.moduleDependedMap[e]=exports.moduleConfigCache.moduleDependedMap[e]||[],exports.moduleConfigCache.moduleDependedMap[e].push(o)}))}const a=e.categories;Object.entries(e.features).forEach(([e,o])=>{var i,n;i=e,n=o,"options"in(exports.moduleConfigCache.features[i]=n)?Object.entries(n.options).forEach(([e,o])=>{t(e,o)}):t(i,n),ignoreModules.includes(e)||(o.category&&a[o.category]?(null==(i=a[o.category]).modules&&(i.modules={}),a[o.category].modules[e]=o):exports.moduleConfigCache.moduleTreeDump.default[e]=o),exports.moduleConfigCache.features[e]=o}),exports.moduleConfigCache.moduleTreeDump.categories=a}async function initEngineModules(e){e=(0,path_1.join)(e,"editor","engine-features","render-config.json");if((0,fs_extra_1.existsSync)(e)){e=(0,fs_extra_1.readJSONSync)(e);if(e&&e.features){initRenderConfig2ModuleConfigCache(e);var o=await generateConfigFromEngine(e);await initGraphicsConfig(o);for(const n of default_config_1.defaultConfigs)await generateDefaultConfig(o,n);var i=await Editor.Profile.getProject("engine","modules.configs","project");i&&await mergeAndCreateDefaultForLocal(e,i,o),await Editor.Profile.setProject("engine","modules.globalConfigKey",default_config_1.defaultConfigKey,"default")}else console.error("render-config.json is not exist in engine!")}else console.error("render-config.json is not exist in engine!")}async function generateConfigFromEngine(e){const t={},o=[],i={};function n(n,e){t[n]={_value:!!e.default},e.default&&(o.push(n),e.flags)&&Object.entries(e.flags).forEach(([e,o])=>{void 0!==o.default&&(i[e]=o.default)}),e.flags&&Object.entries(e.flags).forEach(([e,o])=>{var i;null==(i=t[n])._flags&&(i._flags={}),t[n]._flags[e]=Boolean(o.default)})}return Object.entries(e.features).forEach(([e,o])=>{var i;i=e,e=o,"options"in(exports.moduleConfigCache.features[i]=e)?(t[i]={_value:!!e.default},Object.entries(e.options).forEach(([e,o])=>{n(e,o),o.default&&(t[i]._option=e,t[i]._value=!0)})):n(i,e)}),{cache:t,flags:i,includeModules:Array.from(new Set(o)).sort(),noDeprecatedFeatures:{value:!1,version:""}}}async function generateDefaultConfig(e,o){var{cache:e,flags:i,includeModules:n,noDeprecatedFeatures:t}=e,e=(o.diyConfig(e,i,n),{name:o.name,cache:e,flags:i,includeModules:Array.from(new Set(n)).sort(),noDeprecatedFeatures:t});await Editor.Profile.setProject("engine","modules.configs."+o.key,e,"default")}async function mergeAndCreateDefaultForLocal(e,o,i){for(const[n,t]of Object.entries(o)){default_config_1.defaultConfigs.every(e=>e.key!==n)&&(await Editor.Profile.setProject("engine",`modules.configs.${n}.cache`,i.cache,"default"),await Editor.Profile.setProject("engine",`modules.configs.${n}.flags`,i.flags,"default"));const a=await Editor.Profile.getProject("engine",`modules.configs.${n}.cache`),s=[];Object.entries(e.features).forEach(([e,o])=>{var i=a[e];i?i._option?i._value&&s.push(i._option):i._value&&s.push(e):o.default&&(o.default&&o.required?s.push(e):o.default&&!o.required&&(a[e]={_value:!1}))}),await Editor.Profile.setProject("engine",`modules.configs.${n}.includeModules`,s.sort(),"project"),await Editor.Profile.setProject("engine",`modules.configs.${n}.cache`,a,"project")}}async function initGraphicsConfig(e){e.includeModules.includes("custom-pipeline")&&await Editor.Profile.setProject("engine","modules.graphics.pipeline","custom-pipeline","default"),e.includeModules.includes("legacy-pipeline")&&await Editor.Profile.setProject("engine","modules.graphics.pipeline","legacy-pipeline","default"),e.includeModules.includes("custom-pipeline")||e.includeModules.includes("legacy-pipeline")||await Editor.Profile.setProject("engine","modules.graphics.pipeline","custom-pipeline","default"),await Editor.Profile.setProject("engine","modules.graphics.custom-pipeline-post-process",e.includeModules.includes("custom-pipeline-post-process"),"default")}exports.moduleConfigCache={moduleDependMap:{},moduleDependedMap:{},nativeCodeModules:[],moduleCmakeConfig:{},features:{},moduleTreeDump:{default:{},categories:{}},ignoreModules:ignoreModules},exports.initEngineModules=initEngineModules;