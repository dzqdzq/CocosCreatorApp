"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,n)}:function(e,t,o,i){e[i=void 0===i?o:i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,o=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(o[o.length]=t);return o})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o=n(e),i=0;i<o.length;i++)"default"!==o[i]&&__createBinding(t,e,o[i]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.$=exports.template=exports.style=void 0,exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;const fs_extra_1=require("fs-extra"),path_1=require("path"),ModuleItem=__importStar(require("./module-item")),default_config_1=require("./default-config"),utils_1=require("./utils"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,moduleConfig=null;const envIconMap={HTML5:"html5",NATIVE:"native",MINIGAME:"mini-game"},vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/project-modules.html"),"utf8"),EngineProjectModulesVM=Vue.extend({name:"EngineProjectModulesVM",components:{"module-item":ModuleItem},data(){return{moduleTreeDump:{},saveTimer:null,moduleDependMap:{},moduleDependedMap:{},moduleCache:{},configs:{},globalConfigKey:"",selectedConfigKey:"",envLimitModule:{}}},computed:{allChecked(){var e=Object.keys(this.moduleTreeDump.default??{}).every(e=>this.moduleCache[e]&&!!this.moduleCache[e]._value||this.moduleTreeDump.default[e].hidden),t=Object.values(this.moduleTreeDump.categories??{}).map(e=>Object.entries(e.modules??{})).flat().every(([e,t])=>this.moduleCache[e]&&!!this.moduleCache[e]._value||t.hidden);return e&&t},currentConfig(){return this.configs[this.selectedConfigKey]??{}},noDeprecatedFeatures(){return this.currentConfig.noDeprecatedFeatures??{value:!1,version:""}},envLimitModuleIconMap(){const o={};return Object.entries(this.envLimitModule).forEach(([e,{envList:t}])=>{o[e]=t.map(e=>envIconMap[e]).filter(Boolean)}),o}},methods:{t(e){return e?(e=e.replace("i18n:",""),Editor.I18n.t(e)||e):""},async refresh(e=!0){var t,o,i,n,a=this;moduleConfig&&({moduleTreeDump:n,moduleDependMap:t,moduleDependedMap:o,envLimitModule:i}=moduleConfig,a.moduleTreeDump=n,a.moduleDependMap=Object.freeze(t),a.moduleDependedMap=Object.freeze(o),a.envLimitModule=i,n=await Editor.Profile.getProject("engine","modules.configs"),a.configs=n,a.globalConfigKey=await Editor.Profile.getProject("engine","modules.globalConfigKey"),a.selectedConfigKey&&n[a.selectedConfigKey]||(a.selectedConfigKey=a.globalConfigKey||Object.keys(n)[0]),a.moduleCache=a.configs[this.selectedConfigKey]?.cache,e)&&a.broadcast()},async save(){const n=[],a={},s=this.moduleCache;function t(i){Object.keys(i).forEach(e=>{var t=i[e],o=s[e];(o||t.default)&&(t.default&&!o?(n.push(e),"flags"in t&&Object.entries(t.flags).forEach(([e,t])=>{void 0!==t.default&&(a[e]=t.default)})):o._option?o._value&&(n.push(o._option),(t=s[o._option])?._flags)&&Object.assign(a,t._flags):o._value&&(n.push(e),o._flags)&&Object.assign(a,o._flags))})}Object.values(this.moduleTreeDump.categories).forEach(e=>e.modules&&t(e.modules)),t(this.moduleTreeDump.default);var e=this.configs[this.selectedConfigKey],e=Object.assign({},e,{cache:this.moduleCache,flags:a,includeModules:n.sort()});await Editor.Profile.setProject("engine","modules.configs."+this.selectedConfigKey,e),await this.refresh()},_onConfirm(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.save()},200)},_onCategoryConfirm(e,t){var e=e.target.value,t=this.moduleTreeDump.categories[t],o=t.modules??{};this.setGroupModule(e,o,t.required)},setGroupModule(o,i,e=!1){if(moduleConfig?.moduleTreeDump){const{moduleDependMap:n,features:a}=moduleConfig;Object.keys(i).forEach(e=>{var t;i[e].hidden||(t=!!i[e].required||o,this.moduleCache[e]?this.moduleCache[e]._value=t:this.moduleCache[e]={_value:t},n[e]?.forEach?.(e=>{var t=!!a[e].required||o;this.moduleCache[e]._value=t}))}),e&&!o&&Object.keys(i).forEach(e=>{a[e].default&&(this.moduleCache[e]._value=!0)})}},calcCategoryAllChecked(e){e=this.moduleTreeDump.categories[e].modules??{};return Object.entries(e).filter(([,e])=>!e.hidden).every(([e,t])=>!!t.required||Boolean(this.moduleCache[e]?._value))},calcCategoryIndeterminate(e){e=this.moduleTreeDump.categories[e].modules??{};return Object.entries(e).filter(([,e])=>!e.hidden).some(([e,t])=>!!t.required||Boolean(this.moduleCache[e]?._value))},async _onModuleChanged(o,e,t,i){if(moduleConfig?.moduleTreeDump)if(this.moduleCache[e][t]=i,"_option"===t&&"string"==typeof i&&(this.moduleCache[e]._value=!0),"_value"===t&&"boolean"==typeof i){const{moduleDependMap:n,moduleDependedMap:a,features:s}=moduleConfig;i?(t=n[e])&&t.length&&t.forEach(e=>{var t=!!s[e].required||i;this.moduleCache[e]._value!==t&&this._onModuleChanged(o,e,"_value",t)}):((t=a[e])&&t.length&&t.forEach(e=>{var t=!!s[e].required||i;this.moduleCache[e]._value!==t&&this._onModuleChanged(o,e,"_value",t)}),(t=n[e])&&t.length&&t.forEach(e=>{var t;s[e].hidden&&(t=!!s[e].required||i,this.moduleCache[e]._value!==i)&&this._onModuleChanged(o,e,"_value",t)}))}},onChangeFlag(e,t,o){this.moduleCache[e]?this.moduleCache[e]._flags?this.moduleCache[e]._flags[t]=o:this.moduleCache[e]._flags={[t]:o}:this.moduleCache[e]={_value:!0,_flags:{[t]:o}}},_onSelectAllChanged(e){const o=e.target.value,i=this.moduleTreeDump;Object.keys(i.categories).forEach(e=>{var t=i.categories[e].modules??{},e=i.categories[e].required;this.setGroupModule(o,t,e)}),this.setGroupModule(o,i.default,!1),this._onConfirm()},async selectConfig(e){this.selectedConfigKey=e,await this.refresh(!1)},async onChangeOtherConfig(e,t){await Editor.Profile.setProject("engine",e,t,"project"),await this.refresh(),"modules.globalConfigKey"===e&&this.broadcastGlobal()},async restoreConfig(){var e=await Editor.Profile.getProject("engine","modules.configs."+default_config_1.defaultConfigKey,"default"),e=Object.assign({},e,{name:this.configs[this.selectedConfigKey].name,noDeprecatedFeatures:this.configs[this.selectedConfigKey].noDeprecatedFeatures});await Editor.Profile.setProject("engine","modules.configs."+this.selectedConfigKey,e,"project"),await this.refresh()},async addDefaultConfig(){var e=await Editor.Profile.getProject("engine","modules.configs."+default_config_1.defaultConfigKey,"default"),t="zh"===Editor.I18n.getLanguage()?"自定义配置":"New Custom Config";this.addConfig(Object.assign(e,{name:t}))},async addConfig(e){const t="custom-config-"+(0,utils_1.generateUuid)();await Editor.Profile.setProject("engine","modules.configs."+t,e,"project"),await this.refresh(),this.$nextTick(()=>{this.selectedConfigKey=t,this.$refs["focus-dom"]?.scrollIntoView()})},showMoreOperation(o){Editor.Menu.popup({menu:[{label:"i18n:engine.project.modules.deleteConfig",enabled:o!==default_config_1.defaultConfigKey&&o!==this.globalConfigKey,click:async()=>{await Editor.Profile.setProject("engine","modules.configs."+o,void 0,"project"),await this.refresh()}},{label:"i18n:engine.project.modules.copyConfig",enabled:!0,click:async()=>{var e,t=this.configs[o];t&&(e="zh"===Editor.I18n.getLanguage()?"_副本":"_COPY",this.addConfig(Object.assign(t,{name:t.name+e})))}},{label:"i18n:engine.project.modules.setAsGlobalConfig",enabled:o!==this.globalConfigKey,click:async()=>{this.onChangeOtherConfig("modules.globalConfigKey",o)}},{label:"i18n:engine.project.modules.copyKey",click:async()=>{Editor.Clipboard.write("text",o)}}]})},broadcast(){this.$nextTick(()=>{Editor.Message.broadcast("engine:engine-modules-config-changed"),this.selectedConfigKey===this.globalConfigKey&&this.broadcastGlobal()})},broadcastGlobal(){var e=this.configs[this.globalConfigKey].includeModules;Editor.Message.broadcast("engine:engine-modules-global-config-changed",e)}},template:vueTemplate});async function ready(){panel=this,moduleConfig=await Editor.Message.request("engine","query-modules-config"),vm?.$destroy(),(vm=new EngineProjectModulesVM).$mount(panel.$.container),vm.refresh(!1),Editor.Message.__protected__.addBroadcastListener("project:engine-modules-changed",vm.refresh)}function close(){vm&&Editor.Message.__protected__.removeBroadcastListener("project:engine-modules-changed",vm.refresh),vm?.$destroy(),vm=null,panel=null}async function exportConfig(){var e={};return e.modules=await Editor.Message.request("project","query-config","engine","modules")||{},e}async function importConfig(e){e.modules&&await Editor.Message.request("project","set-config","engine","modules",e.modules)}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./project-modules.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"};