"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ModuleItem=__importStar(require("./module-item")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/project-modules.html"),"utf8"),EngineProjectModulesVM=Vue.extend({name:"EngineProjectModulesVM",components:{"module-item":ModuleItem},data:()=>({all:!0,modulesDump:{},moduleCache:{},categories:{},noDeprecatedFeatures:{value:!1,version:""},saveTimer:null}),methods:{t:e=>e?(e=e.replace("i18n:",""),Editor.I18n.t(e)||e):"",async refresh(){const e=await Editor.Profile.getProject("engine","modules.noDeprecatedFeatures");this.noDeprecatedFeatures=e;const t=await Editor.Message.request("engine","query-engine-info"),o=(0,fs_extra_1.readJSONSync)((0,path_1.join)(t.typescript.path,"editor","engine-features","render-config.json"));this.categories=o.categories||{};const s=o.features,r={default:{}},i=await Editor.Profile.getProject("engine","modules.cache");this.all=!Object.keys(s).some(e=>i[e]&&!i[e]._value),Object.entries(s).forEach(([e,t])=>{if(t.category)return r[t.category]||(r[t.category]={}),void(r[t.category][e]=t);r.default[e]=t}),this.modulesDump=r,this.moduleCache=i},async save(){let e=!0;const t=[],o={},s=this.moduleCache;Object.values(this.modulesDump).forEach(r=>(function r(i){Object.keys(i).forEach(n=>{const a=i[n];if(a.options&&a.multi)return r(a.options);const u=s[n];u.flags&&(o[n]=u.flags),(u||a.default)&&(!a.default||u?(u._value||(e=!1),u._option?u._value&&t.push(u._option):u._value&&t.push(n)):t.push(a.default[0]))})})(r)),this.all=e,Editor.Profile.setProject("engine","modules.cache",this.moduleCache),Editor.Profile.setProject("engine","modules.flags",o),Editor.Profile.setProject("engine","modules.includeModules",t.sort()),Editor.Profile.setProject("engine","modules.noDeprecatedFeatures",this.noDeprecatedFeatures),Editor.Message.broadcast("engine:modules-changed")},onDeprecatedAPI(e,t){this.noDeprecatedFeatures[e]=t},_onConfirm(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.save()},200)},_onSelectAllChanged(e){const t=this.moduleCache;Object.values(this.modulesDump).forEach(function o(s){Object.keys(s).forEach(r=>{const i=s[r];i.options&&!1!==i.multi&&o(i.options),i.required||(t[r]||(t[r]={_value:e.target.value}),t[r]._value=e.target.value)})}),this._onConfirm()}},template:vueTemplate});function ready(){panel=this,null===vm||void 0===vm||vm.$destroy(),(vm=new EngineProjectModulesVM).$mount(panel.$.container),vm.refresh(),Editor.Message.__protected__.addBroadcastListener("project:engine-modules-changed",vm.refresh)}function close(){vm&&Editor.Message.__protected__.removeBroadcastListener("project:engine-modules-changed",vm.refresh),null===vm||void 0===vm||vm.$destroy(),vm=null,panel=null}async function exportConfig(){const e={};return e["modules.cache"]=await Editor.Message.request("project","query-config","engine","modules.cache")||{},e["modules.flags"]=await Editor.Message.request("project","query-config","engine","modules.flags")||{},e["modules.includeModules"]=await Editor.Message.request("project","query-config","engine","modules.includeModules")||[],e["modules.noDeprecatedFeatures"]=await Editor.Message.request("project","query-config","engine","modules.cache")||{},e}async function importConfig(e){e["modules.cache"]&&await Editor.Message.request("project","set-config","engine","modules.cache",e["modules.cache"]),e["modules.flags"]&&await Editor.Message.request("project","set-config","engine","modules.flags",e["modules.flags"]),e["modules.includeModules"]&&await Editor.Message.request("project","set-config","engine","modules.includeModules",e["modules.includeModules"]),e["modules.noDeprecatedFeatures"]&&await Editor.Message.request("project","set-config","engine","modules.noDeprecatedFeatures",e["modules.noDeprecatedFeatures"])}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./project-modules.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;