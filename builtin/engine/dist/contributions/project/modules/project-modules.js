"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,i){void 0===i&&(i=t);var n=Object.getOwnPropertyDescriptor(o,t);n&&("get"in n?o.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,i,n)}:function(e,o,t,i){e[i=void 0===i?t:i]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ModuleItem=__importStar(require("./module-item")),default_config_1=require("./default-config"),utils_1=require("./utils"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,moduleConfig=null;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/project-modules.html"),"utf8"),EngineProjectModulesVM=Vue.extend({name:"EngineProjectModulesVM",components:{"module-item":ModuleItem},data(){return{moduleTreeDump:{},saveTimer:null,moduleDependMap:{},moduleDependedMap:{},moduleCache:{},configs:{},globalConfigKey:"",selectedConfigKey:""}},computed:{allChecked(){var e=Object.keys(null!=(e=this.moduleTreeDump.default)?e:{}).every(e=>this.moduleCache[e]&&!!this.moduleCache[e]._value||this.moduleTreeDump.default[e].hidden),o=Object.values(null!=(o=this.moduleTreeDump.categories)?o:{}).map(e=>{return Object.entries(null!=(e=e.modules)?e:{})}).flat().every(([e,o])=>this.moduleCache[e]&&!!this.moduleCache[e]._value||o.hidden);return e&&o},currentConfig(){var e;return null!=(e=this.configs[this.selectedConfigKey])?e:{}},noDeprecatedFeatures(){var e;return null!=(e=this.currentConfig.noDeprecatedFeatures)?e:{value:!1,version:""}}},methods:{t(e){return e?(e=e.replace("i18n:",""),Editor.I18n.t(e)||e):""},async refresh(e=!0){var o,t,i,n=this;moduleConfig&&({moduleTreeDump:i,moduleDependMap:o,moduleDependedMap:t}=moduleConfig,n.moduleTreeDump=i,n.moduleDependMap=Object.freeze(o),n.moduleDependedMap=Object.freeze(t),i=await Editor.Profile.getProject("engine","modules.configs"),n.configs=i,n.globalConfigKey=await Editor.Profile.getProject("engine","modules.globalConfigKey"),n.selectedConfigKey&&i[n.selectedConfigKey]||(n.selectedConfigKey=n.globalConfigKey||Object.keys(i)[0]),n.moduleCache=null==(o=n.configs[this.selectedConfigKey])?void 0:o.cache,e)&&n.broadcast()},async save(){const n=[],l={},a=this.moduleCache;function o(i){Object.keys(i).forEach(e=>{var o=i[e],t=a[e];(t||o.default)&&(o.default&&!t?(n.push(e),"flags"in o&&Object.entries(o.flags).forEach(([e,o])=>{void 0!==o.default&&(l[e]=o.default)})):t._option?t._value&&(n.push(t._option),null!=(o=a[t._option]))&&o._flags&&Object.assign(l,o._flags):t._value&&(n.push(e),t._flags)&&Object.assign(l,t._flags))})}Object.values(this.moduleTreeDump.categories).forEach(e=>e.modules&&o(e.modules)),o(this.moduleTreeDump.default);var e=this.configs[this.selectedConfigKey],e=Object.assign({},e,{cache:this.moduleCache,flags:l,includeModules:n.sort()});await Editor.Profile.setProject("engine","modules.configs."+this.selectedConfigKey,e),await this.refresh()},_onConfirm(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.save()},200)},_onCategoryConfirm(e,o){var e=e.target.value,o=this.moduleTreeDump.categories[o],t=null!=(t=o.modules)?t:{};this.setGroupModule(e,t,o.required)},setGroupModule(t,i,e=!1){if(null!==moduleConfig&&void 0!==moduleConfig&&moduleConfig.moduleTreeDump){const{moduleDependMap:n,features:l}=moduleConfig;Object.keys(i).forEach(e=>{var o;i[e].hidden||(o=!!i[e].required||t,this.moduleCache[e]?this.moduleCache[e]._value=o:this.moduleCache[e]={_value:o},null!=(e=null==(o=n[e])?void 0:o.forEach)&&e.call(o,e=>{var o=!!l[e].required||t;this.moduleCache[e]._value=o}))}),e&&!t&&Object.keys(i).forEach(e=>{l[e].default&&(this.moduleCache[e]._value=!0)})}},calcCategoryAllChecked(e){e=null!=(e=this.moduleTreeDump.categories[e].modules)?e:{};return Object.entries(e).filter(([,e])=>!e.hidden).every(([e,o])=>{return!!o.required||Boolean(null==(o=this.moduleCache[e])?void 0:o._value)})},calcCategoryIndeterminate(e){e=null!=(e=this.moduleTreeDump.categories[e].modules)?e:{};return Object.entries(e).filter(([,e])=>!e.hidden).some(([e,o])=>{return!!o.required||Boolean(null==(o=this.moduleCache[e])?void 0:o._value)})},async _onModuleChanged(t,e,o,i){if(null!==moduleConfig&&void 0!==moduleConfig&&moduleConfig.moduleTreeDump)if(this.moduleCache[e][o]=i,"_option"===o&&"string"==typeof i&&(this.moduleCache[e]._value=!0),"_value"===o&&"boolean"==typeof i){const{moduleDependMap:n,moduleDependedMap:l,features:a}=moduleConfig;i?(o=n[e])&&o.length&&o.forEach(e=>{var o=!!a[e].required||i;this.moduleCache[e]._value!==o&&this._onModuleChanged(t,e,"_value",o)}):((o=l[e])&&o.length&&o.forEach(e=>{var o=!!a[e].required||i;this.moduleCache[e]._value!==o&&this._onModuleChanged(t,e,"_value",o)}),(o=n[e])&&o.length&&o.forEach(e=>{var o;a[e].hidden&&(o=!!a[e].required||i,this.moduleCache[e]._value!==i)&&this._onModuleChanged(t,e,"_value",o)}))}},onChangeFlag(e,o,t){this.moduleCache[e]?this.moduleCache[e]._flags?this.moduleCache[e]._flags[o]=t:this.moduleCache[e]._flags={[o]:t}:this.moduleCache[e]={_value:!0,_flags:{[o]:t}}},_onSelectAllChanged(e){const t=e.target.value,i=this.moduleTreeDump;Object.keys(i.categories).forEach(e=>{var o=null!=(o=i.categories[e].modules)?o:{},e=i.categories[e].required;this.setGroupModule(t,o,e)}),this.setGroupModule(t,i.default,!1),this._onConfirm()},async selectConfig(e){this.selectedConfigKey=e,await this.refresh(!1)},async onChangeOtherConfig(e,o){await Editor.Profile.setProject("engine",e,o,"project"),await this.refresh(),"modules.globalConfigKey"===e&&this.broadcastGlobal()},async restoreConfig(){var e=await Editor.Profile.getProject("engine","modules.configs."+default_config_1.defaultConfigKey,"default"),e=Object.assign({},e,{name:this.configs[this.selectedConfigKey].name,noDeprecatedFeatures:this.configs[this.selectedConfigKey].noDeprecatedFeatures});await Editor.Profile.setProject("engine","modules.configs."+this.selectedConfigKey,e,"project"),await this.refresh()},async addDefaultConfig(){var e=await Editor.Profile.getProject("engine","modules.configs."+default_config_1.defaultConfigKey,"default"),o="zh"===Editor.I18n.getLanguage()?"自定义配置":"New Custom Config";this.addConfig(Object.assign(e,{name:o}))},async addConfig(e){const o="custom-config-"+(0,utils_1.generateUuid)();await Editor.Profile.setProject("engine","modules.configs."+o,e,"project"),await this.refresh(),this.$nextTick(()=>{var e;this.selectedConfigKey=o,null!=(e=this.$refs["focus-dom"])&&e.scrollIntoView()})},showMoreOperation(t){Editor.Menu.popup({menu:[{label:"i18n:engine.project.modules.deleteConfig",enabled:t!==default_config_1.defaultConfigKey&&t!==this.globalConfigKey,click:async()=>{await Editor.Profile.setProject("engine","modules.configs."+t,void 0,"project"),await this.refresh()}},{label:"i18n:engine.project.modules.copyConfig",enabled:!0,click:async()=>{var e,o=this.configs[t];o&&(e="zh"===Editor.I18n.getLanguage()?"_副本":"_COPY",this.addConfig(Object.assign(o,{name:o.name+e})))}},{label:"i18n:engine.project.modules.setAsGlobalConfig",enabled:t!==this.globalConfigKey,click:async()=>{this.onChangeOtherConfig("modules.globalConfigKey",t)}},{label:"i18n:engine.project.modules.copyKey",click:async()=>{Editor.Clipboard.write("text",t)}}]})},broadcast(){this.$nextTick(()=>{Editor.Message.broadcast("engine:engine-modules-config-changed"),this.selectedConfigKey===this.globalConfigKey&&this.broadcastGlobal()})},broadcastGlobal(){var e=this.configs[this.globalConfigKey].includeModules;Editor.Message.broadcast("engine:engine-modules-global-config-changed",e)}},template:vueTemplate});async function ready(){panel=this,moduleConfig=await Editor.Message.request("engine","query-modules-config"),null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new EngineProjectModulesVM).$mount(panel.$.container),vm.refresh(!1),Editor.Message.__protected__.addBroadcastListener("project:engine-modules-changed",vm.refresh)}function close(){vm&&Editor.Message.__protected__.removeBroadcastListener("project:engine-modules-changed",vm.refresh),null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}async function exportConfig(){var e={};return e.modules=await Editor.Message.request("project","query-config","engine","modules")||{},e}async function importConfig(e){e.modules&&await Editor.Message.request("project","set-config","engine","modules",e.modules)}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./project-modules.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;