"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,r){void 0===r&&(r=t);var u=Object.getOwnPropertyDescriptor(o,t);u&&("get"in u?o.__esModule:!u.writable&&!u.configurable)||(u={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,r,u)}:function(e,o,t,r){e[r=void 0===r?t:r]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.importConfig=exports.exportConfig=exports.close=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ModuleItem=__importStar(require("./module-item")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,moduleConfig=null;const vueTemplate=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../../static/contributions/project-modules.html"),"utf8"),ignoreKeys=["custom-pipeline-post-process"],EngineProjectModulesVM=Vue.extend({name:"EngineProjectModulesVM",components:{"module-item":ModuleItem},data(){return{moduleTreeDump:{},moduleCache:{},noDeprecatedFeatures:{value:!1,version:""},saveTimer:null,moduleDependMap:{},moduleDependedMap:{}}},computed:{allChecked(){var e=Object.keys(null!=(e=this.moduleTreeDump.default)?e:{}).every(e=>{var o=this.moduleCache[e]&&!!this.moduleCache[e]._value;return!(o||!ignoreKeys.includes(e))||o}),o=Object.values(null!=(o=this.moduleTreeDump.categories)?o:{}).map(e=>{return Object.keys(null!=(e=e.modules)?e:{})}).flat().every(e=>this.moduleCache[e]&&!!this.moduleCache[e]._value);return e&&o}},methods:{t(e){return e?(e=e.replace("i18n:",""),Editor.I18n.t(e)||e):""},async refresh(){var e,o,t,r=this;moduleConfig&&({moduleTreeDump:t,moduleDependMap:e,moduleDependedMap:o}=moduleConfig,r.moduleTreeDump=t,r.moduleDependMap=Object.freeze(e),r.moduleDependedMap=Object.freeze(o),t=await Editor.Profile.getProject("engine","modules.cache"),r.moduleCache=t,r.noDeprecatedFeatures=await Editor.Profile.getProject("engine","modules.noDeprecatedFeatures"))},async save(){const u=[],l={},s=this.moduleCache;function o(r){Object.keys(r).forEach(e=>{var o=r[e],t=s[e];(t||o.default)&&(o.default&&!t?(u.push(e),o.flags&&Object.entries(o.flags).forEach(([e,o])=>{void 0!==o.default&&(l[e]=o.default)})):t._option?t._value&&(u.push(t._option),t._flags)&&(o=t._flags[t._option],Object.assign(l,o)):t._value&&(u.push(e),null!=(o=t._flags))&&o[e]&&Object.assign(l,t._flags[e]))})}Object.values(this.moduleTreeDump.categories).forEach(e=>e.modules&&o(e.modules)),o(this.moduleTreeDump.default),Editor.Profile.setProject("engine","modules.cache",this.moduleCache),Editor.Profile.setProject("engine","modules.flags",l),Editor.Profile.setProject("engine","modules.includeModules",u.sort()),Editor.Profile.setProject("engine","modules.noDeprecatedFeatures",this.noDeprecatedFeatures),Editor.Message.broadcast("engine:modules-changed")},onDeprecatedAPI(e,o){this.noDeprecatedFeatures[e]=o},_onConfirm(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.save()},200)},_onCategoryConfirm(e,o){const t=e.target.value;e=this.moduleTreeDump.categories[o];const r=null!=(o=e.modules)?o:{};Object.keys(r).forEach(e=>{var o=!!r[e].required||t;this.moduleCache[e]?this.moduleCache[e]._value=o:this.moduleCache[e]={_value:o}}),e.required&&!t&&Object.keys(r).forEach(e=>{null!==moduleConfig&&void 0!==moduleConfig&&moduleConfig.features[e].default&&(this.moduleCache[e]._value=!0)})},calcCategoryAllChecked(e){e=null!=(e=this.moduleTreeDump.categories[e].modules)?e:{};return Object.entries(e).filter(([,e])=>!e.hidden).every(([e,o])=>{return!(!o.required&&!ignoreKeys.includes(e))||Boolean(null==(o=this.moduleCache[e])?void 0:o._value)})},calcCategoryIndeterminate(e){e=null!=(e=this.moduleTreeDump.categories[e].modules)?e:{};return Object.entries(e).filter(([,e])=>!e.hidden).some(([e,o])=>{return!(!o.required&&!ignoreKeys.includes(e))||Boolean(null==(o=this.moduleCache[e])?void 0:o._value)})},async _onModuleChanged(t,e,o,r){if(null!==moduleConfig&&void 0!==moduleConfig&&moduleConfig.moduleTreeDump)if(this.moduleCache[e][o]=r,"_option"===o&&"string"==typeof r&&(this.moduleCache[r]._value=r),"_value"===o&&"boolean"==typeof r){const{moduleDependMap:u,moduleDependedMap:l,features:s}=moduleConfig;r?(o=u[e])&&o.length&&o.forEach(e=>{var o=!!s[e].required||r;this.moduleCache[e]._value!==o&&this._onModuleChanged(t,e,"_value",o)}):((o=l[e])&&o.length&&o.forEach(e=>{var o=!!s[e].required||r;this.moduleCache[e]._value!==o&&this._onModuleChanged(t,e,"_value",o)}),(o=u[e])&&o.length&&o.forEach(e=>{var o;s[e].hidden&&(o=!!s[e].required||r,this.moduleCache[e]._value!==r)&&this._onModuleChanged(t,e,"_value",o)}))}},onChangeFlag(e,o,t,r){this.moduleCache[e]&&(this.moduleCache[e]._flags||(this.moduleCache[e]._flags={[o]:{[t]:r}}),this.moduleCache[e]._flags[o]||(this.moduleCache[e]._flags[o]={[t]:r}),this.moduleCache[e]._flags[o][t]=r)},_onSelectAllChanged(r){const u=r.target.value,l=this.moduleCache,t=this.moduleTreeDump;function s(e,t=!1){Object.entries(e).forEach(([e,o])=>{o.required||ignoreKeys.includes(e)||(null==l[e]&&(l[e]={_value:u}),l[e]._value=r.target.value,t&&!u&&null!==moduleConfig&&void 0!==moduleConfig&&moduleConfig.features[e].default&&(l[e]._value=!0))})}Object.keys(t.categories).forEach(e=>{var o;s(null!=(o=t.categories[e].modules)?o:{},t.categories[e].required)}),s(t.default),this._onConfirm()}},template:vueTemplate});async function ready(){panel=this,moduleConfig=await Editor.Message.request("engine","query-modules-config"),null!==vm&&void 0!==vm&&vm.$destroy(),(vm=new EngineProjectModulesVM).$mount(panel.$.container),vm.refresh(),Editor.Message.__protected__.addBroadcastListener("project:engine-modules-changed",vm.refresh)}function close(){vm&&Editor.Message.__protected__.removeBroadcastListener("project:engine-modules-changed",vm.refresh),null!==vm&&void 0!==vm&&vm.$destroy(),vm=null,panel=null}async function exportConfig(){var e={};return e["modules.cache"]=await Editor.Message.request("project","query-config","engine","modules.cache")||{},e["modules.flags"]=await Editor.Message.request("project","query-config","engine","modules.flags")||{},e["modules.includeModules"]=await Editor.Message.request("project","query-config","engine","modules.includeModules")||[],e["modules.noDeprecatedFeatures"]=await Editor.Message.request("project","query-config","engine","modules.noDeprecatedFeatures")||{},e}async function importConfig(e){e["modules.cache"]&&await Editor.Message.request("project","set-config","engine","modules.cache",e["modules.cache"]),e["modules.flags"]&&await Editor.Message.request("project","set-config","engine","modules.flags",e["modules.flags"]),e["modules.includeModules"]&&await Editor.Message.request("project","set-config","engine","modules.includeModules",e["modules.includeModules"]),e["modules.noDeprecatedFeatures"]&&await Editor.Message.request("project","set-config","engine","modules.noDeprecatedFeatures",e["modules.noDeprecatedFeatures"])}exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./project-modules.css"),"utf8"),exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.close=close,exports.exportConfig=exportConfig,exports.importConfig=importConfig;