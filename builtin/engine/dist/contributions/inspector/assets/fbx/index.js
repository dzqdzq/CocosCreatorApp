"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.destroyed=exports.mounted=exports.data=exports.watch=exports.methods=exports.components=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default,glPreview=new GlPreview("scene:model-preview","query-model-preview-data");exports.style=fs_extra_1.readFileSync(path_1.join(__dirname,"./style.css"),"utf8"),exports.template=fs_extra_1.readFileSync(path_1.join(__dirname,"./index.html"),"utf8"),exports.components={model:require("./components/model"),material:require("./components/material"),animation:require("./components/animation"),fbx:require("./components/fbx")};const previewConfig={},headerTabs=["model","animation","material","fbx"];var PlayState;function data(){return{info:null,meta:null,readonly:{value:!0},gridWidth:0,gridTableWith:0,activeTab:"animation",tabs:[],isPreviewDataDirty:!0,curEditClipInfo:null,curPlayState:PlayState.STOP,curTotalFrames:0}}function mounted(){const e=this;e.info=e.infos[0],e.meta=e.metas[0],Editor.Message.addBroadcastListener("scene:model-preview-model-info",e.updateModelInfo),Editor.Message.addBroadcastListener("scene:model-preview-animation-time-change",e.onModelAnimationUpdate),Editor.Message.addBroadcastListener("scene:model-preview-animation-state-change",e.onAnimationPlayStateChanged)}function destroyed(){Editor.Message.removeBroadcastListener("scene:model-preview-model-info",this.updateModelInfo),Editor.Message.removeBroadcastListener("scene:model-preview-animation-time-change",this.onModelAnimationUpdate),Editor.Message.removeBroadcastListener("scene:model-preview-animation-state-change",this.onAnimationPlayStateChanged),Editor.Message.request("scene","hide-model-preview")}!function(e){e[e.STOP=0]="STOP",e[e.PLAYING=1]="PLAYING",e[e.PAUSE=2]="PAUSE"}(PlayState||(PlayState={})),exports.methods={apply(){},resize(e){if(!e)return;this.gridTableWith=e-70},t:e=>Editor.I18n.t(`inspector.asset.fbx.${e}`),changeData(e,t,i){switch(i){case"number":e-=0;break;case"boolean":e=!!e}const a=t.split(".");this.metas.forEach(t=>{let i=t.userData;for(let e=0;e<a.length-1;e++)i[a[e]]||this.$set(i,a[e],{}),i=i[a[e]];this.$set(i,a[a.length-1],e)})},refresh(){const e=this,t=headerTabs.slice();"fbx"!==e.info.importer&&t.pop(),e.tabs=t,e.isPreviewDataDirty=!0,this.setCurPlayState(PlayState.STOP),e.initPreview(),e.$refs.animationModule&&(e.$refs.animationModule.onEditClipInfoChanged=(async t=>{t&&(await Editor.Message.request("scene","execute-model-preview-animation-operation","setEditClip",t.clipUUID),e.setCurEditClipInfo(t))}))},async initPreview(){var e;const t=this;t.$refs.image&&(t.from||(await glPreview.init({width:t.$refs.image.clientWidth,height:t.$refs.image.clientHeight}),await Editor.Message.request("scene","set-model-preview-model",null===(e=t.info.redirect)||void 0===e?void 0:e.uuid),t.$refs.image&&(glPreview.initGL(t.$refs.image,{width:t.$refs.image.clientWidth,height:t.$refs.image.clientHeight}),previewConfig.width=t.$refs.image.clientWidth,previewConfig.height=t.$refs.image.clientHeight,t.updateTask&&(cancelAnimationFrame(t.updateTask),t.updateTask=null),t.update())))},async update(){const e=this,t=e.$refs.image;if(e&&t){if(e.isPreviewDataDirty||e.curPlayState===PlayState.PLAYING){t.width=e.$refs.imageDiv.clientWidth,t.height=e.$refs.imageDiv.clientHeight;const i=await glPreview.queryPreviewData({width:e.$refs.imageDiv.clientWidth,height:e.$refs.imageDiv.clientHeight});i.width===previewConfig.width&&i.height===previewConfig.height||(glPreview.resizeGL(i.width,i.height),previewConfig.width=i.width,previewConfig.height=i.height);try{glPreview.drawGL(i.buffer,i.width,i.height)}catch(e){console.warn(e)}e.isPreviewDataDirty=!1}e.updateTask=requestAnimationFrame(async()=>{await e.update()})}else e.updateTask=null},onPreviewMouseDown(e){Editor.Message.request("scene","on-model-preview-mouse-down",{x:e.x,y:e.y}),e.target.requestPointerLock(),document.addEventListener("mousemove",this.onPreviewMouseMove),document.addEventListener("mouseup",this.onPreviewMouseUp);this.isPreviewDataDirty=!0},onPreviewMouseMove(e){Editor.Message.request("scene","on-model-preview-mouse-move",{movementX:e.movementX,movementY:e.movementY});this.isPreviewDataDirty=!0},onPreviewMouseUp(e){Editor.Message.request("scene","on-model-preview-mouse-up",{x:e.x,y:e.y}),document.exitPointerLock(),document.removeEventListener("mousemove",this.onPreviewMouseMove),document.removeEventListener("mouseup",this.onPreviewMouseUp);this.isPreviewDataDirty=!0},updateModelInfo(e){const t=this;t.$refs.verticesLabel&&(t.$refs.verticesLabel.value="Vertices:"+e.vertices),t.$refs.trianglesLabel&&(t.$refs.trianglesLabel.value="Triangles:"+e.polygons),t.isPreviewDataDirty=!0},async stopAnimation(){await Editor.Message.request("scene","execute-model-preview-animation-operation","stop")},async setCurEditClipInfo(e){const t=this;t.curEditClipInfo=e,e&&(t.curTotalFrames=Math.round(e.duration*e.fps),t.$refs.animationTimeSlider&&(t.$refs.animationTimeSlider.max=t.curTotalFrames),await Editor.Message.request("scene","execute-model-preview-animation-operation","setPlaybackRange",e.from,e.to),t.stopAnimation())},async onPlayButtonClick(e){e.stopPropagation();const t=this;if(t.curEditClipInfo){switch(t.curPlayState){case PlayState.PAUSE:await Editor.Message.request("scene","execute-model-preview-animation-operation","resume");break;case PlayState.PLAYING:await Editor.Message.request("scene","execute-model-preview-animation-operation","pause");break;case PlayState.STOP:await Editor.Message.request("scene","execute-model-preview-animation-operation","play",t.curEditClipInfo.clipUUID)}t.isPreviewDataDirty=!0}},async onStopButtonClick(e){e.stopPropagation();this.stopAnimation()},onModelAnimationUpdate(e){const t=this;t.$refs.animationTimeSlider&&(t.$refs.animationTimeSlider.value=Math.round((e-t.curEditClipInfo.from)*t.curEditClipInfo.fps)),t.$refs.timeLabel&&(t.$refs.timeLabel.value="Time:"+(e-t.curEditClipInfo.from).toFixed(2)+"(s)"),t.isPreviewDataDirty=!0},async onAnimationTimeSliderChange(e){e.stopPropagation();const t=e.target.value/this.curTotalFrames*this.curEditClipInfo.duration;await Editor.Message.request("scene","execute-model-preview-animation-operation","setCurEditTime",t),this.isPreviewDataDirty=!0},onAnimationTimeSliderConfirm(e){e.stopPropagation()},setCurPlayState(e){const t=this;t.curPlayState=e;let i="";switch(e){case PlayState.STOP:i="play";break;case PlayState.PLAYING:i="pause";break;case PlayState.PAUSE:i="play"}t.$refs.playButtonIcon&&(t.$refs.playButtonIcon.value=i)},onAnimationPlayStateChanged(e){this.setCurPlayState(e)}},exports.watch={metas(){this.meta=this.metas[0]},meta(){this.resize(this.width),this.refresh()},infos(){this.info=this.infos[0]},info(){this.readonly.value=this.info&&this.info.readonly,this.refresh()},width(){this.resize(this.width)}},exports.data=data,exports.mounted=mounted,exports.destroyed=destroyed;