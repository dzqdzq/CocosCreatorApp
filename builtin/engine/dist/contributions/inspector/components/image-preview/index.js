"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.destroyed=exports.watch=exports.mounted=exports.methods=exports.data=exports.props=void 0;const textureType=["texture","texture-cube"];function data(){return{info:"0 x 0"}}async function mounted(){this.loadImage()}function destroyed(){this._destroyed=!0}function getFitSize(e,t,a,i){let s=e,r=t;return e>a&&t>i?(s=a,(r=t*a/e)>i&&(r=i,s=e*i/t)):e>a?(s=a,r=t*a/e):t>i&&(r=i,s=e*i/t),[s,r]}exports.template='\n<div class="image-preview">\n    <div ref="content" class="content">\n        <canvas ref="canvas" width=1 height=1\n            @click="twinkle"\n        ></canvas>\n    </div>\n    <div class="label">\n        <span>{{ info }}</span>\n    </div>\n</div>\n',exports.props=["meta","imgSrc"],exports.data=data,exports.methods={async loadImage(){const e=this;window.clearTimeout(e.loadImageTimeId),e.loadImageTimeId=window.setTimeout(()=>{e.imgSrc&&(e._image=new Image,e._image.onload=(()=>{e._destroyed||e.updateImage()}),e._image.src=e.imgSrc+`?_t=${(new Date).getTime()}`)},50)},updateImage(){const e=this;if(e._image){const{width:t,height:a}=this.getSize();e.info=`${t} x ${a}`,this.resize()}},getSize(){const e=this;let t=0,a=0;return textureType.includes(e.meta.importer)?(t=e._image.width,a=e._image.height):"sprite-frame"===e.meta.importer&&(t=e.meta.userData.width,a=e.meta.userData.height),{width:t,height:a}},resize(){const e=this;if(e._image&&e.$refs.content){const{height:t,width:a}=e.$refs.content.getBoundingClientRect(),{width:i,height:s}=this.getSize(),[r,n]=getFitSize(i,s,a,t);e.meta.userData.rotated&&(e._scalingSize={width:Math.ceil(n),height:Math.ceil(r)}),e.$refs.canvas.width=Math.ceil(r),e.$refs.canvas.height=Math.ceil(n),window.cancelAnimationFrame(e.animationFrameId),e.animationFrameId=window.requestAnimationFrame(()=>{e.repaint()})}},repaint(){const e=this,t=e.$refs.canvas.getContext("2d");t.imageSmoothingEnabled=!1;const a=e.$refs.canvas.width,i=e.$refs.canvas.height,{subMetas:s}=e.meta;if(textureType.includes(e.meta.importer))t.drawImage(e._image,0,0,a,i),s&&s["sprite-frame"]&&[e.meta.subMetas["sprite-frame"]].forEach(s=>{if(!s||!s.userData)return;const{userData:r}=s,n=a/e._image.width,o=i/e._image.height;t.beginPath(),t.rect(r.trimX*n,r.trimY*o,r.width*n,r.height*o),t.lineWidth=1,t.strokeStyle="#ff00ff",t.stroke()});else if("sprite-frame"===e.meta.importer){let s,r,n,o,d,m;if(e.meta.userData.rotated){const h=a/2,c=i/2;t.translate(h,c),t.rotate(-90*Math.PI/180),t.translate(-h,-c),n=h-e._scalingSize.width/2,o=c-e._scalingSize.height/2,s=e.meta.userData.height,r=e.meta.userData.width,d=i,m=a}else n=0,o=0,s=e.meta.userData.width,r=e.meta.userData.height,d=a,m=i;t.drawImage(e._image,e.meta.userData.trimX,e.meta.userData.trimY,s,r,n,o,d,m)}},async twinkle(){const{isUuid:e,imageUuidOrDatabaseUri:t}=this.meta.userData;let a=t;if(!e){const e=await Editor.Message.request("asset-db","query-asset-info",t);if(!e)return"";a=e.uuid}Editor.Message.send("assets","twinkle",a)}},exports.mounted=mounted,exports.watch={meta:{deep:!0,handler(){this.loadImage()}},imgSrc(){this.loadImage()}},exports.destroyed=destroyed;