"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compareEngineInfo=exports.importConfig=exports.exportConfig=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),Vue=require("vue/dist/vue.js"),lodash=require("lodash");exports.style=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"./engine.css"),"utf8"),exports.template=(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/contributions/preferences-engine.html"),"utf8"),exports.$={engine:".custom-engine"};const component={data:{config:null,types:{"javascript.builtin":"global","javascript.custom":"global","native.builtin":"global"},showRestartInfo:!1,engineInfo:null},watch:{"config.javascript.builtin":{async handler(e){const i=this;e&&(lodash.set(i.config,"native.builtin",!0),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.native.builtin`,!0,i.types["native.builtin"]))},deep:!0},"config.javascript.custom":{handler(e){e.startsWith("project://")&&(e=Editor.UI.__protected__.File.resolveToRaw(e)),this.config.native.custom=e?(0,path_1.join)(e,"./native"):""},deep:!0}},methods:{async onConfirm(e){const i=this,n=e.target.getAttribute("path");let t=e.target.value;"javascript.builtin"===n?t=!i.config.javascript.builtin:"native.builtin"===n&&(t=!i.config.native.builtin),lodash.set(i.config,n,t),await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`,t,i.types[n]),i.showRestartInfo=await compareEngineInfo(i.engineInfo,i.config)},async refresh(e){const i=this,n=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${e}`,"local");i.types[e]=void 0!==n&&null!==n?"local":"global"},relaunch(){Editor.Message.send("engine","relaunch")},onChangePosition(e,i,n){const t=this;Editor.Menu.popup({x:e,y:i,menu:[{label:Editor.I18n.t("preferences.menu.move_local"),enabled:"global"===t.types[n],async click(){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`);if(await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`,e),t.refresh(n),"javascript.builtin"===n){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`);await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,e),t.refresh("javascript.custom")}}},{label:Editor.I18n.t("preferences.menu.move_global"),enabled:"local"===t.types[n],async click(){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`,"local");if(await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`,e,"global"),await Editor.Profile.removeConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.${n}`,t.types[n]),t.refresh(n),"javascript.builtin"===n){const e=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,"local");await Editor.Profile.setConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,e,"global"),await Editor.Profile.removeConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}.javascript.custom`,t.types["javascript.custom"]),t.refresh("javascript.custom")}}}]})}}};async function ready(){component.el=this.$.engine;const e=new Vue(component);e.config=await Editor.Profile.getConfig("engine",`engine.${Editor.App.version.replace(/\./g,"")}`),e.$set(e.config.javascript,"path",(0,path_1.join)(Editor.App.path,"../resources/3d/engine")),e.$set(e.config.native,"path",(0,path_1.join)(Editor.App.path,"../resources/3d/engine/native"));for(const i of Object.keys(e.types))await e.refresh(i);e.engineInfo=await Editor.Message.request("engine","query-engine-info"),e.showRestartInfo=compareEngineInfo(e.engineInfo,e.config)}async function exportConfig(){const e={},i=Editor.App.version.replace(/\./g,"");let n="global";const t=await Editor.Message.request("preferences","query-config","engine",`engine.${i}`,"local");return void 0!==t&&null!==t&&(n="local"),e[`engine.${i}`]={type:n,value:await Editor.Message.request("preferences","query-config","engine",`engine.${i}`)},e}async function importConfig(e){const i=Editor.App.version.replace(/\./g,"");e[`engine.${i}`]&&await Editor.Message.request("preferences","set-config","engine",`engine.${i}`,e[`engine.${i}`].value,e[`engine.${i}`].type)}function compareEngineInfo(e,i){try{const n="builtin"===e.typescript.type,t=e.typescript.path,o="builtin"===e.native.type;if(n!==i.javascript.builtin||o!==i.native.builtin||!n&&t!==i.javascript.custom)return!0}catch(e){console.error(e)}return!1}exports.ready=ready,exports.exportConfig=exportConfig,exports.importConfig=importConfig,exports.compareEngineInfo=compareEngineInfo;