"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadDynamic=void 0;const module_1=__importDefault(require("module")),path_1=__importDefault(require("path"));let hasPreload=!1,loader=null;async function preload(e){var r,o;function n(e){return"cc"===e||e.startsWith("cc/")&&!e.startsWith("cc/preload")||e.startsWith("cce:/internal/")}try{if(hasPreload)throw new Error("You can only preload engine once.");hasPreload=!0;const{requiredModules:t,editorExtensions:i=!0,editorPath:a}=e,s=null!==(r=e.root)&&void 0!==r?r:await(async()=>{return require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info").path})(),l=null!==(o=e.dist)&&void 0!==o?o:path_1.default.join(s,"bin",".cache","dev","editor");if(globalThis.CC_EDITOR=!0,i){const e=require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info");globalThis.EditorExtends=require(path_1.default.join(e.editor,"./builtin/engine/dist/editor-extends"))}const c={},d=require(path_1.default.resolve(l,"loader"));loader=d.default;for(const e of t)c[e]=await loader.import(e);const u=module_1.default,p=u._resolveFilename;u._resolveFilename=function(e){return n(e)?e:p.apply(this,arguments)};const f=u._load;u._load=function(e){if(n(e)){const r=c[e];if(r)return r;throw new Error(`Can not load engine module: ${e}. Valid engine modules are: ${Object.keys(c).join(",")}`)}return f.apply(this,arguments)},t.includes("cc")&&postProcess(a)}catch(e){let r="preload engine failed!";throw console.error(r),console.error(e),e instanceof Error&&(r+=(e.stack,e.stack)),Editor.Message.send("engine","import-engine-error",r),e}}async function loadDynamic(e){if(!loader)throw new Error(`Failed to load engine module ${e}. `+"Loader has not been initialized. You should call preload() first.");return await loader.import(e)}function postProcess(e){let r;if(e)r={editor:e};else{r=require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info")}const o=require("v-stacks");if("__MAIN__"in window){const e=new Error("Try not to run the engine in the window process.");e.stack=o.ignoreStack(e.stack,1),console.warn(e)}let n;console.time("Import engine");try{n=require("cc")}catch(e){let r="require cc failed!";throw e instanceof Error&&(r+=(e.stack,e.stack)),Editor.Message.send("engine","import-engine-error",r),e}console.timeEnd("Import engine"),window.ccm=n,require("./polyfill/engine"),globalThis.EditorExtends.init(),require("./overwrite")(n,r)}exports.default=preload,exports.loadDynamic=loadDynamic;