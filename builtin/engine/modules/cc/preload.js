"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadDynamic=void 0;const module_1=__importDefault(require("module")),path_1=__importDefault(require("path"));let hasPreload=!1,loader=null;async function preload(e){var n,o;function r(e){return"cc"===e||e.startsWith("cc/")&&!e.startsWith("cc/preload")||e.startsWith("cce:/internal/")}try{if(hasPreload)throw new Error("You can only preload engine once.");hasPreload=!0;const{requiredModules:t,editorExtensions:i=!0,editorPath:a}=e,s=null!==(n=e.root)&&void 0!==n?n:await(async()=>{return require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info").path})(),l=null!==(o=e.dist)&&void 0!==o?o:path_1.default.join(s,"bin",".cache","dev","editor");if(globalThis.CC_EDITOR=!0,i){const e=require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info");globalThis.EditorExtends=require(path_1.default.join(e.editor,"./builtin/engine/dist/editor-extends"))}const d={},c=require(path_1.default.resolve(l,"loader"));loader=c.default;for(const e of t)d[e]=await loader.import(e);const u=module_1.default,p=u._resolveFilename;u._resolveFilename=function(e){return r(e)?e:p.apply(this,arguments)};const f=u._load;u._load=function(e){if(r(e)){const n=d[e];if(n)return n;throw new Error(`Can not load engine module: ${e}. Valid engine modules are: ${Object.keys(d).join(",")}`)}return f.apply(this,arguments)},t.includes("cc")&&postProcess(a)}catch(e){throw Editor.Message.send("engine","import-engine-error",e.toString()),e}}async function loadDynamic(e){if(!loader)throw new Error(`Failed to load engine module ${e}. `+"Loader has not been initialized. You should call preload() first.");return await loader.import(e)}function postProcess(e){let n;if(e)n={editor:e};else{n=require("@base/electron-base-ipc").sendSync("packages-engine:query-engine-info")}const o=require("v-stacks");if("__MAIN__"in window){const e=new Error("Try not to run the engine in the window process.");e.stack=o.ignoreStack(e.stack,1),console.warn(e)}let r;console.time("Import engine");try{r=require("cc")}catch(e){throw Editor.Message.send("engine","import-engine-error",e.toString()),e}console.timeEnd("Import engine"),window.ccm=r,require("./polyfill/engine"),globalThis.EditorExtends.init(),require("./overwrite")(r,n)}exports.default=preload,exports.loadDynamic=loadDynamic;