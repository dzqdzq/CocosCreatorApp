"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const metrics_observer_base_1=require("./metrics-observer-base"),MeasurementId="G-JXC4Z86YBG",ApiSecret="OtGhpiWGSCmHl0xjL1P5TQ",QueryParams=`?&measurement_id=${MeasurementId}&api_secret=${ApiSecret}`,HOST="www.google-analytics.com",PATH=`/mp/collect${QueryParams}`,Debug_PATH=`/debug/mp/collect${QueryParams}`,request_1=require("./request"),log_1=require("../libs/log"),headers={"Content-Type":"application/json","User-Agent":""};class GoogleMetricsObserver extends metrics_observer_base_1.MetricsObserverBase{constructor(){super(...arguments),this.DEBUG=!1,this.session_id="",this.time=Date.now()}trackEvent(e,t){if(e.sendToCocosAnalyticsOnly||e.sendToNewCocosAnalyticsOnly)return;if(!t.cid)return void console.debug("Metrics: no valid client ID, trackEventInfo: ",e);if(!e.category)return void console.debug("Metrics: no valid info. trackEventInfo: ",e);const s=e.category;delete e.category,this.sendToGA4(this.createNewData(t,[this.createNewEvent(`${s}_${e.action}`,e)]))}trackException(e,t){t.cid?this.sendToGA4(this.createNewData(t,[this.createNewEvent("exception",{description:e.code+"-"+e.message,fatal:!0})])):console.debug("Metrics: no valid client ID, trackEventInfo: ",t)}sendAppInfo(e){this.DEBUG=e.debug||!1;const{App:t,I18n:s}=this.getEditor();headers["User-Agent"]=t.userAgent,this.time=Date.now(),this.session_id=e.uid+"_"+this.time;const o=this.createNewData(e,[this.createNewEvent("app_info",{engagement_time_msec:0,tid:MeasurementId,app_name:"CocosCreator",app_id:"com.cocos.creator",app_version:t.version,screen_resolution:e.resolution||"unknown",scale_factor:e.scaleFactor||"1",language:s.getLanguage()||"unknown",user_agent:t.userAgent,operating_system:{darwin:"Macintosh",win32:"Windows",linux:"Linux"}[process.platform]||process.platform})]);this.sendToGA4(o)}close(e){const t=this.createNewData(e,[this.createNewEvent("close",{})]);this.sendToGA4(t)}getEditor(){return Editor}createNewData(e,t){return{client_id:e.cid+"",user_id:e.uid+"",timestamp_micros:1e3*Date.now()+"",events:t||[]}}createNewEvent(e,t){return{name:(e=e.replace(/ +/g,"")).replace(/[^A-Za-z0-9_]/g,"_"),params:Object.assign({session_id:this.session_id,engagement_time_msec:Date.now()-this.time},t)}}sendToGA4(e){this.DEBUG&&console.debug("start analytics... ",JSON.stringify(e)),this.DEBUG?this.sendToDebugGA4(e):this.sendToNormalGA4(e)}sendToNormalGA4(e){const t={method:"POST",protocol:"https",host:HOST,path:PATH,headers:headers,data:JSON.stringify(e),useStringifyData:!1},s=Date.now();this.DEBUG&&log_1.logMgr.collectToFile(`[send analytics ga4]: ${s}`,e),(0,request_1.sendHttpRequest)(t,(t,o)=>{t?this.DEBUG&&log_1.logMgr.collectToFile(`[send analytics ga4 fail]: ${s}`,t):this.DEBUG&&log_1.logMgr.collectToFile(`[send analytics ga4 done]: ${s}`,e)})}sendToDebugGA4(e){const t={method:"POST",protocol:"https",host:HOST,path:Debug_PATH,headers:headers,data:JSON.stringify(e),useStringifyData:!1};(0,request_1.sendHttpRequest)(t,(t,s)=>{try{if(t)return void console.debug(t);const o=JSON.parse(s).validationMessages;if(!o||o.length>0)return void console.debug("sending failure.\n",o,JSON.stringify(e));this.sendToNormalGA4(e)}catch(e){console.debug("sending failure. \n","error: \n",e,"content: \n",s)}})}}module.exports=new GoogleMetricsObserver;