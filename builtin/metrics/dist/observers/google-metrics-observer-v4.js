"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.googleG4MetricsObserver=exports.GoogleG4MetricsObserver=void 0;const fs_extra_1=require("fs-extra"),metrics_observer_base_1=require("./metrics-observer-base"),MeasurementId="G-JXC4Z86YBG",ApiSecret="OtGhpiWGSCmHl0xjL1P5TQ",QueryParams=`?&measurement_id=${MeasurementId}&api_secret=`+ApiSecret,HOST="www.google-analytics.com",PATH="/mp/collect"+QueryParams,Debug_PATH="/debug/mp/collect"+QueryParams,request_1=require("./request"),log_1=require("../libs/log"),path_1=require("path"),electron_1=require("electron"),headers={"Content-Type":"application/json","User-Agent":""};let g4Table;class GoogleG4MetricsObserver extends metrics_observer_base_1.MetricsObserverBase{static get googleG4ID(){return"G-JXC4Z86YBG"}DEBUG=!1;session_id="";params={app_name:"",app_id:"",app_version:"",scale_factor:"",language:"",arch:""};time=Date.now();firstTime=new Date;_reportEvents=[];htmlUrl="";async getHtmlUrl(){var e;return this.htmlUrl||(e=await Editor.Message.request("server","query-port")||7456,this.htmlUrl=`http://localhost:${e}/a032ffca62d9edac706b578840ab182b/index.html`,this.limitGoogleG4Request(this.htmlUrl)),this.htmlUrl}limitGoogleG4Request(s){electron_1.session.defaultSession.webRequest.onBeforeSendHeaders((e,t)=>{e.url.startsWith(s)&&(e.requestHeaders["x-custom-header"]="2c2d5f6b07c59e4a4595501a71e93b7c"),t({requestHeaders:e.requestHeaders})})}getReportEvents(){var e=JSON.parse(JSON.stringify(this._reportEvents));return this._reportEvents.length=0,e}trackEvent(e,t){if(!e.sendToCocosAnalyticsOnly)if(t.cid)if(e.category){if("editor"!==e.category||void 0===e.value.A100002){g4Table=g4Table||(0,fs_extra_1.readJSONSync)((0,path_1.join)(__dirname,"../../statics/googleG4Table.json"));const n=e.category,l=Object.assign({},e);delete l.sendToGoogleG4,delete l.sendToNewCocosAnalyticsOnly,delete l.category;let a=e.action?n+"_"+e.action:n,o=[],i="";"object"==typeof l.value?(delete l.value.projectID,Object.keys(l.value).forEach(e=>{var t,s,r;"project_id"!==e&&(t=l.value[e],s=Object.assign({action:n,value:t,count:t,time:t,baseKey:e}),r=1<(r=e.split("_")).length?r:[e],i=(e.startsWith("A")?(s.action=r[0],void 0!==r[1]&&(s.label=r[1])):(a=n,s.action=n,s.label=e),n+"_"+r[0]),(e=g4Table[i+"_"+r[1]]||g4Table[i])&&(s.action=e.action,e.label.includes("{*}")?s.label=e.label.replace(/{\*}/g,r[1]??t):e.label&&(s.label=e.label)),o=o.concat(this.createNewEvent(n,s)))})):o=[this.createNewEvent(a,l)],this.sendToGA4(this.createNewData(t,o))}}else console.debug("Metrics: no valid info. trackEventInfo: ",e);else console.debug("Metrics: no valid client ID, trackEventInfo: ",e)}trackException(e,t){t.cid?this.sendToGA4(this.createNewData(t,[this.createNewEvent("exception",{description:e.code+"-"+e.message,fatal:!0})])):console.debug("Metrics: no valid client ID, trackEventInfo: ",t)}sendAppInfo(e){this.DEBUG=void 0!==e.debug?e.debug:this.DEBUG;var{App:t,I18n:s}=this.getEditor();headers["User-Agent"]=t.userAgent,this.time=Date.now(),this.firstTime=new Date,this.session_id=e.uid+"_"+this.time,this.params={app_name:Editor.App.name,app_id:"com.cocos.creator",app_version:t.version,scale_factor:e.scaleFactor||"1",language:s.getLanguage()||"unknown",arch:process.arch}}close(e){e=this.createNewData(e,[this.createNewEvent("close",{action:"close"})]);this.sendToGA4(e)}getEditor(){return Editor}createNewData(e,t){return{client_id:e.cid+"",user_id:e.uid+"",timestamp_micros:1e3*Date.now()+"",events:t||[]}}createNewEvent(e,t){return{name:e=(e=e.replace(/ +/g,"")).replace(/[^A-Za-z0-9_]/g,"_"),params:Object.assign({},this.params,t)}}sendToGA4(e){this.DEBUG&&console.debug("start analytics... ",JSON.stringify(e)),this._reportEvents=this._reportEvents.concat(e.events),this.DEBUG&&log_1.logMgr.collectToFile("[sendToGA4]",JSON.stringify(e.events)),Editor.Message.broadcast("metrics:google-v4-report-change")}sendToNormalGA4(s){var e={method:"POST",protocol:"https",host:HOST,path:PATH,headers:headers,data:JSON.stringify(s),useStringifyData:!1};const r=Date.now();this.DEBUG&&log_1.logMgr.collectToFile("[send analytics ga4]: "+r,s),(0,request_1.sendHttpRequest)(e,(e,t)=>{e?this.DEBUG&&log_1.logMgr.collectToFile("[send analytics ga4 fail]: "+r,e):this.DEBUG&&log_1.logMgr.collectToFile("[send analytics ga4 done]: "+r,s)})}sendToDebugGA4(r){var e={method:"POST",protocol:"https",host:HOST,path:Debug_PATH,headers:headers,data:JSON.stringify(r),useStringifyData:!1};(0,request_1.sendHttpRequest)(e,(e,t)=>{try{var s;e?console.debug(e):!(s=JSON.parse(t).validationMessages)||0<s.length?console.debug(`sending failure.
`,s,JSON.stringify(r)):this.sendToNormalGA4(r)}catch(e){console.debug("sending failure. \n",`error: 
`,e,`content: 
`,t)}})}}exports.GoogleG4MetricsObserver=GoogleG4MetricsObserver,exports.googleG4MetricsObserver=new GoogleG4MetricsObserver;