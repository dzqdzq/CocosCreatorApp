"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getParentWhenAddNode=exports.twinkle=exports.intoViewNode=exports.scrollIntoView=exports.getChildrenUuids=exports.filterChildren=exports.geLastExpandChildUuid=exports.getSiblingsFromMap=exports.getNodeFromJson=exports.getNodeFromMap=exports.getNodeFromTree=exports.getGroupFromTree=exports.loopSetNodeProps=exports.isSearching=exports.isExistedAsset=exports.isEmptyCopyNodes=exports.canNotPasteNode=exports.canNotDragNode=exports.canNotRenameNode=exports.canNotCutNode=exports.canNotCopyNode=exports.canNotCreateNode=exports.canNotDeleteNode=exports.enableContextMenu=exports.forbidOperate=void 0;const panel_data_1=require("./panel-data"),nodes_data_1=require("./nodes-data");function forbidOperate(){return""!==panel_data_1.vueElement.panel.animationUuid}function enableContextMenu(){return!forbidOperate()}function canNotDeleteNode(e){return!e||e.readonly||e.isScene||e.isPrefabRoot}function canNotCreateNode(e){return!e||e.readonly}function canNotCopyNode(e){return canNotDeleteNode(e)}function canNotCutNode(e){return canNotDeleteNode(e)}function canNotRenameNode(e){return canNotDeleteNode(e)}function canNotDragNode(e){return canNotDeleteNode(e)}function canNotPasteNode(e){return!e||e.readonly||isEmptyCopyNodes()}function isEmptyCopyNodes(){return!panel_data_1.vueElement.tree.copiedUuids.length&&!panel_data_1.vueElement.tree.cutUuids.length}function isExistedAsset(){return!!panel_data_1.vueElement.panel.assetUuid}function isSearching(){return""!==panel_data_1.vueElement.panel.searchValue}function loopSetNodeProps(e,t=nodes_data_1.nodesTree){const o=Object.keys(e);for(const n of o)t[n]=e[n];t.children&&t.children.length&&t.children.forEach(t=>{t&&loopSetNodeProps(JSON.parse(JSON.stringify(e)),t)})}function getGroupFromTree(e,t="",o="uuid"){let n=[];if(!e||!e.children)return[];if(e[o]===t)return[e];let r=e.children;Array.isArray(e)&&(r=e);for(let a=0,d=r.length;a<d;a++){const d=r[a];if(d){if(d[o]===t)return[d,a,r,e];if(d.children&&0!==d.children.length&&(n=getGroupFromTree(d,t,o)).length>0)return n}}return n}function getNodeFromTree(e){return nodes_data_1.uuidToNode[e]}function getNodeFromMap(e=""){for(const[t,o]of nodes_data_1.nodesMap)if(e===o.uuid)return o;return null}function getNodeFromJson(e){return nodes_data_1.uuidToNode[e]}function getSiblingsFromMap(e=""){const t=Array.from(nodes_data_1.nodesMap.values()),o=t.length;let n=t[0],r=t[1],a=t[o-1],d=0;for(const[i,s]of nodes_data_1.nodesMap){if(e===s.uuid){n=s,r=t[d+1],d+1>=o&&(r=t[0]),a=t[d-1],d-1<0&&(a=t[o-1]);break}d++}return[n,a,r]}function geLastExpandChildUuid(e){let t=e.uuid;if(e.isExpand&&0!==e.children.length){const o=e.children.length-1;t=geLastExpandChildUuid(e.children[o])}return t}function filterChildren(e){if(!e||!e.length)return[];let t=[];return e.forEach(e=>{const o=getNodeFromTree(e);if(!o||o.isScene||o.isPrefabRoot)return;let n=!1;(t=t.filter(e=>{return!getGroupFromTree(o,e.uuid)[0]})).forEach(t=>{getGroupFromTree(t,e)[0]&&(n=!0)}),n||t.push(o)}),t.length?t.map(e=>e.uuid):[]}function getChildrenUuids(e,t=!1){const o=[],n=getNodeFromJson(e);if(n&&n.children)for(const e of n.children)if(o.push(e.uuid),e.isParent){if(!e.isExpand&&!t)continue;o.push(...getChildrenUuids(e.uuid,t))}return o}async function scrollIntoView(e){return!e||new Promise(t=>{const o=getNodeFromMap(e);if(o){const e=panel_data_1.vueElement.tree.scrollTop+panel_data_1.configData.nodeHeight/2,n=panel_data_1.vueElement.tree.scrollTop+panel_data_1.vueElement.panel.viewHeight-panel_data_1.configData.nodeHeight,r=panel_data_1.vueElement.viewBox.offsetWidth,a=panel_data_1.vueElement.viewBox.scrollWidth;let d=panel_data_1.vueElement.viewBox.scrollLeft,i=panel_data_1.vueElement.viewBox.scrollTop;const s=d>o.left,l=r<a&&.3*r<o.left-d;(s||l)&&(d=o.left-2*panel_data_1.configData.iconWidth),o.top<=e&&(i=o.top),o.top>=n&&(i=o.top-panel_data_1.vueElement.panel.viewHeight+1.8*panel_data_1.configData.nodeHeight),panel_data_1.vueElement.viewBox.scrollTo(d,i),t()}else intoViewNode(e)?(panel_data_1.vueElement.tree.render(),setTimeout(async()=>{await scrollIntoView(e),t()},200)):t()})}function intoViewNode(e,t){const o=getGroupFromTree(nodes_data_1.nodesTree,e),n=o[0],r=o[3];return!!n&&(void 0!==t&&panel_data_1.vueElement.tree.$set(n,"isExpand",t),!r||!r.uuid||intoViewNode(r.uuid,!0))}function getParentWhenAddNode(e){if(!e.parent)return null;const t=getNodeFromTree(e.parent);if(canNotCreateNode(t))return null;if(e.canvasRequired){if(hasCanvasComponent(t))return t;for(let e=t.children.length;e--;){const o=t.children[e];if(o.isActive&&!o.isPrefabNode&&hasCanvasComponent(o))return o}}return t}function hasCanvasComponent(e){return e&&e.components.some(e=>"cc.Canvas"===e.type)}exports.forbidOperate=forbidOperate,exports.enableContextMenu=enableContextMenu,exports.canNotDeleteNode=canNotDeleteNode,exports.canNotCreateNode=canNotCreateNode,exports.canNotCopyNode=canNotCopyNode,exports.canNotCutNode=canNotCutNode,exports.canNotRenameNode=canNotRenameNode,exports.canNotDragNode=canNotDragNode,exports.canNotPasteNode=canNotPasteNode,exports.isEmptyCopyNodes=isEmptyCopyNodes,exports.isExistedAsset=isExistedAsset,exports.isSearching=isSearching,exports.loopSetNodeProps=loopSetNodeProps,exports.getGroupFromTree=getGroupFromTree,exports.getNodeFromTree=getNodeFromTree,exports.getNodeFromMap=getNodeFromMap,exports.getNodeFromJson=getNodeFromJson,exports.getSiblingsFromMap=getSiblingsFromMap,exports.geLastExpandChildUuid=geLastExpandChildUuid,exports.filterChildren=filterChildren,exports.getChildrenUuids=getChildrenUuids,exports.scrollIntoView=scrollIntoView,exports.intoViewNode=intoViewNode,exports.twinkle={watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="shake"){this.watch&&(panel_data_1.vueElement.tree.$set(panel_data_1.vueElement.tree.twinkles,e,t),setTimeout(()=>{panel_data_1.vueElement.tree.twinkles[e]=void 0,delete panel_data_1.vueElement.tree.twinkles[e]},1e3))}},exports.getParentWhenAddNode=getParentWhenAddNode;