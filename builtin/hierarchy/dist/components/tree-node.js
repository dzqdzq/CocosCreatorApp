"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,n){void 0===n&&(n=a),e[n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.data=exports.methods=exports.watch=exports.computed=exports.props=exports.template=exports.name=void 0;const fs_1=require("fs"),path_1=require("path"),panel_data_1=require("./panel-data"),panel_menu_1=require("./panel-menu"),utils=__importStar(require("./utils"));let renameTimeId;function data(){return{renameValue:"",renameInputState:"",addValue:"",addInputState:"",addInputStyle:{}}}exports.name="tree-node",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.props=["node","renameUuid","addNode"],exports.computed={state(){const e=this.node;return e?this.renameUuid===e.uuid?"rename":this.addNode.sibling===e.uuid?"add":e.state:""},draggable(){const e=this.node;return""===this.state&&!utils.canNotDragNode(e)},isSelected(){return-1!==panel_data_1.vueElement.tree.selects.indexOf(this.node.uuid)},isTwinkle(){return panel_data_1.vueElement.tree.twinkles[this.node.uuid]||!1}},exports.watch={state(){const e=this,t=e.node;"rename"===e.state?(e.renameValue=t.name,e.renameInputState="",e.$nextTick(()=>{e.$refs.renameInput&&(e.$refs.renameInput.focus(),e.$refs.renameInput.setSelectionRange(0,t.name.length))})):"add"===e.state&&e.addState()}},exports.methods={t:e=>panel_data_1.vueElement.panel.t(e),popupMenu(e){panel_menu_1.popupContextMenu(e)},click(e,t){t.shiftKey?panel_data_1.vueElement.tree.ipcShiftClick(e.uuid):t.ctrlKey||t.metaKey?panel_data_1.vueElement.tree.ipcCtrlClick(e.uuid):panel_data_1.vueElement.tree.ipcSelect(e.uuid)},dblclick(e){Editor.Message.send("scene","focus-camera",[e.uuid])},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panel_data_1.vueElement.tree.toggle(e.uuid,!e.isExpand,t.altKey)},renameChange(){this.renameValue=this.$refs.renameInput.value.trim(),this.renameInputState=""},renameSubmit(){let e=this.$refs.renameInput.value.trim();""!==this.renameInputState&&(e=null),panel_data_1.vueElement.tree.rename(this.renameUuid||this.node.uuid,e)},renameCancel(){this.renameInputState="cancel",panel_data_1.vueElement.tree.rename(this.renameUuid||this.node.uuid,null)},addChange(){const{addNode:e}=this;e.name=this.$refs.addInput.value.trim()},addSubmit(){if("add"!==this.state)return;const e=Object.assign({},this.addNode),t=this.$refs.addInput.value.trim();e.name=t,panel_data_1.vueElement.tree.addConfirm(e)},addCancel(){this.$refs.addInput.value="",panel_data_1.vueElement.tree.addConfirm(null)},dragStart(e,t){const a=this;Editor.Message.send("scene","snapshot");let n=[];panel_data_1.vueElement.tree.selects.includes(e.uuid)?panel_data_1.vueElement.tree.selects.forEach(e=>{const t=utils.getNodeFromTree(e);t&&(n=a.mergeAdditional(n,t))}):n=a.mergeAdditional(n,e),t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(n));const r=new Image;r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(r,0,0)},dragOver(e,t){t.preventDefault();const a=t.currentTarget,n=a.getBoundingClientRect();let r="inside";t.clientY-n.top<=4?r="before":n.bottom-t.clientY<=4&&(r="after"),a.setAttribute("drag","over"),a.setAttribute("insert",r),panel_data_1.vueElement.tree.dragOver(e.uuid,r)},dragLeave(e,t){const a=t.currentTarget;a.removeAttribute("insert"),a.removeAttribute("drag")},drop(e,t){if(t.preventDefault(),e.readonly)return;const a=t.currentTarget,n=a.getAttribute("insert");if(a.removeAttribute("insert"),a.removeAttribute("drag"),!panel_data_1.vueElement.tree.$el.hasAttribute("hoving"))return;t.stopPropagation(),panel_data_1.vueElement.tree.$el.removeAttribute("hoving");const r=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};r.to=e.uuid,r.insert=n,r.copy=t.ctrlKey,r.keepWorldTransform=!t.shiftKey,panel_data_1.vueElement.tree.ipcDrop(r)},mergeAdditional:(e,t)=>(e.push({type:t.type,value:t.uuid}),Array.isArray(t.additional)&&t.additional.length&&(e=e.concat(t.additional)),e),addState(){const e=this,{name:t,parent:a}=e.addNode;e.addValue=t,e.addInputState="";const n=utils.getNodeFromTree(a);e.addInputStyle={paddingLeft:n.left+2*panel_data_1.configData.iconWidth+"px"},e.$nextTick(()=>{e.$refs.addInput&&(e.$refs.addInput.focus(),e.$refs.addInput.setSelectionRange(0,t.length))})},toggleLock(e){const t=!e.locked;Editor.Message.send("scene","change-node-lock",e.uuid,t),panel_data_1.vueElement.tree.selects.includes(e.uuid)?panel_data_1.vueElement.tree.selects.forEach(e=>{const a=utils.getNodeFromTree(e);a&&Editor.Message.send("scene","change-node-lock",a.uuid,t)}):Editor.Message.send("scene","change-node-lock",e.uuid,t)}},exports.data=data;