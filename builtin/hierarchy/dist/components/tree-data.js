"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteNode=exports.setParent=exports.moveNode=exports.pasteNode=exports.duplicateNode=exports.copyNode=exports.getDumpData=exports.animationEnd=exports.animationStart=exports.findNodesUseAsset=exports.getExpandLevels=exports.getAllExpands=exports.pointExpand=exports.toggleExpand=exports.loopExpand=exports.outputDisplay=exports.renderImmediately=exports.render=exports.clear=exports.reset=exports.uuidToAnimating=exports.uuidToExpand=exports.uuidToIndex=exports.uuidToDepth=exports.displayArray=exports.uuidToChildren=exports.uuidToParentUuid=exports.uuidToState=exports.uuidToNode=exports.nodeTree=void 0;const panelData=__importStar(require("./panel-data")),utils=__importStar(require("./utils"));let renderAnimationId;async function reset(){return exports.nodeTree=await Editor.Message.request("scene","query-node-tree"),exports.nodeTree?(panelData.act.assetInfo&&"cc.Prefab"===panelData.act.assetInfo.type?(exports.nodeTree=exports.nodeTree.children[0],"should_hide_in_hierarchy"===exports.nodeTree.name&&(exports.nodeTree=exports.nodeTree.children[0]),exports.nodeTree.isPrefabRoot=!0):exports.nodeTree.isPrefabRoot=!1,flatTree(exports.nodeTree,0,"0"),render(),!0):(clear(),console.error(panelData.$.panel.t("operate.refreshFail")),!1)}function clear(){exports.uuidToNode={},exports.uuidToChildren={},exports.uuidToDepth={},exports.uuidToParentUuid={},exports.uuidToState={},exports.displayArray=[],exports.uuidToIndex={length:0},exports.uuidToExpand={},exports.uuidToAnimating={}}function render(){cancelAnimationFrame(renderAnimationId),renderAnimationId=requestAnimationFrame(()=>{renderImmediately()})}function renderImmediately(){exports.displayArray=[],utils.isSearching()?searchData(exports.displayArray):getAllExpands(exports.nodeTree.uuid,exports.displayArray),panelData.$.tree.render()}function outputDisplay(e,t){const o=[];if(exports.displayArray.length)for(let r=e;r<t;r++){const e=displayData(exports.displayArray[r]);e&&o.push(e)}return Object.freeze(o),o}function loopExpand(e,t){function o(e,t){const r=exports.uuidToChildren[e];if(r){const e=r.length;for(let n=0;n<e;n++){const e=r[n];exports.uuidToExpand[e]=t,o(e,t)}}}void 0===t&&(t=!exports.uuidToExpand[e]),t?(o(e,t),toggleExpand(e,t)):(toggleExpand(e,t),o(e,t),render())}function toggleExpand(e,t){void 0===t&&(t=!exports.uuidToExpand[e]),exports.uuidToExpand[e]!==t&&(exports.uuidToExpand[e]=t,render())}function pointExpand(e){let t=e,o=exports.displayArray.includes(t);for(;t&&!o;)t=exports.uuidToParentUuid[t],exports.uuidToExpand[t]=!0,o=exports.displayArray.includes(t);renderImmediately()}function getAllExpands(e,t){t.push(e);const o=exports.uuidToChildren[e];if(exports.uuidToExpand[e]&&Array.isArray(o)){const e=o.length;for(let r=0;r<e;r++){getAllExpands(o[r],t)}}}function getExpandLevels(){const e=[];for(const t in exports.uuidToExpand){const o=exports.uuidToNode[t];o&&!0===exports.uuidToExpand[t]&&e.push(o.level)}return e}exports.nodeTree="",exports.uuidToNode={},exports.uuidToState={},exports.uuidToParentUuid={},exports.uuidToChildren={},exports.displayArray=[],exports.uuidToDepth={},exports.uuidToIndex={},exports.uuidToExpand={},exports.uuidToAnimating={},exports.reset=reset,exports.clear=clear,exports.render=render,exports.renderImmediately=renderImmediately,exports.outputDisplay=outputDisplay,exports.loopExpand=loopExpand,exports.toggleExpand=toggleExpand,exports.pointExpand=pointExpand,exports.getAllExpands=getAllExpands,exports.getExpandLevels=getExpandLevels;let nodesUseAsset=[];async function findNodesUseAsset(){nodesUseAsset.length=0;const e=await Editor.Message.request("scene","query-nodes-by-asset-uuid",panelData.$.panel.searchValue);Array.isArray(e)&&(nodesUseAsset=e)}function flatTree(e,t,o){if(!e||!e.uuid)return;const r=e.uuid;if(exports.uuidToNode[r]=e,exports.uuidToDepth[r]=t,exports.uuidToIndex[r]=exports.uuidToIndex.length,exports.uuidToIndex.length++,exports.uuidToChildren[r]=[],exports.uuidToState[r]="",void 0===exports.uuidToExpand[r]&&(exports.uuidToExpand[r]=panelData.act.expandLevels.includes(o)),e.depth=t,e.level=o,e.additional=attrAdditional(e),e.isScene&&(e.path=""),Array.isArray(e.children)){t++;const o=e.children.length;for(let n=0;n<o;n++){const o=e.children[n];if(!o||!o.uuid)continue;const s=o.uuid,a=e.level?`${e.level}_${n}`:`${n}`;o.path=e.path?`${e.path}/${o.name}`:o.name,flatTree(o,t,a),exports.uuidToChildren[r].push(s),exports.uuidToParentUuid[s]=r}e.children.length=0}}function attrAdditional(e){const t=[];return e.components.forEach(e=>{t.push({type:e.type,value:e.value}),Array.isArray(e.extends)&&e.extends.forEach(o=>{t.push({type:o,value:e.value})})}),t}function animationStart(e){panelData.act.animationUuid=e,function e(t){const o=exports.uuidToNode[t];if(!o)return;exports.uuidToAnimating[t]=!0;const r=exports.uuidToChildren[t];if(!Array.isArray(r))return;const n=r.length;for(let t=0;t<n;t++)e(r[t])}(e),render()}function animationEnd(){panelData.act.animationUuid="",exports.uuidToAnimating={},render()}async function getDumpData(e){return await Editor.Message.request("scene","query-node",e)}async function copyNode(e){return await Editor.Message.request("scene","copy-node",e)}async function duplicateNode(e){return await Editor.Message.request("scene","duplicate-node",e)}async function pasteNode(e,t,o=!1){return await Editor.Message.request("scene","paste-node",{target:e,uuids:t,keepWorldTransform:o})}async function moveNode(e,t,o){return await Editor.Message.send("scene","move-array-element",{uuid:e,path:"children",target:t,offset:o})}async function setParent(e,t,o=!1){return await Editor.Message.send("scene","set-parent",{parent:e,uuids:t,keepWorldTransform:o})}async function deleteNode(e,t){return await Editor.Message.send("scene","remove-node",{uuid:e,keepWorldTransform:t})}function displayData(e){const t=exports.uuidToNode[e];return!t||Object.isFrozen(t)?t:(Object.freeze(t),t)}function searchData(e){const{searchValue:t,searchType:o}=panelData.$.panel,r=t.toLocaleLowerCase();for(const e of exports.uuidToChildren[exports.nodeTree.uuid])n(e);function n(s){const a=exports.uuidToNode[s];if(!a)return;const{name:d,path:i,uuid:u,components:p}=a,l=d.toLocaleLowerCase(),x=i.toLocaleLowerCase();let c=!1;"name"===o&&(l.includes(r)||a.uuid.includes(t))?c=!0:"uuid"===o&&u.includes(t)?c=!0:"path"===o&&x.includes(r)?c=!0:"component"===o&&p.some(e=>e.type.toLocaleLowerCase().includes(r))?c=!0:"asset"===o&&nodesUseAsset.includes(a.uuid)&&(c=!0),c&&e.push(u);const f=exports.uuidToChildren[u];if(!f||!f.length)return;const T=f.length;for(let e=0;e<T;e++)n(f[e])}}exports.findNodesUseAsset=findNodesUseAsset,exports.animationStart=animationStart,exports.animationEnd=animationEnd,exports.getDumpData=getDumpData,exports.copyNode=copyNode,exports.duplicateNode=duplicateNode,exports.pasteNode=pasteNode,exports.moveNode=moveNode,exports.setParent=setParent,exports.deleteNode=deleteNode;