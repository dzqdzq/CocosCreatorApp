"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteNode=exports.setParent=exports.moveNode=exports.pasteNode=exports.duplicateNode=exports.copyNode=exports.getDumpdata=exports.calcNodesTree=exports.findNodesUseAsset=exports.clear=exports.reset=exports.refresh=exports.vm=exports.nodesMap=exports.nodesTree=exports.uuidToNode=void 0;const panel_data_1=require("./panel-data"),utils=__importStar(require("./utils"));async function refresh(){const e=await Editor.Message.request("scene","query-node-tree");if(!e)return;reset(),Array.isArray(e)?exports.nodesTree.children=e:exports.nodesTree.children.push(e);const t=exports.nodesTree.children[0];t.isScene&&t.name&&t.name.endsWith("*prefab")?(exports.nodesTree=exports.nodesTree.children[0],"should_hide_in_hierarchy"===exports.nodesTree.children[0].name&&(exports.nodesTree=exports.nodesTree.children[0]),exports.nodesTree.children[0].isPrefabRoot=!0,panel_data_1.vueElement.panel.assetType="prefab"):panel_data_1.vueElement.panel.assetType="scene",toNodesTree()}function reset(){exports.nodesTree={children:[]}}function clear(){exports.uuidToNode={},panel_data_1.vueElement.tree.selects=[],panel_data_1.vueElement.tree.cutUuids=[]}exports.uuidToNode={},exports.nodesMap=new Map,exports.refresh=refresh,exports.reset=reset,exports.clear=clear;let nodesUseAsset=[];async function findNodesUseAsset(){nodesUseAsset.length=0;const e=await Editor.Message.request("scene","query-nodes-by-asset-uuid",panel_data_1.vueElement.panel.searchValue);Array.isArray(e)&&(nodesUseAsset=e)}function toNodesTree(){!function e(t){legealNodeAttr(t),t.uuid&&(exports.uuidToNode[t.uuid]=t),t.children&&t.children.length>0&&t.children.forEach((n,a)=>{n.level=t.level?`${t.level}_${a}`:`${a}`,n.isScene?n.path="":n.path=t.path?`${t.path}/${n.name}`:`${n.name}`,e(n)})}(exports.nodesTree)}function legealNodeAttr(e){if(!e.uuid)return;if(void 0===panel_data_1.vueElement.tree.folds[e.uuid]){let t=!1;Array.isArray(panel_data_1.vueElement.tree.folds.expandLevels)&&panel_data_1.vueElement.tree.folds.expandLevels.includes(e.level)&&(t=!0),panel_data_1.vueElement.tree.$set(panel_data_1.vueElement.tree.folds,e.uuid,t)}Object.defineProperty(e,"isExpand",{configurable:!0,enumerable:!0,get:()=>panel_data_1.vueElement.tree.folds[e.uuid],set(t){panel_data_1.vueElement.tree.folds[e.uuid]=t}}),Object.defineProperty(e,"height",{configurable:!0,enumerable:!0,get(){return this._height},set:addHeight.bind(e)}),Object.defineProperty(e,"isVisible",{configurable:!0,enumerable:!0,get:()=>panel_data_1.vueElement.tree.nodes.some(t=>t.uuid===e.uuid)});const t={name:e.name,state:"",depth:0,top:0,left:0,isScene:e.isScene,isParent:!!(e.children&&e.children.length>0),isPrefabNode:!1,isAnimationNode:isAnimationNode(e),parentUuid:"",isActive:e.active,additional:attrAdditional(e)},n=Object.keys(t);for(const a of n)panel_data_1.vueElement.tree.$set(e,a,t[a])}function attrAdditional(e){const t=[];return e.components.forEach(e=>{t.push({type:e.type,value:e.value}),Array.isArray(e.extends)&&e.extends.forEach(n=>{t.push({type:n,value:e.value})})}),t}function isAnimationNode(e){if(!panel_data_1.vueElement.panel.animationUuid)return!1;const t=!!(e.parent&&exports.uuidToNode[e.parent]&&exports.uuidToNode[e.parent].isAnimationNode);return!(e.uuid!==panel_data_1.vueElement.panel.animationUuid&&!t)}function calcNodesTree(){exports.nodesMap.clear(),panel_data_1.vueElement.panel.state=utils.isSearching()?"search":"",calcNodePosition(),calcDirectoryHeight()}async function getDumpdata(e){return await Editor.Message.request("scene","query-node",e)}async function copyNode(e){return await Editor.Message.request("scene","copy-node",e)}async function duplicateNode(e){return await Editor.Message.request("scene","duplicate-node",e)}async function pasteNode(e,t,n=!1){return await Editor.Message.request("scene","paste-node",{target:e,uuids:t,keepWorldTransform:n})}async function moveNode(e,t,n){return await Editor.Message.send("scene","move-array-element",{uuid:e,path:"children",target:t,offset:n})}async function setParent(e,t,n=!1){return await Editor.Message.send("scene","set-parent",{parent:e,uuids:t,keepWorldTransform:n})}async function deleteNode(e,t){return await Editor.Message.send("scene","remove-node",{uuid:e,keepWorldTransform:t})}function calcNodePosition(e=exports.nodesTree,t=0,n=0){if(!e||!Array.isArray(e.children))return t;const{state:a,searchValue:s,searchType:r}=panel_data_1.vueElement.panel,o=s.toLocaleLowerCase();return e.children.forEach(d=>{if(!d)return;const i=t*panel_data_1.configData.nodeHeight;if(d.depth=n,d.top=i,d.left=n*panel_data_1.configData.iconWidth+panel_data_1.configData.padding,d.isParent=!!(d.children&&d.children.length>0),d.isPrefabNode=d.prefab.state,d.isAddedChild=d.prefab.isAddedChild,d.parentUuid=e.uuid,d.isActive=!1===e.isActive?e.isActive:d.active,"search"!==a)exports.nodesMap.set(i,d),t++,d.isParent&&!0===d.isExpand&&(t=calcNodePosition(d,t,n+1));else{if(!d.isScene){let e=!1;const n=d.name.toLocaleLowerCase();"name"===r&&(n.includes(o)||d.uuid.includes(s))?e=!0:"uuid"===r&&d.uuid.includes(s)?e=!0:"path"===r&&d.path.includes(s)?e=!0:"component"===r&&d.components.some(e=>e.type.toLocaleLowerCase().includes(o))?e=!0:"asset"===r&&nodesUseAsset.includes(d.uuid)&&(e=!0),e&&(d.depth=0,exports.nodesMap.set(i,d),t++)}d.isParent&&(t=calcNodePosition(d,t,0))}}),t}function addHeight(e){const t=this;if(e>0){t._height+=panel_data_1.configData.nodeHeight*e;for(const[n,a]of exports.nodesMap)if(t.parentUuid===a.uuid){a.height=e;break}}else t._height=panel_data_1.configData.nodeHeight}function calcDirectoryHeight(){for(const[e,t]of exports.nodesMap)t.height=0,t.isExpand&&t.children&&t.children.length>0&&(t.height=t.children.length)}exports.findNodesUseAsset=findNodesUseAsset,exports.calcNodesTree=calcNodesTree,exports.getDumpdata=getDumpdata,exports.copyNode=copyNode,exports.duplicateNode=duplicateNode,exports.pasteNode=pasteNode,exports.moveNode=moveNode,exports.setParent=setParent,exports.deleteNode=deleteNode;