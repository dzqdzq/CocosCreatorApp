"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.data=exports.methods=exports.watch=exports.components=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data")),utils=__importStar(require("./utils"));let requestAnimationId,selectedTimeId,dragOverUuid,dragOverTime,vm=null,isRefreshing=!1;function data(){return{nodes:[],renameUuid:"",addNode:{name:"",parent:"",sibling:""},intoViewByUser:"",scrollTop:0,droppableTypes:[],twinkles:{},checkShiftUpDownMerge:{uuid:"",direction:""}}}function mounted(){vm=this}exports.name="tree",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree.html"),"utf8"),exports.components={"tree-node":require("./tree-node")},exports.watch={scrollTop(){vm.filter()}},exports.methods={t:e=>panelData.$.panel.t(e),update(){const e=vm.$parent.droppableTypes.concat(panelData.config.creatableTypes);vm.droppableTypes=e.concat(panelData.config.extendDrop.types)},clear(){treeData.clear(),vm.refresh()},async refresh(){if(!isRefreshing){isRefreshing=!0,await new Promise(e=>setTimeout(e,200));try{await treeData.reset()}catch(e){console.error(e)}isRefreshing=!1}},selectAll(e){if(utils.isSearching())return Editor.Selection.clear("node"),void Editor.Selection.select("node",treeData.displayArray);if(e=e||vm.getFirstSelectSortByDisplay(),!utils.getNode(e))return;const t=treeData.uuidToParentUuid[e]||e,a=utils.getChildrenUuids(t),i=panelData.act.selects.slice(),n=i.includes(e);let r=!0;if(a.forEach(e=>{panelData.act.selects.includes(e)||(r=!1)}),r)Editor.Selection.select("node",t);else if(n)i.forEach(e=>{a.includes(e)||Editor.Selection.unselect("node",e)}),Editor.Selection.select("node",a);else if(Editor.Selection.clear("node"),utils.isParent(e)){const t=treeData.uuidToChildren[e].slice();Editor.Selection.select("node",t)}else Editor.Selection.select("node",a)},selectClear(){Editor.Selection.clear("node")},selected(e){Array.isArray(e)||(e=[e]),e.forEach(e=>{panelData.act.selects.includes(e)||(panelData.act.selects.push(e),vm.intoViewByUser=e,e===vm.checkShiftUpDownMerge.uuid&&vm.shiftUpDownMergeSelected())}),window.clearTimeout(selectedTimeId),selectedTimeId=window.setTimeout(()=>{vm.filter()},50)},unselected(e){vm.intoViewByUser===e&&(vm.intoViewByUser="");const t=panelData.act.selects.indexOf(e);-1!==t&&(panelData.act.selects.splice(t,1),window.clearTimeout(selectedTimeId),selectedTimeId=window.setTimeout(()=>{vm.filter()},50))},reselected(){const e=Editor.Selection.getSelected("node").filter(e=>!!treeData.uuidToNode[e]);e.length&&(vm.selected(e),window.clearTimeout(selectedTimeId),utils.scrollIntoView(vm.intoViewByUser))},shiftClick(e){if(0===panelData.act.selects.length)return void vm.ipcSelect(e);const t=[],{displayArray:a}=treeData,i=a.indexOf(panelData.act.selects[0]),n=a.indexOf(e);if(-1!==i||-1!==n)if(i<=n)for(let e=i;e<=n;e++)t.push(a[e]);else for(let e=i;e>=n;e--)t.push(a[e]);vm.ipcSelect(t)},ctrlClick(e){panelData.act.selects.includes(e)?Editor.Selection.unselect("node",e):Editor.Selection.select("node",e)},ipcSelect(e){Editor.Selection.clear("node"),Editor.Selection.select("node",e)},ipcSelectFirstChild(){Editor.Selection.clear("node");const e=this.getFirstChild();e&&Editor.Selection.select("node",e)},click(){utils.forbidOperate()||Editor.Selection.clear("node")},async addTo(e){utils.isSearching()&&panelData.$.panel.clearSearch(),e.parent||(e.parent=this.getFirstSelect());const t=await utils.getParentWhenAddNode(e);t&&(vm.toggle(e.parent,!0),e.parent=t.uuid,e.sibling=utils.geLastExpandChildUuid(t.uuid),await utils.scrollIntoView(e.sibling),e.name=await Editor.Message.request("scene","generate-available-name",e.name,e.parent),vm.addNode=e)},addConfirm(e){if(vm.addNode.parent="",vm.addNode.sibling="",!e||!e.parent)return;const t=utils.getNode(e.parent);t&&(utils.canNotCreateNode(t)||(treeData.uuidToState[t.uuid]="loading",vm.add(e)))},async add(e){if(!utils.forbidOperate()){Editor.Message.send("scene","snapshot");try{panelData.$.panel.isOperating=!0,await Editor.Message.request("scene","create-node",e)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1}}},added(e){vm.refresh(),panelData.act.twinkleQueues.push({uuid:e,animation:"shrink"})},changed(e){vm.refresh();const t=utils.getNode(e);t&&t.isScene},async delete(e){if(!utils.forbidOperate())if(Editor.Message.send("scene","snapshot"),e&&!panelData.act.selects.includes(e)){const t=utils.getNode(e);if(!t)return;utils.canNotDeleteNode(t)||await treeData.deleteNode(e)}else{const e=[];if(panelData.act.selects.forEach(t=>{const a=utils.getNode(t);a&&(utils.canNotDeleteNode(a)||e.push(t))}),!e.length)return;await treeData.deleteNode(e)}},deleted(){vm.refresh()},toggle(e,t,a){a?treeData.loopExpand(e,t):treeData.toggleExpand(e,t)},allToggle(){if(!treeData.nodeTree)return;const e=utils.isAllExpand(),t=[],a=panelData.act.selects.length;if(a)for(let i=0;i<a;i++){let a=panelData.act.selects[i];utils.isParent(a)?t.push(a):(a=treeData.uuidToParentUuid[a],t.includes(a)||treeData.toggleExpand(a,!e))}else t.push(treeData.nodeTree.uuid);for(let a=0;a<t.length;a++)treeData.loopExpand(t[a],!e)},upDownLeftRight(e){const t=vm.getLastSelect();if("right"===e){if(!utils.isExpand(t))return void vm.toggle(t,!0);const e=treeData.uuidToChildren[t];Array.isArray(e)&&e.length&&vm.ipcSelect(e[0])}else if("left"===e){if(utils.isExpand(t))return void vm.toggle(t,!1);const e=treeData.uuidToParentUuid[t];e&&vm.ipcSelect(e)}else{const a=utils.getSibling(t);let i;switch(e){case"up":i=a[1];break;case"down":i=a[2]}i&&vm.ipcSelect(i.uuid)}},async shiftUpDown(e){const t=panelData.act.selects.length;if(0===t)return;const[a,i,n]=utils.getSibling(panelData.act.selects[t-1]),r=panelData.act.selects.includes(i.uuid),s=panelData.act.selects.includes(n.uuid);if("up"===e){if(!r)return Editor.Selection.select("node",i.uuid),vm.checkShiftUpDownMerge.uuid=i.uuid,void(vm.checkShiftUpDownMerge.direction=e);s||Editor.Selection.unselect("node",a.uuid),await utils.scrollIntoView(i.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(i.uuid),1),panelData.act.selects.push(i.uuid)}if("down"===e){if(!s)return Editor.Selection.select("node",n.uuid),vm.checkShiftUpDownMerge.uuid=n.uuid,void(vm.checkShiftUpDownMerge.direction=e);r||Editor.Selection.unselect("node",a.uuid),await utils.scrollIntoView(n.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(n.uuid),1),panelData.act.selects.push(n.uuid)}},shiftUpDownMergeSelected(){if(!vm.checkShiftUpDownMerge.uuid)return;let e=!0,t=vm.checkShiftUpDownMerge.uuid;vm.checkShiftUpDownMerge.uuid="";let a=panelData.act.selects.length;for(;e;){const i=utils.getSibling(t);if(!(i&&i[1]&&i[2]&&a))return;t="down"===vm.checkShiftUpDownMerge.direction?i[2].uuid:i[1].uuid,a--,panelData.act.selects.includes(t)?(panelData.act.selects.splice(panelData.act.selects.indexOf(t),1),panelData.act.selects.push(t)):e=!1}},async keyboardRename(){if(utils.forbidOperate())return;if(vm.renameUuid)return;const e=vm.getFirstSelect(),t=utils.getNode(e);t&&!utils.canNotRename(t)&&(await utils.scrollIntoView(e),vm.renameUuid=e)},async rename(e,t){if(utils.forbidOperate())return;vm.renameUuid="";const a=utils.getNode(e);a&&"loading"!==treeData.uuidToState[e]&&(null===t||utils.canNotRename(a)||t===a.name?treeData.uuidToState[e]="":(treeData.uuidToState[e]="loading",Editor.Message.send("scene","snapshot"),await Editor.Message.request("scene","set-property",{uuid:a.uuid,path:"name",dump:{type:"string",value:t}})||vm.dialogError("renameFail"),treeData.uuidToState[e]=""))},async search(){panelData.$.panel.searchValue?(panelData.$.viewBox.scrollTo(0,0),"asset"===panelData.$.panel.searchType&&await treeData.findNodesUseAsset()):vm.intoViewByUser=vm.getFirstSelect(),treeData.render()},dragOver(e,t){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{""===e&&(e=vm.getFirstChild());const a=utils.getNode(e);if(!a)return;const i=Date.now();if(dragOverUuid!==e)dragOverUuid=e,dragOverTime=i;else if(i-dragOverTime>800&&!treeData.uuidToExpand[a.uuid])return vm.toggle(a.uuid,!0),void requestAnimationFrame(()=>{panelData.$.viewBox.scrollTop+=1});const{nodeHeight:n,iconWidth:r,padding:s}=panelData.config,{clientHeight:l,offsetHeight:o,scrollTop:c,scrollHeight:d}=panelData.$.viewBox,u=c&&l+c===d,p=panelData.$.viewBox.getBoundingClientRect(),f=vm.$el.getBoundingClientRect(),g=p.top-f.top,h=vm.scrollTop%n,D=o-l,m=a.depth*r;let v=treeData.displayArray.indexOf(e)*n-g+h+s,y=-13;u&&(y-=2,v+=D);let w=n,S=0;const x=vm.$el.offsetWidth-m- -3,E=m+-3,T=treeData.displayArray.indexOf(treeData.uuidToParentUuid[e])*n;switch(t){case"before":w=2,S=10;break;case"after":w=2,S=10,v=(treeData.displayArray.indexOf(utils.geLastExpandChildUuid(e))+1)*n+s}v=Math.min(d-w,v),utils.isSearching()&&["before","after"].includes(t)||(panelData.$.panel.dropBox={style:{top:v+"px",left:E+"px",height:w+"px",width:x+"px",zIndex:S},position:t,vertical:{height:v-T+y+"px"}})})},dragEnter(){utils.isSearching()?panelData.$.panel.dropBox.style={top:"-2px"}:(window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{vm.dragOver("","after")}))},drop(e){if(e.target&&!e.target.hasAttribute("hoving"))return;const t=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};t.to=vm.getFirstChild(),t.insert="inside",t.copy=e.ctrlKey,t.keepWorldTransform=!e.shiftKey,vm.ipcDrop(t)},async ipcDrop(e){if(panelData.$.panel.focusWindow(),utils.forbidOperate())return;utils.isSearching()&&panelData.$.panel.clearSearch(),Editor.Message.send("scene","snapshot");const t=[],a=[],{value:i,type:n,name:r}=e;let{additional:s}=e;if(vm.toggle(e.to,!0),s)Array.isArray(s)||(s=[s]),s.forEach(e=>{vm.droppableTypes.includes(e.type)&&(t.push(e.value),a.push(e))});else if(!vm.droppableTypes.includes(n))return;if(i&&!t.includes(i)&&(t.push(i),a.push({type:n,value:i,name:r})),e.additional=a,"cc.Node"===e.type){if(!t.length)return;if(e.copy)return await vm.copy(t),void await vm.paste(e.to,e.keepWorldTransform);vm.move(e)}else if(panelData.config.extendDrop.types&&panelData.config.extendDrop.types.includes(e.type)){const t=Object.values(panelData.config.extendDrop.callbacks[e.type]);if(t&&Array.isArray(t)){const a=utils.getNode(e.to);if(a){const i=treeData.uuidToParentUuid[e.to],n=treeData.uuidToChildren[i].indexOf(e.to);t.forEach(t=>{t({node:a.uuid,parent:i,index:n,position:e.insert},e.additional)})}}}else{const t=[];for(const i of a){if(!panelData.config.creatableTypes.includes(i.type))continue;const a=utils.getNode(e.to);if(!a)return;const n=i.value,r=treeData.uuidToParentUuid[e.to];let s="inside"===e.insert?e.to:r;a.isPrefabRoot&&"inside"!==e.insert&&(s=e.to,e.insert="inside");const l=await Editor.Message.request("scene","create-node",{parent:s,assetUuid:n,name:i.name,type:i.type,unlinkPrefab:i.unlinkPrefab,canvasRequired:i.canvasRequired});if(t.push(l),"inside"===e.insert)continue;const o=treeData.uuidToChildren[r];let c=o.indexOf(e.to)-o.length;c<0&&"after"===e.insert?c+=1:c>0&&"before"===e.insert&&(c-=1),treeData.moveNode(r,o.length,c)}vm.ipcSelect(t)}},async copy(e){if(utils.forbidOperate())return;let t=[];const a=(t=Array.isArray(e)?e:e&&!panelData.act.selects.includes(e)?[e]:panelData.act.selects.slice()).filter(e=>{const t=utils.getNode(e);return t&&!utils.canNotCopyNode(t)});panelData.act.copies=utils.filterChildren(a),await treeData.copyNode(panelData.act.copies),panelData.act.copies.forEach(e=>{utils.twinkle.add(e,"light")})},async paste(e,t=!1){if(!utils.forbidOperate()){if(Editor.Message.send("scene","snapshot"),e||(e=this.getFirstSelect()),panelData.act.cuts.length){const a=utils.filterChildren(panelData.act.cuts);if(a.includes(e))return;const i={type:"cc.Node",to:e,insert:"inside",additional:a.map(e=>({value:e,type:"cc.Node"})),keepWorldTransform:t,copy:!1};return await vm.move(i),void(panelData.act.cuts=[])}if(0!==panelData.act.copies.length)try{panelData.$.panel.isOperating=!0;const a=utils.filterChildren(panelData.act.copies);await treeData.pasteNode(e,a,t)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1}}},cut(e){if(utils.forbidOperate())return;let t=[];t=Array.isArray(e)?e:e&&!panelData.act.selects.includes(e)?[e]:panelData.act.selects.slice(),panelData.act.cuts=t.filter(e=>{const t=utils.getNode(e);return t&&!utils.canNotCutNode(t)}),0!==panelData.act.cuts.length&&panelData.act.cuts.forEach(e=>{utils.twinkle.add(e,"light")})},async duplicate(e){if(utils.forbidOperate())return;let t=[];t=Array.isArray(e)?e:e&&!panelData.act.selects.includes(e)?[e]:panelData.act.selects.slice();const a=utils.filterChildren(t).filter(e=>{const t=utils.getNode(e);return t&&!utils.canNotCopyNode(t)});if(a.length){Editor.Message.send("scene","snapshot");try{panelData.$.panel.isOperating=!0,await treeData.duplicateNode(a)}catch(e){console.error(e)}finally{panelData.$.panel.isOperating=!1}}},async move(e){if(utils.forbidOperate())return;if(!e||!e.to||!Array.isArray(e.additional))return;const t=e.additional.map(e=>e.value);if(t.includes(e.to))return;const a=utils.getNode(e.to),i=utils.getParent(e.to);if(!a)return;if(a.isPrefabRoot&&"inside"!==e.insert)return;if(a.isScene&&"inside"!==e.insert)return e.insert="inside",void await vm.move(e);let n=a;i&&["before","after"].includes(e.insert)&&(n=i);const r=n.uuid,s=t.map(t=>{if(utils.isAIncludeB(t,e.to))return"";const a=utils.getNode(t),i=utils.getParent(t);return a?"inside"===e.insert&&n===i?"":t:""}).filter(Boolean).sort((e,t)=>treeData.uuidToIndex[e]-treeData.uuidToIndex[t]);if(!s.length)return;let l=0;for(const t of s){const i=utils.getNode(t);if(!i)continue;if(vm.intoViewByUser=t,r!==treeData.uuidToParentUuid[t]&&await treeData.setParent(r,[t],e.keepWorldTransform),!["before","after"].includes(e.insert))continue;const s=await treeData.getDumpData(n.uuid),o=s.children.findIndex(e=>e.value.uuid===a.uuid),c=s.children.findIndex(e=>e.value.uuid===i.uuid);let d=o-c;"after"===e.insert&&(d<0&&(d+=1),d+=l),"before"===e.insert&&d>0&&(d-=1),await treeData.moveNode(n.uuid,c,d),l++}},render(){for(panelData.$.panel.treeHeight=treeData.displayArray.length*panelData.config.nodeHeight+2*panelData.config.padding,panelData.$.panel.allExpand=utils.isAllExpand();panelData.act.twinkleQueues.length;){const e=panelData.act.twinkleQueues.shift();utils.twinkle.add(e.uuid,e.animation)}vm.filter(),vm.intoViewByUser&&(utils.scrollIntoView(vm.intoViewByUser),vm.intoViewByUser="")},filter(){vm.nodes=[];const e=panelData.config.nodeHeight,t=vm.scrollTop,a=t%e,i=t-a,n=i+panelData.$.panel.viewHeight;vm.$el.style.top=`-${a}px`;const r=Math.round(i/e),s=Math.ceil(n/e)+1;vm.nodes=treeData.outputDisplay(r,s)},getFirstSelect(){const e=panelData.act.selects[0];return e||vm.getFirstChild()},getLastSelect(){const e=panelData.act.selects.length;return e?panelData.act.selects[e-1]:vm.getFirstChild()},getFirstSelectSortByDisplay(){var e;let t="",a=1/0;return panelData.act.selects.forEach(e=>{treeData.uuidToIndex[e]<a&&(a=treeData.uuidToIndex[e],t=e)}),t||(null===(e=treeData.nodeTree)||void 0===e?void 0:e.uuid)},getFirstChild(){var e;return utils.isSearching()?null===(e=treeData.nodeTree)||void 0===e?void 0:e.uuid:treeData.displayArray[0]},isActive:e=>utils.isActive(e),isExpand:e=>utils.isExpand(e),isParent:e=>utils.isParent(e),isSelected:e=>utils.isSelected(e),isAnimating:e=>utils.isAnimating(e||panelData.act.animationUuid),isSearching:()=>utils.isSearching(),async dialogError(e){await Editor.Dialog.error(Editor.I18n.t(`hierarchy.operate.${e}`),{title:Editor.I18n.t("hierarchy.operate.dialogError")})}},exports.data=data,exports.mounted=mounted;