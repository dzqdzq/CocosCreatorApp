"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.data=exports.methods=exports.watch=exports.computed=exports.components=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),panel_data_1=require("./panel-data"),nodesData=__importStar(require("./nodes-data")),utils=__importStar(require("./utils"));let requestAnimationId,dragOverUuid,dragOverTime,vm=null;function data(){return{nodes:[],selects:[],twinkles:{},readyTwinkles:[],folds:{},renameUuid:"",addNode:{},intoView:"",scrollTop:0,copiedUuids:[],cutUuids:[],droppableTypes:[],checkShiftUpDownMerge:{uuid:"",direction:""}}}function mounted(){vm=this}exports.name="tree",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree.html"),"utf8"),exports.components={"tree-node":require("./tree-node")},exports.computed={allExpand(){let e=!0;if(vm.selects.length)vm.selects.forEach(t=>{let i=utils.getNodeFromJson(t);!i||i.isParent||i.isScene||i.isPrefabRoot||(i=utils.getNodeFromJson(i.parentUuid)),(!i||i&&i.isExpand)&&(e=!1)});else{if(!nodesData.nodesTree||!nodesData.nodesTree.children)return!1;nodesData.nodesTree.children.forEach(t=>{t.isScene&&t.isExpand&&(e=!1)})}return e}},exports.watch={scrollTop(){vm.filterNodes()}},exports.methods={t:e=>panel_data_1.vueElement.panel.t(e),update(){const e=vm.$parent.droppableTypes.concat(panel_data_1.configData.creatableTypes);vm.droppableTypes=e.concat(panel_data_1.configData.extendDrop.types)},clear(){nodesData.clear()},async refresh(e=!1){if(!panel_data_1.vueElement.panel.isRefreshing)if(panel_data_1.vueElement.panel.isRefreshing=!0,e||await new Promise(e=>setTimeout(e,200)),await nodesData.refresh(),panel_data_1.vueElement.panel.isRefreshing=!1,nodesData.nodesTree)for(this.render(),e&&vm.$nextTick(()=>{utils.scrollIntoView(vm.intoView)});vm.readyTwinkles.length;){const e=vm.readyTwinkles.shift();utils.twinkle.add(e.uuid,e.animation)}else console.error(vm.t("operate.refreshFail"))},allToggle(){const e=vm.allExpand;if(vm.selects.length){let t=!0;vm.selects.forEach(e=>{utils.getNodeFromMap(e)&&(t=!1)}),t&&vm.refresh(!0),vm.selects.forEach(t=>{let i=utils.getNodeFromJson(t);!i||i.isParent||i.isScene||i.isPrefabRoot||(i=utils.getNodeFromJson(i.parentUuid)),utils.loopSetNodeProps({isExpand:e},i)})}else utils.loopSetNodeProps({isExpand:e});this.render()},selectAll(e){if(utils.isSearching()){const e=Array.from(nodesData.nodesMap.values()).map(e=>e.uuid);return Editor.Selection.clear("node"),void Editor.Selection.select("node",e)}e=e||vm.getFirstSelectInView();const t=utils.getNodeFromTree(e),i=t.parentUuid||e,n=utils.getChildrenUuids(i),s=vm.selects.slice(),a=s.includes(e);let o=!0;if(n.forEach(e=>{vm.selects.includes(e)||(o=!1)}),o)Editor.Selection.select("node",i);else if(a)s.forEach(e=>{n.includes(e)||Editor.Selection.unselect("node",e)}),Editor.Selection.select("node",n);else if(Editor.Selection.clear("node"),t.isParent){const t=utils.getChildrenUuids(e);t.unshift(e),Editor.Selection.select("node",t)}else Editor.Selection.select("node",n)},selectClear(){Editor.Selection.clear("node")},selected(e){let t;Array.isArray(e)||(e=[e]),e.forEach(e=>{e&&(vm.selects.includes(e)||(vm.selects.push(e),vm.intoView=e,e===vm.checkShiftUpDownMerge.uuid&&vm.shiftUpDownMergeSelected()),window.clearTimeout(t),t=window.setTimeout(()=>{utils.scrollIntoView(vm.intoView)},300))}),panel_data_1.vueElement.panel.allExpand=!vm.allExpand},unselected(e){const t=vm.selects.indexOf(e);-1!==t&&vm.selects.splice(t,1),vm.intoView===e&&(vm.intoView="")},resetSelected(){vm.selects=[];const e=Editor.Selection.getSelected("node");vm.selected(e)},async ipcShiftClick(e){if(0===vm.selects.length)return void vm.ipcSelect(e);const t=utils.getNodeFromMap(vm.selects[0]),i=utils.getNodeFromMap(e);if(!i||!t)return;const n=[],s=i.top<t.top?i.top:t.top,a=s===i.top?t.top:i.top;for(const[e,t]of nodesData.nodesMap)s<=e&&e<=a&&n.push(t.uuid);n.splice(n.findIndex(e=>e===t.uuid),1),n.unshift(t.uuid),n.splice(n.findIndex(e=>e===i.uuid),1),n.push(i.uuid),vm.ipcSelect(n)},ipcCtrlClick(e){vm.selects.includes(e)?Editor.Selection.unselect("node",e):Editor.Selection.select("node",e)},ipcSelect(e){Editor.Selection.clear("node"),Editor.Selection.select("node",e)},ipcSelectFirstChild(){Editor.Selection.clear("node");const e=this.getFirstChild();e&&Editor.Selection.select("node",e)},click(){panel_data_1.vueElement.panel.isOperating||(vm.intoView="",Editor.Selection.clear("node"))},async addTo(e){e.parent||(e.parent=this.getFirstSelect());const t=await utils.getParentWhenAddNode(e);t&&(!1===t.isExpand&&(t.isExpand=!0),e.parent=t.uuid,e.sibling=utils.geLastExpandChildUuid(t),await utils.scrollIntoView(e.sibling),e.name=await Editor.Message.request("scene","generate-available-name",e.name,e.parent),vm.addNode=e)},async addConfirm(e){if(vm.addNode.parent="",vm.addNode.sibling="",!e||!e.parent)return;const t=utils.getNodeFromTree(e.parent);if(utils.canNotCreateNode(t))return;t.state="loading",panel_data_1.vueElement.panel.isOperating=!0;const i=await vm.add(e);vm.ipcSelect(i),t.state="",setTimeout(()=>{panel_data_1.vueElement.panel.isOperating=!1},200)},async add(e){if(utils.forbidOperate())return null;return Editor.Message.send("scene","snapshot"),await Editor.Message.request("scene","create-node",e)},added(e){vm.refresh(),vm.readyTwinkles.push({uuid:e,animation:"shrink"})},changed(e){vm.refresh();const t=utils.getNodeFromMap(e);t&&t.isScene},async delete(e){if(!utils.forbidOperate())if(Editor.Message.send("scene","snapshot"),e&&!vm.selects.includes(e)){const t=utils.getNodeFromTree(e);utils.canNotDeleteNode(t)||await nodesData.deleteNode(e)}else{const e=[];if(vm.selects.forEach(t=>{const i=utils.getNodeFromTree(t);utils.canNotDeleteNode(i)||e.push(t)}),!e.length)return;await nodesData.deleteNode(e)}},deleted(){vm.refresh(!0)},toggle(e,t,i){const n=utils.getNodeFromMap(e);n&&n.isParent&&(i?utils.loopSetNodeProps({isExpand:t},n):n.isExpand=t,this.render())},upDownLeftRight(e){const t=vm.getLastSelect(),i=utils.getNodeFromJson(t);if("right"===e){if(!i.isExpand)return void vm.toggle(t,!0);const e=i.children;Array.isArray(e)&&e.length&&vm.ipcSelect(e[0].uuid)}else if("left"===e){if(i.isExpand)return void vm.toggle(t,!1);const e=i.parentUuid;e&&vm.ipcSelect(e)}else{const i=utils.getSiblingsFromMap(t);let n;switch(e){case"up":n=i[1];break;case"down":n=i[2]}n&&vm.ipcSelect(n.uuid)}},async shiftUpDown(e){const t=vm.selects.length;if(0===t)return;const[i,n,s]=utils.getSiblingsFromMap(vm.selects[t-1]),a=vm.selects.includes(n.uuid),o=vm.selects.includes(s.uuid);if("up"===e){if(!a)return Editor.Selection.select("node",n.uuid),vm.checkShiftUpDownMerge.uuid=n.uuid,void(vm.checkShiftUpDownMerge.direction=e);o||Editor.Selection.unselect("node",i.uuid),utils.scrollIntoView(n.uuid),vm.selects.splice(vm.selects.indexOf(n.uuid),1),vm.selects.push(n.uuid)}if("down"===e){if(!o)return Editor.Selection.select("node",s.uuid),vm.checkShiftUpDownMerge.uuid=s.uuid,void(vm.checkShiftUpDownMerge.direction=e);a||Editor.Selection.unselect("node",i.uuid),utils.scrollIntoView(s.uuid),vm.selects.splice(vm.selects.indexOf(s.uuid),1),vm.selects.push(s.uuid)}},shiftUpDownMergeSelected(){if(!vm.checkShiftUpDownMerge.uuid)return;let e=!0,t=vm.checkShiftUpDownMerge.uuid;vm.checkShiftUpDownMerge.uuid="";let i=vm.selects.length;for(;e;){const n=utils.getSiblingsFromMap(t);if(!(n&&n[1]&&n[2]&&i))return;t="down"===vm.checkShiftUpDownMerge.direction?n[2].uuid:n[1].uuid,i--,vm.selects.includes(t)?(vm.selects.splice(vm.selects.indexOf(t),1),vm.selects.push(t)):e=!1}},keyboardRename(){panel_data_1.vueElement.panel.animationUuid||vm.selects.forEach(e=>{if(!vm.renameUuid){const t=utils.getNodeFromTree(e);utils.canNotRenameNode(t)||(utils.scrollIntoView(e),vm.$nextTick(()=>{vm.renameUuid=e}))}})},async rename(e,t){if(utils.forbidOperate())return;vm.renameUuid="";const i=utils.getNodeFromTree(e);null===t||utils.canNotRenameNode(i)||t===i.name?i.state="":(i.state="loading",Editor.Message.send("scene","snapshot"),i.name=t,await Editor.Message.request("scene","set-property",{uuid:i.uuid,path:"name",dump:{type:"string",value:t}})||vm.dialogError("renameFail"),i.state="")},async search(){""!==panel_data_1.vueElement.panel.searchValue&&(panel_data_1.vueElement.viewBox.scrollTo(0,0),"asset"===panel_data_1.vueElement.panel.searchType&&await nodesData.findNodesUseAsset()),vm.render()},dragOver(e,t){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{const i=utils.getNodeFromMap(e||vm.getFirstScene());let n=7,s=0;if(""===e&&(n=18,s=10),!i)return;const a=Date.now();dragOverUuid!==e?(dragOverUuid=e,dragOverTime=a):a-dragOverTime>800&&vm.toggle(i.uuid,!0);const o=panel_data_1.vueElement.viewBox.getBoundingClientRect(),r=vm.$el.getBoundingClientRect(),l=vm.scrollTop%panel_data_1.configData.nodeHeight,d=o.top-r.top;let c=i.top+l-d+panel_data_1.configData.padding,u=panel_data_1.configData.nodeHeight,p=vm.$el.offsetWidth-i.left-s,m=i.left+s,f=0;if(i&&!1===i.isParent){const e=panel_data_1.configData.iconWidth-panel_data_1.configData.padding;m=i.left+e,p-=e}switch(t){case"before":u=2,f=10;break;case"after":u=2,f=10,i.isParent?c+=i.height:c+=panel_data_1.configData.nodeHeight}panel_data_1.vueElement.panel.dropBox={style:{top:c+"px",left:m+"px",height:u+"px",width:p+"px",zIndex:f},position:t,vertical:{height:i.height-n+"px"}}})},dragEnter(){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{vm.dragOver("","after")})},drop(e){const t=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};t.to=vm.getFirstScene(),t.insert="inside",t.copy=e.ctrlKey,t.keepWorldTransform=!e.shiftKey,vm.ipcDrop(t)},async ipcDrop(e){if(panel_data_1.vueElement.panel.focusWindow(),utils.forbidOperate())return;Editor.Message.send("scene","snapshot");const t=[],i=[],{additional:n,value:s,type:a,name:o}=e;if(n)n.forEach(e=>{vm.droppableTypes.includes(e.type)&&(t.push(e.value),i.push(e))});else if(!vm.droppableTypes.includes(a))return;if(s&&!t.includes(s)&&(t.push(s),i.push({type:a,value:s,name:o})),e.additional=i,"cc.Node"===e.type){if(!t.length)return;if(e.copy)return await vm.copy(t),void await vm.paste(e.to,e.keepWorldTransform);vm.move(e)}else if(panel_data_1.configData.extendDrop.types&&panel_data_1.configData.extendDrop.types.includes(e.type)){const t=Object.values(panel_data_1.configData.extendDrop.callbacks[e.type]);if(t&&Array.isArray(t)){const[i,n,s,a]=utils.getGroupFromTree(nodesData.nodesTree,e.to);i&&t.forEach(t=>{t({node:i.uuid,parent:a.uuid||"",index:n,position:e.insert},e.additional)})}}else{const t=[];for(const n of i){if(!panel_data_1.configData.creatableTypes.includes(n.type))continue;const i=n.value,[s,a,o,r]=utils.getGroupFromTree(nodesData.nodesTree,e.to);let l="inside"===e.insert?s.uuid:r.uuid;s.isPrefabRoot&&"inside"!==e.insert&&(l=s.uuid,e.insert="inside");const d=await Editor.Message.request("scene","create-node",{parent:l,assetUuid:i,name:n.name,type:n.type,unlinkPrefab:n.unlinkPrefab,canvasRequired:n.canvasRequired});if(t.push(d),"inside"===e.insert)continue;let c=a-o.length;c<0&&"after"===e.insert?c+=1:c>0&&"before"===e.insert&&(c-=1),nodesData.moveNode(r.uuid,o.length,c)}vm.ipcSelect(t)}},async copy(e){if(panel_data_1.vueElement.panel.isOperating||utils.forbidOperate())return;let t=[];t=Array.isArray(e)?e:e&&!vm.selects.includes(e)?[e]:vm.selects.slice();const i=utils.filterChildren(t);vm.copiedUuids=i.filter(e=>e&&!utils.canNotCopyNode(utils.getNodeFromTree(e))),await nodesData.copyNode(vm.copiedUuids),vm.copiedUuids.forEach(e=>{utils.twinkle.add(e,"light")})},async paste(e,t=!1){if(!panel_data_1.vueElement.panel.isOperating&&!utils.forbidOperate()){if(Editor.Message.send("scene","snapshot"),e||(e=this.getFirstSelect()),vm.cutUuids.length){if(vm.cutUuids.includes(e))return;const i={type:"cc.Node",to:e,insert:"inside",additional:vm.cutUuids.map(e=>({value:e,type:"cc.Node"})),keepWorldTransform:t,copy:!1};return await vm.move(i),vm.cutUuids=[],void(vm.copiedUuids.length=0)}if(0!==vm.copiedUuids.length)try{panel_data_1.vueElement.panel.isOperating=!0;const i=await nodesData.pasteNode(e,vm.copiedUuids,t);vm.ipcSelect(i)}catch(e){console.error(e)}finally{setTimeout(()=>{panel_data_1.vueElement.panel.isOperating=!1},200)}}},cut(e){if(panel_data_1.vueElement.panel.isOperating||utils.forbidOperate())return;let t=[];t=Array.isArray(e)?e:e&&!vm.selects.includes(e)?[e]:vm.selects.slice(),vm.cutUuids=t.filter(e=>e&&!utils.canNotCutNode(utils.getNodeFromTree(e))),0!==vm.cutUuids.length&&vm.cutUuids.forEach(e=>{utils.twinkle.add(e,"light")})},async duplicate(e){if(panel_data_1.vueElement.panel.isOperating||utils.forbidOperate())return;let t=[];t=Array.isArray(e)?e:e&&!vm.selects.includes(e)?[e]:vm.selects.slice();const i=utils.filterChildren(t).filter(e=>e&&!utils.canNotCopyNode(utils.getNodeFromTree(e)));Editor.Message.send("scene","snapshot");try{panel_data_1.vueElement.panel.isOperating=!0;const e=await nodesData.duplicateNode(i);vm.ipcSelect(e)}catch(e){console.error(e)}finally{setTimeout(()=>{panel_data_1.vueElement.panel.isOperating=!1},200)}},async move(e){if(utils.forbidOperate())return;if(!e||!e.to||!Array.isArray(e.additional))return;const t=e.additional.map(e=>e.value);if(t.includes(e.to))return;const[i,n,s,a]=utils.getGroupFromTree(nodesData.nodesTree,e.to);if(i.isPrefabRoot&&"inside"!==e.insert)return;if(i.isScene&&"inside"!==e.insert)return e.insert="inside",void await vm.move(e);let o=i;["before","after"].includes(e.insert)&&(o=a);let r="";const l=t.map(t=>{const i=utils.getGroupFromTree(nodesData.nodesTree,t),n=i[0],s=i[3];if(!utils.getGroupFromTree(i[0],e.to)[0]&&("inside"!==e.insert||o!==s))return r=n.uuid,i}).filter(Boolean).sort((e,t)=>e[0].top-t[0].top);if(!l.length)return;o.state="loading",o.isExpand=!0;let d=0;for(const t of l){const n=t[0],s=t[3];if(o!==s&&await nodesData.setParent(o.uuid,n.uuid,e.keepWorldTransform),!["before","after"].includes(e.insert))continue;const a=await nodesData.getDumpdata(o.uuid);let r=a.children.findIndex(e=>e.value.uuid===i.uuid),l=a.children.findIndex(e=>e.value.uuid===n.uuid),c=r-l;"after"===e.insert&&(c<0&&(c+=1),c+=d),"before"===e.insert&&c>0&&(c-=1),await nodesData.moveNode(o.uuid,l,c),d++}utils.scrollIntoView(r)},render(){nodesData.calcNodesTree(),vm.filterNodes(),panel_data_1.vueElement.panel.treeHeight=nodesData.nodesMap.size*panel_data_1.configData.nodeHeight,panel_data_1.vueElement.panel.allExpand=!vm.allExpand},filterNodes(){vm.nodes=[];const e=vm.scrollTop%panel_data_1.configData.nodeHeight,t=vm.scrollTop-e,i=t+panel_data_1.vueElement.panel.viewHeight;vm.$el.style.top=`-${e}px`;for(const[e,n]of nodesData.nodesMap)t<=e&&e<=i&&vm.nodes.push(n)},getFirstSelect(){const e=utils.getNodeFromJson(vm.selects[0]);return e?e.uuid:vm.getFirstScene()},getLastSelect(){const e=vm.selects.length;if(e){const t=utils.getNodeFromJson(vm.selects[e-1]);if(t)return t.uuid}return vm.getFirstScene()},getFirstSelectInView(){let e;return vm.selects.forEach(t=>{const i=utils.getNodeFromJson(t);(!e||e.top>i.top)&&(e=i)}),e?e.uuid:vm.getFirstScene()},getFirstScene:()=>nodesData.nodesTree.children[0].uuid,getFirstChild(){const e=nodesData.nodesMap.get(0);return e?e.uuid:""},twinkleAsset(){Editor.Message.send("assets","twinkle",panel_data_1.vueElement.panel.assetUuid)},getExpandLevels(){const e=[];for(const t of Object.keys(vm.folds))if(!0===vm.folds[t]){const i=utils.getNodeFromTree(t);i&&i.level&&e.push(i.level)}return e},async dialogError(e){await Editor.Dialog.error(Editor.I18n.t(`hierarchy.operate.${e}`),{title:Editor.I18n.t("hierarchy.operate.dialogError")})}},exports.data=data,exports.mounted=mounted;