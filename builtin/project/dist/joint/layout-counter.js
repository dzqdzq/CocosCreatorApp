"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcJointLayouts=exports.jointTextureCounter=void 0;class JointTextureCounter{async calc(t){return{contents:await Promise.all(t.map(t=>this.calcTextureResult(t))),textureLength:await this.calcTextureLength(t)}}async calcTextureResult(t){const e={skeleton:null,clips:[]};if(t.skeleton){const s=await this._getClipHash(t.skeleton);if(!s)return null;e.skeleton=s}return t.clips&&t.clips.length>0&&await Promise.all(t.clips.map(async t=>{const s=await this._getClipHash(t);s&&e.clips.push(s)})),e}async calcTextureLength(t){const e=(await Promise.all(t.map(async t=>(await this.calcJointPixel(t)).pixel))).reduce((t,e)=>t+e);return 12*Math.ceil(Math.sqrt(e)/12)}async queryJointsLength(t){if(!t)return 0;const e=await Editor.Message.request("asset-db","query-asset-meta",t);return e&&e.userData.jointsLength||0}async calcJointPixel(t){const e=await this.queryJointsLength(t.skeleton);let s=0;for(let n=0;n<t.clips.length;n++){const a=t.clips[n];if(!a)continue;const r=await this._getLibraryJSON(a);r&&(s+=e*(Math.ceil(r.sample*r.duration)+1)*3)}return{joints:e,pixel:s+=3*e,length:t.clips.length}}async _getClipHash(t){const e=await this._getLibraryJSON(t);return e&&e.hash}async _getLibraryJSON(t){try{return await Editor.Message.request("asset-db","execute-script",{name:"project",method:"queryAnimationState",args:[t]})}catch(t){console.error(t)}return null}}async function calcJointLayouts(){const t=await Editor.Profile.getProject("project","custom_joint_texture_layouts")||[];if(!t.length)return[];const e=[];for(const s of t)if(s&&s.contents.length){const t=await exports.jointTextureCounter.calc(s.contents);t&&t.textureLength&&e.push(t)}return e}exports.jointTextureCounter=new JointTextureCounter,exports.calcJointLayouts=calcJointLayouts;