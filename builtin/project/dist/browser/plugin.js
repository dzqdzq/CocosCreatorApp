"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path");class PluginManager{constructor(){this.configs={},this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>register(e))),Editor.Package.__protected__.on("enable",register),Editor.Package.__protected__.on("disable",unRegister)}async handleExportConfigs(){const e={};for(const t in this.configs){e[t]={__version__:this.configs[t].version};let n=!1;for(const o in this.configs[t].tabs){if(!this.configs[t].tabs[o].content)continue;const i=this.configs[t].tabs[o].content||{},s={};for(const e in i)s[e]=await Editor.Profile.getProject(t,e);e[t][o]=s,n=!0}n||delete e[t]}return e}async handleImportConfigs(e){for(const t in e)if("object"==typeof e[t]){if(!e[t].__version__){console.warn(`[${t}] Plugin config without version`);continue}const n=e[t].__version__;delete e[t].__version__,await Editor.Profile.migrateProject(t,n,e[t]);for(const n in e[t])for(const o in e[t][n])"object"==typeof e[t][n]&&this.configs[t].tabs[n].content&&this.configs[t].tabs[n].content[o]&&await Editor.Profile.setProject(t,o,e[t][n][o],"project")}}destroy(){Editor.Package.__protected__.removeListener("enable",register),Editor.Package.__protected__.removeListener("disable",unRegister)}}exports.pluginManager=new PluginManager;const register=async function(e){if(!e||e.invalid||!e.info||!e.info.contributions||!e.info.contributions.project)return!1;exports.pluginManager.hasRegisterPackages.add(e.name);try{const t=e.info.contributions.project,n=e.info.contributions.profile,o={title:e.info.title||e.name,tabs:{},version:e.version};for(const i in t){const s=o.tabs[i]={label:t[i].label,content:null,custom:t[i].custom?(0,path_1.join)(e.path,t[i].custom):""};if(t[i].content)for(const e in t[i].content)s.content=s.content||{},s.content[e]={label:n&&n.project&&n.project[e].label||t[i].content[e].label||e,description:n&&n.project&&n.project[e].description||t[i].content[e].description,render:t[i].content[e]}}exports.pluginManager.configs[e.name]=o,await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")}catch(t){console.log(`${e.name}: register default project failed.`),console.error(t)}},unRegister=async function(e){if(!exports.pluginManager.hasRegisterPackages.has(e.name))return!1;exports.pluginManager.hasRegisterPackages.delete(e.name),delete exports.pluginManager.configs[e.name],await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")};