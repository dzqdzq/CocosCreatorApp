"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash_1=require("lodash");class PluginManager{constructor(){this.configs={},this.customHandlers={},this.hasRegisterPackages=new Set}async init(){const t=Editor.Package.getPackages({enable:!0});await Promise.all(t.map(t=>register(t))),Editor.Package.__protected__.on("enable",register),Editor.Package.__protected__.on("disable",unRegister)}async handleExportConfigs(){const t={};for(const o in this.configs){t[o]={__version__:this.configs[o].version};for(const e in this.configs[o].tabs){if(!this.configs[o].tabs[e].content)continue;const n=this.configs[o].tabs[e].content||{},i={};for(const t in n)i[t]=await Editor.Profile.getProject(o,t);t[o][e]={content:i}}}for(const o in this.customHandlers){t[o]&&t[o].__version__||(t[o]={__version__:this.configs[o].version});for(const e in this.customHandlers[o]){const n=this.customHandlers[o][e];if(n.exportConfig)try{const i=await n.exportConfig.call(n)||{};Array.isArray(i)||"object"!=typeof i||(t[o][e]=Object.assign({},t[o][e],{custom:i}))}catch(t){console.debug(`[Export Project Configs] Handle custom export error in ${o}.${e}`,t)}}}return t}async handleImportConfigs(t){for(const o in t)if("object"==typeof t[o]){if(!t[o].__version__){console.warn(`[${o}] Plugin config without version`);continue}if(t[o].__version__!==this.configs[o].version){const e=t[o].__version__,n=convertToProfileConfigs(t[o]);await Editor.Profile.__protected__.migrateProject(o,e,n),syncMigrateConfigs(t[o],n)}for(const e in t[o]){if(t[o][e].content)for(const n in t[o][e].content)"object"==typeof t[o][e].content&&this.configs[o].tabs[e].content&&this.configs[o].tabs[e].content[n]&&await Editor.Profile.setProject(o,n,t[o][e].content[n],"project");if(t[o][e].custom){const n=this.customHandlers[o][e];if("object"==typeof t[o][e].custom&&n.importConfig)try{await n.importConfig.call(n,t[o][e].custom)}catch(t){console.debug(`[Import Project Configs] Handle custom import error in ${o}.${e}`,t)}}}}}async handleQueryConfigs(t){const o={};for(const e in t)if("object"==typeof t[e]){if(!t[e].__version__){console.warn(`[${e}] Plugin config without version`);continue}const n=convertToProfileConfigs(t[e]);if(t[e].__version__!==this.configs[e].version){const o=t[e].__version__;await Editor.Profile.__protected__.migrateProject(e,o,n)}o[e]=n}return o}destroy(){Editor.Package.__protected__.removeListener("enable",register),Editor.Package.__protected__.removeListener("disable",unRegister)}}exports.pluginManager=new PluginManager;const register=async function(t){if(!t||t.invalid||!t.info||!t.info.contributions||!t.info.contributions.project)return!1;exports.pluginManager.hasRegisterPackages.add(t.name);try{const o=t.info.contributions.project,e=t.info.contributions.profile,n={title:t.info.title||t.name,tabs:{},version:t.version};for(const i in o){const s=n.tabs[i]={label:o[i].label,content:null,custom:o[i].custom?(0,path_1.join)(t.path,o[i].custom):""};if(o[i].content)for(const t in o[i].content)s.content=s.content||{},s.content[t]={label:e&&e.project&&e.project[t].label||o[i].content[t].label||t,description:e&&e.project&&e.project[t].description||o[i].content[t].description,render:o[i].content[t]};if(o[i].custom)try{const e=Editor.Module.__protected__.requireFile((0,path_1.join)(t.path,o[i].custom));(e.exportConfig||e.importConfig)&&(exports.pluginManager.customHandlers[t.name]=exports.pluginManager.customHandlers[t.name]||{},exports.pluginManager.customHandlers[t.name][i]=e)}catch(o){console.log(`${t.name}: register custom project failed.`),console.error(o)}}exports.pluginManager.configs[t.name]=n,await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")}catch(o){console.log(`${t.name}: register default project failed.`),console.error(o)}},unRegister=async function(t){if(!exports.pluginManager.hasRegisterPackages.has(t.name))return!1;exports.pluginManager.hasRegisterPackages.delete(t.name),delete exports.pluginManager.configs[t.name],delete exports.pluginManager.customHandlers[t.name],await Editor.Panel.has("project.settings")&&Editor.Message.broadcast("project:packages-changed")},convertToProfileConfigs=function(t){let o={__version:t.__version__};for(const o in t){if(t[o].content)for(const n in t[o].content)e(n,t[o].content[n]);if(t[o].custom)for(const n in t[o].custom)e(n,t[o].custom[n])}function e(t,e){const n=t.split(".").reverse();let i={[n[0]]:e};for(let t=1;t<n.length;t++)i={[n[t]]:i};o=(0,lodash_1.merge)(o,i)}return o},syncMigrateConfigs=function(t,o){for(const o in t){if(t[o].content)for(const n in t[o].content)e(o,n,"content");if(t[o].custom)for(const n in t[o].custom)e(o,n,"custom")}function e(e,n,i){const s=n.split(".");let r=o,c=!0;for(let o=0;o<s.length;o++){if(void 0===r[s[o]]||null==r[s[o]]){delete t[e][i][n],c=!1;break}r=r[s[o]]}c&&r!==t[e][i][n]&&(t[e][i][n]=r)}};