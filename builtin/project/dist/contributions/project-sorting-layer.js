"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.importConfig=exports.exportConfig=exports.ready=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/contributions/project-sorting-layer.html"),"utf8"),ProjectSortingLayerVM=Vue.extend({name:"ProjectSortingLayerVM",data:()=>({layers:[],increaseId:0,dragging:!1}),mounted(){this.refresh()},methods:{async refresh(){const e=await Editor.Profile.getProject("project","sorting-layer");if(e&&Array.isArray(e.layers))this.increaseId=e.increaseId,this.layers=e.layers;else{const e=await Editor.Message.request("scene","query-sorting-layer-builtin");this.layers=e,this.increaseId=0}this.layers.sort((e,r)=>e.value-r.value),this.layers.forEach(e=>{e.id>this.increaseId&&(this.increaseId=Math.floor(e.id)+1)})},add(){let e=1;this.layers.forEach(r=>{const t=r.name.match(/Sorting Layer (\d+)$/);if(Array.isArray(t)){const r=Number(t[1]);e<=r&&(e=r+1)}}),this.increaseId++,this.layers.push({id:this.increaseId,name:`Sorting Layer ${e}`,value:this.layers.length}),this.save()},remove(e){const r=this.layers[e];r&&0!==r.value&&(this.layers.splice(e,1),this.save())},rename(e,r){const t=e.target.value.trim();t&&(this.layers[r].name=t,this.save())},async save(){let e=this.layers.findIndex(e=>0===e.value);if(-1===e)return void console.error("Sorting Layers configuration data is lack of Default layer.");e=0-e;const r=this.layers.map(r=>{const t={id:r.id,name:r.name,value:e};return e++,t});await Editor.Profile.setProject("project","sorting-layer",{layers:r,increaseId:this.increaseId}),Editor.Message.broadcast("project:setting-change","sorting-layer"),this.refresh()},dragReset(){this.dragging&&(this.dragging=!1)},dragStart(e,r){e.stopPropagation(),this.dragging=!0,e.dataTransfer.setData("_sorting_layer_drag_data_",r)},dragOver(e){if(e.preventDefault(),!this.dragging)return;const r=e.currentTarget,t=r.getBoundingClientRect(),a=t.height/2;e.clientY-t.top<=a?r.setAttribute("drag-over","top"):t.bottom-e.clientY<=a&&r.setAttribute("drag-over","bottom")},dragLeave(e){e.currentTarget.removeAttribute("drag-over")},drop(e,r){if(e.dataTransfer){const t=e.dataTransfer.getData("_sorting_layer_drag_data_");if(!t)return;if(!this.dragging)return;this.dragging=!1;const a=Number(t),n=e.currentTarget,i=n.getAttribute("drag-over");if(n.removeAttribute("drag-over"),0===r-a)return;"top"===i||"bottom"===i&&(r+=1);const o=this.layers[a];r>a?(this.layers.splice(a,1),this.layers.splice(r-1,0,o)):r<a&&(this.layers.splice(a,1),this.layers.splice(r,0,o)),this.save()}}},template:vueTemplate});function ready(){var e;null===(e=this.vm)||void 0===e||e.$destroy(),this.vm=new ProjectSortingLayerVM,this.vm.$mount(this.$.container)}async function exportConfig(){const e={};return e["sorting-layer"]=await Editor.Message.request("project","query-config","project","sorting-layer")||{},e}async function importConfig(e){e["sorting-layer"]&&await Editor.Message.request("project","set-config","project","sorting-layer",{layers:e["sorting-layer"].layers,increaseId:e["sorting-layer"].increaseId})}function close(){var e;null===(e=this.vm)||void 0===e||e.$destroy(),this.vm=null}exports.style="\n.main { \n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n.main > .header { \n    margin-bottom: 16px;\n}\n.main > .footer { \n    padding-left: 30px;\n\n}\n.main > .footer .add { \n    max-width: 200px; \n    margin-top: 16px;\n}\n.main > .footer .add > .icon { \n    margin-right: 8px;\n}\n.main > .list { \n    padding-left: 24px;\n    flex:1;\n    overflow: auto;\n}\n.main > .list .per {\n    position: relative;\n    display: flex;\n    padding: 4px 0;\n}\n.main > .list .per[drag-over]::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    width: 100%;\n    height: 2px;\n    background-color: var(--color-info-fill-weakest);\n}\n.main > .list .per[drag-over='top']::before {\n    top: -1px;\n}\n.main > .list .per[drag-over='bottom']::before {\n    bottom: -1px;\n}\n.main > .list .per > .drag {\n    width: 6px;\n    margin: 2px 6px 2px 0;\n    cursor: move;\n    background: linear-gradient(45deg, var(--color-active-fill-normal) 25%, var(--color-normal-fill) 0, var(--color-normal-fill) 50%, var(--color-active-fill-normal) 0, var(--color-active-fill-normal) 75%, var(--color-normal-fill) 0);\n    background-size: 6px 6px;\n}\n.main > .list .per > .drag:hover {\n    background: linear-gradient(45deg, var(--color-info-fill-weakest) 25%, var(--color-normal-fill) 0, var(--color-normal-fill) 50%, var(--color-info-fill-weakest) 0, var(--color-info-fill-weakest) 75%, var(--color-normal-fill) 0);\n    background-size: 6px 6px;\n}\n.main > .list .per > .layer {\n    flex: 1;\n}\n.main > .list .per > .layer > .icon {\n    flex: none;\n    margin-left: 4px;\n}\n.main > .list .per > .layer[readonly] .name {\n    opacity: 0.55;\n}\n",exports.template='<div class="container"></div>',exports.$={container:".container"},exports.ready=ready,exports.exportConfig=exportConfig,exports.importConfig=importConfig,exports.close=close;