"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.jointTextureCounter=void 0,exports.calcJointLayouts=calcJointLayouts;class JointTextureCounter{async calc(t){var e=await Promise.all(t.map(t=>this.calcTextureResult(t))),t=await this.calcTextureLength(t);return e.sort((t,e)=>(t&&t.skeleton||0)-(e&&e.skeleton||0)),{contents:e,textureLength:t}}async calcTextureResult(t){const e={skeleton:null,clips:[]};if(t.skeleton){var a=await this._getClipHash(t.skeleton);if(!a)return null;e.skeleton=a}return t.clips&&0<t.clips.length&&await Promise.all(t.clips.map(async t=>{t=await this._getClipHash(t);t&&e.clips.push(t)})),e.clips.sort(),e}async calcTextureLength(t){t=(await Promise.all(t.map(async t=>(await this.calcJointPixel(t)).pixel))).reduce((t,e)=>t+e);return 12*Math.ceil(Math.sqrt(t)/12)}async queryJointsLength(t){return(t=t&&await Editor.Message.request("asset-db","query-asset-meta",t))&&t.userData.jointsLength||0}async calcJointPixel(e){var a=await this.queryJointsLength(e.skeleton);let r=0;for(let t=0;t<e.clips.length;t++){var s=e.clips[t];s&&(s=await this._getLibraryJSON(s))&&(s=Math.ceil(s.sample*s.duration)+1,r+=a*s*3)}return{joints:a,pixel:r+=3*a,length:e.clips.length}}async _getClipHash(t){t=await this._getLibraryJSON(t);return t&&t.hash}async _getLibraryJSON(t){try{return await Editor.Message.request("asset-db","execute-script",{name:"project",method:"queryAnimationState",args:[t]})}catch(t){console.error(t)}return null}}async function calcJointLayouts(){var t=await Editor.Profile.getProject("project","custom_joint_texture_layouts")||[];if(!t.length)return[];var e,a=[];for(const r of t)r&&r.contents.length&&(e=await exports.jointTextureCounter.calc(r.contents))&&e.textureLength&&a.push(e);return a}exports.jointTextureCounter=new JointTextureCounter;