"use strict";const logger=require("./logger");class Info{get prefix(){let e=this,t="";const r=[];for(;e.parent;){let s;t=`${(s=e instanceof Describe?e.parent.subDescribes:e.parent.subIts).indexOf(e)+1}.${t}`,e=e.parent,r.push("  ")}return r.pop(),r.join("")+t}constructor(e,t){this.parent=null,this.message=e,this.handle=t}}class It extends Info{constructor(e,t){super(e,t),this._reject=null,this._timer=null}async run(){if(exports.current=this,this.handle){try{logger.log(`${this.prefix} ${this.message||""}`),await new Promise((e,t)=>{this.timeout(5e3);const r=this.handle.call(this);r instanceof Promise?(this._reject=t,r.then(()=>{clearTimeout(this._timer),e()}).catch(e=>{clearTimeout(this._timer),t(e)})):e()})}catch(e){logger.rollback(),logger.error(new Error(`${this.prefix} ${this.message||""}`)),console.log(""),console.log("%c"+`${this.prefix} ${this.message||""}`.trim(),"color: red;"),console.log("%c"+e.stack,"color: red;")}exports.current=this.parent}}timeout(e){clearTimeout(this._timer),this._timer=setTimeout(()=>{this._reject&&this._reject(new Error(`操作超时 ${e}ms`))},e)}}class Describe extends Info{constructor(e,t){super(e,t),this.parent=null,this.subDescribes=[],this.subIts=[],this.before=null,this.after=null}addBefore(e){this.before=e}addAfter(e){this.after=e}addDescribe(e){e.parent=this,this.subDescribes.push(e)}addIt(e){e.parent=this,this.subIts.push(e)}async run(){if(exports.current=this,this.handle)try{await this.handle(),this.parent&&logger.log(`${this.prefix} ${this.message||""}`)}catch(e){this.parent&&(logger.error(new Error(`${this.prefix} ${this.message||""}`)),console.error(`${this.prefix} ${this.message||""}`),console.error(e))}try{this.before&&await this.before()}catch(e){this.parent&&(logger.error(new Error(`${this.prefix} ${this.message||""}`)),console.error(`${this.prefix} ${this.message||""}`),console.error(e))}for(let e=0;e<this.subIts.length;e++){const t=this.subIts[e];await t.run(e)}for(let e=0;e<this.subDescribes.length;e++){const t=this.subDescribes[e];await t.run(e)}try{this.after&&await this.after()}catch(e){this.parent&&(logger.error(new Error(`${this.prefix} ${this.message||""}`)),console.error(`${this.prefix} ${this.message||""}`),console.error(e))}this.parent?exports.current=this.parent:exports.current=new Describe}}window.describe=async function(e,t){exports.current.addDescribe(new Describe(e,t))},window.it=function(e,t){exports.current.addIt(new It(e,t))},window.before=function(e){exports.current.addBefore(e)},window.after=function(e){exports.current.addAfter(e)},exports.current=new Describe,exports.Describe=Describe,exports.It=It;