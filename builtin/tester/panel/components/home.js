"use strict";const{join:join}=require("path"),{readdirSync:readdirSync,existsSync:existsSync}=require("fs"),tester=require("../tester"),profileManager=require("@base/electron-profile"),profile=profileManager.load("local://tester.json");exports.data=function(){return{language:"",auto:!!profile.get("auto"),autoAll:!!profile.get("autoAll"),running:!1,package:"",path:"",test:"",packages:[],tests:[],logs:[]}},exports.watch={package(t){if(this.packages.some(e=>{if(e.info.name===t)return this.path=e.info.path,!0}),!this.path)return this.test="",this.tests=[];const e=join(this.path,"test");if(!existsSync(e))return this.test="",this.tests=[];const s=readdirSync(e);this.tests=s.filter(t=>/\.js$/.test(t)),this.test=this.tests[0]}},exports.methods={t:(t,e)=>Editor.I18n.t(`tester.${t}`),_onAutoClick(t){this.auto=!this.auto,profile.set("auto",this.auto),profile.save()},_onAutoAllClick(){this.autoAll=!this.autoAll,profile.set("autoAll",this.autoAll),profile.save()},_onPakcageConfirm(t){const e=t.target.value;this.package=e,profile.set("package",e),profile.save()},_onTestConfirm(t){this.test=t.target.value},async _onTestButtonClick(t){if(!this.package||!this.test||this.running)return;console.clear(),this.running=!0,this.logs=[];const e=[];this.auto?this.tests.forEach(t=>{e.push(t)}):e.push(this.test);for(let t=0;t<e.length;t++){const s=e[t];this.logs.push({type:"info",message:`======== ${s} ========`});const i=join(this.path,"test",s);try{Editor.Module.requireFile(i),await tester.run()}catch(t){console.error(t)}Editor.Module.removeCache(i)}this.running=!1}},exports.mounted=async function(){const t=Editor.Package.getPackages();this.packages=t.map(t=>{let e=!1;const s=join(t.path,"test");return existsSync(s)?0===readdirSync(s).length&&(e=!0):e=!0,{info:t,disabled:e}}),this.package=profile.get("package"),tester.on("print",t=>{this.logs.push(t)}),tester.on("rollback",()=>{this.logs.pop()})};