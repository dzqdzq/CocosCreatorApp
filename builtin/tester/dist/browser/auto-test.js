"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.autoTest=autoTest;const native_scene_test_1=require("./native-scene-test"),utils_1=require("./utils"),{existsSync,readdirSync,outputFileSync}=require("fs-extra"),tester_1=require("../tester"),path_1=require("path"),globby_1=__importDefault(require("globby")),TEST_CONFIG_NAME="test.config.js";async function autoTest(t){if(void 0!==t.useNative)return e=(t.nativeConfig||{})["immediately"],(0,native_scene_test_1.testNativeScene)(t.useNative,e);await waitEditorReady();var e=await sortTestInfos(t);if(!e.length)return 0;let s=!0,r=0;const o=[];var n=Date.now().toString();const i=(0,path_1.join)(Editor.Project.tmpDir,"test",n,"report.txt");t.outputReport&&!existsSync(i)&&outputFileSync(i,""),tester_1.tester.on("print",async e=>(r++,t.outputReport&&(0,utils_1.collectLog)(i,e),"log"===e.type?console.log(e.message):"error"===e.type?(s=!1,o.push(e.message),console.error(e.message)):void console.log(e)));for(const c of e)if(c.list&&c.list.length){var a=saveReadConfig((0,path_1.join)(c.dir,TEST_CONFIG_NAME));try{a&&a.wait&&await a.wait(c.list,t)}catch(e){console.error(e),s=!1;continue}sortResult(c.list);for(const u of c.list){console.log("======== execute script: ",u,"========"),t.outputReport&&(0,utils_1.collectLog)(i,`======== ${u} ========`);try{require(u),await tester_1.tester.run()}catch(e){console.error(e)}delete require.cache[u]}}n=s?0:-1;return console.log(`output test report in ${i}, success: ${r-o.length} / ${r}, exitCode: `+n),console.log(`auto test failed in : 
         `+o.join("\n")),n}async function waitEditorReady(){return console.debug("waiting for editor scene ready ...."),!!await Editor.Message.request("scene","query-is-ready")||new Promise(e=>{const t=async()=>{Editor.Message.__protected__.removeBroadcastListener("scene:ready",t),Editor.Panel.open("scene"),setTimeout(()=>{console.debug("scene:ready"),e(!0)},500)};Editor.Message.__protected__.addBroadcastListener("scene:ready",t)})}async function sortTestInfos(e){var t=[];for(const o of Editor.Package.getPackages())if(!e.packages||e.packages.includes(o.name)){var s=(0,path_1.join)(o.path,"test");if(existsSync(s)){var r=await(0,globby_1.default)((0,path_1.join)(s,"**/*.spec.js"));if(0!==r.length)if(o.enable){const n=saveReadConfig((0,path_1.join)(s,TEST_CONFIG_NAME));let e=void 0;n&&(n.includes?e=t=>!!n.includes.find(e=>t.includes(e)):n.excludes&&(e=t=>!n.excludes.find(e=>t.includes(e))&&/\.spec\.js$/.test(t))),t.push({dir:s,list:e?r.filter(e):r,name:o.name})}else console.log(`skip test package ${o.name} cause it is disabled.`)}}return t}function saveReadConfig(e){try{return existsSync(e)?require(e):null}catch(e){return console.error(e),null}}function sortResult(e){return e.sort((e,t)=>{var s=e=>(0,path_1.basename)(e),r=e=>{e=e.match(/^(\d+)/);return e?parseInt(e[1],10):1/0},e=s(e),s=s(t);return r(e)-r(s)})}