"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.autoTest=void 0;const native_scene_test_1=require("./native-scene-test"),utils_1=require("./utils"),{existsSync,readdirSync,outputFileSync}=require("fs-extra"),tester_1=require("../tester"),path_1=require("path"),globby_1=__importDefault(require("globby")),TEST_CONFIG_NAME="test.config.js";async function autoTest(t){if(void 0!==t.useNative)return e=(t.nativeConfig||{})["immediately"],(0,native_scene_test_1.testNativeScene)(t.useNative,e);await waitEditorReady();var e=await sortTestInfos(t);if(!e.length)return 0;let s=!0,o=0;const r=[];var i=Date.now().toString();const n=(0,path_1.join)(Editor.Project.tmpDir,"test",i,"report.txt");t.outputReport&&!existsSync(n)&&outputFileSync(n,""),tester_1.tester.on("print",async e=>(o++,t.outputReport&&(0,utils_1.collectLog)(n,e),"log"===e.type?console.log(e.message):"error"===e.type?(s=!1,r.push(e.message),console.error(e.message)):void console.log(e)));for(const c of e)if(c.list&&c.list.length){var a=saveReadConfig((0,path_1.join)(c.dir,TEST_CONFIG_NAME));try{a&&a.wait&&await a.wait()}catch(e){console.error(e),s=!1;continue}for(const u of c.list){t.outputReport&&(0,utils_1.collectLog)(n,`======== ${u} ========`);try{require(u),await tester_1.tester.run()}catch(e){console.error(e)}delete require.cache[u]}}i=s?0:-1;return console.log(`output test report in ${n}, success: ${o-r.length} / ${o}, exitCode: `+i),console.log(`auto test failed in : 
         `+r.join("\n")),i}async function waitEditorReady(){return console.debug("waiting for editor scene ready ...."),!!await Editor.Message.request("scene","query-is-ready")||new Promise(e=>{const t=async()=>{Editor.Message.__protected__.removeBroadcastListener("scene:ready",t),Editor.Panel.open("scene"),setTimeout(()=>{console.debug("scene:ready"),e(!0)},500)};Editor.Message.__protected__.addBroadcastListener("scene:ready",t)})}async function sortTestInfos(e){var t=[];for(const r of Editor.Package.getPackages())if(!e.packages||e.packages.includes(r.name)){var s=(0,path_1.join)(r.path,"test");if(existsSync(s)){var o=await(0,globby_1.default)((0,path_1.join)(s,"**/*.spec.js"));if(0!==o.length)if(r.enable){const i=saveReadConfig((0,path_1.join)(s,TEST_CONFIG_NAME));let e=void 0;i&&(i.includes?e=t=>!!i.includes.find(e=>t.includes(e)):i.excludes&&(e=t=>!i.excludes.find(e=>t.includes(e))&&/\.spec\.js$/.test(t))),t.push({dir:s,list:e?o.filter(e):o,name:r.name})}else console.log(`skip test package ${r.name} cause it is disabled.`)}}return t}function saveReadConfig(e){try{return existsSync(e)?require(e):null}catch(e){return console.error(e),null}}exports.autoTest=autoTest;