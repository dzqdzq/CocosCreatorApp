"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.autoTest=void 0;const native_scene_test_1=require("./native-scene-test"),utils_1=require("./utils"),{existsSync,readdirSync,outputFileSync}=require("fs-extra"),tester_1=require("../tester"),path_1=require("path"),globby_1=__importDefault(require("globby")),TEST_CONFIG_NAME="test.config.js";async function autoTest(t){if(void 0!==t.useNative)return e=(t.nativeConfig||{})["immediately"],(0,native_scene_test_1.testNativeScene)(t.useNative,e);await waitEditorReady();var e=await sortTestInfos(t);if(!e.length)return 0;let o=!0,r=0,s=0;var i=Date.now().toString();const a=(0,path_1.join)(Editor.Project.tmpDir,"test",i,"report.txt");t.outputReport&&!existsSync(a)&&outputFileSync(a,""),tester_1.tester.on("print",async e=>(s++,t.outputReport&&(0,utils_1.collectLog)(a,e),"log"===e.type?console.log(e.message):"error"===e.type?(o=!1,r++,console.error(e.message)):void console.log(e)));for(const c of e)if(c.list&&c.list.length){var n=saveReadConfig((0,path_1.join)(c.dir,TEST_CONFIG_NAME));try{n&&n.wait&&await n.wait()}catch(e){console.error(e),o=!1;continue}for(const u of c.list){t.outputReport&&(0,utils_1.collectLog)(a,`======== ${u} ========`);try{require(u),await tester_1.tester.run()}catch(e){console.error(e)}delete require.cache[u]}}i=o?0:-1;return console.log(`output test report in ${a}, success: ${s-r} / ${s}, exitCode: `+i),i}function waitEditorReady(){return!!Editor.Startup.__protected__.ready.package||(console.log("waiting for editor packages ready ...."),new Promise(e=>{Editor.Startup.__protected__.once("package-ready",async()=>{console.debug("package-ready!"),e(!0)})}))}async function sortTestInfos(e){var t=[];for(const s of Editor.Package.getPackages())if(!e.packages||e.packages.includes(s.name)){var o=(0,path_1.join)(s.path,"test");if(existsSync(o)){var r=await(0,globby_1.default)((0,path_1.join)(o,"**/*.spec.js"));if(0!==r.length)if(s.enable){const i=saveReadConfig((0,path_1.join)(o,TEST_CONFIG_NAME));let e=void 0;i&&(i.includes?e=t=>!!i.includes.find(e=>t.includes(e)):i.excludes&&(e=t=>!i.excludes.find(e=>t.includes(e))&&/\.spec\.js$/.test(t))),t.push({dir:o,list:e?r.filter(e):r,name:s.name})}else console.log(`skip test package ${s.name} cause it is disabled.`)}}return t}function saveReadConfig(e){try{return existsSync(e)?require(e):null}catch(e){return console.error(e),null}}exports.autoTest=autoTest;