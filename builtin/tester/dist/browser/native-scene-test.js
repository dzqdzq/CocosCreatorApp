"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.testNativeScene=testNativeScene;const utils_1=require("./utils"),tester_1=require("../tester"),path_1=require("path"),fs_extra_1=require("fs-extra");async function testNativeScene(l,o=!1){const _=`场景测试失败,useNative=${l} :`,u=(0,path_1.join)(Editor.Project.tmpDir,"testScene",Date.now()+".log");return(0,fs_extra_1.outputFileSync)(u,""),console.log("testScene log path",u),new Promise((e,t)=>{let i="success";const r=setTimeout(()=>{i=_+" 超时",c()},3e5);function c(){clearTimeout(r),Editor.Message.__protected__.removeBroadcastListener("crash-reporter:report",s),(0,utils_1.collectLog)(u,i).then(()=>{e(i)})}function s(e){console.error(_,e.details),i=_+" 场景崩溃,原生堆栈文件在工程temp/crash目录下",c()}async function n(){Editor.Message.__protected__.removeBroadcastListener("scene:ready",n);var e=await Editor.Message.request("scene","is-native");if(l&&!e)i=_+",编译未通过,无法正常启动原生场景";else{tester_1.tester.on("print",async e=>(await(0,utils_1.collectLog)(u,e),"log"===e.type?console.log(e.message):"error"===e.type?(i=_+" 存在测试例未通过，请查看日志"+u,console.error(e.message)):void console.log(e)));var t=(0,path_1.join)(Editor.App.path,"builtin/scene/test"),r=await(0,fs_extra_1.readdir)(t);for(let e=0;e<r.length;e++){var s=r[e];if(s.endsWith("spec.js")){var o=(0,path_1.join)(t,s);try{var a="run test:"+s;await(0,utils_1.collectLog)(u,a,console.log),require(o),await tester_1.tester.run()}catch(e){i=_+" 存在测试例未通过，请查看日志"+u;s=o+`测试异常
`+e;await(0,utils_1.collectLog)(u,s,console.error)}delete require.cache[o]}}}c()}Editor.Message.__protected__.addBroadcastListener("crash-reporter:report",s),Editor.Message.__protected__.addBroadcastListener("scene:ready",n),o&&n()})}