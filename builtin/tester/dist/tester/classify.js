"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Describe=exports.It=void 0;const logger_1=require("./logger");class Info{get prefix(){let r=this,s="";for(var t=[];r.parent;){let e;var i=(e=r instanceof Describe?r.parent.subDescribes:r.parent.subIts).indexOf(r);s=i+1+"."+s,r=r.parent,t.push("  ")}return t.pop(),t.join("")+s}constructor(e,r){this.parent=null,this.message=e,this.handle=r}}class It extends Info{constructor(e,r){super(e,r),this._reject=null,this._timer=null}async run(){if((classify.current=this).handle){try{logger_1.logger.log(this.prefix+" "+(this.message||"")),await new Promise((e,r)=>{this.timeout(5e3);var s=this.handle.call(this);s instanceof Promise?(this._reject=r,s.then(()=>{this._timer&&clearTimeout(this._timer),e()}).catch(e=>{this._timer&&clearTimeout(this._timer),r(e)})):e()})}catch(e){logger_1.logger.rollback(),logger_1.logger.error(new Error(this.prefix+" "+(this.message||""))),console.log(""),console.log("%c"+(this.prefix+" "+(this.message||"")).trim(),"color: red;"),console.log("%c"+e.stack,"color: red;")}classify.current=this.parent}}timeout(e){this._timer&&clearTimeout(this._timer),this._timer=setTimeout(()=>{this._reject&&this._reject(new Error(`操作超时 ${e}ms`))},e)}}exports.It=It;class Describe extends Info{constructor(e,r){super(e,r),this.subDescribes=[],this.subIts=[],this.before=null,this.after=null}addBefore(e){this.before=e}addAfter(e){this.after=e}addDescribe(e){(e.parent=this).subDescribes.push(e)}addIt(e){(e.parent=this).subIts.push(e)}async run(){if((classify.current=this).handle)try{await this.handle(),this.parent&&logger_1.logger.log(this.prefix+" "+(this.message||""))}catch(e){this.parent&&(logger_1.logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}try{this.before&&await this.before()}catch(e){this.parent&&(logger_1.logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}for(let e=0;e<this.subIts.length;e++)await this.subIts[e].run();for(let e=0;e<this.subDescribes.length;e++)await this.subDescribes[e].run();try{this.after&&await this.after()}catch(e){this.parent&&(logger_1.logger.error(new Error(this.prefix+" "+(this.message||""))),console.error(this.prefix+" "+(this.message||"")),console.error(e))}this.parent?classify.current=this.parent:classify.current=new Describe}}const classify={current:new(exports.Describe=Describe)};exports.default=classify;