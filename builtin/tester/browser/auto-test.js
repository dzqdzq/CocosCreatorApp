"use strict";const{join:join}=require("path"),{existsSync:existsSync,readdirSync:readdirSync,readJSONSync:readJSONSync,appendFile:appendFile,outputFileSync:outputFileSync}=require("fs-extra");async function autoTest(e){const t=sortTestInfos();if(!t.length)return!1;const n=require(join(__dirname,"../panel/tester"));let r=!0;const o=join(Editor.Project.tmpDir,"test",Date.now()+".log");e.outputReport&&!existsSync(o)&&outputFileSync(o,""),n.on("print",t=>(e.outputReport&&collectLog(o,t),"log"===t.type?console.log(t.message):"error"===t.type?(r=!1,console.error(t.message)):void console.log(t)));for(const s of t)if(s.list&&s.list.length)for(const t of s.list){e.outputReport&&collectLog(o,`======== ${t} ========`);const c=join(s.dir,t);try{require(c),await n.run()}catch(e){console.error(e),r=!1}delete require.cache[c]}return console.log(`output test log in ${o}`),r}function sortTestInfos(){const e=Editor.Package.getPackages(),t=join(Editor.Project.path,"test.config.json");if(!existsSync(t))return[];const n=readJSONSync(t);0===n.packages.length&&delete n.packages;const r=[];return e.forEach(e=>{if(n.packages&&!n.packages.includes(e.name))return;const t=join(e.path,"test");if(!existsSync(t))return;let o=readdirSync(t);if(0===o.length)return;const s=saveReadJSON(join(e.path,"test","test.config.json"));r.push({dir:t,list:o.filter(e=>!(s&&s.exclude&&s.exclude.includes(e))&&/\.spec\.js$/.test(e)),name:e.name})}),r}function saveReadJSON(e){try{return existsSync(e)?readJSONSync(e):null}catch(e){return console.error(e),null}}function collectLog(e,t){let n=t,r=!1;"object"==typeof t&&(r="error"===t.type,n=t.message);const o=`${r?"[X]":"   "} ${translateLogMsg(n)}\n`;appendFile(e,o)}function translateLogMsg(e){if("string"==typeof e&&!e.includes("\n"))return e;if("string"==typeof e&&e.includes("\n"))return translateLogMsg(e.split("\n"));if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=`${translateLogMsg(e)}\r`}),t}try{return JSON.stringify(e)}catch(e){}return e}module.exports={autoTest:autoTest};