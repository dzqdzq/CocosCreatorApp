"use strict";const{join:join}=require("path"),{existsSync:existsSync,readdirSync:readdirSync,readJSONSync:readJSONSync,appendFile:appendFile,outputFileSync:outputFileSync,readdir:readdir}=require("fs-extra");async function testNativeScene(e,t=!1){const o=`场景测试失败,useNative=${e} :`,r=join(Editor.Project.tmpDir,"testScene",Date.now()+".log");return outputFileSync(r,""),console.log("testScene log path",r),new Promise((n,s)=>{let c="success";const i=setTimeout(()=>{c=`${o} 超时`,a()},3e5);function a(){clearTimeout(i),Editor.Message.removeBroadcastListener("crash-reporter:report",l),collectLog(r,c).then(()=>{n(c)})}function l(e){console.error(o,e.details),c=`${o} 场景崩溃,原生堆栈文件在工程temp/crash目录下`,a()}async function u(){Editor.Message.removeBroadcastListener("scene:ready",u);const t=await Editor.Message.request("scene","is-native");if(e&&!t)return c=`${o},编译未通过,无法正常启动原生场景`,void a();const n=require(join(__dirname,"../panel/tester"));n.on("print",async e=>(await collectLog(r,e),"log"===e.type?console.log(e.message):"error"===e.type?(c=`${o} 存在测试例未通过，请查看日志${r}`,console.error(e.message)):void console.log(e)));const s=join(Editor.App.path,"builtin/scene/test"),i=await readdir(s);for(let e=0;e<i.length;e++){const t=i[e];if(t.endsWith("spec.js")){const e=join(s,t);try{const s="run test:"+t;await collectLog(r,s,console.log),require(e),await n.run()}catch(t){c=`${o} 存在测试例未通过，请查看日志${r}`;const n=`${e}测试异常\n`+t;await collectLog(r,n,console.error)}delete require.cache[e]}}a()}Editor.Message.addBroadcastListener("crash-reporter:report",l),Editor.Message.addBroadcastListener("scene:ready",u),t&&u()})}async function autoTest(e){if(void 0!==e.useNative){const{immediately:t}=e.nativeConfig||{};return await testNativeScene(e.useNative,t)}const t=sortTestInfos();if(!t.length)return!1;const o=require(join(__dirname,"../panel/tester"));let r=!0;const n=join(Editor.Project.tmpDir,"test",Date.now()+".log");e.outputReport&&!existsSync(n)&&outputFileSync(n,""),o.on("print",t=>(e.outputReport&&collectLog(n,t),"log"===t.type?console.log(t.message):"error"===t.type?(r=!1,console.error(t.message)):void console.log(t)));for(const s of t)if(s.list&&s.list.length)for(const t of s.list){e.outputReport&&collectLog(n,`======== ${t} ========`);const c=join(s.dir,t);try{require(c),await o.run()}catch(e){console.error(e),r=!1}delete require.cache[c]}return console.log(`output test log in ${n}`),r}function sortTestInfos(){const e=Editor.Package.getPackages(),t=join(Editor.Project.path,"test.config.json");if(!existsSync(t))return[];const o=readJSONSync(t);0===o.packages.length&&delete o.packages;const r=[];return e.forEach(e=>{if(o.packages&&!o.packages.includes(e.name))return;const t=join(e.path,"test");if(!existsSync(t))return;const n=readdirSync(t);if(0===n.length)return;const s=saveReadJSON(join(e.path,"test","test.config.json"));r.push({dir:t,list:n.filter(e=>!(s&&s.exclude&&s.exclude.includes(e))&&/\.spec\.js$/.test(e)),name:e.name})}),r}function saveReadJSON(e){try{return existsSync(e)?readJSONSync(e):null}catch(e){return console.error(e),null}}async function collectLog(e,t,o){let r=t,n=!1;"object"==typeof t&&(n="error"===t.type,r=t.message);const s=`${n?"[X]":"   "} ${translateLogMsg(r)}\n`;await appendFile(e,s),o&&o(t)}function translateLogMsg(e){if("string"==typeof e&&!e.includes("\n"))return e;if("string"==typeof e&&e.includes("\n"))return translateLogMsg(e.split("\n"));if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=`${translateLogMsg(e)}\r`}),t}try{return JSON.stringify(e)}catch(e){}return e}module.exports={autoTest:autoTest};