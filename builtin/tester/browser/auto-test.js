"use strict";const{join:join}=require("path"),{existsSync:existsSync,readdirSync:readdirSync,readJSONSync:readJSONSync,appendFile:appendFile,outputFileSync:outputFileSync}=require("fs-extra");async function autoTest(t){const e=sortTestInfos();if(!e.length)return!1;const n=require(join(__dirname,"../panel/tester"));let r=!0;const o=join(Editor.Project.tmpDir,"test",Date.now()+".log");t.outputReport&&!existsSync(o)&&outputFileSync(o,""),n.on("print",e=>(t.outputReport&&collectLog(o,e),"log"===e.type?console.log(e.message):"error"===e.type?(r=!1,console.error(e.message)):void console.log(e)));for(const s of e)if(s.list&&s.list.length)for(const e of s.list){t.outputReport&&collectLog(o,`======== ${e} ========`);const c=join(s.dir,e);try{require(c),await n.run()}catch(t){console.error(t),r=!1}delete require.cache[c]}return console.log(`output test log in ${o}`),r}function sortTestInfos(){const t=Editor.Package.getPackages(),e=join(Editor.Project.path,"test.config.json");if(!existsSync(e))return[];const n=readJSONSync(e);0===n.packages.length&&delete n.packages;const r=[];return t.forEach(t=>{if(n.packages&&!n.packages.includes(t.name))return;const e=join(t.path,"test");if(!existsSync(e))return;const o=readdirSync(e);if(0===o.length)return;const s=saveReadJSON(join(t.path,"test","test.config.json"));r.push({dir:e,list:o.filter(t=>!(s&&s.exclude&&s.exclude.includes(t))&&/\.spec\.js$/.test(t)),name:t.name})}),r}function saveReadJSON(t){try{return existsSync(t)?readJSONSync(t):null}catch(t){return console.error(t),null}}function collectLog(t,e){let n=e,r=!1;"object"==typeof e&&(r="error"===e.type,n=e.message);const o=`${r?"[X]":"   "} ${translateLogMsg(n)}\n`;appendFile(t,o)}function translateLogMsg(t){if("string"==typeof t&&!t.includes("\n"))return t;if("string"==typeof t&&t.includes("\n"))return translateLogMsg(t.split("\n"));if(Array.isArray(t)){let e="";return t.forEach(t=>{e+=`${translateLogMsg(t)}\r`}),e}try{return JSON.stringify(t)}catch(t){}return t}module.exports={autoTest:autoTest};