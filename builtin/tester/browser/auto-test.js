"use strict";const{join:join}=require("path"),{existsSync:existsSync,readdirSync:readdirSync,readJSONSync:readJSONSync,appendFile:appendFile,outputFileSync:outputFileSync,readdir:readdir}=require("fs-extra"),TEST_CONFIG_NAME="test.config.js";async function testNativeScene(e,t=!1){const o=`场景测试失败,useNative=${e} :`,r=join(Editor.Project.tmpDir,"testScene",Date.now()+".log");return outputFileSync(r,""),console.log("testScene log path",r),new Promise((n,s)=>{let i="success";const c=setTimeout(()=>{i=`${o} 超时`,a()},3e5);function a(){clearTimeout(c),Editor.Message.removeBroadcastListener("crash-reporter:report",l),collectLog(r,i).then(()=>{n(i)})}function l(e){console.error(o,e.details),i=`${o} 场景崩溃,原生堆栈文件在工程temp/crash目录下`,a()}async function u(){Editor.Message.removeBroadcastListener("scene:ready",u);const t=await Editor.Message.request("scene","is-native");if(e&&!t)return i=`${o},编译未通过,无法正常启动原生场景`,void a();const n=require(join(__dirname,"../panel/tester"));n.on("print",async e=>(await collectLog(r,e),"log"===e.type?console.log(e.message):"error"===e.type?(i=`${o} 存在测试例未通过，请查看日志${r}`,console.error(e.message)):void console.log(e)));const s=join(Editor.App.path,"builtin/scene/test"),c=await readdir(s);for(let e=0;e<c.length;e++){const t=c[e];if(t.endsWith("spec.js")){const e=join(s,t);try{const s="run test:"+t;await collectLog(r,s,console.log),require(e),await n.run()}catch(t){i=`${o} 存在测试例未通过，请查看日志${r}`;const n=`${e}测试异常\n`+t;await collectLog(r,n,console.error)}delete require.cache[e]}}a()}Editor.Message.addBroadcastListener("crash-reporter:report",l),Editor.Message.addBroadcastListener("scene:ready",u),t&&u()})}async function autoTest(e){if(void 0!==e.useNative){const{immediately:t}=e.nativeConfig||{};return await testNativeScene(e.useNative,t)}const t=sortTestInfos();if(!t.length)return!1;const o=require(join(__dirname,"../panel/tester"));let r=!0,n=0,s=0;const i=Date.now().toString(),c=join(Editor.Project.tmpDir,"test",i,"report.ext");e.outputReport&&!existsSync(c)&&outputFileSync(c,""),o.on("print",async t=>(e.outputReport&&collectLog(c,t),"log"===t.type?console.log(t.message):"error"===t.type?(r=!1,n++,console.error(t.message)):void console.log(t)));for(const i of t){if(!i.list||!i.list.length)continue;s+=i.list.length;const t=saveReadConfig(join(i.dir,TEST_CONFIG_NAME));try{t&&t.wait&&await t.wait()}catch(e){console.error(e),r=!1,n+=i.list.length;continue}for(const t of i.list){e.outputReport&&collectLog(c,`======== ${t} ========`);const r=join(i.dir,t);try{require(r),await o.run()}catch(e){console.error(e)}delete require.cache[r]}}return console.log(`output test report in ${c}, success: ${s-n} / ${s}`),r}function sortTestInfos(){const e=Editor.Package.getPackages(),t=saveReadConfig(join(Editor.Project.path,TEST_CONFIG_NAME));if(!t)return[];0===t.packages.length&&delete t.packages;const o=[];return e.forEach(e=>{if(t.packages&&!t.packages.includes(e.name))return;const r=join(e.path,"test");if(!existsSync(r))return;const n=readdirSync(r);if(0===n.length)return;const s=saveReadConfig(join(r,TEST_CONFIG_NAME));let i;s&&(s.includes?i=(e=>s.includes.includes(e)):s.excludes&&(i=(e=>!s.excludes.includes(e)&&/\.spec\.js$/.test(e)))),o.push({dir:r,list:i?n.filter(i):n,name:e.name})}),o}function saveReadConfig(e){try{return existsSync(e)?require(e):null}catch(e){return console.error(e),null}}async function collectLog(e,t,o){let r=t,n=!1;"object"==typeof t&&(n="error"===t.type,r=t.message);const s=`${n?"[X]":"   "} ${translateLogMsg(r)}\n`;await appendFile(e,s),o&&o(t)}function translateLogMsg(e){if("string"==typeof e&&!e.includes("\n"))return e;if("string"==typeof e&&e.includes("\n"))return translateLogMsg(e.split("\n"));if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=`${translateLogMsg(e)}\r`}),t}try{return JSON.stringify(e)}catch(e){}return e}module.exports={autoTest:autoTest};