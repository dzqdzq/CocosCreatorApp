"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.stop=exports.startup=exports.setPort=exports.getPort=void 0;const fs_extra_1=require("fs-extra"),http_1=require("http"),https_1=require("https"),express_1=__importDefault(require("express")),os_1=require("os"),socket_1=require("./socket"),plugin_1=require("./plugin"),compression=require("compression"),app=(0,express_1.default)();app.use(compression());const ports={http:7456,https:7567},server={http:null,https:null};function getPort(){return ports.http}function setPort(e){ports.http=e}async function startup(){server.http=(0,http_1.createServer)(app),ports.http=await Editor.Profile.getConfig("server","server_port")||7456;const e=await Editor.Profile.getConfig("server","https");if(e.enable){const t={key:void 0,cert:void 0,ca:void 0};(0,fs_extra_1.existsSync)(e.key)&&(t.key=await(0,fs_extra_1.readFile)(e.key)),(0,fs_extra_1.existsSync)(e.cert)&&(t.cert=await(0,fs_extra_1.readFile)(e.cert)),(0,fs_extra_1.existsSync)(e.ca)&&(t.ca=await(0,fs_extra_1.readFile)(e.ca)),server.https=(0,https_1.createServer)(t,app),ports.https=await Editor.Profile.getConfig("server","https.port")||7567}try{ports.http=await Editor.Network.getFreePort(ports.http),ports.https=await Editor.Network.getFreePort(ports.https),await new Promise((e,t)=>{var r,s,o,p,n,i;const a={error(){var e,r;null===(e=server.http)||void 0===e||e.removeListener("listening",a.listener),null===(r=server.https)||void 0===r||r.removeListener("listening",a.listener),t(`Port ${ports.http} is occupied`)},listener(){var t,r;null===(t=server.http)||void 0===t||t.removeListener("error",a.error),null===(r=server.https)||void 0===r||r.removeListener("error",a.error),e()}};null===(r=server.http)||void 0===r||r.once("error",a.error),null===(s=server.http)||void 0===s||s.once("listening",a.listener),null===(o=server.http)||void 0===o||o.listen(ports.http),null===(p=server.https)||void 0===p||p.once("error",a.error),null===(n=server.https)||void 0===n||n.once("listening",a.listener),null===(i=server.https)||void 0===i||i.listen(ports.https)})}catch(e){console.warn(`Server: ${e}`)}(0,socket_1.start)(server.https||server.http),Editor.Message.broadcast("preview:port-change",ports.http)}async function stop(){var e,t;server&&(null===(e=server.http)||void 0===e||e.close(()=>{(0,socket_1.disconnect)()}),null===(t=server.https)||void 0===t||t.close(()=>{(0,socket_1.disconnect)()}),server.http=null,server.https=null)}exports.getPort=getPort,exports.setPort=setPort,exports.startup=startup,exports.stop=stop,app.all("*",(e,t,r)=>{server.https&&"http"===e.protocol?t.redirect(`https://${e.host}:${ports.https}${e.url}`):(t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Content-Type"),t.header("Access-Control-Allow-Methods","*"),r())}),app.all("/__test__connect__",(e,t,r)=>{t.send({})}),app.get("/__server__/handshake",async(e,t)=>{const r=await Editor.User.getData();t.send({host:(0,os_1.hostname)(),name:r.nickname})}),app.get("*",async(e,t,r)=>{for(let r=plugin_1.fileArray.length-1;r>=0;r--){const s=plugin_1.fileArray[r],o=e.path.match(s.regexp);if(!o)continue;e.params=o.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let p=!1;if(await new Promise(r=>{const o=t.end;t.end=function(){p=!1,t.end=o,r(),o.call(t)},s.handle(e,t,e=>{e&&console.error(e),p=!0,t.end=o,r()})}),!p)return}for(let r=plugin_1.getArray.length-1;r>=0;r--){const s=plugin_1.getArray[r],o=e.path.match(s.regexp);if(!o)continue;e.params=o.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let p=!1;if(await s.handle(e,t,()=>{p=!0}),!p)return}r()}),app.post("*",async(e,t,r)=>{for(let r=plugin_1.postArray.length-1;r>=0;r--){const s=plugin_1.postArray[r],o=e.path.match(s.regexp);if(!o)continue;e.params=o.filter((e,t)=>0!==t).map(e=>decodeURIComponent(e));let p=!1;if(await s.handle(e,t,()=>{p=!0}),!p)return}r()}),app.get("*",(e,t)=>{t.status(404),t.send("404 - Not Found")}),app.use((e,t,r,s)=>{console.error(e),r.status(500),r.send("500 - Web Server Error")});