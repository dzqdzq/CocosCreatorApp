"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.stop=exports.startup=exports.setPort=exports.getPort=void 0;const http_1=require("http"),express_1=__importDefault(require("express")),os_1=require("os"),socket_1=require("./socket"),plugin_1=require("./plugin"),compression=require("compression"),app=express_1.default();app.use(compression());let port=7456,server=null;function getPort(){return port}function setPort(e){port=e}async function startup(){for(server=http_1.createServer(app),port=await Editor.Profile.getConfig("server","server_port")||7456;;)try{await new Promise((e,r)=>{const t={error(){port++,server.removeListener("listening",t.listener),r(`Port ${port-1} is occupied`)},listener(){server.removeListener("error",t.error),e()}};server.once("error",t.error),server.once("listening",t.listener),server.listen(port)});break}catch(e){console.warn(`Server: ${e}`)}socket_1.start(server),Editor.Message.broadcast("preview:port-change",port)}async function stop(){server&&(server.close(()=>{socket_1.disconnect()}),server=null)}exports.getPort=getPort,exports.setPort=setPort,exports.startup=startup,exports.stop=stop,app.all("*",(e,r,t)=>{r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Headers","Content-Type"),r.header("Access-Control-Allow-Methods","*"),t()}),app.get("/__server__/handshake",async(e,r)=>{const t=await Editor.User.getData();r.send({host:os_1.hostname(),name:t.nickname})}),app.get("*",async(e,r,t)=>{for(let t=0;t<plugin_1.fileArray.length;t++){const o=plugin_1.fileArray[t],s=e.path.match(o.regexp);if(!s)continue;e.params=s.filter((e,r)=>0!==r).map(e=>decodeURIComponent(e));let n=!1;if(await new Promise(t=>{const s=r.end;r.end=function(){n=!1,r.end=s,t(),s.call(r)},o.handle(e,r,e=>{e&&console.error(e),n=!0,r.end=s,t()})}),!n)return}for(let t=0;t<plugin_1.getArray.length;t++){const o=plugin_1.getArray[t],s=e.path.match(o.regexp);if(!s)continue;e.params=s.filter((e,r)=>0!==r).map(e=>decodeURIComponent(e));let n=!1;if(await o.handle(e,r,()=>{n=!0}),!n)return}t()}),app.post("*",async(e,r,t)=>{for(let t=0;t<plugin_1.postArray.length;t++){const o=plugin_1.postArray[t],s=e.path.match(o.regexp);if(!s)continue;e.params=s.filter((e,r)=>0!==r).map(e=>decodeURIComponent(e));let n=!1;if(await o.handle(e,r,()=>{n=!0}),!n)return}t()}),app.get("*",(e,r)=>{r.status(404),r.send("404 - Not Found")}),app.use((e,r,t,o)=>{console.error(e),t.status(500),t.send("500 - Web Server Error")});