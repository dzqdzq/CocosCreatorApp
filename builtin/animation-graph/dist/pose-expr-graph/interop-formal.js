"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPoseExprState=exports.addPoseExprState=exports.PoseExprGraphInterop=void 0;const assert_1=__importDefault(require("assert")),cc_1=require("cc"),new_gen_anim_1=require("cc/editor/new-gen-anim"),env_type_1=require("../env-type"),new_gen_anim_2=require("cc/editor/new-gen-anim"),id_manager_1=require("./utils/id-manager"),globalIDManager=new id_manager_1.IDManager,typeInfos=Object.freeze({[new_gen_anim_1.poseGraphOp.PoseGraphType.INTEGER]:{displayName:"i18n:animation-graph.pose.type.integer.displayName",themeColor:"#2A90DC"},[new_gen_anim_1.poseGraphOp.PoseGraphType.FLOAT]:{displayName:"i18n:animation-graph.pose.type.float.displayName",themeColor:"#8471CF"},[new_gen_anim_1.poseGraphOp.PoseGraphType.BOOLEAN]:{displayName:"i18n:animation-graph.pose.type.boolean.displayName",themeColor:"#D07979"},[new_gen_anim_1.poseGraphOp.PoseGraphType.VEC3]:{displayName:"i18n:animation-graph.pose.type.vec3.displayName",themeColor:"#D97721"},[new_gen_anim_1.poseGraphOp.PoseGraphType.QUAT]:{displayName:"i18n:animation-graph.pose.type.quat.displayName",themeColor:"#B169C4"},[new_gen_anim_1.poseGraphOp.PoseGraphType.POSE]:{displayName:"i18n:animation-graph.pose.type.pose.displayName",themeColor:"#227F9B"}});class PoseGraphInterop_Formal{constructor(e,t,n){this._context=n,this._idManager=globalIDManager,this._animationGraph=e,this._poseGraph=(new_gen_anim_1.ProceduralPoseState,t.graph),this._rootOutputNodeID=this._idManager.getOrCreate(this._poseGraph.outputNode)}query(){var e,t;const n=[],o=[],s=this._rootOutputNodeID,r=new Map;for(const o of this._poseGraph.nodes()){const s=this._getNodeId(o),a=this.queryNodeDump(s),i=null!==(e=o[cc_1.editorExtrasTag])&&void 0!==e?e:o[cc_1.editorExtrasTag]={},p=[],d=new_gen_anim_1.poseGraphOp.getInputKeys(o).map(e=>{const t=(0,new_gen_anim_1.getPoseGraphNodeInputAttrs)(o,e);if(!new_gen_anim_1.poseGraphOp.getInputBinding(this._poseGraph,o,e)&&!isInputVisible(o,t))return;const n=new_gen_anim_1.poseGraphOp.getInputMetadata(o,e);(0,assert_1.default)(n);const s=new_gen_anim_1.poseGraphOp.getInputConstantValue(o,e),r=cce.Dump.encode.encodeObject(s,t,o);return p.push(e),{id:encodeNodeInputKey(e),name:getNodeInputName(o,e,n),value:r,deletable:n.deletable,type:n.type}}).filter(e=>!!e);r.set(o,p);const _=new_gen_anim_1.poseGraphOp.getInputInsertInfos(o),u=new_gen_anim_1.poseGraphOp.getOutputKeys(o).map(e=>({id:e,name:"",type:new_gen_anim_1.poseGraphOp.getOutputType(o,e)})),c=getNodeTitle(o),h=(0,new_gen_anim_2.getNodeAppearanceOptions)(o),g={id:s,name:c,inputs:d,outputs:u,inputInsertInfos:_,enterable:!!(null===(t=o.getEnterInfo)||void 0===t?void 0:t.call(o)),data:a,editorData:i,appearance:h};n.push(g)}for(const e of this._poseGraph.nodes()){const t=r.get(e);(0,assert_1.default)(t);for(const n of t){const t=new_gen_anim_1.poseGraphOp.getInputBinding(this._poseGraph,e,n);t&&o.push({sourceID:this._getNodeId(t.producer),sourceOutputID:t.outputIndex,destinationID:this._getNodeId(e),destinationInputID:encodeNodeInputKey(n)})}}const a={};for(const[e,t]of(0,new_gen_anim_2.getPoseGraphAssetDragHandlersMap)())a[cc_1.js.getClassId(e)]=t;return{nodes:n,links:o,rootOutputNode:s,addNodeInfos:this.queryAddNodeInfos(),inputOutputTypeInfos:this.queryTypeInfos(),editorData:this._poseGraph[cc_1.editorExtrasTag],assetDragHandlersMap:a}}queryTypeInfos(){return typeInfos}get TYPE_ID_POSE(){return new_gen_anim_1.poseGraphOp.PoseGraphType.POSE}queryAddNodeInfos(){return[...function*(){const e={animationGraph:this._animationGraph,layerIndex:this._context.layerIndex};for(const[t,n]of Object.entries(cc_1.js._idToClass))if(cc_1.js.isChildClassOf(n,new_gen_anim_1.poseGraphOp.Node))for(const o of(0,new_gen_anim_1.getCreatePoseGraphNodeEntries)(n,e))yield[{typeId:t,args:o.arg},{menu:composeCreateNodeMenu(n,o)}]}.call(this)]}getNodeName(e){const t=this._findNode(e);if(t)return getNodeTitle(t);this._reportMissingNode(e)}getNodeEditorData(e){var t;const n=this._findNode(e);if(n)return null!==(t=n[cc_1.editorExtrasTag])&&void 0!==t?t:n[cc_1.editorExtrasTag]={};this._reportMissingNode(e)}addNode(e,t){const n=cc_1.js.getClassById(e.typeId);if(!n)return;if(!cc_1.js.isChildClassOf(n,new_gen_anim_1.poseGraphOp.Node))return;const o=(0,new_gen_anim_1.createPoseGraphNode)(n,e.args);return this._emplaceNode(o,t)}removeNode(e){if(e===this._rootOutputNodeID)return void console.error("根节点不可删除。");const t=this._findNode(e);if(!t)return this._reportMissingNode(e);this._poseGraph.removeNode(t)}addLink(e,t,n,o){var s;const r=this._findNode(e);if(!r)return this._reportMissingNode(e);const a=this._findOutput(r,t);if(void 0===a)return this._reportMissingNodeOutput(r,e,t);const i=this._findNode(n);if(!i)return this._reportMissingNode(n);const p=this._findInput(i,o),d=p?new_gen_anim_1.poseGraphOp.getInputMetadata(i,p):void 0;if(!p||!d)return this._reportMissingNodeInput(i,n,o);if(new_gen_anim_1.poseGraphOp.hasInputBinding(this._poseGraph,i,p,r,a))return console.error(`源结点 ${r} 的输出 ${a} 和目标结点 ${i} 的输入 ${p} 之间已经存在了链接。不能重复链接。`);const _=null===(s=new_gen_anim_1.poseGraphOp.getInputMetadata(i,p))||void 0===s?void 0:s.type,u=new_gen_anim_1.poseGraphOp.getOutputType(r,a);if(_!==u)return this._reportTypeMismatch(i,p,d.type,r,a,u);new_gen_anim_1.poseGraphOp.connectNode(this._poseGraph,i,p,r,a)}removeLink(e,t,n,o){const s=this._findNode(e);if(!s)return this._reportMissingNode(e);const r=this._findOutput(s,t);if(void 0===r)return this._reportMissingNodeOutput(s,e,t);const a=this._findNode(n);if(!a)return this._reportMissingNode(n);const i=this._findInput(a,o);return i?new_gen_anim_1.poseGraphOp.hasInputBinding(this._poseGraph,a,i,s,r)?void new_gen_anim_1.poseGraphOp.disconnectNode(this._poseGraph,a,i):console.error(`源结点 ${e} 的输出 ${t} 和目标结点 ${n} 的输入 ${o} 之间并不存在连接。`):this._reportMissingNodeInput(a,n,o)}insertInput(e,t){const n=this._findNode(e);return n?t in new_gen_anim_1.poseGraphOp.getInputInsertInfos(n)?void new_gen_anim_1.poseGraphOp.insertInput(this._poseGraph,n,t):console.error(`结点 ${e} 的插入信息ID ${t} 无效。`):this._reportMissingNode(e)}deleteInput(e,t){var n,o;const s=this._findNode(e);if(!s)return this._reportMissingNode(e);const r=this._findInput(s,t);return r?null!==(o=null===(n=new_gen_anim_1.poseGraphOp.getInputMetadata(s,r))||void 0===n?void 0:n.deletable)&&void 0!==o&&o?console.error(`结点 ${e} 的输入 ${t} 不可删除。`):void new_gen_anim_1.poseGraphOp.deleteInput(this._poseGraph,s,r):this._reportMissingNodeInput(s,e,t)}getNodeEnterInfo(e){var t;const n=this._findNode(e);if(!n)return void this._reportMissingNode(e);const o=null===(t=n.getEnterInfo)||void 0===t?void 0:t.call(n);if(o)switch(o.type){case"animation-blend":return{type:env_type_1.EnvType.PoseExprAnimationBlend,target:o.target};case"state-machine":return{type:env_type_1.EnvType.StateMachine,target:o.target};case"stash":return{type:env_type_1.EnvType.LayerStash,target:{layerIndex:this._context.layerIndex,stashName:o.stashName}};default:return}}updateNodeEditorData(e,t){var n;const o=this._findNode(e);if(!o)return this._reportMissingNode(e);Object.assign(null!==(n=o[cc_1.editorExtrasTag])&&void 0!==n?n:o[cc_1.editorExtrasTag]={},t)}async updateNodeInputValue(e,t,n){if(e===this._rootOutputNodeID)return console.error("不能主动设置根输出结点的输入值。");const o=this._findNode(e);if(!o)return this._reportMissingNode(e);const s=this._findInput(o,t);if(!s)return this._reportMissingNodeInput(o,e,t);const r={value:new_gen_anim_1.poseGraphOp.getInputConstantValue(o,s)};await cce.Dump.decode.decodePatch("value",n,r);for(let e=o,t=0;t<s.length;++t){const n=s[t];if("string"==typeof n){if("object"!=typeof e||!e)return void console.error("错误的 Dump 数据！期望是对象但不是");if(!(n in e))return void console.error(`错误的 Dump 数据！期望对象存在属性 ${n} 但没有`)}else{if((0,assert_1.default)("number"==typeof n),!Array.isArray(e))return void console.error("错误的 Dump 数据！期望是数组但不是");if(n<0||n>=e.length)return void console.error(`错误的 Dump 数据！数组长度不匹配 ${n}/${s.length}`)}t===s.length-1?e[n]=r.value:e=e[n]}}updateGraphEditorData(e){var t,n;Object.assign(null!==(t=(n=this._poseGraph)[cc_1.editorExtrasTag])&&void 0!==t?t:n[cc_1.editorExtrasTag]={},e)}queryNodeDump(e){const t=this._findNode(e);if(!t)return this._reportMissingNode(e);const n=t;return cce.Dump.encode.encodeObject(n,{})}async updateNodeDump(e,t,n){const o=this._findNode(e);if(!o)return this._reportMissingNode(e);const s=o;await cce.Dump.decode.decodePatch(t,n,s)}copyNodes(e){let t=!1;const n=[];for(const o of e){if(o===this._rootOutputNodeID){console.error("Root output node is not copyable."),t=!0;break}const e=this._findNode(o);if(!e){this._reportMissingNode(o),t=!0;break}n.push(e)}if(t)return;const o=(0,new_gen_anim_1.copyPoseGraphNodes)(this._poseGraph,n);return o?{serialized:EditorExtends.serialize(o)}:void 0}async pasteNodes(e){const t=e,n=await cce.Utils.deserializeFull(t.serialized),{addedNodes:o}=(0,new_gen_anim_1.pastePoseGraphNodes)(this._poseGraph,n);return o.map(e=>this._collectNode(e))}async pasteStateMachine(e){const t=(0,new_gen_anim_2.copyStateMachineAsPoseGraphNode)(e),n={serialized:EditorExtends.serialize(t)};return await this.pasteNodes(n)}handleDropAssetIntoPoseGraph(e,t,n){const o=(0,new_gen_anim_2.createPoseNodeOnAssetDrag)(e,n);return!!o&&(this._emplaceNode(o,{centerX:t.x,centerY:t.y}),!0)}stash(e,t,n){const o=(0,new_gen_anim_1.stashPoseGraph)(e,this._poseGraph,t);if(!o)return;const s=o.useStashNode;n&&(s[cc_1.editorExtrasTag]=n,this._collectNode(s))}_getNodeId(e){return this._idManager.getOrCreate(e)}_emplaceNode(e,t){return this._poseGraph.addNode(e),t&&(e[cc_1.editorExtrasTag]=t),this._collectNode(e)}_collectNode(e){return(0,assert_1.default)([...this._poseGraph.nodes()].includes(e)),this._idManager.add(e)}_findNode(e){for(const t of this._poseGraph.nodes())if(this._idManager.getOrCreate(t)===e)return t}_findInput(e,t){const n=decodeNodeInputKey(t);if(n)return new_gen_anim_1.poseGraphOp.isValidInputKey(e,n)?n:void 0}_findOutput(e,t){return new_gen_anim_1.poseGraphOp.getOutputKeys(e).includes(t)?t:void 0}_reportMissingNode(e){console.warn(`结点 ${e} 不在图中。`)}_reportMissingNodeInput(e,t,n){console.warn(`结点 ${t} 不存在输入 ${n}。`)}_reportMissingNodeOutput(e,t,n){console.warn(`结点 ${t} 不存在输出 ${n}。`)}_reportTypeMismatch(e,t,n,o,s,r){const a=1===new_gen_anim_1.poseGraphOp.getInputKeys(e).length?Editor.I18n.t("animation-graph.pose.type_mismatch_message.unique_input"):Editor.I18n.t("animation-graph.pose.type_mismatch_message.named_input",{name:getNodeInputName(e,t)}),i=1===new_gen_anim_1.poseGraphOp.getOutputKeys(o).length?Editor.I18n.t("animation-graph.pose.type_mismatch_message.unique_output"):Editor.I18n.t("animation-graph.pose.type_mismatch_message.named_output",{name:`${s}`});console.error(Editor.I18n.t("animation-graph.pose.type_mismatch_message.message",{consumerNode:getNodeTitle(e),input:a,inputType:this._getTypeNameI18N(n),producerNode:getNodeTitle(o),output:i,outputType:this._getTypeNameI18N(r)}))}_getTypeNameI18N(e){const t=typeInfos[e].displayName;return t.startsWith("i18n:")?Editor.I18n.t(t.slice("i18n:".length)):t}}exports.PoseExprGraphInterop=PoseGraphInterop_Formal;const addPoseState_Formal=(e,{rootOutputNodeEditorData:t,poseGraphEditorData:n})=>{var o,s,r;const a=e.addProceduralPoseState();if(t){const e=a.graph.outputNode;Object.assign(null!==(o=e[cc_1.editorExtrasTag])&&void 0!==o?o:e[cc_1.editorExtrasTag]={},t)}return Object.assign(null!==(s=(r=a.graph)[cc_1.editorExtrasTag])&&void 0!==s?s:r[cc_1.editorExtrasTag]={},n),a};exports.addPoseExprState=addPoseState_Formal;const isPoseState_Formal=e=>e instanceof new_gen_anim_1.ProceduralPoseState;function getNodeTitle(e){if(e.getTitle){const t=e.getTitle();if(void 0!==t)return"string"==typeof t?t:tryTranslate(...t)}const t=e.constructor,n=cc_1.js.getClassName(e);if(n){const e=getClassConventionalI18nKey(n);return e?`i18n:${e}.displayName`:n}return t.name}function getNodeInputName(e,t,n){if(n){if("string"==typeof n.displayName)return n.displayName;if(Array.isArray(n.displayName))return tryTranslate(...n.displayName)}const o=getClassConventionalI18nKey(cc_1.js.getClassName(e.constructor));if(o){const e=(0,new_gen_anim_1.getInputConventionalI18nInfo)(t);if(e){const t=Editor.I18n.t(`${o}.${e[0]}.displayName`,e[1]);if(t)return t}}return(0,new_gen_anim_1.getInputDefaultDisplayName)(t)}function composeCreateNodeMenu(e,t){const n=[];t.category&&n.push(t.category);const o=getClassDisplayNameMayBeI18N(e);return n.push(o),t.subMenu&&n.push(t.subMenu),n.join("/")}function getClassDisplayNameMayBeI18N(e){const t=cc_1.js.getClassName(e);if(t){const e=getClassConventionalI18nKey(t);return e?`i18n:${e}.displayName`:t}return e.name}function getClassConventionalI18nKey(e){return e?e.startsWith("cc.")?`ENGINE.classes.${e}`:e:""}function tryTranslate(e,t){return Editor.I18n.t(e,t)||e}function encodeNodeInputKey(e){return JSON.stringify(e)}function decodeNodeInputKey(e){let t;try{t=JSON.parse(e)}catch(e){return}if(new_gen_anim_1.poseGraphOp.isWellFormedInputKey(t))return t}function isInputVisible(e,t){const n=t.visible;return void 0===n||("boolean"==typeof n?n:n.call(e))}exports.isPoseExprState=isPoseState_Formal;