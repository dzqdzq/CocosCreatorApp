"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,i,e,n){void 0===n&&(n=e);var a=Object.getOwnPropertyDescriptor(i,e);a&&("get"in a?i.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return i[e]}}),Object.defineProperty(t,n,a)}:function(t,i,e,n){void 0===n&&(n=e),t[n]=i[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,i){Object.defineProperty(t,"default",{enumerable:!0,value:i})}:function(t,i){t.default=i}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var i={};if(null!=t)for(var e in t)"default"!==e&&Object.prototype.hasOwnProperty.call(t,e)&&__createBinding(i,t,e);return __setModuleDefault(i,t),i},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),scene_state_component_1=__importDefault(require("./scene-state-component")),animationApi=__importStar(require("cc/editor/new-gen-anim")),EnvType={layer:"Layer",state:"State",transition:"Transition",conditionVariable:"variable",conditionConstant:"constant",stateName:"State",subStateMachineName:"State Machine",clipMotionName:"Clip Motion",animationBlend1DName:"Blend 1D",animationBlend2DName:"Blend 2D",EmptyStateName:"Empty",animationBlendVariable:"variable",animationBlendValue:"value",entryState:"EntryState",anyState:"AnyState",exitState:"ExitState",MotionState:"MotionState",SubStateMachine:"SubStateMachine",Transition:"Transition",AnimationTransition:"AnimationTransition",EmptyStateTransition:"EmptyStateTransition",ClipMotion:"ClipMotion",AnimationBlend1D:"AnimationBlend1D",AnimationBlend2D:"AnimationBlend2D",EmptyState:"EmptyState",BinaryCondition:"BinaryCondition",UnaryCondition:"UnaryCondition",TriggerCondition:"TriggerCondition"},binaryConditionOperatorI18n={EQUAL_TO:"=",NOT_EQUAL_TO:"≠",LESS_THAN:"<",LESS_THAN_OR_EQUAL_TO:"≤",GREATER_THAN:">",GREATER_THAN_OR_EQUAL_TO:"≥"},unaryConditionOperatorI18n={TRUTHY:"true",FALSY:"false"},Utils={produceEditorDataId:()=>Date.now()+Math.random().toString(),checkEditorDataId(t){t&&!t.id&&(t.id=Utils.produceEditorDataId())},getStateType(t,i){switch(t){case i.entryState:return EnvType.entryState;case i.anyState:return EnvType.anyState;case i.exitState:return EnvType.exitState;default:if(t instanceof animationApi.MotionState)return EnvType.MotionState;if(t instanceof animationApi.EmptyState)return EnvType.EmptyState;if(t instanceof animationApi.SubStateMachine)return EnvType.SubStateMachine}return""},getMotionType(t){let i="";return t instanceof animationApi.ClipMotion?i=EnvType.ClipMotion:t instanceof animationApi.AnimationBlend1D?i=EnvType.AnimationBlend1D:t instanceof animationApi.AnimationBlend2D&&(i=EnvType.AnimationBlend2D),i},getMotionValue(t){let i=null;return t instanceof animationApi.ClipMotion&&(i={uuid:t.clip?t.clip._uuid:""}),t instanceof animationApi.AnimationBlend1D&&(i={variable:t.param.variable,value:t.param.value}),t instanceof animationApi.AnimationBlend2D&&(i=[{variable:t.paramX.variable,value:t.paramX.value},{variable:t.paramY.variable,value:t.paramY.value}]),i},getMotionName(t,i){let e="";if(i){const t=i[cc_1.editorExtrasTag];if(t&&t.name)return t.name}return t instanceof animationApi.ClipMotion?e=t.clip?t.clip.name:EnvType.clipMotionName:t instanceof animationApi.AnimationBlend1D?e=t.name||EnvType.animationBlend1DName:t instanceof animationApi.AnimationBlend2D&&(e=t.name||EnvType.animationBlend2DName),e},getDefaultEditorData:(t={})=>Object.assign({id:Utils.produceEditorDataId(),centerX:0,centerY:0,name:""},t),getDefaultCrumbData:()=>({type:"",value:0,name:""}),getDefaultMotionLevel:()=>[0],getLastCrumb(t,i){let e=t[t.length-1];return(i||e.type===EnvType.layer||e.type===EnvType.SubStateMachine||"motionBlend"===e.type)&&(e=Utils.getDefaultCrumbData(),t.push(e)),e},getTransitionType(t){let i="";return i=t?animationApi.isAnimationTransition(t)?EnvType.AnimationTransition:t instanceof animationApi.EmptyStateTransition?EnvType.EmptyStateTransition:EnvType.Transition:""},getTransitionName(t){let i="";return i=t?`${t.from.name} , ${t.to.name}`:""},hasSubStateMachineCrumb(t){for(const i of t)if(i.type===EnvType.SubStateMachine)return!0;return!1}},DefaultValue={minThreshold:0,maxThreshold:1};class SceneAnimationGraph{constructor(){this.assetUuid="",this.animationGraph=null,this.crumbs=[],this.layerIndex=-1,this.layer=null,this.stateMachine=null,this.stateIndex=-1,this.state=null,this.motion=null,this.motionLevel=[],this.transitionIndex=-1,this.transition=null,this.dirtyData={origin:"",realtime:"",isDirty(){return this.origin!==this.realtime}},this.queryDataTemplate={assetInfo:null,isDirty:!1,envType:EnvType,view:{stateMachine:{states:[],transitions:[]},crumbs:[],layerIndex:-1,stateIndex:-1,transitionIndex:-1,motion:void 0,motionLevel:[]},layers:[],variables:{},variableType:animationApi.VariableType,previewState:cce.Preview.motionPreview.PreviewState,conditionVariableType:[EnvType.conditionVariable,EnvType.conditionConstant],unaryConditionOperator:animationApi.UnaryCondition.Operator,binaryConditionOperator:animationApi.BinaryCondition.Operator,binaryConditionOperatorI18n:binaryConditionOperatorI18n,unaryConditionOperatorI18n:unaryConditionOperatorI18n,cannotAddMotionStateType:[EnvType.entryState,EnvType.anyState,EnvType.exitState,EnvType.EmptyState,EnvType.SubStateMachine],cannotAddComponentStateType:[EnvType.entryState,EnvType.anyState,EnvType.exitState,EnvType.EmptyState],cannotRemoveStateType:[EnvType.entryState,EnvType.anyState,EnvType.exitState],motionType:[EnvType.ClipMotion,EnvType.AnimationBlend1D,EnvType.AnimationBlend2D],animationBlendType:[EnvType.AnimationBlend1D,EnvType.AnimationBlend2D]},this.userDefinedPreviewModelUuid={},this.resetData()}get variables(){return this.animationGraph?Array.from(this.animationGraph.variables):[]}async init(t){if(t)try{if(await this.resetData(),this.assetUuid=t,this.queryData.assetInfo=await Editor.Message.request("asset-db","query-asset-info",t),!this.queryData.assetInfo)return;cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(t)),await new Promise((i,e)=>{cc_1.assetManager.loadAny(t,(t,n)=>{t?e(t):(this.animationGraph=n,this.crumbLayer(0),i())})})}catch(t){console.error(t)}}async dialog(){return await Editor.Message.request("animation-graph","dialog-warn")}async edit(t){if(this.dirtyData.isDirty()){const t=await this.dialog();if(0===t)await this.apply();else if(2===t)return}await this.init(t)}async reset(){if(this.assetUuid){if(await Editor.Message.request("asset-db","query-asset-info",this.assetUuid))await this.init(this.assetUuid);else{let t=Editor.I18n.t("animation-graph.resetError");t=t.replace("${uuid}",this.assetUuid),console.error(t)}}else await this.resetData(),this.refresh()}async resetData(){this.assetUuid="",this.animationGraph=null,this.layer=null,this.stateMachine=null,this.state=null,this.motion=null,this.transition=null;const t=await Editor.Profile.getTemp("animation-graph","preview-model");t&&(this.userDefinedPreviewModelUuid=t),this.queryData=JSON.parse(JSON.stringify(this.queryDataTemplate)),this.dirtyData.origin=this.dirtyData.realtime="",this.resetViewData(),this.unselect()}viewport(t){if(this.motion){if(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D){const i=this.motion[cc_1.editorExtrasTag];i?i.viewport?Object.assign(i.viewport,t):i.viewport=t:this.motion[cc_1.editorExtrasTag]={viewport:t}}}else if(this.stateMachine){const i=this.stateMachine[cc_1.editorExtrasTag];i?i.viewport?Object.assign(i.viewport,t):i.viewport=t:this.stateMachine[cc_1.editorExtrasTag]={viewport:t}}}bestViewport(t){if(this.viewport(t.graph),t.states)for(const i of t.states){const t=this.getState(i.index);t&&i.editorData&&(t[cc_1.editorExtrasTag]=Object.assign(t[cc_1.editorExtrasTag]||{},i.editorData))}if(t.motions)for(const i of t.motions){const t=this.getMotionByLevel(i.level);t&&i.editorData&&(t[cc_1.editorExtrasTag]=Object.assign(t[cc_1.editorExtrasTag]||{},i.editorData))}this.refresh()}query(){return this.queryLayers(),this.queryVariables(),this.queryView(),this.queryData}async apply(){if(!this.animationGraph)return;const t=cce.Utils.serialize(this.animationGraph);if(!this.queryData.assetInfo)return;const{uuid:i,url:e}=this.queryData.assetInfo,n=await Editor.Message.request("asset-db","query-asset-info",i);if(n)await cce.Ipc.send("save-asset",n.uuid,t);else{const i=await Editor.Message.request("asset-db","create-asset",e,t);i&&(this.assetUuid=i.uuid,this.queryData.assetInfo=i)}this.dirtyData.origin="",this.refresh()}refresh(){this.dirtyData.realtime=cce.Utils.serialize(this.animationGraph),this.dirtyData.origin||(this.dirtyData.origin=this.dirtyData.realtime),this.queryData.isDirty=this.dirtyData.isDirty(),Editor.Message.broadcast("animation-graph:changed")}unselect(){Editor.Selection.clear("animation-graph")}reselect(){Editor.Selection.clear("animation-graph"),Editor.Selection.select("animation-graph",this.assetUuid)}queryView(){this.queryData.view.crumbs=this.crumbs,this.queryData.view.layerIndex=this.layerIndex,this.queryData.view.stateIndex=this.stateIndex,this.queryData.view.motionLevel=this.motionLevel,this.queryData.view.transitionIndex=this.transitionIndex,this.queryData.view.stateMachine=void 0,this.queryData.view.motion=void 0,this.stateMachine&&(this.queryData.view.stateMachine=this.queryStateMachine(this.stateMachine)),this.motion&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this.motion))}changeView(t,i,e){switch(t){case EnvType.layer:this.crumbLayer(i);break;case EnvType.entryState:case EnvType.anyState:case EnvType.exitState:case EnvType.MotionState:case EnvType.SubStateMachine:case EnvType.EmptyState:this.viewState(i);break;case EnvType.Transition:case EnvType.AnimationTransition:case EnvType.EmptyStateTransition:this.viewTransition(i);break;case EnvType.ClipMotion:case EnvType.AnimationBlend1D:case EnvType.AnimationBlend2D:this.viewMotion(e);break;default:this.crumbView()}}crumbView(t){let i,e;if(void 0!==t)this.crumbs.splice(t+1),i=this.crumbs.length-1,e=this.crumbs[i];else{i=this.crumbs.length-1,e=this.crumbs[i];const t=[EnvType.layer,EnvType.SubStateMachine,EnvType.MotionState];for(;e&&!t.includes(e.type);)i--,e=this.crumbs[i],this.crumbs.pop()}if(this.resetViewData(),this.layer){this.stateMachine=this.layer.stateMachine;for(let t=1;t<this.crumbs.length;t++){const i=this.crumbs[t];if(i.type===EnvType.SubStateMachine){const t=Array.from(this.stateMachine.states());this.stateIndex=i.value,this.state=t[this.stateIndex],this.stateMachine=this.state.stateMachine}if(i.type===EnvType.state){const t=Array.from(this.stateMachine.states());this.stateIndex=i.value,this.state=t[this.stateIndex]}if(i.type===EnvType.transition){const t=Array.from(this.stateMachine.transitions());this.transitionIndex=i.value,this.transition=t[this.transitionIndex]}if(i.type===EnvType.MotionState)if(this.stateIndex=-1,this.transitionIndex=-1,this.motion){if(this.motion instanceof animationApi.AnimationBlend1D){const t=Array.from(this.motion.items);t.length&&(this.motion=t[i.value].motion)}if(this.motion instanceof animationApi.AnimationBlend2D){const t=Array.from(this.motion.items);t.length&&(this.motion=t[i.value].motion)}}else this.state instanceof animationApi.MotionState&&(this.motion=this.state.motion,this.motionLevel=Utils.getDefaultMotionLevel(),e.name=Utils.getMotionName(this.motion,this.state),this.motion&&(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D)&&(this.motion.name=this.state.name))}}this.reselect(),this.refresh()}resetViewData(){this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.motion=null,this.motionLevel.length=0}queryLayers(){this.animationGraph&&(this.queryData.layers=this.animationGraph.layers.map((t,i)=>{var e;return{index:i,name:t.name||EnvType.layer,props:{mask:{uuid:null===(e=t.mask)||void 0===e?void 0:e._uuid},weight:void 0===t.weight?1:t.weight}}}))}addLayer(t){if(!this.animationGraph)return;const i=this.animationGraph.addLayer();t&&(i.name=t),Metric("A100008"),this.crumbLayer(this.animationGraph.layers.length-1)}removeLayer(t){if(this.animationGraph&&!(t<0))if(this.animationGraph.removeLayer(t),t===this.layerIndex){const i=0===t?0:t-1;this.crumbLayer(i)}else this.refresh()}crumbLayer(t){var i,e;if(!this.animationGraph)return;this.resetViewData(),this.layerIndex=t,this.layer=this.animationGraph.layers[this.layerIndex],this.stateMachine=null!==(e=null===(i=this.layer)||void 0===i?void 0:i.stateMachine)&&void 0!==e?e:null;const n=Utils.getDefaultCrumbData();n.type=EnvType.layer,n.value=t,n.name=this.layer.name,this.crumbs=[n],this.reselect(),this.refresh()}renameLayer(t,i){if(!this.animationGraph)return;const e=this.animationGraph.layers[t];if(!e)return;e.name=i;const n=this.crumbs[0];n&&n.value===t&&(n.name=i),this.refresh()}async changeLayer(t,i,e){if(!this.animationGraph)return;const n=this.animationGraph.layers[t];if(n){if("mask"===i){const t=e;t?(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(t)),await new Promise((i,e)=>{cc_1.assetManager.loadAny(t,(t,a)=>{t?e(t):(n.mask=a,i())})})):n.mask=null}else"weight"===i&&(n.weight=e);this.reselect(),this.refresh()}}queryStateMachine(t,i=Utils.hasSubStateMachineCrumb(this.crumbs)){const e=Array.from(t.states()),n=Array.from(t.transitions());return{states:e.map((e,a)=>{const o=e.name,s=Utils.getStateType(e,t),r=Array.from(t.getOutgoings(e)).map(t=>n.findIndex(i=>i===t)),h=Array.from(t.getIncomings(e)).map(t=>n.findIndex(i=>i===t)),c=e[cc_1.editorExtrasTag];Utils.checkEditorDataId(c);const l={index:a,name:o,type:s,outGoings:r,inComings:h,editorData:c};switch(s){case EnvType.entryState:l.editorData||(l.editorData={id:Utils.produceEditorDataId(),centerX:-125,centerY:0});break;case EnvType.exitState:l.editorData||(l.editorData={id:Utils.produceEditorDataId(),centerX:125,centerY:0});break;case EnvType.anyState:l.editorData||(l.editorData={id:Utils.produceEditorDataId(),centerX:i?0:125,centerY:i?75:0});break;default:if(l.editorData||(l.editorData={id:Utils.produceEditorDataId(),centerX:0,centerY:0}),e instanceof animationApi.MotionState?l.props={speed:e.speed,speedMultiplier:e.speedMultiplier,speedMultiplierEnabled:e.speedMultiplierEnabled,motion:{type:Utils.getMotionType(e.motion),name:Utils.getMotionName(e.motion,e),level:Utils.getDefaultMotionLevel(),value:Utils.getMotionValue(e.motion),min:[],max:[]}}:e instanceof animationApi.SubStateMachine&&(l.stateMachine=this.queryStateMachine(e.stateMachine,!0)),e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=this.getComponents(e);l.components=t.map((t,i)=>({name:t.constructor.name,index:i,value:scene_state_component_1.default.encode(t)}))}}return l}),transitions:n.map((i,n)=>{const a=[];for(const t of i.conditions)t instanceof animationApi.BinaryCondition&&a.push({type:EnvType.BinaryCondition,operator:t.operator,lhs:{type:EnvType.conditionVariable,value:{variable:t.lhs.variable,constant:t.lhs.value}},rhs:{type:EnvType.conditionConstant,value:{variable:t.rhs.variable,constant:t.rhs.value}}}),t instanceof animationApi.UnaryCondition&&a.push({type:EnvType.UnaryCondition,operator:t.operator,lhs:{type:EnvType.conditionVariable,value:{variable:t.operand.variable}}}),t instanceof animationApi.TriggerCondition&&a.push({type:EnvType.TriggerCondition,lhs:{type:EnvType.conditionVariable,value:{variable:t.trigger}}});const o=e.findIndex(t=>t===i.from),s=e.findIndex(t=>t===i.to),r={type:Utils.getTransitionType(i),index:n,priority:Array.from(t.getOutgoings(i.from)).findIndex(t=>t===i),from:{index:o,name:i.from.name,type:Utils.getStateType(i.from,t)},to:{index:s,name:i.to.name,type:Utils.getStateType(i.to,t)},removable:!0,duration:-1,relativeDuration:!1,exitConditionEnabled:void 0,interruptible:void 0,exitCondition:0,destinationStart:void 0,relativeDestinationStart:!1,editorData:i[cc_1.editorExtrasTag]||{},conditions:a};return animationApi.isAnimationTransition(i)?(r.duration=i.duration,r.relativeDuration=i.relativeDuration,i.to instanceof animationApi.EmptyState||(r.interruptible=i.interruptible),r.exitConditionEnabled=i.exitConditionEnabled,r.exitCondition=i.exitCondition):i instanceof animationApi.EmptyStateTransition&&(r.duration=i.duration),(i instanceof animationApi.EmptyStateTransition||animationApi.isAnimationTransition(i))&&i.to instanceof animationApi.MotionState&&(r.destinationStart=i.destinationStart,r.relativeDestinationStart=i.relativeDestinationStart),r}).sort((t,i)=>t.priority-i.priority),editorData:t[cc_1.editorExtrasTag]}}crumbStateMachine(t){this.resetViewData(),this.state=this.getState(t),this.state&&this.state instanceof animationApi.SubStateMachine&&(this.stateMachine=this.state.stateMachine);const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.SubStateMachine,i.value=t,i.name=this.state.name,this.reselect(),this.refresh()}getStates(){return this.stateMachine?Array.from(this.stateMachine.states()):[]}getState(t){return this.getStates()[t]||null}async addState(t){if(!this.stateMachine)return;t||(t={editorData:Utils.getDefaultEditorData()});const i=this.getStates().length;let e;if(t.subStateMachine)(e=this.stateMachine.addSubStateMachine()).name=EnvType.subStateMachineName,e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData),this.viewState(i);else if(t.type){switch(t.type){case EnvType.EmptyState:(e=this.stateMachine.addEmpty()).name=EnvType.EmptyStateName,e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData)}this.viewState(i)}else(e=await this.stateMachine.addMotion()).name=EnvType.stateName,e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData),t.motion?this.addMotionToState(i,t.motion):this.viewState(i)}removeState(t){if(!this.stateMachine)return;const i=this.getState(t);i&&(this.stateMachine.remove(i),this.crumbView())}crumbState(t){if(!this.stateMachine)return;const i=this.getState(t);i instanceof animationApi.SubStateMachine?this.crumbStateMachine(t):i instanceof animationApi.MotionState&&(i.motion instanceof animationApi.AnimationBlend1D||i.motion instanceof animationApi.AnimationBlend2D)&&this.crumbMotion(t)}viewState(t){if(!this.stateMachine)return;this.stateIndex=t,this.state=this.getState(t);const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.state,i.value=t,i.name=this.state.name,this.transitionIndex=-1,this.transition=null,this.motion=null,this.motionLevel.length=0,this.reselect(),this.refresh()}moveState(t,i){const e=this.getState(t);e&&(i.editorData&&(e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},i.editorData)),this.refresh())}renameState(t,i){const e=this.getState(t);e&&(e.name=i,e[cc_1.editorExtrasTag].name=i,Metric("A100012"),this.refresh())}changeState(t,i,e){const n=this.getState(t);if(n){if(n[i]instanceof animationApi.BindableNumber)n[i].value=e;else if(n instanceof animationApi.MotionState)switch(i){case"speed":n.speed=Number(e);break;case"speedMultiplier":n.speedMultiplier=e.toString();break;case"speedMultiplierEnabled":n.speedMultiplierEnabled=!!e}else n[i]=e;this.refresh()}}async addMotion(t){let i,e=null;switch(t.type){case EnvType.ClipMotion:if(e=new animationApi.ClipMotion,t.uuid){const i=t.uuid;cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(t.uuid)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e instanceof animationApi.ClipMotion&&(e.clip=a),t())})})}e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData(),t.editorData),Metric("A100002");break;case EnvType.AnimationBlend1D:e=new animationApi.AnimationBlend1D,(i=this.getFirstNumberVariable())&&(e.param.variable=i[0]),e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData({autoThreshold:!0}),t.editorData),Metric("A100003");break;case EnvType.AnimationBlend2D:e=new animationApi.AnimationBlend2D,(i=this.getFirstNumberVariable())&&(e.paramX.variable=i[0],e.paramY.variable=i[0]),e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData(),t.editorData),Metric("A100004")}return e}async addMotionToState(t,i){const e=this.getState(t);if(!(e&&e instanceof animationApi.MotionState))return;let n=e.name;const a=[EnvType.clipMotionName,EnvType.animationBlend1DName,EnvType.animationBlend2DName,EnvType.stateName],o=await this.addMotion(i);switch(i.type){case EnvType.ClipMotion:n=a[0];break;case EnvType.AnimationBlend1D:n=a[1];break;case EnvType.AnimationBlend2D:n=a[2]}if(a.includes(e.name)&&(e.name=n),o){e.motion=o,e.name=Utils.getMotionName(o,e),Utils.getLastCrumb(this.crumbs).name=e.name}this.viewState(t)}async changeClipMotion(t,i){const e=this.getState(t);e&&(i?(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(i)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(e.motion.clip=a,e.name=Utils.getMotionName(e.motion,e)),t())})})):e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(e.motion.clip=null,e.name=Utils.getMotionName(e.motion,e)),this.reselect(),this.refresh())}crumbMotion(t){if(!this.stateMachine)return;if(this.motion){if(this.motion instanceof animationApi.AnimationBlend1D){const i=Array.from(this.motion.items);i.length&&(this.motion=i[t].motion)}if(this.motion instanceof animationApi.AnimationBlend2D){const i=Array.from(this.motion.items);i.length&&(this.motion=i[t].motion)}}else{const i=this.getState(t);if(!(i&&i instanceof animationApi.MotionState))return;if(!i.motion||i.motion instanceof animationApi.ClipMotion)return;this.motion=i.motion,this.motion&&(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D)&&(this.motion.name=i.name)}this.motionLevel=Utils.getDefaultMotionLevel();const i=Utils.getLastCrumb(this.crumbs,!0);i.type=EnvType.MotionState,i.name=Utils.getMotionName(this.motion,null),i.value=this.motionLevel,this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.reselect(),this.refresh()}crumbMotionInMotion(t){if(!this.motion)return;let i=this.motion;for(let e=1;e<t.length;e++){const n=t[e];if(i instanceof animationApi.AnimationBlend1D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}else if(i instanceof animationApi.AnimationBlend2D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}if(!i)break;const a=Utils.getLastCrumb(this.crumbs,!0);a.type=EnvType.MotionState,a.name=Utils.getMotionName(i,null),a.value=n}this.motion!==i&&(this.motion=i,this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.motionLevel.length=0,this.reselect(),this.refresh())}getMotionByLevel(t){let i=this.motion;for(let e=1;e<t.length;e++){const n=t[e];if(i instanceof animationApi.AnimationBlend1D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}else if(i instanceof animationApi.AnimationBlend2D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}}return i}getFirstNumberVariable(){if(!this.animationGraph)return null;let t=this.variables.find(t=>0===t[1]._type);return t||this.animationGraph.addFloat(this.uniqueVariableName("Blend"),0),t=this.variables.find(t=>0===t[1]._type)}removeMotion(t){const i=this.getState(t);i&&(i instanceof animationApi.MotionState&&(i.motion=null),this.reselect(),this.refresh())}getCurrentMotion(){return this.motionLevel.length?this.getMotionByLevel(this.motionLevel):this.state instanceof animationApi.MotionState?this.state.motion:null}viewMotion(t){const i=this.getMotionByLevel(t);if(!i)return;this.motionLevel=t;const e=Utils.getLastCrumb(this.crumbs);e.name=Utils.getMotionName(i,null),e.value=t,this.reselect(),this.refresh()}moveMotion(t,i){const e=this.getMotionByLevel(t);e&&i.editorData&&(e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},i.editorData)),this.refresh()}queryMotion(t,i,e){const n={type:Utils.getMotionType(i),name:Utils.getMotionName(i,null),level:t,value:Utils.getMotionValue(i),threshold:e,min:[],max:[]};if(e instanceof cc_1.Vec2&&(n.threshold={x:e.x,y:e.y}),i instanceof animationApi.ClipMotion&&(n.editorData=i[cc_1.editorExtrasTag]),i instanceof animationApi.AnimationBlend1D){n.editorData=i[cc_1.editorExtrasTag];const e=Array.from(i.items);if(Array.isArray(e)){n.children=[];const i=[];for(let a=0;a<e.length;a++){const o=e[a];if(o&&o.motion){const e=t.slice();e.push(a),i.push(o.threshold);const s=this.queryMotion(e,o.motion,o.threshold);n.children.push(s)}}i.length&&(n.min[0]=Math.min(...i),n.max[0]=Math.max(...i))}}if(i instanceof animationApi.AnimationBlend2D){n.editorData=i[cc_1.editorExtrasTag];const e=Array.from(i.items);if(Array.isArray(e)){n.children=[];const i=[],a=[];for(let o=0;o<e.length;o++){const s=e[o];if(s&&s.motion){const e=t.slice();e.push(o),i.push(s.threshold.x),a.push(s.threshold.y);const r=this.queryMotion(e,s.motion,s.threshold);n.children.push(r)}}i.length&&(n.min=[Math.min(...i),Math.min(...a)],n.max=[Math.max(...i),Math.max(...a)])}}return n}async addMotionToMotion(t,i){const e=this.getMotionByLevel(t);if(!e)return;const n=await this.addMotion(i);if(e instanceof animationApi.AnimationBlend1D){const i=new animationApi.AnimationBlend1D.Item;i.motion=n;const a=Array.from(e.items),o=a.length;if(0===o)i.threshold=DefaultValue.minThreshold;else if(1===o)i.threshold=DefaultValue.maxThreshold;else{const t=e[cc_1.editorExtrasTag],n=[];a.forEach(t=>{n.push(t.threshold)});const s=Math.min(...n),r=Math.max(...n),h=(r-s)/o;t&&!0===t.autoThreshold&&a.forEach((t,i)=>{t.threshold=s+h*i}),i.threshold=r}const s=Array.from(e.items);s.push(i),e.items=s,t.push(s.length-1)}else if(e instanceof animationApi.AnimationBlend2D){const i=Array.from(e.items),a=new animationApi.AnimationBlend2D.Item;a.motion=n,a.threshold=new cc_1.Vec2(0,0),i.push(a),e.items=i,t.push(i.length-1)}this.viewMotion(t)}renameMotionInMotion(t,i){const e=this.getMotionByLevel(t);(e instanceof animationApi.AnimationBlend1D||e instanceof animationApi.AnimationBlend2D)&&(e.name=i,this.refresh())}removeMotionInMotion(t){const i=t.pop();if(void 0===i||!t.length)return;const e=this.getMotionByLevel(t);if(e)if(e instanceof animationApi.AnimationBlend1D){const t=Array.from(e.items);t.splice(i,1);const n=t.length;if(n>2){const i=e[cc_1.editorExtrasTag],a=[];t.forEach(t=>{a.push(t.threshold)});const o=Math.min(...a),s=(Math.max(...a)-o)/(n-1);i&&!0===i.autoThreshold&&t.forEach((t,i)=>{t.threshold=o+s*i})}e.items=t}else if(e instanceof animationApi.AnimationBlend2D){const t=Array.from(e.items);t.splice(i,1),e.items=t}this.motionLevel.length=0,this.crumbView()}changeMotionAutoThreshold(t,i){const e=this.getMotionByLevel(t);e instanceof animationApi.AnimationBlend1D&&(e[cc_1.editorExtrasTag].autoThreshold=i,Metric("A100007"),this.refresh())}changeMotionThreshold1D(t,i,e){const n=this.getMotionByLevel(t);if(!(n instanceof animationApi.AnimationBlend1D))return;const a=Array.from(n.items),o=a[i];o&&(o.threshold=e,n.items=a,Metric("A100007"),this.refresh())}changeMotionThreshold2D(t,i,e,n){const a=this.getMotionByLevel(t);if(!(a instanceof animationApi.AnimationBlend2D))return;const o=Array.from(a.items)[i];o&&("x"===e?o.threshold.x=n:"y"===e&&(o.threshold.y=n),Metric("A100007"),this.refresh())}async changeClipMotionInMotion(t,i){const e=this.getMotionByLevel(t);e instanceof animationApi.ClipMotion&&(i?(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(i)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e.clip=a,t())})})):e.clip=null,Metric("A100007"),this.refresh())}changeAnimationBlend1DInMotion(t,i,e){const n=this.getMotionByLevel(t);n instanceof animationApi.AnimationBlend1D&&(i===EnvType.animationBlendVariable&&(n.param.variable=e),i===EnvType.animationBlendValue&&(n.param.value=e),Metric("A100007"),this.refresh())}changeAnimationBlend2DInMotion(t,i,e,n){const a=this.getMotionByLevel(t);if(!(a instanceof animationApi.AnimationBlend2D))return;const o=1===i?a.paramY:a.paramX;e===EnvType.animationBlendVariable&&(o.variable=n),e===EnvType.animationBlendValue&&(o.value=n),Metric("A100007"),this.refresh()}getComponents(t){return(t instanceof animationApi.MotionState||t instanceof animationApi.SubStateMachine)&&t.components?Array.from(t.components):[]}getComponent(t,i=this.state){return this.getComponents(i)[t]||null}addComponent(t,i){const e=this.getState(t);if(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=cc_1.js.getClassByName(i.name);t&&e.addComponent(t),this.refresh()}}removeComponent(t,i){const e=this.getState(t);if(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=this.getComponent(i,e);e.removeComponent(t)}this.refresh()}async changeComponent(t,i,e){const n=this.getState(t);if(n instanceof animationApi.MotionState||n instanceof animationApi.SubStateMachine){const t=this.getComponent(i,n);await scene_state_component_1.default.change(t,e)}this.refresh()}getTransitions(){return this.stateMachine?Array.from(this.stateMachine.transitions()):[]}getTransition(t){return this.getTransitions()[t]||null}addTransition(t,i){if(!this.stateMachine)return null;const e=this.getStates(),n=e[t],a=e[i];if(a===this.stateMachine.anyState)return console.warn(Editor.I18n.t("animation-graph.transition.toAnyIsInvalid")),null;const o=this.getTransitions().length;return this.stateMachine.connect(n,a),Metric("A100005"),this.viewTransition(o),this.getTransition(o)}removeTransition(t,i){if(!this.stateMachine)return;const e=this.getTransition(t);if(!e)return;i?this.stateMachine.disconnect(e.from,e.to):this.stateMachine.removeTransition(e);const n=this.getTransitions();for(let t=0;t<n.length;t++)if(n[t].from===e.from&&n[t].to===e.to)return void this.viewTransition(t);this.crumbView()}viewTransition(t){this.transition=this.getTransition(t),this.transitionIndex=t;const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.transition,i.value=t,i.name=Utils.getTransitionName(this.transition),this.stateIndex=-1,this.state=null,this.motion=null,this.motionLevel.length=0,this.reselect(),this.refresh()}changeTransitionProp(t,i,e){const n=this.getTransition(t);n&&("relativeDuration"===i&&animationApi.isAnimationTransition(n)?n.relativeDuration=!n.relativeDuration:"relativeDestinationStart"===i&&animationApi.isAnimationTransition(n)?n.relativeDestinationStart=!n.relativeDestinationStart:n[i]=e,Metric("A100006"),this.refresh())}adjustTransitionPriority(t,i){const e=this.getTransition(t);this.stateMachine&&e&&(this.stateMachine.adjustTransitionPriority(e,i),this.refresh())}addCondition(t,i){const e=`add${i.type}`;e in this&&this[e](t,i),this.refresh()}addBinaryCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.BinaryCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeBinaryCondition(t,n,i))}addUnaryCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.UnaryCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeUnaryCondition(t,n,i))}addTriggerCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.TriggerCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeTriggerCondition(t,n,i))}getCondition(t,i){const e=this.getTransition(t);return e&&e.conditions[i]||null}removeCondition(t,i){const e=this.getTransition(t);e&&(e.conditions.splice(i,1),this.refresh())}changeCondition(t,i,e){const n=`change${e.type}`;n in this&&this[n](t,i,e),this.refresh()}changeBinaryCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.BinaryCondition&&(e.lhs&&(e.lhs.type===EnvType.conditionVariable?n.lhs.variable=e.lhs.value.variable:e.lhs.type===EnvType.conditionConstant&&(n.lhs.value=e.lhs.value.constant)),e.rhs&&(e.rhs.type===EnvType.conditionVariable?n.rhs.variable=e.rhs.value.variable:e.rhs.type===EnvType.conditionConstant&&(n.rhs.value=e.rhs.value.constant)),void 0!==e.operator&&(n.operator=e.operator-0))}changeUnaryCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.UnaryCondition&&(e.lhs&&e.lhs.type===EnvType.conditionVariable&&(n.operand.variable=e.lhs.value.variable),void 0!==e.operator&&(n.operator=e.operator-0))}changeTriggerCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.TriggerCondition&&e.lhs&&e.lhs.type===EnvType.conditionVariable&&(n.trigger=e.lhs.value.variable)}queryVariables(){if(this.animationGraph){this.queryData.variables={};for(const t of this.variables){const[i,e]=t;this.queryData.variables[i]={type:animationApi.VariableType[e.type],value:e.value},e.type===animationApi.VariableType.TRIGGER&&(this.queryData.variables[i].resetMode=e.resetMode)}}}addVariable(t,i){if(this.animationGraph){switch(t=this.uniqueVariableName(t),parseInt(i)){case animationApi.VariableType.FLOAT:this.animationGraph.addFloat(t);break;case animationApi.VariableType.BOOLEAN:this.animationGraph.addBoolean(t);break;case animationApi.VariableType.TRIGGER:this.animationGraph.addTrigger(t);break;case animationApi.VariableType.INTEGER:this.animationGraph.addInteger(t)}return Metric("A100009"),this.refresh(),t}}renameVariable(t,i){if(this.animationGraph){this.animationGraph.renameVariable(t,i);for(const e of animationApi.viewVariableBindings(this.animationGraph))e.name===t&&e.rebind(i);Metric("A100013"),this.refresh()}}changeVariable(t,i,e){if(!this.animationGraph)return;const n=this.animationGraph.getVariable(t);n&&(n.type===animationApi.VariableType.TRIGGER&&"resetMode"===e?n.resetMode=i?animationApi.TriggerResetMode.NEXT_FRAME_OR_AFTER_CONSUMED:animationApi.TriggerResetMode.AFTER_CONSUMED:n.value=i,this.refresh())}removeVariable(t){this.animationGraph&&(this.animationGraph.removeVariable(t),this.refresh())}uniqueVariableName(t){const i=[];for(const t of this.variables)i.push(t[0]);for(;t&&i.includes(t);)/(\d+)$/.test(t)?t=t.replace(/(\d+)$/,(t,i)=>{let e=parseInt(i,10);return(e+=1).toString()}):t+="1";return t}queryPreviewMotion(){let t=this.motion;return t||this.state instanceof animationApi.MotionState&&(t=this.state.motion),t}async setPreviewModel(t){this.userDefinedPreviewModelUuid[this.assetUuid]=t,await Editor.Profile.setTemp("animation-graph","preview-model",this.userDefinedPreviewModelUuid)}async queryPreviewModel(){if(this.userDefinedPreviewModelUuid[this.assetUuid])return this.userDefinedPreviewModelUuid[this.assetUuid];const{animationGraph:t}=this;if(!t)return"";for(const i of iterateAllAnimationClips(t)){const t=await queryPreviewModelOfAnimationClip(i);if(t)return t}return""}}async function queryPreviewModelOfAnimationClip(t){const{_uuid:i}=t;if(!i)return"";let e="";const n=i.split("@");if(Array.isArray(n)&&(e=n[0]),!e)return"";const a=await Editor.Message.request("asset-db","query-asset-info",e);if(!a)return"";let o=!1,s="";for(const[t,i]of Object.entries(a.subAssets))if(i.type){const e=cc_1.js.getClassByName(i.type);if(!o&&cc_1.js.isChildClassOf(e,cc_1.Mesh)&&(o=!0),!s&&cc_1.js.isChildClassOf(e,cc_1.Prefab)&&(s=t),o&&s)break}return o&&s?a.subAssets[s].uuid:""}function*iterateAllAnimationClips(t){function*i(t){if(t instanceof animationApi.ClipMotion)t.clip&&(yield t.clip);else if(t instanceof animationApi.AnimationBlend1D||t instanceof animationApi.AnimationBlend2D||t instanceof animationApi.AnimationBlendDirect)for(const{motion:e}of t.items)e&&(yield*i(e))}function*e(t){for(const n of t.states())n instanceof animationApi.MotionState?n.motion&&(yield*i(n.motion)):n instanceof animationApi.SubStateMachine&&(yield*e(n.stateMachine))}for(const i of t.layers)yield*e(i.stateMachine)}function*getTransitiveOutgoingMotionStates(t,i){for(const e of t.getOutgoings(i))e instanceof animationApi.MotionState?yield e:e instanceof animationApi.SubStateMachine&&(yield*getTransitiveOutgoingMotionStates(e.stateMachine,e.stateMachine.entryState))}function Metric(t,i){t&&Editor.Metrics._trackEventWithTimer({category:"animationStateMachine",id:t,value:1})}exports.default=new SceneAnimationGraph;