"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,a)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,n,i){var a,o=arguments.length,r=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(r=(o<3?a(r):o>3?a(t,n,r):a(t,n))||r);return o>3&&r&&Object.defineProperty(t,n,r),r},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),scene_state_component_1=__importDefault(require("./scene-state-component")),animationApi=__importStar(require("cc/editor/new-gen-anim")),env_type_1=require("./env-type"),make_life_easier_utils_1=require("./make-life-easier-utils"),variable_value_dump_1=require("./variable-value-dump"),interop_formal_1=require("./pose-expr-graph/interop-formal"),assert_1=__importDefault(require("assert")),state_machine_env_1=require("./envs/state-machine-env"),motion_env_1=require("./envs/motion-env"),pose_graph_env_1=require("./envs/pose-graph-env"),binaryConditionOperatorI18n={EQUAL_TO:"=",NOT_EQUAL_TO:"≠",LESS_THAN:"<",LESS_THAN_OR_EQUAL_TO:"≤",GREATER_THAN:">",GREATER_THAN_OR_EQUAL_TO:"≥"},unaryConditionOperatorI18n={TRUTHY:"true",FALSY:"false"},Utils={editorDataCloneMethod(e){let t;return e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(t=""),Object.assign(Object.assign({},this),{name:t,id:Utils.produceEditorDataId(),clone:Utils.editorDataCloneMethod})},produceEditorDataId:()=>EditorExtends.UuidUtils.generate(!1),checkEditorData:e=>(e&&(void 0===e.name&&(e.name=""),e.id||(e.id=Utils.produceEditorDataId()),e.clone||(e.clone=Utils.editorDataCloneMethod)),e),getInitialEditorData:(e={})=>Object.assign(Utils.checkEditorData({name:""}),e),getStateType(e,t){switch(e){case t.entryState:return env_type_1.EnvType.entryState;case t.anyState:return env_type_1.EnvType.anyState;case t.exitState:return env_type_1.EnvType.exitState;default:if(e instanceof animationApi.MotionState)return env_type_1.EnvType.MotionState;if((0,interop_formal_1.isPoseExprState)(e))return env_type_1.EnvType.PoseExprState;if(e instanceof animationApi.EmptyState)return env_type_1.EnvType.EmptyState;if(e instanceof animationApi.SubStateMachine)return env_type_1.EnvType.SubStateMachine}return""},canNotAddMotionToState:e=>state_machine_env_1.cannotAddMotionStateType.includes(e),canNotAddComponentToState:e=>state_machine_env_1.cannotAddComponentStateType.includes(e),canNotRemoveState:e=>state_machine_env_1.cannotRemoveStateType.includes(e),canNotCopyState:e=>state_machine_env_1.cannotRemoveStateType.includes(e),getMotionType(e){let t="";return e instanceof animationApi.ClipMotion?t=env_type_1.EnvType.ClipMotion:e instanceof animationApi.AnimationBlend1D?t=env_type_1.EnvType.AnimationBlend1D:e instanceof animationApi.AnimationBlend2D&&(t=env_type_1.EnvType.AnimationBlend2D),t},getMotionValue(e){let t=null;return e instanceof animationApi.ClipMotion&&(t={uuid:e.clip?e.clip._uuid:""}),e instanceof animationApi.AnimationBlend1D&&(t={variable:e.param.variable,value:e.param.value}),e instanceof animationApi.AnimationBlend2D&&(t=[{variable:e.paramX.variable,value:e.paramX.value},{variable:e.paramY.variable,value:e.paramY.value}]),t},getMotionName(e,t){let n="";if(t){const e=t[cc_1.editorExtrasTag];if(e&&e.name)return e.name}return e instanceof animationApi.ClipMotion?n=e.clip?e.clip.name:env_type_1.EnvType.clipMotionName:e instanceof animationApi.AnimationBlend1D?n=e.name||env_type_1.EnvType.animationBlend1DName:e instanceof animationApi.AnimationBlend2D&&(n=e.name||env_type_1.EnvType.animationBlend2DName),n},getDefaultMotionLevel:()=>[0],changeCrumb(e,t,n,i,a){const o=e[e.length-1];a||o.type===env_type_1.EnvType.layer?e.push({type:t,value:i,name:n}):(o.type=t,o.value=i,o.name=n)},getTransitionType(e){let t="";return t=e?animationApi.isAnimationTransition(e)?env_type_1.EnvType.AnimationTransition:e instanceof animationApi.EmptyStateTransition?env_type_1.EnvType.EmptyStateTransition:env_type_1.EnvType.Transition:""},getTransitionName(e){let t="";return t=e?`${e.from.name} , ${e.to.name}`:""},hasSubStateMachineCrumb(e){for(const t of e)if(t.type===env_type_1.EnvType.SubStateMachine)return!0;return!1},getValidName(e,t){const n=Array.from(t.states()).filter(e=>e!==t.anyState&&e!==t.entryState&&e!==t.exitState).map(e=>e&&e.name||"");for(;n.includes(e);)isFinite(Number(e))&&(e+="-"),/(\d+)$/.test(e)?e=e.replace(/(\d+)$/,(e,t)=>{let n=parseInt(t,10);return(n+=1).toString().padStart(t.length,"0")}):(e.endsWith("-")||(e+="-"),e+="001");return e}},DefaultValue={minThreshold:0,maxThreshold:1};class SceneAnimationGraph{get variables(){return this.animationGraph?Array.from(this.animationGraph.variables):[]}get stateMachine(){const e=this._getIfIsStateMachineEnv();return null===e||void 0===e?void 0:e.stateMachine}constructor(){this.assetUuid="",this.animationGraph=null,this.crumbs=[],this.layerIndex=-1,this.layer=null,this._currentEnv=void 0,this.dirtyData={origin:"",realtime:"",isDirty(){return this.origin!==this.realtime}},this.queryDataTemplate={assetInfo:null,isDirty:!1,pasteInfo:{type:"none"},envType:env_type_1.EnvType,view:{stateMachine:{allowEmptyStates:!1,states:[],transitions:[]},crumbs:[],layerIndex:-1,stateIndex:-1,transitionIndex:-1,motion:void 0,motionLevel:[],poseExpr:void 0},layers:[],variables:{},variableType:animationApi.VariableType,previewState:cce.Preview.motionPreview.PreviewState,conditionVariableType:[env_type_1.EnvType.conditionVariable,env_type_1.EnvType.conditionConstant],unaryConditionOperator:animationApi.UnaryCondition.Operator,binaryConditionOperator:animationApi.BinaryCondition.Operator,binaryConditionOperatorI18n:binaryConditionOperatorI18n,unaryConditionOperatorI18n:unaryConditionOperatorI18n,cannotAddMotionStateType:state_machine_env_1.cannotAddMotionStateType,cannotAddComponentStateType:state_machine_env_1.cannotAddComponentStateType,cannotRemoveStateType:state_machine_env_1.cannotRemoveStateType,motionType:motion_env_1.motionType,animationBlendType:motion_env_1.animationBlendType,AnimationBlend2DAlgorithm:animationApi.AnimationBlend2D.Algorithm,TCBindingValueType:animationApi.TCBindingValueType,tcBindingTypeInfos:getTCBindingTypeInfos()},this.clipBoard={type:"none"},this.userDefinedPreviewModelUuid={},this.resetData()}async init(e){if(e)try{if(await this.resetData(),this.assetUuid=e,this.queryData.assetInfo=await Editor.Message.request("asset-db","query-asset-info",e),!this.queryData.assetInfo)return;const t=await loadAssetUncached(e);this.ensureEditorData(t),this.animationGraph=t,this.crumbLayer(0)}catch(e){console.error(e)}}ensureEditorData(e){for(const n of animationApi.visitAnimationGraphEditorExtras(e))"object"==typeof(t=n)&&t&&"conditions"in t||(n[cc_1.editorExtrasTag]?Utils.checkEditorData(n[cc_1.editorExtrasTag]):n[cc_1.editorExtrasTag]=Utils.getInitialEditorData());var t}async dialog(){return await Editor.Message.request("animation-graph","dialog-warn")}async edit(e){if(this.dirtyData.isDirty()){const e=await this.dialog();if(0===e)await this.apply();else if(2===e)return}await this.init(e)}async reset(){if(this.assetUuid){if(await Editor.Message.request("asset-db","query-asset-info",this.assetUuid))await this.init(this.assetUuid);else{let e=Editor.I18n.t("animation-graph.resetError");e=e.replace("${uuid}",this.assetUuid),console.error(e)}}else await this.resetData(),this.refresh()}async resetData(){this.assetUuid="",this.animationGraph=null,this.layer=null,this._currentEnv=void 0,this.clipBoard={type:"none"};const e=await Editor.Profile.getTemp("animation-graph","preview-model");e&&(this.userDefinedPreviewModelUuid=e),this.queryData=JSON.parse(JSON.stringify(this.queryDataTemplate)),this.dirtyData.origin=this.dirtyData.realtime="",this.resetViewData(),this.unselect()}query(){return this.queryLayers(),this.queryVariables(),this.queryView(),this.queryData}async apply(){if(!this.animationGraph)return;const e=cce.Utils.serialize(this.animationGraph);if(!this.queryData.assetInfo)return;const{uuid:t,url:n}=this.queryData.assetInfo,i=await Editor.Message.request("asset-db","query-asset-info",t);if(i)await cce.Ipc.send("save-asset",i.uuid,e);else{const t=await Editor.Message.request("asset-db","create-asset",n,e);t&&(this.assetUuid=t.uuid,this.queryData.assetInfo=t)}this.dirtyData.origin="",this.refresh()}refresh(){switch(this.dirtyData.realtime=cce.Utils.serialize(this.animationGraph),this.dirtyData.origin||(this.dirtyData.origin=this.dirtyData.realtime),this.queryData.isDirty=this.dirtyData.isDirty(),this.clipBoard.type){default:this.queryData.pasteInfo={type:"none"};break;case"pose-nodes":this.queryData.pasteInfo={type:"pose-nodes"};break;case"state":this.queryData.pasteInfo={type:"state",withTransitions:this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&this.clipBoard.stateMachine===this._currentEnv.stateMachine};break;case"state-machine":this.queryData.pasteInfo={type:"state-machine"}}Editor.Message.broadcast("animation-graph:changed")}unselect(){Editor.Selection.clear("animation-graph")}reselect(){Editor.Selection.clear("animation-graph"),Editor.Selection.select("animation-graph",this.assetUuid)}queryView(){this.queryData.view.crumbs=this.crumbs,this.queryData.view.layerIndex=this.layerIndex,this.queryData.view.stateMachine=void 0,this.queryData.view.stateIndex=-1,this.queryData.view.transitionIndex=-1,this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&(this.queryData.view.stateMachine=this.queryStateMachine(this._currentEnv.stateMachine),this.queryData.view.stateIndex=this._currentEnv.stateIndex,this.queryData.view.transitionIndex=this._currentEnv.transitionIndex),this.queryData.view.motion=void 0,this.queryData.view.motionLevel=[],this._currentEnv instanceof motion_env_1.MotionEnv&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this._currentEnv.motion),this.queryData.view.motionLevel=this._currentEnv.motionLevel),this._currentEnv&&this._currentEnv instanceof motion_env_1.MotionEnv&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this._currentEnv.motion,void 0,!0)),this.queryData.view.poseExpr=void 0,this.queryData.view.poseExprNodeId=void 0,this._currentEnv instanceof pose_graph_env_1.PoseGraphEnv&&(this.queryData.view.poseExpr=this._currentEnv.poseGraphInterop.query(),this.queryData.view.poseExprNodeId=this._currentEnv.poseExprNodeId)}changeView(e,t,n){switch(e){case env_type_1.EnvType.layer:this.crumbLayer(t);break;case env_type_1.EnvType.entryState:case env_type_1.EnvType.anyState:case env_type_1.EnvType.exitState:case env_type_1.EnvType.MotionState:case env_type_1.EnvType.SubStateMachine:case env_type_1.EnvType.EmptyState:case env_type_1.EnvType.PoseExprState:this.viewState(t);break;case env_type_1.EnvType.Transition:case env_type_1.EnvType.AnimationTransition:case env_type_1.EnvType.EmptyStateTransition:this.viewTransition(t);break;case env_type_1.EnvType.ClipMotion:case env_type_1.EnvType.AnimationBlend1D:case env_type_1.EnvType.AnimationBlend2D:this.viewMotion(n);break;case env_type_1.EnvType.PoseExprNode:this.viewPoseNode(t);break;default:this.crumbView()}}crumbView(e){if(!this.animationGraph)return;let t,n;if(void 0!==e)this.crumbs.splice(e+1),t=this.crumbs.length-1,n=this.crumbs[t];else{t=this.crumbs.length-1,n=this.crumbs[t];const e=[env_type_1.EnvType.layer,env_type_1.EnvType.SubStateMachine,env_type_1.EnvType.MotionState,env_type_1.EnvType.PoseExprState,env_type_1.EnvType.StateMachine,env_type_1.EnvType.LayerStash];for(;n&&!e.includes(n.type);)t--,n=this.crumbs[t],this.crumbs.pop()}if(n.type!==env_type_1.EnvType.SubStateMachine&&n.type!==env_type_1.EnvType.StateMachine&&n.type!==env_type_1.EnvType.PoseExprState&&n.type!==env_type_1.EnvType.MotionState&&n.type!==env_type_1.EnvType.LayerStash&&n.type!==env_type_1.EnvType.PoseExprNode||Utils.changeCrumb(this.crumbs,"","",null,!0),this.resetViewData(),this.layer){this._currentEnv=new state_machine_env_1.StateMachineEnv(this.layer.stateMachine);for(let e=1;e<this.crumbs.length;e++){const t=this.crumbs[e];if(t.type===env_type_1.EnvType.SubStateMachine){(0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv);const e=this._currentEnv,n=Array.from(e.stateMachine.states());e.stateIndex=t.value,e.state=n[e.stateIndex],e.state instanceof animationApi.SubStateMachine&&(e.stateMachine=e.state.stateMachine)}if(t.type===env_type_1.EnvType.state){(0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv);const e=this._currentEnv,n=Array.from(e.stateMachine.states());e.stateIndex=t.value,e.state=n[e.stateIndex]}if(t.type===env_type_1.EnvType.transition){(0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv);const e=this._currentEnv,n=Array.from(e.stateMachine.transitions());e.transitionIndex=t.value,e.transition=n[e.transitionIndex]}if(t.type===env_type_1.EnvType.MotionState){const e=this._currentEnv;if(e instanceof state_machine_env_1.StateMachineEnv){if(e.stateIndex=-1,e.transitionIndex=-1,e.state instanceof animationApi.MotionState){const t=e.state.motion;if(!t)return;this._currentEnv=new motion_env_1.MotionEnv(t,Utils.getDefaultMotionLevel()),n.name=Utils.getMotionName(t,e.state),t&&isAnimationBlend(t)&&(t.name=e.state.name)}}else{if((0,assert_1.default)(e instanceof motion_env_1.MotionEnv),e.motion instanceof animationApi.AnimationBlend1D){const n=Array.from(e.motion.items);if(n.length){(0,assert_1.default)("number"==typeof t.value);const i=n[t.value].motion;if(!i)return;this._currentEnv=new motion_env_1.MotionEnv(i,e.motionLevel)}}if(e.motion instanceof animationApi.AnimationBlend2D){const n=Array.from(e.motion.items);if(n.length){(0,assert_1.default)("number"==typeof t.value);const i=n[t.value].motion;if(!i)return;this._currentEnv=new motion_env_1.MotionEnv(i,e.motionLevel)}}}}if(t.type===env_type_1.EnvType.PoseExprState){(0,assert_1.default)(this._currentEnv instanceof state_machine_env_1.StateMachineEnv);const e=this._currentEnv,n=Array.from(e.stateMachine.states())[t.value];n&&(0,interop_formal_1.isPoseExprState)(n)&&this.editPoseGraph(n)}t.type===env_type_1.EnvType.PoseExprNode&&this._enterPoseNode(t.value,!1),t.type===env_type_1.EnvType.LayerStash&&this._enterLayerStash(t.value.layerIndex,t.value.stashId),t.type===env_type_1.EnvType.StateMachine&&this._enterPoseNode(t.value,!1)}}this.reselect(),this.refresh()}resetViewData(){this._currentEnv=void 0}queryLayers(){this.animationGraph&&(this.queryData.layers=this.animationGraph.layers.map((e,t)=>{var n;return{index:t,name:e.name||env_type_1.EnvType.layer,props:{mask:{uuid:null===(n=e.mask)||void 0===n?void 0:n._uuid},weight:void 0===e.weight?1:e.weight,additive:e.additive},stashes:[...e.stashes()].reduce((t,[n,i])=>(t[n]={referenceCount:[...animationApi.visitStashReferences(e,n)].length},t),{})}}))}addLayer(e){if(!this.animationGraph)return;const t=this.animationGraph.addLayer();e&&(t.name=e),this.ensureEditorData(this.animationGraph),Metric("A100008"),this.crumbLayer(this.animationGraph.layers.length-1)}removeLayer(e){if(this.animationGraph&&!(e<0))if(this.animationGraph.removeLayer(e),e===this.layerIndex){const t=0===e?0:e-1;this.crumbLayer(t)}else this.refresh()}crumbLayer(e){this.animationGraph&&(this.resetViewData(),this.layerIndex=e,this.layer=this.animationGraph.layers[this.layerIndex],this.layer&&(this._currentEnv=new state_machine_env_1.StateMachineEnv(this.layer.stateMachine),this.crumbs=[{type:env_type_1.EnvType.layer,name:this.layer.name,value:e}],this.reselect(),this.refresh()))}renameLayer(e,t){if(!this.animationGraph)return;const n=this.animationGraph.layers[e];if(!n)return;n.name=t;const i=this.crumbs[0];i&&i.value===e&&(i.name=t),this.refresh()}async changeLayer(e,t,n){if(!this.animationGraph)return;const i=this.animationGraph.layers[e];if(i){if("mask"===t){const e=n;if(e){const t=await loadAssetUncached(e);i.mask=t}else i.mask=null}else"weight"===t?i.weight=n:"additive"===t&&(i.additive=n);this.reselect(),this.refresh()}}moveLayer(e,t){if(!this.animationGraph)return;this.animationGraph.layers[e]&&(this.animationGraph.moveLayer(e,t),this.reselect(),this.refresh())}queryStateMachine(e,t=Utils.hasSubStateMachineCrumb(this.crumbs)){const n=Array.from(e.states()),i=Array.from(e.transitions()),a=n.map((n,a)=>{const o=n.name,r=Utils.getStateType(n,e),s=Array.from(e.getOutgoings(n)).map(e=>i.findIndex(t=>t===e)),c=Array.from(e.getIncomings(n)).map(e=>i.findIndex(t=>t===e));n[cc_1.editorExtrasTag]?Utils.checkEditorData(n[cc_1.editorExtrasTag]):n[cc_1.editorExtrasTag]=Utils.getInitialEditorData();const h=n[cc_1.editorExtrasTag],p=void 0===h.centerX,l={index:a,name:o,type:r,outGoings:s,inComings:c,editorData:h};switch(r){case env_type_1.EnvType.entryState:p&&(l.editorData.centerX=-125,l.editorData.centerY=0);break;case env_type_1.EnvType.exitState:p&&(l.editorData.centerX=125,l.editorData.centerY=0);break;case env_type_1.EnvType.anyState:p&&(l.editorData.centerX=t?0:125,l.editorData.centerY=t?75:0);break;default:if(p&&(l.editorData.centerX=0,l.editorData.centerY=0),(n instanceof animationApi.MotionState||(0,interop_formal_1.isPoseExprState)(n))&&(l.eventBindings={transitionInEventBinding:n.transitionInEventBinding.methodName,transitionOutEventBinding:n.transitionOutEventBinding.methodName}),n instanceof animationApi.MotionState?l.props={speed:n.speed,speedMultiplier:n.speedMultiplier,speedMultiplierEnabled:n.speedMultiplierEnabled,motion:{type:Utils.getMotionType(n.motion),name:Utils.getMotionName(n.motion,n),level:Utils.getDefaultMotionLevel(),value:Utils.getMotionValue(n.motion),min:[],max:[]}}:n instanceof animationApi.SubStateMachine&&(l.stateMachine=this.queryStateMachine(n.stateMachine,!0)),n instanceof animationApi.MotionState||n instanceof animationApi.SubStateMachine){const e=this.getComponents(n);l.components=e.map((e,t)=>({name:e.constructor.name,index:t,value:scene_state_component_1.default.encode(e)}))}}return l}),o=i.map((t,i)=>{const a=[];for(const e of t.conditions)e instanceof animationApi.BinaryCondition&&a.push({type:env_type_1.EnvType.BinaryCondition,operator:e.operator,lhs:0,lhsBinding:dumpTCBinding(e.lhsBinding),rhs:e.rhs,isRhsInteger:e.lhsBinding.getValueType()===animationApi.TCBindingValueType.INTEGER}),e instanceof animationApi.UnaryCondition&&a.push({type:env_type_1.EnvType.UnaryCondition,operator:e.operator,operand:e.operand.variable}),e instanceof animationApi.TriggerCondition&&a.push({type:env_type_1.EnvType.TriggerCondition,trigger:e.trigger});const o=n.findIndex(e=>e===t.from),r=n.findIndex(e=>e===t.to),s={type:Utils.getTransitionType(t),index:i,priority:Array.from(e.getOutgoings(t.from)).findIndex(e=>e===t),from:{index:o,name:t.from.name,type:Utils.getStateType(t.from,e)},to:{index:r,name:t.to.name,type:Utils.getStateType(t.to,e)},removable:!0,duration:-1,relativeDuration:!1,exitConditionEnabled:void 0,exitCondition:0,destinationStart:void 0,relativeDestinationStart:!1,editorData:t[cc_1.editorExtrasTag]||{},conditions:a,eventBindings:void 0};return(animationApi.isAnimationTransition(t)||t instanceof animationApi.EmptyStateTransition||t instanceof animationApi.ProceduralPoseTransition)&&(s.destinationStart=t.destinationStart,s.relativeDestinationStart=t.relativeDestinationStart,s.eventBindings={startEventBinding:t.startEventBinding.methodName,endEventBinding:t.endEventBinding.methodName}),animationApi.isAnimationTransition(t)?(s.duration=t.duration,s.relativeDuration=t.relativeDuration,s.exitConditionEnabled=t.exitConditionEnabled,s.exitCondition=t.exitCondition):t instanceof animationApi.EmptyStateTransition?s.duration=t.duration:t instanceof animationApi.ProceduralPoseTransition&&(s.duration=t.duration),s}).sort((e,t)=>e.priority-t.priority);return{allowEmptyStates:e.allowEmptyStates,states:a,transitions:o,editorData:e[cc_1.editorExtrasTag]}}crumbStateMachine(e){const t=this._getIfIsStateMachineEnv();if(!t)return;this.resetViewData();const n=t.getState(e);n&&n instanceof animationApi.SubStateMachine&&(this._currentEnv=new state_machine_env_1.StateMachineEnv(n.stateMachine)),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.SubStateMachine,n.name,e),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh()}async addState(e){if(!this.animationGraph)return;const t=this._getIfIsStateMachineEnv();if(!t)return;e||(e={type:env_type_1.EnvType.MotionState,editorData:{centerX:0,centerY:0}});const n=t.getStates().length;let i;switch(e.type){case env_type_1.EnvType.SubStateMachine:(i=t.stateMachine.addSubStateMachine()).name=env_type_1.EnvType.subStateMachineName;break;case env_type_1.EnvType.EmptyState:(i=t.stateMachine.addEmpty()).name=env_type_1.EnvType.EmptyStateName;break;case env_type_1.EnvType.PoseExprState:(i=(0,interop_formal_1.addPoseExprState)(t.stateMachine,{poseGraphEditorData:{id:Utils.produceEditorDataId()},rootOutputNodeEditorData:{centerX:-51,centerY:-13.5}})).name="Pose";break;default:(i=await t.stateMachine.addMotion()).name=env_type_1.EnvType.stateName}const a=Utils.getInitialEditorData(e.editorData);if(i[cc_1.editorExtrasTag]=Object.assign(a,i[cc_1.editorExtrasTag]),e.type===env_type_1.EnvType.MotionState&&e.motion){switch(e.motion.type){case env_type_1.EnvType.AnimationBlend1D:case env_type_1.EnvType.AnimationBlend2D:e.motion.editorData={centerX:0,centerY:0}}this.addMotionToState(n,e.motion)}else this.ensureEditorData(this.animationGraph),this.viewState(n)}removeState(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);n&&(t.stateMachine.remove(n),this.crumbView())}crumbState(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);n instanceof animationApi.SubStateMachine?this.crumbStateMachine(e):n instanceof animationApi.MotionState?n.motion&&isAnimationBlend(n.motion)&&this.crumbMotion(e):(0,interop_formal_1.isPoseExprState)(n)&&this.crumbPoseExpr(e)}viewState(e){const t=this._getIfIsStateMachineEnv();t&&(t.stateIndex=e,t.state=t.getState(e),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.state,t.state.name,e),t.transition=null,t.transitionIndex=-1,this.reselect(),this.refresh())}moveState(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);i&&(t.editorData&&(i[cc_1.editorExtrasTag]=Object.assign(i[cc_1.editorExtrasTag]||{},t.editorData)),this.refresh())}renameState(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);i&&(i.name=t,i[cc_1.editorExtrasTag].name=t,Metric("A100012"),this.refresh())}changeState(e,t,n){const i=this._getIfIsStateMachineEnv();if(!i)return;const a=i.getState(e);if(a){switch(t){case"transitionInEventBinding":case"transitionOutEventBinding":return void((a instanceof animationApi.MotionState||(0,interop_formal_1.isPoseExprState)(a))&&(a[t].methodName=n,this.refresh()))}if(a[t]instanceof animationApi.BindableNumber)a[t].value=n;else if(a instanceof animationApi.MotionState)switch(t){case"speed":a.speed=Number(n);break;case"speedMultiplier":a.speedMultiplier=n.toString();break;case"speedMultiplierEnabled":a.speedMultiplierEnabled=!!n}else a[t]=n;this.refresh()}}copyState(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);if(!n)return;const i=Utils.getStateType(n,t.stateMachine);Utils.canNotCopyState(i)||(this.clipBoard={type:"state",state:n,stateMachine:t.stateMachine},this.refresh())}duplicateState(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);if(!n)return;const i=Utils.getStateType(n,t.stateMachine);if(Utils.canNotCopyState(i))return;if(!(n instanceof animationApi.MotionState||n instanceof animationApi.SubStateMachine||n instanceof animationApi.EmptyState||(0,interop_formal_1.isPoseExprState)(n)))return;const a=t.getStates().length,o=animationApi.cloneState(t.stateMachine,n,!0);let r=n.name;if(o instanceof animationApi.MotionState&&o.motion instanceof animationApi.ClipMotion&&(r=Utils.getValidName(o.name,t.stateMachine)),o){o.name=r;const e=o[cc_1.editorExtrasTag];e.centerX+=20,e.centerY+=20}this.viewState(a)}pasteState(e,t){var n;if(!this.animationGraph)return;const i=this._getIfIsStateMachineEnv();if(!i)return;if("state"!==this.clipBoard.type)return;const a=this.clipBoard.stateMachine,o=this.clipBoard.state;if(!o)return;if(!(o instanceof animationApi.MotionState||o instanceof animationApi.SubStateMachine||o instanceof animationApi.EmptyState||(0,interop_formal_1.isPoseExprState)(o)))return;let r;const s=i.getStates().length;let c=o.name;if(o instanceof animationApi.MotionState&&o.motion instanceof animationApi.ClipMotion&&(c=Utils.getValidName(o.name,i.stateMachine)),a===i.stateMachine){if(!t){const e=o[cc_1.editorExtrasTag];t={centerX:e.centerX+20,centerY:e.centerY+20}}r=animationApi.cloneState(a,o,e)}else a&&(t||(t={centerX:0,centerY:0}),r=animationApi.cloneState(a,o,i.stateMachine));r&&(r.name=c,Object.assign(null!==(n=r[cc_1.editorExtrasTag])&&void 0!==n?n:r[cc_1.editorExtrasTag]={},t)),this.ensureEditorData(this.animationGraph),this.viewState(s)}turnMotionStateIntoSubStateMachine(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);n&&n instanceof animationApi.MotionState&&(animationApi.turnMotionStateIntoSubStateMachine(t.stateMachine,n),this.refresh())}async addMotion(e){let t,n=null;switch(e.type){case env_type_1.EnvType.ClipMotion:if(n=new animationApi.ClipMotion,e.uuid){const t=await loadAssetUncached(e.uuid);n instanceof animationApi.ClipMotion&&(n.clip=t)}n[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData(),e.editorData),Metric("A100002");break;case env_type_1.EnvType.AnimationBlend1D:n=new animationApi.AnimationBlend1D,(t=this.getFirstNumberVariable())&&(n.param.variable=t[0]),n[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData({autoThreshold:!0}),e.editorData),Metric("A100003");break;case env_type_1.EnvType.AnimationBlend2D:n=new animationApi.AnimationBlend2D,(t=this.getFirstNumberVariable())&&(n.paramX.variable=t[0],n.paramY.variable=t[0]),n[cc_1.editorExtrasTag]=Object.assign(Utils.getInitialEditorData(),e.editorData),Metric("A100004")}return n}async addMotionToState(e,t){if(!this.animationGraph)return;const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);if(!(i&&i instanceof animationApi.MotionState))return;let a=env_type_1.EnvType.stateName;const o=await this.addMotion(t);switch(i.motion=o,t.type){case env_type_1.EnvType.ClipMotion:a=env_type_1.EnvType.clipMotionName,o&&(a=Utils.getMotionName(o,i)),a=Utils.getValidName(a,n.stateMachine);break;case env_type_1.EnvType.AnimationBlend1D:a=env_type_1.EnvType.animationBlend1DName;break;case env_type_1.EnvType.AnimationBlend2D:a=env_type_1.EnvType.animationBlend2DName}i.name=a,this.ensureEditorData(this.animationGraph),this.viewState(e)}async changeClipMotion(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);if(i){if(t){const e=await loadAssetUncached(t);i instanceof animationApi.MotionState&&i.motion instanceof animationApi.ClipMotion&&(i.motion.clip=e)}else i instanceof animationApi.MotionState&&i.motion instanceof animationApi.ClipMotion&&(i.motion.clip=null);this.reselect(),this.refresh()}}crumbMotion(e){const t=this._currentEnv;if(!t||!(t instanceof state_machine_env_1.StateMachineEnv||t instanceof motion_env_1.MotionEnv))return;let n=null;if(t instanceof state_machine_env_1.StateMachineEnv){const i=t.getState(e);if(!(i&&i instanceof animationApi.MotionState))return;if(!i.motion||i.motion instanceof animationApi.ClipMotion)return;(n=i.motion)&&isAnimationBlend(n)&&(n.name=i.name)}else if(isAnimationBlend(t.motion)){const i=[...t.motion.items];if(i.length){const t=i[e].motion;t&&(n=t)}}if(!n)return;const i=Utils.getDefaultMotionLevel();this._currentEnv=new motion_env_1.MotionEnv(n,i),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(n,null),i,!0),this.reselect(),this.refresh()}crumbMotionInMotion(e){const t=this._currentEnv;if(!(t&&t instanceof motion_env_1.MotionEnv))return;let n=t.motion;for(let t=1;t<e.length;t++){const i=e[t];if(isAnimationBlend(n)){const e=[...n.items];e[i]&&(n=e[i].motion)}if(!n)break;Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(n,null),i,!0)}t.motion!==n&&(this._currentEnv=new motion_env_1.MotionEnv(n,t.motionLevel),this.reselect(),this.refresh())}getMotionByLevel(e){const t=this._currentEnv;if(!(t&&t instanceof motion_env_1.MotionEnv))return;let n=t.motion;for(let t=1;t<e.length;t++){const i=e[t];if(n&&isAnimationBlend(n)){const e=[...n.items];if(e[i]){const t=e[i].motion;if(!t)return;n=t}}}return n}getFirstNumberVariable(){if(!this.animationGraph)return null;let e=this.variables.find(e=>0===e[1]._type);return e||this.animationGraph.addVariable(this.uniqueVariableName("Float Number"),animationApi.VariableType.FLOAT,0),e=this.variables.find(e=>0===e[1]._type)}removeMotion(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);n&&(n instanceof animationApi.MotionState&&(n.motion=null),this.reselect(),this.refresh())}getCurrentMotion(){const e=this._currentEnv;if(e&&(e instanceof state_machine_env_1.StateMachineEnv||e instanceof motion_env_1.MotionEnv))return e instanceof motion_env_1.MotionEnv?e.motionLevel.length?this.getMotionByLevel(e.motionLevel):void 0:e.state instanceof animationApi.MotionState?e.state.motion:null}viewMotion(e){const t=this._currentEnv;if(!(t&&t instanceof motion_env_1.MotionEnv))return;const n=this.getMotionByLevel(e);if(!n)return;const i=Utils.getMotionType(n);i&&(t.motionLevel.length=0,t.motionLevel.push(...e),Utils.changeCrumb(this.crumbs,i,Utils.getMotionName(n,null),e),this.reselect(),this.refresh())}moveMotion(e,t){const n=this.getMotionByLevel(e);n&&t.editorData&&(n[cc_1.editorExtrasTag]=Object.assign(n[cc_1.editorExtrasTag]||{},t.editorData)),this.refresh()}queryMotion(e,t,n,i){const a={type:Utils.getMotionType(t),name:Utils.getMotionName(t,null),level:e,value:Utils.getMotionValue(t),threshold:n,min:[],max:[]};if(n instanceof cc_1.Vec2&&(a.threshold={x:n.x,y:n.y}),t[cc_1.editorExtrasTag]?Utils.checkEditorData(t[cc_1.editorExtrasTag]):t[cc_1.editorExtrasTag]=Utils.getInitialEditorData({centerX:0,centerY:0}),t instanceof animationApi.ClipMotion&&(a.editorData=t[cc_1.editorExtrasTag]),t instanceof animationApi.AnimationBlend1D){a.editorData=t[cc_1.editorExtrasTag];const n=Array.from(t.items);if(Array.isArray(n)){a.children=[];const t=[];for(let i=0;i<n.length;i++){const o=n[i];if(o&&o.motion){const n=e.slice();n.push(i),t.push(o.threshold);const r=this.queryMotion(n,o.motion,o.threshold);a.children.push(r)}}t.length&&(a.min[0]=Math.min(...t),a.max[0]=Math.max(...t))}}if(t instanceof animationApi.AnimationBlend2D){a.props={algorithm:t.algorithm},a.editorData=t[cc_1.editorExtrasTag];const n=Array.from(t.items);if(Array.isArray(n)){a.children=[];const t=[],i=[];for(let o=0;o<n.length;o++){const r=n[o];if(r&&r.motion){const n=e.slice();n.push(o),t.push(r.threshold.x),i.push(r.threshold.y);const s=this.queryMotion(n,r.motion,r.threshold);a.children.push(s)}}t.length&&(a.min=[Math.min(...t),Math.min(...i)],a.max=[Math.max(...t),Math.max(...i)])}}if(i&&t&&isAnimationBlend(t)&&this.animationGraph){const e=getInvolvedBlendParamVariablesOfMotion(t);a.involvedBlendParamVariables={};for(const[t,{min:n,max:i}]of Object.entries(e)){let e=0,o=!1;const r=this.animationGraph.getVariable(t);(null===r||void 0===r?void 0:r.type)===animationApi.VariableType.FLOAT&&(e=r.value,o=!0),a.involvedBlendParamVariables[t]={value:e,valid:o,min:n,max:i}}}return a}async addMotionToMotion(e,t){if(!this.animationGraph)return;const n=this.getMotionByLevel(e);if(!n)return;const i=await this.addMotion(t);if(n instanceof animationApi.AnimationBlend1D){const t=new animationApi.AnimationBlend1D.Item;t.motion=i;const a=Array.from(n.items),o=a.length;if(0===o)t.threshold=DefaultValue.minThreshold;else if(1===o)t.threshold=DefaultValue.maxThreshold;else{const e=n[cc_1.editorExtrasTag],i=[];a.forEach(e=>{i.push(e.threshold)});const r=Math.min(...i),s=Math.max(...i),c=(s-r)/o;e&&!0===e.autoThreshold&&a.forEach((e,t)=>{e.threshold=r+c*t}),t.threshold=s}const r=Array.from(n.items);r.push(t),n.items=r,e.push(r.length-1)}else if(n instanceof animationApi.AnimationBlend2D){const t=Array.from(n.items),a=new animationApi.AnimationBlend2D.Item;a.motion=i,a.threshold=new cc_1.Vec2(0,0),t.push(a),n.items=t,e.push(t.length-1)}this.ensureEditorData(this.animationGraph),this.viewMotion(e)}renameMotionInMotion(e,t){const n=this.getMotionByLevel(e);n&&isAnimationBlend(n)&&(n.name=t,this.refresh())}removeMotionInMotion(e){const t=e.pop();if(void 0===t||!e.length)return;const n=this.getMotionByLevel(e);if(n)if(n instanceof animationApi.AnimationBlend1D){const e=Array.from(n.items);e.splice(t,1);const i=e.length;if(i>2){const t=n[cc_1.editorExtrasTag],a=[];e.forEach(e=>{a.push(e.threshold)});const o=Math.min(...a),r=(Math.max(...a)-o)/(i-1);t&&!0===t.autoThreshold&&e.forEach((e,t)=>{e.threshold=o+r*t})}n.items=e}else if(n instanceof animationApi.AnimationBlend2D){const e=Array.from(n.items);e.splice(t,1),n.items=e}this.refresh()}changeMotionAutoThreshold(e,t){const n=this.getMotionByLevel(e);n instanceof animationApi.AnimationBlend1D&&(n[cc_1.editorExtrasTag].autoThreshold=t,Metric("A100007"),this.refresh())}changeMotionThreshold1D(e,t,n){const i=this.getMotionByLevel(e);if(!(i instanceof animationApi.AnimationBlend1D))return;const a=Array.from(i.items),o=a[t];o&&(o.threshold=n,i.items=a,Metric("A100007"),this.refresh())}changeMotionThreshold2D(e,t,n){const i=this.getMotionByLevel(e);if(!(i instanceof animationApi.AnimationBlend2D))return;const a=Array.from(i.items)[t];if(a){for(const e in n)"x"!==e&&"y"!==e||(a.threshold[e]=n[e]);Metric("A100007"),this.refresh()}}changeMotionProp(e,t,n){const i=this.getMotionByLevel(e);if("algorithm"===t){if(!(i instanceof animationApi.AnimationBlend2D))return;const e=n;if(!(e in animationApi.AnimationBlend2D.Algorithm))return;i.algorithm=e}Metric("A100007"),this.refresh()}async changeClipMotionInMotion(e,t){const n=this.getMotionByLevel(e);if(n instanceof animationApi.ClipMotion){if(t){const e=await loadAssetUncached(t);n.clip=e}else n.clip=null;Metric("A100007"),this.refresh()}}changeAnimationBlend1DInMotion(e,t,n){const i=this.getMotionByLevel(e);i instanceof animationApi.AnimationBlend1D&&(t===env_type_1.EnvType.animationBlendVariable&&(i.param.variable=n),t===env_type_1.EnvType.animationBlendValue&&(i.param.value=n),Metric("A100007"),this.refresh())}changeAnimationBlend2DInMotion(e,t,n,i){const a=this.getMotionByLevel(e);if(!(a instanceof animationApi.AnimationBlend2D))return;const o=1===t?a.paramY:a.paramX;n===env_type_1.EnvType.animationBlendVariable&&(o.variable=i),n===env_type_1.EnvType.animationBlendValue&&(o.value=i),Metric("A100007"),this.refresh()}updateMotionEditData(e,t){if(this._currentEnv instanceof motion_env_1.MotionEnv){if(isAnimationBlend(this._currentEnv.motion)){let n=this._currentEnv.motion[cc_1.editorExtrasTag];n||(n=this._currentEnv.motion[cc_1.editorExtrasTag]={}),"threshold"===e&&(n[e]=t)}this.refresh()}}getComponents(e){return(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine)&&e.components?Array.from(e.components):[]}getComponent(e,t=null){return!t&&this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&(t=this._currentEnv.state),this.getComponents(t)[e]||null}addComponent(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);if(i instanceof animationApi.MotionState||i instanceof animationApi.SubStateMachine){const e=cc_1.js.getClassByName(t.name);e&&i.addComponent(e),this.refresh()}}removeComponent(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getState(e);if(i instanceof animationApi.MotionState||i instanceof animationApi.SubStateMachine){const e=this.getComponent(t,i);i.removeComponent(e)}this.refresh()}async changeComponent(e,t,n){const i=this._getIfIsStateMachineEnv();if(!i)return;const a=i.getState(e);if(a instanceof animationApi.MotionState||a instanceof animationApi.SubStateMachine){const e=this.getComponent(t,a);await scene_state_component_1.default.change(e,n)}this.refresh()}getTransitions(){const e=this._getIfIsStateMachineEnv();return e?Array.from(e.stateMachine.transitions()):[]}getTransition(e){return this.getTransitions()[e]||null}addTransition(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=n.getStates(),a=i[e],o=i[t];if(o===n.stateMachine.anyState)return console.warn(Editor.I18n.t("animation-graph.transition.toAnyIsInvalid")),null;const r=this.getTransitions().length;return n.stateMachine.connect(a,o),Metric("A100005"),this.viewTransition(r),this.getTransition(r)}removeTransition(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=this.getTransition(e);if(!i)return;t?n.stateMachine.disconnect(i.from,i.to):n.stateMachine.removeTransition(i);const a=this.getTransitions();for(let e=0;e<a.length;e++)if(a[e].from===i.from&&a[e].to===i.to)return void this.viewTransition(e);this.crumbView()}viewTransition(e){const t=this._getIfIsStateMachineEnv();t&&(t.transition=this.getTransition(e),t.transitionIndex=e,Utils.changeCrumb(this.crumbs,env_type_1.EnvType.transition,Utils.getTransitionName(t.transition),e),t.stateIndex=-1,t.state=null,this.reselect(),this.refresh())}changeTransitionProp(e,t,n){const i=this.getTransition(e);i&&("relativeDuration"===t&&animationApi.isAnimationTransition(i)?i.relativeDuration=!i.relativeDuration:"relativeDestinationStart"===t&&animationApi.isAnimationTransition(i)?i.relativeDestinationStart=!i.relativeDestinationStart:"startEventBinding"===t||"endEventBinding"===t?(animationApi.isAnimationTransition(i)||i instanceof animationApi.EmptyStateTransition||i instanceof animationApi.ProceduralPoseTransition)&&(i[t].methodName=n):i[t]=n,Metric("A100006"),this.refresh())}adjustTransitionPriority(e,t){const n=this._getIfIsStateMachineEnv();if(!n)return;const i=this.getTransition(e);n.stateMachine&&i&&(n.stateMachine.adjustTransitionPriority(i,t),this.refresh())}addCondition(e,t){const n=`add${t.type}`;n in this&&this[n](e,t),this.refresh()}addBinaryCondition(e,t){const n=this.getTransition(e);if(!n)return;n.conditions.length;const i=new animationApi.BinaryCondition;n.conditions.push(i),t&&i&&(i[cc_1.editorExtrasTag]=Object.assign(i[cc_1.editorExtrasTag]||{},t))}addUnaryCondition(e,t){const n=this.getTransition(e);if(!n)return;const i=n.conditions.length,a=new animationApi.UnaryCondition;n.conditions.push(a),t&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},t),this.changeUnaryCondition(e,i,t))}addTriggerCondition(e,t){const n=this.getTransition(e);if(!n)return;const i=n.conditions.length,a=new animationApi.TriggerCondition;n.conditions.push(a),t&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},t),this.changeTriggerCondition(e,i,t))}getCondition(e,t){const n=this.getTransition(e);return n&&n.conditions[t]||null}removeCondition(e,t){const n=this.getTransition(e);n&&(n.conditions.splice(t,1),this.refresh())}changeConditionProps(e,t,n,i){const a=this.getCondition(e,t);if(a){for(let e=a,t=0;t<n.length;++t){if("object"!=typeof e||!e)return;const a=n[t];if(!(a in e))return;t===n.length-1?e[a]=i:e=e[a]}this.refresh()}}changeConditionBindingProps(e,t,n,i){const a=this.getCondition(e,t);if(a&&n in a){for(const[e,t]of i)for(let i=a[n],o=0;o<e.length;++o){if("object"!=typeof i||!i)return;const n=e[o];if(!(n in i))return;o===e.length-1?i[n]=t:i=i[n]}this.refresh()}}changeConditionBindingType(e,t,n,i){const a=this.getCondition(e,t);if(!a)return;if(!(n in a))return;const o=cc_1.js.getClassById(i);if(!o)return void console.warn(`绑定类型 ${i} 不存在！`);const r=new o;a[n]=r,this.refresh()}changeUnaryCondition(e,t,n){const i=this.getCondition(e,t);i&&n&&i instanceof animationApi.UnaryCondition&&(n.lhs&&n.lhs.type===env_type_1.EnvType.conditionVariable&&(i.operand.variable=n.lhs.value.variable),void 0!==n.operator&&(i.operator=n.operator-0))}changeTriggerCondition(e,t,n){const i=this.getCondition(e,t);i&&n&&i instanceof animationApi.TriggerCondition&&n.lhs&&n.lhs.type===env_type_1.EnvType.conditionVariable&&(i.trigger=n.lhs.value.variable)}queryVariables(){if(this.animationGraph){this.queryData.variables={};for(const[e,t]of this.variables){const n=(0,variable_value_dump_1.dumpVariableValue)(t);this.queryData.variables[e]={type:animationApi.VariableType[t.type],value:n},t.type===animationApi.VariableType.TRIGGER&&(this.queryData.variables[e].resetMode=t.resetMode)}}}addVariable(e,t){if(!this.animationGraph)return;e=this.uniqueVariableName(e);const n=parseInt(t);return n in animationApi.VariableType&&this.animationGraph.addVariable(e,n),Metric("A100009"),this.refresh(),e}renameVariable(e,t){if(this.animationGraph){this.animationGraph.renameVariable(e,t);for(const n of animationApi.viewVariableBindings(this.animationGraph))n.name===e&&n.rebind(t);Metric("A100013"),this.refresh()}}async changeVariable(e,t){if(!this.animationGraph)return;const n=this.animationGraph.getVariable(e);n&&(await(0,variable_value_dump_1.applyVariableValueDumpPatch)(n,t),this.refresh())}changeTriggerResetMode(e,t){if(!this.animationGraph)return;const n=this.animationGraph.getVariable(e);n&&n.type===animationApi.VariableType.TRIGGER&&(n.resetMode=t?animationApi.TriggerResetMode.NEXT_FRAME_OR_AFTER_CONSUMED:animationApi.TriggerResetMode.AFTER_CONSUMED,this.refresh())}async removeVariable(e){if(this.animationGraph){if(this.checkVariableIsUsed(this.animationGraph,e)){if(0!==(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.variable.removeUsedTip",{variableName:e}),{buttons:[Editor.I18n.t("animation-graph.ok"),Editor.I18n.t("animation-graph.cancel")],default:1,cancel:1})).response)return}this.animationGraph.removeVariable(e),this.refresh()}}uniqueVariableName(e){const t=[];for(const e of this.variables)t.push(e[0]);for(;e&&t.includes(e);)/(\d+)$/.test(e)?e=e.replace(/(\d+)$/,(e,t)=>{let n=parseInt(t,10);return(n+=1).toString()}):e+="1";return e}checkVariableIsUsed(e,t){for(const n of animationApi.viewVariableBindings(e))if(n.name===t)return!0;return!1}queryPreviewMotion(){return this._currentEnv instanceof motion_env_1.MotionEnv?this._currentEnv.motion:this._currentEnv instanceof state_machine_env_1.StateMachineEnv&&this._currentEnv.state instanceof animationApi.MotionState?this._currentEnv.state.motion:void 0}async setPreviewModel(e){this.userDefinedPreviewModelUuid[this.assetUuid]=e,await Editor.Profile.setTemp("animation-graph","preview-model",this.userDefinedPreviewModelUuid)}async queryPreviewModel(){if(this.userDefinedPreviewModelUuid[this.assetUuid])return this.userDefinedPreviewModelUuid[this.assetUuid];const{animationGraph:e}=this;if(!e)return"";for(const t of iterateAllAnimationClips(e)){const e=await queryPreviewModelOfAnimationClip(t);if(e)return e}return""}queryBlend2DThresholdsWeights(e,t){const n=new Array(e.length).fill(0);return animationApi.blendSimpleDirectional(n,e,t),n}crumbPoseExpr(e){const t=this._getIfIsStateMachineEnv();if(!t)return;const n=t.getState(e);(0,interop_formal_1.isPoseExprState)(n)&&(this.editPoseGraph(n),Utils.changeCrumb(this.crumbs,env_type_1.EnvType.PoseExprState,n.name,e),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh())}addPoseNode(e){const t=this._getIfIsPoseGraphEnv();t&&(t.poseGraphInterop.addNode(e.key,e.editorData),this.reselect(),this.refresh())}removePoseNode(e){const t=this._getIfIsPoseGraphEnv();t&&(t.poseGraphInterop.removeNode(e),this.crumbView())}movePoseNode(e,t){const n=this._getIfIsPoseGraphEnv();n&&(n.poseGraphInterop.updateNodeEditorData(e,t),this.refresh())}crumbPoseNode(e){this._enterPoseNode(e,!0),this.reselect(),this.refresh()}_enterPoseNode(e,t){const n=this._getIfIsPoseGraphEnv();if(!n)return;const i=n.poseGraphInterop.getNodeEnterInfo(e);if(i)if(i.type===env_type_1.EnvType.PoseExprAnimationBlend)this._currentEnv=new motion_env_1.MotionEnv(i.target,Utils.getDefaultMotionLevel()),t&&(Utils.changeCrumb(this.crumbs,env_type_1.EnvType.MotionState,Utils.getMotionName(this._currentEnv.motion,null),this._currentEnv.motionLevel),Utils.changeCrumb(this.crumbs,"","",null,!0));else if(i.type===env_type_1.EnvType.StateMachine)this._currentEnv=new state_machine_env_1.StateMachineEnv(i.target),t&&(Utils.changeCrumb(this.crumbs,env_type_1.EnvType.StateMachine,n.poseGraphInterop.getNodeName(e)||env_type_1.EnvType.StateMachine,e),Utils.changeCrumb(this.crumbs,"","",null,!0));else if(i.type===env_type_1.EnvType.LayerStash)return void(t?this.editLayerStash(i.target.layerIndex,i.target.stashName,!0):this._enterLayerStash(i.target.layerIndex,i.target.stashName,!0))}copyPoseNode(e){const t=this._getIfIsPoseGraphEnv();if(!t)return;const n=t.poseGraphInterop.copyNodes([e]);n&&(this.clipBoard={type:"pose-nodes",copyPoseNodes:n},this.refresh())}async duplicatePoseNode(e){const t=this._getIfIsPoseGraphEnv();if(!t)return;const n=t.poseGraphInterop.copyNodes([e]);if(!n)return;const i=await t.poseGraphInterop.pasteNodes(n);for(let e=0;e<i.length;e++){const n=i[e],a=t.poseGraphInterop.getNodeEditorData(n);a&&(a.centerX+=20,a.centerY+=20),a&&t.poseGraphInterop.updateNodeEditorData(n,a)}this.viewPoseNode(i[0])}copyCurrentStateMachine(){const e=this._getIfIsStateMachineEnv();e&&(this.clipBoard={type:"state-machine",stateMachine:(0,cc_1.instantiate)(e.stateMachine)},this.refresh())}async pasteIntoPoseGraph(e){const t=this._getIfIsPoseGraphEnv();if(t)switch(this.clipBoard.type){default:return;case"pose-nodes":{const n=await t.poseGraphInterop.pasteNodes(this.clipBoard.copyPoseNodes);return void this._onAfterPasteNodes(n,e)}case"state-machine":{const n=await t.poseGraphInterop.pasteStateMachine(this.clipBoard.stateMachine);return void this._onAfterPasteNodes(n,e)}}}_onAfterPasteNodes(e,t){const n=this._getIfIsPoseGraphEnv();if(n){for(let i=0;i<e.length;i++){const a=e[i];t||(t=n.poseGraphInterop.getNodeEditorData(a))&&(t.centerX+=20,t.centerY+=20),t&&n.poseGraphInterop.updateNodeEditorData(a,t)}this.viewPoseNode(e[0])}}addPoseNodeInput(e,t){const n=this._getIfIsPoseGraphEnv();n&&(n.poseGraphInterop.insertInput(e,t),this.refresh())}async updatePoseNodeInput(e,t,n){const i=this._getIfIsPoseGraphEnv();i&&(await i.poseGraphInterop.updateNodeInputValue(e,t,n),this.refresh())}async updatePoseNodeData(e,t,n){const i=this._getIfIsPoseGraphEnv();i&&(await i.poseGraphInterop.updateNodeDump(e,t,n),this.refresh())}async handleDropAssetIntoPoseGraph(e,t,n){const i=this._getIfIsPoseGraphEnv();if(!i)return;const a=await loadAssetUncached(e);i.poseGraphInterop.handleDropAssetIntoPoseGraph(a,{x:t.centerX,y:t.centerY},n)&&this.refresh()}addPoseLink(e,t,n,i){const a=this._getIfIsPoseGraphEnv();a&&(a.poseGraphInterop.addLink(e,t,n,i),this.reselect(),this.refresh())}removePoseLink(e,t,n,i){const a=this._getIfIsPoseGraphEnv();a&&(a.poseGraphInterop.removeLink(e,t,n,i),this.reselect(),this.refresh())}toggleCollapsePoseNode(e,t){const n=this._getIfIsPoseGraphEnv();n&&(n.poseGraphInterop.updateNodeEditorData(e,{collapse:t}),this.refresh())}viewPoseNode(e){var t;const n=this._getIfIsPoseGraphEnv();n&&(n.poseExprNodeId=e,Utils.changeCrumb(this.crumbs,env_type_1.EnvType.PoseExprNode,null!==(t=n.poseGraphInterop.getNodeName(e))&&void 0!==t?t:"<Unnamed pose node>",n.poseExprNodeId),this.reselect(),this.refresh())}addLayerStash(e){if(!this.animationGraph)return;if(e<0||e>=this.animationGraph.layers.length)return void console.error("Layer index out of bounds.");const t=this.animationGraph.layers[e],n=[...t.stashes()].map(([e])=>e);let i="NewStash";for(let e=0;n.includes(i);++e)i=`NewStash_${e}`;const a=t.addStash(i);a.graph[cc_1.editorExtrasTag]={id:Utils.produceEditorDataId()},a.graph.outputNode[cc_1.editorExtrasTag]={centerX:-51,centerY:-13.5},this.refresh()}removeLayerStash(e,t){if(!this.animationGraph)return;if(e<0||e>=this.animationGraph.layers.length)return void console.error("Layer index out of bounds.");this.animationGraph.layers[e].removeStash(t),this.refresh()}renameLayerStash(e,t,n){if(!this.animationGraph)return;if(e<0||e>=this.animationGraph.layers.length)return void console.error("Layer index out of bounds.");const i=this.animationGraph.layers[e];i.renameStash(t,n);for(const e of animationApi.visitStashReferences(i,t))e.alterReference(n);this.refresh()}editLayerStash(e,t,n){if(!this.animationGraph)return;this._enterLayerStash(e,t,n)&&(this.crumbs=[{type:env_type_1.EnvType.layer,name:this.animationGraph.layers[e].name,value:e}],Utils.changeCrumb(this.crumbs,env_type_1.EnvType.LayerStash,`${t}`,{layerIndex:e,stashId:t}),Utils.changeCrumb(this.crumbs,"","",null,!0),this.reselect(),this.refresh())}stashCurrentPoseGraph(e){var t;const n=this._getIfIsPoseGraphEnv();if(!n)return;const i=null===(t=this.animationGraph)||void 0===t?void 0:t.layers[this.layerIndex];if(!i)return;const a=[...i.stashes()].map(([e])=>e);let o="",r=0;do{o=`Stash${++r}`}while(a.includes(o));n.poseGraphInterop.stash(i,o,e),this.refresh()}_enterLayerStash(e,t,n){if(!this.animationGraph)return!1;if(e<0||e>=this.animationGraph.layers.length)return n||console.error("Layer index out of bounds."),!1;const i=[...this.animationGraph.layers[e].stashes()].find(([e])=>e===t);if(!i)return n||console.error("Layer stash does not exist."),!1;const[a,o]=i;return this.editPoseGraph(o),this.reselect(),this.refresh(),!0}editPoseGraph(e){if(!this.animationGraph)return;const t=new interop_formal_1.PoseExprGraphInterop(this.animationGraph,e,{layerIndex:this.layerIndex});this._currentEnv=new pose_graph_env_1.PoseGraphEnv(t)}_getIfIsStateMachineEnv(){return this._currentEnv&&this._currentEnv instanceof state_machine_env_1.StateMachineEnv?this._currentEnv:void 0}_getIfIsMotionEnv(){return this._currentEnv&&this._currentEnv instanceof motion_env_1.MotionEnv?this._currentEnv:void 0}_getIfIsPoseGraphEnv(){return this._currentEnv&&this._currentEnv instanceof pose_graph_env_1.PoseGraphEnv?this._currentEnv:void 0}}async function queryPreviewModelOfAnimationClip(e){const{_uuid:t}=e;if(!t)return"";let n="";const i=t.split("@");if(Array.isArray(i)&&(n=i[0]),!n)return"";const a=await Editor.Message.request("asset-db","query-asset-info",n);if(!a)return"";let o=!1,r="";for(const[e,t]of Object.entries(a.subAssets))if(t.type){const n=cc_1.js.getClassByName(t.type);if(!o&&cc_1.js.isChildClassOf(n,cc_1.Mesh)&&(o=!0),!r&&cc_1.js.isChildClassOf(n,cc_1.Prefab)&&(r=e),o&&r)break}return o&&r?a.subAssets[r].uuid:""}function*iterateAllAnimationClips(e){function*t(e){if(e instanceof animationApi.ClipMotion)e.clip&&(yield e.clip);else if(isAnimationBlend(e))for(const{motion:n}of e.items)n&&(yield*t(n))}function*n(e){for(const i of e.states())i instanceof animationApi.MotionState?i.motion&&(yield*t(i.motion)):i instanceof animationApi.SubStateMachine&&(yield*n(i.stateMachine))}for(const t of e.layers)yield*n(t.stateMachine)}function Metric(e,t){e&&Editor.Metrics._trackEventWithTimer({category:"animationStateMachine",id:e,value:1})}function isAnimationBlend(e){return e instanceof animationApi.AnimationBlend1D||e instanceof animationApi.AnimationBlend2D}async function loadAsset(e){return new Promise((t,n)=>{cc_1.assetManager.loadAny(e,(e,i)=>{e?n(e):t(i)})})}async function loadAssetUncached(e){return cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),await loadAsset(e)}function getInvolvedBlendParamVariablesOfMotion(e){const t={},n=(e,n,i)=>{e&&(e in t?(t[e].min=Math.min(t[e].min,n),t[e].max=Math.max(t[e].max,i)):t[e]={min:n,max:i})},i=e=>{if(e instanceof animationApi.AnimationBlend1D){const t=[...e.items].map(e=>e.threshold);n(e.param.variable,Math.min(...t),Math.max(...t))}else if(e instanceof animationApi.AnimationBlend2D){const t=[...e.items].map(e=>e.threshold.x),i=[...e.items].map(e=>e.threshold.y);n(e.paramX.variable,Math.min(...t),Math.max(...t)),n(e.paramY.variable,Math.min(...i),Math.max(...i))}else if(e instanceof animationApi.AnimationBlendDirect)for(const t of e.items)n(t.weight.variable,0,1);if(isAnimationBlend(e))for(const t of e.items)t.motion&&i(t.motion)};return i(e),t}function getTCBindingTypeInfos(){var e,t;const n=[];for(const[i,a]of Object.entries(cc_1.js._idToClass))if(cc_1.js.isChildClassOf(a,animationApi.TCBinding)){const o=animationApi.getTCBindingTypeInfo(a);n.push({id:i,menu:null!==(e=null===o||void 0===o?void 0:o.menu)&&void 0!==e?e:i,provisions:null!==(t=null===o||void 0===o?void 0:o.provisions)&&void 0!==t?t:[],transitionSourceFilter:(null===o||void 0===o?void 0:o.transitionSourceFilter)?parseEngineTCBindingTransitionSourceFilter(o.transitionSourceFilter):void 0})}return n}function parseEngineTCBindingTransitionSourceFilter(e){const t=[];return e&animationApi.TCBindingTransitionSourceFilter.MOTION&&t.push(env_type_1.EnvType.MotionState),e&animationApi.TCBindingTransitionSourceFilter.POSE&&t.push(env_type_1.EnvType.PoseExprState),e&animationApi.TCBindingTransitionSourceFilter.EMPTY&&t.push(env_type_1.EnvType.EmptyState),t}__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"reset",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"query",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"apply",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbView",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveLayer",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"duplicateState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"pasteState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"turnMotionStateIntoSubStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addMotionToState",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeClipMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbMotionInMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"moveMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addMotionToMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameMotionInMotion",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updateMotionEditData",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeComponent",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"adjustTransitionPriority",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addCondition",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeCondition",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionProps",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionBindingProps",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeConditionBindingType",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"changeTriggerResetMode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeVariable",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"queryBlend2DThresholdsWeights",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbPoseExpr",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"movePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"crumbPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyPoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"duplicatePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"copyCurrentStateMachine",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"pasteIntoPoseGraph",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseNodeInput",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updatePoseNodeInput",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"updatePoseNodeData",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"handleDropAssetIntoPoseGraph",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addPoseLink",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removePoseLink",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"toggleCollapsePoseNode",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"addLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"removeLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"renameLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"editLayerStash",null),__decorate([(0,make_life_easier_utils_1.bindIPC)()],SceneAnimationGraph.prototype,"stashCurrentPoseGraph",null),exports.default=new SceneAnimationGraph;const dumpTCBinding=e=>{const t=cc_1.js.getClassId(e.constructor);if(!t)throw new Error(`${e.constructor.name} 不是一个有效的 cc 类，无法 dump。`);const n=e.constructor.__props__;if(!Array.isArray(n)||!n.every(e=>"string"==typeof e))throw new Error(`${e.constructor.name} 不是一个有效的 cc 类，无法 dump。`);const i={__type__:t};for(const t of n)i[t]=e[t];return i};