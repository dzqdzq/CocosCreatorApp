"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,i,e,n){void 0===n&&(n=e),Object.defineProperty(t,n,{enumerable:!0,get:function(){return i[e]}})}:function(t,i,e,n){void 0===n&&(n=e),t[n]=i[e]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,i){Object.defineProperty(t,"default",{enumerable:!0,value:i})}:function(t,i){t.default=i}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var i={};if(null!=t)for(var e in t)"default"!==e&&Object.prototype.hasOwnProperty.call(t,e)&&__createBinding(i,t,e);return __setModuleDefault(i,t),i},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),scene_state_component_1=__importDefault(require("./scene-state-component")),animationApi=__importStar(require("cc/editor/new-gen-anim")),EnvType={layer:"Layer",state:"State",transition:"Transition",conditionVariable:"variable",conditionConstant:"constant",stateName:"State",subStateMachineName:"State Machine",clipMotionName:"Clip Motion",animationBlend1DName:"Blend 1D",animationBlend2DName:"Blend 2D",animationBlendVariable:"variable",animationBlendValue:"value",entryState:"entryState",anyState:"anyState",exitState:"exitState",MotionState:"MotionState",SubStateMachine:"SubStateMachine",Transition:"Transition",AnimationTransition:"AnimationTransition",ClipMotion:"ClipMotion",AnimationBlend1D:"AnimationBlend1D",AnimationBlend2D:"AnimationBlend2D",BinaryCondition:"BinaryCondition",UnaryCondition:"UnaryCondition",TriggerCondition:"TriggerCondition"},binaryConditionOperatorI18n={EQUAL_TO:"=",NOT_EQUAL_TO:"≠",LESS_THAN:"<",LESS_THAN_OR_EQUAL_TO:"≤",GREATER_THAN:">",GREATER_THAN_OR_EQUAL_TO:"≥"},unaryConditionOperatorI18n={TRUTHY:"true",FALSY:"false"},Utils={produceEditorDataId:()=>Date.now()+Math.random().toString(),checkEditorDataId(t){t&&!t.id&&(t.id=Utils.produceEditorDataId())},getStateType(t,i){switch(t){case i.entryState:return EnvType.entryState;case i.anyState:return EnvType.anyState;case i.exitState:return EnvType.exitState;default:if(t instanceof animationApi.MotionState)return EnvType.MotionState;if(t instanceof animationApi.SubStateMachine)return EnvType.SubStateMachine}return""},getMotionType(t){let i="";return t instanceof animationApi.ClipMotion?i=EnvType.ClipMotion:t instanceof animationApi.AnimationBlend1D?i=EnvType.AnimationBlend1D:t instanceof animationApi.AnimationBlend2D&&(i=EnvType.AnimationBlend2D),i},getMotionValue(t){let i=null;return t instanceof animationApi.ClipMotion&&(i={uuid:t.clip?t.clip._uuid:""}),t instanceof animationApi.AnimationBlend1D&&(i={variable:t.param.variable,value:t.param.value}),t instanceof animationApi.AnimationBlend2D&&(i=[{variable:t.paramX.variable,value:t.paramX.value},{variable:t.paramY.variable,value:t.paramY.value}]),i},getMotionName(t){let i="";return t instanceof animationApi.ClipMotion?i=t.clip?t.clip.name:EnvType.clipMotionName:t instanceof animationApi.AnimationBlend1D?i=t.name||EnvType.animationBlend1DName:t instanceof animationApi.AnimationBlend2D&&(i=t.name||EnvType.animationBlend2DName),i},getDefaultEditorData:(t={})=>Object.assign({id:Utils.produceEditorDataId(),centerX:0,centerY:0},t),getDefaultCrumbData:()=>({type:"",value:0,name:""}),getDefaultMotionLevel:()=>[0],getLastCrumb(t,i){let e=t[t.length-1];return(i||e.type===EnvType.layer||e.type===EnvType.SubStateMachine||"motionBlend"===e.type)&&(e=Utils.getDefaultCrumbData(),t.push(e)),e},getTransitionType(t){let i="";return i=t?animationApi.isAnimationTransition(t)?EnvType.AnimationTransition:EnvType.Transition:""},getTransitionName(t){let i="";return i=t?`${t.from.name} , ${t.to.name}`:""},hasSubStateMachineCrumb(t){for(const i of t)if(i.type===EnvType.SubStateMachine)return!0;return!1}},DefaultValue={minThreshold:0,maxThreshold:1};class SceneAnimationGraph{constructor(){this.assetUuid="",this.animationGraph=null,this.crumbs=[],this.layerIndex=-1,this.layer=null,this.stateMachine=null,this.stateIndex=-1,this.state=null,this.motion=null,this.motionLevel=[],this.transitionIndex=-1,this.transition=null,this.dirtyData={origin:"",realtime:"",isDirty(){return this.origin!==this.realtime}},this.queryDataTemplate={assetInfo:null,isDirty:!1,envType:EnvType,view:{stateMachine:{states:[],transitions:[]},crumbs:[],layerIndex:-1,stateIndex:-1,transitionIndex:-1,motion:void 0,motionLevel:[]},layers:[],variables:{},variableType:animationApi.VariableType,conditionVariableType:[EnvType.conditionVariable,EnvType.conditionConstant],unaryConditionOperator:animationApi.UnaryCondition.Operator,binaryConditionOperator:animationApi.BinaryCondition.Operator,binaryConditionOperatorI18n:binaryConditionOperatorI18n,unaryConditionOperatorI18n:unaryConditionOperatorI18n,cannotAddMotionStateType:[EnvType.entryState,EnvType.anyState,EnvType.exitState,EnvType.SubStateMachine],cannotRemoveStateType:[EnvType.entryState,EnvType.anyState,EnvType.exitState],motionType:[EnvType.ClipMotion,EnvType.AnimationBlend1D,EnvType.AnimationBlend2D],animationBlendType:[EnvType.AnimationBlend1D,EnvType.AnimationBlend2D]},this.resetData()}get variables(){return this.animationGraph?Array.from(this.animationGraph.variables):[]}async init(t){if(t)try{if(this.resetData(),this.assetUuid=t,this.queryData.assetInfo=await Editor.Message.request("asset-db","query-asset-info",t),!this.queryData.assetInfo)return;cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(t)),await new Promise((i,e)=>{cc_1.assetManager.loadAny(t,(t,n)=>{t?e(t):(this.animationGraph=n,this.crumbLayer(0),i())})})}catch(t){console.error(t)}}async dialog(){return await Editor.Message.request("animation-graph","dialog-warn")}async edit(t){if(t!==this.assetUuid){if(this.dirtyData.isDirty()){const t=await this.dialog();if(0===t)this.apply();else if(2===t)return}this.init(t)}}async reset(){if(this.assetUuid){if(await Editor.Message.request("asset-db","query-asset-info",this.assetUuid))this.init(this.assetUuid);else{let t=Editor.I18n.t("animation-graph.resetError");t=t.replace("${uuid}",this.assetUuid),console.error(t)}}else this.resetData(),this.refresh()}resetData(){this.assetUuid="",this.animationGraph=null,this.layer=null,this.stateMachine=null,this.state=null,this.motion=null,this.transition=null,this.queryData=JSON.parse(JSON.stringify(this.queryDataTemplate)),this.dirtyData.origin=this.dirtyData.realtime="",this.resetViewData()}viewport(t){if(this.motion){if(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D){const i=this.motion[cc_1.editorExtrasTag];i?i.viewport?Object.assign(i.viewport,t):i.viewport=t:this.motion[cc_1.editorExtrasTag]={viewport:t}}}else if(this.stateMachine){const i=this.stateMachine[cc_1.editorExtrasTag];i?i.viewport?Object.assign(i.viewport,t):i.viewport=t:this.stateMachine[cc_1.editorExtrasTag]={viewport:t}}}query(){return this.queryLayers(),this.queryVariables(),this.queryView(),this.queryData}async apply(){if(!this.animationGraph)return;const t=cce.Utils.serialize(this.animationGraph);if(!this.queryData.assetInfo)return;const{uuid:i,url:e}=this.queryData.assetInfo,n=await Editor.Message.request("asset-db","query-asset-info",i);if(n)await cce.Ipc.send("save-asset",n.uuid,t);else{const i=await Editor.Message.request("asset-db","create-asset",e,t);i&&(this.assetUuid=i.uuid,this.queryData.assetInfo=i)}this.dirtyData.origin="",this.refresh()}refresh(){this.dirtyData.realtime=cce.Utils.serialize(this.animationGraph),this.dirtyData.origin||(this.dirtyData.origin=this.dirtyData.realtime),this.queryData.isDirty=this.dirtyData.isDirty(),Editor.Message.send("animation-graph","refresh")}queryView(){this.queryData.view.crumbs=this.crumbs,this.queryData.view.layerIndex=this.layerIndex,this.queryData.view.stateIndex=this.stateIndex,this.queryData.view.motionLevel=this.motionLevel,this.queryData.view.transitionIndex=this.transitionIndex,this.queryData.view.stateMachine=void 0,this.queryData.view.motion=void 0,this.stateMachine&&(this.queryData.view.stateMachine=this.queryStateMachine(this.stateMachine)),this.motion&&(this.queryData.view.motion=this.queryMotion(Utils.getDefaultMotionLevel(),this.motion))}changeView(t,i,e){switch(t){case EnvType.layer:this.crumbLayer(i);break;case EnvType.entryState:case EnvType.anyState:case EnvType.exitState:case EnvType.MotionState:case EnvType.SubStateMachine:this.viewState(i);break;case EnvType.Transition:case EnvType.AnimationTransition:this.viewTransition(i);break;case EnvType.ClipMotion:case EnvType.AnimationBlend1D:case EnvType.AnimationBlend2D:this.viewMotion(e);break;default:this.crumbView()}}crumbView(t){let i,e;if(void 0!==t)this.crumbs.splice(t+1),i=this.crumbs.length-1,e=this.crumbs[i];else{i=this.crumbs.length-1,e=this.crumbs[i];const t=[EnvType.layer,EnvType.SubStateMachine,EnvType.MotionState];for(;e&&!t.includes(e.type);)i--,e=this.crumbs[i],this.crumbs.pop()}if(this.resetViewData(),this.layer){this.stateMachine=this.layer.stateMachine;for(let t=1;t<this.crumbs.length;t++){const i=this.crumbs[t];if(i.type===EnvType.SubStateMachine){const t=Array.from(this.stateMachine.states());this.stateIndex=i.value,this.state=t[this.stateIndex],this.stateMachine=this.state.stateMachine}if(i.type===EnvType.state){const t=Array.from(this.stateMachine.states());this.stateIndex=i.value,this.state=t[this.stateIndex]}if(i.type===EnvType.transition){const t=Array.from(this.stateMachine.transitions());this.transitionIndex=i.value,this.transition=t[this.transitionIndex]}if(i.type===EnvType.MotionState)if(this.stateIndex=-1,this.transitionIndex=-1,this.motion){if(this.motion instanceof animationApi.AnimationBlend1D){const t=Array.from(this.motion.items);t.length&&(this.motion=t[i.value].motion)}if(this.motion instanceof animationApi.AnimationBlend2D){const t=Array.from(this.motion.items);t.length&&(this.motion=t[i.value].motion)}}else this.state instanceof animationApi.MotionState&&(this.motion=this.state.motion,this.motionLevel=Utils.getDefaultMotionLevel(),e.name=Utils.getMotionName(this.motion),this.motion&&(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D)&&(this.motion.name=this.state.name))}}this.refresh()}resetViewData(){this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.motion=null,this.motionLevel.length=0}queryLayers(){this.animationGraph&&(this.queryData.layers=this.animationGraph.layers.map((t,i)=>({index:i,name:t.name||EnvType.layer})))}addLayer(){this.animationGraph&&(this.animationGraph.addLayer(),this.crumbLayer(this.animationGraph.layers.length-1))}removeLayer(t){if(this.animationGraph&&!(t<0))if(this.animationGraph.removeLayer(t),t===this.layerIndex){const i=0===t?0:t-1;this.crumbLayer(i)}else this.refresh()}crumbLayer(t){var i,e;if(!this.animationGraph)return;this.resetViewData(),this.layerIndex=t,this.layer=this.animationGraph.layers[this.layerIndex],this.stateMachine=null!==(e=null===(i=this.layer)||void 0===i?void 0:i.stateMachine)&&void 0!==e?e:null;const n=Utils.getDefaultCrumbData();n.type=EnvType.layer,n.value=t,n.name=this.layer.name,this.crumbs=[n],this.refresh()}renameLayer(t,i){if(!this.animationGraph)return;const e=this.animationGraph.layers[t];if(!e)return;e.name=i;const n=this.crumbs[0];n&&n.value===t&&(n.name=i),this.refresh()}queryStateMachine(t,i=Utils.hasSubStateMachineCrumb(this.crumbs)){const e=Array.from(t.states()),n=Array.from(t.transitions());return{states:e.map((e,n)=>{const a=e.name,o=Utils.getStateType(e,t),s=e[cc_1.editorExtrasTag];Utils.checkEditorDataId(s);const r={index:n,name:a,type:o,editorData:s};switch(o){case"entryState":r.editorData||(r.editorData={id:Utils.produceEditorDataId(),centerX:-125,centerY:0});break;case"exitState":r.editorData||(r.editorData={id:Utils.produceEditorDataId(),centerX:125,centerY:0});break;case"anyState":r.editorData||(r.editorData={id:Utils.produceEditorDataId(),centerX:i?0:125,centerY:i?75:0});break;default:if(r.editorData||(r.editorData={id:Utils.produceEditorDataId(),centerX:0,centerY:0}),e instanceof animationApi.MotionState?r.props={speed:{variable:e.speed.variable,value:e.speed.value},motion:{type:Utils.getMotionType(e.motion),name:Utils.getMotionName(e.motion),level:Utils.getDefaultMotionLevel(),value:Utils.getMotionValue(e.motion),min:[],max:[]}}:e instanceof animationApi.SubStateMachine&&(r.stateMachine=this.queryStateMachine(e.stateMachine,!0)),e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=this.getComponents(e);r.components=t.map((t,i)=>({name:t.constructor.name,index:i,value:scene_state_component_1.default.encode(t)}))}}return r}),transitions:n.map((i,n)=>{const a=[];for(const t of i.conditions)t instanceof animationApi.BinaryCondition&&a.push({type:EnvType.BinaryCondition,operator:t.operator,lhs:{type:EnvType.conditionVariable,value:{variable:t.lhs.variable,constant:t.lhs.value}},rhs:{type:EnvType.conditionConstant,value:{variable:t.rhs.variable,constant:t.rhs.value}}}),t instanceof animationApi.UnaryCondition&&a.push({type:EnvType.UnaryCondition,operator:t.operator,lhs:{type:EnvType.conditionVariable,value:{variable:t.operand.variable}}}),t instanceof animationApi.TriggerCondition&&a.push({type:EnvType.TriggerCondition,lhs:{type:EnvType.conditionVariable,value:{variable:t.trigger}}});const o=e.findIndex(t=>t===i.from),s=e.findIndex(t=>t===i.to),r={type:Utils.getTransitionType(i),index:n,from:{index:o,name:i.from.name,type:Utils.getStateType(i.from,t)},to:{index:s,name:i.to.name,type:Utils.getStateType(i.to,t)},removable:!0,duration:-1,relativeDuration:!1,exitConditionEnabled:!1,exitCondition:0,editorData:i[cc_1.editorExtrasTag]||{},conditions:a};return animationApi.isAnimationTransition(i)&&(r.duration=i.duration,r.relativeDuration=i.relativeDuration,r.exitConditionEnabled=i.exitConditionEnabled,r.exitCondition=i.exitCondition),r}),editorData:t[cc_1.editorExtrasTag]}}crumbStateMachine(t){this.resetViewData(),this.state=this.getState(t),this.state&&this.state instanceof animationApi.SubStateMachine&&(this.stateMachine=this.state.stateMachine);const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.SubStateMachine,i.value=t,i.name=this.state.name,this.refresh()}getStates(){return this.stateMachine?Array.from(this.stateMachine.states()):[]}getState(t){return this.getStates()[t]||null}async addState(t){if(!this.stateMachine)return;t||(t={editorData:Utils.getDefaultEditorData()});const i=this.getStates().length;let e;t.subStateMachine?((e=this.stateMachine.addSubStateMachine()).name=EnvType.subStateMachineName,e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData),this.viewState(i)):((e=await this.stateMachine.addMotion()).name=EnvType.stateName,e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},t.editorData),t.motion?this.addMotionToState(i,t.motion):this.viewState(i))}removeState(t){if(!this.stateMachine)return;const i=this.getState(t);i&&(this.stateMachine.remove(i),this.crumbView())}crumbState(t){if(!this.stateMachine)return;const i=this.getState(t);i instanceof animationApi.SubStateMachine?this.crumbStateMachine(t):i instanceof animationApi.MotionState&&(i.motion instanceof animationApi.AnimationBlend1D||i.motion instanceof animationApi.AnimationBlend2D)&&this.crumbMotion(t)}viewState(t){if(!this.stateMachine)return;this.stateIndex=t,this.state=this.getState(t);const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.state,i.value=t,i.name=this.state.name,this.transitionIndex=-1,this.transition=null,this.motion=null,this.motionLevel.length=0,this.refresh()}moveState(t,i){const e=this.getState(t);e&&(i.editorData&&(e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},i.editorData)),this.refresh())}renameState(t,i){const e=this.getState(t);e&&(e.name=i,this.refresh())}changeState(t,i,e){const n=this.getState(t);n&&(n[i]instanceof animationApi.BindableNumber?n[i].value=e:n[i]=e,this.refresh())}async addMotion(t){let i,e=null;switch(t.type){case EnvType.ClipMotion:if(e=new animationApi.ClipMotion,t.uuid){const i=t.uuid;cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(t.uuid)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e instanceof animationApi.ClipMotion&&(e.clip=a),t())})})}e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData(),t.editorData);break;case EnvType.AnimationBlend1D:e=new animationApi.AnimationBlend1D,(i=this.getFirstNumberVariable())&&(e.param.variable=i[0]),e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData({autoThreshold:!0}),t.editorData);break;case EnvType.AnimationBlend2D:e=new animationApi.AnimationBlend2D,(i=this.getFirstNumberVariable())&&(e.paramX.variable=i[0],e.paramY.variable=i[0]),e[cc_1.editorExtrasTag]=Object.assign(Utils.getDefaultEditorData(),t.editorData)}return e}async addMotionToState(t,i){const e=this.getState(t);if(!(e&&e instanceof animationApi.MotionState))return;let n=e.name;const a=[EnvType.clipMotionName,EnvType.animationBlend1DName,EnvType.animationBlend2DName,EnvType.stateName],o=await this.addMotion(i);switch(i.type){case EnvType.ClipMotion:n=a[0];break;case EnvType.AnimationBlend1D:n=a[1];break;case EnvType.AnimationBlend2D:n=a[2]}if(a.includes(e.name)&&(e.name=n),o){e.motion=o,e.name=Utils.getMotionName(o),Utils.getLastCrumb(this.crumbs).name=e.name}this.refresh()}async changeClipMotion(t,i){const e=this.getState(t);e&&(i?(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(i)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(e.motion.clip=a,e.name=Utils.getMotionName(e.motion)),t())})})):e instanceof animationApi.MotionState&&e.motion instanceof animationApi.ClipMotion&&(e.motion.clip=null,e.name=Utils.getMotionName(e.motion)),this.refresh())}crumbMotion(t){if(!this.stateMachine)return;if(this.motion){if(this.motion instanceof animationApi.AnimationBlend1D){const i=Array.from(this.motion.items);i.length&&(this.motion=i[t].motion)}if(this.motion instanceof animationApi.AnimationBlend2D){const i=Array.from(this.motion.items);i.length&&(this.motion=i[t].motion)}}else{const i=this.getState(t);if(!(i&&i instanceof animationApi.MotionState))return;if(!i.motion||i.motion instanceof animationApi.ClipMotion)return;this.motion=i.motion,this.motion&&(this.motion instanceof animationApi.AnimationBlend1D||this.motion instanceof animationApi.AnimationBlend2D)&&(this.motion.name=i.name)}this.motionLevel=Utils.getDefaultMotionLevel();const i=Utils.getLastCrumb(this.crumbs,!0);i.type=EnvType.MotionState,i.name=Utils.getMotionName(this.motion),i.value=this.motionLevel,this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.refresh()}crumbMotionInMotion(t){if(!this.motion)return;let i=this.motion;for(let e=1;e<t.length;e++){const n=t[e];if(i instanceof animationApi.AnimationBlend1D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}else if(i instanceof animationApi.AnimationBlend2D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}if(!i)break;const a=Utils.getLastCrumb(this.crumbs,!0);a.type=EnvType.MotionState,a.name=Utils.getMotionName(i),a.value=n}this.motion!==i&&(this.motion=i,this.stateIndex=-1,this.state=null,this.transitionIndex=-1,this.transition=null,this.motionLevel.length=0,this.refresh())}getMotionByLevel(t){let i=this.motion;for(let e=1;e<t.length;e++){const n=t[e];if(i instanceof animationApi.AnimationBlend1D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}else if(i instanceof animationApi.AnimationBlend2D){const t=Array.from(i.items);t[n]&&(i=t[n].motion)}}return i}getFirstNumberVariable(){if(!this.animationGraph)return null;let t=this.variables.find(t=>0===t[1]._type);return t||this.animationGraph.addVariable(this.uniqueVariableName("Blend"),0),t=this.variables.find(t=>0===t[1]._type)}removeMotion(t){const i=this.getState(t);i&&(i instanceof animationApi.MotionState&&(i.motion=null),this.refresh())}viewMotion(t){const i=this.getMotionByLevel(t);if(!i)return;this.motionLevel=t;const e=Utils.getLastCrumb(this.crumbs);e.name=Utils.getMotionName(i),e.value=t,this.refresh()}moveMotion(t,i){const e=this.getMotionByLevel(t);e&&i.editorData&&(e[cc_1.editorExtrasTag]=Object.assign(e[cc_1.editorExtrasTag]||{},i.editorData)),this.refresh()}queryMotion(t,i,e){const n={type:Utils.getMotionType(i),name:Utils.getMotionName(i),level:t,value:Utils.getMotionValue(i),threshold:e,min:[],max:[]};if(e instanceof cc_1.Vec2&&(n.threshold={x:e.x,y:e.y}),i instanceof animationApi.ClipMotion&&(n.editorData=i[cc_1.editorExtrasTag]),i instanceof animationApi.AnimationBlend1D){n.editorData=i[cc_1.editorExtrasTag];const e=Array.from(i.items);if(Array.isArray(e)){n.children=[];const i=[];for(let a=0;a<e.length;a++){const o=e[a];if(o&&o.motion){const e=t.slice();e.push(a),i.push(o.threshold);const s=this.queryMotion(e,o.motion,o.threshold);n.children.push(s)}}i.length&&(n.min[0]=Math.min(...i),n.max[0]=Math.max(...i))}}if(i instanceof animationApi.AnimationBlend2D){n.editorData=i[cc_1.editorExtrasTag];const e=Array.from(i.items);if(Array.isArray(e)){n.children=[];const i=[],a=[];for(let o=0;o<e.length;o++){const s=e[o];if(s&&s.motion){const e=t.slice();e.push(o),i.push(s.threshold.x),a.push(s.threshold.y);const r=this.queryMotion(e,s.motion,s.threshold);n.children.push(r)}}i.length&&(n.min=[Math.min(...i),Math.min(...a)],n.max=[Math.max(...i),Math.max(...a)])}}return n}async addMotionToMotion(t,i){const e=this.getMotionByLevel(t);if(!e)return;const n=await this.addMotion(i);if(e instanceof animationApi.AnimationBlend1D){const i=new animationApi.AnimationBlend1D.Item;i.motion=n;const a=Array.from(e.items),o=a.length;if(0===o)i.threshold=DefaultValue.minThreshold;else if(1===o)i.threshold=DefaultValue.maxThreshold;else{const t=e[cc_1.editorExtrasTag],n=[];a.forEach(t=>{n.push(t.threshold)});const s=Math.min(...n),r=Math.max(...n),h=(r-s)/o;t&&!0===t.autoThreshold&&a.forEach((t,i)=>{t.threshold=s+h*i}),i.threshold=r}const s=Array.from(e.items);s.push(i),e.items=s,t.push(s.length-1)}else if(e instanceof animationApi.AnimationBlend2D){const i=Array.from(e.items),a=new animationApi.AnimationBlend2D.Item;a.motion=n,a.threshold=new cc_1.Vec2(0,0),i.push(a),e.items=i,t.push(i.length-1)}this.viewMotion(t)}renameMotionInMotion(t,i){const e=this.getMotionByLevel(t);(e instanceof animationApi.AnimationBlend1D||e instanceof animationApi.AnimationBlend2D)&&(e.name=i,this.refresh())}removeMotionInMotion(t){const i=t.pop();if(void 0===i||!t.length)return;const e=this.getMotionByLevel(t);if(e)if(e instanceof animationApi.AnimationBlend1D){const t=Array.from(e.items);t.splice(i,1);const n=t.length;if(n>2){const i=e[cc_1.editorExtrasTag],a=[];t.forEach(t=>{a.push(t.threshold)});const o=Math.min(...a),s=(Math.max(...a)-o)/(n-1);i&&!0===i.autoThreshold&&t.forEach((t,i)=>{t.threshold=o+s*i})}e.items=t}else if(e instanceof animationApi.AnimationBlend2D){const t=Array.from(e.items);t.splice(i,1),e.items=t}this.motionLevel.length=0,this.crumbView()}changeMotionAutoThreshold(t,i){const e=this.getMotionByLevel(t);e instanceof animationApi.AnimationBlend1D&&(e[cc_1.editorExtrasTag].autoThreshold=i,this.refresh())}changeMotionThreshold1D(t,i,e){const n=this.getMotionByLevel(t);if(!(n instanceof animationApi.AnimationBlend1D))return;const a=Array.from(n.items),o=a[i];o&&(o.threshold=e,n.items=a,this.refresh())}changeMotionThreshold2D(t,i,e,n){const a=this.getMotionByLevel(t);if(!(a instanceof animationApi.AnimationBlend2D))return;const o=Array.from(a.items)[i];o&&("x"===e?o.threshold.x=n:"y"===e&&(o.threshold.y=n),this.refresh())}async changeClipMotionInMotion(t,i){const e=this.getMotionByLevel(t);e instanceof animationApi.ClipMotion&&(i?(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(i)),await new Promise((t,n)=>{cc_1.assetManager.loadAny(i,(i,a)=>{i?n(i):(e.clip=a,t())})})):e.clip=null,this.refresh())}changeAnimationBlend1DInMotion(t,i,e){const n=this.getMotionByLevel(t);n instanceof animationApi.AnimationBlend1D&&(i===EnvType.animationBlendVariable&&(n.param.variable=e),i===EnvType.animationBlendValue&&(n.param.value=e),this.refresh())}changeAnimationBlend2DInMotion(t,i,e,n){const a=this.getMotionByLevel(t);if(!(a instanceof animationApi.AnimationBlend2D))return;const o=1===i?a.paramY:a.paramX;e===EnvType.animationBlendVariable&&(o.variable=n),e===EnvType.animationBlendValue&&(o.value=n),this.refresh()}getComponents(t){return(t instanceof animationApi.MotionState||t instanceof animationApi.SubStateMachine)&&t.components?Array.from(t.components):[]}getComponent(t,i=this.state){return this.getComponents(i)[t]||null}addComponent(t,i){const e=this.getState(t);if(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=cc_1.js.getClassByName(i.name);t&&e.addComponent(t),this.refresh()}}removeComponent(t,i){const e=this.getState(t);if(e instanceof animationApi.MotionState||e instanceof animationApi.SubStateMachine){const t=this.getComponent(i,e);e.removeComponent(t)}this.refresh()}async changeComponent(t,i,e){const n=this.getState(t);if(n instanceof animationApi.MotionState||n instanceof animationApi.SubStateMachine){const t=this.getComponent(i,n);await scene_state_component_1.default.change(t,e)}this.refresh()}getTransitions(){return this.stateMachine?Array.from(this.stateMachine.transitions()):[]}getTransition(t){return this.getTransitions()[t]||null}addTransition(t,i){if(!this.stateMachine)return;const e=this.getStates(),n=e[t],a=e[i],o=this.getTransitions();this.stateMachine.connect(n,a),this.viewTransition(o.length)}removeTransition(t,i){if(!this.stateMachine)return;const e=this.getTransition(t);if(!e)return;i?this.stateMachine.disconnect(e.from,e.to):this.stateMachine.removeTransition(e);const n=this.getTransitions();for(let t=0;t<n.length;t++)if(n[t].from===e.from&&n[t].to===e.to)return void this.viewTransition(t);this.crumbView()}viewTransition(t){this.transition=this.getTransition(t),this.transitionIndex=t;const i=Utils.getLastCrumb(this.crumbs);i.type=EnvType.transition,i.value=t,i.name=Utils.getTransitionName(this.transition),this.stateIndex=-1,this.state=null,this.motion=null,this.motionLevel.length=0,this.refresh()}changeTransitionProp(t,i,e){const n=this.getTransition(t);n&&("relativeDuration"===i&&animationApi.isAnimationTransition(n)?n.relativeDuration=!n.relativeDuration:n[i]=e,this.refresh())}addCondition(t,i){const e=`add${i.type}`;e in this&&this[e](t,i),this.refresh()}addBinaryCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.BinaryCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeBinaryCondition(t,n,i))}addUnaryCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.UnaryCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeUnaryCondition(t,n,i))}addTriggerCondition(t,i){const e=this.getTransition(t);if(!e)return;const n=e.conditions.length,a=new animationApi.TriggerCondition;e.conditions.push(a),i&&a&&(a[cc_1.editorExtrasTag]=Object.assign(a[cc_1.editorExtrasTag]||{},i),this.changeTriggerCondition(t,n,i))}getCondition(t,i){const e=this.getTransition(t);return e&&e.conditions[i]||null}removeCondition(t,i){const e=this.getTransition(t);e&&(e.conditions.splice(i,1),this.refresh())}changeCondition(t,i,e){const n=`change${e.type}`;n in this&&this[n](t,i,e),this.refresh()}changeBinaryCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.BinaryCondition&&(e.lhs&&(e.lhs.type===EnvType.conditionVariable?n.lhs.variable=e.lhs.value.variable:e.lhs.type===EnvType.conditionConstant&&(n.lhs.value=e.lhs.value.constant)),e.rhs&&(e.rhs.type===EnvType.conditionVariable?n.rhs.variable=e.rhs.value.variable:e.rhs.type===EnvType.conditionConstant&&(n.rhs.value=e.rhs.value.constant)),void 0!==e.operator&&(n.operator=e.operator-0))}changeUnaryCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.UnaryCondition&&(e.lhs&&e.lhs.type===EnvType.conditionVariable&&(n.operand.variable=e.lhs.value.variable),void 0!==e.operator&&(n.operator=e.operator-0))}changeTriggerCondition(t,i,e){const n=this.getCondition(t,i);n&&e&&n instanceof animationApi.TriggerCondition&&e.lhs&&e.lhs.type===EnvType.conditionVariable&&(n.trigger=e.lhs.value.variable)}queryVariables(){if(this.animationGraph){this.queryData.variables={};for(const t of this.variables){const[i,e]=t;this.queryData.variables[i]={type:animationApi.VariableType[e._type],value:e._value}}}}addVariable(t,i){if(!this.animationGraph)return;const e=parseInt(i);t=this.uniqueVariableName(t),this.animationGraph.addVariable(t,e),this.refresh()}changeVariable(t,i){if(!this.animationGraph)return;this.animationGraph.getVariable(t).value=i,this.refresh()}removeVariable(t){this.animationGraph&&(this.animationGraph.removeVariable(t),this.refresh())}uniqueVariableName(t){const i=[];for(const t of this.variables)i.push(t[0]);for(;t&&i.includes(t);)/(\d+)$/.test(t)?t=t.replace(/(\d+)$/,(t,i)=>{let e=parseInt(i,10);return(e+=1).toString()}):t+="1";return t}}exports.default=new SceneAnimationGraph;