"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.watch=exports.computed=exports.data=exports.props=exports.components=exports.template=void 0;const assert_1=__importDefault(require("assert"));function data(){return{addingLine:!1,shadowLineStyle:{display:"none"},nodes:{},lines:{},mouseDownPoint:null}}function mounted(){const e=this;e.refresh(),setTimeout(()=>{e.refresh()})}function populateMenus(e,t){var n;const o=[];for(const[s,{menu:i}]of e){const e=i.split("/").filter(e=>e);if(!e){console.warn("Empty menu path.");continue}let r=o;const a=e.length;for(let o=0;o<a;++o){const p=e[o],d=r.find(e=>e.label===p);if(d)o!==a-1?r=null!==(n=d.submenu)&&void 0!==n?n:d.submenu=[]:console.warn(`Duplicated menu item: ${i}`);else{const e={label:p};r.push(e),o===a-1?e.click=(()=>t(s)):r=e.submenu=[]}}}return o}exports.template='\n<section\n    :adding-line="addingLine"\n>\n    <pose-node \n        v-for="(dump,id) in nodes" \n        :key="$root.queryData.assetInfo.uuid + \'-pose-node-\' + id"\n        :ref="\'node-\'+id"\n        :dump="dump"\n        :active="dump.id===$root.queryData.view.poseExprNodeId"\n    ></pose-node>\n    <svg>\n        <path ref="shadowLine"\n            v-show="addingLine"\n            :style="shadowLineStyle"\n        ></path>\n        <path class="line"\n            v-for="(line,id) in lines" \n            :key="$root.queryData.assetInfo.uuid + \'-pose-link-\' + id"\n            :ref="\'link-\'+id"\n            :style="\'--color-pose-link:\'+getLineColor(line)"\n            :d="getLinePath(line)"\n            @mousedown.right.stop="lineContextMenu(line)"\n        ></path>\n    </svg>\n</section>\n',exports.components={"pose-node":require("./pose-node")},exports.props=["graph"],exports.data=data,exports.computed={droppable(){return Object.keys(this.graph.assetDragHandlersMap)}},exports.watch={graph(){const e=this;e.refresh(),setTimeout(()=>{e.refresh()})}},exports.methods={refresh(){const e=this;if(e.nodes={},e.graph&&e.graph.nodes)for(const t of e.graph.nodes)this.mergeNode(t);if(e.lines={},e.graph&&e.graph.links)for(const t of e.graph.links)this.mergeLine(t)},resize(){const e=this;for(const t in e.$refs)Array.isArray(e.$refs[t])&&e.$refs[t].forEach(e=>{e.resize&&e.resize()})},select(e){const t=this;t.$children.forEach(n=>{n.dump.id===e.id&&t.$root.select({type:t.$root.queryData.envType.PoseExprNode,index:e.id})})},mergeNode(e){const t=this.$parent.graph,n=e.id;this.$set(this.nodes,n,Object.assign({id:n,top:t.centerY,left:t.centerX},e))},mergeLine(e){const t=this,n=`${e.sourceID}_${e.sourceOutputID}_to_${e.destinationID}_${e.destinationInputID}`,o=t.nodes[e.sourceID].outputs.find(t=>t.id===e.sourceOutputID);o&&(o.destinationInputs||t.$set(o,"destinationInputs",[]),o.destinationInputs.push([e.destinationID,e.destinationInputID]));const s=t.nodes[e.destinationID].inputs.find(t=>t.id===e.destinationInputID);s&&(s.sourceOutputs||t.$set(s,"sourceOutputs",[]),s.sourceOutputs.push([e.sourceID,e.sourceOutputID])),t.$set(t.lines,n,e)},getNode(e){const t=this.$refs["node-"+e];if(t)return t[0]},addShadowLine(e,t){const n=this;n.addingLine=!0;const[o,s,i,r]=t,a=e?s:r,p=e?o:i,d=n.getNode(p),u=(e?d.dump.outputs:d.dump.inputs).find(e=>e.id===a);function l(t){if(!n.addingLine)return;t.stopPropagation(),t.preventDefault();const{clientX:o,clientY:s}=t,i=n.mouseDownPoint.$el.getPointCenter(e,a),r=n.$parent.graph.scale,p=(o-i.clientX)/r,d=(s-i.clientY)/r,u=i.left,l=i.top,c=i.left+p,h=i.top+d;let f=n.drawLinePath(u,l,c,h);e||(f=n.drawLinePath(c,h,u,l)),n.$refs.shadowLine.setAttribute("d",f)}n.shadowLineStyle["--color-pose-link"]=n.$root.getPoseLinkColor(u.type),n.mouseDownPoint={$el:d},n.$parent.$el.addEventListener("mousemove",l),n.$parent.$el.addEventListener("mouseup",function o(s){if(0!==s.button)return;n.$parent.$el.removeEventListener("mousemove",l),n.$parent.$el.removeEventListener("mouseup",o),setTimeout(()=>{n.addingLine=!1}),n.mouseDownPoint=null,n.$refs.shadowLine.setAttribute("d","");const{clientX:i,clientY:r}=s;let a=n.$el.getRootNode().elementFromPoint(i,r);for(;a;){if(a.classList.contains("point")){if(e&&!a.classList.contains("input"))return;const o=a.getAttribute("point-id"),s=a.getAttribute("node-id");if(s===p)return;const i=e?3:1,r=1===i?Number(o):o;return t[i-1]=Number(s),t[i]=r,void n.$root.addPoseLink(t)}a=a.parentElement}})},getLineColor(e){const{sourceID:t,sourceOutputID:n,destinationID:o,destinationInputID:s}=e,i=this.getNode(t);if(!i)return"";const r=i.dump.outputs[n];return this.$root.getPoseLinkColor(r.type)},getLinePath(e){const t=this,{sourceID:n,sourceOutputID:o,destinationID:s,destinationInputID:i}=e,r=t.getNode(n),a=t.getNode(s);if(!r||!a)return"";const p=r.dump.outputs.find(e=>e.id===o);t.$refs.shadowLine.style["--color-pose-link"]=t.$root.getPoseLinkColor(p.type);const d=r.getPointCenter(!0,o),u=a.getPointCenter(!1,i),l=d.left,c=d.top;if(isNaN(l)||isNaN(c))return"";const h=u.left,f=u.top;return isNaN(h)||isNaN(f)?"":t.drawLinePath(l,c,h,f)},drawLinePath(e,t,n,o){let s=e;const i=t;let r=(e+n)/2;const a=o,p=e>n?40:Math.abs(e-n)/2,d=Math.min(120,Math.max(p,Math.abs((e-n)/2)));return s<e+d&&(s=e+d),r>n-d&&(r=n-d),`M${e},${t} C${s},${i} ${r},${a} ${n},${o}`},contextMenu(e){const t=this,n=[{label:Editor.I18n.t("animation-graph.pose.paste"),enabled:"pose-nodes"===t.$root.queryData.pasteInfo.type||"state-machine"===t.$root.queryData.pasteInfo.type,click(){const n=t.getCenterXY({width:1,height:1,left:e.offsetX,top:e.offsetY});t.$root.pasteIntoPoseGraph(n)}},{type:"separator"}],o=populateMenus(t.graph.addNodeInfos,n=>{t.$root.addPoseNode({key:n,editorData:t.getCenterXY({width:80,height:30,left:e.offsetX,top:e.offsetY})})}),s=[{type:"separator"},{label:Editor.I18n.t("animation-graph.layer.stashGraph"),click(){t.$root.stashCurrentPoseGraph(t.getCenterXY({width:80,height:30,left:e.offsetX,top:e.offsetY}))}}],i=[{type:"separator"},{label:Editor.I18n.t("animation-graph.layer.bestViewport"),click(){t.$parent.bestViewport()}}],r=n.concat(o,s,i);Editor.Menu.popup({menu:r})},drop(e,t){var n;const o=this,s=null===(n=e.currentTarget)||void 0===n?void 0:n.droppable;if(!s)return;(0,assert_1.default)(1===s.length);const i=s[0],r=o.graph.assetDragHandlersMap[i];if(!r)return void console.warn(`There's no handlers configured for asset type ${i}`);const a=e=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"handleDropAssetIntoPoseGraph",args:[t.uuid,o.getCenterXY({width:50,height:30,left:t.offsetX,top:t.offsetY}),e]})},p=Object.keys(r.handlers);0!==p.length?1===p.length?a(p[0]):Editor.Menu.popup({menu:Object.entries(r.handlers).map(([e,t])=>({label:t.displayName,click:()=>{a(e)}}))}):console.warn(`Asset type ${i} did not configure any handlers`)},getCenterXY(e){return this.$parent.getCenterXY(e,!1)},getPosition(e){return this.$parent.getPosition(e,!1)},lineContextMenu(e){const t=this,{sourceID:n,sourceOutputID:o,destinationID:s,destinationInputID:i}=e,r=[n,o,s,i],a=[{label:Editor.I18n.t("animation-graph.pose.link.remove"),click(){t.$root.removePoseLink(r)}}];Editor.Menu.popup({menu:a})},crumbPoseNode(e){this.addingLine||this.$root.crumbPoseNode(e)}},exports.mounted=mounted;