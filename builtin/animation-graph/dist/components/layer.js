"use strict";function data(){return{clipAssetType:"cc.AnimationClip",graphData:{},graph:{scale:1,top:0,left:0,centerX:0,centerY:0,type:"state"},minScale:.05,maxScale:2,mouseDownPoint:null}}function mounted(){const e=this;e.observer=new window.ResizeObserver(()=>{e.resize()}),e.observer.observe(e.$el),e.resize()}function destroyed(){this.observer&&this.observer.unobserve(this.$el)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.destroyed=exports.mounted=exports.methods=exports.watch=exports.computed=exports.data=exports.components=exports.template=void 0,exports.template='\n    <ui-drag-area class="layer"\n        :droppable="clipAssetType"\n        @mousedown="mouseDown($event)"\n        @wheel="wheel($event)"\n        @drop="drop($event)"\n    >\n        <grid class="grid" ref="grid"></grid>\n        <transition name="component-fade" mode="out-in"\n            v-on:before-enter="beforeEnter"\n            v-on:before-leave="beforeLeave"\n        >\n            <component class="graph" ref="component"\n                :is="graph.type"\n                :type="graph.type"\n                :style="graphStyle"\n                :graph="graphData"\n            ></component>\n        </transition>\n    </ui-drag-area>\n',exports.components={grid:require("./grid"),state:require("./state"),motion:require("./motion")},exports.data=data,exports.computed={graphStyle(){return{top:`${Math.ceil(this.graph.top)}px`,left:`${Math.ceil(this.graph.left)}px`,transform:`scale(${this.graph.scale})`}}},exports.watch={"graph.scale"(){this.moveViewport()},"graph.top"(){this.moveViewport()},"graph.left"(){this.moveViewport()},"graph.centerX"(){const e=this;e.$refs.component&&e.$refs.component.resize()},"graph.centerY"(){const e=this;e.$refs.component&&e.$refs.component.resize()}},exports.methods={beforeEnter(){this.$refs.grid.$el.classList.remove("animationOut"),this.$refs.grid.$el.classList.add("animationIn")},beforeLeave(){this.$refs.grid.$el.classList.remove("animationIn"),this.$refs.grid.$el.classList.add("animationOut")},refresh(e,t){const n=this;n.graph.type=e,t.editorData&&t.editorData.viewport&&Object.assign(n.graph,t.editorData.viewport),n.graphData=t},resize(){this.graph.centerX=this.$el.offsetWidth/2,this.graph.centerY=this.$el.offsetHeight/2},clear(){this.graphData={}},viewport(){this.graph.scale=1,this.graph.top=0,this.graph.left=0},bestViewport(){const e=this,t=e.$el.clientWidth,n=e.$el.clientHeight,o=e.calcComponentRect(),r=t/o.width,s=n/o.height,i=Math.min(r,s,1)||1,a=o.centerX-t/2,p=o.centerY-n/2,h={scale:i,top:0,left:0},c=[],l=[],g=e.$refs.component.nodes,d="motion"===e.$refs.component.$attrs.type;for(const t in g){const n=g[t];0!==n.width&&0!==n.height&&(n.left-=a,n.top-=p,d?l.push({level:n.level,editorData:e.getCenterXY(n)}):c.push({index:n.index,editorData:e.getCenterXY(n)}))}Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"bestViewport",args:[{graph:h,states:c,motions:l}]})},moveViewport(){const e=this;window.cancelAnimationFrame(e.viewportAnimationId),e.viewportAnimationId=window.requestAnimationFrame(()=>{Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"viewport",args:[{scale:e.graph.scale,top:e.graph.top,left:e.graph.left}]})})},select(e){this.$refs.component.select(e)},wheel(e){const t=this;if(e.stopPropagation(),e.preventDefault(),!t.$refs.component)return;const n=t.$refs.component.$el.getBoundingClientRect(),o=t.graph.scale,r=0-(e.deltaX||e.deltaY)/5e3,s=0-(e.clientY-(n.y+n.height/2))*r/o,i=0-(e.clientX-(n.x+n.width/2))*r/o;let a=o,p=t.graph.top,h=t.graph.left;(a+=r)<t.minScale||a>t.maxScale||(p+=s,h+=i,t.graph.scale=a,t.graph.top=p,t.graph.left=h)},mouseDown(e){const t=this;if(!t.$refs.component)return;const n=t.$el.getBoundingClientRect(),o=t.$refs.component.$el.getBoundingClientRect(),r=n.width+(e.clientX-o.x-o.width)/t.graph.scale,s=n.height+(e.clientY-o.y-o.height)/t.graph.scale;function i(e){if(!t.mouseDownPoint||"right"!==t.mouseDownPoint.button)return;e.stopPropagation(),e.preventDefault();const{clientX:n,clientY:o,gridStartX:r,gridStartY:s,graphLeft:i,graphTop:a}=t.mouseDownPoint,p=e.clientX-n,h=e.clientY-o;0===p&&0===h||(t.mouseDownPoint.hasMoved=!0,t.$refs.grid.startX=r+p,t.$refs.grid.startY=s+h,t.$refs.grid.render(),t.graph.left=i+p,t.graph.top=a+h)}t.mouseDownPoint={hasMoved:!1,clientX:e.clientX,clientY:e.clientY,offsetX:r,offsetY:s,button:0===e.button?"left":"right",gridStartX:t.$refs.grid.startX,gridStartY:t.$refs.grid.startY,graphLeft:t.graph.left,graphTop:t.graph.top},document.addEventListener("mousemove",i),document.addEventListener("mouseup",function e(n){t.mouseDownPoint&&"right"===t.mouseDownPoint.button&&(t.mouseDownPoint.hasMoved||t.contextMenu(t.mouseDownPoint)),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",e),t.mouseDownPoint=null})},contextMenu(e){this.$refs.component.contextMenu(e)},drop(e){const t=this;t.$el.click();const n=[],{additional:o,type:r,value:s}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(o&&o.forEach(e=>{e.type===t.clipAssetType&&n.push(e.value)}),r===t.clipAssetType&&s&&!n.includes(s)&&n.push(s),!n.length)return;if(!t.$refs.component)return;const i=t.$el.getBoundingClientRect(),a=t.$refs.component.$el.getBoundingClientRect();let p=i.width+(e.clientX-a.x-a.width)/t.graph.scale,h=i.height+(e.clientY-a.y-a.height)/t.graph.scale;for(let o=0;o<n.length;o++){const r=n[o];p+=32,h+=32,t.$refs.component.drop(e,{offsetX:p,offsetY:h,uuid:r})}},getCenterXY(e){return{centerX:e.left+e.width/2-this.graph.centerX,centerY:e.top+e.height/2-this.graph.centerY}},getPosition(e){const t=e.centerX-e.width/2+this.graph.centerX;return{top:e.centerY-e.height/2+this.graph.centerY,left:t}},calcComponentRect(){const e=this.$refs.component.nodes,t=[],n=[],o={},r={};for(const s in e){const i=e[s];0!==i.width&&0!==i.height&&(t.push(i.left),n.push(i.top),(void 0===o[i.left]||o[i.left]<i.width)&&(o[i.left]=i.width),(void 0===r[i.top]||r[i.top]<i.height)&&(r[i.top]=i.height))}const s=Math.min(...t),i=Math.max(...t),a=Math.min(...n),p=Math.max(...n),h=Math.abs(i-s)+o[i],c=Math.abs(p-a)+r[p],l=s,g=i+o[i],d=a,m=p+r[p];return{minX:s,maxX:i,minY:a,maxY:p,centerX:(l+g)/2,centerY:(d+m)/2,left:s,right:g,top:a,bottom:m,width:h,height:c}}},exports.mounted=mounted,exports.destroyed=destroyed;