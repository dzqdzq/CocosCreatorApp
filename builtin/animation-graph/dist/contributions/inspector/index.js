"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../inspector.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/template/inspector.html"),"utf8"),exports.$={container:".container"};const Elements={panel:{ready(){let e;this.__animationGraphChanged__=(()=>{window.cancelAnimationFrame(e),e=window.requestAnimationFrame(()=>{vm.refresh()})}),Editor.Message.__protected__.addBroadcastListener("animation-graph:changed",this.__animationGraphChanged__),this.__updateTransitionPreview__=(e=>{vm.updateTransitionPreview(e)}),Editor.Message.__protected__.addBroadcastListener("scene:update-transition-preview",this.__updateTransitionPreview__),this.__updateMotionPreview__=(e=>{vm.updateMotionPreview(e)}),Editor.Message.__protected__.addBroadcastListener("scene:update-motion-preview",this.__updateMotionPreview__),Editor.Profile.__protected__.on("change",exports.methods.profileChanged)},close(){Editor.Message.__protected__.removeBroadcastListener("animation-graph:changed",this.__animationGraphChanged__),Editor.Message.__protected__.removeBroadcastListener("scene:update-transition-preview",this.__updateTransitionPreview__),Editor.Message.__protected__.removeBroadcastListener("scene:update-motion-preview",this.__updateMotionPreview__),Editor.Profile.__protected__.removeListener("change",exports.methods.profileChanged)}}};function ready(){panel=this;for(const e in Elements){const t=Elements[e];t.ready&&t.ready.call(panel)}vm=new Vue({el:panel.$.container,components:{"variable-selection":require("./variable-selection").default,"motion-prop":require("../../components/motion-prop"),"component-prop":require("../../components/component-prop"),"transition-preview":require("../../components/transition-preview"),"motion-preview":require("../../components/motion-preview"),"condition-grid":require("./condition/condition-grid").default,"event-bindings-area":require("./event-bindings-area").default,"layer-stashes-area":require("./layer-stash/layer-stashes-area").default},directives:{focus:{inserted(e){e.focus()}}},data:{sceneReady:!1,poseExprExperiment:!0,active:"Layer",variableNameValue:"",queryData:{assetInfo:null,isDirty:!1,envType:{},view:{crumbs:[],stateMachine:{states:[],transitions:[]},layerIndex:-1,stateIndex:-1,motionLevel:[],transitionIndex:-1},layers:[],variables:{},variableType:{},previewState:{},unaryConditionOperator:{},binaryConditionOperator:{},conditionVariableType:[],cannotAddMotionStateType:[],cannotRemoveStateType:[],motionType:[],animationBlendType:[]}},watch:{queryData(){vm.queryData&&(1===vm.queryData.view.crumbs.length?vm.active="layer":vm.active="state")}},async mounted(){this.sceneReady=await Editor.Message.request("scene","query-is-ready"),this.sceneReady&&await this.refresh(),this.poseExprExperiment=await this.getPoseExprExperiment()},methods:{t:e=>Editor.I18n.t(`animation-graph.${e}`),async refresh(){const e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"query",args:[]});vm.queryData=e},twinkle(){Editor.Message.request("assets","ui-kit:touch-asset",vm.queryData.assetInfo.uuid)},getLastCrumb(){const e=vm.queryData.view.crumbs.length-1;return vm.queryData.view.crumbs[e]},viewLayer:()=>vm?vm.queryData.layers[vm.queryData.view.layerIndex]:null,changeLayer(e,t){const n=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeLayer",args:[vm.queryData.view.layerIndex,t,n]})},viewStateMachine:()=>vm&&vm.queryData?vm.queryData.view.stateMachine:null,viewState(){if(!vm)return null;const e=this.viewStateMachine();return e?e.states.find(e=>e.index===vm.queryData.view.stateIndex):null},stateMenu(e){const t=vm.viewState(),n=(e.target,[]);vm.queryData.cannotRemoveStateType.includes(t.type)||n.unshift(...[{label:Editor.I18n.t("animation-graph.state.rename"),click(){vm.$set(vm.viewState(),"rename",!0)}},{type:"separator"},{label:Editor.I18n.t("animation-graph.state.remove"),click(){vm.removeState(vm.queryData.view.stateIndex)}},{type:"separator"}]),Editor.Menu.popup({menu:n})},removeState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeState",args:[e]})},changeState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeState",args:[vm.queryData.view.stateIndex,t,e]})},renameStateSubmit(e){const t=e.target;if(!t)return;const n=vm.viewState();if(!n)return;const a=t.value.trim();a&&a!==n.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameState",args:[vm.queryData.view.stateIndex,a]}),n.rename=!1},renameStateCancel(){vm.viewState().rename=!1},componentMenu(e){const t=[{label:Editor.I18n.t("animation-graph.component.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeComponent",args:[vm.queryData.view.stateIndex,e]})}}];Editor.Menu.popup({menu:t})},addComponent(e,t){Date.now();Editor.Panel.__protected__.openKit("ui-kit.searcher",{elem:t,params:[{type:"script",droppable:"cc.animation.StateMachineComponent"}],listeners:{confirm(t){if(!t)return;const n={name:t.info.name};Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addComponent",args:[e,n]})}}})},changeComponent(e,t,n=vm.queryData.view.stateIndex){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeComponent",args:[n,t,e]})},currentMotion:()=>vm&&vm.queryData?vm.queryData.view.motion:null,viewMotion(){if(!vm)return null;const e=this.currentMotion();if(!e)return null;const t=vm.queryData.view.motionLevel;if(0===t.length)return null;let n=e;for(let e=1;e<t.length;e++){const a=t[e];n=n.children[a]}return n},getAddMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.ClipMotion"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],getReplaceMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.replaceWithAnim"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],motionMenuInState(){const e=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotion",args:[vm.queryData.view.stateIndex]})}}];e.unshift(...vm.getReplaceMotionMenu(),{type:"separator"}),Editor.Menu.popup({menu:e})},motionAddMenuInState(){const e=vm.getAddMotionMenu();Editor.Menu.popup({menu:e})},motionMenuInMotion(e){const t=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[vm.queryData.view.motionLevel]})}}];e.type!==vm.queryData.envType.AnimationBlend1D&&e.type!==vm.queryData.envType.AnimationBlend2D||t.unshift(...[{label:Editor.I18n.t("animation-graph.motion.rename"),click(){vm.$set(e,"rename",!0)}},{type:"separator"}]),Editor.Menu.popup({menu:t})},addMotionToState(e){const t=e&&e.stateIndex?e.stateIndex:vm.queryData.view.stateIndex,n=`state-${t}`,a=`${n}-motion`;vm.$refs[n]&&(vm.$refs[n].setAttribute("expand",""),vm.$refs[a].setAttribute("expand","")),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToState",args:[t,e]})},changeClipMotion(e){const t=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotion",args:[vm.queryData.view.stateIndex,t]})},crumbMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotion",args:[vm.queryData.view.stateIndex]})},crumbMotionInMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotionInMotion",args:[vm.queryData.view.motionLevel]})},moveMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveMotion",args:[e,t]})},addMotionToMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToMotion",args:[e,t]})},renameMotionSubmit(e){const t=e.target;if(!t)return;const n=vm.viewMotion();if(!n)return;const a=t.value.trim();a&&a!==n.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameMotionInMotion",args:[vm.queryData.view.motionLevel,a]}),n.rename=!1},renameMotionCancel(){vm.viewMotion().rename=!1},removeMotionInMotion(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[e]})},changeMotionAutoThreshold(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionAutoThreshold",args:[e,t]})},changeMotionThreshold1D(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold1D",args:[e,t,n]})},changeMotionThreshold2D(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold2D",args:[e,t,n]})},changeMotionProp(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionProp",args:[e,t,n]})},changeClipMotionInMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotionInMotion",args:[e,t]})},changeAnimationBlend1DInMotion(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend1DInMotion",args:[e,t,n]})},changeAnimationBlend2DInMotion(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend2DInMotion",args:[e,t,n,a]})},updateMotionPreview(e){vm&&vm.$refs.motionPreview&&vm.$refs.motionPreview.update(e)},selectTransition(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"viewTransition",args:[e]})},viewTransition(){if(!vm)return null;const e=vm.viewStateMachine();return e?e.transitions.find(e=>e.index===vm.queryData.view.transitionIndex):null},viewTransitions(){if(!vm)return null;const e=vm.viewStateMachine();if(!e)return null;const t=[],n=vm.viewTransition();return n&&e.transitions.forEach(e=>{e.from.index===n.from.index&&e.to.index===n.to.index&&t.push(e)}),t},outGoingsTransitions(){if(!vm)return null;const e=vm.viewStateMachine();if(!e)return null;const t=vm.viewState().outGoings,n=[];return e.transitions.forEach(e=>{t.includes(e.index)&&n.push(e)}),n},dragResetTransition(){vm.$refs.transitionList.hasAttribute("dragging")&&vm.$refs.transitionList.removeAttribute("dragging")},dragStartTransition(e,t,n){e.stopPropagation(),vm.$refs.transitionList.setAttribute("dragging",""),e.dataTransfer.setData("_animation_graph_transition_drag_data_",`${t},${n}`)},dragOverTransition(e){if(e.preventDefault(),!vm.$refs.transitionList.hasAttribute("dragging"))return;const t=e.currentTarget,n=t.getBoundingClientRect(),a=n.height/2;e.clientY-n.top<=a?t.setAttribute("drag-over","top"):n.bottom-e.clientY<=a&&t.setAttribute("drag-over","bottom")},dragLeaveTransition(e){e.currentTarget.removeAttribute("drag-over")},dropTransition(e,t){if(e.dataTransfer){const n=e.dataTransfer.getData("_animation_graph_transition_drag_data_");if(!n)return;if(!vm.$refs.transitionList.hasAttribute("dragging"))return;vm.$refs.transitionList.removeAttribute("dragging");const[a,i]=n.split(",").map(Number),o=e.currentTarget,r=o.getAttribute("drag-over");o.removeAttribute("drag-over");let s=t-i;if(0===s)return;s<0&&(s+=1),"top"===r&&(s-=1),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"adjustTransitionPriority",args:[a,s]})}},transitionMenu(e){const t=[{label:Editor.I18n.t("animation-graph.transition.removeAll"),click(){vm.removeTransition(e,!0)}}];Editor.Menu.popup({menu:t})},removeTransition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeTransition",args:[e,t]})},changeTransitionProp(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeTransitionProp",args:[e,t,n]})},getTransitionUnit:e=>e.relativeDuration?vm.t("transition.unitTimes"):vm.t("transition.unitSeconds"),getDestinationStartUnit:e=>e.relativeDestinationStart?vm.t("transition.unitTimes"):vm.t("transition.unitSeconds"),getPoseExprExperiment:async()=>await Editor.Profile.getConfig("animation-graph","animation-graph.pose-expr"),updateTransitionPreview(e){vm&&vm.$refs.transitionPreview&&vm.$refs.transitionPreview.update(e)},conditionMenu(e){const t=[{label:Editor.I18n.t("animation-graph.condition.addUnary"),click(){vm.addCondition(e,{type:"UnaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addBinary"),click(){vm.addCondition(e,{type:"BinaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addTrigger"),click(){vm.addCondition(e,{type:"TriggerCondition"})}}];Editor.Menu.popup({menu:t})},addCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addCondition",args:[e,t]})},conditionTypeMenu(e,t){const n=vm.queryData.conditionVariableType.map(n=>({label:n,type:"radio",checked:t[e].type===n,click(){t[e].type=n}}));Editor.Menu.popup({menu:n})},conditionPropChange(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionProps",args:[e,t,n,a]})},conditionBindingPropChange(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionBindingProps",args:[e,t,n,a]})},conditionBindingTypeChange(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeConditionBindingType",args:[e,t,n,a]})},conditionVariableChange(e,t,n,a,i){n[a].value.variable=i,this.conditionSubmitChange(e,t,n)},conditionOperatorChange(e,t,n,a){n.operator=a-0,this.conditionSubmitChange(e,t,n)},conditionConstantChange(e,t,n,a,i){n[a].value.constant=Number(i),this.conditionSubmitChange(e,t,n)},conditionSubmitChange(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeCondition",args:[e,t,n]})},removeCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeCondition",args:[e,t]})},currentPose:()=>vm&&vm.queryData?vm.queryData.view.poseExpr:null,viewPoseNode(){if(!vm)return null;const e=this.currentPose();if(!e)return null;const t=e.nodes.find(e=>e.id===vm.queryData.view.poseExprNodeId);return t?(t.inputs.forEach(e=>{e.value&&"object"==typeof e.value&&(e.value.name=e.name)}),t):null},getPoseNodeData(){if(!vm)return;const e=this.viewPoseNode();return e&&e.data?e.data.value:void 0},updatePoseNodeData(e,t,n){if(!vm)return;const a=e.currentTarget;a&&a.dump&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeData",args:[n,t,a.dump]})},getPoseNodeInputs:()=>[],updatePoseNodeInput(e,t,n){if(!vm)return;const a=e.target;a&&a.dump&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeInput",args:[t,n,a.dump]})},metric(e,t){e&&Editor.Metrics._trackEventWithTimer({category:"animationStateMachine",id:e,value:1})}}})}function close(){const e=this;for(const t in Elements){const n=Elements[t];n.close&&n.close.call(e)}}exports.methods={apply(){vm&&vm.apply()},refresh(){vm&&vm.refresh()},unselect(){vm&&vm.select({type:""})},delete(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.removeState(e.value);break;case vm.queryData.envType.transition:vm.removeTransition(e.value,!0);break;case vm.queryData.envType.MotionState:vm.removeMotionInMotion(e.value)}},profileChanged(e,t,n,a){vm&&t.includes("animation-graph")&&"animation-graph.pose-expr"===n&&(vm.poseExprExperiment=a)}},exports.ready=ready,exports.close=close;