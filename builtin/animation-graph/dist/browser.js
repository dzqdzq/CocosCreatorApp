"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const Profile=require("@base/electron-profile");let hasOnProfileChange=!1;function load(){}function unload(){}exports.methods={async open(e){e&&await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"edit",args:[e]}),await Editor.Panel.has("scene")&&!await Editor.Task.__protected__.hasSyncTask()?Editor.Panel.openBeside("scene","animation-graph"):Editor.Panel.open("animation-graph")},dialogWarn:async()=>(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.warningCaption"),{title:Editor.I18n.t("animation-graph.warning"),detail:Editor.I18n.t("animation-graph.warningDetail"),default:0,cancel:2,buttons:[Editor.I18n.t("animation-graph.save"),Editor.I18n.t("animation-graph.abort"),Editor.I18n.t("animation-graph.cancel")]})).response,async profileBindWatchWhenSceneReady(){if(!hasOnProfileChange){const e=Profile.load("global://packages/animation-graph.json"),a="animation-graph.pose-expr",n={moduleCache:await Editor.Profile.getProject("engine","modules.cache")};Profile.on("change",async(o,i,t,r)=>{if("global"===o&&"packages/animation-graph.json"===i&&t===a&&!0===r){if(!await exports.methods.profileCheckConfigIsLegal(null,e.get(a))){0===await exports.methods.profileDialogWarn(Editor.I18n.t("animation-graph.configEngineWarn"))&&(await exports.methods.profileEnsureEngineIsLegal(),Editor.Message.broadcast("project:engine-modules-changed"))}}if("project"===o&&"packages/engine.json"===i&&"modules.cache"===t){if(!await exports.methods.profileCheckConfigIsLegal(n,e.get(a))){0===await exports.methods.profileDialogWarn(Editor.I18n.t("animation-graph.configPreferencesWarn"))&&(await exports.methods.profileEnsureEngineIsLegal(),e.set(a,!0),e.save(),Editor.Message.broadcast("preferences:packages-changed"))}}}),hasOnProfileChange=!0}},async profileCheckConfigIsLegal(e,a){const n=await Editor.Profile.getProject("engine","modules.cache");if(!n)return!0;if(e){let a=!1;if(e.moduleCache["procedural-animation"]._value!==n["procedural-animation"]._value&&(a=!0),e.moduleCache.marionette._value!==n.marionette._value&&(a=!0),!a)return!0;e.moduleCache=n}return!(!e&&a&&!1===n["procedural-animation"]._value)&&((!a||!1!==n.marionette._value)&&!(!a&&!0===n["procedural-animation"]._value))},async profileEnsureEngineIsLegal(){const e=await Editor.Profile.getProject("engine","modules.cache"),a=await Editor.Profile.getProject("engine","modules.includeModules");if(!e||!Array.isArray(a))return;let n=!1;return a.includes("marionette")||(a.push("marionette"),n=!0),a.includes("procedural-animation")||(a.push("procedural-animation"),n=!0),e.marionette._value||(e.marionette._value=!0,n=!0),e["procedural-animation"]._value||(e["procedural-animation"]._value=!0,n=!0),n&&(await Editor.Profile.setProject("engine","modules.cache",e),await Editor.Profile.setProject("engine","modules.includeModules",a.sort()),Editor.Message.broadcast("engine:modules-changed"),Editor.Message.broadcast("project:engine-modules-changed")),!0},profileDialogWarn:async e=>(await Editor.Dialog.warn(Editor.I18n.t("animation-graph.configInvalidTitle"),{title:Editor.I18n.t("animation-graph.warning"),detail:e,default:0,cancel:1,buttons:[Editor.I18n.t("animation-graph.ok"),Editor.I18n.t("animation-graph.cancel")]})).response},exports.load=load,exports.unload=unload;