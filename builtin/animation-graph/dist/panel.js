"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;function ready(){vm=new Vue({el:(panel=this).$.container,components:{layer:require("./components/layer"),"motion-prop":require("./components/motion-prop"),"component-prop":require("./components/component-prop")},data:{needToResetViewport:!1,activeTab:0,variableNameValue:"",queryData:{assetInfo:null,isDirty:!1,envType:{},view:{crumbs:[],stateMachine:{states:[],transitions:[]},layerIndex:-1,stateIndex:-1,motionLevel:[],transitionIndex:-1},layers:[],variables:{},variableType:{},motionType:{},unaryConditionOperator:{},binaryConditionOperator:{},conditionVariableType:[],cannotAddMotionStateType:[],cannotRemoveStateType:[]},asideStyle:{width:"20%"}},watch:{queryData(){var e,t;vm.queryData&&vm.$refs.layer&&(vm.queryData.view.motion?(vm.$refs.layer.refresh("motion",vm.queryData.view.motion),(null===(e=vm.queryData.view.motion.editorData)||void 0===e?void 0:e.viewport)||(vm.needToResetViewport=!0)):vm.queryData.view.stateMachine?(vm.$refs.layer.refresh("state",vm.queryData.view.stateMachine),(null===(t=vm.queryData.view.stateMachine.editorData)||void 0===t?void 0:t.viewport)||(vm.needToResetViewport=!0)):vm.$refs.layer.clear(),vm.needToResetViewport&&vm.$nextTick(()=>{vm.needToResetViewport=!1,vm.$refs.layer.viewport()}))}},mounted(){this.refresh()},methods:{t:e=>Editor.I18n.t(`animation-graph.${e}`),open(e){const t=Date.now();Editor.Panel._kitControl.open({$kit:e.target,name:"ui-kit.searcher",timestamp:t,type:"asset",droppable:"cc.animation.AnimationGraph",events:{confirm(e,t){vm.needToResetViewport=!0,Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"edit",args:[t.uuid]})}}})},async refresh(){const e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"query",args:[]});vm.queryData=e},twinkle(){Editor.Message.request("assets","ui-kit:touch-asset",vm.queryData.assetInfo.uuid)},apply(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"apply",args:[]})},reset(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"reset",args:[]})},select(e){const t=vm.viewState();(null===t||void 0===t?void 0:t.rename)&&(t.rename=!1);const n=vm.viewMotion();(null===n||void 0===n?void 0:n.rename)&&(n.rename=!1),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeView",args:[e.type,e.index,e.level]}),"layer"!==e.type&&(vm.activeTab=2)},asideResizeMouseDown(e){const t=this;e.stopPropagation(),e.preventDefault();const n=t.$refs.aside.getBoundingClientRect();function a(e){if(!t.asideResizeMouseDownPoint)return;e.stopPropagation(),e.preventDefault();const{clientX:n,clientY:a,width:i}=t.asideResizeMouseDownPoint,o=e.clientX-n,r=e.clientY-a;0===o&&0===r||(t.asideResizeMouseDownPoint.hasMoved=!0,t.asideStyle.width=`${i+o}px`)}t.asideResizeMouseDownPoint={hasMoved:!1,clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY,button:0===e.button?"left":"right",width:n.width},document.addEventListener("mousemove",a),document.addEventListener("mouseup",function e(){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),t.asideResizeMouseDownPoint=null})},crumbView(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbView",args:[e]})},getLastCrumb(){const e=vm.queryData.view.crumbs.length-1;return vm.queryData.view.crumbs[e]},crumbHasSubStateMachine:()=>!!(vm&&vm.queryData&&vm.queryData.view&&Array.isArray(vm.queryData.view.crumbs))&&vm.queryData.view.crumbs.some(e=>e.type===vm.queryData.envType.SubStateMachine),currentLayer:()=>vm&&vm.queryData&&Array.isArray(vm.queryData.view.crumbs)&&"layer"===vm.queryData.view.crumbs[0].type?vm.queryData.layers[vm.queryData.view.crumbs[0].value]:null,addLayer(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addLayer",args:[]})},crumbLayer(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbLayer",args:[e]})},layerMenu(e,t){const n=[{label:Editor.I18n.t("animation-graph.layer.rename"),click(){vm.$set(t,"rename",!0)}}];vm.queryData.layers.length>1&&n.push(...[{type:"separator"},{label:Editor.I18n.t("animation-graph.layer.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeLayer",args:[e]})}}]),Editor.Menu.popup({menu:n})},renameLayerSubmit(e,t){const n=e.target;if(!n)return;const a=n.value.trim();a&&a!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameLayer",args:[t.index,a]}),t.rename=!1},renameLayerCancel(e){e.rename=!1},crumbStateMachine(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbStateMachine",args:[e]})},currentStateMachine:()=>vm&&vm.queryData?vm.queryData.view.stateMachine:null,viewState(){if(!vm)return null;const e=this.currentStateMachine();return e?e.states[vm.queryData.view.stateIndex]:null},stateMenu(e){const t=vm.viewState(),n=e.target,a=vm.queryData.cannotRemoveStateType.includes(t.type),i=[];vm.queryData.cannotAddMotionStateType.includes(t.type)||i.unshift(...vm.getReplaceMotionMenu(),{type:"separator"}),a||i.unshift(...[{label:Editor.I18n.t("animation-graph.state.remove"),click(){vm.removeState(vm.queryData.view.stateIndex)}},{label:Editor.I18n.t("animation-graph.component.add"),click(){vm.addComponent(vm.queryData.view.stateIndex,n)}},{type:"separator"},{label:Editor.I18n.t("animation-graph.state.rename"),click(){vm.$set(vm.viewState(),"rename",!0)}},{type:"separator"}]),Editor.Menu.popup({menu:i})},addState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addState",args:[e]})},removeState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeState",args:[e]})},crumbState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbState",args:[e]})},moveState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveState",args:[e,t]})},changeState(e,t){const n=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeState",args:[vm.queryData.view.stateIndex,t,n]})},renameStateSubmit(e){const t=e.target;if(!t)return;const n=vm.viewState();if(!n)return;const a=t.value.trim();a&&a!==n.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameState",args:[vm.queryData.view.stateIndex,a]}),n.rename=!1},renameStateCancel(){vm.viewState().rename=!1},componentMenu(e){const t=[{label:Editor.I18n.t("animation-graph.component.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeComponent",args:[vm.queryData.view.stateIndex,e]})}}];Editor.Menu.popup({menu:t})},addComponent(e,t){const n=Date.now();Editor.Panel._kitControl.open({$kit:t,name:"ui-kit.searcher",timestamp:n,type:"script",droppable:"cc.animation.StateMachineComponent",events:{confirm(t,n){const a={name:n.name};Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addComponent",args:[e,a]})}}})},changeComponent(e,t,n=vm.queryData.view.stateIndex){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeComponent",args:[n,t,e]})},currentMotion:()=>vm&&vm.queryData?vm.queryData.view.motion:null,viewMotion(){if(!vm)return null;const e=this.currentMotion();if(!e)return null;const t=vm.queryData.view.motionLevel;if(0===t.length)return null;let n=e;for(let e=1;e<t.length;e++){const a=t[e];n=n.children[a]}return n},getAddMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.ClipMotion"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],getReplaceMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.replaceWithAnim"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],motionMenuInState(){const e=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotion",args:[vm.queryData.view.stateIndex]})}}];Editor.Menu.popup({menu:e})},motionAddMenuInState(){const e=vm.getAddMotionMenu();Editor.Menu.popup({menu:e})},motionMenuInMotion(e){const t=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[vm.queryData.view.motionLevel]})}}];e.type!==vm.queryData.envType.AnimationBlend1D&&e.type!==vm.queryData.envType.AnimationBlend2D||t.unshift(...[{label:Editor.I18n.t("animation-graph.motion.rename"),click(){vm.$set(e,"rename",!0)}},{type:"separator"}]),Editor.Menu.popup({menu:t})},addMotionToState(e){const t=e&&e.stateIndex?e.stateIndex:vm.queryData.view.stateIndex,n=`state-${t}`,a=`${n}-motion`;vm.$refs[n]&&(vm.$refs[n].setAttribute("expand",""),vm.$refs[a].setAttribute("expand","")),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToState",args:[t,e]})},changeClipMotion(e){const t=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotion",args:[vm.queryData.view.stateIndex,t]})},crumbMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotion",args:[vm.queryData.view.stateIndex]})},crumbMotionInMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotionInMotion",args:[vm.queryData.view.motionLevel]})},moveMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveMotion",args:[e,t]})},addMotionToMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToMotion",args:[e,t]})},renameMotionSubmit(e){const t=e.target;if(!t)return;const n=vm.viewMotion();if(!n)return;const a=t.value.trim();a&&a!==n.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameMotionInMotion",args:[vm.queryData.view.motionLevel,a]}),n.rename=!1},renameMotionCancel(){vm.viewMotion().rename=!1},removeMotionInMotion(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[e]})},changeMotionAutoThreshold(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionAutoThreshold",args:[e,t]})},changeMotionThreshold1D(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold1D",args:[e,t,n]})},changeMotionThreshold2D(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold2D",args:[e,t,n,a]})},changeClipMotionInMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotionInMotion",args:[e,t]})},changeAnimationBlend1DInMotion(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend1DInMotion",args:[e,t,n]})},changeAnimationBlend2DInMotion(e,t,n,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend2DInMotion",args:[e,t,n,a]})},viewTransition(){if(!vm)return null;const e=vm.currentStateMachine();if(!e)return null;const t=[],n=e.transitions[vm.queryData.view.transitionIndex];return n&&e.transitions.forEach(e=>{e.from.index===n.from.index&&e.to.index===n.to.index&&t.push(e)}),t},transitionMenu(e){const t=[{label:Editor.I18n.t("animation-graph.condition.addUnary"),click(){vm.addCondition(e,{type:"UnaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addBinary"),click(){vm.addCondition(e,{type:"BinaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addTrigger"),click(){vm.addCondition(e,{type:"TriggerCondition"})}},{type:"separator"},{label:Editor.I18n.t("animation-graph.transition.remove"),click(){vm.removeTransition(e,!1)}}];Editor.Menu.popup({menu:t})},removeTransition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeTransition",args:[e,t]})},changeTransitionProp(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeTransitionProp",args:[e,t,n]})},getTransitionUnit:e=>e.relativeDuration?vm.t("transition.unitTimes"):vm.t("transition.unitSeconds"),conditionMenu(e,t){const n=[{label:Editor.I18n.t("animation-graph.condition.remove"),click(){vm.removeCondition(e,t)}}];Editor.Menu.popup({menu:n})},addCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addCondition",args:[e,t]})},conditionTypeMenu(e,t){const n=vm.queryData.conditionVariableType.map(n=>({label:n,type:"radio",checked:t[e].type===n,click(){t[e].type=n}}));Editor.Menu.popup({menu:n})},conditionVariableChange(e,t,n,a,i){n[a].value.variable=i,this.conditionSubmitChange(e,t,n)},conditionOperatorChange(e,t,n,a){n.operator=a-0,this.conditionSubmitChange(e,t,n)},conditionConstantChange(e,t,n,a,i){n[a].value.constant=Number(i),this.conditionSubmitChange(e,t,n)},conditionSubmitChange(e,t,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeCondition",args:[e,t,n]})},removeCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeCondition",args:[e,t]})},addVariable(){const e=vm.$refs.variableName.value,t=vm.$refs.variableType.value;e?(Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addVariable",args:[e,t]}),vm.variableNameValue=vm.$refs.variableName.value=""):vm.$refs.variableName.focus()},inputVariable(){vm.variableNameValue=vm.$refs.variableName.value},changeVariable(e,t){const n=t.target;if(!n||void 0===n.value)return;let a=n.value;"INTEGER"===n.getAttribute("type")&&(a=Math.round(a),requestAnimationFrame(()=>{n.value=a})),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeVariable",args:[e,a]})},variableMenu(e){Editor.Menu.popup({menu:[{label:Editor.I18n.t("animation-graph.variable.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeVariable",args:[e]})}}]})}},directives:{focus:{inserted(e){e.focus()}}}})}async function beforeClose(){return await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"beforeClose",args:[]})}function close(){}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../dist/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../static","/template/index.html"),"utf8"),exports.$={container:".container"},exports.methods={apply(){vm&&vm.apply()},refresh(){vm&&vm.refresh()},unselect(){vm&&vm.select({type:""})},delete(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.removeState(e.value);break;case vm.queryData.envType.transition:vm.removeTransition(e.value,!0);break;case vm.queryData.envType.MotionState:vm.removeMotionInMotion(e.value)}}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;