"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),throttle_debounce_1=require("throttle-debounce"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,require("./clip-related/animation-graph-clip-asset");let panel=null,vm=null;function ready(){vm=new Vue({el:(panel=this).$.container,components:{layer:require("./components/layer"),"motion-prop":require("./components/motion-prop"),"component-prop":require("./components/component-prop")},directives:{focus:{inserted(e){e.focus()}}},data:{sceneReady:!1,needToResetViewport:!1,poseExprExperiment:!0,active:"",layerState:{readyAdd:!1,readyRenameIndex:-1,confirmRenameIndex:-1},variableState:{readyAdd:!1,readyRenameVariableName:"",confirmRenameVariableName:""},variableNameValue:"",queryData:{assetInfo:null,isDirty:!1,pasteInfo:{type:"none"},envType:{},view:{crumbs:[],stateMachine:{states:[],transitions:[]},layerIndex:-1,stateIndex:-1,motionLevel:[],transitionIndex:-1},layers:[],variables:{},variableType:{},previewState:{},unaryConditionOperator:{},binaryConditionOperator:{},conditionVariableType:[],cannotAddMotionStateType:[],cannotRemoveStateType:[],motionType:[],animationBlendType:[]}},watch:{queryData(){var e,t,a;vm.queryData&&vm.$refs.layer&&(vm.queryData.view.motion?(vm.$refs.layer.refresh("motion",vm.queryData.view.motion),(null===(e=vm.queryData.view.motion.editorData)||void 0===e?void 0:e.viewport)||(vm.needToResetViewport=!0)):vm.queryData.view.poseExpr?(vm.$refs.layer.refresh("pose",vm.queryData.view.poseExpr),(null===(t=vm.queryData.view.poseExpr.editorData)||void 0===t?void 0:t.viewport)||(vm.needToResetViewport=!0)):vm.queryData.view.stateMachine?(vm.$refs.layer.refresh("state",vm.queryData.view.stateMachine),(null===(a=vm.queryData.view.stateMachine.editorData)||void 0===a?void 0:a.viewport)||(vm.needToResetViewport=!0)):vm.$refs.layer.clear(),vm.needToResetViewport&&(vm.needToResetViewport=!1,vm.$refs.layer.viewport()))}},async mounted(){this.poseExprExperiment=await this.getPoseExprExperiment(),this.sceneReady=await Editor.Message.request("scene","query-is-ready"),this.sceneReady&&await this.refresh()},methods:{t:e=>Editor.I18n.t(`animation-graph.${e}`)||`i18n:animation-graph.${e}`,async refresh(){const e=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"query",args:[]});vm.queryData=e},twinkle(){Editor.Message.request("assets","ui-kit:touch-asset",vm.queryData.assetInfo.uuid)},apply(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"apply",args:[]})},reset(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"reset",args:[]})},select(e){const t=vm.viewState();(null===t||void 0===t?void 0:t.rename)&&(t.rename=!1);const a=vm.viewMotion();(null===a||void 0===a?void 0:a.rename)&&(a.rename=!1),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeView",args:[e.type,e.index,e.level]})},getPoseExprExperiment:async()=>await Editor.Profile.getConfig("animation-graph","animation-graph.pose-expr"),activeTab(e){vm.active===e?vm.active="":vm.active=e},cancelTab(){vm.active=""},crumbView(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbView",args:[e]})},getLastCrumb(){const e=vm.queryData.view.crumbs.length-1;return vm.queryData.view.crumbs[e]},crumbHasSubStateMachine:()=>!!(vm&&vm.queryData&&vm.queryData.view&&Array.isArray(vm.queryData.view.crumbs))&&vm.queryData.view.crumbs.some(e=>e.type===vm.queryData.envType.SubStateMachine),viewLayer:()=>vm?vm.queryData.layers[vm.queryData.view.layerIndex]:null,crumbLayer(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbLayer",args:[e]})},addLayer(e){const t=e.target;if(!t)return;const a=t.value.trim();t.value="",vm.addLayerSubmit(a),vm.addLayerCancel(e)},addLayerSubmit:(0,throttle_debounce_1.debounce)(100,e=>{e&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addLayer",args:[e]})},{atBegin:!0}),addLayerReady(){vm.layerState.readyAdd=!vm.layerState.readyAdd},addLayerCancel(e){const t=e.target;t&&(t.value="",vm.layerState.readyAdd=!1)},removeLayer(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeLayer",args:[e]})},dragResetLayer(){vm.$refs.layerList.hasAttribute("dragging")&&vm.$refs.layerList.removeAttribute("dragging")},dragStartLayer(e,t){e.stopPropagation(),vm.$refs.layerList.setAttribute("dragging",""),e.dataTransfer.setData("_animation_graph_layer_drag_data_",t)},dragOverLayer(e){if(e.preventDefault(),!vm.$refs.layerList.hasAttribute("dragging"))return;const t=e.currentTarget,a=t.getBoundingClientRect(),n=a.height/2;e.clientY-a.top<=n?t.setAttribute("drag-over","top"):a.bottom-e.clientY<=n&&t.setAttribute("drag-over","bottom")},dragLeaveLayer(e){e.currentTarget.removeAttribute("drag-over")},dropLayer(e,t){if(e.dataTransfer){const a=e.dataTransfer.getData("_animation_graph_layer_drag_data_");if(!a)return;if(!vm.$refs.layerList.hasAttribute("dragging"))return;vm.$refs.layerList.removeAttribute("dragging");const n=Number(a),r=e.currentTarget,o=r.getAttribute("drag-over");r.removeAttribute("drag-over");let i=t-n;if(0===i)return;i<0&&(i+=1),"top"===o&&(i-=1),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveLayer",args:[n,n+i]})}},renameLayerReady(e){vm.layerState.readyRenameIndex===e?(vm.layerState.readyRenameIndex=-1,vm.layerState.confirmRenameIndex=e):vm.layerState.readyRenameIndex=e},renameLayerSubmit(e,t){const a=e.target;if(!a)return;const n=a.value.trim();n&&n!==t.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameLayer",args:[t.index,n]}),vm.renameLayerCancel()},renameLayerCancel(){vm.layerState.readyRenameIndex=-1,vm.layerState.confirmRenameIndex=-1},crumbStateMachine(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbStateMachine",args:[e]})},viewStateMachine:()=>vm&&vm.queryData?vm.queryData.view.stateMachine:null,viewState(){if(!vm)return null;const e=this.viewStateMachine();return e?e.states[vm.queryData.view.stateIndex]:null},getState(e){if(!vm)return null;const t=this.viewStateMachine();return t?t.states[e]:null},generateStateId:e=>`${vm.queryData.assetInfo.uuid}-${e}`,addState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addState",args:[e]})},removeState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeState",args:[e]})},crumbState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbState",args:[e]})},moveState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveState",args:[e,t]})},copyState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"copyState",args:[e]});const t=vm.getState(e),a=vm.generateStateId(t.editorData.id);vm.$refs.layer.twinkle("state",a,"light"),setTimeout(()=>{vm.$refs.layer.twinkle("state",a,"")},1e3)},duplicateState(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"duplicateState",args:[e]})},pasteState(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"pasteState",args:[e,t]})},turnMotionStateIntoSubStateMachine(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"turnMotionStateIntoSubStateMachine",args:[e]})},stateCanNotAddComponent(e){return this.queryData.cannotAddComponentStateType.includes(e)},stateCanNotRemove(e){return this.queryData.cannotRemoveStateType.includes(e)},stateCanNotCopy(e){return this.queryData.cannotRemoveStateType.includes(e)},componentMenu(e){const t=[{label:Editor.I18n.t("animation-graph.component.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeComponent",args:[vm.queryData.view.stateIndex,e]})}}];Editor.Menu.popup({menu:t})},addComponent(e,t){Date.now();Editor.Panel.__protected__.openKit("ui-kit.searcher",{elem:t,params:[{type:"script",droppable:"cc.animation.StateMachineComponent"}],listeners:{confirm(t){if(!t)return;const a={name:t.info.name};Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addComponent",args:[e,a]})}}})},changeComponent(e,t,a=vm.queryData.view.stateIndex){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeComponent",args:[a,t,e]})},currentMotion:()=>vm&&vm.queryData?vm.queryData.view.motion:null,viewMotion(){if(!vm)return null;const e=this.currentMotion();if(!e)return null;const t=vm.queryData.view.motionLevel;if(0===t.length)return null;let a=e;for(let e=1;e<t.length;e++){const n=t[e];a=a.children[n]}return a},getAddMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.ClipMotion"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.AnimationBlend2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],getReplaceMotionMenu:()=>[{label:Editor.I18n.t("animation-graph.motion.replaceWithAnim"),click(){vm.addMotionToState({type:vm.queryData.envType.ClipMotion})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith1D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend1D})}},{label:Editor.I18n.t("animation-graph.motion.replaceWith2D"),click(){vm.addMotionToState({type:vm.queryData.envType.AnimationBlend2D})}}],motionMenuInState(){const e=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotion",args:[vm.queryData.view.stateIndex]})}}];Editor.Menu.popup({menu:e})},motionAddMenuInState(){const e=vm.getAddMotionMenu();Editor.Menu.popup({menu:e})},motionMenuInMotion(e){const t=[{label:Editor.I18n.t("animation-graph.motion.remove"),click(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[vm.queryData.view.motionLevel]})}}];e.type!==vm.queryData.envType.AnimationBlend1D&&e.type!==vm.queryData.envType.AnimationBlend2D||t.unshift(...[{label:Editor.I18n.t("animation-graph.motion.rename"),click(){vm.$set(e,"rename",!0)}},{type:"separator"}]),Editor.Menu.popup({menu:t})},addMotionToState(e){const t=e&&e.stateIndex?e.stateIndex:vm.queryData.view.stateIndex,a=`state-${t}`,n=`${a}-motion`;vm.$refs[a]&&(vm.$refs[a].setAttribute("expand",""),vm.$refs[n].setAttribute("expand","")),Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToState",args:[t,e]})},changeClipMotion(e){const t=e.target.value;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotion",args:[vm.queryData.view.stateIndex,t]})},crumbMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotion",args:[vm.queryData.view.stateIndex]})},crumbMotionInMotion(){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbMotionInMotion",args:[vm.queryData.view.motionLevel]})},moveMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"moveMotion",args:[e,t]})},addMotionToMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addMotionToMotion",args:[e,t]})},renameMotionSubmit(e){const t=e.target;if(!t)return;const a=vm.viewMotion();if(!a)return;const n=t.value.trim();n&&n!==a.name&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameMotionInMotion",args:[vm.queryData.view.motionLevel,n]}),a.rename=!1},renameMotionCancel(){vm.viewMotion().rename=!1},removeMotionInMotion(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeMotionInMotion",args:[e]})},changeMotionAutoThreshold(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionAutoThreshold",args:[e,t]})},changeMotionThreshold1D(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold1D",args:[e,t,a]})},changeMotionThreshold2D(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionThreshold2D",args:[e,t,a]})},changeMotionProp(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeMotionProp",args:[e,t,a]})},changeClipMotionInMotion(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeClipMotionInMotion",args:[e,t]})},changeAnimationBlend1DInMotion(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend1DInMotion",args:[e,t,a]})},changeAnimationBlend2DInMotion(e,t,a,n){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeAnimationBlend2DInMotion",args:[e,t,a,n]})},viewTransition(){if(!vm)return null;const e=vm.viewStateMachine();if(!e)return null;const t=[],a=e.transitions[vm.queryData.view.transitionIndex];return a&&e.transitions.forEach(e=>{e.from.index===a.from.index&&e.to.index===a.to.index&&t.push(e)}),t},transitionMenu(e){const t=[{label:Editor.I18n.t("animation-graph.condition.addUnary"),click(){vm.addCondition(e,{type:"UnaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addBinary"),click(){vm.addCondition(e,{type:"BinaryCondition"})}},{label:Editor.I18n.t("animation-graph.condition.addTrigger"),click(){vm.addCondition(e,{type:"TriggerCondition"})}},{type:"separator"},{label:Editor.I18n.t("animation-graph.transition.remove"),click(){vm.removeTransition(e,!1)}}];Editor.Menu.popup({menu:t})},removeTransition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeTransition",args:[e,t]})},conditionMenu(e,t){const a=[{label:Editor.I18n.t("animation-graph.condition.remove"),click(){vm.removeCondition(e,t)}}];Editor.Menu.popup({menu:a})},addCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addCondition",args:[e,t]})},conditionTypeMenu(e,t){const a=vm.queryData.conditionVariableType.map(a=>({label:a,type:"radio",checked:t[e].type===a,click(){t[e].type=a}}));Editor.Menu.popup({menu:a})},conditionVariableChange(e,t,a,n,r){a[n].value.variable=r,this.conditionSubmitChange(e,t,a)},conditionOperatorChange(e,t,a,n){a.operator=n-0,this.conditionSubmitChange(e,t,a)},conditionConstantChange(e,t,a,n,r){a[n].value.constant=Number(r),this.conditionSubmitChange(e,t,a)},conditionSubmitChange(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeCondition",args:[e,t,a]})},removeCondition(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeCondition",args:[e,t]})},async addVariable(e,t){e&&(e=e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase(),vm.variableState.confirmRenameVariableName=await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"addVariable",args:[e,t]}),vm.variableState.readyAdd=!1)},addVariableReady(){vm.variableState.readyAdd=!vm.variableState.readyAdd},renameVariableReady(e){vm.variableState.readyRenameVariableName===e?(vm.variableState.readyRenameVariableName="",vm.variableState.confirmRenameVariableName=e):vm.variableState.readyRenameVariableName=e},renameVariableSubmit(e,t){const a=e.target;if(!a)return;const n=a.value.trim();n&&n!==t&&Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"renameVariable",args:[t,n]}),vm.renameVariableCancel()},renameVariableCancel(){vm.variableState.readyRenameVariableName="",vm.variableState.confirmRenameVariableName=""},changeVariable(e,t){const a=t.currentTarget,{dump:n}=a;Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeVariable",args:[e,n]})},changeTriggerResetMode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"changeTriggerResetMode",args:[e,t]})},removeVariable(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removeVariable",args:[e]})},addPoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseNode",args:[e]})},removePoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removePoseNode",args:[e]})},movePoseNode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"movePoseNode",args:[e,t]})},crumbPoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"crumbPoseNode",args:[e]})},copyPoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"copyPoseNode",args:[e]});const t=`node-${e}`;vm.$refs.layer.twinkle("pose",t,"light"),setTimeout(()=>{vm.$refs.layer.twinkle("pose",t,"")},1e3)},duplicatePoseNode(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"duplicatePoseNode",args:[e]})},pasteIntoPoseGraph(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"pasteIntoPoseGraph",args:[e]})},addPoseNodeInput(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseNodeInput",args:[e,t]})},updatePoseNodeInput(e,t,a){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"updatePoseNodeInput",args:[e,t,a]})},getPoseLinkColor:e=>vm.queryData.view.poseExpr.inputOutputTypeInfos[e].themeColor||"#fafafa",addPoseLink(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"addPoseLink",args:[...e]})},removePoseLink(e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"removePoseLink",args:[...e]})},toggleCollapsePoseNode(e,t){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"toggleCollapsePoseNode",args:[e,t]})},stashCurrentPoseGraph(...e){Editor.Message.send("scene","execute-scene-script",{name:"animation-graph",method:"stashCurrentPoseGraph",args:e})}}}),Editor.Profile.__protected__.on("change",exports.methods.profileChanged)}async function beforeClose(){return await Editor.Message.request("scene","execute-scene-script",{name:"animation-graph",method:"beforeClose",args:[]})}function close(){Editor.Profile.__protected__.removeListener("change",exports.methods.profileChanged)}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../dist/index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../static","/template/index.html"),"utf8"),exports.$={container:".container"},exports.methods={apply(){vm&&vm.apply()},refresh(){vm&&vm.refresh()},unselect(){vm&&vm.select({type:""})},delete(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.removeState(e.value);break;case vm.queryData.envType.transition:vm.removeTransition(e.value,!0);break;case vm.queryData.envType.MotionState:vm.removeMotionInMotion(e.value);break;case vm.queryData.envType.PoseExprNode:vm.removePoseNode(e.value)}},copy(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.copyState(e.value);break;case vm.queryData.envType.PoseExprNode:vm.copyPoseNode(e.value)}},duplicate(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.state:vm.duplicateState(e.value);break;case vm.queryData.envType.PoseExprNode:vm.duplicatePoseNode(e.value)}},paste(){if(!vm)return;const e=vm.getLastCrumb();if(e)switch(e.type){case vm.queryData.envType.layer:case vm.queryData.envType.state:vm.pasteState(!1);break;case vm.queryData.envType.PoseExprState:case vm.queryData.envType.PoseExprNode:vm.pasteIntoPoseGraph()}},profileChanged(e,t,a,n){vm&&t.includes("animation-graph")&&"animation-graph.pose-expr"===a&&(vm.poseExprExperiment=n)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;