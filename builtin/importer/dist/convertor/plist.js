"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,a){return new(r||(r=Promise))(function(s,i){function u(t){try{n(a.next(t))}catch(t){i(t)}}function o(t){try{n(a.throw(t))}catch(t){i(t)}}function n(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(u,o)}n((a=a.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlistImporter=void 0;const base_1=require("../common/base"),fs_extra_1=require("fs-extra"),path_1=require("path"),utlis_1=require("../common/utlis"),plist=require("plist");class PlistImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="plist"}import(){return __awaiter(this,void 0,void 0,function*(){return!this._2dMeta||("Texture Packer"===this._2dMeta.type?(this._3dMeta.ver="1.0.6",this._3dMeta.importer="sprite-atlas",this.importTexturePacker()):(this._3dMeta.ver="1.0.2",this._3dMeta.importer="particle",this.importParticle()))})}importTexturePacker(){return __awaiter(this,void 0,void 0,function*(){try{let t=this._3dMeta.userData;const e=yield fs_extra_1.readFile(this.sourceFsPath,"utf8"),r=plist.parse(e);t.atlasTextureName=r.metadata.realTextureFileName,t.format=r.metadata.format,t.textureUuid=`${this._2dMeta.rawTextureUuid}@${base_1.ImporterBase.getNameByID("texture")}`,t=this._3dMeta.userData;for(const e in r.frames){const r=this._2dMeta.subMetas[e],a=base_1.ImporterBase.getNameByID(path_1.parse(e).name),s=this.createNewMeta();s.importer="sprite-frame";for(const t in r)switch(t){case"ver":case"uuid":case"subMetas":case"spriteType":break;case"rawTextureUuid":s.userData.atlasUuid=r[t];break;default:s.userData[t]=r[t]}s.imageUuidOrDatabaseUri=t.textureUuid,this._3dMeta.subMetas[a]=s;for(let t in this._2dMeta.subMetas){const e=this._2dMeta.subMetas[t];e&&(t=path_1.basename(t,path_1.extname(t)),utlis_1.importSubAssets.set(e.uuid,{baseUuid:this._2dMeta.uuid,uuid:`${this._2dMeta.uuid}@${base_1.ImporterBase.getNameByID(t)}`}))}const i=utlis_1.importProjectAssets.get(this._2dMeta.rawTextureUuid);if(i){const t=this.readJSONSync(i.outPath);"texture"!==t.userData.type&&(t.userData.type="texture",fs_extra_1.writeJSONSync(i.outPath,t,{spaces:2}))}}return!0}catch(t){return console.error(t),!1}})}importParticle(){return __awaiter(this,void 0,void 0,function*(){try{const t=yield fs_extra_1.readFile(this.sourceFsPath,"utf8"),e=plist.parse(t);return e.spriteFrameUuid&&(e.spriteFrameUuid=yield base_1.ImporterBase.getUuid(e.spriteFrameUuid,"spriteFrame")),e.blendFuncSource&&(e.blendFuncSource=utlis_1.getBlendFactor2DTo3D(e.blendFuncSource)),e.blendFuncDestination&&(e.blendFuncDestination=utlis_1.getBlendFactor2DTo3D(e.blendFuncDestination)),this._2dTo3dSource=plist.build(e),!0}catch(t){return console.log(t),!1}})}}exports.PlistImporter=PlistImporter;