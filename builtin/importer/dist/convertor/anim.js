"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,r){function n(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimImporter=void 0;const base_1=require("../common/base"),AnimationClip_1=require("../components/AnimationClip");class AnimImporter extends base_1.ImporterBase{constructor(){super(...arguments),this.type="anim"}mergersCommonTarget(e,t,i,s){const o={modifiers:[]};if(s&&o.modifiers.push(s),"x"===e||"y"===e||"z"===e){o.modifiers.push("position");const s=i.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(o.modifiers));-1===s?(t.commonTarget=i.length,i.push(o)):t.commonTarget=s,t.modifiers.push(this.getModifier(e))}else if("scaleX"===e||"scaleY"===e||"scaleZ"===e){o.modifiers.push("scale");const s=i.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(o.modifiers));-1===s?(t.commonTarget=i.length,i.push(o)):t.commonTarget=s,t.modifiers.push(this.getModifier(e))}else s&&t.modifiers.push(s),t.modifiers.push(this.getModifier(e))}getModifier(e){return"angle"===e||"rotation"===e?"eulerAngles":"scaleX"===e?"x":"scaleY"===e?"y":"scaleZ"===e?"z":"top"===e||"bottom"===e||"left"===e||"right"===e||"horizontalCenter"===e||"verticalCenter"===e?"editor"+e.substring(0,1).toLocaleUpperCase()+e.substring(e.length,1):e}getValue(e,t){return __awaiter(this,void 0,void 0,function*(){return"angle"===e||"rotation"===e?{__type__:"cc.Vec3",x:0,y:0,z:t||0}:"scale"===e?{__type__:"cc.Vec3",x:t.x||1,y:t.y||1,z:t.z||1}:"position"===e?{__type__:"cc.Vec3",x:t[0]||0,y:t[1]||0,z:0}:(t.__uuid__&&(t="spriteFrame"===e||"texture"===e?yield base_1.ImporterBase.getUuid(t.__uuid__,e):yield base_1.ImporterBase.getUuid(t.__uuid__)),t)})}getPropsForCurveData(e,t,i){return __awaiter(this,void 0,void 0,function*(){const s=Array.isArray(t)?t[0]:t;for(const o in e){const r=e[o],n=[],a=[],c={modifiers:[],data:{keys:s._keys.length,values:a,easingMethods:{}}};if("opacity"===o){const e={__type__:"cc.animation.ComponentPath",component:"cc.UIOpacity"};i&&c.modifiers.push(i),c.modifiers.push({__id__:t.length}),c.modifiers.push(this.getModifier(o)),t.push(e)}else if("width"===o||"height"===o){const e={__type__:"cc.animation.ComponentPath",component:"cc.UITransform"};let r=t.findIndex(t=>t.__type__===e.__type__&&t.component===e.component);-1===r&&(r=t.length,t.push(e));const n={modifiers:[]};i&&n.modifiers.push(i),n.modifiers.push({__id__:r}),n.modifiers.push("contentSize");let a=s._commonTargets.findIndex(e=>JSON.stringify(e.modifiers)===JSON.stringify(n.modifiers));-1===a&&(a=s._commonTargets.length,s._commonTargets.push(n)),c.commonTarget=a,c.modifiers.push(this.getModifier(o))}else this.mergersCommonTarget(o,c,s._commonTargets,i);for(let e=0;e<r.length;e++){const t=r[e];n.push(t.frame);const i=yield this.getValue(o,t.value);c.data.values.push(i),t.curve&&(c.data.easingMethods[e]=t.curve)}s._keys.push(n),s._curves.push(c)}return t.length>1?t:s})}getCurveDataForComps(e,t,i){return __awaiter(this,void 0,void 0,function*(){for(const s in e){const o=e[s],r={__type__:"cc.animation.ComponentPath",component:s};for(const e in o){const s=o[e],r=[],n=[],a={modifiers:[],data:{keys:t[0]._keys.length,values:n,easingMethods:{}}};i&&a.modifiers.push(i),a.modifiers.push({__id__:t.length}),a.modifiers.push(this.getModifier(e));for(let t=0;t<s.length;t++){const i=s[t];r.push(i.frame);const o=yield this.getValue(e,i.value);a.data.values.push(o),i.curve&&(a.data.easingMethods[t]=i.curve)}t[0]._keys.push(r),t[0]._curves.push(a)}t.push(r)}return t})}getCurveDataForPaths(e,t){return __awaiter(this,void 0,void 0,function*(){for(const i in e){const s={__type__:"cc.animation.HierarchyPath",path:i};t.push(s);const o=e[i];if(o.props&&(t=yield this.getPropsForCurveData(o.props,t,{__id__:t.length-1})),o.comps){const e=t.findIndex(e=>e.path===i);t=yield this.getCurveDataForComps(o.comps,t,{__id__:e})}}return t})}getCurveData(e,t){return __awaiter(this,void 0,void 0,function*(){return e.props&&(t=Array.isArray(t)?t:[t],t=yield this.getPropsForCurveData(e.props,t)),e.comps&&(t=Array.isArray(t)?t:[t],t=yield this.getCurveDataForComps(e.comps,t)),e.paths&&(t=Array.isArray(t)?t:[t],t=yield this.getCurveDataForPaths(e.paths,t)),t})}import(){return __awaiter(this,void 0,void 0,function*(){const e=this.readJSONSync(),t=AnimationClip_1.AnimationClip.create();return t._name=e._name,t.sample=e.sample,t.speed=e.speed,t.wrapMode=e.wrapMode,t.events=e.events,t._duration=e._duration,this._2dTo3dSource=yield this.getCurveData(e.curveData,t),this._3dMeta.ver="1.0.6",this._3dMeta.importer="animation-clip",!0})}}exports.AnimImporter=AnimImporter;