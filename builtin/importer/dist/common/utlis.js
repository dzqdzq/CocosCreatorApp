"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))(function(o,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function n(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,n)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nameToId=exports.getDesignResolution=exports.getComponentByType=exports.compareVersion=exports.sizeSorting=exports.scriptName=exports.fromEuler=exports.getColor=exports.parseTilesetImages=exports.searchTmxDependImages=exports.readWriteFileByLineWithProcess=exports.getFBXSubMetaNewName=exports.setColor=exports.hasUIRenderComponent=exports.hasComponent=exports.getBlendFactor2DTo3D=exports.migratePlatformSettings=exports.import2DChunks=exports.init2DChunks=exports.chunksCacheBy2D=exports.addImportProjectAssets=exports.isFbxMultKey=exports.scanningDefaultAssets2D=exports.getDefaultAssets2D=exports.clear=exports.getNewUuid=exports.saveUuid=exports.updateReplaceScriptList=exports.replaceScriptList=exports.scriptList=exports.uuidList=exports.importSubAssets=exports.importProjectAssets=exports.replaceFbxUuidMap=exports.setGroupLayerByIndex=exports.getGroupLayerByIndex=exports.initGroupList=exports.layerToGroupMap=exports.collator=exports.SKIPS_SCRIPT=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),base_1=require("./base"),fs_1=require("fs"),readline_1=require("readline"),xmldom_1=require("xmldom"),crypto_1=require("crypto"),lodash=require("lodash");exports.SKIPS_SCRIPT=["use_reversed_rotateBy.js","use_reversed_rotateTo.js","use_v2.0.x_cc.Toggle_event.js","use_v2.1-2.2.1_cc.Toggle_event.js"],exports.collator=new Intl.Collator("en",{numeric:!0,sensitivity:"base"}),exports.layerToGroupMap=new Map;let groupList=[];function initGroupList(e){return __awaiter(this,void 0,void 0,function*(){try{const t=fs_extra_1.readJSONSync(path_1.join(e,"../settings/project.json"));groupList=t["group-list"]||[];for(let e=0;e<groupList.length;++e){yield setGroupLayerByIndex(e,groupList[e])}}catch(e){groupList=[]}})}function getGroupLayerByIndex(e){return __awaiter(this,void 0,void 0,function*(){if(0===groupList.length)return 1<<25;const t=groupList[e];return t?yield setGroupLayerByIndex(e,t):null})}function setGroupLayerByIndex(e,t){return __awaiter(this,void 0,void 0,function*(){let r,s=yield Editor.Profile.getProject("project","layer");if(s?r=s.find(e=>e.name===t):s=[],!r){const o=s.length;r={name:t,value:1<<o},s.push(r);let i=1<<e;exports.layerToGroupMap.set(i,r.value),yield Editor.Profile.setProject("project","layer",s)}return r.value})}function updateReplaceScriptList(e){exports.replaceScriptList=e}function saveUuid(e,t){exports.uuidList.set(e,t)}function getNewUuid(e){let t=exports.uuidList.get(e);if(!t){let r=exports.importProjectAssets.get(e);r&&r.outUuid&&(t=r.outUuid),t||(r=exports.importSubAssets.get(e))&&r.uuid&&(t=r.uuid)}return t||e}function clear(){exports.scriptList.clear(),exports.replaceScriptList.length=0,exports.replaceFbxUuidMap.clear()}exports.initGroupList=initGroupList,exports.getGroupLayerByIndex=getGroupLayerByIndex,exports.setGroupLayerByIndex=setGroupLayerByIndex,exports.replaceFbxUuidMap=new Map,exports.importProjectAssets=new Map,exports.importSubAssets=new Map,exports.uuidList=new Map,exports.scriptList=new Map,exports.replaceScriptList=[],exports.updateReplaceScriptList=updateReplaceScriptList,exports.saveUuid=saveUuid,exports.getNewUuid=getNewUuid,exports.clear=clear;const defaultAssets2DList=new Map;function getDefaultAssets2D(e){return defaultAssets2DList.get(e)}function scanningDefaultAssets2D(){const e=path_1.join(__dirname,"../../static"),t=path_1.join(__dirname,"../../static/migrate-resources/default-assets-2d");defaultAssets2DList.clear(),function t(r){try{if(r.endsWith(".DS_Store"))return;if(fs_extra_1.statSync(r).isDirectory())fs_extra_1.readdirSync(r).forEach(s=>{const o=path_1.join(r,s);s.endsWith(".meta")?addImportProjectAssets(e,o,!0):t(o)});else{const e=path_1.join(path_1.dirname(r),path_1.basename(r)+".meta"),t=fs_extra_1.readJSONSync(e);defaultAssets2DList.set(t.uuid,{path:r,type:t.type,baseUuid:t.uuid});for(const e in t.subMetas){const s=t.subMetas[e];s&&defaultAssets2DList.set(s.uuid,{path:r,type:t.type,baseUuid:t.uuid})}}}catch(e){console.error(e)}}(t)}function isFbxMultKey(e,t){if(t.includes("-")){const r=t.split("-")[0];return Object.keys(e).map(e=>e.includes(r+"-")).filter(Boolean).length>1}return!1}function addImportProjectAssets(e,t,r=!1){try{let s=t.replace(".meta","");s.endsWith(".fire")?s=s.replace(/.fire+$/g,".scene"):s.endsWith(".js")&&(s=s.replace(/.js+$/g,".ts"));const o=fs_extra_1.readJSONSync(t);let i;if(i=r?path_1.join(Editor.Project.path,"assets",path_1.relative(e,s+".meta")):path_1.join(Editor.Project.path,path_1.relative(e,s+".meta")),fs_extra_1.existsSync(i)){const e=path_1.extname(s);if(".fbx"===e||".FBX"===e)for(let e in o.subMetas){const r=o.subMetas[e];if(r){const s=isFbxMultKey(o.subMetas,e);e=getFBXSubMetaNewName(t.replace(".meta",""),e,s),exports.importSubAssets.set(r.uuid,{baseUuid:o.uuid,uuid:`${o.uuid}@${base_1.ImporterBase.getNameByID(e)}`})}}else if("Texture Packer"===o.type)for(let e in o.subMetas){const t=o.subMetas[e];t&&(e=path_1.basename(e,path_1.extname(e)),exports.importSubAssets.set(t.uuid,{baseUuid:o.uuid,uuid:`${o.uuid}@${base_1.ImporterBase.getNameByID(e)}`}))}else if("sprite"===o.type)for(const e in o.subMetas){const t=o.subMetas[e];t&&exports.importSubAssets.set(t.uuid,{baseUuid:o.uuid,uuid:`${o.uuid}@${base_1.ImporterBase.getNameByID("spriteFrame")}`})}else"raw"===o.type&&exports.importSubAssets.set(o.uuid,{baseUuid:o.uuid,uuid:`${o.uuid}@${base_1.ImporterBase.getNameByID("texture")}`});exports.importProjectAssets.set(o.uuid,{type:e,basePath:t,outPath:i,outUuid:o.uuid,meta:o})}}catch(e){}}exports.getDefaultAssets2D=getDefaultAssets2D,exports.scanningDefaultAssets2D=scanningDefaultAssets2D,exports.isFbxMultKey=isFbxMultKey,exports.addImportProjectAssets=addImportProjectAssets,exports.chunksCacheBy2D=new Map;const getChunks=(e,t,r)=>{const s=new Map;return function e(o){fs_extra_1.readdirSync(o).forEach(i=>{const a=path_1.join(o,i);if(t.test(i)){const e=path_1.basename(a,r),t=fs_extra_1.readFileSync(a,{encoding:"utf8"});s.set(e,{from:a,to:path_1.join(Editor.Project.path,"assets","migrate-resources","chunks",e+".chunk"),content:t,getIncludePath(e){return path_1.relative(e,this.to)}})}else fs_extra_1.statSync(a).isDirectory()&&e(a)})}(e),s};function init2DChunks(){exports.chunksCacheBy2D=getChunks(path_1.join(__dirname,"../../static/migrate-resources/chunks"),/\.inc$/,".inc")}function import2DChunks(e){return new Promise(t=>__awaiter(this,void 0,void 0,function*(){let r=0,s=!1;for(const[o,i]of exports.chunksCacheBy2D)fs_extra_1.existsSync(i.to)||(fs_extra_1.ensureDirSync(path_1.dirname(i.to)),fs_extra_1.copyFileSync(i.from,i.to),s=!0),++r>=exports.chunksCacheBy2D.size&&(s&&!e&&(yield Editor.Message.request("asset-db","refresh-asset","db://assets")),t(!0))}))}exports.init2DChunks=init2DChunks,exports.import2DChunks=import2DChunks;const migrateMap={pvrtc_4bits:"pvrtc_4bits_rgba",pvrtc_2bits:"pvrtc_2bits_rgba",etc2:"etc2_rgba",etc1:"etc1_rgb_a"},PLATFORMS=["miniGame","web","android","ios","pc"];function migratePlatformSettings(e){return __awaiter(this,void 0,void 0,function*(){if(!e||0===Object.keys(e).length)return;const t={useCompressTexture:!0,presetId:""};return e.default&&1===Object.keys(e).length?PLATFORMS.forEach(t=>{const r={};e.default.formats.forEach(e=>{r[e.name]=e.quality}),e[t]=r}):Object.keys(e).forEach(t=>{if("default"!==t){if("default"!==t){const r={};if(e.default){const t=JSON.parse(JSON.stringify(e.default));t.formats&&t.formats.forEach(e=>{r[e.name]=e.quality})}const s={};e[t].formats.forEach(e=>{s[e.name]=e.quality}),e[t]=Object.assign(r,s)}migrateCompressTextureType(e[t]),"minigame"===t&&(e.miniGame=e.minigame,delete e.minigame)}}),delete e.default,0!==Object.keys(e).length?(t.presetId=yield getPresetId(e),t):void 0})}function migrateCompressTextureType(e){e&&Object.keys(e).forEach(t=>{migrateMap[t]&&(e[migrateMap[t]]=e[t],delete e[t])})}function getPresetId(e){return __awaiter(this,void 0,void 0,function*(){const t="presetId"+Date.now();let r=yield Editor.Profile.getProject("builder","textureCompressConfig.userPreset");if(!r)return r={[t]:{name:t,options:e}},yield Editor.Profile.setProject("builder","textureCompressConfig.userPreset",r),t;for(const t of Object.keys(r))if(lodash.isEqual(r[t].options,e))return t;return yield Editor.Profile.setProject("builder",`textureCompressConfig.userPreset.${t}`,{name:t,options:e}),t})}function getBlendFactor2DTo3D(e){switch(e){case 0:return 0;case 1:return 1;case 770:return 2;case 772:return 3;case 771:return 4;case 773:return 5;case 768:return 6;case 774:return 7;case 769:return 8;case 775:return 9}return e}function hasComponent(e,t,r){for(const s of e._components){if(t[s.__id__].__type__===r)return!0}return!1}exports.migratePlatformSettings=migratePlatformSettings,exports.getBlendFactor2DTo3D=getBlendFactor2DTo3D,exports.hasComponent=hasComponent;const UI_COMPONENT=["cc.Canvas","cc.Widget","cc.Sprite","cc.Label","cc.LabelOutline","cc.LabelShadow","cc.RichText","cc.ParticleSystem","cc.TiledMap","cc.TiledTile","cc.TiledLayer","cc.TiledObjectGroup","cc.Layout","cc.Button","cc.ScrollView","cc.Slider","cc.PageView","cc.ProgressBar","cc.Toggle","cc.ToggleContainer","cc.ToggleGroup","cc.EditBox","cc.VideoPlayer","cc.WebView","cc.UITransform","cc.UIOpacity","sp.Skeleton","dragonBones.ArmatureDisplay"];function hasUIRenderComponent(e,t){if(!e._is3DNode)return!0;if(!e._components)return!1;for(const r of e._components){const e=t[r.__id__];if(e){const t=e.__type__;if(UI_COMPONENT.includes(t))return!0}}for(const r of e._children){if(hasUIRenderComponent(t[r.__id__],t))return!0}return!1}function setColor(e,t,r){if(t){const s=r[t];s&&s._color&&(e._color.r=s._color.r,e._color.g=s._color.g,e._color.b=s._color.b)}}function getFBXSubMetaNewName(e,t,r){let s=path_1.extname(t);const o=t.split("-");let i=o&&o[0];const a=path_1.basename(e,path_1.extname(e));if(i&&a===i){switch(s){case".sac":i="UnnamedAnimation";break;case".image":i="UnnamedImage";break;case".mesh":i="UnnamedMesh";break;case".mtl":i="UnnamedMaterial";break;case".skeleton":i="UnnamedSkeleton";break;case".texture":i="UnnamedTexture";break;default:i="Unnamed"}r&&(i=i+"-"+o[1])}switch(i=i.replace(s,""),s){case".sac":s=".animation";break;case".mtl":s=".material"}return i+s}function readWriteFileByLineWithProcess(e,t){return __awaiter(this,void 0,void 0,function*(){yield new Promise(r=>{const s=fs_1.createReadStream(e),o=readline_1.createInterface({input:s});o.on("line",e=>{t(e)}),o.on("close",()=>{r()})})})}function searchTmxDependImages(e,t){return __awaiter(this,void 0,void 0,function*(){const r=(new xmldom_1.DOMParser).parseFromString(t);if(!r)return void console.error(`TiledMap import failed: failed to parser ${e}`);let s=[];const o=r.documentElement,i=o.getElementsByTagName("tileset");for(let t=0;t<i.length;t++){const r=i[t],o=r.getAttribute("source");if(o){const t=path_1.join(path_1.dirname(e),o);if(fs_extra_1.existsSync(t)){const e=fs_extra_1.readFileSync(t,"utf-8"),r=(new xmldom_1.DOMParser).parseFromString(e);if(r){const e=yield parseTilesetImages(r,t);s=s.concat(e)}else console.warn("Parse %s failed.",t)}}const a=yield parseTilesetImages(r,e);s=s.concat(a)}const a=[],n=o.getElementsByTagName("imagelayer");for(let t=0,r=n.length;t<r;t++){const r=n[t].getElementsByTagName("image");if(r&&r.length>0){const t=r[0].getAttribute("source"),s=path_1.join(path_1.dirname(e),t);fs_extra_1.existsSync(s)?a.push(s):console.warn("Parse %s failed.",s)}}return s.concat(a)})}function parseTilesetImages(e,t){return __awaiter(this,void 0,void 0,function*(){const r=e.getElementsByTagName("image"),s=[];for(let e=0;e<r.length;e++){const o=r[e].getAttribute("source");if(o){const e=path_1.join(path_1.dirname(t),o);s.push(e)}}return s})}function getColor(e){if(e&&e._color)return{__type__:"cc.Color",r:e._color.r,g:e._color.g,b:e._color.b,a:e._color.a}}exports.hasUIRenderComponent=hasUIRenderComponent,exports.setColor=setColor,exports.getFBXSubMetaNewName=getFBXSubMetaNewName,exports.readWriteFileByLineWithProcess=readWriteFileByLineWithProcess,exports.searchTmxDependImages=searchTmxDependImages,exports.parseTilesetImages=parseTilesetImages,exports.getColor=getColor;const halfToRad=.5*Math.PI/180;function fromEuler(e,t,r,s){t*=halfToRad,r*=halfToRad,s*=halfToRad;const o=Math.sin(t),i=Math.cos(t),a=Math.sin(r),n=Math.cos(r),c=Math.sin(s),u=Math.cos(s);return e.x=o*n*u+i*a*c,e.y=i*a*u+o*n*c,e.z=i*n*c-o*a*u,e.w=i*n*u-o*a*c,e}function sizeSorting(e,t){const r=e.__id__;return t.__id__-r}function compareVersion(e,t){const r=e.split("."),s=t.split("."),o=Math.max(r.length,s.length);for(let e=0;e<o;e++){const t=r[e]||0,o=s[e]||0;if(Number(t)<Number(o))return-1;if(Number(t)>Number(o))return 1}return 0}function getComponentByType(e,t,r){return r[e]._components.map(e=>r[e.__id__]).find(e=>e.__type__===t)}function getDesignResolution(){return __awaiter(this,void 0,void 0,function*(){const e=yield Editor.Profile.getProject("project","general.designResolution.width"),t=yield Editor.Profile.getProject("project","general.designResolution.height");return{width:e||960,height:t||640}})}exports.fromEuler=fromEuler,exports.scriptName={allScripts:null,allClassNames:[],timer:0,fileName:"",className:"",isValid(e){return __awaiter(this,void 0,void 0,function*(){const t=this.getValidClassName(e);return t?(yield Editor.Message.request("scene","query-component-has-script",t))?{state:"errorScriptClassNameExist",message:t}:{state:""}:{state:"errorScriptClassName"}})},getValidFileName(e){return __awaiter(this,void 0,void 0,function*(){const t=e=e.trim().replace(/[^a-zA-Z0-9_-]/g,"");let r=0;for(;(yield this.isValid(e)).state;){const s=`-${(++r).toString().padStart(3,"0")}`;e=`${t}${s}`}return e})},getValidClassName(e){const t=(e=e.trim().replace(/^[^a-zA-Z]+/g,"")).match(/[a-zA-Z0-9]+/g);return t?t.filter(Boolean).map(e=>e[0].toLocaleUpperCase()+e.substr(1)).join(""):""}},exports.sizeSorting=sizeSorting,exports.compareVersion=compareVersion,exports.getComponentByType=getComponentByType,exports.getDesignResolution=getDesignResolution;const _extendIndex=[1,2,3,4,5,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,26,27,28,29,30];function nameToId(e,t){t||(t=0);const r=crypto_1.createHash("md5").update(e).digest("hex");let s=r[0]+r[6]+r[16]+r[25]+r[31];for(let e=0;e<t;e++)s+=r[_extendIndex[e]];return s}exports.nameToId=nameToId;