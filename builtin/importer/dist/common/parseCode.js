"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function d(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,d)}l((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.parseTSCode=exports.parseJSCode=void 0;const utlis_1=require("./utlis");function getType(e){if(isNaN(Number(e))&&"false"!==e&&"true"!==e&&"null"!==e&&"undefined"!==e){if(e.startsWith("[")&&e.endsWith("]"))return[];if((e=e.split("(")[0]).includes("cc"))return e}}function getInfo(e,t=!1){let i=e.split(":");if(i.length<=1&&(i=e.split("(")),i.length<=1)return{key:e,value:e};let n=i[1].trim().split(",")[0];return t||(n=n.replace(/'|"|,/g,"")),{key:i[0].trim(),value:n}}function syncIndex(e,t){let i=e.match(/\{/g);return i&&i.length>0&&(t+=i.length),(i=e.match(/\}/g))&&i.length>0&&(t-=i.length),t}function createContent(e){return{name:e,extends:"",mixins:"",editors:{},statics:{},properties:{},functions:{}}}function parseJSCode(e,t){return __awaiter(this,void 0,void 0,function*(){let i=0,n=0;const o=new Map,s=new Map,r=new Map,d=new Map,l=[];let c,a=!1,u=0,v=void 0,f=void 0,h=void 0,p=void 0,y=0,g="",C=0,W=void 0,x=0,m=void 0,I=0,S=void 0,b=0,$=void 0,_=void 0,D=0,z=0,M=void 0,k=void 0,w="",E=0,R=void 0;return yield utlis_1.readWriteFileByLineWithProcess(e,e=>{try{let B=e;if((e=e.trim()).startsWith("/")||e.startsWith("*")||!e)return;if(a){if(a){if(0===(u=syncIndex(e,u))&&(e.endsWith("});")||e.endsWith("})")||e.endsWith(");")||e.endsWith(")")||e.endsWith(";")))return a=!1,void o.set(n,c);if(void 0===_&&void 0===R&&void 0===k){if(void 0===v&&e.startsWith("name:")&&(v=!0),v)return c.name=getInfo(e).value,void(e.endsWith(",")&&(v=!1));if(void 0===f&&e.startsWith("extends:")&&(f=!0),f)return c.extends=getInfo(e).value,void(e.endsWith(",")&&(f=!1));if(void 0===h&&e.startsWith("mixins:")&&(h=!0),h)return c.mixins=getInfo(e).value,void(e.endsWith(",")&&(h=!1));if(void 0===p&&e.startsWith("editor:"))return void(p=!0);if(p){if(e.endsWith("},"))return void(p=!1);const t=getInfo(e);return void(c.editors[t.key]=t.value)}}if(void 0===_&&e.startsWith("properties:")){if(0===(y=syncIndex(e,y)))return;return void(_=!0)}if(_){if(void 0===$&&e.includes("{")){C=syncIndex(e,C);const t=getInfo(e);return g=t.key,c.properties[g]={hasGet:void 0,hasSet:void 0,notify:void 0,type:void 0,default:void 0,visible:void 0,serializable:void 0,content:""},0===C?void(c.properties[g].content=e):void($=!0)}if($){if(0===(C=syncIndex(e,C))&&(e.endsWith("},")||e.endsWith("}")))return void($=void 0);const t=c.properties[g];if(t.content+=e+"\n",void 0===W&&e.includes("get:"))return 0===(x=syncIndex(e,x))?void(t.hasGet=B+"\n"):(t.hasGet=`    get ${g} () {\n`,void(W=!0));if(W)return 0===(x=syncIndex(e,x))&&(e.endsWith("},")||e.endsWith("}"))?(W=void 0,void(t.hasGet+="    }")):void(t.hasGet+=B.substring(8,B.length)+"\n");if(void 0===m&&e.includes("set:")){I=syncIndex(e,I);let i=e.match(/(?<=\()(.*)(?=\))/);i=i?i[0].split(","):[];let n="";for(let e=0;e<i.length;++e){const t=i[e].trim();""!==t&&(e>0&&(n+=" "),n+=`${t}: any`,e<i.length-1&&(n+=","))}return 0===I?void(t.hasSet=B+"\n"):(t.hasSet=`    set ${g} (${n}) {\n`,void(m=!0))}if(m)return 0===(I=syncIndex(e,I))&&(e.endsWith("},")||e.endsWith("}"))?(m=void 0,void(t.hasSet+="    }")):void(t.hasSet+=B.substring(8,B.length)+"\n");if(void 0===S&&e.includes("notify"))return 0===(b=syncIndex(e,b))?void(t.notify=B+"\n"):(S=!0,void(t.notify=e+"\n"));if(S)return void(0===(b=syncIndex(e,b))&&(e.endsWith("},")||e.endsWith("}"))?(S=void 0,t.notify+="}"):t.notify+=e+"\n");const i=getInfo(e);void 0===t.default&&e.includes("default:")&&(t.default=i.value),void 0===t.type&&e.includes("type:")&&(t.type=i.value),void 0===t.visible&&e.includes("visible:")&&(t.visible=i.value),void 0===t.serializable&&e.includes("serializable:")&&(t.serializable=i.value)}else{if(0===(y=syncIndex(e,y))&&(e.endsWith("},")||e.endsWith("}")))return void(_=void 0);const t=getInfo(e);let i=getType(t.value);Array.isArray(i)&&(i=t.value.length>2?"array:"+t.value.substring(1,t.value.length-1):void 0);const n=t.value;c.properties[t.key]={hasGet:void 0,hasSet:void 0,notify:void 0,type:i,default:n,visible:void 0,serializable:void 0,content:e}}return}if(void 0===k&&e.startsWith("statics:")){if(0===(D=syncIndex(e,D)))return;return void(k=!0)}if(k){if(0===(D=syncIndex(e,D))&&(e.endsWith("},")||e.endsWith(",")))return k=!1,void(M=void 0);if(void 0===M&&e.includes("function")){const t=getInfo(e);z=syncIndex(e,z);let i=e.match(/(?<=\()(.*)(?=\))/);i=i?i[0].split(","):[];let n="";for(let e=0;e<i.length;++e){const t=i[e].trim();""!==t&&(e>0&&(n+=" "),n+=`${t}: any`,e<i.length-1&&(n+=","))}return 0===z?void(c.statics[t.key]={parameter:"",content:B+"\n"}):(M=t.key,void(c.statics[M]={parameter:i?i[0]:"",content:`    public static ${g} (${n}) {\n`}))}if(void 0!==M){if(0===(z=syncIndex(e,z))&&(e.endsWith("},")||e.endsWith("}")))return void(c.statics[M].content+="    }");c.statics[M].content+="    "+B.substring(8,B.length)+"\n"}else{const t=getInfo(e);c.statics[t.key]={parameter:"",content:`    public static ${t.key} = ${t.value};\n`}}return}if(void 0===R){const t=getInfo(e);w=t.key;let i=e.match(/(?<=\()(.*)(?=\))/);if(!i)return void(c.properties[t.key]={hasGet:void 0,hasSet:void 0,notify:void 0,type:void 0,default:t.value,visible:void 0,serializable:void 0,content:e});{i=i[0].split(",");let t="";for(let e=0;e<i.length;++e){const n=i[e].trim();""!==n&&(e>0&&(t+=" "),t+=`${n}: any`,e<i.length-1&&(t+=","))}if(c.functions[w]={parameter:i?i[0]:"",content:`    ${w} (${t}) {\n`},0===(E=syncIndex(e,E)))return void(c.functions[w].content+="    }\n\n");R=!0}return}if(R){if(0===(E=syncIndex(e,E))&&(e.endsWith("},")||e.endsWith("}")))return R=void 0,void(c.functions[w].content+="    }\n\n");return void(c.functions[w].content+="        //"+B.substring(8,B.length)+"\n")}}}else if(e.includes("cc.Class("))a=!0,u=1,n=o.size,c=createContent(t),o.has(n)||o.set(n,c);else if(e.includes("require"))s.set(s.size,e);else{const t=e.match(/(?<=cc.)(.*?)(?=[.|,|;|)|}|(])/),n=t&&t[0];if(n&&l.push(n),0===o.size){if(i=syncIndex(e,i),e.includes("cc.runtime")&&(i-=1,B="//"+B),n){const e=(B=n.includes("=")||n.includes("function")?B.replace(`cc.${n}`,`const ${n}`):B.replace(`cc.${n}`,n)).match(new RegExp(n,"g"));e&&e.length>1&&(B="//"+B)}r.set(r.size,B)}else o.size>0&&((i=syncIndex(e,i))<0&&(B="//"+e),d.set(d.size,B))}}catch(e){console.error(e)}}),{ccKeys:l,classCodeMap:o,importCodeMap:s,otherCodeMap:r,endCodeMap:d}})}function match(e,t,i=""){try{const n=new RegExp(`(?<=${t})([a-zA-Z0-9]+)`,i),o=e.match(n);if(o){if(i){let e=[];for(let t of o)e.push(t);return e}return o[o.length-1]}}catch(e){console.error(e)}return null}function getRegExp(e,t=""){return new RegExp(e,t)}function addCode(e,t,i=!0){return t&&(e+=t,i&&(e+="\n")),e}exports.parseJSCode=parseJSCode;const RENAME_COMPONENT={BoxCollider:"BoxCollider2D",BoxCollider3D:"BoxCollider",CircleCollider:"CircleCollider2D",Collider:"Collider2D",Collider3D:"Collider",DistanceJoint:"DistanceJoint2D",ClickEvent:"EventHandler",MouseJoint:"MouseJoint2D",WheelJoint:"WheelJoint2D",PolygonCollider:"PolygonCollider2D",ParticleSystem:"ParticleSystem2D",ParticleSystem3D:"ParticleSystem",Joint:"Joint2D",RigidBody:"RigidBody2D",RigidBody3D:"RigidBody",SphereCollider3D:"SphereCollider",RenderComponent:"UIRenderable",SkeletonAnimation:"SkeletalAnimation",Float:"CCFloat",string:"CCString",Boolean:"CCBoolean",Integer:"CCInteger"};function parseTSCode(e,t){return __awaiter(this,void 0,void 0,function*(){let i=!0,n=!1,o="",s=["_decorator"],r="",d="",l="",c="",a="",u=!1,v=!1,f=0,h=void 0,p=0,y=void 0;function g(e){return e=RENAME_COMPONENT[e]||e,s.includes(e)||s.push(e),e}function C(e,t,i){let n;if(n=match(e,i?":? (cc.)":":? ?(cc.)","g")){let e=t;for(let i of n){let n=g(i),o=getRegExp(`cc.${i}`,"g");e=t.trim().replace(/ /g,"").includes(`${i}=null`)?t.replace(o,`${n} | null`):t.replace(o,n)}let i=e.match(/([a-zA-Z0-9]+)? =? ([a-zA-Z0-9]+)/);if(i&&void 0!==i[1]&&i[1]===i[2])return;return e+"\n"}if(t)return t+"\n"}yield utlis_1.readWriteFileByLineWithProcess(t,e=>{try{let t=e;if(e=e.trim(),u){if(e.startsWith("/")||e.startsWith("*"))return void(a+=t+"\n");if(0===(f=syncIndex(e,f))&&(e.endsWith("}")||e.endsWith("};")))return a+="}\n\n",void(u=!1);if(void 0===h){let i=C(e,t);void 0!==i&&((e.includes("constructor ()")||e.includes("constructor()"))&&(y=!0),a+=i)}if(void 0===h&&e.match(/(?<=\()(.*)(?=\))/)){if(0===(p=syncIndex(e,p)))return;return void(h=!0)}if(h)return 0===(p=syncIndex(e,p))&&e.endsWith("}")?(a+=t,a+="\n",void(h=void 0)):(e?y&&e.startsWith("super();")?a+="        "+e:a+="        //"+e:a+=e,void(a+="\n"))}else if(e.includes("export default class ")||e.includes("export class ")||v){let t=match(e,"extends ?(cc.)");if(t){let i=g(t);a+=e.replace(`cc.${t}`,i)}else a+=e;if(a+="\n",0===(f=syncIndex(e,f)))return void(v=!0);v=!1,u=!0}else if(e.startsWith("/")||e.startsWith("*"))i?o+=t+"\n":n&&(d+=t+"\n");else if(e.includes("cc._decorator"))i=!1,r+=t.replace(/cc._decorator/,"_decorator")+"\n";else if(e.includes("@ccclass"))c=t;else if(e.startsWith("@"))l+=t;else{if(n=!0,!e)return;let i=C(e,t);void 0===i?d+=`// ${t}\n`:i&&(d+=i)}}catch(e){console.error(e)}});let W="";W=addCode(W,o);let x="import { ";for(let e=0;e<s.length;++e)x+=s[e],e<s.length-1&&(x+=", ");return{content:W=addCode(W=addCode(W=addCode(W=addCode(W=addCode(W=addCode(W,x+=" } from 'cc';"),r),d),c.replace(/@ccclass/,`@ccclass('${e}')`)),l),a)}})}exports.parseTSCode=parseTSCode;