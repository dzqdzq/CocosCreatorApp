"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.API=void 0;const fs=__importStar(require("fs-extra")),Network=require("../../../utils/network"),Constant=require("../const"),MAX_APK_SIZE=4294967296,{AuditInfo:AuditInfo,AppInfo:AppInfo,ErrorCode:ErrorCode,AccessTokenRet:AccessTokenRet,AppInfoRet:AppInfoRet,UploadUrlRet:UploadUrlRet,UploadRet:UploadRet,UpdateAPKRet:UpdateAPKRet}=require("./entity");class API{constructor(e,t,r){this.loginType=e,this.accessToken=t,e===Constant.LOGIN_TYPE.client&&(this.clientID=r)}get oAuthLogin(){return this.loginType===Constant.LOGIN_TYPE.oauth}genHeader(){let e={};return this.oAuthLogin?e.oauth2Token=this.accessToken:(e.Authorization=`Bearer ${this.accessToken}`,e.client_id=this.clientID),e}static async getAccessToken(e,t){let r=new AccessTokenRet,o=API.HOST+"/api/oauth2/v1/token",s={grant_type:"client_credentials",client_id:e,client_secret:t};try{let e=await Network.postAsync(o,JSON.stringify(s));(e=JSON.parse(e)).access_token&&(r.code=ErrorCode.success,r.accessToken=e.access_token)}catch(e){r.errorMessage=e}return r}async queryAppInfo(e){let t=new AppInfoRet,r=API.HOST+"/api/publish/v2/app-info",o={appId:e};try{let e=await Network.getAsync(r,o,this.genHeader());0===(e=JSON.parse(e)).ret.code&&(t.code=ErrorCode.success,e.appInfo=new AppInfo(e.appInfo),e.auditInfo=new AuditInfo(e.auditInfo))}catch(e){t.errorMessage=e}return t}async getUploadUrl(e,t){let r=new UploadUrlRet,o=API.HOST+"/api/publish/v2/upload-url",s={appId:e,suffix:t||"apk"};try{let e=await Network.getAsync(o,s,this.genHeader());(e=JSON.parse(e)).uploadUrl&&(r.code=ErrorCode.success,r.uploadUrl=e.uploadUrl,e.chunkUploadUrl&&(r.chunkUploadUrl=e.chunkUploadUrl),r.authCode=e.authCode)}catch(e){r.errorMessage=e}return r}async uploadFile(e,t,r){let o=new UploadRet;if(!fs.existsSync(t))return o.code=ErrorCode.fileNotExists,o;if(fs.statSync(t).size>MAX_APK_SIZE)return o.code=ErrorCode.fileTooLarge,o;try{let s=await Network.uploadFile(e,t,r);(s=(s=JSON.parse(s)).result).UploadFileRsp&&s.UploadFileRsp.ifSuccess&&(o.code=ErrorCode.success,o.files=s.UploadFileRsp.fileInfoList.map(e=>({fileDestUrl:e.fileDestUlr,size:e.size})))}catch(e){o.errorMessage=e}return o}async updateApkInfo(e,t,r,o=1){let s=new UpdateAPKRet,a=API.HOST+"/api/publish/v2/app-file-info";try{let n={appId:e,releaseType:o},i={fileType:5,files:[{fileName:t,fileDestUrl:r}]},c=await Network.putAsync(a,n,this.genHeader(),JSON.stringify(i));0===(c=(c=JSON.parse(c)).ret).code?s.code=ErrorCode.success:s.errorMessage=c.msg}catch(e){s.errorMessage=e}return s}}exports.API=API,API.HOST="https://connect-api.cloud.huawei.com";