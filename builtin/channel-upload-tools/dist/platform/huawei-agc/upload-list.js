"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,a){void 0===a&&(a=t),Object.defineProperty(e,a,{enumerable:!0,get:function(){return o[t]}})}:function(e,o,t,a){void 0===a&&(a=t),e[a]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),Constant=require("./const"),Http=require("./lib/http"),{API:API}=require("./lib/api"),{ErrorCode:ErrorCode}=require("./lib/entity");let Pkg=require("../../../package.json");var UPLOAD_STATE;let comp;!function(e){e[e.fail=0]="fail",e[e.idle=1]="idle",e[e.fetch_token=2]="fetch_token",e[e.fetch_token_fail=3]="fetch_token_fail",e[e.fetch_url=4]="fetch_url",e[e.fetch_url_fail=5]="fetch_url_fail",e[e.upload=6]="upload",e[e.upload_fail=7]="upload_fail",e[e.update_info=8]="update_info",e[e.update_info_fail=9]="update_info_fail",e[e.success=10]="success",e[e.cancel=11]="cancel"}(UPLOAD_STATE||(UPLOAD_STATE={})),module.exports={name:`${Constant.PLATFORM}-upload-list`,template:fs.readFileSync(path_1.default.join(__dirname,"../../../static",`platform/${Constant.PLATFORM}/upload-list.html`),"utf8"),props:["info","compName"],data:function(){return{toggle:!1,uploadProgress:0,pause:!1,uploadState:UPLOAD_STATE.idle,progressTips:"",history:[],page:this.compName,cancel:!1}},async created(){comp=this,await comp.loadHistory(),comp.needUpload&&(await comp.prepareApi(),await comp.uploadApk())},watch:{history:{deep:!0,async handler(){await comp.save()}},page:function(e){comp.$emit("update:compName",e)}},computed:{btnStatus:()=>comp.pause?comp.t("resume"):comp.t("pause"),historyTips:()=>(comp.toggle?"▼ ":"▶ ")+comp.t("history"),uploading:()=>!!comp.info.config&&comp.info.config.version&&comp.uploadState!==UPLOAD_STATE.success&&comp.uploadState!==UPLOAD_STATE.cancel,needUpload:()=>!!comp.info.config&&comp.info.config.version,showBtns:()=>!comp.cancel&&comp.uploading},methods:{toggleClick(){comp.toggle=!comp.toggle},returnClick(){comp.cancelClick(),comp.page=`${Constant.PLATFORM}-upload`},cancelClick(){comp.cancel=!0,comp.checkCancel()},async loadHistory(){comp.history=await Editor.Profile.getConfig(Pkg.name,`options.${Constant.PLATFORM}.history`,"local")||[]},addHistory(){comp.history.length>=Constant.MAX_HISTORY_LENGTH&&comp.history.pop(),comp.history.unshift({time:Date.now(),description:comp.info.config.description,version:comp.info.config.version})},changeState(e){let o=comp.getStateKey(e);comp.uploadState=e,comp.progressTips=comp.t(o)},getStateKey(e){for(let o in UPLOAD_STATE)if(e===UPLOAD_STATE[o])return o},formatTime:e=>new Date(e).toLocaleString("zh"===Editor.I18n.getLanguage()?"zh-cn":"en"),async save(){Editor.Profile.setConfig(Pkg.name,`options.${Constant.PLATFORM}.history`,comp.history,"local")},checkCancel:()=>!!comp.cancel&&(comp.uploadProgress=0,comp.changeState(UPLOAD_STATE.cancel),!0),async prepareApi(){let e;if(comp.info.config.loginType===Constant.LOGIN_TYPE.oauth)e=await Http.getOAuthToken();else{e=(await API.getAccessToken(comp.info.config.clientId,comp.info.config.clientSecret)).accessToken}comp.api=new API(comp.info.config.loginType,e,comp.info.config.clientId)},async uploadApk(){if(comp.uploadProgress=10,comp.checkCancel())return;comp.uploadProgress=20,comp.changeState(UPLOAD_STATE.fetch_url);let e=await comp.api.getUploadUrl(comp.info.config.appid,"apk");if(e.code!==ErrorCode.success)return comp.changeState(UPLOAD_STATE.fetch_url_fail),void console.error("Fetch upload url fail,",e.errorMessage);if(comp.checkCancel())return;comp.uploadProgress=30,comp.changeState(UPLOAD_STATE.upload);let o=await comp.api.uploadFile(e.uploadUrl,comp.info.config.apkPath,e.authCode);if(o.code!==ErrorCode.success)return comp.changeState(UPLOAD_STATE.upload_fail),void console.error("Upload fail,",o.errorMessage);if(comp.checkCancel())return;comp.uploadProgress=90;let t=path_1.default.basename(comp.info.config.apkPath);comp.changeState(UPLOAD_STATE.update_info);let a=await comp.api.updateApkInfo(comp.info.config.appid,t,o.files[0].fileDestUrl);if(a.code!==ErrorCode.success)return comp.changeState(UPLOAD_STATE.update_info_fail),void console.error("Update apk info fail,",a.errorMessage);comp.changeState(UPLOAD_STATE.success),comp.uploadProgress=100,comp.addHistory()},t:e=>Editor.I18n.t(`channel-upload-tools.${e}`)}};