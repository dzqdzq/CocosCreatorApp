"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,o,n){void 0===n&&(n=o),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[o]}})}:function(t,e,o,n){void 0===n&&(n=o),t[n]=e[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)"default"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&__createBinding(e,t,o);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),Constant=require("./const"),Http=require("./lib/http");let comp;module.exports={platform:Constant.PLATFORM,name:`${Constant.PLATFORM}-upload`,template:fs.readFileSync(path_1.default.join(__dirname,"../../../static",`platform/${Constant.PLATFORM}/upload.html`),"utf8"),props:["info","compName"],computed:{oAuth(){return this.config.loginType===Constant.LOGIN_TYPE.oauth},showLoginBtn(){return this.oAuth&&this.needLogin},isLogin(){return!this.needLogin&&this.oAuth}},watch:{page:function(t){comp.$emit("update:compName",t)},info(t){comp.$emit("update:info",t)},async"config.loginType"(t){if(t===Constant.LOGIN_TYPE.oauth){if(comp.loginChecked)return;await comp.checkNeedLogin()}},config:{async handler(t){let e=await Editor.Profile.getConfig(Constant.PLATFORM)||{};e=Object.assign(e,t),Editor.Profile.setConfig(Constant.PLATFORM,"config",e,"local")},deep:!0}},data:function(){return{config:{loginType:Constant.LOGIN_TYPE.oauth,clientId:"",clientSecret:"",appid:"",version:"1.0",apkPath:"",description:""},page:this.compName,loginChecked:!1,loading:!1,needLogin:!0,accessToken:"",loginType:[{type:Constant.LOGIN_TYPE.oauth,name:this.t("oauth")},{type:Constant.LOGIN_TYPE.client,name:this.t("client")}]}},async created(){let t=this;global.xxxx=this,comp=t,t._registerEvent();let e=await Editor.Profile.getConfig(Constant.PLATFORM,"config")||{};e&&Object.keys(t.config).forEach(o=>{let n=e[o];n&&(t.config[o]=n)}),t.config.loginType===Constant.LOGIN_TYPE.oauth&&await t.checkNeedLogin()},methods:{oauthTypeChange(t){this.config.loginType=t.target.value},async checkNeedLogin(){let t=this;await Editor.User.isLoggedIn()?(t.loading=!0,t.needLogin=await Http.needLogin(),t.loading=!1,t.loginChecked=!0):t.popupWarns(comp.t("need_login"))},_registerEvent(){this.$root.$on("loginResult",this.updateLoginResult),this.$root.$on("oAuthWindowClose",this.oAuthWindowClose)},async updateLoginResult(t,e){let o=this;t===module.exports.platform&&"success"===e&&(o.needLogin=await Http.needLogin(),o.accessToken=await Http.getOAuthToken(),o.loading=!1)},async oAuthWindowClose(){comp.needLogin=await Http.needLogin(),comp.loading=!1},async onChooseDistPathClick(t){t.stopPropagation()},async onUpdateValue(t,e){t.stopPropagation(),t.target.value&&(comp.config[e]=t.target.value)},cancelClick(){Editor.Panel.close("channel-upload-tools")},popupWarns:t=>Editor.Dialog.info(t,{title:comp.t("notice_title"),buttons:[comp.t("confirm")],default:-1,cancel:-1}),async oauthClick(){if(comp.loading=!0,!await Editor.User.isLoggedIn())return comp.loading=!1,comp.popupWarns(comp.t("need_login"));let t=await Http.getOAuthUrl();t?Editor.Panel.open("channel-upload-tools.oauth",{platform:Constant.PLATFORM,url:t.url,redirect:t.redirect,method:"loginResult"}):console.error("Get OAuth url fail, please retry")},async uploadClick(){let t=this;if(t.config.version)if(t.config.appid)if(t.config.apkPath&&fs.existsSync(path_1.default.normalize(t.config.apkPath)))if(t.oAuth||t.config.clientId)if(t.oAuth||t.config.clientSecret)if(t.oAuth&&t.needLogin){0===(await t.popupWarns(t.t("need_huawei_login"))).response&&t.oauthClick()}else t.info.config=t.config,t.page=`${Constant.PLATFORM}-upload-list`;else t.popupWarns(t.t("need_client_secret"));else t.popupWarns(t.t("need_clientid"));else t.popupWarns(t.t("need_apk"));else t.popupWarns(t.t("need_appid"));else t.popupWarns(t.t("need_version"))},async logoutClick(){comp.loading=!0;try{await Http.logout(),await comp.checkNeedLogin()}catch(t){}comp.loading=!1},t:t=>Editor.I18n.t(`channel-upload-tools.${t}`)}};