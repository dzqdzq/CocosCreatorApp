"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,a,r){void 0===r&&(r=a),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[a]}})}:function(t,e,a,r){void 0===r&&(r=a),t[r]=e[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var a in t)"default"!==a&&Object.prototype.hasOwnProperty.call(t,a)&&__createBinding(e,t,a);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.thumbnail=exports.twinkle=exports.closestWhichCanCreate=exports.scrollIntoView=exports.isAIncludeB=exports.getChildrenUuid=exports.getDirectory=exports.getSibling=exports.getParent=exports.getChildrenForPreview=exports.getAssetForPreview=exports.getAsset=exports.scriptName=exports.isSearchingMode=exports.canNotReimport=exports.canNotRevealInLibrary=exports.canNotRevealInExplorer=exports.canNotDrop=exports.isEmptyToPaste=exports.canNotPaste=exports.canNotDrag=exports.canNotRename=exports.canNotCut=exports.canNotDuplicate=exports.canNotCopy=exports.canNotCreate=exports.canNotDelete=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),url_1=require("url"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function canNotDelete(t){return!t||t.isDB||t.readonly||t.isSubAsset}function canNotCreate(t){return!t||t.isSubAsset||t.readonly||!t.isDirectory}function canNotCopy(t){return!t||t.isDB||t.isSubAsset}function canNotDuplicate(t){if(!t||!t.uuid)return!0;const e=treeData.uuidToParentUuid[t.uuid];return e&&canNotCreate(treeData.uuidToAsset[e])}function canNotCut(t){return canNotDelete(t)}function canNotRename(t){return canNotDelete(t)}function canNotDrag(t){return!t||t.isDB}function canNotPaste(t){return!t||t.isSubAsset||t.readonly||!t.isDirectory}function isEmptyToPaste(){return!panelData.$.tree.copiedUuids.length&&!panelData.$.tree.cutUuids.length}function canNotDrop(t){return!t||t.readonly}function canNotRevealInExplorer(t){return!t||!t.file||t.isSubAsset}function canNotRevealInLibrary(t){return!t||0===Object.keys(t.library).length}function canNotReimport(t){return!t||t.isDB}function isSearchingMode(){const t=panelData.$.panel;if(!t)return!1;const{searchValue:e,searchType:a,searchInFolder:r,searchAssetTypes:n}=t;return""!==e||"fails"===a||r||!!n.length}function getAsset(t){return t?treeData.uuidToAsset[t]:null}async function getAssetForPreview(t,e){if(!t||e)return null;const a=treeData.uuidToAsset[t];return a||await Editor.Message.request("assets","query-asset",t,!0)}async function getChildrenForPreview(t,e){if(!t||e)return null;const a=treeData.uuidToChildren[t];return a&&a.length?a.map(t=>treeData.uuidToAsset[t]).filter(Boolean):await Editor.Message.request("assets","query-children",t,!0)}function getParent(t){if(!t)return null;return getAsset(treeData.uuidToParentUuid[t])}function getSibling(t){const{displayArray:e,uuidToAsset:a}=treeData,r=e.indexOf(t),n=e.length-1;let i=r-1,s=r+1;return 0===r&&(i=n),r===e.length-1&&(s=0),[a[t],a[e[i]],a[e[s]]]}function getDirectory(t){const e=getAsset(t);return!!e&&(e.isDirectory?e:getDirectory(treeData.uuidToParentUuid[t]))}function getChildrenUuid(t,e,a=!1,r=!1){const n=treeData.uuidToChildren[t];if(!n)return;if(a&&!treeData.uuidToExpand[t])return;const i=n.length;for(let t=0;t<i;t++){const i=n[t],s=getAsset(i);if(s&&(e.push(i),s.isParent)){if(r&&!s.isDirectory)continue;getChildrenUuid(i,e,a,r)}}}function isAIncludeB(t,e){const a=treeData.uuidToAsset[t],r=treeData.uuidToAsset[e];return!(!a||!r)&&r.url.startsWith(`${a.url}/`)}function scrollIntoView(t,e=!1){const a=getAsset(t);if(!a)return;treeData.pointExpand(t);const r=panelData.$.tree.scrollTop,n=panelData.$.tree.scrollTop+panelData.$.viewBox.clientHeight-panelData.config.assetHeight-4,i=panelData.$.viewBox.offsetWidth,s=panelData.$.viewBox.scrollWidth;let o=panelData.$.viewBox.scrollLeft,c=panelData.$.viewBox.scrollTop;const u=o>a.left,l=i<s&&.3*i<a.left-o;(u||l)&&(o=a.left-2*panelData.config.iconWidth);const p=treeData.displayArray.indexOf(t)*panelData.config.assetHeight;e?c=p-panelData.$.viewBox.clientHeight/2:p<=r?c=p:p>=n&&(c=p-panelData.$.viewBox.clientHeight+panelData.config.assetHeight+4,setTimeout(()=>{c=p-panelData.$.viewBox.clientHeight+panelData.config.assetHeight+4,panelData.$.viewBox.scrollWidth!==panelData.$.viewBox.clientWidth&&(c+=10),panelData.$.viewBox.scrollTo(o,c)},100)),panelData.$.tree.$nextTick(()=>{panelData.$.viewBox.scrollTo(o,c)})}function closestWhichCanCreate(t){const e=getAsset(t);return e?canNotCreate(e)?closestWhichCanCreate(treeData.uuidToParentUuid[t]):e:null}exports.canNotDelete=canNotDelete,exports.canNotCreate=canNotCreate,exports.canNotCopy=canNotCopy,exports.canNotDuplicate=canNotDuplicate,exports.canNotCut=canNotCut,exports.canNotRename=canNotRename,exports.canNotDrag=canNotDrag,exports.canNotPaste=canNotPaste,exports.isEmptyToPaste=isEmptyToPaste,exports.canNotDrop=canNotDrop,exports.canNotRevealInExplorer=canNotRevealInExplorer,exports.canNotRevealInLibrary=canNotRevealInLibrary,exports.canNotReimport=canNotReimport,exports.isSearchingMode=isSearchingMode,exports.scriptName={allScripts:null,allClassNames:[],timer:0,fileName:"",className:"",async isValid(t){const e=this.getValidClassName(t);return e?await Editor.Message.request("scene","query-component-has-script",e)?{state:"errorScriptClassNameExist",message:e}:{state:""}:{state:"errorScriptClassName"}},async getValidFileName(t){(t=t.trim().replace(/[^a-zA-Z0-9_-]/g,""))&&!isFinite(t)||(t="NewComponent");const e=t;let a=0;for(;(await this.isValid(t)).state;){t=`${e}${`-${(++a).toString().padStart(3,"0")}`}`}return t},getValidClassName(t){const e=(t=t.trim().replace(/^[^a-zA-Z_]+/g,"")).match(/[a-zA-Z0-9_]+/g);return e?e.join("_"):""}},exports.getAsset=getAsset,exports.getAssetForPreview=getAssetForPreview,exports.getChildrenForPreview=getChildrenForPreview,exports.getParent=getParent,exports.getSibling=getSibling,exports.getDirectory=getDirectory,exports.getChildrenUuid=getChildrenUuid,exports.isAIncludeB=isAIncludeB,exports.scrollIntoView=scrollIntoView,exports.closestWhichCanCreate=closestWhichCanCreate,exports.twinkle={requestAnimationId:0,watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(t,e="shake"){this.watch&&(panelData.act.twinkles[t]=e,setTimeout(()=>{panelData.act.twinkles[t]=void 0,delete panelData.act.twinkles[t],window.cancelAnimationFrame(this.requestAnimationId),this.requestAnimationId=requestAnimationFrame(()=>{panelData.$.tree.render()})},1e3))}},exports.thumbnail={dbInfos:{},emptyMark:"none",async get(t){const e=url_1.parse(t.path);let a=this.dbInfos[e.host];if(!a){a=await Editor.Message.request("asset-db","query-db-info",e.host),this.dbInfos[e.host]=a;const t=path_1.join(a.temp,"thumbnail");fs_extra_1.existsSync(t)&&fs_extra_1.removeSync(t)}const r=t.uuid.split("@")[0],n=path_1.join(a.temp,"thumbnail",r,t.uuid);if(fs_extra_1.existsSync(n)){return fs_extra_1.readFileSync(n,"utf8")}return n},async set(t,e,a={}){if(t===this.emptyMark)return fs_extra_1.outputFileSync(e,t),t;const r=document.createElement("img");r.src=t.replace("#","%23");const n=await new Promise(t=>{r.addEventListener("load",()=>{t(r)}),r.addEventListener("error",()=>{t(!1)})});if(!1===n)return n;let i=a.width||r.width,s=a.height||r.height;const o=Math.max(i,s)/32,c=document.createElement("canvas");c.width=32,c.height=32;const u=c.getContext("2d");if(a.rotated){const t=c.width/2,e=c.height/2;u.translate(t,e),u.rotate(-90*Math.PI/180),u.translate(-t,-e),i=a.height,s=a.width}u.drawImage(r,a.trimX||0,a.trimY||0,i,s,(32-i/o)/2,(32-s/o)/2,i/o,s/o);const l=c.toDataURL("image/*");return fs_extra_1.outputFileSync(e,l),l},delete(t){const e=getAsset(t);if(!e)return;const a=url_1.parse(e.path),r=this.dbInfos[a.host];if(!r)return;const n=path_1.join(r.temp,"thumbnail",e.uuid);if(fs_extra_1.existsSync(n)){fs_extra_1.removeSync(n);const e=treeData.uuidToChildren[t];if(e){const t=e.length;for(let a=0;a<t;a++)this.delete(e[a])}}},async image(t,e=""){let a=path_1.extname(t.name).toLowerCase();if(e)return[".tga",".hdr",".bmp"].includes(a)&&(a=".png"),t.library[a];const r=await this.get(t);if(!r||r===this.emptyMark||r.startsWith("data:image"))return r;const n=this.getLibraryImageSrc(t.library,a),i=await this.set(`${n}?${t.refreshTime}`,r);return!1===i&&console.warn(`Load thumbnail failed: ${t.url}`),i},async subImage(t,e=""){if(e)return await this.subImageOrigin(t);const a=await this.get(t);if(!a||a===this.emptyMark||a.startsWith("data:image"))return a;const r=await Editor.Message.request("asset-db","query-asset-meta",t.uuid);if(!r||!r.userData)return this.set(this.emptyMark,a);let n=r.userData.imageUuidOrDatabaseUri;if("gltf-embeded-image"===r.importer?n=r.uuid:"texture-cube-face"===r.importer?n=r.uuid:"sprite-frame"===r.importer&&(n=r.userData.imageUuidOrDatabaseUri.split("@")[0]),!n)return this.set(this.emptyMark,a);const i=getAsset(n);if(!i)return this.set(this.emptyMark,a);const s=path_1.extname(i.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(i.library,s);return await this.set(`${o}?${t.refreshTime}`,a,r.userData)},async subImageOrigin(t){const e=await Editor.Message.request("asset-db","query-asset-meta",t.uuid);if(!e||!e.userData)return this.emptyMark;const{userData:a}=e,r=(a.imageUuidOrDatabaseUri||e.uuid).split("@");r.length>1&&r.pop();const n=r.join("@"),i=await getAssetForPreview(n);if(!i)return this.emptyMark;const s=path_1.extname(i.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(i.library,s);if(!o){const t=await getAssetForPreview(e.uuid);if(!t||!t.library)return"none";const a=[".png",".jpg",".jpge"];for(const e of a)if(e in t.library)return t.library[e];return"none"}const c=document.createElement("img");if(c.src=`${o.replace("#","%23")}?${t.refreshTime}`,!1===await new Promise(t=>{c.addEventListener("load",()=>{t(c)}),c.addEventListener("error",()=>{t(!1)})}))return this.emptyMark;let u=a.width||c.width,l=a.height||c.height;const p=document.createElement("canvas"),d=p.getContext("2d");if(p.width=u,p.height=l,a.rotated){const t=p.width/2,e=p.height/2;d.translate(t,e),d.rotate(-90*Math.PI/180),d.translate(-t,-e),u=a.height,l=a.width}return d.drawImage(c,a.trimX||0,a.trimY||0,u,l,0,0,u,l),p.toDataURL("image/png")},getLibraryImageSrc(t,e){let a=t[e];if(!a){a=t[Object.keys(t).find(t=>".json"!==t)||""]}return a}};