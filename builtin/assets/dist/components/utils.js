"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.thumbnail=exports.twinkle=exports.closestWhichCanCreate=exports.scrollIntoView=exports.isAIncludeB=exports.getChildrenUuid=exports.getDirectory=exports.getSibling=exports.getParent=exports.getChildrenForPreview=exports.getAssetForPreview=exports.getAsset=exports.scriptName=exports.isSearchingMode=exports.canNotReimport=exports.canNotRevealInLibrary=exports.canNotRevealInExplorer=exports.canNotDrop=exports.isEmptyToPaste=exports.canNotPaste=exports.canNotDrag=exports.canNotRename=exports.canNotCut=exports.canNotDuplicate=exports.canNotCopy=exports.canNotCreate=exports.canNotDelete=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),url_1=require("url"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data"));function canNotDelete(e){return!e||e.isDB||e.readonly||e.isSubAsset}function canNotCreate(e){return!e||e.isSubAsset||e.readonly||!e.isDirectory}function canNotCopy(e){return!e||e.isDB||e.isSubAsset}function canNotDuplicate(e){if(!e||!e.uuid)return!0;const t=treeData.uuidToParentUuid[e.uuid];return t&&canNotCreate(treeData.uuidToAsset[t])}function canNotCut(e){return canNotDelete(e)}function canNotRename(e){return canNotDelete(e)}function canNotDrag(e){return!e||e.isDB}function canNotPaste(e){return!e||e.isSubAsset||e.readonly||!e.isDirectory}function isEmptyToPaste(){return!panelData.$.tree.copiedUuids.length&&!panelData.$.tree.cutUuids.length}function canNotDrop(e){return!e||e.readonly}function canNotRevealInExplorer(e){return!e||!e.file||e.isSubAsset}function canNotRevealInLibrary(e){return!e||0===Object.keys(e.library).length}function canNotReimport(e){return!e||e.isDB}function isSearchingMode(){return!!panelData.$.panel&&(""!==panelData.$.panel.searchValue||panelData.$.panel.searchInFolder||!!panelData.$.panel.searchAssetTypes.length)}function getAsset(e){return e?treeData.uuidToAsset[e]:null}async function getAssetForPreview(e,t){if(!e||t)return null;const a=treeData.uuidToAsset[e];return a||await Editor.Message.request("assets","query-asset",e,!0)}async function getChildrenForPreview(e,t){if(!e||t)return null;const a=treeData.uuidToChildren[e];return a&&a.length?a.map(e=>treeData.uuidToAsset[e]).filter(Boolean):await Editor.Message.request("assets","query-children",e,!0)}function getParent(e){if(!e)return null;return getAsset(treeData.uuidToParentUuid[e])}function getSibling(e){const{displayArray:t,uuidToAsset:a}=treeData,r=t.indexOf(e),n=t.length-1;let i=r-1,s=r+1;return 0===r&&(i=n),r===t.length-1&&(s=0),[a[e],a[t[i]],a[t[s]]]}function getDirectory(e){const t=getAsset(e);return!!t&&(t.isDirectory?t:getDirectory(treeData.uuidToParentUuid[e]))}function getChildrenUuid(e,t,a=!1,r=!1){const n=treeData.uuidToChildren[e];if(!n)return;if(a&&!treeData.uuidToExpand[e])return;const i=n.length;for(let e=0;e<i;e++){const i=n[e],s=getAsset(i);if(s&&(t.push(i),s.isParent)){if(r&&!s.isDirectory)continue;getChildrenUuid(i,t,a,r)}}}function isAIncludeB(e,t){const a=treeData.uuidToAsset[e],r=treeData.uuidToAsset[t];return!(!a||!r)&&r.url.startsWith(`${a.url}/`)}function scrollIntoView(e,t=!1){const a=getAsset(e);if(!a)return;treeData.pointExpand(e);const r=panelData.$.tree.scrollTop,n=panelData.$.tree.scrollTop+panelData.$.panel.viewHeight-panelData.config.assetHeight-4,i=panelData.$.viewBox.offsetWidth,s=panelData.$.viewBox.scrollWidth;let o=panelData.$.viewBox.scrollLeft,c=panelData.$.viewBox.scrollTop;const l=o>a.left,u=i<s&&.3*i<a.left-o;(l||u)&&(o=a.left-2*panelData.config.iconWidth);const p=treeData.displayArray.indexOf(e)*panelData.config.assetHeight;t?c=p-panelData.$.panel.viewHeight/2:p<=r?c=p:p>=n&&(c=p-panelData.$.panel.viewHeight+panelData.config.assetHeight+4,setTimeout(()=>{c=p-panelData.$.panel.viewHeight+panelData.config.assetHeight+4,panelData.$.viewBox.scrollWidth!==panelData.$.viewBox.clientWidth&&(c+=10),panelData.$.viewBox.scrollTo(o,c)},100)),panelData.$.tree.$nextTick(()=>{panelData.$.viewBox.scrollTo(o,c)})}function closestWhichCanCreate(e){const t=getAsset(e);return t?canNotCreate(t)?closestWhichCanCreate(treeData.uuidToParentUuid[e]):t:null}exports.canNotDelete=canNotDelete,exports.canNotCreate=canNotCreate,exports.canNotCopy=canNotCopy,exports.canNotDuplicate=canNotDuplicate,exports.canNotCut=canNotCut,exports.canNotRename=canNotRename,exports.canNotDrag=canNotDrag,exports.canNotPaste=canNotPaste,exports.isEmptyToPaste=isEmptyToPaste,exports.canNotDrop=canNotDrop,exports.canNotRevealInExplorer=canNotRevealInExplorer,exports.canNotRevealInLibrary=canNotRevealInLibrary,exports.canNotReimport=canNotReimport,exports.isSearchingMode=isSearchingMode,exports.scriptName={allScripts:null,allClassNames:[],timer:0,fileName:"",className:"",async isValid(e){const t=this.getValidClassName(e);return t?await Editor.Message.request("scene","query-component-has-script",t)?{state:"errorScriptClassNameExist",message:t}:{state:""}:{state:"errorScriptClassName"}},async getValidFileName(e){const t=e=e.trim().replace(/[^a-zA-Z0-9_-]/g,"");let a=0;for(;(await this.isValid(e)).state;){e=`${t}${`-${(++a).toString().padStart(3,"0")}`}`}return e},getValidClassName(e){const t=(e=e.trim().replace(/^[^a-zA-Z]+/g,"")).match(/[a-zA-Z0-9]+/g);return t?t.filter(Boolean).map(e=>e[0].toLocaleUpperCase()+e.substr(1)).join(""):""}},exports.getAsset=getAsset,exports.getAssetForPreview=getAssetForPreview,exports.getChildrenForPreview=getChildrenForPreview,exports.getParent=getParent,exports.getSibling=getSibling,exports.getDirectory=getDirectory,exports.getChildrenUuid=getChildrenUuid,exports.isAIncludeB=isAIncludeB,exports.scrollIntoView=scrollIntoView,exports.closestWhichCanCreate=closestWhichCanCreate,exports.twinkle={requestAnimationId:0,watch:!0,start(){this.watch=!0},stop(){this.watch=!1},add(e,t="shake"){this.watch&&(panelData.act.twinkles[e]=t,setTimeout(()=>{panelData.act.twinkles[e]=void 0,delete panelData.act.twinkles[e],window.cancelAnimationFrame(this.requestAnimationId),this.requestAnimationId=requestAnimationFrame(()=>{panelData.$.tree.render()})},1e3))}},exports.thumbnail={dbInfos:{},async get(e){const t=url_1.parse(e.path);let a=this.dbInfos[t.host];if(!a){a=await Editor.Message.request("asset-db","query-db-info",t.host),this.dbInfos[t.host]=a;const e=path_1.join(a.temp,"thumbnail");fs_extra_1.existsSync(e)&&fs_extra_1.removeSync(e)}const r=e.uuid.split("@")[0],n=path_1.join(a.temp,"thumbnail",r,e.uuid);if(fs_extra_1.existsSync(n)){return fs_extra_1.readFileSync(n,"utf8")}return n},async set(e,t,a={}){const r=document.createElement("img");r.src=e;const n=await new Promise(e=>{r.addEventListener("load",()=>{e(r)}),r.addEventListener("error",()=>{e(!1)})});if(!1===n)return n;let i=a.width||r.width,s=a.height||r.height;const o=Math.max(i,s)/32,c=document.createElement("canvas");c.width=32,c.height=32;const l=c.getContext("2d");if(a.rotated){const e=c.width/2,t=c.height/2;l.translate(e,t),l.rotate(-90*Math.PI/180),l.translate(-e,-t),i=a.height,s=a.width}l.drawImage(r,a.trimX||0,a.trimY||0,i,s,(32-i/o)/2,(32-s/o)/2,i/o,s/o);const u=c.toDataURL("image/*");return fs_extra_1.outputFileSync(t,u),u},delete(e){const t=getAsset(e);if(!t)return;const a=url_1.parse(t.path),r=this.dbInfos[a.host];if(!r)return;const n=path_1.join(r.temp,"thumbnail",t.uuid);if(fs_extra_1.existsSync(n)){fs_extra_1.removeSync(n);const t=treeData.uuidToChildren[e];if(t){const e=t.length;for(let a=0;a<e;a++)this.delete(t[a])}}},async image(e,t=""){if(t){return e.library[`${".tga"===e.fileExt?".png":path_1.extname(e.name).toLowerCase()}`]}const a=await this.get(e);if(!a||a.startsWith("data:image"))return a;const r=this.getLibraryImageSrc(e.library,e.fileExt),n=await this.set(`${r}?${e.refreshTime}`,a);return!1===n&&console.warn(`Load thumbnail failed: ${e.url}`),n},async subImage(e,t=""){if(t)return await this.subImageOrigin(e);const a=await this.get(e);if(!a||a.startsWith("data:image"))return a;const r=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!r||!r.userData)return"none";let n=r.userData.imageUuidOrDatabaseUri;if("gltf-embeded-image"===r.importer?n=r.uuid:"sprite-frame"===r.importer&&(n=r.userData.imageUuidOrDatabaseUri.split("@")[0]),!n)return"";const i=getAsset(n);if(!i)return"none";const s=path_1.extname(i.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(i.library,s);return await this.set(`${o}?${e.refreshTime}`,a,r.userData)},async subImageOrigin(e){const t=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!t||!t.userData)return"none";const{userData:a}=t,r=(a.imageUuidOrDatabaseUri||t.uuid).split("@")[0],n=await getAssetForPreview(r);if(!n)return"none";const i=path_1.extname(n.name).toLocaleLowerCase(),s=this.getLibraryImageSrc(n.library,i);if(!s){const e=await getAssetForPreview(t.uuid);if(!e||!e.library)return"none";const a=[".png",".jpg",".jpge"];for(const t of a)if(t in e.library)return e.library[t];return"none"}const o=document.createElement("img");if(o.src=`${s}?${e.refreshTime}`,!1===await new Promise(e=>{o.addEventListener("load",()=>{e(o)}),o.addEventListener("error",()=>{e(!1)})}))return"";let c=a.width||o.width,l=a.height||o.height;const u=document.createElement("canvas"),p=u.getContext("2d");if(u.width=c,u.height=l,a.rotated){const e=u.width/2,t=u.height/2;p.translate(e,t),p.rotate(-90*Math.PI/180),p.translate(-e,-t),c=a.height,l=a.width}return p.drawImage(o,a.trimX||0,a.trimY||0,c,l,0,0,c,l),u.toDataURL("image/png")},getLibraryImageSrc(e,t){let a=e[t];if(!a){a=e[Object.keys(e).find(e=>".json"!==e)||""]}return a}};