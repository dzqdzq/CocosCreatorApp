"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.data=exports.methods=exports.watch=exports.computed=exports.props=exports.components=exports.template=exports.name=void 0;const fs_1=require("fs"),path_1=require("path"),panel_menu_1=require("./panel-menu"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data")),utils=__importStar(require("./utils")),illegalFileName=/[\\/:*?"<>|]+/;let renameTimeId;function data(){return{renameUuid:"",renameValue:"",renameInputState:"",addInputState:{}}}exports.name="tree-node",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree-node.html"),"utf8"),exports.components={"tree-node-icon":require("./tree-node-icon")},exports.props=["asset","expand","select","twinkle","renameUrl","addInfo"],exports.computed={state(){const e=this,t=e.asset;return t?t.url&&e.renameUrl===t.url?"rename":t.url&&e.addInfo.parentDir===t.url?(e.addState(),"add"):treeData.uuidToState[t.uuid]||"":""},draggable(){const e=this.asset;return e?treeData.uuidToState[e.uuid]||""!==this.state||utils.canNotDrag(e)?"false":"true":"false"},style(){const{left:e}=this.asset;return{paddingLeft:e+"px"}},addInputStyle(){const{left:e,isParent:t}=this.asset,{iconWidth:a,iconWidthMinus:r}=panelData.config;return{paddingLeft:e+(t?2:1)*a+r+"px"}}},exports.watch={state(){const e=this,t=e.asset;"rename"===e.state?(e.renameUuid=t.uuid,e.renameValue=t.fileName,e.renameInputState="",e.$nextTick(()=>{e.$refs.renameInput&&(e.$refs.renameInput.focus(),e.$refs.renameInput.setSelectionRange(0,t.fileName.length))})):"add"===e.state&&e.addState()}},exports.methods={t:e=>panelData.$.panel.t(e),async dblclick(e){if(clearTimeout(renameTimeId),e.isDirectory)utils.isSearchingMode()?(panelData.$.tree.toggle(e.uuid,!0),panelData.$.panel.clearSearch(),utils.scrollIntoView(e.uuid,!0)):panelData.$.tree.toggle(e.uuid);else{if(e.isSubAsset)return;try{await Editor.Message.request("asset-db","open-asset",e.url)}catch(e){console.error(e)}}},popupMenu(e){panel_menu_1.popupContextMenu(e)},click(e,t){t.shiftKey?panelData.$.tree.shiftClick(e.uuid):t.ctrlKey||t.metaKey?panelData.$.tree.ctrlClick(e.uuid):panelData.$.tree.ipcSelect(e.uuid)},rename(e,t){if(panelData.$.panel.refocus)return;const a=panelData.act.selects;utils.canNotRename(e)||t.ctrlKey||t.metaKey||1!==a.length||!a.includes(e.uuid)||(clearTimeout(renameTimeId),renameTimeId=setTimeout(()=>{panelData.$.tree.renameUrl=e.url},300),t.preventDefault(),t.stopPropagation())},toggle(e,t){const a=t.currentTarget;a.setAttribute("animate",""),setTimeout(()=>{a.removeAttribute("animate")},500),panelData.$.tree.toggle(e.uuid,void 0,t.altKey)},async renameChange(){const e=this,{uuid:t,fileExt:a,fileName:r}=e.asset,n=treeData.uuidToParentUuid[t],i=(treeData.uuidToChildren[n]||[]).map(e=>{const t=utils.getAsset(e);return t&&t.fileExt===a&&t.fileName!==r?t.fileName:null}).filter(Boolean);e.renameValue=e.$refs.renameInput.value.trim();let s="";i.includes(e.renameValue)?s="errorNewnameDuplicate":""===e.renameValue?s="errorNewnameEmpty":illegalFileName.test(e.renameValue)&&(s="errorNewnameUnlegal"),e.renameInputState=s},renameSubmit(){let e=this.$refs.renameInput.value.trim();""===this.renameInputState&&e||(e=""),panelData.$.tree.rename(this.renameUuid||this.asset.uuid,e)},renameCancel(){this.$refs.renameInput.value="",panelData.$.tree.rename(this.renameUuid||this.asset.uuid,"")},async addChange(){const{parentUuid:e,fileExt:t}=this.addInfo,a=(treeData.uuidToChildren[e]||[]).map(e=>{const a=utils.getAsset(e);return a&&a.fileExt===t?a.fileName:null}).filter(Boolean),r=this.$refs.addInput.value,n=r.trim();let i={state:"",title:"",message:""};a.includes(n)?i.state="errorNewnameDuplicate":""===n?i.state="errorNewnameEmpty":illegalFileName.test(n)?i.state="errorNewnameUnlegal":[".ts",".js"].includes(t)&&(i=await utils.scriptName.isValid(n)),i.state&&(i.title=this.t("operate."+i.state),"message"in i&&(i.title=i.title.replace("$$className",i.message))),this.addInputState=i,this.addInfo.fileName=r},addSubmit(){const e=Object.assign({},this.addInfo),t=this.$refs.addInput.value.trim();!this.addInputState.state&&t?(e.fileName=t,panelData.$.tree.addConfirm(e)):panelData.$.tree.addConfirm(null)},addCancel(){this.$refs.addInput.value="",panelData.$.tree.addConfirm(null)},dragStart(e,t){const a=this;Editor.Message.send("scene","snapshot");let r=[];panelData.act.selects.includes(e.uuid)?panelData.act.selects.forEach(e=>{const t=utils.getAsset(e);t&&(r=a.mergeAdditional(r,t))}):r=a.mergeAdditional(r,e),t.dataTransfer.setData("name",e.name),t.dataTransfer.setData("value",e.uuid),t.dataTransfer.setData("additional",JSON.stringify(r));const n=new Image;n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAICRAEAOw==",t.dataTransfer.setDragImage(n,0,0)},dragOver(e,t){t.preventDefault();const a=t.currentTarget;a.setAttribute("drag","over"),a.setAttribute("insert","inside"),panelData.$.tree.dragOver(e.uuid)},dragLeave(e,t){const a=t.currentTarget;a.removeAttribute("insert"),a.removeAttribute("drag"),panelData.$.tree.dragLeave(e.uuid)},drop(e,t){t.preventDefault();const a=t.currentTarget,r=a.getAttribute("insert");a.removeAttribute("insert"),a.removeAttribute("drag");const n=panelData.$.tree.$el;if(!n.hasAttribute("hoving"))return;if(t.stopPropagation(),n.removeAttribute("hoving"),utils.canNotDrop(e))return;const i=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{},s=Array.from(t.dataTransfer.files);s&&s.length>0&&(i.type="osFile",i.insert="inside",i.files=s),i.to=e.uuid,i.insert=r,i.copy=t.ctrlKey,panelData.$.tree.ipcDrop(i),panelData.$.tree.dragLeave(e.uuid)},mergeAdditional:(e,t)=>(Array.isArray(t.additional)&&t.additional.length?e=e.concat(t.additional):e.push({type:t.type,value:t.uuid,name:t.name}),e),addState(){const e=this,{name:t}=e.addInfo;e.addInputState={},e.$nextTick(()=>{e.$refs.addInput&&(e.$refs.addInput.focus(),e.$refs.addInput.setSelectionRange(0,t.length))})}},exports.data=data;