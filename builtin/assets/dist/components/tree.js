"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.data=exports.watch=exports.methods=exports.components=exports.template=exports.name=void 0;const path_1=require("path"),fs_1=require("fs"),panelData=__importStar(require("./panel-data")),treeData=__importStar(require("./tree-data")),utils=__importStar(require("./utils"));let requestAnimationId,dragOverUuid,dragOverTimeId,selectedTimeId,refreshingTimeId,vm=null;function data(){return{assets:[],renameUrl:"",addInfo:{type:"",importer:"",name:"",fileExt:"",fileName:"",parentDir:""},intoViewBySelected:"",intoViewByUser:"",scrollTop:0,copiedUuids:[],cutUuids:[],droppableTypes:[],checkShiftUpDownMerge:{uuid:"",direction:""}}}async function mounted(){(vm=this).refreshing.ignores={}}exports.name="tree",exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static/template/tree.html"),"utf8"),exports.components={"tree-node":require("./tree-node")},exports.methods={t:e=>panelData.$.panel.t(e),update(){vm.droppableTypes=vm.$parent.droppableTypes.concat(panelData.config.assetTypes()),vm.addInfo.parentDir="",vm.renameUrl=""},clear(){treeData.clear(),vm.render()},refreshing(e,t,a){a&&vm.refreshing.ignores[a]?delete vm.refreshing.ignores[a]:(panelData.$.panel.refreshing={type:e,name:t},window.clearTimeout(refreshingTimeId),refreshingTimeId=window.setTimeout(()=>{panelData.$.panel.refreshing.type="",vm.refreshing.ignores={}},1e3))},toggle(e,t,a){a?treeData.loopExpand(e,t):treeData.toggleExpand(e,t)},allToggle(){let e=treeData.uuidToChildren[panelData.config.protocol];panelData.act.selects.length&&(e=panelData.act.selects);const t=e.length;if(!t)return;let a=treeData.uuidToExpand[e[0]];for(let i=0;i<t;i++){let t=e[i];treeData.uuidToAsset[t].isParent||(t=treeData.uuidToParentUuid[t],a=treeData.uuidToExpand[t]),treeData.loopExpand(t,!a)}},selectAll(e){if(utils.isSearchingMode())return Editor.Selection.clear("asset"),void Editor.Selection.select("asset",treeData.displayArray);let t=e||vm.getFirstSelectSortByDisplay();treeData.uuidToChildren[t]||(t=treeData.uuidToParentUuid[t]);const a=[];utils.getChildrenUuid(t,a,!0);const i=panelData.act.selects.slice().includes(t);let s=!0;const r=a.length;for(let e=0;e<r;e++)panelData.act.selects.includes(a[e])||(s=!1);s?i?t!==panelData.config.protocol&&vm.selectAll(treeData.uuidToParentUuid[t]):Editor.Selection.select("asset",t):(Editor.Selection.clear("asset"),i?(a.unshift(t),Editor.Selection.select("asset",a)):Editor.Selection.select("asset",a))},selectClear(){Editor.Selection.clear("asset")},selected(e){Array.isArray(e)||(e=[e]),e.forEach(e=>{panelData.act.selects.includes(e)||(panelData.act.selects.push(e),vm.intoViewBySelected=e,window.clearTimeout(selectedTimeId),selectedTimeId=window.setTimeout(()=>{utils.scrollIntoView(vm.intoViewBySelected)},50),e===vm.checkShiftUpDownMerge.uuid&&vm.shiftUpDownMergeSelected())}),panelData.$.panel.allExpand=vm.isAllExpand()},unselected(e){const t=panelData.act.selects.indexOf(e);-1!==t&&(panelData.act.selects.splice(t,1),window.clearTimeout(selectedTimeId),selectedTimeId=window.setTimeout(()=>{treeData.render()},50)),vm.intoViewBySelected===e&&(vm.intoViewBySelected="")},resetSelected(){panelData.act.selects=[];const e=Editor.Selection.getSelected("asset");vm.selected(e),window.clearTimeout(selectedTimeId),utils.scrollIntoView(vm.intoViewBySelected,!0)},shiftClick(e){if(0===panelData.act.selects.length)return void vm.ipcSelect(e);const t=[],{displayArray:a}=treeData,i=a.indexOf(panelData.act.selects[0]),s=a.indexOf(e);if(-1!==i||-1!==s)if(i<=s)for(let e=i;e<=s;e++)t.push(a[e]);else for(let e=i;e>=s;e--)t.push(a[e]);vm.ipcSelect(t)},ctrlClick(e){panelData.act.selects.includes(e)?Editor.Selection.unselect("asset",e):Editor.Selection.select("asset",e)},ipcSelect(e){Editor.Selection.clear("asset"),Editor.Selection.select("asset",e)},ipcSelectFirstChild(){Editor.Selection.clear("asset");const e=this.getFirstChild();e&&Editor.Selection.select("asset",e)},click(){panelData.$.panel.isOperating||Editor.Selection.clear("asset")},async addTo(e){e.uuid||(e.uuid=vm.getFirstSelect());const t=utils.closestWhichCanCreate(e.uuid);if(!t||treeData.uuidToState[t.uuid])return;vm.toggle(t.uuid,!0),utils.scrollIntoView(t.uuid);const a=t.url;let i=e.fileName||"New File",s=`.${e.type}`;switch(e.type){case"directory":s="";break;case"ts":case"js":i=await utils.scriptName.getValidFileName(i)}let r=`${a}/${i}${s}`;r=await Editor.Message.request("asset-db","generate-available-url",r),vm.addInfo={type:e.type,importer:e.importer,template:e.template,fileExt:s,fileName:path_1.basename(r,s),name:path_1.basename(r),parentDir:a,parentUuid:t.uuid}},async addConfirm(e){if(!(e&&e.parentDir&&e.parentUuid&&e.fileName))return void(vm.addInfo.parentDir="");e.name=e.fileName+e.fileExt;const t=utils.closestWhichCanCreate(e.parentUuid);if(!t)return;let a=null;if("directory"!==e.type){a="";const t=`db://internal/default_file_content/${e.template||e.type}`,i=await Editor.Message.request("asset-db","query-uuid",t);if(i){const t=await Editor.Message.request("asset-db","query-asset-info",i);if(!t||!fs_1.existsSync(t.file))return void console.error(vm.t("readDefaultFileFail"));if(a=fs_1.readFileSync(t.file,"utf-8"),["ts","js"].includes(e.type)){if((await utils.scriptName.isValid(e.fileName)).state)return void console.error(vm.t("errorScriptName"));const t={Name:utils.scriptName.getValidClassName(e.fileName)};Object.keys(t).forEach(e=>{a=a.replace(new RegExp(`<%${e}%>`,"g"),t[e])})}}}vm.addInfo.parentDir="",treeData.uuidToState[t.uuid]="add-loading",panelData.$.panel.isOperating=!0;const i=`${e.parentDir}/${e.fileName}${e.fileExt}`;await vm.add(i,a),setTimeout(()=>{panelData.$.panel.isOperating=!1},200)},async add(e,t,a){const i=await Editor.Message.request("asset-db","create-asset",e,t,{overwrite:null===a||void 0===a?void 0:a.overwrite});if(i)return vm.ipcSelect(i.uuid),setTimeout(()=>{utils.scrollIntoView(i.uuid)},300),i.uuid},async added(e,t){panelData.act.twinkleQueue.push({uuid:e,animation:"shrink"}),treeData.added(e,t),vm.refreshing("added",t.name);const a=treeData.uuidToParentUuid[e];vm.refreshing.ignores[a]=!0},async changed(e,t){utils.thumbnail.delete(e),panelData.act.twinkleQueue.push({uuid:e,animation:"light"}),treeData.changed(e,t),vm.refreshing("changed",t.name,e);const a=treeData.uuidToParentUuid[e];vm.refreshing.ignores[a]=!0,e===vm.intoViewByUser&&setTimeout(()=>{utils.scrollIntoView(vm.intoViewByUser),vm.intoViewByUser=""},300)},async delete(e){let t=[];const a=panelData.act.selects.includes(e),i=(t=e&&!a?[e]:panelData.act.selects.slice()).length;let s=[];for(let e=0;e<i;e++){const a=t[e],i=utils.getAsset(a);i&&!utils.canNotDelete(i)&&((s=s.filter(e=>!utils.isAIncludeB(a,e))).some(e=>utils.isAIncludeB(e,a))||s.push(a))}const r=s.length;if(!r)return;let n=Editor.I18n.t("assets.operate.sureDelete");n=n.replace("${length}",r);let l="";for(let e=0;e<r;e++){const t=s[e];if(e>5)break;const a=utils.getAsset(t);a&&(l+=e<5?`${a.name}\n`:"...")}if(n=n.replace("${filelist}",l),1===(await Editor.Dialog.warn(n,{buttons:["Yes","Cancel"],default:0,cancel:1,title:Editor.I18n.t("assets.operate.dialogQuestion")})).response)return;const o=[];for(let e=0;e<r;e++){const t=s[e],a=utils.getAsset(t);a&&(treeData.uuidToState[t]="loading",treeData.unFreeze(t),o.push(Editor.Message.request("asset-db","delete-asset",a.url)))}treeData.render(),await Promise.all(o).then(()=>{for(let e=0;e<r;e++)delete treeData.uuidToState[s[e]]}),a&&Editor.Selection.clear("asset")},deleted(e,t){utils.thumbnail.delete(e),treeData.deleted(e,t),vm.refreshing("deleted",t.name)},upDownLeftRight(e){const t=vm.getLastSelect();if("right"===e){if(!vm.isExpand(t))return void vm.toggle(t,!0);const e=treeData.uuidToChildren[t];Array.isArray(e)&&e.length&&vm.ipcSelect(e[0])}else if("left"===e){if(vm.isExpand(t))return void vm.toggle(t,!1);const e=treeData.uuidToParentUuid[t];e!==panelData.config.protocol&&vm.ipcSelect(e)}else{const a=utils.getSibling(t);let i;switch(e){case"up":i=a[1];break;case"down":i=a[2]}i&&vm.ipcSelect(i.uuid)}},async shiftUpDown(e){const t=panelData.act.selects.length;if(0===t)return;const[a,i,s]=utils.getSibling(panelData.act.selects[t-1]),r=panelData.act.selects.includes(i.uuid),n=panelData.act.selects.includes(s.uuid);if("up"===e){if(!r)return Editor.Selection.select("asset",i.uuid),vm.checkShiftUpDownMerge.uuid=i.uuid,void(vm.checkShiftUpDownMerge.direction=e);n||Editor.Selection.unselect("asset",a.uuid),utils.scrollIntoView(i.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(i.uuid),1),panelData.act.selects.push(i.uuid)}if("down"===e){if(!n)return Editor.Selection.select("asset",s.uuid),vm.checkShiftUpDownMerge.uuid=s.uuid,void(vm.checkShiftUpDownMerge.direction=e);r||Editor.Selection.unselect("asset",a.uuid),utils.scrollIntoView(s.uuid),panelData.act.selects.splice(panelData.act.selects.indexOf(s.uuid),1),panelData.act.selects.push(s.uuid)}},shiftUpDownMergeSelected(){if(!vm.checkShiftUpDownMerge.uuid)return;let e=!0,t=vm.checkShiftUpDownMerge.uuid;vm.checkShiftUpDownMerge.uuid="";let a=panelData.act.selects.length;for(;e;){const i=utils.getSibling(t);if(!(i&&i[1]&&i[2]&&a))return;t="down"===vm.checkShiftUpDownMerge.direction?i[2].uuid:i[1].uuid,a--,panelData.act.selects.includes(t)?(panelData.act.selects.splice(panelData.act.selects.indexOf(t),1),panelData.act.selects.push(t)):e=!1}},keyboardRename(){if(vm.renameUrl)return;const e=vm.getFirstSelect(),t=utils.getAsset(e);t&&!utils.canNotRename(t)&&(utils.scrollIntoView(e),vm.renameUrl=t.url)},async rename(e,t=""){const a=utils.getAsset(e);if(!a||"loading"===treeData.uuidToState[e])return!1;if(vm.renameUrl="",utils.canNotRename(a)||""===t||t===a.fileName)return treeData.uuidToState[e]="",!1;const i=utils.getParent(e);if(!i)return!1;treeData.uuidToState[e]="loading";const s=t+a.fileExt,r=`${i.url}/${s}`;return await Editor.Message.request("asset-db","move-asset",a.url,r)||vm.dialogError("renameFail"),treeData.uuidToState[e]="",!0},sort(){treeData.resort()},search(){vm.$nextTick(()=>{treeData.render(),panelData.$.panel.searchValue&&setTimeout(()=>{panelData.$.viewBox.scrollTo(0,0)},200),panelData.$.panel.searchInFolder||panelData.$.panel.searchValue||setTimeout(()=>{utils.scrollIntoView(vm.intoViewBySelected,!0)},200)})},dragOver(e){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{const t=utils.getAsset(e);if(!t)return;if(!t.isDirectory)return void vm.dragOver(treeData.uuidToParentUuid[e]);const a=Date.now();dragOverUuid!==e?(dragOverUuid=e,dragOverTimeId=a):a-dragOverTimeId>800&&vm.toggle(e,!0);const i=panelData.$.viewBox,s=vm.scrollTop%panelData.config.assetHeight,r=i.getBoundingClientRect().top-vm.$el.getBoundingClientRect().top,n=treeData.displayArray.indexOf(e)*panelData.config.assetHeight+s-r+3,l=[];utils.getChildrenUuid(e,l,!0),panelData.$.panel.dropBoxStyle={left:i.scrollLeft+"px",top:n+"px",height:(l.length+1)*panelData.config.assetHeight+2+"px",opacity:t.readonly?0:1}})},dragLeave(e){let t=utils.getAsset(e);t&&!t.isDirectory&&(t=utils.getParent(e)),t&&(treeData.uuidToState[t.uuid]="")},drop(e){const t=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{},a=vm.assets[0].uuid,i=Array.from(e.dataTransfer.files);if(i&&i.length>0&&(t.type="osFile",t.files=i),t.value){const e=utils.getParent(t.value);if(e&&e.uuid===a)return}t.to=a,t.copy=e.ctrlKey,vm.ipcDrop(t)},dragEnter(){window.cancelAnimationFrame(requestAnimationId),requestAnimationId=requestAnimationFrame(()=>{vm.dragOver(treeData.displayArray[0])})},async ipcDrop(e){panelData.$.panel.focusWindow();const t=utils.getDirectory(e.to);if(t&&!utils.canNotCreate(t))if("osFile"===e.type){if(!Array.isArray(e.files))return;const a=e.files.map(e=>e.path);treeData.uuidToState[t.uuid]="loading",treeData.unFreeze(t.uuid),treeData.render(),await Promise.all(a.map(e=>Editor.Message.request("asset-db","import-asset",e,t.url+"/"+path_1.basename(e)))),treeData.uuidToState[t.uuid]=""}else if("cc.Node"===e.type)for(const a of e.additional){if("cc.Node"!==a.type)continue;const e=a.value,i=await Editor.Message.request("scene","query-node",e),s=(i.__prefab__,`${t.url}/${i.name.value||"Node"}.prefab`),r=await Editor.Message.request("scene","create-prefab",e,s);r&&(vm.ipcSelect(r),setTimeout(()=>{utils.scrollIntoView(r)},300))}else if(panelData.config.extendDrop.types&&panelData.config.extendDrop.types.includes(e.type)){const t=Object.values(panelData.config.extendDrop.callbacks[e.type]);if(Array.isArray(t)){const a=utils.getAsset(e.to);if(!a)return;t.forEach(t=>{t({uuid:a.uuid,type:a.type,isDirectory:a.isDirectory},e.additional)})}}else{if(!e.additional||!Array.isArray(e.additional))return;if(e.copy){const t=e.additional.map(e=>e.value.split("@")[0]);return vm.copy(t),void vm.paste(e.to)}await vm.move(e,t)}},copy(e){if(panelData.$.panel.isOperating)return;let t=[];t=Array.isArray(e)?e:e&&!panelData.act.selects.includes(e)?[e]:panelData.act.selects.slice(),vm.copiedUuids=t.filter(e=>{const t=utils.getAsset(e);return t&&!utils.canNotCopy(t)}),vm.copiedUuids.forEach(e=>{utils.twinkle.add(e,"light")}),vm.render()},async paste(e,t=vm.copiedUuids){if(panelData.$.panel.isOperating)return;e||(e=vm.getFirstSelect());let a=utils.closestWhichCanCreate(e);if(vm.cutUuids.length){if(a&&vm.cutUuids.includes(a.uuid))return;const e={additional:vm.cutUuids.map(e=>({value:e}))};return await vm.move(e,a),vm.cutUuids=[],void(vm.copiedUuids.length=0)}if(a&&t.includes(a.uuid)&&(a=utils.closestWhichCanCreate(treeData.uuidToParentUuid[a.uuid])),!parent)return;const i=[];if(t.forEach(e=>{const t=utils.getAsset(e);if(!t)return;const s=!utils.canNotCopy(t);if(!s){const e=`${Editor.I18n.t("assets.operate.copyFail")}: ${t.name}`;console.warn(e)}const r=utils.isAIncludeB(e,a.uuid);if(r){const e=`${Editor.I18n.t("assets.operate.errorPasteParentToChild")}: ${t.name}`;console.warn(e)}s&&!r&&i.push(e)}),0===i.length)return;let s,r,n=0;const l=[];treeData.uuidToState[a.uuid]="loading",treeData.unFreeze(a.uuid),treeData.render(),vm.toggle(a.uuid,!0);do{if(s=utils.getAsset(i[n]),n++,r=null,s){const e=path_1.basename(s.url);let t=`${a.url}/${e}`;t=await Editor.Message.request("asset-db","generate-available-url",t),(r=await Editor.Message.request("asset-db","copy-asset",s.url,t))&&(vm.intoViewByUser=r.uuid,l.push(r.uuid))}}while(r);treeData.uuidToState[a.uuid]="",vm.ipcSelect(l)},cut(e){if(panelData.$.panel.isOperating)return;let t=[];t=Array.isArray(e)?e:e&&!panelData.act.selects.includes(e)?[e]:panelData.act.selects.slice(),vm.cutUuids=t.filter(e=>{const t=utils.getAsset(e);return t&&!utils.canNotCut(t)}),vm.cutUuids.forEach(e=>{utils.twinkle.add(e,"light")}),vm.render()},async duplicate(e){if(panelData.$.panel.isOperating)return;e||(e=panelData.act.selects.slice().filter(Boolean));const t=e.filter(e=>{const t=utils.getAsset(e);return t&&!utils.canNotDuplicate(t)});if(0!==t.length)try{for(const e of t)await vm.paste(treeData.uuidToParentUuid[e],[e])}catch(e){console.error(e)}},async move(e,t){if(!e||!t||!Array.isArray(e.additional))return;vm.toggle(t.uuid,!0);const a=e.additional.map(e=>e.value.split("@")[0]);a.sort((e,t)=>{return treeData.uuidToIndex[e]-treeData.uuidToIndex[t]});const i=[],s=a.length;for(let r=0;r<s;r++){const s=a[r],n=utils.getAsset(s),l=utils.getParent(s);n&&l&&(t.uuid!==n.uuid&&(utils.canNotCut(n)||utils.isAIncludeB(n.uuid,e.to)||t.uuid!==l.uuid&&i.push(s)))}const r=[],n=i.length;for(let e=0;e<n;e++){const i=a[e],s=utils.getAsset(i),n=utils.getParent(i);if(!s||!n)continue;vm.intoViewByUser=s.uuid,treeData.uuidToState[i]="loading",treeData.unFreeze(i),treeData.render();const l=t.url+"/"+path_1.basename(s.url);s.instantiation?r.push(Editor.Message.request("asset-db","init-asset",s.url,l)):r.push(Editor.Message.request("asset-db","move-asset",s.url,l,{overwrite:!0}))}await Promise.all(r).then(()=>{for(let e=0;e<n;e++){const t=a[e];treeData.uuidToState[t]=""}}),vm.ipcSelect(i)},async reimport(e){let t=[];const a=(t=panelData.act.selects.includes(e)?panelData.act.selects:[e]).length;let i=[];for(let e=0;e<a;e++){const a=t[e],s=utils.getAsset(a);s&&!utils.canNotReimport(s)&&((i=i.filter(e=>!utils.isAIncludeB(a,e))).some(e=>utils.isAIncludeB(e,a))||(i.push(a),utils.getChildrenUuid(a,i,!0,!0)))}if(i.length)for(const e of i)await Editor.Message.request("asset-db","reimport-asset",e)},render(){for(panelData.$.panel.treeHeight=treeData.displayArray.length*panelData.config.assetHeight,panelData.$.panel.allExpand=vm.isAllExpand(),vm.filterAssets();panelData.act.twinkleQueue.length;){const e=panelData.act.twinkleQueue.shift();utils.twinkle.add(e.uuid,e.animation)}},filterAssets(){vm.assets=[];const e=vm.scrollTop%panelData.config.assetHeight,t=vm.scrollTop-e,a=t+panelData.$.panel.viewHeight;vm.$el.style.top=`-${e}px`;const i=Math.round(t/panelData.config.assetHeight),s=Math.ceil(a/panelData.config.assetHeight)+1;vm.assets=treeData.outputDisplay(i,s)},getFirstSelect(){const e=panelData.act.selects[0];return e||treeData.displayArray[0]},getLastSelect(){const e=panelData.act.selects.length;if(e)return panelData.act.selects[e-1];{const e=treeData.displayArray.length;return treeData.displayArray[e-1]}},getFirstSelectSortByDisplay(){let e=panelData.config.protocol;const t=treeData.displayArray.length,a=panelData.act.selects.length;if(a)for(let i=0;i<a;i++){const a=panelData.act.selects[i];treeData.displayArray.indexOf(a)<t&&(e=a)}return e},getFirstChild:()=>treeData.displayArray[0],isExpand:e=>treeData.uuidToExpand[e],isSelect:e=>-1!==panelData.act.selects.indexOf(e),isTwinkle:e=>panelData.act.twinkles[e],isAllExpand(){let e=!0,t=treeData.uuidToChildren[panelData.config.protocol];if(panelData.act.selects.length&&(t=panelData.act.selects),!t||!t.length)return e;const a=t.length;for(let i=0;i<a;i++){let a=t[i];const s=treeData.uuidToAsset[a];if(s&&!s.isParent&&(a=treeData.uuidToParentUuid[a]),treeData.uuidToExpand[a]){e=!1;break}}return!e},isSearchingMode:()=>utils.isSearchingMode(),async dialogError(e){await Editor.Dialog.error(Editor.I18n.t(`assets.operate.${e}`),{title:Editor.I18n.t("assets.operate.dialogError")})}},exports.watch={scrollTop(){vm.filterAssets()},activeAsset(){panelData.$.panel.activeAsset=vm.activeAsset}},exports.data=data,exports.mounted=mounted;