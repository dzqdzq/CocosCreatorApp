"use strict";const i18n=require("@base/electron-i18n"),Vue=require("vue/dist/vue.js"),qrcode=require("qrcode"),{basename:basename}=require("path");let vm=null;exports.style="\n:host {\n    display: flex;\n}\n\n.preview-info-wrap {\n    display: flex;\n}\n\n.preview-info {\n    display: flex;\n    border-radius: calc(var(--size-normal-radius) * 2px);\n    border: 1px solid var(--color-default-border);\n}\n\n.preview-info > .transparent {\n    border-radius: 0;\n    height: 22px;\n}\n\n.preview-info > .transparent:last-child {\n    border-right: none;\n    border-top-right-radius: calc(var(--size-normal-radius) * 2px);\n    border-bottom-right-radius: calc(var(--size-normal-radius) * 2px);\n}\n\n.preview-info ul {\n    padding: 0;\n    margin: 0;\n    position: absolute;\n    z-index: 99;\n    left: 0;\n    top: 26px;\n    padding: 4px;\n    background: var(--color-normal-fill);\n    color: var(--color-default-contrast);\n    overflow: hidden;\n    border-radius: 4px;\n    border: 1px solid var(--color-default-border);\n}\n\n.preview-info ul > li {\n    list-style: block;\n    white-space: nowrap;\n    text-align: left;\n    box-sizing: border-box;\n    cursor: pointer;\n    border-radius: 2px;\n    padding-right: 4px;\n    line-height: 20px;\n}\n\n.prefix, .suffix{\n    color: var(--color-default-contrast-emphasis);\n    background-color: transparent;\n}\n\n.prefix {\n    padding: 0 4px;\n}\n\n.suffix {\n    margin-left: 16px;\n    color: var(--color-default-fill-weakest);\n}\n\n.preview-info ul > li:hover {\n    background: var(--color-hover-fill);\n    color: var(--color-focus-contrast-emphasis);\n}\n\n.preview-info ul > li:active {\n    background: var(--color-default-fill-emphasis);\n    color: var(--color-focus-contrast-emphasis);\n}\n\n.preview-info ul > li > ui-icon {\n    font-size: 14px;\n}\n\n.preview-info .play,\n.preview-info .pause,\n.preview-info .step {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    width: 24px;\n    border-right: 1px solid var(--color-default-border);\n    padding: 0;\n}\n\n.preview-info .step {\n    border: none;\n}\n\n.preview-info .play[active=true],\n.preview-info .pause[active=true],\n.preview-info .step[active=true] {\n    background: var(--color-info-fill-important);\n    color: var(--color-info-contrast-important);\n}\n\n\n.preview-info .platform {\n    display: flex;\n    position: relative;\n    overflow: visible;\n    cursor: pointer;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    padding: 0 4px 0 8px;\n    border-top-left-radius: calc(var(--size-normal-radius) * 2px);\n    border-top-right-radius: 0;\n    border-bottom-left-radius: calc(var(--size-normal-radius) * 2px);\n    border-bottom-right-radius: 0;\n    border-right: 1px solid var(--color-default-border);\n}\n\n.preview-info .platform:hover {\n    color: var(--color-focus-contrast-emphasis);\n    background-color: var(--color-default-fill-weaker);\n}\n\n.preview-info .platform .browser {\n    padding: 0 4px 0 0;\n    font-size: 14px;\n    line-height: 0;\n}\n\n.preview-info .platform > ul {\n    max-height: 150px;\n    overflow: auto;\n}\n\n.preview-info .scene {\n    position: relative;\n    overflow: visible;\n    height: 22px;\n    cursor: pointer;\n    line-height: 22px;\n    padding: 0 4px 0 8px;\n    border-right: 1px solid var(--color-default-border);\n    border-radius: 0;\n    display: flex;\n    align-items: center;\n}\n\n.preview-info .scene:hover {\n    color: var(--color-focus-contrast-emphasis);\n    background-color: var(--color-default-fill-weaker);\n}\n\n.preview-info .scene .title {\n    width: 84px;\n    white-space: nowrap;\n}\n\n.preview-info .reload ui-icon {\n    width: 20px;\n    cursor: pointer;\n}\n\n.preview-info .scene > ul {\n    width: 240px;\n    max-height: 200px;\n    overflow: auto;\n}\n\n.preview-info .scene > ul > li {\n    overflow: hidden;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n    cursor: pointer;\n    padding: 2px 4px;\n}\n\n.preview-info .scene > ul > li:first-child {\n    border-bottom: 1px solid var(--color-hover-fill-weaker);\n}\n\n.preview-info .scene > ul > li[active] {\n    color: var(--color-focus-contrast-emphasis);\n}\n\n.preview-info .scene-url {\n    display: flex;\n    font-size: 11px;\n    line-height: 14px;\n    color: var(--color-normal-contrast-emphasis);\n    align-items: center;\n}\n\n.preview-info .scene-url .location:hover {\n    color: var(--color-focus-border-weakest);\n}\n\n.preview-info .scene-url .scene-url-name {\n    flex: 1;\n    direction: rtl;\n}\n\n.preview-info .arrow-triangle {\n    font-size: 12px;\n}\n\n.preview-info .sub-triangle-icon {\n    font-size: 12px;\n}\n\n.preview-info .reload {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    width: 24px;\n    padding-left: 5px;\n    padding-right: 5px;\n    border-top-left-radius: 0;\n    border-top-right-radius: 3px;\n    border-bottom-left-radius: 0;\n    border-bottom-right-radius: 3px;\n}\n\n.qr-wrap {\n    position: relative;\n}\n\n.qr-wrap ui-button {\n    width: 24px;\n    height: 24px;\n    padding: 0;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    border: 1px solid var(--color-default-border-important);\n    margin-left: 8px;\n    border-radius: calc(var(--size-normal-radius) * 2px);\n}\n\n.qr-code {\n    width: 24px;\n}\n\n.qr {\n    display: flex;\n    position: absolute;\n    background: var(--color-normal-fill-important);\n    border: 1px solid var(--color-default-border-important);\n    z-index: 999;\n    top: 26px;\n    left: 8px;\n    flex-direction: column;\n    padding: 18px 12px 12px 12px;\n    border-radius: calc(var(--size-normal-radius) * 2px);\n    opacity: 1;\n    text-align: center;\n}\n\n.qr ui-icon {\n    cursor: pointer;\n}\n\n.qr ui-label {\n    cursor: text;\n    user-select: text;\n    white-space: nowrap;\n    color: var(--color-default-fill-weakest);\n    line-height: 20px;\n}\n\n.canvas {\n    width: 120px;\n    height: 120px;\n    margin: 0 auto 16px;\n    border-radius: calc(var(--size-normal-radius) * 2px);\n}\n\n.address {\n    font-size: 12px;\n    line-height: 22px;\n    white-space: nowrap;\n}\n\n.address .copy {\n    opacity: 0.7;\n}\n\n.address .copy:active {\n    opacity: 1;\n}\n\n",exports.template='\n<div class="preview-info-wrap" @dblclick.stop>\n    <div class="preview-info">\n        <div class="platform transparent" \n            @click.stop="visiblePlatformList"\n        >\n            <ui-icon class="browser"\n            :value="platformsIcon[currPlatform].prefix"\n            ></ui-icon>\n            <ui-icon value="arrow-triangle" class="sub-triangle-icon"></ui-icon>\n            <ul v-show="isShowPlatformsList">\n                <li v-for="platform in platforms" @click.stop="changePlatform(platform)">\n                    <ui-icon \n                        class="prefix" \n                        :value="platformsIcon[platform].prefix"\n                    ></ui-icon>\n                    <ui-label \n                        :value="\'i18n:preview.\'+platform"\n                    ></ui-label>\n                    <ui-icon class="suffix" color\n                        v-if="platformsIcon[platform].suffix" \n                        :value="platformsIcon[platform].suffix"\n                        :tooltip="\'i18n:preview.tips.\'+platformsIcon[platform].suffix"\n                    ></ui-icon>\n                </li>\n            </ul>\n        </div>\n        <div class="scene transparent" \n            @click.stop="visibleSelectList" \n        >\n            <ui-label class="title"\n                :value="curSelectScene.name===\'\'?\'i18n:preview.current_scene\':curSelectScene.name"\n            ></ui-label>\n            <ui-icon value="arrow-triangle" class="arrow-triangle"></ui-icon>\n            <ul class="scene_list" \n                v-show="isShowSceneList"\n            >\n                <li \n                    :title="curSceneUrl" \n                    :active="curSelectScene.name===\'\'"\n                    @click.stop="_onSettingsChanged(\'current_scene\', \'general.start_scene\', {name: \'\'})"\n                >\n                    <ui-label value="i18n:preview.current_scene"></ui-label>\n                </li>\n                \n                <li v-for="scene in scenes"\n                    :value="scene.uuid"\n                    :title="scene.url"\n                    :active="curSelectScene.url===scene.url"\n                    @click.stop="_onSettingsChanged(scene.uuid, \'general.start_scene\', scene)"\n                >\n                    <div class="scene-name">{{scene.name}}</div>\n                    <div class="scene-url">\n                        <ui-icon class="location" value="location" tooltip="i18n:ENGINE.assets.locate_asset"\n                            @click.stop="_onLocation(scene.uuid)"\n                        ></ui-icon>\n                        <ui-label class="scene-url-name">{{scene.url}}</ui-label>\n                    </div>\n                </li>\n            </ul>\n        </div>\n        <ui-button class="play transparent"\n            :active="currPlatform===\'gameView\' && gameView.isPlay"\n            @click="play()"\n        >\n            <ui-loading v-if="currPlatform ===\'browser\' && isLoading"></ui-loading>\n            <ui-icon v-else\n                :value="gameView.isPlay ? \'stop\' : \'play\'"\n            ></ui-icon>\n        </ui-button>\n        <ui-button :disabled="!gameView.isPlay" class="pause transparent"\n            v-if="currPlatform===\'gameView\'"\n            :active="currPlatform===\'gameView\' && gameView.isPaused"\n            @click="gameViewPause()"\n        >\n            <ui-icon value="pause"></ui-icon>\n        </ui-button>\n        <ui-button class="step transparent" tooltip="i18n:preview.step"\n            v-if="currPlatform===\'gameView\'" \n            @click="gameViewStep()"\n        >\n            <ui-icon value="next-step"></ui-icon>\n        </ui-button>\n        \n        <ui-button class="reload transparent" tooltip="i18n:preview.refresh_device"\n            v-if="currPlatform ===\'browser\'"\n            @click="reload"\n        >\n            <ui-icon value="reset"></ui-icon>\n        </ui-button>\n    </div>\n    <div class="qr-wrap">\n        <ui-button\n            class="transparent" \n            v-if="currPlatform ===\'browser\' || currPlatform ===\'gameView\'"\n            @click.stop="showQR"\n        >\n            <ui-icon value="qr-code"></ui-icon>\n        </ui-button>\n        <div class="qr active" ref="qr" v-show="isShowQR"\n            @click.stop\n        >\n            <canvas ref="qrcanvas" class="canvas"></canvas>\n            <div class="address">\n                <ui-label :value="address"></ui-label>\n                <ui-icon class="copy" value="copy" tooltip="i18n:preview.copy" @click="copyAddress"></ui-icon>\n            </div>\n            <ui-label value="i18n:preview.scan"></ui-label>\n        </div>\n    </div>\n</div>\n';const collator=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});exports.$={platform:".platform",play:".play",reload:".reload",preview_info:".preview-info",preview_info_wrap:".preview-info-wrap"},exports.ready=function(){window.xxx=vm=new Vue({el:this.$.preview_info_wrap,data:{scenes:[],platforms:["browser","gameView","simulator"],platformsIcon:{browser:{prefix:"sphere",suffix:""},gameView:{prefix:"scene",suffix:"experiment"},simulator:{prefix:"mini-game",suffix:""}},gameView:{isPlay:!1,isPaused:!1,isStep:!1},currPlatform:"browser",isLoading:!1,isPlaying:!1,isShowSceneList:!1,isShowPlatformsList:!1,curSelectScene:{},curSceneUrl:null,previewIp:"",previewPort:"",address:"",isShowQR:!1},watch:{currPlatform:async function(e){await Editor.Profile.setConfig("scene","console.extend.clearOnPlay.show","gameView"===e,"global"),Editor.Message.send("console","update-extension-visiable")}},mounted(){this.curSelectScene={name:""},this._refreshScenes(),Editor.Message.addBroadcastListener("scene:preview-stop",()=>{this.gameView={isPlay:!1,isPaused:!1,isStep:!1}}),this.handleOnPortChange(),this.handleOnIPChange(),Editor.Profile.getConfig("preview","preview.current.platform","local").then(e=>{console.debug(`[Preview] change platform: ${e}`),this.platformsIcon[e]||(e="browser"),this.currPlatform=e,Editor.Message.send("preview","change-platform",e)})},methods:{updateAddress(){this.address=`${this.previewIp}:${this.previewPort}`,qrcode.toCanvas(this.$refs.qrcanvas,`http://${this.address}/`,{errorCorrectionLevel:"H",maskPattern:2,margin:1,width:120,height:120})},copyAddress(){Editor.Clipboard.write("text",this.address),console.info(`Finish copying: ${this.address}`)},async updateIp(){this.previewPort=await Editor.Message.request("server","query-port"),this.previewIp=await Editor.Message.request("preview","get-preview-ip"),this.updateAddress()},showQR(){vm.hidePlatformList(),vm.hideSelectList(),this.isShowQR=!this.isShowQR,this.isShowQR&&this.updateIp()},hideQR(){this.isShowQR=!1},_onSettingsChanged(e,i,n){this.curSelectScene=n,Editor.Profile.setConfig("preview",i,e,"local"),vm.isShowSceneList=!1},_onLocation(e){Editor.Message.request("assets","ui-kit:touch-asset",e)},handleOnPortChange(){Editor.Message.addBroadcastListener("preview:port-change",e=>{this.previewPort=e,this.updateAddress()})},handleOnIPChange(){Editor.Message.addBroadcastListener("preview:ip-change",e=>{this.previewIp=e,this.updateAddress()})},async _playWithGameView(){let e=!this.gameView.isPlay;Editor.Metrics.trackTimeStart("preview:ready-gameView");const i=await Editor.Message.request("scene","editor-preview-set-play",e);Editor.Metrics.trackTimeEnd("preview:ready-gameView"),this.gameView.isPlay=i?e:!e},async _playWithoutGameView(){if(!this.isLoading){this.isLoading=!0;try{await Editor.Message.request("preview","open-terminal",!1)}finally{this.isLoading=!1}}},async play(){if(!this.isPlaying){this.isPlaying=!0;try{"gameView"===this.currPlatform?await this._playWithGameView():await this._playWithoutGameView()}catch(e){throw e}finally{this.isPlaying=!1,Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"view",value:{A100000:this.currPlatform,A100001:Editor.Project.uuid}})}}},async gameViewPause(){if(this.isPlaying)return;if(!this.gameView.isPlay)return;if(this.gameView.isStep&&this.gameView.isPaused)return;"gameView"===this.currPlatform&&(this.gameView.isPaused=!this.gameView.isPaused),!1===await Editor.Message.request("scene","editor-preview-call-method","pause",this.gameView.isPaused)&&(this.gameView.isPaused=!this.gameView.isPaused)},async gameViewStep(){if(!this.isPlaying)if(this.gameView.isPlay)this.gameView.isStep=!0,await this.gameViewPause(),Editor.Message.request("scene","editor-preview-call-method","step"),this.gameView.isStep=!1;else{await Editor.Message.request("scene","editor-preview-set-play",!0)&&(this.gameView.isPlay=!0,await this.gameViewPause())}},reload(){Editor.Message.send("preview","reload-terminal")},async changePlatform(e){this.changePlatform!==e&&("gameView"===this.currPlatform&&(this.gameView.isPlay||this.isPlaying)&&"gameView"!==e&&(await this.play(),this.gameView.isPlay=!1,this.gameView.isPaused=!1,this.isPlaying=!1),Editor.Profile.setConfig("preview","preview.current.platform",e,"local"),this.currPlatform=e,Editor.Message.send("preview","change-platform",e),vm.isShowPlatformsList=!1)},visibleSelectList(){vm._refreshScenes(),vm.hidePlatformList(),vm.hideQR(),vm.isShowSceneList=!vm.isShowSceneList},visiblePlatformList(){vm.hideSelectList(),vm.hideQR(),vm.isShowPlatformsList=!vm.isShowPlatformsList},hideSelectList(){vm.isShowSceneList=!1},hidePlatformList(){vm.isShowPlatformsList=!1},async _refreshScenes(){const e=this,i=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.SceneAsset"}),n=await Editor.Message.request("scene","query-current-scene");if(!i)return;const r=await Editor.Profile.getConfig("preview","general.start_scene"),a=i.find(e=>e.uuid===r);a&&(this.curSelectScene={name:this.splitName(a.name),uuid:a.uuid,url:a.url}),e.scenes=i.map(i=>(i.uuid===n&&(e.curSceneUrl=i.url),{uuid:i.uuid,name:this.splitName(basename(i.source)),url:i.url})).sort((e,i)=>collator.compare(e.name,i.name))},splitName(e){if(!e)return"";let i=e.split(".");return i.splice(i.length-1,1),i.length>1?i.join("."):i[0]}}}),document.addEventListener("click",()=>{vm.hidePlatformList(),vm.hideSelectList(),vm.hideQR()})};