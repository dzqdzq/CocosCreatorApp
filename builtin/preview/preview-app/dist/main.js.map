{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import { Ui } from './ui.js';\nimport { bootstrap } from './index.js';\n\nfunction addClass(element: { className: string; }, name: string) {\n    const hasClass = (' ' + element.className + ' ').indexOf(' ' + name + ' ') > -1;\n    if (!hasClass) {\n        if (element.className) {\n            element.className += ' ';\n        }\n        element.className += name;\n    }\n}\n\nfunction findCanvas() {\n    const frame = document.querySelector('#GameDiv');\n    const container = document.querySelector('#Cocos3dGameContainer');\n    const canvas = document.querySelector('#GameCanvas');\n    canvas!.setAttribute('tabindex', '99');\n\n    return { frame, container, canvas };\n}\n\nexport async function main(ui: Ui, options: bootstrap.Options) {\n    const cc = await System.import('cc');\n\n    // 抗锯齿\n    cc.macro.ENABLE_WEBGL_ANTIALIAS = true;\n\n    // 用户宏配置优先级最高\n    if (options.settings.macros) {\n        for (const key in options.settings.macros) {\n            cc.macro[key] = options.settings.macros[key];\n        }\n    }\n\n    // @ts-ignore\n    window.CC_WECHATGAME = false;\n\n    // 配置资源路径\n    const assetOptions = {\n        importBase: 'assets/general/import',\n        nativeBase: 'assets/general/native',\n    };\n\n    const adapter = findCanvas();\n    if (!adapter) {\n        throw new Error(cc.getError(200));\n    }\n\n    const debugMode = cc.DebugMode[ui.debugMode] ?? cc.DebugMode.INFO;\n\n    // 引擎启动选项\n    const option = {\n        id: ui.gameCanvas,\n        showFPS: ui.showFps,\n        debugMode,\n        frameRate: ui.frameRate,\n        groupList: options.settings.groupList,\n        collisionMatrix: options.settings.collisionMatrix,\n        adapter,\n        renderPipeline: options.settings.renderPipeline,\n        assetOptions,\n        customJointTextureLayouts: options.settings.customJointTextureLayouts || [],\n        physics: options.settings.physics,\n        exactFitScreen: false,\n    };\n\n    // need to exact fit screen on web mobile preview\n    if (ui.isFullscreen()) {\n        option.exactFitScreen = true;\n    }\n\n    const jsList: string[] = (options.settings.jsList || []).map((x: any) => '/plugins/' + x);\n    for (const url of jsList) {\n        await new Promise<void>((resolve, reject) => {\n            let err: any;\n            function windowErrorListener(evt: any) {\n                if (evt.filename === url) {\n                    err = evt.error;\n                }\n            }\n\n            window.addEventListener('error', windowErrorListener);\n\n            const script = document.createElement('script');\n            script.charset = 'utf-8';\n            script.async = true;\n            script.crossOrigin = 'anonymous';\n            script.addEventListener('error', function() {\n                window.removeEventListener('error', windowErrorListener);\n                const error = Error('Error loading ' + url);\n                ui.showError(error.message);\n                error.stack && ui.showError(error.stack);\n                reject(error);\n            });\n            script.addEventListener('load', function() {\n                window.removeEventListener('error', windowErrorListener);\n                document.head.removeChild(script);\n                // Note that if an error occurs that isn't caught by this if statement,\n                // that getRegister will return null and a \"did not instantiate\" error will be thrown.\n                if (err) {\n                    reject(err);\n                } else {\n                    resolve();\n                }\n            });\n            script.src = url.replace('#', '%23');\n            document.head.appendChild(script);\n        });\n    }\n\n    // 等待引擎启动\n    await cc.game.init(option);\n\n    try {\n        if (options.settings.customLayers) {\n            options.settings.customLayers.forEach((layer) => {\n                cc.Layers.addLayer(layer.name, layer.bit);\n            });\n        }\n    } catch (error) {\n        console.warn(error);\n    }\n\n    await import('./init-loader.js');\n    await import('cce:/internal/x/prerequisite-imports');\n\n    const { RESOURCES, MAIN } = cc.AssetManager.BuiltinBundleName;\n    const bundleRoot = options.settings.hasResourcesBundle ? [RESOURCES, MAIN] : [MAIN];\n\n    for (const bundle of bundleRoot) {\n        await new Promise<void>((resolve, reject) => {\n            cc.assetManager.loadBundle(bundle, (error: Error) => {\n                if (error) {\n                    ui.showError(error.message);\n                    error.stack && ui.showError(error.stack);\n                    reject(error);\n                } else {\n                    resolve();\n                }\n            });\n        });\n    }\n\n    const json = await getCurrentScene(options.settings.launchScene);\n\n    await cc.game.run(() => {\n        cc.game.canvas.setAttribute('tabindex', -1);\n        cc.game.canvas.style.backgroundColor = '';\n        cc.director.once(cc.Director.EVENT_AFTER_SCENE_LAUNCH, () => {\n            ui.hideSplash();\n            if (isCurrentSceneEmpty(cc)) {\n                ui.hintEmptyScene();\n            }\n        });\n\n        cc.view.resizeWithBrowserSize(true);\n        const { width, height, policy } = options.settings.designResolution;\n        // 引擎如果接受到字符串会出问题\n        cc.view.setDesignResolutionSize(Number(width), Number(height), policy || cc.ResolutionPolicy.FIXED_HEIGHT);\n        cc.game.pause();\n\n        // load scene\n        cc.assetManager.loadWithJson(json, { assetId: options.settings.launchScene },\n            // 进度条\n            (completedCount: number, totalCount: number) => {\n                const progress = 100 * completedCount / totalCount * 0.6; // 划分加载进度，场景加载 60%\n                ui.reportLoadProgress(progress);\n            },\n            (error: null | Error, sceneAsset: any) => {\n                if (error) {\n                    ui.showError(error.message);\n                    error.stack && ui.showError(error.stack);\n                    cc.error(error.stack);\n                    return;\n                }\n                const scene = sceneAsset.scene;\n                scene._name = sceneAsset._name;\n                cc.director.runSceneImmediate(scene, () => {\n                    cc.game.resume();\n                });\n            }\n        );\n    });\n\n    await new Promise((resolve) => {\n        setTimeout(resolve, 100);\n    });\n}\n\n/**\n * Check if current scene is empty.\n */\nfunction isCurrentSceneEmpty(cc: any) {\n    const scene = cc.director.getScene();\n    if (!scene || scene.children.length === 0) {\n        return true;\n    } else if (scene.children.length > 1) {\n        return false;\n    } else {\n        const child0 = scene.children[0];\n        if (child0.children.length > 0 ||\n            child0._components.length > 1 ||\n            (child0._components.length > 0 && !(child0._components[0] instanceof cc.Canvas))) {\n            return false;\n        } else {\n            return true;\n        }\n    }\n}\n\n/**\n * 读取当前场景 json 数据\n */\nfunction getCurrentScene(launchScene?: string) {\n    return new Promise<any>((resolve, reject) => {\n        const request = new XMLHttpRequest();\n        request.responseType = 'text';\n        request.addEventListener('load', () => {\n            if (request.status === 200) {\n                resolve(JSON.parse(request.response));\n            }\n        });\n        request.open('GET', `scene/${launchScene}.json`, true);\n        request.send();\n    });\n}\n"]}