{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IASA,SAAe,SAAS,CAAC,OAA0B;;;;;;;wBAE3C,qBAAM,cAAc,CAAC,OAAO,CAAC,EAAA;;wBAA7B,SAA6B,CAAC;;;;wBAE9B,OAAO,CAAC,KAAK,CAAC,OAAK,CAAC,CAAC;;;;;;KAE5B;;IAuBD,SAAe,cAAc,CAAC,OAA0B;;YAUpD,SAAS,uBAAuB;gBAC5B,IAAM,WAAW,GAAG,UAAS,KAAyB;oBAClD,IAAI,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,gBAAgB,CAAC,EAAE;wBAC1C,OAAO;qBACV;oBACD,wBAAO,CAAC,KAAK,GAAG,IAAI,CAAC;oBACrB,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;oBACrB,EAAE,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;oBACpB,oCAAoC;oBACpC,OAAO,IAAI,CAAC;gBAChB,CAAC,CAAC;gBACF,SAAS;gBACT,MAAM,CAAC,gBAAgB,CACnB,OAAO;gBACP,aAAa;gBACb,WAAW,EACX,IAAI,CACP,CAAC;gBACF,MAAM,CAAC,gBAAgB,CACnB,oBAAoB;gBACpB,aAAa;gBACb,UAAC,KAA4B;oBACzB,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;oBACrB,EAAE,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;gBACxB,CAAC,EACD,IAAI,CACP,CAAC;YACN,CAAC;YAED,SAAe,YAAY;;;;;oCAEN,sCAAa,yBAAyB,GAAC;;gCAAlD,QAAQ,GAAG,SAAuC;gCAClD,MAAM,GAAG,QAAQ,CAAC,OAAO,EAAE,CAAC;gCAClC,MAAM,CAAC,EAAE,CAAC,gBAAgB,EAAE;oCACxB,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;gCAC7B,CAAC,CAAC,CAAC;gCACH,MAAM,CAAC,EAAE,CAAC,eAAe,EAAE;oCACvB,MAAM,CAAC,KAAK,EAAE,CAAC;gCACnB,CAAC,CAAC,CAAC;gCACH,MAAM,CAAC,EAAE,CAAC,oBAAoB,EAAE;oCAC5B,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;gCAC7B,CAAC,CAAC,CAAC;gCACH,sBAAO,MAAM,EAAC;;;;aACjB;;;;4BApDc,qBAAM,YAAY,EAAE,EAAA;;wBAA7B,MAAM,GAAG,SAAoB;wBAE7B,EAAE,GAAG,IAAI,UAAE,CAAC;4BACd,OAAO,EAAE,OAAO,CAAC,OAAO;4BACxB,IAAI,EAAE,UAAC,KAAK;gCAAE,cAAO;qCAAP,UAAO,EAAP,qBAAO,EAAP,IAAO;oCAAP,6BAAO;;gCACjB,MAAM,CAAC,IAAI,OAAX,MAAM,iBAAM,KAAK,GAAK,IAAI,UAAE;4BAChC,CAAC;yBACJ,CAAC,CAAC;;;;wBAgDC,uBAAuB,EAAE,CAAC;wBACf,qBAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAA;;wBAA9B,EAAE,GAAG,SAAyB;wBACpC,EAAE,CAAC,UAAU,CAAC,EAAE,CAAC,CAAC;wBAClB,qBAAM,cAAI,CAAC,EAAE,EAAE,OAAO,CAAC,EAAA;;wBAAvB,SAAuB,CAAC;;;;wBAExB,OAAO,CAAC,KAAK,CAAC,OAAK,CAAC,CAAC;;;;;;KAE5B","sourcesContent":["import { Ui } from './ui.js';\nimport { globals } from './app-globals.js';\nimport { main } from './main.js';\n\nimport { IOutputSettings, ISettings } from '../../../builder/@types/public/build-result';\ndeclare global {\n    const System: any;\n}\n\nasync function bootstrap(options: bootstrap.Options) {\n    try {\n        await bootstrapAsync(options);\n    } catch (error) {\n        console.error(error);\n    }\n}\n\ndeclare namespace bootstrap {\n    export interface Options {\n        /**\n         * 引擎模块 URL。\n         */\n        engineBaseUrl: string;\n\n        devices: Record<string, {\n            name: string;\n            width: number;\n            height: number;\n            ratio?: number;\n        }>;\n\n        /**\n         * Settings。\n         */\n        settings: IOutputSettings;\n    }\n}\n\nasync function bootstrapAsync(options: bootstrap.Options) {\n    const socket = await createSocket();\n\n    const ui = new Ui({\n        devices: options.devices,\n        emit: (event, ...args) => {\n            socket.emit(event, ...args);\n        },\n    });\n\n    function installDiagnosisRoutine() {\n        const errorHandle = function(error: Error | ErrorEvent) {\n            if (error.message.includes('debug-evaluate')) {\n                return;\n            }\n            globals.error = true;\n            console.error(error);\n            ui.showError(error);\n            // 注意，在返回 true 的时候，异常才不会继续向上抛出error;\n            return true;\n        };\n        // 全局捕获错误\n        window.addEventListener(\n            'error',\n            // @ts-ignore\n            errorHandle,\n            true,\n        );\n        window.addEventListener(\n            'unhandledrejection',\n            // @ts-ignore\n            (error: PromiseRejectionEvent) => {\n                console.error(error);\n                ui.showError(error);\n            },\n            true,\n        );\n    }\n\n    async function createSocket() {\n        // @ts-ignore\n        const socketIo = await import('/socket.io/socket.io.js');\n        const socket = socketIo.default();\n        socket.on('browser:reload', function() {\n            window.location.reload();\n        });\n        socket.on('browser:close', function() {\n            window.close();\n        });\n        socket.on('browser:disconnect', function() {\n            window.location.reload();\n        });\n        return socket;\n    }\n\n    try {\n        installDiagnosisRoutine();\n        const cc = await System.import('cc');\n        ui.bindEngine(cc);\n        await main(ui, options);\n    } catch (error: any) {\n        console.error(error);\n    }\n}\n\nexport { bootstrap };\n"]}