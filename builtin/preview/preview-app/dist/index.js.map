{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Ui } from './ui.js';\nimport { globals } from './app-globals.js';\nimport { main } from './main.js';\n\nimport { ISettings } from '../../../builder/@types/public/build-result';\ndeclare global {\n    const System: any;\n}\n\nfunction bootstrap(options: bootstrap.Options) {\n    (async () => {\n        await bootstrapAsync(options);\n    })().catch((err) => {\n        console.error(err);\n    });\n}\n\ndeclare namespace bootstrap {\n    export interface Options {\n        /**\n         * 引擎模块 URL。\n         */\n        engineBaseUrl: string;\n\n        devices: Record<string, {\n            name: string;\n            width: number;\n            height: number;\n            ratio?: number;\n        }>;\n\n        /**\n         * Settings。\n         */\n        settings: ISettings;\n    }\n}\n\nasync function bootstrapAsync(options: bootstrap.Options) {\n    const socket = await createSocket();\n\n    const ui = new Ui({\n        devices: options.devices,\n        emit: (event, ...args) => {\n            socket.emit(event, ...args);\n        },\n    });\n\n    installDiagnosisRoutine();\n\n    const engineModuleEntries: string[] = options.settings.engineModules;\n    const hasPhysicsAmmo = engineModuleEntries.findIndex((entry) => entry === 'physics-ammo') >= 0;\n    if (hasPhysicsAmmo) {\n        // @ts-ignore\n        const { default: waitForAmmoInstantiation } = await import('cce:/internal/x/cc-fu/wait-for-ammo-instantiation');\n        await waitForAmmoInstantiation();\n    }\n\n    const cc = await System.import('cc');\n    ui.bindEngine(cc);\n    await main(ui, options);\n\n    function installDiagnosisRoutine() {\n        const errorHandle = function(error: Error) {\n            globals.error = true;\n            // @ts-ignore\n            const eventType = [].toString.call(error, error);\n            console.error(error);\n            if (eventType === '[object Event]') {\n                // 加载错误,显示错误页面\n                // @ts-ignore\n                ui.showError(`load ${error.target.src} failed`);\n            } else {\n                // @ts-ignore\n                ui.showError(`${error.message} in ${error.filename}`);\n            }\n            // 注意，在返回 true 的时候，异常才不会继续向上抛出error;\n            return true;\n        };\n        // 全局捕获错误\n        window.addEventListener(\n            'error',\n            // @ts-ignore\n            errorHandle,\n            true,\n        );\n        window.addEventListener(\n            'unhandledrejection',\n            // @ts-ignore\n            (error: PromiseRejectionEvent) => {\n                ui.showError(`${error.type}: ${error.reason.message}`);\n                ui.showError(error.reason.stack);\n            },\n            true,\n        );\n    }\n\n    async function createSocket() {\n        // @ts-ignore\n        const socketIo = await import('/socket.io/socket.io.js');\n        const socket = socketIo.default();\n        socket.on('browser:reload', function() {\n            window.location.reload();\n        });\n        socket.on('browser:disconnect', function() {\n            window.location.reload();\n        });\n        return socket;\n    }\n}\n\nexport { bootstrap };\n"]}