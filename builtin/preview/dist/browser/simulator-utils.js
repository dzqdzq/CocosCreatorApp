"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateSimulatorConfig = exports.getSimulatorPreference = exports.getJsEnginePath = exports.getNativeEnginePath = exports.formatPath = exports.copyDirSync = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
function copyDirSync(path, dest) {
    if (!fs_extra_1.existsSync(path)) {
        return 0;
    }
    const stat = fs_extra_1.statSync(path);
    if (!stat.isDirectory()) {
        fs_extra_1.ensureDirSync(path_1.dirname(dest));
        return fs_extra_1.copyFileSync(path, dest);
    }
    // 文件夹
    const files = fs_extra_1.readdirSync(path);
    fs_extra_1.ensureDirSync(dest);
    files.forEach((fileName) => {
        const file = path_1.join(path, fileName);
        const fileDest = path_1.join(dest, fileName);
        copyDirSync(file, fileDest);
    });
}
exports.copyDirSync = copyDirSync;
function formatPath(pathToFormat) {
    return pathToFormat.replace(/\\/g, '/');
}
exports.formatPath = formatPath;
async function getNativeEnginePath() {
    return (await Editor.Message.request('engine', 'query-info')).nativePath;
}
exports.getNativeEnginePath = getNativeEnginePath;
async function getJsEnginePath() {
    return (await Editor.Message.request('engine', 'query-info')).path;
}
exports.getJsEnginePath = getJsEnginePath;
async function getSimulatorPreference() {
    var _a;
    let showDebugPanel = await Editor.Profile.getConfig('preview', 'preview.simulator_debugger');
    let waitForConnect = false;
    if (showDebugPanel) {
        waitForConnect = await Editor.Profile.getConfig('preview', 'preview.wait_for_connect');
    }
    let orientation = await Editor.Profile.getConfig('preview', 'preview.simulator_orientation');
    let device = await Editor.Message.request('device', 'query');
    let resolutionIndex = await Editor.Profile.getConfig('preview', 'preview.simulator_resolution');
    let resolution = (_a = device[resolutionIndex]) !== null && _a !== void 0 ? _a : device[0];
    return {
        showDebugPanel,
        waitForConnect,
        orientation,
        resolution,
    };
}
exports.getSimulatorPreference = getSimulatorPreference;
/**
 * 生成模拟器 config.json 配置文件，模拟器启动阶段会去解析这份配置
 */
async function generateSimulatorConfig() {
    // 路径处理
    let isDarwin = process.platform === 'darwin';
    let nativeEnginePath = await getNativeEnginePath();
    let simulatorResourcesMac = path_1.join(nativeEnginePath, 'simulator/Debug/SimulatorApp-Mac.app/Contents/Resources');
    let simulatorWritablePath = isDarwin ? simulatorResourcesMac : path_1.join(process.env.LOCALAPPDATA, 'SimulatorApp-Win32/debugruntime');
    // 偏好设置
    let preference = await getSimulatorPreference();
    // 写入 JSON
    fs_extra_1.ensureDirSync(simulatorWritablePath);
    let simulatorConfigPath = path_1.join(simulatorWritablePath, 'config.json');
    let simulatorConfigData = {
        name: 'Simulator',
        entry: 'main.js',
        isLandscape: preference.orientation === 'landscape',
        isWindowTop: false,
        waitForConnect: preference.waitForConnect,
        width: preference.resolution.width,
        height: preference.resolution.height,
        consolePort: 6050,
        uploadPort: 6060,
        debugPort: 5086,
    };
    await fs_extra_1.writeFile(simulatorConfigPath, JSON.stringify(simulatorConfigData, undefined, 2), 'utf8');
}
exports.generateSimulatorConfig = generateSimulatorConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdG9yLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvc2ltdWxhdG9yLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUFxRztBQUNyRywrQkFBcUM7QUFTckMsU0FBZ0IsV0FBVyxDQUFDLElBQVksRUFBRSxJQUFZO0lBQ2xELElBQUksQ0FBQyxxQkFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ25CLE9BQU8sQ0FBQyxDQUFDO0tBQ1o7SUFDRCxNQUFNLElBQUksR0FBRyxtQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7UUFDckIsd0JBQWEsQ0FBQyxjQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM3QixPQUFPLHVCQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ25DO0lBQ0QsTUFBTTtJQUNOLE1BQU0sS0FBSyxHQUFHLHNCQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsd0JBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDdkIsTUFBTSxJQUFJLEdBQUcsV0FBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsQyxNQUFNLFFBQVEsR0FBRyxXQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBakJELGtDQWlCQztBQUVELFNBQWdCLFVBQVUsQ0FBRSxZQUFvQjtJQUM1QyxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFGRCxnQ0FFQztBQUVNLEtBQUss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QyxDQUFDO0FBQ3BHLENBQUM7QUExQkQsMERBMEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29weUZpbGVTeW5jLCBlbnN1cmVEaXJTeW5jLCBleGlzdHNTeW5jLCByZWFkZGlyU3luYywgc3RhdFN5bmMsIHdyaXRlRmlsZSB9IGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgam9pbiwgZGlybmFtZSB9IGZyb20gXCJwYXRoXCI7XG5cbmludGVyZmFjZSBSZXNvbHV0aW9uSW5mbyB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHdpZHRoOiBudW1iZXIsXG4gICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgcmF0aW86IG51bWJlcixcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvcHlEaXJTeW5jKHBhdGg6IHN0cmluZywgZGVzdDogc3RyaW5nKSB7XG4gICAgaWYgKCFleGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ID0gc3RhdFN5bmMocGF0aCk7XG4gICAgaWYgKCFzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgZW5zdXJlRGlyU3luYyhkaXJuYW1lKGRlc3QpKTtcbiAgICAgICAgcmV0dXJuIGNvcHlGaWxlU3luYyhwYXRoLCBkZXN0KTtcbiAgICB9XG4gICAgLy8g5paH5Lu25aS5XG4gICAgY29uc3QgZmlsZXMgPSByZWFkZGlyU3luYyhwYXRoKTtcbiAgICBlbnN1cmVEaXJTeW5jKGRlc3QpO1xuICAgIGZpbGVzLmZvckVhY2goKGZpbGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBqb2luKHBhdGgsIGZpbGVOYW1lKTtcbiAgICAgICAgY29uc3QgZmlsZURlc3QgPSBqb2luKGRlc3QsIGZpbGVOYW1lKTtcbiAgICAgICAgY29weURpclN5bmMoZmlsZSwgZmlsZURlc3QpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0UGF0aCAocGF0aFRvRm9ybWF0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aFRvRm9ybWF0LnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE5hdGl2ZUVuZ2luZVBhdGggKCkge1xuICAgIHJldHVybiAoYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnZW5naW5lJywgJ3F1ZXJ5LWluZm8nKSkubmF0aXZlUGF0aDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEpzRW5naW5lUGF0aCAoKSB7XG4gICAgcmV0dXJuIChhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdlbmdpbmUnLCAncXVlcnktaW5mbycpKS5wYXRoO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2ltdWxhdG9yUHJlZmVyZW5jZSAoKSB7XG4gICAgbGV0IHNob3dEZWJ1Z1BhbmVsID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcuc2ltdWxhdG9yX2RlYnVnZ2VyJyk7XG4gICAgbGV0IHdhaXRGb3JDb25uZWN0ID0gZmFsc2U7XG4gICAgaWYgKHNob3dEZWJ1Z1BhbmVsKSB7XG4gICAgICAgIHdhaXRGb3JDb25uZWN0ID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcud2FpdF9mb3JfY29ubmVjdCcpO1xuICAgIH1cbiAgICBsZXQgb3JpZW50YXRpb24gPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ3ByZXZpZXcnLCAncHJldmlldy5zaW11bGF0b3Jfb3JpZW50YXRpb24nKTtcbiAgICBsZXQgZGV2aWNlID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnZGV2aWNlJywgJ3F1ZXJ5Jyk7XG4gICAgbGV0IHJlc29sdXRpb25JbmRleCAgPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ3ByZXZpZXcnLCAncHJldmlldy5zaW11bGF0b3JfcmVzb2x1dGlvbicpO1xuICAgIGxldCByZXNvbHV0aW9uID0gZGV2aWNlW3Jlc29sdXRpb25JbmRleF0gPz8gZGV2aWNlWzBdO1xuICAgIHJldHVybiAge1xuICAgICAgICBzaG93RGVidWdQYW5lbCxcbiAgICAgICAgd2FpdEZvckNvbm5lY3QsXG4gICAgICAgIG9yaWVudGF0aW9uLFxuICAgICAgICByZXNvbHV0aW9uLFxuICAgIH07XG59XG5cbi8qKlxuICog55Sf5oiQ5qih5ouf5ZmoIGNvbmZpZy5qc29uIOmFjee9ruaWh+S7tu+8jOaooeaLn+WZqOWQr+WKqOmYtuauteS8muWOu+ino+aekOi/meS7vemFjee9rlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVTaW11bGF0b3JDb25maWcgKCkge1xuICAgIC8vIOi3r+W+hOWkhOeQhlxuICAgIGxldCBpc0RhcndpbiA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICdkYXJ3aW4nO1xuICAgIGxldCBuYXRpdmVFbmdpbmVQYXRoID0gYXdhaXQgZ2V0TmF0aXZlRW5naW5lUGF0aCgpO1xuICAgIGxldCBzaW11bGF0b3JSZXNvdXJjZXNNYWMgPSBqb2luKG5hdGl2ZUVuZ2luZVBhdGgsICdzaW11bGF0b3IvRGVidWcvU2ltdWxhdG9yQXBwLU1hYy5hcHAvQ29udGVudHMvUmVzb3VyY2VzJyk7XG4gICAgbGV0IHNpbXVsYXRvcldyaXRhYmxlUGF0aCA9IGlzRGFyd2luPyBzaW11bGF0b3JSZXNvdXJjZXNNYWM6IGpvaW4ocHJvY2Vzcy5lbnYuTE9DQUxBUFBEQVRBIGFzIHN0cmluZywgJ1NpbXVsYXRvckFwcC1XaW4zMi9kZWJ1Z3J1bnRpbWUnKTtcbiAgICBcbiAgICAvLyDlgY/lpb3orr7nva5cbiAgICBsZXQgcHJlZmVyZW5jZSA9IGF3YWl0IGdldFNpbXVsYXRvclByZWZlcmVuY2UoKTtcbiAgICBcbiAgICAvLyDlhpnlhaUgSlNPTlxuICAgIGVuc3VyZURpclN5bmMoc2ltdWxhdG9yV3JpdGFibGVQYXRoKTtcbiAgICBsZXQgc2ltdWxhdG9yQ29uZmlnUGF0aCA9IGpvaW4oc2ltdWxhdG9yV3JpdGFibGVQYXRoLCAnY29uZmlnLmpzb24nKTtcbiAgICBsZXQgc2ltdWxhdG9yQ29uZmlnRGF0YSA9IHtcbiAgICAgICAgbmFtZTogJ1NpbXVsYXRvcicsXG4gICAgICAgIGVudHJ5OiAnbWFpbi5qcycsXG4gICAgICAgIGlzTGFuZHNjYXBlOiBwcmVmZXJlbmNlLm9yaWVudGF0aW9uID09PSAnbGFuZHNjYXBlJyxcbiAgICAgICAgaXNXaW5kb3dUb3A6IGZhbHNlLFxuICAgICAgICB3YWl0Rm9yQ29ubmVjdDogcHJlZmVyZW5jZS53YWl0Rm9yQ29ubmVjdCxcbiAgICAgICAgd2lkdGg6IHByZWZlcmVuY2UucmVzb2x1dGlvbi53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiBwcmVmZXJlbmNlLnJlc29sdXRpb24uaGVpZ2h0LFxuICAgICAgICBjb25zb2xlUG9ydDogNjA1MCxcbiAgICAgICAgdXBsb2FkUG9ydDogNjA2MCxcbiAgICAgICAgZGVidWdQb3J0OiA1MDg2LFxuICAgIH07XG4gICAgYXdhaXQgd3JpdGVGaWxlKHNpbXVsYXRvckNvbmZpZ1BhdGgsIEpTT04uc3RyaW5naWZ5KHNpbXVsYXRvckNvbmZpZ0RhdGEsIHVuZGVmaW5lZCwgMiksICd1dGY4Jyk7XG59Il19