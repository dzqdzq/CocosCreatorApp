"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateSimulatorConfig = exports.getSimulatorPreference = exports.getJsEnginePath = exports.getNativeEnginePath = exports.formatPath = exports.copyDirSync = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
function copyDirSync(path, dest) {
    if (!fs_extra_1.existsSync(path)) {
        return 0;
    }
    const stat = fs_extra_1.statSync(path);
    if (!stat.isDirectory()) {
        fs_extra_1.ensureDirSync(path_1.dirname(dest));
        return fs_extra_1.copyFileSync(path, dest);
    }
    // 文件夹
    const files = fs_extra_1.readdirSync(path);
    fs_extra_1.ensureDirSync(dest);
    files.forEach((fileName) => {
        const file = path_1.join(path, fileName);
        const fileDest = path_1.join(dest, fileName);
        copyDirSync(file, fileDest);
    });
}
exports.copyDirSync = copyDirSync;
function formatPath(pathToFormat) {
    return pathToFormat.replace(/\\/g, '/');
}
exports.formatPath = formatPath;
async function getNativeEnginePath() {
    return (await Editor.Message.request('engine', 'query-info')).nativePath;
}
exports.getNativeEnginePath = getNativeEnginePath;
async function getJsEnginePath() {
    return (await Editor.Message.request('engine', 'query-info')).path;
}
exports.getJsEnginePath = getJsEnginePath;
async function getSimulatorPreference() {
    var _a;
    let showDebugPanel = await Editor.Profile.getConfig('preview', 'preview.simulator_debugger');
    let waitForConnect = false;
    if (showDebugPanel) {
        waitForConnect = await Editor.Profile.getConfig('preview', 'preview.wait_for_connect');
    }
    let orientation = await Editor.Profile.getConfig('preview', 'preview.simulator_orientation');
    let device = await Editor.Message.request('device', 'query');
    let resolutionIndex = await Editor.Profile.getConfig('preview', 'preview.simulator_resolution');
    let resolution = (_a = device[resolutionIndex]) !== null && _a !== void 0 ? _a : device[0];
    return {
        showDebugPanel,
        waitForConnect,
        orientation,
        resolution,
    };
}
exports.getSimulatorPreference = getSimulatorPreference;
/**
 * 生成模拟器 config.json 配置文件，模拟器启动阶段会去解析这份配置
 */
async function generateSimulatorConfig() {
    // 路径处理
    let isDarwin = process.platform === 'darwin';
    let nativeEnginePath = await getNativeEnginePath();
    let simulatorResourcesMac = path_1.join(nativeEnginePath, 'simulator/Debug/SimulatorApp-Mac.app/Contents/Resources');
    let simulatorWritablePath = isDarwin ? simulatorResourcesMac : path_1.join(process.env.LOCALAPPDATA, 'SimulatorApp-Win32/debugruntime');
    // 偏好设置
    let preference = await getSimulatorPreference();
    // 写入 JSON
    fs_extra_1.ensureDirSync(simulatorWritablePath);
    let simulatorConfigPath = path_1.join(simulatorWritablePath, 'config.json');
    let simulatorConfigData = {
        name: 'Simulator',
        entry: 'main.js',
        isLandscape: preference.orientation === 'landscape',
        isWindowTop: false,
        waitForConnect: preference.waitForConnect,
        width: preference.resolution.width,
        height: preference.resolution.height,
        consolePort: 6050,
        uploadPort: 6060,
        debugPort: 5086,
    };
    await fs_extra_1.writeFile(simulatorConfigPath, JSON.stringify(simulatorConfigData, undefined, 2), 'utf8');
}
exports.generateSimulatorConfig = generateSimulatorConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdG9yLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvc2ltdWxhdG9yLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUFxRztBQUNyRywrQkFBcUM7QUFTckMsU0FBZ0IsV0FBVyxDQUFDLElBQVksRUFBRSxJQUFZO0lBQ2xELElBQUksQ0FBQyxxQkFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ25CLE9BQU8sQ0FBQyxDQUFDO0tBQ1o7SUFDRCxNQUFNLElBQUksR0FBRyxtQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7UUFDckIsd0JBQWEsQ0FBQyxjQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM3QixPQUFPLHVCQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ25DO0lBQ0QsTUFBTTtJQUNOLE1BQU0sS0FBSyxHQUFHLHNCQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsd0JBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDdkIsTUFBTSxJQUFJLEdBQUcsV0FBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsQyxNQUFNLFFBQVEsR0FBRyxXQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBakJELGtDQWlCQztBQUVELFNBQWdCLFVBQVUsQ0FBRSxZQUFvQjtJQUM1QyxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFGRCxnQ0FFQztBQUVNLEtBQUss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QztBQUNwRyxDQUFDO0FBMUJELDBEQTBCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvcHlGaWxlU3luYywgZW5zdXJlRGlyU3luYywgZXhpc3RzU3luYywgcmVhZGRpclN5bmMsIHN0YXRTeW5jLCB3cml0ZUZpbGUgfSBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUgfSBmcm9tIFwicGF0aFwiO1xuXG5pbnRlcmZhY2UgUmVzb2x1dGlvbkluZm8ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIHJhdGlvOiBudW1iZXIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3B5RGlyU3luYyhwYXRoOiBzdHJpbmcsIGRlc3Q6IHN0cmluZykge1xuICAgIGlmICghZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgY29uc3Qgc3RhdCA9IHN0YXRTeW5jKHBhdGgpO1xuICAgIGlmICghc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGVuc3VyZURpclN5bmMoZGlybmFtZShkZXN0KSk7XG4gICAgICAgIHJldHVybiBjb3B5RmlsZVN5bmMocGF0aCwgZGVzdCk7XG4gICAgfVxuICAgIC8vIOaWh+S7tuWkuVxuICAgIGNvbnN0IGZpbGVzID0gcmVhZGRpclN5bmMocGF0aCk7XG4gICAgZW5zdXJlRGlyU3luYyhkZXN0KTtcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBmaWxlID0gam9pbihwYXRoLCBmaWxlTmFtZSk7XG4gICAgICAgIGNvbnN0IGZpbGVEZXN0ID0gam9pbihkZXN0LCBmaWxlTmFtZSk7XG4gICAgICAgIGNvcHlEaXJTeW5jKGZpbGUsIGZpbGVEZXN0KTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFBhdGggKHBhdGhUb0Zvcm1hdDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHBhdGhUb0Zvcm1hdC5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXROYXRpdmVFbmdpbmVQYXRoICgpIHtcbiAgICByZXR1cm4gKGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2VuZ2luZScsICdxdWVyeS1pbmZvJykpLm5hdGl2ZVBhdGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRKc0VuZ2luZVBhdGggKCkge1xuICAgIHJldHVybiAoYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnZW5naW5lJywgJ3F1ZXJ5LWluZm8nKSkucGF0aDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNpbXVsYXRvclByZWZlcmVuY2UgKCkge1xuICAgIGxldCBzaG93RGVidWdQYW5lbCA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LnNpbXVsYXRvcl9kZWJ1Z2dlcicpO1xuICAgIGxldCB3YWl0Rm9yQ29ubmVjdCA9IGZhbHNlO1xuICAgIGlmIChzaG93RGVidWdQYW5lbCkge1xuICAgICAgICB3YWl0Rm9yQ29ubmVjdCA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LndhaXRfZm9yX2Nvbm5lY3QnKTtcbiAgICB9XG4gICAgbGV0IG9yaWVudGF0aW9uID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcuc2ltdWxhdG9yX29yaWVudGF0aW9uJyk7XG4gICAgbGV0IGRldmljZSA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2RldmljZScsICdxdWVyeScpO1xuICAgIGxldCByZXNvbHV0aW9uSW5kZXggID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKCdwcmV2aWV3JywgJ3ByZXZpZXcuc2ltdWxhdG9yX3Jlc29sdXRpb24nKTtcbiAgICBsZXQgcmVzb2x1dGlvbiA9IGRldmljZVtyZXNvbHV0aW9uSW5kZXhdID8/IGRldmljZVswXTtcbiAgICByZXR1cm4gIHtcbiAgICAgICAgc2hvd0RlYnVnUGFuZWwsXG4gICAgICAgIHdhaXRGb3JDb25uZWN0LFxuICAgICAgICBvcmllbnRhdGlvbixcbiAgICAgICAgcmVzb2x1dGlvbixcbiAgICB9O1xufVxuXG4vKipcbiAqIOeUn+aIkOaooeaLn+WZqCBjb25maWcuanNvbiDphY3nva7mlofku7bvvIzmqKHmi5/lmajlkK/liqjpmLbmrrXkvJrljrvop6PmnpDov5nku73phY3nva5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU2ltdWxhdG9yQ29uZmlnICgpIHtcbiAgICAvLyDot6/lvoTlpITnkIZcbiAgICBsZXQgaXNEYXJ3aW4gPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnZGFyd2luJztcbiAgICBsZXQgbmF0aXZlRW5naW5lUGF0aCA9IGF3YWl0IGdldE5hdGl2ZUVuZ2luZVBhdGgoKTtcbiAgICBsZXQgc2ltdWxhdG9yUmVzb3VyY2VzTWFjID0gam9pbihuYXRpdmVFbmdpbmVQYXRoLCAnc2ltdWxhdG9yL0RlYnVnL1NpbXVsYXRvckFwcC1NYWMuYXBwL0NvbnRlbnRzL1Jlc291cmNlcycpO1xuICAgIGxldCBzaW11bGF0b3JXcml0YWJsZVBhdGggPSBpc0Rhcndpbj8gc2ltdWxhdG9yUmVzb3VyY2VzTWFjOiBqb2luKHByb2Nlc3MuZW52LkxPQ0FMQVBQREFUQSBhcyBzdHJpbmcsICdTaW11bGF0b3JBcHAtV2luMzIvZGVidWdydW50aW1lJyk7XG4gICAgXG4gICAgLy8g5YGP5aW96K6+572uXG4gICAgbGV0IHByZWZlcmVuY2UgPSBhd2FpdCBnZXRTaW11bGF0b3JQcmVmZXJlbmNlKCk7XG4gICAgXG4gICAgLy8g5YaZ5YWlIEpTT05cbiAgICBlbnN1cmVEaXJTeW5jKHNpbXVsYXRvcldyaXRhYmxlUGF0aCk7XG4gICAgbGV0IHNpbXVsYXRvckNvbmZpZ1BhdGggPSBqb2luKHNpbXVsYXRvcldyaXRhYmxlUGF0aCwgJ2NvbmZpZy5qc29uJyk7XG4gICAgbGV0IHNpbXVsYXRvckNvbmZpZ0RhdGEgPSB7XG4gICAgICAgIG5hbWU6ICdTaW11bGF0b3InLFxuICAgICAgICBlbnRyeTogJ21haW4uanMnLFxuICAgICAgICBpc0xhbmRzY2FwZTogcHJlZmVyZW5jZS5vcmllbnRhdGlvbiA9PT0gJ2xhbmRzY2FwZScsXG4gICAgICAgIGlzV2luZG93VG9wOiBmYWxzZSxcbiAgICAgICAgd2FpdEZvckNvbm5lY3Q6IHByZWZlcmVuY2Uud2FpdEZvckNvbm5lY3QsXG4gICAgICAgIHdpZHRoOiBwcmVmZXJlbmNlLnJlc29sdXRpb24ud2lkdGgsXG4gICAgICAgIGhlaWdodDogcHJlZmVyZW5jZS5yZXNvbHV0aW9uLmhlaWdodCxcbiAgICAgICAgY29uc29sZVBvcnQ6IDYwNTAsXG4gICAgICAgIHVwbG9hZFBvcnQ6IDYwNjAsXG4gICAgICAgIGRlYnVnUG9ydDogNTA4NixcbiAgICB9O1xuICAgIGF3YWl0IHdyaXRlRmlsZShzaW11bGF0b3JDb25maWdQYXRoLCBKU09OLnN0cmluZ2lmeShzaW11bGF0b3JDb25maWdEYXRhLCB1bmRlZmluZWQsIDIpLCAndXRmOCcpO1xufSJdfQ==