"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.copyDirSync = copyDirSync;
exports.formatPath = formatPath;
exports.getNativeEnginePath = getNativeEnginePath;
exports.getJsEnginePath = getJsEnginePath;
exports.getSimulatorPreference = getSimulatorPreference;
exports.generateSimulatorConfig = generateSimulatorConfig;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
function copyDirSync(path, dest) {
    if (!(0, fs_extra_1.existsSync)(path)) {
        return 0;
    }
    const stat = (0, fs_extra_1.statSync)(path);
    if (!stat.isDirectory()) {
        (0, fs_extra_1.ensureDirSync)((0, path_1.dirname)(dest));
        return (0, fs_extra_1.copyFileSync)(path, dest);
    }
    // 文件夹
    const files = (0, fs_extra_1.readdirSync)(path);
    (0, fs_extra_1.ensureDirSync)(dest);
    files.forEach((fileName) => {
        const file = (0, path_1.join)(path, fileName);
        const fileDest = (0, path_1.join)(dest, fileName);
        copyDirSync(file, fileDest);
    });
}
function formatPath(pathToFormat) {
    return pathToFormat.replace(/\\/g, '/');
}
async function getNativeEnginePath() {
    return (await Editor.Message.request('engine', 'query-engine-info')).native.path;
}
async function getJsEnginePath() {
    return (await Editor.Message.request('engine', 'query-engine-info')).typescript.path;
}
async function getSimulatorPreference() {
    const showDebugPanel = await Editor.Profile.getConfig('preview', 'preview.simulator_debugger');
    let waitForConnect = false;
    if (showDebugPanel) {
        waitForConnect = await Editor.Profile.getConfig('preview', 'preview.wait_for_connect');
    }
    const orientation = await Editor.Profile.getConfig('preview', 'preview.simulator_orientation');
    const device = await Editor.Message.request('device', 'query');
    const resolutionIndex = await Editor.Profile.getConfig('preview', 'preview.simulator_resolution');
    let resolution = device[resolutionIndex] ?? device[0];
    if (!resolution) {
        // 无法从设备管理器处拿到合适的设备信息里，此时使用默认的设计分辨率作为默认的窗口大小
        resolution = await Editor.Profile.getProject('project', 'general.designResolution');
    }
    return {
        showDebugPanel,
        waitForConnect,
        orientation,
        resolution,
    };
}
/**
 * 生成模拟器 config.json 配置文件，模拟器启动阶段会去解析这份配置
 */
async function generateSimulatorConfig() {
    // 路径处理
    const isDarwin = process.platform === 'darwin';
    const nativeEnginePath = await getNativeEnginePath();
    const simulatorResourcesMac = (0, path_1.join)(nativeEnginePath, 'simulator/Release/SimulatorApp-Mac.app/Contents/Resources');
    const simulatorWritablePath = isDarwin ? simulatorResourcesMac : (0, path_1.join)(process.env.LOCALAPPDATA, 'SimulatorApp-Win32/debugruntime');
    // 偏好设置
    const preference = await getSimulatorPreference();
    // 写入 JSON
    (0, fs_extra_1.ensureDirSync)(simulatorWritablePath);
    const simulatorConfigPath = (0, path_1.join)(simulatorWritablePath, 'config.json');
    const simulatorConfigData = {
        name: 'Simulator',
        entry: 'main.js',
        isLandscape: preference.orientation === 'landscape',
        isWindowTop: false,
        waitForConnect: preference.waitForConnect,
        width: preference.resolution.width,
        height: preference.resolution.height,
        consolePort: 6050,
        uploadPort: 6060,
        debugPort: 5086,
    };
    await (0, fs_extra_1.writeFile)(simulatorConfigPath, JSON.stringify(simulatorConfigData, undefined, 2), 'utf8');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdG9yLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc291cmNlL2Jyb3dzZXIvc2ltdWxhdG9yLXV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBVUEsa0NBaUJDO0FBRUQsZ0NBRUM7QUFFRCxrREFFQztBQUVELDBDQUVDO0FBRUQsd0RBb0JDO0FBS0QsMERBMEJDO0FBNUZELHVDQUFxRztBQUNyRywrQkFBcUM7QUFTckMsU0FBZ0IsV0FBVyxDQUFDLElBQVksRUFBRSxJQUFZO0lBQ2xELElBQUksQ0FBQyxJQUFBLHFCQUFVLEVBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7SUFDRCxNQUFNLElBQUksR0FBRyxJQUFBLG1CQUFRLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDO1FBQ3RCLElBQUEsd0JBQWEsRUFBQyxJQUFBLGNBQU8sRUFBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdCLE9BQU8sSUFBQSx1QkFBWSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQ0QsTUFBTTtJQUNOLE1BQU0sS0FBSyxHQUFHLElBQUEsc0JBQVcsRUFBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxJQUFBLHdCQUFhLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1FBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUEsV0FBSSxFQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsQyxNQUFNLFFBQVEsR0FBRyxJQUFBLFdBQUksRUFBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdEMsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FBQztBQUNQ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QUN6QyxLQUFLLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxLQUFLO1FBQ2xDLE1BQU0sRUFBRSxVQUFVLENBQUMsVUFBVSxDQUFDLE1BQU07UUFDcEMsV0FBVyxFQUFFLElBQUk7UUFDakIsVUFBVSxFQUFFLElBQUk7UUFDaEIsU0FBUyxFQUFFLElBQUk7S0FDbEIsQ0FBQztJQUNGLE1BQU0sSUFBQSxvQkFBUyxFQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3BHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb3B5RmlsZVN5bmMsIGVuc3VyZURpclN5bmMsIGV4aXN0c1N5bmMsIHJlYWRkaXJTeW5jLCBzdGF0U3luYywgd3JpdGVGaWxlIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgam9pbiwgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuXG5pbnRlcmZhY2UgUmVzb2x1dGlvbkluZm8ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIHJhdGlvOiBudW1iZXIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3B5RGlyU3luYyhwYXRoOiBzdHJpbmcsIGRlc3Q6IHN0cmluZykge1xuICAgIGlmICghZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgY29uc3Qgc3RhdCA9IHN0YXRTeW5jKHBhdGgpO1xuICAgIGlmICghc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGVuc3VyZURpclN5bmMoZGlybmFtZShkZXN0KSk7XG4gICAgICAgIHJldHVybiBjb3B5RmlsZVN5bmMocGF0aCwgZGVzdCk7XG4gICAgfVxuICAgIC8vIOaWh+S7tuWkuVxuICAgIGNvbnN0IGZpbGVzID0gcmVhZGRpclN5bmMocGF0aCk7XG4gICAgZW5zdXJlRGlyU3luYyhkZXN0KTtcbiAgICBmaWxlcy5mb3JFYWNoKChmaWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBmaWxlID0gam9pbihwYXRoLCBmaWxlTmFtZSk7XG4gICAgICAgIGNvbnN0IGZpbGVEZXN0ID0gam9pbihkZXN0LCBmaWxlTmFtZSk7XG4gICAgICAgIGNvcHlEaXJTeW5jKGZpbGUsIGZpbGVEZXN0KTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFBhdGgocGF0aFRvRm9ybWF0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aFRvRm9ybWF0LnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE5hdGl2ZUVuZ2luZVBhdGgoKSB7XG4gICAgcmV0dXJuIChhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdlbmdpbmUnLCAncXVlcnktZW5naW5lLWluZm8nKSkubmF0aXZlLnBhdGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRKc0VuZ2luZVBhdGgoKSB7XG4gICAgcmV0dXJuIChhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdlbmdpbmUnLCAncXVlcnktZW5naW5lLWluZm8nKSkudHlwZXNjcmlwdC5wYXRoO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2ltdWxhdG9yUHJlZmVyZW5jZSgpIHtcbiAgICBjb25zdCBzaG93RGVidWdQYW5lbCA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LnNpbXVsYXRvcl9kZWJ1Z2dlcicpO1xuICAgIGxldCB3YWl0Rm9yQ29ubmVjdCA9IGZhbHNlO1xuICAgIGlmIChzaG93RGVidWdQYW5lbCkge1xuICAgICAgICB3YWl0Rm9yQ29ubmVjdCA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LndhaXRfZm9yX2Nvbm5lY3QnKTtcbiAgICB9XG4gICAgY29uc3Qgb3JpZW50YXRpb24gPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoJ3ByZXZpZXcnLCAncHJldmlldy5zaW11bGF0b3Jfb3JpZW50YXRpb24nKTtcbiAgICBjb25zdCBkZXZpY2UgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdkZXZpY2UnLCAncXVlcnknKTtcbiAgICBjb25zdCByZXNvbHV0aW9uSW5kZXg6IG51bWJlciA9IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZygncHJldmlldycsICdwcmV2aWV3LnNpbXVsYXRvcl9yZXNvbHV0aW9uJyk7XG4gICAgbGV0IHJlc29sdXRpb24gPSBkZXZpY2VbcmVzb2x1dGlvbkluZGV4XSA/PyBkZXZpY2VbMF07XG4gICAgaWYgKCFyZXNvbHV0aW9uKSB7XG4gICAgICAgIC8vIOaXoOazleS7juiuvuWkh+euoeeQhuWZqOWkhOaLv+WIsOWQiOmAgueahOiuvuWkh+S/oeaBr+mHjO+8jOatpOaXtuS9v+eUqOm7mOiupOeahOiuvuiuoeWIhui+qOeOh+S9nOS4uum7mOiupOeahOeql+WPo+Wkp+Wwj1xuICAgICAgICByZXNvbHV0aW9uID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0UHJvamVjdCgncHJvamVjdCcsICdnZW5lcmFsLmRlc2lnblJlc29sdXRpb24nKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc2hvd0RlYnVnUGFuZWwsXG4gICAgICAgIHdhaXRGb3JDb25uZWN0LFxuICAgICAgICBvcmllbnRhdGlvbixcbiAgICAgICAgcmVzb2x1dGlvbixcbiAgICB9O1xufVxuXG4vKipcbiAqIOeUn+aIkOaooeaLn+WZqCBjb25maWcuanNvbiDphY3nva7mlofku7bvvIzmqKHmi5/lmajlkK/liqjpmLbmrrXkvJrljrvop6PmnpDov5nku73phY3nva5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlU2ltdWxhdG9yQ29uZmlnKCkge1xuICAgIC8vIOi3r+W+hOWkhOeQhlxuICAgIGNvbnN0IGlzRGFyd2luID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2Rhcndpbic7XG4gICAgY29uc3QgbmF0aXZlRW5naW5lUGF0aCA9IGF3YWl0IGdldE5hdGl2ZUVuZ2luZVBhdGgoKTtcbiAgICBjb25zdCBzaW11bGF0b3JSZXNvdXJjZXNNYWMgPSBqb2luKG5hdGl2ZUVuZ2luZVBhdGgsICdzaW11bGF0b3IvUmVsZWFzZS9TaW11bGF0b3JBcHAtTWFjLmFwcC9Db250ZW50cy9SZXNvdXJjZXMnKTtcbiAgICBjb25zdCBzaW11bGF0b3JXcml0YWJsZVBhdGggPSBpc0RhcndpbiA/IHNpbXVsYXRvclJlc291cmNlc01hYyA6IGpvaW4ocHJvY2Vzcy5lbnYuTE9DQUxBUFBEQVRBIGFzIHN0cmluZywgJ1NpbXVsYXRvckFwcC1XaW4zMi9kZWJ1Z3J1bnRpbWUnKTtcbiAgICBcbiAgICAvLyDlgY/lpb3orr7nva5cbiAgICBjb25zdCBwcmVmZXJlbmNlID0gYXdhaXQgZ2V0U2ltdWxhdG9yUHJlZmVyZW5jZSgpO1xuICAgIFxuICAgIC8vIOWGmeWFpSBKU09OXG4gICAgZW5zdXJlRGlyU3luYyhzaW11bGF0b3JXcml0YWJsZVBhdGgpO1xuICAgIGNvbnN0IHNpbXVsYXRvckNvbmZpZ1BhdGggPSBqb2luKHNpbXVsYXRvcldyaXRhYmxlUGF0aCwgJ2NvbmZpZy5qc29uJyk7XG4gICAgY29uc3Qgc2ltdWxhdG9yQ29uZmlnRGF0YSA9IHtcbiAgICAgICAgbmFtZTogJ1NpbXVsYXRvcicsXG4gICAgICAgIGVudHJ5OiAnbWFpbi5qcycsXG4gICAgICAgIGlzTGFuZHNjYXBlOiBwcmVmZXJlbmNlLm9yaWVudGF0aW9uID09PSAnbGFuZHNjYXBlJyxcbiAgICAgICAgaXNXaW5kb3dUb3A6IGZhbHNlLFxuICAgICAgICB3YWl0Rm9yQ29ubmVjdDogcHJlZmVyZW5jZS53YWl0Rm9yQ29ubmVjdCxcbiAgICAgICAgd2lkdGg6IHByZWZlcmVuY2UucmVzb2x1dGlvbi53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiBwcmVmZXJlbmNlLnJlc29sdXRpb24uaGVpZ2h0LFxuICAgICAgICBjb25zb2xlUG9ydDogNjA1MCxcbiAgICAgICAgdXBsb2FkUG9ydDogNjA2MCxcbiAgICAgICAgZGVidWdQb3J0OiA1MDg2LFxuICAgIH07XG4gICAgYXdhaXQgd3JpdGVGaWxlKHNpbXVsYXRvckNvbmZpZ1BhdGgsIEpTT04uc3RyaW5naWZ5KHNpbXVsYXRvckNvbmZpZ0RhdGEsIHVuZGVmaW5lZCwgMiksICd1dGY4Jyk7XG59Il19