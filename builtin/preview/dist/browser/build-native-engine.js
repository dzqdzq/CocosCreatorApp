"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildNativeEngine=void 0;const ccBuild=__importStar(require("@cocos/build-engine")),build_time_constants_1=require("@cocos/build-engine/dist/build-time-constants"),path_1=require("path"),fs_extra_1=require("fs-extra"),build_polyfills_1=__importDefault(require("@editor/build-polyfills")),build_systemjs_1=require("@editor/lib-programming/dist/build-systemjs"),ejs_1=__importDefault(require("ejs")),stats_query_1=require("@cocos/build-engine/dist/stats-query");async function buildNativeEngine(e){var t,i;let n,s;if(console.log("compiling native simulator engine, please wait..."),console.time("compile native engine"),e)n=path_1.join(__dirname,"../../../../../resources/3d/engine"),s=!1;else{n=(await Editor.Message.request("engine","query-info")).path,s=null!==(i=null===(t=(await Editor.Profile.getProject("engine","modules.flags"))["2d"])||void 0===t?void 0:t.UI_GPU_DRIVEN)&&void 0!==i&&i}const o=path_1.join(__dirname,"../../static/simulator"),a=path_1.join(n,"bin/.cache/dev/native-preview");try{fs_extra_1.emptyDirSync(a)}catch(e){}const r=build_time_constants_1.setupBuildTimeConstants({mode:"PREVIEW",platform:"NATIVE",flags:{DEBUG:!0,UI_GPU_DRIVEN:!1}}),l={engine:n,out:a,moduleFormat:ccBuild.ModuleOption.system,compress:!1,split:!0,ammoJsWasm:!1,buildTimeConstants:r,platform:"NATIVE",mode:"PREVIEW"};await ccBuild.build(l);const u={imports:{"cc/env":"./builtin/cce.env.js","cce.env":"./builtin/cce.env.js","wait-for-ammo-instantiation":"./cocos-js/wait-for-ammo-instantiation.js"}},c=(await stats_query_1.StatsQuery.create(n)).getFeatureUnits();for(const e of c)u.imports[`cce:/internal/x/cc-fu/${e}`]=`./cocos-js/${e}.js`;await fs_extra_1.writeFile(path_1.join(o,"import-map.json"),JSON.stringify(u,void 0,2),"utf8"),await build_polyfills_1.default({debug:!1,sourceMap:!1,file:path_1.join(o,"polyfills.bundle.js"),coreJs:{modules:["es.global-this"],blacklist:[]},asyncFunctions:!0,fetch:!0});const _=path_1.join(__dirname,"../../static/simulator/system/index"),d=`${_}.ejs`,m=(await ejs_1.default.renderFile(d,{preset:"commonjs-like"})).toString();await build_systemjs_1.build({input:`${_}.js`,inputSource:m,out:path_1.join(o,"system.bundle.js"),sourceMap:!1,minify:!1}),console.log("compile finished!"),console.timeEnd("compile native engine")}exports.buildNativeEngine=buildNativeEngine;