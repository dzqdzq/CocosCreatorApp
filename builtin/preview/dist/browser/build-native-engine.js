"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildNativeEngine=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),build_polyfills_1=__importDefault(require("@editor/build-polyfills")),build_systemjs_1=require("@editor/lib-programming/dist/build-systemjs"),ejs_1=__importDefault(require("ejs")),ccbuild_1=require("@cocos/ccbuild");async function buildNativeEngine(e){let i;if(console.log("compiling native simulator engine, please wait..."),console.time("compile native engine"),e)i=(0,path_1.join)(__dirname,"../../../../../resources/3d/engine");else{i=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await Editor.Profile.getProject("engine","modules.flags")}const t=(0,path_1.join)(__dirname,"../../static/simulator"),s=(0,path_1.join)(i,"bin/native-preview");try{(0,fs_extra_1.emptyDirSync)(s)}catch(e){}const o=await ccbuild_1.StatsQuery.create(i),n={engine:i,out:s,moduleFormat:"system",compress:!1,targets:"chrome 80",split:!0,ammoJsWasm:!1,platform:"NATIVE",mode:"PREVIEW",flags:{DEBUG:!0,SERVER_MODE:!1}};await(0,ccbuild_1.buildEngine)(n);const a={imports:{"cc/env":"./builtin/cce.env.js","cce.env":"./builtin/cce.env.js","wait-for-ammo-instantiation":"./cocos-js/wait-for-ammo-instantiation.js"}},l=o.getFeatureUnits();for(const e of l)a.imports[`cce:/internal/x/cc-fu/${e}`]=`./cocos-js/${e}.js`;await(0,fs_extra_1.writeFile)((0,path_1.join)(t,"import-map.json"),JSON.stringify(a,void 0,2),"utf8"),await(0,build_polyfills_1.default)({debug:!1,sourceMap:!1,file:(0,path_1.join)(t,"polyfills.bundle.js"),coreJs:{modules:["es.global-this"],blacklist:[]},asyncFunctions:!0,fetch:!0});const r=(0,path_1.join)(__dirname,"../../static/simulator/system/index"),c=`${r}.ejs`,u=(await ejs_1.default.renderFile(c,{preset:"commonjs-like"})).toString();await(0,build_systemjs_1.build)({input:`${r}.js`,inputSource:u,out:(0,path_1.join)(t,"system.bundle.js"),sourceMap:!1,minify:!1}),console.log("compile finished!"),console.timeEnd("compile native engine")}exports.buildNativeEngine=buildNativeEngine;