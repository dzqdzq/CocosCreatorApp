"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.browserPreviewManager=exports.CURRENT_SCENE=void 0;const server_1=require("../contributions/server");exports.CURRENT_SCENE="current_scene";class PreviewManager{constructor(){this._awaitScriptCompile=!1,this._awaitSceneChanged=!1,this.canAutoRefresh=!1,this.currentScene="",this._currentSceneUuid="",this.defaultScene="",this._waitAutoLoadPromise=null,this._waitAutoLoadTimmer=null,this._autoReloadTimmer=null,this._timeout=3e4}async init(){this.canAutoRefresh=await Editor.Profile.getConfig("preview","general.auto_refresh"),this.defaultScene=await Editor.Profile.getConfig("preview","general.start_scene"),Editor.Profile.__protected__.on("change",onProfileChange)}set scriptCompiled(e){this._awaitScriptCompile=!e,e&&this.step()}set sceneChanged(e){this._awaitSceneChanged=!e,e&&this.step()}set currentSceneUuid(e){this._currentSceneUuid=e}get currentSceneUuid(){return this._currentSceneUuid||this.currentScene||this.defaultScene}step(){if(this._waitAutoLoadPromise)return this._waitAutoLoadTimmer&&clearTimeout(this._waitAutoLoadTimmer),this._load(),this._waitAutoLoadPromise(),void(this._waitAutoLoadPromise=null);!this.canAutoRefresh||this._awaitScriptCompile||this._awaitSceneChanged||(this._autoReloadTimmer&&clearTimeout(this._autoReloadTimmer),this._autoReloadTimmer=setTimeout(()=>{console.debug("auto refresh because script compiled or scene changed"),this.reload()},500))}reload(){(0,server_1.reload)()}async load(e,t=!1){if(!this._waitAutoLoadPromise)return this.currentScene=e||this.defaultScene,!this.currentScene||this.currentScene===exports.CURRENT_SCENE||t?this._load():this._awaitScriptCompile?new Promise(async e=>{this._waitAutoLoadPromise=e;const t=this._awaitScriptCompile?"waiting for script compile":`waiting for scene {asset(${this.currentScene})} loaded`;console.log(`${t} ...`),this._waitAutoLoadTimmer&&clearTimeout(this._waitAutoLoadTimmer),this._waitAutoLoadTimmer=setTimeout(()=>{this.step(),console.debug(`${t} timeout`)},this._timeout)}):this._load();console.log(Editor.I18n.t("preview.waitCurrentPreview"))}async _load(){const e=await Editor.Message.request("server","query-port"),t=this.currentScene===this.defaultScene?"":this.currentScene,r=`http://localhost:${e}${t?"?scene="+t:""}`;Editor.Message.send("program","open-url",r),this.currentScene===exports.CURRENT_SCENE&&(this.currentSceneUuid=await Editor.Message.request("scene","query-current-scene"))}async queryCurrentScene(){return this.currentScene?this.currentScene:await Editor.Profile.getConfig("preview","general.start_scene")}async queryPreviewUrl(){const e=await Editor.Message.request("server","query-port");return`http://${await this.queryPreviewIp()}:${e}`}async queryPreviewIp(){const e=await Editor.Profile.getConfig("preview","preview_ip"),t=await(await Editor.Message.request("server","query-sort-ip-list"));return t.length<1?e:e?-1===t.indexOf(e)?(console.log(Editor.I18n.t("preview.ip.use_default")),t[0]):e:t[0]}async setPreviewIp(e){if("string"!=typeof e)return;-1!==(await Editor.Message.request("server","query-ip-list")).indexOf(e)&&(Editor.Message.broadcast("preview:ip-change",e),Editor.Profile.setConfig("preview","preview_ip",e,"global"))}destroyed(){(0,server_1.close)(),Editor.Profile.__protected__.removeListener("change",onProfileChange)}}function onProfileChange(e,t,r,i){"packages/preview.json"===t&&"general.auto_refresh"===r&&(exports.browserPreviewManager.canAutoRefresh=i),"packages/preview.json"===t&&"general.start_scene"===r&&(exports.browserPreviewManager.defaultScene=i)}exports.browserPreviewManager=new PreviewManager;