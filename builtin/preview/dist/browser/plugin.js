"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash=require("lodash");class PluginManager{constructor(){this.configs={},this.supportPreviewTypes=["browser","game-view","simulator"],this.supportDataType=["settings","renderData"],this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>this.register(e))),Editor.Package.on("enable",e=>this.register(e)),Editor.Package.on("disable",e=>this.unregister(e))}async register(e){if(!e||!e.info||this.hasRegisterPackages.has(e.name)||!e.enable||!e.info.contributions||"object"!=typeof e.info.contributions.preview)return!1;this.hasRegisterPackages.add(e.name);const s=e.info.contributions.preview;if(s["*"])for(const t of this.supportPreviewTypes)await this.internalRegister(t,e.name,e.path,s["*"]);Object.keys(s).forEach(t=>{"*"!==t&&this.internalRegister(t,e.name,e.path,s[t])})}async internalRegister(e,s,t,o){try{if(!o||!o.methods)return;path_1.isAbsolute(o.methods)||(o.methods=path_1.join(t,o.methods));const i=require(o.methods);i.load&&await i.load(),"object"==typeof o.hooks&&Object.keys(o.hooks).forEach(t=>{lodash.set(this.configs,`${e}.${t}.${s}`,{methods:o.methods,hook:o.hooks[t]})})}catch(e){console.error(`Register preview plugin ${s} failed!`),console.error(e)}}async runHooks(e,s,...t){const o=lodash.get(this.configs,`${e}.${s}`);if(o&&Object.keys(o).length)for(const i of Object.keys(o)){const r=o[i];try{const o=require(r.methods)[r.hook];await o(...t),console.debug(`[preview] runHooks (${e}-${s}) from plugin ${i} success!`)}catch(t){console.error(`[preview] runHooks (${e}-${s}) from plugin ${i} failed!`),console.error(t)}}}async unregister(e){var s;if(!this.hasRegisterPackages.has(e.name))return;const t=null===(s=e.info.contributions)||void 0===s?void 0:s.preview;this.supportPreviewTypes.forEach(async s=>{const o=t[s];if(!o||!o.methods)return;const i=require(o.methods);i&&i.unload&&await i.unload(),delete require.cache[o.methods],o.hooks&&this.supportDataType.forEach(t=>{this.configs[s][t]&&delete this.configs[s][t][e.name]})}),this.hasRegisterPackages.delete(e.name)}}exports.pluginManager=new PluginManager;