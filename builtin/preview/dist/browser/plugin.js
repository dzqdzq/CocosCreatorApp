"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash=require("lodash");class PluginManager{constructor(){this.configs={},this.supportPreviewTypes=["browser","game-view","simulator"],this.supportDataType=["settings","renderData"],this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>this.register(e))),Editor.Package.__protected__.on("enable",e=>this.register(e)),Editor.Package.__protected__.on("disable",e=>this.unregister(e))}async register(e){if(!e||!e.info||this.hasRegisterPackages.has(e.name)||!e.enable||!e.info.contributions||"object"!=typeof e.info.contributions.preview)return!1;this.hasRegisterPackages.add(e.name);const t=e.info.contributions.preview;if(t["*"])for(const s of this.supportPreviewTypes)await this.internalRegister(s,e.name,e.path,t["*"]);Object.keys(t).forEach(s=>{"*"!==s&&this.internalRegister(s,e.name,e.path,t[s])})}async internalRegister(e,t,s,o){try{if(!o||!o.methods)return;(0,path_1.isAbsolute)(o.methods)||(o.methods=(0,path_1.join)(s,o.methods));const i=Editor.Module.requireFile(o.methods);i.load&&await i.load(),"object"==typeof o.hooks&&Object.keys(o.hooks).forEach(s=>{lodash.set(this.configs,`${e}.${s}.${t}`,{methods:o.methods,hook:o.hooks[s]})})}catch(e){console.error(`Register preview plugin ${t} failed!`),console.error(e)}}async runHooks(e,t,...s){const o=lodash.get(this.configs,`${e}.${t}`);if(o&&Object.keys(o).length)for(const i of Object.keys(o)){const r=o[i];try{const o=Editor.Module.requireFile(r.methods)[r.hook];await o(...s),console.debug(`[preview] runHooks (${e}-${t}) from plugin ${i} success!`)}catch(s){console.error(`[preview] runHooks (${e}-${t}) from plugin ${i} failed!`),console.error(s)}}}async unregister(e){var t;if(!this.hasRegisterPackages.has(e.name))return;const s=null===(t=e.info.contributions)||void 0===t?void 0:t.preview;this.supportPreviewTypes.forEach(async t=>{const o=s[t];if(!o||!o.methods)return;const i=Editor.Module.requireFile(o.methods);i&&i.unload&&await i.unload(),Editor.Module.removeCache(o.methods),o.hooks&&this.supportDataType.forEach(s=>{this.configs[t][s]&&delete this.configs[t][s][e.name]})}),this.hasRegisterPackages.delete(e.name)}}exports.pluginManager=new PluginManager;