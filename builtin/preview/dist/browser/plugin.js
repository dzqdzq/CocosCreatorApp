"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path"),lodash=require("lodash");class PluginManager{constructor(){this.configs={},this.supportPreviewTypes=["browser","game-view","simulator"],this.supportDataType=["settings","renderData"],this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>this.register(e))),Editor.Package.__protected__.on("enable",e=>this.register(e)),Editor.Package.__protected__.on("disable",e=>this.unregister(e))}async register(e){if(!e||!e.info||this.hasRegisterPackages.has(e.name)||!e.enable||!e.info.contributions||"object"!=typeof e.info.contributions.preview)return!1;this.hasRegisterPackages.add(e.name);const t=e.info.contributions.preview;if(t["*"])for(const o of this.supportPreviewTypes)await this.internalRegister(o,e.name,e.path,t["*"]);Object.keys(t).forEach(o=>{"*"!==o&&this.internalRegister(o,e.name,e.path,t[o])})}async internalRegister(e,t,o,s){try{if(!s||!s.methods)return;(0,path_1.isAbsolute)(s.methods)||(s.methods=(0,path_1.join)(o,s.methods));const r=Editor.Module.__protected__.requireFile(s.methods);r.load&&await r.load(),"object"==typeof s.hooks&&Object.keys(s.hooks).forEach(o=>{lodash.set(this.configs,`${e}.${o}.${t}`,{methods:s.methods,hook:s.hooks[o]})})}catch(e){console.error(`Register preview plugin ${t} failed!`),console.error(e)}}async runHooks(e,t,...o){const s=lodash.get(this.configs,`${e}.${t}`);if(s&&Object.keys(s).length)for(const r of Object.keys(s)){const i=s[r];try{const s=Editor.Module.__protected__.requireFile(i.methods)[i.hook];await s(...o),console.debug(`[preview] runHooks (${e}-${t}) from plugin ${r} success!`)}catch(o){console.error(`[preview] runHooks (${e}-${t}) from plugin ${r} failed!`),console.error(o)}}}async unregister(e){var t;if(!this.hasRegisterPackages.has(e.name))return;const o=null===(t=e.info.contributions)||void 0===t?void 0:t.preview;this.supportPreviewTypes.forEach(async t=>{const s=o[t];if(!s||!s.methods)return;const r=Editor.Module.__protected__.requireFile(s.methods);r&&r.unload&&await r.unload(),Editor.Module.__protected__.removeCache(s.methods),s.hooks&&this.supportDataType.forEach(o=>{this.configs[t][o]&&delete this.configs[t][o][e.name]})}),this.hasRegisterPackages.delete(e.name)}}exports.pluginManager=new PluginManager;