"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),server_1=require("../contributions/server"),child_process_1=require("child_process"),plist_1=require("plist"),FacetInstance_1=require("../programming/FacetInstance"),simulator_1=require("./simulator"),build_native_engine_1=require("./build-native-engine"),plugin_1=require("./plugin");let pkg=null,currMode="browser";async function load(){pkg=this;try{await(0,FacetInstance_1.createProgrammingFacet)()}catch(e){console.error(e)}Editor.Startup.ready.package?await plugin_1.pluginManager.init():Editor.Startup.once("package-ready",async()=>{await plugin_1.pluginManager.init()})}function unload(){(0,server_1.close)()}async function getPreviewIp(){const e=await Editor.Profile.getConfig("preview","preview_ip"),t=await Editor.Network.queryIPList();return e?-1===t.indexOf(e)?(console.log(Editor.I18n.t("preview.ip.use_default")),t[t.length-1]):e:t[t.length-1]}function setPreviewIp(e){if("string"!=typeof e)return;-1!==Editor.Network.queryIPList().indexOf(e)&&(Editor.Message.broadcast("preview:ip-change",e),Editor.Profile.setConfig("preview","preview_ip",e,"global"))}async function openBrowser(e){const t=`http://localhost:${await Editor.Message.request("server","query-port")}${e?"?scene="+e:""}`;let r=await Editor.Profile.getConfig("program","browser");if(!r)return void electron_1.shell.openExternal(t);let a=[t],i="";if("darwin"===process.platform){if(r.endsWith(".app")){r=(0,path_1.join)(r,"/Contents/MacOS/");const e=(0,plist_1.parse)((0,fs_extra_1.readFileSync)((0,path_1.join)(r,"../Info.plist"),"utf8"));r=(0,path_1.join)(r,e.CFBundleExecutable)}i="open",a=["-a",r,t]}else i=r;(0,child_process_1.spawn)(i,a,{detached:!0,stdio:"ignore"}).unref()}exports.methods={open(){Editor.Panel.open("preview.panel")},async generateSettings(e){const t=await Editor.Message.request("builder","generate-preview-setting",{debug:!0,platform:e.platform||"web-desktop",preview:!0,startScene:e.startScene});if(t&&t.settings)return t.settings.engine.engineModules=await Editor.Profile.getProject("engine","modules.includeModules"),await plugin_1.pluginManager.runHooks(e.type,"settings",t.settings),t},buildNativeEngine:build_native_engine_1.buildNativeEngine,previewSceneInBrowser(e){e&&openBrowser(e)},async autoReload(){await Editor.Profile.getConfig("preview","general.auto_refresh")&&(0,server_1.reload)()},async"open-terminal"(e){switch(currMode){case"browser":await openBrowser();break;case"simulator":await(0,simulator_1.runSimulator)()}},async"restart-simulator"(){await(0,simulator_1.runSimulator)()},async"pause-terminal"(e){await Editor.Message.request("scene","preview-play-call-method","pause",e)},async"step-terminal"(){Editor.Message.request("scene","preview-play-call-method","step")},async"on-pack-build-end"(e){var t;"preview"===e&&await(null===(t=(0,FacetInstance_1.getPreviewFacet)())||void 0===t?void 0:t.notifyPackDriverUpdated())},"change-platform"(e){currMode=e,Editor.Message.request("scene","preview-play-call-method","setPlatform",e)},"reload-terminal"(){(0,server_1.reload)()},async queryPreviewUrl(){const e=await Editor.Message.request("server","query-port");return`http://${await getPreviewIp()}:${e}`},"get-preview-ip":async()=>await getPreviewIp(),"set-preview-ip"(e){setPreviewIp(e)},async"create-template"(){const e=(0,path_1.join)(__dirname,"./../../static/views/index.ejs").replace("app.asar","app.asar.unpacked"),t=(0,path_1.join)(Editor.Project.path,"preview-template","index.ejs");if((0,fs_extra_1.existsSync)(t)){if(1===(await Editor.Dialog.warn("Template already exists, do you want to overwrite source file?",{buttons:["Yes","Cancel"],default:0,cancel:1})).response)return}return(0,fs_extra_1.copySync)(e,t),console.log(`${Editor.I18n.t("preview.creat_template_success")}( ${t} )`),electron_1.shell.showItemInFolder(t),!0}},exports.load=load,exports.unload=unload;