"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.listeners=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default;let glPreview=new GlPreview("scene:preview","query-preview-data");const Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,resizeTimer=null,currIndex=-1,currResolution=-1,zoom=1,frameId=0;const resolutions=["FreeAspect","16:9","16:10","5:4","4:3","3:2"];function calculateSize(e,i,a,n,t){if(1!==t){const l=n*t;l<a?e=(a-(a=l))/2:i=(n-(n=a/t))/2}panel.width=a,panel.height=n,panel.$.image.width=a,panel.$.image.height=n,panel.$.image.style.width=`${a}px`,panel.$.image.style.height=`${n}px`,panel.$.image.style.left=`${e}px`,panel.$.image.style.top=`${i}px`,glPreview.resizeGL(a,n),Editor.Message.send("scene","excute-mini-preview-method",{name:"setPreviewInfo",args:[{name:"preview-plugin",left:e,top:i,width:a,height:n,k:t}]})}async function ready(){if((panel=this).$.image.hidden=!0,await Editor.Message.request("scene","query-is-ready")){const e=await Editor.Message.request("scene","query-preview-info");if(0===e.windows.length)return;-1===currIndex&&(currIndex=e.windows[e.windows.length-1].index),await glPreview.init({index:currIndex,width:panel.clientWidth,height:panel.clientHeight}),panel.initData.call(panel),panel.resize.call(panel),panel.updateText.call(panel,e.windows)}panel.$.automatic.addEventListener("confirm",()=>{panel.automatic=!!panel.$.automatic.value,panel.update.call(panel)}),panel.$.windows.addEventListener("confirm",()=>{currIndex=panel.$.windows.value,panel.resize.call(panel)}),panel.$.resolutions.addEventListener("confirm",()=>{currResolution=parseInt(panel.$.resolutions.value),Editor.Profile.setConfig("preview","preview.resolution",currResolution),panel.resize.call(panel)}),panel.$.zoom.addEventListener("change",()=>{zoom=panel.$.zoom.value,Editor.Profile.setConfig("preview","preview.zoom",zoom),panel.$.image.style.transform=`scale(${zoom}, ${-zoom})`}),glPreview.initGL(panel.$.image)}async function beforeClose(){Editor.Profile.removeConfig("preview","preview.resolution"),Editor.Profile.removeConfig("preview","preview.zoom"),Editor.Message.request("scene","excute-mini-preview-method",{name:"setPreviewInfo",args:[{name:"preview-plugin"}]})}async function close(){glPreview.destroyGL()}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../static/style/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/index.html"),"utf8"),exports.$={preview:".preview",image:".image",automatic:".automatic",windows:".windows",resolutions:".resolutions",zoom:".zoom"},exports.listeners={resize(){clearTimeout(resizeTimer),resizeTimer=setTimeout(()=>{panel.resize.call(panel)},400)},show(){this.resize()}},exports.methods={resize(){let e=panel.$.preview.getBoundingClientRect().width,i=panel.$.preview.getBoundingClientRect().height;switch(currResolution){case-1:case 0:calculateSize(0,0,e,i,1);break;case 1:calculateSize(0,0,e,i,16/9);break;case 2:calculateSize(0,0,e,i,1.6);break;case 3:calculateSize(0,0,e,i,5/4);break;case 4:calculateSize(0,0,e,i,4/3);break;case 5:calculateSize(0,0,e,i,1.5)}panel.update.call(panel)},async update(){if(!panel||!panel.$.image||panel.updateLock)return;if(!glPreview.initialized)return;panel.updateLock=!0;const e=await glPreview.queryPreviewData({index:currIndex,width:panel.width,height:panel.height});if(e){try{glPreview.drawGL(e.buffer,e.width,e.height)}catch(e){console.warn(e)}panel.$.image.hidden=!1,panel.updateLock=!1,panel.automatic?frameId=requestAnimationFrame(panel.update.bind(this)):cancelAnimationFrame(frameId)}else panel.updateLock=!1},updateText(e){panel.$.automatic.innerHTML=Editor.I18n.t("preview.automatic"),panel.$.automatic.setAttribute("tooltip",Editor.I18n.t("preview.automatic_tooltip")),panel.$.windows.innerHTML="";let i=!1;e.forEach(e=>{const a=document.createElement("option");a.innerHTML=`Window ${e.index}`,a.value=e.index,currIndex===e.index&&!1===i&&(i=!0),panel.$.windows.appendChild(a)}),panel.$.windows.value=currIndex=i?currIndex:e[e.length-1].index},async initData(){resolutions.forEach((e,i)=>{const a=document.createElement("option");a.innerHTML=e,a.value=`${i}`,panel.$.resolutions.appendChild(a)});let e=0;const i=await Editor.Profile.getConfig("preview","preview.resolution");i&&(e=i),currResolution=panel.$.resolutions.value=e;const a=await Editor.Profile.getConfig("preview","preview.zoom");a&&(zoom=panel.$.zoom.value=a,panel.$.image.style.transform=`scale(${a})`)},async"scene:ready"(){const e=await Editor.Message.request("scene","query-preview-info");currIndex=e.windows[e.windows.length-1].index,await glPreview.init({index:currIndex,width:panel.clientWidth,height:panel.clientHeight}),panel.initData.call(panel),panel.resize.call(panel),panel.updateText.call(panel,e.windows),panel.update.call(panel)},"scene:close"(){currIndex=-1},async"scene:preview-add"(){const e=await Editor.Message.request("scene","query-preview-info");panel.updateText.call(panel,e.windows),panel.update.call(panel)},"scene:preview-change"(){panel.update.call(panel)},async"scene:preview-remove"(){const e=await Editor.Message.request("scene","query-preview-info");panel.updateText.call(panel,e.windows),panel.update.call(panel)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;