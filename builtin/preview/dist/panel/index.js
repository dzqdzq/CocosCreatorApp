"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.listeners=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default,glPreview=new GlPreview("scene:preview","query-preview-data"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,resizeTimer=null,currIndex=-1,currResolution={width:800,height:600},zoom=1,frameId=0;const resolutions=["FreeAspect","16:9","16:10","5:4","4:3","3:2"];function calculateSize(e,i,n,a,t){if(1!==t){const r=a*t;r<n?e=(n-(n=r))/2:i=(a-(a=n/t))/2}panel.width=n,panel.height=a,panel.$.image.width=n,panel.$.image.height=a,panel.$.image.style.width=`${n}px`,panel.$.image.style.height=`${a}px`,panel.$.image.style.left=`${e}px`,panel.$.image.style.top=`${i}px`,glPreview.resizeGL(n,a)}async function ready(){if((panel=this).$.image.hidden=!0,await Editor.Message.request("scene","query-is-ready")){const e=await Editor.Message.request("scene","query-preview-info");if(0===e.windows.length)return;-1===currIndex&&(currIndex=e.windows[e.windows.length-1].index),await glPreview.init({index:currIndex,width:panel.clientWidth,height:panel.clientHeight}),panel.initData.call(panel),panel.resize.call(panel),panel.updateText.call(panel,e.windows)}panel.$.automatic.addEventListener("confirm",()=>{panel.automatic=!!panel.$.automatic.value,panel.update.call(panel)}),panel.$.windows.addEventListener("confirm",async()=>{currIndex=Number.parseInt(panel.$.windows.value),await Editor.Message.request("scene","change-preview-camera",currIndex),panel.resize.call(panel)}),panel.$.zoom.addEventListener("change",()=>{zoom=panel.$.zoom.value,Editor.Profile.setConfig("preview","preview.zoom",zoom),panel.$.image.style.transform=`scale(${zoom}, ${zoom})`}),glPreview.initGL(panel.$.image)}async function beforeClose(){Editor.Profile.removeConfig("preview","preview.resolution"),Editor.Profile.removeConfig("preview","preview.zoom"),Editor.Message.request("scene","excute-mini-preview-method",{name:"setPreviewInfo",args:[{name:"preview-plugin"}]})}async function close(){glPreview.destroyGL()}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../static/style/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/index.html"),"utf8"),exports.$={preview:".preview",image:".image",automatic:".automatic",windows:".windows",zoom:".zoom"},exports.listeners={resize(){clearTimeout(resizeTimer),resizeTimer=setTimeout(()=>{panel.resize.call(panel)},400)},show(){this.resize()}},exports.methods={resize(){calculateSize(0,0,panel.$.preview.getBoundingClientRect().width,panel.$.preview.getBoundingClientRect().height,currResolution.width/currResolution.height),panel.update.call(panel)},async update(){if(!panel||!panel.$.image||panel.updateLock)return;if(!glPreview.initialized)return;panel.updateLock=!0;const e=await glPreview.queryPreviewData({index:currIndex,width:panel.width,height:panel.height});if(e){try{glPreview.drawGL(e.buffer,e.width,e.height)}catch(e){console.warn(e)}panel.$.image.hidden=!1,panel.updateLock=!1,panel.automatic?frameId=requestAnimationFrame(panel.update.bind(this)):cancelAnimationFrame(frameId)}else panel.updateLock=!1},async updateText(e){panel.$.automatic.innerHTML=Editor.I18n.t("preview.automatic"),panel.$.automatic.setAttribute("tooltip",Editor.I18n.t("preview.automatic_tooltip")),panel.$.windows.innerHTML="";let i=!1;e.forEach((e,n)=>{const a=document.createElement("option");a.innerHTML=`${n} ${e.name}`,a.value=e.index,currIndex===e.index&&!1===i&&(i=!0),panel.$.windows.appendChild(a)}),i||e&&e.length>0&&(currIndex=e[e.length-1].index,await Editor.Message.request("scene","change-preview-camera",currIndex)),panel.$.windows.value=currIndex},async initData(){const e=await Editor.Profile.getConfig("preview","preview.zoom");e&&(zoom=panel.$.zoom.value=e,panel.$.image.style.transform=`scale(${e})`)},async"scene:ready"(){const e=await Editor.Message.request("scene","query-preview-info");e.windows&&e.windows.length>0&&(currIndex=e.windows[e.windows.length-1].index,await glPreview.init({index:currIndex,width:panel.clientWidth,height:panel.clientHeight})),panel.initData.call(panel),panel.resize.call(panel),panel.updateText.call(panel,e.windows),panel.update.call(panel)},"scene:close"(){currIndex=-1},async"scene:preview-add"(){const e=await Editor.Message.request("scene","query-preview-info");panel.updateText.call(panel,e.windows)},"scene:preview-change"(){panel.update.call(panel)},async"scene:preview-remove"(){const e=await Editor.Message.request("scene","query-preview-info");panel.updateText.call(panel,e.windows),panel.update.call(panel)},"scene:target-resolution-changed"(e){currResolution=e,panel.resize.call(panel)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;