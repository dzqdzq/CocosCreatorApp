"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.reload=exports.disconnect=exports.connection=exports.get=exports.file=void 0;const ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),fs_extra_2=__importDefault(require("fs-extra")),path_2=__importDefault(require("path")),FacetInstance_1=require("../programming/FacetInstance"),url_1=require("url"),plugin_1=require("../browser/plugin"),Mobiledetect=require("mobile-detect");exports.file=[{url:"/",path:path_1.join(Editor.Project.path,"preview-template")},{url:"/",path:path_1.join(__dirname,"../../static/resources")}];let databaseResourceMapping={},bundleConfigs=[];exports.get=[{url:"/settings.js",async handle(e,t,r){const s=await Editor.Message.request("preview","generate-settings",{type:"browser",startScene:e.query.scene});if(!s||!s.settings)return r(new Error("构建 settings 出错"));databaseResourceMapping=s.script2library,bundleConfigs=s.bundleConfigs,t.send(`window._CCSettings = ${JSON.stringify(s.settings)}`)}},{url:"/scene/*.json",async handle(e,t,r){const s=e.params[0],n=new Error(Editor.I18n.t("preview.load_current_scene_error",{scene:s}));if("current_scene"===s){const e=await Editor.Message.request("scene","query-scene-json");if(!e)return r(n);t.end(e)}else if(s){const e=await Editor.Message.request("asset-db","query-asset-info",s);if(!e||!e.library[".json"])return r(n);{const s=e.library[".json"];if(!s)return r(n);t.sendFile(s)}}}},{url:"/assets/*/import/*",async handle(e,t,r){const s=e.params[1].replace(/[^(\\|/|@)]+/g,encodeURIComponent);let n=path_1.join(Editor.Project.path,"/library",s);if(fs_extra_1.existsSync(n)||(n=path_1.join(Editor.App.path,"builtin/asset-db/static/internal/library",s)),!fs_extra_1.existsSync(n))return r();t.sendFile(n)}},{url:"/assets/*/native/*",async handle(e,t,r){const s=e.params[1].replace(/[^(\\|/|@)]+/g,encodeURIComponent);let n=path_1.join(Editor.Project.path,"/library",s);if(fs_extra_1.existsSync(n)||(n=path_1.join(Editor.App.path,"builtin/asset-db/static/internal/library",s)),!fs_extra_1.existsSync(n))return r();t.sendFile(n)}},{url:"/assets/*/config.json",async handle(e,t,r){const s=bundleConfigs.find(t=>t.name===e.params[0]);if(!s)return r();t.send(JSON.stringify(s))}},{url:"/assets/*/index.js",async handle(e,t,r){if(!bundleConfigs.find(t=>t.name===e.params[0]))return r();const s=`System.register("virtual:///prerequisite-imports/${e.params[0]}", [], function () {\n                "use strict";\n              \n                return {\n                  setters: [],\n                  execute: function () {}\n                };\n            });`;t.send(s)}},{url:"/plugins/*",async handle(e,t,r){const s=databaseResourceMapping[e.params[0]];if(!fs_extra_1.existsSync(s))return r();t.sendFile(s)}},{url:"/",async handle(e,t,r){const s=e.header("user-agent"),n=new Mobiledetect(s),a=await Editor.Profile.getConfig("preview","preview");let i=e.query.scene;i||(i=await Editor.Profile.getConfig("preview","general.start_scene"));const o=await Editor.Message.request("device","query"),c=await Editor.Profile.getProject("project","general.designResolution");c&&o.splice(0,0,{name:"Default",width:c.width,height:c.height,ratio:1}),a.device=a.device||"Default";const l={};o.forEach(e=>{l[e.name]=e});const p={title:`Cocos Creator - ${path_1.basename(Editor.Project.path)}`,tip_sceneIsEmpty:Editor.I18n.t("preview.scene_is_empty"),enableDebugger:!!n.mobile()||-1!==s.indexOf("MicroMessenger"),devices:l,config:a,cocosTemplate:path_1.join(__dirname,"../../static/views/script.ejs"),cocosToolBar:path_1.join(__dirname,"../../static/views/toolbar.ejs"),settingsJs:`/settings.js?scene=${i}`};await plugin_1.pluginManager.runHooks("browser","renderData",p);const d=path_1.join(Editor.Project.path,"preview-template","index.ejs");if(fs_extra_1.existsSync(d))try{console.log(`Use preview template {link(${d})}`);const e=await ejs_1.default.renderFile(d,p);return void t.end(e)}catch(e){console.error(e)}const u=await ejs_1.default.renderFile(path_1.join(__dirname,"../../static/views/index.ejs"),p);t.send(u)}},{url:"/preview-app/*",async handle(e,t,r){t.sendFile(path_1.join(__dirname,"..","..","preview-app","dist",e.params[0]))}},{url:"/node_modules/*",async handle(e,t,r){let s=path_1.join(__dirname,"../../../../node_modules",e.params[0]);fs_extra_1.existsSync(s)||(s=s.replace("app.asar","app.asar.unpacked")),fs_extra_1.existsSync(s)||r(),t.sendFile(s)}},{url:"/scripting/polyfills/*",async handle(e,t){const r=path_2.default.join(path_2.default.dirname(require.resolve("@editor/build-polyfills/package.json")),"prebuilt","preview"),s=path_2.default.join(r,e.params[0]);t.sendFile(s)}},{url:"/scripting/systemjs/*",async handle(e,t){const r=FacetInstance_1.getPreviewFacet();r&&t.sendFile(path_2.default.join(r.systemJsHomeDir,e.params[0]))}},{url:"/scripting/import-map-project",async handle(e,t,r){const s=FacetInstance_1.getPreviewFacet();if(!s)return;const n=await s.getProjectImportMap();t.json(n)}},{url:"/scripting/import-map-global",async handle(e,t,r){const s=FacetInstance_1.getPreviewFacet();if(!s)return;const n=await s.getGlobalImportMap();t.json(n)}},{url:"/scripting/x/*",async handle(e,t,r){const s=FacetInstance_1.getPreviewFacet();if(!s)return;const n=0===Object.keys(e.query).length?"":`?${new url_1.URLSearchParams(e.query).toString()}`,a=e.params[0]+n;let i;try{i=await s.getResource(a)}catch(e){return void r(e)}"file"===i.type&&t.sendFile(i.path)}},{url:"/scripting/engine/*",async handle(e,t){const r=FacetInstance_1.getPreviewFacet();if(!r)return;let s=path_2.default.join(r.engineRoot,e.params[0]);await fs_extra_2.default.pathExists(s)||(s=`${s}.js`),t.sendFile(s,{dotfiles:"allow"})}}];let sockets=[],reloadTimer=null;function connection(e){sockets.push(e),e.on("changeOption",(e,t)=>{Editor.Profile.setConfig("preview",`preview.${e}`,t,"global")}),e.on("preview error",e=>{console.error(e)})}function disconnect(e){const t=sockets.indexOf(e);-1!==t&&sockets.splice(t,1)}function reload(){0!==sockets.length&&(clearTimeout(reloadTimer),reloadTimer=setTimeout(()=>{sockets.forEach(e=>{e.emit("browser:reload")})},200))}exports.connection=connection,exports.disconnect=disconnect,exports.reload=reload;