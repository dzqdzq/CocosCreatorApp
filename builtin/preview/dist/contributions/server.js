"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryConnectNum=exports.close=exports.reload=exports.disconnect=exports.connection=exports.get=exports.file=void 0;const ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),FacetInstance_1=require("../programming/FacetInstance"),url_1=require("url"),plugin_1=require("../browser/plugin"),preview_settings_1=require("../browser/preview-settings"),Mobiledetect=require("mobile-detect"),sockets=(exports.file=[{url:"/",path:(0,path_1.join)(Editor.Project.path,"preview-template")},{url:"/",path:(0,path_1.join)(__dirname,"../../static/resources")}],exports.get=[{url:"/engine_external/",async handle(e,r,t){var a,e=e.query.url,n="external:";"string"==typeof e&&e.startsWith(n)?(a=(await Editor.Message.request("engine","query-engine-info")).native.path,n=e.replace(n,(0,path_1.join)(a,"external/")),a=await(0,fs_extra_1.readFile)(n),r.send(a)):t(new Error("请求 external 资源失败，请使用 external 协议: "+e))}},{url:"/settings.js",async handle(e,r,t){try{var a=await preview_settings_1.previewSettingsManager.querySettingsData("browser",{startScene:e.query.scene});if(!a||!a.settings)return t(new Error("构建 settings 出错"));"true"!==e.query.splashPreview&&(a.settings.splashScreen.totalTime=50),r.status(200).send("window._CCSettings = "+JSON.stringify(a.settings))}catch(e){console.error(e),t(new Error("Get settings failed"))}}},{url:"/settings.json",async handle(e,r,t){try{var a=await preview_settings_1.previewSettingsManager.querySettingsData("game-view",{startScene:e.query.scene});if(!a||!a.settings)return t(new Error("构建 settings 出错"));a.settings.plugins.jsList&&(a.settings.plugins.jsList=[]),r.status(200).send(""+JSON.stringify(a.settings))}catch(e){return console.error(e),t(new Error("Get settings failed!"))}}},{url:"/src/effect.bin",async handle(e,r,t){var a=(0,path_1.join)(Editor.Project.tmpDir,"asset-db/effect/effect.bin");r.sendFile(a)}},{url:"/scene/*.json",async handle(e,r,t){var e=e.params[0],a=new Error(Editor.I18n.t("preview.load_current_scene_error",{scene:e}));if("current_scene"===e){var n=await Editor.Message.request("scene","query-scene-json");if(!n)return t(a);r.end(n)}else if(e)return(n=await Editor.Message.request("asset-db","query-asset-info",e))&&n.library[".json"]&&(e=n.library[".json"])?void r.sendFile(e):t(a)}},{url:"/assets/*/import/*",handle:handleLibraryFile},{url:"/assets/*/native/*",handle:handleLibraryFile},{url:"/remote/*/import/*",handle:handleLibraryFile},{url:"/remote/*/native/*",handle:handleLibraryFile},{url:"/query-extname/*",async handle(e,r,t){e=e.params[0],e=await Editor.Message.request("asset-db","query-asset-info",e);e&&e.library[".cconb"]?r.status(200).send(".cconb"):r.status(200).send("")}},{url:"/assets/*/config.json",handle:handlerBundleConfig},{url:"/remote/*/config.json",handle:handlerBundleConfig},{url:"/remote/*/cc.config.json",async handle(e,r,t){return handlerBundleConfig(e,r,t,"simulator")}},{url:"/remote/*/index.js",handle:handlerBundleIndex},{url:"/assets/*/index.js",handle:handlerBundleIndex},{url:"/plugins/*",async handle(e,r,t){var a=await preview_settings_1.previewSettingsManager.queryScript2library("browser");return a?(a=a[e.params[0]],(0,fs_extra_1.existsSync)(a)?void r.sendFile(a):t()):t(new Error("构建 settings 出错"))}},{url:"/",async handle(e,r,t){var a=await(0,FacetInstance_1.waitForProgrammingFacet)(),n=e.header("user-agent"),s=new Mobiledetect(n);let i=e.query.scene;i=i||await Editor.Profile.getConfig("preview","general.start_scene");var o=await handleDeviceMap(),l=await Editor.Profile.getConfig("preview","preview"),c=(l.device=l.device||"Default","false"===e.query.debug&&(l.showFps=!1),"true"===e.query.splashPreview),e={title:"Cocos Creator - "+(0,path_1.basename)(Editor.Project.path),tip_sceneIsEmpty:Editor.I18n.t("preview.scene_is_empty"),enableDebugger:"false"!==e.query.debug&&(!!s.mobile()||-1!==(null==n?void 0:n.indexOf("MicroMessenger"))),devices:o,config:l,cocosTemplate:(0,path_1.join)(__dirname,"../../static/views/script.ejs"),cocosToolBar:(0,path_1.join)(__dirname,"../../static/views/toolbar.ejs"),settingsJs:"/settings.js?scene="+i+(c?"&splashPreview=true":""),packImportMapURL:"/scripting/x/"+a.packImportMapURL,packResolutionDetailMapURL:"/scripting/x/"+a.packResolutionDetailMapURL},s=(await plugin_1.pluginManager.runHooks("browser","renderData",e),(0,path_1.join)(Editor.Project.path,"preview-template","index.ejs"));if((0,fs_extra_1.existsSync)(s))try{console.log(`Use preview template {link(${s})}`);var u=await ejs_1.default.renderFile(s,e);return void r.end(u)}catch(e){console.error(e)}n=await ejs_1.default.renderFile((0,path_1.join)(__dirname,"../../static/views/index.ejs"),e);r.status(200).send(n),Editor.Message.send("preview","ready")}},{url:"/preview-app/*",async handle(e,r,t){r.sendFile((0,path_1.join)(__dirname,"..","..","preview-app","dist",e.params[0]))}},{url:"/node_modules/*",async handle(e,r,t){let a=(0,path_1.join)(__dirname,"../../../../node_modules",e.params[0]);(0,fs_extra_1.existsSync)(a)||(a=a.replace("app.asar","app.asar.unpacked")),(0,fs_extra_1.existsSync)(a)||t(),r.sendFile(a)}},{url:"/scripting/polyfills/*",async handle(e,r){var t=(0,path_1.join)((0,path_1.dirname)(require.resolve("@editor/build-polyfills/package.json")),"prebuilt","preview"),t=(0,path_1.join)(t,e.params[0]);r.sendFile(t)}},{url:"/scripting/systemjs/*",async handle(e,r){var t=await(0,FacetInstance_1.waitForProgrammingFacet)();r.sendFile((0,path_1.join)(t.systemJsHomeDir,e.params[0]))}},{url:"/scripting/userland/macro",async handle(e,r,t){await(0,FacetInstance_1.waitForProgrammingFacet)();var a=(0,path_1.join)(Editor.Project.path,"./temp/programming/custom-macro.js");r.sendFile(a)}},{url:"/scripting/import-map-global",async handle(e,r,t){var a=await(await(0,FacetInstance_1.waitForProgrammingFacet)()).getGlobalImportMap();r.json(a)}},{url:"/scripting/x/*",async handle(e,r,t){var a=await(0,FacetInstance_1.waitForProgrammingFacet)(),n=0===Object.keys(e.query).length?"":"?"+new url_1.URLSearchParams(e.query).toString(),e=e.params[0]+n,s=await a.loadPackResource(e);switch(s.type){case"json":r.json(s.json);break;case"chunk":r.sendFile(s.chunk.path);break;default:t(new Error("Unknown pack resource type"))}}},{url:"/scripting/engine/*",async handle(e,r,t){var a=await(0,FacetInstance_1.waitForProgrammingFacet)();let n=(0,path_1.join)(a.engineRoot,e.params[0]);if(await(0,fs_extra_1.pathExists)(n)||(n+=".js"),!await(0,fs_extra_1.pathExists)(n))return t();r.sendFile(n,{dotfiles:"allow"})}},{url:"/missing-asset/*",async handle(e,r,t){e=e.params[0].match(/[^@]*/)[0],e=await Editor.Message.request("asset-db","query-missing-asset-info",e);r.json(e)}}],[]);let reloadTimer=null;async function handleDeviceMap(){const t={};var e=await Editor.Message.request("device","query"),r=await Editor.Profile.getProject("project","general.designResolution");return r&&e.splice(0,0,{name:Editor.I18n.t("preview.web_view.design_resolution"),width:r.width,height:r.height,ratio:1}),e.splice(1,0,{name:Editor.I18n.t("preview.web_view.fullScreen")},{name:Editor.I18n.t("preview.web_view.webpageFullScreen")},{name:"__separator__"}),e.forEach(e=>{let r=e.name;e.name===Editor.I18n.t("preview.web_view.design_resolution")?r="Default":e.name===Editor.I18n.t("preview.web_view.fullScreen")?r="FullScreen":e.name===Editor.I18n.t("preview.web_view.webpageFullScreen")&&(r="WebpageFullScreen"),t[r]=e}),t}function generateDummyScript(e){return`System.register("virtual:///prerequisite-imports/${e}", [], function () {
        "use strict";
      
        return {
          setters: [],
          execute: function () {}
        };
    });`}let otherLibraryPath=null;async function queryOtherLibraryPath(){if(!otherLibraryPath)try{var e=await Editor.Message.request("asset-db","query-db-infos");otherLibraryPath=e.map(e=>e.library)}catch(e){console.debug(e),otherLibraryPath=[(0,path_1.join)(Editor.App.temp,"asset-db/library")]}return otherLibraryPath}async function handlerBundleConfig(r,e,t,a){a=(await preview_settings_1.previewSettingsManager.queryBundleConfigs(a||"browser")).find(e=>e.name===r.params[0]);if(!a)return t();e.status(200).send(JSON.stringify(a))}async function handlerBundleIndex(r,e,t){if(!(await preview_settings_1.previewSettingsManager.queryBundleConfigs("browser")).find(e=>e.name===r.params[0]))return t();t=generateDummyScript(r.params[0]);e.status(200).send(t)}async function handleLibraryFile(e,r,t){const a=e.params[1].replace(/[^(\\|/|@)]+/g,encodeURIComponent);e=(await queryOtherLibraryPath()).map(e=>(0,path_1.join)(e,a)).find(e=>(0,fs_extra_1.existsSync)(e));if(!e)return t();r.sendFile(e)}function connection(e){sockets.push(e),e.on("changeOption",(e,r)=>{Editor.Profile.setConfig("preview","preview."+e,r,"global")}),e.on("preview error",e=>{console.error(e)})}function disconnect(e){e=sockets.indexOf(e);-1!==e&&sockets.splice(e,1)}function reload(){0!==sockets.length&&(clearTimeout(reloadTimer),reloadTimer=setTimeout(()=>{sockets.forEach(e=>{e.emit("browser:reload")})},200))}function close(){0!==sockets.length&&sockets.forEach(e=>{e.emit("browser:close")})}function queryConnectNum(){return sockets.length}exports.connection=connection,exports.disconnect=disconnect,exports.reload=reload,exports.close=close,exports.queryConnectNum=queryConnectNum;