"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.reload=exports.disconnect=exports.connection=exports.get=exports.file=void 0;const ejs_1=__importDefault(require("ejs")),path_1=require("path"),fs_extra_1=require("fs-extra"),FacetInstance_1=require("../programming/FacetInstance"),url_1=require("url"),plugin_1=require("../browser/plugin"),Mobiledetect=require("mobile-detect");let databaseResourceMapping;exports.file=[{url:"/",path:(0,path_1.join)(Editor.Project.path,"preview-template")},{url:"/",path:(0,path_1.join)(__dirname,"../../static/resources")}];let bundleConfigs=[],gameviewBundleConfigs=[];exports.get=[{url:"/engine_external/",async handle(e,t,s){const r=e.query.url;if(r.startsWith("external:")){const e=(await Editor.Message.request("engine","query-engine-info")).native.path,s=r.replace("external:",(0,path_1.join)(e,"external/")),n=await(0,fs_extra_1.readFile)(s);t.send(n)}else s(new Error(`请求 external 资源失败，请使用 external 协议: ${r}`))}},{url:"/settings.js",async handle(e,t,s){const r=await Editor.Message.request("preview","generate-settings",{type:"browser",startScene:e.query.scene});if(!r||!r.settings)return s(new Error("构建 settings 出错"));"true"!==e.query.splashPreview&&(r.settings.splashScreen.totalTime=50),databaseResourceMapping=r.script2library,bundleConfigs=r.bundleConfigs,t.status(200).send(`window._CCSettings = ${JSON.stringify(r.settings)}`)}},{url:"/settings.json",async handle(e,t,s){const r=await Editor.Message.request("preview","generate-settings",{type:"game-view",startScene:e.query.scene});if(!r||!r.settings)return s(new Error("构建 settings 出错"));gameviewBundleConfigs=r.bundleConfigs,t.status(200).send(`${JSON.stringify(r.settings)}`)}},{url:"/src/effect.bin",async handle(e,t,s){const r=(0,path_1.join)(Editor.Project.tmpDir,"asset-db/effect/effect.bin");t.sendFile(r)}},{url:"/scene/*.json",async handle(e,t,s){const r=e.params[0],n=new Error(Editor.I18n.t("preview.load_current_scene_error",{scene:r}));if("current_scene"===r){const e=await Editor.Message.request("scene","query-scene-json");if(!e)return s(n);t.end(e)}else if(r){const e=await Editor.Message.request("asset-db","query-asset-info",r);if(!e||!e.library[".json"])return s(n);{const r=e.library[".json"];if(!r)return s(n);t.sendFile(r)}}}},{url:"/assets/*/import/*",handle:handleLibraryFile},{url:"/assets/*/native/*",handle:handleLibraryFile},{url:"/remote/*/import/*",handle:handleLibraryFile},{url:"/remote/*/native/*",handle:handleLibraryFile},{url:"/query-extname/*",async handle(e,t,s){const r=e.params[0],n=await Editor.Message.request("asset-db","query-asset-info",r);n&&n.library[".cconb"]?t.status(200).send(".cconb"):t.status(200).send("")}},{url:"/assets/*/config.json",async handle(e,t,s){const r=bundleConfigs.find(t=>t.name===e.params[0]);if(!r)return s();t.status(200).send(JSON.stringify(r))}},{url:"/assets/*/index.js",async handle(e,t,s){if(!bundleConfigs.find(t=>t.name===e.params[0]))return s();const r=generateDummyScript(e.params[0]);t.status(200).send(r)}},{url:"/remote/*/config.json",async handle(e,t,s){const r=gameviewBundleConfigs.find(t=>t.name===e.params[0]);if(!r)return s();t.status(200).send(JSON.stringify(r))}},{url:"/remote/*/index.js",async handle(e,t,s){if(!gameviewBundleConfigs.find(t=>t.name===e.params[0]))return s();const r=generateDummyScript(e.params[0]);t.status(200).send(r)}},{url:"/plugins/*",async handle(e,t,s){if(!databaseResourceMapping){const t=await Editor.Message.request("preview","generate-settings",{type:"browser",startScene:e.query.scene});if(!t||!t.script2library)return s(new Error("构建 settings 出错"));databaseResourceMapping=t.script2library}const r=databaseResourceMapping[e.params[0]];if(!(0,fs_extra_1.existsSync)(r))return s();t.sendFile(r)}},{url:"/",async handle(e,t,s){const r=await(0,FacetInstance_1.waitForProgrammingFacet)(),n=e.header("user-agent"),a=new Mobiledetect(n);let i=e.query.scene;i||(i=await Editor.Profile.getConfig("preview","general.start_scene"));const o=await handleDeviceMap(),c=await Editor.Profile.getConfig("preview","preview");c.device=c.device||"Default","false"===e.query.debug&&(c.showFps=!1);const l="true"===e.query.splashPreview,p={title:`Cocos Creator - ${(0,path_1.basename)(Editor.Project.path)}`,tip_sceneIsEmpty:Editor.I18n.t("preview.scene_is_empty"),enableDebugger:"false"!==e.query.debug&&(!!a.mobile()||-1!==n.indexOf("MicroMessenger")),devices:o,config:c,cocosTemplate:(0,path_1.join)(__dirname,"../../static/views/script.ejs"),cocosToolBar:(0,path_1.join)(__dirname,"../../static/views/toolbar.ejs"),settingsJs:`/settings.js?scene=${i}${l?"&splashPreview=true":""}`,packImportMapURL:`/scripting/x/${r.packImportMapURL}`,packResolutionDetailMapURL:`/scripting/x/${r.packResolutionDetailMapURL}`};await plugin_1.pluginManager.runHooks("browser","renderData",p);const u=(0,path_1.join)(Editor.Project.path,"preview-template","index.ejs");if((0,fs_extra_1.existsSync)(u))try{console.log(`Use preview template {link(${u})}`);const e=await ejs_1.default.renderFile(u,p);return void t.end(e)}catch(e){console.error(e)}const d=await ejs_1.default.renderFile((0,path_1.join)(__dirname,"../../static/views/index.ejs"),p);t.status(200).send(d),Editor.Message.send("preview","ready")}},{url:"/preview-app/*",async handle(e,t,s){t.sendFile((0,path_1.join)(__dirname,"..","..","preview-app","dist",e.params[0]))}},{url:"/node_modules/*",async handle(e,t,s){let r=(0,path_1.join)(__dirname,"../../../../node_modules",e.params[0]);(0,fs_extra_1.existsSync)(r)||(r=r.replace("app.asar","app.asar.unpacked")),(0,fs_extra_1.existsSync)(r)||s(),t.sendFile(r)}},{url:"/scripting/polyfills/*",async handle(e,t){const s=(0,path_1.join)((0,path_1.dirname)(require.resolve("@editor/build-polyfills/package.json")),"prebuilt","preview"),r=(0,path_1.join)(s,e.params[0]);t.sendFile(r)}},{url:"/scripting/systemjs/*",async handle(e,t){const s=await(0,FacetInstance_1.waitForProgrammingFacet)();t.sendFile((0,path_1.join)(s.systemJsHomeDir,e.params[0]))}},{url:"/scripting/userland/macro",async handle(e,t,s){await(0,FacetInstance_1.waitForProgrammingFacet)();const r=(0,path_1.join)(Editor.Project.path,"./temp/programming/custom-macro.js");t.sendFile(r)}},{url:"/scripting/import-map-global",async handle(e,t,s){const r=await(0,FacetInstance_1.waitForProgrammingFacet)(),n=await r.getGlobalImportMap();t.json(n)}},{url:"/scripting/x/*",async handle(e,t,s){const r=await(0,FacetInstance_1.waitForProgrammingFacet)(),n=0===Object.keys(e.query).length?"":`?${new url_1.URLSearchParams(e.query).toString()}`,a=e.params[0]+n,i=await r.loadPackResource(a);switch(i.type){case"json":t.json(i.json);break;case"chunk":t.sendFile(i.chunk.path);break;default:s(new Error("Unknown pack resource type"))}}},{url:"/scripting/engine/*",async handle(e,t,s){const r=await(0,FacetInstance_1.waitForProgrammingFacet)();let n=(0,path_1.join)(r.engineRoot,e.params[0]);if(await(0,fs_extra_1.pathExists)(n)||(n=`${n}.js`),!await(0,fs_extra_1.pathExists)(n))return s();t.sendFile(n,{dotfiles:"allow"})}},{url:"/missing-asset/*",async handle(e,t,s){const r=e.params[0].match(/[^@]*/)[0],n=await Editor.Message.request("asset-db","query-missing-asset-info",r);t.json(n)}}];const sockets=[];let reloadTimer=null;async function handleDeviceMap(){const e={},t=await Editor.Message.request("device","query"),s=await Editor.Profile.getProject("project","general.designResolution");return s&&t.splice(0,0,{name:Editor.I18n.t("preview.web_view.design_resolution"),width:s.width,height:s.height,ratio:1}),t.splice(1,0,{name:Editor.I18n.t("preview.web_view.fullScreen")},{name:Editor.I18n.t("preview.web_view.webpageFullScreen")},{name:"__separator__"}),t.forEach(t=>{let s=t.name;t.name===Editor.I18n.t("preview.web_view.design_resolution")?s="Default":t.name===Editor.I18n.t("preview.web_view.fullScreen")?s="FullScreen":t.name===Editor.I18n.t("preview.web_view.webpageFullScreen")&&(s="WebpageFullScreen"),e[s]=t}),e}function generateDummyScript(e){return`System.register("virtual:///prerequisite-imports/${e}", [], function () {\n        "use strict";\n      \n        return {\n          setters: [],\n          execute: function () {}\n        };\n    });`}async function handleLibraryFile(e,t,s){const r=e.params[1].replace(/[^(\\|/|@)]+/g,encodeURIComponent);let n=(0,path_1.join)(Editor.Project.path,"/library",r);if((0,fs_extra_1.existsSync)(n)||(n=(0,path_1.join)(Editor.App.path,"builtin/asset-db/static/internal/library",r)),!(0,fs_extra_1.existsSync)(n))return s();t.sendFile(n)}function connection(e){sockets.push(e),e.on("changeOption",(e,t)=>{Editor.Profile.setConfig("preview",`preview.${e}`,t,"global")}),e.on("preview error",e=>{console.error(e)})}function disconnect(e){const t=sockets.indexOf(e);-1!==t&&sockets.splice(t,1)}function reload(){0!==sockets.length&&(clearTimeout(reloadTimer),reloadTimer=setTimeout(()=>{sockets.forEach(e=>{e.emit("browser:reload")})},200))}function close(){0!==sockets.length&&sockets.forEach(e=>{e.emit("browser:close")})}exports.connection=connection,exports.disconnect=disconnect,exports.reload=reload,exports.close=close;