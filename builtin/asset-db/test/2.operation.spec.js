"use struct";const{expect:expect}=require("chai"),{join:join}=require("path"),{existsSync:existsSync,statSync:statSync,readJSONSync:readJSONSync,readFileSync:readFileSync,removeSync:removeSync}=require("fs-extra"),invalidParams=[{name:"undefined",value:void 0},{name:"null",value:null},{name:"number - 0",value:0},{name:"number - 2",value:2},{name:"string - empty",value:""},{name:"string - str",value:"str"},{name:"boolean - true",value:!0},{name:"boolean- false",value:!1},{name:"array",value:[]},{name:"object",value:{}}];describe("测试 db 的操作接口",async function(){const e=`__${Date.now()}__`,s=join(Editor.Project.path,"assets","__asset-db-test__");after(async function(){removeSync(s)}),describe("create-asset",async function(){it("创建文件夹",async function(){const t=await Editor.Message.request("asset-db","create-asset",`db://assets/__asset-db-test__/${e}.directory`),a=existsSync(join(s,`${e}.directory`));console.log(join(s,`${e}.directory`)),expect(a).is.equal(!0);const i=statSync(join(s,`${e}.directory`));expect(i.isDirectory()).is.equal(!0);const n=readJSONSync(join(s,`${e}.directory.meta`));expect(n.uuid).is.equal(t.uuid)}),it("创建普通资源",async function(){const t=await Editor.Message.request("asset-db","create-asset",`db://assets/__asset-db-test__/${e}.normal`,"test"),a=existsSync(join(s,`${e}.normal`));expect(a).is.equal(!0);const i=statSync(join(s,`${e}.normal`));expect(i.isDirectory()).is.equal(!1);const n=readJSONSync(join(s,`${e}.normal.meta`));expect(n.uuid).is.equal(t.uuid);const c=readFileSync(join(s,`${e}.normal`),"utf8");expect(c).is.equal("test")}),invalidParams.forEach(e=>{it(`传入参数错误 - ${e.name}`,async function(){let s=!1;try{await Editor.Message.request("asset-db","create-asset",e.value)}catch(e){s=!0}expect(s).is.true})})}),describe("copy-asset",()=>{it("复制文件夹",async function(){await Editor.Message.request("asset-db","copy-asset",`db://assets/__asset-db-test__/${e}.directory`,`db://assets/__asset-db-test__/${e}.directory2`);const t=await Editor.Message.request("asset-db","query-uuid",`db://assets/__asset-db-test__/${e}.directory2`),a=existsSync(join(s,`${e}.directory`));expect(a).is.equal(!0);const i=existsSync(join(s,`${e}.directory2`));expect(i).is.equal(!0);const n=statSync(join(s,`${e}.directory2`));expect(n.isDirectory()).is.equal(!0);const c=readJSONSync(join(s,`${e}.directory2.meta`));expect(c.uuid).is.equal(t)}),it("复制普通资源",async function(){await Editor.Message.request("asset-db","copy-asset",`db://assets/__asset-db-test__/${e}.normal`,`db://assets/__asset-db-test__/${e}.normal2`);const t=await Editor.Message.request("asset-db","query-uuid",`db://assets/__asset-db-test__/${e}.normal2`),a=existsSync(join(s,`${e}.normal`));expect(a).is.equal(!0);const i=existsSync(join(s,`${e}.normal2`));expect(i).is.equal(!0);const n=statSync(join(s,`${e}.normal2`));expect(n.isDirectory()).is.equal(!1);const c=readJSONSync(join(s,`${e}.normal2.meta`));expect(c.uuid).is.equal(t);const r=readFileSync(join(s,`${e}.normal2`),"utf8");expect(r).is.equal("test")}),invalidParams.forEach(t=>{it(`第一个参数传入参数错误 - ${t.name}`,async function(){let a=!1;try{await Editor.Message.request("asset-db","copy-asset",t.value,join(s,`${e}.normal10`))}catch(e){a=!0}expect(a).is.true}),it(`第二个参数传入参数错误 - ${t.name}`,async function(){let a=!1;try{await Editor.Message.request("asset-db","copy-asset",join(s,`${e}.normal`),t.value)}catch(e){a=!0}expect(a).is.true})})}),describe("move-asset",()=>{it("移动文件夹",async function(){await Editor.Message.request("asset-db","move-asset",`db://assets/__asset-db-test__/${e}.directory2`,`db://assets/__asset-db-test__/${e}.directory3`);const t=existsSync(join(s,`${e}.directory2`));expect(t).is.equal(!1);const a=existsSync(join(s,`${e}.directory3`));expect(a).is.equal(!0);const i=statSync(join(s,`${e}.directory3`));expect(i.isDirectory()).is.equal(!0)}),it("移动普通资源",async function(){await Editor.Message.request("asset-db","move-asset",`db://assets/__asset-db-test__/${e}.normal2`,`db://assets/__asset-db-test__/${e}.normal3`);const t=existsSync(join(s,`${e}.normal2`));expect(t).is.equal(!1);const a=existsSync(join(s,`${e}.normal3`));expect(a).is.equal(!0);const i=statSync(join(s,`${e}.normal3`));expect(i.isDirectory()).is.equal(!1);const n=readFileSync(join(s,`${e}.normal3`),"utf8");expect(n).is.equal("test")}),invalidParams.forEach(t=>{it(`第一个参数传入参数错误 - ${t.name}`,async function(){let a=!1;try{await Editor.Message.request("asset-db","move-asset",t.value,join(s,`${e}.normal10`))}catch(e){a=!0}expect(a).is.true}),it(`第二个参数传入参数错误 - ${t.name}`,async function(){let a=!1;try{await Editor.Message.request("asset-db","move-asset",join(s,`${e}.normal`),t.value)}catch(e){a=!0}expect(a).is.true})})}),describe("delete-asset",()=>{it("删除文件夹",async function(){await Editor.Message.request("asset-db","delete-asset",`db://assets/__asset-db-test__/${e}.directory3`);const t=existsSync(join(s,`${e}.directory3`));expect(t).is.equal(!1);const a=existsSync(join(s,`${e}.directory3.meta`));expect(a).is.equal(!1)}),it("删除普通资源",async function(){await Editor.Message.request("asset-db","delete-asset",`db://assets/__asset-db-test__/${e}.normal3`,"test");const t=existsSync(join(s,`${e}.normal3`));expect(t).is.equal(!1);const a=existsSync(join(s,`${e}.normal3.meta`));expect(a).is.equal(!1)}),invalidParams.forEach(e=>{it(`传入参数错误 - ${e.name}`,async function(){let s=!1;try{await Editor.Message.request("asset-db","delete-asset",e.value)}catch(e){s=!0}expect(s).is.true})})}),describe("save-asset",()=>{it("保存普通资源",async function(){await Editor.Message.request("asset-db","save-asset",`db://assets/__asset-db-test__/${e}.normal`,"test2");const t=existsSync(join(s,`${e}.normal`));expect(t).is.equal(!0);const a=readFileSync(join(s,`${e}.normal`),"utf8");expect(a).is.equal("test2")}),invalidParams.forEach(e=>{it(`传入参数错误 - ${e.name}`,async function(){let s=!1;try{await Editor.Message.request("asset-db","save-asset",e.value)}catch(e){s=!0}expect(s).is.true})})}),describe("save-asset-meta",()=>{it("保存资源的 meta",async function(){const t=await Editor.Message.request("asset-db","query-uuid",`db://assets/__asset-db-test__/${e}.normal`),a=readJSONSync(join(s,`${e}.normal.meta`));a.userData.test=!0,await Editor.Message.request("asset-db","save-asset-meta",t,JSON.stringify(a));const i=await Editor.Message.request("asset-db","query-asset-meta",t);expect(i.userData.test).is.equal(!0)}),invalidParams.forEach(s=>{it(`传入参数错误 - ${s.name}`,async function(){const t=await Editor.Message.request("asset-db","query-uuid",`db://assets/__asset-db-test__/${e}.normal`);let a=!1;try{null===await Editor.Message.request("asset-db","save-asset-meta",t,s.value)&&(a=!0)}catch(e){a=!0}expect(a).is.true;const i=await Editor.Message.request("asset-db","query-asset-meta",t);expect(i.userData.test).is.equal(!0)})})})});