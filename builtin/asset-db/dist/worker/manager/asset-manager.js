"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetManager=exports.AssetManager=void 0,exports.searchAssets=searchAssets;const asset_db_1=require("@editor/asset-db"),path_1=require("path"),asset_db_manager_1=require("../asset-db-manager"),utils_1=require("../utils"),asset_handler_manager_1=require("./asset-handler-manager"),minimatch_1=__importDefault(require("minimatch")),events_1=__importDefault(require("events")),mask_sync_1=require("../mask-sync"),fs_extra_1=require("fs-extra"),asset_cache_1=require("./asset-cache");class AssetManager extends events_1.default{async queryAssetDependencies(e,s="asset"){e=this.queryAsset(e);if(!e)return[];let t=[];return["asset","all"].includes(s)&&(t=this.queryAssetProperty(e,"depends")),["script","all"].includes(s)&&("cc.Script"===this.queryAssetProperty(e,"type")?(s=await Editor.Message.request("programming","packer-driver/query-script-deps",e.source),t.push(...s.map(e=>(0,asset_db_1.queryUUID)(e)))):t.push(...this.queryAssetProperty(e,"dependScripts"))),t}async queryAssetUsers(e,s="asset"){e=this.queryAsset(e);if(!e)return[];var t=this.queryAssetProperty(e,"type");let a=[];return["asset","all"].includes(s)&&(a="cc.Script"===t?this.queryAssetProperty(e,"dependedScripts"):this.queryAssetProperty(e,"dependeds")),["script","all"].includes(s)&&"cc.Script"===t&&(await Editor.Message.request("programming","packer-driver/query-script-users",e.source)).forEach(e=>a.push((0,asset_db_1.queryUUID)(e))),a}queryAsset(e){var s=Editor.Utils.UUID.isUUID(e)?e:this.queryAssetUUID(e);for(const a in asset_db_manager_1.assetDBManager.assetDBMap){var t=asset_db_manager_1.assetDBManager.assetDBMap[a];if(t){if(s==="db://"+a)return{displayName:"",basename:a,extname:"",imported:!0,source:"db://"+a,subAssets:{},library:"",parent:null,userData:{},isDirectory(){return!1},uuid:"db://"+a,meta:{ver:"1.0.0",uuid:"db://"+a,name:a,id:a,subMetas:{},userData:{},importer:"database",imported:!0,files:[],displayName:""}};t=t.getAsset(s||"");if(t)return t}}return null}queryAssetInfo(e,s){if(!e||"string"!=typeof e)throw new Error("parameter error");let t="";if(e.startsWith("db://")){var a=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[a])return exports.assetManager.queryDBAssetInfo(a);t=(0,utils_1.url2uuid)(e)}else if((0,path_1.isAbsolute)(e))for(const n in asset_db_manager_1.assetDBManager.assetDBMap){var r=asset_db_manager_1.assetDBManager.assetDBMap[n];if(r&&r.path2asset.has(e)){t=r.path2asset.get(e).uuid;break}}else t=e;return t?this.queryAssetInfoByUUID(t,s):null}queryAssetInfoByUUID(e,s){return(e=e&&(0,asset_db_1.queryAsset)(e))?this.encodeAsset(e,s):null}queryAssetInfos(s,t){let e=[];var a=[];for(const o in asset_db_manager_1.assetDBManager.assetDBMap){var r=asset_db_manager_1.assetDBManager.assetDBMap[o];e=e.concat(Array.from(r.uuid2asset.values())),a.push(this.queryDBAssetInfo(o))}let n=e;s&&(s.isBundle&&(t=(t||[]).concat(["meta"])),i=FilterHandlerInfos.filter(e=>(e.value=s[e.name],e.resolve&&(e.value=e.resolve(e.value)),void 0!==e.value)),n=searchAssets(i,e));var i=n.map(e=>this.encodeAsset(e,t));return!s||e.length&&e.length===i.length?i.concat(a):s.pattern&&1===Object.keys(s).length?a.filter(e=>(0,minimatch_1.default)(e.url,s.pattern)).concat(i):i}queryAssets(s={}){"object"==typeof s&&!Array.isArray(s)||(s={});let e=[];for(const r in asset_db_manager_1.assetDBManager.assetDBMap){var t;r in asset_db_manager_1.assetDBManager.assetDBMap&&(t=asset_db_manager_1.assetDBManager.assetDBMap[r],e=e.concat(Array.from(t.uuid2asset.values())))}var a;return s&&(a=FilterHandlerInfos.filter(e=>(e.value=s[e.name],e.resolve&&(e.value=e.resolve(e.value)),void 0!==e.value)),e=searchAssets(a,e)),e}async saveAssetMeta(e,s,t){if("object"!=typeof s||Array.isArray(s))throw new Error(`Save meta failed(${e}): The meta must be an Object string`);mergeMeta((t=t||this.queryAsset(e)).meta,s),await t.save()}async saveAsset(e,s){e=this.queryAsset(e);if(!e)throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.asset"));if(e._assetDB.options.readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e.url);if(void 0===s)throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.content"));if(e.source)return await asset_handler_manager_1.assetHandlerManager.saveAsset(e,s)&&this.reimportAsset(e.uuid),exports.assetManager.encodeAsset(e);throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.uuid"))}encodeAsset(s,e=["displayName","subAssets","redirect","visible","extends"],t=!1){let a="",r="",n="";var i,o,u,d=s._assetDB;s.uuid===s.source||s instanceof asset_db_1.Asset&&s.source?(a=(0,path_1.basename)(s.source),r=asset_db_manager_1.assetDBManager.path2url(s.source,d.options.name),n=s.source):a=s._name;let _=a,l=a;if(s.uuid===s.source||s instanceof asset_db_1.Asset)l=_=r;else{let e=s.parent;for(;e&&!(e instanceof asset_db_1.Asset);)_=e._name+"/"+a,e=e.parent;e instanceof asset_db_1.Asset&&(i=(0,path_1.extname)(e._source),o=asset_db_manager_1.assetDBManager.path2url(e._source,d.options.name),l=o+"/"+_,_=o.substr(0,o.length-i.length)+"/"+_)}let c=!1;try{c=s.isDirectory()}catch(e){t?console.debug(e):console.error(e),c=""===(0,path_1.extname)(s.source)}c||(_=_.replace(/\.[^./]+$/,""));const p={name:a,displayName:s.displayName,source:r,path:_,url:l,file:n,uuid:s.uuid,importer:s.meta.importer,imported:s.meta.imported,invalid:s.invalid,type:this.queryAssetProperty(s,"type"),isDirectory:c,instantiation:this.queryAssetProperty(s,"instantiation"),readonly:d.options.readonly,library:(0,utils_1.libArr2Obj)(s)};if(e.forEach(e=>{p[e]=this.queryAssetProperty(s,e)??p[e]}),e.includes("isBundle")||this.queryAssetProperty(s,"isBundle")&&(p.isBundle=!0),e.includes("fatherInfo")&&s.parent&&(p.fatherInfo={source:s.parent.source,library:(0,utils_1.libArr2Obj)(s.parent),uuid:s.parent.uuid}),e.includes("subAssets")){p.subAssets={};for(const a in s.subAssets)a in s.subAssets&&(u=this.encodeAsset(s.subAssets[a],e),p.subAssets[a]=u)}return p}queryAssetProperty(n,e){switch(e){case"path":{var t=this.queryAssetProperty(n,"name");let s=t;if(n instanceof asset_db_1.Asset)s=asset_db_manager_1.assetDBManager.path2url(n.source,n._assetDB.options.name);else{let e=n.parent;for(;e&&!(e instanceof asset_db_1.Asset);)s=e._name+"/"+t,e=e.parent;e instanceof asset_db_1.Asset&&(i=(0,path_1.extname)(e._source),a=asset_db_manager_1.assetDBManager.path2url(e._source,n._assetDB.options.name),s=a.substr(0,a.length-i.length)+"/"+s)}var a=n.isDirectory();return s=a?s:s.replace(/\.[^./]+$/,"")}case"name":return n.uuid===n.source||n instanceof asset_db_1.Asset&&n.source?(0,path_1.basename)(n.source):n._name;case"url":var r=this.queryAssetProperty(n,"name");if(n.uuid===n.source||n instanceof asset_db_1.Asset)return asset_db_manager_1.assetDBManager.path2url(n.source,n._assetDB.options.name);{let e=r,s=n.parent;for(;s&&!(s instanceof asset_db_1.Asset);)e=s._name+"/"+r,s=s.parent;return s instanceof asset_db_1.Asset?asset_db_manager_1.assetDBManager.path2url(s._source,n._assetDB.options.name)+"/"+e:e}case"type":var i=asset_handler_manager_1.assetHandlerManager.name2handler[n.meta.importer]||n._assetDB.importerManager.name2importer[n.meta.importer]||null;return i&&i.assetType||"cc.Asset";case"isBundle":return n.meta.userData&&n.meta.userData.isBundle;case"instantiation":a=asset_handler_manager_1.assetHandlerManager.name2handler[n.meta.importer]||n._assetDB.importerManager.name2importer[n.meta.importer]||null;return a?a.instantiation:void 0;case"library":return(0,utils_1.libArr2Obj)(n);case"displayName":return n.displayName;case"redirect":if(n.meta.userData&&n.meta.userData.redirect){i=this.queryAsset(n.meta.userData.redirect);if(i)return a=asset_handler_manager_1.assetHandlerManager.name2handler[i.meta.importer]||null,{uuid:i.uuid,type:a&&a.assetType||"cc.Asset"}}return;case"extends":i=this.queryAssetProperty(n,"type");return(0,utils_1.getExtendsFromCCType)(i);case"visible":{let e=n._assetDB.options.visible;return!1!==(e=e&&!1===n.userData.visible?!1:e)}case"mtime":a=n._assetDB.infoManager.get(n.source);return a?a.time:null;case"meta":return n.meta;case"depends":return Array.from(n.getData("depends")||[]);case"dependeds":{const o=[],u=Object.values(n.subAssets).map(e=>e.uuid);let r;return r=u.length?(u.push(n.uuid),(s,t)=>{u.forEach(e=>{s.includes(e)&&!u.includes(t)&&o.push(t)})}):(e,s)=>{e.includes(n.uuid)&&o.push(s)},(0,asset_db_1.forEach)(e=>{var s=e.dataManager.dataMap;for(const a in s){var t=s[a];t.value&&t.value.depends&&t.value.depends.length&&r(t.value.depends,a)}}),o}case"dependScripts":i=n._assetDB.dataManager.dataMap[n.uuid];return Array.from(i&&i.value&&i.value.dependScripts||[]);case"dependedScripts":{const d=[];return(0,asset_db_1.forEach)(e=>{var s=e.dataManager.dataMap;for(const a in s){var t=s[a];t.value&&t.value.dependScripts&&t.value.dependScripts.includes(n.uuid)&&d.push(a)}}),d}}}queryAssetMeta(e){if(!e||"string"!=typeof e)return null;if(e.startsWith("db://")){var s=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return{files:[],imported:!0,importer:"database",subMetas:{},userData:{},uuid:e,ver:"1.0.0"};e=(0,utils_1.url2uuid)(e)}s=(0,asset_db_1.queryAsset)(e);return s?s.meta:null}queryAssetMtime(e){if(e&&"string"==typeof e)for(const a in asset_db_manager_1.assetDBManager.assetDBMap)if(a in asset_db_manager_1.assetDBManager.assetDBMap){var s=asset_db_manager_1.assetDBManager.assetDBMap[a];if(s){var t=s.getAsset(e);if(t)return(s=s.infoManager.get(t.source))?s.time:null}}return null}queryAssetUUID(e){if(!e||"string"!=typeof e)return null;if(e.startsWith("db://")){var s=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return"db://"+s;s=(0,utils_1.url2uuid)(e);if(s)return s}try{return(0,asset_db_1.queryUUID)(e)}catch(e){return null}}queryDBAssetInfo(e){var s=asset_db_manager_1.assetDBManager.assetDBInfo[e];return s?{name:e,displayName:e||"",source:"db://"+e,path:"db://"+e,url:"db://"+e,file:s.target,uuid:"db://"+e,importer:"database",imported:!0,invalid:!1,type:"database",isDirectory:!1,library:{},subAssets:{},visible:s.visible,instantiation:void 0,readonly:s.readonly}:null}queryUrl(e){var s;if(e&&"string"==typeof e)return s=e.substr(Editor.Project.path.length+1),asset_db_manager_1.assetDBManager.assetDBMap[s]?"db://"+s:(0,asset_db_1.queryUrl)(e);throw new Error("parameter error")}checkValidUrl(e){if(!e.startsWith("db://")&&!(e=this.queryUrl(e)))throw new Error(Editor.I18n.t("asset-db.operation.invalid_url")+` 
  url: `+e);var s=e.split("/").filter(Boolean)[1];if(asset_db_manager_1.assetDBManager.assetDBInfo[s].readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e);return!0}async createAsset(e){if(!e.target||"string"!=typeof e.target)throw new Error("Cannot create asset because options.target is required.");this.checkValidUrl(e.target),(0,path_1.isAbsolute)(e.target)||(e.target=(0,utils_1.url2path)(e.target));e=await asset_handler_manager_1.assetHandlerManager.createAsset(e);if(!e||!e.length)return null;let s=[];s="string"==typeof e?[e]:e;e=await Promise.all(s.map(async e=>(await this.refreshAsset(e),this.queryAssetInfo((0,asset_db_1.queryUUID)(e)))));return 1===e.length?e[0]:e}async createAssetDialog(e){e=await asset_handler_manager_1.assetHandlerManager.createAssetDialog(e);if(!e||!e.length)return null;let s=[];s="string"==typeof e?[e]:e;e=await Promise.all(s.map(async e=>(await this.refreshAsset(e),this.queryAssetInfo((0,asset_db_1.queryUUID)(e)))));return 1===e.length?e[0]:e}async generateExportData(e,s){var t=e.getData("output");if(!t||s){var a=await asset_handler_manager_1.assetHandlerManager.generateExportData(e,s);if(a)return a;if(!e.meta.files.includes(".json")&&!e.meta.files.includes(".cconb"))return null;t=(0,utils_1.ensureOutputData)(e),s&&t.native&&((a=asset_cache_1.assetOutputPathCache.query(e.uuid,s))?t.import.path=a:(a=await(0,utils_1.serializeCompiled)(e,s),await(0,fs_extra_1.outputFile)(t.import.path,a),await asset_cache_1.assetOutputPathCache.add(e,s,t.import.path)),e.setData("output",t))}return t}async outputExportData(e,s,t){e=await asset_handler_manager_1.assetHandlerManager.outputExportData(e,s,t);if(!e&&(await(0,fs_extra_1.copy)(s.import.path,t.import.path),s.native)&&t.native){e=Object.values(s.native);const a=Object.values(t.native);await Promise.all(e.map((e,s)=>(0,fs_extra_1.copy)(e,a[s])))}}async refreshAsset(e){return asset_db_manager_1.assetDBManager.addTask(this._refreshAsset.bind(this),[e])}async _refreshAsset(e,s=!0){console.debug(`start refresh asset from ${e}...`);var t=await(0,asset_db_1.refresh)(e);return s&&asset_db_manager_1.assetDBManager.addTask(asset_db_manager_1.assetDBManager.autoRefreshAssetLazy.bind(asset_db_manager_1.assetDBManager),[(0,path_1.dirname)(e)]),console.debug(`refresh asset ${(0,path_1.dirname)(e)} success`),t}async reimportAsset(e){return asset_db_manager_1.assetDBManager.addTask(this._reimportAsset.bind(this),[e])}async _reimportAsset(e){e.startsWith("db://")&&(e=(0,utils_1.url2uuid)(e)),Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+e),await(0,asset_db_1.reimport)(e),Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+e,{output:!0})}async moveAsset(e,s,t){return asset_db_manager_1.assetDBManager.addTask(this._moveAsset.bind(this),[e,s,t])}async _moveAsset(e,s,t){console.debug(`start move asset from ${e} -> ${s}...`);(0,fs_extra_1.existsSync)(s)&&t?.overwrite&&await this._removeAsset(s),await(0,utils_1.moveFile)(e,s,t);var t=(0,asset_db_1.queryUrl)(s),a=/db:\/\/[^/]+/.exec(t);a&&a[0]&&t.startsWith(a[0])?(await this.refreshAsset(s),await this.refreshAsset((0,path_1.dirname)(e))):(await this.refreshAsset(e),await this.refreshAsset(s)),console.debug(`move asset from ${e} -> ${s} success`)}async renameAsset(e,s,t){return asset_db_manager_1.assetDBManager.addTask(this._renameAsset.bind(this),[e,s,t])}async _renameAsset(e,s,t){console.debug(`start rename asset from ${e} -> ${s}...`);var a={basename:(0,path_1.basename)(s),dirname:(0,path_1.dirname)(s)},a=(0,path_1.join)(a.dirname,".rename_temp");await(0,fs_extra_1.rename)(e+".meta",a+".meta"),await(0,fs_extra_1.rename)(e,a),await this._refreshAsset(e,!1),await(0,fs_extra_1.rename)(a+".meta",s+".meta"),await(0,fs_extra_1.rename)(a,s),await this._refreshAsset(s),console.debug(`rename asset from ${e} -> ${s} success`)}async removeAsset(e){var s=this.queryAsset(e);if(!s)throw new Error(Editor.I18n.t("asset-db.deleteAsset.fail.unexist")+` 
source: `+e);if(s._assetDB.options.readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+s.url);e=s.source;return await asset_db_manager_1.assetDBManager.addTask(this._removeAsset.bind(this),[e])?this.encodeAsset(s):null}async _removeAsset(e){console.debug(`start remove asset ${e}...`);let s=!1;try{await(0,utils_1.removeFile)(e),await this.refreshAsset(e),s=!0,console.debug(`remove asset ${e} success`)}catch(e){console.warn(""+Editor.I18n.t("asset-db.deleteAsset.fail.unknown")),console.warn(e)}return s}url2uuid(e){return(0,utils_1.url2uuid)(e)}url2path(e){return(0,utils_1.url2path)(e)}path2url(e,s){return asset_db_manager_1.assetDBManager.path2url(e,s)}init(){asset_db_manager_1.assetDBManager.on("db-created",this._onAssetDBCreated),asset_db_manager_1.assetDBManager.on("db-started",this._onAssetDBStarted),asset_db_manager_1.assetDBManager.on("db-removed",this._onAssetDBRemoved)}destroyed(){asset_db_manager_1.assetDBManager.removeListener("db-created",this._onAssetDBCreated),asset_db_manager_1.assetDBManager.removeListener("db-started",this._onAssetDBStarted),asset_db_manager_1.assetDBManager.removeListener("db-removed",this._onAssetDBRemoved)}_onAssetDBCreated(e){e.on("unresponsive",onUnResponsive),e.on("added",exports.assetManager._onAssetAdded),e.on("changed",exports.assetManager._onAssetChanged),e.on("deleted",exports.assetManager._onAssetDeleted),e.on("add",mask_sync_1.assetAdd),e.on("delete",mask_sync_1.assetChange),e.on("change",mask_sync_1.assetDeleted)}_onAssetDBStarted(e){e.removeListener("add",mask_sync_1.assetAdd),e.removeListener("change",mask_sync_1.assetChange),e.removeListener("delete",mask_sync_1.assetDeleted)}_onAssetDBRemoved(e){e.removeListener("unresponsive",onUnResponsive),e.removeListener("added",exports.assetManager._onAssetAdded),e.removeListener("changed",exports.assetManager._onAssetChanged),e.removeListener("deleted",exports.assetManager._onAssetDeleted)}async _onAssetAdded(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-add",e),Editor.Message.broadcast("asset-db:asset-add",e.uuid,await exports.assetManager.encodeAsset(e),e.meta)):(0,mask_sync_1.assetAdded)(e)}async _onAssetChanged(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-change",e),Editor.Message.broadcast("asset-db:asset-change",e.uuid,await exports.assetManager.encodeAsset(e),e.meta)):(0,mask_sync_1.assetChanged)(e)}async _onAssetDeleted(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-delete",e),Editor.Message.broadcast("asset-db:asset-delete",e.uuid,await exports.assetManager.encodeAsset(e,void 0,!0),e.meta)):(0,mask_sync_1.assetDeleted)(e)}}async function onUnResponsive(e,s){asset_db_manager_1.assetDBManager.ready?1===(await Editor.Dialog.info(`Resource import Timeout.
  uuid: ${e.uuid}
  url: `+e.url,{buttons:["Waiting","Interrupt"]})).response&&s.reject("User interrupt"):console.debug("import asset unresponsive")}function mergeMeta(s,t){Object.keys(t).map(e=>{"subMetas"===e?(Object.keys(t.subMetas).forEach(e=>{s.subMetas[e]||(s.subMetas[e]={}),mergeMeta(s.subMetas[e],t.subMetas[e])}),s.subMetas&&Object.keys(s.subMetas).forEach(e=>{e in t.subMetas||delete s.subMetas[e]})):s[e]=t[e]})}exports.AssetManager=AssetManager,exports.assetManager=new AssetManager;const TYPES={scripts:[".js",".ts"],scene:[".scene"],effect:[".effect"],image:[".jpg",".png",".jpeg",".webp",".tga"]};function searchAssets(e,s,t=[]){return e.length?(s.forEach(s=>{s.subAssets&&0<Object.keys(s.subAssets).length&&searchAssets(e,Object.values(s.subAssets),t),e.some(e=>void 0!==e.value&&!e.handler(e.value,s))||t.push(s)}),t):s}function filterUserDataInfo(s,t){return!Object.keys(s).some(e=>s[e]!==t.meta.userData[e])}const FilterHandlerInfos=[{name:"ccType",handler:(e,s)=>e.includes(exports.assetManager.queryAssetProperty(s,"type")),resolve:e=>"string"==typeof e?[e.trim()]:e},{name:"pattern",handler:(e,s)=>{var t=exports.assetManager.queryAssetProperty(s,"path"),s=exports.assetManager.queryAssetProperty(s,"url");return(0,minimatch_1.default)(t,e)||(0,minimatch_1.default)(s,e)},resolve:e=>"string"==typeof e?e:void 0},{name:"importer",handler:(e,s)=>e.includes(s.meta.importer),resolve:e=>{if("string"==typeof e)return[e.trim()]}},{name:"isBundle",handler:(e,s)=>!!exports.assetManager.queryAssetProperty(s,"isBundle")===e},{name:"extname",handler:(e,s)=>{var t=(0,path_1.extname)(s.source).toLowerCase();return!(!e.includes(t)||/\.d\.ts$/.test(s.source))},resolve(e){return"string"==typeof e?[e.trim().toLocaleLowerCase()]:Array.isArray(e)?e.map(e=>e.trim().toLocaleLowerCase()):void 0}},{name:"userData",handler:(e,s)=>filterUserDataInfo(e,s)},{name:"type",handler:(e,s)=>e.includes((0,path_1.extname)(s.source))&&!/\.d\.ts$/.test(s.source),resolve:e=>{e=TYPES[e];if(e)return console.warn(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"options.type",newName:"options.ccType",version:"3.8.0"})),e}}];