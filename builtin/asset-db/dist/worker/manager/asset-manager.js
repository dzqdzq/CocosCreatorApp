"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetManager=exports.AssetManager=void 0,exports.searchAssets=searchAssets;const asset_db_1=require("@editor/asset-db"),path_1=require("path"),asset_db_manager_1=require("../asset-db-manager"),utils_1=require("../utils"),asset_handler_manager_1=require("./asset-handler-manager"),minimatch_1=__importDefault(require("minimatch")),events_1=__importDefault(require("events")),mask_sync_1=require("../mask-sync"),fs_extra_1=require("fs-extra"),asset_cache_1=require("./asset-cache");class AssetManager extends events_1.default{async queryAssetDependencies(e,s="asset"){e=this.queryAsset(e);if(!e)return[];let t=[];return["asset","all"].includes(s)&&(t=this.queryAssetProperty(e,"depends")),["script","all"].includes(s)&&("cc.Script"===this.queryAssetProperty(e,"type")?(s=await Editor.Message.request("programming","packer-driver/query-script-deps",e.source),t.push(...s.map(e=>(0,asset_db_1.queryUUID)(e)))):t.push(...this.queryAssetProperty(e,"dependScripts"))),t}async queryAssetUsers(e,s="asset"){e=this.queryAsset(e);if(!e)return[];var t=this.queryAssetProperty(e,"type");let a=[];return["asset","all"].includes(s)&&(a="cc.Script"===t?this.queryAssetProperty(e,"dependedScripts"):this.queryAssetProperty(e,"dependeds")),["script","all"].includes(s)&&"cc.Script"===t&&(await Editor.Message.request("programming","packer-driver/query-script-users",e.source)).forEach(e=>a.push((0,asset_db_1.queryUUID)(e))),a}queryAsset(e){var s=Editor.Utils.UUID.isUUID(e)?e:this.queryAssetUUID(e);for(const a in asset_db_manager_1.assetDBManager.assetDBMap){var t=asset_db_manager_1.assetDBManager.assetDBMap[a];if(t){if(s==="db://"+a)return{displayName:"",basename:a,extname:"",imported:!0,source:"db://"+a,subAssets:{},library:"",parent:null,userData:{},isDirectory(){return!1},uuid:"db://"+a,meta:{ver:"1.0.0",uuid:"db://"+a,name:a,id:a,subMetas:{},userData:{},importer:"database",imported:!0,files:[],displayName:""}};t=t.getAsset(s||"");if(t)return t}}return null}queryAssetInfo(e,s){if(!e||"string"!=typeof e)throw new Error("parameter error");let t="";if(e.startsWith("db://")){var a=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[a])return exports.assetManager.queryDBAssetInfo(a);t=(0,utils_1.url2uuid)(e)}else if((0,path_1.isAbsolute)(e))for(const n in asset_db_manager_1.assetDBManager.assetDBMap){var r=asset_db_manager_1.assetDBManager.assetDBMap[n];if(r&&r.path2asset.has(e)){t=r.path2asset.get(e).uuid;break}}else t=e;return t?this.queryAssetInfoByUUID(t,s):null}queryAssetInfoByUUID(e,s){return(e=e&&(0,asset_db_1.queryAsset)(e))?this.encodeAsset(e,s):null}queryAssetInfos(s,t){let e=[];var a=[];for(const i in asset_db_manager_1.assetDBManager.assetDBMap){var r=asset_db_manager_1.assetDBManager.assetDBMap[i];e=e.concat(Array.from(r.uuid2asset.values())),a.push(this.queryDBAssetInfo(i))}s&&s.isBundle&&(t=(t||[]).concat(["meta"]));var n=(s?searchAssets(s,e):e).map(e=>this.encodeAsset(e,t));return s&&e.length!==n.length?s.pattern&&1===Object.keys(s).length?a.filter(e=>(0,minimatch_1.default)(e.url,s.pattern)).concat(n):n:n.concat(a)}queryAssets(e={}){"object"==typeof e&&!Array.isArray(e)||(e={});let s=[];for(const a in asset_db_manager_1.assetDBManager.assetDBMap){var t;a in asset_db_manager_1.assetDBManager.assetDBMap&&(t=asset_db_manager_1.assetDBManager.assetDBMap[a],s=s.concat(Array.from(t.uuid2asset.values())))}return s=e?searchAssets(e,s):s}async saveAssetMeta(e,s,t){if("object"!=typeof s||Array.isArray(s))throw new Error(`Save meta failed(${e}): The meta must be an Object string`);mergeMeta((t=t||this.queryAsset(e)).meta,s),await t.save()}async saveAsset(e,s){e=this.queryAsset(e);if(!e)throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.asset"));if(e._assetDB.options.readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e.url);if(void 0===s)throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.content"));if(e.source)return await asset_handler_manager_1.assetHandlerManager.saveAsset(e,s)&&this.reimportAsset(e.uuid),exports.assetManager.encodeAsset(e);throw new Error(""+Editor.I18n.t("asset-db.saveAsset.fail.uuid"))}encodeAsset(s,e=["displayName","subAssets","redirect","visible","extends"],t=!1){let a="",r="",n="";var i,o,u,d=s._assetDB;s.uuid===s.source||s instanceof asset_db_1.Asset&&s.source?(a=(0,path_1.basename)(s.source),r=asset_db_manager_1.assetDBManager.path2url(s.source,d.options.name),n=s.source):a=s._name;let _=a,c=a;if(s.uuid===s.source||s instanceof asset_db_1.Asset)c=_=r;else{let e=s.parent;for(;e&&!(e instanceof asset_db_1.Asset);)_=e._name+"/"+a,e=e.parent;e instanceof asset_db_1.Asset&&(i=(0,path_1.extname)(e._source),o=asset_db_manager_1.assetDBManager.path2url(e._source,d.options.name),c=o+"/"+_,_=o.substr(0,o.length-i.length)+"/"+_)}let l=!1;try{l=s.isDirectory()}catch(e){t?console.debug(e):console.error(e),l=""===(0,path_1.extname)(s.source)}l||(_=_.replace(/\.[^./]+$/,""));const p={name:a,displayName:s.displayName,source:r,path:_,url:c,file:n,uuid:s.uuid,importer:s.meta.importer,imported:s.meta.imported,invalid:s.invalid,type:this.queryAssetProperty(s,"type"),isDirectory:l,instantiation:this.queryAssetProperty(s,"instantiation"),readonly:d.options.readonly,library:(0,utils_1.libArr2Obj)(s)};if(e.forEach(e=>{p[e]=this.queryAssetProperty(s,e)??p[e]}),e.includes("isBundle")||this.queryAssetProperty(s,"isBundle")&&(p.isBundle=!0),e.includes("fatherInfo")&&s.parent&&(p.fatherInfo={source:s.parent.source,library:(0,utils_1.libArr2Obj)(s.parent),uuid:s.parent.uuid}),e.includes("subAssets")){p.subAssets={};for(const a in s.subAssets)a in s.subAssets&&(u=this.encodeAsset(s.subAssets[a],e),p.subAssets[a]=u)}return p}queryAssetProperty(r,e){switch(e){case"path":{var t=this.queryAssetProperty(r,"name");let s=t;if(r instanceof asset_db_1.Asset)s=asset_db_manager_1.assetDBManager.path2url(r.source,r._assetDB.options.name);else{let e=r.parent;for(;e&&!(e instanceof asset_db_1.Asset);)s=e._name+"/"+t,e=e.parent;e instanceof asset_db_1.Asset&&(n=(0,path_1.extname)(e._source),a=asset_db_manager_1.assetDBManager.path2url(e._source,r._assetDB.options.name),s=a.substr(0,a.length-n.length)+"/"+s)}var a=r.isDirectory();return s=a?s:s.replace(/\.[^./]+$/,"")}case"name":return r.uuid===r.source||r instanceof asset_db_1.Asset&&r.source?(0,path_1.basename)(r.source):r._name;case"type":var n=asset_handler_manager_1.assetHandlerManager.name2handler[r.meta.importer]||r._assetDB.importerManager.name2importer[r.meta.importer]||null;return n&&n.assetType||"cc.Asset";case"isBundle":return r.meta.userData&&r.meta.userData.isBundle;case"instantiation":a=asset_handler_manager_1.assetHandlerManager.name2handler[r.meta.importer]||r._assetDB.importerManager.name2importer[r.meta.importer]||null;return a?a.instantiation:void 0;case"library":return(0,utils_1.libArr2Obj)(r);case"displayName":return r.displayName;case"redirect":if(r.meta.userData&&r.meta.userData.redirect){n=this.queryAsset(r.meta.userData.redirect);if(n)return a=asset_handler_manager_1.assetHandlerManager.name2handler[n.meta.importer]||null,{uuid:n.uuid,type:a&&a.assetType||"cc.Asset"}}return;case"extends":n=this.queryAssetProperty(r,"type");return(0,utils_1.getExtendsFromCCType)(n);case"visible":{let e=r._assetDB.options.visible;return!1!==(e=e&&!1===r.userData.visible?!1:e)}case"mtime":a=r._assetDB.infoManager.get(r.source);return a?a.time:null;case"meta":return r.meta;case"depends":return Array.from(r.getData("depends")||[]);case"dependeds":{const i=[];return(0,asset_db_1.forEach)(e=>{var s=e.dataManager.dataMap;for(const a in s){var t=s[a];t.value&&t.value.depends&&t.value.depends.includes(r.uuid)&&i.push(a)}}),i}case"dependScripts":n=r._assetDB.dataManager.dataMap[r.uuid];return Array.from(n&&n.value&&n.value.dependScripts||[]);case"dependedScripts":{const o=[];return(0,asset_db_1.forEach)(e=>{var s=e.dataManager.dataMap;for(const a in s){var t=s[a];t.value&&t.value.dependScripts&&t.value.dependScripts.includes(r.uuid)&&o.push(a)}}),o}}}queryAssetMeta(e){if(!e||"string"!=typeof e)return null;if(e.startsWith("db://")){var s=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return{files:[],imported:!0,importer:"database",subMetas:{},userData:{},uuid:e,ver:"1.0.0"};e=(0,utils_1.url2uuid)(e)}s=(0,asset_db_1.queryAsset)(e);return s?s.meta:null}queryAssetMtime(e){if(e&&"string"==typeof e)for(const a in asset_db_manager_1.assetDBManager.assetDBMap)if(a in asset_db_manager_1.assetDBManager.assetDBMap){var s=asset_db_manager_1.assetDBManager.assetDBMap[a];if(s){var t=s.getAsset(e);if(t)return(s=s.infoManager.get(t.source))?s.time:null}}return null}queryAssetUUID(e){if(!e||"string"!=typeof e)return null;if(e.startsWith("db://")){var s=e.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return"db://"+s;s=(0,utils_1.url2uuid)(e);if(s)return s}try{return(0,asset_db_1.queryUUID)(e)}catch(e){return null}}queryDBAssetInfo(e){var s=asset_db_manager_1.assetDBManager.assetDBInfo[e];return s?{name:e,displayName:e||"",source:"db://"+e,path:"db://"+e,url:"db://"+e,file:s.target,uuid:"db://"+e,importer:"database",imported:!0,invalid:!1,type:"database",isDirectory:!1,library:{},subAssets:{},visible:s.visible,instantiation:void 0,readonly:s.readonly}:null}queryUrl(e){var s;if(e&&"string"==typeof e)return s=e.substr(Editor.Project.path.length+1),asset_db_manager_1.assetDBManager.assetDBMap[s]?"db://"+s:(0,asset_db_1.queryUrl)(e);throw new Error("parameter error")}checkValidUrl(e){if(!e.startsWith("db://")&&!(e=this.queryUrl(e)))throw new Error(Editor.I18n.t("asset-db.operation.invalid_url")+` 
  url: `+e);var s=e.split("/").filter(Boolean)[1];if(asset_db_manager_1.assetDBManager.assetDBInfo[s].readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e);return!0}async createAsset(e){if(!e.target||"string"!=typeof e.target)throw new Error("Cannot create asset because options.target is required.");this.checkValidUrl(e.target),(0,path_1.isAbsolute)(e.target)||(e.target=(0,utils_1.url2path)(e.target));e=await asset_handler_manager_1.assetHandlerManager.createAsset(e);if(!e||!e.length)return null;let s=[];s="string"==typeof e?[e]:e;e=await Promise.all(s.map(async e=>(await this.refreshAsset(e),this.queryAssetInfo((0,asset_db_1.queryUUID)(e)))));return 1===e.length?e[0]:e}async createAssetDialog(e){e=await asset_handler_manager_1.assetHandlerManager.createAssetDialog(e);if(!e||!e.length)return null;let s=[];s="string"==typeof e?[e]:e;e=await Promise.all(s.map(async e=>(await this.refreshAsset(e),this.queryAssetInfo((0,asset_db_1.queryUUID)(e)))));return 1===e.length?e[0]:e}async generateExportData(e,s){var t=e.getData("output");if(!t||s){var a=await asset_handler_manager_1.assetHandlerManager.generateExportData(e,s);if(a)return a;if(!e.meta.files.includes(".json")&&!e.meta.files.includes(".cconb"))return null;t=(0,utils_1.ensureOutputData)(e),s&&t.native&&((a=asset_cache_1.assetOutputPathCache.query(e.uuid,s))?t.import.path=a:(a=await(0,utils_1.serializeCompiled)(e,s),await(0,fs_extra_1.outputFile)(t.import.path,a),await asset_cache_1.assetOutputPathCache.add(e,s,t.import.path)),e.setData("output",t))}return t}async outputExportData(e,s,t){e=await asset_handler_manager_1.assetHandlerManager.outputExportData(e,s,t);if(!e&&(await(0,fs_extra_1.copy)(s.import.path,t.import.path),s.native)&&t.native){e=Object.values(s.native);const a=Object.values(t.native);await Promise.all(e.map((e,s)=>(0,fs_extra_1.copy)(e,a[s])))}}async refreshAsset(e){return asset_db_manager_1.assetDBManager.addTask(this._refreshAsset.bind(this),[e])}async _refreshAsset(e,s=!0){console.debug(`start refresh asset from ${e}...`);var t=await(0,asset_db_1.refresh)(e);return s&&asset_db_manager_1.assetDBManager.addTask(asset_db_manager_1.assetDBManager.autoRefreshAssetLazy.bind(asset_db_manager_1.assetDBManager),[(0,path_1.dirname)(e)]),console.debug(`refresh asset ${(0,path_1.dirname)(e)} success`),t}async reimportAsset(e){return asset_db_manager_1.assetDBManager.addTask(this._reimportAsset.bind(this),[e])}async _reimportAsset(e){e.startsWith("db://")&&(e=(0,utils_1.url2uuid)(e)),Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+e),await(0,asset_db_1.reimport)(e),Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+e,{output:!0})}async moveAsset(e,s,t){return asset_db_manager_1.assetDBManager.addTask(this._moveAsset.bind(this),[e,s,t])}async _moveAsset(e,s,t){console.debug(`start move asset from ${e} -> ${s}...`);(0,fs_extra_1.existsSync)(s)&&t?.overwrite&&await this._removeAsset(s),await(0,utils_1.moveFile)(e,s,t);var t=(0,asset_db_1.queryUrl)(s),a=/db:\/\/[^/]+/.exec(t);a&&a[0]&&t.startsWith(a[0])?(await this.refreshAsset(s),await this.refreshAsset((0,path_1.dirname)(e))):(await this.refreshAsset(e),await this.refreshAsset(s)),console.debug(`move asset from ${e} -> ${s} success`)}async renameAsset(e,s,t){return asset_db_manager_1.assetDBManager.addTask(this._renameAsset.bind(this),[e,s,t])}async _renameAsset(e,s,t){console.debug(`start rename asset from ${e} -> ${s}...`);var a={basename:(0,path_1.basename)(s),dirname:(0,path_1.dirname)(s)},a=(0,path_1.join)(a.dirname,".rename_temp");await(0,fs_extra_1.rename)(e+".meta",a+".meta"),await(0,fs_extra_1.rename)(e,a),await this._refreshAsset(e,!1),await(0,fs_extra_1.rename)(a+".meta",s+".meta"),await(0,fs_extra_1.rename)(a,s),await this._refreshAsset(s),console.debug(`rename asset from ${e} -> ${s} success`)}async removeAsset(e){var s=this.queryAsset(e);if(!s)throw new Error(Editor.I18n.t("asset-db.deleteAsset.fail.unexist")+` 
source: `+e);if(s._assetDB.options.readonly)throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+s.url);e=s.source;return await asset_db_manager_1.assetDBManager.addTask(this._removeAsset.bind(this),[e])?this.encodeAsset(s):null}async _removeAsset(e){console.debug(`start remove asset ${e}...`);let s=!1;try{await(0,utils_1.removeFile)(e),await this.refreshAsset(e),s=!0,console.debug(`remove asset ${e} success`)}catch(e){console.warn(""+Editor.I18n.t("asset-db.deleteAsset.fail.unknown")),console.warn(e)}return s}url2uuid(e){return(0,utils_1.url2uuid)(e)}url2path(e){return(0,utils_1.url2path)(e)}path2url(e,s){return asset_db_manager_1.assetDBManager.path2url(e,s)}init(){asset_db_manager_1.assetDBManager.on("db-created",this._onAssetDBCreated),asset_db_manager_1.assetDBManager.on("db-started",this._onAssetDBStarted),asset_db_manager_1.assetDBManager.on("db-removed",this._onAssetDBRemoved)}destroyed(){asset_db_manager_1.assetDBManager.removeListener("db-created",this._onAssetDBCreated),asset_db_manager_1.assetDBManager.removeListener("db-started",this._onAssetDBStarted),asset_db_manager_1.assetDBManager.removeListener("db-removed",this._onAssetDBRemoved)}_onAssetDBCreated(e){e.on("unresponsive",onUnResponsive),e.on("added",exports.assetManager._onAssetAdded),e.on("changed",exports.assetManager._onAssetChanged),e.on("deleted",exports.assetManager._onAssetDeleted),e.on("add",mask_sync_1.assetAdd),e.on("delete",mask_sync_1.assetChange),e.on("change",mask_sync_1.assetDeleted)}_onAssetDBStarted(e){e.removeListener("add",mask_sync_1.assetAdd),e.removeListener("change",mask_sync_1.assetChange),e.removeListener("delete",mask_sync_1.assetDeleted)}_onAssetDBRemoved(e){e.removeListener("unresponsive",onUnResponsive),e.removeListener("added",exports.assetManager._onAssetAdded),e.removeListener("changed",exports.assetManager._onAssetChanged),e.removeListener("deleted",exports.assetManager._onAssetDeleted)}async _onAssetAdded(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-add",e),Editor.Message.broadcast("asset-db:asset-add",e.uuid,await exports.assetManager.encodeAsset(e),e.meta)):(0,mask_sync_1.assetAdded)(e)}async _onAssetChanged(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-change",e),Editor.Message.broadcast("asset-db:asset-change",e.uuid,await exports.assetManager.encodeAsset(e),e.meta)):(0,mask_sync_1.assetChanged)(e)}async _onAssetDeleted(e){asset_db_manager_1.assetDBManager.ready?(this.emit("asset-delete",e),Editor.Message.broadcast("asset-db:asset-delete",e.uuid,await exports.assetManager.encodeAsset(e,void 0,!0),e.meta)):(0,mask_sync_1.assetDeleted)(e)}}async function onUnResponsive(e,s){asset_db_manager_1.assetDBManager.ready?1===(await Editor.Dialog.info(`Resource import Timeout.
  uuid: ${e.uuid}
  url: `+e.url,{buttons:["Waiting","Interrupt"]})).response&&s.reject("User interrupt"):console.debug("import asset unresponsive")}function mergeMeta(s,t){Object.keys(t).map(e=>{"subMetas"===e?(Object.keys(t.subMetas).forEach(e=>{s.subMetas[e]||(s.subMetas[e]={}),mergeMeta(s.subMetas[e],t.subMetas[e])}),s.subMetas&&Object.keys(s.subMetas).forEach(e=>{e in t.subMetas||delete s.subMetas[e]})):s[e]=t[e]})}exports.AssetManager=AssetManager,exports.assetManager=new AssetManager;const TYPES={scripts:[".js",".ts"],scene:[".scene"],effect:[".effect"],image:[".jpg",".png",".jpeg",".webp",".tga"]};function searchAssets(s={},e,t=[]){if(s.pattern&&"string"==typeof s.pattern&&(e=e.filter(e=>(0,minimatch_1.default)(e.url,s.pattern))),"boolean"==typeof s.isBundle)return e=e.filter(e=>exports.assetManager.queryAssetProperty(e,"isBundle")===s.isBundle);var a=s.type;if(a&&"string"==typeof a){console.warn(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"options.type",newName:"options.ccType",version:"3.8.0"}));const r=TYPES[a];r&&(e=e.filter(e=>!(!r.includes((0,path_1.extname)(e.source))||/\.d\.ts$/.test(e.source))))}if(void 0!==s.extname&&("string"==typeof s.extname&&(s.extname=[s.extname.trim()]),Array.isArray(s.extname))){const n=s.extname.map(e=>e.toLowerCase());e=e.filter(e=>{var s=(0,path_1.extname)(e.source).toLowerCase();return!(!n.includes(s)||/\.d\.ts$/.test(e.source))})}return["ccType","importer","userData","pattern"].some(e=>void 0!==s[e])&&("string"==typeof s.ccType&&(s.ccType=[s.ccType.trim()]),"string"==typeof s.importer&&(s.importer=[s.importer.trim()]),e.forEach(e=>{e.subAssets&&0<Object.keys(e.subAssets).length&&searchAssets({ccType:s.ccType,importer:s.importer,pattern:s.pattern,userData:s.userData},Object.values(e.subAssets),t),Array.isArray(s.ccType)&&!s.ccType.includes(exports.assetManager.queryAssetProperty(e,"type"))||Array.isArray(s.importer)&&!s.importer.includes(e.meta.importer)||s.pattern&&!(0,minimatch_1.default)(e.url,s.pattern)||s.userData&&!filterUserDataInfo(s.userData,e)||t.push(e)}),e=t),e}function filterUserDataInfo(s,t){return Object.keys(s).every(e=>s[e]===t.meta.userData[e])}