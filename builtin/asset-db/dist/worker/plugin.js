"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),asset_db_1=require("@editor/asset-db"),events_1=__importDefault(require("events")),console_1=require("./console"),Profile=require("@base/electron-profile"),_profile=Profile.load("local://editor/packages.json"),_profileDefault=Profile.load("defaultPreferences://editor/packages.json");class PluginManager extends events_1.default{constructor(){super(...arguments),this.packageRegisterInfo={},this.hookMap={},this.assetDBProfileMap={},this._tasks=[],this._currentTask=null,this.pkgLock={}}async init(){Editor.Metrics.trackTimeStart("asset-db:worker-init: initPlugin"),console_1.newConsole.trackMemoryStart("asset-db:worker-init: initPlugin");const e=Editor.Package.getPackages({});await Promise.all(e.map(async e=>{await this.onPackageRegister(e),e.enable&&await this.onPackageEnable(e)})),Editor.Package.__protected__.on("register",registerAttach),Editor.Package.__protected__.on("unregister",unregisterDetach),Editor.Package.__protected__.on("enable",enableAttach),Editor.Package.__protected__.on("disable",disableDetach),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: initPlugin"),Editor.Metrics.trackTimeEnd("asset-db:worker-init: initPlugin",{output:!0})}async destroyed(){Editor.Package.__protected__.removeListener("register",registerAttach),Editor.Package.__protected__.removeListener("unregister",unregisterDetach),Editor.Package.__protected__.removeListener("enable",enableAttach),Editor.Package.__protected__.removeListener("disable",disableDetach)}addTask(e,t,a,...o){this._tasks.push({type:e,pkgName:t,handler:a,args:o}),this.step()}async onPackageRegister(e){if(_profile.get(`disable-packages.${e.path}`))return;if(_profileDefault.get(`disable-packages.${e.path}`))return;if(!e.info.contributions||!e.info.contributions["asset-db"])return;const t=e.info.contributions["asset-db"],a=this.packageRegisterInfo[e.name]||{name:e.name};if(console_1.newConsole.trackMemoryStart(`asset-db-plugin-register: ${e.name}`),t.importer&&t.importer.script){if(!t.importer.list)return;const o=(0,path_1.join)(e.path,t.importer.script);try{const n=Editor.Module.__protected__.requireFile(o);"function"==typeof n.load&&await n.load(),a.assetHandlerInfo={script:o,list:t.importer.list}}catch(t){console.warn(`Failed to register the importer from ${e.name}: ${o}`),console.warn(t)}}if(t.hook){const o=(0,path_1.join)(e.path,t.hook);try{const t=Editor.Module.__protected__.requireFile(o);"function"==typeof t.load&&await t.load(),a.hook=o,this.hookMap[e.name]=o}catch(t){console.warn(t),console.warn(`Failed to register hook from ${e.name}: ${o}`)}}t.script&&(a.script=(0,path_1.join)(e.path,t.script)),t.mount&&(a.mount=Object.assign(Object.assign({},t.mount),{path:t.mount.path?(0,path_1.join)(e.path,t.mount.path):t.mount.path}),t.mount.enable&&(this.assetDBProfileMap[`packages/${e.name}.json(${t.mount.enable})`]=e.name)),console_1.newConsole.trackMemoryEnd(`asset-db-plugin-register: ${e.name}`),this.emit("register",e.name,a),this.packageRegisterInfo[e.name]=a}async onPackageUnregister(e){const t=this.packageRegisterInfo[e.name];if(t){if(t.hook)try{const a=Editor.Module.__protected__.requireFile(t.hook);a.unload&&a.unload(),delete this.hookMap[e.name]}catch(e){console.warn(e)}if(t.assetHandlerInfo)try{const e=Editor.Module.__protected__.requireFile(t.assetHandlerInfo.script);e.unload&&e.unload()}catch(e){console.warn(e)}this.emit("unregister",e.name,t),delete this.packageRegisterInfo[e.name]}}async onPackageEnable(e){if(e.invalid)return;const t=this.packageRegisterInfo[e.name];if(t){if(console_1.newConsole.trackMemoryStart(`asset-db-plugin-enable: ${e.name}`),t.script)try{const a=Editor.Module.__protected__.requireFile(t.script);"function"==typeof a.load&&await a.load()}catch(a){delete t.script,console.warn(`Description Failed to register the Asset-DB script from ${e.name}: ${t.script}.`),console.warn(a)}console_1.newConsole.trackMemoryEnd(`asset-db-plugin-enable: ${e.name}`),this.emit("enable",e.name,t)}}async onPackageDisable(e){const t=this.packageRegisterInfo[e.name];if(t){if(t.script)try{const e=Editor.Module.__protected__.requireFile(t.script);e.unload&&e.unload()}catch(e){console.warn("Description Failed to register the Asset-DB script."),console.warn(e)}this.emit("disable",e.name,t)}}async step(){if(!this._tasks.length)return;const e=this._tasks.findIndex(e=>!this.pkgLock[e.pkgName]);if(-1===e)return;const t=this._tasks[e];this.pkgLock[t.pkgName]=!0,this._tasks.splice(e,1);const a=`run package(${t.pkgName}) handler(${t.type})`;try{console.debug(a+" start"),await t.handler.call(this,...t.args),console.debug(a+" success!")}catch(e){console.error(e),console.error(a+" failed!")}this.pkgLock[t.pkgName]=!1,await this.step()}async queryAssetDBInfos(){const e=[];for(const t of Object.keys(this.packageRegisterInfo)){const a=await this.queryAssetDBInfo(t);a&&e.push(a)}return e}async queryAssetDBInfo(e){const t=this.packageRegisterInfo[e];if(!t||!t.mount)return null;if(t.mount.enable){if(!(await Editor.Profile.getProject(t.name,t.mount.enable)||await Editor.Profile.getConfig(t.name,t.mount.enable)))return null}return{name:e,readonly:!!t.mount.readonly,visible:!1!==t.mount.visible,target:t.mount.path}}getAssetDBInfo(e){const t=this.packageRegisterInfo[e];return t&&t.mount?{name:e,readonly:!!t.mount.readonly,visible:!1!==t.mount.visible,target:t.mount.path}:null}async executeScript(e){if(!this.packageRegisterInfo[e.name]){const t=(await Editor.Package.getPackages({name:e.name}))[0];t&&await enableAttach(t)}const t=this.packageRegisterInfo[e.name];if(!t||!t.script)throw"Asset database scripts do not exist: "+e.name+"/"+e.method;const a=Editor.Module.__protected__.requireFile(t.script);if(a.methods&&a.methods[e.method])return await a.methods[e.method](...e.args||[]);throw"Asset database scripts do not exist: "+e.name+"/"+e.method}async runHook(e,t=[]){const a=Object.keys(this.hookMap);for(const o of a){const a=this.hookMap[o];try{const n=Editor.Module.__protected__.requireFile(a);n[e]&&(Editor.Metrics.trackTimeStart(`asset-db-hook-${o}-${e}`),console.debug(`Run asset db hook ${o}:${e} ...`),await n[e](...t),console.debug(`Run asset db hook ${o}:${e} success!`),Editor.Metrics.trackTimeEnd(`asset-db-hook-${o}-${e}`,{output:!0}))}catch(t){console.error(t),console.error(`Run asset-db hook ${o}:${e} failed!`)}}}async registerImporterList(e){for(const t in pluginManager.packageRegisterInfo){const a=pluginManager.packageRegisterInfo[t];if(a.assetHandlerInfo){const t=Editor.Module.__protected__.requireFile(a.assetHandlerInfo.script);for(const o of a.assetHandlerInfo.list)if(t.methods&&t.methods[o])try{const a=await t.methods[o]();e.importerManager.add(a.importer,a.extname)}catch(t){console.warn(`Failed to register importer. Data is not compliant: ${e.options.name} ${o}`),console.warn(t)}else console.warn(`Failed to register importer. Data is not compliant: ${e.options.name} ${o}`)}}}queryAllImporter(){const e=(0,asset_db_1.get)("internal");return Object.keys(e.importerManager.name2importer).sort()}queryAllAssetTypes(){const e=(0,asset_db_1.get)("internal").importerManager.name2importer,t=[];for(const a in e){const{assetType:o}=e[a];o&&!t.includes(o)&&t.push(o)}return t.sort()}}const registerAttach=async function(e){pluginManager.addTask("register",e.name,pluginManager.onPackageRegister,e)},enableAttach=async function(e){pluginManager.addTask("enable",e.name,pluginManager.onPackageEnable,e)},unregisterDetach=function(e){pluginManager.addTask("unregister",e.name,pluginManager.onPackageUnregister,e)},disableDetach=async function(e){pluginManager.addTask("disable",e.name,pluginManager.onPackageDisable,e)},pluginManager=new PluginManager;exports.default=pluginManager;