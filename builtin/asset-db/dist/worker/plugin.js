"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),asset_db_1=require("@editor/asset-db"),ScriptModuleMap={},ImporterMap={};class PluginManager{init(){Editor.Package.getPackages({}).forEach(t=>{registerAttach(t),t.enable&&enableAttach(t)}),Editor.Package.on("register",registerAttach),Editor.Package.on("unregister",unregisterDetach),Editor.Package.on("enable",enableAttach),Editor.Package.on("disable",disableDetach)}async executeScript(t){if(!ScriptModuleMap[t.name])throw"Asset database scripts do not exist: "+t.name;if(ScriptModuleMap[t.name].methods&&ScriptModuleMap[t.name].methods[t.method])return await ScriptModuleMap[t.name].methods[t.method](...t.args||[])}async registerImporterList(t){for(const e in ImporterMap){const r=ImporterMap[e];r.script&&r.list.forEach(e=>{if(r.script.methods&&r.script.methods[e])try{const o=r.script.methods[e]();t.importerManager.add(o.importer,o.extname)}catch(r){console.warn(`Failed to register importer. Data is not compliant: ${t.options.name} ${e}`),console.warn(r)}else console.warn(`Failed to register importer. Data is not compliant: ${t.options.name} ${e}`)})}}queryAllImporter(){const t=asset_db_1.get("internal");return Object.keys(t.importerManager.name2importer).sort()}queryAllAssetTypes(){const t=asset_db_1.get("internal").importerManager.name2importer,e=[];for(const r in t){const{assetType:o}=t[r];o&&!e.includes(o)&&e.push(o)}return e.sort()}}const registerAttach=function(t){if(t.invalid)return;if(!t.info.contributions||!t.info.contributions["asset-db"])return;const e=t.info.contributions["asset-db"];if(e.importer){const r={priority:[],list:[]};if(e.importer.script)try{r.script=Editor.Module.requireFile(path_1.join(t.path,e.importer.script)),r.script.load()}catch(t){console.warn("Failed to register the importer."),console.warn(t)}r.priority=e.importer.priority,r.list=e.importer.list,ImporterMap[t.name]=r}},enableAttach=function(t){if(t.invalid)return;if(!t.info.contributions||!t.info.contributions["asset-db"])return;const e=t.info.contributions["asset-db"];if(t.enable&&e.script&&!ScriptModuleMap[t.name])try{const r=require(path_1.join(t.path,e.script));r.load&&r.load(),ScriptModuleMap[t.name]=r}catch(t){console.warn("Description Failed to register the Asset-DB script."),console.warn(t)}},unregisterDetach=function(t){var e;ImporterMap[t.name]&&(ImporterMap[t.name].script&&(null===(e=ImporterMap[t.name].script)||void 0===e||e.unload()),delete ImporterMap[t.name])},disableDetach=function(t){const e=t.info.contributions["asset-db"];if(ScriptModuleMap[t.name]){const r=ScriptModuleMap[t.name];delete ScriptModuleMap[t.name],r.unload&&r.unload(),Editor.Module.removeCache(path_1.join(t.path,e.script))}};exports.default=new PluginManager;