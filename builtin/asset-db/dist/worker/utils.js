"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveAssetMeta=exports.moveFile=exports.removeFile=exports.decidePromiseState=exports.PROMISE_STATE=exports.tranAssetInfo=exports.queryAssetProperty=exports.encodeAsset=exports.queryAsset=exports.libArr2Obj=exports.url2uuid=exports.queryAssetDependeds=exports.queryAssetDependencies=exports.getMemorySize=exports.path2url=void 0;const asset_db_1=require("@editor/asset-db"),path_1=require("path"),fs_extra_1=require("fs-extra"),asset_db_manager_1=require("./asset-db-manager"),query_1=require("./messages/query");function path2url(e,t){if(e===`db://${t}`)return e;const s=asset_db_manager_1.assetDBManager.assetDBMap[t];let r=(0,path_1.relative)(s.options.target,e);return`db://${t}/${r=r.replace(/\\/g,"/")}`}function getMemorySize(){const e=process.memoryUsage();function t(e){return(e/1024/1024).toFixed(2)+"MB"}return"Process: heapTotal "+t(e.heapTotal)+" heapUsed "+t(e.heapUsed)+" rss "+t(e.rss)}async function queryAssetDependencies(e,t="asset"){const s=queryAsset(e);if(!s||!s.asset)return[];let r=[];if(["asset","all"].includes(t)&&(r=queryAssetProperty(s.asset,"depends")),["script","all"].includes(t)){if("cc.Script"===queryAssetProperty(s.asset,"type")){const e=await Editor.Message.request("programming","packer-driver/query-script-deps",s.asset.url);r.push(...e.map(e=>url2uuid(e)))}else r.push(...queryAssetProperty(s.asset,"dependScripts"))}return r}async function queryAssetDependeds(e,t="asset"){const s=queryAsset(e);if(!s||!s.asset)return[];const r=queryAssetProperty(s.asset,"type");let a=[];if(["asset","all"].includes(t)&&(a=queryAssetProperty(s.asset,"cc.Script"===r?"dependedScripts":"dependeds")),["script","all"].includes(t)&&"cc.Script"===r){const e=await(0,query_1.queryAssets)({ccType:"cc.Script"});await Promise.all(e.map(async e=>{(await Editor.Message.request("programming","packer-driver/query-script-deps",e.url)).includes(s.asset.url)&&a.push(url2uuid(e.url))}))}return a}function url2uuid(e){const t=[];let s=e,r="";for(;!(r=(0,asset_db_1.queryUUID)(s))&&"db:/"!==s;)s=s.replace(/\/([^/]*)$/,(e,s)=>(t.splice(0,0,asset_db_1.Utils.nameToId(s)),""));if(r){const e=(0,asset_db_1.queryAsset)(s);!e||e.isDirectory()&&t.length>0?s="":(s=e.uuid,t.length>0&&(s+="@"+t.join("@")))}else s="";return s}exports.path2url=path2url,exports.getMemorySize=getMemorySize,exports.queryAssetDependencies=queryAssetDependencies,exports.queryAssetDependeds=queryAssetDependeds,exports.url2uuid=url2uuid;const extnameRex=/^\./;function isExtname(e){return""===e||extnameRex.test(e)}function libArr2Obj(e){const t={};for(const s of e.meta.files)isExtname(s)?t[s]=e.library+s:t[s]=(0,path_1.resolve)(e.library,s);return t}function queryAsset(e){for(const t in asset_db_manager_1.assetDBManager.assetDBMap){const s=asset_db_manager_1.assetDBManager.assetDBMap[t];if(!s)continue;if(e===`db://${t}`)return{name:t,asset:{displayName:"",basename:t,extname:"",imported:!0,source:`db://${t}`,subAssets:{},library:"",parent:null,userData:{},isDirectory:()=>!1,uuid:`db://${t}`,meta:{ver:"1.0.0",uuid:`db://${t}`,name:t,id:t,subMetas:{},userData:{},importer:"database",imported:!0,files:[],displayName:""}}};const r=s.getAsset(e||"");if(r)return{name:t,asset:r}}return null}function encodeAsset(e,t,s=["displayName","subAssets","redirect","visible","extends"]){const r=e.importerManager.name2importer[t.meta.importer]||null;let a="",i="",n="";t.uuid===t.source||t instanceof asset_db_1.Asset&&t.source?(a=(0,path_1.basename)(t.source),i=path2url(t.source,e.options.name),n=t.source):a=t._name;let o=a,u=a;if(t.uuid===t.source||t instanceof asset_db_1.Asset)u=o=i;else{let s=t.parent;for(;s&&!(s instanceof asset_db_1.Asset);)o=`${s._name}/${a}`,s=s.parent;if(s instanceof asset_db_1.Asset){const t=(0,path_1.extname)(s._source),r=path2url(s._source,e.options.name);u=r+"/"+o,o=r.substr(0,r.length-t.length)+"/"+o}}const c=t.isDirectory();c||(o=o.replace(/\.[^./]+$/,""));const p=r&&r.assetType||"cc.Asset",d={name:a,displayName:t.displayName,source:i,path:o,url:u,file:n,uuid:t.uuid,importer:t.meta.importer,imported:t.meta.imported,invalid:t.invalid,type:p,isDirectory:c,instantiation:r?r.instantiation:void 0,readonly:e.options.readonly,library:libArr2Obj(t)};if(s.forEach(e=>{var s;d[e]=null!==(s=queryAssetProperty(t,e))&&void 0!==s?s:d[e]}),s.includes("fatherInfo")&&t.parent&&(d.fatherInfo={source:t.parent.source,library:libArr2Obj(t.parent),uuid:t.parent.uuid}),s.includes("subAssets")){d.subAssets={};for(const r in t.subAssets){if(!(r in t.subAssets))continue;const a=encodeAsset(e,t.subAssets[r],s);d.subAssets[r]=a}}return d}function queryAssetProperty(e,t){switch(t){case"type":{const t=e._assetDB.importerManager.name2importer[e.meta.importer]||null;return t&&t.assetType||"cc.Asset"}case"library":return libArr2Obj(e);case"displayName":return e.displayName;case"redirect":if(e.meta.userData&&e.meta.userData.redirect){const t=queryAsset(e.meta.userData.redirect);if(t){const s=e._assetDB.importerManager.name2importer[t.asset.meta.importer]||null;return{uuid:t.asset.uuid,type:s&&s.assetType||"cc.Asset"}}}return;case"extends":{const t=e._assetDB.importerManager.name2importer[e.meta.importer]||null,s=t&&t.assetType||"cc.Asset";try{return getExtendsFromCCType(s)}catch(e){return["cc.Asset"]}}case"visible":{let t=e._assetDB.options.visible;return t&&!1===e.userData.visible&&(t=!1),t}case"mtime":{const t=e._assetDB.infoManager.get(e.source);return t?t.time:null}case"meta":return e.meta;case"depends":{const t=e._assetDB.dataManager.dataMap[e.uuid];return Array.from(t&&t.value&&t.value.depends||[])}case"dependeds":{const t=e._assetDB.dataManager.dataMap,s=[];for(const r in t){const a=t[r];a.value&&a.value.depends&&a.value.depends.includes(e.uuid)&&s.push(r)}return s}case"dependScripts":{const t=e._assetDB.dataManager.dataMap[e.uuid];return Array.from(t&&t.value&&t.value.dependScripts||[])}case"dependedScripts":{const t=e._assetDB.dataManager.dataMap,s=[];for(const r in t){const a=t[r];a.value&&a.value.dependScripts&&a.value.dependScripts.includes(e.uuid)&&s.push(r)}return s}}}function getExtendsFromCCType(e){if(!e||"cc.Asset"===e)return[];let t=cc.js.getSuper(cc.js.getClassByName(e));const s=[];let r=cc.js.getClassName(t);for(;r&&"cc.Asset"!==s[s.length-1];)s.push(r),t=cc.js.getSuper(t),r=cc.js.getClassName(t);return s}function tranAssetInfo(e){return{file:e.source,uuid:e.uuid,library:libArr2Obj(e),importer:e.meta.importer}}function decidePromiseState(e){const t={name:"test"};return Promise.race([e,t]).then(e=>e===t?exports.PROMISE_STATE.PENDING:exports.PROMISE_STATE.FULFILLED).catch(()=>exports.PROMISE_STATE.REJECTED)}async function removeFile(e){if((0,fs_extra_1.existsSync)(e)){try{await Editor.Utils.File.trashItem(e)}catch(t){console.error(`asset db removeFile ${e} fail!`),console.error(t)}try{const t=e+".meta";(0,fs_extra_1.existsSync)(t)&&await Editor.Utils.File.trashItem(t)}catch(e){}}}async function moveFile(e,t,s){if(!(0,fs_extra_1.existsSync)(e)||!(0,fs_extra_1.existsSync)(e+".meta"))return;if(!s){if((0,fs_extra_1.existsSync)(t)||(0,fs_extra_1.existsSync)(t+".meta"))return;s={overwrite:!1}}const r=(0,path_1.join)(Editor.Project.tmpDir,"asset-db","move-temp"),a=(0,path_1.relative)(Editor.Project.path,t);try{if(!Editor.Utils.Path.contains(e,t))return await(0,fs_extra_1.move)(e+".meta",t+".meta",{overwrite:!0}),void await(0,fs_extra_1.move)(e,t,s);await(0,fs_extra_1.remove)((0,path_1.join)(r,a)),await(0,fs_extra_1.remove)((0,path_1.join)(r,a)+".meta"),await(0,fs_extra_1.move)(e+".meta",(0,path_1.join)(r,a)+".meta",{overwrite:!0}),await(0,fs_extra_1.move)(e,(0,path_1.join)(r,a),{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(r,a)+".meta",t+".meta",{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(r,a),t,s)}catch(s){console.error(`asset db moveFile from ${e} -> ${t} fail!`),console.error(s)}}async function saveAssetMeta(e,t,s){if("object"!=typeof t||Array.isArray(t))throw new Error(`Save meta failed(${e}): The meta must be an Object string`);mergeMeta((s=s||queryAsset(e)).asset.meta,t),await s.asset.save()}function mergeMeta(e,t){Object.keys(t).map(s=>{"subMetas"===s?(Object.keys(t.subMetas).forEach(s=>{e.subMetas[s]||(e.subMetas[s]={}),mergeMeta(e.subMetas[s],t.subMetas[s])}),e.subMetas&&Object.keys(e.subMetas).forEach(s=>{s in t.subMetas||delete e.subMetas[s]})):e[s]=t[s]})}exports.libArr2Obj=libArr2Obj,exports.queryAsset=queryAsset,exports.encodeAsset=encodeAsset,exports.queryAssetProperty=queryAssetProperty,exports.tranAssetInfo=tranAssetInfo,exports.PROMISE_STATE={PENDING:"pending",FULFILLED:"fulfilled",REJECTED:"rejected"},exports.decidePromiseState=decidePromiseState,exports.removeFile=removeFile,exports.moveFile=moveFile,exports.saveAssetMeta=saveAssetMeta;