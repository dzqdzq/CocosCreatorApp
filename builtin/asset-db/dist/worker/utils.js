"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.moveFile=exports.removeFile=exports.decidePromiseState=exports.PROMISE_STATE=exports.tranAssetInfo=exports.encodeAsset=exports.queryAsset=exports.libArr2Obj=exports.url2uuid=exports.getMemorySize=exports.path2url=void 0;const asset_db_1=require("@editor/asset-db"),path_1=require("path"),fs_extra_1=require("fs-extra");function path2url(e,t){if(e===`db://${t}`)return e;const s=Manager.AssetWorker[t];let r=(0,path_1.relative)(s.options.target,e);return`db://${t}/${r=r.replace(/\\/g,"/")}`}function getMemorySize(){const e=process.memoryUsage();function t(e){return(e/1024/1024).toFixed(2)+"MB"}return"Process: heapTotal "+t(e.heapTotal)+" heapUsed "+t(e.heapUsed)+" rss "+t(e.rss)}function url2uuid(e){const t=[];let s=e,r="";for(;!(r=(0,asset_db_1.queryUUID)(s))&&"db:/"!==s;)s=s.replace(/\/([^/]*)$/,(e,s)=>(t.splice(0,0,asset_db_1.Utils.nameToId(s)),""));if(r){const e=(0,asset_db_1.queryAsset)(s);!e||e.isDirectory()&&t.length>0?s="":(s=e.uuid,t.length>0&&(s+="@"+t.join("@")))}else s="";return s}exports.path2url=path2url,exports.getMemorySize=getMemorySize,exports.url2uuid=url2uuid;const extnameRex=/^\./;function isExtname(e){return""===e||extnameRex.test(e)}function libArr2Obj(e){const t={};for(const s of e.meta.files)isExtname(s)?t[s]=e.library+s:t[s]=(0,path_1.resolve)(e.library,s);return t}function queryAsset(e){for(const t in Manager.AssetWorker){if(!(t in Manager.AssetWorker))continue;const s=Manager.AssetWorker[t];if(!s)continue;if(e===`db://${t}`)return{name:t,asset:{displayName:"",basename:t,extname:"",imported:!0,source:`db://${t}`,subAssets:{},library:"",parent:null,userData:{},isDirectory:()=>!1,uuid:`db://${t}`,meta:{ver:"1.0.0",uuid:`db://${t}`,name:t,id:t,subMetas:{},userData:{},importer:"database",imported:!0,files:[],displayName:""}}};const r=s.getAsset(e||"");if(r)return{name:t,asset:r}}return null}function encodeAsset(e,t){const s=e.importerManager.name2importer[t.meta.importer]||null;let r,a="",o="",i="";if(t.uuid===t.source||t instanceof asset_db_1.Asset&&t.source?(a=(0,path_1.basename)(t.source),o=path2url(t.source,e.options.name),i=t.source):a=t._name,t.meta.userData&&t.meta.userData.redirect){const s=queryAsset(t.meta.userData.redirect);if(s){const t=e.importerManager.name2importer[s.asset.meta.importer]||null;r={uuid:s.asset.uuid,type:t&&t.assetType||"cc.Asset"}}}let n=a,u=a;if(t.uuid===t.source||t instanceof asset_db_1.Asset)u=n=o;else{let s=t.parent;for(;s&&!(s instanceof asset_db_1.Asset);)n=`${s._name}/${a}`,s=s.parent;if(s instanceof asset_db_1.Asset){const t=(0,path_1.extname)(s._source),r=path2url(s._source,e.options.name);u=r+"/"+n,n=r.substr(0,r.length-t.length)+"/"+n}}const c=t.isDirectory();c||(n=n.replace(/\.[^./]+$/,""));let m=e.options.visible;m&&!1===t.userData.visible&&(m=!1);const l={name:a,displayName:t.displayName,source:o,path:n,url:u,file:i,uuid:t.uuid,importer:t.meta.importer,imported:t.meta.imported,invalid:t.invalid,type:s&&s.assetType||"cc.Asset",extends:s?s.assetExtends:[],isDirectory:c,library:libArr2Obj(t),subAssets:{},visible:m,instantiation:s?s.instantiation:void 0,readonly:e.options.readonly,redirect:r};for(const s in t.subAssets){if(!(s in t.subAssets))continue;const r=encodeAsset(e,t.subAssets[s]);l.subAssets[s]=r}return l}function tranAssetInfo(e){return{file:e.source,uuid:e.uuid,library:libArr2Obj(e),importer:e.meta.importer}}function decidePromiseState(e){const t={name:"test"};return Promise.race([e,t]).then(e=>e===t?exports.PROMISE_STATE.PENDING:exports.PROMISE_STATE.FULFILLED).catch(()=>exports.PROMISE_STATE.REJECTED)}async function removeFile(e){if((0,fs_extra_1.existsSync)(e)){try{await Editor.Utils.File.trashItem(e)}catch(t){console.error(`asset db removeFile ${e} fail!`),console.error(t)}try{const t=e+".meta";(0,fs_extra_1.existsSync)(t)&&await Editor.Utils.File.trashItem(t)}catch(e){}}}async function moveFile(e,t,s){if(!(0,fs_extra_1.existsSync)(e)||!(0,fs_extra_1.existsSync)(e+".meta"))return;if(!s){if((0,fs_extra_1.existsSync)(t)||(0,fs_extra_1.existsSync)(t+".meta"))return;s={overwrite:!1}}const r=(0,path_1.join)(Editor.Project.tmpDir,"asset-db","move-temp"),a=(0,path_1.relative)(Editor.Project.path,t);try{if(!Editor.Utils.Path.contains(e,t))return await(0,fs_extra_1.move)(e+".meta",t+".meta",{overwrite:!0}),void await(0,fs_extra_1.move)(e,t,s);await(0,fs_extra_1.remove)((0,path_1.join)(r,a)),await(0,fs_extra_1.remove)((0,path_1.join)(r,a)+".meta"),await(0,fs_extra_1.move)(e+".meta",(0,path_1.join)(r,a)+".meta",{overwrite:!0}),await(0,fs_extra_1.move)(e,(0,path_1.join)(r,a),{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(r,a)+".meta",t+".meta",{overwrite:!0}),await(0,fs_extra_1.move)((0,path_1.join)(r,a),t,s)}catch(s){console.error(`asset db moveFile from ${e} -> ${t} fail!`),console.error(s)}}exports.libArr2Obj=libArr2Obj,exports.queryAsset=queryAsset,exports.encodeAsset=encodeAsset,exports.tranAssetInfo=tranAssetInfo,exports.PROMISE_STATE={PENDING:"pending",FULFILLED:"fulfilled",REJECTED:"rejected"},exports.decidePromiseState=decidePromiseState,exports.removeFile=removeFile,exports.moveFile=moveFile;