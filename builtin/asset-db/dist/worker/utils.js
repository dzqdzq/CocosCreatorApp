"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.tranAssetInfo=exports.encodeAsset=exports.queryAsset=exports.libArr2Obj=exports.url2uuid=exports.path2url=void 0;const asset_db_1=require("@editor/asset-db"),path_1=require("path");function path2url(e,t){if(e===`db://${t}`)return e;const s=Manager.AssetWorker[t];let r=(0,path_1.relative)(s.options.target,e);return`db://${t}/${r=r.replace(/\\/g,"/")}`}function url2uuid(e){const t=[];let s=e,r="";for(;!(r=(0,asset_db_1.queryUUID)(s))&&"db:/"!==s;)s=s.replace(/\/([^/]*)$/,(e,s)=>(t.splice(0,0,asset_db_1.Utils.nameToId(s)),""));if(r){const e=(0,asset_db_1.queryAsset)(s);!e||e.isDirectory()&&t.length>0?s="":(s=e.uuid,t.length>0&&(s+="@"+t.join("@")))}else s="";return s}exports.path2url=path2url,exports.url2uuid=url2uuid;const extnameRex=/^\./;function isExtname(e){return""===e||extnameRex.test(e)}function libArr2Obj(e){const t={};for(const s of e.meta.files)isExtname(s)?t[s]=e.library+s:t[s]=(0,path_1.resolve)(e.library,s);return t}function queryAsset(e){for(const t in Manager.AssetWorker){if(!(t in Manager.AssetWorker))continue;const s=Manager.AssetWorker[t];if(!s)continue;if(e===`db://${t}`)return{name:t,asset:{displayName:"",basename:t,extname:"",imported:!0,source:`db://${t}`,subAssets:{},library:"",parent:null,userData:{},isDirectory:()=>!1,uuid:`db://${t}`,meta:{ver:"1.0.0",uuid:`db://${t}`,name:t,id:t,subMetas:{},userData:{},importer:"database",imported:!0,files:[],displayName:""}}};const r=s.getAsset(e||"");if(r)return{name:t,asset:r}}return null}function encodeAsset(e,t){const s=e.importerManager.name2importer[t.meta.importer]||null;let r,n="",a="",i="";if(t.uuid===t.source||t instanceof asset_db_1.Asset&&t.source?(n=(0,path_1.basename)(t.source),a=path2url(t.source,e.options.name),i=t.source):n=t._name,t.meta.userData&&t.meta.userData.redirect){const s=queryAsset(t.meta.userData.redirect);if(s){const t=e.importerManager.name2importer[s.asset.meta.importer]||null;r={uuid:s.asset.uuid,type:t&&t.assetType||"cc.Asset"}}}let o=n,u=n;if(t.uuid===t.source||t instanceof asset_db_1.Asset)u=o=a;else{let s=t.parent;for(;s&&!(s instanceof asset_db_1.Asset);)o=`${s._name}/${n}`,s=s.parent;if(s instanceof asset_db_1.Asset){const t=(0,path_1.extname)(s._source),r=path2url(s._source,e.options.name);u=r+"/"+o,o=r.substr(0,r.length-t.length)+"/"+o}}const l=t.isDirectory();l||(o=o.replace(/\.[^./]+$/,""));let c=e.options.visible;c&&!1===t.userData.visible&&(c=!1);const p={name:n,displayName:t.displayName,source:a,path:o,url:u,file:i,uuid:t.uuid,importer:t.meta.importer,imported:t.meta.imported,invalid:t.invalid,type:s&&s.assetType||"cc.Asset",extends:s?s.assetExtends:[],isDirectory:l,library:libArr2Obj(t),subAssets:{},visible:c,instantiation:s?s.instantiation:void 0,readonly:e.options.readonly,redirect:r};for(const s in t.subAssets){if(!(s in t.subAssets))continue;const r=encodeAsset(e,t.subAssets[s]);p.subAssets[s]=r}return p}function tranAssetInfo(e){return{file:e.source,uuid:e.uuid,library:libArr2Obj(e),importer:e.meta.importer}}exports.libArr2Obj=libArr2Obj,exports.queryAsset=queryAsset,exports.encodeAsset=encodeAsset,exports.tranAssetInfo=tranAssetInfo;