"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ipc_1=require("../ipc"),utils_1=require("../utils"),asset_db_1=require("@editor/asset-db"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=__importDefault(require("../plugin"));function mergeMeta(e,r){Object.keys(r).map(t=>{"subMetas"===t?(Object.keys(r.subMetas).forEach(t=>{e.subMetas[t]||(e.subMetas[t]={}),mergeMeta(e.subMetas[t],r.subMetas[t])}),Object.keys(e.subMetas).forEach(t=>{t in r.subMetas||delete e.subMetas[t]})):e[t]=r[t]})}ipc_1.ipcAddListener("asset-worker:save-asset-meta",async(e,r,t)=>{if(!r||!t)return e.reply(new Error(Editor.I18n.t("asset-db.saveAssetMeta.fail.content")),!1);const s=utils_1.queryAsset(r);if(!s)return e.reply(null,!1);try{const a=JSON.parse(t);if("object"!=typeof a||Array.isArray(a))throw new Error(`Save meta failed(${r}): The meta must be an Object string`);return mergeMeta(s.asset.meta,a),await s.asset.save(),Manager.AssetWorker[s.name].reimport(s.asset.uuid),e.reply(null,!0)}catch(r){return console.warn(r),e.reply(r,!1)}}),ipc_1.ipcAddListener("asset-worker:reimport-asset",async(e,r)=>{const t=await asset_db_1.reimport(r);return e.reply(null,t)}),ipc_1.ipcAddListener("asset-worker:query-all-importer",async(e,r)=>{const t=plugin_1.default.queryAllImporter();return e.reply(null,t)}),ipc_1.ipcAddListener("asset-worker:query-all-asset-types",async(e,r)=>{const t=plugin_1.default.queryAllAssetTypes();return e.reply(null,t)});const refreshFiles=[];let autoRefreshTimer;function autoRefresh(e){refreshFiles.includes(e)||refreshFiles.push(e),clearTimeout(autoRefreshTimer),autoRefreshTimer=setTimeout(()=>{refreshFiles.forEach(asset_db_1.refresh),refreshFiles.length=0},100)}function refreshDefaultUserData(){try{const e=path_1.join(Editor.Project.path,".creator","default-meta.json");if(fs_extra_1.existsSync(e)){const r=fs_extra_1.readJSONSync(e);for(const e in r)asset_db_1.setDefaultUserData(e,r[e])}}catch(e){console.error(e)}}ipc_1.ipcAddListener("asset-worker:refresh-asset",async(e,r)=>{const t=await asset_db_1.refresh(r);return autoRefresh(path_1.dirname(r)),e.reply(null,t)}),ipc_1.ipcAddListener("asset-worker:execute-script",async(e,r)=>{const t=await plugin_1.default.executeScript(r);return e.reply(null,t)}),refreshDefaultUserData(),ipc_1.ipcAddListener("asset-worker:refresh-default-user-data",()=>{refreshDefaultUserData()});