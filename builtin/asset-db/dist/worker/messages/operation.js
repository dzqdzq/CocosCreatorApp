"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,a)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ipc_1=require("../ipc"),utils_1=require("../utils"),asset_db_1=require("@editor/asset-db"),plugin_1=__importDefault(require("../plugin")),asset_db_manager_1=require("../asset-db-manager");function mergeMeta(e,t){Object.keys(t).map(r=>{"subMetas"===r?(Object.keys(t.subMetas).forEach(r=>{e.subMetas[r]||(e.subMetas[r]={}),mergeMeta(e.subMetas[r],t.subMetas[r])}),e.subMetas&&Object.keys(e.subMetas).forEach(r=>{r in t.subMetas||delete e.subMetas[r]})):e[r]=t[r]})}(0,ipc_1.ipcAddListener)("asset-worker:save-asset-meta",async(e,t,r)=>{if(!t||!r)return e.reply(new Error(Editor.I18n.t("asset-db.saveAssetMeta.fail.content")),!1);const s=(0,utils_1.queryAsset)(t);if(!s)return e.reply(null,!1);try{const a=JSON.parse(r);if("object"!=typeof a||Array.isArray(a))throw new Error(`Save meta failed(${t}): The meta must be an Object string`);return mergeMeta(s.asset.meta,a),await s.asset.save(),asset_db_manager_1.assetDBManager.reimportAsset(s.asset.uuid),e.reply(null,!0)}catch(t){return console.warn(t),e.reply(t,!1)}}),(0,ipc_1.ipcAddListener)("asset-worker:reimport-asset",async(e,t)=>e.reply(null,await asset_db_manager_1.assetDBManager.reimportAsset(t))),(0,ipc_1.ipcAddListener)("asset-worker:query-all-importer",async(e,t)=>{const r=plugin_1.default.queryAllImporter();return e.reply(null,r)}),(0,ipc_1.ipcAddListener)("asset-worker:query-all-asset-types",async(e,t)=>{const r=plugin_1.default.queryAllAssetTypes();return e.reply(null,r)}),(0,ipc_1.ipcAddListener)("asset-worker:refresh-asset",async(e,t)=>e.reply(null,await asset_db_manager_1.assetDBManager.refreshAsset(t))),(0,ipc_1.ipcAddListener)("asset-worker:refresh-all-effect",async()=>{(0,asset_db_1.forEach)(e=>{e.path2asset.forEach(e=>{e&&"effect"===e.meta.importer&&e._assetDB.reimport(e.uuid)})})}),(0,ipc_1.ipcAddListener)("asset-worker:execute-script",async(e,t)=>{try{Editor.Metrics.trackTimeStart("programming:execute-script");const r=await plugin_1.default.executeScript(t);return Editor.Metrics.trackTimeEnd("programming:execute-script",{output:!0}),e.reply(null,r)}catch(t){return e.reply(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:change-high-quality",async(e,t)=>{try{const{settings:t}=await Promise.resolve().then(()=>__importStar(require("cc")));return t.overrideSettings("rendering","highQualityMode",!0),e.reply(null)}catch(t){return e.reply(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:refresh-default-user-data",e=>e.reply(null,asset_db_manager_1.assetDBManager.refreshDefaultUserData())),(0,ipc_1.ipcAddListener)("asset-worker:remove-asset",async(e,t)=>e.reply(null,await asset_db_manager_1.assetDBManager.removeAsset(t))),(0,ipc_1.ipcAddListener)("asset-worker:rename-asset",async(e,t,r)=>e.reply(null,await asset_db_manager_1.assetDBManager.renameAsset(t,r))),(0,ipc_1.ipcAddListener)("asset-worker:move-asset",async(e,t,r,s)=>e.reply(null,await asset_db_manager_1.assetDBManager.moveAsset(t,r,s)));