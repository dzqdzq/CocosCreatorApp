"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ipc_1=require("../ipc"),utils_1=require("../utils"),asset_db_1=require("@editor/asset-db"),path_1=require("path"),fs_extra_1=require("fs-extra"),plugin_1=__importDefault(require("../plugin"));function mergeMeta(e,t){Object.keys(t).map(r=>{"subMetas"===r?(Object.keys(t.subMetas).forEach(r=>{e.subMetas[r]||(e.subMetas[r]={}),mergeMeta(e.subMetas[r],t.subMetas[r])}),Object.keys(e.subMetas).forEach(r=>{r in t.subMetas||delete e.subMetas[r]})):e[r]=t[r]})}(0,ipc_1.ipcAddListener)("asset-worker:save-asset-meta",async(e,t,r)=>{if(!t||!r)return e.reply(new Error(Editor.I18n.t("asset-db.saveAssetMeta.fail.content")),!1);const s=(0,utils_1.queryAsset)(t);if(!s)return e.reply(null,!1);try{const a=JSON.parse(r);if("object"!=typeof a||Array.isArray(a))throw new Error(`Save meta failed(${t}): The meta must be an Object string`);return mergeMeta(s.asset.meta,a),await s.asset.save(),Manager.AssetWorker[s.name].reimport(s.asset.uuid),e.reply(null,!0)}catch(t){return console.warn(t),e.reply(t,!1)}}),(0,ipc_1.ipcAddListener)("asset-worker:reimport-asset",async(e,t)=>{Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+t);const r=await(0,asset_db_1.reimport)(t);return Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+t,{output:!0}),e.reply(null,r)}),(0,ipc_1.ipcAddListener)("asset-worker:query-all-importer",async(e,t)=>{const r=plugin_1.default.queryAllImporter();return e.reply(null,r)}),(0,ipc_1.ipcAddListener)("asset-worker:query-all-asset-types",async(e,t)=>{const r=plugin_1.default.queryAllAssetTypes();return e.reply(null,r)});const refreshFiles=[];let autoRefreshTimer;function autoRefresh(e){refreshFiles.includes(e)||refreshFiles.push(e),clearTimeout(autoRefreshTimer),autoRefreshTimer=setTimeout(()=>{refreshFiles.forEach(asset_db_1.refresh),refreshFiles.length=0},100)}function refreshDefaultUserData(){try{const e=(0,path_1.join)(Editor.Project.path,".creator","default-meta.json");if((0,fs_extra_1.existsSync)(e)){const t=(0,fs_extra_1.readJSONSync)(e);for(const e in t)(0,asset_db_1.setDefaultUserData)(e,t[e])}}catch(e){console.error(e)}}(0,ipc_1.ipcAddListener)("asset-worker:refresh-asset",async(e,t)=>{const r=await(0,asset_db_1.refresh)(t);return autoRefresh((0,path_1.dirname)(t)),e.reply(null,r)}),(0,ipc_1.ipcAddListener)("asset-worker:execute-script",async(e,t)=>{try{Editor.Metrics.trackTimeStart("programming:execute-script");const r=await plugin_1.default.executeScript(t);return Editor.Metrics.trackTimeEnd("programming:execute-script",{output:!0}),e.reply(null,r)}catch(t){return e.reply(t)}}),refreshDefaultUserData(),(0,ipc_1.ipcAddListener)("asset-worker:refresh-default-user-data",()=>{refreshDefaultUserData()});