"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,s)}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const i18n=require("@base/electron-i18n"),fs_extra_1=require("fs-extra"),path_1=require("path"),editor_1=require("editor"),asset_db_1=require("@editor/asset-db"),ipc_1=require("../ipc"),utils_1=require("../utils"),plugin_1=__importDefault(require("../plugin")),scripting_1=require("./scripting"),mask_sync_1=require("../mask-sync");let broadcastFlag=!1;(0,ipc_1.ipcAddListener)("asset-worker:init",async(e,t)=>{try{Editor.Metrics.trackTimeStart("asset-db:worker-init"),window.CC_PREVIEW=!1,Editor.Metrics.trackTimeStart("asset-db:require-engine-code");const{default:a}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await a({requiredModules:["cc","cc/editor/populate-internal-constants","cc/editor/serialization","cc/editor/animation-clip-migration","cc/editor/exotic-animation","cc/editor/new-gen-anim","cc/editor/offline-mappings","cc/editor/embedded-player","cc/editor/color-utils"]}),Editor.Metrics.trackTimeEnd("asset-db:require-engine-code",{output:!0}),Manager.AssetInfo=t;const r=async function(e,t){e.output=e.input;for(let t=0;t<e.input.length;t++){const a=e.input[t];if(a.uuid&&!a.isNative)try{const e=await new Promise(e=>{Worker.Ipc._events["asset-worker:query-asset-info"]({reply:(t,a)=>{e(a)}},a.uuid)});e&&e.library[".cconb"]&&(a.ext=".cconb",a.url=a.url.replace(".json",".cconb"))}catch(e){continue}}t(null)};cc.assetManager.pipeline.insert(r,1),cc.assetManager.fetchPipeline.insert(r,1),plugin_1.default.init(),Editor.Metrics.trackTimeEnd("asset-db:worker-init",{output:!0}),e.reply(null)}catch(t){console.error(t),e.reply(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:init-script",async e=>{try{Editor.Metrics.trackTimeStart("asset-db:worker-init-script"),await(0,scripting_1.initializeAssetDBScriptingEnvironment)(),Editor.Metrics.trackTimeEnd("asset-db:worker-init-script",{output:!0}),e.reply(null)}catch(t){console.error(t),e.reply(t)}});const startupDatabaseQueue=[];async function effectDataProcessing(){const e=[];(0,asset_db_1.forEach)(t=>{t.path2asset.forEach(t=>{"effect"===t.meta.importer&&e.push(t)})});const t=Manager.AssetWorker.internal.importerManager.name2importer.effect;t.afterImport&&await t.afterImport(e)}var refreshEnum;(0,ipc_1.ipcAddListener)("asset-worker:startup-database",async(e,t,a)=>{if(Manager.AssetWorker[t.name])return;Editor.Metrics.trackTimeStart(`asset-db:worker-startup-database[${t.name}]`),t.target=t.target.replace("app.asar","app.asar.unpacked"),(0,fs_extra_1.ensureDirSync)(t.target),(0,fs_extra_1.ensureDirSync)(t.library),(0,fs_extra_1.ensureDirSync)(t.temp),t.ignoreRegular&&(t.ignoreRegular=new RegExp(t.ignoreRegular));const r=(0,asset_db_1.create)(t);Manager.AssetWorker[t.name]=r,await plugin_1.default.registerImporterList(r),r.on("unresponsive",async(e,t)=>{if(s&&broadcastFlag){1===(await Editor.Dialog.info(`Resource import Timeout.\n  uuid: ${e.uuid}\n  url: ${e.url}`,{buttons:["Waiting","Interrupt"]})).response&&t.reject("User interrupt")}});let s=!1;r.on("add",e=>{s&&broadcastFlag||(0,mask_sync_1.assetAdd)(e)}),r.on("added",async e=>{s&&broadcastFlag?editor_1.Message.broadcast("asset-db:asset-add",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetAdded)(e)}),r.on("change",async e=>{s&&broadcastFlag||(0,mask_sync_1.assetChange)(e)}),r.on("changed",async e=>{s&&broadcastFlag?editor_1.Message.broadcast("asset-db:asset-change",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetChanged)(e)}),r.on("delete",async e=>{s&&broadcastFlag||(0,mask_sync_1.assetDelete)(e)}),r.on("deleted",async e=>{s&&broadcastFlag?editor_1.Message.broadcast("asset-db:asset-delete",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetDeleted)(e)}),r.once("refresh-uuid-ready",()=>{editor_1.Message.broadcast("asset-db:db-uuid-ready")});const i=async function(e){let t=0,a=0,r=0;for(let s=0;s<e.length;s++){const i=e[s],n=(0,path_1.extname)(i);n?".chunk"===n?(e.splice(s,1),e.splice(t+a,0,i),a+=1):".effect"===n&&(e.splice(s,1),e.splice(t+a+r,0,i),r+=1):(e.splice(s,1),e.splice(t,0,i),t+=1)}};if(r.preImporterHandler=function(e){const t=(0,path_1.extname)(e);return!t||(".chunk"===t||(".effect"===t||".ts"===t))},a)await r.start({hooks:{afterScan:i,afterPreImport:async function(){r.taskManager.start(),await r.taskManager.waitQueue(),r.taskManager.stop(),console.debug("---------------- Effect ------------------- start");try{await effectDataProcessing()}catch(e){console.error(e)}}}}),s=!0,e.reply(null);else{const a={name:t.name};startupDatabaseQueue.push(a);const n=async function(){},c=async function(){a.finish&&a.finish()},o=async function(){return r.taskManager.start(),await r.taskManager.waitQueue(),r.taskManager.stop(),console.debug("---------------- Effect -------------------"),e.reply(null),new Promise(e=>{a.resolve=e})};await r.start({hooks:{afterGenerateMete:n,afterScan:i,afterRefresh:c,afterPreImport:o}}),s=!0}Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${t.name}]`,{output:!0})}),(0,ipc_1.ipcAddListener)("asset-worker:effect-data-processing",async e=>{try{Editor.Metrics.trackTimeStart("asset-db:worker-effect-data-processing"),await effectDataProcessing(),Editor.Metrics.trackTimeEnd("asset-db:worker-effect-data-processing",{output:!0})}catch(e){console.error(e)}e.reply(null)}),(0,ipc_1.ipcAddListener)("asset-worker:startup-await-database",async(e,t,a)=>{for(let e=0;e<startupDatabaseQueue.length;e++){const t=startupDatabaseQueue[e];Editor.Metrics.trackTimeStart(`Start the '${t.name}' database...`);const a=Date.now();await new Promise(e=>{t.finish=e,t.resolve()}),Editor.Metrics.trackTimeEnd(`Start the '${t.name}' database: ${Date.now()-a} ms`)}e.reply(null)}),(0,ipc_1.ipcAddListener)("asset-worker:shutdown-database",async(e,t)=>{const a=Manager.AssetWorker[t];await a.stop(),delete Manager.AssetWorker[t],e.reply(null)}),(0,ipc_1.ipcAddListener)("asset-worker:database-ready",e=>{broadcastFlag=!0,e.reply(null)}),function(e){e[e.idle=0]="idle",e[e.busy=1]="busy",e[e.wait=2]="wait"}(refreshEnum||(refreshEnum={}));let refreshFlag=refreshEnum.idle;const refreshAllDatabase=async e=>{if(e&&e.reply(),refreshFlag===refreshEnum.idle){refreshFlag=refreshEnum.busy;for(const e in Manager.AssetWorker){if(!Manager.AssetWorker[e])continue;const t=Manager.AssetWorker[e];await t.refresh(t.options.target,{ignoreSelf:!0,hooks:"assets"===e?{afterPreImport:async function(){t.taskManager.start(),await t.taskManager.waitQueue(),t.taskManager.stop(),console.debug("---------------- Effect -------------------");try{await effectDataProcessing()}catch(e){console.error(e)}}}:{}})}refreshFlag===refreshEnum.busy?refreshFlag=refreshEnum.idle:refreshFlag===refreshEnum.wait&&(refreshFlag=refreshEnum.idle,refreshAllDatabase()),Editor.Message.broadcast("asset-db:refresh-finish")}else refreshFlag=refreshEnum.wait};(0,ipc_1.ipcAddListener)("asset-worker:refresh-all-database",e=>{Editor.Metrics.trackTimeStart("asset-db:refresh-all-database"),refreshAllDatabase(e),Editor.Metrics.trackTimeEnd("asset-db:refresh-all-database",{output:!0})});