"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,a)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ipc_1=require("../ipc"),asset_db_manager_1=require("../asset-db-manager"),Utils=__importStar(require("../utils")),plugin_1=__importDefault(require("../plugin")),query_1=require("./query"),console_1=require("../console");let hasWarningRequestAnimationFrame=!1;(0,ipc_1.ipcAddListener)("asset-worker:init",async(e,t)=>{try{console_1.newConsole.initLogFiles(),console_1.newConsole.record(),Editor.Metrics.trackTimeStart("asset-db:worker-init"),Editor.Task.__protected__.updateSyncTask("import-asset","Init Asset Worker..."),console_1.newConsole.trackMemoryStart("asset-db:worker-init"),Object.defineProperties(window,{Manager:{set(){console.error(Editor.I18n.t("asset-db.globalReadonlyTip",{name:"Manager"}))},get:()=>({assetDBManager:asset_db_manager_1.assetDBManager,pluginManager:plugin_1.default,AssetInfo:t,Utils:Object.assign({queryAssets:query_1.queryAssets,queryAssetInfo:query_1.queryAssetInfo,queryAssetMeta:query_1.queryAssetMeta,queryAssetMtime:query_1.queryAssetMtime},Utils),get AssetWorker(){return console.log(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"Manager.AssetWorker",newName:"Manager.assetDBManager.assetDBMap",version:"3.8.0"})),asset_db_manager_1.assetDBManager.assetDBMap}})}}),window.requestAnimationFrame=function(e){hasWarningRequestAnimationFrame||(hasWarningRequestAnimationFrame=!0,console.debug("requestAnimationFrame is disabled in editor worker process, will use setTimeout instead.")),setTimeout(e,0)},window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),asset_db_manager_1.assetDBManager.ready||initAssetWorkerFailed(e.reason||"unhandledrejection")}),await asset_db_manager_1.assetDBManager.init(t),console_1.newConsole.trackMemoryEnd("asset-db:worker-init"),Editor.Metrics.trackTimeEnd("asset-db:worker-init",{output:!0}),await asset_db_manager_1.assetDBManager.start(),e.reply(null)}catch(t){console.error("Init asset worker failed!"),console.error(t),e.reply(t),initAssetWorkerFailed(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:start",async e=>{await asset_db_manager_1.assetDBManager.start(),e.reply(null)}),(0,ipc_1.ipcAddListener)("asset-worker:query-database-busy",e=>{e.reply(null,asset_db_manager_1.assetDBManager.isBusy())}),(0,ipc_1.ipcAddListener)("asset-worker:pause-database",async(e,t)=>{e.reply(null,await asset_db_manager_1.assetDBManager.pause(t))}),(0,ipc_1.ipcAddListener)("asset-worker:resume-database",async e=>{await asset_db_manager_1.assetDBManager.resume(),e.reply(null,!0)}),(0,ipc_1.ipcAddListener)("asset-worker:refresh-all-database",async e=>{await asset_db_manager_1.assetDBManager.refresh(),e.reply(null,!0)});let hasErrorDialog=!1;async function initAssetWorkerFailed(e){if(hasErrorDialog)return;hasErrorDialog=!0;const t=(e&&e.stack||e.reason||e).toString();0===(await Editor.Dialog.error(t,{title:Editor.I18n.t("asset-db.assetDBInitError"),buttons:[Editor.I18n.t("asset-db.debug-mode"),Editor.I18n.t("asset-db.operate.dialogQuestion")],default:1})).response&&Editor.Message.send("asset-db","open-devtools")}