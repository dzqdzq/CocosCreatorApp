"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,s){void 0===s&&(s=t);var r=Object.getOwnPropertyDescriptor(a,t);r&&("get"in r?a.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,s,r)}:function(e,a,t,s){e[s=void 0===s?t:s]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(){var r=function(e){return(r=Object.getOwnPropertyNames||function(e){var a,t=[];for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[t.length]=a);return t})(e)};return function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t=r(e),s=0;s<t.length;s++)"default"!==t[s]&&__createBinding(a,e,t[s]);return __setModuleDefault(a,e),a}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessageMap=void 0;const asset_db_manager_1=require("../asset-db-manager"),plugin_1=__importDefault(require("../manager/plugin")),console_1=require("../console"),asset_manager_1=require("../manager/asset-manager"),UtilsModule=__importStar(require("../utils"));let hasWarningRequestAnimationFrame=!1,hasErrorDialog=!(exports.MessageMap={init:async e=>{try{console_1.newConsole.initLogFiles(),console_1.newConsole.record(),Editor.Metrics.trackTimeStart("asset-db:worker-init"),Editor.Task.__protected__.updateSyncTask("import-asset","Init Asset Worker..."),console_1.newConsole.trackMemoryStart("asset-db:worker-init");const a={...UtilsModule,path2url:asset_db_manager_1.assetDBManager.path2url.bind(asset_db_manager_1.assetDBManager)};defineProperties(a,["queryAssetUsers","queryAssets","queryAsset","queryAssetProperty","queryAssetInfo","queryAssetMeta","queryAssetMtime","queryAssetDependencies","encodeAsset"],e=>(console.log(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"Manager.Utils."+e,newName:"Manager.assetManager."+e,version:"3.8.3"})),asset_manager_1.assetManager[e].bind(asset_manager_1.assetManager))),Object.defineProperties(window,{Manager:{set(){console.error(Editor.I18n.t("asset-db.globalReadonlyTip",{name:"Manager"}))},get(){return{assetDBManager:asset_db_manager_1.assetDBManager,assetManager:asset_manager_1.assetManager,pluginManager:plugin_1.default,AssetInfo:e,get AssetWorker(){return console.log(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"Manager.AssetWorker",newName:"Manager.assetDBManager.assetDBMap",version:"3.8.0"})),asset_db_manager_1.assetDBManager.assetDBMap},Utils:a}}}}),window.requestAnimationFrame=function(e){hasWarningRequestAnimationFrame||(hasWarningRequestAnimationFrame=!0,console.debug("requestAnimationFrame is disabled in editor worker process, will use setTimeout instead.")),setTimeout(e,0)},window.addEventListener("unhandledrejection",e=>{console.error(e.reason),console.debug(e),asset_db_manager_1.assetDBManager.ready||initAssetWorkerFailed(e.reason||"unhandledrejection")}),await asset_manager_1.assetManager.init(),await asset_db_manager_1.assetDBManager.init(e),console_1.newConsole.trackMemoryEnd("asset-db:worker-init"),Editor.Metrics.trackTimeEnd("asset-db:worker-init",{output:!0}),await asset_db_manager_1.assetDBManager.start()}catch(e){throw console.error("Init asset worker failed!"),console.error(e),initAssetWorkerFailed(e),e}},start:async()=>asset_db_manager_1.assetDBManager.start(),"query-database-busy":()=>asset_db_manager_1.assetDBManager.isBusy(),"pause-database":async e=>asset_db_manager_1.assetDBManager.pause(e),"stop-database":async e=>asset_db_manager_1.assetDBManager.removeDB(e),"start-database":async e=>asset_db_manager_1.assetDBManager.addDB(e),"resume-database":async()=>asset_db_manager_1.assetDBManager.resume(),"refresh-all-database":async()=>(await asset_db_manager_1.assetDBManager.refresh(),!0)});async function initAssetWorkerFailed(e){if(hasErrorDialog||asset_db_manager_1.assetDBManager.ready)console.error(e);else{hasErrorDialog=!0;e=(e&&e.stack||e.reason||e).toString();switch((await Editor.Dialog.error(e,{title:Editor.I18n.t("asset-db.assetDBInitError"),buttons:[Editor.I18n.t("asset-db.debug-mode"),Editor.I18n.t("asset-db.operate.dialogQuestion"),Editor.I18n.t("asset-db.operate.stillOpen")],default:1})).response){case 0:Editor.Message.send("asset-db","open-devtools");break;case 2:Editor.Task.__protected__.removeSyncTask("import-asset")}}}function defineProperties(e,a,t){const s={};a.forEach(e=>{s[e]={get(){return t(e)}}}),Object.defineProperties(e,s)}