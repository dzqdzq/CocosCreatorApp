"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const i18n=require("@base/electron-i18n"),fs_extra_1=require("fs-extra"),editor_1=require("editor"),asset_db_1=require("@editor/asset-db"),ipc_1=require("../ipc"),utils_1=require("../utils"),plugin_1=__importDefault(require("../plugin")),scripting_1=require("./scripting");let broadcastFlag=!1;ipc_1.ipcAddListener("asset-worker:init",(e,s)=>{try{window.CC_PREVIEW=!1,Editor.Metrics.trackTimeStart("[AssetDB] Require engine code");const a=require("cc");window.cc.debug._resetDebugSetting(a.DebugMode.INFO),Editor.Metrics.trackTimeEnd("[AssetDB] Require engine code"),Manager.AssetInfo=s;const t=async function(e,s){e.output=e.input;for(let s=0;s<e.input.length;s++){const a=e.input[s];if(a.uuid&&!a.isNative)try{const e=await new Promise(e=>{Worker.Ipc._events["asset-worker:query-asset-info"]({reply:(s,a)=>{e(a)}},a.uuid)});e&&e.library[".cconb"]&&(a.ext=".cconb",a.url=a.url.replace(".json",".cconb"))}catch(e){continue}}s(null)};a.assetManager.pipeline.insert(t,1),a.assetManager.fetchPipeline.insert(t,1),plugin_1.default.init(),e.reply(null)}catch(s){console.error(s),e.reply(s)}}),ipc_1.ipcAddListener("asset-worker:init-script",async e=>{try{await scripting_1.initializeAssetDBScriptingEnvironment(),e.reply(null)}catch(s){console.error(s),e.reply(s)}});const startupDatabaseQueue=[];var refreshEnum;ipc_1.ipcAddListener("asset-worker:startup-database",async(e,s,a)=>{fs_extra_1.ensureDirSync(s.target),fs_extra_1.ensureDirSync(s.library),fs_extra_1.ensureDirSync(s.temp),s.ignoreRegular&&(s.ignoreRegular=new RegExp(s.ignoreRegular));const t=asset_db_1.create(s);Manager.AssetWorker[s.name]=t,plugin_1.default.registerImporterList(t);let r=!1;if(t.on("added",async e=>{if(r&&broadcastFlag)editor_1.Message.broadcast("asset-db:asset-add",e.uuid,await utils_1.encodeAsset(e._assetDB,e),e.meta);else{const s=e._assetDB.taskManager._execID-e._assetDB.taskManager._execThread;editor_1.Task.updateSyncTask("import-asset",i18n.translation("asset-db.mask.loading"),`${asset_db_1.queryUrl(e.source)}\n(${s}/${e._assetDB.taskManager.total()})`)}}),t.on("changed",async e=>{if(r&&broadcastFlag)editor_1.Message.broadcast("asset-db:asset-change",e.uuid,await utils_1.encodeAsset(e._assetDB,e),e.meta);else{const s=e._assetDB.taskManager._execID-e._assetDB.taskManager._execThread;editor_1.Task.updateSyncTask("import-asset",i18n.translation("asset-db.mask.loading"),`${asset_db_1.queryUrl(e.source)}\n(${s}/${e._assetDB.taskManager.total()})`)}}),t.on("deleted",async e=>{if(r&&broadcastFlag)editor_1.Message.broadcast("asset-db:asset-delete",e.uuid,await utils_1.encodeAsset(e._assetDB,e),e.meta);else{const s=e._assetDB.taskManager._execID-e._assetDB.taskManager._execThread;editor_1.Task.updateSyncTask("import-asset",i18n.translation("asset-db.mask.loading"),`${asset_db_1.queryUrl(e.source)}\n(${s}/${e._assetDB.taskManager.total()})`)}}),t.once("refresh-uuid-ready",()=>{editor_1.Message.broadcast("asset-db:db-uuid-ready")}),a)await t.start(),r=!0,e.reply(null);else{const a={name:s.name};startupDatabaseQueue.push(a);const n=async function(){return e.reply(null),new Promise(e=>{a.resolve=e})},i=async function(){a.finish&&a.finish()};await t.start({hooks:{afterGenerateMete:n,afterRefresh:i}}),r=!0}}),ipc_1.ipcAddListener("asset-worker:startup-await-database",async(e,s,a)=>{for(let e=0;e<startupDatabaseQueue.length;e++){const s=startupDatabaseQueue[e];console.log(`Start the '${s.name}' database...`);const a=Date.now();await new Promise(e=>{s.finish=e,s.resolve()}),console.log(`Start the '${s.name}' database: ${Date.now()-a}`)}e.reply(null)}),ipc_1.ipcAddListener("asset-worker:shutdown-database",async(e,s)=>{const a=Manager.AssetWorker[s];await a.stop(),delete Manager.AssetWorker[s],e.replay(null)}),ipc_1.ipcAddListener("asset-worker:database-ready",e=>{broadcastFlag=!0,e.reply(null)}),function(e){e[e.idle=0]="idle",e[e.busy=1]="busy",e[e.wait=2]="wait"}(refreshEnum||(refreshEnum={}));let refreshFlag=refreshEnum.idle;const refreshAllDatabase=async e=>{if(e&&e.reply(),refreshFlag===refreshEnum.idle){refreshFlag=refreshEnum.busy;for(const e in Manager.AssetWorker){if(!Manager.AssetWorker[e])continue;const s=Manager.AssetWorker[e];await s.refresh(s.options.target,{ignoreSelf:!0})}refreshFlag===refreshEnum.busy?refreshFlag=refreshEnum.idle:refreshFlag===refreshEnum.wait&&(refreshFlag=refreshEnum.idle,refreshAllDatabase()),Editor.Message.broadcast("asset-db:refresh-finish")}else refreshFlag=refreshEnum.wait};ipc_1.ipcAddListener("asset-worker:refresh-all-database",refreshAllDatabase);