"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryAssetInfo=exports.queryAssets=void 0;const path_1=require("path"),editor_1=require("editor"),asset_db_1=require("@editor/asset-db"),ipc_1=require("../ipc"),utils_1=require("../utils"),fs_extra_1=require("fs-extra"),minimatch=require("minimatch"),packageManager=require("@editor/package"),TYPES={scripts:[".js",".ts"],scene:[".scene"],effect:[".effect"],image:[".jpg",".png",".jpeg",".webp",".tga"]};async function queryDatabaseInfo(e=""){if("string"!=typeof e||""===e)return null;if(e.startsWith("db://")){e=e.split("/").filter(Boolean)[1]}const r=Manager.AssetWorker[e];return r&&r.options?r.options:null}function queryAssets(e={}){("object"!=typeof e||Array.isArray(e))&&(e={}),e=e||{};let r=[];for(const e in Manager.AssetWorker){if(!(e in Manager.AssetWorker))continue;const t=Manager.AssetWorker[e];r.push(dbAssetInfo(e)),t.uuid2asset.forEach((e,s)=>{const n=(0,utils_1.encodeAsset)(t,e);r.push(n)})}return e&&(r=searchAssets(e,r)),r}function queryAssetInfo(e){if(!e)return null;const r=(0,utils_1.queryAsset)(e);if(!r||!r.asset)return null;const t=r.asset,s=Manager.AssetWorker[r.name];return(0,utils_1.encodeAsset)(s,t)}async function queryAssetMtime(e=""){if(!e||"string"!=typeof e)return null;for(const r in Manager.AssetWorker){if(!(r in Manager.AssetWorker))continue;const t=Manager.AssetWorker[r];if(!t)continue;const s=t.getAsset(e);if(s){const e=t.infoManager.map[s.source];return e?e.time:null}}return null}async function queryAssetMeta(e=""){if(!e||"string"!=typeof e)return null;const r=(0,utils_1.queryAsset)(e);if(!r)return null;const t=r.asset;return t?t.meta:null}function searchAssets(e,r,t=[],s){if(e.pattern&&"string"==typeof e.pattern&&(r=r.filter(r=>minimatch(r.source,e.pattern))),e.isBundle)return r=r.filter(e=>{const r=(0,utils_1.queryAsset)(e.uuid);return!!r&&(!(!r.asset.meta.userData||!r.asset.meta.userData.isBundle)&&(e.meta=r.asset.meta,!0))});if(e.type&&"string"==typeof e.type){const t=TYPES[e.type];t&&(r=r.filter(e=>!(!t.includes((0,path_1.extname)(e.source))||/\.d\.ts$/.test(e.source))))}if(void 0!==e.extname&&("string"==typeof e.extname&&(e.extname=[e.extname.trim()]),Array.isArray(e.extname))){const t=e.extname.map(e=>e.toLowerCase());r=r.filter(e=>{const r=(0,path_1.extname)(e.source).toLowerCase();return!(!t.includes(r)||/\.d\.ts$/.test(e.source))})}return void 0===e.ccType&&void 0===e.importer||("string"==typeof e.ccType&&(e.ccType=[e.ccType.trim()]),"string"==typeof e.importer&&(e.importer=[e.importer.trim()]),r.forEach(r=>{if(Array.isArray(e.ccType)&&e.ccType.includes(r.type)||Array.isArray(e.importer)&&e.importer.includes(r.importer))return s&&(r.fatherInfo={source:s.source,library:s.library,uuid:s.uuid}),void t.push(r);Object.keys(r.subAssets).length>0&&searchAssets({ccType:e.ccType,importer:e.importer},Object.values(r.subAssets),t,r)}),r=t),r}function dbAssetInfo(e){const r=Manager.AssetWorker[e];return{name:e,displayName:e||"",source:`db://${e}`,path:`db://${e}`,url:`db://${e}`,file:r.options.target,uuid:`db://${e}`,importer:"database",imported:!0,invalid:!1,type:"database",isDirectory:!1,library:{},subAssets:{},visible:r.options.visible,instantiation:void 0,readonly:r.options.readonly}}(0,ipc_1.ipcAddListener)("asset-worker:generate-available-url",(e,r)=>{if(!r||"string"!=typeof r)return e.reply(null,null);const t=(0,asset_db_1.queryPath)(r);if(!t)return e.reply(null,"");if(!(0,fs_extra_1.existsSync)(t))return e.reply(null,r);const s=editor_1.Utils.File.getName(t);return e.reply(null,(0,asset_db_1.queryUrl)(s))}),(0,ipc_1.ipcAddListener)("asset-worker:query-path",(e,r)=>{if(!r||"string"!=typeof r)return e.reply(new Error("parameter error"),null);if(r.startsWith("db://")){const t=r.substr(5);if(Manager.AssetWorker[t])return e.reply(null,Manager.AssetWorker[t].options.target);const s=(0,utils_1.url2uuid)(r);s&&(0,utils_1.queryAsset)(s)&&(r=s)}try{const t=(0,asset_db_1.queryPath)(r);return e.reply(null,t)}catch(r){return e.reply(r)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-url",async(e,r)=>{if(!r||"string"!=typeof r)return e.reply(new Error("parameter error"),null);const t=r.substr(editor_1.Project.path.length+1);if(Manager.AssetWorker[t])return e.reply(null,`db://${t}`);try{const t=(0,asset_db_1.queryUrl)(r);return e.reply(null,t)}catch(r){return e.reply(r)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-uuid",(e,r)=>{if(!r||"string"!=typeof r)return e.reply(null,null);if(r.startsWith("db://")){const t=r.substr(5);if(Manager.AssetWorker[t])return e.reply(null,`db://${t}`);const s=(0,utils_1.url2uuid)(r);if(s)return e.reply(null,s)}try{const t=(0,asset_db_1.queryUUID)(r);return e.reply(null,t)}catch(r){return e.reply(r)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-info",async(e,r)=>{try{const t=await queryDatabaseInfo(r);return e.reply(null,t)}catch(r){return e.reply(r,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-list",e=>{try{return e.reply(null,Object.keys(Manager.AssetWorker))}catch(r){return e.reply(r,null)}}),exports.queryAssets=queryAssets,(0,ipc_1.ipcAddListener)("asset-worker:query-assets",async(e,r={})=>{try{const t=await queryAssets(r);return e.reply(null,t)}catch(r){return e.reply(r,null)}}),exports.queryAssetInfo=queryAssetInfo,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-info",async(e,r="")=>{if(!r||"string"!=typeof r)return e.reply(new Error("parameter error"),null);let t="";if(r.startsWith("db://")){const s=r.substr(5);if(Manager.AssetWorker[s])return e.reply(null,dbAssetInfo(s));t=(0,utils_1.url2uuid)(r)}else if((0,path_1.isAbsolute)(r))for(const e in Manager.AssetWorker){const s=Manager.AssetWorker[e];if(s&&s.path2asset.has(r)){t=s.path2asset.get(r).uuid;break}}else t=r;if(!t)return e.reply(null,null);try{const r=await queryAssetInfo(t);return e.reply(null,r)}catch(r){return e.reply(r,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-mtime",async(e,r)=>{if(r.startsWith("db://")){const t=r.substr(5);if(Manager.AssetWorker[t])return e.reply(null,dbAssetInfo(t));r=(0,utils_1.url2uuid)(r)}try{const t=await queryAssetMtime(r);return e.reply(null,t)}catch(r){return e.reply(r,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-meta",async(e,r)=>{if(!r||"string"!=typeof r)return e.reply(null,null);if(r.startsWith("db://")){const t=r.substr(5);if(Manager.AssetWorker[t])return e.reply(null,{files:[],imported:!0,importer:"database",subMetas:{},userData:{},uuid:r,ver:"1.0.0"});r=(0,utils_1.url2uuid)(r)}const t=await queryAssetMeta(r);return e.reply(null,t)}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-dependencies",async(e,r)=>{const t=(0,utils_1.queryAsset)(r);if(!t||!t.asset)return e.reply(null,[]);const s=t.asset.uuid,n=(null===t||void 0===t?void 0:t.asset._assetDB.dataManaer.dataMap)[s];return n&&n.value&&n.value.depends?e.reply(null,n.value.depends||[]):e.reply(null,[])}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-used",async(e,r)=>{const t=(0,utils_1.queryAsset)(r);if(!t||!t.asset)return e.reply(null,[]);const s=t.asset.uuid,n=null===t||void 0===t?void 0:t.asset._assetDB.dataManaer.dataMap,a=[];for(const e in n){const r=n[e];r.value&&r.value.depends&&r.value.depends.includes(s)&&a.push(e)}return e.reply(null,a)}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-data",async(e,r)=>{let t=null;return(0,asset_db_1.forEach)(e=>{e.dataManaer.dataMap[r]&&(t=e.dataManaer.dataMap[r])}),e.reply(null,t)});