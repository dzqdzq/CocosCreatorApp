"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryAssetMeta=exports.queryAssetMtime=exports.queryAssetInfo=exports.queryAssets=void 0;const path_1=require("path"),asset_db_1=require("@editor/asset-db"),ipc_1=require("../ipc"),utils_1=require("../utils"),fs_extra_1=require("fs-extra"),asset_db_manager_1=require("../asset-db-manager"),minimatch=require("minimatch"),TYPES={scripts:[".js",".ts"],scene:[".scene"],effect:[".effect"],image:[".jpg",".png",".jpeg",".webp",".tga"]};function queryDatabaseInfo(e=""){if("string"!=typeof e||""===e)return null;if(e.startsWith("db://")){e=e.split("/").filter(Boolean)[1]}return asset_db_manager_1.assetDBManager.assetDBInfo[e]||null}async function queryAssets(e={},s){("object"!=typeof e||Array.isArray(e))&&(e={}),e=e||{};let t=[];for(const e in asset_db_manager_1.assetDBManager.assetDBMap){if(!(e in asset_db_manager_1.assetDBManager.assetDBMap))continue;const r=asset_db_manager_1.assetDBManager.assetDBMap[e];t.push(dbAssetInfo(e)),r.uuid2asset.forEach((e,a)=>{const n=(0,utils_1.encodeAsset)(r,e,s);t.push(n)})}return e&&(t=searchAssets(e,t)),t}function queryAssetInfo(e,s){if(!e)return null;const t=(0,utils_1.queryAsset)(e);if(!t||!t.asset)return null;const r=t.asset,a=asset_db_manager_1.assetDBManager.assetDBMap[t.name];return(0,utils_1.encodeAsset)(a,r,s)}function queryAssetMtime(e=""){if(!e||"string"!=typeof e)return null;for(const s in asset_db_manager_1.assetDBManager.assetDBMap){if(!(s in asset_db_manager_1.assetDBManager.assetDBMap))continue;const t=asset_db_manager_1.assetDBManager.assetDBMap[s];if(!t)continue;const r=t.getAsset(e);if(r){const e=t.infoManager.get(r.source);return e?e.time:null}}return null}function queryAssetMeta(e=""){if(!e||"string"!=typeof e)return null;const s=(0,utils_1.queryAsset)(e);if(!s)return null;const t=s.asset;return t?t.meta:null}function searchAssets(e,s,t=[],r){if(e.pattern&&"string"==typeof e.pattern&&(s=s.filter(s=>minimatch(s.source,e.pattern))),e.isBundle)return s=s.filter(e=>{const s=(0,utils_1.queryAsset)(e.uuid);return!!s&&(!(!s.asset.meta.userData||!s.asset.meta.userData.isBundle)&&(e.meta=s.asset.meta,!0))});const a=e.type;if(a&&"string"==typeof a){console.warn(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"options.type",newName:"options.ccType",version:"3.8.0"}));const e=TYPES[a];e&&(s=s.filter(s=>!(!e.includes((0,path_1.extname)(s.source))||/\.d\.ts$/.test(s.source))))}if(void 0!==e.extname&&("string"==typeof e.extname&&(e.extname=[e.extname.trim()]),Array.isArray(e.extname))){const t=e.extname.map(e=>e.toLowerCase());s=s.filter(e=>{const s=(0,path_1.extname)(e.source).toLowerCase();return!(!t.includes(s)||/\.d\.ts$/.test(e.source))})}return void 0===e.ccType&&void 0===e.importer||("string"==typeof e.ccType&&(e.ccType=[e.ccType.trim()]),"string"==typeof e.importer&&(e.importer=[e.importer.trim()]),s.forEach(s=>{if(Array.isArray(e.ccType)&&e.ccType.includes(s.type)||Array.isArray(e.importer)&&e.importer.includes(s.importer))return r&&(s.fatherInfo={source:r.source,library:r.library,uuid:r.uuid}),void t.push(s);s.subAssets&&Object.keys(s.subAssets).length>0&&searchAssets({ccType:e.ccType,importer:e.importer},Object.values(s.subAssets),t,s)}),s=t),s}function dbAssetInfo(e){const s=asset_db_manager_1.assetDBManager.assetDBInfo[e];return{name:e,displayName:e||"",source:`db://${e}`,path:`db://${e}`,url:`db://${e}`,file:s.target,uuid:`db://${e}`,importer:"database",imported:!0,invalid:!1,type:"database",isDirectory:!1,library:{},subAssets:{},visible:s.visible,instantiation:void 0,readonly:s.readonly}}(0,ipc_1.ipcAddListener)("asset-worker:generate-available-url",(e,s)=>{if(!s||"string"!=typeof s)return e.reply(null,null);const t=(0,asset_db_1.queryPath)(s);if(!t)return e.reply(null,"");if(!(0,fs_extra_1.existsSync)(t))return e.reply(null,s);const r=Editor.Utils.File.getName(t);return e.reply(null,(0,asset_db_1.queryUrl)(r))}),(0,ipc_1.ipcAddListener)("asset-worker:query-path",(e,s)=>{if(!s||"string"!=typeof s)return e.reply(new Error("parameter error"),null);if(s.startsWith("db://")){const t=s.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,asset_db_manager_1.assetDBManager.assetDBMap[t].options.target);const r=(0,utils_1.url2uuid)(s);r&&(0,utils_1.queryAsset)(r)&&(s=r)}try{const t=(0,asset_db_1.queryPath)(s);return e.reply(null,t)}catch(s){return e.reply(s)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-url",async(e,s)=>{if(!s||"string"!=typeof s)return e.reply(new Error("parameter error"),null);const t=s.substr(Editor.Project.path.length+1);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,`db://${t}`);try{const t=(0,asset_db_1.queryUrl)(s);return e.reply(null,t)}catch(s){return e.reply(s)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-uuid",(e,s)=>{if(!s||"string"!=typeof s)return e.reply(null,null);if(s.startsWith("db://")){const t=s.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,`db://${t}`);const r=(0,utils_1.url2uuid)(s);if(r)return e.reply(null,r)}try{const t=(0,asset_db_1.queryUUID)(s);return e.reply(null,t)}catch(s){return e.reply(s,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-info",async(e,s)=>{try{return e.reply(null,queryDatabaseInfo(s))}catch(s){return e.reply(s,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-list",e=>{try{return e.reply(null,Object.keys(asset_db_manager_1.assetDBManager.assetDBMap))}catch(s){return e.reply(s,[])}}),exports.queryAssets=queryAssets,(0,ipc_1.ipcAddListener)("asset-worker:query-assets",async(e,s={},t)=>{try{const r=await queryAssets(s,t);return e.reply(null,r)}catch(s){return e.reply(s,[])}}),exports.queryAssetInfo=queryAssetInfo,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-info",async(e,s="",t)=>{if(!s||"string"!=typeof s)return e.reply(new Error("parameter error"),null);let r="";if(s.startsWith("db://")){const t=s.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,dbAssetInfo(t));r=(0,utils_1.url2uuid)(s)}else if((0,path_1.isAbsolute)(s))for(const e in asset_db_manager_1.assetDBManager.assetDBMap){const t=asset_db_manager_1.assetDBManager.assetDBMap[e];if(t&&t.path2asset.has(s)){r=t.path2asset.get(s).uuid;break}}else r=s;if(!r)return e.reply(null,null);try{const s=await queryAssetInfo(r,t);return e.reply(null,s)}catch(s){return e.reply(s,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-missing-asset-info",async(e,s)=>e.reply(null,(0,asset_db_1.queryMissingInfo)(s))),exports.queryAssetMtime=queryAssetMtime,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-mtime",async(e,s)=>{if(s.startsWith("db://")){const t=s.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,dbAssetInfo(t));s=(0,utils_1.url2uuid)(s)}try{const t=await queryAssetMtime(s);return e.reply(null,t)}catch(s){return e.reply(s,null)}}),exports.queryAssetMeta=queryAssetMeta,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-meta",async(e,s)=>{if(!s||"string"!=typeof s)return e.reply(null,null);if(s.startsWith("db://")){const t=s.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[t])return e.reply(null,{files:[],imported:!0,importer:"database",subMetas:{},userData:{},uuid:s,ver:"1.0.0"});s=(0,utils_1.url2uuid)(s)}const t=await queryAssetMeta(s);return e.reply(null,t)}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-dependencies",async(e,s,t="asset")=>e.reply(null,await(0,utils_1.queryAssetDependencies)(s,t))),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-used",async(e,s,t="asset")=>e.reply(null,await(0,utils_1.queryAssetDependeds)(s,t))),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-data",async(e,s)=>{let t=null;return(0,asset_db_1.forEach)(e=>{e.dataManager.dataMap[s]&&(t=e.dataManager.dataMap[s])}),e.reply(null,t)});