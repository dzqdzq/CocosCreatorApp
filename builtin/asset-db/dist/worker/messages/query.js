"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryAssetMeta=exports.queryAssetMtime=exports.queryAssetInfo=exports.queryAssets=void 0;const path_1=require("path"),asset_db_1=require("@editor/asset-db"),ipc_1=require("../ipc"),utils_1=require("../utils"),fs_extra_1=require("fs-extra"),asset_db_manager_1=require("../asset-db-manager"),minimatch=require("minimatch"),TYPES={scripts:[".js",".ts"],scene:[".scene"],effect:[".effect"],image:[".jpg",".png",".jpeg",".webp",".tga"]};function queryDatabaseInfo(e=""){if("string"!=typeof e||""===e)return null;if(e.startsWith("db://")){e=e.split("/").filter(Boolean)[1]}return asset_db_manager_1.assetDBManager.assetDBInfo[e]||null}async function queryAssets(e={},t){("object"!=typeof e||Array.isArray(e))&&(e={}),e=e||{};let s=[];for(const e in asset_db_manager_1.assetDBManager.assetDBMap){if(!(e in asset_db_manager_1.assetDBManager.assetDBMap))continue;const r=asset_db_manager_1.assetDBManager.assetDBMap[e];s.push(dbAssetInfo(e)),r.uuid2asset.forEach((e,a)=>{const n=(0,utils_1.encodeAsset)(r,e,t);s.push(n)})}return e&&(s=searchAssets(e,s)),s}function queryAssetInfo(e,t){if(!e)return null;const s=(0,utils_1.queryAsset)(e);if(!s||!s.asset)return null;const r=s.asset,a=asset_db_manager_1.assetDBManager.assetDBMap[s.name];return(0,utils_1.encodeAsset)(a,r,t)}function queryAssetMtime(e=""){if(!e||"string"!=typeof e)return null;for(const t in asset_db_manager_1.assetDBManager.assetDBMap){if(!(t in asset_db_manager_1.assetDBManager.assetDBMap))continue;const s=asset_db_manager_1.assetDBManager.assetDBMap[t];if(!s)continue;const r=s.getAsset(e);if(r){const e=s.infoManager.get(r.source);return e?e.time:null}}return null}function queryAssetMeta(e=""){if(!e||"string"!=typeof e)return null;const t=(0,utils_1.queryAsset)(e);if(!t)return null;const s=t.asset;return s?s.meta:null}function searchAssets(e,t,s=[],r){if(e.pattern&&"string"==typeof e.pattern&&(t=t.filter(t=>minimatch(t.url,e.pattern))),e.isBundle)return t=t.filter(e=>{const t=(0,utils_1.queryAsset)(e.uuid);return!!t&&(!(!t.asset.meta.userData||!t.asset.meta.userData.isBundle)&&(e.meta=t.asset.meta,!0))});const a=e.type;if(a&&"string"==typeof a){console.warn(Editor.I18n.t("asset-db.deprecatedTip",{oldName:"options.type",newName:"options.ccType",version:"3.8.0"}));const e=TYPES[a];e&&(t=t.filter(t=>!(!e.includes((0,path_1.extname)(t.source))||/\.d\.ts$/.test(t.source))))}if(void 0!==e.extname&&("string"==typeof e.extname&&(e.extname=[e.extname.trim()]),Array.isArray(e.extname))){const s=e.extname.map(e=>e.toLowerCase());t=t.filter(e=>{const t=(0,path_1.extname)(e.source).toLowerCase();return!(!s.includes(t)||/\.d\.ts$/.test(e.source))})}return void 0===e.ccType&&void 0===e.importer&&void 0===e.pattern||("string"==typeof e.ccType&&(e.ccType=[e.ccType.trim()]),"string"==typeof e.importer&&(e.importer=[e.importer.trim()]),t.forEach(t=>{t.subAssets&&Object.keys(t.subAssets).length>0&&searchAssets({ccType:e.ccType,importer:e.importer,pattern:e.pattern},Object.values(t.subAssets),s,t),(Array.isArray(e.ccType)&&e.ccType.includes(t.type)||Array.isArray(e.importer)&&e.importer.includes(t.importer)||e.pattern&&minimatch(t.url,e.pattern))&&(r&&(t.fatherInfo={source:r.source,library:r.library,uuid:r.uuid}),s.push(t))}),t=s),t}function dbAssetInfo(e){const t=asset_db_manager_1.assetDBManager.assetDBInfo[e];return{name:e,displayName:e||"",source:`db://${e}`,path:`db://${e}`,url:`db://${e}`,file:t.target,uuid:`db://${e}`,importer:"database",imported:!0,invalid:!1,type:"database",isDirectory:!1,library:{},subAssets:{},visible:t.visible,instantiation:void 0,readonly:t.readonly}}(0,ipc_1.ipcAddListener)("asset-worker:generate-available-url",(e,t)=>{if(!t||"string"!=typeof t)return e.reply(null,null);const s=(0,asset_db_1.queryPath)(t);if(!s)return e.reply(null,"");if(!(0,fs_extra_1.existsSync)(s))return e.reply(null,t);const r=Editor.Utils.File.getName(s);return e.reply(null,(0,asset_db_1.queryUrl)(r))}),(0,ipc_1.ipcAddListener)("asset-worker:query-path",(e,t)=>{if(!t||"string"!=typeof t)return e.reply(new Error("parameter error"),null);if(t.startsWith("db://")){const s=t.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,asset_db_manager_1.assetDBManager.assetDBMap[s].options.target);const r=(0,utils_1.url2uuid)(t);r&&(0,utils_1.queryAsset)(r)&&(t=r)}try{const s=(0,asset_db_1.queryPath)(t);return e.reply(null,s)}catch(t){return e.reply(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-url",async(e,t)=>{if(!t||"string"!=typeof t)return e.reply(new Error("parameter error"),null);const s=t.substr(Editor.Project.path.length+1);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,`db://${s}`);try{const s=(0,asset_db_1.queryUrl)(t);return e.reply(null,s)}catch(t){return e.reply(t)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-uuid",(e,t)=>{if(!t||"string"!=typeof t)return e.reply(null,null);if(t.startsWith("db://")){const s=t.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,`db://${s}`);const r=(0,utils_1.url2uuid)(t);if(r)return e.reply(null,r)}try{const s=(0,asset_db_1.queryUUID)(t);return e.reply(null,s)}catch(t){return e.reply(t,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-info",async(e,t)=>{try{return e.reply(null,queryDatabaseInfo(t))}catch(t){return e.reply(t,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-db-list",e=>{try{return e.reply(null,Object.keys(asset_db_manager_1.assetDBManager.assetDBMap))}catch(t){return e.reply(t,[])}}),exports.queryAssets=queryAssets,(0,ipc_1.ipcAddListener)("asset-worker:query-assets",async(e,t={},s)=>{try{const r=await queryAssets(t,s);return e.reply(null,r)}catch(t){return e.reply(t,[])}}),exports.queryAssetInfo=queryAssetInfo,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-info",async(e,t="",s)=>{if(!t||"string"!=typeof t)return e.reply(new Error("parameter error"),null);let r="";if(t.startsWith("db://")){const s=t.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,dbAssetInfo(s));r=(0,utils_1.url2uuid)(t)}else if((0,path_1.isAbsolute)(t))for(const e in asset_db_manager_1.assetDBManager.assetDBMap){const s=asset_db_manager_1.assetDBManager.assetDBMap[e];if(s&&s.path2asset.has(t)){r=s.path2asset.get(t).uuid;break}}else r=t;if(!r)return e.reply(null,null);try{const t=await queryAssetInfo(r,s);return e.reply(null,t)}catch(t){return e.reply(t,null)}}),(0,ipc_1.ipcAddListener)("asset-worker:query-missing-asset-info",async(e,t)=>e.reply(null,(0,asset_db_1.queryMissingInfo)(t))),exports.queryAssetMtime=queryAssetMtime,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-mtime",async(e,t)=>{if(t.startsWith("db://")){const s=t.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,dbAssetInfo(s));t=(0,utils_1.url2uuid)(t)}try{const s=await queryAssetMtime(t);return e.reply(null,s)}catch(t){return e.reply(t,null)}}),exports.queryAssetMeta=queryAssetMeta,(0,ipc_1.ipcAddListener)("asset-worker:query-asset-meta",async(e,t)=>{if(!t||"string"!=typeof t)return e.reply(null,null);if(t.startsWith("db://")){const s=t.substr(5);if(asset_db_manager_1.assetDBManager.assetDBMap[s])return e.reply(null,{files:[],imported:!0,importer:"database",subMetas:{},userData:{},uuid:t,ver:"1.0.0"});t=(0,utils_1.url2uuid)(t)}const s=await queryAssetMeta(t);return e.reply(null,s)}),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-dependencies",async(e,t,s="asset")=>e.reply(null,await(0,utils_1.queryAssetDependencies)(t,s))),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-used",async(e,t,s="asset")=>e.reply(null,await(0,utils_1.queryAssetDependeds)(t,s))),(0,ipc_1.ipcAddListener)("asset-worker:query-asset-data",async(e,t)=>{let s=null;return(0,asset_db_1.forEach)(e=>{e.dataManager.dataMap[t]&&(s=e.dataManager.dataMap[t])}),e.reply(null,s)});