"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,a){void 0===a&&(a=t);var r=Object.getOwnPropertyDescriptor(s,t);r&&("get"in r?s.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,a,r)}:function(e,s,t,a){void 0===a&&(a=t),e[a]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetDBManager=void 0;const assetdb=__importStar(require("@editor/asset-db")),events_1=__importDefault(require("events")),fs_extra_1=require("fs-extra"),path_1=require("path"),console_1=require("./console"),mask_sync_1=require("./mask-sync"),utils_1=require("./utils"),plugin_1=__importDefault(require("./plugin")),AssetDBPriority={internal:99,assets:98};class AssetDBManager extends events_1.default{constructor(){super(...arguments),this.assetDBMap={},this._hasPause=!1,this.startPause=!1,this.ready=!1,this.state="free",this.assetDBInfo={},this.startupDatabaseQueue=[],this.waitingTaskQueue=[],this.waitingRefreshAsset=[],this.reimportCheck=!1,this.assetBusyTask=new Set}get hasPause(){return this._hasPause}set hasPause(e){this._hasPause=e,Editor.Profile.setTemp("asset-db","hasPause",e)}get isPause(){return this.hasPause||this.startPause}get assetBusy(){return this.assetBusyTask.size>0}get free(){return this.ready&&!this.isPause&&"free"!==this.state&&!this.assetBusy}async start(){console_1.newConsole.trackMemoryStart("asset-db:worker-init: preStart"),Editor.Metrics.trackTimeStart("asset-db:start-database"),await plugin_1.default.runHook("beforePreStart",[this.assetDBInfo]),await this._preStart(),await plugin_1.default.runHook("afterPreStart",[this.assetDBInfo]),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: preStart"),console_1.newConsole.trackMemoryStart("asset-db:worker-init: startup"),await this._startup(),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: startup"),this.ready=!0,await plugin_1.default.runHook("beforeReady"),Editor.Metrics.trackTimeEnd("asset-db:start-database",{output:!0}),Editor.Metrics.trackTimeEnd("asset-db:ready",{output:!0}),Editor.Message.broadcast("asset-db:ready"),await plugin_1.default.runHook("afterReady"),this.step()}async init(e){console_1.newConsole.trackMemoryStart("asset-db:worker-init: initEngine"),await initEngine(e),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: initEngine"),this.refreshDefaultUserData(),Editor.Profile.__protected__.on("change",(e,s,t,a)=>{if("local"===e||"global"===e||"project"===e){const e=plugin_1.default.assetDBProfileMap[`${s}(${t})`];if(e&&this.ready)if(a){const s=plugin_1.default.getAssetDBInfo(e);if(!s)return;this.assetDBInfo[s.name]=patchAssetDBInfo(s),this.startDB(this.assetDBInfo[e],!0)}else this._removeDB(e)}}),await plugin_1.default.init(),await plugin_1.default.runHook("beforeInit",[e]),this.reimportCheck=await Editor.Profile.getConfig("asset-db","flagReimportCheck"),this.assetDBInfo.internal=patchAssetDBInfo({name:"internal",target:(0,path_1.join)(e.engine,"./editor/assets"),readonly:!Editor.App.dev,visible:!0,ignoreGlob:""});const s=await Editor.Profile.getConfig("asset-db","ignoreGlob");this.assetDBInfo.assets=patchAssetDBInfo({name:"assets",target:(0,path_1.join)(Editor.Project.path,"assets"),readonly:!1,visible:!0,ignoreGlob:s});const t=await plugin_1.default.queryAssetDBInfos();plugin_1.default.on("enable",async e=>{const s=await plugin_1.default.queryAssetDBInfo(e);s&&(console.debug(`start custom db ${s.name}...`),this.addDB(s))}),plugin_1.default.on("disable",async e=>{await this._removeDB(e)});for(const e of t)this.assetDBInfo[e.name]=patchAssetDBInfo(e);this.initInfo=e,await plugin_1.default.runHook("afterInit",[e]),this._hasPause=await Editor.Profile.getTemp("asset-db","hasPause"),this.resume()}async _preStart(){const e=Object.keys(this.assetDBInfo).sort((e,s)=>(AssetDBPriority[s]||0)-(AssetDBPriority[e]||0));for(const s of e)await this.startDB(this.assetDBInfo[s],!1)}isBusy(){for(const e in this.assetDBMap){if(!this.assetDBMap[e])continue;if(this.assetDBMap[e].assetProgressInfo.wait>0)return!0}return!1}hasDB(e){return!!this.assetDBMap[e]}async startDB(e,s=!0){this.hasDB(e.name)||(await this._createDB(e),this.ready&&await plugin_1.default.runHook("beforeStartDB",[e]),await this._startDB(e.name,s),this.ready&&await plugin_1.default.runHook("afterStartDB",[e]),Editor.Message.broadcast("asset-db:db-ready",e.name))}async _createDB(e){if(e.target.includes("app.asar")&&Editor.Utils.Path.contains(Editor.App.path,e.target)){const s=e.target.replace("app.asar","app.asar.unpacked");(0,fs_extra_1.existsSync)(s)?e.target=s:console.warn(`[asset-db] The current database address(${e.target}) is in the installation package and may cause problems, please move to the unpack directory`)}(0,fs_extra_1.ensureDirSync)(e.library),(0,fs_extra_1.ensureDirSync)(e.temp),e.flags={reimportCheck:this.reimportCheck};const s=assetdb.create(e);return this.assetDBMap[e.name]=s,await plugin_1.default.registerImporterList(s),s}_registerEventHandler(e){e.on("unresponsive",onUnResPonseive),e.on("add",onAssetAdd),e.on("added",onAssetAdded),e.on("delete",onAssetDelete),e.on("deleted",onAssetDeleted),e.on("change",onAssetChange),e.on("changed",onAssetChanged)}async _startDB(e,s=!0){const t=this.assetDBMap[e];Editor.Metrics.trackTimeStart(`asset-db:worker-startup-database[${t.options.name}]`),console_1.newConsole.trackMemoryStart(`asset-db:worker-startup-database[${t.options.name}]`),this.assetDBInfo[e].state="start",this._registerEventHandler(t);const a=getPreImporterHandler(this.assetDBInfo[e].preImportExtList);a&&(t.preImporterHandler=a);const r={afterScan:afterScan};return(0,fs_extra_1.existsSync)(this.assetDBInfo[e].target)||((0,fs_extra_1.ensureDirSync)(this.assetDBInfo[e].target),s=!0),s?(r.afterPreImport=(async()=>{await afterPreImport(t)}),console.debug(`start asset-db(${e})...`),await t.start({hooks:r}),this.assetDBInfo[e].state="startup",Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${t.options.name}]`,{output:!0}),void console_1.newConsole.trackMemoryEnd(`asset-db:worker-startup-database[${t.options.name}]`)):await new Promise(async s=>{const a={name:t.options.name,afterPreImportResolve:()=>{console.error(`Start database ${e} failed!`),a.finish&&a.finish()}};r.afterPreImport=(async()=>(await afterPreImport(t),console.debug(`Preimport db ${e} success`),s(),new Promise(e=>{a.afterPreImportResolve=e}))),r.afterStart=(()=>{a.finish&&a.finish()}),this.startupDatabaseQueue.push(a),t.start({hooks:r}),this.assetDBInfo[e].state="start"})}async _startup(){for(let e=0;e<this.startupDatabaseQueue.length;e++){const s=this.startupDatabaseQueue[e];console.debug(`Start up the '${s.name}' database...`),Editor.Metrics.trackTimeStart(`asset-db: startup '${s.name}' database...`),await new Promise(async e=>{s.finish=e,s.afterPreImportResolve()}),Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${s.name}]`,{output:!0}),console_1.newConsole.trackMemoryEnd(`asset-db:worker-startup-database[${s.name}]`),this.assetDBInfo[s.name].state="startup";const t=this.assetDBMap[s.name];this.assetDBInfo[s.name].state="startup",t.removeListener("add",onAssetAdd),t.removeListener("change",onAssetChange),t.removeListener("delete",onAssetDelete),Editor.Metrics.trackTimeEnd(`asset-db: startup '${s.name}' database...`)}this.step()}async addDB(e){this.assetDBInfo[e.name]=patchAssetDBInfo(e),await this.startDB(this.assetDBInfo[e.name],!0)}async removeDB(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeDB"})),new Promise(s=>{this._addTaskToQueue({name:"_removeDB",args:[e],resolve:s})})):await this._removeDB(e)}async _operate(e,...s){const t=e+Date.now();e.endsWith("Asset")&&this.assetBusyTask.add(t);try{const a=await this[e](...s);return this.assetBusyTask.delete(t),a}catch(a){console.error(`${e} failed with args: ${s.toString()}`),console.error(a),this.assetBusyTask.delete(t)}}async _removeDB(e){const s=this.assetDBMap[e];if(!s)return;const t=this.assetDBInfo[e];this.ready&&await plugin_1.default.runHook("beforeStopDB",[t]),await s.stop(),this.ready&&await plugin_1.default.runHook("afterStopDB",[t]),delete this.assetDBMap[e],delete this.assetDBInfo[e],Editor.Message.broadcast("asset-db:db-close",e)}async refresh(){if(this.ready)return"free"!==this.state||this.isPause||this.assetBusy?(this.isPause&&console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refresh"})),new Promise(e=>{this._addTaskToQueue({name:"_refresh",args:[],resolve:e})})):await this._refresh()}async _refresh(){this.state="busy",await plugin_1.default.runHook("beforeRefresh"),Editor.Metrics.trackTimeStart("asset-db:refresh-all-database");for(const e in this.assetDBMap){if(!this.assetDBMap[e]){console.debug(`Get assetDB ${e} form manager failed!`);continue}const s=this.assetDBMap[e];await s.refresh(s.options.target,{ignoreSelf:!0,hooks:"assets"===e?{afterPreImport:async()=>{await afterPreImport(s)}}:{}}),console.debug(`refresh db ${e} success`)}Editor.Metrics.trackTimeEnd("asset-db:refresh-all-database",{output:!0}),await plugin_1.default.runHook("afterRefresh"),Editor.Message.broadcast("asset-db:refresh-finish"),this.state="free",this.step()}async reimportAsset(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"reimportAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_reimportAsset",args:[e],resolve:s})})):await this._operate("_reimportAsset",e)}async _reimportAsset(e){e.startsWith("db://")&&(e=(0,utils_1.url2uuid)(e)),Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+e);const s=await assetdb.reimport(e);return Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+e,{output:!0}),this.step(),s}async refreshAsset(e){return this.isPause||!this.ready?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_refreshAsset",args:[e],resolve:s})})):await this._operate("_refreshAsset",e)}async _refreshAsset(e,s=!0){console.debug(`start refresh asset from ${e}...`);const t=await assetdb.refresh(e);return s&&this.waitingTaskQueue.push({name:"autoRefreshAssetLazy",args:[(0,path_1.dirname)(e)]}),console.debug(`refresh asset ${(0,path_1.dirname)(e)} success`),this.step(),t}async moveAsset(e,s,t){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(t=>{this._addTaskToQueue({name:"moveAsset",args:[e,s],resolve:t})})):await this._operate("_moveAsset",e,s,t)}async _moveAsset(e,s,t){console.debug(`start move asset from ${e} -> ${s}...`),(0,fs_extra_1.existsSync)(s)&&(null===t||void 0===t?void 0:t.overwrite)&&await this._removeAsset(s),await(0,utils_1.moveFile)(e,s,t);const a=assetdb.queryUrl(s),r=/db:\/\/[^/]+/.exec(a);r&&r[0]&&a.startsWith(r[0])?(await this.refreshAsset(s),await this.refreshAsset((0,path_1.dirname)(e))):(await this.refreshAsset(e),await this.refreshAsset(s)),console.debug(`move asset from ${e} -> ${s} success`),this.step()}async renameAsset(e,s,t){if(this.isPause||"busy"===this.state)return console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"renameAsset"})),new Promise(t=>{this._addTaskToQueue({name:"_renameAsset",args:[e,s],resolve:t})});await this._renameAsset(e,s)}async _renameAsset(e,s,t){console.debug(`start rename asset from ${e} -> ${s}...`);const a={basename:(0,path_1.basename)(s),dirname:(0,path_1.dirname)(s)},r=(0,path_1.join)(a.dirname,".rename_temp");await(0,fs_extra_1.rename)(e+".meta",r+".meta"),await(0,fs_extra_1.rename)(e,r),await this._refreshAsset(e,!1),await(0,fs_extra_1.rename)(r+".meta",s+".meta"),await(0,fs_extra_1.rename)(r,s),await this._refreshAsset(s),console.debug(`rename asset from ${e} -> ${s} success`),this.step()}async removeAsset(e){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_removeAsset",args:[e],resolve:s})})):await this._operate("_removeAsset",e)}async _removeAsset(e){const s="_removeAsset"+Date.now();this.assetBusyTask.add(s),console.debug(`start remove asset ${e}...`);let t=!1;try{await(0,utils_1.removeFile)(e),await this.refreshAsset(e),t=!0,console.debug(`remove asset ${e} success`)}catch(e){console.warn(`${Editor.I18n.t("asset-db.deleteAsset.fail.unknown")}`),console.warn(e)}return this.assetBusyTask.delete(s),this.step(),t}async autoRefreshAssetLazy(e){return this.waitingRefreshAsset.includes(e)||this.waitingRefreshAsset.push(e),this.autoRefreshTimmer&&clearTimeout(this.autoRefreshTimmer),new Promise(e=>{this.autoRefreshTimmer=setTimeout(async()=>{const s="autoRefreshAssetLazy"+Date.now();this.assetBusyTask.add(s);const t=JSON.parse(JSON.stringify(this.waitingRefreshAsset));this.waitingRefreshAsset.length=0,await Promise.all(t.map(e=>assetdb.refresh(e))),this.assetBusyTask.delete(s),this.step(),e(!0)},100)})}async resume(){(this.hasPause||this.startPause)&&(this.hasPause=!1,this.startPause=!1,Editor.Message.broadcast("asset-db:resume"),console_1.newConsole.record(),console.log("Asset DB is resume!"),await this.step())}_addTaskToQueue(e){const s=this.waitingTaskQueue[this.waitingTaskQueue.length-1],t={name:e.name,args:e.args};return e.resolve&&(t.resolves=[e.resolve]),s?s.name!==t.name||t.args.toString()!==s.args.toString()?(this.waitingTaskQueue.push(t),void this.step()):void(e.resolve&&(s.resolves?s.resolves.push(e.resolve):s.resolves=t.resolves,this.step())):(this.waitingTaskQueue.push(t),void this.step())}async step(){if(this.startPause&&this.waitPauseHandle&&(this.waitPauseHandle(!0),this.waitPauseHandle=void 0),this.isPause||!this.waitingTaskQueue.length||"busy"===this.state)return;let e=Array.from(this.waitingTaskQueue);const s=[];e=e.filter(e=>!(this.assetBusy&&(!this.assetBusy||"_refresh"===e.name))||(s.push(e),!1)),this.waitingTaskQueue=s;for(let s=0;s<e.length;s++){const t=e[s];try{if("_refresh"===t.name&&this.assetBusy){this.waitingTaskQueue.push(t);continue}const e=await this._operate(t.name,...t.args);if(!t.resolves)return;t.resolves.forEach(s=>s(e))}catch(e){console.warn(e)}}}async pause(e="unkown"){return this.startPause=!0,this.isBusy()?this.hasPause?(this.waitPausePromiseTask=new Promise(s=>{this.waitPauseHandle=(()=>{this.waitPausePromiseTask=void 0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),console_1.newConsole.stopRecord(),this.hasPause=!0,console_1.newConsole.stopRecord(),s(!0)})}),setTimeout(()=>{this.waitPausePromiseTask&&(0,utils_1.decidePromiseState)(this.waitPausePromiseTask).then(s=>{s===utils_1.PROMISE_STATE.PENDING&&(this.hasPause=!0,Editor.Message.broadcast("asset-db:pause",e),this.waitPauseHandle(),console.debug("Pause asset db time out"))})},12e4),this.waitPausePromiseTask):this.waitPausePromiseTask:(this.hasPause=!0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),!0)}refreshDefaultUserData(){try{const e=(0,path_1.join)(Editor.Project.path,".creator","default-meta.json");if((0,fs_extra_1.existsSync)(e)){const s=(0,fs_extra_1.readJSONSync)(e);for(const e in s)assetdb.setDefaultUserData(e,s[e])}}catch(e){console.error(e)}}}function patchAssetDBInfo(e){return{name:e.name,target:Editor.Utils.Path.normalize(e.target),readonly:!!e.readonly,temp:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"temp/asset-db",e.name)),library:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"library")),level:4,ignoreGlob:e.ignoreGlob,ignoreFiles:[".DS_Store",".rename_temp"],visible:e.visible,state:"none",preImportExtList:e.preImportExtList||[]}}async function onAssetAdded(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-add",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetAdded)(e)}async function onAssetAdd(e){(0,mask_sync_1.assetAdd)(e)}async function onAssetChanged(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-change",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetChanged)(e)}function onAssetChange(e){(0,mask_sync_1.assetChange)(e)}async function onAssetDeleted(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-delete",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetDeleted)(e)}function onAssetDelete(e){(0,mask_sync_1.assetDeleted)(e)}async function onUnResPonseive(e,s){if(exports.assetDBManager.ready){1===(await Editor.Dialog.info(`Resource import Timeout.\n  uuid: ${e.uuid}\n  url: ${e.url}`,{buttons:["Waiting","Interrupt"]})).response&&s.reject("User interrupt")}else console.debug("import asset unresponsive")}exports.assetDBManager=new AssetDBManager;const layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function initEngine(e){window.CC_PREVIEW=!1,Editor.Metrics.trackTimeStart("asset-db:require-engine-code"),Editor.Task.__protected__.updateSyncTask("import-asset","preload cc engine ...");const{default:s}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await s({requiredModules:["cc","cc/editor/populate-internal-constants","cc/editor/serialization","cc/editor/animation-clip-migration","cc/editor/exotic-animation","cc/editor/new-gen-anim","cc/editor/offline-mappings","cc/editor/embedded-player","cc/editor/color-utils","cc/editor/custom-pipeline"]}),Editor.Metrics.trackTimeEnd("asset-db:require-engine-code",{output:!0});const t=await Editor.Profile.getProject("engine","modules.includeModules");let a="";const r=["physics-cannon","physics-ammo","physics-builtin","physics-physx"];for(let e=0;e<r.length;e++)if(t.indexOf(r[e])>=0){a=r[e];break}const i=await Editor.Profile.getProject("project","physics"),o=await Editor.Profile.getProject("engine","macroConfig"),n=await Editor.Profile.getProject("project","layer"),u=await Editor.Profile.getProject("project","sorting-layer")||{},d=n.map(e=>{const s=layerMask.findIndex(s=>e.value===s);return{name:e.name,bit:s}}),c=u.layers||[],h=await Editor.Profile.getProject("project","general.highQuality"),l={debugMode:cc.debug.DebugMode.WARN,overrideSettings:{engine:{builtinAssets:[],macros:o,sortingLayers:c,customLayers:d},profiling:{showFPS:!1},screen:{frameRate:30,exactFitScreen:!0},rendering:{renderMode:3,highQualityMode:h},physics:Object.assign(Object.assign({},i),{physicsEngine:a,enabled:!1}),assets:{importBase:(0,path_1.join)(Editor.Project.path,"library"),nativeBase:(0,path_1.join)(Editor.Project.path,"library")}},exactFitScreen:!0};cc.physics.selector.runInEditor=!0,await cc.game.init(l),Editor.Task.__protected__.updateSyncTask("import-asset","init engine success")}function getPreImporterHandler(e){return e&&e.length?function(s){const t=(0,path_1.extname)(s);return!t||e.includes(t)}:null}const afterScan=async function(e){let s=0,t=0,a=0;for(let r=0;r<e.length;r++){const i=e[r],o=(0,path_1.extname)(i);o?".chunk"===o?(e.splice(r,1),e.splice(s+t,0,i),t+=1):".effect"===o&&(e.splice(r,1),e.splice(s+t+a,0,i),a+=1):(e.splice(r,1),e.splice(s,0,i),s+=1)}};async function afterPreImport(e){e.taskManager.start(),await e.taskManager.waitQueue(),e.taskManager.stop()}