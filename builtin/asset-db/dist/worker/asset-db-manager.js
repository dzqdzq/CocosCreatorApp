"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,r)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetDBManager=void 0;const assetdb=__importStar(require("@editor/asset-db")),events_1=__importDefault(require("events")),fs_extra_1=require("fs-extra"),path_1=require("path"),console_1=require("./console"),mask_sync_1=require("./mask-sync"),utils_1=require("./utils"),plugin_1=__importDefault(require("./plugin")),AssetDBPriority={internal:99,assets:98};class AssetDBManager extends events_1.default{constructor(){super(...arguments),this.assetDBMap={},this.hasPause=!1,this.startPause=!1,this.ready=!1,this.state="free",this.assetDBInfo={},this.startupDatabaseQueue=[],this.waitingTaskQueue=[],this.waitingRefreshAsset=[],this.reimportCheck=!1,this.assetBusyTask=new Set}get isPause(){return this.hasPause||this.startPause}get assetBusy(){return this.assetBusyTask.size>0}get free(){return this.ready&&!this.isPause&&"free"!==this.state&&!this.assetBusy}async start(){console_1.newConsole.trackMemoryStart("asset-db:worker-init: preStart"),Editor.Metrics.trackTimeStart("asset-db:start-database"),await plugin_1.default.runHook("beforePreStart",[this.assetDBInfo]),await this._preStart(),await plugin_1.default.runHook("afterPreStart",[this.assetDBInfo]),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: preStart"),console_1.newConsole.trackMemoryStart("asset-db:worker-init: startup"),await this._startup(),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: startup"),this.ready=!0,await plugin_1.default.runHook("beforeReady"),Editor.Metrics.trackTimeEnd("asset-db:start-database",{output:!0}),Editor.Metrics.trackTimeEnd("asset-db:ready",{output:!0}),Editor.Message.broadcast("asset-db:ready"),await plugin_1.default.runHook("afterReady"),this.step()}async init(e){console_1.newConsole.trackMemoryStart("asset-db:worker-init: initEngine"),await initEngine(e),console_1.newConsole.trackMemoryEnd("asset-db:worker-init: initEngine"),this.refreshDefaultUserData(),Editor.Profile.__protected__.on("change",(e,t,s,a)=>{if("local"===e||"global"===e||"project"===e){const e=plugin_1.default.assetDBProfileMap[`${t}(${s})`];if(e&&this.ready)if(a){const t=plugin_1.default.getAssetDBInfo(e);if(!t)return;this.assetDBInfo[t.name]=patchAssetDBInfo(t),this.startDB(this.assetDBInfo[e],!0)}else this._removeDB(e)}}),await plugin_1.default.init(),await plugin_1.default.runHook("beforeInit",[e]),this.reimportCheck=await Editor.Profile.getConfig("asset-db","flagReimportCheck"),this.assetDBInfo.internal=patchAssetDBInfo({name:"internal",target:(0,path_1.join)(e.engine,"./editor/assets"),readonly:!Editor.App.dev,visible:!0,ignoreGlob:""});const t=await Editor.Profile.getConfig("asset-db","ignoreGlob");this.assetDBInfo.assets=patchAssetDBInfo({name:"assets",target:(0,path_1.join)(Editor.Project.path,"assets"),readonly:!1,visible:!0,ignoreGlob:t});const s=await plugin_1.default.queryAssetDBInfos();plugin_1.default.on("enable",async e=>{const t=await plugin_1.default.queryAssetDBInfo(e);t&&(this.assetDBInfo[t.name]=patchAssetDBInfo(t),console.debug(`start custom db ${t.name}...`),await this.startDB(this.assetDBInfo[e],!0))}),plugin_1.default.on("disable",async e=>{await this._removeDB(e)});for(const e of s)this.assetDBInfo[e.name]=patchAssetDBInfo(e);this.initInfo=e,await plugin_1.default.runHook("afterInit",[e])}async _preStart(){const e=Object.keys(this.assetDBInfo).sort((e,t)=>(AssetDBPriority[t]||0)-(AssetDBPriority[e]||0));for(const t of e)await this.startDB(this.assetDBInfo[t],!1)}isBusy(){for(const e in this.assetDBMap){if(!this.assetDBMap[e])continue;if(this.assetDBMap[e].assetProgressInfo.wait>0)return!0}return!1}hasDB(e){return!!this.assetDBMap[e]}async startDB(e,t=!0){this.hasDB(e.name)||(await this._createDB(e),this.ready&&await plugin_1.default.runHook("beforeStartDB",[e]),await this._startDB(e.name,t),this.ready&&await plugin_1.default.runHook("afterStartDB",[e]),Editor.Message.broadcast("asset-db:db-ready",e.name))}async _createDB(e){if(e.target.includes("app.asar")&&Editor.Utils.Path.contains(Editor.App.path,e.target)){const t=e.target.replace("app.asar","app.asar.unpacked");(0,fs_extra_1.existsSync)(t)?e.target=t:console.warn(`[asset-db] The current database address(${e.target}) is in the installation package and may cause problems, please move to the unpack directory`)}(0,fs_extra_1.ensureDirSync)(e.library),(0,fs_extra_1.ensureDirSync)(e.temp),e.flags={reimportCheck:this.reimportCheck};const t=assetdb.create(e);return this.assetDBMap[e.name]=t,await plugin_1.default.registerImporterList(t),t}_registerEventHandler(e){e.on("unresponsive",onUnResPonseive),e.on("add",onAssetAdd),e.on("added",onAssetAdded),e.on("delete",onAssetDelete),e.on("deleted",onAssetDeleted),e.on("change",onAssetChange),e.on("changed",onAssetChanged)}async _startDB(e,t=!0){const s=this.assetDBMap[e];Editor.Metrics.trackTimeStart(`asset-db:worker-startup-database[${s.options.name}]`),console_1.newConsole.trackMemoryStart(`asset-db:worker-startup-database[${s.options.name}]`),this.assetDBInfo[e].state="start",this._registerEventHandler(s);const a=getPreImporterHandler(this.assetDBInfo[e].preImportExtList);a&&(s.preImporterHandler=a);const r={afterScan:afterScan};return(0,fs_extra_1.existsSync)(this.assetDBInfo[e].target)||((0,fs_extra_1.ensureDirSync)(this.assetDBInfo[e].target),t=!0),t?(r.afterPreImport=(async()=>{await afterPreImport(s)}),console.debug(`start asset-db(${e})...`),await s.start({hooks:r}),this.assetDBInfo[e].state="startup",Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${s.options.name}]`,{output:!0}),void console_1.newConsole.trackMemoryEnd(`asset-db:worker-startup-database[${s.options.name}]`)):await new Promise(async t=>{const a={name:s.options.name,afterPreImportResolve:()=>{console.error(`Start database ${e} failed!`),a.finish&&a.finish()}};r.afterPreImport=(async()=>(await afterPreImport(s),console.debug(`Preimport db ${e} success`),t(),new Promise(e=>{a.afterPreImportResolve=e}))),r.afterStart=(()=>{a.finish&&a.finish()}),this.startupDatabaseQueue.push(a),s.start({hooks:r}),this.assetDBInfo[e].state="start"})}async _startup(){for(let e=0;e<this.startupDatabaseQueue.length;e++){const t=this.startupDatabaseQueue[e];console.debug(`Start up the '${t.name}' database...`),Editor.Metrics.trackTimeStart(`asset-db: startup '${t.name}' database...`),await new Promise(async e=>{t.finish=e,t.afterPreImportResolve()}),Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${t.name}]`,{output:!0}),console_1.newConsole.trackMemoryEnd(`asset-db:worker-startup-database[${t.name}]`),this.assetDBInfo[t.name].state="startup";const s=this.assetDBMap[t.name];this.assetDBInfo[t.name].state="startup",s.removeListener("add",onAssetAdd),s.removeListener("change",onAssetChange),s.removeListener("delete",onAssetDelete),Editor.Metrics.trackTimeEnd(`asset-db: startup '${t.name}' database...`)}this.step()}async removeDB(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeDB"})),new Promise(t=>{this._addTaskToQueue({name:"_removeDB",args:[e],resolve:t})})):await this._removeDB(e)}async _operate(e,...t){const s=e+Date.now();e.endsWith("Asset")&&this.assetBusyTask.add(s);try{const a=await this[e](...t);return this.assetBusyTask.delete(s),a}catch(a){console.error(`${e} failed with args: ${t.toString()}`),console.error(a),this.assetBusyTask.delete(s)}}async _removeDB(e){const t=this.assetDBMap[e];if(!t)return;const s=this.assetDBInfo[e];this.ready&&await plugin_1.default.runHook("beforeStopDB",[s]),await t.stop(),this.ready&&await plugin_1.default.runHook("afterStopDB",[s]),delete this.assetDBMap[e],delete this.assetDBInfo[e],Editor.Message.broadcast("asset-db:db-close",e)}async refresh(){if(this.ready)return"free"!==this.state||this.isPause||this.assetBusy?(this.isPause&&console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refresh"})),new Promise(e=>{this._addTaskToQueue({name:"_refresh",args:[],resolve:e})})):await this._refresh()}async _refresh(){this.state="busy",await plugin_1.default.runHook("beforeRefresh"),Editor.Metrics.trackTimeStart("asset-db:refresh-all-database");for(const e in this.assetDBMap){if(!this.assetDBMap[e]){console.debug(`Get assetDB ${e} form manager failed!`);continue}const t=this.assetDBMap[e];await t.refresh(t.options.target,{ignoreSelf:!0,hooks:"assets"===e?{afterPreImport:async()=>{await afterPreImport(t)}}:{}}),console.debug(`refresh db ${e} success`)}Editor.Metrics.trackTimeEnd("asset-db:refresh-all-database",{output:!0}),await plugin_1.default.runHook("afterRefresh"),Editor.Message.broadcast("asset-db:refresh-finish"),this.state="free",this.step()}async reimportAsset(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"reimportAsset"})),new Promise(t=>{this._addTaskToQueue({name:"_reimportAsset",args:[e],resolve:t})})):await this._operate("_reimportAsset",e)}async _reimportAsset(e){e.startsWith("db://")&&(e=(0,utils_1.url2uuid)(e)),Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+e);const t=await assetdb.reimport(e);return Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+e,{output:!0}),this.step(),t}async refreshAsset(e){return this.isPause||!this.ready?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(t=>{this._addTaskToQueue({name:"_refreshAsset",args:[e],resolve:t})})):await this._operate("_refreshAsset",e)}async _refreshAsset(e,t=!0){console.debug(`start refresh asset from ${e}...`);const s=await assetdb.refresh(e);return t&&this.waitingTaskQueue.push({name:"autoRefreshAssetLazy",args:[(0,path_1.dirname)(e)]}),console.debug(`refresh asset ${(0,path_1.dirname)(e)} success`),this.step(),s}async moveAsset(e,t,s){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(s=>{this._addTaskToQueue({name:"moveAsset",args:[e,t],resolve:s})})):await this._operate("_moveAsset",e,t,s)}async _moveAsset(e,t,s){console.debug(`start move asset from ${e} -> ${t}...`),await(0,utils_1.moveFile)(e,t,s);const a=assetdb.queryUrl(t),r=/db:\/\/[^/]+/.exec(a);r&&r[0]&&a.startsWith(r[0])?(await this.refreshAsset(t),await this.refreshAsset((0,path_1.dirname)(e))):(await this.refreshAsset(e),await this.refreshAsset(t)),console.debug(`move asset from ${e} -> ${t} success`),this.step()}async renameAsset(e,t,s){if(this.isPause||"busy"===this.state)return console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"renameAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_renameAsset",args:[e,t],resolve:s})});await this._renameAsset(e,t)}async _renameAsset(e,t,s){console.debug(`start rename asset from ${e} -> ${t}...`);const a={basename:(0,path_1.basename)(t),dirname:(0,path_1.dirname)(t)},r=(0,path_1.join)(a.dirname,".rename_temp");await(0,fs_extra_1.rename)(e+".meta",r+".meta"),await(0,fs_extra_1.rename)(e,r),await this._refreshAsset(e,!1),await(0,fs_extra_1.rename)(r+".meta",t+".meta"),await(0,fs_extra_1.rename)(r,t),await this._refreshAsset(t),console.debug(`rename asset from ${e} -> ${t} success`),this.step()}async removeAsset(e){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeAsset"})),new Promise(t=>{this._addTaskToQueue({name:"_removeAsset",args:[e],resolve:t})})):await this._operate("_removeAsset",e)}async _removeAsset(e){const t="_removeAsset"+Date.now();this.assetBusyTask.add(t),console.debug(`start remove asset ${e}...`);let s=!1;try{await(0,utils_1.removeFile)(e),await this.refreshAsset(e),s=!0,console.debug(`remove asset ${e} success`)}catch(e){console.warn(`${Editor.I18n.t("asset-db.deleteAsset.fail.unknown")}`),console.warn(e)}return this.assetBusyTask.delete(t),this.step(),s}async autoRefreshAssetLazy(e){return this.waitingRefreshAsset.includes(e)||this.waitingRefreshAsset.push(e),this.autoRefreshTimmer&&clearTimeout(this.autoRefreshTimmer),new Promise(e=>{this.autoRefreshTimmer=setTimeout(async()=>{const t="autoRefreshAssetLazy"+Date.now();this.assetBusyTask.add(t);const s=JSON.parse(JSON.stringify(this.waitingRefreshAsset));this.waitingRefreshAsset.length=0,await Promise.all(s.map(e=>assetdb.refresh(e))),this.assetBusyTask.delete(t),this.step(),e(!0)},100)})}async resume(){(this.hasPause||this.startPause)&&(this.hasPause=!1,this.startPause=!1,Editor.Message.broadcast("asset-db:resume"),console_1.newConsole.record(),console.log("Asset DB is resume!"),await this.step())}_addTaskToQueue(e){const t=this.waitingTaskQueue[this.waitingTaskQueue.length-1],s={name:e.name,args:e.args};return e.resolve&&(s.resolves=[e.resolve]),t?t.name!==s.name||s.args.toString()!==t.args.toString()?(this.waitingTaskQueue.push(s),void this.step()):void(e.resolve&&(t.resolves?t.resolves.push(e.resolve):t.resolves=s.resolves,this.step())):(this.waitingTaskQueue.push(s),void this.step())}async step(){if(this.startPause&&this.waitPauseHandle&&(this.waitPauseHandle(!0),this.waitPauseHandle=void 0),this.isPause||!this.waitingTaskQueue.length||"busy"===this.state)return;let e=Array.from(this.waitingTaskQueue);const t=[];e=e.filter(e=>!(this.assetBusy&&(!this.assetBusy||"_refresh"===e.name))||(t.push(e),!1)),this.waitingTaskQueue=t;for(let t=0;t<e.length;t++){const s=e[t];try{if("_refresh"===s.name&&this.assetBusy){this.waitingTaskQueue.push(s);continue}const e=await this._operate(s.name,...s.args);if(!s.resolves)return;s.resolves.forEach(t=>t(e))}catch(e){console.warn(e)}}}async pause(e="unkown"){return this.startPause=!0,this.isBusy()?this.hasPause?(this.waitPausePromiseTask=new Promise(t=>{this.waitPauseHandle=(()=>{this.waitPausePromiseTask=void 0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),console_1.newConsole.stopRecord(),this.hasPause=!0,console_1.newConsole.stopRecord(),t(!0)})}),setTimeout(()=>{this.waitPausePromiseTask&&(0,utils_1.decidePromiseState)(this.waitPausePromiseTask).then(t=>{t===utils_1.PROMISE_STATE.PENDING&&(this.hasPause=!0,Editor.Message.broadcast("asset-db:pause",e),this.waitPauseHandle(),console.debug("Pause asset db time out"))})},12e4),this.waitPausePromiseTask):this.waitPausePromiseTask:(this.hasPause=!0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),!0)}refreshDefaultUserData(){try{const e=(0,path_1.join)(Editor.Project.path,".creator","default-meta.json");if((0,fs_extra_1.existsSync)(e)){const t=(0,fs_extra_1.readJSONSync)(e);for(const e in t)assetdb.setDefaultUserData(e,t[e])}}catch(e){console.error(e)}}}function patchAssetDBInfo(e){return{name:e.name,target:Editor.Utils.Path.normalize(e.target),readonly:!!e.readonly,temp:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"temp/asset-db",e.name)),library:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"library")),level:4,ignoreGlob:e.ignoreGlob,ignoreFiles:[".DS_Store",".rename_temp"],visible:e.visible,state:"none",preImportExtList:e.preImportExtList||[]}}async function onAssetAdded(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-add",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetAdded)(e)}async function onAssetAdd(e){(0,mask_sync_1.assetAdd)(e)}async function onAssetChanged(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-change",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetChanged)(e)}function onAssetChange(e){(0,mask_sync_1.assetChange)(e)}async function onAssetDeleted(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-delete",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetDeleted)(e)}function onAssetDelete(e){(0,mask_sync_1.assetDeleted)(e)}async function onUnResPonseive(e,t){if(exports.assetDBManager.ready){1===(await Editor.Dialog.info(`Resource import Timeout.\n  uuid: ${e.uuid}\n  url: ${e.url}`,{buttons:["Waiting","Interrupt"]})).response&&t.reject("User interrupt")}else console.debug("import asset unresponsive")}exports.assetDBManager=new AssetDBManager;const layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function initEngine(e){window.CC_PREVIEW=!1,Editor.Metrics.trackTimeStart("asset-db:require-engine-code"),Editor.Task.__protected__.updateSyncTask("import-asset","preload cc engine ...");const{default:t}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await t({requiredModules:["cc","cc/editor/populate-internal-constants","cc/editor/serialization","cc/editor/animation-clip-migration","cc/editor/exotic-animation","cc/editor/new-gen-anim","cc/editor/offline-mappings","cc/editor/embedded-player","cc/editor/color-utils","cc/editor/custom-pipeline"]}),Editor.Metrics.trackTimeEnd("asset-db:require-engine-code",{output:!0});const s=await Editor.Profile.getProject("engine","modules.includeModules");let a="";const r=["physics-cannon","physics-ammo","physics-builtin","physics-physx"];for(let e=0;e<r.length;e++)if(s.indexOf(r[e])>=0){a=r[e];break}const i=await Editor.Profile.getProject("project","physics"),o=await Editor.Profile.getProject("engine","macroConfig"),n=await Editor.Profile.getProject("project","layer"),u=await Editor.Profile.getProject("project","sorting-layer")||{},d=n.map(e=>{const t=layerMask.findIndex(t=>e.value===t);return{name:e.name,bit:t}}),c=u.layers||[],h=await Editor.Profile.getProject("project","general.highQuality"),l={debugMode:cc.debug.DebugMode.WARN,overrideSettings:{engine:{builtinAssets:[],macros:o,sortingLayers:c,customLayers:d},profiling:{showFPS:!1},screen:{frameRate:30,exactFitScreen:!0},rendering:{renderMode:3,highQualityMode:h},physics:Object.assign(Object.assign({},i),{physicsEngine:a,enabled:!1}),assets:{importBase:(0,path_1.join)(Editor.Project.path,"library"),nativeBase:(0,path_1.join)(Editor.Project.path,"library")}},exactFitScreen:!0};cc.physics.selector.runInEditor=!0,await cc.game.init(l),Editor.Task.__protected__.updateSyncTask("import-asset","init engine success")}function getPreImporterHandler(e){return e&&e.length?function(t){const s=(0,path_1.extname)(t);return!s||e.includes(s)}:null}const afterScan=async function(e){let t=0,s=0,a=0;for(let r=0;r<e.length;r++){const i=e[r],o=(0,path_1.extname)(i);o?".chunk"===o?(e.splice(r,1),e.splice(t+s,0,i),s+=1):".effect"===o&&(e.splice(r,1),e.splice(t+s+a,0,i),a+=1):(e.splice(r,1),e.splice(t,0,i),t+=1)}};async function afterPreImport(e){e.taskManager.start(),await e.taskManager.waitQueue(),e.taskManager.stop()}