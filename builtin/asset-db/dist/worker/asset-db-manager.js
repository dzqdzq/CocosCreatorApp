"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,a){void 0===a&&(a=t);var r=Object.getOwnPropertyDescriptor(s,t);r&&("get"in r?s.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,a,r)}:function(e,s,t,a){void 0===a&&(a=t),e[a]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.effectDataProcessing=exports.assetDBManager=void 0;const assetdb=__importStar(require("@editor/asset-db")),events_1=__importDefault(require("events")),fs_extra_1=require("fs-extra"),path_1=require("path"),console_1=require("./console"),mask_sync_1=require("./mask-sync"),utils_1=require("./utils"),lodash=require("lodash");class AssetDBManager extends events_1.default{constructor(){super(...arguments),this.assetDBMap={},this.hasPause=!1,this.startPause=!1,this.ready=!1,this.state="free",this.asetDBInfo={},this.startupDatabaseQueue=[],this.waitingTaskQueue=[],this.waitingRefreshAsset=[],this.assetBusy=!1}get isPause(){return this.hasPause||this.startPause}get free(){return this.ready&&!this.isPause&&"free"!==this.state&&!this.assetBusy}async init(e){await initEngine(e),this.refreshDefaultUserData(),await console_1.newConsole.initLogFiles(),console_1.newConsole.record()}isBusy(){for(const e in this.assetDBMap){if(!this.assetDBMap[e])continue;if(this.assetDBMap[e].assetProgressInfo.wait>0)return!0}return!1}hasDB(e){return!!this.assetDBMap[e]}createDB(e){return(0,fs_extra_1.existsSync)(e.target)||(e.target=e.target&&e.target.replace("app.asar","app.asar.unpacked"),(0,fs_extra_1.ensureDirSync)(e.target)),(0,fs_extra_1.ensureDirSync)(e.library),(0,fs_extra_1.ensureDirSync)(e.temp),this.assetDBMap[e.name]=assetdb.create(e),Manager.AssetWorker[e.name]=this.assetDBMap[e.name],this.asetDBInfo[e.name]=Object.assign(Object.assign({},e),{state:"none"}),this.assetDBMap[e.name]}_registerEventHandler(e){e.on("unresponsive",onUnResPonseive),e.on("add",onAssetAdd),e.on("added",onAssetAdded),e.on("delete",onAssetDelete),e.on("deleted",onAssetDeleted),e.on("change",onAssetChange),e.on("changed",onAssetChanged)}async startDB(e,s=!0){Editor.Metrics.trackTimeStart(`asset-db:worker-startup-database[${e}]`),this.asetDBInfo[e].state="start";const t=this.assetDBMap[e];this._registerEventHandler(t),t.preImporterHandler=preImporterHandler;const a={afterScan:afterScan};return s?(a.afterPreImport=(async()=>{await afterPreImport(t),await effectDataProcessing()}),await t.start({hooks:a}),this.asetDBInfo[e].state="startup",void Editor.Metrics.trackTimeEnd(`asset-db:worker-startup-database[${t.options.name}]`,{output:!0})):await new Promise(async s=>{const r={name:t.options.name,afterPreImportResolve:()=>{console.error(`Start database ${e} failed!`),r.finish&&r.finish()}};a.afterPreImport=(async()=>(await afterPreImport(t),console.debug(`Preimport db ${e} success`),s(),new Promise(e=>{r.afterPreImportResolve=e}))),a.afterRefresh=(()=>{r.finish&&r.finish()}),this.startupDatabaseQueue.push(r),t.start({hooks:a}),this.asetDBInfo[e].state="start"})}async startup(){for(let e=0;e<this.startupDatabaseQueue.length;e++){const s=this.startupDatabaseQueue[e];console.debug(`Start up the '${s.name}' database...`),Editor.Metrics.trackTimeStart(`asset-db: startup '${s.name}' database...`),await new Promise(e=>{s.finish=e,s.afterPreImportResolve()}),this.asetDBInfo[s.name].state="startup";const t=this.assetDBMap[s.name];t.removeListener("add",onAssetAdd),t.removeListener("change",onAssetChange),t.removeListener("delete",onAssetDelete),Editor.Metrics.trackTimeEnd(`asset-db: startup '${s.name}' database...`)}this.ready=!0,this.step()}async removeDB(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeDB"})),new Promise(s=>{this._addTaskToQueue({name:"_removeDB",args:[e],resolve:s})})):await this._removeDB(e)}async _removeDB(e){const s=this.assetDBMap[e];s&&(await s.stop(),delete this.assetDBMap[e],delete Manager.AssetWorker[e])}async refresh(){if(this.ready)return"free"!==this.state||this.isPause||this.assetBusy?(this.isPause&&console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refresh"})),new Promise(e=>{this._addTaskToQueue({name:"_refresh",args:[],resolve:e})})):await this._refresh()}async _refresh(){this.state="busy",Editor.Metrics.trackTimeStart("asset-db:refresh-all-database");for(const e in this.assetDBMap){if(!this.assetDBMap[e]){console.debug(`Get assetDB ${e} form manager failed!`);continue}const s=this.assetDBMap[e];await s.refresh(s.options.target,{ignoreSelf:!0,hooks:"assets"===e?{afterPreImport:async()=>{await afterPreImport(s),await effectDataProcessing()}}:{}}),console.debug(`refresh db ${e} success`)}Editor.Metrics.trackTimeEnd("asset-db:refresh-all-database",{output:!0}),Editor.Message.broadcast("asset-db:refresh-finish"),this.state="free",this.step()}async reimportAsset(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"reimportAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_reimportAsset",args:[e],resolve:s})})):await this._reimportAsset(e)}async _reimportAsset(e){this.assetBusy=!0,Editor.Metrics.trackTimeStart("asset-db:reimport-asset"+e);const s=await assetdb.reimport(e);return Editor.Metrics.trackTimeEnd("asset-db:reimport-asset"+e,{output:!0}),this.step(),s}async refreshAsset(e){return this.isPause?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_refreshAsset",args:[e],resolve:s})})):await this._refreshAsset(e)}async _refreshAsset(e){console.debug(`start refresh asset from ${e}...`),this.assetBusy=!0;const s=await assetdb.refresh(e);return this.waitingTaskQueue.push({name:"autoRefreshAssetLazy",args:[e]}),console.debug(`refresh asset ${e} success`),this.step(),s}async moveAsset(e,s,t){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"refreshAsset"})),new Promise(t=>{this._addTaskToQueue({name:"moveAsset",args:[e,s],resolve:t})})):await this._moveAsset(e,s,t)}async _moveAsset(e,s,t){console.debug(`start move asset from ${e} -> ${s}...`),this.assetBusy=!0,await(0,utils_1.moveFile)(e,s,t);const a=assetdb.queryUrl(s),r=/db:\/\/[^/]+/.exec(a);r&&r[0]&&a.startsWith(r[0])?(await this.refreshAsset(s),await this.refreshAsset((0,path_1.dirname)(e))):(await this.refreshAsset(e),await this.refreshAsset(s)),console.debug(`move asset from ${e} -> ${s} success`)}async renameAsset(e,s){if(this.isPause||"busy"===this.state)return console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"renameAsset"})),new Promise(t=>{this._addTaskToQueue({name:"_renameAsset",args:[e,s],resolve:t})});await this._renameAsset(e,s)}async _renameAsset(e,s){console.debug(`start rename asset from ${e} -> ${s}...`),this.assetBusy=!0;const t={basename:(0,path_1.basename)(s),dirname:(0,path_1.dirname)(s)},a=(0,path_1.join)(t.dirname,".rename_temp");await(0,fs_extra_1.rename)(e+".meta",a+".meta"),await(0,fs_extra_1.rename)(e,a),await this.refreshAsset(e),await(0,fs_extra_1.rename)(a+".meta",s+".meta"),await(0,fs_extra_1.rename)(a,s),await this.refreshAsset(s),console.debug(`rename asset from ${e} -> ${s} success`)}async removeAsset(e){return this.isPause||"busy"===this.state?(console.log(Editor.I18n.t("asset-db.assetDBPauseTips",{operate:"removeAsset"})),new Promise(s=>{this._addTaskToQueue({name:"_removeAsset",args:[e],resolve:s})})):await this._removeAsset(e)}async _removeAsset(e){this.assetBusy=!0,console.debug(`start remove asset ${e}...`);try{return await(0,utils_1.removeFile)(e),await this.refreshAsset(e),console.debug(`remove asset ${e} success`),!0}catch(e){return console.warn(`${Editor.I18n.t("asset-db.deleteAsset.fail.unknown")}`),console.warn(e),!1}}async autoRefreshAssetLazy(e){return this.waitingRefreshAsset.includes(e)||this.waitingRefreshAsset.push(e),this.autoRefreshTimmer&&clearTimeout(this.autoRefreshTimmer),new Promise(e=>{this.autoRefreshTimmer=setTimeout(async()=>{this.assetBusy=!0;const s=JSON.parse(JSON.stringify(this.waitingRefreshAsset));this.waitingRefreshAsset.length=0,await Promise.all(s.map(e=>assetdb.refresh(e))),e(!0)},100)})}async resume(){this.hasPause=!1,this.startPause=!1,Editor.Message.broadcast("asset-db:resume"),console_1.newConsole.record(),console.log("Asset DB is resume!"),await this.step()}_addTaskToQueue(e){const s=this.waitingTaskQueue[this.waitingTaskQueue.length-1],t={name:e.name,args:e.args};return e.resolve&&(t.resolves=[e.resolve]),s?s.name!==t.name||t.args.toString()!==s.args.toString()?(this.waitingTaskQueue.push(t),void this.step()):void(e.resolve&&(s.resolves?s.resolves.push(e.resolve):s.resolves=t.resolves,this.step())):(this.waitingTaskQueue.push(t),void this.step())}async step(){if(this.startPause&&this.waitPauseHandle&&(this.waitPauseHandle(!0),this.waitPauseHandle=void 0),this.isPause||!this.waitingTaskQueue.length||"busy"===this.state)return;const e=Array.from(this.waitingTaskQueue);this.waitingTaskQueue=this.waitingTaskQueue.filter(e=>"refresh"===e.name&&this.assetBusy);for(const s of e)try{if("refresh"===s.name&&this.assetBusy)continue;const e=await this[s.name](...s.args);if(!s.resolves)return;s.resolves.forEach(s=>s(e))}catch(e){console.warn(e)}this.waitingTaskQueue.length?await this.step():this.assetBusy=!1}async pause(e="unkown"){return this.startPause=!0,this.isBusy()?this.hasPause?(this.waitPausePromiseTask=new Promise(s=>{this.waitPauseHandle=(()=>{this.waitPausePromiseTask=void 0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),console_1.newConsole.stopRecord(),this.hasPause=!0,console_1.newConsole.stopRecord(),s(!0)})}),setTimeout(()=>{this.waitPausePromiseTask&&(0,utils_1.decidePromiseState)(this.waitPausePromiseTask).then(e=>{e===utils_1.PROMISE_STATE.PENDING&&(this.hasPause=!0,this.waitPauseHandle(),console.debug("Pause asset db time out"))})},12e4),this.waitPausePromiseTask):this.waitPausePromiseTask:(this.hasPause=!0,Editor.Message.broadcast("asset-db:pause",e),console.log(`Asset DB is paused with ${e}!`),!0)}refreshDefaultUserData(){try{const e=(0,path_1.join)(Editor.Project.path,".creator","default-meta.json");if((0,fs_extra_1.existsSync)(e)){const s=(0,fs_extra_1.readJSONSync)(e);for(const e in s)assetdb.setDefaultUserData(e,s[e])}}catch(e){console.error(e)}}}async function onAssetAdded(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-add",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetAdded)(e)}async function onAssetAdd(e){(0,mask_sync_1.assetAdd)(e)}async function onAssetChanged(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-change",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetChanged)(e)}function onAssetChange(e){(0,mask_sync_1.assetChange)(e)}async function onAssetDeleted(e){exports.assetDBManager.ready?Editor.Message.broadcast("asset-db:asset-delete",e.uuid,await(0,utils_1.encodeAsset)(e._assetDB,e),e.meta):(0,mask_sync_1.assetDeleted)(e)}function onAssetDelete(e){(0,mask_sync_1.assetDeleted)(e)}async function onUnResPonseive(e,s){if(exports.assetDBManager.ready){1===(await Editor.Dialog.info(`Resource import Timeout.\n  uuid: ${e.uuid}\n  url: ${e.url}`,{buttons:["Waiting","Interrupt"]})).response&&s.reject("User interrupt")}else console.debug("import asset unresponsive")}exports.assetDBManager=new AssetDBManager;const layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;async function initEngine(e){window.CC_PREVIEW=!1,Editor.Metrics.trackTimeStart("asset-db:require-engine-code");const{default:s}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await s({requiredModules:["cc","cc/editor/populate-internal-constants","cc/editor/serialization","cc/editor/animation-clip-migration","cc/editor/exotic-animation","cc/editor/new-gen-anim","cc/editor/offline-mappings","cc/editor/embedded-player","cc/editor/color-utils","cc/editor/custom-pipeline"]}),Editor.Metrics.trackTimeEnd("asset-db:require-engine-code",{output:!0}),Manager.AssetInfo=e;const t=await Editor.Profile.getProject("engine","modules.includeModules");let a="";const r=["physics-cannon","physics-ammo","physics-builtin","physics-physx"];for(let e=0;e<r.length;e++)if(t.indexOf(r[e])>=0){a=r[e];break}const i=await Editor.Profile.getProject("project","physics"),o=await Editor.Profile.getProject("engine","macroConfig"),n=await Editor.Profile.getProject("project","layer"),c=await Editor.Profile.getProject("project","sorting-layer")||{},u=n.map(e=>{const s=layerMask.findIndex(s=>e.value===s);return{name:e.name,bit:s}}),d=c.layers||[],h=await Editor.Profile.getProject("project","general.highQuality"),l={debugMode:cc.debug.DebugMode.WARN,overrideSettings:{engine:{builtinAssets:[],macros:o,sortingLayers:d,customLayers:u},profiling:{showFPS:!1},screen:{frameRate:30,exactFitScreen:!0},rendering:{renderMode:3,highQualityMode:h},physics:Object.assign(Object.assign({},i),{physicsEngine:a,enabled:!1}),assets:{importBase:(0,path_1.join)(Editor.Project.path,"library"),nativeBase:(0,path_1.join)(Editor.Project.path,"library")}},exactFitScreen:!0};cc.physics.selector.runInEditor=!0;try{await cc.game.init(l)}catch(e){console.warn(e),console.warn("Game init failed!")}}function preImporterHandler(e){const s=(0,path_1.extname)(e);return!s||(".chunk"===s||(".effect"===s||".ts"===s))}const afterScan=async function(e){let s=0,t=0,a=0;for(let r=0;r<e.length;r++){const i=e[r],o=(0,path_1.extname)(i);o?".chunk"===o?(e.splice(r,1),e.splice(s+t,0,i),t+=1):".effect"===o&&(e.splice(r,1),e.splice(s+t+a,0,i),a+=1):(e.splice(r,1),e.splice(s,0,i),s+=1)}};async function afterPreImport(e){e.taskManager.start(),await e.taskManager.waitQueue(),e.taskManager.stop()}async function effectDataProcessing(){Editor.Metrics.trackTimeStart("asset-db:worker-effect-data-processing");try{const e=[];assetdb.forEach(s=>{s.path2asset.forEach(s=>{"effect"===s.meta.importer&&e.push(s)})});const s=Manager.AssetWorker.internal.importerManager.name2importer.effect;s.afterImport&&await s.afterImport(e)}catch(e){console.error(e)}Editor.Metrics.trackTimeEnd("asset-db:worker-effect-data-processing",{output:!0})}exports.effectDataProcessing=effectDataProcessing;