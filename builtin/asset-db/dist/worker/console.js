"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.newConsole=exports.getRealTime=exports.getCurrentLocalTime=exports.transTimeToNumber=exports.formateBytes=exports.NewConsole=void 0;const fs_1=require("fs"),fs_extra_1=require("fs-extra"),path_1=require("path");let rawConsole;class NewConsole{constructor(){this.command=!1,this.messages=[],this._start=!1,this.memoryTrackMap=new Map,this.logDest=(0,path_1.join)(NewConsole.logDest,getCurrentLocalTime()+".log"),rawConsole=console.__rawConsole?console.__rawConsole:console,this.__proto__.__proto__=rawConsole}initLogFiles(){try{(0,fs_1.existsSync)(this.logDest)||(0,fs_extra_1.outputFileSync)(this.logDest,""),this.clearAuto()}catch(e){console.debug(e)}}async clearAuto(){const e=await(0,fs_extra_1.readdir)(NewConsole.logDest);if(!e.length)return;e.sort((e,t)=>transTimeToNumber(t)-transTimeToNumber(e));const t=e.slice(4,e.length-1);await Promise.all(t.map(e=>{(0,fs_extra_1.remove)((0,path_1.join)(NewConsole.logDest,e))}))}record(){window.console.switchConsole?window.console.switchConsole(this):(this._start=!0,window.console=this,rawConsole.debug(`Start record asset-db log in {file(${this.logDest})}`))}stopRecord(){rawConsole.debug(`Stop record asset-db log. {file(${this.logDest})}`),window.console=rawConsole,this._start=!1}log(...e){rawConsole.log(...e),this._start&&(this.messages.push({type:"log",value:e}),this.save())}error(e){rawConsole.error(e),this._start&&(this.messages.push({type:"error",value:e}),this.save())}warn(...e){rawConsole.warn(...e),this._start&&(this.messages.push({type:"warn",value:e}),this.save())}debug(...e){rawConsole.debug(...e),this._start&&(this.messages.push({type:"debug",value:e}),this.save())}async save(){if(!this._start||!this.messages.length)return;const e=this.messages.shift();await this.saveLog(e.type,e.value)}async saveLog(e,t){if(!t||!(0,fs_1.existsSync)(this.logDest))return;const s=`${getRealTime()}-${e}: ${translate(t)}\n`;(0,fs_extra_1.appendFile)(this.logDest,s)}trackMemoryStart(e){const t=process.memoryUsage().heapUsed;return this.memoryTrackMap.set(e,t),t}trackMemoryEnd(e,t=!0){const s=this.memoryTrackMap.get(e);if(!s)return 0;const o=process.memoryUsage().heapUsed;this.memoryTrackMap.delete(e);const r=o-s;return t?(r>1048576&&console.debug(`[Assets Memory track]: ${e} start:${formateBytes(s)}, end ${formateBytes(o)}, increase: ${formateBytes(r)}`),t):r}}function formateBytes(e){return(e/1024/1024).toFixed(2)+"MB"}function transTimeToNumber(e){const t=(e=(0,path_1.basename)(e,".log")).match(/-(\d+)$/);if(t){const s=Array.from(e);return s[t.index]=":",new Date(s.join("")).getTime()}return(new Date).getTime()}function getCurrentLocalTime(){const e=new Date;return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().slice(0,5).replace(/:/g,"-")}function translate(e){if("string"==typeof e&&!e.includes("\n")||"number"==typeof e)return String(e);if("string"==typeof e&&e.includes("\n"))return translate(e.split("\n"));if("object"==typeof e){if(Array.isArray(e)){let t="";return e.forEach(e=>{t+=`${translate(e)}\r`}),t}try{return e.stack?translate(e.stack):JSON.stringify(e)}catch(e){}}return e&&e.toString&&e.toString()}function getRealTime(){const e=new Date;return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().slice(0,8)}exports.NewConsole=NewConsole,NewConsole.logDest=(0,path_1.join)(Editor.Project.path,"temp","asset-db","log"),exports.formateBytes=formateBytes,exports.transTimeToNumber=transTimeToNumber,exports.getCurrentLocalTime=getCurrentLocalTime,exports.getRealTime=getRealTime,exports.newConsole=new NewConsole;