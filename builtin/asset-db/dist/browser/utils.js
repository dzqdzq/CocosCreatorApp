"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.metricCreateAsset=exports.isLegalMetaFile=exports.changeMetaUuid=exports.isReadonly=exports.getName=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),{v4:v4}=require("node-uuid");function getName(e){if(!(0,fs_extra_1.existsSync)(e))return e;const t=(0,path_1.dirname)(e),a=(0,path_1.extname)(e);let r=(0,path_1.basename)(e,a);do{/-\d{3}/.test(r)?r=r.replace(/(-(\d{3})$)/,(e,t,a)=>{let r=parseInt(a,10);return`-${r=(r+=1).toString().padStart(3,"0")}`}):r+="-001",e=(0,path_1.join)(t,r)}while((0,fs_extra_1.existsSync)(e+a));return e+a}async function isReadonly(e){if(e.startsWith("db://")||(e=await(0,index_1.forwarding)("asset-worker:query-url",e)),!e)return!0;const t=await(0,index_1.forwarding)("asset-worker:query-db-info",e);return t&&t.readonly||!1}async function changeMetaUuid(e){if((0,fs_extra_1.statSync)(e).isDirectory()){const t=await(0,fs_extra_1.readdir)(e);for(const a of t)await changeMetaUuid((0,path_1.join)(e,a))}else{if(!(0,fs_extra_1.existsSync)(e)||!e.endsWith(".meta"))return;try{const t=await(0,fs_extra_1.readJson)(e);t.uuid=v4(),await(0,fs_extra_1.outputJson)(e,t)}catch(e){console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.metauuid")}`),console.warn(e)}}}async function isLegalMetaFile(e){if(!(0,fs_extra_1.existsSync)(e)||!e.endsWith(".meta"))return!1;if(!(0,fs_extra_1.statSync)(e).isFile())return!1;try{const t=await(0,fs_extra_1.readJson)(e);return"subMetas"in t&&"userData"in t}catch(e){return!1}}function metricCreateAsset(e){let t="",a="";e.endsWith(".animgraph")?(t="animationStateMachine",a="A100000"):e.endsWith(".animask")&&(t="animationStateMachine",a="A100001"),t&&a&&Editor.Metrics._trackEventWithTimer({category:t,id:a,value:1})}exports.getName=getName,exports.isReadonly=isReadonly,exports.changeMetaUuid=changeMetaUuid,exports.isLegalMetaFile=isLegalMetaFile,exports.metricCreateAsset=metricCreateAsset;