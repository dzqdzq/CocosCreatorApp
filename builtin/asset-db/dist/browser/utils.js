"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.changeMetaUuid=exports.isReadonly=exports.moveFile=exports.removeFile=exports.getName=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),{shell:shell}=require("electron"),{v4:v4}=require("node-uuid");function getName(e){if(!fs_extra_1.existsSync(e))return e;const t=path_1.dirname(e),r=path_1.extname(e);let a=path_1.basename(e,r);do{/-\d{3}/.test(a)?a=a.replace(/(-(\d{3})$)/,(e,t,r)=>{let a=parseInt(r,10);return`-${a=(a+=1).toString().padStart(3,"0")}`}):a+="-001",e=path_1.join(t,a)}while(fs_extra_1.existsSync(e+r));return e+r}async function removeFile(e){if(fs_extra_1.existsSync(e)){try{await shell.trashItem(e)}catch(e){console.error(`db removeFile fail: ${e}`)}try{const t=e+".meta";fs_extra_1.existsSync(t)&&await shell.trashItem(t)}catch(e){}}}async function moveFile(e,t,r){if(fs_extra_1.existsSync(e)&&fs_extra_1.existsSync(e+".meta")){if(!r){if(fs_extra_1.existsSync(t)||fs_extra_1.existsSync(t+".meta"))return;r={overwrite:!1}}try{await fs_extra_1.move(e+".meta",t+".meta",{overwrite:!0}),await fs_extra_1.move(e,t,r)}catch(e){console.error(`db moveFile fail: ${e}`)}}}async function isReadonly(e){if(e.startsWith("db://")||(e=await index_1.forwarding("asset-worker:query-url",e)),!e)return!0;const t=await index_1.forwarding("asset-worker:query-db-info",e);return t&&t.readonly||!1}async function changeMetaUuid(e){if(fs_extra_1.statSync(e).isDirectory()){const t=await fs_extra_1.readdir(e);for(const r of t)await changeMetaUuid(path_1.join(e,r))}else{if(!fs_extra_1.existsSync(e)||!e.endsWith(".meta"))return;try{const t=await fs_extra_1.readJson(e);t.uuid=v4(),await fs_extra_1.outputJson(e,t)}catch(e){console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.metauuid")}`),console.warn(e)}}}exports.getName=getName,exports.removeFile=removeFile,exports.moveFile=moveFile,exports.isReadonly=isReadonly,exports.changeMetaUuid=changeMetaUuid;