"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isLegalMetaFile=exports.changeMetaUuid=exports.isReadonly=exports.moveFile=exports.removeFile=exports.getName=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),{shell:shell}=require("electron"),{v4:v4}=require("node-uuid");function getName(e){if(!fs_extra_1.existsSync(e))return e;const t=path_1.dirname(e),a=path_1.extname(e);let r=path_1.basename(e,a);do{/-\d{3}/.test(r)?r=r.replace(/(-(\d{3})$)/,(e,t,a)=>{let r=parseInt(a,10);return`-${r=(r+=1).toString().padStart(3,"0")}`}):r+="-001",e=path_1.join(t,r)}while(fs_extra_1.existsSync(e+a));return e+a}async function removeFile(e){if(fs_extra_1.existsSync(e)){try{await shell.trashItem(e)}catch(e){console.error(`db removeFile fail: ${e}`)}try{const t=e+".meta";fs_extra_1.existsSync(t)&&await shell.trashItem(t)}catch(e){}}}async function moveFile(e,t,a){if(fs_extra_1.existsSync(e)&&fs_extra_1.existsSync(e+".meta")){if(!a){if(fs_extra_1.existsSync(t)||fs_extra_1.existsSync(t+".meta"))return;a={overwrite:!1}}try{await fs_extra_1.move(e+".meta",t+".meta",{overwrite:!0}),await fs_extra_1.move(e,t,a)}catch(e){console.error(`db moveFile fail: ${e}`)}}}async function isReadonly(e){if(e.startsWith("db://")||(e=await index_1.forwarding("asset-worker:query-url",e)),!e)return!0;const t=await index_1.forwarding("asset-worker:query-db-info",e);return t&&t.readonly||!1}async function changeMetaUuid(e){if(fs_extra_1.statSync(e).isDirectory()){const t=await fs_extra_1.readdir(e);for(const a of t)await changeMetaUuid(path_1.join(e,a))}else{if(!fs_extra_1.existsSync(e)||!e.endsWith(".meta"))return;try{const t=await fs_extra_1.readJson(e);t.uuid=v4(),await fs_extra_1.outputJson(e,t)}catch(e){console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.metauuid")}`),console.warn(e)}}}async function isLegalMetaFile(e){if(!fs_extra_1.existsSync(e)||!e.endsWith(".meta"))return!1;if(!fs_extra_1.statSync(e).isFile())return!1;try{const t=await fs_extra_1.readJson(e);return"subMetas"in t&&"userData"in t}catch(e){return!1}}exports.getName=getName,exports.removeFile=removeFile,exports.moveFile=moveFile,exports.isReadonly=isReadonly,exports.changeMetaUuid=changeMetaUuid,exports.isLegalMetaFile=isLegalMetaFile;