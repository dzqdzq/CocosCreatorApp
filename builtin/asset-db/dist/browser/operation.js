"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.zip=zip,exports.generateAvailableURL=generateAvailableURL,exports.importAsset=importAsset,exports.copyAsset=copyAsset,exports.renameAsset=renameAsset,exports.moveAsset=moveAsset,exports.deleteAsset=deleteAsset,exports.reimportAsset=reimportAsset,exports.queryAllImporter=queryAllImporter,exports.queryAllAssetTypes=queryAllAssetTypes,exports.refreshAsset=refreshAsset,exports.refreshAllEffect=refreshAllEffect,exports.initAsset=initAsset;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("../share/utils"),index_1=require("./worker/index");function zip(e,r){var t=require("archiver"),e=(0,fs_extra_1.createWriteStream)(e);const a=t("zip");a.on("error",e=>{throw e}),a.pipe(e),r.forEach(e=>{var r=(0,path_1.parse)(e);a.append((0,fs_extra_1.createReadStream)(e),{name:r.ext.substr(1)})}),a.finalize()}async function generateAvailableURL(e){if(!e||"string"!=typeof e)throw new Error(Editor.I18n.t("asset-db.operation.invalid_url"));var r=await(0,index_1.forwarding)("asset-worker:generate-available-url",e);if(r)return r;throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+`
  url: `+e)}function checkURL(e){if(!e||"string"!=typeof e||!e.startsWith("db://"))throw new Error(Editor.I18n.t("asset-db.operation.invalid_url")+` 
  url: `+e)}async function checkReadonly(e){if(await isReadonly(e))throw new Error(Editor.I18n.t("asset-db.operation.readonly")+` 
  url: `+e)}async function isReadonly(e){return!(e=e.startsWith("db://")?e:await(0,index_1.forwarding)("asset-worker:query-url",e))||(e=await(0,index_1.forwarding)("asset-worker:query-db-info",e))&&e.readonly||!1}async function generateURL(r){try{return await generateAvailableURL(r)}catch(e){throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+` 
  url: `+r)}}async function queryUUID(e){if(!e.startsWith("db://"))return e;let r;try{r=await(0,index_1.forwarding)("asset-worker:query-uuid",e||"")}catch(e){}return r||null}async function importAsset(r,t,e){checkURL(t),await checkReadonly((0,path_1.dirname)(t));var a=await generateURL(t);if(t!==a){e=await(0,utils_1.handleAssetOption)(t,e);if("rename"===e)t=a;else if("cancel"===e)return null}try{var s=await(0,index_1.forwarding)("asset-worker:query-path",t);if(await(0,fs_extra_1.copy)(r,s,{overwrite:!0}),s.endsWith(".meta")){const r=s.replace(".meta","");if(await(0,index_1.forwarding)("asset-worker:query-path",r)){await refreshAsset(s);const u=await queryUUID(t);return u?await(0,index_1.forwarding)("asset-worker:query-asset-info",u):null}return null}var i,n=r+".meta",o=s+".meta";(0,fs_extra_1.existsSync)(n)&&(!1===(i=await Editor.Profile.getConfig("asset-db","autoOverwriteMeta"))&&(0,fs_extra_1.existsSync)(o)&&console.log(Editor.I18n.t("asset-db.importAsset.metaExists",{name:r})),await(0,utils_1.isLegalMetaFile)(n))&&await(0,fs_extra_1.copy)(n,o,{overwrite:i}),await refreshAsset(s)}catch(e){return console.error(`Import asset form ${r} -> ${t} failed!`),console.error(e),null}const u=await queryUUID(t);return u?await(0,index_1.forwarding)("asset-worker:query-asset-info",u):null}async function copyAsset(e,r,t){checkURL(e),checkURL(r),await checkReadonly((0,path_1.dirname)(r));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",r)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.copyAsset.fail.source")+` 
source: `+e);if(Editor.Utils.Path.contains(a.target,a.source))throw new Error(Editor.I18n.t("asset-db.copyAsset.fail.include")+` 
source: ${e}
target: `+r);let s=await generateURL(r);if(r!==s){e=await(0,utils_1.handleAssetOption)(r,t);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else{if("cancel"===e)return null;s=r}}t=a.source+".meta",e=a.target+".meta",(0,fs_extra_1.existsSync)(t)&&await(0,utils_1.isLegalMetaFile)(t)&&(await(0,fs_extra_1.copy)(t,e),await(0,utils_1.changeMetaUuid)(e)),await(0,fs_extra_1.copy)(a.source,a.target),await(0,utils_1.changeMetaUuid)(a.target),await refreshAsset(a.target),t=await queryUUID(s);return t?(0,index_1.forwarding)("asset-worker:query-asset-info",t):(console.warn(""+Editor.I18n.t("asset-db.createAsset.fail.uuid",{target:r})),null)}async function renameAsset(e,r,t){checkURL(e),checkURL(r),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(r));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",r)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.renameAsset.fail.source")+` 
source: `+e);var s=await generateURL(r);if(e.toLowerCase()===r.toLowerCase()&&r!==s)return(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,t);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(Editor.I18n.t("asset-db.renameAsset.fail.parent")+` 
source: ${e}
target: `+r);if(r!==s){e=await(0,utils_1.handleAssetOption)(r,t);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return(t=t||{}).overwrite=!0,(0,path_1.dirname)(a.target)!==(0,path_1.dirname)(a.source)?(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,t):(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,t)}async function moveAsset(e,r,t){checkURL(e),checkURL(r),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(r));var a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",r)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(Editor.I18n.t("asset-db.moveAsset.fail.source")+` 
source: `+e);var s=await generateURL(r);if(e.toLowerCase()===r.toLowerCase()&&r!==s)return(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(Editor.I18n.t("asset-db.moveAsset.fail.parent")+` 
source: ${e}
target: `+r);if(r!==s){e=await(0,utils_1.handleAssetOption)(r,t);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return(t=t||{}).overwrite=!0,(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,t)}async function deleteAsset(e){e=await(0,index_1.forwarding)("asset-worker:remove-asset",e);return e&&Editor.Selection.unselect("asset",e.uuid),e}async function reimportAsset(e){return(0,index_1.forwarding)("asset-worker:reimport-asset",e)}async function queryAllImporter(){return(0,index_1.forwarding)("asset-worker:query-all-importer")}async function queryAllAssetTypes(){return(0,index_1.forwarding)("asset-worker:query-all-asset-types")}async function refreshAsset(e){return(0,index_1.forwarding)("asset-worker:refresh-asset",e)}async function refreshAllEffect(){return(0,index_1.forwarding)("asset-worker:refresh-all-effect")}async function initAsset(e,r){const t=await(0,index_1.forwarding)("asset-worker:query-asset-info",e);if(!t)return console.warn(Editor.I18n.t("asset-db.saveAsset.fail.uuid")+` 
{asset(${e})}`),null;if(!r||"string"!=typeof r||!r.startsWith("db://"))return console.warn(Editor.I18n.t("asset-db.copyAsset.fail.url")+` 
target: {asset(${r})}`),null;var r=await(0,index_1.forwarding)("asset-worker:query-path",r),a=(0,path_1.parse)(t.name),s=Object.keys(t.library).map(e=>t.library[e]);if(!s||0===s.length)return console.warn(`Unable to instantiate resource 
uuid: `+e),null;try{var i=(0,path_1.join)(r,a.name+t.instantiation);if(zip(i,s),await refreshAsset(i),!(0,fs_extra_1.existsSync)(i))throw new Error(""+Editor.I18n.t("asset-db.createAsset.fail.drop",{target:i}));const e=await queryUUID(i);return e?await(0,index_1.forwarding)("asset-worker:query-asset-info",e):null}catch(e){return console.error(e),null}}