"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initAsset=exports.removeAsset=exports.refreshAllEffect=exports.refreshAsset=exports.queryAllAssetTypes=exports.queryAllImporter=exports.createAssetDialog=exports.reimportAsset=exports.saveAssetMeta=exports.saveAsset=exports.deleteAsset=exports.moveAsset=exports.copyAsset=exports.importAsset=exports.createAsset=exports.generateAvailableURL=exports.zip=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),index_1=require("./worker/index"),asset_config_1=require("./asset-config");function zip(e,t){const r=require("archiver"),s=(0,fs_extra_1.createWriteStream)(e),a=r("zip");a.on("error",e=>{throw e}),a.pipe(s),t.forEach(e=>{const t=(0,path_1.parse)(e);a.append((0,fs_extra_1.createReadStream)(e),{name:t.ext.substr(1)})}),a.finalize()}async function generateAvailableURL(e){if(!e||"string"!=typeof e)throw new Error(Editor.I18n.t("asset-db.operation.invalid_url"));const t=await(0,index_1.forwarding)("asset-worker:generate-available-url",e);if(!t)throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+`\n  url: ${e}`);return t}function checkURL(e){if(!e||"string"!=typeof e||!e.startsWith("db://"))throw new Error(`${Editor.I18n.t("asset-db.operation.invalid_url")} \n  url: ${e}`)}async function checkReadonly(e){if(await(0,utils_1.isReadonly)(e))throw new Error(`${Editor.I18n.t("asset-db.operation.readonly")} \n  url: ${e}`)}async function generateURL(e){try{return await generateAvailableURL(e)}catch(t){throw new Error(`${Editor.I18n.t("asset-db.operation.exists_url")} \n  url: ${e}`)}}async function queryUUID(e){if(!e.startsWith("db://"))return e;let t;try{t=await(0,index_1.forwarding)("asset-worker:query-uuid",e||"")}catch(e){}return t||null}async function handleAssetOption(e,t){if((t=t||{}).overwrite)return"overwrite";if(t.rename)return"rename";{const t=await Editor.Dialog.warn(Editor.I18n.t("asset-db.operation.overwrite"),{title:Editor.I18n.t("asset-db.operate.dialogQuestion"),detail:e,buttons:[Editor.I18n.t("asset-db.operate.overwrite"),Editor.I18n.t("asset-db.operate.rename"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:2});return 0===t.response?"overwrite":1===t.response?"rename":"cancel"}}async function createAsset(e,t,r){checkURL(e),await checkReadonly((0,path_1.dirname)(e));const s=await generateURL(e);if(s!==e){const t=await handleAssetOption(e,r);if("rename"===t)e=s;else if("cancel"===t)return null}const a=await(0,index_1.forwarding)("asset-worker:query-path",e);if(void 0!==t&&null!==t?await(0,fs_extra_1.outputFile)(a,t):await(0,fs_extra_1.ensureDir)(a),await refreshAsset(a),!(0,fs_extra_1.existsSync)(a))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop")} \n${a}`);(0,utils_1.metricCreateAsset)(a);const n=await queryUUID(e);return n?await(0,index_1.forwarding)("asset-worker:query-asset-info",n):(console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.uuid")} \n${e}`),null)}async function importAsset(e,t,r){checkURL(t),await checkReadonly((0,path_1.dirname)(t));const s=await generateURL(t);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)t=s;else if("cancel"===e)return null}try{const r=await(0,index_1.forwarding)("asset-worker:query-path",t);if(await(0,fs_extra_1.copy)(e,r,{overwrite:!0}),r.endsWith(".meta")){const e=r.replace(".meta","");if(await(0,index_1.forwarding)("asset-worker:query-path",e)){await refreshAsset(r);const e=await queryUUID(t);return e?await(0,index_1.forwarding)("asset-worker:query-asset-info",e):null}return null}const s=e+".meta",a=r+".meta";if((0,fs_extra_1.existsSync)(s)){const t=await Editor.Profile.getConfig("asset-db","autoOverwriteMeta");!1===t&&(0,fs_extra_1.existsSync)(a)&&console.log(Editor.I18n.t("asset-db.importAsset.metaExists",{name:e})),await(0,utils_1.isLegalMetaFile)(s)&&await(0,fs_extra_1.copy)(s,a,{overwrite:t})}await refreshAsset(r)}catch(r){return console.error(`Import asset form ${e} -> ${t} failed!`),console.error(r),null}const a=await queryUUID(t);return a?await(0,index_1.forwarding)("asset-worker:query-asset-info",a):null}async function copyAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(t));const s={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!s.source||!(0,fs_extra_1.existsSync)(s.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.source")} \nsource: ${e}`);if(Editor.Utils.Path.contains(s.target,s.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.include")} \nsource: ${e}\ntarget: ${t}`);let a=await generateURL(t);if(t!==a){const e=await handleAssetOption(t,r);if("rename"===e)s.target=await(0,index_1.forwarding)("asset-worker:query-path",a);else{if("cancel"===e)return null;a=t}}const n=s.source+".meta",i=s.target+".meta";if((0,fs_extra_1.existsSync)(n)){await(0,utils_1.isLegalMetaFile)(n)&&(await(0,fs_extra_1.copy)(n,i),await(0,utils_1.changeMetaUuid)(i))}await(0,fs_extra_1.copy)(s.source,s.target),await(0,utils_1.changeMetaUuid)(s.target),await refreshAsset(s.target);const o=await queryUUID(a);return o?await(0,index_1.forwarding)("asset-worker:query-asset-info",o):(console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.uuid")} \n${t}`),null)}async function moveAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(t));const s={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!s.source||!(0,fs_extra_1.existsSync)(s.source))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.source")} \nsource: ${e}`);const a=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==a)return await(0,index_1.forwarding)("asset-worker:rename-asset",s.source,s.target);if(s.target.startsWith((0,path_1.join)(s.source,"/")))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.parent")} \nsource: ${e}\ntarget: ${t}`);if(t!==a){const e=await handleAssetOption(t,r);if("rename"===e)s.target=await(0,index_1.forwarding)("asset-worker:query-path",a);else if("cancel"===e)return null}return r||(r={}),r.overwrite=!0,await(0,index_1.forwarding)("asset-worker:move-asset",s.source,s.target,r)}async function deleteAsset(e){checkURL(e),await checkReadonly(e);const t=await queryUUID(e);if(!t)return null;const r=await(0,index_1.forwarding)("asset-worker:query-asset-info",t),s=await removeAsset(r.file);return Editor.Selection.unselect("asset",t),s?r:null}async function saveAsset(e,t){const r=await queryUUID(e);if(await checkReadonly(e),void 0===t)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.content")}`);if(!r)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n${r}`);const s=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);return"gltf-material"===s.importer&&"cc.Material"===s.type?await saveInternalMaterialToMeta(r,t):await(0,fs_extra_1.outputFile)(s.file,t),await refreshAsset(s.file),s}async function saveInternalMaterialToMeta(e,t){const[r,s]=e.split("@");if(await checkReadonly(r),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`);const a=await(0,index_1.forwarding)("asset-worker:query-asset-meta",r);a.userData.materials&&"object"==typeof a.userData.materials||(a.userData.materials={});try{a.userData.materials[e]=JSON.parse(t),await saveAssetMeta(r,JSON.stringify(a))}catch(t){console.error(`Save materials({asset(${e})} data to fbx {asset(${r})} failed!`),console.error(t)}}async function saveAssetMeta(e,t){const r=await queryUUID(e);if(await checkReadonly(e),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`);const s=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);return await(0,index_1.forwarding)("asset-worker:save-asset-meta",r,t)?s:(console.warn(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`),s)}async function reimportAsset(e){return await(0,index_1.forwarding)("asset-worker:reimport-asset",e)}async function createAssetDialog(e,t){if(e&&"string"!=typeof e)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type")} \n${e}`),null;if(t&&("string"!=typeof t||!t.startsWith("db://")))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.url")} \n${t}`),null;const r=asset_config_1.createAssetConfig[e];if(!r)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type")} \n${e}`),null;const s=null===r.extension&&null===r.content,a=s?r.name:`${r.name}.${r.extension}`;let n=(0,path_1.join)(`${Editor.Project.path}`,"assets",a);if(t&&(n=await Editor.Message.request("asset-db","query-path",t)),!n)return null;if(n=(0,utils_1.getName)(n),n=(await Editor.Dialog.save({title:Editor.I18n.t("asset-db.createAsset.title"),path:n,filters:[{name:r.type,extensions:[r.extension]}]})).filePath||"",Array.isArray(n)&&(n=n[0]),!n)return null;if(s)await(0,fs_extra_1.ensureDir)(n),await refreshAsset(n);else{let e=r.content;if(r.template&&(e=await(0,asset_config_1.getTemplateContent)(r.template)),!(e instanceof Buffer||"string"==typeof e))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.content")}`),null;await(0,fs_extra_1.outputFile)(n,e),await refreshAsset(n)}let i,o;try{i=await(0,index_1.forwarding)("asset-worker:query-url",n)}catch(e){}if(!i)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.toUrl")} \n${n}`),null;try{o=await(0,index_1.forwarding)("asset-worker:query-uuid",i||"")}catch(e){}return o}async function queryAllImporter(){return await(0,index_1.forwarding)("asset-worker:query-all-importer")}async function queryAllAssetTypes(){return await(0,index_1.forwarding)("asset-worker:query-all-asset-types")}async function refreshAsset(e){return await(0,index_1.forwarding)("asset-worker:refresh-asset",e)}async function refreshAllEffect(){return await(0,index_1.forwarding)("asset-worker:refresh-all-effect")}async function removeAsset(e){return await(0,index_1.forwarding)("asset-worker:remove-asset",e)}async function initAsset(e,t){const r=await(0,index_1.forwarding)("asset-worker:query-asset-info",e);if(!r)return console.warn(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n{asset(${e})}`),null;if(!t||"string"!=typeof t||!t.startsWith("db://"))return console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.url")} \ntarget: {asset(${t})}`),null;const s=await(0,index_1.forwarding)("asset-worker:query-path",t),a=(0,path_1.parse)(r.name),n=Object.keys(r.library).map(e=>r.library[e]);if(!n||0===n.length)return console.warn(`Unable to instantiate resource \nuuid: ${e}`),null;try{const e=(0,path_1.join)(s,a.name+r.instantiation);if(zip(e,n),await refreshAsset(e),!(0,fs_extra_1.existsSync)(e))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop")} \n${e}`);const t=await queryUUID(e);return t?await(0,index_1.forwarding)("asset-worker:query-asset-info",t):null}catch(e){return console.error(e),null}}exports.zip=zip,exports.generateAvailableURL=generateAvailableURL,exports.createAsset=createAsset,exports.importAsset=importAsset,exports.copyAsset=copyAsset,exports.moveAsset=moveAsset,exports.deleteAsset=deleteAsset,exports.saveAsset=saveAsset,exports.saveAssetMeta=saveAssetMeta,exports.reimportAsset=reimportAsset,exports.createAssetDialog=createAssetDialog,exports.queryAllImporter=queryAllImporter,exports.queryAllAssetTypes=queryAllAssetTypes,exports.refreshAsset=refreshAsset,exports.refreshAllEffect=refreshAllEffect,exports.removeAsset=removeAsset,exports.initAsset=initAsset;