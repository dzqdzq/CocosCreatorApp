"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initAsset=exports.removeAsset=exports.refreshAllEffect=exports.refreshAsset=exports.queryAllAssetTypes=exports.queryAllImporter=exports.createAssetDialog=exports.reimportAsset=exports.saveAssetMeta=exports.saveAsset=exports.deleteAsset=exports.moveAsset=exports.renameAsset=exports.copyAsset=exports.importAsset=exports.createAsset=exports.generateAvailableURL=exports.zip=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),index_1=require("./worker/index"),asset_config_1=require("./asset-config");function zip(e,t){const r=require("archiver"),a=(0,fs_extra_1.createWriteStream)(e),s=r("zip");s.on("error",e=>{throw e}),s.pipe(a),t.forEach(e=>{const t=(0,path_1.parse)(e);s.append((0,fs_extra_1.createReadStream)(e),{name:t.ext.substr(1)})}),s.finalize()}async function generateAvailableURL(e){if(!e||"string"!=typeof e)throw new Error(Editor.I18n.t("asset-db.operation.invalid_url"));const t=await(0,index_1.forwarding)("asset-worker:generate-available-url",e);if(!t)throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+`\n  url: ${e}`);return t}function checkURL(e){if(!e||"string"!=typeof e||!e.startsWith("db://"))throw new Error(`${Editor.I18n.t("asset-db.operation.invalid_url")} \n  url: ${e}`)}async function checkReadonly(e){if(await(0,utils_1.isReadonly)(e))throw new Error(`${Editor.I18n.t("asset-db.operation.readonly")} \n  url: ${e}`)}async function generateURL(e){try{return await generateAvailableURL(e)}catch(t){throw new Error(`${Editor.I18n.t("asset-db.operation.exists_url")} \n  url: ${e}`)}}async function queryUUID(e){if(!e.startsWith("db://"))return e;let t;try{t=await(0,index_1.forwarding)("asset-worker:query-uuid",e||"")}catch(e){}return t||null}async function handleAssetOption(e,t){if((t=t||{}).overwrite)return"overwrite";if(t.rename)return"rename";{const t=await Editor.Dialog.warn(Editor.I18n.t("asset-db.operation.overwrite"),{title:Editor.I18n.t("asset-db.operate.dialogQuestion"),detail:e,buttons:[Editor.I18n.t("asset-db.operate.overwrite"),Editor.I18n.t("asset-db.operate.rename"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:2});return 0===t.response?"overwrite":1===t.response?"rename":"cancel"}}async function createAsset(e,t,r){checkURL(e),await checkReadonly((0,path_1.dirname)(e));const a=await generateURL(e);if(a!==e){const t=await handleAssetOption(e,r);if("rename"===t)e=a;else if("cancel"===t)return null}const s=await(0,index_1.forwarding)("asset-worker:query-path",e);if(void 0!==t&&null!==t?await(0,fs_extra_1.outputFile)(s,t):await(0,fs_extra_1.ensureDir)(s),await refreshAsset(s),!(0,fs_extra_1.existsSync)(s))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop",{target:s})}`);(0,utils_1.metricCreateAsset)(s);const n=await queryUUID(e);return n?await(0,index_1.forwarding)("asset-worker:query-asset-info",n):(console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.uuid",{target:e})}`),null)}async function importAsset(e,t,r){checkURL(t),await checkReadonly((0,path_1.dirname)(t));const a=await generateURL(t);if(t!==a){const e=await handleAssetOption(t,r);if("rename"===e)t=a;else if("cancel"===e)return null}try{const r=await(0,index_1.forwarding)("asset-worker:query-path",t);if(await(0,fs_extra_1.copy)(e,r,{overwrite:!0}),r.endsWith(".meta")){const e=r.replace(".meta","");if(await(0,index_1.forwarding)("asset-worker:query-path",e)){await refreshAsset(r);const e=await queryUUID(t);return e?await(0,index_1.forwarding)("asset-worker:query-asset-info",e):null}return null}const a=e+".meta",s=r+".meta";if((0,fs_extra_1.existsSync)(a)){const t=await Editor.Profile.getConfig("asset-db","autoOverwriteMeta");!1===t&&(0,fs_extra_1.existsSync)(s)&&console.log(Editor.I18n.t("asset-db.importAsset.metaExists",{name:e})),await(0,utils_1.isLegalMetaFile)(a)&&await(0,fs_extra_1.copy)(a,s,{overwrite:t})}await refreshAsset(r)}catch(r){return console.error(`Import asset form ${e} -> ${t} failed!`),console.error(r),null}const s=await queryUUID(t);return s?await(0,index_1.forwarding)("asset-worker:query-asset-info",s):null}async function copyAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(t));const a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.source")} \nsource: ${e}`);if(Editor.Utils.Path.contains(a.target,a.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.include")} \nsource: ${e}\ntarget: ${t}`);let s=await generateURL(t);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else{if("cancel"===e)return null;s=t}}const n=a.source+".meta",i=a.target+".meta";if((0,fs_extra_1.existsSync)(n)){await(0,utils_1.isLegalMetaFile)(n)&&(await(0,fs_extra_1.copy)(n,i),await(0,utils_1.changeMetaUuid)(i))}await(0,fs_extra_1.copy)(a.source,a.target),await(0,utils_1.changeMetaUuid)(a.target),await refreshAsset(a.target);const o=await queryUUID(s);return o?await(0,index_1.forwarding)("asset-worker:query-asset-info",o):(console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.uuid",{target:t})}`),null)}async function renameAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(t));const a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(`${Editor.I18n.t("asset-db.renameAsset.fail.source")} \nsource: ${e}`);const s=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==s)return await(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,r);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(`${Editor.I18n.t("asset-db.renameAsset.fail.parent")} \nsource: ${e}\ntarget: ${t}`);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return r||(r={}),r.overwrite=!0,(0,path_1.dirname)(a.target)!==(0,path_1.dirname)(a.source)?await(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,r):await(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target,r)}async function moveAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly((0,path_1.dirname)(e)),await checkReadonly((0,path_1.dirname)(t));const a={source:await(0,index_1.forwarding)("asset-worker:query-path",e),target:await(0,index_1.forwarding)("asset-worker:query-path",t)};if(!a.source||!(0,fs_extra_1.existsSync)(a.source))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.source")} \nsource: ${e}`);const s=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==s)return await(0,index_1.forwarding)("asset-worker:rename-asset",a.source,a.target);if(a.target.startsWith((0,path_1.join)(a.source,"/")))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.parent")} \nsource: ${e}\ntarget: ${t}`);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)a.target=await(0,index_1.forwarding)("asset-worker:query-path",s);else if("cancel"===e)return null}return r||(r={}),r.overwrite=!0,await(0,index_1.forwarding)("asset-worker:move-asset",a.source,a.target,r)}async function deleteAsset(e){let t=e;if(Editor.Utils.UUID.isUUID(t)||(t=await(0,index_1.forwarding)("asset-worker:query-uuid",e)),!t)throw new Error(`${Editor.I18n.t("asset-db.deleteAsset.fail.unexist")} \nsource: ${t}`);const r=await(0,index_1.forwarding)("asset-worker:query-asset-info",t),a=await removeAsset(r.file);return Editor.Selection.unselect("asset",t),a?r:null}async function saveAsset(e,t){const r=await queryUUID(e);if(await checkReadonly(e),void 0===t)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.content")}`);if(!r)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n${r}`);const a=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);return"gltf-material"===a.importer&&"cc.Material"===a.type?await saveInternalMaterialToMeta(r,t):await(0,fs_extra_1.outputFile)(a.file,t),await refreshAsset(a.file),a}async function saveInternalMaterialToMeta(e,t){const[r,a]=e.split("@");if(await checkReadonly(r),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`);const s=await(0,index_1.forwarding)("asset-worker:query-asset-meta",r);s.userData.materials&&"object"==typeof s.userData.materials||(s.userData.materials={});try{s.userData.materials[e]=JSON.parse(t),await saveAssetMeta(r,JSON.stringify(s))}catch(t){console.error(`Save materials({asset(${e})} data to fbx {asset(${r})} failed!`),console.error(t)}}async function saveAssetMeta(e,t){const r=await queryUUID(e);if(await checkReadonly(e),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`);const a=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);return await(0,index_1.forwarding)("asset-worker:save-asset-meta",r,t)?a:(console.warn(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`),a)}async function reimportAsset(e){return await(0,index_1.forwarding)("asset-worker:reimport-asset",e)}async function createAssetDialog(e,t){if(e&&"string"!=typeof e)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type",{type:e})}`),null;if(t&&("string"!=typeof t||!t.startsWith("db://")))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.url",{url:t})}}`),null;const r=asset_config_1.createAssetConfig[e];if(!r)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type",{type:e})}`),null;const a=null===r.extension&&null===r.content,s=a?r.name:`${r.name}.${r.extension}`;let n=(0,path_1.join)(`${Editor.Project.path}`,"assets",s);if(t&&(n=await Editor.Message.request("asset-db","query-path",t)),!n)return null;if(n=(0,utils_1.getName)(n),n=(await Editor.Dialog.save({title:Editor.I18n.t("asset-db.createAsset.title"),path:n,filters:[{name:r.type,extensions:[r.extension]}]})).filePath||"",Array.isArray(n)&&(n=n[0]),!n)return null;if(a)await(0,fs_extra_1.ensureDir)(n),await refreshAsset(n);else{let e=r.content;if(r.template&&(e=await(0,asset_config_1.getTemplateContent)(r.template)),!(e instanceof Buffer||"string"==typeof e))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.content",{target:n})}`),null;await(0,fs_extra_1.outputFile)(n,e),await refreshAsset(n)}let i,o;try{i=await(0,index_1.forwarding)("asset-worker:query-url",n)}catch(e){}if(!i)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.toUrl",{target:n})}`),null;try{o=await(0,index_1.forwarding)("asset-worker:query-uuid",i||"")}catch(e){}return o}async function queryAllImporter(){return await(0,index_1.forwarding)("asset-worker:query-all-importer")}async function queryAllAssetTypes(){return await(0,index_1.forwarding)("asset-worker:query-all-asset-types")}async function refreshAsset(e){return await(0,index_1.forwarding)("asset-worker:refresh-asset",e)}async function refreshAllEffect(){return await(0,index_1.forwarding)("asset-worker:refresh-all-effect")}async function removeAsset(e){return await(0,index_1.forwarding)("asset-worker:remove-asset",e)}async function initAsset(e,t){const r=await(0,index_1.forwarding)("asset-worker:query-asset-info",e);if(!r)return console.warn(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n{asset(${e})}`),null;if(!t||"string"!=typeof t||!t.startsWith("db://"))return console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.url")} \ntarget: {asset(${t})}`),null;const a=await(0,index_1.forwarding)("asset-worker:query-path",t),s=(0,path_1.parse)(r.name),n=Object.keys(r.library).map(e=>r.library[e]);if(!n||0===n.length)return console.warn(`Unable to instantiate resource \nuuid: ${e}`),null;try{const e=(0,path_1.join)(a,s.name+r.instantiation);if(zip(e,n),await refreshAsset(e),!(0,fs_extra_1.existsSync)(e))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop",{target:e})}`);const t=await queryUUID(e);return t?await(0,index_1.forwarding)("asset-worker:query-asset-info",t):null}catch(e){return console.error(e),null}}exports.zip=zip,exports.generateAvailableURL=generateAvailableURL,exports.createAsset=createAsset,exports.importAsset=importAsset,exports.copyAsset=copyAsset,exports.renameAsset=renameAsset,exports.moveAsset=moveAsset,exports.deleteAsset=deleteAsset,exports.saveAsset=saveAsset,exports.saveAssetMeta=saveAssetMeta,exports.reimportAsset=reimportAsset,exports.createAssetDialog=createAssetDialog,exports.queryAllImporter=queryAllImporter,exports.queryAllAssetTypes=queryAllAssetTypes,exports.refreshAsset=refreshAsset,exports.refreshAllEffect=refreshAllEffect,exports.removeAsset=removeAsset,exports.initAsset=initAsset;