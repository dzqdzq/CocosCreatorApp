"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initAsset=exports.refreshAsset=exports.queryAllAssetTypes=exports.queryAllImporter=exports.createAssetDialog=exports.reimportAsset=exports.saveAssetMeta=exports.saveAsset=exports.deleteAsset=exports.moveAsset=exports.copyAsset=exports.importAsset=exports.createAsset=exports.generateAvailableURL=exports.zip=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),utils_1=require("./utils"),index_1=require("./worker/index"),asset_config_1=require("./asset-config");function zip(e,t){const r=require("archiver"),a=fs_extra_1.createWriteStream(e),s=r("zip");s.on("error",e=>{throw e}),s.pipe(a),t.forEach(e=>{const t=path_1.parse(e);s.append(fs_extra_1.createReadStream(e),{name:t.ext.substr(1)})}),s.finalize()}async function generateAvailableURL(e){if(!e||"string"!=typeof e)throw new Error(Editor.I18n.t("asset-db.operation.invalid_url"));const t=await index_1.forwarding("asset-worker:generate-available-url",e);if(!t)throw new Error(Editor.I18n.t("asset-db.operation.exists_url")+`\n  url: ${e}`);return t}function checkURL(e){if(!e||"string"!=typeof e||!e.startsWith("db://"))throw new Error(`${Editor.I18n.t("asset-db.operation.invalid_url")} \n  url: ${e}`)}async function checkReadonly(e){if(await utils_1.isReadonly(e))throw new Error(`${Editor.I18n.t("asset-db.operation.readonly")} \n  url: ${e}`)}async function generateURL(e){try{return await generateAvailableURL(e)}catch(t){throw new Error(`${Editor.I18n.t("asset-db.operation.exists_url")} \n  url: ${e}`)}}async function queryUUID(e){if(!e.startsWith("db://"))return e;let t;try{t=await index_1.forwarding("asset-worker:query-uuid",e||"")}catch(e){}return t||(console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.uuid")} \n${e}`),null)}async function handleAssetOption(e,t){if((t=t||{}).overwrite)return"overwrite";if(t.rename)return"rename";{const t=await Editor.Dialog.warn(Editor.I18n.t("asset-db.operation.overwrite"),{title:Editor.I18n.t("asset-db.operate.dialogQuestion"),detail:e,buttons:[Editor.I18n.t("asset-db.operate.overwrite"),Editor.I18n.t("asset-db.operate.rename"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:2});return 0===t.response?"overwrite":1===t.response?"rename":"cancel"}}async function createAsset(e,t,r){checkURL(e),await checkReadonly(path_1.dirname(e));const a=await generateURL(e);if(a!==e){const t=await handleAssetOption(e,r);if("rename"===t)e=a;else if("cancel"===t)return null}const s=await index_1.forwarding("asset-worker:query-path",e);if(void 0!==t&&null!==t?await fs_extra_1.outputFile(s,t):await fs_extra_1.ensureDir(s),await refreshAsset(s),!fs_extra_1.existsSync(s))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop")} \n${s}`);const n=await queryUUID(e);return n?await index_1.forwarding("asset-worker:query-asset-info",n):null}async function importAsset(e,t,r){checkURL(t),await checkReadonly(path_1.dirname(t));const a=await generateURL(t);if(t!==a){const e=await handleAssetOption(t,r);if("rename"===e)t=a;else if("cancel"===e)return null}try{const r=await index_1.forwarding("asset-worker:query-path",t);if(await fs_extra_1.copy(e,r,{overwrite:!0}),fs_extra_1.existsSync(e+".meta")){const t=await Editor.Profile.getConfig("asset-db","autoOverwriteMeta");!1===t&&fs_extra_1.existsSync(r+".meta")&&console.log(Editor.I18n.t("asset-db.importAsset.metaExists",{name:e})),await fs_extra_1.copy(e+".meta",r+".meta",{overwrite:t})}await refreshAsset(r)}catch(e){return console.error(e),null}const s=await queryUUID(t);return s?await index_1.forwarding("asset-worker:query-asset-info",s):null}async function copyAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly(path_1.dirname(t));const a={source:await index_1.forwarding("asset-worker:query-path",e),target:await index_1.forwarding("asset-worker:query-path",t)};if(!a.source||!fs_extra_1.existsSync(a.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.source")} \nsource: ${e}`);if(Editor.Utils.Path.contains(a.target,a.source))throw new Error(`${Editor.I18n.t("asset-db.copyAsset.fail.include")} \nsource: ${e}\ntarget: ${t}`);const s=await generateURL(t);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)a.target=await index_1.forwarding("asset-worker:query-path",s);else if("cancel"===e)return null}fs_extra_1.existsSync(`${a.source}.meta`)&&(await fs_extra_1.copy(`${a.source}.meta`,`${a.target}.meta`),await utils_1.changeMetaUuid(`${a.target}.meta`)),await fs_extra_1.copy(a.source,a.target),await utils_1.changeMetaUuid(a.target),await refreshAsset(a.target);const n=await queryUUID(t);return n?await index_1.forwarding("asset-worker:query-asset-info",n):null}async function moveAsset(e,t,r){checkURL(e),checkURL(t),await checkReadonly(path_1.dirname(e)),await checkReadonly(path_1.dirname(t));const a={source:await index_1.forwarding("asset-worker:query-path",e),target:await index_1.forwarding("asset-worker:query-path",t)};if(!a.source||!fs_extra_1.existsSync(a.source))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.source")} \nsource: ${e}`);const s=await generateURL(t);if(e.toLowerCase()===t.toLowerCase()&&t!==s){const e={basename:path_1.basename(a.target),dirname:path_1.dirname(a.target)},r=path_1.join(e.dirname,".rename_temp");await fs_extra_1.rename(a.source+".meta",r+".meta"),await fs_extra_1.rename(a.source,r),await refreshAsset(a.source),await fs_extra_1.rename(r+".meta",a.target+".meta"),await fs_extra_1.rename(r,a.target),await refreshAsset(a.target);const s=await queryUUID(t);return s?await index_1.forwarding("asset-worker:query-asset-info",s):null}if(a.target.startsWith(path_1.join(a.source,"/")))throw new Error(`${Editor.I18n.t("asset-db.moveAsset.fail.parent")} \nsource: ${e}\ntarget: ${t}`);if(t!==s){const e=await handleAssetOption(t,r);if("rename"===e)a.target=await index_1.forwarding("asset-worker:query-path",s);else if("cancel"===e)return null;await utils_1.removeFile(a.target),await refreshAsset(a.target)}r||(r={}),r.overwrite=!0,await utils_1.moveFile(a.source+".meta",a.target+".meta",r),await utils_1.moveFile(a.source,a.target,r);const n=/db:\/\/[^/]+/.exec(e);n&&n[0]&&t.startsWith(n[0])?(await refreshAsset(a.target),await refreshAsset(path_1.dirname(a.source))):(await refreshAsset(a.source),await refreshAsset(a.target));const i=await queryUUID(t);return i?await index_1.forwarding("asset-worker:query-asset-info",i):null}async function deleteAsset(e){checkURL(e),await checkReadonly(e);const t=await queryUUID(e);if(!t)return null;const r=await index_1.forwarding("asset-worker:query-asset-info",t);try{await utils_1.removeFile(r.file),await refreshAsset(r.file),Editor.Selection.unselect("asset",t)}catch(e){return console.warn(`${Editor.I18n.t("asset-db.deleteAsset.fail.unknown")}`),console.warn(e),null}return r}async function saveAsset(e,t){const r=await queryUUID(e);if(await checkReadonly(e),void 0===t)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.content")}`);if(!r)throw new Error(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n${r}`);const a=await index_1.forwarding("asset-worker:query-asset-info",r);return await fs_extra_1.outputFile(a.file,t),await refreshAsset(a.file),a}async function saveAssetMeta(e,t){const r=await queryUUID(e);if(await checkReadonly(e),!t||"string"!=typeof t&&Buffer.isBuffer(t))throw new Error(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`);const a=await index_1.forwarding("asset-worker:query-asset-info",r);return await index_1.forwarding("asset-worker:save-asset-meta",r,t)?a:(console.warn(`${Editor.I18n.t("asset-db.saveAssetMeta.fail.content")}`),a)}async function reimportAsset(e){return await index_1.forwarding("asset-worker:reimport-asset",e)}async function createAssetDialog(e,t){if(e&&"string"!=typeof e)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type")} \n${e}`),null;if(t&&("string"!=typeof t||!t.startsWith("db://")))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.url")} \n${t}`),null;const r=asset_config_1.createAssetConfig[e];if(!r)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.type")} \n${e}`),null;const a=null===r.extension&&null===r.content,s=a?r.name:`${r.name}.${r.extension}`;let n=path_1.join(`${Editor.Project.path}`,"assets",s);if(t&&(n=await Editor.Message.request("asset-db","query-path",t)),!n)return null;if(n=utils_1.getName(n),n=(await Editor.Dialog.save({title:Editor.I18n.t("asset-db.createAsset.title"),path:n,filters:[{name:r.type,extensions:[r.extension]}]})).filePath||"",Array.isArray(n)&&(n=n[0]),!n)return null;if(a)await fs_extra_1.ensureDir(n),await refreshAsset(n);else{let e=r.content;if(r.template&&(e=await asset_config_1.getTemplateContent(r.template)),!(e instanceof Buffer||"string"==typeof e))return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.content")}`),null;await fs_extra_1.outputFile(n,e),await refreshAsset(n)}let i,o;try{i=await index_1.forwarding("asset-worker:query-url",n)}catch(e){}if(!i)return console.warn(`${Editor.I18n.t("asset-db.createAsset.fail.toUrl")} \n${n}`),null;try{o=await index_1.forwarding("asset-worker:query-uuid",i||"")}catch(e){}return o}async function queryAllImporter(){return await index_1.forwarding("asset-worker:query-all-importer")}async function queryAllAssetTypes(){return await index_1.forwarding("asset-worker:query-all-asset-types")}async function refreshAsset(e){return await index_1.forwarding("asset-worker:refresh-asset",e)}async function initAsset(e,t){const r=await index_1.forwarding("asset-worker:query-asset-info",e);if(!r)return console.warn(`${Editor.I18n.t("asset-db.saveAsset.fail.uuid")} \n${e}`),null;if(!t||"string"!=typeof t||!t.startsWith("db://"))return console.warn(`${Editor.I18n.t("asset-db.copyAsset.fail.url")} \ntarget: ${t}`),null;const a=await index_1.forwarding("asset-worker:query-path",t),s=path_1.parse(r.name),n=Object.keys(r.library).map(e=>r.library[e]);if(!n||0===n.length)return console.warn(`Unable to instantiate resource \nuuid: ${e}`),null;try{const e=path_1.join(a,s.name+r.instantiation);if(zip(e,n),await refreshAsset(e),!fs_extra_1.existsSync(e))throw new Error(`${Editor.I18n.t("asset-db.createAsset.fail.drop")} \n${e}`);const t=await queryUUID(e);return t?await index_1.forwarding("asset-worker:query-asset-info",t):null}catch(e){return console.error(e),null}}exports.zip=zip,exports.generateAvailableURL=generateAvailableURL,exports.createAsset=createAsset,exports.importAsset=importAsset,exports.copyAsset=copyAsset,exports.moveAsset=moveAsset,exports.deleteAsset=deleteAsset,exports.saveAsset=saveAsset,exports.saveAssetMeta=saveAssetMeta,exports.reimportAsset=reimportAsset,exports.createAssetDialog=createAssetDialog,exports.queryAllImporter=queryAllImporter,exports.queryAllAssetTypes=queryAllAssetTypes,exports.refreshAsset=refreshAsset,exports.initAsset=initAsset;