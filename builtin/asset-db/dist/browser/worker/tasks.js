"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setAutoRefresh=exports.refreshAllDatabase=exports.unregister=exports.register=exports.isReady=exports.getWorker=exports.depend=exports.reimportCheck=exports.autoRefresh=void 0;const path_1=require("path"),windows=require("@base/electron-windows"),worker=require("@base/electron-worker"),vDependence=require("v-dependence");let ready=!1,packageStartup=!1;exports.autoRefresh=!0,exports.reimportCheck=!1;const databaseMap={},profileMap={};function getWorker(){return databaseWorker}function isReady(){return ready}exports.depend=vDependence.create(),exports.getWorker=getWorker,exports.isReady=isReady;let engineInfo,databaseWorker=null;async function startPackageDatabase(e,a,t=!0){const r=a.mount;if(r){if(r.enable){if(profileMap[`packages/${e}.json(${r.enable})`]=e,!(await Editor.Profile.getProject(e,r.enable)||await Editor.Profile.getConfig(e,r.enable)))return}r.path&&await startDatabase({name:e,readonly:!!r.readonly,visible:!1!==r.visible,target:r.path},t)}}async function startDatabase(e,a=!0){if(!e.name||!e.target)return;const t={name:e.name,target:Editor.Utils.Path.normalize(e.target),readonly:!!e.readonly,temp:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"temp/asset-db",e.name)),library:Editor.Utils.Path.normalize((0,path_1.join)(Editor.Project.path,"library")),interval:500,binaryInterval:1e3,usePolling:!1,alwaysStat:!0,followSymlinks:!1,level:4,ignoreGlob:e.ignoreGlob,ignoreFiles:[".DS_Store",".rename_temp"],visible:e.visible,flags:{reimportCheck:exports.reimportCheck}};("number"!=typeof t.level||t.level<=0||t.level>4)&&(t.level=3),await databaseWorker.send("asset-worker:startup-database",t,a),Editor.Message.broadcast("asset-db:db-ready",e.name)}async function stopDatabase(e){await databaseWorker.send("asset-worker:shutdown-database",e),Editor.Message.broadcast("asset-db:db-close",e)}exports.depend.add("editor-init",{depends:[],async handle(){},async reset(){}}),exports.depend.add("engine-info",{depends:[],async handle(){engineInfo=await Editor.Message.request("engine","query-info",Editor.Project.type),exports.depend.finish("engine-info")},async reset(){}}),exports.depend.add("worker-init",{depends:[],async handle(){Editor.Metrics.trackTimeStart("asset-db:ready"),exports.autoRefresh=await Editor.Profile.getConfig("asset-db","autoScan"),exports.reimportCheck=await Editor.Profile.getConfig("asset-db","flagReimportCheck");const e=worker.create("Asset DB"),a=require.resolve("@editor/creator/dist/require");await e.init({preload:a}),e.require((0,path_1.join)(__dirname,"../../worker/index")),e.on("refresh",()=>{exports.depend.reset("worker-init")}),e.on("closed",()=>{exports.depend.reset("worker-init")}),e.on("asset-worker:startup",()=>{databaseWorker=e,exports.depend.finish("worker-init")})},async reset(){databaseWorker=null}}),exports.depend.add("worker-engine",{depends:["engine-info","worker-init"],async handle(){await databaseWorker.send("asset-worker:init",{engine:engineInfo.path,type:Editor.Project.type,dist:(0,path_1.join)(__dirname,"../../../dist")}),exports.depend.finish("worker-engine")},async reset(){}});const tasks=[];exports.depend.add("db-refresh",{depends:["engine-info","worker-engine"],async handle(){Editor.Metrics.trackTimeStart("asset-db:start-database");let e=(0,path_1.join)(engineInfo.path,"./editor/assets");e=e.replace("app.asar","app.asar.unpacked"),await startDatabase({name:"internal",target:e,readonly:!Editor.App.dev,visible:!0},!1);const a=await Editor.Profile.getConfig("asset-db","ignoreGlob");await startDatabase({name:"assets",target:(0,path_1.join)(Editor.Project.path,"assets"),readonly:!1,visible:!0,ignoreGlob:a},!1);for(const e in databaseMap)await startPackageDatabase(e,databaseMap[e],!1);Editor.Metrics.trackTimeEnd("asset-db:start-database",{output:!0}),packageStartup=!0,exports.depend.finish("db-refresh")},async reset(){}}),exports.depend.add("build-script",{depends:["db-refresh"],async handle(){await Editor.Message.request("programming","packer-driver/start"),await databaseWorker.send("asset-worker:init-script"),exports.depend.finish("build-script")}}),exports.depend.add("effect-data-processing",{depends:["db-refresh"],async handle(){await databaseWorker.send("asset-worker:effect-data-processing"),exports.depend.finish("effect-data-processing")}}),exports.depend.add("db-startup",{depends:["build-script","effect-data-processing"],async handle(){Editor.Metrics.trackTimeStart("asset-db:startup-await-database"),await databaseWorker.send("asset-worker:startup-await-database"),Editor.Metrics.trackTimeEnd("asset-db:startup-await-database",{output:!0}),exports.depend.finish("db-startup")}});let hasBindEvent=!1;async function register(e,a,t){const r=databaseMap[e]={};t.mount&&(r.mount={path:(0,path_1.join)(a,t.mount.path),readonly:t.mount.readonly,visible:t.mount.visible,enable:t.mount.enable},packageStartup&&startPackageDatabase(e,r))}function unregister(e){const a=databaseMap[e];a.mount&&a.mount.enable&&delete profileMap[`packages/${e}.json(${a.mount.enable})`],delete databaseMap[e],stopDatabase(e)}exports.depend.add("asset-db-ready",{depends:["db-startup"],async handle(){ready=!0,Editor.Message.broadcast("asset-db:ready"),Editor.Metrics.trackTimeEnd("asset-db:ready",{output:!0}),await databaseWorker.send("asset-worker:database-ready"),!1===hasBindEvent&&(hasBindEvent=!0,windows.on("blur",()=>{}),windows.on("focus",()=>{exports.autoRefresh&&refreshAllDatabase()}))},async reset(){ready=!1,Editor.Message.broadcast("asset-db:close")}}),Editor.Profile.on("change",(e,a,t,r)=>{if("local"===e||"global"===e||"project"===e){const e=profileMap[`${a}(${t})`];e&&packageStartup&&(r?startPackageDatabase(e,databaseMap[e]):stopDatabase(e))}}),exports.register=register,exports.unregister=unregister;let refreshALlDatabaseTimer=null;function refreshAllDatabase(){clearTimeout(refreshALlDatabaseTimer),refreshALlDatabaseTimer=setTimeout(()=>{databaseWorker&&databaseWorker.send("asset-worker:refresh-all-database").then(()=>{})},100)}function setAutoRefresh(e){exports.autoRefresh=e}exports.refreshAllDatabase=refreshAllDatabase,exports.setAutoRefresh=setAutoRefresh;