"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openAsset=void 0;const child_process_1=require("child_process"),electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),tasks_1=require("./worker/tasks"),parse=require("plist").parse;function openAssetWithProgram(e,r,t){t=t||[];let s="";if("darwin"===process.platform){if(r.endsWith(".app")){r=(0,path_1.join)(r,"/Contents/MacOS/");const e=parse((0,fs_extra_1.readFileSync)((0,path_1.join)(r,"../Info.plist"),"utf8"));r=(0,path_1.join)(r,e.CFBundleExecutable)}s="open",t?(t.splice(0,0,r),t.splice(0,0,"-a")):t=["-a",r,e]}else s=r,t||(t=[e]);(0,child_process_1.spawn)(s,t,{detached:!0,stdio:"ignore"}).unref()}const openerMap={"*"(e){const r=(0,tasks_1.getOpenMessage)(e.importer);r?Editor.Message.send(r.target,r.message,{file:e.file,uuid:e.uuid}):e&&e.file&&electron_1.shell.openPath(e.file)},scene(e){Editor.Message.send("scene","open-scene",e.uuid)},prefab(e){Editor.Message.send("scene","open-scene",e.uuid)},javascript(e){openCodeAsset(e)},typescript(e){openCodeAsset(e)},effect(e){openCodeAsset(e)},image(e){openImageAsset(e)},"animation-graph"(e){Editor.Message.send("animation-graph","open",e.uuid)},"animation-mask"(e){},"shader-graph"(e){Editor.Message.send("shader-graph","open",e.uuid)}};async function getCodeEditor(){let e="";const r=await Editor.Message.request("program","query-program-info","scriptEditor");if(r&&r.path)e=r.path;else try{console.warn(Editor.I18n.t("asset-db.openAsset.preferenceProgramWarning",{preferences:Editor.I18n.t("preferences.title"),program:Editor.I18n.t("program.title"),scriptEditor:Editor.I18n.t("program.label.script_editor")}));const r=await electron_1.app.getApplicationInfoForProtocol("vscode://");"Visual Studio Code"===r.name&&(e=r.path)}catch(e){}return e}async function openCodeAsset(e){const r=await getCodeEditor();(0,fs_extra_1.existsSync)(r)?openAssetWithProgram(e.file,r,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openImageAsset(e){let r="";const t=await Editor.Message.request("program","query-program-info","pictureEditor");t&&t.path&&(r=t.path),(0,fs_extra_1.existsSync)(r)?openAssetWithProgram(e.file,r,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openAsset(e){let r;if(!(r=e.startsWith("db://")?await(0,index_1.forwarding)("asset-worker:query-uuid",e):e))throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);const t=await(0,index_1.forwarding)("asset-worker:query-asset-info",r);if(!t)throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);try{(openerMap[t.importer]||openerMap["*"])(t)}catch(e){if(openerMap["*"](t),"string"==typeof e)throw new Error(e)}}exports.openAsset=openAsset;