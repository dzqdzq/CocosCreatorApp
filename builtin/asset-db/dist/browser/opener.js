"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openAsset=void 0;const child_process_1=require("child_process"),electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),parse=require("plist").parse;function openAssetWithProgram(e,t,o){o=o||[];let r="";if("darwin"===process.platform){if(t.endsWith(".app")){t=(0,path_1.join)(t,"/Contents/MacOS/");const e=parse((0,fs_extra_1.readFileSync)((0,path_1.join)(t,"../Info.plist"),"utf8"));t=(0,path_1.join)(t,e.CFBundleExecutable)}r="open",o?(o.splice(0,0,t),o.splice(0,0,"-a")):o=["-a",t,e]}else r=t,o||(o=[e]);(0,child_process_1.spawn)(r,o,{detached:!0,stdio:"ignore"}).unref()}const openerMap={"*"(e){e&&e.file&&electron_1.shell.openPath(e.file)},scene(e){Editor.Message.send("scene","open-scene",e.uuid)},prefab(e){Editor.Message.send("scene","open-scene",e.uuid)},javascript(e){openCodeAsset(e)},typescript(e){openCodeAsset(e)},effect(e){openCodeAsset(e)},image(e){openImageAsset(e)},"animation-graph"(e){Editor.Message.send("animation-graph","open",e.uuid)}};async function getCodeEditor(){let e="";const t=await Editor.Profile.getConfig("program","script_editor");if(t)e=t;else try{console.warn(Editor.I18n.t("asset-db.openAsset.preferenceProgramWarning"));const t=await electron_1.app.getApplicationInfoForProtocol("vscode://");"Visual Studio Code"===t.name&&(e=t.path)}catch(e){}return e}async function openCodeAsset(e){const t=await getCodeEditor();(0,fs_extra_1.existsSync)(t)?openAssetWithProgram(e.file,t,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openImageAsset(e){let t="";const o=await Editor.Profile.getConfig("program","picture_editor");o&&(t=o),(0,fs_extra_1.existsSync)(t)?openAssetWithProgram(e.file,t,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openAsset(e){let t;if(!(t=e.startsWith("db://")?await(0,index_1.forwarding)("asset-worker:query-uuid",e):e))throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);const o=await(0,index_1.forwarding)("asset-worker:query-asset-info",t);if(!o)throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);try{(openerMap[o.importer]||openerMap["*"])(o)}catch(e){if(openerMap["*"](o),"string"==typeof e)throw new Error(e)}}exports.openAsset=openAsset;