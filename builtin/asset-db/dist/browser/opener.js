"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openAsset=void 0;const child_process_1=require("child_process"),electron_1=require("electron"),fs_extra_1=require("fs-extra"),path_1=require("path"),index_1=require("./worker/index"),parse=require("plist").parse;function openAssetWithProgram(e,r,t){t=t||[];let o="";if("darwin"===process.platform){if(r.endsWith(".app")){r=path_1.join(r,"/Contents/MacOS/");const e=parse(fs_extra_1.readFileSync(path_1.join(r,"../Info.plist"),"utf8"));r=path_1.join(r,e.CFBundleExecutable)}o="open",t?(t.splice(0,0,r),t.splice(0,0,"-a")):t=["-a",r,e]}else o=r,t||(t=[e]);child_process_1.spawn(o,t,{detached:!0,stdio:"ignore"}).unref()}const openerMap={"*"(e){e&&e.file&&electron_1.shell.openPath(e.file)},scene(e){Editor.Message.send("scene","open-scene",e.uuid)},prefab(e){Editor.Message.send("scene","open-scene",e.uuid)},javascript(e){openCodeAsset(e)},typescript(e){openCodeAsset(e)},effect(e){openCodeAsset(e)},image(e){openImageAsset(e)}};async function getCodeEditor(){let e="";e="darwin"===process.platform?"/Applications/Visual Studio Code.app":"C:\\Program Files (x86)\\Microsoft VS Code\\Code.exe";const r=await Editor.Profile.getConfig("program","script_editor");return r&&(e=r),e}async function openCodeAsset(e){const r=await getCodeEditor();fs_extra_1.existsSync(r)?openAssetWithProgram(e.file,r,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openImageAsset(e){let r="";const t=await Editor.Profile.getConfig("program","picture_editor");t&&(r=t),fs_extra_1.existsSync(r)?openAssetWithProgram(e.file,r,[Editor.Project.path,e.file]):openerMap["*"](e)}async function openAsset(e){let r;if(!(r=e.startsWith("db://")?await index_1.forwarding("asset-worker:query-uuid",e):e))throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);const t=await index_1.forwarding("asset-worker:query-asset-info",r);if(!t)throw new Error(`The resource does not exist and cannot be opened.\n  urlOrUUID: ${e}`);try{(openerMap[t.importer]||openerMap["*"])(t)}catch(e){throw openerMap["*"](t),new Error(e)}}exports.openAsset=openAsset;