"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.changeMetaUuid=changeMetaUuid,exports.isLegalMetaFile=isLegalMetaFile,exports.metricCreateAsset=metricCreateAsset,exports.formatCreateMenu=formatCreateMenu,exports.sortAssetCreateMenu=sortAssetCreateMenu,exports.handleAssetOption=handleAssetOption;const fs_extra_1=require("fs-extra"),path_1=require("path"),asset_config_1=require("./asset-config"),v4=require("node-uuid")["v4"];async function changeMetaUuid(e){var t=(0,fs_extra_1.statSync)(e);if(t.isDirectory())for(const r of await(0,fs_extra_1.readdir)(e))await changeMetaUuid((0,path_1.join)(e,r));else if((0,fs_extra_1.existsSync)(e)&&e.endsWith(".meta"))try{var a=await(0,fs_extra_1.readJson)(e);a.uuid=v4(),await(0,fs_extra_1.outputJson)(e,a)}catch(e){console.warn(""+Editor.I18n.t("asset-db.copyAsset.fail.metauuid")),console.warn(e)}}async function isLegalMetaFile(e){if(!(0,fs_extra_1.existsSync)(e)||!e.endsWith(".meta"))return!1;if(!(0,fs_extra_1.statSync)(e).isFile())return!1;try{var t=await(0,fs_extra_1.readJson)(e);return"subMetas"in t&&"userData"in t?!0:!1}catch(e){return!1}}function metricCreateAsset(e){let t="",a="";e.endsWith(".animgraph")?(t="animationStateMachine",a="A100000"):e.endsWith(".animask")&&(t="animationStateMachine",a="A100001"),t&&a&&Editor.Metrics._trackEventWithTimer({category:t,id:a,value:1})}function formatCreateMenu(e){const a=[],t={},r={},s=(e.forEach(e=>{(e.group?(t[e.group]||(t[e.group]={handler:e.group,list:[]},a.push(t[e.group])),collectCreateTemplateFromMenu(e,r),t[e.group].list):(collectCreateTemplateFromMenu(e,r),a)).push(e)}),[]);sortAssetCreateMenu(a),a.forEach((e,t)=>{e.list?s.push(...e.list):s.push(e),t!==a.length-1&&s.push({type:"separator"})});e=sortAssetCreateMenu(Object.values(r));return s.push({label:"i18n:asset-db.createAssetTemplate.title",submenu:e}),s}function collectCreateTemplateFromMenu(e,t){return e.handler&&e.template&&!t[e.handler]?t[e.handler]={label:e.label,handler:e.handler,message:{target:"asset-db",name:"create-asset-template",params:[e.handler,e.template||""]}}:e.submenu&&e.submenu.forEach(e=>collectCreateTemplateFromMenu(e,t)),t}function sortAssetCreateMenu(e){return e.sort((e,t)=>{return(asset_config_1.createListOrder.includes(e.handler)?asset_config_1.createListOrder.indexOf(e.handler):asset_config_1.createListOrder.length)-(asset_config_1.createListOrder.includes(t.handler)?asset_config_1.createListOrder.indexOf(t.handler):asset_config_1.createListOrder.length)}),e}async function handleAssetOption(e,t){return(t=t||{}).overwrite?"overwrite":t.rename?"rename":0===(t=await Editor.Dialog.warn(Editor.I18n.t("asset-db.operation.overwrite"),{title:Editor.I18n.t("asset-db.operate.dialogQuestion"),detail:e,buttons:[Editor.I18n.t("asset-db.operate.overwrite"),Editor.I18n.t("asset-db.operate.rename"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:2})).response?"overwrite":1===t.response?"rename":"cancel"}