"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),path_1=require("path"),fntParser=require("../../../static/utils/fnt-parser");function getRealFntTexturePath(e,t){const r=path_1.basename(e),a=path_1.join(path_1.dirname(t),r);return fs_extra_1.existsSync(a)||console.error("Parse Error: Unable to find file Texture, the path: "+a),a}class BitmapImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"bitmap-font"}async validate(e){return!0}async import(e){let t=!1;if(!await e.existsInLibrary(".json")){const r=await fs_extra_1.readFile(e.source,"utf8");let a;try{a=fntParser.parseFnt(r)}catch(t){throw console.error(t),new Error(`BitmapFont import failed: ${e.uuid} file parsing failed`)}if(e.userData._fntConfig=a,!a.fontSize)return t;e.userData.fontSize=a.fontSize;const s=getRealFntTexturePath(a.atlasName,e.source);if(e.depend(s),!e.userData.textureUuid&&this.assetDB&&(e.userData.textureUuid=this.assetDB.pathToUuid(s)),e.userData.textureUuid&&this.assetDB){const r=this.assetDB.getAsset(e.userData.textureUuid);if(r){const a=this.createBitmapFnt(e);a.spriteFrame=EditorExtends.serialize.asAsset(r.uuid+"@sprite-frame"),await e.saveToLibrary(".json",EditorExtends.serialize(a)),t=!0}}}return t}createBitmapFnt(e){const t=new cc.BitmapFont;return t.name=path_1.basename(e.source,e.extname),t.fontSize=e.userData.fontSize,t._fntConfig=e.userData._fntConfig,t}}exports.default=BitmapImporter;