"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_1=require("fs"),utils_1=require("../utils"),imageUtils=require("../../../static/utils/image");class SpriteImporter extends asset_db_1.Importer{get version(){return"1.0.1"}get name(){return"sprite-frame"}async validate(t){return!0}async import(t){let e=!1;if(await t.existsInLibrary(".json")||!t.parent)return e;if("texture"===t.parent.meta.importer){const e=t.parent.library+(t.parent.extname||"");if(!e||!fs_1.existsSync(e))throw new Error(`Spriteframe import failed: The picture file [${t.userData.textureUuid}] does not exist`);const r=t.userData,i=await imageUtils.getImageData(e);r.trimThreshold=1,r.rotated=!1,r.rawWidth=i.width,r.rawHeight=i.height;const s=utils_1.getTrimRect(i.data,r.rawWidth,r.rawHeight,r.trimThreshold);r.trimX=s[0],r.trimY=s[1],r.width=s[2],r.height=s[3],r.offsetX=r.trimX+r.width/2-r.rawWidth/2,r.offsetY=-(r.trimY+r.height/2-r.rawHeight/2),r.borderTop=utils_1.clamp(r.borderTop||0,0,r.height-(r.borderBottom||0)),r.borderBottom=utils_1.clamp(r.borderBottom||0,0,r.height-(r.borderTop||0)),r.borderLeft=utils_1.clamp(r.borderLeft||0,0,r.width-(r.borderRight||0)),r.borderRight=utils_1.clamp(r.borderRight||0,0,r.width-(r.borderLeft||0)),r.vertices=void 0}const r=this.createSpriteFrame(t);return await t.saveToLibrary(".json",JSON.stringify({__type__:"cc.SpriteFrame",content:this.serialize(r,t)},null,2)),e=!0}createSpriteFrame(t){const e=t.userData,r=new cc.SpriteFrame;return r.name="sprite-frame",r.setOriginalSize(cc.size(e.rawWidth,e.rawHeight)),r.setRect(cc.rect(0,0,e.width,e.height)),r._textureFilename=e.textureFile,r.setRect(cc.rect(e.trimX,e.trimY,e.width,e.height)),r.setRotated(e.rotated),r.insetTop=e.borderTop,r.insetBottom=e.borderBottom,r.insetLeft=e.borderLeft,r.insetRight=e.borderRight,r.vertices=e.vertices,r.setOffset(cc.v2(e.offsetX,e.offsetY)),r}serialize(t,e){const r=t._rect,i=t._offset,s=t._originalSize,a=e.userData.textureUuid;let o,n;return(t.insetLeft||t.insetTop||t.insetRight||t.insetBottom)&&(o=[t.insetLeft,t.insetTop,t.insetRight,t.insetBottom]),t.vertices&&(n={triangles:t.vertices.triangles,x:t.vertices.x,y:t.vertices.y,u:t.vertices.u,v:t.vertices.v}),{name:t._name,texture:a||void 0,atlas:t._atlasUuid||"",rect:r?[r.x,r.y,r.width,r.height]:void 0,offset:i?[i.x,i.y]:void 0,originalSize:s?[s.width,s.height]:void 0,rotated:t._rotated?1:void 0,capInsets:o,vertices:n}}}exports.default=SpriteImporter;