"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),babel=require("@babel/core"),uuidUtils=require("../../../static/utils/uuid-utils");class JavascriptImporter extends asset_db_1.Importer{get version(){return"1.0.2"}get name(){return"javascript"}async validate(e){return!0}async import(e){let r=!1;try{if(!await e.existsInLibrary(".js")){const a=await this.compile(e),s=`\n                    'use strict';\n                    cc._RF.push(module, '${uuidUtils.compressUuid(e.uuid)}', '${e.basename}');\n                    // ${e.basename}\n\n                `,t="\ncc._RF.pop();\n";a.code=s+a.code+t,await e.saveToLibrary(".js",a.code),await e.saveToLibrary(".js.map",JSON.stringify(a.map)),r=!0}}catch(e){console.error(e)}return r}async compile(e){const r=require("convert-source-map"),a=await fs_extra_1.readFile(e.source,"utf8"),s=!!r.fromSource(a),{code:t,map:i=""}=babel.transformSync(a,{ast:!1,compact:!1,filename:e.source,highlightCode:!1,inputSourceMap:s,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],require("@babel/plugin-proposal-class-properties"),require("babel-plugin-add-module-exports")],sourceMaps:!0});return{code:t,map:i}}}exports.default=JavascriptImporter;