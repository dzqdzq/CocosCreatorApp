"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),babel=require("@babel/core"),uuidUtils=require("../../../static/utils/uuid-utils");class TypescriptImporter extends asset_db_1.Importer{get version(){return"1.0.2"}get name(){return"typescript"}async validate(e){return!0}async import(e){let r=!1;try{if(!await e.existsInLibrary(".js")){const s=await this.compile(e),t=`\n                    'use strict';\n                    cc._RF.push(module, '${uuidUtils.compressUuid(e.uuid)}', '${e.basename}');\n                    // ${e.basename}\n\n                `,a="\ncc._RF.pop();\n";s.code=t+s.code+a,await e.saveToLibrary(".ts",s.code),await e.saveToLibrary(".ts.map",JSON.stringify(s.map)),r=!0}}catch(e){console.error(e)}return r}async compile(e){const r=require("convert-source-map"),s=await fs_extra_1.readFile(e.source,"utf8"),t=!!r.fromSource(s),{code:a,map:i=""}=babel.transformSync(s,{ast:!1,compact:!1,filename:e.source,highlightCode:!1,inputSourceMap:t,presets:[require("@babel/preset-env")],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],require("babel-plugin-add-module-exports")],sourceMaps:!0});return{code:a,map:i}}}exports.default=TypescriptImporter;