"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),TMX_ENCODING={encoding:"utf-8"},DOMParser=require("xmldom").DOMParser,fs=require("fs"),path=require("path");function searchDependFiles(e,t){const s=(new DOMParser).parseFromString(t);if(!s)return cb(new Error(cc.debug.getError(7222,e)));let r=[];const a=[];let n=[];const i=s.documentElement.getElementsByTagName("tileset");return Array.prototype.forEach.call(i,t=>{const s=t.getAttribute("source");if(s){const t=path.join(path.dirname(e),s);if(fs.existsSync(t)){a.push(s);const e=fs.readFileSync(t,"utf-8"),i=(new DOMParser).parseFromString(e);if(i){const{srcs:e,names:s}=parseTilesetImages(i,t);r.concat(e),n.concat(s)}else console.warn("Parse %s failed.",t)}}const{srcs:i,names:o}=parseTilesetImages(t,e);r=r.concat(i),n=n.concat(o)}),{textures:r,tsxFiles:a,textureNames:n}}function parseTilesetImages(e,t){const s=e.getElementsByTagName("image"),r=[],a=[];return Array.prototype.forEach.call(s,e=>{const s=e.getAttribute("source");if(s){const e=path.join(path.dirname(t),s);r.push(e);const n=path.basename(e);a.push(n)}}),{srcs:r,names:a}}class TiledMapImporter extends asset_db_1.Importer{get version(){return"1.0.1"}get name(){return"tiled-map"}get assetType(){return"cc.TileMapAsset"}async validate(e){return!0}async import(e){let t=!1;if(await e.existsInLibrary(e.extname)||(await e.copyToLibrary(e.extname,e.source),t=!0),!await e.existsInLibrary(".json")){const s=new cc.TiledMap,r=fs.readFileSync(e.source,TMX_ENCODING);s.tmxXmlStr=r;const a=searchDependFiles(e.source,r);s.textures=a.textures,s.tsxFiles=a.tsxFiles,s.textureNames=a.textureNames,await e.saveToLibrary(".json",JSON.stringify({__type__:"cc.TiledMap",content:this.serialize(s,e)},null,2)),t=!0}return t}serialize(e,t){const{textures:s,tmxXmlStr:r,tsxFiles:a}=e,n=[];return s.map(e=>{n.push({__uuid__:this.assetDB.pathToUuid(e)})}),{_name:t.basename,_objFlags:0,_rawFiles:null,tmxXmlStr:r,tmxFolderPath:t.source,textures:n,tsxFiles:a}}}exports.default=TiledMapImporter;