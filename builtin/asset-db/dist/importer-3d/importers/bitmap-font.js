"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),path_1=require("path"),image_utils_1=require("./utils/image-utils"),fntParser=require("../../../static/utils/fnt-parser");function getRealFntTexturePath(t,e){const r=path_1.basename(t),s=path_1.join(path_1.dirname(e),r);return fs_extra_1.existsSync(s)||console.error("Parse Error: Unable to find file Texture, the path: "+s),s}let DoNotNotify=!1;class BitmapImporter extends asset_db_1.Importer{constructor(){super(...arguments),this.showPopups=!0}get version(){return"1.0.5"}get name(){return"bitmap-font"}get assetType(){return"cc.BitmapFont"}get assetExtends(){return["cc.Font"]}async validate(t){return!0}async import(t){const e=await fs_extra_1.readFile(t.source,"utf8");let r;try{r=fntParser.parseFnt(e)}catch(e){throw console.error(e),new Error(`BitmapFont import failed: ${t.uuid} file parsing failed`)}if(t.userData._fntConfig=r,!r.fontSize)return console.error(`BitmapFont import failed: ${t.uuid} file parsing failed, There is no 'fontSize' in the configuration.`),!1;t.userData.fontSize=r.fontSize;const s=getRealFntTexturePath(r.atlasName,t.source);if(t.depend(s),!this.assetDB.pathToUuid(s))return this.showPopups=!1,!1;if(this.assetDB&&(t.userData.textureUuid=this.assetDB.pathToUuid(s)),t.userData.textureUuid&&this.assetDB){const e=asset_db_1.queryAsset(t.userData.textureUuid);if(e&&e.imported){this.showPopups&&await image_utils_1.checkImageType(e,DoNotNotify,"BitmapFont","sprite-frame");const r=this.createBitmapFnt(t);r.spriteFrame=EditorExtends.serialize.asAsset(e.uuid+"@f9941"),await t.saveToLibrary(".json",EditorExtends.serialize(r))}}return this.showPopups=!0,!0}createBitmapFnt(t){const e=new cc.BitmapFont;return e.name=path_1.basename(t.source,t.extname),e.fontSize=t.userData.fontSize,e.fntConfig=t.userData._fntConfig,e}}exports.default=BitmapImporter;