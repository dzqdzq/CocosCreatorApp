"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=require("fs-extra"),path_1=require("path"),migratesNameToId=__importStar(require("./migrates/name2id")),sprite_frame_1=require("./sprite-frame"),sprite_atlas_1=__importStar(require("./sprite-atlas")),plist=require("plist");class TexturePackerImporter extends sprite_atlas_1.default{get version(){return"1.0.6"}get migrations(){return[{version:"1.0.4",migrate:migratesNameToId.migrate}]}async validate(e){try{const t=plist.parse(await fs_extra_1.readFile(e.source,"utf8"));return void 0!==t.frames&&void 0!==t.metadata}catch(e){return!1}}async import(e){const t=path_1.extname(e.source);await e.copyToLibrary(t,e.source);const r=e.userData,a=await fs_extra_1.readFile(e.source,"utf8"),s=plist.parse(a),i=s.metadata;if(r.atlasTextureName=i.realTextureFileName||i.textureFileName,r.format=i.format,r.uuid=e.uuid,this.assetDB){const t=path_1.basename(r.atlasTextureName),a=path_1.join(path_1.dirname(e.source),t);fs_extra_1.existsSync(a)||console.error("Parse Error: Unable to find file Texture, the path: "+a),e.depend(a);const s=this.assetDB.pathToUuid(a);if(!s)return!1;r.textureUuid=s+"@"+require("@editor/asset-db/libs/utils").nameToId("texture")}if(e.userData.textureUuid&&this.assetDB){const t=/\.[^.]+$/;let a="";const i=Object.keys(s.frames),o=new cc.SpriteAtlas;o.name=path_1.basename(e.source,e.extname);for(const u of i){a=u.replace(t,"");const i=s.frames[u],n=await e.createSubAsset(a,"sprite-frame"),d=this.fillFrameData(i,r);d.borderBottom=d.borderBottom|n.userData.borderBottom,d.borderTop=d.borderTop|n.userData.borderTop,d.borderLeft=d.borderLeft|n.userData.borderLeft,d.borderRight=d.borderRight|n.userData.borderRight,n.assignUserData(d,!0),n.userData.imageUuidOrDatabaseUri=d.imageUuidOrDatabaseUri;const c=u.split(".");c.pop();const f=c.join(".");o.spriteFrames[f]=EditorExtends.serialize.asAsset(n.uuid)}await e.saveToLibrary(".json",EditorExtends.serialize(o))}return!0}fillFrameData(e,t){const r=t.format,a=sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(t.textureUuid,t.uuid);let s=!1,i="",o="",u="";1===r||2===r?(s=e.rotated,i=e.sourceSize,o=e.offset,u=e.frame):3===r&&(s=e.textureRotated,i=e.spriteSourceSize,o=e.spriteOffset,u=e.textureRect),a.rotated=s;const n=sprite_atlas_1._parseFloat2(i,cc.Size);a.rawWidth=n.width,a.rawHeight=n.height;const d=sprite_atlas_1._parseRect(u);a.trimX=d.x,a.trimY=d.y,a.width=d.width,a.height=d.height;const c=sprite_atlas_1._parseFloat2(o,cc.Vec2);return a.offsetX=c.x,a.offsetY=c.y,a}}exports.default=TexturePackerImporter;