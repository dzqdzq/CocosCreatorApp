"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfImporter=void 0;const asset_db_1=require("@editor/asset-db"),ajv_1=__importDefault(require("ajv")),assert_1=require("assert"),fs=__importStar(require("fs-extra")),path=__importStar(require("path")),urijs_1=__importDefault(require("urijs")),url_1=__importDefault(require("url")),asset_finder_1=require("./gltf/asset-finder"),material_1=require("./gltf/material"),reader_manager_1=require("./gltf/reader-manager"),texture_1=require("./texture"),migratesNameToId=__importStar(require("./migrates/name2id")),uri_utils_1=require("./utils/uri-utils"),cc_1=require("cc"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),editor_1=require("editor"),resolve_glTF_image_path_1=require("./utils/resolve-glTF-image-path"),serialize_library_1=require("./utils/serialize-library"),original_animation_1=require("./gltf/original-animation"),path_1=require("path"),ajv=new ajv_1.default({errorDataPath:""});class GltfImporter extends asset_db_1.Importer{constructor(e){super(e);const t=path.join(__dirname,"..","..","..","static","meta-schemas","glTF.meta.json"),a=fs.readJSONSync(t);this._metaValidator=ajv.compile(a)}get version(){return"2.1.4"}get name(){return"gltf"}get migrations(){return[{version:"1.1.21",migrate(e){delete e.meta.userData.assetFinder}},{version:"1.1.23",migrate:migratesNameToId.migrate},{version:"1.3.0",migrate:migrateImageLocations},{version:"1.3.21",migrate:migrateDumpMaterial},{version:"2.0.0",migrate:migrateFbxConverterSelector},{version:"2.0.8",migrate:migrateFbxConverterUnitConversion}]}async import(e){return await this._validateMeta(e),await this._importSubAssets(e)}async getGltfFilePath(e){const t=e.userData;return t.meshOptimizer?await this.getOptimizerPath(e,e.source,t.meshOptimizerOptions||{}):e.source}async getOptimizerPath(e,t,a){const s=e._assetDB.options.temp,r=path.join(s,`gltfpack-${e.uuid}`);fs.ensureDirSync(r);const i=path.join(r,"out.gltf"),n=path.join(r,"status.json"),o={mtimeMs:(await fs_extra_1.stat(e.source)).mtimeMs,version:this.version,options:JSON.stringify(a)};if(fs_extra_1.existsSync(i)&&fs_extra_1.existsSync(n))try{const e=await fs_extra_1.readJSON(n);if(e.mtimeMs===o.mtimeMs&&e.version===o.version&&e.options===o.options)return i}catch(e){}return new Promise(e=>{try{const s=path.join(editor_1.App.path,"./node_modules/gltfpack/bin/gltfpack.js"),r=["-i",t,"-o",i],u=a.c;"1"===u?r.push("-c"):"2"===u&&r.push("-cc"),a.te&&r.push("-te"),a.tb&&r.push("-tb"),a.tc&&r.push("-tc"),50!==a.tq&&void 0!==a.tq&&(r.push("-tq"),r.push(a.tq)),a.tu&&r.push("-tu"),1!==a.si&&void 0!==a.si&&(r.push("-si"),r.push(a.si)),a.sa&&r.push("-sa"),14!==a.vp&&void 0!==a.vp&&(r.push("-vp"),r.push(a.vp)),12!==a.vt&&void 0!==a.vt&&(r.push("-vt"),r.push(a.vt)),8!==a.vn&&void 0!==a.vn&&(r.push("-vn"),r.push(a.vn)),16!==a.at&&void 0!==a.at&&(r.push("-at"),r.push(a.at)),12!==a.ar&&void 0!==a.ar&&(r.push("-ar"),r.push(a.ar)),16!==a.as&&void 0!==a.as&&(r.push("-as"),r.push(a.as)),30!==a.af&&void 0!==a.af&&(r.push("-af"),r.push(a.af)),a.ac&&r.push("-ac"),a.kn&&r.push("-kn"),a.ke&&r.push("-ke"),a.cf&&r.push("-cf"),(a.noq||void 0===a.noq)&&r.push("-noq"),(a.v||void 0===a.v)&&r.push("-v"),child_process_1.fork(s,r).on("exit",async t=>{await fs.writeFile(n,JSON.stringify(o,void 0,2)),e(i)})}catch(a){console.error(a),e(t)}})}async _validateMeta(e){if(!await this._metaValidator(e.meta.userData)){0!==Object.keys(e.meta.userData).length&&console.warn("Meta file of asset "+e.source+" is damaged: \n"+(this._metaValidator.errors||[]).map(e=>e.message)+"\nA default meta file is generated.");const t={imageMetas:[],legacyFbxImporter:!1};e.meta.userData=t}}async _importSubAssets(e){var t;reader_manager_1.glTfReaderManager.delete(e);const a=await reader_manager_1.glTfReaderManager.getOrCreate(e,!0);await this._adjustMeta(e,a);const s=e.userData,r=new asset_finder_1.DefaultGltfAssetFinder(s.assetFinder),i=await this._importMeshes(e,a);r.set("meshes",i),await this._saveOriginalAnimations(e,a,!0);const{animationImportSettings:n}=s;if(n)for(const a of n)for(const s of a.splits){const r=(await e.createSubAsset(`${s.name}.animation`,"gltf-animation")).userData;r.gltfIndex=n.indexOf(a),void 0!==s.wrapMode&&(r.wrapMode=s.wrapMode),void 0!==s.speed&&(r.speed=s.speed),r.sample=null!==(t=s.fps)&&void 0!==t?t:a.fps,r.span={from:s.from,to:s.to}}const o=await this._importSkins(e,a);r.set("skeletons",o),await this._importImages(e,a);const u=await this._importTextures(e,a);r.set("textures",u);const m=await this._importMaterials(e,a,r);r.set("materials",m);const l=await this._importScenes(e,a);return r.set("scenes",l),s.dumpMaterials&&!m.every(e=>null!==e)?(console.debug("Waiting for dependency materials..."),!1):(s.assetFinder=r.serialize(),!0)}async _adjustMeta(e,t){const a=e.userData,s=t.gltf.images;if(s){const e=a.imageMetas,t=s.map((t,a)=>{const r={};if(t.name){if(r.name=t.name,e){const t=e.find(e=>e.remap&&e.name&&e.name===r.name);t&&(r.remap=t.remap)}}else e&&s.length===e.length&&!e[a].name&&e[a].remap&&(r.remap=e[a].remap);return r});a.imageMetas=t}else a.imageMetas=[];const r=t.gltf.animations;if(r){const s=a.animationImportSettings||[],i=makeUniqueSubAssetNames(e.basename,r,"animations",""),n=r.map((a,n)=>{const o=t.getAnimationDuration(n),u=a.name||i[n];let m=u;if(1===r.length){const t=path.basename(e.basename,path.extname(e.basename)).split("@");t.length>1&&(m=t[t.length-1])}const l={name:u,duration:o,fps:30,splits:[{name:m,from:0,to:o,wrapMode:cc_1.AnimationClip.WrapMode.Loop}]};let c=s.find(e=>e.name===l.name);if(c||s.length!==a.length||(c=s[n]),c){l.fps=c.fps;const e=e=>e===c.duration?o:Math.min(e,o);l.splits=c.splits.map(t=>{var a;return{name:t.name,from:e(t.from),to:e(t.to),fps:t.fps,wrapMode:null!==(a=t.wrapMode)&&void 0!==a?a:cc_1.AnimationClip.WrapMode.Loop,speed:t.speed}})}return l});a.animationImportSettings=n}else delete a.animationImportSettings}async _importMeshes(e,t){const a=t.gltf.meshes;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"meshes",".mesh"),r=new Array(a.length);for(let t=0;t<a.length;t++){a[t];const i=await e.createSubAsset(s[t],"gltf-mesh");i.userData.gltfIndex=t,r[t]=i.uuid}return r}async _importSkins(e,t){const a=t.gltf.skins;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"skeletons",".skeleton"),r=new Array(a.length);for(let t=0;t<a.length;t++){a[t];const i=await e.createSubAsset(s[t],"gltf-skeleton");i.userData.gltfIndex=t,r[t]=i.uuid}return r}async _importImages(e,t){const a=t.gltf.images;if(void 0===a)return;const s=e.userData,r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",i=e=>(()=>{const e=t.gltf.asset.generator;return null===e||void 0===e?void 0:e.includes("FBX2glTF")})()&&e===r,n=e=>(()=>{const e=t.gltf.asset.generator;return null===e||void 0===e?void 0:e.includes("FBX-glTF-conv")})()&&e===r,o=makeUniqueSubAssetNames(e.basename,a,"images",".image");for(let r=0;r<a.length;++r){const u=a[r],m=s.imageMetas[r],l=u.uri;let c,p=!1;if(l&&(i(l)||n(l)))p=!0;else if(l&&!l.startsWith("data:")){const e=t.path,a=url_1.default.pathToFileURL(e).toString();try{let e=new urijs_1.default(l);e=e.absoluteTo(a),uri_utils_1.convertsEncodedSeparatorsInURI(e),"file"===e.scheme()&&(c=url_1.default.fileURLToPath(e.toString()),p=!0)}catch(e){}}let f="";if(p){const t=await resolve_glTF_image_path_1.resolveGlTfImagePath(u.name,c,path.dirname(e.source),u.extras);if(t){const a=asset_db_1.queryUrl(t);if(a)m.uri=a;else{const a=path_1.relative(Editor.Project.tmpDir,t);path_1.isAbsolute(a)||a.startsWith(`..${path_1.sep}`)?console.warn(`In model file ${e.source},`+`the image ${u.name} is resolved to ${t},`+"which is a location out of asset directory.This can cause problem as your project migrated."):f=t}}}if(!m.uri){const t=await e.createSubAsset(o[r],"gltf-embeded-image");t.userData.gltfIndex=r,m.uri=t.uuid,f&&(t.getSwapSpace().resolved=f)}}}async _importTextures(e,t){const a=t.gltf.textures;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"textures",".texture"),r=new Array(a.length);for(let i=0;i<a.length;i++){const n=a[i],o=s[i],u=await e.createSubAsset(o,"texture"),m=u.userData;if(Object.assign(m,texture_1.makeDefaultTexture2DAssetUserData()),t.getTextureParameters(n,m),void 0!==n.source){const t=e.userData.imageMetas[n.source],a=t.remap||t.uri;if(a){const e=!a.startsWith("db://");if(m.isUuid=e,m.imageUuidOrDatabaseUri=a,!e){const e=asset_db_1.queryPath(m.imageUuidOrDatabaseUri);if(!e)throw new assert_1.AssertionError({message:`${m.imageUuidOrDatabaseUri} is not found in asset-db.`});u.depend(e)}}else delete m.imageUuidOrDatabaseUri,delete m.isUuid}r[i]=u.uuid}return r}async _importMaterials(e,t,a){const s=t.gltf.materials;if(void 0===s)return[];const{dumpMaterials:r}=e.userData,i=makeUniqueSubAssetNames(e.basename,s,"materials",r?".mtl":".material"),n=new Array(s.length);for(let o=0;o<s.length;o++)if(r)n[o]=await material_1.dumpMaterial(e,a,t,o,i[o]);else{const t=await e.createSubAsset(i[o],"gltf-material");t.userData.gltfIndex=o,n[o]=t.uuid}return n}async _importScenes(e,t){const a=t.gltf.scenes;if(void 0===a)return[];const s=makeUniqueSubAssetNames(e.basename,a,"scenes",".prefab"),r=new Array(a.length);for(let i=0;i<a.length;i++){a[i];const n=await e.createSubAsset(s[i],"gltf-scene");n.userData.gltfIndex=i,(t.gltf.scene||0)===i&&(e.userData.redirect=n.uuid),r[i]=n.uuid}return r}async _saveOriginalAnimations(e,t,a){const s=t.gltf.animations;s&&await Promise.all(s.map(async(a,s)=>{const r=t.createAnimation(s),{data:i,extension:n}=serialize_library_1.serializeForLibrary(r),o=original_animation_1.getOriginalAnimationLibraryPath(e,s);await e.saveToLibrary(o,i)}))}}function makeUniqueSubAssetNames(e,t,a,s){let r=t.map(t=>{let s;return s="scenes"===a?e:"string"==typeof t.name?t.name:(()=>{switch(a){case"animations":return"UnnamedAnimation";case"images":return"UnnamedImage";case"meshes":return"UnnamedMesh";case"materials":return"UnnamedMaterial";case"skeletons":return"UnnamedSkeleton";case"textures":return"UnnamedTexture";default:return"Unnamed"}})()});if(!isDifferWithEachOther(r)){let e="-";for(;!r.every(t=>!t.endsWith(e));)e+="-";r=r.map((t,a)=>t+`${e}${a}`)}return r.map(e=>e+s)}function isDifferWithEachOther(e){if(e.length>=2){const t=e.slice().sort();for(let e=0;e<t.length-1;++e)if(t[e]===t[e+1])return!1}return!0}async function migrateImageLocations(e){const t=e.meta.userData,a=[];if(t.imageLocations){const{imageLocations:e}=t;for(const t of Object.keys(e)){const s=e[t];s.targetDatabaseUrl&&a.push({name:t,remap:s.targetDatabaseUrl})}delete t.imageLocations}e.meta.userData.imageMetas=a,t.assetFinder&&t.assetFinder.images&&delete t.assetFinder.images}async function migrateDumpMaterial(e){if(!e.userData.dumpMaterials||e.userData.materialDumpDir)return;const t=path.join(e.source,`../Materials_${e.basename}.FBX`),a=path.join(e.source,`../Materials_${e.basename}.FBX.meta`),s=path.join(e.source,`../Materials_${e.basename}`),r=path.join(e.source,`../Materials_${e.basename}.meta`);fs.existsSync(t)&&!fs.existsSync(s)&&(fs.renameSync(t,s),fs.existsSync(a)&&fs.renameSync(a,r),e._assetDB.refresh(s))}async function migrateFbxConverterSelector(e){".fbx"===e.extname&&(e.userData.legacyFbxImporter=!0)}async function migrateFbxConverterUnitConversion(e){var t;if(".fbx"!==e.extname)return;const a=e.userData;a.legacyFbxImporter||((null!==(t=a.fbx)&&void 0!==t?t:a.fbx={}).unitConversion="hierarchy-level")}exports.GltfImporter=GltfImporter,exports.default=GltfImporter;