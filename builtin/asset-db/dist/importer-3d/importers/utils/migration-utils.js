"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Archive=void 0;const archiveProxyWatchedTag=Symbol("ArchiveProxyWatched");class Archive{constructor(e=null){deIndex(e,e),this._originalData=e,this._root=Array.isArray(e)?e[0]:e;const t={get(e,r,o){if(r===archiveProxyWatchedTag)return e;const i=Reflect.get(e,r,o);if(null===i||void 0===i||"object"!=typeof i)return i;const c=void 0!==i[refTag]?i[refTag]:i;return new Proxy(c,t)},set(e,t,r,o){var i;const c="object"==typeof r&&r&&null!==(i=r[archiveProxyWatchedTag])&&void 0!==i?i:r,s=!Array.isArray(r)&&"object"==typeof r&&r?{[refTag]:c}:c;return Reflect.set(e,t,s,o)}};this._proxyHandler=t}get root(){return new Proxy(this._root,this._proxyHandler)}get(e){var t;const r="object"==typeof e&&e?null!==(t=e[archiveProxyWatchedTag])&&void 0!==t?t:e:this._root,o=[r];return reIndex(r,o),1===o.length?o[0]:o}addObject(){return new Proxy({},this._proxyHandler)}addTypedObject(e){return new Proxy({__type__:e},this._proxyHandler)}visitTypedObject(e,t){const r=new Set;this._visitTypedObject(e,t,this._root,r)}clearObject(e){const t=Object.keys(e);for(const r of t)switch(r){case"__type__":break;default:delete e[r]}}_visitTypedObject(e,t,r,o){if(Array.isArray(r))r.forEach(r=>{this._visitTypedObject(e,t,r,o)});else if(r&&"object"==typeof r)if(r[refTag])this._visitTypedObject(e,t,r[refTag],o);else if(!o.has(r)){o.add(r),r.__type__===e&&t(new Proxy(r,this._proxyHandler));for(const i of Object.values(r))this._visitTypedObject(e,t,i,o)}}}exports.Archive=Archive;const refTag=Symbol("Ref");function deIndex(e,t){if(Array.isArray(e))e.forEach(e=>{deIndex(e,t)});else if(e&&"object"==typeof e){const r=e;if("number"==typeof r.__id__){const e=r.__id__;r[refTag]=t[e]}else Object.values(e).forEach(e=>deIndex(e,t))}}function reIndex(e,t){if(Array.isArray(e))e.forEach(e=>{reIndex(e,t)});else if(e&&"object"==typeof e){const r=e,o=r[refTag];if(o){const e=t.indexOf(o);e>=0?r.__id__=e:(r.__id__=t.length,t.push(o),reIndex(o,t))}else Object.values(e).forEach(e=>reIndex(e,t))}}