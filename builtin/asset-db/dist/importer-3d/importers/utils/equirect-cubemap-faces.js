"use strict";function clamp(e,n,t){return Math.min(t,Math.max(n,e))}function srgbToLinear(e){return Math.pow(e,2.2)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.equirectToCubemapFaces=exports.InterpolationType=void 0;const i255=1/255;function betweenZeroAndOne(e){return i255*e}function linearToSRGB(e){return Math.pow(e,.454545)}const ilog2=1/Math.log(2);function nearestPowerOfTwo(e){return 1<<Math.round(Math.log(e)*ilog2)}var InterpolationType;!function(e){e.BILINEAR="bilinear",e.NEAREST="nearest"}(InterpolationType=exports.InterpolationType||(exports.InterpolationType={}));const DEFAULT_OPTIONS={flipTheta:!1,interpolation:InterpolationType.BILINEAR,isRGBE:!1};function floatToRGBE(e,n,t,o,r){const a=Math.max(Math.max(e,n),t),i=Math.ceil(Math.log2(a)),s=Math.pow(2,i-8);o[r+0]=e/s|0,o[r+1]=n/s|0,o[r+2]=t/s|0,o[r+3]=i+128}function transformSingleFace(e,n,t,o){const r=o.flipTheta?-1:1,a=0|t.width,i=0|e.width,s=0|e.height,c=e.data,h=o.interpolation===InterpolationType.NEAREST,b=o.isRGBE,w=t.data,d=0|t.width,l=0|t.height,p=0|n,g=2/d,T=2/l;for(let e=0;e<l;++e)for(let n=0;n<d;++n){const t=g*n,o=T*e,d=n+e*a<<2;let l=0,u=0,A=0;switch(p){case 0:l=1,u=1-t,A=1-o;break;case 1:l=-1,u=t-1,A=1-o;break;case 2:l=t-1,u=o-1,A=1;break;case 3:l=t-1,u=1-o,A=-1;break;case 4:l=t-1,u=1,A=1-o;break;case 5:l=1-t,u=-1,A=1-o}const O=r*Math.atan2(u,l),f=Math.sqrt(l*l+u*u),m=Math.atan2(A,f),Z=i/4*2*(O+Math.PI)/Math.PI,M=i/4*2*(Math.PI/2-m)/Math.PI,I=0|Math.floor(Z),L=0|Math.floor(M);if(h){const e=I%i+i*clamp(L,0,s-1)<<2;w[d+0]=0|c[e+0],w[d+1]=0|c[e+1],w[d+2]=0|c[e+2],w[d+3]=0|c[e+3]}else{const e=I+1,n=L+1,t=Z-I,o=M-L,r=I%i+i*clamp(L,0,s-1)<<2,a=e%i+i*clamp(L,0,s-1)<<2,h=I%i+i*clamp(n,0,s-1)<<2,l=e%i+i*clamp(n,0,s-1)<<2,p=(1-t)*(1-o),g=t*(1-o),T=(1-t)*o,u=t*o;if(b){const e=Math.pow(2,(0|c[r+3])-128),n=Math.pow(2,(0|c[a+3])-128),t=Math.pow(2,(0|c[h+3])-128),o=Math.pow(2,(0|c[l+3])-128),i=betweenZeroAndOne(0|c[r+0])*e,s=betweenZeroAndOne(0|c[r+1])*e,b=betweenZeroAndOne(0|c[r+2])*e,A=betweenZeroAndOne(0|c[a+0])*n,O=betweenZeroAndOne(0|c[a+1])*n,f=betweenZeroAndOne(0|c[a+2])*n,m=betweenZeroAndOne(0|c[h+0])*t,Z=betweenZeroAndOne(0|c[h+1])*t,M=betweenZeroAndOne(0|c[h+2])*t;floatToRGBE(i*p+A*g+m*T+betweenZeroAndOne(0|c[l+0])*o*u,s*p+O*g+Z*T+betweenZeroAndOne(0|c[l+1])*o*u,b*p+f*g+M*T+betweenZeroAndOne(0|c[l+2])*o*u,w,d)}else{const e=betweenZeroAndOne(0|c[r+3]),n=betweenZeroAndOne(0|c[a+3]),t=betweenZeroAndOne(0|c[h+3]),o=betweenZeroAndOne(0|c[l+3]),i=srgbToLinear(betweenZeroAndOne(0|c[r+0]))*e,s=srgbToLinear(betweenZeroAndOne(0|c[r+1]))*e,b=srgbToLinear(betweenZeroAndOne(0|c[r+2]))*e,A=srgbToLinear(betweenZeroAndOne(0|c[a+0]))*n,O=srgbToLinear(betweenZeroAndOne(0|c[a+1]))*n,f=srgbToLinear(betweenZeroAndOne(0|c[a+2]))*n,m=srgbToLinear(betweenZeroAndOne(0|c[h+0]))*t,Z=srgbToLinear(betweenZeroAndOne(0|c[h+1]))*t,M=srgbToLinear(betweenZeroAndOne(0|c[h+2]))*t,I=i*p+A*g+m*T+srgbToLinear(betweenZeroAndOne(0|c[l+0]))*o*u,L=s*p+O*g+Z*T+srgbToLinear(betweenZeroAndOne(0|c[l+1]))*o*u,x=b*p+f*g+M*T+srgbToLinear(betweenZeroAndOne(0|c[l+2]))*o*u,E=e*p+n*g+t*T+o*u,P=1/E;w[d+3]=255*E|0,w[d+0]=255*linearToSRGB(I*P)|0,w[d+1]=255*linearToSRGB(L*P)|0,w[d+2]=255*linearToSRGB(x*P)|0}}}return t}function transformToCubeFaces(e,n,t){if(6!==n.length)throw new Error("facePixArray length must be 6!");for(let o=0;o<6;++o)transformSingleFace(e,o,n[o],t);return n}function imageGetPixels(e){if(e instanceof ImageData)return e;let n,t=e;return"CANVAS"!==t.tagName?((t=document.createElement("canvas")).width=e.width,t.height=e.height,(n=t.getContext("2d")).drawImage(e,0,0,t.width,t.height,0,0,t.width,t.height)):n=t.getContext("2d"),n.getImageData(0,0,t.width,t.height)}function equirectToCubemapFaces(e,n,t){const o=imageGetPixels(e);n||(n=0|nearestPowerOfTwo(e.width/4));const r=[];for(let e=0;e<6;++e){const e=document.createElement("canvas");e.width=n,e.height=n,r.push(e)}return t||(t=DEFAULT_OPTIONS),transformToCubeFaces(o,r.map(e=>e.getContext("2d").createImageData(e.width,e.height)),t).forEach((e,n)=>{r[n].getContext("2d").putImageData(e,0,0)}),r}exports.equirectToCubemapFaces=equirectToCubemapFaces;