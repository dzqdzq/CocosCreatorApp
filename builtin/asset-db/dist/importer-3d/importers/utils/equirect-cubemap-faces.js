"use strict";function clamp(e,t,n){return Math.min(n,Math.max(t,e))}function srgbToLinear(e){return Math.pow(e,2.2)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.equirectToCubemapFaces=exports.InterpolationType=void 0;const i255=1/255;function betweenZeroAndOne(e){return i255*e}function linearToSRGB(e){return Math.pow(e,.454545)}const ilog2=1/Math.log(2);function nearestPowerOfTwo(e){return 1<<Math.round(Math.log(e)*ilog2)}var InterpolationType;!function(e){e.BILINEAR="bilinear",e.NEAREST="nearest"}(InterpolationType=exports.InterpolationType||(exports.InterpolationType={}));const DEFAULT_OPTIONS={flipTheta:!1,interpolation:InterpolationType.BILINEAR,isRGBE:!1},rgbe_base=1.1;function floatToRGBE(e,t,n,o,r){const a=Math.max(Math.max(e,t),n),i=Math.ceil(Math.log(a)/Math.log(rgbe_base)),s=Math.min(Math.max(i+128,0),255),b=Math.pow(rgbe_base,s-128);o[r+0]=e/b*255|0,o[r+1]=t/b*255|0,o[r+2]=n/b*255|0,o[r+3]=s}function transformSingleFace(e,t,n,o){const r=o.flipTheta?-1:1,a=0|n.width,i=0|e.width,s=0|e.height,b=e.data,h=o.interpolation===InterpolationType.NEAREST,c=o.isRGBE,w=n.data,d=0|n.width,g=0|n.height,l=0|t,p=2/d,T=2/g;for(let e=0;e<g;++e)for(let t=0;t<d;++t){const n=p*t,o=T*e,d=t+e*a<<2;let g=0,u=0,A=0;switch(l){case 0:g=1,u=1-n,A=1-o;break;case 1:g=-1,u=n-1,A=1-o;break;case 2:g=n-1,u=o-1,A=1;break;case 3:g=n-1,u=1-o,A=-1;break;case 4:g=n-1,u=1,A=1-o;break;case 5:g=1-n,u=-1,A=1-o}const O=r*Math.atan2(u,g),f=Math.sqrt(g*g+u*u),m=Math.atan2(A,f),M=i/4*2*(O+Math.PI)/Math.PI,Z=i/4*2*(Math.PI/2-m)/Math.PI,I=0|Math.floor(M),x=0|Math.floor(Z);if(h){const e=I%i+i*clamp(x,0,s-1)<<2;w[d+0]=0|b[e+0],w[d+1]=0|b[e+1],w[d+2]=0|b[e+2],w[d+3]=0|b[e+3]}else{const e=I+1,t=x+1,n=M-I,o=Z-x,r=I%i+i*clamp(x,0,s-1)<<2,a=e%i+i*clamp(x,0,s-1)<<2,h=I%i+i*clamp(t,0,s-1)<<2,g=e%i+i*clamp(t,0,s-1)<<2,l=(1-n)*(1-o),p=n*(1-o),T=(1-n)*o,u=n*o;if(c){const e=Math.pow(rgbe_base,(0|b[r+3])-128),t=Math.pow(rgbe_base,(0|b[a+3])-128),n=Math.pow(rgbe_base,(0|b[h+3])-128),o=Math.pow(rgbe_base,(0|b[g+3])-128),i=betweenZeroAndOne(0|b[r+0])*e,s=betweenZeroAndOne(0|b[r+1])*e,c=betweenZeroAndOne(0|b[r+2])*e,A=betweenZeroAndOne(0|b[a+0])*t,O=betweenZeroAndOne(0|b[a+1])*t,f=betweenZeroAndOne(0|b[a+2])*t,m=betweenZeroAndOne(0|b[h+0])*n,M=betweenZeroAndOne(0|b[h+1])*n,Z=betweenZeroAndOne(0|b[h+2])*n;floatToRGBE(i*l+A*p+m*T+betweenZeroAndOne(0|b[g+0])*o*u,s*l+O*p+M*T+betweenZeroAndOne(0|b[g+1])*o*u,c*l+f*p+Z*T+betweenZeroAndOne(0|b[g+2])*o*u,w,d)}else{const e=betweenZeroAndOne(0|b[r+3]),t=betweenZeroAndOne(0|b[a+3]),n=betweenZeroAndOne(0|b[h+3]),o=betweenZeroAndOne(0|b[g+3]),i=srgbToLinear(betweenZeroAndOne(0|b[r+0]))*e,s=srgbToLinear(betweenZeroAndOne(0|b[r+1]))*e,c=srgbToLinear(betweenZeroAndOne(0|b[r+2]))*e,A=srgbToLinear(betweenZeroAndOne(0|b[a+0]))*t,O=srgbToLinear(betweenZeroAndOne(0|b[a+1]))*t,f=srgbToLinear(betweenZeroAndOne(0|b[a+2]))*t,m=srgbToLinear(betweenZeroAndOne(0|b[h+0]))*n,M=srgbToLinear(betweenZeroAndOne(0|b[h+1]))*n,Z=srgbToLinear(betweenZeroAndOne(0|b[h+2]))*n,I=i*l+A*p+m*T+srgbToLinear(betweenZeroAndOne(0|b[g+0]))*o*u,x=s*l+O*p+M*T+srgbToLinear(betweenZeroAndOne(0|b[g+1]))*o*u,L=c*l+f*p+Z*T+srgbToLinear(betweenZeroAndOne(0|b[g+2]))*o*u,E=e*l+t*p+n*T+o*u,P=1/E;w[d+3]=255*E|0,w[d+0]=255*linearToSRGB(I*P)|0,w[d+1]=255*linearToSRGB(x*P)|0,w[d+2]=255*linearToSRGB(L*P)|0}}}return n}function transformToCubeFaces(e,t,n){if(6!==t.length)throw new Error("facePixArray length must be 6!");for(let o=0;o<6;++o)transformSingleFace(e,o,t[o],n);return t}function imageGetPixels(e){if(e instanceof ImageData)return e;let t,n=e;return"CANVAS"!==n.tagName?((n=document.createElement("canvas")).width=e.width,n.height=e.height,(t=n.getContext("2d")).drawImage(e,0,0,n.width,n.height,0,0,n.width,n.height)):t=n.getContext("2d"),t.getImageData(0,0,n.width,n.height)}function equirectToCubemapFaces(e,t,n){const o=imageGetPixels(e);t||(t=0|nearestPowerOfTwo(e.width/4));const r=[];for(let e=0;e<6;++e){const e=document.createElement("canvas");e.width=t,e.height=t,r.push(e)}return n||(n=DEFAULT_OPTIONS),transformToCubeFaces(o,r.map(e=>e.getContext("2d").createImageData(e.width,e.height)),n).forEach((e,t)=>{r[t].getContext("2d").putImageData(e,0,0)}),r}exports.equirectToCubemapFaces=equirectToCubemapFaces;