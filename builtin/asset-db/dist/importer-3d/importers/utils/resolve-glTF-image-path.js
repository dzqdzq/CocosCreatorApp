"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveGlTfImagePath=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));async function resolveGlTfImagePath(e,t,a,n){if(t&&await fs_extra_1.default.pathExists(t))return t;console.debug("Image"+`(Name: ${e}, Expected path: ${t})`+" is not found, fuzzy search starts.");const s=t?path_1.default.extname(t):"",o=s.toLowerCase(),r=t?path_1.default.basename(t,s):"",l=new Set;if(0!==r.length&&l.add(r),e&&l.add(e),"object"==typeof n&&keyFbxGlTfConvImageExtras in n){console.debug(`Found FBX-glTF-conv specified extras: ${JSON.stringify(n[keyFbxGlTfConvImageExtras],void 0,2)}`);const{fileName:e,relativeFileName:t}=n[keyFbxGlTfConvImageExtras];if(0!==e.length){const t=normalizePathInFbx(e);l.add(path_1.default.basename(t,path_1.default.extname(t)))}if(0!==t.length){const e=normalizePathInFbx(t);l.add(path_1.default.basename(e,path_1.default.extname(e)))}}if(0===l.size)return null;const i=[".jpg",".jpeg",".png"];0===s.length||i.includes(o)||i.unshift(o);const u=[".","textures","materials"],f=toNormalizedAbsolute(Manager.AssetWorker.assets.options.target),d=e=>e.startsWith(f),c=Array.from(l);let h=toNormalizedAbsolute(a);for(let e=0;e<2&&d(h);++e){for(const e of u){const t=path_1.default.join(h,e);console.debug(`Do fuzzy search in ${t}, with base names: ${c}.`);const a=await fuzzySearchTexture(t,c,i);if(a)return console.debug(`Found ${a}, use it.`),a}h=path_1.default.dirname(h)}return console.debug("Fuzzy search failed."),null}function toNormalizedAbsolute(e){const t=path_1.default.isAbsolute(e)?e:path_1.default.join(process.cwd(),e);return path_1.default.normalize(t)}async function fuzzySearchTexture(e,t,a){if(!await fs_extra_1.default.pathExists(e))return null;const n=await fs_extra_1.default.readdir(e);for(const s of n){const n=path_1.default.extname(s),o=path_1.default.basename(s,n);if(!t.some(e=>caseInsensitiveStringEqual(o,e)))continue;const r=path_1.default.join(e,s);if((await fs_extra_1.default.stat(r)).isFile()&&a.indexOf(n.toLowerCase())>=0)return r}return null}function caseInsensitiveStringEqual(e,t){return e.length===t.length&&e.toLowerCase()===t.toLowerCase()}exports.resolveGlTfImagePath=resolveGlTfImagePath;const keyFbxGlTfConvImageExtras="FBX-glTF-conv";function normalizePathInFbx(e){return e.split(/[\\/]/g).join(path_1.default.sep)}