"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveGlTfImagePath=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));async function resolveGlTfImagePath(e,t,a,n){if(t&&await fs_extra_1.default.pathExists(t))return t;let s="",r="";if("object"==typeof n&&keyFbxGlTfConvImageExtras in n){console.debug(`Found FBX-glTF-conv specified extras: ${JSON.stringify(n[keyFbxGlTfConvImageExtras],void 0,2)}`);const{fileName:e,relativeFileName:t}=n[keyFbxGlTfConvImageExtras];t&&(r=normalizePathInFbx(t)),e&&(s=normalizePathInFbx(e))}if(r){const e=path_1.default.join(a,r);if(await fs_extra_1.default.pathExists(e))return e}if(s&&await fs_extra_1.default.pathExists(s))return s;console.debug("Image"+`(Name: ${e}, Expected path: ${t})`+" is not found, fuzzy search starts.");const o=t?path_1.default.extname(t):"",i=o.toLowerCase(),u=t?path_1.default.basename(t,o):"",l=new Set;if(0!==u.length&&l.add(u),e&&l.add(e),s&&l.add(path_1.default.basename(s,path_1.default.extname(s))),r&&l.add(path_1.default.basename(r,path_1.default.extname(r))),0===l.size)return null;const f=[".jpg",".jpeg",".png",".tga",".webp"];0===o.length||f.includes(i)||f.unshift(i);const d=["textures","materials"],c=toNormalizedAbsolute(Manager.AssetWorker.assets.options.target),_=e=>e.startsWith(c),h=Array.from(l);let p=toNormalizedAbsolute(a);for(let e=0;e<2&&_(p);++e){const e=await fuzzySearchTexture(p,h,f);if(e)return console.debug(`Found ${e}, use it.`),e;const t=await fs_extra_1.default.readdir(p);for(const e of t){if(!d.some(t=>caseInsensitiveStringEqual(e,t)))continue;const t=path_1.default.join(p,e);try{if(!(await fs_extra_1.default.stat(t)).isDirectory())continue}catch(e){}const a=await fuzzySearchTexture(t,h,f);if(a)return console.debug(`Found ${a}, use it.`),a}p=path_1.default.dirname(p)}return console.debug("Fuzzy search failed."),null}function toNormalizedAbsolute(e){const t=path_1.default.isAbsolute(e)?e:path_1.default.join(process.cwd(),e);return path_1.default.normalize(t)}async function fuzzySearchTexture(e,t,a){if(!await fs_extra_1.default.pathExists(e))return null;const n=await fs_extra_1.default.readdir(e);for(const s of n){const n=path_1.default.extname(s),r=path_1.default.basename(s,n);if(!t.some(e=>caseInsensitiveStringEqual(r,e)))continue;const o=path_1.default.join(e,s);if((await fs_extra_1.default.stat(o)).isFile()&&a.indexOf(n.toLowerCase())>=0)return o}return null}function caseInsensitiveStringEqual(e,t){return e.length===t.length&&e.toLowerCase()===t.toLowerCase()}exports.resolveGlTfImagePath=resolveGlTfImagePath;const keyFbxGlTfConvImageExtras="FBX-glTF-conv";function normalizePathInFbx(e){return e.split(/[\\/]/g).join(path_1.default.sep)}