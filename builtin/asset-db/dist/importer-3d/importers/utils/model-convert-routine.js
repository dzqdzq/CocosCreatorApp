"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.modelConvertRoutine=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path"));async function modelConvertRoutine(t,e,a,i,r){const s=path_1.default.join(a.options.temp,t,e.uuid);await fs_extra_1.default.ensureDir(s);const u=(await fs_extra_1.default.stat(e.source)).mtimeMs,o=path_1.default.join(s,"status.json");let n;try{n=await fs_extra_1.default.readJson(o)}catch(t){console.debug(`Status file ${o}: ${t}`)}const f=path_1.default.join(s,"output");if(await fs_extra_1.default.ensureDir(f),!(void 0!==n&&n.version===i&&await isOutputTimeStampsAvailable(f,n.outputTimeStamps))){if(await fs_extra_1.default.emptyDir(f),!await r.convert(e,f))return;const t={};await getMtimeTree(f,t);const a={version:i,sourceTimeStamp:u,outputTimeStamps:t};await fs_extra_1.default.ensureDir(path_1.default.dirname(o)),await fs_extra_1.default.writeJson(o,a,{spaces:2})}return await r.get(e,f)}async function getMtimeTree(t,e,a){const i=await fs_extra_1.default.readdir(t);await Promise.all(i.map(async i=>{const r=path_1.default.join(t,i),s=await fs_extra_1.default.stat(r),u=a?`${a}/${i}`:i;s.isFile()?e[u]=s.mtimeMs:s.isDirectory()&&await getMtimeTree(r,e,u)}))}async function isOutputTimeStampsAvailable(t,e){return(await Promise.all(Object.entries(e).map(async([e,a])=>{const i=path_1.default.join(t,path_1.default.join(...e.split("/")));try{return(await fs_extra_1.default.stat(i)).mtimeMs===a}catch(t){return!1}}))).every(t=>t)}exports.modelConvertRoutine=modelConvertRoutine;