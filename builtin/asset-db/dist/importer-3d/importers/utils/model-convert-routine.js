"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.modelConvertRoutine=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path"));async function modelConvertRoutine(t,e,a,i,r){var s;const o=path_1.default.join(a.options.temp,t,e.uuid);await fs_extra_1.default.ensureDir(o);const u=(await fs_extra_1.default.stat(e.source)).mtimeMs,n=path_1.default.join(o,"status.json");let l;try{l=await fs_extra_1.default.readJson(n)}catch(t){console.debug(`Status file ${n}: ${t}`)}const f=path_1.default.join(o,"output");if(await fs_extra_1.default.ensureDir(f),!(void 0!==l&&l.version===i&&l.sourceTimeStamp===u&&await isOutputTimeStampsAvailable(f,l.outputTimeStamps))){if(await fs_extra_1.default.emptyDir(f),!await r.convert(e,f))return;const t={};await getMtimeTree(f,t);const a={version:i,sourceTimeStamp:u,outputTimeStamps:t};await fs_extra_1.default.ensureDir(path_1.default.dirname(n)),await fs_extra_1.default.writeJson(n,a,{spaces:2})}return await(null===(s=r.printLogs)||void 0===s?void 0:s.call(r,e,f)),await r.get(e,f)}async function getMtimeTree(t,e,a){const i=await fs_extra_1.default.readdir(t);await Promise.all(i.map(async i=>{const r=path_1.default.join(t,i),s=await fs_extra_1.default.stat(r),o=a?`${a}/${i}`:i;s.isFile()?e[o]=s.mtimeMs:s.isDirectory()&&await getMtimeTree(r,e,o)}))}async function isOutputTimeStampsAvailable(t,e){return(await Promise.all(Object.entries(e).map(async([e,a])=>{const i=path_1.default.join(t,path_1.default.join(...e.split("/")));try{return(await fs_extra_1.default.stat(i)).mtimeMs===a}catch(t){return!1}}))).every(t=>t)}exports.modelConvertRoutine=modelConvertRoutine;