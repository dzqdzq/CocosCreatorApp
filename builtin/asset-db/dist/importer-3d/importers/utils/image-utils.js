"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkImageType=exports.checkImageTypeToSpriteFrame=exports.unlock=exports.lock=exports.lockFlag=void 0;const fs_extra_1=require("fs-extra"),path=__importStar(require("path")),Plist=require("plist"),fntParser=require("../../../../static/utils/fnt-parser");exports.lockFlag=!1;const lockQueue=[];function lock(){if(exports.lockFlag)return new Promise(e=>{lockQueue.push(e)})}function unlock(){const e=lockQueue.shift();e?e():exports.lockFlag=!1}async function checkImageTypeToSpriteFrame(e){if(!e)return;const t=path.basename(e.source),r=path.basename(e.basename,path.extname(e.basename)),a=path.join(path.dirname(e.source),r);try{if(fs_extra_1.existsSync(a+".plist")){const e=Plist.parse(fs_extra_1.readFileSync(a+".plist","utf8"));if((e.realTextureFileName||e.textureFileName)===t)return"sprite-frame"}else if(fs_extra_1.existsSync(a+".fnt")){const e=fs_extra_1.readFileSync(a+".fnt","utf8");if(fntParser.parseFnt(e).atlasName===t)return"sprite-frame"}}catch(e){}return"texture"}async function checkImageType(e,t,r,a,o=!1){if(e){if(await lock(),exports.lockFlag=!0,!t&&e.meta.userData.type!==a){let i=!0;if(!o){const a=Editor.I18n.t("asset-db.importers.image.title"),o=Editor.I18n.t("asset-db.importers.image.change_type_detail",{path:e.url,name:r}),s=await Editor.Dialog.info(a,{detail:o,checkboxLabel:Editor.I18n.t("asset-db.operate.dialogDoNotNotify"),checkboxChecked:!1,buttons:[Editor.I18n.t("asset-db.operate.dialogQuestion"),Editor.I18n.t("asset-db.operate.cancel")],default:0,cancel:1});t=s.checkboxChecked,i=0===s.response}i&&(e.meta.userData.type=a,e.save(),e._assetDB.reimport(e.uuid))}unlock()}}exports.lock=lock,exports.unlock=unlock,exports.checkImageTypeToSpriteFrame=checkImageTypeToSpriteFrame,exports.checkImageType=checkImageType;