"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),ts=__importStar(require("typescript")),javascript_1=__importDefault(require("./javascript")),ts_utils_1=require("./utils/ts-utils"),Editor=require("editor");class ScriptImporter extends javascript_1.default{get version(){return`${super.version}`}get name(){return"typescript"}get assetType(){return"cc.Script"}async import(e){if(e.source.endsWith(".d.ts"))return!0;let t=!1,r=!1;switch(await this._getTypeCheckLevel()){case"checkOnly":t=!0,r=!1;break;case"fatalOnError":t=!0,r=!0;break;case"disable":default:t=!1}return super.import(e)}async _getTypeCheckLevel(){return await Editor.Profile.getProject("project","general.type_check_level")}async _typeCheck(e){const t=e.source,r=ts_utils_1.getCompilerOptions(),i=ts.createProgram({rootNames:[t],options:r}),s=i.getSourceFile(t);if(!s)return console.debug("program created in _typeCheck() doesn't contain main entry file?"),!1;const a=ts.getPreEmitDiagnostics(i,s);if(!a||0===a.length)return!1;const n={getCurrentDirectory:()=>path_1.dirname(e.source),getCanonicalFileName:e=>path_1.normalize(e),getNewLine:()=>"\n"};let c=0;for(const e of a){const t=ts.formatDiagnostic(e,n);let r;switch(e.category){case ts.DiagnosticCategory.Error:++c,r=console.error;break;case ts.DiagnosticCategory.Warning:r=console.warn;break;case ts.DiagnosticCategory.Message:case ts.DiagnosticCategory.Suggestion:default:r=console.log}r(t)}return 0!==c}}function CocosScriptFrameTransformer(e,t){return r=>{const i=s=>{if(ts.isSourceFile(s)){const r=ts.createExpressionStatement(ts.createCall(ts.createPropertyAccess(ts.createPropertyAccess(ts.createIdentifier("cc"),ts.createIdentifier("_RF")),ts.createIdentifier("push")),void 0,[ts.createBinary(ts.createPropertyAccess(ts.createIdentifier("window"),ts.createIdentifier("module")),ts.SyntaxKind.BarBarToken,ts.createObjectLiteral()),ts.createStringLiteral(e),ts.createStringLiteral(t)])),i=ts.createExpressionStatement(ts.createCall(ts.createPropertyAccess(ts.createPropertyAccess(ts.createIdentifier("cc"),ts.createIdentifier("_RF")),ts.createIdentifier("pop")),void 0,[])),a=new Array;return a.push(r),a.push(...s.statements),a.push(i),ts.updateSourceFileNode(s,a,s.isDeclarationFile,s.referencedFiles,s.typeReferenceDirectives,s.hasNoDefaultLib,s.libReferenceDirectives)}return ts.visitEachChild(s,e=>i(e),r)};return e=>ts.visitNode(e,i)}}function CocosLibTransformer(){return e=>{const t=r=>{if(!ts.isImportDeclaration(r)||!r.importClause||!ts.isStringLiteral(r.moduleSpecifier)||"Cocos3D"!==r.moduleSpecifier.text)return ts.visitEachChild(r,e=>t(e),e);const i=()=>ts.createIdentifier("cc"),s=new Array,a=e=>{s.push(ts.createVariableDeclaration(ts.createIdentifier(e.text),void 0,i()))},{importClause:{name:n,namedBindings:c}}=r;if(n&&a(n),c)if(ts.isNamespaceImport(c))a(c.name);else{const e=new Array;for(const{name:t,propertyName:r}of c.elements)r?e.push(ts.createBindingElement(void 0,ts.createIdentifier(r.text),ts.createIdentifier(t.text))):e.push(ts.createBindingElement(void 0,void 0,ts.createIdentifier(t.text)));s.push(ts.createVariableDeclaration(ts.createObjectBindingPattern(e),void 0,i()))}return 0!==s.length?ts.createVariableStatement([ts.createModifier(ts.SyntaxKind.ConstKeyword)],s):void 0};return e=>ts.visitNode(e,t)}}exports.default=ScriptImporter;