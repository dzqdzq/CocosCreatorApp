"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),TMX_ENCODING={encoding:"utf8"},path=__importStar(require("path")),fs=__importStar(require("fs")),xmldom_1=require("xmldom"),sharp_1=__importDefault(require("sharp")),cc_1=require("cc");async function searchDependFiles(e,t,a){const s=(new xmldom_1.DOMParser).parseFromString(a);if(!s)throw console.error(`failed to parse ${a}`),new Error(`TiledMap import failed: failed to parser ${t}`);let r=[];const i=[];let n=[],o=[];const l=s.documentElement,u=l.getElementsByTagName("tileset");for(let a=0;a<u.length;a++){const s=u[a],l=s.getAttribute("source");if(l){const a=path.join(path.dirname(t),l);e.depend(a);const s=asset_db_1.queryAsset(a);if(!s||!s.imported)return console.warn(`cannot find ${a}`),null;if(fs.existsSync(a)){i.push(a);const t=fs.readFileSync(a,"utf-8"),s=(new xmldom_1.DOMParser).parseFromString(t);if(s){const t=await parseTilesetImages(e,s,a);if(!t)return null;r=r.concat(t.imageFullPath),n=n.concat(t.imageBaseName),o=o.concat(t.imageSizes)}else console.warn("Parse %s failed.",a)}}const c=await parseTilesetImages(e,s,t);if(!c)return null;r=r.concat(c.imageFullPath),n=n.concat(c.imageBaseName),o=o.concat(c.imageSizes)}const c=[],m=[],d=l.getElementsByTagName("imagelayer");for(let a=0,s=d.length;a<s;a++){const s=d[a].getElementsByTagName("image");if(s&&s.length>0){const a=s[0].getAttribute("source"),r=path.join(path.dirname(t),a);e.depend(r);const i=asset_db_1.queryAsset(r);if(!i||!i.imported)return console.warn(`cannot find ${r}`),null;if(fs.existsSync(r)){c.push(r);let e=path.relative(path.dirname(t),r);e=e.replace(/\\/g,"/"),m.push(e)}else console.warn("Parse %s failed.",r)}}return{imgFullPaths:r,tsxFiles:i,imgBaseNames:n,imageLayerTextures:c,imageLayerTextureNames:m,imgSizes:o}}async function parseTilesetImages(e,t,a){const s=t.getElementsByTagName("image"),r=[],i=[],n=[];for(let t=0;t<s.length;t++){const o=s[t].getAttribute("source");if(o){const t=path.join(path.dirname(a),o);e.depend(t);const s=asset_db_1.queryAsset(t);if(!s||!s.imported)return console.warn(`cannot find ${t}`),null;const l=await sharp_1.default(t).metadata();n.push(new cc_1.Size(l.width,l.height)),r.push(t);const u=path.basename(t);i.push(u)}}return{imageFullPath:r,imageBaseName:i,imageSizes:n}}class TiledMapImporter extends asset_db_1.Importer{get version(){return"1.0.1"}get name(){return"tiled-map"}get assetType(){return"cc.TiledMapAsset"}async validate(e){return!0}async import(e){if(await e.existsInLibrary(e.extname)||await e.copyToLibrary(e.extname,e.source),!await e.existsInLibrary(".json")){const t=new cc_1.TiledMapAsset,a=fs.readFileSync(e.source,TMX_ENCODING);t.name=path.basename(e.source,e.extname);const s=new cc_1.TextAsset;s.name=t.name,s.text=a,t.tmxXmlStr=a;const r=await searchDependFiles(e,e.source,a);if(!r)return!1;t.spriteFrames=r.imgFullPaths.map(e=>{const t=asset_db_1.queryAsset(e);return EditorExtends.serialize.asAsset(t.uuid+"@f9941")}),t.spriteFrameNames=r.imgBaseNames,t.tsxFiles=r.tsxFiles.map(e=>{const t=asset_db_1.queryAsset(e);return EditorExtends.serialize.asAsset(t.uuid)}),t.tsxFileNames=r.tsxFiles.map(e=>path.basename(e)),t.imageLayerSpriteFrame=r.imageLayerTextures.map(e=>{const t=asset_db_1.queryAsset(e);return EditorExtends.serialize.asAsset(t.uuid+"@f9941")}),t.imageLayerSpriteFrameNames=r.imageLayerTextureNames.map(e=>path.basename(e)),t.spriteFrameSizes=r.imgSizes,await e.saveToLibrary(".json",EditorExtends.serialize(t))}return!0}}exports.default=TiledMapImporter;