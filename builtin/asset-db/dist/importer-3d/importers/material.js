"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),migrates_1=require("./scene/migrates"),material_upgrader_1=require("./utils/material-upgrader");class MaterialImporter extends asset_db_1.Importer{get version(){return"1.0.9"}get name(){return"material"}get assetType(){return"cc.Material"}async validate(e){try{return"cc.Material"===fs_extra_1.readJSONSync(e.source).__type__}catch(e){return!1}}get migrations(){return migrations}get migrationHook(){return migrates_1.migrationHook}async import(e){try{const r=fs_extra_1.readJSONSync(e.source),a=r._effectAsset&&r._effectAsset.__uuid__;return e.depend(a),await material_upgrader_1.upgradeProperties(r,e)&&fs_extra_1.writeJSONSync(e.source,r,{spaces:2}),await e.saveToLibrary(".json",JSON.stringify(r,void 0,2)),!0}catch(e){return console.error(e),!1}}}exports.default=MaterialImporter;const migrations=[{version:"1.0.5",migrate:migrates_1.migrateImageUuid},{version:"1.0.6",migrate:migrates_1.migrateAnimationName},{version:"1.0.7",async migrate(e){await migrates_1.migrateNameToId(e,!0)}},{version:"1.0.9",migrate:migrateStandardEffect}],componentMap={r:"x",g:"y",b:"z",a:"w"};async function migrateStandardEffect(e){const r=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);if("1baf0fc9-befa-459c-8bdd-af1a450a0319"===r._effectAsset.__uuid__){let e=r._defines[0];e||(e=r._defines[0]={}),e.OCCLUSION_CHANNEL||(e.OCCLUSION_CHANNEL="b"),e.ROUGHNESS_CHANNEL||(e.ROUGHNESS_CHANNEL="r"),e.METALLIC_CHANNEL||(e.METALLIC_CHANNEL="g");let a=r._props[0];a||(a=r._props[0]={}),a.occlusion=(a.pbrParams&&a.pbrParams[componentMap[e.OCCLUSION_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]]||1),a.roughness=(a.pbrParams&&a.pbrParams[componentMap[e.ROUGHNESS_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]]||.8),a.metallic=(a.pbrParams&&a.pbrParams[componentMap[e.METALLIC_CHANNEL]]||1)*(a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]]||.6),e.USE_PBR_MAP?(a.occlusion=a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof a.occlusion&&(a.occlusion=1),a.roughness=a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof a.roughness&&(a.roughness=1),a.metallic=a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof a.metallic&&(a.metallic=1)):e.USE_METALLIC_ROUGHNESS_MAP?(a.roughness=a.pbrScale&&a.pbrScale[componentMap[e.ROUGHNESS_CHANNEL]],"number"!=typeof a.roughness&&(a.roughness=1),a.metallic=a.pbrScale&&a.pbrScale[componentMap[e.METALLIC_CHANNEL]],"number"!=typeof a.metallic&&(a.metallic=1)):e.USE_OCCLUSION_MAP&&(a.occlusion=a.pbrScale&&a.pbrScale[componentMap[e.OCCLUSION_CHANNEL]],"number"!=typeof a.occlusion&&(a.occlusion=1))}}