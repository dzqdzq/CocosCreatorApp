"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migratePrefab=exports.beforeMigratePrefab=void 0;const asset_db_1=require("@editor/asset-db"),fs_extra_1=require("fs-extra"),PrefabInfo={__type__:"cc.PrefabInfo",targetOverrides:[]},addPrefabInfo=function(e,n){let t,_,r=n[0];if(r&&(r=r.data||r.scene)&&!(_=n[r.__id__]))return void console.warn(`Can not find root node, root info: ${n[0]}`);const o=_._prefab&&_._prefab.__id__;return o?t=n[o]:(t=JSON.parse(JSON.stringify(PrefabInfo)),n.push(t),_._prefab={__id__:n.length-1}),t.targetOverrides=e,t},TargetOverrideInfo={__type__:"cc.TargetOverrideInfo",source:null,sourceInfo:null,propertyPath:[],target:null,targetInfo:null},createTargetOverrideInfo=function(){return JSON.parse(JSON.stringify(TargetOverrideInfo))},PrefabLink={__type__:"cc.PrefabLink",_name:"",_objFlags:0,node:{__id__:2},_enabled:!0,__prefab:null,prefab:null,_id:"a6NH7Dj9tMVbatCdgoxYyz"},addPrefabLink=function(e,n,t){const _=e[t];if(!_||!_.asset)return-1;const r=JSON.parse(JSON.stringify(PrefabLink));return r.node={__id__:n},r.prefab={__uuid__:_.asset.__uuid__},e.push(r),e.length-1},PrefabInstance={__type__:"cc.PrefabInstance",fileId:"",prefabRootNode:null,mountedChildren:[],propertyOverrides:[],removedComponents:[]},addPrefabInstance=function(e,n,t){const _=JSON.parse(JSON.stringify(PrefabInstance));return t&&(_.prefabRootNode={__id__:1}),_.fileId=EditorExtends.UuidUtils.uuid(),n.push(_),n[e].instance={__id__:n.length-1},_},CCPropertyOverrideInfo={__type__:"CCPropertyOverrideInfo",targetInfo:null,propertyPath:[],value:null},createPropertyOverrideInfo=function(e,n){const t=JSON.parse(JSON.stringify(CCPropertyOverrideInfo)),_=[];return"_lpos"===e?_.push("position"):"_lrot"===e?_.push("rotation"):"_lscale"===e?_.push("scale"):_.push(e),t.propertyPath=_,t.value=n,t},TargetInfo={__type__:"cc.TargetInfo",localID:[]},createTargetInfo=function(e){const n=JSON.parse(JSON.stringify(TargetInfo));return n.localID=e,n},CompPrefabInfo={__type__:"cc.CompPrefabInfo",fileId:""},addCompPrefabInfo=function(e,n){const t=n[e];if("cc.Node"!==t.__type__&&t.node){if(!n[t.node.__id__]._prefab)return;if(t.__prefab)return;const e=JSON.parse(JSON.stringify(CompPrefabInfo));e.fileId=EditorExtends.UuidUtils.uuid(),n.push(e),t.__prefab={__id__:n.length-1}}},MountedChildrenInfo={__type__:"cc.MountedChildrenInfo",targetInfo:null,nodes:[]},addMountedChildrenInfo=function(e,n,t,_){const r=JSON.parse(JSON.stringify(MountedChildrenInfo));return r.nodes=_,{prefabInstanceID:e,mountedChildrenInfo:r,targetInfo:createTargetInfo(t)}},INSTANCE_RESERVED_KEYWORDS=["__type__","_objFlags","_parent","_prefab","_id"];function compareBaseProp(e,n,t,_,r){const o=[],i=["_lpos","_lrot","_lscale","_active","_name","_layer"];for(const r of i){const i=n[r],a=t[r];if(JSON.stringify(i)!==JSON.stringify(a)){const n=createPropertyOverrideInfo(r,i),t=createTargetInfo(_);o.push({prefabInstanceID:e,propertyOverrideInfo:n,targetInfo:t})}}return o}function compareComponentIDProp(e,n,t,_,r,o,i,a){const s=r[n];if(!s)return null;let f,c,d,l,p="cc.Node"!==s.__type__;if(p){if(!(c=s.node&&s.node.__id__))return null;f=r[c]}else f=s,c=n;const u=(l=(d=f&&f._prefab&&f._prefab.__id__)&&r[d])&&l.root&&l.root.__id__;if(!l||!l.asset||o.has(u)||0===l.asset.__id__)return null;const b=r[u];if(!b)return null;const I=createTargetOverrideInfo();I.propertyPath=e;let h=[];const g=totalPrefab.get(l.asset.__uuid__);if(!g)return console.warn(`Cannot get Base Prefab by UUID: ${l.asset.__uuid__}, PrefabInfo ID: ${c} name: ${f._name}.`),null;const m=g[0]&&g[0].data&&g[0].data.__id__,y=g&&g[m];let P,O;if(u===c)P=y,O=m;else{const e=b._children.findIndex(e=>e.__id__===c);P=g[O=y._children[e]&&y._children[e].__id__]}if(p){const e=f._components.findIndex(e=>e.__id__===n),t=P&&P._components[e]&&P._components[e].__id__,_=t&&g[t];if(!_||s.__type__!==_.__type__)return void o.set(u,d);h=getLocalID(t,g,p)}else{if(!P)return void o.set(u,d);h=getLocalID(O,g,p)}I.source={__id__:t};const v=createTargetInfo(h);return I.target={__id__:l.root.__id__},{emptyProp:a,targetOverrideInfo:I,sourceInfo:_,targetInfo:v}}const SKIP_COMPONENT_KEY=["_name","_objFlags","node","__prefab","_id"];function compareComponentProp(e,n,t,_,r,o){const i=[],a=n.__id__,s=_[a],f=t&&t.__id__,c=r[f];if(!c)return i;let d=[];d=s.__prefab?getLocalID(f,r,!0):getLocalID(a,_,!0);for(let n in s){if(SKIP_COMPONENT_KEY.includes(n))continue;const t=s[n];if(t){if(o[a]===n)continue}const _=c[n];if(JSON.stringify(t)!==JSON.stringify(_)){const _=createPropertyOverrideInfo(n,t),r=createTargetInfo(d);i.push({prefabInstanceID:e,propertyOverrideInfo:_,targetInfo:r})}}return i}function isEqual(e,n,t,_){if(!e._prefab||!n._prefab)return!1;const r=_[e._prefab.__id__],o=t[n._prefab.__id__];if(!r||!o)return!1;if("__uuid__"in o.asset&&r.asset.__uuid__!==o.asset.__uuid__)return!1;if(!!r.sync)return!0;if(e.__type__!==n.__type__)return!1;if(e._children&&!n._children||!e._children&&n._children||!e._children&&!n._children)return!1;if(e._children.length<n._children.length)return!1;const i=e._children.map(e=>_[e.__id__]),a=n._children.map(e=>t[e.__id__]);for(let e=0;e<i.length;++e){if(a[e]&&!isEqual(i[e],a[e],t,_))return!1}if(e._components&&!n._components||!e._components&&n._components||!e._components&&!n._components)return!1;if(e._components.length!==n._components.length)return!1;const s=e._components.map(e=>_[e.__id__]),f=n._components.map(e=>t[e.__id__]);for(let e=0;e<s.length;++e){const n=s[e],t=f[e];if(!n||!t)return!1;if("cc.SkeletalAnimation"===n.__type__&&n._sockets.length>0)return!1;if(n.__type__!==t.__type__)return!1}return!0}function isDiff(e,n){if(!e.asset)return!0;const t=e.root&&e.root.__id__,_=e.asset&&e.asset.__uuid__,r=totalPrefab.get(_);if(!r)return console.warn(`Cannot get Prefab by UUID: ${_}\n PrefabInfo ID: ${t} name: ${n[t]._name} \n`),!0;const o=n[t],i=r[0]&&r[0].data&&r[0].data.__id__;return!isEqual(o,i&&r[i],r,n)}function addInstanceFileID(e,n,t){if(e.instance){const _=n[e.instance.__id__];_&&t.push(_.fileId)}}function getLocalID(e,n,t=!1){let _=[];if(t){const t=n[e];if(t){const e=t.node&&n[t.node.__id__];if(e._prefab){addInstanceFileID(e._prefab&&n[e._prefab.__id__],n,_)}const r=t.__prefab&&t.__prefab.__id__;if(r){const e=n[r];_.push(e.fileId)}}}else{const t=n[e],r=t._prefab&&n[t._prefab.__id__];r&&(addInstanceFileID(r,n,_),_.push(r.fileId))}return _}function isMountedChild(e,n,t,_){const r=e._prefab&&e._prefab.__id__;if(r){if(t[r].sync)return!1}return e.__type__!==n.__type__}function compareChildren(e,n,t,_,r,o){let i=[],a=[],s=[];if(n._children)for(let f=0;f<n._children.length;++f){const c=n._children[f],d=c&&c.__id__,l=d&&r[d];if(!l)continue;const p=t._children[f];if(!p){s.push({__id__:d});continue}const u=p.__id__,b=_[u];if(isMountedChild(l,b,r,_)){s.push({__id__:d});continue}if(l._prefab){i=getLocalID(u,_);const n=compareChildren(e,l,b,_,r,o);n&&(a=a.concat(n.childPropertyOverrides),s=s.concat(n.childMountedNodes))}else i=getLocalID(d,r);const I=compareBaseProp(e,l,b,i,r);a=a.concat(I)}if(n._components)for(let i=0;i<n._components.length;++i){const s=compareComponentProp(e,n._components[i],t._components[i],r,_,o);a=a.concat(s)}return{childPropertyOverrides:a,childMountedNodes:s}}function comparePrefab(e,n,t,_){let r=null,o=[];const i=e.root&&e.root.__id__,a=i&&n[i],s=e.asset.__uuid__;let f=totalPrefab.get(s);if(!f)return void console.warn(`Cannot get Base Prefab by UUID: ${s}, PrefabInfo ID: ${i} name: ${a._name}.`);const c=f[f[0]&&f[0].data&&f[0].data.__id__];if(!c)return;const d=(c._prefab&&f[c._prefab.__id__]).fileId;let l,p=a._prefab&&n[a._prefab.__id__];p&&!p.instance&&(addPrefabInstance(a._prefab.__id__,n,t),p=n[a._prefab.__id__]);let u=compareBaseProp(l=p&&p.instance&&p.instance.__id__,a,c,[d],n);o=o.concat(u);const b=compareChildren(l,a,c,f,n,_),{childPropertyOverrides:I,childMountedNodes:h}=b;if(o=o.concat(I),h.length>0){r=addMountedChildrenInfo(l,n,[d],h)}return{propertyOverrides:o,mountedChildrenInfo:r,childMountedNodes:h}}function updateReplaceIDs(e,n,t){let _=(JSON.stringify(n).match(/(?<="__id__":)([0-9]+)/g)||[]).map(e=>Number(e));for(let n of e)for(let e=0;e<_.length;++e){let r=_[e],o=t[e];o||(o={baseID:r,newID:r},t.push(o)),r>n&&o.newID--}}function addRemoveID(e,n){n.includes(e)||n.push(e)}function addRemove(e,n,t,_=!0){const r=n[e];r._prefab&&(addRemoveID(r._prefab.__id__,t),r._prefab=null),r.__prefab&&(addRemoveID(r.__prefab.__id__,t),r.__prefab=null),r.instance&&(addRemoveID(r.instance.__id__,t),r.instance=null),_&&addRemoveID(e,t)}function restoreNormalNodes(e,n,t){const _=e._prefab&&e._prefab.__id__;if(!_||!n[_].instance){if(e._children){const _=e._children.map(e=>n[e.__id__]);for(let e of _)restoreNormalNodes(e,n,t)}if(e._components)for(let t=0;t<e._components.length;++t){const _=n[e._components[t].__id__];_&&_.__prefab&&(_.__prefab=null)}_&&(e._prefab=null)}}let totalPrefab=new Map;async function beforeMigratePrefab(e){let n=e.getSwapSpace().json;const t=await Editor.Message.request("asset-db","query-assets",{ccType:"cc.Prefab"});for(let e of t)!totalPrefab.has(e.uuid)&&e.file&&totalPrefab.set(e.uuid,fs_extra_1.readJSONSync(e.file));const _=n[0]&&"cc.Prefab"===n[0].__type__;for(let e=0;e<n.length;++e){let t=n[e];addCompPrefabInfo(e,n),"cc.PrefabInfo"===t.__type__&&(t.fileId||(t.fileId=EditorExtends.UuidUtils.uuid()),t.sync&&addPrefabInstance(e,n,_))}_&&totalPrefab.set(e.uuid,n)}function removeAllChild(e,n,t,_=!0,r){const o=n[e];for(let e of o._children){const o=Number(e.__id__);r&&r.includes(o)||(addRemove(o,n,t,_),removeAllChild(o,n,t,_,r))}n[e]._children.length=[];for(let e of o._components){addRemove(Number(e.__id__),n,t,_)}n[e]._components.legnth=[]}function getTargetOverrideInfoForComponents(e,n,t,_,r,o,i){const a=[],s=_[e],f=_[s.node&&s.node.__id__];let c=e,d=null,l=!r;const p=f&&f._prefab&&_[f._prefab.__id__];if(p&&!l){const e=p.asset&&0===p.asset.__id__;if(!(p.root&&o.has(p.root.__id__))&&!e){let e=getLocalID(n,r,!0);d=createTargetInfo(e),c=p.root.__id__}}for(let n of t){let t;const r=s[n];if(r&&Array.isArray(r)&&r[0]&&r[0].__id__)for(let s=0;s<r.length;++s){const f=r[s],p={componentID:e,key:n,idx:s};(t=compareComponentIDProp([n,s.toString()],f.__id__,c,d,_,o,l,p))&&(i[e]=p.key,a.push(t))}else if(r&&r.__id__){const s={componentID:e,key:n,idx:-1};(t=compareComponentIDProp([n],r.__id__,c,d,_,o,l,s))&&(i[e]=s.key,a.push(t))}}return a}async function migratePrefab(e){let n=e.getSwapSpace(),t=n.json;const _=[];for(let t of n.json){if("cc.PrefabInfo"!==t.__type__||!t.asset||!t.asset.__uuid__||t.asset.__uuid__===e.uuid)continue;const n=t.asset.__uuid__;if(!_.includes(n)){_.push(n);const t=asset_db_1.queryAsset(n);if(t){t._init||(e._assetDB.taskManager.pause(e.task),await t.waitInit(),e._assetDB.taskManager.resume(e.task));try{const e=fs_extra_1.readJSONSync(t.library+".json");totalPrefab.has(n)||totalPrefab.set(n,e)}catch(e){console.error(e)}}else console.warn(`depends aseet uuid: ${n} missing in the scene: ${e.basename}`)}}const r=t[0]&&"cc.Prefab"===t[0].__type__,o=r?"prefab":"scene",i=new Map,a=[];let s=new Map,f=[],c=[],d=[],l=[],p=[];for(let n=0;n<t.length;++n){let _=t[n];if("cc.Node"===_.__type__&&_._prefab){const r=_._prefab.__id__,a=t[r];if(!a||!a.root||!a.asset){s.get(n)||s.set(n,r),console.warn(`Prefab asset missing, name: ${_._name} in the ${o} : ${e.basename}.`);continue}let f=i.get(a.root.__id__);f?f.push(r):f=[r],i.set(a.root.__id__,f)}}i.forEach((e,n,_)=>{const o=t[n];if(!o)return void console.warn(`The prefab is bad. id: ${n}`);const i=o._prefab&&o._prefab.__id__,a=t[i];let f=!0;r&&(f=!!a.instance&&!a.sync),f&&isDiff(a,t)&&!s.get(n)&&s.set(n,i)});for(let n of t)if("cc.Node"===n.__type__&&n._components){const _=n._components.map((e,n)=>{const _=t[e.__id__],r=[];for(let e in _){let n=_[e];if(SKIP_COMPONENT_KEY.includes(e)||!n)continue;(Array.isArray(n)?n[0]&&n[0].__id__:n&&n.__id__)&&r.push(e)}if(r.length>0)return{index:n,__id__:e.__id__,keys:r}}).filter(Boolean);if(0===_.length)continue;let r,i=n._prefab&&n._prefab.__id__;if(n._prefab){const _=t[i],a=_&&_.asset&&_.asset.__uuid__;0===(_.asset&&_.asset.__id__)?r=t:a&&((r=totalPrefab.get(a))||console.warn(`Cannot get Prefab by UUID: ${a}, the node name: ${n._name} in the ${o} : ${e.basename}`))}const a=r&&r[1];for(let e of _){const n=e.index,_=e.__id__,o=e.keys,i=getTargetOverrideInfoForComponents(_,a&&a._components[n]&&a._components[n].__id__,o,t,r,s,p);l=l.concat(i)}}i.forEach((e,n,_)=>{const o=t[n];if(!o)return;const i=o._prefab.__id__,a=t[i];let l=!0,u=!0;if(r&&(u=!!a.instance&&!a.sync,l=!!a.instance),(!u||!s.has(n))&&l)try{const e=comparePrefab(a,t,r,p);if(e){const{propertyOverrides:n,mountedChildrenInfo:t,childMountedNodes:_}=e;t&&(c=c.concat(t),f=f.concat(_)),d=d.concat(n)}}catch(e){i&&!s.has(n)&&s.set(n,i),console.error(e)}}),i.forEach((e,n,_)=>{if(s.has(n))return;const r=t[n],o=r._prefab&&r._prefab.__id__;o&&o.instance&&removeAllChild(n,t,a,!0,f);for(let n of e){const e=t[n];if(e.instance)for(let e in r)INSTANCE_RESERVED_KEYWORDS.includes(e)||delete r[e];delete e.sync,delete e._synced}});for(let e of d){t.push(e.targetInfo);const n=t.length-1;e.propertyOverrideInfo.targetInfo={__id__:n},t.push(e.propertyOverrideInfo);const _=t.length-1;t[e.prefabInstanceID].propertyOverrides.push({__id__:_})}for(let e of c){t.push(e.targetInfo);const n=t.length-1;e.mountedChildrenInfo.targetInfo={__id__:n},t.push(e.mountedChildrenInfo);const _=t.length-1;t[e.prefabInstanceID].mountedChildren.push({__id__:_})}if(l.length>0){const e=[];for(let n of l){const _=n.emptyProp&&n.emptyProp.componentID;if(_){const e=t[_],n=e&&e.node&&e.node.__id__,r=t[n],o=r._prefab&&r._prefab.__id__,i=t[o],a=i&&i.root&&i.root.__id__;if(a&&s.has(a))continue}if(n.sourceInfo){t.push(n.sourceInfo);const e=t.length-1;n.targetOverrideInfo.sourceInfo={__id__:e}}if(n.targetInfo){t.push(n.targetInfo);const e=t.length-1;t.length;n.targetOverrideInfo.targetInfo={__id__:e}}t.push(n.targetOverrideInfo);const r=t.length-1;e.push({__id__:r});const o=n.emptyProp;if(o){let e=t[o.componentID],n=e[o.key];Array.isArray(n)?n[o.idx]=null:n=null,e[o.key]=n}}addPrefabInfo(e,t)}for(let e of f){const n=e.__id__,_=t[n],r=t[_._prefab.__id__];if(r.instance)continue;const o=r.root&&r.root.__id__;if(o&&s.has(o))continue;const i=!r;addRemove(n,t,a,i),removeAllChild(n,t,a,i),_._prefab=null}s.forEach((e,n,_)=>{const r=t[n];if(t[e].instance)return;restoreNormalNodes(r,t,a);const o=addPrefabLink(t,n,e);-1!==o&&r._components.push({__id__:o})}),n.json=t}exports.beforeMigratePrefab=beforeMigratePrefab,exports.migratePrefab=migratePrefab;