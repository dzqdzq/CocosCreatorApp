"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextureCubeFaceImporter=exports.makeDefaultTextureCubeAssetUserData=void 0;const asset_db_1=require("@editor/asset-db"),texture_base_1=require("./texture-base"),equirect_cubemap_faces_1=require("./utils/equirect-cubemap-faces"),cc=__importStar(require("cc")),cube_map_simple_layout_1=require("./utils/cube-map-simple-layout"),migratesNameToId=__importStar(require("./migrates/name2id")),sharp_1=__importDefault(require("sharp"));function makeDefaultTextureCubeAssetUserData(){const e=texture_base_1.makeDefaultTextureBaseAssetUserData();return e.isRGBE=!1,e.mipfilter="linear",e}exports.makeDefaultTextureCubeAssetUserData=makeDefaultTextureCubeAssetUserData;class ERPTextureCubeImporter extends asset_db_1.Importer{get version(){return"1.0.10"}get name(){return"erp-texture-cube"}get assetType(){return"cc.TextureCube"}get migrations(){return[{version:"1.0.9",migrate:migratesNameToId.migrate}]}async import(e){0===Object.getOwnPropertyNames(e.userData).length&&e.assignUserData(makeDefaultTextureCubeAssetUserData(),!0);const t=e.userData,r=asset_db_1.queryAsset(t.imageDatabaseUri);if(!r)return!1;let a;a=[".tga",".hdr",".bmp"].includes(e.parent.extname.toLowerCase())?r.library+".png":r.source;const s=sharp_1.default(a),i=await s.metadata(),u=i.width,n=i.height;let o;const c=cube_map_simple_layout_1.matchSimpleLayout(u,n);o=c?await this._getFacesInSimpleLayout(s,c):await this._getFacesInEquirectangularProjected(a,0===t.faceSize?void 0:t.faceSize,t.isRGBE);const m={},p=e.getSwapSpace();for(const t of Object.getOwnPropertyNames(o)){const r=o[t];p[t]=r;const a=await e.createSubAsset(t,"texture-cube-face");m[t]=EditorExtends.serialize.asAsset(a.uuid,cc.ImageAsset)}const l=new cc.TextureCube;return texture_base_1.applyTextureBaseAssetUserData(t,l),l.isRGBE=t.isRGBE,l._mipmaps=[m],await e.saveToLibrary(".json",EditorExtends.serialize(l)),!0}async _getFacesInSimpleLayout(e,t){const r={},a=Object.getOwnPropertyNames(t);for(const e of a)r[e]=void 0;return await Promise.all(a.map(async a=>{const s=t[a],i=e.extract({left:s.x,top:s.y,width:s.width,height:s.height}),u=await i.toFormat(sharp_1.default.format.png).toBuffer();r[a]=u})),r}async _getFacesInEquirectangularProjected(e,t,r){const a=await new Promise((t,r)=>{const a=document.createElement("img");a.onload=(()=>t(a)),a.onerror=r,a.src=e}),s=equirect_cubemap_faces_1.equirectToCubemapFaces(a,t,{isRGBE:r});if(6!==s.length)throw new Error("Failed to resolve equirectangular projection image.");const i=await Promise.all(s.map(getCanvasData));return{right:i[0],left:i[1],top:i[2],bottom:i[3],front:i[4],back:i[5]}}}exports.default=ERPTextureCubeImporter;class TextureCubeFaceImporter extends asset_db_1.Importer{get version(){return"1.0.0"}get name(){return"texture-cube-face"}get assetType(){return"cc.ImageAsset"}async import(e){if(!e.parent)return!1;const t=e.parent.getSwapSpace();if(!t)return!1;const r=e._name;if(!(r in t))return!1;const a=t[r];await e.saveToLibrary(".png",a);const s=new cc.ImageAsset;return s._setRawAsset(".png"),await e.saveToLibrary(".json",EditorExtends.serialize(s)),!0}}async function getCanvasData(e){const t=await new Promise((t,r)=>{e.toBlob(e=>{e?t(e):r(e)})}),r=await new Response(t).arrayBuffer();return Buffer.from(r)}exports.TextureCubeFaceImporter=TextureCubeFaceImporter;