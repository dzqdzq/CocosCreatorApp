"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const asset_db_1=require("@editor/asset-db"),assert_1=require("assert"),fs_extra_1=require("fs-extra"),erp_texture_cube_1=require("../erp-texture-cube"),sprite_frame_1=require("../sprite-frame"),texture_1=require("../texture"),image_mics_1=require("./image-mics"),migrations_1=require("./migrations"),image_utils_1=require("../utils/image-utils"),Sharp=require("sharp");class ImageImporter extends asset_db_1.Importer{get version(){return"1.0.21"}get name(){return"image"}get assetType(){return"cc.ImageAsset"}get migrations(){return migrations_1.migrations}async force(e){return!1}async validate(e){return!await e.isDirectory()}async import(e){let a=e.extname,t=e.source;if(".tga"===a.toLowerCase()){const r=await image_mics_1.convertTGA(await fs_extra_1.readFile(e.source));if(r instanceof Error||!r)return console.error("Failed to convert tga image."),!1;a=r.extName,t=r.data}const r=await Sharp(t).metadata();e.userData.hasAlpha=r.hasAlpha,!!e.userData.flipVertical&&("string"==typeof t&&(t=await fs_extra_1.readFile(e.source)),t=await Sharp(t).flip().toBuffer()),"string"==typeof t?await e.copyToLibrary(a,e.source):await e.saveToLibrary(a,t);const s=new cc.ImageAsset;s._setRawAsset(a),await e.saveToLibrary(".json",EditorExtends.serialize(s));const i=asset_db_1.queryUrl(e.source);if(!i)throw new assert_1.AssertionError({message:`${e.source} is not found in asset-db.`});let u=e.userData.type;switch(void 0===u&&(u=await image_utils_1.checkImageTypeToSpriteFrame(e),e.userData.type=u),u){case"raw":delete e.userData.redirect;break;case"texture":const a=await e.createSubAsset("texture","texture",{displayName:e.basename});e.userData.redirect=a.uuid,a.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid)),a.userData.imageUuidOrDatabaseUri=e.uuid;break;case"normal map":const t=await e.createSubAsset("normalMap","texture",{displayName:e.basename});e.userData.redirect=t.uuid,t.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));break;case"texture cube":const r=await e.createSubAsset("textureCube","erp-texture-cube",{displayName:e.basename});e.userData.redirect=r.uuid,r.assignUserData(erp_texture_cube_1.makeDefaultTextureCubeAssetUserData()),r.userData.imageDatabaseUri=i,r.userData.isRGBE=!!e.userData.isRGBE;break;case"sprite-frame":const s=await e.createSubAsset("texture","texture",{displayName:e.basename});e.userData.redirect=s.uuid,s.userData.imageUuidOrDatabaseUri=e.uuid,s.assignUserData(texture_1.makeDefaultTexture2DAssetUserDataFromImageUuid(e.uuid));const m=await e.createSubAsset("spriteFrame","sprite-frame",{displayName:e.basename});e.userData.redirect=m.uuid,m.assignUserData(sprite_frame_1.makeDefaultSpriteFrameAssetUserDataFromImageUuid(s.uuid,"")),m.userData.imageUuidOrDatabaseUri=s.uuid}return!0}}exports.default=ImageImporter;