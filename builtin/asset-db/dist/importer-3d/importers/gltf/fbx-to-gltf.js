"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.fbxToGlTf=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=require("path"),fbx2glTf_1=require("../utils/fbx2glTf"),tmp_1=__importDefault(require("tmp")),utils_1=require("../../utils");async function fbxToGlTf(t,e,r){const a=e.options.temp,i=path_1.join(a,`fbx2gltf-${t.uuid}`);await fs_extra_1.default.ensureDir(i);const s=path_1.join(i,"out","out.gltf"),f=path_1.join(i,"status.json"),o={mtimeMs:(await fs_extra_1.default.stat(t.source)).mtimeMs,version:r};if(await fs_extra_1.default.pathExists(f)){if(isSameConversionStatus(JSON.parse((await fs_extra_1.default.readFile(f)).toString()),o)&&await fs_extra_1.default.pathExists(s))return s}await fs_extra_1.default.pathExists(i)&&await fs_extra_1.default.emptyDir(i);const _=[()=>path_1.join(i,"fbm"),()=>{return tmp_1.default.dirSync({mode:777,prefix:"fbm"}).name}];let u=null;for(const t of _){const e=t();if(/^[\x00-\x7F]*$/.test(e)){u=e;break}}if(!u)throw new Error(utils_1.i18nTranslate("asset-db.importers.fbx.no_available_fbx_temp_dir"));await fs_extra_1.default.ensureDir(u);const n=["--fbx-temp-dir",u];if(await fs_extra_1.default.ensureDir(path_1.dirname(s)),await fbx2glTf_1.convert(t.source,s,n),fs_extra_1.default.existsSync(s))return console.debug(`${t.source} is converted to: ${s}`),await fs_extra_1.default.writeFile(f,JSON.stringify(o,void 0,2)),s;throw new Error(utils_1.i18nTranslate("asset-db.importers.fbx.failed_to_convert_fbx_file",{path:t.source}))}function isSameConversionStatus(t,e){return t.mtimeMs===e.mtimeMs&&t.version===e.version}exports.fbxToGlTf=fbxToGlTf;