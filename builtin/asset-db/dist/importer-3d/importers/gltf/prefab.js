"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GltfPrefabImporter=void 0;const asset_db_1=require("@editor/asset-db"),cc=__importStar(require("cc")),path_1=__importDefault(require("path")),asset_finder_1=require("./asset-finder"),load_asset_sync_1=require("./load-asset-sync"),reader_manager_1=require("./reader-manager");class GltfPrefabImporter extends asset_db_1.Importer{get version(){return"1.0.12"}get name(){return"gltf-scene"}get assetType(){return"cc.Prefab"}async import(e){if(!e.parent)return!1;const t=await reader_manager_1.glTfReaderManager.getOrCreate(e.parent),r=e.parent.userData,a=t.createScene(e.userData.gltfIndex,new asset_finder_1.DefaultGltfAssetFinder(r.assetFinder)),n=[];for(const t of Object.keys(e.parent.subAssets)){const r=e.parent.subAssets[t];"gltf-animation"===r.meta.importer&&n.push(r.uuid)}let s=null;if(a.getComponentInChildren(cc.SkinnedMeshRenderer)?(s=a.addComponent(cc.SkeletalAnimation))._sockets=t.createSockets(a):0!==n.length&&(s=a.addComponent(cc.Animation)),s){const e=n.map(e=>load_asset_sync_1.loadAssetSync(e)||null);s._clips=e;for(const t of e)if(t){s._defaultClip=t;break}}if(1===t.gltf.scenes.length){const t=e.parent.basename;a.name=path_1.default.basename(t,path_1.default.extname(t))}const i=generatePrefab(a);return await e.saveToLibrary(".json",EditorExtends.serialize(i)),!0}}function getDumpableNode(e,t){return EditorExtends.PrefabUtils.addPrefabInfo(e,e,t,{useNodePathAsFileId:!0}),EditorExtends.PrefabUtils.checkAndStripNode(e),e}function generatePrefab(e){const t=new cc.Prefab,r=getDumpableNode(e,t);return t.data=r,t}exports.GltfPrefabImporter=GltfPrefabImporter;