"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.migrate_1_0_10=exports.migrate_1_0_8=exports.changeCCType=exports.migrate_1_0_3=void 0;const asset_db_1=require("@editor/asset-db"),cc_1=require("cc"),fs_extra_1=require("fs-extra"),path_1=require("path"),migrates_1=require("./scene/migrates");class AnimationImporter extends asset_db_1.Importer{get version(){return"1.0.11"}get name(){return"animation-clip"}get assetType(){return"cc.AnimationClip"}get migrations(){return[{version:"1.0.2",migrate:migrates_1.migrateImageUuid},{version:"1.0.3",migrate:migrate_1_0_3},{version:"1.0.4",async migrate(e){await migrates_1.migrateNameToId(e,!0)}},{version:"1.0.5",migrate:migrates_1.migrateNameToId},{version:"1.0.6",migrate:migrateType},{version:"1.0.7",migrate:migrateSharedMaterials},{version:"1.0.8",migrate:migrate_1_0_8},{version:"1.0.10",migrate:migrate_1_0_10},{version:"1.0.11",migrate:migrateComponentNames}]}get migrationHook(){return migrates_1.migrationHook}async force(e){return e.userData.name!==e.basename}async import(e){const a=e.userData;try{const t=fs_extra_1.readJSONSync(e.source),r=Array.isArray(t)?t[0]:t;r._name=path_1.basename(e.source,".anim"),a.name=r._name,r._curves&&(r._hash=cc_1.murmurhash2_32_gc(JSON.stringify(r._curves),666)),await e.saveToLibrary(".json",JSON.stringify(t,null,2))}catch(e){return console.error(e),!1}return!0}}exports.default=AnimationImporter;const walkCCClass=(e,a,t)=>{if(Array.isArray(e))e.forEach(e=>{walkCCClass(e,a,t)});else if(e&&"object"==typeof e)if(e.__type__===a)t(e);else for(const r of Object.values(e))walkCCClass(r,a,t)},walkCCClasses=(e,a)=>{if(Array.isArray(e))e.forEach((t,r)=>{e[r]=walkCCClasses(t,a)});else if(e&&"object"==typeof e){if(e.__type__ in a)return a[e.__type__](e);for(const t of Object.keys(e))e[t]=walkCCClasses(e[t],a)}return e};async function migrate_1_0_3(e){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);walkCCClass(a,cc.js.getClassName(cc.AnimationClip),e=>{const{_curves:a,curveDatas:t}=e;Array.isArray(a)&&0!==a.length&&"object"==typeof t&&0!==Object.keys(t).length&&delete e._curves})}function changeCCType(e,a){return e.__type__=a,e}async function migrate_1_0_8(e){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);walkCCClasses(a,{[cc_1.js.getClassName(cc_1.ComponentModifier)]:e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.ComponentPath)),[cc_1.js.getClassName(cc_1.HierachyModifier)]:e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.HierarchyPath)),[cc_1.js.getClassName(cc_1.UniformCurveValueAdapter)]:e=>changeCCType(e,cc_1.js.getClassName(cc_1.animation.UniformProxyFactory))})}async function migrate_1_0_10(e){const a=e.getSwapSpace(),t=a.json||await fs_extra_1.readJSON(e.source);if(!t.curveDatas)return;let r,s;try{r=cc_1.deserialize(t.curveDatas,void 0,{createAssetRefs:!0})}catch(e){return}try{s=cc_1.deserialize(t,void 0,{createAssetRefs:!0})}catch(e){return}const{curves:c}=s;for(const e of Object.keys(r)){const a=new cc_1.animation.HierarchyPath;a.path=e;const t=r[e];if(t.props)for(const e of Object.keys(t.props)){const r=t.props[e];c.push({modifiers:[a,e],data:r})}if(t.comps)for(const e of Object.keys(t.comps)){const r=new cc_1.animation.ComponentPath;r.component=e;const s=t.comps[e];for(const e of Object.keys(s)){const t=s[e];c.push({modifiers:[a,r,e],data:t})}}}delete s.curveDatas,a.json=JSON.parse(EditorExtends.serialize(s))}async function migrateComponentNames(e){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);for(let e=0;e<a.length;e++){const t=a[e];let r=migrates_1._renameMap[t.component];r&&(t.component=r)}}async function migrateType(e){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);"cc.AnimationClip"!==a.__type__&&(a.__type__="cc.AnimationClip")}async function migrateSharedMaterials(e){const a=e.getSwapSpace().json||await fs_extra_1.readJSON(e.source);if(!a)return;const t=a[0];if(!t||t.__type__!==cc_1.js.getClassName(cc_1.AnimationClip))return;const r=t._curves;r&&r.length>0&&r.forEach(e=>{if(e){const a=e.modifiers;a&&a.length>=2&&"sharedMaterials"===a[1]&&(a[1]="materials")}})}exports.migrate_1_0_3=migrate_1_0_3,exports.changeCCType=changeCCType,exports.migrate_1_0_8=migrate_1_0_8,exports.migrate_1_0_10=migrate_1_0_10;