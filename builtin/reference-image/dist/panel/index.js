"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.ready=exports.methods=exports.$=exports.template=exports.style=void 0;const remote=require("electron").remote,path_1=require("path"),fs_1=require("fs"),{I18n:I18n,Message:Message,Dialog:Dialog,Profile:Profile}=Editor;let ui_editor,ui_images,ui_x,ui_y,ui_opacity,btn_add,btn_del;exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../dist/index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../statics/index.html"),"utf8"),exports.$={ui_editor:".config",ui_images:".images",btnAdd:".add-image",btnDel:".del-image",x:".x",y:".y",opacity:".opacity"};let onMoveXFunc,onMoveYFunc,onAddImageFunc,onDelImageFunc,onSetOpacityFunc,onSwitchImagesFunc,images=[],index=0,x=0,y=0,opacity=0,show=!0,initialized=!1;exports.methods={async"scene:ready"(){const e=this;initialized||(initialized=!0,await e.updateImages()),Message.broadcast("reference-image:show",show)},async updateImages(){for(;ui_images.firstChild;)ui_images.removeChild(ui_images.firstChild);for(let e=0;e<images.length;++e){const i=document.createElement("option");i.setAttribute("value",`${e}`),ui_images.appendChild(i);const t=images[e];i.text=path_1.basename(t,path_1.extname(t))}btn_del.removeAttribute("disabled"),ui_editor.removeAttribute("disabled"),ui_images.removeAttribute("placeholder"),ui_images.setAttribute("value",""),0===images.length?(ui_images.setAttribute("placeholder",I18n.t("reference-image.none")),btn_del.setAttribute("disabled",""),ui_editor.setAttribute("disabled",""),await this.resetImage()):(ui_images.setAttribute("value",`${index}`),await this.sendSwitchImages())},async onAddImage(){const e=await Dialog.select({title:I18n.t("reference-image.dialog.add-image-title"),path:await Profile.getConfig("reference-image","root-path")||"",filters:[{name:"image",extensions:["png","jpg"]}]});if(!e||!e.filePaths[0])return;for(let i of e.filePaths)images.includes(i)||images.push(i);index=images.length-1,await this.updateImages();const i=path_1.dirname(e.filePaths[0]);await Profile.setConfig("reference-image","root-path",i)},async onDelImage(){0===(await Dialog.info(I18n.t("reference-image.dialog.del_image_message",{path:images[index]}),{buttons:[I18n.t("reference-image.dialog.yes"),I18n.t("reference-image.dialog.cancel")],default:0,cancel:1})).response&&(images.splice(index,1),--index<0&&(index=0),await this.updateImages())},async resetImage(){await Message.request("scene","execute-scene-script",{name:"reference-image",method:"resetImage"})},async sendSwitchImages(){const e=images[index];await Message.request("scene","execute-scene-script",{name:"reference-image",method:"switchImages",args:[e]}),await this.sendMoveX(),await this.sendMoveY(),await this.sendOpacity()},async onSwitchImages(e){index=parseInt(e.target.value),await this.sendSwitchImages()},async sendOpacity(){await Message.request("scene","execute-scene-script",{name:"reference-image",method:"setOpacity",args:[opacity]})},async sendMoveX(){await Message.request("scene","execute-scene-script",{name:"reference-image",method:"moveX",args:[x]})},async sendMoveY(){await Message.request("scene","execute-scene-script",{name:"reference-image",method:"moveY",args:[y]})},async onMoveX(e){x=e.target.value,await Profile.setConfig("reference-image","x",x),await this.sendMoveX()},async onMoveY(e){y=e.target.value,await Profile.setConfig("reference-image","y",y),await this.sendMoveY()},async onSetOpacity(e){opacity=e.target.value,await Profile.setConfig("reference-image","opacity",opacity),await this.sendOpacity()},registerEventListeners(){onMoveXFunc=this.onMoveX.bind(this),onMoveYFunc=this.onMoveY.bind(this),onSetOpacityFunc=this.onSetOpacity.bind(this),onSwitchImagesFunc=this.onSwitchImages.bind(this),onAddImageFunc=this.onAddImage.bind(this),onDelImageFunc=this.onDelImage.bind(this),ui_x.addEventListener("confirm",onMoveXFunc),ui_y.addEventListener("confirm",onMoveYFunc),ui_opacity.addEventListener("confirm",onSetOpacityFunc),ui_images.addEventListener("confirm",onSwitchImagesFunc),btn_add.addEventListener("click",onAddImageFunc),btn_del.addEventListener("click",onDelImageFunc)},unregisterEventListeners(){ui_x.removeEventListener("confirm",onMoveXFunc),ui_y.removeEventListener("confirm",onMoveYFunc),ui_opacity.removeEventListener("confirm",onSetOpacityFunc),ui_images.removeEventListener("confirm",onSwitchImagesFunc),btn_add.removeEventListener("click",onAddImageFunc),btn_del.removeEventListener("click",onDelImageFunc)}};const ready=async function(){remote.getCurrentWindow().setTitle(I18n.t("reference-image.name"));const e=this;ui_x=e.$.x,ui_y=e.$.y,ui_editor=e.$.ui_editor,ui_images=e.$.ui_images,ui_opacity=e.$.opacity,btn_add=e.$.btnAdd,btn_del=e.$.btnDel,e.registerEventListeners(),x=await Profile.getConfig("reference-image","x")||0,y=await Profile.getConfig("reference-image","y")||0,opacity=await Profile.getConfig("reference-image","opacity")||100,index=await Profile.getConfig("reference-image","index")||index,images=await Profile.getConfig("reference-image","images")||[],ui_x.value=x,ui_y.value=y,ui_opacity.value=opacity,ui_images.value=index,initialized||(initialized=!0,await e.updateImages()),show=await Profile.getConfig("reference-image","show"),Message.broadcast("reference-image:show",show)};exports.ready=ready;const close=async function(){this.unregisterEventListeners(),await Profile.setConfig("reference-image","images",images),await Profile.setConfig("reference-image","index",index)};exports.close=close;