"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.checkWhen=exports.contributions=void 0;const lodash_1=require("lodash"),platform_1=require("./platform"),panel=require("@editor/panel"),panelMap={},modeMap={},projectTypeMap={},packageShortcutMap=new Map;let shortcutUserConfig={};const noopMap=Object.freeze({}),menuMap={},dirty=[];let projectType="3d";function checkWhen(when){if(!when)return!0;if("string"!=typeof when)return!1;const $focusPanel=panel.getFocusPanel(),EditMode=Editor.EditMode.getMode(),PanelName=$focusPanel.current,ProjectType=projectType;try{return eval(when)}catch(e){return console.error(e),!1}}async function readUserShortcutConfig(){return Editor.Profile.getConfig("shortcuts","userConfig","global").then(e=>{const t={};return(0,lodash_1.forOwn)(e,(e,a)=>{const o={};(0,lodash_1.forOwn)(e,e=>{if("string"!=typeof e.rawShortcut)return;const t=e.rawShortcut;(0,lodash_1.has)(o,t)&&console.warn(`raw shortcut "${t}" already exists in package "${a}"`),o[t]=e}),t[a]=o}),t})}async function load(){const e=await Editor.Profile.getProject("engine","modules.includeModules");e&&!e.includes("3d")&&(projectType="2d"),await(0,platform_1.getPlatform)(process.platform)(),shortcutUserConfig=await readUserShortcutConfig(),Editor.Layout.__protected__.on("layout-added",updateCustomLayoutMenu),panel.on("focus",exports.methods.updatePanelMenu),panel.on("blur",exports.methods.updatePanelMenu)}async function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach),Editor.Package.__protected__.removeListener("disable",exports.methods.detach),Editor.Layout.__protected__.removeListener("layout-added",updateCustomLayoutMenu),panel.removeListener("focus",exports.methods.updatePanelMenu),panel.removeListener("blur",exports.methods.updatePanelMenu)}async function updateCustomLayoutMenu(){let e="Cocos Creator";"win32"===process.platform&&(e="i18n:menu.file"),Editor.Menu.__protected__.add(`${e}/i18n:menu.layout`,{label:"i18n:menu.customLayout",enabled:!!await Editor.Layout.query("custom"),async click(){Editor.Layout.apply(await Editor.Layout.query("custom"))}}),Editor.Menu.__protected__.apply()}exports.contributions={enable(e,t){exports.methods.attach(e,t)},disable(e,t){exports.methods.detach(e,t)}},exports.checkWhen=checkWhen,exports.methods={attach(e,t){if(e.invalid)return;const a=t||[],o=e.info.contributions&&e.info.contributions.shortcuts||[],r=[];(a||[]).forEach(t=>{dirty.push({path:t.path,label:t.label}),menuMap[t.path]=menuMap[t.path]||{},menuMap[t.path][t.label]=menuMap[t.path][t.label]||[];const a=Editor.Utils.Parse.when(t.when);a.PanelName&&(panelMap[a.PanelName]=panelMap[a.PanelName]||[],panelMap[a.PanelName].push({label:t.label,source:e.name,path:t.path})),a.EditMode&&(modeMap[a.EditMode]=modeMap[a.EditMode]||[],modeMap[a.EditMode].push({label:t.label,source:e.name,path:t.path})),a.ProjectType&&(projectTypeMap[a.ProjectType]=projectTypeMap[a.ProjectType]||[],projectTypeMap[a.ProjectType].push({label:t.label,source:e.name,path:t.path})),menuMap[t.path][t.label].push({source:e.name,when:t.when,shortcuts:(o||[]).reduce((o,p,n)=>{if(p.message!==t.message)return o;const l=Editor.Utils.Parse.when(p.when);return l.PanelName&&a.PanelName!==l.PanelName&&(panelMap[l.PanelName]=panelMap[l.PanelName]||[],panelMap[l.PanelName].push({label:t.label,source:e.name,path:t.path})),l.EditMode&&a.EditMode!==l.EditMode&&(modeMap[l.EditMode]=modeMap[l.EditMode]||[],modeMap[l.EditMode].push({label:t.label,source:e.name,path:t.path})),r.push({label:t.label,source:e.name,path:t.path}),o.push(p),o},[]),option:{label:t.label,sublabel:t.sublabel,type:t.type,checked:t.checked,enabled:t.enabled,accelerator:"",group:t.group||"default",order:t.order||0,role:t.role,template:t.template,message:t.message,params:t.params,target:e.name}})}),packageShortcutMap.set(e.name,r),exports.methods.apply()},detach(e,t){(t||[]||[]).forEach(t=>{if(menuMap[t.path]&&menuMap[t.path][t.label])for(let a=0;a<menuMap[t.path][t.label].length;a++){const o=menuMap[t.path][t.label][a];o&&o.source===e.name&&menuMap[t.path][t.label].splice(a--,1)}Editor.Menu.__protected__.remove(t.path,t)}),Object.keys(panelMap).forEach(t=>{const a=panelMap[t];if(a)for(let t=0;t<a.length;t++)a[t].source===e.name&&(a.splice(t,1),t--)}),packageShortcutMap.delete(e.name),Editor.Menu.__protected__.apply()},apply(){if(0!==dirty.length){for(const e of dirty)exports.methods.updateMenu(e.path,e.label);dirty.length=0,Editor.Menu.__protected__.apply()}},updatePanelMenu(e){const t=panelMap[e];t&&(t.forEach(e=>{dirty.push({path:e.path,label:e.label})}),exports.methods.apply())},updateMenu(e,t){var a,o;const r=(menuMap[e]||{})[t]||[];let p=!0;for(const t of r){panel.getFocusPanel();if(!checkWhen(t.when))continue;const r=null!==(a=shortcutUserConfig[t.source])&&void 0!==a?a:noopMap;for(const e of t.shortcuts){if(e.when){if(!Editor.Utils.Parse.checkWhen(e.when)){t.option.accelerator="";continue}}let a="win32"===process.platform?e.win:e.mac;(0,lodash_1.has)(r,a)&&r[a].message===e.message&&(a=null!==(o=r[a].shortcut)&&void 0!==o?o:a),t.option.accelerator=a;break}"win32"===process.platform&&/^Cocos Creator/.test(e)&&(e="about"===t.option.group?e.replace(/^Cocos Creator/,"i18n:menu.help"):e.replace(/^Cocos Creator/,"i18n:menu.file")),Editor.Menu.__protected__.add(e,t.option),p=!1;break}p&&Editor.Menu.__protected__.remove(e,{label:t})},engineModuleChanged(e){projectType=e.includes("3d")?"3d":"2d";for(const e in projectTypeMap){projectTypeMap[e].forEach(e=>{dirty.push({path:e.path,label:e.label})})}exports.methods.apply()},modeChanged(e,t){const a=modeMap[t];a&&a.forEach(e=>{dirty.push({path:e.path,label:e.label})});const o=modeMap[e];o&&o.forEach(e=>{dirty.push({path:e.path,label:e.label})}),exports.methods.apply()},async onShortcutChange(e){if("string"!=typeof e)return;const t=packageShortcutMap.get(e);if(Array.isArray(t)&&!(t.length<1))try{shortcutUserConfig=await readUserShortcutConfig()}finally{for(const e of t)dirty.push({path:e.path,label:e.label});exports.methods.apply()}}},exports.load=load,exports.unload=unload;