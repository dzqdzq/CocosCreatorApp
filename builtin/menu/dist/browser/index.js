"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.checkWhen=exports.contributions=void 0;const path_1=require("path"),platform_1=require("./platform"),panel=require("@editor/panel"),panelMap={},modeMap={},projectTypeMap={},menuMap={},dirty=[];let projectType="3d";function checkWhen(when){if(!when)return!0;if("string"!=typeof when)return!1;const $panel=require("@editor/panel"),$focusPanel=$panel.getFocusPanel(),EditMode=Editor.EditMode.getMode(),PanelName=$focusPanel.current,ProjectType=projectType;try{return eval(when)}catch(e){return console.error(e),!1}}async function load(){const e=await Editor.Profile.getProject("engine","modules.includeModules");e&&!e.includes("3d")&&(projectType="2d"),(platform_1.getPlatform(process.platform)||function(){})(),panel.on("focus",exports.methods.updatePanelMenu),panel.on("blur",exports.methods.updatePanelMenu)}async function unload(){Editor.Package.removeListener("enable",exports.methods.attach),Editor.Package.removeListener("disable",exports.methods.detach),panel.removeListener("focus",exports.methods.updatePanelMenu),panel.removeListener("blur",exports.methods.updatePanelMenu)}exports.contributions={enable(e,a){exports.methods.attach(e,a)},disable(e,a){exports.methods.detach(e,a)}},exports.checkWhen=checkWhen,exports.methods={attach(e,a){if(e.invalid)return;const t=a||[],o=e.info.contributions&&e.info.contributions.shortcuts||[];(t||[]).forEach(a=>{dirty.push({path:a.path,label:a.label}),menuMap[a.path]=menuMap[a.path]||{},menuMap[a.path][a.label]=menuMap[a.path][a.label]||[];const t=Editor.Utils.Parse.when(a.when);t.PanelName&&(panelMap[t.PanelName]=panelMap[t.PanelName]||[],panelMap[t.PanelName].push({label:a.label,source:e.name,path:a.path})),t.EditMode&&(modeMap[t.EditMode]=modeMap[t.EditMode]||[],modeMap[t.EditMode].push({label:a.label,source:e.name,path:a.path})),t.ProjectType&&(projectTypeMap[t.ProjectType]=projectTypeMap[t.ProjectType]||[],projectTypeMap[t.ProjectType].push({label:a.label,source:e.name,path:a.path})),menuMap[a.path][a.label].push({source:e.name,when:a.when,shortcuts:(o||[]).filter(o=>{if(o.message!==a.message)return!1;const p=Editor.Utils.Parse.when(o.when);return p.PanelName&&t.PanelName!==p.PanelName&&(panelMap[p.PanelName]=panelMap[p.PanelName]||[],panelMap[p.PanelName].push({label:a.label,source:e.name,path:a.path})),p.EditMode&&t.EditMode!==p.EditMode&&(modeMap[p.EditMode]=modeMap[p.EditMode]||[],modeMap[p.EditMode].push({label:a.label,source:e.name,path:a.path})),!0}),option:{label:a.label,subLabel:a.subLabel,type:a.type,checked:a.checked,enabled:a.enabled,icon:a.icon?path_1.join(e.path,a.icon):void 0,accelerator:"",group:a.group||"default",order:a.order||0,role:a.role,template:a.template,message:a.message,params:a.params,target:e.name}})}),exports.methods.apply()},detach(e,a){(a||[]||[]).forEach(a=>{if(menuMap[a.path]&&menuMap[a.path][a.label])for(let t=0;t<menuMap[a.path][a.label].length;t++){const o=menuMap[a.path][a.label][t];o&&o.source===e.name&&menuMap[a.path][a.label].splice(t--,1)}Editor.Menu.remove(a.path,a)}),Object.keys(panelMap).forEach(a=>{const t=panelMap[a];if(t)for(let a=0;a<t.length;a++)t[a].source===e.name&&(t.splice(a,1),a--)}),Editor.Menu.apply()},apply(){if(0!==dirty.length){for(const e of dirty)exports.methods.updateMenu(e.path,e.label);dirty.length=0,Editor.Menu.apply()}},updatePanelMenu(e){const a=panelMap[e];a&&(a.forEach(e=>{dirty.push({path:e.path,label:e.label})}),exports.methods.apply())},updateMenu(e,a){const t=(menuMap[e]||{})[a]||[];let o=!0;for(const a of t){panel.getFocusPanel();if(checkWhen(a.when)){for(const e of a.shortcuts){if(e.when){if(!Editor.Utils.Parse.checkWhen(e.when)){a.option.accelerator="";continue}a.option.accelerator="win32"===process.platform?e.win:e.mac;break}a.option.accelerator="win32"===process.platform?e.win:e.mac;break}Editor.Menu.add(e,a.option),o=!1;break}}o&&Editor.Menu.remove(e,{label:a})},engineModuleChanged(e){projectType=e.includes("3d")?"3d":"2d";for(let e in projectTypeMap){projectTypeMap[e].forEach(e=>{dirty.push({path:e.path,label:e.label})})}exports.methods.apply()},modeChanged(e,a){const t=modeMap[a];t&&t.forEach(e=>{dirty.push({path:e.path,label:e.label})});const o=modeMap[e];o&&o.forEach(e=>{dirty.push({path:e.path,label:e.label})}),exports.methods.apply()}},exports.load=load,exports.unload=unload;