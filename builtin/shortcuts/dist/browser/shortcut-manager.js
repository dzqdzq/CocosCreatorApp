"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.shortcutManager=void 0;const utils_1=require("../utils"),lodash=require("lodash"),debounceEmitChange=lodash.debounce(()=>{Editor.Message.broadcast("editor-shortcut:change")},300);class ShortcutManager{constructor(){this._packagesShortcutConfig={},this._userConfig={},this._shortcutMapCache={},this._shortcutListCache={},this._dirty=!1,this.emitChange=debounceEmitChange}get shortcutMap(){return this._dirty&&(this._shortcutMapCache=this.queryShortcutMap()),this._shortcutMapCache}get queryPackagesShortcutList(){return this._dirty&&(this._shortcutListCache=this.queryShortcutList(),this._dirty=!1),this._shortcutListCache}queryShortcutList(){let t=JSON.parse(JSON.stringify(this._packagesShortcutConfig));return Object.keys(this._userConfig).forEach(e=>{let s=t[e];const r=this._userConfig[e];Object.values(r).forEach(t=>{const r=this.getKeyFromItem(t,!0);this._packagesShortcutConfig[e][r]||(t.missing=!0),t.key=r,s[t.key]=t})}),t}queryShortcutMap(){const t={};return Object.keys(this.queryPackagesShortcutList).forEach(e=>{let s=this.queryPackagesShortcutList[e];Object.values(s).forEach(e=>{t[e.shortcut]=t[e.shortcut]||[],t[e.shortcut].push(e)})}),t}async init(){this._userConfig=await Editor.Profile.getConfig("shortcuts","userConfig","global")||{},(await Editor.Package.getPackages({enable:!0})).forEach(t=>this.register(t)),Editor.Package.on("enable",t=>this.register(t)),Editor.Package.on("disable",t=>this.unRegister(t))}register(t){if(t.invalid)return;const e=t.info.contributions?t.info.contributions.shortcuts:[];if(!Array.isArray(e)||0===e.length)return;const s={};for(const r of e){const e=utils_1.handleOptionsToShortcut(r);if(!e)continue;const i=this.getKeyFromItem(Object.assign(r,{shortcut:e}));s[i]={shortcut:e,when:r.when,message:r.message,pkgName:t.name,key:i}}this._packagesShortcutConfig[t.name]=s,this._dirty=!0,this.emitChange()}unRegister(t){delete this._packagesShortcutConfig[t.name],this._dirty=!0,this.emitChange()}async changeShortcut(t,e){if(!this._packagesShortcutConfig[t.pkgName]||"string"!=typeof e)return!1;const s=this.getKeyFromItem(t,!0);if(!this._packagesShortcutConfig[t.pkgName][s])return""===e&&(delete this._userConfig[t.pkgName][s],!0);this._userConfig[t.pkgName]||(this._userConfig[t.pkgName]={});const r=this.getKeyFromItem(t);delete this._userConfig[t.pkgName][r];const i=JSON.parse(JSON.stringify(t)),o=this.getKeyFromItem(Object.assign(i,{shortcut:e,rawShortcut:t.rawShortcut||this._packagesShortcutConfig[t.pkgName][s].shortcut,when:this._packagesShortcutConfig[t.pkgName][s].when}));return i.rawShortcut&&(this._userConfig[t.pkgName][o]=i,await Editor.Profile.setConfig("shortcuts","userConfig",this._userConfig,"global")),this._dirty=!0,this.emitChange(),!0}resetShortcut(t){const e=this.getKeyFromItem(t);if(!this._userConfig[t.pkgName]||!this._userConfig[t.pkgName][e])return t.rawShortcut||t.shortcut;const s=this._userConfig[t.pkgName][e];return delete this._userConfig[t.pkgName][e],this._dirty=!0,this.emitChange(),s.rawShortcut||this._packagesShortcutConfig[t.pkgName][this.getKeyFromItem(t,!0)].shortcut}getKeyFromItem(t,e=!1){const s=e&&t.rawShortcut||t.shortcut||"(empty)";return t.message+(t.when||"")+s}}exports.shortcutManager=new ShortcutManager;