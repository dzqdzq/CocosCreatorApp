"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=void 0;const electron_1=require("electron"),panel=require("@editor/panel"),utils_1=require("./utils"),flags={panel:panel.getFocusPanel().current};let shortcutMap={};function keyDownHandle(e){const t=utils_1.handleEventKey(e);if(!t)return;const n=e.path[0];switch(t){case"ctrl+z":case"cmd+z":if("INPUT"===n.tagName||"TEXTAREA"===n.tagName){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.undo())}break;case"shift+ctrl+z":case"shift+cmd+z":if("INPUT"===n.tagName||"TEXTAREA"===n.tagName){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.redo())}break;case"ctrl+x":case"cmd+x":if((window.getSelection()||"").toString()){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.cut())}break;case"ctrl+c":case"cmd+c":if((window.getSelection()||"").toString()){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.copy())}break;case"ctrl+v":case"cmd+v":if("INPUT"===n.tagName||"TEXTAREA"===n.tagName){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.paste())}break;case"ctrl+a":case"cmd+a":if("INPUT"===n.tagName||"TEXTAREA"===n.tagName){e.preventDefault();const t=electron_1.remote.BrowserWindow.getFocusedWindow();return void(t&&t.webContents.selectAll())}}if("INPUT"===n.tagName||"TEXTAREA"===n.tagName)return;const o=shortcutMap[t];if(Array.isArray(o)&&0!==o.length)for(let t of o){const n=Editor.Utils.Parse.checkWhen(t.when);if(t.when){if(n){e.preventDefault(),Editor.Message.send(t.pkgName,t.message);continue}}else Editor.Message.send(t.pkgName,t.message),e.preventDefault()}}function onFocusPanel(e){flags.panel=e}function onBlurPanel(e){flags.panel===e&&(flags.panel="")}async function updateShortMap(){shortcutMap=await Editor.Message.request("shortcuts","query-shortcut-map")}async function load(){await updateShortMap(),Editor.Message.addBroadcastListener("editor-shortcut:change",updateShortMap),document.addEventListener("keydown",keyDownHandle),panel.on("focus",onFocusPanel),panel.on("blur",onBlurPanel)}function unload(){Editor.Message.removeBroadcastListener("editor-shortcut:change",updateShortMap),document.removeEventListener("keydown",keyDownHandle),panel.removeListener("focus",onFocusPanel),panel.removeListener("blur",onBlurPanel)}exports.load=load,exports.unload=unload;