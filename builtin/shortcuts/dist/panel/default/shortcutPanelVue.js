"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path_1=require("path"),fs_extra_1=require("fs-extra"),utils_1=require("../../utils"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.default=Vue.extend({props:{qwertyKeys:{type:Object,required:!0}},data(){return{map:{},shortcutList:{},active:"",msg:null,left:[],right:[],editInfo:null,checkEditInfoTimer:null,dirty:!0,editFlag:{hasHandle:!1}}},async mounted(){this.left=this.qwertyKeys.left,this.right=this.qwertyKeys.right,await this.updateShortcutMap(),this.active||(this.active=Object.keys(this.map)[0])},methods:{t(t){return Editor.I18n.t("shortcuts."+t)},scrollIntoView(t){t=t.currentTarget;t&&t.scrollIntoView({behavior:"smooth",block:"center"})},async updateShortcutMap(){var t=await Editor.Message.request("shortcuts","query-packages-shortcut-list");this.map=(0,utils_1.sortShortcutMap)(t)},onSelect(t,i){this.active=i,this.scrollIntoView(t),this.msg=null,this.editInfo=null},async handlerMissing(t){return!!t.missing&&(1===await this.checkShouldRemove()&&await this.removeCustomShortcut(t.key),!0)},async checkShouldRemove(){return(await Editor.Dialog.info(this.t("invalid_shortcut.message"),{title:this.t("invalid_shortcut.title"),buttons:[this.t("invalid_shortcut.cancel"),this.t("invalid_shortcut.remove")],default:1,cancel:0})).response},async changeShortcuts(){this.editFlag.hasHandle||(this.checkEditInfoTimer=setTimeout(()=>{this._changeShortcuts()},300))},async _changeShortcuts(){var t;this.checkEditShortcutChanged()?this.editInfo&&(!(t=this.map[this.active][this.editInfo.key])||this.editInfo.searches&&(this.editInfo.searches=[],this.editInfo.conflict)?this.editInfo=null:(await Editor.Message.request("shortcuts","change-shortcut",t,this.editInfo.shortcut)&&(t.rawShortcut=t.rawShortcut||t.shortcut,t.shortcut=this.editInfo.shortcut),this.editInfo=null,this.dirty=!0)):this.editInfo=null},checkEditShortcutChanged(){var t;return!!(this.editInfo&&this.editInfo.key&&this.editInfo.shortcut&&(t=this.editInfo.key,t=this.map[this.active][t])&&t.shortcut!==this.editInfo.shortcut)},async removeCustomShortcut(t){this.editFlag.hasHandle=!0;var i=this.map[this.active][t];await Editor.Message.request("shortcuts","remove-custom-shortcut",i)&&(await this.updateShortcutMap(),this.msg=this.map[this.active][t],this.editInfo=null,this.dirty=!0),this.editFlag.hasHandle=!1},async checkApplyShortcut(){this.checkEditShortcutChanged()&&(await Editor.Dialog.info(this.t("tips.is_apply"),{buttons:["cancel","save"],default:0})).response&&await this.changeShortcuts()},async onItemClick(t,i){this.msg=this.map[this.active][i],this.scrollIntoView(t),this.editInfo&&this.editInfo.key!==i&&await this.checkApplyShortcut()},async updateShortcutList(){this.dirty&&(this.shortcutList=await Editor.Message.request("shortcuts","query-shortcut-map"),this.dirty=!1)},async startEditShortcuts(t,i){this.checkEditInfoTimer&&clearTimeout(this.checkEditInfoTimer),await this._changeShortcuts(),await this.handlerMissing(i)||((t=t.currentTarget)&&t.focus(),this.editInfo={key:i.key,shortcut:"",searches:[],conflict:!1,when:i.when,showSearches:!1})},async onEditKeyDown(t){this.checkEditInfoTimer&&clearTimeout(this.checkEditInfoTimer),t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),this.editInfo&&(this.editFlag.hasHandle=!1,this.editInfo.shortcut=(0,utils_1.handleEventKey)(t),await this.updateShortcutList(),t=this.shortcutList[this.editInfo.shortcut]||[],this.editInfo.searches=t.filter(t=>this.editInfo&&t.key!==this.editInfo.key),this.editInfo.conflict=this.editInfo.searches.some(t=>this.editInfo&&t.when===this.editInfo.when))},async jumpToItem(t){this.checkEditInfoTimer&&clearTimeout(this.checkEditInfoTimer),await this._changeShortcuts(),this.editFlag.hasHandle=!0,this.active=t.pkgName,this.map[this.active][t.key]&&(this.msg=this.map[this.active][t.key])},getEditInfoState(){return this.editInfo&&this.editInfo.searches&&this.editInfo.searches.length?this.editInfo.conflict?"error":"warn":""},async clearShortcuts(t){var i=this.map[this.active][t];await this.handlerMissing(i)||(this.editFlag.hasHandle=!0,await Editor.Message.request("shortcuts","change-shortcut",i,"")&&(await this.updateShortcutMap(),this.msg=this.map[this.active][t],this.editInfo=null,this.dirty=!0),this.editFlag.hasHandle=!1)},async resetShortcuts(t){this.checkEditInfoTimer&&clearTimeout(this.checkEditInfoTimer),this.editFlag.hasHandle=!0;var t=this.map[this.active][t],i=await Editor.Message.request("shortcuts","reset-shortcut",t);t.shortcut=i||t.rawShortcut,this.dirty=!0,this.editInfo=null,this.msg=t,this.editFlag.hasHandle=!1}},template:(0,fs_extra_1.readFileSync)((0,path_1.join)(__dirname,"../../../static","./default/index.html"),"utf8")});