"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const path_1=require("path");class PluginManager{constructor(){this.configs={},this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>register(e))),Editor.Package.__protected__.on("enable",register),Editor.Package.__protected__.on("disable",unRegister)}async handleExportConfigs(){const e={};for(const o in this.configs){const t=this.configs[o].properties||{},i=this.configs[o].laboratory||[];if(!this.configs[o].properties&&!this.configs[o].laboratory)continue;const r={__version__:this.configs[o].version};for(const e in t){const t=await Editor.Profile.getConfig(o,e,"local"),i=void 0!==t&&null!==t?"local":"global";r[e]={type:i,value:"local"===i?await Editor.Profile.getConfig(o,e,i):await Editor.Profile.getConfig(o,e)}}for(let e=0;e<i.length;e++)r[i[e].path]={value:await Editor.Profile.getConfig(o,i[e].path)};e[o]=r}return e}async handleImportConfigs(e){for(const o in e)if("object"==typeof e[o])if(e[o].__version__&&e[o].__version__===this.configs[o].version){for(const t in e[o])if(void 0!==e[o][t].value&&this.configs[o].properties&&this.configs[o].properties[t]||this.configs[o].laboratory&&this.configs[o].laboratory.find(e=>e.path===t)){const i=e[o][t].type?e[o][t].type:"global";await Editor.Profile.setConfig(o,t,e[o][t].value,i)}}else console.warn(`[${o}] Wrong version of the plugin`)}destroy(){Editor.Package.__protected__.removeListener("enable",register),Editor.Package.__protected__.removeListener("disable",unRegister)}}exports.pluginManager=new PluginManager;const register=async function(e){if(!e||e.invalid||!e.info||!e.info.contributions||!e.info.contributions.preferences||!e.info.contributions.profile)return!1;exports.pluginManager.hasRegisterPackages.add(e.name);try{const o=e.info.contributions.preferences,t=e.info.contributions.profile,i={title:e.info.title||e.name,properties:null,custom:o.custom?(0,path_1.join)(e.path,o.custom):"",laboratory:o.laboratory?o.laboratory.map(o=>t.editor&&t.editor[o]?{path:o,label:t.editor[o].label,description:t.editor[o].description}:(console.warn(`The data is not defined.\n  package: ${e.name}\n  key: ${o}`),null)):null,version:e.version};for(const r in o.properties)t.editor&&t.editor[r]?(i.properties=i.properties||{},i.properties[r]={label:t.editor[r].label,description:t.editor[r].description,render:o.properties[r]}):console.warn(`The data is not defined.\n  package: ${e.name}\n  key: ${r}`);exports.pluginManager.configs[e.name]=i,await Editor.Panel.has("preferences.settings")&&Editor.Message.broadcast("preferences:packages-changed")}catch(o){console.log(`${e.name}: register default preferences failed.`),console.error(o)}},unRegister=async function(e){if(!exports.pluginManager.hasRegisterPackages.has(e.name))return!1;exports.pluginManager.hasRegisterPackages.delete(e.name),delete exports.pluginManager.configs[e.name],await Editor.Panel.has("preferences.settings")&&Editor.Message.broadcast("preferences:packages-changed")};