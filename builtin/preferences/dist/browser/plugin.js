"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pluginManager=void 0;const lodash_1=require("lodash"),path_1=require("path");class PluginManager{constructor(){this.configs={},this.customHandlers={},this.hasRegisterPackages=new Set}async init(){const e=Editor.Package.getPackages({enable:!0});await Promise.all(e.map(e=>register(e))),Editor.Package.__protected__.on("enable",register),Editor.Package.__protected__.on("disable",unRegister)}async handleExportConfigs(){const e={};for(const o in this.configs){const t=this.configs[o].properties||{},r=this.configs[o].laboratory||[];if(!this.configs[o].properties&&!this.configs[o].laboratory)continue;const i={__version__:this.configs[o].version};for(const e in t){const t=await Editor.Profile.getConfig(o,e,"local"),r=void 0!==t&&null!==t?"local":"global";i.properties=i.properties||{},i.properties[e]={type:r,value:"local"===r?await Editor.Profile.getConfig(o,e,r):await Editor.Profile.getConfig(o,e)}}for(let e=0;e<r.length;e++)i.laboratory=i.laboratory||{},i.laboratory[r[e].path]={type:"global",value:await Editor.Profile.getConfig(o,r[e].path)};e[o]=i}for(const o in this.customHandlers){e[o]&&e[o].__version__||(e[o]={__version__:this.configs[o].version});const t=this.customHandlers[o];if(t.exportConfig)try{const r=await t.exportConfig.call(t)||{};Array.isArray(r)||"object"!=typeof r||(e[o]=Object.assign({},e[o],{custom:r}))}catch(e){console.debug(`[Export Preferences Configs] Handle custom export error in ${o}`,e)}}return e}async handleImportConfigs(e){for(const o in e)if("object"==typeof e[o])if(e[o].__version__){if(e[o].__version__===this.configs[o].version){const t=e[o].__version__,r=convertToProfileConfigs(e[o]);r.global&&await Editor.Profile.__protected__.migrateGlobal(o,t,r.global),r.local&&await Editor.Profile.__protected__.migrateLocal(o,t,r.local),syncMigrateConfigs(e[o],r)}if(e[o].properties){const t=e[o].properties;for(const e in t)if(void 0!==t[e].value&&this.configs[o].properties&&this.configs[o].properties[e]){const r=t[e].type?t[e].type:"global";await Editor.Profile.setConfig(o,e,t[e].value,r)}}if(e[o].laboratory){const t=e[o].laboratory;for(const e in t)void 0!==t[e].value&&this.configs[o].laboratory&&this.configs[o].laboratory.find(o=>o.path===e)&&await Editor.Profile.setConfig(o,e,t[e].value,"global")}if(e[o].custom){const t=e[o].custom,r=this.customHandlers[o];if("object"==typeof t&&r.importConfig)try{await r.importConfig.call(r,t)}catch(e){console.debug(`[Import Preferences Configs] Handle custom import error in ${o}`,e)}}}else console.warn(`[Import Preferences Configs] ${o} Plugin config without version`)}async handleQueryConfigs(e){const o={};for(const t in e)if("object"==typeof e[t]){if(!e[t].__version__){console.warn(`[${t}] Plugin config without version`);continue}const r=convertToProfileConfigs(e[t]);if(e[t].__version__===this.configs[t].version){const o=e[t].__version__;r.global&&await Editor.Profile.__protected__.migrateGlobal(t,o,r.global),r.local&&await Editor.Profile.__protected__.migrateLocal(t,o,r.local)}o[t]=(0,lodash_1.merge)(r.global,r.local)}return o}destroy(){Editor.Package.__protected__.removeListener("enable",register),Editor.Package.__protected__.removeListener("disable",unRegister)}}exports.pluginManager=new PluginManager;const register=async function(e){if(!e||e.invalid||!e.info||!e.info.contributions||!e.info.contributions.preferences||!e.info.contributions.profile)return!1;exports.pluginManager.hasRegisterPackages.add(e.name);try{const o=e.info.contributions.preferences,t=e.info.contributions.profile,r={title:e.info.title||e.name,properties:null,custom:o.custom?(0,path_1.join)(e.path,o.custom):"",laboratory:o.laboratory?o.laboratory.map(o=>t.editor&&t.editor[o]?{path:o,label:t.editor[o].label,description:t.editor[o].description}:(console.warn(`The data is not defined.\n  package: ${e.name}\n  key: ${o}`),null)):null,version:e.version};if(o.properties)for(const i in o.properties)t.editor&&t.editor[i]?(r.properties=r.properties||{},r.properties[i]={label:t.editor[i].label,description:t.editor[i].description,render:o.properties[i]}):console.warn(`The data is not defined.\n  package: ${e.name}\n  key: ${i}`);if(o.custom)try{const t=Editor.Module.__protected__.requireFile((0,path_1.join)(e.path,o.custom));(t.exportConfig||t.importConfig)&&(exports.pluginManager.customHandlers[e.name]=t)}catch(o){console.log(`${e.name}: register custom preferences failed.`),console.error(o)}exports.pluginManager.configs[e.name]=r,await Editor.Panel.has("preferences.settings")&&Editor.Message.broadcast("preferences:packages-changed")}catch(o){console.log(`${e.name}: register default preferences failed.`),console.error(o)}},unRegister=async function(e){if(!exports.pluginManager.hasRegisterPackages.has(e.name))return!1;exports.pluginManager.hasRegisterPackages.delete(e.name),delete exports.pluginManager.configs[e.name],delete exports.pluginManager.customHandlers[e.name],await Editor.Panel.has("preferences.settings")&&Editor.Message.broadcast("preferences:packages-changed")},convertToProfileConfigs=function(e){const o={},t=["properties","laboratory","custom"];for(let o=0;o<t.length;o++){const i=t[o];if(e[i])for(const o in e[i])r(o,e[i][o])}function r(t,r){const i=t.split(".").reverse();let n={[i[0]]:r.value};for(let e=1;e<i.length;e++)n={[i[e]]:n};"global"===r.type?(o.global=o.global||{__version:e.__version__},o.global=(0,lodash_1.merge)(o.global,n)):"local"===r.type&&(o.local=o.local||{__version:e.__version__},o.local=(0,lodash_1.merge)(o.local,n))}return o},syncMigrateConfigs=function(e,o){const t=["properties","laboratory","custom"];for(let o=0;o<t.length;o++){const i=t[o];if(e[i])for(const o in e[i])r(o,i,e[i][o].type)}function r(t,r,i){const n=t.split(".");let s=o[i]||{},a=!0;for(let o=0;o<n.length;o++){if(void 0===s[n[o]]||null==s[n[o]]){delete e[r][t],a=!1;break}s=s[n[o]]}a&&s!==e[r][t].value&&(e[r][t].value=s)}};