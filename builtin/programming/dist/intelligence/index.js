"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateCommonTsConfig=exports.updateCustomMacro=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),db_module_url_1=require("../utils/db-module-url"),build_engine_1=require("@cocos/build-engine"),realTsConfigPath=path_1.default.join(Editor.Project.path,"tsconfig.json"),tempDirPath=path_1.default.join(Editor.Project.path,"temp"),configFilePath=path_1.default.join(tempDirPath,"tsconfig.cocos.json"),declarationHomePath=path_1.default.join(tempDirPath,"declarations");async function updateCustomMacroJS(){const t=path_1.default.join(tempDirPath,"programming/custom-macro.js");await fs_extra_1.default.outputFile(t,await generateCustomMacroJSFile(),{encoding:"utf8"})}async function updateCustomMacro(){const t=path_1.default.join(declarationHomePath,"cc.custom-macro.d.ts");await fs_extra_1.default.outputFile(t,await generateCustomMacroDeclarationFile(),{encoding:"utf8"}),await updateCustomMacroJS()}async function generateCommonTsConfig(){const t=[],e=function(){const t=[];return 0===t.length?void 0:t}(),a={};await Promise.all([async function(){const e=await Editor.Message.request("engine","query-info"),a=path_1.default.join(declarationHomePath,"cc.d.ts");await fs_extra_1.default.outputFile(a,generateEngineDeclarationFile(e.path),{encoding:"utf8"}),t.push(o(a))}(),async function(){const e=await Editor.Message.request("engine","query-info"),a=path_1.default.join(declarationHomePath,"cc.env.d.ts");await fs_extra_1.default.outputFile(a,await generateEnvDeclarationFile(e.path),{encoding:"utf8"}),t.push(o(a))}(),async function(){const e=path_1.default.join(declarationHomePath,"cc.custom-macro.d.ts");await fs_extra_1.default.outputFile(e,await generateCustomMacroDeclarationFile(),{encoding:"utf8"}),t.push(o(e))}(),async function(){const e=await Editor.Message.request("engine","query-info"),a=path_1.default.join(declarationHomePath,"jsb.d.ts");await fs_extra_1.default.outputFile(a,generateJsbDeclarationFile(e.path),{encoding:"utf8"}),t.push(o(a))}(),async function(){const t=await Editor.Message.request("asset-db","query-db-list");for(const e of t){const t=await Editor.Message.request("asset-db","query-db-info",e),n=(0,db_module_url_1.getDatabaseModuleRootURL)(e);a[`${n}*`]=[path_1.default.join(t.target,"*")]}}()]),await updateCustomMacroJS();const n={$schema:"https://json.schemastore.org/tsconfig",compilerOptions:{target:"ES2015",module:"ES2015",strict:!0,types:t,libs:e,paths:a,experimentalDecorators:!0,isolatedModules:!0,moduleResolution:"node",noEmit:!0,forceConsistentCasingInFileNames:!0}};function o(t){const e=path_1.default.relative(path_1.default.dirname(realTsConfigPath),t),a=(e.endsWith(".d.ts")?e.substr(0,e.length-5):e).replace(/\\/g,"/");return a.startsWith("./")||a.startsWith("../")?a:`./${a}`}await fs_extra_1.default.outputJson(configFilePath,n,{spaces:2})}function generateEngineDeclarationFile(t){return`\n    /// <reference path="${path_1.default.join(t,"bin/.declarations/cc.d.ts")}"/>\n    \n    /**\n     * @deprecated Global variable \`cc\` was dropped since 3.0. Use ES6 module syntax to import Cocos Creator APIs.\n     */\n    declare const cc: never;\n    `}function generateJsbDeclarationFile(t){return`/// <reference path="${path_1.default.join(t,"./@types/jsb.d.ts")}"/>\n`}async function generateEnvDeclarationFile(t){return(await build_engine_1.StatsQuery.create(t)).constantManager.genCCEnv()}async function generateCustomMacroDeclarationFile(){return`declare module "cc/userland/macro" {\n${(await Editor.Profile.getProject("engine","macroCustom")).map(t=>`\texport const ${t.key}: boolean;`).join("\n")}\n}\n`}async function generateCustomMacroJSFile(){return`System.register([], function (_export, _context) {      \n    return {\n        setters: [],\n        execute: function () {\n${(await Editor.Profile.getProject("engine","macroCustom")).map(t=>`_export("${t.key}", ${t.value});`).join("\n")}\n        }\n    };\n});\n`}exports.updateCustomMacro=updateCustomMacro,exports.generateCommonTsConfig=generateCommonTsConfig;