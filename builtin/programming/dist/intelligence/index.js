"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateCommonTsConfig=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),db_module_url_1=require("../utils/db-module-url");async function generateCommonTsConfig(){const e=path_1.default.join(Editor.Project.path,"tsconfig.json"),t=path_1.default.join(Editor.Project.path,"temp"),n=path_1.default.join(t,"tsconfig.cocos.json"),o=path_1.default.join(t,"declarations"),a=[],s=function(){const e=[];return 0===e.length?void 0:e}(),r={};await Promise.all([async function(){const e=await Editor.Message.request("engine","query-info"),t=path_1.default.join(o,"cc.d.ts");await fs_extra_1.default.outputFile(t,generateEngineDeclarationFile(e.path),{encoding:"utf8"}),a.push(c(t))}(),async function(){const e=path_1.default.join(o,"cc.env.d.ts");await fs_extra_1.default.outputFile(e,generateEnvDeclarationFile(),{encoding:"utf8"}),a.push(c(e))}(),async function(){const e=path_1.default.join(o,"jsb.d.ts");await fs_extra_1.default.outputFile(e,generateJsbDeclarationFile(),{encoding:"utf8"}),a.push(c(e))}(),async function(){const e=await Editor.Message.request("asset-db","query-db-list");for(const t of e){const e=await Editor.Message.request("asset-db","query-db-info",t),n=db_module_url_1.getDatabaseModuleRootURL(t);r[`${n}*`]=[path_1.default.join(e.target,"*")]}}()]);const i={$schema:"https://json.schemastore.org/tsconfig",compilerOptions:{target:"ES2015",module:"ES2015",strict:!0,types:a,libs:s,paths:r,experimentalDecorators:!0,isolatedModules:!0,moduleResolution:"node",noEmit:!0,forceConsistentCasingInFileNames:!0}};function c(t){const n=path_1.default.relative(path_1.default.dirname(e),t),o=(n.endsWith(".d.ts")?n.substr(0,n.length-5):n).replace(/\\/g,"/");return o.startsWith("./")||o.startsWith("../")?o:`./${o}`}await fs_extra_1.default.outputJson(n,i,{spaces:2})}function generateEngineDeclarationFile(e){return`\n    /// <reference path="${path_1.default.join(e,"bin/.declarations/cc.d.ts")}"/>\n    \n    /**\n     * @deprecated Global variable \`cc\` was dropped since 3.0. Use ES6 module syntax to import Cocos Creator APIs.\n     */\n    declare const cc: never;\n    `}function generateJsbDeclarationFile(){return`/// <reference path="${path_1.default.join(Editor.App.path,"../resources/3d/engine/@types/jsb.d.ts")}"/>\n`}function generateEnvDeclarationFile(){const e=require("cc/mods-mgr").syncImport("cc/editor/exports/populate-internal-constants");return`declare module "cc/env" {\n${Object.entries(e).map(([e,t])=>`    export const ${e}: ${typeof t};\n`).join("\n")}\n}\n`}exports.generateCommonTsConfig=generateCommonTsConfig;