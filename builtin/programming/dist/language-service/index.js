"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LanguageServiceAdapter=exports.LanguageServiceHostAdapter=exports.ParseConfigFileHostAdapter=exports.VirtualIOAdapter=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),typescript_1=__importDefault(require("typescript")),cache_1=require("../shared/cache"),command_1=require("./command");class VirtualIOAdapter{constructor(){this._fileCache=cache_1.assetInfoCache}readFile(e){if(e===LanguageServiceHostAdapter.defaultLibFileName)return;const t=this.readCache(e);let i;if(null===t||void 0===t?void 0:t.content)i=t.content;else try{i=(0,fs_extra_1.readFileSync)(e,"utf8");const t=this._fileCache.get(e),a=(0,fs_extra_1.statSync)(e).mtimeMs;this.writeCache({filePath:e,uuid:null===t||void 0===t?void 0:t.uuid,content:i,version:a.toString()})}catch(e){console.debug(e)}return i}readCache(e){return this._fileCache.get(e)}removeCache(e){return this._fileCache.delete(e)}writeCache({uuid:e,content:t,version:i,filePath:a}){this._fileCache.set(a,{filePath:a,uuid:e,content:t,version:i})}fileExists(e){return(0,fs_extra_1.existsSync)(e)}getFileNames(){return Array.from(cache_1.assetInfoCache.keys())}}exports.VirtualIOAdapter=VirtualIOAdapter;class ParseConfigFileHostAdapter extends VirtualIOAdapter{constructor(e){super(),this._currentDirectory=e,this.useCaseSensitiveFileNames=!0}getCurrentDirectory(){return this._currentDirectory}readDirectory(e,t,i,a,r){return this.getFileNames()}onUnRecoverableConfigFileDiagnostic(...e){console.error(...e)}}exports.ParseConfigFileHostAdapter=ParseConfigFileHostAdapter;class LanguageServiceHostAdapter extends VirtualIOAdapter{constructor(e,t,i,a){super(),this._parseConfigFileHost=e,this._tsconfigPath=t,this._currentDirectory=i,this._compilerOptions=a}getCompilationSettings(){return this._compilerOptions}getScriptFileNames(){return this.getFileNames().slice()}getScriptVersion(e){var t,i;return null!==(i=null===(t=this.readCache(e))||void 0===t?void 0:t.version)&&void 0!==i?i:""}getScriptSnapshot(e){const t=this.readFile(e);return t&&typescript_1.default.ScriptSnapshot.fromString(t)||void 0}getCurrentDirectory(){return this._currentDirectory}getDefaultLibFileName(e){return LanguageServiceHostAdapter.defaultLibFileName}useCaseSensitiveFileNames(){return this._parseConfigFileHost.useCaseSensitiveFileNames}}exports.LanguageServiceHostAdapter=LanguageServiceHostAdapter,LanguageServiceHostAdapter.defaultLibFileName="__DEFAULT_LIB_FILE_NAME_IS_NEVER_EXIST.d.ts";class LanguageServiceAdapter{constructor(e,t,i,a,r){this._tsconfigPath=e,this._currentDirectory=t,this._beforeBuildDelegate=i,this._compilerOptions=a,this.dbURLInfos=r,this._awaitCommandQueue=[],this._executingCommandID="",this._changedFileSet=new Set,this._afterOutputTasks=[],this._parseConfigFileHost=new ParseConfigFileHostAdapter(t),this.host=new LanguageServiceHostAdapter(this._parseConfigFileHost,this._tsconfigPath,this._currentDirectory,this._compilerOptions),this.languageService=typescript_1.default.createLanguageService(this.host,void 0,typescript_1.default.LanguageServiceMode.Semantic),this._beforeBuildDelegate.add(async e=>{e.forEach(e=>e.oldFilePath&&e.newFilePath&&this.requestRenameFile(e.oldFilePath,e.newFilePath)),await this.finishCommand(e)})}isExecuting(e){return!(this._executingCommandID!==e&&!this._awaitCommandQueue.some(t=>t.command.id===e))}get isBusy(){return Boolean(this._executingCommandID)}async executeCommand(e){if(this.isExecuting(e.id))return;this._executingCommandID&&await new Promise((t,i)=>{this._awaitCommandQueue.push({command:e,resolveAwait:t})}),this._executingCommandID=e.id;const t=await e.execute(this);for(const e of t.values())this._changedFileSet.add(e);const i=this._awaitCommandQueue.shift();if(i)i.resolveAwait(void 0);else{await this.outPutFiles(this._changedFileSet),this._executingCommandID="",this._changedFileSet.clear();const e=this._awaitCommandQueue.shift();e&&e.resolveAwait(void 0)}}async requestRenameFile(e,t){if(e&&t&&e.endsWith(".ts")&&t.endsWith(".ts")||!(0,path_1.extname)(e)){if(e===t)return;void 0===this.autoUpdateFileImport&&(this.autoUpdateFileImport=await Editor.Profile.getConfig("programming","updateAutoUpdateImportConfig","global")),this.autoUpdateFileImport&&(console.debug("Starting rename..."),Editor.Metrics.trackTimeStart("programming:worker-rename"),await this.executeCommand(new command_1.RenameCommand(e,t)),Editor.Metrics.trackTimeEnd("programming:worker-rename",{output:!0}),console.debug("Finish rename."))}}applyChanges(e,t){for(let i=t.length-1;i>=0;i--){const{span:a,newText:r}=t[i];e=`${e.substring(0,a.start)}${r}${e.substring(this.textSpanEnd(a))}`}return e}async outPutFiles(e){const t=Array.from(e.values());for(await Promise.all(t.map(async e=>{try{const t=this.host.readCache(e);if(!(null===t||void 0===t?void 0:t.content))return void console.debug("There's nothing in the cache");await(0,fs_extra_1.writeFile)(e,null===t||void 0===t?void 0:t.content,{encoding:"utf8"}),await Editor.Message.send("asset-db","refresh-asset",e)}catch(t){console.debug(`Failed to update script ${e}`,t)}}));this._afterOutputTasks.length;){const e=this._afterOutputTasks.shift();e&&e()}this.clearCache()}clearCache(){cache_1.assetInfoCache.forEach(e=>e.content=void 0)}textSpanEnd(e){return e.start+e.length}async finishCommand(e){return new Promise((e,t)=>{this.isBusy?this._afterOutputTasks.push(e):e()})}}exports.LanguageServiceAdapter=LanguageServiceAdapter;