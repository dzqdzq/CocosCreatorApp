"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RenameCommand=exports.Command=exports.CommandType=void 0;const path_1=require("path"),asserts_1=require("../utils/asserts"),path_2=require("../utils/path");var CommandType;!function(t){t[t.rename=0]="rename"}(CommandType=exports.CommandType||(exports.CommandType={}));class Command{}exports.Command=Command;class RenameCommand extends Command{static _createDescription(t,e){return`Rename ${(0,path_2.resolveFileName)(t)} to ${(0,path_2.resolveFileName)(e)}.`}static _createID(t,e){return this._createDescription(t,e)}static create(t,e){return new RenameCommand(t,e)}constructor(t,e){super(),this.oldFilePath=t,this.newFilePath=e,this._executed=!1,this.oldFilePath=(0,path_2.resolveFileName)(t),this.oldFilePathWithOutExt=(0,path_2.removeTSExt)(this.oldFilePath),this.newFilePath=(0,path_2.resolveFileName)(e),this.newFilePathWithOutExt=(0,path_2.removeTSExt)(this.newFilePath),this.id=RenameCommand._createID(t,e),this.description=RenameCommand._createDescription(t,e),this.commandType=CommandType.rename}applyImportChanges(t,e,s,i){(0,asserts_1.asserts)(this._newFileDBInfo),(0,asserts_1.asserts)(this._newFileDBURL),(0,asserts_1.asserts)(this._oldFileDBInfo),(0,asserts_1.asserts)(this._newFileDBInfo);const a=(0,path_2.removeTSExt)(e),n=e===this.newFilePath,o=Editor.Utils.Path.contains(this._newFileDBInfo.target,e),h=n||!o;for(let n=i.length-1;n>=0;n--){const{span:r,newText:l}=i[n];let d=l;const m=(0,path_1.join)(e,"../",d);if(h)if(s.substring(r.start,r.start+5)!==path_2.dbURLRoot||o){let t;t=e===this.newFilePath?this.oldFilePathWithOutExt:a;const i=(0,path_2.resolveFileName)((0,path_1.join)(t,"../",s.substring(r.start,this.textSpanEnd(r))));if(i===this.oldFilePathWithOutExt)d=this._newFileDBURL;else if(Editor.Utils.Path.contains(this.oldFilePath+"/",i))d=i.replace(this.oldFilePath,this._newFileDBURL);else if(t===this.oldFilePathWithOutExt){const t=Editor.Utils.Path.relative(this._oldFileDBInfo.target,i);d=this._oldFileDBInfo.dbURL+(0,path_2.resolveFileName)(t)}}else if(!l.startsWith(path_2.dbURLRoot)&&t)for(let e=0;e<t.length;e++){const s=t[e];if(Editor.Utils.Path.contains(s.target,m)){const t=Editor.Utils.Path.relative(s.target,m);d=s.dbURL+(0,path_2.resolveFileName)(t);break}}s=`${s.substring(0,r.start)}${d}${s.substring(this.textSpanEnd(r))}`}return s}textSpanEnd(t){return t.start+t.length}async execute(t){for(let e=0;e<t.dbURLInfos.length;e++){const s=t.dbURLInfos[e];if(Editor.Utils.Path.contains(s.target,this.newFilePath)){this._newFileDBInfo=s;const t=Editor.Utils.Path.relative(s.target,this.newFilePath);this._newFileDBURL=s.dbURL+(0,path_2.removeTSExt)((0,path_2.resolveFileName)(t))}if(Editor.Utils.Path.contains(s.target,this.oldFilePath)){this._oldFileDBInfo=s;const t=Editor.Utils.Path.relative(s.target,this.oldFilePath);this._oldFileDBURL=s.dbURL+(0,path_2.removeTSExt)((0,path_2.resolveFileName)(t))}}const e=new Set;if(!this._executed){const s=t.languageService.getEditsForFileRename(this.oldFilePath,this.newFilePath,{},void 0);for(let i=0;i<s.length;i++){const a=s[i],n=t.host.readFile(a.fileName);if(!n)continue;const o=this.applyImportChanges(t.dbURLInfos,a.fileName,n,a.textChanges);e.add(a.fileName);const h=t.host.readCache(a.fileName);(0,asserts_1.asserts)(h),t.host.writeCache({uuid:h.uuid,filePath:a.fileName,content:o})}this._executed=!0}return e}}exports.RenameCommand=RenameCommand;