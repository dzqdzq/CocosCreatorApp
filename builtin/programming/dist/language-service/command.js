"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RenameCommand=exports.Command=exports.CommandType=void 0;const path_1=require("path"),asserts_1=require("../utils/asserts"),path_2=require("../utils/path");var CommandType;!function(e){e[e.rename=0]="rename"}(CommandType||(exports.CommandType=CommandType={}));class Command{}class RenameCommand extends(exports.Command=Command){oldFilePath;newFilePath;_newFileDBInfo;_oldFileDBInfo;_newFileDBURL;_oldFileDBURL;oldFilePathWithOutExt;newFilePathWithOutExt;static _createDescription(e,t){return`Rename ${(0,path_2.resolveFileName)(e)} to ${(0,path_2.resolveFileName)(t)}.`}static _createID(e,t){return this._createDescription(e,t)}_executed=!1;id;description;commandType;static create(e,t){return new RenameCommand(e,t)}constructor(e,t){super(),this.oldFilePath=e,this.newFilePath=t,this.oldFilePath=(0,path_2.resolveFileName)(e),this.oldFilePathWithOutExt=(0,path_2.removeTSExt)(this.oldFilePath),this.newFilePath=(0,path_2.resolveFileName)(t),this.newFilePathWithOutExt=(0,path_2.removeTSExt)(this.newFilePath),this.id=RenameCommand._createID(e,t),this.description=RenameCommand._createDescription(e,t),this.commandType=CommandType.rename}applyImportChanges(a,i,s,r){(0,asserts_1.asserts)(this._newFileDBInfo),(0,asserts_1.asserts)(this._newFileDBURL),(0,asserts_1.asserts)(this._oldFileDBInfo),(0,asserts_1.asserts)(this._newFileDBInfo);var l=(0,path_2.removeTSExt)(i),e=i===this.newFilePath,h=Editor.Utils.Path.contains(this._newFileDBInfo.target,i),n=e||!h;for(let e=r.length-1;0<=e;e--){var{span:o,newText:d}=r[e];let t=d;var m=(0,path_1.join)(i,"../",t);if(n)if(s.substring(o.start,o.start+5)!==path_2.dbURLRoot||h){let e;e=i===this.newFilePath?this.oldFilePathWithOutExt:l;var p=(0,path_2.resolveFileName)((0,path_1.join)(e,"../",s.substring(o.start,this.textSpanEnd(o))));p===this.oldFilePathWithOutExt?t=this._newFileDBURL:Editor.Utils.Path.contains(this.oldFilePath+"/",p)?t=p.replace(this.oldFilePath,this._newFileDBURL):e===this.oldFilePathWithOutExt&&(p=Editor.Utils.Path.relative(this._oldFileDBInfo.target,p),t=this._oldFileDBInfo.dbURL+(0,path_2.resolveFileName)(p))}else if(!d.startsWith(path_2.dbURLRoot)&&a)for(let e=0;e<a.length;e++){var F=a[e];if(Editor.Utils.Path.contains(F.target,m)){var _=Editor.Utils.Path.relative(F.target,m);t=F.dbURL+(0,path_2.resolveFileName)(_);break}}s=""+s.substring(0,o.start)+t+s.substring(this.textSpanEnd(o))}return s}textSpanEnd(e){return e.start+e.length}async execute(t){for(let e=0;e<t.dbURLInfos.length;e++){var a,i=t.dbURLInfos[e];Editor.Utils.Path.contains(i.target,this.newFilePath)&&(this._newFileDBInfo=i,a=Editor.Utils.Path.relative(i.target,this.newFilePath),this._newFileDBURL=i.dbURL+(0,path_2.removeTSExt)((0,path_2.resolveFileName)(a))),Editor.Utils.Path.contains(i.target,this.oldFilePath)&&(this._oldFileDBInfo=i,a=Editor.Utils.Path.relative(i.target,this.oldFilePath),this._oldFileDBURL=i.dbURL+(0,path_2.removeTSExt)((0,path_2.resolveFileName)(a)))}var s=new Set;if(!this._executed){var r=t.languageService.getEditsForFileRename(this.oldFilePath,this.newFilePath,{},void 0);for(let e=0;e<r.length;e++){var l,h=r[e],n=t.host.readFile(h.fileName);n&&(n=this.applyImportChanges(t.dbURLInfos,h.fileName,n,h.textChanges),s.add(h.fileName),l=t.host.readCache(h.fileName),(0,asserts_1.asserts)(l),t.host.writeCache({uuid:l.uuid,filePath:h.fileName,content:n}))}this._executed=!0}return s}}exports.RenameCommand=RenameCommand;