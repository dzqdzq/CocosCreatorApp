"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetChangeType=exports.AssetDbInterop=void 0;const asserts_1=require("../utils/asserts"),timers_1=require("timers"),url_1=require("url"),db_module_url_1=require("../utils/db-module-url"),cache_1=require("../shared/cache"),path_1=require("../utils/path"),intelligence_1=require("../intelligence");class AssetDbInterop{constructor(e){this._assetInfoCache=cache_1.assetInfoCache,this._blockScriptUUIDSet=cache_1.blockAssetUUIDSet,this._waitTimeoutMs=10,this._changeQueue=[],this._handler=e,this._assetChangeTimer=new AccumulatingTimer(this._waitTimeoutMs,()=>{this._onAssetChangeTimerArrived()}),Editor.Message.addBroadcastListener("asset-db:asset-change",async(...e)=>this._onAssetChange(AssetChangeType.modified,...e)),Editor.Message.addBroadcastListener("asset-db:asset-add",async(...e)=>this._onAssetChange(AssetChangeType.add,...e)),Editor.Message.addBroadcastListener("asset-db:asset-delete",async(...e)=>this._onAssetChange(AssetChangeType.remove,...e))}async fetch(e){return await this.fetchAssetDb({assetDbOptions:{type:"scripts",pattern:`db://${e}/**/*.ts`},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAll(){return await this.fetchAllTypescripts(),await this.fetchAssetDb({assetDbOptions:{type:"scripts"},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAllTypescripts(){const e=await this.fetchAssetDb({assetDbOptions:{importer:"typescript"},mapper:mapperForFileInfo});for(let t=0;t<e.length;t++){const s=e[t];cache_1.assetInfoCache.set(s.filePath,s)}}async onMountDatabase(e){const t=`db://${e}/**/*.ts`,s=await this.fetchAssetDb({assetDbOptions:{importer:"typescript",pattern:t},mapper:mapperForFileInfo});for(let e=0;e<s.length;e++){const t=s[e];cache_1.assetInfoCache.set(t.filePath,t)}}async onUnmountDatabase(e){const t=(await(0,intelligence_1.getInternalDbURLInfos)()).find(t=>e===(0,path_1.getDbName)(t.dbURL));(0,asserts_1.asserts)(t),cache_1.assetInfoCache.forEach(e=>{e.filePath.startsWith(t.dbURL)&&cache_1.assetInfoCache.delete(e.filePath)})}async queryAssetDomains(){const e=await Editor.Message.request("asset-db","query-db-list"),t=[];for(const s of e){const e=await Editor.Message.request("asset-db","query-db-info",s),a=(0,db_module_url_1.getDatabaseModuleRootURL)(s),i={root:new URL(a),physical:e.target};if(isPackageDomain(s)){const e=Editor.Package.getPackages({name:s}),t=e[e.length-1];i.jail=t.path}t.push(i)}return t}async fetchAssetDb(e){var t;const s=[],a=null!==(t=null===e||void 0===e?void 0:e.mapper)&&void 0!==t?t:(e,t)=>({assetInfo:e,meta:t}),i=await Editor.Message.request("asset-db","query-assets",(null===e||void 0===e?void 0:e.assetDbOptions)||{});return await Promise.all(i.map(async t=>{const i=t.uuid,r=await Editor.Message.request("asset-db","query-asset-meta",i);if(!(null===e||void 0===e?void 0:e.filter)||(null===e||void 0===e?void 0:e.filter(t,r))){const e=await a(t,r);s.push(e)}})),s}async _onAssetChange(e,t,s,a){const i={url:getURL(s,a),uuid:t,filePath:s.file,type:e,isPluginScript:isPluginScript(s,a)},r=mapperForFileInfo(s,a);if(e===AssetChangeType.modified&&!this._assetInfoCache.has(s.file))for(const e of this._assetInfoCache.values())if(e.uuid===t){this._assetInfoCache.delete(e.filePath),this._assetInfoCache.set(r.filePath,r),i.oldFilePath=e.filePath,i.newFilePath=r.filePath;break}if(e===AssetChangeType.add&&("typescript"===s.importer||s.isDirectory)){const e=this._changeQueue.findIndex(e=>e.type===AssetChangeType.remove&&e.uuid===t);-1!==e&&(i.type=AssetChangeType.modified,i.oldFilePath=(0,path_1.resolveFileName)(this._changeQueue[e].filePath),i.newFilePath=r.filePath,this._changeQueue.splice(e,1)),"typescript"===s.importer&&this._assetInfoCache.set(r.filePath,r)}e===AssetChangeType.remove&&this._assetInfoCache.delete(s.file),this._blockScriptUUIDSet.has(t)?this._blockScriptUUIDSet.delete(t):filterForAssetChange(s,a)&&(this._changeQueue.push(i),this._assetChangeTimer.refresh())}_onAssetChangeTimerArrived(){const e=this._changeQueue;this._changeQueue=[],this._handler(e)}}var AssetChangeType;exports.AssetDbInterop=AssetDbInterop,function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.modified=2]="modified"}(AssetChangeType=exports.AssetChangeType||(exports.AssetChangeType={}));class AccumulatingTimer{constructor(e,t){this._timeout=void 0,this._waitTimeoutMs=e,this._callback=t}refresh(){this._timeout?this._timeout.refresh():this._timeout=(0,timers_1.setTimeout)(async()=>{this._callback(),(0,asserts_1.asserts)(this._timeout),clearTimeout(this._timeout),this._timeout=void 0},this._waitTimeoutMs)}}function filterForAssetChange(e,t){return!!t&&("javascript"===e.importer||"typescript"===e.importer)}function mapperForAssetChange(e,t){return(0,asserts_1.asserts)(t),{type:AssetChangeType.add,url:getURL(e,t),uuid:e.uuid,isPluginScript:isPluginScript(e,t),filePath:e.file}}function mapperForFileInfo(e,t){return e.file=(0,path_1.resolveFileName)(e.file),{uuid:e.uuid,filePath:e.file}}function isPluginScript(e,t){return!!t.userData.isPlugin}function getURL(e,t){return(0,url_1.pathToFileURL)(e.file)}function isPackageDomain(e){return!["assets","internal"].includes(e)}