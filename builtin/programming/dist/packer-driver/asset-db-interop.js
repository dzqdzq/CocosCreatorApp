"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetChangeType=exports.AssetDbInterop=void 0;const asserts_1=require("../utils/asserts"),timers_1=require("timers"),url_1=require("url"),db_module_url_1=require("../utils/db-module-url"),cache_1=require("../shared/cache"),path_1=require("../utils/path");class AssetDbInterop{_assetInfoCache=cache_1.assetInfoCache;_blockScriptUUIDSet=cache_1.blockAssetUUIDSet;_assetChangeTimeOut;_hasInit=!1;broadcastListenerMap={};constructor(e){this._handler=e,this._assetChangeTimer=new AccumulatingTimer(this._waitTimeoutMs,()=>{this._onAssetChangeTimerArrived()})}async init(){this._hasInit||(this.broadcastListenerMap["asset-db:asset-change"]=async(...e)=>this._onAssetChange(AssetChangeType.modified,...e),this.broadcastListenerMap["asset-db:asset-add"]=async(...e)=>this._onAssetChange(AssetChangeType.add,...e),this.broadcastListenerMap["asset-db:asset-delete"]=async(...e)=>this._onAssetChange(AssetChangeType.remove,...e),Object.keys(this.broadcastListenerMap).forEach(e=>Editor.Message.__protected__.addBroadcastListener(e,this.broadcastListenerMap[e])),this._hasInit=!0)}async destroyed(){Object.keys(this.broadcastListenerMap).forEach(e=>Editor.Message.__protected__.removeBroadcastListener(e,this.broadcastListenerMap[e])),this.broadcastListenerMap={},this._hasInit=!1}async fetch(e){return this.fetchAssetDb({assetDbOptions:{ccType:"cc.Script",pattern:`db://${e}/**/*.ts`},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAll(){return await this.fetchAllTypescripts(),this.fetchAssetDb({assetDbOptions:{ccType:"cc.Script"},filter:filterForAssetChange,mapper:mapperForAssetChange})}async fetchAllTypescripts(){var t=await this.fetchAssetDb({assetDbOptions:{importer:"typescript"},mapper:mapperForAssetInfoCache});for(let e=0;e<t.length;e++){var s=t[e];cache_1.assetInfoCache.set(s.filePath,s)}}async onMountDatabase(e){var e=`db://${e.name}/**/*.ts`,t=await this.fetchAssetDb({assetDbOptions:{importer:"typescript",pattern:e},mapper:mapperForAssetInfoCache});for(let e=0;e<t.length;e++){var s=t[e];cache_1.assetInfoCache.set(s.filePath,s)}return t}async onUnmountDatabase(t){const s=[];return cache_1.assetInfoCache.forEach(e=>{Editor.Utils.Path.normalize(e.filePath).startsWith(t.target)&&(s.push(e),cache_1.assetInfoCache.delete(e.filePath))}),s}async queryAssetDomains(){var e=[];for(const s of await Editor.Message.request("asset-db","query-db-infos")){var t=(0,db_module_url_1.getDatabaseModuleRootURL)(s.name),t={root:new URL(t),physical:s.target};isPackageDomain(s.name)&&(t.jail=s.target),e.push(t)}return e}async fetchAssetDb(t){const s=[],a=t?.mapper??(e=>({assetInfo:e}));var e=await Editor.Message.request("asset-db","query-assets",t?.assetDbOptions,["meta","url","file","importer","type"]);return e&&e.length&&await Promise.all(e.map(async e=>{t?.filter&&!t?.filter(e)||(e=await a(e),s.push(e))})),s}_waitTimeoutMs=10;_handler;_assetChangeTimer;_changeQueue=[];async _onAssetChange(e,t,s,a){var i={url:getURL(s),uuid:t,filePath:s.file,type:e,isPluginScript:isPluginScript(a)},r=mapperForAssetInfoCache(s,a);if(e===AssetChangeType.modified&&!this._assetInfoCache.has(s.file))for(const n of this._assetInfoCache.values())if(n.uuid===t){this._assetInfoCache.delete(n.filePath),this._assetInfoCache.set(r.filePath,r),i.oldFilePath=n.filePath,i.newFilePath=r.filePath;break}e!==AssetChangeType.add||"typescript"!==s.importer&&!s.isDirectory||(-1!==(a=this._changeQueue.findIndex(e=>e.type===AssetChangeType.remove&&e.uuid===t))&&(i.type=AssetChangeType.modified,i.oldFilePath=(0,path_1.resolveFileName)(this._changeQueue[a].filePath),i.newFilePath=r.filePath,this._changeQueue.splice(a,1)),"typescript"!==s.importer)||this._assetInfoCache.set(r.filePath,r),e===AssetChangeType.remove&&this._assetInfoCache.delete(s.file),this._blockScriptUUIDSet.has(t)?this._blockScriptUUIDSet.delete(t):filterForAssetChange(s)&&(this._changeQueue.push(i),this._assetChangeTimer.refresh())}_onAssetChangeTimerArrived(){var e=this._changeQueue;this._changeQueue=[],this._handler(e)}}var AssetChangeType;exports.AssetDbInterop=AssetDbInterop,function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.modified=2]="modified"}(AssetChangeType||(exports.AssetChangeType=AssetChangeType={}));class AccumulatingTimer{constructor(e,t){this._waitTimeoutMs=e,this._callback=t}refresh(){this._timeout?this._timeout.refresh():this._timeout=(0,timers_1.setTimeout)(async()=>{this._callback(),(0,asserts_1.asserts)(this._timeout),clearTimeout(this._timeout),this._timeout=void 0},this._waitTimeoutMs)}_waitTimeoutMs;_timeout=void 0;_callback}function filterForAssetChange(e){return"javascript"===e.importer||"typescript"===e.importer}function mapperForAssetChange(e,t){return{type:AssetChangeType.add,uuid:e.uuid,filePath:e.file,url:getURL(e),isPluginScript:isPluginScript(t||e.meta)}}function mapperForAssetInfoCache(e,t){return e.file=(0,path_1.resolveFileName)(e.file),{uuid:e.uuid,filePath:e.file,url:getURL(e),isPluginScript:isPluginScript(t||e.meta)}}function isPluginScript(e){return!!e?.userData?.isPlugin}function getURL(e){return(0,url_1.pathToFileURL)(e.file)}function isPackageDomain(e){return!["assets","internal"].includes(e)}