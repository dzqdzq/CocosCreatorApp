"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetChangeType=exports.AssetDBInterop=void 0;const asserts_1=require("../utils/asserts"),timers_1=require("timers"),url_1=require("url"),db_module_url_1=require("../utils/db-module-url");class AssetDBInterop{constructor(e){this._waitTimeoutMs=10,this._changeQueue=[],this._handler=e,this._assetChangeTimer=new AccumulatingTimer(this._waitTimeoutMs,()=>{this._onAssetChangeTimerArrived()}),Editor.Message.addBroadcastListener("asset-db:asset-change",async(...e)=>this._onAssetChange(AssetChangeType.modified,...e)),Editor.Message.addBroadcastListener("asset-db:asset-add",async(...e)=>this._onAssetChange(AssetChangeType.add,...e)),Editor.Message.addBroadcastListener("asset-db:asset-delete",async(...e)=>this._onAssetChange(AssetChangeType.remove,...e))}async fetch(e){const s=[],t=await Editor.Message.request("asset-db","query-assets",{type:"scripts",pattern:`db://${e}/**/*.ts`});return await Promise.all(t.map(async e=>{const t=e.uuid,i=await Editor.Message.request("asset-db","query-asset-meta",t);i&&filterAsset(e,i)&&s.push({type:AssetChangeType.add,url:getURL(e,i),uuid:t,isPluginScript:isPluginScript(e,i)})})),s}async fetchAll(){const e=[],s=await Editor.Message.request("asset-db","query-assets",{type:"scripts"});return await Promise.all(s.map(async s=>{const t=s.uuid,i=await Editor.Message.request("asset-db","query-asset-meta",t);i&&filterAsset(s,i)&&e.push({type:AssetChangeType.add,url:getURL(s,i),uuid:t,isPluginScript:isPluginScript(s,i)})})),e}async queryAssetDomains(){const e=await Editor.Message.request("asset-db","query-db-list"),s=[];for(const t of e){const e=await Editor.Message.request("asset-db","query-db-info",t),i=(0,db_module_url_1.getDatabaseModuleRootURL)(t),a={root:new URL(i),physical:e.target};if(isPackageDomain(t)){const e=Editor.Package.getPackages({name:t});(0,asserts_1.asserts)(1===e.length,`Database ${t} is enabled but lack of package info.`);const s=e[0];a.jail=s.path}s.push(a)}return s}async _onAssetChange(e,s,t,i){i&&!filterAsset(t,i)||(this._changeQueue.push({url:getURL(t,i),uuid:s,type:e,isPluginScript:isPluginScript(t,i)}),this._assetChangeTimer.refresh())}_onAssetChangeTimerArrived(){const e=this._changeQueue;this._changeQueue=[],this._handler(e)}}var AssetChangeType;exports.AssetDBInterop=AssetDBInterop,function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.modified=2]="modified"}(AssetChangeType=exports.AssetChangeType||(exports.AssetChangeType={}));class AccumulatingTimer{constructor(e,s){this._timeout=void 0,this._waitTimeoutMs=e,this._callback=s}refresh(){this._timeout?this._timeout.refresh():this._timeout=(0,timers_1.setTimeout)(async()=>{this._callback(),(0,asserts_1.asserts)(this._timeout),clearTimeout(this._timeout),this._timeout=void 0},this._waitTimeoutMs)}}function filterAsset(e,s){return("javascript"===e.importer||"typescript"===e.importer)&&!e.source.endsWith(".d.ts")}function isPluginScript(e,s){return!!s.userData.isPlugin}function getURL(e,s){return(0,url_1.pathToFileURL)(e.file)}function isPackageDomain(e){return!["assets","internal"].includes(e)}