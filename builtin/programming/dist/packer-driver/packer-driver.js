"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackerDriver=void 0;const mod_lo_1=require("@editor/lib-programming/dist/mod-assembling/mod-lo/mod-lo"),quick_pack_1=require("@editor/lib-programming/dist/mod-assembling/quick-pack/quick-pack"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),url_1=require("url"),perf_hooks_1=require("perf_hooks"),prerequisite_imports_1=require("./prerequisite-imports"),babel_preset_cc_1=__importDefault(require("@cocos/babel-preset-cc")),utils_1=require("@editor/lib-programming/dist/utils"),uuidUtils=__importStar(require("../../../asset-db/static/utils/uuid-utils")),stats_query_1=require("@cocos/build-engine/dist/stats-query"),winston_1=__importDefault(require("winston")),asserts_1=require("../utils/asserts"),db_module_url_1=require("../utils/db-module-url"),VERSION="8",featureUnitModulePrefix="cce:/internal/x/cc-fu/";class PackerDriver{constructor(e,t,s){this._waitTimeoutMs=10,this._targets={},this._timeAccumulatedAssetChanges=[],this._buildAccumulatedAssetChanges=[],this._featureChanged=!1,this._beforeBuildTasks=[],this._targets=e,this._statsQuery=t,this._logger=s,this._assetChangeTimer=new AccumulatingTimer(this._waitTimeoutMs,()=>{this._onAssetChangeTimerArrived()}),this._asyncIteration=new AsyncIterationConcurrency1(async()=>await this._startBuildIteration()),Editor.Message.addBroadcastListener("asset-db:asset-change",async(...e)=>this._onAssetChange(AssetChangeType.modified,...e)),Editor.Message.addBroadcastListener("asset-db:asset-add",async(...e)=>this._onAssetChange(AssetChangeType.add,...e)),Editor.Message.addBroadcastListener("asset-db:asset-delete",async(...e)=>this._onAssetChange(AssetChangeType.remove,...e)),Editor.Message.addBroadcastListener("engine:modules-changed",async()=>this._onEngineFeaturesChanged())}static async create(){var e;const t=path_1.default.join(Editor.Project.tmpDir,"programming","packer-driver"),s=path_1.default.join(t,"VERSION"),i=path_1.default.join(t,"targets"),r=path_1.default.join(t,"logs","debug.log"),a={};if(await fs_extra_1.default.pathExists(r))try{await fs_extra_1.default.unlink(r)}catch(e){console.warn(`Failed to reset log file: ${r}`)}const o=createLogger(r);o.debug((new Date).toUTCString()),o.debug(`Project: ${Editor.Project.path}`),o.debug(`Targets: ${Object.keys(predefinedTargets)}`);const n=await PackerDriver._createIncrementalRecord();await PackerDriver._validateIncrementalRecord(n,s,i,o);const u={"cce:/internal/code-quality/":url_1.pathToFileURL(path_1.default.join(__dirname,"..","..","static","builtin-mods","code-quality","/")).href},c=await Editor.Message.request("engine","query-info",Editor.Project.type),{path:d}=c;o.debug(`Engine path: ${d}`);const l=await stats_query_1.StatsQuery.create(d),_=l.evaluateIndexModuleSource([]),g={moduleRequestFilter:[/^cc\.?.*$/g],reporter:{moduleName:"cce:/internal/code-quality/cr.mjs",functionName:"report"}};for(const[t,s]of Object.entries(predefinedTargets)){o.debug(`Initializing target [${s.name}]`);const r=["cc/env"];r.push(...l.getFeatureUnits().map(e=>`${featureUnitModulePrefix}${e}`));const c={},d=new mod_lo_1.ModLo({targets:s.browsersListTargets,loose:n.config.loose,guessCommonJsExports:n.config.guessCommonJsExports,_cc:[babel_preset_cc_1.default,{useDefineForClassFields:n.config.useDefineForClassFields,allowDeclareFields:n.config.allowDeclareFields}],cr:g,_compressUUID:uuidUtils.compressUuid,importMap:c,loadMappings:u,externals:r,logger:o}),h=path_1.default.join(i,t),p=Editor.Project.path,m=new quick_pack_1.QuickPack({modLo:d,origin:p,workspace:h,logger:o,verbose:!0});o.debug("Loading cache");const f=perf_hooks_1.performance.now();await m.loadCache();const y=perf_hooks_1.performance.now();let b;if(o.debug(`Loading cache costs ${y-f}ms.`),s.isEditor){const e=await PackerDriver._getEngineFeaturesShippedInEditor(l);o.debug(`Engine features shipped in editor: ${e}`),b={source:PackerDriver._getEngineIndexModuleSource(l,e),respectToFeatureSetting:!1}}else b={source:_,respectToFeatureSetting:!0};const M=await m.createLoaderContext();a[t]=new PackTarget({name:t,modLo:d,sourceMaps:s.sourceMaps,quickPack:m,quickPackLoaderContext:M,logger:o,engineIndexModule:b,tentativePrerequisiteImportsMod:null!==(e=s.isEditor)&&void 0!==e&&e})}const h=new PackerDriver(a,l,o);return await h._syncEngineFeatures(),h}async resetDatabases(e=!0){const t=await Editor.Message.request("asset-db","query-db-list"),s=[];for(const e of t){const t=await Editor.Message.request("asset-db","query-db-info",e),i=db_module_url_1.getDatabaseModuleRootURL(e),r={root:new url_1.URL(i),physical:t.target};if(isPackageDomain(e)){const t=Editor.Package.getPackages({name:e});asserts_1.asserts(1===t.length);const s=t[0];r.jail=s.path}s.push(r)}const i=()=>{for(const e of Object.values(this._targets))e.setAssetDatabaseDomains(s)};e?this._triggerNextBuild(i):i()}async pullAssetDb(){const e=this._logger;e.debug("Pulling asset-db.");const t=perf_hooks_1.performance.now();await this._fetchAllAssets();const s=perf_hooks_1.performance.now();e.debug(`Fetch asset-db cost: ${s-t}ms.`),this._dispatchBuildRequest()}getQuickPackLoaderContext(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].quickPackLoaderContext}isReady(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].ready}async shutDown(){}_warnMissingTarget(e){e in this._targets||console.warn(`Invalid pack target: ${e}. Existing targets are: ${Object.keys(this._targets)}`)}async _onAssetChange(e,t,s,i){i&&!PackerDriver._filterAsset(s,i)||(this._timeAccumulatedAssetChanges.push({uuid:t,type:e,assetInfo:s,meta:i}),this._assetChangeTimer.refresh())}_onAssetChangeTimerArrived(){this._logger.debug(`Dispatch build request for time accumulated ${this._timeAccumulatedAssetChanges.length} asset changes.`),this._buildAccumulatedAssetChanges.push(...this._timeAccumulatedAssetChanges),this._timeAccumulatedAssetChanges.length=0,this._dispatchBuildRequest()}async _onEngineFeaturesChanged(){this._featureChanged=!0,this._dispatchBuildRequest()}async _startBuildIteration(){this._logger.debug("Build iteration starts.\n"+`Number of accumulated asset changes: ${this._buildAccumulatedAssetChanges.length}\n`+`Feature changed: ${this._featureChanged}`),this._featureChanged&&(this._featureChanged=!1,await this._syncEngineFeatures());const e=this._buildAccumulatedAssetChanges;this._buildAccumulatedAssetChanges=[];const t=this._beforeBuildTasks.slice();this._beforeBuildTasks.length=0;for(const e of t)e();for(const[,t]of Object.entries(this._targets))0!==e.length&&t.applyAssetChanges(e),await t.build();Editor.Message.send("preview","reload-terminal")}_dispatchBuildRequest(){this._asyncIteration.nextIteration()}static async _createIncrementalRecord(){const[e,t,s,i]=await Promise.all([Editor.Profile.getProject("project","script.useDefineForClassFields"),Editor.Profile.getProject("project","script.allowDeclareFields"),Editor.Profile.getProject("project","script.loose"),!1]);return{version:VERSION,config:{useDefineForClassFields:null===e||void 0===e||e,allowDeclareFields:null===t||void 0===t||t,loose:null!==s&&void 0!==s&&s,guessCommonJsExports:null!==i&&void 0!==i&&i}}}static async _validateIncrementalRecord(e,t,s,i){let r=!1;try{const s=await fs_extra_1.default.readJson(t);(r=matchObject(e,s))?i.debug("Incremental file seems great."):i.debug("[PackerDriver] Options doesn't match.\n"+`Last: ${JSON.stringify(e,void 0,2)}\n`+`Current: ${JSON.stringify(s,void 0,2)}`)}catch(e){i.debug(`Packer deriver version file lost or format incorrect: ${e}`)}return r||(i.debug("Clearing out the targets..."),await fs_extra_1.default.emptyDir(s),await fs_extra_1.default.outputJson(t,e,{spaces:2})),r}async _fetchAllAssets(){const e=await Editor.Message.request("asset-db","query-assets",{type:"scripts"});await Promise.all(e.map(async e=>{const t=e.uuid,s=await Editor.Message.request("asset-db","query-asset-meta",t);s&&PackerDriver._filterAsset(e,s)&&this._buildAccumulatedAssetChanges.push({uuid:t,type:AssetChangeType.add,assetInfo:e,meta:s})}))}static async _getEngineFeaturesShippedInEditor(e){return e.getFeatures().filter(e=>!["physics-ammo","physics-builtin","physics-cannon","physics-physx","physics-2d-box2d","physics-2d-builtin","wait-for-ammo-instantiation"].includes(e))}async _syncEngineFeatures(){const e=await Editor.Profile.getProject("engine","modules.includeModules")||[];this._logger.debug(`Sync engine features: ${e}`);const t=PackerDriver._getEngineIndexModuleSource(this._statsQuery,e);for(const[,e]of Object.entries(this._targets))e.respectToEngineFeatureSetting&&e.setEngineIndexModuleSource(t)}static _getEngineIndexModuleSource(e,t){const s=e.getUnitsOfFeatures(t);return e.evaluateIndexModuleSource(s,e=>`${featureUnitModulePrefix}${e}`)}static _filterAsset(e,t){return("javascript"===e.importer||"typescript"===e.importer)&&(!t.userData.importAsPlugin&&!t.userData.isPlugin&&!e.source.endsWith(".d.ts"))}async _triggerNextBuild(e){this._beforeBuildTasks.push(e),this._dispatchBuildRequest()}}exports.PackerDriver=PackerDriver;const engineIndexModURL="cce:/internal/x/cc",predefinedTargets={editor:{name:"Editor",browsersListTargets:utils_1.editorBrowserslistQuery,sourceMaps:"inline",isEditor:!0},preview:{name:"Preview",sourceMaps:!0}};class PackTarget{constructor(e){this._buildStarted=!1,this._ready=!1,this._prerequisiteAssetMods=new Set,this._uuidURLMap=new Map,this._firstBuild=!0,this._name=e.name,this._modLo=e.modLo,this._quickPack=e.quickPack,this._quickPackLoaderContext=e.quickPackLoaderContext,this._sourceMaps=e.sourceMaps,this._logger=e.logger,this._respectToFeatureSetting=e.engineIndexModule.respectToFeatureSetting,this._tentativePrerequisiteImportsMod=e.tentativePrerequisiteImportsMod;const t=this._modLo;this._entryMod=t.addMemoryModule(prerequisite_imports_1.prerequisiteImportsModURL,(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)([])),this._engineIndexMod=t.addMemoryModule(engineIndexModURL,e.engineIndexModule.source),this.setAssetDatabaseDomains([])}get quickPackLoaderContext(){return this._quickPackLoaderContext}get ready(){return this._ready}get respectToEngineFeatureSetting(){return this._respectToFeatureSetting}async build(){asserts_1.asserts(!this._buildStarted),this._buildStarted=!0;const e=this._name;Editor.Message.broadcast("programming:pack-build-start",e),this._logger.debug(`Target(${e}) build started.`);const t=perf_hooks_1.performance.now();try{await this._quickPack.build([engineIndexModURL,prerequisite_imports_1.prerequisiteImportsModURL],{forceAll:this._firstBuild,retryResolutionOnUnchangedModule:this._firstBuild}),this._firstBuild=!1}catch(e){this._logger.error(e)}const s=perf_hooks_1.performance.now();this._logger.debug(`Target(${e}) ends with cost ${s-t}ms.`),this._ready=!0,Editor.Message.broadcast("programming:pack-build-end",e),this._buildStarted=!1}applyAssetChanges(e){asserts_1.asserts(!this._buildStarted);for(const t of e){const e=t.uuid;if(t.type===AssetChangeType.modified||t.type===AssetChangeType.remove){const t=this._uuidURLMap.get(e);if(t){this._uuidURLMap.delete(e),this._modLo.unsetUUID(t),this._prerequisiteAssetMods.delete(t)||this._logger.warn(`Unexpected: ${t} is not in registry.`)}else this._logger.warn(`Unexpected: ${e} is not in registry.`)}if(t.type===AssetChangeType.modified||t.type===AssetChangeType.add){const s=PackTarget._getURL(t.assetInfo,t.meta);this._uuidURLMap.set(e,s),this._modLo.setUUID(s,e),this._prerequisiteAssetMods.add(s)}}const t=Array.from(this._prerequisiteAssetMods).sort();this._entryMod.source=(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)(t)}setEngineIndexModuleSource(e){asserts_1.asserts(!this._buildStarted),this._engineIndexMod.source=e}setAssetDatabaseDomains(e){asserts_1.asserts(!this._buildStarted);const t={imports:{}};t.imports.cc=engineIndexModURL;const s=[];for(const i of e){const e=url_1.pathToFileURL(path_1.default.join(i.physical,path_1.default.join(path_1.default.sep))).href;t.imports[i.root.href]=e,s.push(e)}this._modLo.setImportMap(t),this._modLo.setAssetPrefixes(s)}static _getURL(e,t){return url_1.pathToFileURL(e.file).href}}var AssetChangeType;function createLogger(e){const t=winston_1.default.createLogger({transports:[new winston_1.default.transports.File({level:"debug",filename:e,format:winston_1.default.format.simple()})]});return{debug(e){return t.debug(e),this},info(e){return t.info(e),console.info(e),this},warn(e){return t.warn(e),console.warn(e),this},error(e){return t.error(e),console.error(e),this}}}!function(e){e[e.add=0]="add",e[e.remove=1]="remove",e[e.modified=2]="modified"}(AssetChangeType||(AssetChangeType={}));class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}class AccumulatingTimer{constructor(e,t){this._timeout=void 0,this._waitTimeoutMs=e,this._callback=t}refresh(){this._timeout?this._timeout.refresh():this._timeout=setTimeout(async()=>{this._callback(),asserts_1.asserts(this._timeout),clearTimeout(this._timeout),this._timeout=void 0},this._waitTimeoutMs)}}function matchObject(e,t){return function e(t,s){return Array.isArray(t)?Array.isArray(s)&&t.length===s.length&&t.every((t,i)=>e(t,s[i])):"object"==typeof t&&null!==t?"object"==typeof s&&null!==s&&Object.keys(t).every(i=>e(t[i],s[i])):null===t?null===s:t===s}(e,t)}function isPackageDomain(e){return!["assets","internal"].includes(e)}