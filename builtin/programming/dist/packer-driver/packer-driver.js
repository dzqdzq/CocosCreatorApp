"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackerDriver=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),url_1=require("url"),perf_hooks_1=require("perf_hooks"),prerequisite_imports_1=require("./prerequisite-imports"),utils_1=require("@editor/lib-programming/dist/utils"),ccbuild_1=require("@cocos/ccbuild"),asserts_1=require("../utils/asserts"),query_shared_settings_1=require("../shared/query-shared-settings"),quick_pack_1=require("@cocos/creator-programming-quick-pack/lib/quick-pack"),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),asset_db_interop_1=require("./asset-db-interop"),logger_1=require("./logger"),language_service_1=require("../language-service"),intelligence_1=require("../intelligence"),delegate_1=require("../utils/delegate"),json5_1=__importDefault(require("json5")),minimatch_1=__importDefault(require("minimatch")),VERSION="19",featureUnitModulePrefix="cce:/internal/x/cc-fu/",useEditorFolderFeature=!1;function matchPattern(e,t){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),t.replace(/\\/g,"/"))}async function getEditorPatterns(){const e=await Editor.Message.request("asset-db","query-db-list"),t=[];for(const s of e){const e=await Editor.Message.request("asset-db","query-db-info",s),r=path_1.default.join(e.target,"**","editor","**/*");t.push(r)}return t}function getCCEModuleIDs(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}class PackerDriver{constructor(e,t,s,r,i){this.beforeEditorBuildDelegate=new delegate_1.AsyncDelegate,this._clearing=!1,this._targets={},this._assetChangeQueue=[],this._featureChanged=!1,this._beforeBuildTasks=[],this._broadcastListenerMap={},this._depsGraph={},this._targets=e,this._statsQuery=t,this._logger=s,this.languageService=new language_service_1.LanguageServiceAdapter(intelligence_1.realTsConfigPath,Editor.Project.path,this.beforeEditorBuildDelegate,r,i),this._assetDbInterop=new asset_db_interop_1.AssetDbInterop(this._onSomeAssetChangesWereMade.bind(this)),this._asyncIteration=new AsyncIterationConcurrency1(async()=>await this._startBuildIteration())}static async create(){var e;PackerDriver._cceModuleMap=PackerDriver.queryCCEModuleMap();const t=path_1.default.join(Editor.Project.tmpDir,"programming","packer-driver"),s=path_1.default.join(t,"VERSION"),r=path_1.default.join(t,"targets"),i=path_1.default.join(t,"logs","debug.log"),a={};if(await fs_extra_1.default.pathExists(i))try{await fs_extra_1.default.unlink(i)}catch(e){console.warn(`Failed to reset log file: ${i}`)}const o=new logger_1.PackerDriverLogger(i);o.debug((new Date).toUTCString()),o.debug(`Project: ${Editor.Project.path}`),o.debug(`Targets: ${Object.keys(predefinedTargets)}`);const n=await PackerDriver._createIncrementalRecord(o);await PackerDriver._validateIncrementalRecord(n,s,r,o);const c={"cce:/internal/code-quality/":(0,url_1.pathToFileURL)(path_1.default.join(__dirname,"..","..","static","builtin-mods","code-quality","/")).href},u=await Editor.Message.request("engine","query-engine-info",Editor.Project.__protected__.type),{path:d}=u.typescript;o.debug(`Engine path: ${d}`);const l=await ccbuild_1.StatsQuery.create(d),_=l.evaluateIndexModuleSource([]),g={moduleRequestFilter:[/^cc\.?.*$/g],reporter:{moduleName:"cce:/internal/code-quality/cr.mjs",functionName:"report"}};for(const[t,s]of Object.entries(predefinedTargets)){o.debug(`Initializing target [${s.name}]`);const i=["cc/env","cc/userland/macro",...getCCEModuleIDs(PackerDriver._cceModuleMap)];i.push(...l.getFeatureUnits().map(e=>`${featureUnitModulePrefix}${e}`));let u=s.browsersListTargets;"preview"===t&&n.config.previewTarget&&(u=n.config.previewTarget,o.debug(`Use specified preview browserslist target: ${u}`));const d=new mod_lo_1.ModLo({targets:u,loose:n.config.loose,guessCommonJsExports:n.config.guessCommonJsExports,useDefineForClassFields:n.config.useDefineForClassFields,allowDeclareFields:n.config.allowDeclareFields,cr:g,_compressUUID:e=>Editor.Utils.UUID.compressUUID(e,!1),logger:o,checkObsolete:!0,importRestrictions:PackerDriver._importRestrictions});d.setExtraExportsConditions(n.config.exportsConditions),d.setExternals(i),d.setLoadMappings(c);const h=path_1.default.join(r,t),p=Editor.Project.path,m=new quick_pack_1.QuickPack({modLo:d,origin:p,workspace:h,logger:o,verbose:!0});o.debug("Loading cache");const f=perf_hooks_1.performance.now();await m.loadCache();const b=perf_hooks_1.performance.now();let y;if(o.debug(`Loading cache costs ${b-f}ms.`),s.isEditor){const e=await PackerDriver._getEngineFeaturesShippedInEditor(l);o.debug(`Engine features shipped in editor: ${e}`),y={source:PackerDriver._getEngineIndexModuleSource(l,e),respectToFeatureSetting:!1}}else y={source:_,respectToFeatureSetting:!0};const M=await m.createLoaderContext();a[t]=new PackTarget({name:t,modLo:d,sourceMaps:s.sourceMaps,quickPack:m,quickPackLoaderContext:M,logger:o,engineIndexModule:y,tentativePrerequisiteImportsMod:null!==(e=s.isEditor)&&void 0!==e&&e,userImportMap:n.config.importMap?{json:n.config.importMap.json,url:new url_1.URL(n.config.importMap.url)}:void 0})}const h=new PackerDriver(a,l,o,await(0,intelligence_1.getInternalCompilerOptions)(),await(0,intelligence_1.getInternalDbURLInfos)());return await h.init(),await h._syncEngineFeatures(),h}static async updateImportRestrictions(){if(!useEditorFolderFeature)return;const e=await Editor.Message.request("asset-db","query-db-list"),t=PackerDriver._importRestrictions;t.length=0;const s=await getEditorPatterns();s.push(...getCCEModuleIDs(PackerDriver._cceModuleMap));for(let r=0;r<e.length;++r){const i=e[r],a=await Editor.Message.request("asset-db","query-db-info",i),o=path_1.default.join(a.target,"**/*"),n=path_1.default.join(a.target,"**","editor","**/*");t[r]={importerPatterns:[o,"!"+n],banSourcePatterns:s}}}static queryCCEModuleMap(){const e=path_1.default.join(__dirname,"../../cce-module.jsonc"),t=json5_1.default.parse(fs_extra_1.default.readFileSync(e,"utf8"));return t.mapLocation=e,t}busy(){return this._asyncIteration.busy()}async mountDatabase(e){const t=await this._assetDbInterop.fetch(e);this._assetChangeQueue.push(...t),await this._assetDbInterop.onMountDatabase(e),await PackerDriver.updateImportRestrictions()}async unmountDatabase(e){this._assetDbInterop.onUnmountDatabase(e),await PackerDriver.updateImportRestrictions()}async resetDatabases(e=!0){const t=await this._assetDbInterop.queryAssetDomains();this._logger.debug("Reset databases. "+`Enumerated domains: ${JSON.stringify(t,void 0,2)}`);const s=()=>{for(const e of Object.values(this._targets))e.setAssetDatabaseDomains(t)};e?this._triggerNextBuild(s):s()}async pullAssetDb(){const e=this._logger;e.debug("Pulling asset-db.");const t=perf_hooks_1.performance.now();await this._fetchAll();const s=perf_hooks_1.performance.now();e.debug(`Fetch asset-db cost: ${s-t}ms.`),await this._waitForBuild()}async clearCache(){if(this._clearing)this._logger.debug("Failed to clear cache: previous clearing have not finished yet.");else if(this.busy())this._logger.error("Failed to clear cache: the building is still working in progress.");else{this._clearing=!0;for(const[e,t]of Object.entries(this._targets))this._logger.debug(`Clear cache of target ${e}`),await t.clearCache();this._logger.debug("Request build after clearing..."),this._dispatchBuildRequest(),this._clearing=!1}}getQuickPackLoaderContext(e){return this._warnMissingTarget(e),e in this._targets?this._targets[e].quickPackLoaderContext:void 0}isReady(e){return this._warnMissingTarget(e),e in this._targets?this._targets[e].ready:void 0}async queryScriptDeps(e){var t;return await this._transformDepsGraph(),null!==(t=this._depsGraph[e])&&void 0!==t?t:[]}async shutDown(){await this.destroyed()}async init(){this._broadcastListenerMap["engine:modules-changed"]=(()=>this._onEngineFeaturesChanged()),Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.addBroadcastListener(e,this._broadcastListenerMap[e])),await this._assetDbInterop.init()}async destroyed(){Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.removeBroadcastListener(e,this._broadcastListenerMap[e])),this._broadcastListenerMap={},await this._assetDbInterop.destroyed()}_warnMissingTarget(e){e in this._targets||console.warn(`Invalid pack target: ${e}. Existing targets are: ${Object.keys(this._targets)}`)}_onSomeAssetChangesWereMade(e){this._logger.debug(`Dispatch build request for time accumulated ${e.length} asset changes.`),this._assetChangeQueue.push(...e),this._dispatchBuildRequest()}async _onEngineFeaturesChanged(){this._featureChanged=!0,this._dispatchBuildRequest()}async _startBuildIteration(){Editor.Metrics.trackTimeStart("programming:compile-start"),Editor.Message.broadcast("programming:compile-start"),this._logger.clear(),this._logger.debug("Build iteration starts.\n"+`Number of accumulated asset changes: ${this._assetChangeQueue.length}\n`+`Feature changed: ${this._featureChanged}`),this._featureChanged&&(this._featureChanged=!1,await this._syncEngineFeatures());const e=this._assetChangeQueue;this._assetChangeQueue=[];const t=this._beforeBuildTasks.slice();this._beforeBuildTasks.length=0;for(const e of t)e();try{await this.beforeEditorBuildDelegate.dispatch(e.filter(e=>e.type===asset_db_interop_1.AssetChangeType.modified))}catch(e){console.debug(e)}const s=e.filter(e=>!e.filePath.endsWith(".d.ts"));for(const[,t]of Object.entries(this._targets)){0!==e.length&&await t.applyAssetChanges(s);const r=await t.build();this._depsGraph=r.depsGraph}Editor.Message.broadcast("programming:compiled"),Editor.Metrics.trackTimeEnd("programming:compile-start")}async _waitForBuild(){return await this._asyncIteration.nextIteration()}_dispatchBuildRequest(){this._asyncIteration.nextIteration()}static async _createIncrementalRecord(e){const t=await(0,query_shared_settings_1.querySharedSettings)(e),s={version:VERSION,config:{useDefineForClassFields:t.useDefineForClassFields,allowDeclareFields:t.allowDeclareFields,loose:t.loose,exportsConditions:t.exportsConditions,guessCommonJsExports:t.guessCommonJsExports,importMap:t.importMap}},r=await Editor.Profile.getProject("project","script.previewBrowserslistConfigFile");if(r){const e=Editor.UI.__protected__.File.resolveToRaw(r),t=await readBrowserslistTarget(e);t&&(s.config.previewTarget=t)}return s}static async _validateIncrementalRecord(e,t,s,r){let i=!1;try{const s=await fs_extra_1.default.readJson(t);(i=matchObject(e,s))?r.debug("Incremental file seems great."):r.debug("[PackerDriver] Options doesn't match.\n"+`Last: ${JSON.stringify(e,void 0,2)}\n`+`Current: ${JSON.stringify(s,void 0,2)}`)}catch(e){r.debug(`Packer deriver version file lost or format incorrect: ${e}`)}return i||(r.debug("Clearing out the targets..."),await fs_extra_1.default.emptyDir(s),await fs_extra_1.default.outputJson(t,e,{spaces:2})),i}async _fetchAll(){const e=await this._assetDbInterop.fetchAll();this._assetChangeQueue.push(...e)}static async _getEngineFeaturesShippedInEditor(e){return e.getFeatures().filter(e=>!["physics-ammo","physics-builtin","physics-cannon","physics-physx","physics-2d-box2d","physics-2d-builtin","wait-for-ammo-instantiation"].includes(e))}async _syncEngineFeatures(){const e=await Editor.Profile.getProject("engine","modules.includeModules")||[];this._logger.debug(`Sync engine features: ${e}`);const t=PackerDriver._getEngineIndexModuleSource(this._statsQuery,e);for(const[,e]of Object.entries(this._targets))e.respectToEngineFeatureSetting&&e.setEngineIndexModuleSource(t)}static _getEngineIndexModuleSource(e,t){const s=e.getUnitsOfFeatures(t);return e.evaluateIndexModuleSource(s,e=>`${featureUnitModulePrefix}${e}`)}async _triggerNextBuild(e){this._beforeBuildTasks.push(e),this._dispatchBuildRequest()}async _transformDepsGraph(){var e;const t={};for(const[s,r]of Object.entries(this._depsGraph)){const i=await this._transformFilePathToDbPath(s);if(i){const s=null!==(e=t[i])&&void 0!==e?e:t[i]=[];for(const e of r){const t=await this._transformFilePathToDbPath(e);t&&!s.includes(t)&&s.push(t)}}}this._depsGraph=t}async _transformFilePathToDbPath(e){if(e.startsWith("db:"))return e;return e.startsWith("file:///")?(e=(0,url_1.fileURLToPath)(e),await Editor.Message.request("asset-db","query-url",e)):void 0}}exports.PackerDriver=PackerDriver,PackerDriver._importRestrictions=[];const engineIndexModURL="cce:/internal/x/cc",DEFAULT_PREVIEW_BROWSERS_LIST_TARGET="supports es6-module",predefinedTargets={editor:{name:"Editor",browsersListTargets:utils_1.editorBrowserslistQuery,sourceMaps:"inline",isEditor:!0},preview:{name:"Preview",sourceMaps:!0,browsersListTargets:"supports es6-module"}};async function readBrowserslistTarget(e){let t;try{t=await fs_extra_1.default.readFile(e,"utf8")}catch(e){return}const s=function(e){const t=[];for(const s of e.split("\n")){const e=s.indexOf("#"),r=(e<0?s:s.substr(0,e)).trim();0!==r.length&&t.push(r)}return t}(t);if(0!==s.length)return s.join(" or ")}class PackTarget{constructor(e){this._buildStarted=!1,this._ready=!1,this._prerequisiteAssetMods=new Set,this._uuidURLMap=new Map,this._firstBuild=!0,this._cleanResolutionNextTime=!0,this._name=e.name,this._modLo=e.modLo,this._quickPack=e.quickPack,this._quickPackLoaderContext=e.quickPackLoaderContext,this._sourceMaps=e.sourceMaps,this._logger=e.logger,this._respectToFeatureSetting=e.engineIndexModule.respectToFeatureSetting,this._tentativePrerequisiteImportsMod=e.tentativePrerequisiteImportsMod,this._userImportMap=e.userImportMap;const t=this._modLo;this._entryMod=t.addMemoryModule(prerequisite_imports_1.prerequisiteImportsModURL,(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)([])),this._engineIndexMod=t.addMemoryModule(engineIndexModURL,e.engineIndexModule.source),this.setAssetDatabaseDomains([])}get quickPackLoaderContext(){return this._quickPackLoaderContext}get ready(){return this._ready}get respectToEngineFeatureSetting(){return this._respectToFeatureSetting}async build(){this._ensureIdle(),this._buildStarted=!0;const e=this._name;let t;Editor.Message.broadcast("programming:pack-build-start",e),Editor.Metrics.trackTimeStart(`programming:pack-build-start-${e}`),this._logger.debug(`Target(${e}) build started.`);const s=perf_hooks_1.performance.now();try{const e=await this._getPrerequisiteAssetModsWithFilter(),s=[engineIndexModURL,prerequisite_imports_1.prerequisiteImportsModURL,...e],r=this._cleanResolutionNextTime;r&&(this._cleanResolutionNextTime=!1),r&&console.debug("This build will perform a clean module resolution."),t=await this._quickPack.build(s,{retryResolutionOnUnchangedModule:this._firstBuild,cleanResolution:r}),this._firstBuild=!1}catch(e){this._logger.error(`${e}`)}const r=perf_hooks_1.performance.now();return this._logger.debug(`Target(${e}) ends with cost ${r-s}ms.`),this._ready=!0,Editor.Message.broadcast("programming:pack-build-end",e),Editor.Metrics.trackTimeEnd(`programming:pack-build-start-${e}`),this._buildStarted=!1,t||(console.warn("Cannot get build result from quick pack."),{depsGraph:{}})}async clearCache(){await this._quickPack.clear(),this._firstBuild=!0}async applyAssetChanges(e){this._ensureIdle();for(const t of e){const e=t.uuid;if(t.type===asset_db_interop_1.AssetChangeType.modified||t.type===asset_db_interop_1.AssetChangeType.remove){const t=this._uuidURLMap.get(e);if(t){this._uuidURLMap.delete(e),this._modLo.unsetUUID(t),this._prerequisiteAssetMods.delete(t)||this._logger.warn(`Unexpected: ${t} is not in registry.`)}else;}if(t.type===asset_db_interop_1.AssetChangeType.modified||t.type===asset_db_interop_1.AssetChangeType.add){if(t.isPluginScript)continue;const{href:s}=t.url;this._uuidURLMap.set(e,s),this._modLo.setUUID(s,e),this._prerequisiteAssetMods.add(s)}}const t=await this._getPrerequisiteAssetModsWithFilter();this._entryMod.source=(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)(t)}setEngineIndexModuleSource(e){this._ensureIdle(),this._engineIndexMod.source=e}setAssetDatabaseDomains(e){var t,s;this._ensureIdle();const{_userImportMap:r}=this,i={},a=r?r.url:new url_1.URL("foo:/bar");i.imports={},i.imports.cc=engineIndexModURL;const o=[];for(const t of e){const e=(0,url_1.pathToFileURL)(path_1.default.join(t.physical,path_1.default.join(path_1.default.sep))).href;i.imports[t.root.href]=e,o.push(e)}if(r&&(r.json.imports&&(i.imports=Object.assign(Object.assign({},i.imports),r.json.imports)),r.json.scopes))for(const[e,a]of Object.entries(r.json.scopes)){const r=null!==(t=i.scopes)&&void 0!==t?t:i.scopes={};r[e]=Object.assign(Object.assign({},null!==(s=r[e])&&void 0!==s?s:{}),a)}this._logger.debug(`Our import map(${a}): ${JSON.stringify(i,void 0,2)}`),this._modLo.setImportMap(i,a),this._modLo.setAssetPrefixes(o),this._cleanResolutionNextTime=!0}async _getPrerequisiteAssetModsWithFilter(){let e=Array.from(this._prerequisiteAssetMods).sort();if(useEditorFolderFeature&&"editor"!==this._name){const t=await getEditorPatterns();e=Array.from(e).filter(e=>{const s=e.startsWith("file:")?(0,url_1.fileURLToPath)(e):e;return!t.some(e=>(0,minimatch_1.default)(s,e))})}return e}_ensureIdle(){(0,asserts_1.asserts)(!this._buildStarted,"Build is in progress, but a status change request is filed")}}class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}busy(){return!!this._executionPromise||!!this._pendingPromise}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}function matchObject(e,t){return function e(t,s){return Array.isArray(t)?Array.isArray(s)&&t.length===s.length&&t.every((t,r)=>e(t,s[r])):"object"==typeof t&&null!==t?"object"==typeof s&&null!==s&&Object.keys(t).every(r=>e(t[r],s[r])):null===t?null===s:t===s}(e,t)}