"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackerDriver=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),url_1=require("url"),perf_hooks_1=require("perf_hooks"),prerequisite_imports_1=require("./prerequisite-imports"),utils_1=require("@editor/lib-programming/dist/utils"),ccbuild_1=require("@cocos/ccbuild"),asserts_1=require("../utils/asserts"),query_shared_settings_1=require("../shared/query-shared-settings"),quick_pack_1=require("@cocos/creator-programming-quick-pack/lib/quick-pack"),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),asset_db_interop_1=require("./asset-db-interop"),logger_1=require("./logger"),language_service_1=require("../language-service"),intelligence_1=require("../intelligence"),delegate_1=require("../utils/delegate"),json5_1=__importDefault(require("json5")),minimatch_1=__importDefault(require("minimatch")),fs_1=require("fs"),VERSION="20",featureUnitModulePrefix="cce:/internal/x/cc-fu/",useEditorFolderFeature=!1;function matchPattern(e,t){return(0,minimatch_1.default)(e.replace(/\\/g,"/"),t.replace(/\\/g,"/"))}async function getEditorPatterns(){var e=[];for(const r of await Editor.Message.request("asset-db","query-db-list")){var t=await Editor.Message.request("asset-db","query-db-info",r),t=path_1.default.join(t.target,"**","editor","**/*");e.push(t)}return e}function getCCEModuleIDs(e){return Object.keys(e).filter(e=>"mapLocation"!==e)}async function wrapToSetImmediateQueue(r,i,...s){return new Promise((e,t)=>{setImmediate(()=>{try{e(i.apply(r,s))}catch(e){t(e)}})})}class PackerDriver{languageService;static async create(){PackerDriver._cceModuleMap=PackerDriver.queryCCEModuleMap();var t=path_1.default.join(Editor.Project.tmpDir,"programming","packer-driver"),e=path_1.default.join(t,"VERSION"),r=path_1.default.join(t,"targets"),t=path_1.default.join(t,"logs","debug.log"),i={};if(await fs_extra_1.default.pathExists(t))try{await fs_extra_1.default.unlink(t)}catch(e){console.warn("Failed to reset log file: "+t)}var s,a,o=new logger_1.PackerDriverLogger(t),n=(o.debug((new Date).toLocaleString()),o.debug("Project: "+Editor.Project.path),o.debug("Targets: "+Object.keys(predefinedTargets)),await PackerDriver._createIncrementalRecord(o)),u=(await PackerDriver._validateIncrementalRecord(n,e,r,o),{"cce:/internal/code-quality/":(0,url_1.pathToFileURL)(path_1.default.join(__dirname,"..","..","static","builtin-mods","code-quality","/")).href}),t=(await Editor.Message.request("engine","query-engine-info",Editor.Project.__protected__.type)).typescript["path"],c=(o.debug("Engine path: "+t),await ccbuild_1.StatsQuery.create(t)),d=c.evaluateIndexModuleSource([]),l={moduleRequestFilter:[/^cc\.?.*$/g],reporter:{moduleName:"cce:/internal/code-quality/cr.mjs",functionName:"report"}};for([s,a]of Object.entries(predefinedTargets)){o.debug(`Initializing target [${a.name}]`);var _=["cc/env","cc/userland/macro",...getCCEModuleIDs(PackerDriver._cceModuleMap)];_.push(...c.getFeatureUnits().map(e=>""+featureUnitModulePrefix+e));let e=a.browsersListTargets;"preview"===s&&n.config.previewTarget&&(e=n.config.previewTarget,o.debug("Use specified preview browserslist target: "+e));var g=new mod_lo_1.ModLo({targets:e,loose:n.config.loose,guessCommonJsExports:n.config.guessCommonJsExports,useDefineForClassFields:n.config.useDefineForClassFields,allowDeclareFields:n.config.allowDeclareFields,cr:l,_compressUUID(e){return Editor.Utils.UUID.compressUUID(e,!1)},logger:o,checkObsolete:!0,importRestrictions:PackerDriver._importRestrictions,preserveSymlinks:n.config.preserveSymlinks}),_=(g.setExtraExportsConditions(n.config.exportsConditions),g.setExternals(_),g.setLoadMappings(u),path_1.default.join(r,s)),p=Editor.Project.path,p=new quick_pack_1.QuickPack({modLo:g,origin:p,workspace:_,logger:o,verbose:!0}),_=(o.debug("Loading cache"),perf_hooks_1.performance.now()),h=(await p.loadCache(),perf_hooks_1.performance.now());o.debug(`Loading cache costs ${h-_}ms.`);let t;t=a.isEditor?(h=await PackerDriver._getEngineFeaturesShippedInEditor(c),o.debug("Engine features shipped in editor: "+h),{source:PackerDriver._getEngineIndexModuleSource(c,h),respectToFeatureSetting:!1}):{source:d,respectToFeatureSetting:!0};_=p.createLoaderContext();i[s]=new PackTarget({name:s,modLo:g,sourceMaps:a.sourceMaps,quickPack:p,quickPackLoaderContext:_,logger:o,engineIndexModule:t,tentativePrerequisiteImportsMod:a.isEditor??!1,userImportMap:n.config.importMap?{json:n.config.importMap.json,url:new url_1.URL(n.config.importMap.url)}:void 0})}return new PackerDriver(i,c,o,await(0,intelligence_1.getInternalCompilerOptions)(),await(0,intelligence_1.getInternalDbURLInfos)())}static async updateImportRestrictions(){if(useEditorFolderFeature){var t=await Editor.Message.request("asset-db","query-db-infos"),r=PackerDriver._importRestrictions,i=(r.length=0,await getEditorPatterns());i.push(...getCCEModuleIDs(PackerDriver._cceModuleMap));for(let e=0;e<t.length;++e){var s=t[e],a=path_1.default.join(s.target,"**/*"),s=path_1.default.join(s.target,"**","editor","**/*");r[e]={importerPatterns:[a,"!"+s],banSourcePatterns:i}}}}static queryCCEModuleMap(){var e=path_1.default.join(__dirname,"../../cce-module.jsonc"),t=json5_1.default.parse(fs_extra_1.default.readFileSync(e,"utf8"));return t.mapLocation=e,t}beforeEditorBuildDelegate=new delegate_1.AsyncDelegate;busy(){return this._asyncIteration.busy()}async mountDatabase(e){(await this._assetDbInterop.onMountDatabase(e)).forEach(e=>{this._assetChangeQueue.push({type:asset_db_interop_1.AssetChangeType.add,filePath:e.filePath,uuid:e.uuid,isPluginScript:e.isPluginScript,url:e.url})}),await PackerDriver.updateImportRestrictions()}async unmountDatabase(e){(await this._assetDbInterop.onUnmountDatabase(e)).forEach(e=>{this._assetChangeQueue.push({type:asset_db_interop_1.AssetChangeType.remove,filePath:e.filePath,uuid:e.uuid,isPluginScript:e.isPluginScript,url:e.url})}),await PackerDriver.updateImportRestrictions()}async resetDatabases(e=!0){const t=await this._assetDbInterop.queryAssetDomains();this._logger.debug("Reset databases. Enumerated domains: "+JSON.stringify(t,void 0,2));var r=()=>{for(const e of Object.values(this._targets))e.setAssetDatabaseDomains(t)};e?this._triggerNextBuild(r):r()}async pullAssetDb(){var e=this._logger,t=(e.debug("Pulling asset-db."),perf_hooks_1.performance.now()),r=(await this._fetchAll(),perf_hooks_1.performance.now());e.debug(`Fetch asset-db cost: ${r-t}ms.`),await this._waitForBuild()}async clearCache(){if(this._clearing)this._logger.debug("Failed to clear cache: previous clearing have not finished yet.");else if(this.busy())this._logger.error("Failed to clear cache: the building is still working in progress.");else{this._clearing=!0;for(var[e,t]of Object.entries(this._targets))this._logger.debug("Clear cache of target "+e),await t.clearCache();this._logger.debug("Request build after clearing..."),this._dispatchBuildRequest(),this._clearing=!1}}getQuickPackLoaderContext(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].quickPackLoaderContext}isReady(e){if(this._warnMissingTarget(e),e in this._targets)return this._targets[e].ready}queryScriptDeps(e){return this._transformDepsGraph(),this._depsGraphCache[e]?Array.from(this._depsGraphCache[e]):[]}queryScriptUsers(e){return this._transformDepsGraph(),this._usedGraphCache[e]?Array.from(this._usedGraphCache[e]):[]}async shutDown(){await this.destroyed()}_clearing=!1;_targets={};_logger;_statsQuery;_asyncIteration;_assetDbInterop;_assetChangeQueue=[];_featureChanged=!1;_beforeBuildTasks=[];_broadcastListenerMap={};_depsGraph={};_needUpdateDepsCache=!1;_usedGraphCache={};_depsGraphCache={};static _cceModuleMap;static _importRestrictions=[];_init=!1;constructor(e,t,r,i,s){this._targets=e,this._statsQuery=t,this._logger=r,this.languageService=new language_service_1.LanguageServiceAdapter(intelligence_1.realTsConfigPath,Editor.Project.path,this.beforeEditorBuildDelegate,i,s),this._assetDbInterop=new asset_db_interop_1.AssetDbInterop(this._onSomeAssetChangesWereMade.bind(this)),this._asyncIteration=new AsyncIterationConcurrency1(async()=>this._startBuildIteration())}async init(){this._init||(this._init=!0,this._broadcastListenerMap["engine:engine-modules-global-config-changed"]=()=>this._onEngineFeaturesChanged(),Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.addBroadcastListener(e,this._broadcastListenerMap[e])),await this._assetDbInterop.init(),await this._syncEngineFeatures())}async destroyed(){this._init=!1,Object.keys(this._broadcastListenerMap).forEach(e=>Editor.Message.__protected__.removeBroadcastListener(e,this._broadcastListenerMap[e])),this._broadcastListenerMap={},await this._assetDbInterop.destroyed()}_warnMissingTarget(e){e in this._targets||console.warn(`Invalid pack target: ${e}. Existing targets are: `+Object.keys(this._targets))}_onSomeAssetChangesWereMade(e){this._logger.debug(`Dispatch build request for time accumulated ${e.length} asset changes.`),this._assetChangeQueue.push(...e),this._dispatchBuildRequest()}async _onEngineFeaturesChanged(){this._featureChanged=!0,this._dispatchBuildRequest()}async _startBuildIteration(){Editor.Metrics.trackTimeStart("programming:compile-start"),Editor.Message.broadcast("programming:compile-start","project"),this._logger.clear(),this._logger.debug("Build iteration starts.\n"+`Number of accumulated asset changes: ${this._assetChangeQueue.length}
`+"Feature changed: "+this._featureChanged),this._featureChanged&&(this._featureChanged=!1,await this._syncEngineFeatures());var e=this._assetChangeQueue,t=(this._assetChangeQueue=[],this._beforeBuildTasks.slice());this._beforeBuildTasks.length=0;for(const a of t)a();try{await this.beforeEditorBuildDelegate.dispatch(e.filter(e=>e.type===asset_db_interop_1.AssetChangeType.modified))}catch(e){console.debug(e)}var r,i=e.filter(e=>!e.filePath.endsWith(".d.ts"));for([,r]of Object.entries(this._targets)){0!==e.length&&await r.applyAssetChanges(i);var s=await r.build();this._depsGraph=s.depsGraph,this._needUpdateDepsCache=!0}Editor.Message.broadcast("programming:compiled","project"),Editor.Metrics.trackTimeEnd("programming:compile-start")}async _waitForBuild(){return this._asyncIteration.nextIteration()}_dispatchBuildRequest(){this._asyncIteration.nextIteration()}static async _createIncrementalRecord(t){var e=await(0,query_shared_settings_1.querySharedSettings)(t),e={version:VERSION,config:{...e}},r=await Editor.Profile.getProject("project","script.previewBrowserslistConfigFile");if(r&&"project://"!==r){var i,s=Editor.UI.__protected__.File.resolveToRaw(r);try{s&&(0,fs_1.existsSync)(s)?(i=await readBrowserslistTarget(s))&&(e.config.previewTarget=i):t.warn("Preview target config file not found. "+(s||r))}catch(e){t.error(`Failed to load preview target config file at ${s||r}: `+e)}}return e}static async _validateIncrementalRecord(e,t,r,i){let s=!1;try{var a=await fs_extra_1.default.readJson(t);(s=matchObject(e,a))?i.debug("Incremental file seems great."):i.debug("[PackerDriver] Options doesn't match.\n"+`Last: ${JSON.stringify(e,void 0,2)}
`+"Current: "+JSON.stringify(a,void 0,2))}catch(e){i.debug("Packer deriver version file lost or format incorrect: "+e)}return s||(i.debug("Clearing out the targets..."),await fs_extra_1.default.emptyDir(r),await fs_extra_1.default.outputJson(t,e,{spaces:2})),s}async _fetchAll(){var e=await this._assetDbInterop.fetchAll();this._assetChangeQueue.push(...e)}static async _getEngineFeaturesShippedInEditor(e){return e.getFeatures()}async _syncEngineFeatures(){var e,t=(await Editor.Message.request("engine","query-engine-modules-profile"))?.includeModules??[],r=(this._logger.debug("Sync engine features: "+t),PackerDriver._getEngineIndexModuleSource(this._statsQuery,t));for([,e]of Object.entries(this._targets))e.respectToEngineFeatureSetting&&e.setEngineIndexModuleSource(r)}static _getEngineIndexModuleSource(e,t){t=e.getUnitsOfFeatures(t);return e.evaluateIndexModuleSource(t,e=>""+featureUnitModulePrefix+e)}async _triggerNextBuild(e){this._beforeBuildTasks.push(e),this._dispatchBuildRequest()}_transformDepsGraph(){if(this._needUpdateDepsCache){this._needUpdateDepsCache=!1;var e,t,r={},i={};for([e,t]of Object.entries(this._depsGraph))if(e.startsWith("file://")){var s,a=(0,url_1.fileURLToPath)(e);r[a]||(r[a]=new Set);for(const o of t)o.startsWith("file://")&&(s=(0,url_1.fileURLToPath)(o),r[a].add(s),i[s]||(i[s]=new Set),i[s].add(a))}this._usedGraphCache=i,this._depsGraphCache=r}}}exports.PackerDriver=PackerDriver;const engineIndexModURL="cce:/internal/x/cc",DEFAULT_PREVIEW_BROWSERS_LIST_TARGET="supports es6-module",predefinedTargets={editor:{name:"Editor",browsersListTargets:utils_1.editorBrowserslistQuery,sourceMaps:"inline",isEditor:!0},preview:{name:"Preview",sourceMaps:!0,browsersListTargets:DEFAULT_PREVIEW_BROWSERS_LIST_TARGET}};async function readBrowserslistTarget(e){let t;try{t=await fs_extra_1.default.readFile(e,"utf8")}catch(e){return}e=function(e){var t=[];for(const i of e.split("\n")){var r=i.indexOf("#"),r=(r<0?i:i.substr(0,r)).trim();0!==r.length&&t.push(r)}return t}(t);if(0!==e.length)return e.join(" or ")}const OPTIMIZE_ENTRY_SOURCE_COMPILATION=!1;class PackTarget{constructor(e){this._name=e.name,this._modLo=e.modLo,this._quickPack=e.quickPack,this._quickPackLoaderContext=e.quickPackLoaderContext,this._sourceMaps=e.sourceMaps,this._logger=e.logger,this._respectToFeatureSetting=e.engineIndexModule.respectToFeatureSetting,this._tentativePrerequisiteImportsMod=e.tentativePrerequisiteImportsMod,this._userImportMap=e.userImportMap;var t=this._modLo;this._entryMod=t.addMemoryModule(prerequisite_imports_1.prerequisiteImportsModURL,(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)([])),this._entryModSource=this._entryMod.source,this._engineIndexMod=t.addMemoryModule(engineIndexModURL,e.engineIndexModule.source),this.setAssetDatabaseDomains([])}get quickPackLoaderContext(){return this._quickPackLoaderContext}get ready(){return this._ready}get respectToEngineFeatureSetting(){return this._respectToFeatureSetting}async build(){this._ensureIdle(),this._buildStarted=!0;var e=this._name;Editor.Message.broadcast("programming:pack-build-start",e),Editor.Metrics.trackTimeStart("programming:pack-build-start-"+e),this._logger.debug(`Target(${e}) build started.`);let t;var r=perf_hooks_1.performance.now();try{var i=await this._getPrerequisiteAssetModsWithFilter();const s=[engineIndexModURL,prerequisite_imports_1.prerequisiteImportsModURL,...i],a=this._cleanResolutionNextTime;a&&(this._cleanResolutionNextTime=!1),a&&console.debug("This build will perform a clean module resolution."),await wrapToSetImmediateQueue(this,async()=>{t=await this._quickPack.build(s,{retryResolutionOnUnchangedModule:this._firstBuild,cleanResolution:a})}),this._firstBuild=!1}catch(e){this._logger.error(e+", stack: "+e.stack)}i=perf_hooks_1.performance.now();return this._logger.debug(`Target(${e}) ends with cost ${i-r}ms.`),this._ready=!0,Editor.Message.broadcast("programming:pack-build-end",e),Editor.Metrics.trackTimeEnd("programming:pack-build-start-"+e),this._buildStarted=!1,t||(console.warn("Cannot get build result from quick pack."),{depsGraph:{}})}async clearCache(){this._quickPack.clear(),this._firstBuild=!0}async applyAssetChanges(e){this._ensureIdle();for(const i of e){var t,r=i.uuid;i.type!==asset_db_interop_1.AssetChangeType.modified&&i.type!==asset_db_interop_1.AssetChangeType.remove||(t=this._uuidURLMap.get(r))&&(this._uuidURLMap.delete(r),this._modLo.unsetUUID(t),this._prerequisiteAssetMods.delete(t)||this._logger.warn(`Unexpected: ${t} is not in registry.`)),i.type!==asset_db_interop_1.AssetChangeType.modified&&i.type!==asset_db_interop_1.AssetChangeType.add||i.isPluginScript||(t=i.url["href"],this._uuidURLMap.set(r,t),this._modLo.setUUID(t,r),this._prerequisiteAssetMods.add(t))}e=await this._getPrerequisiteAssetModsWithFilter(),e=(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)(e);console.time("update entry mod"),OPTIMIZE_ENTRY_SOURCE_COMPILATION&&this._entryModSource.length===e.length&&this._entryModSource===e||(this._entryModSource=this._entryMod.source=e),console.timeEnd("update entry mod")}setEngineIndexModuleSource(e){this._ensureIdle(),this._engineIndexMod.source=e}setAssetDatabaseDomains(e){this._ensureIdle();var t=this["_userImportMap"],r={},i=t?t.url:new url_1.URL("foo:/bar"),s=(r.imports={},r.imports.cc=engineIndexModURL,[]);for(const c of e){var a=(0,url_1.pathToFileURL)(path_1.default.join(c.physical,path_1.default.join(path_1.default.sep))).href;r.imports[c.root.href]=a,s.push(a)}if(t&&(t.json.imports&&(r.imports={...r.imports,...t.json.imports}),t.json.scopes))for(var[o,n]of Object.entries(t.json.scopes)){var u=r.scopes??={};u[o]={...u[o]??{},...n}}this._logger.debug(`Our import map(${i}): `+JSON.stringify(r,void 0,2)),this._modLo.setImportMap(r,i),this._modLo.setAssetPrefixes(s),this._cleanResolutionNextTime=!0}_buildStarted=!1;_ready=!1;_name;_engineIndexMod;_entryMod;_entryModSource="";_modLo;_sourceMaps;_quickPack;_quickPackLoaderContext;_prerequisiteAssetMods=new Set;_uuidURLMap=new Map;_logger;_firstBuild=!0;_cleanResolutionNextTime=!0;_respectToFeatureSetting;_tentativePrerequisiteImportsMod;_userImportMap;async _getPrerequisiteAssetModsWithFilter(){let e=Array.from(this._prerequisiteAssetMods).sort();if(useEditorFolderFeature&&"editor"!==this._name){const r=await getEditorPatterns();e=Array.from(e).filter(e=>{const t=e.startsWith("file:")?(0,url_1.fileURLToPath)(e):e;return!r.some(e=>(0,minimatch_1.default)(t,e))})}return e}_ensureIdle(){(0,asserts_1.asserts)(!this._buildStarted,"Build is in progress, but a status change request is filed")}}class AsyncIterationConcurrency1{_iterate;_executionPromise=null;_pendingPromise=null;constructor(e){this._iterate=e}busy(){return!!this._executionPromise||!!this._pendingPromise}nextIteration(){return this._executionPromise?this._pendingPromise||(this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration()))):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}function matchObject(e,t){return function r(t,i){return Array.isArray(t)?Array.isArray(i)&&t.length===i.length&&t.every((e,t)=>r(e,i[t])):"object"==typeof t&&null!==t?"object"==typeof i&&null!==i&&Object.keys(t).every(e=>r(t[e],i[e])):null===t?null===i:t===i}(e,t)}