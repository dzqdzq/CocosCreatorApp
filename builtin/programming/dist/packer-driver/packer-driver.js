"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackerDriver=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),url_1=require("url"),perf_hooks_1=require("perf_hooks"),prerequisite_imports_1=require("./prerequisite-imports"),utils_1=require("@editor/lib-programming/dist/utils"),build_engine_1=require("@cocos/build-engine"),asserts_1=require("../utils/asserts"),query_shared_settings_1=require("../shared/query-shared-settings"),quick_pack_1=require("@cocos/creator-programming-quick-pack/lib/quick-pack"),mod_lo_1=require("@cocos/creator-programming-mod-lo/lib/mod-lo"),asset_db_interop_1=require("./asset-db-interop"),logger_1=require("./logger"),language_service_1=require("../language-service"),intelligence_1=require("../intelligence"),delegate_1=require("../utils/delegate"),VERSION="19",featureUnitModulePrefix="cce:/internal/x/cc-fu/";class PackerDriver{constructor(e,t,s,i,r){this.beforeEditorBuildDelegate=new delegate_1.AsyncDelegate,this._clearing=!1,this._targets={},this._assetChangeQueue=[],this._featureChanged=!1,this._beforeBuildTasks=[],this._targets=e,this._statsQuery=t,this._logger=s,this.languageService=new language_service_1.LanguageServiceAdapter(intelligence_1.realTsConfigPath,Editor.Project.path,this.beforeEditorBuildDelegate,i,r),this._assetDbInterop=new asset_db_interop_1.AssetDbInterop(this._onSomeAssetChangesWereMade.bind(this)),this._asyncIteration=new AsyncIterationConcurrency1(async()=>await this._startBuildIteration()),Editor.Message.addBroadcastListener("engine:modules-changed",async()=>this._onEngineFeaturesChanged())}static async create(){var e;const t=path_1.default.join(Editor.Project.tmpDir,"programming","packer-driver"),s=path_1.default.join(t,"VERSION"),i=path_1.default.join(t,"targets"),r=path_1.default.join(t,"logs","debug.log"),a={};if(await fs_extra_1.default.pathExists(r))try{await fs_extra_1.default.unlink(r)}catch(e){console.warn(`Failed to reset log file: ${r}`)}const o=new logger_1.PackerDriverLogger(r);o.debug((new Date).toUTCString()),o.debug(`Project: ${Editor.Project.path}`),o.debug(`Targets: ${Object.keys(predefinedTargets)}`);const n=await PackerDriver._createIncrementalRecord(o);await PackerDriver._validateIncrementalRecord(n,s,i,o);const c={"cce:/internal/code-quality/":(0,url_1.pathToFileURL)(path_1.default.join(__dirname,"..","..","static","builtin-mods","code-quality","/")).href},u=await Editor.Message.request("engine","query-engine-info",Editor.Project.type),{path:d}=u.typescript;o.debug(`Engine path: ${d}`);const l=await build_engine_1.StatsQuery.create(d),g=l.evaluateIndexModuleSource([]),_={moduleRequestFilter:[/^cc\.?.*$/g],reporter:{moduleName:"cce:/internal/code-quality/cr.mjs",functionName:"report"}};for(const[t,s]of Object.entries(predefinedTargets)){o.debug(`Initializing target [${s.name}]`);const r=["cc/env","cc/userland/macro"];r.push(...l.getFeatureUnits().map(e=>`${featureUnitModulePrefix}${e}`));let u=s.browsersListTargets;"preview"===t&&n.config.previewTarget&&(u=n.config.previewTarget,o.debug(`Use specified preview browserslist target: ${u}`));const d=new mod_lo_1.ModLo({targets:u,loose:n.config.loose,guessCommonJsExports:n.config.guessCommonJsExports,useDefineForClassFields:n.config.useDefineForClassFields,allowDeclareFields:n.config.allowDeclareFields,cr:_,_compressUUID:e=>Editor.Utils.UUID.compressUUID(e,!1),logger:o,checkObsolete:!0});d.setExtraExportsConditions(n.config.exportsConditions),d.setExternals(r),d.setLoadMappings(c);const h=path_1.default.join(i,t),p=Editor.Project.path,m=new quick_pack_1.QuickPack({modLo:d,origin:p,workspace:h,logger:o,verbose:!0});o.debug("Loading cache");const f=perf_hooks_1.performance.now();await m.loadCache();const b=perf_hooks_1.performance.now();let y;if(o.debug(`Loading cache costs ${b-f}ms.`),s.isEditor){const e=await PackerDriver._getEngineFeaturesShippedInEditor(l);o.debug(`Engine features shipped in editor: ${e}`),y={source:PackerDriver._getEngineIndexModuleSource(l,e),respectToFeatureSetting:!1}}else y={source:g,respectToFeatureSetting:!0};const w=await m.createLoaderContext();a[t]=new PackTarget({name:t,modLo:d,sourceMaps:s.sourceMaps,quickPack:m,quickPackLoaderContext:w,logger:o,engineIndexModule:y,tentativePrerequisiteImportsMod:null!==(e=s.isEditor)&&void 0!==e&&e,userImportMap:n.config.importMap?{json:n.config.importMap.json,url:new url_1.URL(n.config.importMap.url)}:void 0})}const h=new PackerDriver(a,l,o,await(0,intelligence_1.getInternalCompilerOptions)(),await(0,intelligence_1.getInternalDbURLInfos)());return await h._syncEngineFeatures(),h}busy(){return this._asyncIteration.busy()}async mountDatabase(e){const t=await this._assetDbInterop.fetch(e);this._assetChangeQueue.push(...t),await this._assetDbInterop.onMountDatabase(e)}async unmountDatabase(e){this._assetDbInterop.onUnmountDatabase(e)}async resetDatabases(e=!0){const t=await this._assetDbInterop.queryAssetDomains();this._logger.debug("Reset databases. "+`Enumerated domains: ${JSON.stringify(t,void 0,2)}`);const s=()=>{for(const e of Object.values(this._targets))e.setAssetDatabaseDomains(t)};e?this._triggerNextBuild(s):s()}async pullAssetDb(){const e=this._logger;e.debug("Pulling asset-db.");const t=perf_hooks_1.performance.now();await this._fetchAll();const s=perf_hooks_1.performance.now();e.debug(`Fetch asset-db cost: ${s-t}ms.`),await this._waitForBuild()}async clearCache(){if(this._clearing)this._logger.debug("Failed to clear cache: previous clearing have not finished yet.");else if(this.busy())this._logger.error("Failed to clear cache: the building is still working in progress.");else{this._clearing=!0;for(const[e,t]of Object.entries(this._targets))this._logger.debug(`Clear cache of target ${e}`),await t.clearCache();this._logger.debug("Request build after clearing..."),this._dispatchBuildRequest(),this._clearing=!1}}getQuickPackLoaderContext(e){return this._warnMissingTarget(e),e in this._targets?this._targets[e].quickPackLoaderContext:void 0}isReady(e){return this._warnMissingTarget(e),e in this._targets?this._targets[e].ready:void 0}async shutDown(){}_warnMissingTarget(e){e in this._targets||console.warn(`Invalid pack target: ${e}. Existing targets are: ${Object.keys(this._targets)}`)}_onSomeAssetChangesWereMade(e){this._logger.debug(`Dispatch build request for time accumulated ${e.length} asset changes.`),this._assetChangeQueue.push(...e),this._dispatchBuildRequest()}async _onEngineFeaturesChanged(){this._featureChanged=!0,this._dispatchBuildRequest()}async _startBuildIteration(){this._logger.clear(),this._logger.debug("Build iteration starts.\n"+`Number of accumulated asset changes: ${this._assetChangeQueue.length}\n`+`Feature changed: ${this._featureChanged}`),this._featureChanged&&(this._featureChanged=!1,await this._syncEngineFeatures());const e=this._assetChangeQueue;this._assetChangeQueue=[];const t=this._beforeBuildTasks.slice();this._beforeBuildTasks.length=0;for(const e of t)e();try{await this.beforeEditorBuildDelegate.dispatch(e.filter(e=>e.type===asset_db_interop_1.AssetChangeType.modified))}catch(e){console.debug(e)}const s=e.filter(e=>!e.filePath.endsWith(".d.ts"));for(const[,t]of Object.entries(this._targets))0!==e.length&&t.applyAssetChanges(s),await t.build();Editor.Message.broadcast("programming:compiled")}async _waitForBuild(){return await this._asyncIteration.nextIteration()}_dispatchBuildRequest(){this._asyncIteration.nextIteration()}static async _createIncrementalRecord(e){const t=await(0,query_shared_settings_1.querySharedSettings)(e),s={version:VERSION,config:{useDefineForClassFields:t.useDefineForClassFields,allowDeclareFields:t.allowDeclareFields,loose:t.loose,exportsConditions:t.exportsConditions,guessCommonJsExports:t.guessCommonJsExports,importMap:t.importMap}},i=await Editor.Profile.getProject("project","script.previewBrowserslistConfigFile");if(i){const e=Editor.UI.File.resolveToRaw(i),t=await readBrowserslistTarget(e);t&&(s.config.previewTarget=t)}return s}static async _validateIncrementalRecord(e,t,s,i){let r=!1;try{const s=await fs_extra_1.default.readJson(t);(r=matchObject(e,s))?i.debug("Incremental file seems great."):i.debug("[PackerDriver] Options doesn't match.\n"+`Last: ${JSON.stringify(e,void 0,2)}\n`+`Current: ${JSON.stringify(s,void 0,2)}`)}catch(e){i.debug(`Packer deriver version file lost or format incorrect: ${e}`)}return r||(i.debug("Clearing out the targets..."),await fs_extra_1.default.emptyDir(s),await fs_extra_1.default.outputJson(t,e,{spaces:2})),r}async _fetchAll(){const e=await this._assetDbInterop.fetchAll();this._assetChangeQueue.push(...e)}static async _getEngineFeaturesShippedInEditor(e){return e.getFeatures().filter(e=>!["physics-ammo","physics-builtin","physics-cannon","physics-physx","physics-2d-box2d","physics-2d-builtin","wait-for-ammo-instantiation"].includes(e))}async _syncEngineFeatures(){const e=await Editor.Profile.getProject("engine","modules.includeModules")||[];this._logger.debug(`Sync engine features: ${e}`);const t=PackerDriver._getEngineIndexModuleSource(this._statsQuery,e);for(const[,e]of Object.entries(this._targets))e.respectToEngineFeatureSetting&&e.setEngineIndexModuleSource(t)}static _getEngineIndexModuleSource(e,t){const s=e.getUnitsOfFeatures(t);return e.evaluateIndexModuleSource(s,e=>`${featureUnitModulePrefix}${e}`)}async _triggerNextBuild(e){this._beforeBuildTasks.push(e),this._dispatchBuildRequest()}}exports.PackerDriver=PackerDriver;const engineIndexModURL="cce:/internal/x/cc",DEFAULT_PREVIEW_BROWSERS_LIST_TARGET="supports es6-module",predefinedTargets={editor:{name:"Editor",browsersListTargets:utils_1.editorBrowserslistQuery,sourceMaps:"inline",isEditor:!0},preview:{name:"Preview",sourceMaps:!0,browsersListTargets:"supports es6-module"}};async function readBrowserslistTarget(e){let t;try{t=await fs_extra_1.default.readFile(e,"utf8")}catch(e){return}const s=function(e){const t=[];for(const s of e.split("\n")){const e=s.indexOf("#"),i=(e<0?s:s.substr(0,e)).trim();0!==i.length&&t.push(i)}return t}(t);if(0!==s.length)return s.join(" or ")}class PackTarget{constructor(e){this._buildStarted=!1,this._ready=!1,this._prerequisiteAssetMods=new Set,this._uuidURLMap=new Map,this._firstBuild=!0,this._cleanResolutionNextTime=!0,this._name=e.name,this._modLo=e.modLo,this._quickPack=e.quickPack,this._quickPackLoaderContext=e.quickPackLoaderContext,this._sourceMaps=e.sourceMaps,this._logger=e.logger,this._respectToFeatureSetting=e.engineIndexModule.respectToFeatureSetting,this._tentativePrerequisiteImportsMod=e.tentativePrerequisiteImportsMod,this._userImportMap=e.userImportMap;const t=this._modLo;this._entryMod=t.addMemoryModule(prerequisite_imports_1.prerequisiteImportsModURL,(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)([])),this._engineIndexMod=t.addMemoryModule(engineIndexModURL,e.engineIndexModule.source),this.setAssetDatabaseDomains([])}get quickPackLoaderContext(){return this._quickPackLoaderContext}get ready(){return this._ready}get respectToEngineFeatureSetting(){return this._respectToFeatureSetting}async build(){this._ensureIdle(),this._buildStarted=!0;const e=this._name;Editor.Message.broadcast("programming:pack-build-start",e),Editor.Metrics.trackTimeStart(`programming:pack-build-start-${e}`),this._logger.debug(`Target(${e}) build started.`);const t=perf_hooks_1.performance.now();try{const e=[engineIndexModURL,prerequisite_imports_1.prerequisiteImportsModURL,...this._prerequisiteAssetMods],t=this._cleanResolutionNextTime;t&&(this._cleanResolutionNextTime=!1),t&&console.debug("This build will perform a clean module resolution."),await this._quickPack.build(e,{retryResolutionOnUnchangedModule:this._firstBuild,cleanResolution:t}),this._firstBuild=!1}catch(e){this._logger.error(`${e}`)}const s=perf_hooks_1.performance.now();this._logger.debug(`Target(${e}) ends with cost ${s-t}ms.`),this._ready=!0,Editor.Message.broadcast("programming:pack-build-end",e),Editor.Metrics.trackTimeEnd(`programming:pack-build-start-${e}`),this._buildStarted=!1}async clearCache(){await this._quickPack.clear(),this._firstBuild=!0}applyAssetChanges(e){this._ensureIdle();for(const t of e){const e=t.uuid;if(t.type===asset_db_interop_1.AssetChangeType.modified||t.type===asset_db_interop_1.AssetChangeType.remove){const t=this._uuidURLMap.get(e);if(t){this._uuidURLMap.delete(e),this._modLo.unsetUUID(t),this._prerequisiteAssetMods.delete(t)||this._logger.warn(`Unexpected: ${t} is not in registry.`)}else;}if(t.type===asset_db_interop_1.AssetChangeType.modified||t.type===asset_db_interop_1.AssetChangeType.add){if(t.isPluginScript)continue;const{href:s}=t.url;this._uuidURLMap.set(e,s),this._modLo.setUUID(s,e),this._prerequisiteAssetMods.add(s)}}const t=Array.from(this._prerequisiteAssetMods).sort();this._entryMod.source=(this._tentativePrerequisiteImportsMod?prerequisite_imports_1.makeTentativePrerequisiteImports:prerequisite_imports_1.makePrerequisiteImportsMod)(t)}setEngineIndexModuleSource(e){this._ensureIdle(),this._engineIndexMod.source=e}setAssetDatabaseDomains(e){var t,s;this._ensureIdle();const{_userImportMap:i}=this,r={},a=i?i.url:new url_1.URL("foo:/bar");r.imports={},r.imports.cc=engineIndexModURL;const o=[];for(const t of e){const e=(0,url_1.pathToFileURL)(path_1.default.join(t.physical,path_1.default.join(path_1.default.sep))).href;r.imports[t.root.href]=e,o.push(e)}if(i&&(i.json.imports&&(r.imports=Object.assign(Object.assign({},r.imports),i.json.imports)),i.json.scopes))for(const[e,a]of Object.entries(i.json.scopes)){const i=null!==(t=r.scopes)&&void 0!==t?t:r.scopes={};i[e]=Object.assign(Object.assign({},null!==(s=i[e])&&void 0!==s?s:{}),a)}this._logger.debug(`Our import map(${a}): ${JSON.stringify(r,void 0,2)}`),this._modLo.setImportMap(r,a),this._modLo.setAssetPrefixes(o),this._cleanResolutionNextTime=!0}_ensureIdle(){(0,asserts_1.asserts)(!this._buildStarted,"Build is in progress, but a status change request is filed")}}class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}busy(){return!!this._executionPromise||!!this._pendingPromise}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}function matchObject(e,t){return function e(t,s){return Array.isArray(t)?Array.isArray(s)&&t.length===s.length&&t.every((t,i)=>e(t,s[i])):"object"==typeof t&&null!==t?"object"==typeof s&&null!==s&&Object.keys(t).every(i=>e(t[i],s[i])):null===t?null===s:t===s}(e,t)}