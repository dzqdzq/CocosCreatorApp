"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,r){void 0===r&&(r=t);var i=Object.getOwnPropertyDescriptor(a,t);i&&("get"in i?a.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,r,i)}:function(e,a,t,r){void 0===r&&(r=t),e[r]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.messages=void 0;const asserts_1=require("../utils/asserts"),intelligence_1=require("../intelligence"),awaiter_1=require("../utils/awaiter"),globalPackerDriverAwaiter=new awaiter_1.Awaiter;let globalPackerDriverAwaiterResolved=!1,allDatabasesAreReady=!1;async function onAssetDBFullReady(){(await globalPackerDriverAwaiter.wait()).pullAssetDb(),allDatabasesAreReady=!0}async function onAssetDBFullClose(){const e=await globalPackerDriverAwaiter.wait();(0,asserts_1.asserts)(allDatabasesAreReady,"DB has not been ready."),allDatabasesAreReady=!1,await e.shutDown()}async function onSomeAssetDBReady(e){console.debug(`${e} opened.`);const a=await globalPackerDriverAwaiter.wait();allDatabasesAreReady&&(await a.mountDatabase(e),await a.resetDatabases(!0))}async function onSomeAssetDBClose(e){console.debug(`${e} closed.`);const a=await globalPackerDriverAwaiter.wait();allDatabasesAreReady&&(await a.unmountDatabase(e),await a.resetDatabases(!0))}const initializeAndBuild=(()=>{let e=!1;return async function(){Editor.Metrics.trackTimeStart("programming:worker-init"),e||(e=!0,(async()=>{const{PackerDriver:e}=await Promise.resolve().then(()=>__importStar(require("../packer-driver/packer-driver"))),a=await e.create();globalPackerDriverAwaiter.resolve(a),globalPackerDriverAwaiterResolved=!0})());const a=await globalPackerDriverAwaiter.wait();Editor.Metrics.trackTimeEnd("programming:worker-init",{output:!0}),Editor.Message.addBroadcastListener("asset-db:ready",onAssetDBFullReady),Editor.Message.addBroadcastListener("asset-db:close",onAssetDBFullClose),Editor.Message.addBroadcastListener("asset-db:db-ready",onSomeAssetDBReady),Editor.Message.addBroadcastListener("asset-db:db-close",onSomeAssetDBClose),sleep(500),Editor.Metrics.trackTimeStart("programming:database-startup"),await a.resetDatabases(!1),await a.pullAssetDb(),Editor.Metrics.trackTimeEnd("programming:database-startup",{output:!0})}})();function sleep(e){return new Promise(a=>{setTimeout(a,e)})}exports.messages={async"packer-driver/start"(){allDatabasesAreReady=!0,console.debug("Starting packer driver..."),Editor.Metrics.trackTimeStart("programming:worker-start"),await initializeAndBuild(),Editor.Metrics.trackTimeEnd("programming:worker-start",{output:!0}),console.debug("Packer driver started.")},async"packer-driver/get-loader-context"(e){var a;return null===(a=(await globalPackerDriverAwaiter.wait()).getQuickPackLoaderContext(e))||void 0===a?void 0:a.serialize()},async"packer-driver/ready"(e){if(!globalPackerDriverAwaiterResolved)return!1;return(await globalPackerDriverAwaiter.wait()).isReady(e)},async"clear-code-cache"(){console.debug("Clearing code cache");const e=await globalPackerDriverAwaiter.wait();await e.clearCache()},async"custom-macro-changed"(){await(0,intelligence_1.updateCustomMacro)()}};