"use strict";const{existsSync:existsSync,readFileSync:readFileSync}=require("fs"),{join:join}=require("path"),{expect:expect}=require("chai");function generateAnimOperation(e,t){return{funcName:e,args:t}}function IchangeClipSample(e,t){return generateAnimOperation("changeSample",[e,t])}function IchangeClipWrapMode(e,t){return generateAnimOperation("changeWrapMode",[e,t])}async function Irecord(e,t){return await Editor.Message.request("scene","record-animation",e,t)}async function IchangeAnimNode(e,t){return await Editor.Message.request("scene","change-animation-root",e,t)}function IsetCurEditTime(e){return Editor.Message.request("scene","set-edit-time",e)}function IchangeClipSpeed(e,t){return generateAnimOperation("changeSpeed",[e,t])}function IchangeAnimationState(e,t){return Editor.Message.request("scene","change-clip-state",e,t)}function IsetEditClip(e){return Editor.Message.request("scene","change-edit-clip",e)}function IcreateProp(e,t,a){return generateAnimOperation("createProp",[e,t,a])}function IremoveProp(e,t,a){return generateAnimOperation("removeProp",[e,t,a])}function IcreateKey(e,t,a,n,r){return generateAnimOperation("createKey",[e,t,a,n,r])}function IcopyKeysTo(e,t,a,n,r){return generateAnimOperation("copyKeysTo",[e,t,a,n,r])}function IremoveKey(e,t,a,n){return generateAnimOperation("removeKey",[e,t,a,n])}function ImoveKeys(e,t,a,n,r){return generateAnimOperation("moveKeys",[e,t,a,n,r])}function IspacingKeys(e,t,a,n,r){return generateAnimOperation("spacingKeys",[e,t,a,n,r])}function IclearKeys(e,t,a){return generateAnimOperation("clearKeys",[e,t,a])}function IremoveNode(e,t){return generateAnimOperation("removeNode",[e,t])}function IchangeNodeDataPath(e,t,a){return generateAnimOperation("changeNodeDataPath",[e,t,a])}function IaddEvent(e,t,a,n){return generateAnimOperation("addEvent",[e,t,a,n])}function IcopyEventsTo(e,t,a){return generateAnimOperation("copyEventsTo",[e,t,a])}function ImoveEvents(e,t,a){return generateAnimOperation("moveEvents",[e,t,a])}function IdeleteEvent(e,t){return generateAnimOperation("deleteEvent",[e,t])}function IupdateEvent(e,t,a){return generateAnimOperation("updateEvent",[e,t,a])}function IsaveClip(){return Editor.Message.request("scene","save-clip")}function ImodifyCurveOfKey(e,t,a,n,r){return generateAnimOperation("modifyCurveOfKey",[e,t,a,n,r])}function IcopyNode(e,t,a){return generateAnimOperation("copyNode",[e,t,a])}function IcopyProp(e,t,a){return generateAnimOperation("copyProp",[e,t,a])}function IcopyKey(e,t,a){return generateAnimOperation("copyKey",[e,t,a])}function IcopyEvent(e,t,a){return generateAnimOperation("copyEvent",[e,t,a])}function IApplyOperation(e){return!!e&&(Array.isArray(e)||(e=[e]),!(e.length<=0)&&Editor.Message.request("scene","animation-operation",e))}describe("Test Animation IPC",()=>{let e=null;let t=null;let a=null;describe("prepare test resources",async()=>{it("create Cube Node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"testAnimNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde"});expect(!!t).to.true,e=t}),it("create Sub Cone Node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"SubNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!t).to.true,a=t}),it("add animation component",async()=>{await Editor.Message.request("scene","create-component",{uuid:e,component:"cc.Animation"});const t=await Editor.Message.request("scene","query-node",e);expect(t.__comps__[1].type).to.equal("cc.Animation")}),it("create animation clip",async()=>{const e=await Editor.Message.request("asset-db","query-path","db://internal/default_file_content/anim"),a=await Editor.Message.request("asset-db","import-asset",e,"db://assets/testAnimClip.anim",{overwrite:!0});expect(!!a.uuid).to.true,t=a.uuid}),it("set default clip to component",async()=>{await Editor.Message.request("scene","set-property",{uuid:e,path:"__comps__.1.defaultClip",dump:{type:"cc.AnimationClip",value:{uuid:t}}});let a=(await Editor.Message.request("scene","query-node",e)).__comps__[1].value.defaultClip.value.uuid;expect(a).to.equal(t)})}),describe("test animation clip edit",async()=>{await new Promise(e=>{setTimeout(function(){e()},2e3)});let a=async function(){return await Editor.Message.request("scene","query-animation-clip",e,t)};describe("enter Animation Mode",async()=>{it("set edit clip",async()=>{IsetEditClip(t);let e=await Editor.Message.request("scene","query-current-animation-info");expect(e.clipid).to.equal(t)}),it("change to Animation Mode",async()=>{Irecord(e,!0);let t=await Editor.Message.request("scene","query-scene-mode");expect(t).to.equal("animation")})}),describe("edit uniform key",async()=>{let n=null,r=null;let o="";it("get animatable properties",async()=>{let t=await Editor.Message.request("scene","query-animation-properties",e);console.log(t),t.forEach(e=>{"mainColor"===e.name&&(n=e)}),console.log(n),(r=n.propData).type=n.type,o=n.key}),it("create mainColor prop",async()=>{await IApplyOperation(IcreateProp(t,"/",o));let e=await a();console.log(e),expect(!!e.curves[0]).to.true});let i=30;it("create key",async()=>{let e={newValue:{r:255,g:0,b:0,a:255}};const n=await IApplyOperation(IcreateKey(t,"/",o,0,e));e.newValue={r:0,g:255,b:0,a:255};const r=await IApplyOperation(IcreateKey(t,"/",o,i,e));let s=await a();console.log("create key:",s);let c=s.curves[0].keyframes,p=2===c.length&&0===c[0].frame&&c[1].frame===i;expect(n&&r&&p).to.true}),it("get value at",async()=>{let e=await Editor.Message.request("scene","query-property-value-at-frame",t,"/",o,60);console.log("get value at",e),expect(!!e).to.true});let s=15,c=i+15;it("copy key",async()=>{delete r.newValue;const e=await IApplyOperation(IcopyKeysTo(t,"/",o,[0,i],15));let n=(await a()).curves[0].keyframes,p=4===n.length&&n[1].frame===s&&n[3].frame===c;expect(e&&p).to.true});it("move keys",async()=>{const e=await IApplyOperation(ImoveKeys(t,"/",o,[s,c],5));let n=(await a()).curves[0].keyframes;s+=5,c+=5;let r=4===n.length&&n[1].frame===s&&n[3].frame===c;expect(e&&r).to.true}),it("spacing keys",async()=>{const e=await IApplyOperation(IspacingKeys(t,"/",o,[0,i,s,c],10));let n=(await a()).curves[0].keyframes;s=10,c=20,i=30;let r=4===n.length&&0===n[0].frame&&n[1].frame===s&&n[2].frame===c&&n[3].frame===i;expect(e&&r).to.true}),it("remove key",async()=>{const e=await IApplyOperation(IremoveKey(t,"/",o,s)),n=await IApplyOperation(IremoveKey(t,"/",o,c));let r=(await a()).curves[0].keyframes,p=2===r.length&&0===r[0].frame&&r[1].frame===i;expect(e&&n&&p).to.true}),it("change sample",async()=>{const e=await IApplyOperation(IchangeClipSample(t,30));let n=await a();expect(e&&30===n.sample).to.true}),it("clear keys",async()=>{const e=await IApplyOperation(IclearKeys(t,"/",o));let n=await a();console.log("remove key:",n);let r=0===n.curves[0].keyframes.length;expect(e&&r).to.true}),it("remove material prop",async()=>{const e=await IApplyOperation(IremoveProp(t,"/",o));let n=await a();console.log("remove key:",n);let r=0===n.curves.length;expect(e&&r).to.true})}),describe("edit node keys",async()=>{const n="position";let r=null,o=null;let i="";it("get animatable properties",async()=>{let t=await Editor.Message.request("scene","query-animation-properties",e);console.log(t),t.forEach(e=>{e.name===n&&(r=e)}),(o=r.propData).type=r.type,i=r.key}),it(`create ${n} prop`,async()=>{await IApplyOperation(IcreateProp(t,"/",i));let e=await a();console.log("position prop:",e),expect(4===e.curves.length).to.true});let s=30;it("create key",async()=>{const e=await IApplyOperation(IcreateKey(t,"/",i,0)),n=await IApplyOperation(IcreateKey(t,"/",i,s));let r=(await a()).curves[0].keyframes,o=2===r.length&&0===r[0].frame&&r[1].frame===s;expect(e&&n&&o).to.true});let c=15,p=s+15;it("copy key",async()=>{const e=IApplyOperation(IcopyKeysTo(t,"/",i,[0,s],15));let n=(await a()).curves[0].keyframes,r=4===n.length&&n[1].frame===c&&n[3].frame===p;expect(e&&r).to.true});it("move keys",async()=>{const e=await IApplyOperation(ImoveKeys(t,"/",i,[c,p],5));let n=(await a()).curves[0].keyframes;c+=5,p+=5;let r=4===n.length&&n[1].frame===c&&n[3].frame===p;expect(e&&r).to.true}),it("spacing keys",async()=>{const e=await IApplyOperation(IspacingKeys(t,"/",i,[0,s,c,p],10));let n=(await a()).curves[0].keyframes;c=10,p=20,s=30;let r=4===n.length&&0===n[0].frame&&n[1].frame===c&&n[2].frame===p&&n[3].frame===s;expect(e&&r).to.true}),it("remove key",async()=>{const e=await IApplyOperation(IremoveKey(t,"/",i,c)),n=await IApplyOperation(IremoveKey(t,"/",i,p));let r=(await a()).curves[0].keyframes,o=2===r.length&&0===r[0].frame&&r[1].frame===s;expect(e&&n&&o).to.true}),it("change sample",async()=>{const e=await IApplyOperation(IchangeClipSample(t,30));let n=await a();expect(e&&30===n.sample).to.true}),it("set edit time",async()=>{const e=await IsetCurEditTime(1);expect(e).to.true}),it("auto add key",async()=>{await Editor.Message.request("scene","set-property",{uuid:e,path:n,dump:{type:"cc.Vec3",value:{x:0,y:5,z:0}}});let t=await a();console.log("after Auto add key:",t);let r=t.curves[0].keyframes,o=2===r.length&&0===r[0].frame&&r[1].frame===s;expect(o).to.true});const l=[.23,1.14,.7,.7];it("modify curve",async()=>{const e=await IApplyOperation(IcreateKey(t,"/",i,45)),n=await IApplyOperation(ImodifyCurveOfKey(t,"/",i,30,l)),r=await a();console.log(r);let o=r.curves[0].keyframes,c=3===o.length&&0===o[0].frame&&o[1].frame===s&&45===o[2].frame;console.log(o[1].curve);let p=JSON.stringify(o[1].curve)===JSON.stringify(l);expect(e&&n&&c&&p).to.true}),it("save clip",async()=>{IsaveClip()}),it("change to General Mode",async()=>{Irecord(e,!1);let t=await Editor.Message.request("scene","query-scene-mode");expect(t).to.equal("general")}),it("set edit clip",async()=>{IsetEditClip(t);let e=await Editor.Message.request("scene","query-current-animation-info");expect(e.clipid).to.equal(t)}),it("change to Animation Mode",async()=>{Irecord(e,!0);let t=await Editor.Message.request("scene","query-scene-mode");expect(t).to.equal("animation")}),it("test Serialized Data",async()=>{let e=await a();console.log("reload data:",e);let t=e.curves[0].keyframes,n=3===t.length&&0===t[0].frame&&t[1].frame===s&&45===t[2].frame,r=JSON.stringify(t[1].curve)===JSON.stringify(l);expect(n&&r).to.true});it("copy node curve to subNode",async()=>{let e=await a();await IApplyOperation(IcopyNode(t,{curvesDump:e.curves},{nodePath:"/SubNode"}));let n=await a();console.log("dump after copy to subNode:",n);let r=3===n.curves[4].keyframes.length;expect(8===n.curves.length&&r).to.true}),it("remove subNode data",async()=>{const e=await IApplyOperation(IremoveNode(t,"/SubNode"));let n=await a();console.log("dump after remove subNode data:",n);let r=4===n.curves.length;expect(e&&r).to.true}),it(`create ${n} prop for subNode`,async()=>{await IApplyOperation(IcreateProp(t,"/SubNode",i));let e=await a();console.log("position prop:",e),expect(8===e.curves.length).to.true}),it("copy prop curve to subNode",async()=>{let e=await a();await IApplyOperation(IcopyProp(t,{curvesDump:[e.curves[0]]},{nodePath:"/SubNode",propKeys:[i]}));let n=await a();console.log("dump after copy prop to subNode:",n);let r=3===n.curves[4].keyframes.length;expect(8===n.curves.length&&r).to.true}),it("remove key",async()=>{const e=await IApplyOperation(IremoveKey(t,"/",i,0));let n=await a();console.log("remove key:",n);let r=n.curves[0].keyframes,o=2===r.length&&30===r[0].frame&&45===r[1].frame;expect(e&&o).to.true});it("copy prop curve key to subNode prop",async()=>{let e=await a();await IApplyOperation(IcopyKey(t,{curvesDump:[e.curves[0]]},{nodePath:"/SubNode",propKeys:[i],startFrame:5}));let n=await a();console.log("dump after copy prop key to subNode prop:",n);let r=n.curves[4].keyframes,o=5===r.length&&5===r[1].frame&&20===r[2].frame,s=5===r[1].dump.value.y;expect(8===n.curves.length&&o&&s).to.true}),it("clear subNode keys",async()=>{const e=await IApplyOperation(IclearKeys(t,"/SubNode",i));let n=0===(await a()).curves[4].keyframes.length;expect(e&&n).to.true}),it(`create key for subNode ${n}`,async()=>{const e=await IApplyOperation(IcreateKey(t,"/SubNode",i,0)),n=await IApplyOperation(IcreateKey(t,"/SubNode",i,s));let r=await a();const o=8===r.curves.length;let c=r.curves[4].keyframes,p=2===c.length&&0===c[0].frame&&c[1].frame===s;expect(e&&n&&o&&p).to.true}),it("change node data path",async()=>{IApplyOperation(IchangeNodeDataPath(t,"/","/SubNode"));let e=await a();console.log("data after change path:",e);const n=4===e.curves.length;let r=e.curves[0].keyframes,o=2===r.length&&r[0].frame===s&&45===r[1].frame;expect(n&&o).to.true}),it("change node data path back",async()=>{IApplyOperation(IchangeNodeDataPath(t,"/SubNode","/"));let e=await a();console.log("data after change path back:",e);const n=4===e.curves.length;let r=e.curves[0].keyframes,o=2===r.length&&r[0].frame===s&&45===r[1].frame;expect(n&&o).to.true}),it("set speed",async()=>{await IApplyOperation(IchangeClipSpeed(t,3));const e=3===(await a()).speed;expect(e).to.true}),it("set wrap mode",async()=>{await IApplyOperation(IchangeClipWrapMode(t,2));const e=2===(await a()).wrapMode;expect(e).to.true}),it("clear keys",async()=>{const e=await IApplyOperation(IclearKeys(t,"/",i));let n=0===(await a()).curves[0].keyframes.length;expect(e&&n).to.true}),it("remove node clip",async()=>{const e=await IApplyOperation(IremoveNode(t,"/"));let n=await a();console.log(n);let r=0===n.curves.length;expect(e&&r).to.true})}),describe("edit events",async()=>{it("add event",async()=>{const e=await IApplyOperation(IaddEvent(t,5,"Hello1",[])),n=await IApplyOperation(IaddEvent(t,30,"Hello2",[]));let r=await a(),o=2===r.events.length&&5===r.events[0].frame&&"Hello1"===r.events[0].func&&30===r.events[1].frame&&"Hello2"===r.events[1].func;expect(e&&n&&o).to.true});let e=15,n=40;it("copy event",async()=>{let r=await a();const o=await IApplyOperation(IcopyEvent(t,{eventsDump:r.events},{startFrame:15}));let i=await a(),s=4===i.events.length&&i.events[1].frame===e&&"Hello1"===i.events[1].func&&i.events[3].frame===n&&"Hello2"===i.events[3].func;expect(o&&s).to.true});it("move events",async()=>{const r=await IApplyOperation(ImoveEvents(t,[e,n],5));e+=5,n+=5;let o=await a(),i=4===o.events.length&&o.events[1].frame===e&&"Hello1"===o.events[1].func&&o.events[3].frame===n&&"Hello2"===o.events[3].func;expect(r&&i).to.true}),it("update event",async()=>{const r=await IApplyOperation(IupdateEvent(t,e,[{func:"update Hello",params:[]}]));let o=await a(),i=4===o.events.length&&o.events[1].frame===e&&"update Hello"===o.events[1].func&&o.events[3].frame===n&&"Hello2"===o.events[3].func;expect(r&&i).to.true}),it("delete event",async()=>{const e=await IApplyOperation(IdeleteEvent(t,n));let r=await a(),o=3===r.events.length&&30===r.events[2].frame&&"Hello2"===r.events[2].func;expect(e&&o).to.true})}),describe("exit Animation Mode",async()=>{it("save clip",async()=>{IsaveClip()}),it("change to General Mode",async()=>{Irecord(e,!1);let t=await Editor.Message.request("scene","query-scene-mode");expect(t).to.equal("general")})})}),describe("clear test resources",async()=>{it("remove node",async()=>{await Editor.Message.request("scene","remove-node",{uuid:e})}),it("delete animation clip",async()=>{const e=await Editor.Message.request("asset-db","delete-asset","db://assets/testAnimClip.anim");expect(e).not.to.be.null})})});