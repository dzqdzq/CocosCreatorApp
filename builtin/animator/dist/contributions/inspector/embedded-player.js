"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.ready = exports.update = exports.$ = exports.template = exports.style = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const utils_1 = require("../../panel/utils");
const Vue = require('vue/dist/vue.js');
let panel = null;
let vm = null;
const vueTemplate = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../../../static/embedded-player.html'), 'utf8');
const EmbeddedPlayerVM = Vue.extend({
    name: 'EmbeddedPlayerVM',
    data() {
        return {
            embeddedPlayer: null,
            selectInfo: {
                root: '',
                clipUuid: '',
            },
            nodeFilterOptions: {
                pathPattern: '',
            },
        };
    },
    computed: {
        typeInfo() {
            if (!this.embeddedPlayer || !this.embeddedPlayer.playable) {
                return;
            }
            return utils_1.EmbeddedPlayerMenuMap[this.embeddedPlayer.playable.type];
        },
        defaultDisplayName() {
            if (!this.embeddedPlayer) {
                return '';
            }
            if (this.embeddedPlayer.displayName) {
                return this.embeddedPlayer.displayName;
            }
            if (this.embeddedPlayer.playable?.path) {
                return (0, path_1.basename)(this.embeddedPlayer.playable.path);
            }
            return '';
        },
    },
    methods: {
        onSelectNode(event) {
            const $root = event.target;
            Editor.Panel.__protected__.openKit('ui-kit.searcher', {
                elem: $root,
                params: [
                    {
                        type: 'node',
                        droppable: 'cc.Node',
                        filterOptions: this.nodeFilterOptions,
                    },
                ],
                listeners: {
                    confirm: (detail) => {
                        if (!detail) {
                            return;
                        }
                        this.onNodeConfirm(detail.info.path);
                    },
                    change: (detail) => {
                        if (!detail) {
                            return;
                        }
                        this.onNodeConfirm(detail.info.path);
                    },
                    cancel: (detail) => {
                        if (!detail) {
                            return;
                        }
                        this.onNodeConfirm(detail.info.path);
                    },
                },
            });
        },
        onNodeConfirm(nodePath) {
            if (!nodePath || !this.embeddedPlayer?.playable) {
                return;
            }
            const newEmbeddedPlayer = {
                ...this.embeddedPlayer,
                playable: {
                    ...this.embeddedPlayer.playable,
                    // 相对于根节点的路径
                    path: nodePath.replace(this.selectInfo.root, ''),
                },
            };
            this.updateEmbeddedPlayer(newEmbeddedPlayer);
            this.embeddedPlayer = newEmbeddedPlayer;
        },
        onAssetConfirm(assetUuid) {
            if (!this.embeddedPlayer?.playable) {
                return;
            }
            const newEmbeddedPlayer = {
                ...this.embeddedPlayer,
                playable: {
                    ...this.embeddedPlayer.playable,
                    clip: assetUuid,
                },
            };
            this.updateEmbeddedPlayer(newEmbeddedPlayer);
            this.embeddedPlayer = newEmbeddedPlayer;
        },
        onDisplayNameConfirm(displayName) {
            if (!this.embeddedPlayer) {
                return;
            }
            const newEmbeddedPlayer = {
                ...this.embeddedPlayer,
                displayName,
            };
            this.updateEmbeddedPlayer(newEmbeddedPlayer);
            this.embeddedPlayer = newEmbeddedPlayer;
        },
        updateEmbeddedPlayer(newEmbeddedPlayer) {
            Editor.Message.request('scene', 'animation-operation', [{
                    funcName: 'updateEmbeddedPlayer',
                    args: [this.selectInfo.clipUuid, this.embeddedPlayer, newEmbeddedPlayer],
                }]);
        },
        onReconciledSpeed(value) {
            if (!this.embeddedPlayer) {
                return;
            }
            this.embeddedPlayer.reconciledSpeed = value;
            this.updateEmbeddedPlayer(this.embeddedPlayer);
        },
    },
    template: vueTemplate,
});
exports.style = (0, fs_1.readFileSync)((0, path_1.join)(__dirname, '../../../dist/embedded-player.css'), 'utf8');
exports.template = '<div class="container"></div>';
exports.$ = {
    container: '.container',
};
function update(embeddedPlayerStrArr) {
    if (!vm) {
        return;
    }
    try {
        const embeddedPlayers = embeddedPlayerStrArr.map((str) => JSON.parse(str));
        const embeddedPlayer = embeddedPlayers[0];
        vm.nodeFilterOptions.pathPattern = `${embeddedPlayer.root}/**`;
        vm.$set(vm, 'embeddedPlayer', embeddedPlayer.dump);
        vm.$set(vm, 'selectInfo', embeddedPlayer);
    }
    catch (error) {
        console.error(error);
    }
}
exports.update = update;
function ready() {
    // @ts-ignore
    panel = this;
    vm?.$destroy();
    vm = new EmbeddedPlayerVM();
    vm.$mount(panel.$.container);
}
exports.ready = ready;
function close() {
    vm?.$destroy();
    vm = null;
    panel = null;
}
exports.close = close;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1iZWRkZWQtcGxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL2NvbnRyaWJ1dGlvbnMvaW5zcGVjdG9yL2VtYmVkZGVkLXBsYXllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBa0M7QUFDbEMsK0JBQXNDO0FBRXRDLDZDQUEwRDtBQUkxRCxNQUFNLEdBQUcsR0FBbUIsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFdkQsSUFBSSxLQUFLLEdBQVEsSUFBSSxDQUFDO0FBQ3RCLElBQUksRUFBRSxHQUFlLElBQUksQ0FBQztBQUUxQixNQUFNLFdBQVcsR0FBRyxJQUFBLGlCQUFZLEVBQUMsSUFBQSxXQUFJLEVBQUMsU0FBUyxFQUFFLHNDQUFzQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFbEcsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO0lBQ2hDLElBQUksRUFBRSxrQkFBa0I7SUFDeEIsSUFBSTtRQUNBLE9BQU87WUFDSCxjQUFjLEVBQUUsSUFBK0I7WUFDL0MsVUFBVSxFQUFFO2dCQUNSLElBQUksRUFBRSxFQUFFO2dCQUNSLFFBQVEsRUFBRSxFQUFFO2FBQ2Y7WUFDRCxpQkFBaUIsRUFBRTtnQkFDZixXQUFXLEVBQUUsRUFBRTthQUNsQjtTQUNKLENBQUM7SUFDTixDQUFDO0lBQ0QsUUFBUSxFQUFFO1FBQ04sUUFBUTtZQUNKLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3ZELE9BQU87YUFDVjtZQUNELE9BQU8sNkJBQXFCLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEUsQ0FBQztRQUNELGtCQUFrQjtZQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsQ0FBQzthQUNiO1lB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QU0sZUFBZSxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzNFLE1BQU0sY0FBYyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxHQUFHLEdBQUcsY0FBYyxDQUFDLElBQUksS0FBSyxDQUFDO1FBQy9ELEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRCxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsY0FBYyxDQUFDLENBQUM7S0FDN0M7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDeEI7QUFDTCxDQUFDO0FBZEQsd0JBY0M7QUFFRCxTQUFnQixLQUFLO0lBQ2pCLGFBQWE7SUFDYixLQUFLLEdBQUcsSUFBSSxDQUFDO0lBRWIsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDO0lBQ2YsRUFBRSxHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztJQUM1QixFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDakMsQ0FBQztBQVBELHNCQU9DO0FBRUQsU0FBZ0IsS0FBSztJQUNqQixFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDZixFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQ1YsS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixDQUFDO0FBSkQsc0JBSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBiYXNlbmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgSUVtYmVkZGVkUGxheWVycyB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lL0B0eXBlcy9wdWJsaWMnO1xuaW1wb3J0IHsgRW1iZWRkZWRQbGF5ZXJNZW51TWFwIH0gZnJvbSAnLi4vLi4vcGFuZWwvdXRpbHMnO1xuXG5pbXBvcnQgdHlwZSB7IFZ1ZUNvbnN0cnVjdG9yIH0gZnJvbSAndnVlJztcbmltcG9ydCB7IElFbWJlZGRlZFBsYXllck1lbnVJdGVtIH0gZnJvbSAnLi4vLi4vLi4vQHR5cGVzL3ByaXZhdGUnO1xuY29uc3QgVnVlOiBWdWVDb25zdHJ1Y3RvciA9IHJlcXVpcmUoJ3Z1ZS9kaXN0L3Z1ZS5qcycpO1xuXG5sZXQgcGFuZWw6IGFueSA9IG51bGw7XG5sZXQgdm06IGFueSB8IG51bGwgPSBudWxsO1xuXG5jb25zdCB2dWVUZW1wbGF0ZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uLy4uLy4uL3N0YXRpYy9lbWJlZGRlZC1wbGF5ZXIuaHRtbCcpLCAndXRmOCcpO1xuXG5jb25zdCBFbWJlZGRlZFBsYXllclZNID0gVnVlLmV4dGVuZCh7XG4gICAgbmFtZTogJ0VtYmVkZGVkUGxheWVyVk0nLFxuICAgIGRhdGEoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbWJlZGRlZFBsYXllcjogbnVsbCBhcyBJRW1iZWRkZWRQbGF5ZXJzIHwgbnVsbCxcbiAgICAgICAgICAgIHNlbGVjdEluZm86IHtcbiAgICAgICAgICAgICAgICByb290OiAnJyxcbiAgICAgICAgICAgICAgICBjbGlwVXVpZDogJycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbm9kZUZpbHRlck9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBwYXRoUGF0dGVybjogJycsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgIH0sXG4gICAgY29tcHV0ZWQ6IHtcbiAgICAgICAgdHlwZUluZm8oKTogSUVtYmVkZGVkUGxheWVyTWVudUl0ZW18dW5kZWZpbmVkIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5lbWJlZGRlZFBsYXllciB8fCAhdGhpcy5lbWJlZGRlZFBsYXllci5wbGF5YWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBFbWJlZGRlZFBsYXllck1lbnVNYXBbdGhpcy5lbWJlZGRlZFBsYXllci5wbGF5YWJsZS50eXBlXTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVmYXVsdERpc3BsYXlOYW1lKCk6IHN0cmluZyB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW1iZWRkZWRQbGF5ZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmVtYmVkZGVkUGxheWVyLmRpc3BsYXlOYW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW1iZWRkZWRQbGF5ZXIuZGlzcGxheU5hbWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmVtYmVkZGVkUGxheWVyLnBsYXlhYmxlPy5wYXRoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGJhc2VuYW1lKHRoaXMuZW1iZWRkZWRQbGF5ZXIucGxheWFibGUucGF0aCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIG1ldGhvZHM6IHtcbiAgICAgICAgb25TZWxlY3ROb2RlKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgICAgICAgICBjb25zdCAkcm9vdCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIEVkaXRvci5QYW5lbC5fX3Byb3RlY3RlZF9fLm9wZW5LaXQoJ3VpLWtpdC5zZWFyY2hlcicsIHtcbiAgICAgICAgICAgICAgICBlbGVtOiAkcm9vdCxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ25vZGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJvcHBhYmxlOiAnY2MuTm9kZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJPcHRpb25zOiB0aGlzLm5vZGVGaWx0ZXJPcHRpb25zLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpcm06IChkZXRhaWw6IEVkaXRvci5QYW5lbC5LaXRFdmVudFBhcmFtcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZXRhaWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTm9kZUNvbmZpcm0oZGV0YWlsLmluZm8ucGF0aCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGNoYW5nZTogKGRldGFpbDogRWRpdG9yLlBhbmVsLktpdEV2ZW50UGFyYW1zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRldGFpbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25Ob2RlQ29uZmlybShkZXRhaWwuaW5mby5wYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgY2FuY2VsOiAoZGV0YWlsOiBFZGl0b3IuUGFuZWwuS2l0RXZlbnRQYXJhbXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGV0YWlsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbk5vZGVDb25maXJtKGRldGFpbC5pbmZvLnBhdGgpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgb25Ob2RlQ29uZmlybShub2RlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgICAgICBpZiAoIW5vZGVQYXRoIHx8ICF0aGlzLmVtYmVkZGVkUGxheWVyPy5wbGF5YWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgbmV3RW1iZWRkZWRQbGF5ZXIgPSB7XG4gICAgICAgICAgICAgICAgLi4udGhpcy5lbWJlZGRlZFBsYXllcixcbiAgICAgICAgICAgICAgICBwbGF5YWJsZToge1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmVtYmVkZGVkUGxheWVyLnBsYXlhYmxlLFxuICAgICAgICAgICAgICAgICAgICAvLyDnm7jlr7nkuo7moLnoioLngrnnmoTot6/lvoRcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogbm9kZVBhdGgucmVwbGFjZSh0aGlzLnNlbGVjdEluZm8ucm9vdCwgJycpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy51cGRhdGVFbWJlZGRlZFBsYXllcihuZXdFbWJlZGRlZFBsYXllcik7XG4gICAgICAgICAgICB0aGlzLmVtYmVkZGVkUGxheWVyID0gbmV3RW1iZWRkZWRQbGF5ZXI7XG4gICAgICAgIH0sXG4gICAgICAgIG9uQXNzZXRDb25maXJtKGFzc2V0VXVpZDogc3RyaW5nKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW1iZWRkZWRQbGF5ZXI/LnBsYXlhYmxlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBuZXdFbWJlZGRlZFBsYXllciA9IHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLmVtYmVkZGVkUGxheWVyLFxuICAgICAgICAgICAgICAgIHBsYXlhYmxlOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuZW1iZWRkZWRQbGF5ZXIucGxheWFibGUsXG4gICAgICAgICAgICAgICAgICAgIGNsaXA6IGFzc2V0VXVpZCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlRW1iZWRkZWRQbGF5ZXIobmV3RW1iZWRkZWRQbGF5ZXIpO1xuICAgICAgICAgICAgdGhpcy5lbWJlZGRlZFBsYXllciA9IG5ld0VtYmVkZGVkUGxheWVyO1xuICAgICAgICB9LFxuICAgICAgICBvbkRpc3BsYXlOYW1lQ29uZmlybShkaXNwbGF5TmFtZTogc3RyaW5nKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW1iZWRkZWRQbGF5ZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IG5ld0VtYmVkZGVkUGxheWVyID0ge1xuICAgICAgICAgICAgICAgIC4uLnRoaXMuZW1iZWRkZWRQbGF5ZXIsXG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy51cGRhdGVFbWJlZGRlZFBsYXllcihuZXdFbWJlZGRlZFBsYXllcik7XG4gICAgICAgICAgICB0aGlzLmVtYmVkZGVkUGxheWVyID0gbmV3RW1iZWRkZWRQbGF5ZXI7XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZUVtYmVkZGVkUGxheWVyKG5ld0VtYmVkZGVkUGxheWVyOiBJRW1iZWRkZWRQbGF5ZXJzKSB7XG4gICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdzY2VuZScsICdhbmltYXRpb24tb3BlcmF0aW9uJywgW3tcbiAgICAgICAgICAgICAgICBmdW5jTmFtZTogJ3VwZGF0ZUVtYmVkZGVkUGxheWVyJyxcbiAgICAgICAgICAgICAgICBhcmdzOiBbdGhpcy5zZWxlY3RJbmZvLmNsaXBVdWlkLCB0aGlzLmVtYmVkZGVkUGxheWVyLCBuZXdFbWJlZGRlZFBsYXllcl0sXG4gICAgICAgICAgICB9XSk7XG4gICAgICAgIH0sXG4gICAgICAgIG9uUmVjb25jaWxlZFNwZWVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW1iZWRkZWRQbGF5ZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZW1iZWRkZWRQbGF5ZXIucmVjb25jaWxlZFNwZWVkID0gdmFsdWU7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUVtYmVkZGVkUGxheWVyKHRoaXMuZW1iZWRkZWRQbGF5ZXIpO1xuICAgICAgICB9LFxuICAgIH0sXG4gICAgdGVtcGxhdGU6IHZ1ZVRlbXBsYXRlLFxufSk7XG5cbmV4cG9ydCBjb25zdCBzdHlsZSA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uLy4uLy4uL2Rpc3QvZW1iZWRkZWQtcGxheWVyLmNzcycpLCAndXRmOCcpO1xuXG5leHBvcnQgY29uc3QgdGVtcGxhdGUgPSAnPGRpdiBjbGFzcz1cImNvbnRhaW5lclwiPjwvZGl2Pic7XG5cbmV4cG9ydCBjb25zdCAkID0ge1xuICAgIGNvbnRhaW5lcjogJy5jb250YWluZXInLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZShlbWJlZGRlZFBsYXllclN0ckFycjogc3RyaW5nW10pIHtcbiAgICBpZiAoIXZtKXtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBlbWJlZGRlZFBsYXllcnMgPSBlbWJlZGRlZFBsYXllclN0ckFyci5tYXAoKHN0cikgPT4gSlNPTi5wYXJzZShzdHIpKTtcbiAgICAgICAgY29uc3QgZW1iZWRkZWRQbGF5ZXIgPSBlbWJlZGRlZFBsYXllcnNbMF07XG4gICAgICAgIHZtLm5vZGVGaWx0ZXJPcHRpb25zLnBhdGhQYXR0ZXJuID0gYCR7ZW1iZWRkZWRQbGF5ZXIucm9vdH0vKipgO1xuICAgICAgICB2bS4kc2V0KHZtLCAnZW1iZWRkZWRQbGF5ZXInLCBlbWJlZGRlZFBsYXllci5kdW1wKTtcbiAgICAgICAgdm0uJHNldCh2bSwgJ3NlbGVjdEluZm8nLCBlbWJlZGRlZFBsYXllcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZHkoKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHBhbmVsID0gdGhpcztcbiAgICBcbiAgICB2bT8uJGRlc3Ryb3koKTtcbiAgICB2bSA9IG5ldyBFbWJlZGRlZFBsYXllclZNKCk7XG4gICAgdm0uJG1vdW50KHBhbmVsLiQuY29udGFpbmVyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsb3NlKCkge1xuICAgIHZtPy4kZGVzdHJveSgpO1xuICAgIHZtID0gbnVsbDtcbiAgICBwYW5lbCA9IG51bGw7XG59XG4iXX0=