"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.methods=void 0;const cc_1=require("cc"),util_1=require("util");function getAnimationComp(e,n){const o=cce.Node.query(e);if(!o)return console.debug(`can not get node from uuid ${e}`),null;if(n)return o.getComponent(n);for(const e of["cc.Animation","cc.SkeletalAnimation"]){const n=o.getComponent(e);if(n)return n}return null}async function addAllPropKeysToNode(e,n,o,t){const i=`Start addAllPropKeysToNode ${o||"/"}...`;console.time(i),t.node++;const c=cce.Animation.queryProperties(e.uuid);return t.property+=c.length,await Promise.all(c.map(e=>addAllKeysToProp(e.key,n,o||"/"))),!e.children||!e.children.length||(await Promise.all(e.children.map(e=>addAllPropKeysToNode(e,n,`${o}/${e.name}`,t))),console.timeEnd(i),!0)}async function addAllKeysToProp(e,n,o){const t=`Start addAllKeysToProp ${o}:${e} with key(${n.num})...`;console.time(t),n.createProp&&await cce.Animation._curEditAnimClip.createProp(o,e),await Promise.all(new Array(n.num).fill(1).map((t,i)=>cce.Animation._curEditAnimClip.createKey(o,e,n.start+i*n.spacing))),console.timeEnd(t),cce.Animation._isDirty=!0}exports.methods={async createAniCompFromAsset(e,n,o){if(!e||!n||!n.length)return!1;if("cc.animation.AnimationController"===(o=o||"cc.Animation"))return void console.debug("Can not add AnimationClip to cc.animation.AnimationController");const t=cce.Node.query(e);let i=t.getComponent(o);i||(cce.SceneFacadeManager.createComponent({uuid:e,component:o}),i=t.getComponent(o));const c=i.defaultClip;for(const e of n){const n=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(e);i.defaultClip=n}return c&&(i.defaultClip=c),cce.SceneFacadeManager.snapshot(),cce.Node.emit("change",t),!0},async addClipFromAsset(e,n,o){if(!e||!n)return!1;const t=getAnimationComp(e,o);if(!t)return console.debug(`get animaton component from ${e} failed!`),!1;if("cc.animation.AnimationController"===o)return void console.debug("Can not add AnimationClip to cc.animation.AnimationController");const i=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(n);return t.defaultClip=i,cce.SceneFacadeManager.snapshot(),cce.Node.emit("change",cce.Node.query(e)),!0},async restoreFromDump(e,n,o){cce.Animation.restoreFromDump(e,n,o)},queryClipDump:(e,n)=>cce.Animation.dumpClip(e,n),async createAllSupportKeys(e){if("animation"!==cce.SceneFacadeManager.queryMode())return void console.warn("请先进入动画编辑模式");const n={spacing:5,num:4,createProp:!0,start:0};e=e?Object.assign(n,e):n;const o=cce.Scene.queryNodeTree(cce.Animation._curEditRootNodeUuid);console.time("createAllSupportKeys");const t={node:0,property:0};await addAllPropKeysToNode(o,e,"",t),cce.Animation._isDirty=!0,cce.Engine.repaintInEditMode(),cce.Animation.emit("scene:animation-change",cce.Animation._curEditRootNodeUuid,cce.Animation._curEditClipUuid),Editor.Message.broadcast("scene:animation-change",cce.Animation._curEditRootNodeUuid,cce.Animation._curEditClipUuid),console.timeEnd("createAllSupportKeys"),console.log(`createAllSupportKeys with node: ${t.node}, property: ${t.property}`)}};