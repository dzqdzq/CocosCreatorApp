"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,i,a,e){void 0===e&&(e=a),Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[a]}})}:function(t,i,a,e){void 0===e&&(e=a),t[e]=i[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,i){Object.defineProperty(t,"default",{enumerable:!0,value:i})}:function(t,i){t.default=i}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var i={};if(null!=t)for(var a in t)"default"!==a&&Object.prototype.hasOwnProperty.call(t,a)&&__createBinding(i,t,a);return __setModuleDefault(i,t),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.fonts=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),VmConfig=__importStar(require("./vm/index")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/index.html"),"utf8");const ipc_event_1=require("./share/ipc-event"),utils_1=require("./utils"),animation_ctrl_1=require("./share/animation-ctrl"),global_data_1=require("./share/global-data"),animation_editor_1=require("./share/animation-editor"),grid_ctrl_1=require("./share/grid-ctrl");let panel=null,vm=null;async function ready(){panel=this;const t=require("lodash");panel.onChangeNode=t.throttle(_onChangeNode.bind(panel),100),animation_editor_1.animationEditor.panel=panel,initVue()}async function beforeClose(){if(vm&&vm.animationMode){if("animation"!==await ipc_event_1.IquerySceneMode())return!0;if(!await animation_ctrl_1.animationCtrl.exit())return!1}return!0}async function close(){animation_editor_1.animationEditor.close(),vm=null}function initVue(){animation_editor_1.animationEditor.reset(),animation_ctrl_1.animationCtrl.reset(),vm=new Vue(Object.assign({el:panel.$.animator},VmConfig))}async function _onChangeNode(t,i){if(this.hidden)return;if(console.debug("change-node"),!vm||vm.animationMode||"play"===vm.animationState)return;if(vm.selectedId===t&&await animation_editor_1.animationEditor.updateSelectedId(),animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.isLock)return;const a=await ipc_event_1.IqueryAnimationRoot(t);if(!a||a!==vm.root)return vm.selectedId===t?void await animation_editor_1.animationEditor.update(t,"node-change"):void 0;t!==vm.root&&(t=a),global_data_1.Flags.lockUuid||global_data_1.Flags.lockUuid===t||(global_data_1.Flags.lockUuid=t,global_data_1.Flags.lockTimer&&clearTimeout(global_data_1.Flags.lockTimer),await animation_editor_1.animationEditor.update(t,"node-change"),global_data_1.Flags.lockTimer=setTimeout(()=>{global_data_1.Flags.lockUuid=""},600))}exports.$={animator:".animator",grid:".grid"},exports.fonts=[{name:"animator"}],exports.methods={deleteSelected(){if(vm&&vm.selectEventInfo&&animation_ctrl_1.animationCtrl.clipsDump)animation_ctrl_1.animationCtrl.deleteEvent();else if(vm&&!animation_editor_1.animationEditor.isLock&&animation_ctrl_1.animationCtrl.clipsDump){if(!vm.selectKeyInfo)return vm.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.selectProperty.nodePath][vm.selectProperty.prop].parentPropKey?void animation_editor_1.animationEditor.showToast("i18n:animator.property.can_not_delete_part_property"):void animation_ctrl_1.animationCtrl.removeProp(vm.selectProperty):void 0;animation_ctrl_1.animationCtrl.removeKey()}},nextStep:animation_editor_1.animationEditor.nextStep.bind(animation_editor_1.animationEditor),prevStep:animation_editor_1.animationEditor.prevStep.bind(animation_editor_1.animationEditor),jumpToNextKey:animation_editor_1.animationEditor.jumpToNextKey.bind(animation_editor_1.animationEditor),jumpToPrevKey:animation_editor_1.animationEditor.jumpToPrevKey.bind(animation_editor_1.animationEditor),jumpFirstFrame:animation_editor_1.animationEditor.jumpFirstFrame.bind(animation_editor_1.animationEditor),jumpLastFrame:animation_editor_1.animationEditor.jumpLastFrame.bind(animation_editor_1.animationEditor),showAllKeys(){vm&&vm.showAnimCurve&&vm.showAllKeys()},copy:animation_editor_1.animationEditor.copy.bind(animation_editor_1.animationEditor),paste:animation_editor_1.animationEditor.paste.bind(animation_editor_1.animationEditor),selectAll(t){if(t){if(t.path&&"INPUT"===t.path[0].tagName)return;t.stopPropagation(),t.preventDefault()}if(!vm||animation_editor_1.animationEditor.isLock||!animation_ctrl_1.animationCtrl.clipsDump||!vm.selectProperty||!vm.properties)return;const i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.computeSelectPath][vm.selectProperty.prop].keyFrames.map(t=>({nodePath:vm.computeSelectPath,prop:t.prop,frame:t.frame,rawFrame:t.frame,x:t.x})),a=utils_1.sortSelectParams(i);vm.selectKeyInfo={keyFrames:i,sortDump:a,prop:vm.selectProperty.prop,nodePath:vm.computeSelectPath}},createKey(){if(!vm||animation_editor_1.animationEditor.isLock)return;if(!vm.selectProperty||!vm.computeSelectPath)return;if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.isLock)return;const{prop:t,nodePath:i}=vm.selectProperty;i===vm.computeSelectPath&&animation_ctrl_1.animationCtrl.createKey({frame:vm.currentFrame,nodePath:i,prop:t})},playOrPause(){vm&&!animation_editor_1.animationEditor.isLock&&("stop"===vm.animationState||"pause"===vm.animationState?animation_ctrl_1.animationCtrl.updatePlayState("play"):animation_ctrl_1.animationCtrl.updatePlayState("pause"))},stop(){animation_editor_1.animationEditor.isLock||animation_ctrl_1.animationCtrl.updatePlayState("stop")},clearSelect(){animation_editor_1.animationEditor.isLock||animation_editor_1.animationEditor.clearSelectData()},changeRecordState(){vm&&vm.currentClip&&vm.active&&ipc_event_1.Irecord(vm.root,!vm.animationMode)},"change-debug-mode"(){window.animationEditor=window.animationEditor?null:animation_editor_1.animationEditor,window.animationCtrl=window.animationCtrl?null:animation_ctrl_1.animationCtrl,window.gridCtrl=window.gridCtrl?null:grid_ctrl_1.gridCtrl},async"asset-db:asset-change"(t){if(!vm||!Array.isArray(vm.clipsMenu))return;let i=!1;for(const a of vm.clipsMenu)if(a.uuid===t){i=!0;break}i&&setTimeout(async()=>{if(vm){const t=await ipc_event_1.IqueryclipsMenuInfo(vm.root);t&&(vm.clipsMenu=t.clipsMenu)}},500)},async"scene:ready"(){global_data_1.Flags.sceneReady||(global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask++,vm&&await animation_editor_1.animationEditor.debounceRefresh())},"scene:close"(){global_data_1.Flags.sceneReady=!1,vm&&(vm.loading="wait_scene_ready")},async"selection:activated"(t,i){this.hidden||vm&&"node"===t&&(vm.selectedIds=new Set(i),vm.selectPath="",i.length?await animation_editor_1.animationEditor.debounceUpdateNode(i[0]):vm.selectedId="")},async"scene:change-node"(t,i){global_data_1.Flags.sceneReady&&panel.onChangeNode(t,i)},async"scene:animation-start"(t){vm&&t===vm.root&&!vm.animationMode&&(vm.animationMode=!0,console.debug("scene:animation-start"))},async"scene:animation-end"(){global_data_1.Flags.sceneReady=!1,vm&&vm.animationMode&&(vm.animationMode=!1,animation_editor_1.animationEditor.exit(),console.debug("scene:animation-end"))},async"scene:animation-change"(t){!this.hidden&&t&&vm&&t===vm.root&&await animation_editor_1.animationEditor.updateClips(vm.currentClip,"update")},"scene:animation-state-change"(t){animation_editor_1.animationEditor.updatePlayState&&animation_editor_1.animationEditor.updatePlayState(t)},async"scene:animation-clip-change"(t){vm&&t!==vm.currentClip&&(await animation_editor_1.animationEditor.updateClips(t),vm.selectKeyInfo=null,vm.selectProperty=null)}},exports.listeners={resize(){global_data_1.Flags.sceneReady&&vm&&(animation_editor_1.animationEditor.updateLayoutConfig(),animation_editor_1.animationEditor.resize())},async show(){vm||initVue(),global_data_1.Flags.sceneReady&&await animation_editor_1.animationEditor.debounceRefresh()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;