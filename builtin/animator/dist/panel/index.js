"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,a){void 0===a&&(a=i);var n=Object.getOwnPropertyDescriptor(e,i);n&&("get"in n?e.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,a,n)}:function(t,e,i,a){void 0===a&&(a=i),t[a]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),VmConfig=__importStar(require("./vm/index")),vue_js_1=__importDefault(require("vue/dist/vue.js")),pinia_1=require("pinia"),ipc_event_1=require("./share/ipc-event"),utils_1=require("./utils"),animation_ctrl_1=require("./share/animation-ctrl"),global_data_1=require("./share/global-data"),animation_editor_1=require("./share/animation-editor"),grid_ctrl_1=require("./share/grid-ctrl"),Utils=__importStar(require("./utils")),pop_menu_1=require("./share/pop-menu");vue_js_1.default.config.productionTip=!Editor.App.dev,vue_js_1.default.config.devtools=!Editor.App.dev,vue_js_1.default.config.silent=!Editor.App.dev,vue_js_1.default.use(pinia_1.PiniaVuePlugin);let panel=null,vm=null;function ready(){panel=this;const t=require("lodash");panel.onChangeNode=t.throttle(_onChangeNode.bind(panel),100),animation_editor_1.animationEditor.panel=panel,initVue();require("@editor/setting");(Editor.App.dev||Editor.App.args.spectron)&&toggleAnimationEditor()}async function beforeClose(){if(vm&&vm.animationMode){if("animation"!==await(0,ipc_event_1.IquerySceneMode)())return!0;if(!await animation_ctrl_1.animationCtrl.exit())return!1}return!0}function close(){animation_editor_1.animationEditor.close(),null===vm||void 0===vm||vm.$destroy(),vm=null}function toggleAnimationEditor(){window.AnimationEditor=window.AnimationEditor?null:{animationEditor:animation_editor_1.animationEditor,animationCtrl:animation_ctrl_1.animationCtrl,gridCtrl:grid_ctrl_1.gridCtrl,Utils:Utils,menuConfig:pop_menu_1.menuConfig,Test:require((0,path_1.join)(__dirname,"../../test/tools/index.js"))}}function initVue(){animation_editor_1.animationEditor.reset(),animation_ctrl_1.animationCtrl.reset();const t=(0,pinia_1.createPinia)();vm=new vue_js_1.default(Object.assign(Object.assign({el:panel.$.animator,name:"CcAnimatior"},VmConfig),{pinia:t}))}async function _onChangeNode(t,e){if(this.hidden)return;if(Editor.App.dev&&console.debug("change-node",t),!vm||"play"===vm.animationState)return;if(vm.animationMode&&"cc.animation.AnimationController"===vm.aniCompType)return;if(vm.animationMode)return void await animation_editor_1.animationEditor.updateClipMenu();const i=await(0,ipc_event_1.IqueryAnimationRoot)(t);if(!vm)return;const a=await(0,ipc_event_1.IqueryAnimationRoot)(vm.selectedId);a&&a!==i||global_data_1.Flags.lockUuid||global_data_1.Flags.lockUuid===t||(global_data_1.Flags.lockUuid=t,global_data_1.Flags.lockTimer&&clearTimeout(global_data_1.Flags.lockTimer),await animation_editor_1.animationEditor.updateNode(t),global_data_1.Flags.lockTimer=setTimeout(()=>{global_data_1.Flags.lockUuid=""},600))}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/index.html"),"utf8"),exports.$={animator:".animator",grid:".grid"},exports.methods={deleteSelected(){if(vm&&vm.selectEventInfo&&animation_ctrl_1.animationCtrl.clipsDump)animation_ctrl_1.animationCtrl.deleteEvent();else if(vm&&vm.selectEmbeddedPlayerInfo)animation_editor_1.animationEditor.deleteSelecteEmbeddedPlayers();else if(vm&&!animation_editor_1.animationEditor.isLock&&animation_ctrl_1.animationCtrl.clipsDump){if(!vm.selectKeyInfo)return vm.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.selectProperty.nodePath][vm.selectProperty.prop].parentPropKey?void animation_editor_1.animationEditor.showToast("i18n:animator.property.can_not_delete_part_property"):void animation_ctrl_1.animationCtrl.removeProp(vm.selectProperty):void 0;animation_ctrl_1.animationCtrl.removeKey()}},nextStep:animation_editor_1.animationEditor.nextStep.bind(animation_editor_1.animationEditor),prevStep:animation_editor_1.animationEditor.prevStep.bind(animation_editor_1.animationEditor),jumpToNextKey:animation_editor_1.animationEditor.jumpToNextKey.bind(animation_editor_1.animationEditor),jumpToPrevKey:animation_editor_1.animationEditor.jumpToPrevKey.bind(animation_editor_1.animationEditor),jumpFirstFrame:animation_editor_1.animationEditor.jumpFirstFrame.bind(animation_editor_1.animationEditor),jumpLastFrame:animation_editor_1.animationEditor.jumpLastFrame.bind(animation_editor_1.animationEditor),showAllKeys(){vm&&vm.showAnimCurve&&vm.showAllKeys()},copy:animation_editor_1.animationEditor.copy.bind(animation_editor_1.animationEditor),paste:animation_editor_1.animationEditor.paste.bind(animation_editor_1.animationEditor),selectAll(t){if(t){if(t.path&&"INPUT"===t.path[0].tagName)return;t.stopPropagation(),t.preventDefault()}if(!vm||animation_editor_1.animationEditor.isLock||!animation_ctrl_1.animationCtrl.clipsDump||!vm.selectProperty||!vm.properties)return;const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.computeSelectPath][vm.selectProperty.prop].keyFrames.map(t=>Object.assign(Object.assign({},t),{nodePath:vm.computeSelectPath,rawFrame:t.frame,key:Utils.calcKeyFrameKey(t)})),i=(0,utils_1.sortKeysToTreeMap)(e);vm.selectKeyInfo={keyFrames:e,sortDump:i,prop:vm.selectProperty.prop,nodePath:vm.computeSelectPath,location:"prop"}},createKey(){if(!vm||animation_editor_1.animationEditor.isLock)return;if(!vm.selectProperty||!vm.computeSelectPath)return;if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.isLock)return;const{prop:t,nodePath:e}=vm.selectProperty;e===vm.computeSelectPath&&animation_ctrl_1.animationCtrl.createKey({frame:vm.currentFrame,nodePath:e,prop:t})},playOrPause(){vm&&vm.animationMode&&("stop"===vm.animationState||"pause"===vm.animationState?animation_ctrl_1.animationCtrl.updatePlayState("play"):animation_ctrl_1.animationCtrl.updatePlayState("pause"))},stop(){vm&&vm.animationMode&&animation_ctrl_1.animationCtrl.updatePlayState("stop")},clearSelect(){animation_editor_1.animationEditor.isLock||animation_editor_1.animationEditor.clearSelectData()},changeRecordState(){vm&&vm.currentClip&&vm.active&&(vm.animationMode?animation_ctrl_1.animationCtrl.exit():animation_ctrl_1.animationCtrl.enter(vm.currentClip))},"change-debug-mode"(){toggleAnimationEditor()},"asset-db:asset-change"(t){if(!vm||!Array.isArray(vm.clipsMenu))return;let e=!1;for(const i of vm.clipsMenu)if(i.uuid===t){e=!0;break}e&&setTimeout(async()=>{if(vm){const t=await(0,ipc_event_1.IqueryclipsMenuInfo)(vm.root);t&&(vm.clipsMenu=t.clipsMenu)}},500)},async"scene:ready"(){global_data_1.Flags.sceneReady||(global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask++,vm&&await animation_editor_1.animationEditor.debounceRefresh())},"scene:close"(){global_data_1.Flags.sceneReady=!1,vm&&(vm.loading="wait_scene_ready"),animation_editor_1.animationEditor.onSceneClose()},async"selection:activated"(t,e){this.hidden||vm&&"node"===t&&(vm.selectedIds=new Set(e),vm.selectPath="",e.length?(vm.selectedId=e[0],vm.animationMode||await animation_editor_1.animationEditor.debounceUpdateNode(vm.selectedId)):vm.selectedId="")},async"scene:change-node"(t,e){global_data_1.Flags.sceneReady&&await panel.onChangeNode(t,e)},"scene:animation-start"(t){vm&&t===vm.root&&!vm.animationMode&&(animation_editor_1.animationEditor.onEnter(),console.debug("scene:animation-start"))},"scene:animation-end"(){global_data_1.Flags.sceneReady=!1,vm&&vm.animationMode&&(vm.animationMode=!1,console.debug("scene:animation-end"))},async"scene:animation-change"(t){!this.hidden&&t&&vm&&t===vm.root&&await animation_editor_1.animationEditor.updateClips(vm.currentClip,"update")},"scene:animation-state-change"(t){animation_editor_1.animationEditor.updatePlayState(t)},async"scene:animation-clip-change"(t){vm&&t!==vm.currentClip&&(await animation_editor_1.animationEditor.updateClips(t),vm.selectKeyInfo=null,vm.selectProperty=null)},async enableEmbeddedPlayer(){vm&&vm.updateEnableEmbeddedPlayer()},async enableAuxiliaryCurve(){vm&&vm.updateAuxCurveEnableState()}},exports.listeners={resize(){global_data_1.Flags.sceneReady&&vm&&(animation_editor_1.animationEditor.updateLayoutConfig(),animation_editor_1.animationEditor.resize())},async show(){vm||initVue(),global_data_1.Flags.sceneReady&&await animation_editor_1.animationEditor.debounceRefresh()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;