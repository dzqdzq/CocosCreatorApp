"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,a){void 0===a&&(a=i),Object.defineProperty(t,a,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,a){void 0===a&&(a=i),t[a]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.fonts=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),VmConfig=__importStar(require("./vm/index")),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/index.html"),"utf8");const ipc_event_1=require("./share/ipc-event"),utils_1=require("./utils"),animation_ctrl_1=require("./share/animation-ctrl"),global_data_1=require("./share/global-data"),animation_editor_1=require("./share/animation-editor"),grid_ctrl_1=require("./share/grid-ctrl");let panel=null,vm=null;async function ready(){panel=this,animation_editor_1.animationEditor.panel=panel,initVue()}async function beforeClose(){if(vm&&vm.animationMode){if("animation"!==await ipc_event_1.IquerySceneMode())return!0;if(!await animation_ctrl_1.animationCtrl.exit())return!1}return!0}async function close(){animation_editor_1.animationEditor.close(),vm=null}function initVue(){vm=new Vue(Object.assign({el:panel.$.animator},VmConfig))}exports.$={animator:".animator",grid:".grid"},exports.fonts=[{name:"animator"}],exports.methods={deleteSelected(){if(!animation_editor_1.animationEditor.isLock&&animation_ctrl_1.animationCtrl.clipsDump)if(vm.selectKeyInfo)animation_ctrl_1.animationCtrl.removeKey();else{if(!vm.selectEventInfo)return vm.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[vm.selectProperty.nodePath][vm.selectProperty.prop].parentPropKey?void animation_editor_1.animationEditor.showToast("i18n:animator.property.can_not_delete_part_property"):void animation_ctrl_1.animationCtrl.removeProp(vm.selectProperty):void 0;animation_ctrl_1.animationCtrl.deleteEvent()}},nextStep:animation_editor_1.animationEditor.nextStep.bind(animation_editor_1.animationEditor),prevStep:animation_editor_1.animationEditor.prevStep.bind(animation_editor_1.animationEditor),jumpToNextKey:animation_editor_1.animationEditor.jumpToNextKey.bind(animation_editor_1.animationEditor),jumpToPrevKey:animation_editor_1.animationEditor.jumpToPrevKey.bind(animation_editor_1.animationEditor),jumpFirstFrame:animation_editor_1.animationEditor.jumpFirstFrame.bind(animation_editor_1.animationEditor),jumpLastFrame:animation_editor_1.animationEditor.jumpLastFrame.bind(animation_editor_1.animationEditor),copy:animation_editor_1.animationEditor.copy.bind(animation_editor_1.animationEditor),paste:animation_editor_1.animationEditor.paste.bind(animation_editor_1.animationEditor),selectAll(t){if(t){if(t.path&&"INPUT"===t.path[0].tagName)return;t.stopPropagation(),t.preventDefault()}if(animation_editor_1.animationEditor.isLock||!vm.selectProperty)return;const e=vm.properties[vm.selectProperty.prop].keyFrames,i=e.map(t=>({nodePath:vm.computeSelectPath,prop:t.prop,frame:t.frame})),a=utils_1.sortSelectParams(i);vm.selectKeyInfo={data:e,params:i,sortDump:a}},createKey(){if(animation_editor_1.animationEditor.isLock)return;if(!vm.selectProperty||!vm.computeSelectPath)return;if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.isLock)return;const{prop:t,nodePath:e}=vm.selectProperty;e===vm.computeSelectPath&&animation_ctrl_1.animationCtrl.createKey({frame:vm.currentFrame,param:{nodePath:e,prop:t}})},playOrPause(){animation_editor_1.animationEditor.isLock||("stop"===vm.animationState||"pause"===vm.animationState?animation_ctrl_1.animationCtrl.updatePlayState("play"):animation_ctrl_1.animationCtrl.updatePlayState("pause"))},stop(){animation_editor_1.animationEditor.isLock||animation_ctrl_1.animationCtrl.updatePlayState("stop")},clearSelect(){animation_editor_1.animationEditor.isLock||animation_editor_1.animationEditor.clearSelectData()},changeRecordState(){vm&&vm.currentClip&&vm.active&&ipc_event_1.Irecord(vm.root,!vm.animationMode)},"change-debug-mode"(){window.animationEditor=window.animationEditor?null:animation_editor_1.animationEditor,window.animationCtrl=window.animationCtrl?null:animation_ctrl_1.animationCtrl,window.gridCtrl=window.gridCtrl?null:grid_ctrl_1.gridCtrl},async"asset-db:asset-change"(t){if(!vm||!Array.isArray(vm.clipsMenu))return;let e=!1;for(const i of vm.clipsMenu)if(i.uuid===t){e=!0;break}e&&setTimeout(async()=>{const t=await ipc_event_1.IqueryclipsMenuInfo(vm.root);t&&(vm.clipsMenu=t.clipsMenu)},500)},async"scene:ready"(){global_data_1.Flags.sceneReady||(global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask++,vm&&await vm.refresh())},"scene:close"(){global_data_1.Flags.sceneReady=!1,vm&&(vm.loading="wait_scene_ready")},async"selection:activated"(t,e){this.hidden||vm&&"node"===t&&(vm.selectedIds=new Set(e),vm.selectPath=null,e.length?await animation_editor_1.animationEditor.debounceUpdateNode(e[0]):vm.selectedId="")},async"scene:change-node"(t){if(this.hidden)return;if(!vm)return;if(vm.selectedId===t&&await vm.updateSelectedId(),vm.clipDump&&vm.clipDump.isLock)return;const e=await ipc_event_1.IqueryAnimationRoot(t);if(!e||e!==vm.root)return vm.selectedId===t?void await vm.update(t):void 0;t!==vm.root&&(t=e),global_data_1.Flags.lockUuid||global_data_1.Flags.lockUuid===t||(global_data_1.Flags.lockUuid=t,global_data_1.Flags.lockTimer&&clearTimeout(global_data_1.Flags.lockTimer),await vm.update(t,"node-change"),global_data_1.Flags.lockTimer=setTimeout(()=>{global_data_1.Flags.lockUuid=""},600))},async"scene:animation-start"(t){vm&&t===vm.root&&!vm.animationMode&&(vm.animationMode=!0)},async"scene:animation-end"(){vm&&vm.animationMode&&(vm.animationMode=!1,animation_editor_1.animationEditor.exit())},async"scene:animation-change"(t){!this.hidden&&t&&vm&&t===vm.root&&await vm.updateClips(vm.currentClip,"update")},"scene:animation-state-change"(t){animation_editor_1.animationEditor.debounceUpdateState&&animation_editor_1.animationEditor.debounceUpdateState(t)},async"scene:animation-clip-change"(t){vm&&t!==vm.currentClip&&(await vm.updateClips(t),vm.selectKeyInfo=null,vm.selectProperty=null)}},exports.listeners={resize(){global_data_1.Flags.sceneReady&&vm&&(animation_editor_1.animationEditor.updateLayoutConfig(),vm&&vm.resize())},async show(){vm||initVue(),global_data_1.Flags.sceneReady&&await vm.refresh()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;