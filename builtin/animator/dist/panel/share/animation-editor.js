"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcFrames=exports.animationEditor=exports.CurveColorList=void 0;const utils_1=require("../utils"),animation_ctrl_1=require("./animation-ctrl"),bezier_presets_1=require("./bezier-presets"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event");exports.CurveColorList=["#ff717c","#56beef","#70d39f","#b499ff"];const Lodash=require("lodash");class AnimationEditor{constructor(){this.panel=null,this.LINE_HEIGHT=24,this.KEY_SIZE_R=Math.sqrt(14),this.imageCCTypes=["cc.SpriteFrame","cc.Texture2D"],this.curveDisabledCCtypes=["Unknown","cc.Boolean","cc.Quat",...this.imageCCTypes],this.gridCtrl=grid_ctrl_1.gridCtrl,this.refreshTask=0,this.hasInitCurve=!1,this.hasInitCurvePreset=!1,this._spacingFrame=1,this._curveData=null,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this.hasShowStick=!1,this.layoutConfig={topMin:24,leftMin:100,topMax:500,leftMax:500},this.aniPlayTask=0,this.updateSelectQueue=[]}get spacingFrame(){return this._spacingFrame}set spacingFrame(e){this._spacingFrame=e,this.changeSpacingFrame(e)}get isLock(){return!this.vm||!(this.vm&&this.vm.animationMode&&!this.vm.lock&&!this.vm.maskPanel)}reset(){this.refreshTask=0,this.hasInitCurve=!1,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this._spacingFrame=1,this.hasShowStick=!1,this.layoutConfig={topMin:24,leftMin:100,topMax:500,leftMax:500},this.aniPlayTask=0,this.updateSelectQueue=[]}setConfig(e,t){Editor.Profile.setConfig("animator",e,t,"global")}async getConfig(e){return await Editor.Profile.getConfig("animator",e)}async init(e){this.vm=e,this.debounceUpdateNode=require("lodash").debounce(this.update,300),this.debounceFilterNode=require("lodash").debounce(this.FilterNode,300),this.debounceRefresh=require("lodash").debounce(this._refresh,300);const t=await exports.animationEditor.getConfig("spacingFrame");this._spacingFrame=t||1,utils_1.addEventListenerOnce(document,"mouseup",this.onMouseUp),utils_1.addEventListenerOnce(document,"mousemove",this.onMouseMove)}async vmInit(){const e=this.vm;e.$refs.chart.style.width=`${e.$refs.right.offsetWidth}px`;const t=await this.getConfig("showType");grid_ctrl_1.gridCtrl.init({$canvas:e.$refs.gridCanvas,$left:e.$refs.left,$right:e.$refs.right,$xAxis:e.$refs.xAxis,showType:t,minScale:1,maxScale:100}),this.updateLayoutConfig(),e.offset=e.$refs.left.offsetWidth,requestAnimationFrame(()=>{grid_ctrl_1.gridCtrl.grid.resize(),e.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.setCurrentFrame(e.currentFrame),this.initCurve()})}initCurve(){const{width:e,height:t}=this.vm.$refs["property-content"].getBoundingClientRect();if(this.vm.$refs.curve.style.width=e,this.vm.$refs.curve.style.height=t,this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.curveCtrl.canvas.width&&this.vm.$refs.curve.curveCtrl.canvas.height||(this.vm.$refs.curve.resize(e,t),this.vm.$refs.curve.setConfig({xRange:[0,1/0],yRange:[-1/0,1/0],showPreWrapMode:!1,showPostWrapMode:!1,precisionX:0,precisionY:3,showXLabel:!1,showYLabel:!0,axisMargin:0,showYLine:!0,showXLine:!1,startXOffset:10,handlerSize:60,gridColor:"#333846",spacingFrame:exports.animationEditor.spacingFrame,sample:this.vm.sample}),this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.yAxisScale=10),!exports.animationEditor.hasInitCurve){new ResizeObserver(e=>{const{width:t,height:i}=e[0].contentRect;this.vm.$refs.curve.resize(t,i)}).observe(this.vm.$refs.curve),this.vm.$refs.curve.addEventListener("transform",()=>{grid_ctrl_1.gridCtrl.grid.xAxisScale=this.vm.$refs.curve.curveCtrl.grid.xAxisScale,grid_ctrl_1.gridCtrl.grid.xAxisOffset=this.vm.$refs.curve.curveCtrl.grid.xAxisOffset,this.vm.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.updatePositionInfo(),this.vm.updatePosition++,grid_ctrl_1.gridCtrl.grid.render()}),this.vm.$refs.curve.curveCtrl.getCopyKeys=(()=>{const e=animation_ctrl_1.animationCtrl.copyKeyInfo;if(!e)return[];const t=[];return e.curvesDump.forEach(e=>{t.push({key:e.key,keys:e.keyframes.map(e=>utils_1.mockDumpToCtrl(e))})}),t}),this.vm.$refs.curve.curveCtrl.on("operate",this.onCurveOperate.bind(this)),exports.animationEditor.hasInitCurve=!0}if(!this.hasInitCurvePreset){for(const e of this.vm.presetArr){const{p1:t,p2:i,p3:r,p4:a}=bezier_presets_1.transformBezierDataToPoint(e.data);e.svgData=`M${t[0]} ${t[1]} C ${i[0]} ${i[1]}, ${r[0]} ${r[1]}, ${a[0]} ${a[1]}`}this.hasInitCurvePreset=!0}}onCurveOperate(e,t,i){if(this.vm.hasSelectedCurveClip=!1,"unselect"===e||!this.vm.selectProperty)return this.vm.selectKeyInfo=null,void(this.vm.lightCurve=null);if(!t)return;const{nodePath:r,type:a}=this.vm.selectProperty;switch(e){case"select":{const e={keyFrames:[],nodePath:r,prop:this.vm.selectProperty.prop};t.forEach(t=>{const i=utils_1.transformCtrlKeyToDump(t.keys,a),r=t.key;e.keyFrames.push(...i.map((e,i)=>({x:t.keys[i].key.canvas.x-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:e.frame,rawFrame:e.frame,prop:r,nodePath:this.vm.computeSelectPath})))}),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=e,this.vm.updateSelectKey++}break;case"db-select":{const e=t[0].keys,i=utils_1.transformCtrlKeyToDump(e,a);this.updateCurrentFrame(i[0].frame)}break;case"select-curve":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color};break;case"select-curve-clip":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color},this.vm.hasSelectedCurveClip=!0;break;case"apply-bezier":{this.vm.hasSelectedCurveClip=!0;const e=t[0].key,i=utils_1.transformCtrlKeyToDump(t[0].keys,a).map(t=>ipc_event_1.ImodifyCurveOfKey(this.vm.currentClip,r,e,t.frame,{inTangent:t.inTangent,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight,interpMode:t.interpMode,tangentWeightMode:t.tangentWeightMode}));ipc_event_1.IApplyOperation(i)}break;case"scale-keys":case"move-keys":{const e=[],i=[],n={nodePath:this.vm.computeSelectPath,keyFrames:[]};t.forEach(t=>{const o=t.keys,s=utils_1.transformCtrlKeyToDump(o,a);o.forEach((a,o)=>{const l=Math.round(a.key.point.x-a.raw.point.x);n.keyFrames.push({x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(s[o].frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:s[o].frame,prop:t.key,rawFrame:Math.round(a.raw.point.x),nodePath:this.vm.computeSelectPath,offsetFrame:l});const c=Math.round(a.key.point.y-a.raw.point.y);(l||c)&&(l&&e.push(ipc_event_1.ImoveKeys(this.vm.currentClip,r,t.key,[Math.round(a.raw.point.x)],l)),i.push(ipc_event_1.IcreateKey(this.vm.currentClip,r,t.key,s[o].frame,{newValue:a.key.point.y,inTangent:a.key.inTangent,outTangent:a.key.outTangent})))})}),ipc_event_1.IApplyOperation([...e,...i]),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=n}break;case"tangent":{const e=t[0].key,i=utils_1.transformCtrlKeyToDump(t[0].keys,a).map(t=>ipc_event_1.ImodifyCurveOfKey(this.vm.currentClip,r,e,t.frame,{inTangent:t.inTangent,broken:t.broken,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight}));ipc_event_1.IApplyOperation(i)}break;case"change-broken-state":{const e=t[0].key,i=utils_1.transformCtrlKeyToDump(t[0].keys,a).map(t=>ipc_event_1.ImodifyCurveOfKey(this.vm.currentClip,r,e,t.frame,{broken:t.broken}));ipc_event_1.IApplyOperation(i)}break;case"create-keys":{const e=[];t.forEach(t=>{const i=t.keys,n=utils_1.transformCtrlKeyToDump(i,a);n.forEach((i,a)=>{e.push(ipc_event_1.IcreateKey(this.vm.currentClip,r,t.key,n[a].frame,{inTangent:i.inTangent,outTangent:i.outTangent,newValue:i.dump.value,interpMode:i.interpMode,tangentWeightMode:i.tangentWeightMode,inTangentWeight:i.inTangentWeight,outTangentWeight:i.outTangentWeight}))})}),ipc_event_1.IApplyOperation(e)}break;case"change-interp-mode":{const e=[];t.forEach(t=>{const i=t.keys,n=utils_1.transformCtrlKeyToDump(i,a);e.push(...n.map(e=>ipc_event_1.ImodifyCurveOfKey(this.vm.currentClip,r,t.key,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode})))}),ipc_event_1.IApplyOperation(e)}break;case"change-tangent-weight":{const e=[];t.forEach(t=>{const i=t.keys,n=utils_1.transformCtrlKeyToDump(i,a);e.push(...n.map(e=>ipc_event_1.ImodifyCurveOfKey(this.vm.currentClip,r,t.key,e.frame,{tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight})))}),ipc_event_1.IApplyOperation(e)}break;case"remove-keys":{const e=[];t.forEach(t=>{const i=t.keys,n=utils_1.transformCtrlKeyToDump(i,a);e.push(...n.map(e=>ipc_event_1.IremoveKey(this.vm.currentClip,r,t.key,e.frame)))}),ipc_event_1.IApplyOperation(e),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=null}break;case"move-curve":{const e=[];t.forEach(t=>{const i=t.keys,n=utils_1.transformCtrlKeyToDump(i,a);e.push(...n.map(e=>ipc_event_1.IcreateKey(this.vm.currentClip,r,t.key,e.frame,{newValue:e.dump.value})))}),ipc_event_1.IApplyOperation(e)}break;case"paste":animation_ctrl_1.animationCtrl.pasteKey({target:i,nodePath:r},animation_ctrl_1.animationCtrl.getClipBoardData("key"));break;case"copy":{const e=[],i=[];t.forEach(t=>{const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r][t.key],o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r][n.parentPropKey],s=t.keys,l=utils_1.transformCtrlKeyToDump(s,a);e.push({nodePath:r,key:t.key,type:n.type,displayName:n.displayName,keyframes:l,_parentType:o.type,preExtrap:n.preExtrap,postExtrap:n.postExtrap,isCurveSupport:n.isCurveSupport}),i.push(l[0].frame)}),animation_ctrl_1.animationCtrl.copyKeyInfo={curvesDump:e,leftFrame:i.sort((e,t)=>e-t)[0]}}}}FilterNode(e){this.vm.filterName=e,this.calcDisplayNodes()}checkCurveDataDirty(e){if(!this._curveData)return this._curveData=e,!0;const t=JSON.stringify(this._curveData)!==JSON.stringify(e);return this._curveData=e,t}updateCurveSelecteKeys(){if(!this.vm.showAnimCurve)return;if(!this.vm.selectKeyInfo)return void this.vm.$refs.curve.curveCtrl.selectKeys(null);const e=this.vm.selectKeyInfo.sortDump||utils_1.sortKeysToTreeMap(this.vm.selectKeyInfo.keyFrames),t=Object.values(e).map(e=>({key:e.prop,frames:e.keyFrames.map(e=>e.frame)}));this.vm.$refs.curve.curveCtrl.selectKeys(t)}repaintCurve(e){if(this.vm){try{this.vm.showAnimCurve&&this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.curveCtrl.paint(e)}catch(e){console.error(e)}this.selectKeyUpdateFlag&&(this.updateCurveSelecteKeys(),this.selectKeyUpdateFlag=!1)}}updateLayoutConfig(){this.layoutConfig.topMax=this.panel.clientHeight-100,this.layoutConfig.leftMax=this.panel.clientWidth-100}updateSample(e){this.vm.$refs.curve.sample=e}hideNodes(){this.vm.$refs.nodes.style.height="24px",this.vm.$refs.nodes.style.flex="unset",this.vm.$refs["node-content"].style.height="24px",this.vm.$refs["node-content"].style.flex="unset"}showToast(e,t=1e3){this.vm.toast.message=e,global_data_1.Flags.tipsTimer&&clearTimeout(global_data_1.Flags.tipsTimer),global_data_1.Flags.tipsTimer=setTimeout(()=>{this.vm.toast.message=""},t)}changeSpacingFrame(e){this.setConfig("spacingFrame",e),this.vm.$refs.curve.curveCtrl&&(this.vm.$refs.curve.curveCtrl.config.spacingFrame=e)}updatePositionInfo(e){const t=this.vm;if(t.previewPointer&&(t.previewPointer=null),t.nodeDump&&animation_ctrl_1.animationCtrl.clipsDump&&(t.nodeDump.forEach(e=>{e.keyFrames=Object.freeze(this.calcNodeFrames(e.path))}),t.properties&&(t.properties=this.calcProperty()),t.updateKeyFrame++),"move"!==e){if(t.selectKeyInfo){for(const e of t.selectKeyInfo.keyFrames)e&&(e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset);t.updateSelectKey++}if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events&&this.calcEventsDump(),t.selectEventInfo)for(const e of t.selectEventInfo.data)e&&(e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset)}}resetSelectedKeyInfo(){const e=this.vm;if(!e.selectKeyInfo)return;const t=JSON.parse(JSON.stringify(e.selectKeyInfo));t.offsetFrame=0,t.offset=0,delete t.sortDump,t.keyFrames.forEach((e,i)=>{t.keyFrames[i].frame=e.frame,delete t.keyFrames[i].offsetFrame}),t.sortDump=utils_1.sortKeysToTreeMap(t.keyFrames),t.keyFrames.sort((e,t)=>e.frame-t.frame),e.selectKeyInfo=t}clearSelectData(){if(this.vm.selectEventInfo||this.vm.selectKeyInfo)return this.vm.selectEventInfo=null,void(this.vm.selectKeyInfo=null);this.vm.selectProperty&&(this.vm.selectProperty=null)}copy(){if(this.isLock)return this.vm.selectEventInfo&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.copyEvents():void 0;this.vm.selectKeyInfo?animation_ctrl_1.animationCtrl.copyKey():this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectProperty?animation_ctrl_1.animationCtrl.copyProp(this.vm.selectProperty):this.vm.selectedId&&animation_ctrl_1.animationCtrl.copyNodeData([animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId]])}paste(){if(this.isLock)return animation_ctrl_1.animationCtrl.copyEventInfo&&this.vm.animationMode&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):void 0;animation_ctrl_1.animationCtrl.copyKeyInfo?animation_ctrl_1.animationCtrl.pasteKey({target:this.vm.currentFrame,nodePath:this.vm.computeSelectPath},animation_ctrl_1.animationCtrl.getClipBoardData("key")):animation_ctrl_1.animationCtrl.copyEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):this.vm.selectProperty&&animation_ctrl_1.animationCtrl.copyPropInfo?animation_ctrl_1.animationCtrl.pasteProp(this.vm.selectProperty,animation_ctrl_1.animationCtrl.getClipBoardData("prop")):this.vm.selectedId&&animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("node"))}updateSelectKey(e){const t=this.vm;if(!t.selectKeyInfo&&!e)return;const i=JSON.parse(JSON.stringify(t.selectKeyInfo||e));if(!i.sortDump){if(!e.nodePath)return;i.sortDump={}}const{nodePath:r,prop:a}=e,n=r+a;if(!i.sortDump[n]&&!e.keyFrames.length||!a)return;const o=e.keyFrames.map(e=>e.frame)||[];i.sortDump[n]={keyFrames:e.keyFrames,prop:a,nodePath:r,frames:o},e.keyFrames.length||delete i.sortDump[n];let s=[];Object.keys(i.sortDump).map(e=>{const t=i.sortDump[e];t.keyFrames.length||delete i.sortDump[e],s=s.concat(t.keyFrames)}),i.keyFrames=s.sort((e,t)=>e.frame-t.frame),t.selectKeyInfo=i,console.debug(i)}getPositionAtSelect(e){return this.vm.selectKeyInfo?this.vm.selectKeyInfo.keyFrames.findIndex(t=>t.prop===e.prop&&t.frame===e.frame&&t.nodePath===e.nodePath):-1}removeSelectKey(e){if(!this.vm.selectKeyInfo||!this.vm.selectKeyInfo.keyFrames)return!1;const t=JSON.parse(JSON.stringify(this.vm.selectKeyInfo));return this.vm.selectKeyInfo.keyFrames.forEach((i,r)=>{e.find(e=>Lodash.isEqual(i,e))&&(t.keyFrames.splice(r,1),t.keyFrames.splice(r,1))}),delete t.sortDump,this.vm.selectKeyInfo=t,!0}openEventEditor(e){this.vm.editEventFrame=e,this.vm.maskPanel="event"}closeMaskPanel(){this.vm.maskPanel=""}setMovePath(e){this.vm.moveNodePath=e}cancelMoveNode(){this.vm.moveNodePath=""}selectNode(e,t=!1){if(!animation_ctrl_1.animationCtrl.nodesDump)return;const i=this.vm,r=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[e];if(r){const e=[r[0]];e[0]!==i.selectedId&&t&&e.push(i.selectedId),Editor.Selection.update("node",e)}else i.selectPath=e,i.properties=this.calcProperty(),i.selectedId="",i.selectedIds.clear()}startMoveNode(e){this.vm.moveNodePath=e}startDragKey(e,t=!1){if(!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return;const i=this.vm;if(e){e.keyFrames.sort((e,t)=>e.frame-t.frame),e.sortDump=utils_1.sortKeysToTreeMap(e.keyFrames);const t=e.keyFrames[0];if(t.nodePath!==i.computeSelectPath){const e=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[t.nodePath];e[0]!==i.selectedId&&(Editor.Selection.unselect("node",i.selectedId),Editor.Selection.select("node",e[0]),i.selectedId=e[0])}if(!this.vm.selectProperty||this.vm.selectProperty.prop!==t.prop||this.vm.selectProperty.nodePath!==t.nodePath){const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.nodePath][t.prop];exports.animationEditor.updateSelectProperty({nodePath:t.nodePath,prop:t.prop,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid,isCurveSupport:e.isCurveSupport}),this.selectKeyUpdateFlag=!0}}i.selectKeyInfo=e,i.updateSelectKey++,t||(global_data_1.Flags.mouseDownName="key")}async updateSelectProperty(e){const t=this.vm,i=await ipc_event_1.IgetPropValueAtFrame(t.currentClip,e.nodePath,e.prop,t.currentFrame);i&&(t.selectProperty=Object.assign(e,{dump:i,type:{value:i.type,extends:i.extends}}))}startDragEvent(e,t=!1){this.vm.selectEventInfo=e,t?"event"===global_data_1.Flags.mouseDownName&&(global_data_1.Flags.mouseDownName=""):global_data_1.Flags.mouseDownName="event"}updateMouseFrame(e,t){const i=this.vm;if(!e||!e.x&&!e.y)return void(i.moveInfo=null);const r=grid_ctrl_1.gridCtrl.pageToCtrl(e.x,e.y),a=e.frame||grid_ctrl_1.gridCtrl.pageToFrame(e.x);i.moveInfo?(i.moveInfo.frame=a,i.moveInfo.x=r.x+5,i.moveInfo.y=r.y+5,i.moveInfo.offsetFrame=t||0):i.moveInfo={frame:a,x:r.x+5,y:r.y+5,offsetFrame:t||0}}updatePropExpandState(e,t){const i=this.vm;i.expandInfo[e]=t;const r=i.properties[e].partKeys;r?(r.forEach(e=>{i.properties[e].hidden=!t}),i.properties=this.calcProperty(),requestAnimationFrame(()=>{i.updateSelectKey++})):console.log(`[Animation Editor] Can't get partKeys of prop(${e})`)}showFrameInGrid(e){const{start:t,end:i}=grid_ctrl_1.gridCtrl.getFrameRang();e>=i?this.setGridHeaderFrame(e):e<=t&&this.setGridFooterFrame(e)}setGridHeaderFrame(e){const{start:t}=grid_ctrl_1.gridCtrl.getFrameRang(),i=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(i-grid_ctrl_1.gridCtrl.frameToCanvas(e))}setGridFooterFrame(e){const{end:t}=grid_ctrl_1.gridCtrl.getFrameRang(),i=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(i-grid_ctrl_1.gridCtrl.frameToCanvas(e))}moveTimeLine(e){const t=this.vm;grid_ctrl_1.gridCtrl.grid.transferX(e),t.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,t.updatePosition++,this.updatePositionInfo("move"),grid_ctrl_1.gridCtrl.grid.render(),this.vm.$refs.curve.curveCtrl&&(this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.rePaint())}scaleTimeLine(e,t){const i=this.vm,r=utils_1.smoothScale(e,grid_ctrl_1.gridCtrl.scale);e<0&&r<=grid_ctrl_1.gridCtrl.grid.xMinScale||e>0&&r>=grid_ctrl_1.gridCtrl.grid.xMaxScale||(grid_ctrl_1.gridCtrl.grid.xAxisScaleAt(t,r),i.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.rePaint(),this.updatePositionInfo(),i.updatePosition++,grid_ctrl_1.gridCtrl.grid.render())}runPointer(){const e=this.vm;this.aniPlayTask=requestAnimationFrame(async()=>{"play"===e.animationState&&e.animationMode&&!global_data_1.Flags.timeLock?(global_data_1.Flags.timeLock=!0,await this.checkCurrentTime(),global_data_1.Flags.timeLock=!1,this.runPointer()):(this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),await this.checkCurrentTime())})}setCurrentFrame(e){const t=this.vm;e<0&&(e=0),t.currentFrame=e,0!==e?this.showFrameInGrid(e):grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset!==grid_ctrl_1.gridCtrl.startOffset&&this.moveTimeLine(grid_ctrl_1.gridCtrl.startOffset-grid_ctrl_1.gridCtrl.grid.xAxisOffset)}updateCurrentFrame(e){this.setCurrentFrame(e);const t=utils_1.frameToTime(e,this.vm.sample);ipc_event_1.IsetCurEditTime(t)}jumpPrevFrame(){this.vm.currentFrame>0&&this.updateCurrentFrame(--this.vm.currentFrame)}jumpNextFrame(){this.updateCurrentFrame(++this.vm.currentFrame)}jumpFirstFrame(){this.updateCurrentFrame(0)}jumpLastFrame(){this.updateCurrentFrame(this.vm.lastFrameInfo.frame)}async nextStep(){const e=this.vm;this.isLock||(e.selectKeyInfo?this.moveSelectKeys(1,!1):e.selectEventInfo?await this.moveSelectEvents(1,!1):this.jumpNextFrame())}async prevStep(){if(this.isLock)return;const e=this.vm;e.selectKeyInfo?this.moveSelectKeys(-1,!1):e.selectEventInfo?await this.moveSelectEvents(-1,!1):this.jumpPrevFrame()}async jumpToNextKey(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath)return;let t=[];if(t=e.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath][e.selectProperty.prop].keyFrames:this.calcNodeFrames(e.computeSelectPath,!0),e.currentFrame>t[t.length-1].frame)this.updateCurrentFrame(t[t.length-1].frame);else for(const i of t)if(i.frame>e.currentFrame)return void this.updateCurrentFrame(i.frame)}async jumpToPrevKey(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath)return;let t=[];if(t=e.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath][e.selectProperty.prop].keyFrames:this.calcNodeFrames(e.computeSelectPath,!0),e.currentFrame<t[0].frame)this.updateCurrentFrame(t[0].frame);else for(let i=t.length-1;i>=0;i--){const r=t[i].frame;if(r<e.currentFrame)return void this.updateCurrentFrame(r)}}async moveSelectKeys(e,t=!1){const i=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!i.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(i.selectKeyInfo));r.offsetFrame=r.offsetFrame||0;const{keyFrames:a}=r,n=[];for(let r=0;r<a.length;r++){const o=a[r];let s=o.frame+e;if(s<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!i.selectKeyInfo.keyFrames.find(e=>e.frame===s)){const i=a[r],n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.nodePath][i.prop].keyFrames;for(;n.find(e=>e.frame===s);){let i="";if(i=t&&!this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_with_ctrl"):t&&this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_keys_with_ctrl"):Editor.I18n.t("animator.move_key_tips.should_move_keys_with_ctrl"),this.showToast(i),!t||this.hasShowStick)return;e=e>0?e+1:e-1,s=o.frame+e}}n.push(s),o.frame=s,o.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(o.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}0!==n.length&&(n.sort((e,t)=>e-t),e>0?this.showFrameInGrid(n[n.length-1]):this.showFrameInGrid(n[0]),r.ctrl=t,r.offsetFrame+=e,i.selectKeyInfo=r,await animation_ctrl_1.animationCtrl.moveKeys())}async moveSelectEvents(e,t){const i=this.vm,{data:r,frames:a}=i.selectEventInfo,n=[];for(const i of r){let r=i.frame+e;if(r<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!a.includes(r))for(;animation_ctrl_1.animationCtrl.clipsDump.events.find(e=>e.frame===r);){let n="";if(n=t&&1===a.length?"i18n:animator.move_key_tips.move_with_ctrl":t&&1!==a.length?"i18n:animator.move_key_tips.move_keys_with_ctrl":"i18n:animator.move_key_tips.should_move_keys_with_ctrl",this.showToast(n),!t||1!==a.length)return;e=e>0?e+1:e-1,r=i.frame+e}n.push(r),i.frame=r,i.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(i.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}n.sort((e,t)=>e-t),e>0?this.showFrameInGrid(n[a.length-1]):this.showFrameInGrid(n[0]),i.selectEventInfo.offsetFrame+=e,await animation_ctrl_1.animationCtrl.callByDebounce("moveEvents")}onKeyMouseMove(e){const t=this.vm,i=e.target;if(!t.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(t.selectKeyInfo)),{startX:a,keyFrames:n}=r;if(a===e.x)return;e.altKey?i.style.cursor="copy":i.style.cursor="ew-resize";const o=grid_ctrl_1.gridCtrl.pageToFrame(e.x);let s=grid_ctrl_1.gridCtrl.pageToFrame(a);s<0&&(s=0);const l=o-s;if(0===l)return;const c=grid_ctrl_1.gridCtrl.grid.valueToPixelH(o)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(s),m=[];for(const e of n){if(!e)continue;const t=e.frame+l;if(t<0)return;e.x+=c,e.frame=t,m.push(t)}r.startX+=c,r.offset+=c,r.offsetFrame+=l,global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:e.x,y:e.y,frame:n[0].frame},r.offsetFrame),t.selectKeyInfo=r,m.sort((e,t)=>e-t);const{start:p,end:d}=grid_ctrl_1.gridCtrl.getFrameRang();(m[0]<=p||m[m.length-1]>=d)&&this.moveTimeLine(-c)}onKeyMouseUp(e,t){if((t&&t.alt||e.altKey)&&this.vm.selectKeyInfo){const e=t&&t.target||this.vm.currentFrame;animation_ctrl_1.animationCtrl.pasteKey({target:e,nodePath:this.vm.selectKeyInfo.keyFrames[0].nodePath},animation_ctrl_1.animationCtrl.transSelectToCopyKeyInfo())}else animation_ctrl_1.animationCtrl.moveKeys()}onEventMouseMove(e){const t=this.vm;if(!t.selectEventInfo)return;const i=e.target;e.altKey?i.style.cursor="copy":i.style.cursor="ew-resize";const{startX:r,data:a}=t.selectEventInfo,n=grid_ctrl_1.gridCtrl.pageToFrame(e.x);let o=grid_ctrl_1.gridCtrl.pageToFrame(r);o<0&&(o=0);const s=n-o;if(0===s)return;const l=grid_ctrl_1.gridCtrl.grid.valueToPixelH(n)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(o);t.selectEventInfo.startX+=l,t.selectEventInfo.offset+=l,t.selectEventInfo.offsetFrame+=s;for(const e of a)if(e.x+=l,e.frame+=s,e.frame<0)return;this.updateMouseFrame({x:e.x,y:e.y,frame:a[0].frame},t.selectEventInfo.offsetFrame);const{start:c,end:m}=grid_ctrl_1.gridCtrl.getFrameRang();(a[0].frame<=c||a[a.length-1].frame>=m)&&this.moveTimeLine(-l)}onEventMouseUp(e){const t=grid_ctrl_1.gridCtrl.pageToFrame(e.x+grid_ctrl_1.gridCtrl.startOffset);e.altKey&&this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(t,{eventsDump:this.vm.selectEventInfo.data}):this.vm.selectEventInfo&&0===this.vm.selectEventInfo.offsetFrame||animation_ctrl_1.animationCtrl.moveEvents()}onStickMouseMove(e){const t=this.vm;if(!global_data_1.Flags.startDragStickInfo||!t.selectKeyInfo)return;const i=e.x-global_data_1.Flags.startDragStickInfo.startX;if(0!==i)switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseMove(e);break;case"right":{const e=1+i/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,a=r[0];for(let i=1;i<r.length;i++){const n=r[i];if(n.frame===a.frame)continue;let o=(n.x-a.x)*e+a.x,s=grid_ctrl_1.gridCtrl.canvasToFrame(o);s===a.frame&&(s=a.frame+(e>1?-1:1)),o=grid_ctrl_1.gridCtrl.frameToCanvas(s),this.stickInfo.width=o+12-this.stickInfo.left,t.selectKeyInfo.keyFrames[i].offsetFrame=s-t.selectKeyInfo.keyFrames[i].rawFrame,Object.assign(t.selectKeyInfo.keyFrames[i],{x:o,frame:s})}t.updateSelectKey++}break;case"left":{const e=i/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,a=r[r.length-1];for(let i=r.length-2;i>=0;i--){const n=r[i];if(n.frame===a.frame)continue;let o=(a.x-n.x)*e+n.x,s=grid_ctrl_1.gridCtrl.canvasToFrame(o);s===a.frame&&(s=a.frame+(e>1?-1:1)),o=grid_ctrl_1.gridCtrl.frameToCanvas(s),t.selectKeyInfo.keyFrames[i].offsetFrame=s-t.selectKeyInfo.keyFrames[i].rawFrame,Object.assign(t.selectKeyInfo.keyFrames[i],{x:o,frame:s})}t.updateSelectKey++}}}async update(e,t){var i;const r=this.vm;if(e===r.root&&"node-change"===t){const t=await Editor.Message.request("scene","query-node-tree",e);this.updateRoot(t);const i=await ipc_event_1.IqueryclipsMenuInfo(r.root);if(!i||i&&i.clipsMenu&&0===i.clipsMenu.length)r.clipsMenu=[],this.updateClips(null);else if(r.clipsMenu=Object.freeze(i.clipsMenu),r.currentClip!==i.defaultClip){(-1===i.clipsMenu.findIndex(e=>e.uuid===r.currentClip)&&r.animationMode||!r.animationMode)&&(i.defaultClip||(i.defaultClip=i.clipsMenu[0].uuid),await this.updateClips(i.defaultClip))}else this.calcNodes(),this.calcDisplayNodes(),this.calcDisplayClips(),r.properties=this.calcProperty(),this.checkSelectData(),r.updateKeyFrame++;return void(r.compIndex=animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.nodesDump.compIndex)}let a;if("node-change"!==t&&r.animationMode)e!==r.selectedId?r.selectedId=e:r.selectPath&&(r.selectPath="",r.properties=this.calcProperty());else if(a=await ipc_event_1.IqueryAnimationRoot(e)){console.debug("start queryAnimationRootInfo"),console.time("queryAnimationRootInfo");const t=await ipc_event_1.IqueryAnimationRootInfo(a);if(console.timeEnd("queryAnimationRootInfo"),!t.nodeTreeDump.name)return void this.updateRoot(t.nodeTreeDump);if(console.time("updateRoot"),this.updateRoot(t.nodeTreeDump),console.timeEnd("updateRoot"),r.root=t.root,r.compIndex=null===(i=animation_ctrl_1.animationCtrl.nodesDump)||void 0===i?void 0:i.compIndex,"number"==typeof r.compIndex){r.clipsMenu=Object.freeze(t.clipsMenu);const{defaultClip:i}=t;if(!(i||r.clipsMenu&&0!==r.clipsMenu.length))return this.updateClips(null),r.selectedId=e,void(r.nodeDump=Object.freeze(JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))));this.updatePlayState(t.state),"number"==typeof t.time&&0!==t.time&&this.setCurrentFrame(utils_1.timeToFrame(t.time,r.sample)),r.currentClip=t.defaultClip||t.clipsMenu[0].uuid,await this.updateClips(t.clipDump||r.currentClip,"update"),r.selectedId=e;const a=await ipc_event_1.IquerySceneMode();r.animationMode="animation"===a}else r.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes),await this.updateClips(null)}else{r.root=e;const t=await Editor.Message.request("scene","query-node-tree",e);this.updateRoot(t),r.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump?animation_ctrl_1.animationCtrl.nodesDump.nodes:null),r.compIndex=null,await this.updateClips(null),r.selectedId=e}}checkPropTypeInCopyKeyInfo(e){const t=animation_ctrl_1.animationCtrl.copyKeyInfo;if(!t)return!1;for(const i of t.curvesDump)if(i._parentType&&i._parentType.value===e.value||i.type.value===e.value)return!0;return!1}onPropTrackMenu(e,t){if(!this.vm.properties)return!1;const i=t-this.vm.$refs["property-content"].getBoundingClientRect().top+this.vm.propertyScrollInfo.top,r=Object.values(this.vm.properties).find(e=>e.top+this.LINE_HEIGHT>i&&i>e.top);if(!r)return!1;const a=grid_ctrl_1.gridCtrl.pageToFrame(e),n=[{label:Editor.I18n.t("animator.property.create_key"),accelerator:"Enter",click(){animation_ctrl_1.animationCtrl.createKey({frame:a,nodePath:r.nodePath,prop:r.prop})}}];return this.checkPropTypeInCopyKeyInfo(r.type)&&n.push({label:Editor.I18n.t("animator.property.paste_key"),click(){animation_ctrl_1.animationCtrl.pasteKey({target:a,nodePath:r.nodePath,prop:r.prop})}}),n.push({label:`frame: ${a}`}),Editor.Menu.popup({x:e,y:t,menu:n}),!0}onNodeTrackMenu(e,t){const i=t-this.vm.$refs["node-content"].getBoundingClientRect().top+this.vm.nodeScrollInfo.top;return!!this.vm.nodeDump.find(e=>e.top+this.LINE_HEIGHT>i&&i>e.top)}onStickMouseUp(e){if(2!==e.button){if(global_data_1.Flags.startDragStickInfo){switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseUp(e,{target:this.stickInfo.leftFrame});break;case"right":case"left":this.onKeyMouseUp(e)}global_data_1.Flags.startDragStickInfo=null}}else Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:[{label:Editor.I18n.t("animator.property.copy_key"),accelerator:"CmdOrCtrl+C",click(){animation_ctrl_1.animationCtrl.copyKey()}},{label:Editor.I18n.t("animator.property.remove_key"),accelerator:"Delete",click(){animation_ctrl_1.animationCtrl.removeKey()}},{label:Editor.I18n.t("animator.property.spacing_key"),async click(){animation_ctrl_1.animationCtrl.spacingKeys(exports.animationEditor.spacingFrame)}}]})}onStartResize(e,t){global_data_1.Flags.mouseDownName="resize",global_data_1.Flags.startResizeInfo={type:t,start:0};const i=e.target;i.style.cursor="left"===t?"ew-resize":"ns-resize"}onResizeMouseMove(e){if(!global_data_1.Flags.startResizeInfo)return;const t=global_data_1.Flags.startResizeInfo.type,i=global_data_1.Flags.startResizeInfo.start;let r=0;if(r="left"===t?e.x:e.y+25,!i)return void(global_data_1.Flags.startResizeInfo.start=r);global_data_1.Flags.startResizeInfo.start=r;const a="left"===t?"leftPec":"topPec",n="left"===t?this.vm.$refs.container.offsetWidth:this.vm.$refs.container.offsetHeight;let o=(parseFloat(this.vm.layout[a])/100*n||0)+r-i;o=Editor.Utils.Math.clamp(o,this.layoutConfig[`${t}Min`],this.layoutConfig[`${t}Max`]),this.vm.layout[a]=o/n*100+"%"}onResizeMouseUp(e){global_data_1.Flags.startResizeInfo=null,this.setConfig("layout",this.vm.layout),e.target.style="default"}onMouseUp(e){if(!global_data_1.Flags.mouseDownName)return void(global_data_1.Flags._startMove&&clearTimeout(global_data_1.Flags._startMove));if(!["grid","pointer","time-pointer","resize","property","key","event"].includes(global_data_1.Flags.mouseDownName)&&exports.animationEditor.isLock)return;const t=exports.animationEditor.vm;switch(e.target.style.cursor="default",global_data_1.Flags.onSelecting=!1,global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseUp(e,{target:grid_ctrl_1.gridCtrl.pageToFrame(e.x)});break;case"event":exports.animationEditor.onEventMouseUp(e);break;case"stick":exports.animationEditor.onStickMouseUp(e);break;case"resize":exports.animationEditor.onResizeMouseUp(e);break;case"time-pointer":{let i=grid_ctrl_1.gridCtrl.pageToFrame(e.x);if(i<0&&(i=0),2===e.button){const t=[{label:utils_1.T("create","event."),click(){animation_ctrl_1.animationCtrl.addEvent(i),global_data_1.Flags.mouseDownName=""}}];animation_ctrl_1.animationCtrl.copyEventInfo&&t.push({label:utils_1.T("paste","event."),accelerator:"CmdOrCtrl+V",click(){animation_ctrl_1.animationCtrl.pasteEvent(i),global_data_1.Flags.mouseDownName=""}}),Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:t})}else{t.currentFrame=i;const e=utils_1.frameToTime(i,t.sample);ipc_event_1.IsetCurEditTime(e)}}break;case"property":!t.boxInfo&&exports.animationEditor.onPropTrackMenu(e.x,e.y);break;case"grid":setTimeout(()=>{global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null},10)}t.boxInfo=null,t.boxStyle=null,t.boxData=null,global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,t.moveInfo=null}onMouseMove(e){if(!["grid","pointer","time-pointer","resize","event","key","property","node"].includes(global_data_1.Flags.mouseDownName)&&(exports.animationEditor.isLock||global_data_1.Flags.onScrolling||!e.buttons)||exports.animationEditor.vm.maskPanel)return;const t=exports.animationEditor.vm,i=e.target,{x:r,y:a}=e,n=t.$refs.gridCanvas.getBoundingClientRect();switch(global_data_1.Flags.mouseDownName&&(t.previewPointer=null),global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseMove(e);break;case"event":exports.animationEditor.onEventMouseMove(e);break;case"stick":requestAnimationFrame(()=>{exports.animationEditor.onStickMouseMove(e)});break;case"resize":requestAnimationFrame(()=>{exports.animationEditor.onResizeMouseMove(e)});break;case"grid":case"property":case"node":{if(!global_data_1.Flags.startDragGridInfo)break;i.style.cursor="-webkit-grabbing";const e=r-global_data_1.Flags.startDragGridInfo.lastStart;if(0===e)return;global_data_1.Flags.mouseDownName="grid",global_data_1.Flags.startDragGridInfo.lastStart=r,requestAnimationFrame(()=>{exports.animationEditor.moveTimeLine(e)})}break;case"pointer":{i.style.cursor="ew-resize";let r=grid_ctrl_1.gridCtrl.pageToFrame(e.x);r<0&&(r=0),t.currentFrame=r,ipc_event_1.IsetCurEditTime(utils_1.frameToTime(t.currentFrame,t.sample))}}if(!global_data_1.Flags.mouseDownName){if(r<n.x||r>n.x+n.width||a<n.y||a>n.y+n.height)return;i.style.cursor="";const e=grid_ctrl_1.gridCtrl.pageToCtrl(r,a),o=grid_ctrl_1.gridCtrl.pageToFrame(r);if(o<0)return;if(t.previewPointer&&t.previewPointer.frame===o&&t.previewPointer.y===e.y)return;return global_data_1.Flags.previewPointerTask&&clearTimeout(global_data_1.Flags.previewPointerTask),e.y+=24,e.y<32&&(e.y=32),void requestAnimationFrame(()=>{t.previewPointer={frame:o,x:e.x-grid_ctrl_1.gridCtrl.startOffset,y:e.y},global_data_1.Flags.previewPointerTask=setTimeout(()=>{t.previewPointer=null},1e3)})}["node","property"].includes(global_data_1.Flags.mouseDownName)&&0===e.button&&(global_data_1.Flags.onSelecting=!0,requestAnimationFrame(()=>{t.boxInfo&&(t.boxInfo.x=e.x,t.boxInfo.y=e.y,t.boxStyle=exports.animationEditor.calcBoxStyle())}))}checkSelectData(){this.checkSelectProperty(),this.checkSelectEvents(),this.checkSelectKeys()}checkSelectProperty(){const e=this.vm;e.selectProperty&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid).includes(e.selectProperty.nodePath)&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath][e.selectPropData.prop]||(e.selectProperty=null))}checkSelectEvents(){const e=this.vm;if(!e.selectEventInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.events)return void(e.selectEventInfo=null);const t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>e.frame);if(!t.length)return void(e.selectEventInfo=null);const i=[];for(const r of e.selectEventInfo.frames){-1!==t.indexOf(r)&&i.push(r)}0===i.length?e.selectEventInfo=null:e.selectEventInfo.frames=i}checkSelectKeys(){const e=this.vm;if(!e.selectKeyInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump)return void(e.selectKeyInfo=null);const t=[];if(e.selectKeyInfo.keyFrames.forEach((i,r)=>{if(!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.nodePath][i.prop])return;const a=e.selectKeyInfo.keyFrames[r];animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.nodePath][i.prop].keyFrames.map(e=>e.frame).includes(a.frame)&&(a.rawFrame=i.frame,delete a.offsetFrame,t.push(a))}),0===t.length)return void(e.selectKeyInfo=null);const i=utils_1.sortKeysToTreeMap(t);Object.assign(e.selectKeyInfo,{keyFrames:t,sortDump:i,offsetFrame:0,offset:0,startX:e.selectKeyInfo.startX}),e.updateSelectKey++}resetState(){const e=this.vm;this.updateClips(null),e.compIndex=null,e.animationMode=!1,e.clipConfig=null,e.nodeDump=null}async updateSelectedId(){const e=this.vm;if(!e.selectedId&&e.animationMode)return;if(e.selectedId?(e.propertiesMenu=await ipc_event_1.IqueryPropertieMenu(e.selectedId),console.debug("propertiesMenu",e.selectedId,e.propertiesMenu.length)):(e.root="",this.resetState(),e.propertiesMenu=null),e.properties=this.calcProperty(),!animation_ctrl_1.animationCtrl.nodesDump)return;const t=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,i=t.findIndex(t=>t.uuid===e.selectedId&&"number"==typeof t.listIndex);if(-1===i)return;const r=t[i].listIndex*this.LINE_HEIGHT,{top:a,height:n}=e.nodeScrollInfo;(r-a>n||r-a<0)&&(e.nodeScrollInfo.top=r-n/2,this.calcDisplayNodes(),this.calcDisplayClips())}calcBoxStyle(){const e=this.vm;if(!e.boxInfo||!e.boxInfo.type)return null;const{startX:t,startY:i,type:r,x:a,y:n}=e.boxInfo,o=grid_ctrl_1.gridCtrl.pageToCtrl(a,n),{offsetTop:s,offsetHeight:l,offsetWidth:c}=e.$refs[`${r}-content`],m=Editor.Utils.Math.clamp(o.x,0,c),p=Editor.Utils.Math.clamp(o.y,s,s+l),d=t-m,u=i-p;if(!d||!u)return null;const f={};return d>0&&u>0?(f.x=m,f.y=p-s):d<0&&u<0?(f.x=t,f.y=i-s):d<0&&u>0?(f.x=t,f.y=p-s):d>0&&u<0&&(f.x=m,f.y=i-s),e.boxData={origin:f,w:Math.abs(d),h:Math.abs(u),type:e.boxInfo.type},{top:`${f.y}px`,left:`${f.x}px`,right:`${Math.round(c-f.x-Math.abs(d))}px`,bottom:`${Math.round(l-f.y-Math.abs(u))}px`}}updatePlayState(e){const t=this.vm;switch(e){case 0:t.animationState="stop",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),this.checkCurrentTime();break;case 1:if("play"!==animation_ctrl_1.animationCtrl.animationState){console.debug(`Invalid animation state change. (${animation_ctrl_1.animationCtrl.animationState} -> play))`);break}"play"!==t.animationState&&(t.animationState="play",this.runPointer());break;case 2:t.animationState="pause",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask)}}async checkCurrentTime(){const e=this.vm,t=await ipc_event_1.IqueryPlayingClipTime(e.currentClip),i=utils_1.timeToFrame(t,e.sample);i!==e.currentFrame&&this.setCurrentFrame(i)}updateRoot(e){const t=this.vm;if(e){if(""===e.name||e.isScene)return t.selectedId="",t.root="",t.nodeDump=null,animation_ctrl_1.animationCtrl.clipsDump=null,void(animation_ctrl_1.animationCtrl.nodesDump=null);animation_ctrl_1.animationCtrl.nodesDump=utils_1.formatNodeDump(e),t.nodeDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes)),t.compIndex=animation_ctrl_1.animationCtrl.nodesDump.compIndex}}async updateClips(e,t){const i=this.vm;if(i.nodeDump&&!i.active)return void this.clearClips();if(!e)return void this.clearClips();let r=e;if("string"==typeof e){if(i.currentClip===e&&"update"!==t)return;if(console.time("IqueryClipDump"),r=await ipc_event_1.IqueryClipDump(i.root,e),console.timeEnd("IqueryClipDump"),!r&&!global_data_1.Flags.sceneReady)return void exports.animationEditor.refreshTask++;if(!r)return console.warn(`Get animation clip data failed! node ${i.root}, clip ${i.currentClip}`),void this.clearClips();i.currentClip=e}if(r){if(animation_ctrl_1.animationCtrl.clipsDump=Object.assign(utils_1.formatClipDump(r),{uuid:i.currentClip}),r.sample!==grid_ctrl_1.gridCtrl.grid.sample&&(grid_ctrl_1.gridCtrl.grid.sample=r.sample,grid_ctrl_1.gridCtrl.grid.render()),Object.keys(animation_ctrl_1.animationCtrl.clipConfig).forEach(e=>{var t;animation_ctrl_1.animationCtrl.clipConfig[e]=null!==(t=animation_ctrl_1.animationCtrl.clipsDump[e])&&void 0!==t?t:animation_ctrl_1.animationCtrl.clipConfig[e]}),i.clipConfig=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.clipConfig)),i.clipConfig&&i.clipConfig.duration){const e=Math.min(i.$refs.chart.offsetWidth/(i.clipConfig.duration*i.clipConfig.sample*2),this.gridCtrl.grid.xMinScale),t=Math.max(i.clipConfig.duration*i.clipConfig.sample,this.gridCtrl.grid.xMaxScale);this.gridCtrl.grid.updateScale(e,t)}await i.calcSelectProperty(null,!0)}this.calcEventsDump(),this.calcNodes(),this.calcDisplayNodes(),this.calcDisplayClips(),i.properties=this.calcProperty(),this.checkSelectData(),i.updateKeyFrame++}async clearClips(){const e=this.vm;e.currentClip="",animation_ctrl_1.animationCtrl.exit(),animation_ctrl_1.animationCtrl.clipsDump=null,e.clipConfig=null,e.eventsDump=null,this.calcDisplayNodes(),e.properties=this.calcProperty(),this.checkSelectData(),e.updateKeyFrame++}calcProperty(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath||!grid_ctrl_1.gridCtrl.grid)return null;let t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath];if(!t)return null;t=JSON.parse(JSON.stringify(t));let i=0;return Object.keys(t).forEach((r,a)=>{const n=t[r];let o=n;if("string"==typeof t[r].parentPropKey){const a=(o=t[t[r].parentPropKey]).partKeys.findIndex(e=>e===n.prop);-1!==a&&n.isCurveSupport&&(n.color=exports.CurveColorList[a]),!0!==e.expandInfo[o.prop]?(e.expandInfo[o.prop]=!1,t[r].hidden=!0):i++}else i++,n.type&&n.isCurveSupport&&(n.color=exports.CurveColorList[3]);t[r].index=Math.max(0,i-1),t[r].top=(i-1)*this.LINE_HEIGHT,e.propertiesMenu&&!utils_1.checkPropertyInMenu(o,e.propertiesMenu)&&(t[r].missing=!0),n.keyFrames=Object.freeze(calcFrames(n.keyFrames,e.$refs.chart.offsetWidth,this.imageCCTypes.includes(n.type&&n.type.value)))}),t}calcEventsDump(){const e=this.vm;let t=[];return animation_ctrl_1.animationCtrl.clipsDump&&grid_ctrl_1.gridCtrl.grid&&(t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>(e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,e))),e.eventsDump=Object.freeze(t)}calcNodes(){if(!animation_ctrl_1.animationCtrl.nodesDump)return null;if(!animation_ctrl_1.animationCtrl.clipsDump)return;const e=JSON.parse(JSON.stringify(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid)));function t(i,r=!1){const a=i.match(/\//g);if(!a)return;const n=a.length;let o=e.findIndex(e=>!!e.match(/\//g)&&e.match(/\//g).length===n);const s=i.match(/\/([^\/]*)$/);if(s){if(0===o&&(o=1),-1===o){o=e.length;const a=i.match(/\/([^\/]+)/g);if(a&&!r){let i="";for(const r of a)i+=r,e.includes(i)||t(i,!0);return}}e.splice(o,0,i),animation_ctrl_1.animationCtrl.nodesDump.nodesDump.splice(o,0,{indent:2*n,path:i,name:s[1],uuid:"",keyFrames:[],top:0,rawIndex:o,listIndex:o})}}animation_ctrl_1.animationCtrl.nodesDump.nodesDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes));for(const i of Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump))-1===e.indexOf(i)&&t(i)}calcDisplayNodes(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.nodesDump)return void(e.nodeDump=null);const t=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,i=[];let r=-1;const a=e.filterInvalid||e.filterName;t.forEach((t,n)=>{if(delete t.listIndex,delete t.top,delete t.rawIndex,a){if(!hasKeyData(t.path)&&e.filterInvalid)return;if(e.filterName&&!new RegExp(e.filterName,"i").test(t.name))return;r++}else r=n;const o=r*this.LINE_HEIGHT-e.nodeScrollInfo.top;t.top=r*this.LINE_HEIGHT,t.rawIndex=n,t.listIndex=r,o>-this.LINE_HEIGHT&&o<e.nodeScrollInfo.height+this.LINE_HEIGHT&&i.push(t)});const n=a?r*this.LINE_HEIGHT:t.length*this.LINE_HEIGHT;e.nodesHeight=Math.floor(n),animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump=i,e.nodeDump=i,Math.abs(e.nodeScrollInfo.top-e.$refs.nodes.scrollTop)>this.LINE_HEIGHT&&(e.$refs.nodes.scrollTop=e.nodeScrollInfo.top)}calcDisplayClips(){const e=this.vm;if(!e.nodeDump||!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return void(e.clipConfig=null);const t=Object.create(null);animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump.forEach(e=>{t[e.path]=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.path],!e.disabled&&t[e.path]&&(e.keyFrames=Object.freeze(JSON.parse(JSON.stringify(this.calcNodeFrames(e.path)))))}),e.nodeDump=animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump,animation_ctrl_1.animationCtrl.clipsDump.displayClipsDump=t}calcNodeFrames(e,t=!1){const i=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump)return[];const r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e];if(!r)return[];let a=[];for(const e of Object.keys(r)){const t=calcFrames(r[e].keyFrames,i.$refs.chart.offsetWidth,!1);a=a.concat(t)}return t&&0!==a.length&&a.sort((e,t)=>e.frame-t.frame),a}async _refresh(){const e=this.vm,t={w:e.$refs.right.offsetWidth,h:e.$refs.right.offsetHeight};if(!t.w||!t.h)return void(global_data_1.Flags.domReady=!1);if(!this.refreshTask&&global_data_1.Flags.domReady&&e.$refs.gridCanvas.width===t.w&&e.$refs.gridCanvas.height===t.h)return void(e.loading="");e.loading="init_animation_data",global_data_1.Flags.domReady=!0,e.nodeScrollInfo={size:t,height:e.$refs["node-content"].offsetHeight,top:e.$refs.nodes.scrollTop},e.propertyScrollInfo={size:t,height:e.$refs["property-content"].offsetHeight,top:0};const i=Editor.Selection.getLastSelected("node"),r=await ipc_event_1.IquerySceneMode();if(e.animationMode="animation"===r,await this.vmInit(),i)console.debug("update"),console.time("update"),await this.debounceUpdateNode(i),console.timeEnd("update");else if(e.animationMode){const{rootid:e,clipid:t}=await ipc_event_1.IgetEditAnimationInfo(),i=await Editor.Message.request("scene","query-node-tree",e);console.time("updateRoot"),await this.updateRoot(i),console.timeEnd("updateRoot"),console.time("updateClips"),await this.updateClips(t),console.timeEnd("updateClips")}else this.resetState();await this.updateSelectedId(),e.loading="",global_data_1.Flags.sceneReady=!0,this.refreshTask=0}resize(){const e=this.vm;if(!e.$refs.right)return void(global_data_1.Flags.domReady=!1);const{offsetWidth:t,offsetHeight:i}=e.$refs.right;e.$refs.chart.style.width=`${t}px`;const r={w:e.$refs.right.offsetWidth,h:e.$refs.right.offsetHeight};grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.resize(t,i),e.nodeScrollInfo={size:r,height:e.$refs["node-content"].offsetHeight,top:e.$refs.nodes.scrollTop},e.propertyScrollInfo={size:r,height:e.$refs["property-content"].offsetHeight,top:0},requestAnimationFrame(()=>{this.calcDisplayNodes(),this.calcDisplayClips(),this.vm.updateKeyFrame++,e.$refs.curve.rePaint()})}exit(){this.closeMaskPanel(),this.vm.moveNodePath="",this.vm.selectKeyInfo=null,this.vm.selectEventInfo=null,this.vm.selectProperty=null,this._curveData=null,this.vm.showAnimCurve&&this.vm.toggleAniCurve(),this.updateCurrentFrame(0),animation_ctrl_1.animationCtrl.clear()}close(){utils_1.removeEventListener(document,"mouseup",this.onMouseUp),utils_1.removeEventListener(document,"mousemove",this.onMouseMove)}}function calcFrames(e,t,i){if(!e)return[];const r=[];function a(e){return i?{x:e.x,prop:e.prop,frame:e.frame,value:e.dump.value&&e.dump.value.uuid}:{x:e.x,prop:e.prop,frame:e.frame}}const n={maxNegative:{distance:-1/0,index:-1},minPositive:{index:-1,distance:1/0}};var o;return e.forEach((e,i)=>{e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset;const s=(o=e.x)+grid_ctrl_1.gridCtrl.grid.xAxisOffset>t?o+grid_ctrl_1.gridCtrl.grid.xAxisOffset-t:o+grid_ctrl_1.gridCtrl.grid.xAxisOffset<0?o+grid_ctrl_1.gridCtrl.grid.xAxisOffset:0;0!==s?s>0&&n.minPositive.distance>s?(n.minPositive.distance=s,n.minPositive.index=i):s<0&&n.maxNegative.distance<s&&(n.maxNegative.distance=s,n.maxNegative.index=i):r.push(a(e))}),r.length!==e.length&&(-1!==n.maxNegative.index&&r.push(a(e[n.maxNegative.index])),-1!==n.minPositive.index&&r.push(a(e[n.minPositive.index]))),r}function hasKeyData(e){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e])return!1;for(const t of Object.values(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e]))if(0!==t.keyFrames.length)return!0;return!1}exports.animationEditor=new AnimationEditor,exports.calcFrames=calcFrames;