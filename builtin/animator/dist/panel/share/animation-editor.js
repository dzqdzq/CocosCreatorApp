"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcFrames=exports.animationEditor=void 0;const utils_1=require("../utils"),animation_ctrl_1=require("./animation-ctrl"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),Lodash=require("lodash");class AnimationEditor{constructor(){this.panel=null,this.LINE_HEIGHT=24,this.imageCCTypes=["cc.SpriteFrame","cc.Texture2D"],this.gridCtrl=grid_ctrl_1.gridCtrl,this.refreshTask=0,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this.hasShowStick=!1,this.layoutConfig={topMin:24,leftMin:100,topMax:500,leftMax:500},this.vm=null,this.updateSelectQueue=[]}get isLock(){return!this.vm||(!this.vm||!this.vm.animationMode||this.vm.lock||this.vm.maskPanel)}setConfig(t,e){Editor.Profile.setConfig("animator",t,e,"global")}async getConfig(t){return await Editor.Profile.getConfig("animator",t)}init(t){this.vm=t,this.debounceUpdateState=require("lodash").debounce(t.updateState,300),this.debounceUpdateNode=require("lodash").debounce(t.update,300),this.debounceFilterNode=require("lodash").debounce(this.FilterNode,300),utils_1.addEventListenerOnce(document,"mouseup",this.onMouseUp),utils_1.addEventListenerOnce(document,"mousemove",this.onMouseMove)}FilterNode(t){this.vm.filterName=t,this.calcDisplayNodes()}updateLayoutConfig(){this.layoutConfig.topMax=this.panel.clientHeight-100,this.layoutConfig.leftMax=this.panel.clientWidth-100}hideNodes(){this.vm.$refs.nodes.style="height: 24px; flex: unset;",this.vm.$refs["node-content"].style="height: 24px; flex: unset;"}showToast(t,e=1e3){this.vm.toast.message=t,global_data_1.Flags.tipsTimer&&clearTimeout(global_data_1.Flags.tipsTimer),global_data_1.Flags.tipsTimer=setTimeout(()=>{this.vm.toast.message=""},e)}changeSpacingFrame(t){this.setConfig("spacingFrame",t),this.vm.spacingFrame=t}updatePositionInfo(t){const e=this.vm;if(e.previewPointer&&(e.previewPointer=null),e.nodeDump&&animation_ctrl_1.animationCtrl.clipsDump&&(e.nodeDump.forEach(t=>{t.keyFrames=Object.freeze(this.calcNodeFrames(t.path))}),e.properties&&(e.properties=this.calcProperty()),e.updateKeyFrame++),"move"!==t){if(e.selectKeyInfo){for(const t of e.selectKeyInfo.data)t&&(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset);e.updateSelectKey++}if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events&&this.calcEventsDump(),e.selectEventInfo)for(const t of e.selectEventInfo.data)t&&(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset)}}resetSelectedKeyInfo(){if(!this.selectKeyInfo)return;const t=JSON.parse(JSON.stringify(this.selectKeyInfo));t.offsetFrame=0,t.offset=0,delete t.sortDump,t.data.forEach((e,a)=>{t.params[a].frame=e.frame,delete t.params[a].offsetFrame}),t.frames=t.params.map(t=>t.frame),t.sortDump=utils_1.sortSelectParams(t.params),this.selectKeyInfo=t}clearSelectData(){if(this.vm.selectEventInfo||this.vm.selectKeyInfo)return this.vm.selectEventInfo=null,void(this.vm.selectKeyInfo=null);this.vm.selectProperty&&(this.vm.selectProperty=null)}copy(){this.isLock||(this.vm.selectKeyInfo?animation_ctrl_1.animationCtrl.copyKey():this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectProperty?animation_ctrl_1.animationCtrl.copyProp(this.vm.selectProperty):this.vm.selectedId&&animation_ctrl_1.animationCtrl.copyNodeData([animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId]]))}paste(){exports.animationEditor.isLock||(animation_ctrl_1.animationCtrl.getClipBoardData("key")?animation_ctrl_1.animationCtrl.pasteKey({target:this.vm.currentFrame,nodePath:this.vm.computeSelectPath},animation_ctrl_1.animationCtrl.getClipBoardData("key")):animation_ctrl_1.animationCtrl.getClipBoardData("event")?animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):this.vm.selectProperty&&animation_ctrl_1.animationCtrl.getClipBoardData("prop")?animation_ctrl_1.animationCtrl.pasteProp(this.vm.selectProperty,animation_ctrl_1.animationCtrl.getClipBoardData("prop")):this.vm.selectedId&&animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("node")))}updateSelectKey(t){const e=this.vm;let a=JSON.parse(JSON.stringify(e.selectKeyInfo));if(!a){if(!t)return;a={}}if(!a.sortDump){if(!t.nodePath)return;a.sortDump={}}const{nodePath:r,prop:i}=t,n=r+i;if(!a.sortDump[n]&&!t.data||!i)return;const o=t.params?t.params.map(t=>t.frame):[];a.sortDump[n]={data:t.data,params:t.params,prop:i,nodePath:r,frames:o},t.data&&t.params||delete a.sortDump[n];let s=[],l=[];Object.keys(a.sortDump).map(t=>{const e=a.sortDump[t];e.data&&e.params||delete a.sortDump[t],s=s.concat(e.data),l=l.concat(e.params)}),a.data=s.sort((t,e)=>t.frame-e.frame),a.params=l.sort((t,e)=>t.frame-e.frame),e.selectKeyInfo=a}getPositionAtSelect(t){return this.vm.selectKeyInfo?this.vm.selectKeyInfo.params.findIndex(e=>e.prop===t.prop&&e.frame===t.frame&&e.nodePath===t.nodePath):-1}removeSelectKey(t){if(!this.vm.selectKeyInfo||!this.vm.selectKeyInfo.params)return!1;const e=JSON.parse(JSON.stringify(this.vm.selectKeyInfo));this.vm.selectKeyInfo.params.forEach((a,r)=>{t.find(t=>Lodash.isEqual(a,t))&&(e.data.splice(r,1),e.params.splice(r,1))}),delete e.sortDump,this.vm.selectKeyInfo=e}openBezierEditor(t){this.vm.currentBezierData=t,this.vm.maskPanel="bezier"}openEventEditor(t){this.vm.editEventFrame=t,this.vm.maskPanel="event"}closeMaskPanel(){this.vm.maskPanel=""}setMovePath(t){this.vm.moveNodePath=t}cancelMoveNode(){this.vm.moveNodePath=null}selectNode(t,e=!1){if(!animation_ctrl_1.animationCtrl.nodesDump)return;const a=this.vm,r=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[t];if(r){const t=[r[0]];t[0]!==a.selectedId&&e&&t.push(a.selectedId),Editor.Selection.update("node",t)}else a.selectPath=t,a.properties=this.calcProperty(),a.selectedId="",a.selectedIds.clear()}startMoveNode(t){this.vm.moveNodePath=t}startDragKey(t,e=!1){if(!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return;const a=this.vm;if(t){const e=t.data.map((e,a)=>Object.assign(Object.assign({newFrame:e.frame},e),t.params[a]));e.sort((t,e)=>t.frame-e.frame),t.data=e.map(t=>({frame:t.newFrame,prop:t.prop,x:t.x,value:t.value})),t.params=e.map(t=>({frame:t.frame,prop:t.prop,nodePath:t.nodePath})),t.sortDump=utils_1.sortSelectParams(t.params)}if(a.selectKeyInfo=t,a.updateSelectKey++,e)return;global_data_1.Flags.mouseDownName="key";const r=a.selectKeyInfo.params[0];if(r.nodePath!==a.computeSelectPath){const t=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[r.nodePath];t[0]!==a.selectedId&&(Editor.Selection.unselect("node",a.selectedId),Editor.Selection.select("node",t[0]))}}async updateSelectProperty(t){const e=this.vm,a=await ipc_event_1.IgetPropValueAtFrame(e.currentClip,t.nodePath,t.prop,e.currentFrame);a&&(e.selectProperty=Object.assign(t,{value:a&&a.value,type:{value:a.type,extends:a.extends}}))}startDragEvent(t,e=!1){this.vm.selectEventInfo=t,e?"event"===global_data_1.Flags.mouseDownName&&(global_data_1.Flags.mouseDownName=""):global_data_1.Flags.mouseDownName="event"}updateMouseFrame(t,e){const a=this.vm;if(!t||!t.x&&!t.y)return void(a.moveInfo=null);const r=grid_ctrl_1.gridCtrl.pageToCtrl(t.x,t.y);a.moveInfo?(a.moveInfo.x=r.x+5,a.moveInfo.y=r.y+5,a.moveInfo.offsetFrame=e||0):a.moveInfo={x:r.x+5,y:r.y+5,offsetFrame:e||0},a.moveInfo&&(a.moveInfo.frame=t.frame||grid_ctrl_1.gridCtrl.pageToFrame(t.x))}updatePropExpandState(t,e){const a=this.vm;a.expandInfo[t]=e;const r=a.properties[t].partKeys;r?(r.forEach(t=>{a.properties[t].hidden=!e}),a.properties=this.calcProperty(),requestAnimationFrame(()=>{a.updateSelectKey++})):console.log(`[Animation Editor] Can't get partKeys of prop(${t})`)}showFrameInGrid(t){const{start:e,end:a}=grid_ctrl_1.gridCtrl.getFrameRang();t>=a?exports.animationEditor.setGridHeaderFrame(t):t<=e&&exports.animationEditor.setGridFooterFrame(t)}setGridHeaderFrame(t){const{start:e}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(e);this.vm.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(t))}setGridFooterFrame(t){const{end:e}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(e);this.vm.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(t))}updateCurrentFrame(t){const e=this.vm;e.setCurrentFrame(t);const a=utils_1.frameToTime(t,e.sample);ipc_event_1.IsetCurEditTime(a)}jumpPrevFrame(){this.vm.currentFrame>0&&this.updateCurrentFrame(--this.vm.currentFrame)}jumpNextFrame(){this.updateCurrentFrame(++this.vm.currentFrame)}jumpFirstFrame(){this.updateCurrentFrame(0)}jumpLastFrame(){this.updateCurrentFrame(this.vm.lastFrameInfo.frame)}async nextStep(){const t=this.vm;this.isLock||(t.selectKeyInfo?exports.animationEditor.moveSelectKeys(1,!1):t.selectEventInfo?await exports.animationEditor.moveSelectEvents(1,!1):exports.animationEditor.jumpNextFrame())}async prevStep(){if(exports.animationEditor.isLock)return;const t=exports.animationEditor.vm;t.selectKeyInfo?exports.animationEditor.moveSelectKeys(-1,!1):t.selectEventInfo?await exports.animationEditor.moveSelectEvents(-1,!1):exports.animationEditor.jumpPrevFrame()}async jumpToNextKey(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath)return;let e=[];if(e=t.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath][t.selectProperty.prop].keyFrames:this.calcNodeFrames(t.computeSelectPath,!0),t.currentFrame>e[e.length-1].frame)this.updateCurrentFrame(e[e.length-1].frame);else for(const a of e)if(a.frame>t.currentFrame)return void this.updateCurrentFrame(a.frame)}async jumpToPrevKey(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath)return;let e=[];if(e=t.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath][t.selectProperty.prop].keyFrames:this.calcNodeFrames(t.computeSelectPath,!0),t.currentFrame<e[0].frame)this.updateCurrentFrame(e[0].frame);else for(let a=e.length-1;a>=0;a--){const r=e[a].frame;if(r<t.currentFrame)return void this.updateCurrentFrame(r)}}async moveSelectKeys(t,e=!1){if(!animation_ctrl_1.animationCtrl.clipsDump)return;const a=this.vm,r=JSON.parse(JSON.stringify(a.selectKeyInfo));r.offsetFrame=r.offsetFrame||0;const{data:i,params:n}=r,o=[];for(let r=0;r<i.length;r++){const s=i[r];let l=s.frame+t;if(l<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!a.selectKeyInfo.data.find(t=>t.frame===l)){const a=n[r],i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath][a.prop].keyFrames;for(;i.find(t=>t.frame===l);){let a="";if(a=e&&!this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_with_ctrl"):e&&this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_keys_with_ctrl"):Editor.I18n.t("animator.move_key_tips.should_move_keys_with_ctrl"),this.showToast(a),!e||this.hasShowStick)return;t=t>0?t+1:t-1,l=s.frame+t}}o.push(l),s.frame=l,s.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(s.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}0!==o.length&&(o.sort((t,e)=>t-e),t>0?this.showFrameInGrid(o[o.length-1]):this.showFrameInGrid(o[0]),r.ctrl=e,r.offsetFrame+=t,a.selectKeyInfo=r,await animation_ctrl_1.animationCtrl.moveKeys())}async moveSelectEvents(t,e){const a=this.vm,{data:r,frames:i}=a.selectEventInfo,n=[];for(const a of r){let r=a.frame+t;if(r<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!i.includes(r))for(;animation_ctrl_1.animationCtrl.clipsDump.events.find(t=>t.frame===r);){let n="";if(n=e&&1===i.length?"i18n:animator.move_key_tips.move_with_ctrl":e&&1!==i.length?"i18n:animator.move_key_tips.move_keys_with_ctrl":"i18n:animator.move_key_tips.should_move_keys_with_ctrl",this.showToast(n),!e||1!==i.length)return;t=t>0?t+1:t-1,r=a.frame+t}n.push(r),a.frame=r,a.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(a.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}n.sort((t,e)=>t-e),t>0?this.showFrameInGrid(n[i.length-1]):this.showFrameInGrid(n[0]),a.selectEventInfo.offsetFrame+=t,await animation_ctrl_1.animationCtrl.callByDebounce("moveEvents")}onKeyMouseMove(t){const e=this.vm,a=t.target;if(!e.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(e.selectKeyInfo)),{startX:i,data:n}=r;if(i===t.x)return;t.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const o=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let s=grid_ctrl_1.gridCtrl.pageToFrame(i);s<0&&(s=0);const l=o-s;if(0===l)return;const m=grid_ctrl_1.gridCtrl.grid.valueToPixelH(o)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(s),c=[];for(const t of n){if(!t)continue;let e=t.frame+l;if(e<0)return;t.x+=m,t.frame=e,c.push(e)}r.startX+=m,r.offset+=m,r.offsetFrame+=l,global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:t.x,y:t.y,frame:n[0].frame},r.offsetFrame),e.selectKeyInfo=r,c.sort((t,e)=>t-e);const{start:p,end:d}=grid_ctrl_1.gridCtrl.getFrameRang();(c[0]<=p||c[c.length-1]>=d)&&this.vm.moveTimeLine(-m)}onKeyMouseUp(t,e){if((e&&e.alt||t.altKey)&&this.vm.selectKeyInfo){let t=e&&e.target||this.vm.currentFrame;animation_ctrl_1.animationCtrl.pasteKey({target:t,nodePath:this.vm.selectKeyInfo.params[0].nodePath},animation_ctrl_1.animationCtrl.transSelectToCopyKeyInfo())}else animation_ctrl_1.animationCtrl.moveKeys()}onEventMouseMove(t){const e=this.vm;if(!e.selectEventInfo)return;const a=t.target;t.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const{startX:r,data:i}=e.selectEventInfo,n=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let o=grid_ctrl_1.gridCtrl.pageToFrame(r);o<0&&(o=0);const s=n-o;if(0===s)return;const l=grid_ctrl_1.gridCtrl.grid.valueToPixelH(n)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(o);e.selectEventInfo.startX+=l,e.selectEventInfo.offset+=l,e.selectEventInfo.offsetFrame+=s;for(const t of i)if(t.x+=l,t.frame+=s,t.frame<0)return;this.updateMouseFrame({x:t.x,y:t.y,frame:i[0].frame},e.selectEventInfo.offsetFrame);const{start:m,end:c}=grid_ctrl_1.gridCtrl.getFrameRang();(i[0].frame<=m||i[i.length-1].frame>=c)&&this.vm.moveTimeLine(-l)}onEventMouseUp(t){const e=grid_ctrl_1.gridCtrl.pageToFrame(t.x+grid_ctrl_1.gridCtrl.startOffset);t.altKey?animation_ctrl_1.animationCtrl.pasteEvent(e,this.vm.selectEventInfo):0!==this.vm.selectEventInfo.offsetFrame&&animation_ctrl_1.animationCtrl.moveEvents()}onStickMouseMove(t){const e=this.vm;if(!global_data_1.Flags.startDragStickInfo)return;const a=t.x-global_data_1.Flags.startDragStickInfo.startX;if(0!==a)switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseMove(t);break;case"right":{const t=1+a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,i=r[0],n=Object.create(null);for(let a=1;a<r.length;a++){const o=r[a];if(o.frame===i.frame){n[o.prop]?n[o.prop].push(o.frame):n[o.prop]=[o.frame];continue}let s=(o.x-i.x)*t+i.x,l=grid_ctrl_1.gridCtrl.canvasToFrame(s);n[o.prop]&&(n[o.prop].includes(l)&&(l+=t>1?-1:1),n[o.prop]=[]),l===i.frame&&(l=i.frame+(t>1?-1:1)),n[o.prop]=[l],s=grid_ctrl_1.gridCtrl.frameToCanvas(l),this.stickInfo.width=s+12-this.stickInfo.left,e.selectKeyInfo.params[a].offsetFrame=l-e.selectKeyInfo.params[a].frame,Object.assign(e.selectKeyInfo.data[a],{x:s,frame:l})}e.updateSelectKey++}break;case"left":{const t=a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,i=r[r.length-1],n=Object.create(null);for(let a=r.length-2;a>=0;a--){const o=r[a];if(o.frame===i.frame){n[o.prop]?n[o.prop].push(o.frame):n[o.prop]=[o.frame];continue}let s=(i.x-o.x)*t+o.x,l=grid_ctrl_1.gridCtrl.canvasToFrame(s);n[o.prop]&&(n[o.prop].includes(l)&&(l+=t>1?-1:1),n[o.prop]=[]),l===i.frame&&(l=i.frame+(t>1?-1:1)),n[o.prop]=[l],s=grid_ctrl_1.gridCtrl.frameToCanvas(l),e.selectKeyInfo.params[a].offsetFrame=l-e.selectKeyInfo.params[a].frame,Object.assign(e.selectKeyInfo.data[a],{x:s,frame:l})}e.updateSelectKey++}}}onStickMouseUp(t){if(global_data_1.Flags.startDragStickInfo){switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseUp(t,{target:this.stickInfo.leftFrame});break;case"right":case"left":this.onKeyMouseUp(t)}global_data_1.Flags.startDragStickInfo=null}}onStartResize(t,e){global_data_1.Flags.mouseDownName="resize",global_data_1.Flags.startResizeInfo={type:e,start:0};const a=t.target;a.style.cursor="left"===e?"ew-resize":"ns-resize"}onResizeMouseMove(t){if(!global_data_1.Flags.startResizeInfo)return;const e=global_data_1.Flags.startResizeInfo.type,a=global_data_1.Flags.startResizeInfo.start;let r=0;if(r="left"===e?t.x:t.y+25,!a)return void(global_data_1.Flags.startResizeInfo.start=r);global_data_1.Flags.startResizeInfo.start=r;const i="left"===e?this.vm.$refs.container.offsetWidth:this.vm.$refs.container.offsetHeight;let n=(parseFloat(this.vm.layout[e+"Pec"])/100*i||0)+r-a;n=Editor.Utils.Math.clamp(n,this.layoutConfig[`${e}Min`],this.layoutConfig[`${e}Max`]),this.vm.layout[e+"Pec"]=n/i*100+"%"}onResizeMouseUp(t){global_data_1.Flags.startResizeInfo=null,this.setConfig("layout",this.vm.layout),t.target.style="default"}onMouseUp(t){if(!["grid","pointer","time-pointer","resize"].includes(global_data_1.Flags.mouseDownName)&&exports.animationEditor.isLock)return;const e=exports.animationEditor.vm;if(t.target.style.cursor="default",global_data_1.Flags.mouseDownName){switch(e.boxInfo=null,e.boxStyle=null,e.boxData=null,global_data_1.Flags.onSelecting=!1,global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseUp(t,{target:grid_ctrl_1.gridCtrl.pageToFrame(t.x)});break;case"event":exports.animationEditor.onEventMouseUp(t);break;case"stick":exports.animationEditor.onStickMouseUp(t);break;case"resize":exports.animationEditor.onResizeMouseUp(t);break;case"time-pointer":let a=grid_ctrl_1.gridCtrl.pageToFrame(t.x);a<0&&(a=0),e.currentFrame=a;const r=utils_1.frameToTime(a,e.sample);ipc_event_1.IsetCurEditTime(r);break;case"grid":return void setTimeout(()=>{global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null},10)}global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,e.moveInfo=null}else global_data_1.Flags._startMove&&clearTimeout(global_data_1.Flags._startMove)}onMouseMove(t){if(!["grid","pointer","time-pointer","resize"].includes(global_data_1.Flags.mouseDownName)&&(exports.animationEditor.isLock||global_data_1.Flags.onScrolling||!t.buttons))return;const e=exports.animationEditor.vm,a=t.target,{x:r,y:i}=t,n=e.$refs.gridCanvas.getBoundingClientRect();switch(global_data_1.Flags.mouseDownName&&(e.previewPointer=null),global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseMove(t);break;case"event":exports.animationEditor.onEventMouseMove(t);break;case"stick":requestAnimationFrame(()=>{exports.animationEditor.onStickMouseMove(t)});break;case"resize":requestAnimationFrame(()=>{exports.animationEditor.onResizeMouseMove(t)});break;case"grid":a.style.cursor="-webkit-grabbing";const i=r-global_data_1.Flags.startDragGridInfo.lastStart;if(0===i)return;global_data_1.Flags.startDragGridInfo.lastStart=r,requestAnimationFrame(()=>{e.moveTimeLine(i)});break;case"pointer":case"time-pointer":a.style.cursor="ew-resize";let n=grid_ctrl_1.gridCtrl.pageToFrame(t.x);n<0&&(n=0),e.currentFrame=n,ipc_event_1.IsetCurEditTime(utils_1.frameToTime(e.currentFrame,e.sample))}if(!global_data_1.Flags.mouseDownName){if(r<n.x||r>n.x+n.w||i<n.y||i>n.y+n.h)return;a.style.cursor="";const t=grid_ctrl_1.gridCtrl.pageToCtrl(r,i),o=grid_ctrl_1.gridCtrl.pageToFrame(r);if(o<0)return;if(e.previewPointer&&e.previewPointer.frame===o&&e.previewPointer.y===t.y)return;return global_data_1.Flags.previewPointerTask&&clearTimeout(global_data_1.Flags.previewPointerTask),t.y+=24,t.y<32&&(t.y=32),void requestAnimationFrame(()=>{e.previewPointer={frame:o,x:t.x-grid_ctrl_1.gridCtrl.startOffset,y:t.y},global_data_1.Flags.previewPointerTask=setTimeout(()=>{e.previewPointer=null},1e3)})}["node","property"].includes(global_data_1.Flags.mouseDownName)&&(global_data_1.Flags.onSelecting=!0,requestAnimationFrame(()=>{e.boxInfo&&(e.boxStyle=null,e.boxInfo.x=t.x,e.boxInfo.y=t.y,e.boxStyle=exports.animationEditor.calcBoxStyle())}))}checkSelectData(){this.checkSelectProperty(),this.checkSelectEvents(),this.checkSelectKeys()}checkSelectProperty(){const t=this.vm;t.selectProperty&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid).includes(t.selectProperty.nodePath)||(t.selectProperty=null),animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.selectProperty.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.selectProperty.nodePath]||(t.selectProperty=null))}checkSelectEvents(){const t=this.vm;if(!t.selectEventInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.events)return void(t.selectEventInfo=null);const e=animation_ctrl_1.animationCtrl.clipsDump.events.map(t=>t.frame);if(!e.length)return void(t.selectEventInfo=null);const a=[];for(const r of t.selectEventInfo.frames){-1!==e.indexOf(r)&&a.push(r)}0===a.length?t.selectEventInfo=null:t.selectEventInfo.frames=a}checkSelectKeys(){const t=this.vm;if(!t.selectKeyInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump)return void(t.selectKeyInfo=null);const e=[],a=[];if(t.selectKeyInfo.params.forEach((r,i)=>{if(!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop])return;const n=t.selectKeyInfo.data[i];animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r.nodePath][r.prop].keyFrames.map(t=>t.frame).includes(n.frame)&&(r.frame=n.frame,delete r.offsetFrame,e.push(r),a.push(n))}),0===e.length)return void(t.selectKeyInfo=null);const r=utils_1.sortSelectParams(e);Object.assign(t.selectKeyInfo,{params:e,data:a,sortDump:r,offsetFrame:0,offset:0,start:t.selectKeyInfo.start}),t.updateSelectKey++}calcBoxStyle(){const t=this.vm;if(!t.boxInfo)return;const{startX:e,startY:a,type:r,x:i,y:n}=t.boxInfo,o=grid_ctrl_1.gridCtrl.pageToCtrl(i,n),{offsetTop:s,offsetHeight:l,offsetWidth:m}=t.$refs[`${r}-content`],c=Editor.Utils.Math.clamp(o.x,0,m),p=Editor.Utils.Math.clamp(o.y,s,s+l),d=e-c,u=a-p;if(!d||!u)return;const f={};return d>0&&u>0?(f.x=c,f.y=p-s):d<0&&u<0?(f.x=e,f.y=a-s):d<0&&u>0?(f.x=e,f.y=p-s):d>0&&u<0&&(f.x=c,f.y=a-s),t.boxData={origin:f,w:Math.abs(d),h:Math.abs(u),type:t.boxInfo.type},{top:`${f.y}px`,left:`${f.x}px`,right:`${m-f.x-Math.abs(d)}px`,bottom:`${l-f.y-Math.abs(u)}px`}}updateRoot(t){const e=this.vm;if(t){if(""===t.name||t.isScene)return e.selectedId=null,e.root=null,e.nodeDump=null,animation_ctrl_1.animationCtrl.clipsDump=null,void(animation_ctrl_1.animationCtrl.nodesDump=null);animation_ctrl_1.animationCtrl.nodesDump=utils_1.formatNodeDump(t),e.active=t.active,t.active?e.compIndex=animation_ctrl_1.animationCtrl.nodesDump.compIndex:e.nodeDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))}}async updateClips(t,e){const a=this.vm;if(a.nodesDump&&!a.active)return void this.clearClips();if(!t)return void this.clearClips();let r=t;if("string"==typeof t){if(a.currentClip===t&&"update"!==e)return;if(console.time("IqueryClipDump"),r=await ipc_event_1.IqueryClipDump(a.root,t),console.timeEnd("IqueryClipDump"),!r&&!global_data_1.Flags.sceneReady)return void exports.animationEditor.refreshTask++;if(!r)return console.warn(`Get animation clip data failed! node ${a.root}, clip ${a.currentClip}`),void this.clearClips();a.currentClip=t}if(r){if(animation_ctrl_1.animationCtrl.clipsDump=Object.assign(utils_1.formatClipDump(r),{uuid:a.currentClip}),r.sample!==grid_ctrl_1.gridCtrl.grid.sample&&(grid_ctrl_1.gridCtrl.grid.sample=r.sample,grid_ctrl_1.gridCtrl.grid.render()),Object.keys(animation_ctrl_1.animationCtrl.clipConfig).forEach(t=>{var e;animation_ctrl_1.animationCtrl.clipConfig[t]=null!==(e=animation_ctrl_1.animationCtrl.clipsDump[t])&&void 0!==e?e:animation_ctrl_1.animationCtrl.clipConfig[t]}),a.clipConfig=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.clipConfig)),a.clipConfig.duration){const t=Math.min(a.$refs.chart.offsetWidth/(a.clipConfig.duration*a.clipConfig.sample*2),this.gridCtrl.grid.xMinScale),e=Math.max(a.clipConfig.duration*a.clipConfig.sample,this.gridCtrl.grid.xMaxScale);this.gridCtrl.grid.updateScale(t,e)}await a.calcSelectProperty(null,!0)}this.calcEventsDump(),this.calcNodes(),this.calcDisplayNodes(),this.calcDisplayClips(),a.properties=this.calcProperty(),this.checkSelectData(),a.updateKeyFrame++}async clearClips(){const t=this.vm;t.currentClip=null,animation_ctrl_1.animationCtrl.exit(),animation_ctrl_1.animationCtrl.clipsDump=null,t.clipConfig=null,t.eventsDump=null,this.calcDisplayNodes(),t.properties=this.calcProperty(),this.checkSelectData(),t.updateKeyFrame++}calcProperty(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath||!grid_ctrl_1.gridCtrl.grid)return null;let e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath];if(!e)return null;e=JSON.parse(JSON.stringify(e));let a=0;return Object.keys(e).forEach((r,i)=>{let n=e[r],o=n;"string"==typeof e[r].parentPropKey?(o=e[e[r].parentPropKey],!0!==t.expandInfo[o.prop]?(t.expandInfo[o.prop]=!1,e[r].hidden=!0):a++):a++,e[r].index=Math.max(0,a-1),e[r].top=a*this.LINE_HEIGHT,t.propertiesMenu&&!utils_1.isExitProperty(o,t.propertiesMenu)&&(e[r].missing=!0),n.keyFrames=Object.freeze(calcFrames(n.keyFrames,t.$refs.chart.offsetWidth,this.imageCCTypes.includes(n.type&&n.type.value)))}),e}calcEventsDump(){const t=this.vm;let e=[];return animation_ctrl_1.animationCtrl.clipsDump&&grid_ctrl_1.gridCtrl.grid&&(e=animation_ctrl_1.animationCtrl.clipsDump.events.map(t=>(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,t))),t.eventsDump=Object.freeze(e)}calcNodes(){if(!animation_ctrl_1.animationCtrl.nodesDump)return null;if(!animation_ctrl_1.animationCtrl.clipsDump)return;const t=JSON.parse(JSON.stringify(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid)));function e(a,r=!1){const i=a.match(/\//g);if(!i)return;const n=i.length;let o=t.findIndex(t=>!!t.match(/\//g)&&t.match(/\//g).length===n);const s=a.match(/\/([^\/]*)$/);if(s){if(0===o&&(o=1),-1===o){o=t.length;const i=a.match(/\/([^\/]+)/g);if(i&&!r){let a="";for(const r of i)a+=r,t.includes(a)||e(a,!0);return}}t.splice(o,0,a),animation_ctrl_1.animationCtrl.nodesDump.nodesDump.splice(o,0,{indent:2*n,path:a,name:s[1],uuid:"",keyFrames:[],top:0,rawIndex:o,listIndex:o})}}animation_ctrl_1.animationCtrl.nodesDump.nodesDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes));for(const a of Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump))-1===t.indexOf(a)&&e(a)}calcDisplayNodes(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.nodesDump)return void(t.nodeDump=null);const e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,a=[];let r=-1;const i=t.filterInvalid||t.filterName;e.forEach((e,n)=>{if(delete e.listIndex,delete e.top,delete e.rawIndex,i){if(!hasKeyData(e.path)&&t.filterInvalid)return;if(t.filterName&&!new RegExp(t.filterName,"i").test(e.name))return;r++}else r=n;const o=r*this.LINE_HEIGHT-t.nodeScrollInfo.top;e.top=r*this.LINE_HEIGHT,e.rawIndex=n,e.listIndex=r,o>=1.5*-this.LINE_HEIGHT&&o<=t.nodeScrollInfo.height+this.LINE_HEIGHT&&a.push(e)}),t.nodesHeight=i?r*this.LINE_HEIGHT:e.length*this.LINE_HEIGHT,animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump=a,t.nodeDump=a,Math.abs(t.nodeScrollInfo.top-t.$refs.nodes.scrollTop)>this.LINE_HEIGHT&&(t.$refs.nodes.scrollTop=t.nodeScrollInfo.top)}calcDisplayClips(){const t=this.vm;if(!t.nodeDump||!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return void(t.clipConfig=null);0===t.nodeDump.length&&(t.clipConfig=null);const e=Object.create(null);animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump.forEach(t=>{e[t.path]=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.path],t.disabled||(t.keyFrames=Object.freeze(JSON.parse(JSON.stringify(this.calcNodeFrames(t.path)))))}),t.nodeDump=animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump,animation_ctrl_1.animationCtrl.clipsDump.displayClipsDump=e}calcNodeFrames(t,e=!1){const a=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump)return[];const r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t];if(!r)return[];let i=[];for(const t of Object.keys(r)){const e=calcFrames(r[t].keyFrames,a.$refs.chart.offsetWidth,!1);i=i.concat(e)}return e&&0!==i.length&&i.sort((t,e)=>t.frame-e.frame),i}exit(){this.closeMaskPanel(),this.vm.moveNodePath=null,this.vm.selectKeyInfo=null,this.vm.selectEventInfo=null,this.vm.selectProperty=null,this.updateCurrentFrame(0),animation_ctrl_1.animationCtrl.clear()}close(){utils_1.removeEventListener(document,"mouseup",this.onMouseUp),utils_1.removeEventListener(document,"mousemove",this.onMouseMove)}}function calcFrames(t,e,a){if(!t)return[];const r=[];function i(t){return a?{x:t.x,prop:t.prop,frame:t.frame,value:t.dump.value&&t.dump.value.uuid}:{x:t.x,prop:t.prop,frame:t.frame}}const n={maxNegative:{distance:-1/0,index:-1},minPositive:{index:-1,distance:1/0}};var o;return t.forEach((t,a)=>{t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset;const s=(o=t.x)+grid_ctrl_1.gridCtrl.grid.xAxisOffset>e?o+grid_ctrl_1.gridCtrl.grid.xAxisOffset-e:o+grid_ctrl_1.gridCtrl.grid.xAxisOffset<0?o+grid_ctrl_1.gridCtrl.grid.xAxisOffset:0;0!==s?s>0&&n.minPositive.distance>s?(n.minPositive.distance=s,n.minPositive.index=a):s<0&&n.maxNegative.distance<s&&(n.maxNegative.distance=s,n.maxNegative.index=a):r.push(i(t))}),r.length!==t.length&&(-1!==n.maxNegative.index&&r.push(i(t[n.maxNegative.index])),-1!==n.minPositive.index&&r.push(i(t[n.minPositive.index]))),r}function hasKeyData(t){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t])return!1;for(const e of Object.values(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t]))if(0!==e.keyFrames.length)return!0;return!1}exports.animationEditor=new AnimationEditor,exports.calcFrames=calcFrames;