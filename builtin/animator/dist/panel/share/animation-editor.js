"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationEditor=void 0;const utils_1=require("../utils"),animation_ctrl_1=require("./animation-ctrl"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),Lodash=require("lodash");class AnimationEditor{constructor(){this.panel=null,this.LINE_HEIGHT=24,this.imageCCTypes=["cc.SpriteFrame","cc.Texture2D"],this.gridCtrl=grid_ctrl_1.gridCtrl,this.refreshTask=0,this.scaleRange={min:10,max:100},this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this.hasShowStick=!1,this.layoutConfig={topMin:24,leftMin:100,topMax:500,leftMax:500},this.vm=null}get isLock(){return!this.vm||(!this.vm||!this.vm.animationMode||this.vm.lock||this.vm.showBezierEditor||this.vm.showEventEditor)}setConfig(t,e){Editor.Profile.setConfig("animator",t,e,"global")}async getConfig(t){return await Editor.Profile.getConfig("animator",t)}init(t){this.vm=t,this.debounceUpdateState=require("lodash").debounce(t.updateState,300),this.debounceUpdateNode=require("lodash").debounce(t.update,300),this.debounceFilterNode=require("lodash").debounce(this.FilterNode,300),utils_1.addEventListenerOnce(document,"mouseup",this.onMouseUp),utils_1.addEventListenerOnce(document,"mousemove",this.onMouseMove)}FilterNode(t){this.vm.filterName=t,this.vm.calcDisplayNodes()}updateLayoutConfig(){this.layoutConfig.topMax=this.panel.clientHeight-100,this.layoutConfig.leftMax=this.panel.clientWidth-100}hideNodes(){this.vm.$refs.nodes.style="height: 24px; flex: unset;",this.vm.$refs["node-content"].style="height: 24px; flex: unset;"}showToast(t,e=1e3){this.vm.toast.message=t,global_data_1.Flags.tipsTimer&&clearTimeout(global_data_1.Flags.tipsTimer),global_data_1.Flags.tipsTimer=setTimeout(()=>{this.vm.toast.message=""},e)}changeSpacingFrame(t){this.setConfig("spacingFrame",t),this.vm.spacingFrame=t}clearSelectData(){if(this.vm.selectEventInfo||this.vm.selectKeyInfo)return this.vm.selectEventInfo=null,void(this.vm.selectKeyInfo=null);this.vm.selectProperty&&(this.vm.selectProperty=null)}copy(){this.isLock||(this.vm.selectKeyInfo?animation_ctrl_1.animationCtrl.copyKey():this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectProperty?animation_ctrl_1.animationCtrl.copyProp(this.vm.selectProperty):this.vm.selectedId&&animation_ctrl_1.animationCtrl.copyNodeData([animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId]]))}paste(){exports.animationEditor.isLock||(animation_ctrl_1.animationCtrl.getClipBoardData("key")?animation_ctrl_1.animationCtrl.pasteKey({target:this.vm.currentFrame,nodePath:this.vm.computeSelectPath},animation_ctrl_1.animationCtrl.getClipBoardData("key")):animation_ctrl_1.animationCtrl.getClipBoardData("event")?animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):this.vm.selectProperty&&animation_ctrl_1.animationCtrl.getClipBoardData("prop")?animation_ctrl_1.animationCtrl.pasteProp(this.vm.selectProperty,animation_ctrl_1.animationCtrl.getClipBoardData("prop")):this.vm.selectedId&&animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("node")))}updateSelectKey(t){const e=this.vm;let a=JSON.parse(JSON.stringify(e.selectKeyInfo));if(!a){if(!t)return;a={}}if(!a.sortDump){if(!t.nodePath)return;a.sortDump={}}const{nodePath:r,prop:o}=t,i=r+o;if(!a.sortDump[i]&&!t.data||!o)return;const s=t.params?t.params.map(t=>t.frame):[];a.sortDump[i]={data:t.data,params:t.params,prop:o,nodePath:r,frames:s},t.data&&t.params||delete a.sortDump[i];let n=[],l=[];Object.keys(a.sortDump).map(t=>{const e=a.sortDump[t];e.data&&e.params||delete a.sortDump[t],n=n.concat(e.data),l=l.concat(e.params)}),a.data=n.sort((t,e)=>t.frame-e.frame),a.params=l.sort((t,e)=>t.frame-e.frame),e.selectKeyInfo=a}getPositionAtSelect(t){return this.vm.selectKeyInfo?this.vm.selectKeyInfo.params.findIndex(e=>e.prop===t.prop&&e.frame===t.frame&&e.nodePath===t.nodePath):-1}removeSelectKey(t){if(!this.vm.selectKeyInfo||!this.vm.selectKeyInfo.params)return!1;const e=JSON.parse(JSON.stringify(this.vm.selectKeyInfo));this.vm.selectKeyInfo.params.forEach((a,r)=>{t.find(t=>Lodash.isEqual(a,t))&&(e.data.splice(r,1),e.params.splice(r,1))}),delete e.sortDump,this.vm.selectKeyInfo=e}openBezierEditor(t){this.vm.currentBezierData=t,this.vm.showBezierEditor=!0}closeBezierEditor(){this.vm.currentBezierData=null,this.vm.showBezierEditor=!1}openEventEditor(t){this.vm.editEventFrame=t,this.vm.showEventEditor=!0}closeEventEditor(){this.vm.showEventEditor=!1}setMovePath(t){this.vm.moveNodePath=t}cancelMoveNode(){this.vm.moveNodePath=null}selectNode(t,e=!1){if(!animation_ctrl_1.animationCtrl.nodesDump)return;const a=this.vm,r=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[t];if(r){const t=[r[0]];t[0]!==a.selectedId&&e&&t.push(a.selectedId),Editor.Selection.update("node",t)}else a.selectPath=t,a.properties=a.calcProperty(),a.selectedId="",a.selectedIds.clear()}startMoveNode(t){this.vm.moveNodePath=t}startDragKey(t,e=!1){if(!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return;const a=this.vm;if(a.selectKeyInfo=t,a.updateSelectKey++,e)return;global_data_1.Flags.mouseDownName="key";const r=a.selectKeyInfo.params[0];if(r.nodePath!==a.computeSelectPath){const t=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[r.nodePath];t[0]!==a.selectedId&&(Editor.Selection.unselect("node",a.selectedId),Editor.Selection.select("node",t[0]))}}async updateSelectProperty(t){const e=this.vm,a=await ipc_event_1.IgetPropValueAtFrame(e.currentClip,t.nodePath,t.prop,e.currentFrame);a&&(e.selectProperty=Object.assign(t,{value:a&&a.value,type:{value:a.type,extends:a.extends}}))}startDragEvent(t,e=!1){this.vm.selectEventInfo=t,e?"event"===global_data_1.Flags.mouseDownName&&(global_data_1.Flags.mouseDownName=""):global_data_1.Flags.mouseDownName="event"}updateMouseFrame(t,e){const a=this.vm;if(!t||!t.x&&!t.y)return void(a.moveInfo=null);const r=grid_ctrl_1.gridCtrl.pageToCtrl(t.x,t.y);a.moveInfo?(a.moveInfo.x=r.x+5,a.moveInfo.y=r.y+5,a.moveInfo.offsetFrame=e||0):a.moveInfo={x:r.x+5,y:r.y+5,offsetFrame:e||0},a.moveInfo&&(a.moveInfo.frame=t.frame||grid_ctrl_1.gridCtrl.pageToFrame(t.x))}updatePropExpandState(t,e){const a=this.vm;a.expandInfo[t]=e;const r=a.properties[t].partKeys;r?(r.forEach(t=>{a.properties[t].hidden=!e}),a.properties=a.calcProperty(),requestAnimationFrame(()=>{a.updateSelectKey++})):console.log(`[Animation Editor] Can't get partKeys of prop(${t})`)}showFrameInGrid(t){const{start:e,end:a}=grid_ctrl_1.gridCtrl.getFrameRang();t>=a?exports.animationEditor.setGridHeaderFrame(t):t<=e&&exports.animationEditor.setGridFooterFrame(t)}setGridHeaderFrame(t){const{start:e}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(e);this.vm.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(t))}setGridFooterFrame(t){const{end:e}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(e);this.vm.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(t))}updateCurrentFrame(t){const e=this.vm;e.setCurrentFrame(t);const a=utils_1.frameToTime(t,e.sample);ipc_event_1.IsetCurEditTime(a)}jumpPrevFrame(){this.vm.currentFrame>0&&this.updateCurrentFrame(--this.vm.currentFrame)}jumpNextFrame(){this.updateCurrentFrame(++this.vm.currentFrame)}jumpFirstFrame(){this.updateCurrentFrame(0)}jumpLastFrame(){this.updateCurrentFrame(this.vm.lastFrameInfo.frame)}async nextStep(){const t=this.vm;this.isLock||(t.selectKeyInfo?exports.animationEditor.moveSelectKeys(1,!1):t.selectEventInfo?await exports.animationEditor.moveSelectEvents(1,!1):exports.animationEditor.jumpNextFrame())}async prevStep(){if(exports.animationEditor.isLock)return;const t=exports.animationEditor.vm;t.selectKeyInfo?exports.animationEditor.moveSelectKeys(-1,!1):t.selectEventInfo?await exports.animationEditor.moveSelectEvents(-1,!1):exports.animationEditor.jumpPrevFrame()}async jumpToNextKey(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath)return;let e=[];if(e=t.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath][t.selectProperty.prop].keyFrames:t.calcNodeFrames(t.computeSelectPath,!0),t.currentFrame>e[e.length-1].frame)exports.animationEditor.updateCurrentFrame(e[e.length-1].frame);else for(const a of e)if(a.frame>t.currentFrame)return void exports.animationEditor.updateCurrentFrame(a.frame)}async jumpToPrevKey(){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath)return;let e=[];if(e=t.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath][t.selectProperty.prop].keyFrames:t.calcNodeFrames(t.computeSelectPath,!0),t.currentFrame<e[0].frame)exports.animationEditor.updateCurrentFrame(e[0].frame);else for(let a=e.length-1;a>=0;a--){const r=e[a].frame;if(r<t.currentFrame)return void exports.animationEditor.updateCurrentFrame(r)}}async moveSelectKeys(t,e=!1){if(!animation_ctrl_1.animationCtrl.clipsDump)return;const a=this.vm,r=JSON.parse(JSON.stringify(a.selectKeyInfo));r.offsetFrame=r.offsetFrame||0;const{data:o,params:i}=r,s=[];for(let r=0;r<o.length;r++){const n=o[r];let l=n.frame+t;if(l<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!a.selectKeyInfo.data.find(t=>t.frame===l)){const a=i[r],o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath][a.prop].keyFrames;for(;o.find(t=>t.frame===l);){let a="";if(a=e&&!this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_with_ctrl"):e&&this.hasShowStick?Editor.I18n.t("animator.move_key_tips.move_keys_with_ctrl"):Editor.I18n.t("animator.move_key_tips.should_move_keys_with_ctrl"),this.showToast(a),!e||this.hasShowStick)return;t=t>0?t+1:t-1,l=n.frame+t}}s.push(l),n.frame=l,n.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(n.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}0!==s.length&&(s.sort((t,e)=>t-e),t>0?this.showFrameInGrid(s[s.length-1]):this.showFrameInGrid(s[0]),r.ctrl=e,r.offsetFrame+=t,a.selectKeyInfo=r,await animation_ctrl_1.animationCtrl.moveKeys())}async moveSelectEvents(t,e){const a=this.vm,{data:r,frames:o}=a.selectEventInfo,i=[];for(const a of r){let r=a.frame+t;if(r<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!o.includes(r))for(;animation_ctrl_1.animationCtrl.clipsDump.events.find(t=>t.frame===r);){let i="";if(i=e&&1===o.length?"i18n:animator.move_key_tips.move_with_ctrl":e&&1!==o.length?"i18n:animator.move_key_tips.move_keys_with_ctrl":"i18n:animator.move_key_tips.should_move_keys_with_ctrl",this.showToast(i),!e||1!==o.length)return;t=t>0?t+1:t-1,r=a.frame+t}i.push(r),a.frame=r,a.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(a.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}i.sort((t,e)=>t-e),t>0?this.showFrameInGrid(i[o.length-1]):this.showFrameInGrid(i[0]),a.selectEventInfo.offsetFrame+=t,await animation_ctrl_1.animationCtrl.callByDebounce("moveEvents")}onKeyMouseMove(t){const e=this.vm,a=t.target;if(!e.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(e.selectKeyInfo)),{startX:o,data:i}=r;if(o===t.x)return;t.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const s=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let n=grid_ctrl_1.gridCtrl.pageToFrame(o);n<0&&(n=0);const l=s-n;if(0===l)return;const m=grid_ctrl_1.gridCtrl.grid.valueToPixelH(s)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(n),c=[];for(const t of i){if(!t)continue;let e=t.frame+l;if(e<0)return;t.x+=m,t.frame=e,c.push(e)}r.startX+=m,r.offset+=m,r.offsetFrame+=l,global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:t.x,y:t.y,frame:i[0].frame},r.offsetFrame),e.selectKeyInfo=r,c.sort((t,e)=>t-e);const{start:d,end:p}=grid_ctrl_1.gridCtrl.getFrameRang();(c[0]<=d||c[c.length-1]>=p)&&this.vm.moveTimeLine(-m)}onKeyMouseUp(t,e){if((e&&e.alt||t.altKey)&&this.vm.selectKeyInfo){let t=e&&e.target||this.vm.currentFrame;animation_ctrl_1.animationCtrl.pasteKey({target:t,nodePath:this.vm.selectKeyInfo.params[0].nodePath},animation_ctrl_1.animationCtrl.transSelectToCopyKeyInfo())}else animation_ctrl_1.animationCtrl.moveKeys()}onEventMouseMove(t){const e=this.vm;if(!e.selectEventInfo)return;const a=t.target;t.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const{startX:r,data:o}=e.selectEventInfo,i=grid_ctrl_1.gridCtrl.pageToFrame(t.x);let s=grid_ctrl_1.gridCtrl.pageToFrame(r);s<0&&(s=0);const n=i-s;if(0===n)return;const l=grid_ctrl_1.gridCtrl.grid.valueToPixelH(i)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(s);e.selectEventInfo.startX+=l,e.selectEventInfo.offset+=l,e.selectEventInfo.offsetFrame+=n;for(const t of o)if(t.x+=l,t.frame+=n,t.frame<0)return;this.updateMouseFrame({x:t.x,y:t.y,frame:o[0].frame},e.selectEventInfo.offsetFrame);const{start:m,end:c}=grid_ctrl_1.gridCtrl.getFrameRang();(o[0].frame<=m||o[o.length-1].frame>=c)&&this.vm.moveTimeLine(-l)}onEventMouseUp(t){const e=grid_ctrl_1.gridCtrl.pageToFrame(t.x+grid_ctrl_1.gridCtrl.startOffset);t.altKey?animation_ctrl_1.animationCtrl.pasteEvent(e,this.vm.selectEventInfo):0!==this.vm.selectEventInfo.offsetFrame&&animation_ctrl_1.animationCtrl.moveEvents()}onStickMouseMove(t){const e=this.vm;if(!global_data_1.Flags.startDragStickInfo)return;const a=t.x-global_data_1.Flags.startDragStickInfo.startX;if(0!==a)switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseMove(t);break;case"right":{const t=1+a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,o=r[0],i=Object.create(null);for(let a=1;a<r.length;a++){const s=r[a];if(s.frame===o.frame){i[s.prop]?i[s.prop].push(s.frame):i[s.prop]=[s.frame];continue}let n=(s.x-o.x)*t+o.x,l=grid_ctrl_1.gridCtrl.canvasToFrame(n);i[s.prop]&&(i[s.prop].includes(l)&&(l+=t>1?-1:1),i[s.prop]=[]),l===o.frame&&(l=o.frame+(t>1?-1:1)),i[s.prop]=[l],n=grid_ctrl_1.gridCtrl.frameToCanvas(l),this.stickInfo.width=n+12-this.stickInfo.left,e.selectKeyInfo.params[a].offsetFrame=l-e.selectKeyInfo.params[a].frame,Object.assign(e.selectKeyInfo.data[a],{x:n,frame:l})}e.updateSelectKey++}break;case"left":{const t=a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,o=r[r.length-1],i=Object.create(null);for(let a=r.length-2;a>=0;a--){const s=r[a];if(s.frame===o.frame){i[s.prop]?i[s.prop].push(s.frame):i[s.prop]=[s.frame];continue}let n=(o.x-s.x)*t+s.x,l=grid_ctrl_1.gridCtrl.canvasToFrame(n);i[s.prop]&&(i[s.prop].includes(l)&&(l+=t>1?-1:1),i[s.prop]=[]),l===o.frame&&(l=o.frame+(t>1?-1:1)),i[s.prop]=[l],n=grid_ctrl_1.gridCtrl.frameToCanvas(l),e.selectKeyInfo.params[a].offsetFrame=l-e.selectKeyInfo.params[a].frame,Object.assign(e.selectKeyInfo.data[a],{x:n,frame:l})}e.updateSelectKey++}}}onStickMouseUp(t){if(global_data_1.Flags.startDragStickInfo){switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseUp(t,{target:this.stickInfo.leftFrame});break;case"right":case"left":this.onKeyMouseUp(t)}global_data_1.Flags.startDragStickInfo=null}}onStartResize(t,e){global_data_1.Flags.mouseDownName="resize",global_data_1.Flags.startResizeInfo={type:e,start:0};const a=t.target;a.style.cursor="left"===e?"ew-resize":"ns-resize"}onResizeMouseMove(t){if(!global_data_1.Flags.startResizeInfo)return;const e=global_data_1.Flags.startResizeInfo.type,a=global_data_1.Flags.startResizeInfo.start;let r=0;if(r="left"===e?t.x:t.y+25,!a)return void(global_data_1.Flags.startResizeInfo.start=r);global_data_1.Flags.startResizeInfo.start=r;const o="left"===e?this.vm.$refs.container.offsetWidth:this.vm.$refs.container.offsetHeight;let i=(parseFloat(this.vm.layout[e+"Pec"])/100*o||0)+r-a;i=Editor.Utils.Math.clamp(i,this.layoutConfig[`${e}Min`],this.layoutConfig[`${e}Max`]),this.vm.layout[e+"Pec"]=i/o*100+"%"}onResizeMouseUp(t){global_data_1.Flags.startResizeInfo=null,this.setConfig("layout",this.vm.layout),t.target.style="default"}onMouseUp(t){if(exports.animationEditor.isLock)return;const e=exports.animationEditor.vm;if(t.target.style.cursor="default",global_data_1.Flags.mouseDownName){switch(e.boxInfo=null,e.boxStyle=null,e.boxData=null,global_data_1.Flags.onSelecting=!1,global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseUp(t,{target:grid_ctrl_1.gridCtrl.pageToFrame(t.x)});break;case"event":exports.animationEditor.onEventMouseUp(t);break;case"stick":exports.animationEditor.onStickMouseUp(t);break;case"resize":exports.animationEditor.onResizeMouseUp(t);break;case"time-pointer":let a=grid_ctrl_1.gridCtrl.pageToFrame(t.x);a<0&&(a=0),e.currentFrame=a;const r=utils_1.frameToTime(a,e.sample);ipc_event_1.IsetCurEditTime(r);break;case"grid":return void setTimeout(()=>{global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null},10)}global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,e.moveInfo=null}else global_data_1.Flags._startMove&&clearTimeout(global_data_1.Flags._startMove)}onMouseMove(t){if(exports.animationEditor.isLock||global_data_1.Flags.onScrolling||!t.buttons)return;const e=exports.animationEditor.vm,a=t.target,{x:r,y:o}=t,i=e.$refs.gridCanvas.getBoundingClientRect();switch(global_data_1.Flags.mouseDownName&&(e.previewPointer=null),global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseMove(t);break;case"event":exports.animationEditor.onEventMouseMove(t);break;case"stick":requestAnimationFrame(()=>{exports.animationEditor.onStickMouseMove(t)});break;case"resize":requestAnimationFrame(()=>{exports.animationEditor.onResizeMouseMove(t)});break;case"grid":a.style.cursor="-webkit-grabbing";const o=r-global_data_1.Flags.startDragGridInfo.lastStart;if(0===o)return;global_data_1.Flags.startDragGridInfo.lastStart=r,requestAnimationFrame(()=>{e.moveTimeLine(o)});break;case"pointer":case"time-pointer":a.style.cursor="ew-resize";let i=grid_ctrl_1.gridCtrl.pageToFrame(t.x);i<0&&(i=0),e.currentFrame=i,ipc_event_1.IsetCurEditTime(utils_1.frameToTime(e.currentFrame,e.sample))}if(!global_data_1.Flags.mouseDownName){if(r<i.x||r>i.x+i.w||o<i.y||o>i.y+i.h)return;a.style.cursor="";const t=grid_ctrl_1.gridCtrl.pageToCtrl(r,o),s=grid_ctrl_1.gridCtrl.pageToFrame(r);if(s<0)return;if(e.previewPointer&&e.previewPointer.frame===s&&e.previewPointer.y===t.y)return;return global_data_1.Flags.previewPointerTask&&clearTimeout(global_data_1.Flags.previewPointerTask),t.y+=24,t.y<32&&(t.y=32),void requestAnimationFrame(()=>{e.previewPointer={frame:s,x:t.x-grid_ctrl_1.gridCtrl.startOffset,y:t.y},global_data_1.Flags.previewPointerTask=setTimeout(()=>{e.previewPointer=null},1e3)})}["node","property"].includes(global_data_1.Flags.mouseDownName)&&(global_data_1.Flags.onSelecting=!0,requestAnimationFrame(()=>{e.boxInfo&&(e.boxStyle=null,e.boxInfo.x=t.x,e.boxInfo.y=t.y,e.boxStyle=e.calcBoxStyle())}))}exit(){this.closeBezierEditor(),this.closeEventEditor(),this.vm.moveNodePath=null,this.vm.selectKeyInfo=null,this.vm.selectEventInfo=null,this.vm.selectProperty=null,this.updateCurrentFrame(0),animation_ctrl_1.animationCtrl.clear()}close(){utils_1.removeEventListener(document,"mouseup",this.onMouseUp),utils_1.removeEventListener(document,"mousemove",this.onMouseMove)}}exports.animationEditor=new AnimationEditor;