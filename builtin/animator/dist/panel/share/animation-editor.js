"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcFrames=exports.animationEditor=exports.CurveColorList=void 0;const utils_1=require("../utils"),animation_ctrl_1=require("./animation-ctrl"),bezier_presets_1=require("./bezier-presets"),clip_cache_1=require("./clip-cache"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),pop_menu_1=require("./pop-menu");exports.CurveColorList=["#AE2D47","#227F9B","#198F6B","#7979D7"];const Lodash=require("lodash");class AnimationEditor{constructor(){this.panel=null,this.LINE_HEIGHT=24,this.KEY_SIZE_R=Math.sqrt(14),this.imageCCTypes=["cc.SpriteFrame","cc.Texture2D","cc.TextureBase","cc.ImageAsset"],this.curveDisabledCCtypes=["Unknown","cc.Boolean","cc.Quat",...this.imageCCTypes],this.gridCtrl=grid_ctrl_1.gridCtrl,this.refreshTask=0,this.hasInitCurve=!1,this.hasInitCurvePreset=!1,this._spacingFrame=1,this._curveData=null,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this.hasShowStick=!1,this.layoutConfig={topMin:0,leftMin:100,centerMin:0,centerMax:500,topMax:500,leftMax:500,totalPec:100},this.aniPlayTask=0,this.updateSelectQueue=[]}get spacingFrame(){return this._spacingFrame}set spacingFrame(e){this._spacingFrame=e,this.changeSpacingFrame(e)}get isLock(){return!this.vm||!(this.vm&&this.vm.animationMode&&!this.vm.lock&&!this.vm.maskPanel)}reset(){this.refreshTask=0,this.hasInitCurve=!1,this.selectKeyUpdateFlag=!1,this.stickInfo={leftFrame:0,rightFrame:0,left:0,top:0,width:0,height:0},this._spacingFrame=1,this.hasShowStick=!1,this.layoutConfig={topMin:0,leftMin:100,centerMin:0,centerMax:500,topMax:500,leftMax:500,totalPec:100},this.aniPlayTask=0,this.updateSelectQueue=[]}setConfig(e,t){Editor.Profile.setConfig("animator",e,t,"global")}async getConfig(e){return await Editor.Profile.getConfig("animator",e)}async init(e){this.vm=e,this.debounceUpdateNode=require("lodash").debounce(this.update,300),this.debounceFilterNode=require("lodash").debounce(this.FilterNode,300),this.debounceRefresh=require("lodash").debounce(this._refresh,300);const t=await exports.animationEditor.getConfig("spacingFrame");this._spacingFrame=t||1,(0,utils_1.addEventListenerOnce)(document,"mouseup",this.onMouseUp),(0,utils_1.addEventListenerOnce)(document,"mousemove",this.onMouseMove)}async vmInit(){const e=this.vm;e.$refs.chart.style.width=`${e.$refs.right.offsetWidth}px`;const t=await this.getConfig("showType");grid_ctrl_1.gridCtrl.init({$canvas:e.$refs.gridCanvas,$left:e.$refs.left,$right:e.$refs.right,$xAxis:e.$refs.xAxis,showType:t,minScale:1,maxScale:100}),this.updateLayoutConfig(),e.offset=e.$refs.left.offsetWidth,requestAnimationFrame(()=>{grid_ctrl_1.gridCtrl.grid.resize(),this.renderTimeAxis(),this.setCurrentFrame(e.currentFrame),this.initCurve(),e.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset})}initCurve(){const{width:e,height:t}=this.vm.$refs["property-content"].getBoundingClientRect();if(this.vm.$refs.curve.style.width=e,this.vm.$refs.curve.style.height=t,this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.curveCtrl.canvas.width&&this.vm.$refs.curve.curveCtrl.canvas.height||(this.vm.$refs.curve.resize(e,t),this.vm.$refs.curve.setConfig({xRange:[0,1/0],yRange:[-1/0,1/0],showPreWrapMode:!1,showPostWrapMode:!1,precisionX:0,precisionY:3,showXLabel:!1,showYLabel:!0,axisMargin:0,showYLine:!0,showXLine:!1,startXOffset:10,handlerSize:60,gridColor:"#333846",spacingFrame:exports.animationEditor.spacingFrame,sample:this.vm.sample,xAxisName:"time",yAxisName:"value"}),this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.yAxisScale=10),!exports.animationEditor.hasInitCurve){new ResizeObserver(e=>{const{width:t,height:a}=e[0].contentRect;this.vm.$refs.curve.resize(t,a)}).observe(this.vm.$refs.curve),this.vm.$refs.curve.addEventListener("transform",()=>{grid_ctrl_1.gridCtrl.grid.xAxisScale=this.vm.$refs.curve.curveCtrl.grid.xAxisScale,grid_ctrl_1.gridCtrl.grid.xAxisOffset=this.vm.$refs.curve.curveCtrl.grid.xAxisOffset,this.vm.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.updatePositionInfo(),this.vm.updatePosition++,grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis()}),this.vm.$refs.curve.curveCtrl.getCopyKeys=(()=>{const e=animation_ctrl_1.animationCtrl.copyKeyInfo;if(!e)return[];const t=[];return e.curvesDump.forEach(e=>{t.push({key:e.key,keys:e.keyframes.map(e=>(0,utils_1.mockDumpToCtrl)(e))})}),t}),this.vm.$refs.curve.curveCtrl.on("operate",this.onCurveOperate.bind(this)),exports.animationEditor.hasInitCurve=!0}if(!this.hasInitCurvePreset){for(const e of this.vm.presetArr){const{p1:t,p2:a,p3:r,p4:i}=(0,bezier_presets_1.transformBezierDataToPoint)(e.data);e.svgData=`M${t[0]} ${t[1]} C ${a[0]} ${a[1]}, ${r[0]} ${r[1]}, ${i[0]} ${i[1]}`}this.hasInitCurvePreset=!0}}getEmbeddedPlayerMenu(e){const t=e||{};return Object.values(utils_1.EmbeddedPlayerMenuMap).map(e=>({label:e.label,click:()=>{this.addEmbeddedPlayer(Object.assign(Object.assign({},t),{playable:e.value}))}}))}onEmbeddedPlayerTrackMenu(e,t){const a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerTrackMenu);a.clearEmbeddedPlayer.click=(()=>{this.clearEmbeddedPlayerGroup(t.key)}),a.removeEmbeddedPlayerGroup.click=(()=>{this.removeEmbeddedPlayerGroup(t.key)}),Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:Object.values(a)})}onEmbeddedPlayerContextMenu(e,t){const a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerContextMenu),r=grid_ctrl_1.gridCtrl.pageToFrame(e.x);a.createEmbeddedPlayer.click=(()=>{this.addEmbeddedPlayer({begin:r,end:r+5,playable:{type:t.type},group:t.key})}),a.clearEmbeddedPlayer.click=(()=>{this.clearEmbeddedPlayerGroup(t.key)});let i=animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")||[];i=i.filter(e=>e.playable.type===t.type),a.pasteEmbeddedPlayer.enabled=!!i.length,a.pasteEmbeddedPlayer.click=(()=>{animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(r,i,t.key)}),Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:Object.values(a)})}async clearEmbeddedPlayerGroup(e){await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.clearEmbeddedPlayerGroup)(this.vm.currentClip,e))}async removeEmbeddedPlayerGroup(e){await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.removeEmbeddedPlayerGroup)(this.vm.currentClip,e))}async addEmbeddedPlayer(e){const t={begin:this.vm.currentFrame,end:this.vm.currentFrame+5,reconciledSpeed:!1,playable:{type:"animation-clip"},group:""};e&&Object.assign(t,e);let a=this.findGroupCanAdd(t);const r=[];a||(a={key:String(Date.now()),name:t.playable.type,type:t.playable.type,embeddedPlayers:[],menuInfo:utils_1.EmbeddedPlayerMenuMap[t.playable.type]},r.push((0,ipc_event_1.addEmbeddedPlayerGroup)(this.vm.currentClip,{key:a.key,name:a.name,type:a.type})),this.vm.embeddedPlayerGroups.push(a)),a.embeddedPlayers.push(this.transEmbeddedPlayerDumpToInfo(t)),t.group=a.key,r.push((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,t)),await(0,ipc_event_1.IApplyOperation)(r),Editor.Metrics._trackEventWithTimer({category:"hippoAnimator",id:"A100002",value:1})}findGroupCanAdd(e){const t=this.vm.embeddedPlayerGroups.find(t=>t.key===e.group);if(t){if(!t.embeddedPlayers.find(t=>Math.max(t.begin,e.begin)<Math.min(t.end,e.end)))return t}for(const t of this.vm.embeddedPlayerGroups){if(t.type!==e.playable.type)continue;if(!t.embeddedPlayers.find(t=>Math.max(t.begin,e.begin)<Math.min(t.end,e.end)))return t}return null}changeToEmbeddedPlayerMode(){this.vm.$refs.nodes.scrollTop=this.vm.nodeScrollInfo.top=0,exports.animationEditor.calcDisplayClips()}changeToKeyFrameMode(){this.vm.$refs.nodes.scrollTop=this.vm.nodeScrollInfo.top=0,exports.animationEditor.calcDisplayClips()}renderTimeAxis(){let e=1,t=e*(animation_ctrl_1.animationCtrl.clipConfig.sample||60);const a=[],r=this.vm.$refs.container.clientWidth,i=e=>this.gridCtrl.frameToCanvas(e)-10+this.vm.offset;for(;Editor.Utils.Math.clamp(i(t),0,r)===i(t);){const r=this.gridCtrl.frameToCanvas(t);a.push({value:Math.floor(t/(animation_ctrl_1.animationCtrl.clipConfig.sample||60)),x:r-10}),t=++e*(animation_ctrl_1.animationCtrl.clipConfig.sample||60)}this.vm.timeInfos=a,this.vm.scale=100*grid_ctrl_1.gridCtrl.grid.xAxisScale/(grid_ctrl_1.gridCtrl.grid.xMaxScale-grid_ctrl_1.gridCtrl.grid.xMinScale)}onCurveOperate(e,t,a){if(this.vm.hasSelectedCurveClip=!1,"unselect"===e||!this.vm.selectProperty)return this.vm.selectKeyInfo=null,void(this.vm.lightCurve=null);if(!t)return;const{nodePath:r,type:i}=this.vm.selectProperty;switch(e){case"select":{const e={keyFrames:[],nodePath:r,prop:this.vm.selectProperty.prop,location:"prop"};t.forEach(t=>{const a=(0,utils_1.transformCtrlKeyToDump)(t.keys,i),r=t.key;e.keyFrames.push(...a.map((e,a)=>{const i={x:t.keys[a].key.canvas.x-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:e.frame,rawFrame:e.frame,prop:r,nodePath:this.vm.computeSelectPath};return Object.assign(Object.assign({},i),{key:(0,utils_1.calcKeyFrameKey)(i)})}))}),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=e,this.vm.updateSelectKey++}break;case"db-select":{const e=t[0].keys,a=(0,utils_1.transformCtrlKeyToDump)(e,i);this.updateCurrentFrame(a[0].frame)}break;case"select-curve":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color};break;case"select-curve-clip":this.vm.lightCurve={name:t[0].key,color:this.vm.properties[t[0].key].color},this.vm.hasSelectedCurveClip=!0;break;case"apply-bezier":{this.vm.hasSelectedCurveClip=!0;const e=t[0].key,a=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,i).map(t=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,r,e,t.frame,{inTangent:t.inTangent,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight,interpMode:t.interpMode,tangentWeightMode:t.tangentWeightMode}));(0,ipc_event_1.IApplyOperation)(a)}break;case"scale-keys":case"move-keys":{const e=[],a=[],n={nodePath:this.vm.computeSelectPath,keyFrames:[],location:"prop",prop:this.vm.selectProperty.prop};t.forEach(t=>{const o=t.keys,s=(0,utils_1.transformCtrlKeyToDump)(o,i);o.forEach((i,o)=>{const l=Math.round(i.key.point.x-i.raw.point.x),c={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(s[o].frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:s[o].frame,prop:t.key,rawFrame:Math.round(i.raw.point.x),nodePath:this.vm.computeSelectPath,offsetFrame:l};n.keyFrames.push(Object.assign(Object.assign({},c),{key:(0,utils_1.calcKeyFrameKey)(c)}));const m=Math.round(i.key.point.y-i.raw.point.y);(l||m)&&(l&&e.push((0,ipc_event_1.ImoveKeys)(this.vm.currentClip,r,t.key,[Math.round(i.raw.point.x)],l)),a.push((0,ipc_event_1.IcreateKey)(this.vm.currentClip,r,t.key,s[o].frame,{newValue:i.key.point.y,inTangent:i.key.inTangent,outTangent:i.key.outTangent})))})}),(0,ipc_event_1.IApplyOperation)([...e,...a]),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=n}break;case"tangent":{const e=t[0].key,a=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,i).map(t=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,r,e,t.frame,{inTangent:t.inTangent,broken:t.broken,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight}));(0,ipc_event_1.IApplyOperation)(a)}break;case"change-broken-state":{const e=t[0].key,a=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,i).map(t=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,r,e,t.frame,{broken:t.broken}));(0,ipc_event_1.IApplyOperation)(a)}break;case"create-keys":{const e=[];t.forEach(t=>{const a=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(a,i);n.forEach((a,i)=>{e.push((0,ipc_event_1.IcreateKey)(this.vm.currentClip,r,t.key,n[i].frame,{inTangent:a.inTangent,outTangent:a.outTangent,newValue:a.dump.value,interpMode:a.interpMode,tangentWeightMode:a.tangentWeightMode,inTangentWeight:a.inTangentWeight,outTangentWeight:a.outTangentWeight}))})}),(0,ipc_event_1.IApplyOperation)(e)}break;case"change-interp-mode":{const e=[];t.forEach(t=>{const a=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(a,i);e.push(...n.map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,r,t.key,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode})))}),(0,ipc_event_1.IApplyOperation)(e)}break;case"change-tangent-weight":{const e=[];t.forEach(t=>{const a=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(a,i);e.push(...n.map(e=>(0,ipc_event_1.ImodifyCurveOfKey)(this.vm.currentClip,r,t.key,e.frame,{tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight})))}),(0,ipc_event_1.IApplyOperation)(e)}break;case"remove-keys":{const e=[];t.forEach(t=>{const a=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(a,i);e.push(...n.map(e=>(0,ipc_event_1.IremoveKey)(this.vm.currentClip,r,t.key,e.frame)))}),(0,ipc_event_1.IApplyOperation)(e),this.selectKeyUpdateFlag=!1,this.vm.selectKeyInfo=null}break;case"move-curve":{const e=[];t.forEach(t=>{const a=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(a,i);e.push(...n.map(e=>(0,ipc_event_1.IcreateKey)(this.vm.currentClip,r,t.key,e.frame,{newValue:e.dump.value})))}),(0,ipc_event_1.IApplyOperation)(e)}break;case"paste":animation_ctrl_1.animationCtrl.pasteKey({target:a,nodePath:r},animation_ctrl_1.animationCtrl.getClipBoardData("key"));break;case"copy":{const e=[],a=[];t.forEach(t=>{const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r][t.key],o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[r][n.parentPropKey],s=t.keys,l=(0,utils_1.transformCtrlKeyToDump)(s,i);e.push({nodePath:r,key:t.key,type:n.type,displayName:n.displayName,keyframes:l,_parentType:o&&o.type,preExtrap:n.preExtrap,postExtrap:n.postExtrap,isCurveSupport:n.isCurveSupport}),a.push(l[0].frame)}),animation_ctrl_1.animationCtrl.copyKeyInfo={curvesDump:e,leftFrame:a.sort((e,t)=>e-t)[0]}}}}FilterNode(e){this.vm.filterName=e,this.calcDisplayNodes()}checkCurveDataDirty(e){if(!this._curveData)return this._curveData=e,!0;const t=JSON.stringify(this._curveData)!==JSON.stringify(e);return this._curveData=e,t}updateCurveSelecteKeys(){if(!this.vm.showAnimCurve)return;if(!this.vm.selectKeyInfo)return void this.vm.$refs.curve.curveCtrl.selectKeys(null);const e=this.vm.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(this.vm.selectKeyInfo.keyFrames),t=Object.values(e).map(e=>({key:e.prop,frames:e.keyFrames.map(e=>e.frame)}));this.vm.$refs.curve.curveCtrl.selectKeys(t)}repaintCurve(e){if(this.vm){try{this.vm.showAnimCurve&&this.vm.$refs.curve.curveCtrl&&this.vm.$refs.curve.curveCtrl.paint(e),this._curveData=e}catch(e){console.error(e)}this.selectKeyUpdateFlag&&(this.updateCurveSelecteKeys(),this.selectKeyUpdateFlag=!1)}}updateLayoutConfig(){const e=this.vm.$el.getBoundingClientRect();this.layoutConfig.topMax=e.top+this.panel.clientHeight-133,this.layoutConfig.leftMax=e.left+this.panel.clientWidth-100,this.layoutConfig.totalPec=100*(this.vm.$refs.container.offsetHeight-90)/this.vm.$refs.container.offsetHeight}updateSample(e){this.vm&&this.vm.showAnimCurve&&(this.vm.$refs.curve.sample=e)}hideNodes(){this.vm.$refs.nodes.style.height="24px",this.vm.$refs.nodes.style.flex="unset",this.vm.$refs["node-content"].style.height="24px",this.vm.$refs["node-content"].style.flex="unset"}showToast(e,t=1e3){this.vm.toast.message=e,global_data_1.Flags.tipsTimer&&clearTimeout(global_data_1.Flags.tipsTimer),global_data_1.Flags.tipsTimer=setTimeout(()=>{this.vm.toast.message=""},t)}changeSpacingFrame(e){this.setConfig("spacingFrame",e),this.vm.$refs.curve.curveCtrl&&(this.vm.$refs.curve.curveCtrl.config.spacingFrame=e)}updatePositionInfo(e){const t=this.vm;if(t.previewPointer&&(t.previewPointer=null),t.nodeDump&&animation_ctrl_1.animationCtrl.clipsDump&&(t.nodeDump.forEach(e=>{e.keyFrames=Object.freeze(this.calcNodeFrames(e.path))}),t.properties&&(t.properties=this.calcProperty()),t.updateKeyFrame++),exports.animationEditor.calcDisplayEmbeddedPlayers(),"move"!==e){if(t.selectKeyInfo){for(const e of t.selectKeyInfo.keyFrames)e&&(e.x=grid_ctrl_1.gridCtrl.frameToCanvas(e.frame));t.updateSelectKey++}if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events&&this.calcEventsDump(),t.selectEventInfo)for(const e of t.selectEventInfo.data)e&&(e.x=grid_ctrl_1.gridCtrl.frameToCanvas(e.frame));if(t.selectEmbeddedPlayerInfo)for(const e of t.selectEmbeddedPlayerInfo)e&&(e.x=grid_ctrl_1.gridCtrl.frameToCanvas(e.rawInfo.begin),e.width=grid_ctrl_1.gridCtrl.frameToCanvas(e.rawInfo.end)-e.x)}}resetSelectedKeyInfo(){const e=this.vm;if(!e.selectKeyInfo)return;const t=JSON.parse(JSON.stringify(e.selectKeyInfo));t.offsetFrame=0,t.offset=0,delete t.sortDump,t.keyFrames.forEach((e,a)=>{t.keyFrames[a].frame=e.frame,delete t.keyFrames[a].offsetFrame}),t.sortDump=(0,utils_1.sortKeysToTreeMap)(t.keyFrames),t.keyFrames.sort((e,t)=>e.frame-t.frame),e.selectKeyInfo=t}clearSelectData(){if(this.vm.selectEventInfo||this.vm.selectKeyInfo)return this.vm.selectEventInfo=null,void(this.vm.selectKeyInfo=null);this.vm.selectProperty&&(this.vm.selectProperty=null),this.vm.selectEmbeddedPlayerInfo&&(this.vm.selectEmbeddedPlayerInfo=null,Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")))}copy(){if(this.isLock)return this.vm.selectEventInfo&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectEmbeddedPlayerInfo?void(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=this.vm.selectEmbeddedPlayerInfo.map(e=>this.transEmbeddedPlayerInfoToDump(e,!1))):void 0;this.vm.selectKeyInfo?animation_ctrl_1.animationCtrl.copyKey():this.vm.selectEmbeddedPlayerInfo?animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=this.vm.selectEmbeddedPlayerInfo.map(e=>this.transEmbeddedPlayerInfoToDump(e,!1)):this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.copyEvents():this.vm.selectProperty?animation_ctrl_1.animationCtrl.copyProp(this.vm.selectProperty):this.vm.selectedId&&animation_ctrl_1.animationCtrl.copyNodeData([animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId]])}paste(){if(this.isLock)return animation_ctrl_1.animationCtrl.copyEventInfo&&this.vm.animationMode&&!this.vm.maskPanel?void animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):void(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump&&animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")));animation_ctrl_1.animationCtrl.copyKeyInfo?animation_ctrl_1.animationCtrl.pasteKey({target:this.vm.currentFrame,nodePath:this.vm.computeSelectPath},animation_ctrl_1.animationCtrl.getClipBoardData("key")):(animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump&&animation_ctrl_1.animationCtrl.pasteEmbeddedPlayer(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("embeddedPlayer")),animation_ctrl_1.animationCtrl.copyEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(this.vm.currentFrame,animation_ctrl_1.animationCtrl.getClipBoardData("event")):this.vm.selectProperty&&animation_ctrl_1.animationCtrl.copyPropInfo?animation_ctrl_1.animationCtrl.pasteProp(this.vm.selectProperty,animation_ctrl_1.animationCtrl.getClipBoardData("prop")):this.vm.selectedId&&animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[this.vm.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("node")||animation_ctrl_1.animationCtrl.getClipBoardData("prop")))}updateSelectKey(e){const t=this.vm;if(!t.selectKeyInfo&&!e)return;const a=JSON.parse(JSON.stringify(t.selectKeyInfo||e));if(!a.sortDump){if(!e.nodePath)return;a.sortDump={}}const{nodePath:r,prop:i}=e,n=r+i;if(!a.sortDump[n]&&!e.keyFrames.length||!i)return;const o=e.keyFrames.map(e=>e.frame)||[];a.sortDump[n]={keyFrames:e.keyFrames,prop:i,nodePath:r,frames:o},e.keyFrames.length||delete a.sortDump[n];let s=[];Object.keys(a.sortDump).map(e=>{const t=a.sortDump[e];t.keyFrames.length||delete a.sortDump[e],s=s.concat(t.keyFrames)}),a.keyFrames=s.sort((e,t)=>e.frame-t.frame),t.selectKeyInfo=a}getPositionAtSelect(e){return this.vm.selectKeyInfo?this.vm.selectKeyInfo.keyFrames.findIndex(t=>t.prop===e.prop&&t.frame===e.frame&&t.nodePath===e.nodePath):-1}removeSelectKey(e){if(!this.vm.selectKeyInfo||!this.vm.selectKeyInfo.keyFrames)return!1;const t=JSON.parse(JSON.stringify(this.vm.selectKeyInfo));return this.vm.selectKeyInfo.keyFrames.forEach((a,r)=>{e.find(e=>Lodash.isEqual(a,e))&&(t.keyFrames.splice(r,1),t.keyFrames.splice(r,1))}),delete t.sortDump,this.vm.selectKeyInfo=t,!0}async deleteSelecteEmbeddedPlayers(){if(!this.vm.selectEmbeddedPlayerInfo)return!1;const e=[];return this.vm.selectEmbeddedPlayerInfo.forEach(t=>{e.push((0,ipc_event_1.deleteEmbeddedPlayer)(this.vm.currentClip,this.transEmbeddedPlayerInfoToDump(t,!1)))}),this.vm.selectEmbeddedPlayerInfo=null,Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")),await(0,ipc_event_1.IApplyOperation)(e)}openEventEditor(e){this.vm.editEventFrame=e,this.vm.maskPanel="event"}closeMaskPanel(){this.vm.maskPanel=""}setMovePath(e){this.vm.moveNodePath=e}cancelMoveNode(){this.vm.moveNodePath=""}selectNode(e,t=!1){if(!animation_ctrl_1.animationCtrl.nodesDump)return;const a=this.vm,r=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[e];if(r){const e=[r[0]];e[0]!==a.selectedId&&t&&e.push(a.selectedId),a.selectedId=r[0],a.selectPath="",Editor.Selection.update("node",e)}else a.selectPath=e,a.properties=this.calcProperty(),a.selectedId="",a.selectedIds.clear()}startMoveNode(e){this.vm.moveNodePath=e}startDragKey(e,t=!1){if(!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return;const a=this.vm;if(e){e.keyFrames.sort((e,t)=>e.frame-t.frame),e.sortDump=(0,utils_1.sortKeysToTreeMap)(e.keyFrames);const t=e.keyFrames[0];if(t.nodePath!==a.computeSelectPath){const e=animation_ctrl_1.animationCtrl.nodesDump.path2uuid[t.nodePath];e[0]!==a.selectedId&&(Editor.Selection.unselect("node",a.selectedId),Editor.Selection.select("node",e[0]),a.selectedId=e[0])}if(!this.vm.selectProperty||this.vm.selectProperty.prop!==t.prop||this.vm.selectProperty.nodePath!==t.nodePath){const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.nodePath][t.prop];exports.animationEditor.updateSelectProperty({nodePath:t.nodePath,prop:t.prop,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid,isCurveSupport:e.isCurveSupport}),this.selectKeyUpdateFlag=!0}}a.selectKeyInfo=e,a.updateSelectKey++,t||(global_data_1.Flags.mouseDownName="key")}async updateSelectProperty(e){const t=this.vm;if(e.clipUuid!==this.vm.currentClip||e.nodePath!==this.vm.computeSelectPath)return;const a=await(0,ipc_event_1.IgetPropValueAtFrame)(e.clipUuid,e.nodePath,e.prop,t.currentFrame);a&&(t.selectProperty=Object.assign(e,{dump:a,type:{value:a.type,extends:a.extends}}),t.lightCurve=null)}startDragEvent(e,t=!1){this.vm.selectEventInfo=e,t?"event"===global_data_1.Flags.mouseDownName&&(global_data_1.Flags.mouseDownName=""):global_data_1.Flags.mouseDownName="event"}updateMouseFrame(e,t){const a=this.vm;if(!e||!e.x&&!e.y)return void(a.moveInfo=null);const r=grid_ctrl_1.gridCtrl.pageToCtrl(e.x,e.y),i=e.frame||grid_ctrl_1.gridCtrl.pageToFrame(e.x);a.moveInfo?(a.moveInfo.frame=i,a.moveInfo.x=r.x+5,a.moveInfo.y=r.y+5,a.moveInfo.offsetFrame=t||0):a.moveInfo={frame:i,x:r.x+5,y:r.y+5,offsetFrame:t||0}}updatePropExpandState(e,t){const a=this.vm;a.expandInfo[e]=t;const r=a.properties[e].partKeys;r?(r.forEach(e=>{a.properties[e].hidden=!t}),a.properties=this.calcProperty(),requestAnimationFrame(()=>{a.updateSelectKey++})):console.log(`[Animation Editor] Can't get partKeys of prop(${e})`)}showFrameInGrid(e){const{start:t,end:a}=grid_ctrl_1.gridCtrl.getFrameRang();e>=a?this.setGridHeaderFrame(e):e<=t&&this.setGridFooterFrame(e)}setGridHeaderFrame(e){const{start:t}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(e))}setGridFooterFrame(e){const{end:t}=grid_ctrl_1.gridCtrl.getFrameRang(),a=grid_ctrl_1.gridCtrl.frameToCanvas(t);this.moveTimeLine(a-grid_ctrl_1.gridCtrl.frameToCanvas(e))}moveTimeLine(e){const t=this.vm;grid_ctrl_1.gridCtrl.grid.transferX(e),t.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,t.updatePosition++,this.updatePositionInfo("move"),grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis(),this.vm.$refs.curve.curveCtrl&&(this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.rePaint())}scaleTimeLineAt(e,t){const a=this.vm,r=(0,utils_1.smoothScale)(e,grid_ctrl_1.gridCtrl.scale);e<0&&r<=grid_ctrl_1.gridCtrl.grid.xMinScale||e>0&&r>=grid_ctrl_1.gridCtrl.grid.xMaxScale||(grid_ctrl_1.gridCtrl.grid.xAxisScaleAt(t,r),a.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.rePaint(),this.updatePositionInfo(),a.updatePosition++,grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis())}scaleTimeLineWith(e){const t=this.vm,a=(grid_ctrl_1.gridCtrl.grid.xMaxScale-grid_ctrl_1.gridCtrl.grid.xMinScale)*(e/100);a<=grid_ctrl_1.gridCtrl.grid.xMinScale||a>=grid_ctrl_1.gridCtrl.grid.xMaxScale||(grid_ctrl_1.gridCtrl.grid.xAxisScale=a,this.vm.$refs.curve.curveCtrl.grid.xAxisScale=grid_ctrl_1.gridCtrl.grid.xAxisScale,this.vm.$refs.curve.curveCtrl.grid.xAxisOffset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.vm.$refs.curve.curveCtrl.rePaint(),this.updatePositionInfo(),t.updatePosition++,grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis())}runPointer(){const e=this.vm;this.aniPlayTask=requestAnimationFrame(async()=>{"play"===e.animationState&&e.animationMode?(await this.checkCurrentTime(),this.runPointer()):(this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),await this.checkCurrentTime())})}setCurrentFrame(e){const t=this.vm;e<0&&(e=0),t.currentFrame=e,0!==e?this.showFrameInGrid(e):grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset!==grid_ctrl_1.gridCtrl.startOffset&&this.moveTimeLine(grid_ctrl_1.gridCtrl.startOffset-grid_ctrl_1.gridCtrl.grid.xAxisOffset)}updateCurrentFrame(e){this.setCurrentFrame(e);const t=(0,utils_1.frameToTime)(e,this.vm.sample);(0,ipc_event_1.IsetCurEditTime)(t)}jumpPrevFrame(){this.vm.currentFrame>0&&this.updateCurrentFrame(--this.vm.currentFrame)}jumpNextFrame(){this.updateCurrentFrame(++this.vm.currentFrame)}jumpFirstFrame(){this.updateCurrentFrame(0)}jumpLastFrame(){this.updateCurrentFrame(this.vm.lastFrameInfo.frame)}async nextStep(){const e=this.vm;this.isLock||(e.selectKeyInfo?this.moveSelectKeys(1,!0):e.selectEmbeddedPlayerInfo?this.moveSelectEmbeddedPlayers(1):e.selectEventInfo?await this.moveSelectEvents(1,!0):this.jumpNextFrame())}async prevStep(){if(this.isLock)return;const e=this.vm;e.selectKeyInfo?this.moveSelectKeys(-1,!0):e.selectEmbeddedPlayerInfo?this.moveSelectEmbeddedPlayers(-1):e.selectEventInfo?await this.moveSelectEvents(-1,!0):this.jumpPrevFrame()}jumpToNextKey(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath)return;let t=[];if(t=e.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath][e.selectProperty.prop].keyFrames:this.calcNodeFrames(e.computeSelectPath,!0),e.currentFrame>t[t.length-1].frame)this.updateCurrentFrame(t[t.length-1].frame);else for(const a of t)if(a.frame>e.currentFrame)return void this.updateCurrentFrame(a.frame)}jumpToPrevKey(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath)return;let t=[];if(t=e.selectProperty?animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath][e.selectProperty.prop].keyFrames:this.calcNodeFrames(e.computeSelectPath,!0),e.currentFrame<t[0].frame)this.updateCurrentFrame(t[0].frame);else for(let a=t.length-1;a>=0;a--){const r=t[a].frame;if(r<e.currentFrame)return void this.updateCurrentFrame(r)}}async moveSelectEmbeddedPlayers(e){const t=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.selectEmbeddedPlayerInfo)return;const a=[];for(const r of t.selectEmbeddedPlayerInfo){const t=Math.max(r.rawInfo.begin+e,0)-r.rawInfo.begin;if(0===t)return;const i=Object.assign(Object.assign({},r.rawInfo),{begin:r.rawInfo.begin+t,end:r.rawInfo.end+t});a.push((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,r.rawInfo,i)),Object.assign(r,this.transEmbeddedPlayerDumpToInfo(i))}await(0,ipc_event_1.IApplyOperation)(a)}async moveSelectKeys(e,t=!1){const a=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!a.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(a.selectKeyInfo));r.offsetFrame=r.offsetFrame||0;const{keyFrames:i}=r,n=[];for(let r=0;r<i.length;r++){const o=i[r];let s=o.frame+e;if(s<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!a.selectKeyInfo.keyFrames.find(e=>e.frame===s)){const a=i[r],n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath][a.prop].keyFrames;for(;n.find(e=>e.frame===s);){if(!t||this.hasShowStick)return;e=e>0?e+1:e-1,s=o.frame+e}}n.push(s),o.frame=s,o.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(o.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}0!==n.length&&(n.sort((e,t)=>e-t),e>0?this.showFrameInGrid(n[n.length-1]):this.showFrameInGrid(n[0]),r.ctrl=t,r.offsetFrame+=e,a.selectKeyInfo=r,await animation_ctrl_1.animationCtrl.moveKeys())}async moveSelectEvents(e,t){const a=this.vm,{data:r,frames:i}=a.selectEventInfo,n=[];for(const a of r){let r=a.frame+e;if(r<0)return void this.showToast("i18n:animator.move_key_tips.can_not_be_zero");if(!i.includes(r))for(;animation_ctrl_1.animationCtrl.clipsDump.events.find(e=>e.frame===r);){let n="";if(n=t&&1===i.length?"i18n:animator.move_key_tips.move_with_ctrl":t&&1!==i.length?"i18n:animator.move_key_tips.move_keys_with_ctrl":"i18n:animator.move_key_tips.should_move_keys_with_ctrl",this.showToast(n),!t||1!==i.length)return;e=e>0?e+1:e-1,r=a.frame+e}n.push(r),a.frame=r,a.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(a.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset}n.sort((e,t)=>e-t),e>0?this.showFrameInGrid(n[i.length-1]):this.showFrameInGrid(n[0]),a.selectEventInfo.offsetFrame+=e,await animation_ctrl_1.animationCtrl.callByDebounce("moveEvents")}onKeyMouseMove(e){const t=this.vm,a=e.target;if(!t.selectKeyInfo)return;const r=JSON.parse(JSON.stringify(t.selectKeyInfo)),{startX:i,keyFrames:n,location:o,nodePath:s}=r;if(Math.abs(i-e.x)<.1)return;e.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const l=grid_ctrl_1.gridCtrl.pageToFrame(e.x);let c=grid_ctrl_1.gridCtrl.pageToFrame(i);c<0&&(c=0);const m=l-c;if(0===m)return;const d=grid_ctrl_1.gridCtrl.grid.valueToPixelH(l)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(c),p=[];for(const e of n){if(!e)continue;if("prop"===o&&s&&e.nodePath!==s){e.offsetFrame=0,p.push(e.frame);continue}const t=e.frame+m;if(t<0)return;e.x+=d,e.frame=t,p.push(t)}r.startX+=d,r.offset+=d,r.offsetFrame+=m,global_data_1.Flags.startDragStickInfo||this.updateMouseFrame({x:e.x,y:e.y,frame:n[0].frame},r.offsetFrame),t.selectKeyInfo=r,p.sort((e,t)=>e-t);const{start:u,end:f}=grid_ctrl_1.gridCtrl.getFrameRang();(p[0]<=u||p[p.length-1]>=f)&&this.moveTimeLine(-d)}onEmbeddedPlayerMouseMove(e){const t=this.vm;if(!global_data_1.Flags.startDragEmbeddedPlayerInfo||!t.selectEmbeddedPlayerInfo)return;const a=e.x-global_data_1.Flags.startDragEmbeddedPlayerInfo.startX;if(0===a)return;const r=e.target;switch(global_data_1.Flags.startDragEmbeddedPlayerInfo.offset=a,console.debug(global_data_1.Flags.startDragEmbeddedPlayerInfo.type),global_data_1.Flags.startDragEmbeddedPlayerInfo.type){case"center":e.altKey?r.style.cursor="copy":r.style.cursor="move",t.selectEmbeddedPlayerInfo.forEach(e=>{e.x=e.rawInfo.x+a});break;case"left":r.style.cursor="em-resize",t.selectEmbeddedPlayerInfo.forEach(e=>{const t=e.x;e.x=Math.max(0,e.rawInfo.x+a),e.width=e.rawInfo.width-(t-e.rawInfo.x)});break;case"right":t.selectEmbeddedPlayerInfo.forEach(e=>{e.width=e.rawInfo.width+a})}}async onEmbeddedPlayerMouseUp(e){const t=this.vm;if(!global_data_1.Flags.startDragEmbeddedPlayerInfo||!t.selectEmbeddedPlayerInfo||!global_data_1.Flags.startDragEmbeddedPlayerInfo.offset||"drop"===global_data_1.Flags.startDragEmbeddedPlayerInfo.type)return;const a=[];t.selectEmbeddedPlayerInfo.forEach(e=>{a.push((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,this.transEmbeddedPlayerInfoToDump(e,!1),this.transEmbeddedPlayerInfoToDump(e,!0)))}),await(0,ipc_event_1.IApplyOperation)(a)}async onEmbeddedPlayerDrop(e,t){const{value:a}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};e.preventDefault(),e.stopPropagation();const r=JSON.parse(a),i=this.transEmbeddedPlayerInfoToDump(r,!1),n=e.x-global_data_1.Flags.startDragEmbeddedPlayerInfo.startX;r.x=r.rawInfo.x+n,r.group=t;const o=this.transEmbeddedPlayerInfoToDump(r,!0);await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,i,o))}onKeyMouseUp(e,t){if((t&&t.alt||e.altKey)&&this.vm.selectKeyInfo){const e=t&&t.target||this.vm.currentFrame;animation_ctrl_1.animationCtrl.pasteKey({target:e,nodePath:this.vm.selectKeyInfo.keyFrames[0].nodePath},animation_ctrl_1.animationCtrl.transSelectToCopyKeyInfo())}else animation_ctrl_1.animationCtrl.moveKeys()}onEventMouseMove(e){const t=this.vm;if(!t.selectEventInfo)return;const a=e.target;e.altKey?a.style.cursor="copy":a.style.cursor="ew-resize";const{startX:r,data:i}=t.selectEventInfo,n=grid_ctrl_1.gridCtrl.pageToFrame(e.x);let o=grid_ctrl_1.gridCtrl.pageToFrame(r);o<0&&(o=0);const s=n-o;if(0===s)return;const l=grid_ctrl_1.gridCtrl.grid.valueToPixelH(n)-grid_ctrl_1.gridCtrl.grid.valueToPixelH(o);t.selectEventInfo.startX+=l,t.selectEventInfo.offset+=l,t.selectEventInfo.offsetFrame+=s;for(const e of i)if(e.x+=l,e.frame+=s,e.frame<0)return;this.updateMouseFrame({x:e.x,y:e.y,frame:i[0].frame},t.selectEventInfo.offsetFrame);const{start:c,end:m}=grid_ctrl_1.gridCtrl.getFrameRang();(i[0].frame<=c||i[i.length-1].frame>=m)&&this.moveTimeLine(-l)}onEventMouseUp(e){const t=grid_ctrl_1.gridCtrl.pageToFrame(e.x+grid_ctrl_1.gridCtrl.startOffset);e.altKey&&this.vm.selectEventInfo?animation_ctrl_1.animationCtrl.pasteEvent(t,{eventsDump:this.vm.selectEventInfo.data}):this.vm.selectEventInfo&&0===this.vm.selectEventInfo.offsetFrame||animation_ctrl_1.animationCtrl.moveEvents()}onStartDragSuregion(e,t){if((0,utils_1.checkCtrlOrCommand)(e)&&this.vm.selectEmbeddedPlayerInfo){const e=this.vm.selectEmbeddedPlayerInfo.findIndex(e=>e.key===t.key);-1===e?this.vm.selectEmbeddedPlayerInfo.push(Object.assign(Object.assign({},t),{rawInfo:JSON.parse(JSON.stringify(t))})):this.vm.selectEmbeddedPlayerInfo.splice(e,1)}this.vm.selectEmbeddedPlayerInfo=[Object.assign(Object.assign({},t),{rawInfo:JSON.parse(JSON.stringify(t))})],Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer")),Editor.Selection.select("animation-embeddedPlayer",this.vm.selectEmbeddedPlayerInfo.map(e=>JSON.stringify({dump:this.transEmbeddedPlayerInfoToDump(e,!1),clipUuid:this.vm.currentClip,root:animation_ctrl_1.animationCtrl.nodesDump.rawPath}))),global_data_1.Flags.mouseDownName="embeddedPlayer",global_data_1.Flags.startDragEmbeddedPlayerInfo={startX:e.x,type:e.target.getAttribute("name")}}onStickMouseMove(e){const t=this.vm;if(!global_data_1.Flags.startDragStickInfo||!t.selectKeyInfo)return;const a=e.x-global_data_1.Flags.startDragStickInfo.startX;if(0!==a)switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseMove(e);break;case"right":{const e=1+a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,i=r[0];for(let a=1;a<r.length;a++){const n=r[a];if(n.frame===i.frame)continue;let o=(n.x-i.x)*e+i.x,s=grid_ctrl_1.gridCtrl.canvasToFrame(o);s===i.frame&&(s=i.frame+(e>1?-1:1)),o=grid_ctrl_1.gridCtrl.frameToCanvas(s),this.stickInfo.width=o+12-this.stickInfo.left,t.selectKeyInfo.keyFrames[a].offsetFrame=s-t.selectKeyInfo.keyFrames[a].rawFrame,Object.assign(t.selectKeyInfo.keyFrames[a],{x:o,frame:s})}t.updateSelectKey++}break;case"left":{const e=a/global_data_1.Flags.startDragStickInfo.width,r=global_data_1.Flags.startDragStickInfo.cacheData,i=r[r.length-1];for(let a=r.length-2;a>=0;a--){const n=r[a];if(n.frame===i.frame)continue;let o=(i.x-n.x)*e+n.x,s=grid_ctrl_1.gridCtrl.canvasToFrame(o);s===i.frame&&(s=i.frame+(e>1?-1:1)),o=grid_ctrl_1.gridCtrl.frameToCanvas(s),t.selectKeyInfo.keyFrames[a].offsetFrame=s-t.selectKeyInfo.keyFrames[a].rawFrame,Object.assign(t.selectKeyInfo.keyFrames[a],{x:o,frame:s})}t.updateSelectKey++}}}async update(e,t){var a;const r=this.vm;if(e===r.root&&"node-change"===t){const t=await Editor.Message.request("scene","query-node-tree",e);return this.updateRoot(t),await this.updateClipMenu()||(this.calcNodes(),this.calcDisplayClips()),void(r.compIndex=animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.nodesDump.compIndex)}let i;if("node-change"!==t&&r.animationMode)e!==r.selectedId?r.selectedId=e:r.selectPath&&(r.selectPath="",r.properties=this.calcProperty());else if(i=await(0,ipc_event_1.IqueryAnimationRoot)(e)){console.debug("start queryAnimationRootInfo"),console.time("queryAnimationRootInfo");const t=await(0,ipc_event_1.IqueryAnimationRootInfo)(i);if(console.timeEnd("queryAnimationRootInfo"),!t.nodeTreeDump||!t.nodeTreeDump.name)return console.debug(`Invalid node info ${t.nodeTreeDump}`),void this.updateRoot(t.nodeTreeDump);if(console.time("updateRoot"),this.updateRoot(t.nodeTreeDump),console.timeEnd("updateRoot"),r.root=t.root,r.compIndex=null===(a=animation_ctrl_1.animationCtrl.nodesDump)||void 0===a?void 0:a.compIndex,"number"==typeof r.compIndex){r.clipsMenu=t.clipsMenu;const{defaultClip:a}=t;if(!(a||r.clipsMenu&&0!==r.clipsMenu.length))return this.updateClips(null),r.selectedId=e,void(r.nodeDump=Object.freeze(JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))));this.updatePlayState(t.state),"number"==typeof t.time&&0!==t.time&&this.setCurrentFrame((0,utils_1.timeToFrame)(t.time,r.sample)),r.currentClip=t.defaultClip||t.clipsMenu[0].uuid,await this.updateClips(t.clipDump||r.currentClip,"update"),r.selectedId=e;const i=await(0,ipc_event_1.IquerySceneMode)();r.animationMode="animation"===i}else r.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes),await this.updateClips(null)}else{r.root=e;const t=await Editor.Message.request("scene","query-node-tree",e);this.updateRoot(t),r.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump?animation_ctrl_1.animationCtrl.nodesDump.nodes:null),r.compIndex=null,await this.updateClips(null),r.selectedId=e}}async updateClipMenu(){const e=this.vm,t=await(0,ipc_event_1.IqueryclipsMenuInfo)(e.root);if(!t||t&&t.clipsMenu&&0===t.clipsMenu.length)return e.clipsMenu=[],this.updateClips(null),!0;if(e.clipsMenu=t.clipsMenu,e.currentClip!==t.defaultClip){if(-1===t.clipsMenu.findIndex(t=>t.uuid===e.currentClip)&&e.animationMode||!e.animationMode)return t.defaultClip||(t.defaultClip=t.clipsMenu[0].uuid),await this.updateClips(t.defaultClip),!0}return!1}checkPropTypeInCopyKeyInfo(e){const t=animation_ctrl_1.animationCtrl.copyKeyInfo;if(!t)return!1;for(const a of t.curvesDump)if(a._parentType&&a._parentType.value===e.value||a.type.value===e.value)return!0;return!1}onPropTrackMenu(e,t){if(!this.vm.properties)return!1;const a=t-this.vm.$refs["property-content"].getBoundingClientRect().top+this.vm.propertyScrollInfo.top,r=Object.values(this.vm.properties).find(e=>e.top+this.LINE_HEIGHT>a&&a>e.top);if(!r)return!1;const i=grid_ctrl_1.gridCtrl.pageToFrame(e),n=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropContextMenus,!0);return n.createKey.click=(()=>{animation_ctrl_1.animationCtrl.createKey({frame:i,nodePath:r.nodePath,prop:r.prop})}),n.pasteKey.enabled=this.checkPropTypeInCopyKeyInfo(r.type),n.pasteKey.click=(()=>{animation_ctrl_1.animationCtrl.pasteKey({target:i,nodePath:r.nodePath,prop:r.prop})}),Editor.Menu.popup({x:e,y:t,menu:[...Object.values(n),{label:`frame: ${i}`,enabled:!1}]}),!0}onNodeTrackMenu(e,t){const a=t-this.vm.$refs["node-content"].getBoundingClientRect().top+this.vm.nodeScrollInfo.top;return!!this.vm.nodeDump.find(e=>e.top+this.LINE_HEIGHT>a&&a>e.top)}spacingSelectedKeys(e){this.selectKeyUpdateFlag=!0,animation_ctrl_1.animationCtrl.spacingKeys(e)}onStickMouseUp(e){if(2===e.button){const t=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onStickMenus,!0);return t.copyKey.click=(()=>{animation_ctrl_1.animationCtrl.copyKey()}),t.spacingKeys.click=(()=>{this.spacingSelectedKeys(exports.animationEditor.spacingFrame)}),t.removeKey.click=(()=>{animation_ctrl_1.animationCtrl.removeKey()}),void Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:Object.values(t)})}if(global_data_1.Flags.startDragStickInfo){switch(global_data_1.Flags.startDragStickInfo.type){case"center":this.onKeyMouseUp(e,{target:this.stickInfo.leftFrame});break;case"right":case"left":this.onKeyMouseUp(e)}global_data_1.Flags.startDragStickInfo=null}}onStartResize(e,t){global_data_1.Flags.mouseDownName="resize",global_data_1.Flags.startResizeInfo={type:t,start:0};const a=e.target;"left"===t&&(a.style.cursor="ew-resize")}onResizeMouseMove(e){if(!global_data_1.Flags.startResizeInfo)return;const t=global_data_1.Flags.startResizeInfo.type,a=global_data_1.Flags.startResizeInfo.start;let r=0;if("left"===t?(r=e.x,this.vm.letfResizeMoving=!0):r=e.y+25,!a)return void(global_data_1.Flags.startResizeInfo.start=r);if(e.x<this.layoutConfig.leftMin||e.x>this.layoutConfig.leftMax)return;const i=e.y-32-this.vm.$refs.container.getBoundingClientRect().top;if("left"!==t&&(i>this.layoutConfig.topMax||i<this.layoutConfig.topMin))return;if("top"===t&&!this.vm.expandLayout.embeddedPlayer||"center"===t&&!this.vm.expandLayout.node||"center"===t&&!this.vm.expandLayout.property)return;global_data_1.Flags.startResizeInfo.start=r;const n=t+"Pec",o="left"===t?this.vm.$refs.container.offsetWidth:this.vm.$refs.container.offsetHeight;let s=(parseFloat(this.vm.layout[n])/100*o||0)+r-a;const l=(s=Editor.Utils.Math.clamp(s,this.layoutConfig[`${t}Min`],this.layoutConfig[`${t}Max`]))/o*100;"topPec"===n&&(this.vm.layout.centerPec=this.vm.layout.topPec+this.vm.layout.centerPec-l),this.vm.layout[n]=l}onResizeMouseUp(e){this.vm.letfResizeMoving=!1,global_data_1.Flags.startResizeInfo=null,this.setConfig("layout",this.vm.layout),e.target.style="default"}onMouseUp(e){var t;if(!["grid","pointer","time-pointer","resize","property","key","event","node","property-list-content","embeddedPlayer"].includes(global_data_1.Flags.mouseDownName)&&exports.animationEditor.isLock)return;const a=exports.animationEditor.vm;switch(e.target.style.cursor="default",global_data_1.Flags.onSelecting=!1,global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseUp(e,{target:grid_ctrl_1.gridCtrl.pageToFrame(e.x)});break;case"embeddedPlayer":exports.animationEditor.onEmbeddedPlayerMouseUp(e);break;case"event":exports.animationEditor.onEventMouseUp(e);break;case"stick":exports.animationEditor.onStickMouseUp(e);break;case"resize":exports.animationEditor.onResizeMouseUp(e);break;case"time-pointer":{let t=grid_ctrl_1.gridCtrl.pageToFrame(e.x);if(t<0&&(t=0),2!==e.button){a.currentFrame=t;const e=(0,utils_1.frameToTime)(t,a.sample);(0,ipc_event_1.IsetCurEditTime)(e)}else{const a=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onTimerContextMenus,!0);a.createEventKey.click=(()=>{animation_ctrl_1.animationCtrl.addEvent(t),global_data_1.Flags.mouseDownName=""}),a.pasteEventKey.enabled=!!animation_ctrl_1.animationCtrl.copyEventInfo,a.pasteEventKey.click=(()=>{animation_ctrl_1.animationCtrl.pasteEvent(t),global_data_1.Flags.mouseDownName=""}),Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:Object.values(a)})}}break;case"property":!a.boxInfo&&exports.animationEditor.onPropTrackMenu(e.x,e.y);break;case"property-list-content":if(2===e.button){const r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropListContextMenus,!0);r.pasteProp.enabled=!(!animation_ctrl_1.animationCtrl.copyPropInfo||!a.selectedId),r.pasteProp.click=(()=>{animation_ctrl_1.animationCtrl.pasteNodeData(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[a.selectedId],animation_ctrl_1.animationCtrl.getClipBoardData("prop"))}),r.createProp.submenu=a.displayPropertiesMenu,r.createProp.enabled=!!a.selectedId&&!!a.displayPropertiesMenu.length&&!(null===(t=a.clipConfig)||void 0===t?void 0:t.isLock),Editor.Menu.popup({x:e.pageX,y:e.pageY,menu:Object.values(r)})}break;case"grid":if(2===e.button)break;setTimeout(()=>{global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null},10)}a.boxInfo=null,a.boxStyle=null,a.boxData=null,global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,a.moveInfo=null}onMouseMove(e){if(!["grid","pointer","time-pointer","resize","event","key","property","node","embeddedPlayer"].includes(global_data_1.Flags.mouseDownName)&&(exports.animationEditor.isLock||global_data_1.Flags.onScrolling||!e.buttons)||exports.animationEditor.vm.maskPanel)return;const t=exports.animationEditor.vm,a=e.target,{x:r,y:i,button:n}=e,o=t.$refs.gridCanvas.getBoundingClientRect();switch(global_data_1.Flags.mouseDownName&&(t.previewPointer=null),global_data_1.Flags.mouseDownName){case"key":exports.animationEditor.onKeyMouseMove(e);break;case"embeddedPlayer":exports.animationEditor.onEmbeddedPlayerMouseMove(e);break;case"event":exports.animationEditor.onEventMouseMove(e);break;case"stick":a.style.cursor="ew-resize",requestAnimationFrame(()=>{exports.animationEditor.onStickMouseMove(e)});break;case"resize":global_data_1.Flags.startResizeInfo&&"left"===global_data_1.Flags.startResizeInfo.type&&(a.style.cursor="ew-resize"),requestAnimationFrame(()=>{exports.animationEditor.onResizeMouseMove(e)});break;case"grid":case"property":case"node":{if(!global_data_1.Flags.startDragGridInfo)break;a.style.cursor="-webkit-grabbing";const e=r-global_data_1.Flags.startDragGridInfo.lastStart;if(0===e)return;global_data_1.Flags.mouseDownName="grid",global_data_1.Flags.startDragGridInfo.lastStart=r,requestAnimationFrame(()=>{exports.animationEditor.moveTimeLine(e)})}break;case"pointer":case"time-pointer":{a.style.cursor="ew-resize";let r=grid_ctrl_1.gridCtrl.pageToFrame(e.x);r<0&&(r=0),t.currentFrame=r,(0,ipc_event_1.IsetCurEditTime)((0,utils_1.frameToTime)(t.currentFrame,t.sample))}}if(!global_data_1.Flags.mouseDownName){if(r<o.x||r>o.x+o.width||i<o.y||i>o.y+o.height)return;a.style.cursor="";const e=grid_ctrl_1.gridCtrl.pageToCtrl(r,i),n=grid_ctrl_1.gridCtrl.pageToFrame(r);if(n<0)return;if(t.previewPointer&&t.previewPointer.frame===n&&t.previewPointer.y===e.y)return;return global_data_1.Flags.previewPointerTask&&clearTimeout(global_data_1.Flags.previewPointerTask),e.y+=24,e.y<32&&(e.y=32),void requestAnimationFrame(()=>{t.previewPointer={frame:n,x:e.x-grid_ctrl_1.gridCtrl.startOffset,y:e.y},global_data_1.Flags.previewPointerTask=setTimeout(()=>{t.previewPointer=null},1e3)})}if(["node","property"].includes(global_data_1.Flags.mouseDownName)&&0===e.button){if(global_data_1.Flags.onSelecting=!0,exports.animationEditor.isLock)return;requestAnimationFrame(()=>{t.boxInfo&&(t.boxInfo.x=e.x,t.boxInfo.y=e.y,t.boxStyle=exports.animationEditor.calcBoxStyle())})}}checkSelectData(){this.checkSelectProperty(),this.checkSelectEvents(),this.checkSelectKeys(),this.checkSelectEmbeddedPlayers()}checkSelectEmbeddedPlayers(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers)return e.selectEmbeddedPlayerInfo=null,void Editor.Selection.unselect("animation-embeddedPlayer",Editor.Selection.getSelected("animation-embeddedPlayer"));const t=Editor.Selection.getSelected("animation-embeddedPlayer");if(t){const a=[];for(const r of t){const t=JSON.parse(r);if(t.clipUuid!==e.currentClip){Editor.Selection.unselect("animation-embeddedPlayer",r);continue}const i=this.transEmbeddedPlayerDumpToInfo(t.dump);a.push(Object.assign(Object.assign({},i),{rawInfo:JSON.parse(JSON.stringify(i))}))}a.length&&(e.selectEmbeddedPlayerInfo=a)}e.selectEmbeddedPlayerInfo&&(e.selectEmbeddedPlayerInfo=e.selectEmbeddedPlayerInfo.filter(e=>{const t=animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[e.group];if(!t||!t.length)return!1;const a=this.transEmbeddedPlayerInfoToDump(e,!0),r=t.find(e=>Lodash.isEqual(e,a));return!!r&&(Object.assign(e,r),e.rawInfo=JSON.parse(JSON.stringify(r)),!0)}))}checkSelectProperty(){const e=this.vm;e.selectProperty&&e.selectPropData&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid).includes(e.selectProperty.nodePath)&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.selectProperty.nodePath][e.selectPropData.prop]||(e.selectProperty=null))}checkSelectEvents(){const e=this.vm;if(!e.selectEventInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.events)return void(e.selectEventInfo=null);const t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>e.frame);if(!t.length)return void(e.selectEventInfo=null);const a=[];for(const r of e.selectEventInfo.frames){-1!==t.indexOf(r)&&a.push(r)}0===a.length?e.selectEventInfo=null:e.selectEventInfo.frames=a}checkSelectKeys(){const e=this.vm;if(!e.selectKeyInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump)return void(e.selectKeyInfo=null);const t=[];if(e.selectKeyInfo.keyFrames.forEach((a,r)=>{if(!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath]||!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath][a.prop])return;const i=e.selectKeyInfo.keyFrames[r];animation_ctrl_1.animationCtrl.clipsDump.pathsDump[a.nodePath][a.prop].keyFrames.map(e=>e.frame).includes(i.frame)&&(i.rawFrame=a.frame,delete i.offsetFrame,t.push(i))}),0===t.length)return void(e.selectKeyInfo=null);const a=(0,utils_1.sortKeysToTreeMap)(t);Object.assign(e.selectKeyInfo,{keyFrames:t,sortDump:a,offsetFrame:0,offset:0,startX:e.selectKeyInfo.startX}),e.updateSelectKey++}resetState(){const e=this.vm;this.updateClips(null),e.compIndex=null,e.animationMode=!1,e.clipConfig=null,e.nodeDump=null}calcCreatePropMenu(e){let t=[];if(e.key){const a=e.menuName?e.menuName:e.displayName;return t.push({label:a,enabled:!e.disable,click:()=>{this.createProp(e.key)}}),t}for(const a of Object.keys(e)){const r=e[a];r.key?t=t.concat(this.calcCreatePropMenu(r)):t.push({label:a,submenu:this.calcCreatePropMenu(r)})}return t}async createProp(e){let t=!1;const a=this.vm;if(a.selectedIds&&a.selectedIds.size>1){let e=Array.from(a.selectedIds);if((e=e.filter(e=>animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e])).length>1){const e=await Editor.Dialog.info(Editor.I18n.t("animator.is_add_prop_multi.title"),{buttons:[Editor.I18n.t("animator.is_add_prop_multi.add_to_current"),Editor.I18n.t("animator.is_add_prop_multi.add_to_all")],default:0,cancel:-1});if(-1===e.response)return;t=!!e.response}}animation_ctrl_1.animationCtrl.createProp({prop:e},t)}async updateSelectedId(){const e=this.vm;!e.selectedId&&e.animationMode||(e.selectedId?e.propertiesMenu=await(0,ipc_event_1.IqueryPropertieMenu)(e.selectedId):(e.root="",this.resetState(),e.propertiesMenu=null),e.properties=this.calcProperty(),this.jumpToSelectedNode())}jumpToSelectedNode(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.nodesDump)return;const t=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,a=t.findIndex(t=>t.uuid===e.selectedId&&"number"==typeof t.listIndex);if(-1===a)return;const r=(t[a].listIndex+1)*this.LINE_HEIGHT,{top:i,height:n}=e.nodeScrollInfo;(r-i>n||r-i<0)&&(e.nodeScrollInfo.top=Editor.Utils.Math.clamp(r-n/2+this.LINE_HEIGHT,0,t.length*this.LINE_HEIGHT-n+this.LINE_HEIGHT),this.calcDisplayClips())}calcBoxStyle(){const e=this.vm;if(!e.boxInfo||!e.boxInfo.type||e.lock)return null;const{startX:t,startY:a,type:r,x:i,y:n}=e.boxInfo,o=grid_ctrl_1.gridCtrl.pageToCtrl(i,n),{offsetTop:s,offsetHeight:l,offsetWidth:c}=e.$refs[`${r}-content`],m=Editor.Utils.Math.clamp(o.x,0,c),d=Editor.Utils.Math.clamp(o.y,s,s+l),p=t-m,u=a-d;if(!p||!u)return null;const f={};return p>0&&u>0?(f.x=m,f.y=d-s):p<0&&u<0?(f.x=t,f.y=a-s):p<0&&u>0?(f.x=t,f.y=d-s):p>0&&u<0&&(f.x=m,f.y=a-s),e.boxData={origin:f,w:Math.abs(p),h:Math.abs(u),type:e.boxInfo.type},{top:`${f.y}px`,left:`${f.x}px`,right:`${Math.round(c-f.x-Math.abs(p))}px`,bottom:`${Math.round(l-f.y-Math.abs(u))}px`}}updatePlayState(e){const t=this.vm;switch(e){case 0:t.animationState="stop",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask),this.checkCurrentTime();break;case 1:if("play"!==animation_ctrl_1.animationCtrl.animationState){console.debug(`Invalid animation state change. (${animation_ctrl_1.animationCtrl.animationState} -> play))`);break}"play"!==t.animationState&&(t.animationState="play",this.runPointer());break;case 2:t.animationState="pause",this.aniPlayTask&&cancelAnimationFrame(this.aniPlayTask)}}async checkCurrentTime(){const e=this.vm,t=await(0,ipc_event_1.IqueryPlayingClipTime)(e.currentClip),a=(0,utils_1.timeToFrame)(t,e.sample);a!==e.currentFrame&&this.setCurrentFrame(a)}updateRoot(e){const t=this.vm;if(e){if(""===e.name||e.isScene)return t.selectedId="",t.root="",t.nodeDump=null,animation_ctrl_1.animationCtrl.clipsDump=null,void(animation_ctrl_1.animationCtrl.nodesDump=null);animation_ctrl_1.animationCtrl.nodesDump=(0,utils_1.formatNodeDump)(e),t.nodeDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes)),t.compIndex=animation_ctrl_1.animationCtrl.nodesDump.compIndex}}async updateClips(e,t){var a;const r=this.vm;if(r.nodeDump&&!r.active)return void this.clearClips();if(!e)return void this.clearClips();let i=e;if(clip_cache_1.animationClipCacheManager.cacheClipDump(r.root,r.currentClip),"string"==typeof e){if(r.currentClip===e&&"update"!==t)return;if(console.time("IqueryClipDump"),i=await(0,ipc_event_1.IqueryClipDump)(r.root,e),console.timeEnd("IqueryClipDump"),!i&&!global_data_1.Flags.sceneReady)return void exports.animationEditor.refreshTask++;if(!i)return console.warn(`Get animation clip data failed! node ${r.root}, clip ${r.currentClip}`),void this.clearClips();r.currentClip=e}if(i){if(animation_ctrl_1.animationCtrl.clipsDump=Object.assign((0,utils_1.formatClipDump)(i),{uuid:r.currentClip}),i.sample!==(null===(a=grid_ctrl_1.gridCtrl.grid)||void 0===a?void 0:a.sample)&&(grid_ctrl_1.gridCtrl.grid.sample=i.sample,grid_ctrl_1.gridCtrl.grid.render(),this.renderTimeAxis()),Object.keys(animation_ctrl_1.animationCtrl.clipConfig).forEach(e=>{var t;animation_ctrl_1.animationCtrl.clipConfig[e]=null!==(t=animation_ctrl_1.animationCtrl.clipsDump[e])&&void 0!==t?t:animation_ctrl_1.animationCtrl.clipConfig[e]}),r.clipConfig=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.clipConfig)),r.clipConfig&&r.clipConfig.duration){const e=Math.min(r.$refs.chart.offsetWidth/(r.clipConfig.duration*r.clipConfig.sample*2),this.gridCtrl.grid.xMinScale),t=Math.max(r.clipConfig.duration*r.clipConfig.sample,this.gridCtrl.grid.xMaxScale);this.gridCtrl.grid.updateScale(e,t)}await r.calcSelectProperty(null,!0)}this.calcEventsDump(),this.calcNodes(),this.calcDisplayClips(),r.properties=this.calcProperty(),this.checkSelectData(),r.updateKeyFrame++}clearClips(){const e=this.vm;e.currentClip="",animation_ctrl_1.animationCtrl.exit(),animation_ctrl_1.animationCtrl.clipsDump=null,e.clipConfig=null,e.eventsDump=null,this.calcDisplayClips(),e.properties=this.calcProperty(),e.embeddedPlayerGroups=[],this.checkSelectData(),e.updateKeyFrame++}calcProperty(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump||!e.computeSelectPath||!grid_ctrl_1.gridCtrl.grid)return null;let t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.computeSelectPath];if(!t)return null;t=JSON.parse(JSON.stringify(t));let a=0;return Object.keys(t).forEach((r,i)=>{const n=t[r];let o=n;if("string"==typeof t[r].parentPropKey){const i=(o=t[t[r].parentPropKey]).partKeys.findIndex(e=>e===n.prop);-1!==i&&n.isCurveSupport&&(n.color=exports.CurveColorList[i]),!0!==e.expandInfo[o.prop]?(e.expandInfo[o.prop]=!1,t[r].hidden=!0):a++}else a++,n.type&&n.isCurveSupport&&(n.color=exports.CurveColorList[3]);t[r].index=Math.max(0,a-1),t[r].top=(a-1)*this.LINE_HEIGHT,e.propertiesMenu&&!(0,utils_1.checkPropertyInMenu)(o,e.propertiesMenu)&&(t[r].missing=!0),n.keyFrames=Object.freeze(calcFrames(n.keyFrames,e.$refs.chart.offsetWidth,this.imageCCTypes.includes(n.type&&n.type.value)))}),t}calcEventsDump(){const e=this.vm;let t=[];return animation_ctrl_1.animationCtrl.clipsDump&&grid_ctrl_1.gridCtrl.grid&&(t=animation_ctrl_1.animationCtrl.clipsDump.events.map(e=>(e.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,e))),e.eventsDump=Object.freeze(t)}calcNodes(){if(!animation_ctrl_1.animationCtrl.nodesDump)return null;if(!animation_ctrl_1.animationCtrl.clipsDump)return;const e=JSON.parse(JSON.stringify(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid)));function t(a,r=!1){const i=a.match(/\//g);if(!i)return;const n=i.length;let o=e.findIndex(e=>!!e.match(/\//g)&&e.match(/\//g).length===n);const s=a.match(/\/([^/]*)$/);if(s){if(0===o&&(o=1),-1===o){o=e.length;const i=a.match(/\/([^/]+)/g);if(i&&!r){let a="";for(const r of i)a+=r,e.includes(a)||t(a,!0);return}}e.splice(o,0,a),animation_ctrl_1.animationCtrl.nodesDump.nodesDump.splice(o,0,{indent:2*n,path:a,name:s[1],uuid:"",keyFrames:[],top:0,rawIndex:o,listIndex:o})}}animation_ctrl_1.animationCtrl.nodesDump.nodesDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes));for(const a of Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump))-1===e.indexOf(a)&&t(a)}calcDisplayNodes(){const e=this.vm;if(!animation_ctrl_1.animationCtrl.nodesDump)return void(e.nodeDump=null);const t=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,a=[];let r=-1;const i=e.filterInvalid||e.filterName;t.forEach((t,n)=>{if(delete t.listIndex,delete t.top,delete t.rawIndex,i){if(t.hidden=!0,e.filterName&&!new RegExp(e.filterName,"i").test(t.name))return;if(e.filterInvalid&&(!t.keyFrames||!t.keyFrames.length))return;t.hidden=!1,r++}else r=n;const o=r*this.LINE_HEIGHT-e.nodeScrollInfo.top;t.top=r*this.LINE_HEIGHT,t.rawIndex=n,t.listIndex=r,o>-this.LINE_HEIGHT&&o<e.nodeScrollInfo.height+this.LINE_HEIGHT&&(a.push(t),t.hidden=!1)});const n=i?r*this.LINE_HEIGHT:t.length*this.LINE_HEIGHT;e.nodesHeight=Math.floor(n),animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump=a,e.nodeDump=a,Math.abs(e.nodeScrollInfo.top-e.$refs.nodes.scrollTop)>this.LINE_HEIGHT&&(e.$refs.nodes.scrollTop=e.nodeScrollInfo.top)}calcDisplayClips(){const e=this.vm;if(!(e.nodeDump&&animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump.nodesDump))return e.clipConfig=null,void this.calcDisplayNodes();this.calcDisplayEmbeddedPlayers();const t=Object.create(null);animation_ctrl_1.animationCtrl.nodesDump.nodesDump.forEach(e=>{t[e.path]=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e.path],!e.disabled&&t[e.path]&&(e.keyFrames=Object.freeze(JSON.parse(JSON.stringify(this.calcNodeFrames(e.path)))))}),e.nodeDump=animation_ctrl_1.animationCtrl.nodesDump.nodesDump,animation_ctrl_1.animationCtrl.clipsDump.displayClipsDump=t,this.calcDisplayNodes()}calcDisplayEmbeddedPlayers(){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers||!animation_ctrl_1.animationCtrl.clipsDump.embeddedPlayerGroups)return{};const e=[];return animation_ctrl_1.animationCtrl.clipsDump.embeddedPlayerGroups.forEach(t=>{let a=[];animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[t.key]&&(a=animation_ctrl_1.animationCtrl.clipsDump.groupToEmbeddedPlayers[t.key].map(e=>this.transEmbeddedPlayerDumpToInfo(e))),e.push({name:t.name,type:t.type,key:t.key,embeddedPlayers:a,menuInfo:utils_1.EmbeddedPlayerMenuMap[t.type]})}),this.vm.embeddedPlayerGroups=e,e}calcNodeFrames(e,t=!1){const a=this.vm;if(!animation_ctrl_1.animationCtrl.clipsDump)return[];const r=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e];if(!r)return[];let i=[];for(const e of Object.keys(r)){const t=calcFrames(r[e].keyFrames,a.$refs.chart.offsetWidth,!1);i=i.concat(t)}return t&&0!==i.length&&i.sort((e,t)=>e.frame-t.frame),i}transEmbeddedPlayerDumpToInfo(e,t){return{x:t="number"==typeof t?t:grid_ctrl_1.gridCtrl.frameToCanvas(e.begin),width:grid_ctrl_1.gridCtrl.frameToCanvas(e.end)-t,reconciledSpeed:e.reconciledSpeed,playable:e.playable,group:e.group,key:(0,utils_1.calcEmbeddedPlayerKey)(e),begin:e.begin,end:e.end}}calcEmbeddedPlayers(e,t){const a=[];return e.forEach(e=>{const r=grid_ctrl_1.gridCtrl.frameToCanvas(e.begin),i=grid_ctrl_1.gridCtrl.frameToCanvas(e.end),n=getDistance(r,t),o=getDistance(i,t);0!==n&&0!==o||a.push(this.transEmbeddedPlayerDumpToInfo(e,r))}),a}transEmbeddedPlayerInfoToDump(e,t){return{begin:t?grid_ctrl_1.gridCtrl.canvasToFrame(e.x):e.begin,end:t?grid_ctrl_1.gridCtrl.canvasToFrame(e.x+e.width):e.end,reconciledSpeed:e.reconciledSpeed,playable:e.playable,group:e.group}}async _refresh(){const e=this.vm,t={w:e.$refs.right.offsetWidth,h:e.$refs.right.offsetHeight};if(!t.w||!t.h)return void(global_data_1.Flags.domReady=!1);if(!this.refreshTask&&global_data_1.Flags.domReady&&e.$refs.gridCanvas.width===t.w&&e.$refs.gridCanvas.height===t.h)return void(e.loading="");Editor.Metrics.trackTimeStart("animator:view-refresh"),e.loading="init_animation_data",global_data_1.Flags.domReady=!0,this.updateScrollInfo(t),requestAnimationFrame(async()=>{this.updateScrollInfo(t)});const a=Editor.Selection.getLastSelected("node"),r=await(0,ipc_event_1.IquerySceneMode)();if(e.animationMode="animation"===r,await this.vmInit(),e.wrapModeList=await Editor.Message.request("scene","query-enum-list-with-path","AnimationClip.WrapMode"),e.wrapModeList.forEach(e=>{e.tip=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.tip`)||e.name,e.name=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.label`)||e.name}),a)console.time("update"),await this.debounceUpdateNode(a),console.timeEnd("update");else if(e.animationMode){const{rootid:e,clipid:t}=await(0,ipc_event_1.IgetEditAnimationInfo)(),a=await Editor.Message.request("scene","query-node-tree",e);console.time("updateRoot"),await this.updateRoot(a),console.timeEnd("updateRoot"),Editor.Metrics.trackTimeStart("animator:update-clips-data"),await this.updateClips(t),Editor.Metrics.trackTimeEnd("animator:update-clips-data",{output:!0,label:`animator:update-clips-data ${t}`}),console.timeEnd("updateClips")}else this.resetState();e.loading="",global_data_1.Flags.sceneReady=!0,this.refreshTask=0,Editor.Metrics.trackTimeEnd("animator:view-refresh",{output:!0})}resize(){const e=this.vm;if(!e.$refs.right)return void(global_data_1.Flags.domReady=!1);const{offsetWidth:t,offsetHeight:a}=e.$refs.right;e.$refs.chart.style.width=`${t}px`;const r={w:e.$refs.right.offsetWidth,h:e.$refs.right.offsetHeight};grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.resize(t,a),requestAnimationFrame(()=>{this.updateScrollInfo(r),this.calcDisplayClips(),this.calcDisplayNodes(),this.vm.updateKeyFrame++,e.$refs.curve.rePaint()})}updateScrollInfo(e){const t=this.vm;t.nodeScrollInfo={size:e,height:t.$refs["node-content"].offsetHeight,top:t.$refs.nodes.scrollTop},t.propertyScrollInfo={size:e,height:t.$refs["property-content"].offsetHeight,top:t.$refs.property.scrollTop},t.embeddedPlayerScrollInfo={size:e,height:t.$refs["embeddedPlayer-content"].offsetHeight,top:t.$refs.embeddedPlayer.scrollTop}}async onEnter(){clip_cache_1.animationClipCacheManager.animationMode=!0,this.vm.animationMode=!0}onExit(){this.closeMaskPanel(),this.vm.animationMode=!1,clip_cache_1.animationClipCacheManager.animationMode=!1,this.vm.moveNodePath="",this.vm.selectKeyInfo=null,this.vm.selectEventInfo=null,this.vm.selectProperty=null,this._curveData=null,this.vm.showAnimCurve&&this.vm.toggleAniCurve(),this.updateCurrentFrame(0),animation_ctrl_1.animationCtrl.clear()}close(){(0,utils_1.removeEventListener)(document,"mouseup",this.onMouseUp),(0,utils_1.removeEventListener)(document,"mousemove",this.onMouseMove)}async selectCacheClipToApply(){const e=await clip_cache_1.animationClipCacheManager.selectClipCache(this.vm.currentClip);e&&await Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"restoreFromDump",args:[this.vm.root,this.vm.currentClip,e]})}}function getDistance(e,t){return e+grid_ctrl_1.gridCtrl.grid.xAxisOffset>t?e+grid_ctrl_1.gridCtrl.grid.xAxisOffset-t:e+grid_ctrl_1.gridCtrl.grid.xAxisOffset<0?e+grid_ctrl_1.gridCtrl.grid.xAxisOffset:0}function calcFrames(e,t,a){if(!e)return[];const r=[];function i(e){return a?{x:e.x,prop:e.prop,frame:e.frame,value:e.dump.value&&e.dump.value.uuid}:{x:e.x,prop:e.prop,frame:e.frame}}const n={maxNegative:{distance:-1/0,index:-1},minPositive:{index:-1,distance:1/0}};return e.forEach((e,a)=>{e.x=grid_ctrl_1.gridCtrl.frameToCanvas(e.frame);const o=getDistance(e.x,t);0!==o?o>0&&n.minPositive.distance>o?(n.minPositive.distance=o,n.minPositive.index=a):o<0&&n.maxNegative.distance<o&&(n.maxNegative.distance=o,n.maxNegative.index=a):r.push(i(e))}),r.length!==e.length&&(-1!==n.maxNegative.index&&r.push(i(e[n.maxNegative.index])),-1!==n.minPositive.index&&r.push(i(e[n.minPositive.index]))),r}function hasKeyData(e){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e])return!1;for(const t of Object.values(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e]))if(0!==t.keyFrames.length)return!0;return!1}exports.animationEditor=new AnimationEditor,exports.calcFrames=calcFrames;