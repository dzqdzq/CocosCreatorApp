"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationCtrl=void 0;const lodash_1=require("lodash"),utils_1=require("../utils"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),lodash=require("lodash");class AnimationCtrl{constructor(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.animationState="stop",this.debounceCache={},this.isCreatingAniClip=!1}get copyPropInfo(){return this.getClipBoardData("prop")}set copyPropInfo(e){this.__copyPropInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.prop",e)}get copyKeyInfo(){return this.getClipBoardData("key")}set copyKeyInfo(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.key",e)}get copyEmbeddedPlayerDump(){return this.getClipBoardData("embeddedPlayer")}set copyEmbeddedPlayerDump(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.embeddedPlayer",e)}get copyEventInfo(){return JSON.parse(JSON.stringify(this.__copyEventInfo))||this.getClipBoardData("event")}set copyEventInfo(e){this.__copyEventInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.event",e)}get copyNodeInfo(){return this.getClipBoardData("node")}set copyNodeInfo(e){this.__copyNodeInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.node",e)}reset(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.debounceCache={}}getClipBoardData(e){return Editor.Clipboard.read(`animation.${e}`)}init(e){this.vm=e}getPropData(e,t){var r;if(!this.clipsDump||!(null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e])||!this.vm.properties)return null;let p=this.clipsDump.pathsDump[e][t];return p&&this.vm.properties[t]&&(p=Object.assign(JSON.parse(JSON.stringify(p)),this.vm.properties[t])),p}setCurrentFrame(e){this.vm.currentFrame=e}async updateConfig(e,t){switch(e){case"speed":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSpeed)(this.vm.currentClip,t));break;case"sample":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSample)(this.vm.currentClip,t));break;case"wrapMode":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipWrapMode)(this.vm.currentClip,Number(t)));break;case"exit":await this.exit()}}async createAniCompFromAsset(e){return await Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"createAniCompFromAsset",args:[this.vm.root,e.map(e=>e.value),this.vm.aniCompType]})}async addClipFromAsset(e){if(this.vm.clipsMenu){if(this.vm.clipsMenu.find(t=>e.find(e=>t.uuid===e.value)))return!0}else this.vm.clipsMenu=[];const t=await this.createAniCompFromAsset(e);return t&&e.forEach(e=>{this.vm.clipsMenu.push({name:e.name,uuid:e.value})}),t}async addAnimationComponent(){const e=await Editor.Message.request("scene","begin-recording",this.vm.root);await Editor.Message.request("scene","create-component",{uuid:this.vm.root,component:"cc.Animation"}),await Editor.Message.request("scene","end-recording",e)}async createAniClip(){this.isCreatingAniClip=!0;const e=await Editor.Message.request("asset-db","create-asset-dialog","cc.AnimationClip");if(e){const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return this.vm.currentClip;await exports.animationCtrl.addClipFromAsset([{value:t.uuid,name:t.name}])}return this.isCreatingAniClip=!1,e||""}async enter(e){return await(0,ipc_event_1.Irecord)(this.vm.root,!0,e)}async exit(){return!1!==this.vm.animationMode&&await Editor.Message.request("scene","close-scene")}async updatePlayState(e){const t=this.vm;return"play"===e&&(Editor.Metrics._trackEventWithTimer({category:"hippoAnimator",id:"A100003",value:1}),"pause"===t.animationState&&(e="resume")),await(0,ipc_event_1.IchangeAnimationState)(e,t.currentClip)?(this.animationState="resume"===e?"play":e,!0):(console.warn(`${t.currentClip} change play status ${e} failedï¼`),!1)}save(){return Editor.Message.request("scene","save-clip")}callByDebounce(e,...t){const r=this[e];return!!r&&(this.debounceCache[e]||(this.debounceCache[e]=lodash.debounce(r,300)),this.debounceCache[e].call(this,...t))}spacingKeys(e){const t=this.vm;if(!t.selectKeyInfo||!t.selectKeyInfo.keyFrames.length)return;const r=(0,utils_1.sortKeysToTreeMap)(t.selectKeyInfo.keyFrames);if(0===Object.keys(r).length)return;const p=[],n={nodePath:t.selectKeyInfo.nodePath,prop:t.selectKeyInfo.prop,keyFrames:[],location:"prop"};Object.keys(r).forEach(o=>{const s=r[o];if(s.frames.length<=1)return;const a=s.frames[0],i=s.frames.map((t,r)=>{const p={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(a+r*e)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,rawFrame:t,nodePath:s.nodePath,prop:s.prop,frame:a+r*e,offsetFrame:a+r*e-t};return Object.assign(Object.assign({},p),{key:(0,utils_1.calcKeyFrameKey)(p)})});n.keyFrames.push(...i);const c=exports.animationCtrl.clipsDump.pathsDump[s.nodePath][s.prop].parentPropKey;c&&r[s.nodePath+c]||p.push((0,ipc_event_1.IspacingKeys)(t.currentClip,s.nodePath,s.prop,s.frames,e))}),(0,ipc_event_1.IApplyOperation)(p),t.selectKeyInfo=n}copyKey(e){var t;if(e&&e.frame){const{nodePath:r,prop:p}=e,n=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[r][p];if(!n)return;const o=[];if(n.partKeys)for(const t of n.partKeys){const p=this.clipsDump.pathsDump[r][t],s=p.keyFrames.find(t=>t.frame===e.frame);s&&o.push({nodePath:r,key:t,type:p.type,displayName:p.displayName,keyframes:[s.curve&&(0,utils_1.transCurveKeyToDumpKey)(s.curve,p.type)||s],_parentType:n.type,postExtrap:p.postExtrap,preExtrap:p.preExtrap,isCurveSupport:p.isCurveSupport})}else{const t=n.keyFrames.find(t=>t.frame===e.frame);t&&o.push({nodePath:r,key:p,type:n.type,displayName:n.displayName,keyframes:[t.curve&&(0,utils_1.transCurveKeyToDumpKey)(t.curve,n.type)||t],postExtrap:n.postExtrap,preExtrap:n.preExtrap,isCurveSupport:n.isCurveSupport})}o.length&&(this.copyKeyInfo={curvesDump:o,leftFrame:e.frame})}else if(this.vm.selectKeyInfo){const e=this.transSelectToCopyKeyInfo();e.curvesDump.length&&(this.copyKeyInfo=e)}else;}createKey(e){var t;const r=this.vm;e.frame=null!==(t=e.frame)&&void 0!==t?t:r.currentFrame,(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcreateKey)(r.currentClip,e.nodePath,e.prop,Number(e.frame),e.value)),Editor.Metrics._trackEventWithTimer({category:"hippoAnimator",id:"A100001",value:1})}createKeyBatch(e){const t=this.vm,r=[];e.forEach(e=>{e.frame=e.frame||t.currentFrame,r.push((0,ipc_event_1.IcreateKey)(t.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}),(0,ipc_event_1.IApplyOperation)(r)}async pasteEmbeddedPlayer(e,t,r){const p=e-t[0].begin,n=[];t.forEach(e=>{e.begin+=p,e.end+=p,e.group=r||e.group,n.push((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e))}),await(0,ipc_event_1.IApplyOperation)(n)}pasteKey(e,t){if(!(t=t||this.copyKeyInfo))return;const r=[];let p=t.curvesDump;if(e.prop){p=(0,utils_1.pickTargetCurveDump)({nodePath:e.nodePath,prop:e.prop},p,exports.animationCtrl.clipsDump.pathsDump);const n=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];if(p.length&&!n.partKeys){const n=p[0].keyframes[0].frame;r.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[p[0]]},{startFrame:e.target+(n-t.leftFrame),nodePath:e.nodePath,propKeys:[e.prop]}))}}r.length||p.forEach(p=>{if(!p.keyframes.length)return;const n=p.keyframes[0].frame;r.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[p]},{startFrame:e.target+(n-t.leftFrame),nodePath:e.nodePath,propKeys:[p.key]}))}),(0,ipc_event_1.IApplyOperation)(r)}transSelectToCopyKeyInfo(){const e=(0,utils_1.sortKeysToTreeMap)(this.vm.selectKeyInfo.keyFrames),t=[];Object.values(e).forEach(t=>{var r;const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[t.nodePath][t.prop];if(p)if(p.partKeys)for(const r of p.partKeys){const n=p.nodePath+r;e[n]||(e[n]={prop:r,nodePath:t.nodePath,frames:[],keyFrames:[]}),e[n].frames.push(...t.frames)}else;}),Object.values(e).forEach(e=>{var r;const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e.nodePath][e.prop];if(!p||p.partKeys)return;const n=this.clipsDump.pathsDump[e.nodePath][p.parentPropKey],o=p.keyFrames.filter(t=>e.frames.includes(t.frame)).map(e=>e.curve?(0,utils_1.transCurveKeyToDumpKey)(e.curve,p.type):e);o.length&&t.push({nodePath:e.nodePath,key:e.prop,type:p.type,displayName:p.displayName,keyframes:o,_parentType:n&&n.type,preExtrap:p.preExtrap,postExtrap:p.postExtrap,isCurveSupport:p.isCurveSupport})});let r=this.vm.stickInfo&&this.vm.stickInfo.leftFrame||this.vm.selectKeyInfo.keyFrames[0].frame;return this.vm.selectKeyInfo.offsetFrame&&(r-=this.vm.selectKeyInfo.offsetFrame),{curvesDump:t,leftFrame:r}}async removeKey(e,t=!1){const r=this.vm;if(e){let p=[];Array.isArray(e)?p=e:p.push(e);const n=[];if(p.forEach(e=>{if("number"!=typeof e.frame&&(e.frame=this.vm.currentFrame),r.selectKeyInfo&&!t){const t=e.nodePath+e.prop,p=r.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(r.selectKeyInfo.keyFrames);if(p[t]&&!p[t].frames.includes(e.frame))return void n.push((0,ipc_event_1.IremoveKey)(r.currentClip,e.nodePath,e.prop,e.frame))}else n.push((0,ipc_event_1.IremoveKey)(r.currentClip,e.nodePath,e.prop,e.frame))}),n.length>0){await(0,ipc_event_1.IApplyOperation)(n);return void 0}}if(!r.selectKeyInfo)return;const p=r.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(r.selectKeyInfo.keyFrames),n=[];for(const e of Object.keys(p)){const t=p[e];n.push((0,ipc_event_1.IremoveKey)(r.currentClip,t.nodePath,t.prop,t.frames))}await(0,ipc_event_1.IApplyOperation)(n)&&(r.selectKeyInfo=null)}async moveKeys(){var e;const t=this.vm;if(!t.selectKeyInfo)return!1;const{offsetFrame:r}=t.selectKeyInfo;if(!(0!==r||global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type||t.selectKeyInfo.ctrl))return!1;const p=[],n=(0,utils_1.changeParentToPart)(t.selectKeyInfo.keyFrames,exports.animationCtrl.clipsDump.pathsDump);if(global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type)for(const e of Object.keys(n)){const o=[],s=[];let a=void 0,i=void 0;n[e].keyFrames.forEach(e=>{var t;(e.offsetFrame||r)&&(o.push(e.rawFrame),s.push(null!==(t=e.offsetFrame)&&void 0!==t?t:r),a||(a=e.nodePath),i||(i=e.prop))}),a&&i&&p.push((0,ipc_event_1.ImoveKeys)(t.currentClip,a,i,o,s))}else for(const o of Object.keys(n)){const s=n[o];(s.offsetFrame||r)&&p.push((0,ipc_event_1.ImoveKeys)(t.currentClip,s.nodePath,s.prop,s.frames,null!==(e=s.offsetFrame)&&void 0!==e?e:r))}return 0!==p.length&&(!!await(0,ipc_event_1.IApplyOperation)(p)||(t.selectKeyInfo=null,!1))}addEvent(e){"number"!=typeof e&&(e=Number(this.vm.currentFrame)),(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IaddEvent)(this.vm.currentClip,e,"",[]))}async deleteEvent(e){const t=this.vm;if(t.selectEventInfo&&!e&&(e=t.selectEventInfo.frames,t.selectEventInfo=null),!e)return!1;const r=[];for(const p of e)r.push((0,ipc_event_1.IdeleteEvent)(t.currentClip,p));return!!await(0,ipc_event_1.IApplyOperation)(r)}copyEvents(e){const t=this.vm;(e=e||t.selectEventInfo&&t.selectEventInfo.frames||[])&&(this.copyEventInfo={eventsDump:this.clipsDump.events.filter(t=>e.includes(t.frame))})}pasteEvent(e,t){const r=this.vm;(t=t||this.copyEventInfo)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyEvent)(r.currentClip,t,{startFrame:e})),r.selectEventInfo=null)}async moveEvents(){const e=this.vm;if(!e.selectEventInfo)return!1;const{frames:t,offsetFrame:r}=e.selectEventInfo;return!!await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.ImoveEvents)(e.currentClip,t,r))&&(e.selectEventInfo.frames=[...new Set(e.selectEventInfo.data.map(e=>e.frame))],e.selectEventInfo.offsetFrame-=r,!0)}createProp(e,t){const r=[];if(t&&this.vm.selectedIds.size)for(const t of this.vm.selectedIds.values()){if(!this.nodesDump.uuid2path[t])break;r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,this.nodesDump.uuid2path[t],e.prop))}else r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,e.nodePath||this.vm.computeSelectPath,e.prop));(0,ipc_event_1.IApplyOperation)(r)}async clearPropKeys(e){await checkClearPropData(e.prop)&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IclearKeys)(this.vm.currentClip,e.nodePath,e.prop))}async removeProp(e){const t=this.vm;await checkRemoveProp(e.prop)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveProp)(t.currentClip,e.nodePath,e.prop)),t.selectProperty&&e.prop===t.selectProperty.prop&&(t.selectProperty=null))}copyProp(e){var t;const r=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[e.nodePath][e.prop];if(!r)return;const p=[(0,utils_1.propDataToCurveDump)(r)];r.partKeys&&r.partKeys.forEach(t=>{p.push((0,utils_1.propDataToCurveDump)(this.clipsDump.pathsDump[e.nodePath][t]))}),this.copyPropInfo={curvesDump:p}}pasteProp(e,t){const r=this.vm;if(t=t||this.copyPropInfo,!this.copyPropInfo||!e)return;let p=t.curvesDump.filter(t=>{var r,p;return(null===(r=t.type)||void 0===r?void 0:r.value)===(null===(p=e.type)||void 0===p?void 0:p.value)});if(!p.length)return void console.warn(Editor.I18n.t("animator.property.can_not_paste_in_current_prop"));const n=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];let o=n.partKeys;if(o){const r=p[0],n=exports.animationCtrl.clipsDump.pathsDump[e.nodePath];if(!n[r.key])return;p=n[r.key].partKeys.map(e=>{const p=JSON.parse(JSON.stringify(n[e])),o=t.curvesDump.find(t=>t.key===e)||r;return p.keyFrames=o.keyframes,(0,utils_1.propDataToCurveDump)(p)})}else if(o=[e.prop],n.parentPropKey){const t=p.find(t=>t.key===e.prop);t&&(p=[t])}(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyProp)(r.currentClip,{curvesDump:p},{nodePath:e.nodePath,propKeys:o}))}async clearNodeKeys(e){await checkClearNodeKeys()&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveNode)(this.vm.currentClip,e))}moveNodeData(e,t){var r;const p=this.vm;p.moveNodePath&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeNodeDataPath)(p.currentClip,t||p.moveNodePath,e)),p.moveNodePath="",(null===(r=p.selectProperty)||void 0===r?void 0:r.nodePath)===(t||p.moveNodePath)&&(p.selectProperty=null))}copyNodeData(e){const t=[];for(const r of e)for(const e of Object.keys(this.clipsDump.pathsDump[r])){const p=this.clipsDump.pathsDump[r][e];t.push((0,utils_1.propDataToCurveDump)(p))}this.copyNodeInfo={curvesDump:t}}pasteNodeData(e,t){(t=t||this.copyNodeInfo)&&e&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyNode)(this.vm.currentClip,t,{nodePath:e}))}async clearEmbeddedPlayer(e){return e=e||this.vm.computeSelectPath,await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.clearEmbeddedPlayer)(this.vm.currentClip,e))}async addEmbeddedPlayer(e){const t=await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e));return Editor.Metrics._trackEventWithTimer({category:"hippoAnimator",id:"A100002",value:1}),t}async deleteEmbeddedPlayer(e){return await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.deleteEmbeddedPlayer)(this.vm.currentClip,e))}async updateEmbeddedPlayer(e,t){return await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,e,t))}async createAuxKey(e,t,r){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.createAuxKey)(this.vm.currentClip,e,null!==t&&void 0!==t?t:this.vm.currentFrame,r))}async removeAuxKey(e,t){return(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.removeAuxKey)(this.vm.currentClip,e,null!==t&&void 0!==t?t:this.vm.currentFrame))}async moveAuxKey(e,t){const r=this.vm.currentClip,p=(0,lodash_1.groupBy)(e,e=>e.key),n=Object.keys(p).map(e=>{const n=p[e].reduce((e,t)=>(e.push(t.rawFrame),e),[]);return(0,ipc_event_1.moveAuxKeys)(r,e,n,t)});return(0,ipc_event_1.IApplyOperation)(n)}async copyAuxKey(e,t){return(0,ipc_event_1.IApplyOperation)([(0,ipc_event_1.copyAuxKey)(this.vm.currentClip,e,t)])}clear(){this.__copyPropInfo=null,this.__copyEventInfo=null,this.__copyKeyInfo=null,this.__copyNodeInfo=null}}function T(e,t=""){return Editor.I18n.t(`animator.${t}${e}`)}async function checkRemoveProp(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_remove_prop.message"),{title:`${t("is_remove_prop.title")}(${e})`,buttons:[t("cancel"),t("is_remove_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearPropData(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_clear_prop.message"),{title:`${t("is_clear_prop.title")}(${e})`,buttons:[t("cancel"),t("is_clear_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearNodeKeys(){const e=T;if(1===(await Editor.Dialog.warn(e("is_clear_message"),{title:e("is_clear"),buttons:[e("cancel"),e("clear")],default:0,cancel:0})).response)return!0}exports.animationCtrl=new AnimationCtrl;