"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationCtrl=void 0;const utils_1=require("../utils"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),lodash=require("lodash");class AnimationCtrl{constructor(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.animationState="stop",this.debounceCache={}}get copyPropInfo(){return this.getClipBoardData("prop")}set copyPropInfo(e){this.__copyPropInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.prop",e)}get copyKeyInfo(){return this.getClipBoardData("key")}set copyKeyInfo(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.key",e)}get copyEmbeddedPlayerDump(){return this.getClipBoardData("embeddedPlayer")}set copyEmbeddedPlayerDump(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.embeddedPlayer",e)}get copyEventInfo(){return JSON.parse(JSON.stringify(this.__copyEventInfo))||this.getClipBoardData("event")}set copyEventInfo(e){this.__copyEventInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.event",e)}get copyNodeInfo(){return this.getClipBoardData("node")}set copyNodeInfo(e){this.__copyNodeInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.node",e)}reset(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.debounceCache={}}getClipBoardData(e){return Editor.Clipboard.read(`animation.${e}`)}init(e){this.vm=e}getPropData(e,t){var r;if(!this.clipsDump||!(null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e])||!this.vm.properties)return null;let s=this.clipsDump.pathsDump[e][t];return s&&this.vm.properties[t]&&(s=Object.assign(JSON.parse(JSON.stringify(s)),this.vm.properties[t])),s}async setCurrentClip(e){const t=this.vm;if(e===t.currentClip)return!1;const r=await(0,ipc_event_1.IsetEditClip)(e);return r&&(t.currentClip=e),r}setCurrentFrame(e){this.vm.currentFrame=e}async updateConfig(e,t){switch(e){case"speed":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSpeed)(this.vm.currentClip,t));break;case"sample":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipSample)(this.vm.currentClip,t));break;case"wrapMode":(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeClipWrapMode)(this.vm.currentClip,Number(t)));break;case"exit":await this.exit()}}async createAniCompFromAsset(e){await Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"createAniCompFromAsset",args:[this.vm.root,e,this.nodesDump.animationType]})}async addClipFromAsset(e){if(this.vm.clipsMenu){if(this.vm.clipsMenu.find(t=>t.uuid===e))return!0}else this.vm.clipsMenu=[];const t=await Editor.Message.request("scene","execute-scene-script",{name:"animator",method:"createAniCompFromAsset",args:[this.vm.root,e,this.nodesDump.animationType]});if(t){const t=await Editor.Message.request("asset-db","query-asset-info",e);t&&this.vm.clipsMenu.push({name:t.name,uuid:e})}return t}async addAnimationComponent(){Editor.Message.send("scene","snapshot"),await Editor.Message.request("scene","create-component",{uuid:this.vm.root,component:"cc.Animation"}),Editor.Message.send("scene","snapshot")}async createAniClip(){const e=await Editor.Message.request("asset-db","create-asset-dialog","cc.AnimationClip");if(e){if(await exports.animationCtrl.addClipFromAsset(e),!await Editor.Message.request("asset-db","query-asset-info",e))return this.vm.currentClip;if(!await(0,ipc_event_1.IsetEditClip)(e))return this.vm.currentClip;await exports.animationCtrl.enter()}return e||""}async setDefautClip(e){await Editor.Message.request("scene","set-property",{uuid:this.vm.root,path:`__comps__.${this.vm.compIndex}.defaultClip`,dump:{type:"cc.AnimationClip",value:{uuid:e}}})}async enter(){return await(0,ipc_event_1.Irecord)(this.vm.root,!0)}async exit(){return!1!==this.vm.animationMode&&await Editor.Message.request("scene","close-scene")}async updatePlayState(e){const t=this.vm;return"play"===e&&"pause"===t.animationState&&(e="resume"),await(0,ipc_event_1.IchangeAnimationState)(e,t.currentClip)?(this.animationState="resume"===e?"play":e,!0):(console.warn(`${t.currentClip} change play status ${e} failedï¼`),!1)}save(){return Editor.Message.request("scene","save-clip")}callByDebounce(e,...t){const r=this[e];return!!r&&(this.debounceCache[e]||(this.debounceCache[e]=lodash.debounce(r,300)),this.debounceCache[e].call(this,...t))}spacingKeys(e){const t=this.vm;if(!t.selectKeyInfo||!t.selectKeyInfo.keyFrames.length)return;const r=(0,utils_1.sortKeysToTreeMap)(t.selectKeyInfo.keyFrames);if(0===Object.keys(r).length)return;const s=[],p={nodePath:t.selectKeyInfo.nodePath,prop:t.selectKeyInfo.prop,keyFrames:[],location:"prop"};Object.keys(r).forEach(n=>{const o=r[n];if(o.frames.length<=1)return;const a=o.frames[0],i=o.frames.map((t,r)=>{const s={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(a+r*e)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,rawFrame:t,nodePath:o.nodePath,prop:o.prop,frame:a+r*e,offsetFrame:a+r*e-t};return Object.assign(Object.assign({},s),{key:(0,utils_1.calcKeyFrameKey)(s)})});p.keyFrames.push(...i);const c=exports.animationCtrl.clipsDump.pathsDump[o.nodePath][o.prop].parentPropKey;c&&r[o.nodePath+c]||s.push((0,ipc_event_1.IspacingKeys)(t.currentClip,o.nodePath,o.prop,o.frames,e))}),(0,ipc_event_1.IApplyOperation)(s),t.selectKeyInfo=p}copyKey(e){var t;if(e&&e.frame){const{nodePath:r,prop:s}=e,p=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[r][s];if(!p)return;const n=[];if(p.partKeys)for(const t of p.partKeys){const s=this.clipsDump.pathsDump[r][t],o=s.keyFrames.find(t=>t.frame===e.frame);o&&n.push({nodePath:r,key:t,type:s.type,displayName:s.displayName,keyframes:[o.curve&&(0,utils_1.transCurveKeyToDumpKey)(o.curve,s.type)||o],_parentType:p.type,postExtrap:s.postExtrap,preExtrap:s.preExtrap,isCurveSupport:s.isCurveSupport})}else{const t=p.keyFrames.find(t=>t.frame===e.frame);t&&n.push({nodePath:r,key:s,type:p.type,displayName:p.displayName,keyframes:[t.curve&&(0,utils_1.transCurveKeyToDumpKey)(t.curve,p.type)||t],postExtrap:p.postExtrap,preExtrap:p.preExtrap,isCurveSupport:p.isCurveSupport})}n.length&&(this.copyKeyInfo={curvesDump:n,leftFrame:e.frame})}else if(this.vm.selectKeyInfo){const e=this.transSelectToCopyKeyInfo();e.curvesDump.length&&(this.copyKeyInfo=e)}else;}createKey(e){var t;const r=this.vm;e.frame=null!==(t=e.frame)&&void 0!==t?t:r.currentFrame,(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcreateKey)(r.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}createKeyBatch(e){const t=this.vm,r=[];e.forEach(e=>{e.frame=e.frame||t.currentFrame,r.push((0,ipc_event_1.IcreateKey)(t.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}),(0,ipc_event_1.IApplyOperation)(r)}async pasteEmbeddedPlayer(e,t,r){const s=e-t[0].begin,p=[];t.forEach(e=>{e.begin+=s,e.end+=s,e.group=r||e.group,p.push((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e))}),await(0,ipc_event_1.IApplyOperation)(p)}pasteKey(e,t){if(!(t=t||this.copyKeyInfo))return;const r=[];let s=t.curvesDump;if(e.prop){s=(0,utils_1.pickTargetCurveDump)({nodePath:e.nodePath,prop:e.prop},s,exports.animationCtrl.clipsDump.pathsDump);const p=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];if(s.length&&!p.partKeys){const p=s[0].keyframes[0].frame;r.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[s[0]]},{startFrame:e.target+(p-t.leftFrame),nodePath:e.nodePath,propKeys:[e.prop]}))}}r.length||s.forEach(s=>{if(!s.keyframes.length)return;const p=s.keyframes[0].frame;r.push((0,ipc_event_1.IcopyKeys)(this.vm.currentClip,{curvesDump:[s]},{startFrame:e.target+(p-t.leftFrame),nodePath:e.nodePath,propKeys:[s.key]}))}),(0,ipc_event_1.IApplyOperation)(r)}transSelectToCopyKeyInfo(){const e=(0,utils_1.sortKeysToTreeMap)(this.vm.selectKeyInfo.keyFrames),t=[];Object.values(e).forEach(t=>{var r;const s=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[t.nodePath][t.prop];if(s)if(s.partKeys)for(const r of s.partKeys){const p=s.nodePath+r;e[p]||(e[p]={prop:r,nodePath:t.nodePath,frames:[],keyFrames:[]}),e[p].frames.push(...t.frames)}else;}),Object.values(e).forEach(e=>{var r;const s=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e.nodePath][e.prop];if(!s||s.partKeys)return;const p=this.clipsDump.pathsDump[e.nodePath][s.parentPropKey],n=s.keyFrames.filter(t=>e.frames.includes(t.frame)).map(e=>e.curve?(0,utils_1.transCurveKeyToDumpKey)(e.curve,s.type):e);n.length&&t.push({nodePath:e.nodePath,key:e.prop,type:s.type,displayName:s.displayName,keyframes:n,_parentType:p&&p.type,preExtrap:s.preExtrap,postExtrap:s.postExtrap,isCurveSupport:s.isCurveSupport})});let r=this.vm.stickInfo&&this.vm.stickInfo.leftFrame||this.vm.selectKeyInfo.keyFrames[0].frame;return this.vm.selectKeyInfo.offsetFrame&&(r-=this.vm.selectKeyInfo.offsetFrame),{curvesDump:t,leftFrame:r}}async removeKey(e,t=!1){const r=this.vm;if(e){let s=[];Array.isArray(e)?s=e:s.push(e);const p=[];if(s.forEach(e=>{if("number"!=typeof e.frame&&(e.frame=this.vm.currentFrame),r.selectKeyInfo&&!t){const t=e.nodePath+e.prop,s=r.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(r.selectKeyInfo.keyFrames);if(s[t]&&!s[t].frames.includes(e.frame))return void p.push((0,ipc_event_1.IremoveKey)(r.currentClip,e.nodePath,e.prop,e.frame))}else p.push((0,ipc_event_1.IremoveKey)(r.currentClip,e.nodePath,e.prop,e.frame))}),p.length>0){await(0,ipc_event_1.IApplyOperation)(p);return void 0}}if(!r.selectKeyInfo)return;const s=r.selectKeyInfo.sortDump||(0,utils_1.sortKeysToTreeMap)(r.selectKeyInfo.keyFrames),p=[];for(const e of Object.keys(s)){const t=s[e];p.push((0,ipc_event_1.IremoveKey)(r.currentClip,t.nodePath,t.prop,t.frames))}await(0,ipc_event_1.IApplyOperation)(p)&&(r.selectKeyInfo=null)}async moveKeys(){var e;const t=this.vm;if(!t.selectKeyInfo)return!1;const{offsetFrame:r}=t.selectKeyInfo;if(!(0!==r||global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type||t.selectKeyInfo.ctrl))return!1;const s=[],p=(0,utils_1.changeParentToPart)(t.selectKeyInfo.keyFrames,exports.animationCtrl.clipsDump.pathsDump);if(global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type)for(const e of Object.keys(p)){const n=[],o=[];let a=void 0,i=void 0;p[e].keyFrames.forEach(e=>{var t;(e.offsetFrame||r)&&(n.push(e.rawFrame),o.push(null!==(t=e.offsetFrame)&&void 0!==t?t:r),a||(a=e.nodePath),i||(i=e.prop))}),a&&i&&s.push((0,ipc_event_1.ImoveKeys)(t.currentClip,a,i,n,o))}else for(const n of Object.keys(p)){const o=p[n];(o.offsetFrame||r)&&s.push((0,ipc_event_1.ImoveKeys)(t.currentClip,o.nodePath,o.prop,o.frames,null!==(e=o.offsetFrame)&&void 0!==e?e:r))}return 0!==s.length&&(!!await(0,ipc_event_1.IApplyOperation)(s)||(t.selectKeyInfo=null,!1))}addEvent(e){"number"!=typeof e&&(e=Number(this.vm.currentFrame)),(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IaddEvent)(this.vm.currentClip,e,"",[]))}async deleteEvent(e){const t=this.vm;if(t.selectEventInfo&&!e&&(e=t.selectEventInfo.frames,t.selectEventInfo=null),!e)return!1;const r=[];for(const s of e)r.push((0,ipc_event_1.IdeleteEvent)(t.currentClip,s));return!!await(0,ipc_event_1.IApplyOperation)(r)}copyEvents(e){const t=this.vm;(e=e||t.selectEventInfo&&t.selectEventInfo.frames||[])&&(this.copyEventInfo={eventsDump:this.clipsDump.events.filter(t=>e.includes(t.frame))})}pasteEvent(e,t){const r=this.vm;(t=t||this.copyEventInfo)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyEvent)(r.currentClip,t,{startFrame:e})),r.selectEventInfo=null)}async moveEvents(){const e=this.vm;if(!e.selectEventInfo)return!1;const{frames:t,offsetFrame:r}=e.selectEventInfo;return!!await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.ImoveEvents)(e.currentClip,t,r))&&(e.selectEventInfo.frames=[...new Set(e.selectEventInfo.data.map(e=>e.frame))],e.selectEventInfo.offsetFrame-=r,!0)}createProp(e,t){const r=[];if(t&&this.vm.selectedIds.size)for(const t of this.vm.selectedIds.values()){if(!this.nodesDump.uuid2path[t])break;r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,this.nodesDump.uuid2path[t],e.prop))}else r.push((0,ipc_event_1.IcreateProp)(this.vm.currentClip,e.nodePath||this.vm.computeSelectPath,e.prop));(0,ipc_event_1.IApplyOperation)(r)}async clearPropKeys(e){await checkClearPropData(e.prop)&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IclearKeys)(this.vm.currentClip,e.nodePath,e.prop))}async removeProp(e){const t=this.vm;await checkRemoveProp(e.prop)&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveProp)(t.currentClip,e.nodePath,e.prop)),t.selectProperty&&e.prop===t.selectProperty.prop&&(t.selectProperty=null))}copyProp(e){var t;const r=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[e.nodePath][e.prop];if(!r)return;const s=[(0,utils_1.propDataToCurveDump)(r)];r.partKeys&&r.partKeys.forEach(t=>{s.push((0,utils_1.propDataToCurveDump)(this.clipsDump.pathsDump[e.nodePath][t]))}),this.copyPropInfo={curvesDump:s}}pasteProp(e,t){const r=this.vm;if(t=t||this.copyPropInfo,!this.copyPropInfo||!e)return;let s=t.curvesDump.filter(t=>{var r,s;return(null===(r=t.type)||void 0===r?void 0:r.value)===(null===(s=e.type)||void 0===s?void 0:s.value)});if(!s.length)return void console.warn(Editor.I18n.t("animator.property.can_not_paste_in_current_prop"));const p=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];let n=p.partKeys;if(n){const r=s[0],p=exports.animationCtrl.clipsDump.pathsDump[e.nodePath];if(!p[r.key])return;s=p[r.key].partKeys.map(e=>{const s=JSON.parse(JSON.stringify(p[e])),n=t.curvesDump.find(t=>t.key===e)||r;return s.keyFrames=n.keyframes,(0,utils_1.propDataToCurveDump)(s)})}else if(n=[e.prop],p.parentPropKey){const t=s.find(t=>t.key===e.prop);t&&(s=[t])}(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyProp)(r.currentClip,{curvesDump:s},{nodePath:e.nodePath,propKeys:n}))}async clearNodeKeys(e){await checkClearNodeKeys()&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IremoveNode)(this.vm.currentClip,e))}moveNodeData(e,t){var r;const s=this.vm;s.moveNodePath&&((0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IchangeNodeDataPath)(s.currentClip,t||s.moveNodePath,e)),s.moveNodePath="",(null===(r=s.selectProperty)||void 0===r?void 0:r.nodePath)===(t||s.moveNodePath)&&(s.selectProperty=null))}copyNodeData(e){const t=[];for(const r of e)for(const e of Object.keys(this.clipsDump.pathsDump[r])){const s=this.clipsDump.pathsDump[r][e];t.push((0,utils_1.propDataToCurveDump)(s))}this.copyNodeInfo={curvesDump:t}}pasteNodeData(e,t){(t=t||this.copyNodeInfo)&&e&&(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.IcopyNode)(this.vm.currentClip,t,{nodePath:e}))}async clearEmbeddedPlayer(e){return e=e||this.vm.computeSelectPath,await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.clearEmbeddedPlayer)(this.vm.currentClip,e))}async addEmbeddedPlayer(e){return await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.addEmbeddedPlayer)(this.vm.currentClip,e))}async deleteEmbeddedPlayer(e){return await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.deleteEmbeddedPlayer)(this.vm.currentClip,e))}async updateEmbeddedPlayer(e,t){return await(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.updateEmbeddedPlayer)(this.vm.currentClip,e,t))}clear(){this.__copyPropInfo=null,this.__copyEventInfo=null,this.__copyKeyInfo=null,this.__copyNodeInfo=null}}function T(e,t=""){return Editor.I18n.t(`animator.${t}${e}`)}async function checkRemoveProp(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_remove_prop.message"),{title:`${t("is_remove_prop.title")}(${e})`,buttons:[t("cancel"),t("is_remove_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearPropData(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_clear_prop.message"),{title:`${t("is_clear_prop.title")}(${e})`,buttons:[t("cancel"),t("is_clear_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearNodeKeys(){const e=T;if(1===(await Editor.Dialog.warn(e("is_clear_message"),{title:e("is_clear"),buttons:[e("cancel"),e("clear")],default:0,cancel:0})).response)return!0}exports.animationCtrl=new AnimationCtrl;