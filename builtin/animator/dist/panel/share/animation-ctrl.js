"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationCtrl=void 0;const utils_1=require("../utils"),global_data_1=require("./global-data"),grid_ctrl_1=require("./grid-ctrl"),ipc_event_1=require("./ipc-event"),lodash=require("lodash");class AnimationCtrl{constructor(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.animationState="stop",this.debounceCache={}}get copyPropInfo(){return this.getClipBoardData("prop")}set copyPropInfo(e){this.__copyPropInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.prop",e)}get copyKeyInfo(){return this.getClipBoardData("key")}set copyKeyInfo(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.key",e)}get copyEventInfo(){return JSON.parse(JSON.stringify(this.__copyEventInfo))||this.getClipBoardData("event")}set copyEventInfo(e){this.__copyEventInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.event",e)}get copyNodeInfo(){return this.getClipBoardData("node")}set copyNodeInfo(e){this.__copyNodeInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.node",e)}reset(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.debounceCache={}}getClipBoardData(e){return Editor.Clipboard.read(`animation.${e}`)}init(e){this.vm=e}getPropData(e,t){var r;if(!this.clipsDump||!(null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e])||!this.vm.properties)return null;let p=this.clipsDump.pathsDump[e][t];return p&&this.vm.properties[t]&&(p=Object.assign(JSON.parse(JSON.stringify(p)),this.vm.properties[t])),p}async queryAllPropValue(e,t){if(!(this.clipsDump&&this.vm.animationMode&&this.clipsDump.displayClipsDump&&this.clipsDump.displayClipsDump[e]))return null;Object.keys(this.clipsDump.displayClipsDump[e])}async setCurrentClip(e){const t=this.vm;if(e===t.currentClip)return!1;const r=await ipc_event_1.IsetEditClip(e);return r&&(t.currentClip=e),r}setCurrentFrame(e){this.vm.currentFrame=e}async updateConfig(e,t){switch(e){case"speed":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipSpeed(this.vm.currentClip,t));break;case"sample":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipSample(this.vm.currentClip,t));break;case"wrapMode":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipWrapMode(this.vm.currentClip,Number(t)));break;case"exit":this.exit()}}async exit(){return!1!==this.vm.animationMode&&await Editor.Message.request("scene","close-scene")}async updatePlayState(e){const t=this.vm;return"play"===e&&"pause"===t.animationState&&(e="resume"),await ipc_event_1.IchangeAnimationState(e,t.currentClip)?(this.animationState="resume"===e?"play":e,!0):(console.warn(`${t.currentClip} change play status ${e} failedï¼`),!1)}save(){return Editor.Message.request("scene","save-clip")}callByDebounce(e,...t){const r=this[e];return!!r&&(this.debounceCache[e]||(this.debounceCache[e]=lodash.debounce(r,300)),this.debounceCache[e].call(this,...t))}spacingKeys(e){const t=this.vm;if(!t.selectKeyInfo||!t.selectKeyInfo.keyFrames.length)return;const r=utils_1.sortKeysToTreeMap(t.selectKeyInfo.keyFrames);if(0===Object.keys(r).length)return;const p=[],o={nodePath:t.selectKeyInfo.nodePath,prop:t.selectKeyInfo.prop,keyFrames:[]};Object.keys(r).forEach(s=>{const n=r[s];if(n.frames.length<=1)return;const a=n.frames[0],i=n.frames.map((t,r)=>({x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(a+r*e)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,rawFrame:t,nodePath:n.nodePath,prop:n.prop,frame:a+r*e,offsetFrame:a+r*e-t}));o.keyFrames.push(...i);const c=exports.animationCtrl.clipsDump.pathsDump[n.nodePath][n.prop].parentPropKey;c&&r[n.nodePath+c]||p.push(ipc_event_1.IspacingKeys(t.currentClip,n.nodePath,n.prop,n.frames,e))}),ipc_event_1.IApplyOperation(p),t.selectKeyInfo=o}copyKey(e){var t;if(e&&e.frame){const{nodePath:r,prop:p}=e,o=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[r][p];if(!o)return;const s=[];if(o.partKeys)for(const t of o.partKeys){const p=this.clipsDump.pathsDump[r][t],n=p.keyFrames.find(t=>t.frame===e.frame);n&&s.push({nodePath:r,key:t,type:p.type,displayName:p.displayName,keyframes:[n.curve&&utils_1.transCurveKeyToDumpKey(n.curve,p.type)||n],_parentType:o.type,postExtrap:p.postExtrap,preExtrap:p.preExtrap,isCurveSupport:p.isCurveSupport})}else{const t=o.keyFrames.find(t=>t.frame===e.frame);t&&s.push({nodePath:r,key:p,type:o.type,displayName:o.displayName,keyframes:[t.curve&&utils_1.transCurveKeyToDumpKey(t.curve,o.type)||t],postExtrap:o.postExtrap,preExtrap:o.preExtrap,isCurveSupport:o.isCurveSupport})}s.length&&(this.copyKeyInfo={curvesDump:s,leftFrame:e.frame})}else if(this.vm.selectKeyInfo){const e=this.transSelectToCopyKeyInfo();e.curvesDump.length&&(this.copyKeyInfo=e)}else;}createKey(e){var t;const r=this.vm;e.frame=null!==(t=e.frame)&&void 0!==t?t:r.currentFrame,ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(r.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}createKeyBatch(e){const t=this.vm,r=[];e.forEach(e=>{e.frame=e.frame||t.currentFrame,r.push(ipc_event_1.IcreateKey(t.currentClip,e.nodePath,e.prop,Number(e.frame),e.value))}),ipc_event_1.IApplyOperation(r)}pasteKey(e,t){if(!(t=t||this.copyKeyInfo))return;const r=[];let p=t.curvesDump;e.prop&&(p=utils_1.pickTargetCurveDump({nodePath:e.nodePath,prop:e.prop},p,exports.animationCtrl.clipsDump.pathsDump)),p.forEach(p=>{if(!p.keyframes.length)return;const o=p.keyframes[0].frame;r.push(ipc_event_1.IcopyKeys(this.vm.currentClip,{curvesDump:[p]},{startFrame:e.target+(o-t.leftFrame),nodePath:e.nodePath,propKeys:[p.key]}))}),ipc_event_1.IApplyOperation(r)}transSelectToCopyKeyInfo(){const e=utils_1.sortKeysToTreeMap(this.vm.selectKeyInfo.keyFrames),t=[];Object.values(e).forEach(t=>{var r;const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[t.nodePath][t.prop];if(p)if(p.partKeys)for(const r of p.partKeys){const o=p.nodePath+r;e[o]||(e[o]={prop:r,nodePath:t.nodePath,frames:[],keyFrames:[]}),e[o].frames.push(...t.frames)}else;}),Object.values(e).forEach(e=>{var r;const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e.nodePath][e.prop];if(!p||p.partKeys)return;const o=this.clipsDump.pathsDump[e.nodePath][p.parentPropKey],s=p.keyFrames.filter(t=>e.frames.includes(t.frame)).map(e=>e.curve?utils_1.transCurveKeyToDumpKey(e.curve,p.type):e);s.length&&t.push({nodePath:e.nodePath,key:e.prop,type:p.type,displayName:p.displayName,keyframes:s,_parentType:o&&o.type,preExtrap:p.preExtrap,postExtrap:p.postExtrap,isCurveSupport:p.isCurveSupport})});let r=this.vm.stickInfo&&this.vm.stickInfo.leftFrame||this.vm.selectKeyInfo.keyFrames[0].frame;return this.vm.selectKeyInfo.offsetFrame&&(r-=this.vm.selectKeyInfo.offsetFrame),{curvesDump:t,leftFrame:r}}async removeKey(e,t=!1){const r=this.vm;if(e){let p=[];Array.isArray(e)?p=e:p.push(e);const o=[];if(p.forEach(e=>{if("number"!=typeof e.frame&&(e.frame=this.vm.currentFrame),r.selectKeyInfo&&!t){const t=e.nodePath+e.prop,p=r.selectKeyInfo.sortDump||utils_1.sortKeysToTreeMap(r.selectKeyInfo.keyFrames);if(p[t]&&!p[t].frames.includes(e.frame))return void o.push(ipc_event_1.IremoveKey(r.currentClip,e.nodePath,e.prop,e.frame))}else o.push(ipc_event_1.IremoveKey(r.currentClip,e.nodePath,e.prop,e.frame))}),o.length>0){await ipc_event_1.IApplyOperation(o);return void 0}}if(!r.selectKeyInfo)return;const p=r.selectKeyInfo.sortDump||utils_1.sortKeysToTreeMap(r.selectKeyInfo.keyFrames),o=[];for(const e of Object.keys(p)){const t=p[e];o.push(ipc_event_1.IremoveKey(r.currentClip,t.nodePath,t.prop,t.frames))}await ipc_event_1.IApplyOperation(o)&&(r.selectKeyInfo=null)}async moveKeys(){var e;const t=this.vm;if(!t.selectKeyInfo)return!1;const{offsetFrame:r}=t.selectKeyInfo;if(!(0!==r||global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type||t.selectKeyInfo.ctrl))return!1;const p=[],o=utils_1.changeParentToPart(t.selectKeyInfo.keyFrames,exports.animationCtrl.clipsDump.pathsDump);if(global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type)for(const e of Object.keys(o)){const s=[],n=[];let a=void 0,i=void 0;o[e].keyFrames.forEach(e=>{var t;(e.offsetFrame||r)&&(s.push(e.rawFrame),n.push(null!==(t=e.offsetFrame)&&void 0!==t?t:r),a||(a=e.nodePath),i||(i=e.prop))}),a&&i&&p.push(ipc_event_1.ImoveKeys(t.currentClip,a,i,s,n))}else for(const s of Object.keys(o)){const n=o[s];(n.offsetFrame||r)&&p.push(ipc_event_1.ImoveKeys(t.currentClip,n.nodePath,n.prop,n.frames,null!==(e=n.offsetFrame)&&void 0!==e?e:r))}return 0!==p.length&&(!!await ipc_event_1.IApplyOperation(p)||(t.selectKeyInfo=null,!1))}addEvent(e){"number"!=typeof e&&(e=Number(this.vm.currentFrame)),ipc_event_1.IApplyOperation(ipc_event_1.IaddEvent(this.vm.currentClip,e,"",[]))}async deleteEvent(e){const t=this.vm;if(t.selectEventInfo&&!e&&(e=t.selectEventInfo.frames,t.selectEventInfo=null),!e)return!1;const r=[];for(const p of e)r.push(ipc_event_1.IdeleteEvent(t.currentClip,p));return!!await ipc_event_1.IApplyOperation(r)}copyEvents(e){const t=this.vm;(e=e||t.selectEventInfo&&t.selectEventInfo.frames||[])&&(this.copyEventInfo={eventsDump:this.clipsDump.events.filter(t=>e.includes(t.frame))})}pasteEvent(e,t){const r=this.vm;(t=t||this.copyEventInfo)&&(ipc_event_1.IApplyOperation(ipc_event_1.IcopyEvent(r.currentClip,t,{startFrame:e})),r.selectEventInfo=null)}async moveEvents(){const e=this.vm;if(!e.selectEventInfo)return!1;const{frames:t,offsetFrame:r}=e.selectEventInfo;return!!await ipc_event_1.IApplyOperation(ipc_event_1.ImoveEvents(e.currentClip,t,r))&&(e.selectEventInfo.frames=[...new Set(e.selectEventInfo.data.map(e=>e.frame))],e.selectEventInfo.offsetFrame-=r,!0)}createProp(e,t){const r=[];if(t&&this.vm.selectedIds.size)for(const t of this.vm.selectedIds.values()){if(!this.nodesDump.uuid2path[t])break;r.push(ipc_event_1.IcreateProp(this.vm.currentClip,this.nodesDump.uuid2path[t],e.prop))}else r.push(ipc_event_1.IcreateProp(this.vm.currentClip,e.nodePath||this.vm.computeSelectPath,e.prop));ipc_event_1.IApplyOperation(r)}async clearPropKeys(e){await checkClearPropData(e.prop)&&ipc_event_1.IApplyOperation(ipc_event_1.IclearKeys(this.vm.currentClip,e.nodePath,e.prop))}async removeProp(e){const t=this.vm;await checkRemoveProp(e.prop)&&(ipc_event_1.IApplyOperation(ipc_event_1.IremoveProp(t.currentClip,e.nodePath,e.prop)),t.selectProperty&&e.prop===t.selectProperty.prop&&(t.selectProperty=null))}copyProp(e){var t;const r=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[e.nodePath][e.prop];if(!r)return;const p=[utils_1.propDataToCurveDump(r)];r.partKeys&&r.partKeys.forEach(t=>{p.push(utils_1.propDataToCurveDump(this.clipsDump.pathsDump[e.nodePath][t]))}),this.copyPropInfo={curvesDump:p}}pasteProp(e,t){const r=this.vm;if(t=t||this.copyPropInfo,!this.copyPropInfo||!e)return;let p=t.curvesDump.filter(t=>{var r,p;return(null===(r=t.type)||void 0===r?void 0:r.value)===(null===(p=e.type)||void 0===p?void 0:p.value)});if(!p.length)return void console.warn(Editor.I18n.t("animator.property.can_not_paste_in_current_prop"));const o=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];let s=o.partKeys;if(s){const r=p[0],o=exports.animationCtrl.clipsDump.pathsDump[e.nodePath];p=o[r.key].partKeys.map(e=>{const p=JSON.parse(JSON.stringify(o[e])),s=t.curvesDump.find(t=>t.key===e)||r;return p.keyFrames=s.keyframes,utils_1.propDataToCurveDump(p)})}else if(s=[e.prop],o.parentPropKey){const t=p.find(t=>t.key===e.prop);t&&(p=[t])}ipc_event_1.IApplyOperation(ipc_event_1.IcopyProp(r.currentClip,{curvesDump:p},{nodePath:e.nodePath,propKeys:s}))}async clearNodeKeys(e){await checkClearNodeKeys()&&ipc_event_1.IApplyOperation(ipc_event_1.IremoveNode(this.vm.currentClip,e))}moveNodeData(e,t){const r=this.vm;r.moveNodePath&&(ipc_event_1.IApplyOperation(ipc_event_1.IchangeNodeDataPath(r.currentClip,t||r.moveNodePath,e)),r.moveNodePath="")}copyNodeData(e){const t=[];for(const r of e)for(const e of Object.keys(this.clipsDump.pathsDump[r])){const p=this.clipsDump.pathsDump[r][e];t.push(utils_1.propDataToCurveDump(p))}this.copyNodeInfo={curvesDump:t}}pasteNodeData(e,t){(t=t||this.copyNodeInfo)&&e&&ipc_event_1.IApplyOperation(ipc_event_1.IcopyNode(this.vm.currentClip,t,{nodePath:e}))}clear(){this.__copyPropInfo=null,this.__copyEventInfo=null,this.__copyKeyInfo=null,this.__copyNodeInfo=null}}function T(e,t=""){return Editor.I18n.t(`animator.${t}${e}`)}async function checkRemoveProp(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_remove_prop.message"),{title:`${t("is_remove_prop.title")}(${e})`,buttons:[t("cancel"),t("is_remove_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearPropData(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_clear_prop.message"),{title:`${t("is_clear_prop.title")}(${e})`,buttons:[t("cancel"),t("is_clear_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearNodeKeys(){const e=T;if(1===(await Editor.Dialog.warn(e("is_clear_message"),{title:e("is_clear"),buttons:[e("cancel"),e("clear")],default:0,cancel:0})).response)return!0}exports.animationCtrl=new AnimationCtrl;