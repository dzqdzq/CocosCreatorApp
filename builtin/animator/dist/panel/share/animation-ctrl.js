"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.animationCtrl=void 0;const utils_1=require("../utils"),global_data_1=require("./global-data"),ipc_event_1=require("./ipc-event"),lodash=require("lodash");class AnimationCtrl{constructor(){this.clipConfig={sample:60,isLock:!1,speed:1,duration:60,wrapMode:0},this.clipsDump=null,this.nodesDump=null,this.aniPlayTimer=null,this.propRowIndex={},this.__copyKeyInfo=null,this.__copyNodeInfo=null,this.__copyEventInfo=null,this.__copyPropInfo=null,this.debounceCache={},this.vm=null}get copyPropInfo(){return JSON.parse(JSON.stringify(this.__copyPropInfo))||Editor.Clipboard.read("animation.prop")}set copyPropInfo(e){this.__copyPropInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.prop",e)}get copyKeyInfo(){return JSON.parse(JSON.stringify(this.__copyKeyInfo))||Editor.Clipboard.read("animation.key")}set copyKeyInfo(e){this.__copyKeyInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.key",e)}get copyEventInfo(){return JSON.parse(JSON.stringify(this.__copyEventInfo))||Editor.Clipboard.read("animation.event")}set copyEventInfo(e){this.__copyEventInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.event",e)}get copyNodeInfo(){return JSON.parse(JSON.stringify(this.__copyNodeInfo))||Editor.Clipboard.read("animation.node")}set copyNodeInfo(e){this.__copyNodeInfo=JSON.parse(JSON.stringify(e)),Editor.Clipboard.write("animation.node",e)}getClipBoardData(e){return Editor.Clipboard.read(`animation.${e}`)}init(e){this.vm=e}getPropData(e,t){var r;if(!this.clipsDump||!(null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e]))return null;let a=this.clipsDump.pathsDump[e][t];return a&&this.vm.properties[t]&&(a=Object.assign(JSON.parse(JSON.stringify(a)),this.vm.properties[t])),a}async queryAllPropValue(e,t){if(!(this.clipsDump&&this.vm.animationMode&&this.clipsDump.displayClipsDump&&this.clipsDump.displayClipsDump[e]))return null;Object.keys(this.clipsDump.displayClipsDump[e])}async setCurrentClip(e){const t=this.vm;if(e===t.currentClip)return!1;const r=await ipc_event_1.IsetEditClip(e);return r&&(t.currentClip=e),r}setCurrentFrame(e){this.vm.currentFrame=e}async updateConfig(e,t){switch(e){case"speed":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipSpeed(this.vm.currentClip,t));break;case"sample":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipSample(this.vm.currentClip,t));break;case"wrapMode":ipc_event_1.IApplyOperation(ipc_event_1.IchangeClipWrapMode(this.vm.currentClip,Number(t)));break;case"exit":this.exit()}}async exit(){return!1!==this.vm.animationMode&&await Editor.Message.request("scene","close-scene")}async updatePlayState(e){const t=this.vm;if("play"===e&&"pause"===t.animationState&&(e="resume"),await ipc_event_1.IchangeAnimationState(e,t.currentClip)){switch(e){case"play":case"resume":t.animationState="playing",t.runPointer();break;case"stop":case"pause":t.animationState=e,this.aniPlayTimer&&cancelAnimationFrame(this.aniPlayTimer)}"stop"===e&&t.setCurrentFrame(0)}else console.warn(`${t.currentClip} change play status ${e} failedï¼`)}save(){return Editor.Message.request("scene","save-clip")}callByDebounce(e,...t){const r=this[e];return!!r&&(this.debounceCache[e]||(this.debounceCache[e]=lodash.debounce(r,300)),this.debounceCache[e].call(this,...t))}spacingKeys(e){const t=this.vm;if(!t.selectKeyInfo)return;const r=t.selectKeyInfo.sortDump||utils_1.sortSelectParams(t.selectKeyInfo.params);if(0===Object.keys(r).length)return;"number"==typeof e&&e||(e=t.spacingFrame);const a=[];Object.keys(r).forEach(p=>{var o;const n=r[p];if(n.frames.length<=1)return;const s=null===(o=exports.animationCtrl.clipsDump)||void 0===o?void 0:o.pathsDump[n.nodePath][n.prop].parentPropKey;s&&r[n.nodePath+s]||a.push(ipc_event_1.IspacingKeys(t.currentClip,n.nodePath,n.prop,n.frames,e))}),ipc_event_1.IApplyOperation(a),t.selectKeyInfo=null}copyKey(e){var t,r;if(e&&e.frame&&e.param){const{nodePath:a,prop:p}=e.param;let o=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[a][p];if(!o)return;const n=[];if(o.partKeys)for(const t of o.partKeys){const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[a][t];n.push({nodePath:a,key:t,type:p.type,displayName:p.displayName,keyframes:[p.keyFrames.find(t=>t.frame===e.frame)],_parentType:o.type})}else n.push({nodePath:a,key:p,type:o.type,displayName:o.displayName,keyframes:[o.keyFrames.find(t=>t.frame===e.frame)]});exports.animationCtrl.copyKeyInfo={curvesDump:n,leftFrame:e.frame}}else this.vm.selectKeyInfo&&(this.copyKeyInfo=this.transSelectToCopyKeyInfo())}createKey(e){var t;const r=this.vm;e.frame=null!==(t=e.frame)&&void 0!==t?t:r.currentFrame,ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(r.currentClip,e.param.nodePath,e.param.prop,Number(e.frame),e.value))}createKeyBatch(e){const t=this.vm,r=[];e.forEach(e=>{e.frame=e.frame||t.currentFrame,r.push(ipc_event_1.IcreateKey(t.currentClip,e.param.nodePath,e.param.prop,Number(e.frame),e.value))}),ipc_event_1.IApplyOperation(r)}pasteKey(e,t){if(!(t=t||this.copyKeyInfo))return;let r=[];if(e.propKey){const a=this.clipsDump.pathsDump[e.nodePath][e.propKey],p=null===a||void 0===a?void 0:a.type;if(null===a||void 0===a?void 0:a.partKeys){const o=null===a||void 0===a?void 0:a.partKeys.map(t=>this.clipsDump.pathsDump[e.nodePath][t]);t.curvesDump.forEach(a=>{if(!a._parentType||a._parentType.value!==p.value)return;const n=o.find(e=>e.displayName===a.displayName);if(!n||!a.keyframes.length)return;const s=a.keyframes[0].frame;r.push(ipc_event_1.IcopyKeys(this.vm.currentClip,{curvesDump:[a]},{startFrame:e.target+(s-t.leftFrame),nodePath:e.nodePath,propKeys:[n.prop]}))})}else for(const o of t.curvesDump){if(o.type&&o.type.value!==p.value)continue;const n=o.keyframes[0].frame;if(r=[ipc_event_1.IcopyKeys(this.vm.currentClip,{curvesDump:[o]},{startFrame:e.target+(n-t.leftFrame),nodePath:e.nodePath,propKeys:[a.prop]})],o.key===a.prop)break}}else t.curvesDump.forEach(a=>{if(!a.keyframes.length)return;const p=a.keyframes[0].frame;r.push(ipc_event_1.IcopyKeys(this.vm.currentClip,{curvesDump:[a]},{startFrame:e.target+(p-t.leftFrame),nodePath:e.nodePath,propKeys:[a.key]}))});ipc_event_1.IApplyOperation(r)}transSelectToCopyKeyInfo(){const e=this.vm.selectKeyInfo.sortDump||utils_1.sortSelectParams(this.vm.selectKeyInfo.params),t=[];Object.values(e).forEach(t=>{var r;const a=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[t.nodePath][t.prop];if(a)if(a.partKeys)for(const r of a.partKeys){const p=a.nodePath+r;e[p]||(e[p]={prop:r,nodePath:t.nodePath,frames:[]}),e[p].frames.push(...t.frames)}else;}),Object.values(e).forEach(e=>{var r,a;const p=null===(r=this.clipsDump)||void 0===r?void 0:r.pathsDump[e.nodePath][e.prop];if(!p||p.partKeys)return;const o=null===(a=this.clipsDump)||void 0===a?void 0:a.pathsDump[e.nodePath][p.parentPropKey];t.push({nodePath:e.nodePath,key:e.prop,type:p.type,displayName:p.displayName,keyframes:p.keyFrames.filter(t=>e.frames.includes(t.frame)),_parentType:o&&o.type})});let r=this.vm.stickInfo&&this.vm.stickInfo.leftFrame||this.vm.selectKeyInfo.data[0].frame;return this.vm.selectKeyInfo.offsetFrame&&(r-=this.vm.selectKeyInfo.offsetFrame),{curvesDump:t,leftFrame:r}}async removeKey(e,t=!1){const r=this.vm;if(e){let a=[];Array.isArray(e)?a=e:a.push(e);const p=[];if(a.forEach(e=>{if("number"!=typeof e.frame&&(e.frame=this.vm.currentFrame),r.selectKeyInfo&&!t){const t=e.param.nodePath+e.param.prop,a=r.selectKeyInfo.sortDump||utils_1.sortSelectParams(r.selectKeyInfo.params);if(a[t]&&!a[t].frames.includes(e.frame))return void p.push(ipc_event_1.IremoveKey(r.currentClip,e.param.nodePath,e.param.prop,e.frame))}else p.push(ipc_event_1.IremoveKey(r.currentClip,e.param.nodePath,e.param.prop,e.frame))}),p.length>0){await ipc_event_1.IApplyOperation(p);return void 0}}if(!r.selectKeyInfo)return;const a=r.selectKeyInfo.sortDump||utils_1.sortSelectParams(r.selectKeyInfo.params),p=[];for(const e of Object.keys(a)){const t=a[e];p.push(ipc_event_1.IremoveKey(r.currentClip,t.nodePath,t.prop,t.frames))}await ipc_event_1.IApplyOperation(p)&&(r.selectKeyInfo=null)}async moveKeys(){var e;const t=this.vm;if(!t.selectKeyInfo)return!1;const{offsetFrame:r}=t.selectKeyInfo;if(!(0!==r||global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type||t.selectKeyInfo.ctrl))return!1;const a=[],p=changeParentToPart(t.selectKeyInfo);if(global_data_1.Flags.startDragStickInfo&&"center"!==global_data_1.Flags.startDragStickInfo.type)for(const e of Object.keys(p)){let o=[],n=[],s=void 0,i=void 0;p[e].params.forEach(e=>{var t;(e.offsetFrame||r)&&(o.push(e.frame),n.push(null!==(t=e.offsetFrame)&&void 0!==t?t:r),s||(s=e.nodePath),i||(i=e.prop))}),s&&i&&a.push(ipc_event_1.ImoveKeys(t.currentClip,s,i,o,n))}else for(const o of Object.keys(p)){const n=p[o];(n.offsetFrame||r)&&a.push(ipc_event_1.ImoveKeys(t.currentClip,n.nodePath,n.prop,n.frames,null!==(e=n.offsetFrame)&&void 0!==e?e:r))}return 0!==a.length&&(!!await ipc_event_1.IApplyOperation(a)||(t.selectKeyInfo=null,!1))}async scaleKeys(){}addEvent(e){"number"!=typeof e&&(e=Number(this.vm.currentFrame)),ipc_event_1.IApplyOperation(ipc_event_1.IaddEvent(this.vm.currentClip,e,"",[]))}async deleteEvent(e){const t=this.vm;if(t.selectEventInfo&&!e&&(e=t.selectEventInfo.frames,t.selectEventInfo=null),!e)return;const r=[];for(const a of e)r.push(ipc_event_1.IdeleteEvent(t.currentClip,a));return!!await ipc_event_1.IApplyOperation(r)}copyEvents(e){const t=this.vm;(e=e||t.selectEventInfo&&t.selectEventInfo.frames)&&(this.copyEventInfo={eventsDump:this.clipsDump.events.filter(t=>e.includes(t.frame))})}pasteEvent(e,t){const r=this.vm;(t=t||this.copyEventInfo)&&(ipc_event_1.IApplyOperation(ipc_event_1.IcopyEvent(r.currentClip,t,{startFrame:e})),r.selectEventInfo=null)}async moveEvents(){const e=this.vm;if(!e.selectEventInfo)return;const{frames:t,offsetFrame:r}=e.selectEventInfo;return!!await ipc_event_1.IApplyOperation(ipc_event_1.ImoveEvents(e.currentClip,t,r))&&(e.selectEventInfo.frames=[...new Set(e.selectEventInfo.data.map(e=>e.frame))],e.selectEventInfo.offsetFrame-=r,!0)}createProp(e,t){const r=[];if(t&&this.vm.selectedIds.size)for(const t of this.vm.selectedIds.values()){if(!this.nodesDump.uuid2path[t])break;r.push(ipc_event_1.IcreateProp(this.vm.currentClip,this.nodesDump.uuid2path[t],e.prop))}else r.push(ipc_event_1.IcreateProp(this.vm.currentClip,e.nodePath||this.vm.computeSelectPath,e.prop));ipc_event_1.IApplyOperation(r)}async clearPropKeys(e){await checkClearPropData(e.prop)&&ipc_event_1.IApplyOperation(ipc_event_1.IclearKeys(this.vm.currentClip,e.nodePath,e.prop))}async removeProp(e){const t=this.vm;await checkRemoveProp(e.prop)&&(ipc_event_1.IApplyOperation(ipc_event_1.IremoveProp(t.currentClip,e.nodePath,e.prop)),t.selectProperty&&e.prop===t.selectProperty.prop&&(t.selectProperty=null))}copyProp(e){var t;const r=null===(t=this.clipsDump)||void 0===t?void 0:t.pathsDump[e.nodePath][e.prop];r&&(this.copyPropInfo={curvesDump:[propDataToCurveDump(r)]})}pasteProp(e,t){const r=this.vm;if(t=t||this.copyPropInfo,!this.copyPropInfo||!e)return;let a=t.curvesDump.filter(t=>{var r,a;return(null===(r=t.type)||void 0===r?void 0:r.value)===(null===(a=e.type)||void 0===a?void 0:a.value)});if(!a.length)return void console.warn(Editor.I18n.t("animator.property.can_not_paste_in_current_prop"));let p=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop].partKeys;if(p){const e=a[0],t=exports.animationCtrl.clipsDump.pathsDump[e.nodePath];a=t[e.key].partKeys.map(e=>propDataToCurveDump(t[e]))}else p=[e.prop];ipc_event_1.IApplyOperation(ipc_event_1.IcopyProp(r.currentClip,{curvesDump:a},{nodePath:e.nodePath,propKeys:p}))}async clearNodeKeys(e){await checkClearNodeKeys()&&ipc_event_1.IApplyOperation(ipc_event_1.IremoveNode(this.vm.currentClip,e))}moveNodeData(e,t){const r=this.vm;r.moveNodePath&&(ipc_event_1.IApplyOperation(ipc_event_1.IchangeNodeDataPath(r.currentClip,t||r.moveNodePath,e)),r.moveNodePath=null)}copyNodeData(e){const t=[];for(const r of e)for(const e of Object.keys(this.clipsDump.pathsDump[r])){const a=this.clipsDump.pathsDump[r][e];t.push(propDataToCurveDump(a))}this.copyNodeInfo={curvesDump:t}}pasteNodeData(e,t){(t=t||this.copyNodeInfo)&&e&&(t.curvesDump=t.curvesDump.filter(t=>!this.clipsDump.pathsDump[e][t.key].partKeys),ipc_event_1.IApplyOperation(ipc_event_1.IcopyNode(this.vm.currentClip,t,{nodePath:e})))}clear(){this.__copyPropInfo=null,this.__copyEventInfo=null,this.__copyKeyInfo=null,this.__copyNodeInfo=null}}function propDataToCurveDump(e){return{nodePath:e.nodePath,keyframes:e.keyFrames,displayName:e.displayName,key:e.prop,type:e.type}}function T(e,t=""){return Editor.I18n.t(`animator.${t}${e}`)}async function checkRemoveProp(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_remove_prop.message"),{title:`${t("is_remove_prop.title")}(${e})`,buttons:[t("cancel"),t("is_remove_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearPropData(e){const t=T;if(1===(await Editor.Dialog.warn(t("is_clear_prop.message"),{title:`${t("is_clear_prop.title")}(${e})`,buttons:[t("cancel"),t("is_clear_prop.remove")],default:0,cancel:0})).response)return!0}async function checkClearNodeKeys(){const e=T;if(1===(await Editor.Dialog.warn(e("is_clear_message"),{title:e("is_clear"),buttons:[e("cancel"),e("clear")],default:0,cancel:0})).response)return!0}function changeParentToPart(e){if(1===e.params.length)return utils_1.sortSelectParams(e.params);const t={};return e.params.forEach(e=>{const r=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][e.prop];r&&r.partKeys?r.partKeys.forEach(r=>{const a=exports.animationCtrl.clipsDump.pathsDump[e.nodePath][r];a.keyFrames.find(t=>t.frame===e.frame)&&(t[a.prop+e.frame]={prop:a.prop,frame:e.frame,nodePath:e.nodePath,offsetFrame:e.offsetFrame})}):t[e.prop+e.frame]={prop:e.prop,frame:e.frame,nodePath:e.nodePath,offsetFrame:e.offsetFrame}}),utils_1.sortSelectParams(Object.values(t))}function filterPartKeys(e){if(!e.data||!e.params)return;const t=JSON.parse(JSON.stringify(e.params)),r=JSON.parse(JSON.stringify(e.data));e.params.forEach(e=>{var a;const p=null===(a=exports.animationCtrl.clipsDump)||void 0===a?void 0:a.pathsDump[e.nodePath][e.prop].partKeys;p&&(t.filter(t=>!(p.includes(t.prop)&&t.frame===e.frame)),r.filter(t=>!(p.includes(t.prop)&&t.frame===e.frame)))}),e.data=r,e.params=t}exports.animationCtrl=new AnimationCtrl;