"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.T=exports.propDataToCurveDump=exports.changeParentToPart=exports.pickTargetCurveDump=exports.checkCtrlOrCommand=exports.removeEventListener=exports.addEventListenerOnce=exports.sortPropertyMenu=exports.checkPropertyInMenu=exports.calcParamPath=exports.sortKeysToTreeMap=exports.sortSelectParams=exports.transFrameByType=exports.frameToTime=exports.timeToFrame=exports.formatClipDump=exports.transformCurveKeyToDump=exports.transformCtrlKeyToDump=exports.mockDumpToCtrl=exports.transCurveKeyToDumpKey=exports.transDumpKeyToCurveKey=exports.transKeyFrames=exports.queryAnimCompIndex=exports.formatNodeDump=exports.smoothScale=void 0;const lodash=require("lodash");function smoothScale(e,t){return t=Math.pow(2,.002*e)*t}function initNode(e){e.uuid2path={},e.path2uuid={},e.nodes=[]}function formatNodeDump(e,t="",r=0,o={}){if(t){o.uuid2path[e.uuid]=t;const n={path:t,uuid:e.uuid,name:e.name,indent:r,disabled:!1};o.path2uuid[t]?(o.path2uuid[t].push(e.uuid),n.disabled=!0):o.path2uuid[t]=[e.uuid],o.nodes.push(n)}else initNode(o),o.uuid2path[e.uuid]="/",o.path2uuid["/"]=[e.uuid],o.nodes.push({path:"/",uuid:e.uuid,name:e.name,indent:r});const n={name:e.name,children:[],uuid:e.uuid,indent:r,path:t};for(const a of e.children){const e=formatNodeDump(a,`${t}/${a.name}`,r+2,o);n.children.push(e)}return t||(n.uuid2path=o.uuid2path,n.path2uuid=o.path2uuid,n.nodes=o.nodes,n.path="/",n.compIndex=queryAnimCompIndex(e.components),"number"==typeof n.compIndex&&(n.animationType=e.components[n.compIndex].type)),n}exports.smoothScale=smoothScale,exports.formatNodeDump=formatNodeDump;const animCompRE=/Animation/;function queryAnimCompIndex(e){if(!e||e.length<1)return null;const t=e.findIndex(e=>animCompRE.test(e.type));return-1===t?null:t}function transKeyFrames(e,t,r){return e.map(e=>{return{frame:e.frame,prop:t,dump:{type:e.dump.type,value:e.dump.value},x:0,curve:r?transDumpKeyToCurveKey(e):null}})}function transDumpKeyToCurveKey(e){return e.dump&&"number"==typeof e.dump.value?{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod,point:{x:e.frame,y:Number(e.dump.value)}}:null}function transCurveKeyToDumpKey(e,t){return{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,frame:Math.round(e.point.x),easingMethod:e.easingMethod,broken:e.broken,dump:{value:e.point.y,type:t}}}function mockDumpToCtrl(e){return{key:transDumpKeyToCurveKey(e)}}function transformCtrlKeyToDump(e,t){return e.map(e=>transCurveKeyToDumpKey(e.key,t))}function transformCurveKeyToDump(e,t){return e.map(e=>transCurveKeyToDumpKey(e,t))}function formatClipDump(e){const t={};return e.curves.forEach(e=>{t[e.nodePath]||(t[e.nodePath]={});const r=JSON.parse(JSON.stringify(e));r.keyFrames=transKeyFrames(r.keyframes,r.key,r.isCurveSupport),r.propOpts=r.opts,r.prop=r.key,r.curve=r.isCurveSupport,delete r.opts,delete r.keyframes,delete r.key,t[e.nodePath][e.key]=r}),e.pathsDump=t,e}function timeToFrame(e,t){return Math.round(e*t)}function frameToTime(e,t){return e/t}function transFrameByType(e,t="frame",r=60){if("frame"===t)return e+"";switch(t){case"time":{let t="",o=Math.floor(Math.log10(r))+1;e<0&&(t="-",e=-e);let n=(e%r).toString();return(o-=n.length)>0&&(n=new Array(o+1).join("0")+n),t+Math.floor(e/r)+"-"+n}case"time_s":{const t=getRightNum(e/r);if(t>60){return`${Math.floor(t/60)}m${getRightNum(t%60)}s`}return`${t}s`}default:return e+"f"}}function getRightNum(e){return Number(e.toFixed(2))}function sortSelectParams(e,t){const r={};for(const o of e){if(!o)continue;const e=t&&t[o.prop];e&&(e.partKeys&&e.partKeys.forEach(e=>{addInfoToProp(r,Object.assign(Object.assign({},o),{prop:e}))}),e.parentPropKey&&addInfoToProp(r,Object.assign(Object.assign({},o),{prop:e.parentPropKey}))),addInfoToProp(r,o)}return r}function sortKeysToTreeMap(e){const t={};for(const r of e){if(!r)continue;const e=r.nodePath+r.prop;t[e]?(t[e].frames.push(r.rawFrame),t[e].keyFrames.push(r)):t[e]={prop:r.prop,nodePath:r.nodePath,frames:[r.rawFrame],keyFrames:[r],offsetFrame:r.offsetFrame}}return t}function addInfoToProp(e,t){const r=t.nodePath+t.prop;e[r]?e[r].frames.includes(t.rawFrame)||(e[r].frames.push(t.rawFrame),e[r].keyFrames.push(t)):e[r]={prop:t.prop,nodePath:t.nodePath,frames:[t.rawFrame],keyFrames:[t],offsetFrame:t.offsetFrame}}function calcParamPath(e){let t;return t=e[1]?`path_${e[0]}${e[1]}`:`path_${e[0]}`}function checkPropertyInMenu(e,t){if(!e)return!1;return-1!==t.findIndex(t=>e.prop===t.key)}function sortPropertyMenu(e,t){const r=Object.create(null);t=t||[];const o=Object.keys(t);return(e=JSON.parse(JSON.stringify(e))).forEach(e=>{if("eulerAngles"!==e.key&&"rotation"!==e.key||!o.includes("eulerAngles")&&!o.includes("rotation")?o.includes(e.key)?e.disable=!0:e.disable=!1:e.disable=!0,!e.category)return void(r[e.name]=e);const t=e.menuName?e.menuName:e.displayName;setObject(r,e.category+`/${t}`,e)}),r}function setObject(e,t,r){const o=t.split("/");let n=e;o.forEach((e,t)=>{if(t!==o.length-1)null===n[e]||void 0===n[e]?(n[e]=Object.create(null),n=n[e]):n=n[e];else{if(n.key){const e=JSON.parse(JSON.stringify(n));n._self=e,Object.keys(n).forEach(e=>{"_self"!==e&&delete n[e]})}n[e]=r}})}function addEventListenerOnce(e,t,r){e&&!r.hasBind&&t&&(e.addEventListener(t,r),r.hasBind=!0)}function removeEventListener(e,t,r){e&&t&&(e.removeEventListener(t,r),r.hasBind=!1)}function checkCtrlOrCommand(e){return!!e&&("win32"===process.platform?e.ctrlKey:e.metaKey)}function pickTargetCurveDump(e,t,r){if(!t||!r[e.nodePath][e.prop])return[];const o=r[e.nodePath][e.prop],n=o.type;let a=[];if(o.partKeys){const p=o.partKeys.map(t=>r[e.nodePath][t]);t.forEach(e=>{if(!e._parentType||e._parentType.value!==n.value)return;p.find(t=>t.displayName===e.displayName)&&e.keyframes.length&&a.push(e)})}else for(const e of t)if(!(n&&e.type&&e.type.value!==n.value||!e.keyframes.length)&&(a=[e],e.key===o.prop))break;return a}function changeParentToPart(e,t){if(!e.length)return{};if(1===e.length)return sortKeysToTreeMap(e);const r={};return e.forEach(e=>{const o=t[e.nodePath][e.prop];if(o&&o.partKeys)o.partKeys.forEach(o=>{const n=t[e.nodePath][o];if(n.keyFrames.find(t=>t.frame===e.rawFrame)){const t=r[n.prop+e.frame],o=e.offsetFrame||t&&t.offsetFrame||e.frame-e.rawFrame;r[e.nodePath+n.prop+e.rawFrame]={prop:n.prop,frame:e.frame,nodePath:e.nodePath,rawFrame:e.rawFrame,x:e.x,offsetFrame:o}}});else{const t=r[o.prop+e.frame],n=e.offsetFrame||t&&t.offsetFrame||e.frame-e.rawFrame;r[e.nodePath+e.prop+e.rawFrame]={prop:e.prop,frame:e.frame,nodePath:e.nodePath,rawFrame:e.rawFrame,x:e.x,offsetFrame:n}}}),sortKeysToTreeMap(Object.values(r))}function propDataToCurveDump(e){const t=e.keyFrames.map(t=>t.curve&&transCurveKeyToDumpKey(t.curve,e.type)||t);return{nodePath:e.nodePath,keyframes:t,displayName:e.displayName,key:e.prop,type:e.type,postExtrap:e.postExtrap,preExtrap:e.preExtrap,isCurveSupport:e.isCurveSupport}}function T(e,t=""){return Editor.I18n.t(`animator.${t}${e}`)}exports.queryAnimCompIndex=queryAnimCompIndex,exports.transKeyFrames=transKeyFrames,exports.transDumpKeyToCurveKey=transDumpKeyToCurveKey,exports.transCurveKeyToDumpKey=transCurveKeyToDumpKey,exports.mockDumpToCtrl=mockDumpToCtrl,exports.transformCtrlKeyToDump=transformCtrlKeyToDump,exports.transformCurveKeyToDump=transformCurveKeyToDump,exports.formatClipDump=formatClipDump,exports.timeToFrame=timeToFrame,exports.frameToTime=frameToTime,exports.transFrameByType=transFrameByType,exports.sortSelectParams=sortSelectParams,exports.sortKeysToTreeMap=sortKeysToTreeMap,exports.calcParamPath=calcParamPath,exports.checkPropertyInMenu=checkPropertyInMenu,exports.sortPropertyMenu=sortPropertyMenu,exports.addEventListenerOnce=addEventListenerOnce,exports.removeEventListener=removeEventListener,exports.checkCtrlOrCommand=checkCtrlOrCommand,exports.pickTargetCurveDump=pickTargetCurveDump,exports.changeParentToPart=changeParentToPart,exports.propDataToCurveDump=propDataToCurveDump,exports.T=T;