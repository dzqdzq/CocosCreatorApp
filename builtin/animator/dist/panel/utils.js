"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkCtrlOrCommand=exports.removeEventListener=exports.addEventListenerOnce=exports.getPropOpts=exports.sortPropertyMenu=exports.isExitProperty=exports.calcParamPath=exports.sortSelectParams=exports.frameFormat=exports.frameToTime=exports.timeToFrame=exports.formatClipDump=exports.transformCurveKeyToDump=exports.transformCtrlKeyToDump=exports.transDumpToCtrl=exports.transCurveToDump=exports.transDumpToCurve=exports.transKeyFrames=exports.queryAnimCompIndex=exports.formatNodeDump=exports.smoothScale=void 0;const lodash=require("lodash");function smoothScale(e,t){return t=Math.pow(2,.002*e)*t}function initNode(e){e.uuid2path={},e.path2uuid={},e.nodes=[]}function formatNodeDump(e,t="",r=0,n={}){if(t){n.uuid2path[e.uuid]=t;const o={path:t,uuid:e.uuid,name:e.name,indent:r,disabled:!1};n.path2uuid[t]?(n.path2uuid[t].push(e.uuid),o.disabled=!0):n.path2uuid[t]=[e.uuid],n.nodes.push(o)}else initNode(n),n.uuid2path[e.uuid]="/",n.path2uuid["/"]=[e.uuid],n.nodes.push({path:"/",uuid:e.uuid,name:e.name,indent:r});const o={name:e.name,children:[],uuid:e.uuid,indent:r,path:t};for(const a of e.children){const e=formatNodeDump(a,`${t}/${a.name}`,r+2,n);o.children.push(e)}return t||(o.uuid2path=n.uuid2path,o.path2uuid=n.path2uuid,o.nodes=n.nodes,o.path="/",o.compIndex=queryAnimCompIndex(e.components)),o}exports.smoothScale=smoothScale,exports.formatNodeDump=formatNodeDump;const animCompRE=/Animation/;function queryAnimCompIndex(e){if(!e)return;if(e.length<1)return null;const t=e.findIndex(e=>animCompRE.test(e.type));return-1===t?null:t}function transKeyFrames(e,t,r){return e.map(e=>{return{frame:e.frame,prop:t,dump:{type:e.dump.type,value:e.dump.value},x:0,curve:transDumpToCurve(e)}})}function transDumpToCurve(e){return!e.dump||isNaN(Number(e.dump.value))?null:{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod,point:{x:e.frame,y:Number(e.dump.value)}}}function transCurveToDump(e,t){return{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,frame:Math.round(e.point.x),easingMethod:e.easingMethod,dump:{value:e.point.y,type:t}}}function transDumpToCtrl(e){return{key:transDumpToCurve(e)}}function transformCtrlKeyToDump(e,t){return e.map(e=>transCurveToDump(e.key,t))}function transformCurveKeyToDump(e,t){return e.map(e=>transCurveToDump(e,t))}function formatClipDump(e){const t={};return e.curves.forEach(e=>{var r;t[e.nodePath]||(t[e.nodePath]={});const n=JSON.parse(JSON.stringify(e));n.keyFrames=transKeyFrames(n.keyframes,n.key,null===(r=n.type)||void 0===r?void 0:r.value),n.propOpts=n.opts,n.prop=n.key,"Number"===n.type.value&&(n.curve=!0),delete n.opts,delete n.keyframes,delete n.key,t[e.nodePath][e.key]=n}),e.pathsDump=t,e}function timeToFrame(e,t){return Math.round(e*t)}function frameToTime(e,t){return e/t}function frameFormat(e,t="frame",r=60){if("frame"===t)return e+"";switch(t){case"time":{let t="",n=Math.floor(Math.log10(r))+1;e<0&&(t="-",e=-e);let o=(e%r).toString();return(n-=o.length)>0&&(o=new Array(n+1).join("0")+o),t+Math.floor(e/r)+"-"+o}case"time_s":{const t=getRightNum(e/r);if(t>60){return`${Math.floor(t/60)}m${getRightNum(t%60)}s`}return`${t}s`}default:return e+"f"}}function getRightNum(e){return Number(e.toFixed(2))}function sortSelectParams(e){const t={};for(const r of e){if(!r)continue;const e=r.nodePath+r.prop;t[e]?(t[e].frames.push(r.rawFrame),t[e].keyFrames.push(r)):t[e]={prop:r.prop,nodePath:r.nodePath,frames:[r.rawFrame],keyFrames:[r],offsetFrame:r.offsetFrame}}return t}function calcParamPath(e){let t;return t=e[1]?`path_${e[0]}${e[1]}`:`path_${e[0]}`}function isExitProperty(e,t){if(!e)return!1;return-1!==t.findIndex(t=>e.prop===t.key)}function sortPropertyMenu(e,t){const r=Object.create(null);t=t||[];const n=Object.keys(t);return(e=JSON.parse(JSON.stringify(e))).forEach(e=>{if("eulerAngles"!==e.key&&"rotation"!==e.key||!n.includes("eulerAngles")&&!n.includes("rotation")?n.includes(e.key)?e.disable=!0:e.disable=!1:e.disable=!0,!e.category)return void(r[e.name]=e);const t=e.menuName?e.menuName:e.displayName;setObject(r,e.category+`/${t}`,e)}),r}function setObject(e,t,r){const n=t.split("/");let o=e;n.forEach((e,t)=>{if(t!==n.length-1)null===o[e]||void 0===o[e]?(o[e]=Object.create(null),o=o[e]):o=o[e];else{if(o.key){const e=JSON.parse(JSON.stringify(o));o._self=e,Object.keys(o).forEach(e=>{"_self"!==e&&delete o[e]})}o[e]=r}})}function getPropOpts(e,t){if(!window.ClipsDump)return;if(!window.ClipsDump.pathsDump[e])return;const r=window.ClipsDump.pathsDump[e][t];return r&&r.propOpts?Object.assign(r.propOpts,{type:r.type}):void 0}function addEventListenerOnce(e,t,r){e&&!r.hasBind&&t&&(e.addEventListener(t,r),r.hasBind=!0)}function removeEventListener(e,t,r){e&&t&&(e.removeEventListener(t,r),r.hasBind=!1)}function checkCtrlOrCommand(e){return!!e&&("win32"===process.platform?e.ctrlKey:e.metaKey)}exports.queryAnimCompIndex=queryAnimCompIndex,exports.transKeyFrames=transKeyFrames,exports.transDumpToCurve=transDumpToCurve,exports.transCurveToDump=transCurveToDump,exports.transDumpToCtrl=transDumpToCtrl,exports.transformCtrlKeyToDump=transformCtrlKeyToDump,exports.transformCurveKeyToDump=transformCurveKeyToDump,exports.formatClipDump=formatClipDump,exports.timeToFrame=timeToFrame,exports.frameToTime=frameToTime,exports.frameFormat=frameFormat,exports.sortSelectParams=sortSelectParams,exports.calcParamPath=calcParamPath,exports.isExitProperty=isExitProperty,exports.sortPropertyMenu=sortPropertyMenu,exports.getPropOpts=getPropOpts,exports.addEventListenerOnce=addEventListenerOnce,exports.removeEventListener=removeEventListener,exports.checkCtrlOrCommand=checkCtrlOrCommand;