"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.calcEmbeddedPlayerKey=exports.T=exports.propDataToCurveDump=exports.changeParentToPart=exports.pickTargetCurveDump=exports.checkCtrlOrCommand=exports.removeEventListener=exports.addEventListenerOnce=exports.isMenuItem=exports.sortPropertyMenu=exports.checkPropertyInMenu=exports.calcParamPath=exports.sortKeysToTreeMap=exports.sortSelectParams=exports.transFrameByType=exports.transFrameByTypeInGrid=exports.frameToTime=exports.timeToFrame=exports.formatClipDump=exports.transformCurveKeyToDump=exports.transformCtrlKeyToDump=exports.mockDumpToCtrl=exports.transCurveKeyToDumpKey=exports.transDumpKeyToCurveKey=exports.transKeyFrames=exports.calcKeyFrameKey=exports.formatNodeDump=exports.EmbeddedPlayerMenuMap=exports.smoothScale=void 0;const lodash=require("lodash"),ComponentToPlayer={ParticleSystem:""};function smoothScale(e,r){return r=Math.pow(2,.002*e)*r}function initNode(e){e.uuid2path={},e.path2uuid={},e.nodes=[]}function formatNodeDump(e,r="",t=0,a={}){if(r){a.uuid2path[e.uuid]=r;const n={path:r,uuid:e.uuid,name:e.name,indent:t,disabled:!1};a.path2uuid[r]?(a.path2uuid[r].push(e.uuid),n.disabled=!0):a.path2uuid[r]=[e.uuid],a.nodes.push(n)}else initNode(a),a.uuid2path[e.uuid]="/",a.path2uuid["/"]=[e.uuid],a.nodes.push({path:"/",uuid:e.uuid,name:e.name,indent:t});const n={name:e.name,children:[],uuid:e.uuid,indent:t,path:r};for(const o of e.children){const e=formatNodeDump(o,`${r}/${o.name}`,t+2,a);n.children.push(e)}return r||(n.uuid2path=a.uuid2path,n.path2uuid=a.path2uuid,n.nodes=a.nodes,n.path="/",n.rawPath=e.path),n}exports.smoothScale=smoothScale,exports.EmbeddedPlayerMenuMap={"animation-clip":{label:"i18n:animator.embeddedPlayer.AnimationPlayer",trackLabel:"i18n:animator.embeddedPlayer.AnimationTrack",value:{type:"animation-clip"},icon:"animation",pathPlaceholder:"i18n:animator.embeddedPlayer.nodePathTip"},"particle-system":{label:"i18n:animator.embeddedPlayer.ParticlePlayer",trackLabel:"i18n:animator.embeddedPlayer.ParticleTrack",value:{type:"particle-system"},icon:"particle",pathPlaceholder:"i18n:animator.embeddedPlayer.particlePathTip"}},exports.formatNodeDump=formatNodeDump;const animCompRE=/Animation/;function calcKeyFrameKey(e){let r=e.frame+e.prop+e.x;return e.nodePath&&(r+=e.nodePath),e.value&&(r+=e.value),r}function transKeyFrames(e,r,t){return e.map(e=>{const a={frame:e.frame,prop:r,dump:{type:e.dump.type,value:e.dump.value},x:0,curve:t?transDumpKeyToCurveKey(e):null};return Object.assign(Object.assign({},a),{key:calcKeyFrameKey(a)})})}function transDumpKeyToCurveKey(e){return e.dump&&"number"==typeof e.dump.value?{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod,point:{x:e.frame,y:Number(e.dump.value)}}:null}function transCurveKeyToDumpKey(e,r){return{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,frame:Math.round(e.point.x),easingMethod:e.easingMethod,broken:e.broken,dump:{value:e.point.y,type:r}}}function mockDumpToCtrl(e){return{key:transDumpKeyToCurveKey(e)}}function transformCtrlKeyToDump(e,r){return e.map(e=>transCurveKeyToDumpKey(e.key,r))}function transformCurveKeyToDump(e,r){return e.map(e=>transCurveKeyToDumpKey(e,r))}function formatClipDump(e){const r=Object.assign({},e),t={};r.curves.forEach(e=>{t[e.nodePath]||(t[e.nodePath]={});const r=JSON.parse(JSON.stringify(e));r.keyFrames=transKeyFrames(r.keyframes,r.key,r.isCurveSupport),r.propOpts=r.opts,r.prop=r.key,r.curve=r.isCurveSupport,delete r.opts,delete r.keyframes,delete r.key,t[e.nodePath][e.key]=r}),r.pathsDump=t,r.embeddedPlayers||(r.embeddedPlayers=[]),r.embeddedPlayerGroups||(r.embeddedPlayerGroups=[]);const a={};return r.embeddedPlayers.forEach(e=>{a[e.group]||(a[e.group]=[]),e.playable||(console.error("no playable in animation clip"),e.playable={type:"animation-clip"}),a[e.group].push(e)}),r.groupToEmbeddedPlayers=a,r.displayAuxiliaryCurves=Object.values(e.auxiliaryCurves).map(e=>{const r=transKeyFrames(e.keyframes,e.displayName,!0);return Object.assign(Object.assign({},e),{keyframes:r})}),r}function timeToFrame(e,r){return Math.round(e*r)}function frameToTime(e,r){return e/r}function transFrameByTypeInGrid(e,r="frame",t=60){if("frame"===r)return e+"";switch(r){case"time_s":{const r=getRightNum(e/t);if(r>60){return`${Math.floor(r/60)}m${getRightNum(r%60)}s`}return`${r}s`}case"time":return e%t;default:return e+""}}function transFrameByType(e,r="frame",t=60){if("frame"===r)return e+"";switch(r){case"time":{let r="",a=Math.floor(Math.log10(t))+1;e<0&&(r="-",e=-e);let n=(e%t).toString();return(a-=n.length)>0&&(n=new Array(a+1).join("0")+n),r+Math.floor(e/t)+"-"+n}case"time_s":{const r=getRightNum(e/t);if(r>60){return`${Math.floor(r/60)}m${getRightNum(r%60)}s`}return`${r}s`}default:return e+""}}function getRightNum(e){return Number(e.toFixed(2))}function sortSelectParams(e,r){const t={};for(const a of e){if(!a)continue;const e=r&&r[a.prop];e&&(e.partKeys&&e.partKeys.forEach(e=>{addInfoToProp(t,Object.assign(Object.assign({},a),{prop:e}))}),e.parentPropKey&&addInfoToProp(t,Object.assign(Object.assign({},a),{prop:e.parentPropKey}))),addInfoToProp(t,a)}return t}function sortKeysToTreeMap(e){const r={};for(const t of e){if(!t)continue;const e=t.nodePath+t.prop;r[e]?(r[e].frames.push(t.rawFrame),r[e].keyFrames.push(t)):r[e]={prop:t.prop,nodePath:t.nodePath,frames:[t.rawFrame],keyFrames:[t],offsetFrame:t.offsetFrame}}return r}function addInfoToProp(e,r){const t=r.nodePath+r.prop;e[t]?e[t].frames.includes(r.rawFrame)||(e[t].frames.push(r.rawFrame),e[t].keyFrames.push(r)):e[t]={prop:r.prop,nodePath:r.nodePath,frames:[r.rawFrame],keyFrames:[r],offsetFrame:r.offsetFrame}}function calcParamPath(e){let r;return r=e[1]?`path_${e[0]}${e[1]}`:`path_${e[0]}`}function checkPropertyInMenu(e,r){if(!e)return!1;return-1!==r.findIndex(r=>e.prop===r.key)}function sortPropertyMenu(e,r){const t=Object.create(null);r=r||[];const a=Object.keys(r);return(e=JSON.parse(JSON.stringify(e))).forEach(e=>{if("eulerAngles"!==e.key&&"rotation"!==e.key||!a.includes("eulerAngles")&&!a.includes("rotation")?a.includes(e.key)?e.disable=!0:e.disable=!1:e.disable=!0,!e.category)return void(t[e.name]=e);const r=e.menuName?e.menuName:e.displayName;setMenuItem(t,e.category+`/${r}`,e)}),t}function isMenuItem(e){return e.key&&"string"==typeof e.key}function setMenuItem(e,r,t){const a=r.split("/");let n=e;a.forEach((e,r)=>{if(r!==a.length-1)null===n[e]||void 0===n[e]?(n[e]=Object.create(null),n=n[e]):n=n[e];else{if(isMenuItem(n)){const e=JSON.parse(JSON.stringify(n));n._self=e,Object.keys(n).forEach(e=>{"_self"!==e&&delete n[e]})}n[e]=t}})}function addEventListenerOnce(e,r,t){e&&!t.hasBind&&r&&(e.addEventListener(r,t),t.hasBind=!0)}function removeEventListener(e,r,t){e&&r&&(e.removeEventListener(r,t),t.hasBind=!1)}function checkCtrlOrCommand(e){return!!e&&("win32"===process.platform?e.ctrlKey:e.metaKey)}function pickTargetCurveDump(e,r,t){if(!r||!t[e.nodePath][e.prop])return[];const a=t[e.nodePath][e.prop],n=a.type;let o=[];if(a.partKeys){const s=a.partKeys.map(r=>t[e.nodePath][r]);r.forEach(e=>{if(!e._parentType||e._parentType.value!==n.value)return;s.find(r=>r.displayName===e.displayName)&&e.keyframes.length&&o.push(e)})}else for(const e of r)if(!(n&&e.type&&e.type.value!==n.value||!e.keyframes.length)&&(o=[e],e.key===a.prop))break;return o}function changeParentToPart(e,r){if(!e.length)return{};if(1===e.length)return sortKeysToTreeMap(e);const t={};return e.forEach(e=>{const a=r[e.nodePath][e.prop];if(a&&a.partKeys)a.partKeys.forEach(a=>{const n=r[e.nodePath][a];if(n.keyFrames.find(r=>r.frame===e.rawFrame)){const r=t[n.prop+e.frame],a=e.offsetFrame||r&&r.offsetFrame||e.frame-e.rawFrame;t[e.key]=Object.assign(Object.assign({},e),{offsetFrame:a})}});else{const r=t[a.prop+e.frame],n=e.offsetFrame||r&&r.offsetFrame||e.frame-e.rawFrame;t[e.key]=Object.assign(Object.assign({},e),{offsetFrame:n})}}),sortKeysToTreeMap(Object.values(t))}function propDataToCurveDump(e){const r=e.keyFrames.map(r=>r.curve&&transCurveKeyToDumpKey(r.curve,e.type)||r);return{nodePath:e.nodePath,keyframes:r,displayName:e.displayName,key:e.prop,type:e.type,postExtrap:e.postExtrap,preExtrap:e.preExtrap,isCurveSupport:e.isCurveSupport}}function T(e,r=""){return Editor.I18n.t(`animator.${r}${e}`)}function calcEmbeddedPlayerKey(e){var r;return`begin:${e.begin},end:${e.end},player:${null===(r=e.playable)||void 0===r?void 0:r.type},group:${e.group},displayName:${e.displayName}`}exports.calcKeyFrameKey=calcKeyFrameKey,exports.transKeyFrames=transKeyFrames,exports.transDumpKeyToCurveKey=transDumpKeyToCurveKey,exports.transCurveKeyToDumpKey=transCurveKeyToDumpKey,exports.mockDumpToCtrl=mockDumpToCtrl,exports.transformCtrlKeyToDump=transformCtrlKeyToDump,exports.transformCurveKeyToDump=transformCurveKeyToDump,exports.formatClipDump=formatClipDump,exports.timeToFrame=timeToFrame,exports.frameToTime=frameToTime,exports.transFrameByTypeInGrid=transFrameByTypeInGrid,exports.transFrameByType=transFrameByType,exports.sortSelectParams=sortSelectParams,exports.sortKeysToTreeMap=sortKeysToTreeMap,exports.calcParamPath=calcParamPath,exports.checkPropertyInMenu=checkPropertyInMenu,exports.sortPropertyMenu=sortPropertyMenu,exports.isMenuItem=isMenuItem,exports.addEventListenerOnce=addEventListenerOnce,exports.removeEventListener=removeEventListener,exports.checkCtrlOrCommand=checkCtrlOrCommand,exports.pickTargetCurveDump=pickTargetCurveDump,exports.changeParentToPart=changeParentToPart,exports.propDataToCurveDump=propDataToCurveDump,exports.T=T,exports.calcEmbeddedPlayerKey=calcEmbeddedPlayerKey;