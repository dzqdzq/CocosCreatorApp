"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Grid=void 0;const Chroma=require("chroma-js"),HALF_TEXT_WIDTH=5,POINT_LENGTH=2,LinearTicks=require("./../../../../static//script/linear-ticks.js"),{clamp:clamp}=Editor.Utils.Math;class Grid{constructor(t){this.xAxisScale=1,this.xAxisOffset=0,this.xAnchor=.5,this.yAxisScale=1,this.yAxisOffset=0,this.yAnchor=.5,this.labelShowType="time",this.cxt2D=t.context,this.axis=t.axis,this.labelShowType=t.showType,this.cxt2D.lineWidth=t.lineWidth||1,this.lineColor=t.color||"#ccc",this._lineColor=Chroma(this.lineColor),this.hticks=new LinearTicks;const{lods:i,minScale:s,maxScale:e,sample:h,startOffset:a,container:c}=this.axis;this.xAxisOffset=a||0,this.startOffset=a||0,this.sample=h,this.container=c,this.hticks.initTicks(i,s,e,h).spacing(10,20),this.xAxisScale=clamp(this.xAxisScale,this.hticks.minValueScale,this.hticks.maxValueScale),this.hformat=t.hformat}set cxt2D(t){this.canvas=t.canvas,this._cxt2D=t}get cxt2D(){return this._cxt2D}get xMinScale(){return this.hticks.minValueScale}get xMaxScale(){return this.hticks.maxValueScale}updateScale(t,i){const{lods:s,sample:e}=this.axis;this.hticks.initTicks(s,t,i,e).spacing(10,20)}xAxisScaleAt(t,i){const s=this.pixelToValueH(t);this.xAxisScale=clamp(i,this.hticks.minValueScale,this.hticks.maxValueScale);const e=this.valueToPixelH(s);return this.transferX(t-e),this.xAxisScale}transferX(t){if(this.xAxisOffset===this.startOffset&&t>0)return;let i,s,e=this.xAxisOffset+t;e>this.startOffset&&(e=this.startOffset),void 0!==this.xMinRange&&null!==this.xMinRange&&(i=this.valueToPixelH(this.xMinRange)),void 0!==this.xMaxRange&&null!==this.xMaxRange&&(s=this.valueToPixelH(this.xMaxRange),s=Math.max(0,s-this.canvas.width)),this.xAxisOffset=e,void 0===i||void 0===s?void 0===i?void 0===s||(this.xAxisOffset=Math.max(this.xAxisOffset,-s)):this.xAxisOffset=Math.min(this.xAxisOffset,-i):this.xAxisOffset=clamp(this.xAxisOffset,-s,-i)}resize(t,i){if(!t||!i){const s=this.canvas.getBoundingClientRect();t=t||s.width,i=i||s.height,t=Math.round(t),i=Math.round(i)}this.canvas.width===t&&this.canvas.height===i||(this.canvas.width=t,this.canvas.height=i,this.render())}render(){this.clear(),this.updateGrids(),this.updateLabels()}pixelToValueH(t){return(t-this.xAxisOffset)/this.xAxisScale}valueToPixelH(t){return t*this.xAxisScale+this.xAxisOffset}updateLabels(){if(!this.container)return;const t=this.hticks.levelForStep(30);let i="";this.hticks.ticksAtLevel(t,!1).forEach(t=>{const s=Math.floor(this.valueToPixelH(t)),e=this.hformat(t,this.labelShowType,this.sample),h=e.toString().length/2*4;i+=`<span style="transform: translateX(${Math.floor(s-this.startOffset-h)}px);">${e}</span>`}),this.container.x.innerHTML=i}clear(){this.cxt2D.clearRect(0,0,this.canvas.width,this.canvas.height)}updateGrids(){let t,i,s;const e=this.pixelToValueH(0),h=this.pixelToValueH(this.canvas.width);this.hticks.range(e,h,this.canvas.width);for(let e=this.hticks.minTickLevel;e<=this.hticks.maxTickLevel;++e)if((i=this.hticks.tickRatios[e])>0){this.cxt2D.strokeStyle=`rgba(${this._lineColor.rgb().toString()}, ${3*i})`,t=this.hticks.ticksAtLevel(e,!0);for(const i of t)this.cxt2D.beginPath(),s=this.valueToPixelH(i),this.cxt2D.moveTo(Math.floor(s)+.5,35),this.cxt2D.lineTo(Math.floor(s)+.5,this.canvas.height),this.cxt2D.stroke()}}}exports.Grid=Grid;