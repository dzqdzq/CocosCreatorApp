"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useCurveEditor = exports.generateOperateHandler = void 0;
const vue_js_1 = require("vue/dist/vue.js");
const store_base_1 = require("./store-base");
function generateOperateHandler(map) {
    const func = (...args) => {
        const operate = args[0];
        map[operate]?.apply(undefined, args);
    };
    return func;
}
exports.generateOperateHandler = generateOperateHandler;
function useCurveEditor(options) {
    const { size: containerSize, configure } = options;
    const visible = (0, vue_js_1.ref)(false);
    const curveEditor = (0, vue_js_1.ref)();
    const initialized = (0, vue_js_1.ref)(false);
    const baseStore = (0, store_base_1.useBaseStore)();
    function getElement() {
        const el = (0, vue_js_1.unref)(curveEditor);
        if (!el) {
            throw new Error(`curve editor element is not ready`);
        }
        return el;
    }
    const curveCtrl = (0, vue_js_1.computed)(() => {
        return curveEditor.value?.curveCtrl;
    });
    const sample = (0, vue_js_1.customRef)((track, trigger) => {
        return {
            get() {
                track();
                return curveEditor.value?.sample ?? 1;
            },
            set(val) {
                if (!curveEditor.value) {
                    return;
                }
                curveEditor.value.sample = val;
                trigger();
            },
        };
    });
    const show = () => {
        if (visible.value) {
            return;
        }
        visible.value = true;
        (0, vue_js_1.nextTick)(() => {
            if (!visible.value) {
                return;
            }
            const el = getElement();
            // FIXME: 在第一次显示时重新执行一次初始化配置动作。
            // CurveEditor 内部有计算逻辑依赖了元素高度，隐藏的时候计算值不正确，需要在显示的时候重新计算
            // 如 xAxis yAxis init 时需要 grid.canvas.width, grid.canvas.height
            if (!initialized.value) {
                configure(el);
                initialized.value = true;
            }
            resize();
        });
    };
    const hide = () => {
        if (!visible.value) {
            return;
        }
        visible.value = false;
    };
    const onFocus = (event) => {
        if (!options.uniqueName) {
            return;
        }
        baseStore.focusedCurve = options.uniqueName;
    };
    const onBlur = (event) => {
        if (!options.uniqueName) {
            return;
        }
        baseStore.focusedCurve = '';
    };
    const resize = (width, height) => {
        const el = (0, vue_js_1.unref)(curveEditor);
        if (!el)
            return;
        if (width === undefined) {
            if (!containerSize) {
                throw new Error('boxSize is required');
            }
            width = (0, vue_js_1.unref)(containerSize.width);
        }
        if (height === undefined) {
            if (!containerSize) {
                throw new Error('boxSize is required');
            }
            height = (0, vue_js_1.unref)(containerSize.height);
        }
        el.resize(width, height);
    };
    const paint = (data) => {
        const el = (0, vue_js_1.unref)(curveEditor);
        if (!el)
            return;
        el.curveCtrl.paint(data);
    };
    const repaint = () => {
        const el = getElement();
        el.repaint();
    };
    const zoomToFit = () => {
        const el = getElement();
        el.curveCtrl.zoomToFit();
    };
    const zoomToSelectedKeys = () => {
        const el = getElement();
        el.curveCtrl.zoomToSelectedKeyframes();
    };
    const getExposedAPI = () => {
        return {
            editor: curveEditor,
            curveCtrl,
            paint,
            resize,
            repaint,
            zoomToFit,
            zoomToSelectedKeys,
            sample,
        };
    };
    return {
        curveEditor,
        getElement,
        visible,
        show,
        hide,
        onFocus,
        onBlur,
        curveCtrl,
        paint,
        resize,
        repaint,
        zoomToFit,
        sample,
        getExposedAPI,
    };
}
exports.useCurveEditor = useCurveEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWN1cnZlLWVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NvdXJjZS9wYW5lbC92bS9ob29rcy91c2UtY3VydmUtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRDQVl5QjtBQVN6Qiw2Q0FBNEM7QUFtQzVDLFNBQWdCLHNCQUFzQixDQUFDLEdBQXVEO0lBQzFGLE1BQU0sSUFBSSxHQUF3QixDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7UUFDMUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3pDLENBQUMsQ0FBQztJQUNGLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFORCx3REFNQztBQUVELFNBQWdCLGNBQWMsQ0FBQyxPQUE2QjtJQUN4RCxNQUFNLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFFbkQsTUFBTSxPQUFPLEdBQUcsSUFBQSxZQUFHLEVBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0IsTUFBTSxXQUFXLEdBQUcsSUFBQSxZQUFHLEdBQStCLENBQUM7SUFDdkQsTUFBTSxXQUFXLEdBQUcsSUFBQSxZQUFHLEVBQUMsS0FBSyxDQUFDLENBQUM7SUFFL0IsTUFBTSxTQUFTLEdBQUcsSUFBQSx5QkFBWSxHQUFFLENBQUM7SUFFakMsU0FBUyxVQUFVO1FBQ2YsTUFBTSxFQUFFLEdBQUcsSUFBQSxjQUFLLEVBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztTQUN4RDtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELE1BQU0sU0FBUyxHQUFHLElBQUEsaUJBQVEs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QztBQUNOLENBQUM7QUF6SkQsd0NBeUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBjb21wdXRlZCxcbiAgICByZWYsXG4gICAgd2F0Y2gsXG4gICAgb25Nb3VudGVkLFxuICAgIG9uVW5tb3VudGVkLFxuICAgIFJlZixcbiAgICB1bnJlZixcbiAgICBuZXh0VGljayxcbiAgICB3YXRjaEVmZmVjdCxcbiAgICB0b1JlZixcbiAgICBjdXN0b21SZWYsXG59IGZyb20gJ3Z1ZS9kaXN0L3Z1ZS5qcyc7XG5cbmltcG9ydCB7XG4gICAgSUFuaUN1cnZlQ29tcG9uZW50LFxuICAgIElDdXJ2ZUtleUluZm9zLFxuICAgIElDdXJ2ZVZhbHVlLFxuICAgIE1heWJlUmVmLFxuICAgIElBbmlDdXJ2ZU5hbWUsXG59IGZyb20gJy4uLy4uLy4uLy4uL0B0eXBlcy9wcml2YXRlJztcbmltcG9ydCB7IHVzZUJhc2VTdG9yZSB9IGZyb20gJy4vc3RvcmUtYmFzZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlckN1cnZlQmFzZU9wdGlvbnMge1xuICAgIC8vIOWuueWZqOWFg+e0oOWwuuWvuOWkp+Wwj1xuICAgIHNpemU/OiB7IHdpZHRoOiBNYXliZVJlZjxudW1iZXI+OyBoZWlnaHQ6IE1heWJlUmVmPG51bWJlcj4gfTtcbiAgICBjb25maWd1cmUoZWw6IEVkaXRvci5VSS5IVE1MQ3VzdG9tRWxlbWVudCk6IHZvaWQ7XG5cbiAgICB1bmlxdWVOYW1lPzogSUFuaUN1cnZlTmFtZTtcbn1cblxuZXhwb3J0IHR5cGUgQ3VydmVPcGVyYXRlSGFuZGxlciA9IChcbiAgICBvcGVyYXRlOiBDdXJ2ZU9wZXJhdGUsXG4gICAgY3VydmVLZXlGcmFtZXM6IElDdXJ2ZUtleUluZm9zW10sXG4gICAgdGFyZ2V0RnJhbWU/OiBudW1iZXIsXG4pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIEN1cnZlT3BlcmF0ZSA9XG4gICAgfCAnc2VsZWN0J1xuICAgIHwgJ2RiLXNlbGVjdCdcbiAgICB8ICd1bnNlbGVjdCdcbiAgICB8ICdjcmVhdGUta2V5cydcbiAgICB8ICdyZW1vdmUta2V5cydcbiAgICB8ICdtb3ZlLWtleXMnXG4gICAgfCAnc2NhbGUta2V5cydcbiAgICB8ICdhcHBseS1iZXppZXInXG4gICAgfCAnY29weSdcbiAgICB8ICdzZWxlY3QtY3VydmUnXG4gICAgfCAnc2VsZWN0LWN1cnZlLWNsaXAnXG4gICAgfCAnbW92ZS1jdXJ2ZSdcbiAgICB8ICdjaGFuZ2UtdGFuZ2VudC13ZWlnaHQnXG4gICAgfCAnY2hhbmdlLWludGVycC1tb2RlJ1xuICAgIHwgJ2NoYW5nZS1icm9rZW4tc3RhdGUnXG4gICAgfCAncGFzdGUnXG4gICAgfCAndGFuZ2VudCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZU9wZXJhdGVIYW5kbGVyKG1hcDogUGFydGlhbDxSZWNvcmQ8Q3VydmVPcGVyYXRlLCBDdXJ2ZU9wZXJhdGVIYW5kbGVyPj4pIHtcbiAgICBjb25zdCBmdW5jOiBDdXJ2ZU9wZXJhdGVIYW5kbGVyID0gKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgY29uc3Qgb3BlcmF0ZSA9IGFyZ3NbMF07XG4gICAgICAgIG1hcFtvcGVyYXRlXT8uYXBwbHkodW5kZWZpbmVkLCBhcmdzKTtcbiAgICB9O1xuICAgIHJldHVybiBmdW5jO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlQ3VydmVFZGl0b3Iob3B0aW9uczogVXNlckN1cnZlQmFzZU9wdGlvbnMpIHtcbiAgICBjb25zdCB7IHNpemU6IGNvbnRhaW5lclNpemUsIGNvbmZpZ3VyZSB9ID0gb3B0aW9ucztcblxuICAgIGNvbnN0IHZpc2libGUgPSByZWYoZmFsc2UpO1xuICAgIGNvbnN0IGN1cnZlRWRpdG9yID0gcmVmPEVkaXRvci5VSS5IVE1MQ3VzdG9tRWxlbWVudD4oKTtcbiAgICBjb25zdCBpbml0aWFsaXplZCA9IHJlZihmYWxzZSk7XG5cbiAgICBjb25zdCBiYXNlU3RvcmUgPSB1c2VCYXNlU3RvcmUoKTtcblxuICAgIGZ1bmN0aW9uIGdldEVsZW1lbnQoKSB7XG4gICAgICAgIGNvbnN0IGVsID0gdW5yZWYoY3VydmVFZGl0b3IpO1xuICAgICAgICBpZiAoIWVsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGN1cnZlIGVkaXRvciBlbGVtZW50IGlzIG5vdCByZWFkeWApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbDtcbiAgICB9XG5cbiAgICBjb25zdCBjdXJ2ZUN0cmwgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkPigoKSA9PiB7XG4gICAgICAgIHJldHVybiBjdXJ2ZUVkaXRvci52YWx1ZT8uY3VydmVDdHJsO1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc2FtcGxlID0gY3VzdG9tUmVmPG51bWJlcj4oKHRyYWNrLCB0cmlnZ2VyKSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBnZXQoKSB7XG4gICAgICAgICAgICAgICAgdHJhY2soKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VydmVFZGl0b3IudmFsdWU/LnNhbXBsZSA/PyAxO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldCh2YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWN1cnZlRWRpdG9yLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY3VydmVFZGl0b3IudmFsdWUuc2FtcGxlID0gdmFsO1xuICAgICAgICAgICAgICAgIHRyaWdnZXIoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgfSk7XG5cbiAgICBjb25zdCBzaG93ID0gKCkgPT4ge1xuICAgICAgICBpZiAodmlzaWJsZS52YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZpc2libGUudmFsdWUgPSB0cnVlO1xuXG4gICAgICAgIG5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICAgIGlmICghdmlzaWJsZS52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGVsID0gZ2V0RWxlbWVudCgpO1xuXG4gICAgICAgICAgICAvLyBGSVhNRTog5Zyo56ys5LiA5qyh5pi+56S65pe26YeN5paw5omn6KGM5LiA5qyh5Yid5aeL5YyW6YWN572u5Yqo5L2c44CCXG4gICAgICAgICAgICAvLyBDdXJ2ZUVkaXRvciDlhoXpg6jmnInorqHnrpfpgLvovpHkvp3otZbkuoblhYPntKDpq5jluqbvvIzpmpDol4/nmoTml7blgJnorqHnrpflgLzkuI3mraPnoa7vvIzpnIDopoHlnKjmmL7npLrnmoTml7blgJnph43mlrDorqHnrpdcbiAgICAgICAgICAgIC8vIOWmgiB4QXhpcyB5QXhpcyBpbml0IOaXtumcgOimgSBncmlkLmNhbnZhcy53aWR0aCwgZ3JpZC5jYW52YXMuaGVpZ2h0XG4gICAgICAgICAgICBpZiAoIWluaXRpYWxpemVkLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJlKGVsKTtcbiAgICAgICAgICAgICAgICBpbml0aWFsaXplZC52YWx1ZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNpemUoKTtcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBjb25zdCBoaWRlID0gKCkgPT4ge1xuICAgICAgICBpZiAoIXZpc2libGUudmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2aXNpYmxlLnZhbHVlID0gZmFsc2U7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uRm9jdXMgPSAoZXZlbnQ6IEZvY3VzRXZlbnQpID0+IHtcbiAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZU5hbWUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBiYXNlU3RvcmUuZm9jdXNlZEN1cnZlID0gb3B0aW9ucy51bmlxdWVOYW1lO1xuICAgIH07XG4gICAgY29uc3Qgb25CbHVyID0gKGV2ZW50OiBGb2N1c0V2ZW50KSA9PiB7XG4gICAgICAgIGlmICghb3B0aW9ucy51bmlxdWVOYW1lKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYmFzZVN0b3JlLmZvY3VzZWRDdXJ2ZSA9ICcnO1xuICAgIH07XG5cbiAgICBjb25zdCByZXNpemUgPSAod2lkdGg/OiBudW1iZXIsIGhlaWdodD86IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBlbCA9IHVucmVmKGN1cnZlRWRpdG9yKTtcbiAgICAgICAgaWYgKCFlbCkgcmV0dXJuO1xuXG4gICAgICAgIGlmICh3aWR0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lclNpemUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JveFNpemUgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdpZHRoID0gdW5yZWYoY29udGFpbmVyU2l6ZS53aWR0aCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGhlaWdodCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lclNpemUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JveFNpemUgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhlaWdodCA9IHVucmVmKGNvbnRhaW5lclNpemUuaGVpZ2h0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGVsLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgICB9O1xuXG4gICAgY29uc3QgcGFpbnQgPSAoZGF0YTogSUN1cnZlVmFsdWUgfCBudWxsIHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgICAgIGNvbnN0IGVsID0gdW5yZWYoY3VydmVFZGl0b3IpO1xuICAgICAgICBpZiAoIWVsKSByZXR1cm47XG5cbiAgICAgICAgZWwuY3VydmVDdHJsLnBhaW50KGRhdGEpO1xuICAgIH07XG5cbiAgICBjb25zdCByZXBhaW50ID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBlbCA9IGdldEVsZW1lbnQoKTtcbiAgICAgICAgZWwucmVwYWludCgpO1xuICAgIH07XG5cbiAgICBjb25zdCB6b29tVG9GaXQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGVsID0gZ2V0RWxlbWVudCgpO1xuICAgICAgICBlbC5jdXJ2ZUN0cmwuem9vbVRvRml0KCk7XG4gICAgfTtcblxuICAgIGNvbnN0IHpvb21Ub1NlbGVjdGVkS2V5cyA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgZWwgPSBnZXRFbGVtZW50KCk7XG4gICAgICAgIGVsLmN1cnZlQ3RybC56b29tVG9TZWxlY3RlZEtleWZyYW1lcygpO1xuICAgIH07XG5cbiAgICBjb25zdCBnZXRFeHBvc2VkQVBJID0gKCk6IElBbmlDdXJ2ZUNvbXBvbmVudCA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlZGl0b3I6IGN1cnZlRWRpdG9yIGFzIFJlZjxFZGl0b3IuVUkuSFRNTEN1c3RvbUVsZW1lbnQ+LFxuICAgICAgICAgICAgY3VydmVDdHJsLFxuICAgICAgICAgICAgcGFpbnQsXG4gICAgICAgICAgICByZXNpemUsXG4gICAgICAgICAgICByZXBhaW50LFxuICAgICAgICAgICAgem9vbVRvRml0LFxuICAgICAgICAgICAgem9vbVRvU2VsZWN0ZWRLZXlzLFxuICAgICAgICAgICAgc2FtcGxlLFxuICAgICAgICB9O1xuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBjdXJ2ZUVkaXRvcixcbiAgICAgICAgZ2V0RWxlbWVudCxcblxuICAgICAgICB2aXNpYmxlLFxuICAgICAgICBzaG93LFxuICAgICAgICBoaWRlLFxuICAgICAgICBvbkZvY3VzLFxuICAgICAgICBvbkJsdXIsXG5cbiAgICAgICAgY3VydmVDdHJsLFxuICAgICAgICBwYWludCxcbiAgICAgICAgcmVzaXplLFxuICAgICAgICByZXBhaW50LFxuICAgICAgICB6b29tVG9GaXQsXG4gICAgICAgIHNhbXBsZSxcblxuICAgICAgICBnZXRFeHBvc2VkQVBJLFxuICAgIH07XG59XG4iXX0=