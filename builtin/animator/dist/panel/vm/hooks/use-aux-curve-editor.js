"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.useAuxCurveEditor=void 0;const vue_js_1=require("vue/dist/vue.js"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),ipc_event_1=require("../../share/ipc-event"),utils_1=require("../../utils"),store_aux_1=require("./store-aux"),store_base_1=require("./store-base"),store_grid_1=require("./store-grid"),use_curve_editor_1=require("./use-curve-editor"),DUMP_VALUE_TYPE="Float",CURVE_COLOR="#7979D7";function useAuxCurveEditor(e){const t=(0,store_base_1.useBaseStore)(),K=(0,store_aux_1.useAuxCurveStore)(),P=e.currentClip??(0,vue_js_1.computed)(()=>t.currentClip);e=(0,use_curve_editor_1.useCurveEditor)({...e,configure:e=>animation_editor_1.animationEditor.configureCurveEditor(e),uniqueName:"auxCurve"});const{curveEditor:r,getElement:n,paint:a,sample:u}=e,W=(0,vue_js_1.ref)(),i=(0,vue_js_1.computed)(()=>{var e=K.curves,t=K.selectedCurve;if(e.length<1||null==t)return null;var e={curveInfos:{},duration:0,wrapMode:0},r=[];for(const n of t.keyframes)n.curve&&r.push(n.curve);return e.curveInfos[t.displayName]={keys:r,postWrapMode:t.postExtrap,preWrapMode:t.preExtrap,color:CURVE_COLOR},e}),D=e=>animation_editor_1.animationEditor.updateCurrentFrame(e),o=(e,t,r)=>{if(t)switch(e){case"select":var n={keyframes:[],ctrl:!1,offset:0,offsetFrame:0,startX:0};for(const y of t){var a=(0,utils_1.transformCtrlKeyToDump)(y.keys,DUMP_VALUE_TYPE).map((e,t)=>{return{x:y.keys[t].key.canvas.x-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:e.frame,rawFrame:e.frame,key:y.key}});n.keyframes.push(...a)}K.selectKeyInfo=n;break;case"db-select":var u=t[0].keys,u=(0,utils_1.transformCtrlKeyToDump)(u,DUMP_VALUE_TYPE);D(u[0].frame);break;case"select-curve":case"select-curve-clip":W.value={name:t[0].key,color:CURVE_COLOR};break;case"apply-bezier":{const m=t[0].key;u=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(P),m,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode}));(0,ipc_event_1.IApplyOperation)(u);break}case"scale-keys":case"move-keys":var i=[],o=[],s={keyframes:[],ctrl:!1,offset:0,offsetFrame:0,startX:0};for(const d of t){var _=d.keys,p=(0,utils_1.transformCtrlKeyToDump)(_,DUMP_VALUE_TYPE);for(let e=0;e<_.length;e++){var c=_[e],v=Math.round(c.key.point.x-c.raw.point.x),g={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(p[e].frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:p[e].frame,rawFrame:Math.round(c.raw.point.x),offsetFrame:v,key:d.key},g=(s.keyframes.push(g),Math.round(c.key.point.y-c.raw.point.y));(v||g)&&(0!==v&&i.push((0,ipc_event_1.moveAuxKeys)((0,vue_js_1.unref)(P),d.key,[Math.round(c.raw.point.x)],v)),o.push((0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(P),d.key,p[e].frame,{newValue:c.key.point.y,inTangent:c.key.inTangent,outTangent:c.key.outTangent})))}}(0,ipc_event_1.IApplyOperation)([...i,...o]),K.selectKeyInfo=s;break;case"tangent":{const T=t[0].key;u=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(P),T,e.frame,{inTangent:e.inTangent,broken:e.broken,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight}));(0,ipc_event_1.IApplyOperation)(u);break}case"change-broken-state":{const k=t[0].key;u=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(P),k,e.frame,{inTangent:e.inTangent,broken:e.broken,outTangent:e.outTangent,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight}));(0,ipc_event_1.IApplyOperation)(u);break}case"create-keys":{const h=[];for(const E of t){var l=E.keys;const C=(0,utils_1.transformCtrlKeyToDump)(l,DUMP_VALUE_TYPE);C.forEach((e,t)=>{h.push((0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(P),E.key,C[t].frame,{inTangent:e.inTangent,outTangent:e.outTangent,newValue:e.dump.value,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight}))})}(0,ipc_event_1.IApplyOperation)(h);break}case"change-interp-mode":{const x=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,DUMP_VALUE_TYPE);x.push(...e.map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(P),t.key,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode})))}),(0,ipc_event_1.IApplyOperation)(x);break}case"change-tangent-weight":{const A=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,DUMP_VALUE_TYPE);A.push(...e.map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(P),t.key,e.frame,{tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight})))}),(0,ipc_event_1.IApplyOperation)(A);break}case"remove-keys":{const M=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,DUMP_VALUE_TYPE);M.push(...e.map(e=>(0,ipc_event_1.removeAuxKey)((0,vue_js_1.unref)(P),t.key,e.frame)))}),(0,ipc_event_1.IApplyOperation)(M),K.selectKeyInfo=null;break}case"move-curve":{const U=[];t.forEach(t=>{var e=t.keys,e=(0,utils_1.transformCtrlKeyToDump)(e,DUMP_VALUE_TYPE);U.push(...e.map(e=>(0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(P),t.key,e.frame,{newValue:e.dump.value})))}),(0,ipc_event_1.IApplyOperation)(U);break}case"copy":var u=t[0],f=u.keys[0];K.copyKeyframeSnap={clip:(0,vue_js_1.unref)(P),name:u.key,frame:f.raw.point.x,curve:{...f.raw},dump:{type:DUMP_VALUE_TYPE,value:f.raw.point.y}}}},s=(0,store_grid_1.useTransformEvent)();s.onUpdate(e=>{"aux_curve"!==e&&grid_ctrl_1.gridCtrl.grid&&(e=n(),(0,grid_ctrl_1.syncAxisX)(grid_ctrl_1.gridCtrl.grid,e.curveCtrl.grid),a(i.value))});const _=()=>{var e,t=K.copyKeyframeSnap;return null==t||null==(e=(0,utils_1.transDumpKeyToCurveKey)({...t.curve,frame:t.frame,dump:t.dump}))?[]:(e=[{key:{...e,canvas:{x:t.frame,y:t.dump.value}},raw:t.curve}],[{key:t.name,keys:e}])};return(0,vue_js_1.watchEffect)(()=>{u.value=t.currentSample}),(0,vue_js_1.watch)(i,(e,t,r)=>{let n=!1;(0,vue_js_1.nextTick)(()=>{n||a(e)}),r(()=>{n=!0})},{flush:"post"}),(0,vue_js_1.onMounted)(()=>{(0,vue_js_1.nextTick)(()=>{var e;r.value&&(e=r.value,animation_editor_1.animationEditor.configureCurveEditor(e),e.curveCtrl.getCopyKeys=_,e.curveCtrl.on("operate",o))})}),(0,vue_js_1.onUnmounted)(()=>{r.value&&r.value.curveCtrl.off("operate",o)}),{...e,onTransform:()=>{var e=n();grid_ctrl_1.gridCtrl.grid&&((0,grid_ctrl_1.syncAxisX)(e.curveCtrl.grid,grid_ctrl_1.gridCtrl.grid),s.emitUpdate("aux_curve"))},onOperate:o}}exports.useAuxCurveEditor=useAuxCurveEditor;