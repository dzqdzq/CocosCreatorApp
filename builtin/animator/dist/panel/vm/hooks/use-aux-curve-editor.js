"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.useAuxCurveEditor=void 0;const vue_js_1=require("vue/dist/vue.js"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),ipc_event_1=require("../../share/ipc-event"),utils_1=require("../../utils"),store_aux_1=require("./store-aux"),store_base_1=require("./store-base"),store_grid_1=require("./store-grid"),use_curve_editor_1=require("./use-curve-editor"),DUMP_VALUE_TYPE="Float",CURVE_COLOR="#7979D7";function useAuxCurveEditor(e){var t;const r=(0,store_base_1.useBaseStore)(),n=(0,store_aux_1.useAuxCurveStore)(),a=null!==(t=e.currentClip)&&void 0!==t?t:(0,vue_js_1.computed)(()=>r.currentClip),{element:o,getElement:s,hide:i,paint:u,resize:_,show:c,visible:p}=(0,use_curve_editor_1.useCurveEditor)(Object.assign(Object.assign({},e),{configure:e=>animation_editor_1.animationEditor.configureCurveEditor(e)})),l=(0,vue_js_1.ref)(),f=(0,vue_js_1.computed)(()=>{const e=n.curves,t=n.selectedCurve;if(e.length<1||null==t)return null;const r={curveInfos:{},duration:0,wrapMode:0},a=[];for(const e of t.keyframes)e.curve&&a.push(e.curve);return r.curveInfos[t.displayName]={keys:a,postWrapMode:t.postExtrap,preWrapMode:t.preExtrap,color:CURVE_COLOR},r}),g=(e,t,r)=>{if(t)switch(e){case"select":{const e={keyframes:[],ctrl:!1,offset:0,offsetFrame:0,startX:0};for(const r of t){const t=(0,utils_1.transformCtrlKeyToDump)(r.keys,DUMP_VALUE_TYPE).map((e,t)=>{return{x:r.keys[t].key.canvas.x-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:e.frame,rawFrame:e.frame,key:r.key}});e.keyframes.push(...t)}n.selectKeyInfo=e;break}case"db-select":{const e=t[0].keys;(e=>animation_editor_1.animationEditor.updateCurrentFrame(e))((0,utils_1.transformCtrlKeyToDump)(e,DUMP_VALUE_TYPE)[0].frame);break}case"select-curve":case"select-curve-clip":l.value={name:t[0].key,color:CURVE_COLOR};break;case"apply-bezier":{const e=t[0].key,r=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(t=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(a),e,t.frame,{inTangent:t.inTangent,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight,interpMode:t.interpMode,tangentWeightMode:t.tangentWeightMode}));(0,ipc_event_1.IApplyOperation)(r);break}case"scale-keys":case"move-keys":{const e=[],r=[],o={keyframes:[],ctrl:!1,offset:0,offsetFrame:0,startX:0};for(const n of t){const t=n.keys,s=(0,utils_1.transformCtrlKeyToDump)(t,DUMP_VALUE_TYPE);for(let i=0;i<t.length;i++){const u=t[i],_=Math.round(u.key.point.x-u.raw.point.x),c={x:grid_ctrl_1.gridCtrl.grid.valueToPixelH(s[i].frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,frame:s[i].frame,rawFrame:Math.round(u.raw.point.x),offsetFrame:_,key:n.key};o.keyframes.push(c);const p=Math.round(u.key.point.y-u.raw.point.y);if(!_&&!p)return;0!==_&&e.push((0,ipc_event_1.moveAuxKeys)((0,vue_js_1.unref)(a),n.key,[Math.round(u.raw.point.x)],_)),r.push((0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(a),n.key,s[i].frame,{newValue:u.key.point.y,inTangent:u.key.inTangent,outTangent:u.key.outTangent}))}}(0,ipc_event_1.IApplyOperation)([...e,...r]),n.selectKeyInfo=o;break}case"tangent":{const e=t[0].key,r=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(t=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(a),e,t.frame,{inTangent:t.inTangent,broken:t.broken,outTangent:t.outTangent,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight}));(0,ipc_event_1.IApplyOperation)(r);break}case"change-broken-state":{const e=t[0].key,r=(0,utils_1.transformCtrlKeyToDump)(t[0].keys,DUMP_VALUE_TYPE).map(t=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(a),e,t.frame,{broken:t.broken}));(0,ipc_event_1.IApplyOperation)(r);break}case"create-keys":{const e=[];for(const r of t){const t=r.keys,n=(0,utils_1.transformCtrlKeyToDump)(t,DUMP_VALUE_TYPE);n.forEach((t,o)=>{e.push((0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(a),r.key,n[o].frame,{inTangent:t.inTangent,outTangent:t.outTangent,newValue:t.dump.value,interpMode:t.interpMode,tangentWeightMode:t.tangentWeightMode,inTangentWeight:t.inTangentWeight,outTangentWeight:t.outTangentWeight}))})}(0,ipc_event_1.IApplyOperation)(e);break}case"change-interp-mode":{const e=[];t.forEach(t=>{const r=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(r,DUMP_VALUE_TYPE);e.push(...n.map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(a),t.key,e.frame,{inTangent:e.inTangent,outTangent:e.outTangent,interpMode:e.interpMode})))}),(0,ipc_event_1.IApplyOperation)(e);break}case"change-tangent-weight":{const e=[];t.forEach(t=>{const r=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(r,DUMP_VALUE_TYPE);e.push(...n.map(e=>(0,ipc_event_1.modifyAuxCurveOfKey)((0,vue_js_1.unref)(a),t.key,e.frame,{tangentWeightMode:e.tangentWeightMode,inTangentWeight:e.inTangentWeight,outTangentWeight:e.outTangentWeight})))}),(0,ipc_event_1.IApplyOperation)(e);break}case"remove-keys":{const e=[];t.forEach(t=>{const r=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(r,DUMP_VALUE_TYPE);e.push(...n.map(e=>(0,ipc_event_1.removeAuxKey)((0,vue_js_1.unref)(a),t.key,e.frame)))}),(0,ipc_event_1.IApplyOperation)(e),n.selectKeyInfo=null;break}case"move-curve":{const e=[];t.forEach(t=>{const r=t.keys,n=(0,utils_1.transformCtrlKeyToDump)(r,DUMP_VALUE_TYPE);e.push(...n.map(e=>(0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(a),t.key,e.frame,{newValue:e.dump.value})))}),(0,ipc_event_1.IApplyOperation)(e);break}case"copy":{const e=t[0],r=e.keys[0];n.copyKeyframeSnap={clip:(0,vue_js_1.unref)(a),name:e.key,frame:r.raw.point.x,curve:Object.assign({},r.raw),dump:{type:DUMP_VALUE_TYPE,value:r.raw.point.y}};break}}},v=(0,store_grid_1.useTransformEvent)();v.onUpdate(e=>{if("aux_curve"===e||!grid_ctrl_1.gridCtrl.grid)return;const t=s();(0,grid_ctrl_1.syncAxisX)(grid_ctrl_1.gridCtrl.grid,t.curveCtrl.grid),u(f.value)});const m=()=>{const e=s();grid_ctrl_1.gridCtrl.grid&&((0,grid_ctrl_1.syncAxisX)(e.curveCtrl.grid,grid_ctrl_1.gridCtrl.grid),v.emitUpdate("aux_curve"))},y=()=>{const e=n.copyKeyframeSnap;if(null==e)return[];const t=(0,utils_1.transDumpKeyToCurveKey)(Object.assign(Object.assign({},e.curve),{frame:e.frame,dump:e.dump}));if(null==t)return[];const r=[{key:Object.assign(Object.assign({},t),{canvas:{x:e.frame,y:e.dump.value}}),raw:e.curve}];return[{key:e.name,keys:r}]};var d;return(0,vue_js_1.watchEffect)(()=>{o.value&&(o.value.sample=r.currentSample)}),(0,vue_js_1.watch)(f,(e,t,r)=>{let n=!1;(0,vue_js_1.nextTick)(()=>{n||u(e)}),r(()=>{n=!0})},{flush:"post"}),(0,vue_js_1.onMounted)(()=>{(0,vue_js_1.nextTick)(()=>{o.value&&(d=o.value,animation_editor_1.animationEditor.configureCurveEditor(d),d.addEventListener("transform",m),d.curveCtrl.getCopyKeys=y,d.curveCtrl.on("operate",g))})}),(0,vue_js_1.onUnmounted)(()=>{if(o.value){const e=o.value;e.removeEventListener("transform",m),e.curveCtrl.off("operate",g)}}),{curveEl:o,visible:p,show:c,hide:i,paint:u,onTransform:m,onOperate:g}}exports.useAuxCurveEditor=useAuxCurveEditor;