"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewRowAux=void 0;const vue_js_1=require("vue/dist/vue.js"),lodash_1=require("lodash"),animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),utils_1=require("../../utils"),pop_menu_1=require("../../share/pop-menu"),global_data_1=require("../../share/global-data"),hooks_1=require("../hooks"),template='\n    <div\n        :style="elStyle"\n        class="content-item preview-row"\n        @mousedown="onRowMousedown"\n        @contextmenu="onRowContextmenu"\n    >\n        <div tabindex="-1" class="row-wrap" :style="wrapStyle">\n            \x3c!-- 关键帧显示 --\x3e\n            <div\n                v-for="(frame, index) in keyFrames"\n                :key="getFrameKey(frame)"\n                :style="queryKeyStyle(frame.x)"\n                :index="index"\n                class="key"\n                name="aux-key"\n                @mousedown="onKeyMousedown($event, index)"\n                @contextmenu="onKeyContextmenu($event, index)"\n            ></div>\n\n            <div\n                v-for="(item, index) in selectKey"\n                :key="\'active_\' + getFrameKey(item)"\n                :style="queryKeyStyle(item.x)"\n                class="active key"\n                name="key"\n            ></div>\n        </div>\n    </div>\n';exports.PreviewRowAux=(0,vue_js_1.defineComponent)({name:"PreviewRowAux",props:{name:{type:String,default:""},keyFrames:{type:Array,default:()=>[]},selectInfo:{type:Object,default:void 0},scroll:{type:Object,default:void 0},listIndex:{type:Number,default:0},offset:{type:Number,default:0},updateFrame:{type:Number,default:0},updatePosition:{type:Number,default:0},updateSelect:{type:Number,default:0},hidden:{type:Boolean,default:!1}},emits:{"select-key":null,"remove-key":null,"paste-key":null,"create-key":null},setup(e,t){const n=(0,hooks_1.useBaseStore)(),a=(0,hooks_1.useAuxCurveStore)(),r=(0,vue_js_1.ref)([]),o=(0,vue_js_1.computed)(()=>{var t,n;return e.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-(null!==(n=null===(t=e.scroll)||void 0===t?void 0:t.top)&&void 0!==n?n:0)}),u=(0,vue_js_1.computed)(()=>({transform:`translateY(${(0,vue_js_1.unref)(o)}px)`})),s=(0,vue_js_1.computed)(()=>({transform:`translateX(${e.offset}px)`}));async function l(t){const n=a.copyKeyframeSnap;if(null==n)return;const r=Object.assign(Object.assign({},n.curve),{newValue:n.dump.value});return animation_ctrl_1.animationCtrl.copyAuxKey({name:n.name,frame:n.frame,data:r},{name:e.name,frame:t,data:r})}function i(r){let o=!1;const u=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onAuxKeyContextMenus,!1),s=e.name,{frame:i}=e.keyFrames[r];let m=[i];if(e.selectInfo&&Array.isArray(e.selectInfo.keyframes)){for(const t of e.selectInfo.keyframes)if(t.key===s&&t.frame===i){o=!0;break}o&&(m=e.selectInfo.keyframes.map(e=>e.frame))}return m=Array.from(new Set(m)),u.copyAuxKey.enabled=m.length>0,u.copyAuxKey.click=(()=>{m.length<1||function(t){const r=e.keyFrames.find(e=>e.frame===t);if(!r||null==r.curve||null==r.dump)return;const o={clip:n.currentClip,name:e.name,frame:r.frame,curve:(0,lodash_1.cloneDeep)(r.curve),dump:(0,lodash_1.cloneDeep)(r.dump)};a.setCopyKeyframe(o)}(i)}),null!=a.copyKeyframeSnap?(u.pasteAuxKey.enabled=!0,u.pasteAuxKey.click=(()=>{l(i).then(()=>{t.emit("paste-key",s,i)})})):u.pasteAuxKey.enabled=!1,u.removeAuxKey.enabled=!0,u.removeAuxKey.click=(()=>{animation_ctrl_1.animationCtrl.removeAuxKey(s,i).then(()=>{t.emit("remove-key",s,i),o&&t.emit("select-key",s,null)})}),Object.values(u)}return(0,vue_js_1.watch)(()=>e.selectInfo,(t,n)=>{r.value=t?function(t){if(!t||!t.keyframes||!animation_ctrl_1.animationCtrl.clipsDump)return[];const n=[],a=new Set,r=e.keyFrames;for(let e=0;e<r.length;e++){const o=r[e];if(a.has(o.frame))continue;const u=t.keyframes.find(e=>e.key===o.prop&&o.frame===e.rawFrame);null!=u&&(n.push({key:u.key,frame:u.frame,rawFrame:u.rawFrame,x:u.x,offsetFrame:u.offsetFrame}),a.add(u.frame))}return n}(t):[]}),(0,hooks_1.useTickUpdate)(()=>e.updatePosition,()=>{const e=(0,vue_js_1.unref)(r);if(e.length>0)for(const t of e)t.x=grid_ctrl_1.gridCtrl.frameToCanvas(t.frame)}),{selectKey:r,elStyle:u,wrapStyle:s,getKeyMenu:i,queryKeyStyle:function(e){return{transform:`translateX(${Number.isFinite(e)?e:0}px) translateX(-50%) rotate(45deg)`}},getFrameKey:function(e){return`${e.frame}__${e.prop}`},onKeyMousedown:function(n,a){if(n.stopPropagation(),0!==n.button)return;const r=(0,utils_1.checkCtrlOrCommand)(n),o=e.keyFrames[a],u={keyframes:[{key:e.name,rawFrame:o.frame,frame:o.frame,x:o.x,offsetFrame:0}],ctrl:r,offset:0,offsetFrame:0,startX:n.x};t.emit("select-key",e.name,u),r||(global_data_1.Flags.mouseDownName="aux-key")},onKeyContextmenu:function(t,n){t.stopPropagation();const a=i(n);if(n>-1&&n<=e.keyFrames.length-1){const t=e.keyFrames[n];a.push({label:`Frame: ${t.frame}`,enabled:!1})}Editor.Menu.popup({x:t.pageX,y:t.pageY+10,menu:a})},onRowMousedown:function(n){t.emit("select-key",e.name,null)},onRowContextmenu:function(n){n.stopPropagation();const r=grid_ctrl_1.gridCtrl.pageToFrame(n.x),o=function(n){const r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onAuxRowContextMenus,!1),o=e.name;return r.createAuxKey=Object.assign(Object.assign({},pop_menu_1.popMenuMap.createAuxKey),{enabled:!0,click(){animation_ctrl_1.animationCtrl.createAuxKey(o,n).then(()=>{t.emit("create-key",o,n)})}}),null!=a.copyKeyframeSnap&&(r.pasteAuxKey.enabled=!0,r.pasteAuxKey.click=(()=>{l(n).then(()=>{t.emit("paste-key",o,n)})})),Object.values(r)}(r);o.push(Object.assign({},pop_menu_1.popMenuMap.separator)),o.push({label:`frame: ${r}`,enabled:!1}),Editor.Menu.popup({menu:o})}}},template:template});