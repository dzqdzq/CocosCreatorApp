"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuxiliaryCurveFrames=void 0;const vue_js_1=require("vue/dist/vue.js"),lodash_1=require("lodash"),ipc_event_1=require("../../share/ipc-event"),hooks_1=require("../hooks"),directives_1=require("../directives"),preview_row_aux_1=require("./preview-row-aux"),animation_editor_1=require("../../share/animation-editor"),template='\n    <div class="auxiliary-curves-frames">\n        <div\n            class="auxiliary-curves-frames__header content-device property-tools ns-resize"\n            @mousedown="onHeaderMousedown"\n        >\n            \x3c!-- TODO: should use ui-radio-group instead --\x3e\n            <div>\n                <ui-prop\n                    v-if="isPropEditable"\n                    type="dump"\n                    v-prop-dump="renderDump"\n                    @change-dump="onFrameValueChange"\n                ></ui-prop>\n            </div>\n            <div class="icon-group">\n                <ui-icon :active="curveVisible" value="curve" @click="showCurve"></ui-icon>\n                <ui-icon :active="!curveVisible" value="slider" @click="hideCurve"></ui-icon>\n            </div>\n        </div>\n\n        <div ref="framesArea" name="aux-curves" class="auxiliary-curves-frames__content">\n            <div v-show="curveVisible" class="tw-full">\n                <ui-curve-editor ref="curveEl" class="tw-block"></ui-curve-editor>\n            </div>\n\n            <div v-show="!curveVisible">\n                <PreviewRow\n                    v-for="(item, index) in curves"\n                    :key="String(index) + \'__\' + item.displayName"\n                    :name="item.displayName"\n                    :hidden="false"\n                    :key-frames="item.keyframes"\n                    :list-index="index"\n                    :update-position="$root.updatePosition"\n                    :update-frame="$root.updateKeyFrame"\n                    :update-select="$root.updateSelectKey"\n                    :lock="false"\n                    :offset="offset"\n                    :select-info="selectedKeyInfo"\n                    :scroll="scrollInfo"\n                    :param="[]"\n                    @select-key="updateSelectKey"\n                    @remove-key="onKeyRemove"\n                    @paste-key="onKeyPaste"\n                    @create-key="onKeyCreate"\n                ></PreviewRow>\n            </div>\n        </div>\n    </div>\n';function useFrameDump(){const e=(0,hooks_1.useAuxCurveStore)(),r=(0,vue_js_1.ref)(-1),u=(0,vue_js_1.computed)({get:()=>e.selectedFrameDump,set:r=>{e.selectedFrameDump=r}}),i=(0,vue_js_1.computed)(()=>null!=u.value),n=()=>{u.value=null};return{renderDump:u,isEditable:i,update:async(e,i,s)=>{if(""===i||""===e)return void n();const a=Date.now();r.value=a;const t=await(0,ipc_event_1.getAuxCurveValueAtFrame)(e,i,s);r.value===a&&((0,lodash_1.isPlainObject)(t)?u.value=Object.assign(Object.assign({},t),{displayName:"Value"}):u.value=t)},reset:n}}exports.AuxiliaryCurveFrames=(0,vue_js_1.defineComponent)({name:"AuxiliaryCurveFrames",components:{PreviewRow:preview_row_aux_1.PreviewRowAux},directives:{propDump:directives_1.UiPropDump},props:{offset:{type:Number,default:0},currentFrame:{type:Number,default:0}},setup(e,r){const u=(0,hooks_1.useBaseStore)(),i=(0,hooks_1.useAuxCurveStore)(),n=(0,vue_js_1.ref)({}),s=(0,vue_js_1.ref)(),a=(0,vue_js_1.computed)(()=>u.currentClip),t=(0,hooks_1.useElementSize)(s),{curveEl:o,visible:v,show:l,hide:c}=(0,hooks_1.useAuxCurveEditor)({currentClip:a,size:t}),d=(0,vue_js_1.computed)(()=>i.curves),p=(0,vue_js_1.toRef)(i,"selectedCurveName"),_=(0,vue_js_1.toRef)(i,"selectKeyInfo"),m=(0,vue_js_1.computed)(()=>i.curveNameMap),{isEditable:f,renderDump:y,update:w,reset:h}=useFrameDump();(0,vue_js_1.watch)(a,()=>{i.reset()}),(0,vue_js_1.watch)(()=>[(0,vue_js_1.unref)(a),p.value,e.currentFrame],async([e,r,u],i,n)=>{w(e,r,u)});return{framesArea:s,curveEl:o,curveVisible:v,showCurve:l,hideCurve:c,scrollInfo:n,curves:d,selectedKeyInfo:_,keyframeMap:m,renderDump:y,isPropEditable:f,onFrameValueChange:r=>{var u,i;const n=null===(i=null===(u=r.target)||void 0===u?void 0:u.dump)||void 0===i?void 0:i.value;if(!f.value||!Number.isFinite(n))return;const s={newValue:n};(0,ipc_event_1.IApplyOperation)((0,ipc_event_1.createAuxKey)((0,vue_js_1.unref)(a),p.value,e.currentFrame,s))},updateSelectKey:(e,r)=>{p.value=e,i.selectKeyInfo=r},onKeyRemove:(e,r)=>{e===p.value&&w((0,vue_js_1.unref)(a),p.value,r)},onKeyPaste:(e,r)=>{e===p.value&&w((0,vue_js_1.unref)(a),p.value,r)},onKeyCreate:(e,r)=>{e===p.value&&w((0,vue_js_1.unref)(a),p.value,r)},onHeaderMousedown:e=>{animation_editor_1.animationEditor.onStartResize(e,"auxCurve")}}},template:template});