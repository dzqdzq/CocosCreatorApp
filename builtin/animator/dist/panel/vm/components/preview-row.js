"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),global_data_1=require("../../share/global-data"),utils_1=require("../../utils"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-row.html"),"utf-8");let KeyFrames=[];function data(){return{keyData:[],refreshTask:null,refreshTaskNumber:0,dbKeyClick:!1,tips:"",selectKey:null,combine:!1,lines:[]}}async function mounted(){this.formatKey=getFormatKeyFunc(this.keyType),await this.refresh(),this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}function getLineInfo(e,t){const a=Math.min(e,t);return{x:0|a,w:Math.max(e,t)-a}}function getFormatKeyFunc(e){return"image"===e?function(e,t){return{x:e.x,i:t,value:e.value}}:function(e,t){return{x:e.x,i:t}}}exports.props=["keyFrames","selectInfo","param","type","index","listIndex","scroll","box","lock","offset","updateFrame","updatePosition","updateSelect","hidden","stickInfo"],exports.data=data,exports.watch={async updateFrame(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},updatePosition(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},box(){const e=this;if(!(e.display&&e.box&&e.keyData&&e.param))return;const{origin:t,w:a,h:r,type:o}=e.box;if("property"===o&&!e.type)return;if("node"===o&&e.type)return;const i=e.param[0],n=e.param[1];if(e.offsetHeight+animation_editor_1.animationEditor.LINE_HEIGHT/2<t.y||e.offsetHeight+animation_editor_1.animationEditor.LINE_HEIGHT/2>t.y+r)if(n)animation_editor_1.animationEditor.updateSelectKey({prop:n,nodePath:i,data:null,params:null});else{const t=[];for(const a of e.keyFrames)t.includes(a.prop)||(animation_editor_1.animationEditor.updateSelectKey({prop:a.prop,nodePath:i,data:null,params:null}),t.push(a.prop))}else if(n){let r=[];const o=[];for(const n of e.keyFrames)n.x+10+e.offset>t.x&&n.x+e.offset<t.x+a&&(r.push(n),o.push({nodePath:i,prop:n.prop,frame:n.frame}));if(0===r.length)return;r=JSON.parse(JSON.stringify(r)),animation_editor_1.animationEditor.updateSelectKey({data:r,params:o,nodePath:i,prop:n})}else{const r={};for(const o of e.keyFrames)r[o.prop]||(r[o.prop]={nodePath:i,data:[],params:[]}),o.x+10+e.offset>t.x&&o.x+e.offset<t.x+a&&(r[o.prop].data.push(o),r[o.prop].params.push({nodePath:i,prop:o.prop,frame:o.frame}));Object.keys(r).forEach(e=>{0!==r[e].data.length&&animation_editor_1.animationEditor.updateSelectKey({data:r[e].data,params:r[e].params,nodePath:i,prop:e})})}},selectInfo(e,t){this.$set(this,"selectKey",this.calcSelectKey(e))},updateSelect(){this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}},exports.computed={display(){return!this.scroll||(this.offsetHeight>=-animation_editor_1.animationEditor.LINE_HEIGHT&&this.offsetHeight<this.scroll.height+animation_editor_1.animationEditor.LINE_HEIGHT||void 0)},previewStyle(){return{transform:`translateY(${this.offsetHeight}px)`}},stickStyle(){if(!this.stickInfo)return;const{left:e,width:t}=this.stickInfo;return`left: ${e-this.offset}px; width: ${t}px;`},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},offsetHeight(){return this.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top},draggable(){return"key"!==this.keyType},keyType(){return this.type&&animation_editor_1.animationEditor.imageCCTypes.includes(this.type.value)?"image":"key"}},exports.components={},exports.methods={t:(e,t="preview_row.")=>Editor.I18n.t(`animator.${t}${e}`),calcSelectKey(e){const t=this;if(!e||!e.params||!animation_ctrl_1.animationCtrl.clipsDump)return null;const a=[];return(e=JSON.parse(JSON.stringify(e))).data.forEach((r,o)=>{const i=e.params[o];if(i.nodePath===t.param[0]){if("key"!==t.keyType){const e=t.keyFrames.find(e=>e.frame===r.frame);e&&(r.value=e.value)}if(t.param[1]){const e=t.param[1],o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][i.prop].partKeys;if(Array.isArray(o)&&o.includes(e)){const o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][e].keyFrames.find(e=>i.frame===e.frame);return void(o&&o.prop===e&&a.push({frame:o.frame,x:r.x,prop:o.prop,value:o.dump.value}))}const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][i.prop].parentPropKey;if("string"==typeof n&&n===e)return void a.push(r);if(e!==i.prop)return null;a.push(r)}else a.push(r)}}),Object.freeze(a)},async refresh(e){const t=this;if(t.refreshTaskNumber=0,!t.keyFrames||t.hidden)return t.lines=null,void(t.keyData=null);if(t.keyFrames.length<1)return t.lines=null,void(t.keyData=null);const a={};(KeyFrames=t.keyFrames).forEach((e,r)=>{a[e.frame]=t.formatKey(e,r)});const r=Object.values(a);r.sort((e,t)=>e.x-t.x);const o=[],i=[r[0]];let n;n=animation_ctrl_1.animationCtrl.clipConfig.isLock?e=>{r[e+1].x-i[i.length-1].x>5&&i.push(r[e+1])}:e=>{const t=getLineInfo(r[e].x,r[e+1].x);t.w>13&&o.push({x:r[e].x,style:`transform: translateX(${t.x}px); width: ${t.w}px`}),r[e+1].x-i[i.length-1].x>5&&i.push(r[e+1])};for(let e=0;e<r.length-1;e++)n(e);i.length!==r.length?t.combine=!0:t.combine=!1,t.lines=Object.freeze(o),t.keyData=Object.freeze(i.map(e=>e.i))},calcSelectClass(e){const t=["active"];return e&&this.type?t.push("image"):t.push("key"),t},queryKeyStyle(e){return"image"===this.keyType?`transform: translateX(${0|e}px);`:`transform: translateX(${e-5|0}px) rotate(45deg);`},queryLineStyle(e,t){if(e&&t){const a=Math.min(e.x,t.x);return`transform: translateX(${0|a}px); width: ${Math.max(e.x,t.x)-a}px`}},openBezierEditor(e){const t=animation_editor_1.animationEditor.gridCtrl.canvasToFrame(e.x),a=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[this.param[0]][this.param[1]].keyFrames.find(e=>e.frame===t);animation_editor_1.animationEditor.openBezierEditor(Object.assign({path:this.param[0]},a))},onDragLeave(e){this.tips="",this.draggable&&animation_editor_1.animationEditor.updateMouseFrame()},onDragOver(e){const t=this;if(!t.draggable)return;let a=[];const{additional:r,value:o}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};r?r.forEach(e=>{e.type===t.type.value&&a.push(e.value)}):o&&!a.includes(o)&&a.push(o),a.length?(requestAnimationFrame(()=>{animation_editor_1.animationEditor.updateMouseFrame({x:e.x,y:e.y})}),t.tips=t.t("asset_position_tips"),e.preventDefault(),e.dataTransfer.dropEffect="copy"):t.tips=`${t.t("asset_type_should_be")} ${t.type.value}`},async onDrop(e){const t=this;t.tips="",animation_editor_1.animationEditor.updateMouseFrame();const a=[];let r=[];const{additional:o,value:i,type:n}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(o&&o.forEach(e=>{e.type===t.type.value&&(r.push(e.value),a.push(e))}),i&&!r.includes(i)&&(r.push(i),a.push({type:n,value:i})),!r.length)return;let s=grid_ctrl_1.gridCtrl.pageToFrame(e.x);const p=await animation_editor_1.animationEditor.getConfig("spacingFrame")||1;a.sort((e,t)=>e.name>t.name?1:-1);const m=[];for(const e of a)if(e.type===t.type.value){if(-1===e.value.indexOf("@")){const t=await Editor.Message.request("asset-db","query-asset-info",e.value);if(!t){console.warn(`Failed to create keyframe: Asset not found - ${e.value}`);continue}const a=Object.keys(t.subAssets);e.value=t.subAssets[a[0]].uuid}m.push({frame:s,value:{newValue:{uuid:e.value}},param:{nodePath:t.param[0],prop:t.param[1]}}),s+=p}animation_ctrl_1.animationCtrl.createKeyBatch(m)},async onMouseDown(e,t){if(e.stopPropagation(),e.stopImmediatePropagation(),0!==e.button)return;const a=this,r=JSON.parse(JSON.stringify(a.keyFrames[t]));a.dbKeyClick?(a.draggable&&r.value&&Editor.Message.send("assets","twinkle",r.value),animation_editor_1.animationEditor.updateCurrentFrame(r.frame)):(a.dbKeyClick=!0,setTimeout(()=>{a.dbKeyClick=!1},300));const o={nodePath:a.param[0],prop:r.prop,frame:r.frame};let i=a.selectInfo||{},n=animation_editor_1.animationEditor.getPositionAtSelect(o);const s=utils_1.checkCtrlOrCommand(e);if(a.selectInfo&&s&&-1===n)i.params.push(o),i.data.push(r);else{if(-1!==n&&s){const e=[];return a.type?e.push(o):a.keyFrames.forEach(t=>{t.frame===r.frame&&e.push({nodePath:a.param[0],prop:t.prop||a.param[1],frame:t.frame})}),void animation_editor_1.animationEditor.removeSelectKey(e)}-1===n&&(i={startX:e.x,offset:0,offsetFrame:0,params:[o],data:[r]})}if(a.type){const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o.nodePath][o.prop].partKeys;e&&e.forEach(e=>{const t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o.nodePath][e];t&&t.keyFrames.find(e=>e.frame===o.frame)&&(i.params.push(Object.assign(Object.assign({},o),{prop:e})),i.data.push(Object.assign(Object.assign({},r),{prop:e})))})}else a.keyFrames.forEach(e=>{e.frame===r.frame&&e.prop!==r.prop&&(i.params.push({nodePath:a.param[0],prop:e.prop||a.param[1],frame:e.frame}),i.data.push(e))});i.sortDump&&-1!==n&&(i.startX=e.x,i.offset=0,i.offsetFrame=0),animation_editor_1.animationEditor.startDragKey(i,s),animation_editor_1.animationEditor.updateSelectProperty({nodePath:o.nodePath,prop:o.prop,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid})},onPreviewMouseDown(e){!this.lock&&e.button},onStickMouseDown(e){global_data_1.Flags.mouseDownName="stick",this.selectInfo.startX=e.x,this.selectInfo.offset=0,this.selectInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"}},onPopMenu(e){var t;const a=this;if(a.lock||2!==e.button||"grid"===global_data_1.Flags.mouseDownName&&(null===(t=global_data_1.Flags.startDragGridInfo)||void 0===t?void 0:t.start)!==e.x)return;global_data_1.Flags.mouseDownName="",e.stopPropagation();const r=e.target.getAttribute("name");if(!a.type&&!r)return;const o=e.target.getAttribute("index");let i={param:{nodePath:a.param[0],prop:a.param[1]||a.keyFrames[o].prop}};const n=[],s=[],p={};if("key"===r){const t=e.target.getAttribute("index"),{frame:r}=a.keyFrames[t];i.frame=r,i.data=a.keyFrames[t];let o=[r],m=!1;if(a.selectInfo&&Array.isArray(a.selectInfo.params)){for(const e of a.selectInfo.params)if(e.frame===r){m=!0;break}if(m){const e=[];o=a.selectInfo.params.map((t,a)=>(e.push({frame:t.frame,param:{nodePath:t.nodePath,prop:t.prop}}),t.frame)),o=Array.from(new Set(o)),i=e}}if(m&&o.length>1&&(s.push("spacingKeys"),n.push(a.t("spacing_key","property."))),a.type)s.push("copyKey"),n.push(a.t("copy_key","property.")),p.copyKey="CmdOrCtrl+C",m&&1!==o.length||a.canPaste()&&(s.push("pasteKey"),n.push(a.t("paste_key","property.")),p.pasteKey="CmdOrCtrl+V");else if(!m){const e=[];a.keyFrames.forEach(t=>{o.includes(t.frame)&&e.push({frame:t.frame,param:{nodePath:a.param[0],prop:t.prop}})}),i=e}s.push("removeKey"),n.push(a.t("remove_key","property.")),p.removeKey="Delete"}else{if("stick"===r)return void Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:[{label:Editor.I18n.t("animator.property.copy_key"),accelerator:"CmdOrCtrl+C",click(){animation_ctrl_1.animationCtrl.copyKey()}},{label:Editor.I18n.t("animator.property.remove_key"),accelerator:"Delete",click(){animation_ctrl_1.animationCtrl.removeKey()}},{label:Editor.I18n.t("animator.property.spacing_key"),async click(){animation_ctrl_1.animationCtrl.spacingKeys()}}]});s.push("createKey"),n.push(a.t("create_key","property.")),p.createKey="Enter",i.frame=grid_ctrl_1.gridCtrl.pageToFrame(e.x),a.canPaste()&&(s.push("pasteKey"),n.push(a.t("paste_key","property.")),p.pasteKey="CmdOrCtrl+V")}Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:a.createMenu(n,s,i,p)})},canPaste(){const e=this;if(!e.type||!animation_ctrl_1.animationCtrl.copyKeyInfo)return!1;const t=animation_ctrl_1.animationCtrl.copyKeyInfo;for(const a of t.curvesDump)if(a._parentType&&a._parentType.value===e.type.value||a.type.value===e.type.value)return!0;return!1},createMenu(e,t,a,r){const o=t.map((t,o)=>({label:e[o],accelerator:r[t],click(){"pasteKey"!==t?animation_ctrl_1.animationCtrl[t](a):animation_ctrl_1.animationCtrl.pasteKey({target:a.frame,nodePath:a.param.nodePath,propKey:a.param.prop||void 0})}}));return"number"==typeof a.frame&&a.frame>=0&&o.push({label:`frame: ${a.frame}`,enabled:!1}),o}},exports.mounted=mounted;