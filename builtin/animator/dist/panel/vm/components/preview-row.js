"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),global_data_1=require("../../share/global-data"),utils_1=require("../../utils"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-row.html"),"utf-8");let KeyFrames=[];function data(){return{keyData:[],refreshTask:null,refreshTaskNumber:0,dbKeyClick:!1,tips:"",selectKey:null}}async function mounted(){await this.refresh(),this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}exports.props=["keyFrames","selectInfo","param","type","index","listIndex","scroll","box","lock","offset","updateFrame","updatePosition","updateSelect","hidden","stickInfo"],exports.data=data,exports.watch={async updateFrame(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},updatePosition(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},box(){const e=this;if(!(e.display&&e.box&&e.keyData&&e.param))return;const{origin:t,w:a,h:r,type:i}=e.box;if("property"===i&&!e.type)return;if("node"===i&&e.type)return;const o=e.param[0],n=e.param[1];if(e.offsetHeight+animation_editor_1.animationEditor.LINE_HEIGHT/2<t.y||e.offsetHeight+animation_editor_1.animationEditor.LINE_HEIGHT/2>t.y+r)if(n)animation_editor_1.animationEditor.updateSelectKey({prop:n,nodePath:o,data:null,params:null});else{const t=[];for(const a of e.keyData)t.includes(a.prop)||(animation_editor_1.animationEditor.updateSelectKey({prop:a.prop,nodePath:o,data:null,params:null}),t.push(a.prop))}else if(n){let r=[];const i=[];for(const n of e.keyData)n.x+10+e.offset>t.x&&n.x+e.offset<t.x+a&&(r.push(n),i.push({nodePath:o,prop:n.prop,frame:n.frame}));if(0===r.length)return;r=JSON.parse(JSON.stringify(r)),animation_editor_1.animationEditor.updateSelectKey({data:r,params:i,nodePath:o,prop:n})}else{const r={};for(const i of e.keyData)r[i.prop]||(r[i.prop]={nodePath:o,data:[],params:[]}),i.x+10+e.offset>t.x&&i.x+e.offset<t.x+a&&(r[i.prop].data.push(i),r[i.prop].params.push({nodePath:o,prop:i.prop,frame:i.frame}));Object.keys(r).forEach(e=>{0!==r[e].data.length&&animation_editor_1.animationEditor.updateSelectKey({data:r[e].data,params:r[e].params,nodePath:o,prop:e})})}},selectInfo(e,t){this.$set(this,"selectKey",this.calcSelectKey(e))},updateSelect(){this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}},exports.computed={display(){return!this.scroll||(this.offsetHeight>=-animation_editor_1.animationEditor.LINE_HEIGHT&&this.offsetHeight<this.scroll.height+animation_editor_1.animationEditor.LINE_HEIGHT||void 0)},previewStyle(){return{transform:`translateY(${this.offsetHeight}px)`}},stickStyle(){if(!this.stickInfo)return;const{left:e,width:t}=this.stickInfo;return`left: ${e-this.offset}px; width: ${t}px;`},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},offsetHeight(){return this.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top},draggable(){return"key"!==this.keyType},keyType(){return this.type&&animation_editor_1.animationEditor.imageCCTypes.includes(this.type.value)?"image":"key"}},exports.components={},exports.methods={t:(e,t="preview_row.")=>Editor.I18n.t(`animator.${t}${e}`),calcSelectKey(e){const t=this;if(!e||!e.params||!animation_ctrl_1.animationCtrl.clipsDump)return null;const a=[];return(e=JSON.parse(JSON.stringify(e))).data.forEach((r,i)=>{const o=e.params[i];if(o.nodePath===t.param[0]){if(t.param[1]){const e=t.param[1],i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][o.prop].partKeys;if(Array.isArray(i)&&i.includes(e)){const i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][e].keyFrames.find(e=>o.frame===e.frame);return void(i&&a.push({frame:i.frame,x:r.x,prop:i.prop}))}const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][o.prop].parentPropKey;if("string"==typeof n&&n===e)return void a.push(r);if(e!==o.prop)return null}a.push(r)}}),a},async refresh(e){const t=this;if(t.refreshTaskNumber=0,!t.keyFrames||t.hidden)return void(t.keyData=null);if(t.keyFrames.length<1)return void(t.keyData=null);const a={maxNegative:{distance:-1/0,index:-1},minPositive:{index:-1,distance:1/0}};KeyFrames=JSON.parse(JSON.stringify(t.keyFrames)),t.type||"position"===e||KeyFrames.sort((e,t)=>e.x-t.x);const r=[];KeyFrames.forEach((e,i)=>{const o=t.getDistance(e.x);0!==o?o>0&&a.minPositive.distance>o?(a.minPositive.distance=o,a.minPositive.index=i):o<0&&a.maxNegative.distance<o&&(a.maxNegative.distance=o,a.maxNegative.index=i):r.push(e)}),r.length!==KeyFrames.length&&(-1!==a.maxNegative.index&&r.push(KeyFrames[a.maxNegative.index]),-1!==a.minPositive.index&&r.push(KeyFrames[a.minPositive.index])),r.sort((e,t)=>e.frame-t.frame),t.keyData=Object.freeze(r)},calcSelectClass(e){const t=["active"];return e&&this.type?t.push("image"):t.push("key"),t},getDistance(e){const t=this;return t.scroll?e+t.offset>t.scroll.size.w?e+t.offset-t.scroll.size.w:e+t.offset<0?e+t.offset:0:0},queryKeyStyle(e){return"image"===this.keyType?`transform: translateX(${0|e}px);`:`transform: translateX(${e-5|0}px);`},queryLineStyle(e,t){if(e&&t){const a=Math.min(e.x,t.x);return`transform: translateX(${0|a}px); width: ${Math.max(e.x,t.x)-a}px`}},openBezierEditor(e){e.path=this.param[0],animation_editor_1.animationEditor.openBezierEditor(e)},onDragLeave(e){this.tips="",this.draggable&&animation_editor_1.animationEditor.updateMouseFrame()},onDragOver(e){const t=this;if(!t.draggable)return;let a=[];const{additional:r,value:i}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};r&&r.forEach(e=>{e.type===t.type.value&&a.push(e.value)}),i&&!a.includes(i)&&a.push(i),a.length?(requestAnimationFrame(()=>{animation_editor_1.animationEditor.updateMouseFrame({x:e.x,y:e.y})}),t.tips=t.t("asset_position_tips"),e.preventDefault(),e.dataTransfer.dropEffect="copy"):t.tips=`${t.t("asset_type_should_be")} ${t.type.value}`},async onDrop(e){const t=this;t.tips="",animation_editor_1.animationEditor.updateMouseFrame();const a=[];let r=[];const{additional:i,value:o,type:n}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(i&&i.forEach(e=>{e.type===t.type.value&&(r.push(e.value),a.push(e))}),o&&!r.includes(o)&&(r.push(o),a.push({type:n,value:o})),!r.length)return;let s=grid_ctrl_1.gridCtrl.pageToFrame(e.x);const p=await animation_editor_1.animationEditor.getConfig("spacingFrame")||1;a.sort((e,t)=>e.name>t.name?1:-1);const m=[];for(const e of a)if(e.type===t.type.value){if(-1===e.value.indexOf("@")){const t=await Editor.Message.request("asset-db","query-asset-info",e.value);if(!t){console.warn(`Failed to create keyframe: Asset not found - ${e.value}`);continue}const a=Object.keys(t.subAssets);e.value=t.subAssets[a[0]].uuid}m.push({frame:s,value:{newValue:{uuid:e.value}},param:{nodePath:t.param[0],prop:t.param[1]}}),s+=p}animation_ctrl_1.animationCtrl.createKeyBatch(m)},async onMouseDown(e,t){if(e.stopPropagation(),0!==e.button)return;const a=this,r=JSON.parse(JSON.stringify(a.keyData[t]));a.dbKeyClick?(a.draggable&&r.dump.value&&Editor.Message.send("assets","twinkle",r.dump.value.uuid),animation_editor_1.animationEditor.updateCurrentFrame(r.frame)):(a.dbKeyClick=!0,setTimeout(()=>{a.dbKeyClick=!1},300));const i={nodePath:a.param[0],prop:r.prop,frame:r.frame};let o=a.selectInfo||{},n=animation_editor_1.animationEditor.getPositionAtSelect(i);const s=utils_1.checkCtrlOrCommand(e);if(a.selectInfo&&s&&-1===n)o.params.push(i),o.data.push(r);else{if(-1!==n&&s){const e=[];return a.type?e.push(i):a.keyFrames.forEach(t=>{t.frame===r.frame&&e.push({nodePath:a.param[0],prop:t.prop,frame:t.frame})}),void animation_editor_1.animationEditor.removeSelectKey(e)}-1===n&&(o={startX:e.x,offset:0,offsetFrame:0,params:[i],data:[r]})}a.type||a.keyFrames.forEach(e=>{e.frame===r.frame&&e.prop!==r.prop&&(o.params.push({nodePath:a.param[0],prop:e.prop,frame:e.frame}),o.data.push(e))}),o.sortDump&&-1!==n&&(o.startX=e.x,o.offset=0,o.offsetFrame=0),animation_editor_1.animationEditor.startDragKey(o,s),animation_editor_1.animationEditor.updateSelectProperty({nodePath:i.nodePath,prop:i.prop,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid})},onPreviewMouseDown(e){!this.lock&&e.button},onStickMouseDown(e){global_data_1.Flags.mouseDownName="stick",this.selectInfo.startX=e.x,this.selectInfo.offset=0,this.selectInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"}},onPopMenu(e){var t;const a=this;if(a.lock||2!==e.button||"grid"===global_data_1.Flags.mouseDownName&&(null===(t=global_data_1.Flags.startDragGridInfo)||void 0===t?void 0:t.start)!==e.x)return;global_data_1.Flags.mouseDownName="",e.stopPropagation();const r=e.target.getAttribute("name");if(!a.type&&!r)return;const i=e.target.getAttribute("index");let o={param:{nodePath:a.param[0],prop:a.param[1]||a.keyData[i].prop}};const n=[],s=[],p={};if("key"===r){const t=e.target.getAttribute("index"),{frame:r}=a.keyData[t];o.frame=r,o.data=a.keyData[t];let i=[r],m=!1;if(a.selectInfo&&Array.isArray(a.selectInfo.params)){for(const e of a.selectInfo.params)if(e.frame===r){m=!0;break}if(m){const e=[];i=a.selectInfo.params.map((t,a)=>(e.push({frame:t.frame,param:{nodePath:t.nodePath,prop:t.prop}}),t.frame)),i=Array.from(new Set(i)),o=e}}if(m&&i.length>1&&(s.push("spacingKeys"),n.push(a.t("spacing_key","property."))),a.type)s.push("copyKey"),n.push(a.t("copy_key","property.")),p.copyKey="CmdOrCtrl+C",m&&1!==i.length||(o.frame=grid_ctrl_1.gridCtrl.pageToFrame(e.x),a.canPaste()&&(s.push("pasteKey"),n.push(a.t("paste_key","property.")),p.pasteKey="CmdOrCtrl+V"));else if(!m){const e=[];a.keyData.forEach(t=>{i.includes(t.frame)&&e.push({frame:t.frame,param:{nodePath:a.param[0],prop:t.prop}})}),o=e}s.push("removeKey"),n.push(a.t("remove_key","property.")),p.removeKey="Delete"}else{if("stick"===r)return void Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:[{label:Editor.I18n.t("animator.property.copy_key"),accelerator:"CmdOrCtrl+C",click(){animation_ctrl_1.animationCtrl.copyKey()}},{label:Editor.I18n.t("animator.property.remove_key"),accelerator:"Delete",click(){animation_ctrl_1.animationCtrl.removeKey()}},{label:Editor.I18n.t("animator.property.spacing_key"),async click(){animation_ctrl_1.animationCtrl.spacingKeys()}}]});s.push("createKey"),n.push(a.t("create_key","property.")),p.createKey="Enter",o.frame=grid_ctrl_1.gridCtrl.pageToFrame(e.x),a.canPaste()&&(s.push("pasteKey"),n.push(a.t("paste_key","property.")),p.pasteKey="CmdOrCtrl+V")}Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:a.createMenu(n,s,o,p)})},canPaste(){const e=this;if(!e.type||!animation_ctrl_1.animationCtrl.copyKeyInfo)return!1;const t=animation_ctrl_1.animationCtrl.copyKeyInfo;for(const a of t.curvesDump)if(a._parentType&&a._parentType.value===e.type.value||a.type.value===e.type.value)return!0;return!1},createMenu(e,t,a,r){const i=t.map((t,i)=>({label:e[i],accelerator:r[t],click(){"pasteKey"!==t?animation_ctrl_1.animationCtrl[t](a):animation_ctrl_1.animationCtrl.pasteKey({target:a.frame,nodePath:a.param.nodePath,propKey:a.param.prop||void 0})}}));return"number"==typeof a.frame&&a.frame>=0&&i.push({label:`frame: ${a.frame}`,enabled:!1}),i}},exports.mounted=mounted;