"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),global_data_1=require("../../share/global-data"),utils_1=require("../../utils"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-row.html"),"utf-8");let KeyFrames=[];function data(){return{keyData:[],refreshTask:null,refreshTaskNumber:0,dbKeyClick:!1,tips:"",selectKey:null,combine:!1}}async function mounted(){this.formatKey=getFormatKeyFunc(this.keyType),await this.refresh(),this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}function getLineInfo(e,t){const a=Math.min(e,t);return{x:0|a,w:Math.max(e,t)-a}}function getFormatKeyFunc(e){return"image"===e?function(e,t){return{x:e.x,i:t,value:e.value}}:function(e,t){return{x:e.x,i:t}}}exports.props=["keyFrames","selectInfo","param","type","index","listIndex","scroll","lock","offset","updateFrame","updatePosition","updateSelect","hidden"],exports.data=data,exports.watch={async updateFrame(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},updatePosition(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},selectInfo(e,t){this.$set(this,"selectKey",this.calcSelectKey(e))},updateSelect(){this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}},exports.computed={display:()=>!0,previewStyle(){return{transform:`translateY(${this.offsetHeight}px)`,"pointer-events":`${"image"===this.keyType?"auto":"none"}`}},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},offsetHeight(){return this.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top},draggable(){return"key"!==this.keyType||this.type&&this.type.extends&&this.type.extends.includes("cc.Asset")},keyType(){return this.type&&animation_editor_1.animationEditor.imageCCTypes.includes(this.type.value)?"image":"key"}},exports.components={},exports.methods={t:(e,t="preview_row.")=>Editor.I18n.t(`animator.${t}${e}`),calcSelectKey(e){const t=this;if(!e||!e.keyFrames||!animation_ctrl_1.animationCtrl.clipsDump)return null;const a=[];return(e=JSON.parse(JSON.stringify(e))).keyFrames.forEach((r,o)=>{const i=e.keyFrames[o];if(i.nodePath===t.param[0]){if("key"!==t.keyType){const e=t.keyFrames.find(e=>e.frame===r.rawFrame);e&&(r.value=e.value)}if(t.param[1]){const e=t.param[1],o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][i.prop].partKeys;if(Array.isArray(o)&&o.includes(e)){const o=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][e].keyFrames.find(e=>i.frame===e.frame);return void(o&&o.prop===e&&a.push({frame:o.frame,rawFrame:o.frame,x:r.x,prop:o.prop,value:o.dump.value,nodePath:t.param[0]}))}const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][i.prop].parentPropKey;if("string"==typeof n&&n===e)return void a.push(r);if(e!==i.prop)return null;a.push(r)}else a.push(r)}}),Object.freeze(a)},async refresh(e){const t=this;if(t.refreshTaskNumber=0,!t.keyFrames||t.hidden)return void(t.keyData=null);if(t.keyFrames.length<1)return void(t.keyData=null);const a={};(KeyFrames=t.keyFrames).forEach((e,r)=>{a[e.frame]=t.formatKey(e,r)});const r=Object.values(a);r.sort((e,t)=>e.x-t.x);const o=[r[0]];for(let e=0;e<r.length-1;e++)r[(e=e)+1].x-o[o.length-1].x>5&&o.push(r[e+1]);var i;o.length!==r.length?t.combine=!0:t.combine=!1,t.keyData=Object.freeze(o.map(e=>e.i))},calcSelectClass(e){const t=["active"];return e&&this.type?t.push("image"):t.push("key"),t},queryKeyStyle(e){return"image"===this.keyType?`transform: translateX(${0|e}px);`:`transform: translateX(${e-4|0}px) rotate(45deg);`},onDragLeave(e){this.tips="",this.draggable&&animation_editor_1.animationEditor.updateMouseFrame()},onDragOver(e){const t=this;if(!t.draggable)return;const a=[],{additional:r,value:o}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};r?r.forEach(e=>{e.type===t.type.value&&a.push(e.value)}):o&&!a.includes(o)&&a.push(o),a.length?(requestAnimationFrame(()=>{animation_editor_1.animationEditor.updateMouseFrame({x:e.x,y:e.y})}),t.tips=t.t("asset_position_tips"),e.preventDefault(),e.dataTransfer.dropEffect="copy"):t.tips=`${t.t("asset_type_should_be")} ${t.type.value}`},async onDrop(e){const t=this;t.tips="",animation_editor_1.animationEditor.updateMouseFrame();const a=[],r=[],{additional:o,value:i,type:n}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(o&&o.forEach(e=>{e.type===t.type.value&&(r.push(e.value),a.push(e))}),i&&!r.includes(i)&&(r.push(i),a.push({type:n,value:i})),!r.length)return;let s=grid_ctrl_1.gridCtrl.pageToFrame(e.x);const p=await animation_editor_1.animationEditor.getConfig("spacingFrame")||1;a.sort((e,t)=>e.name>t.name?1:-1);const m=[];for(const e of a)if(e.type===t.type.value){if(-1===e.value.indexOf("@")){const t=await Editor.Message.request("asset-db","query-asset-info",e.value);if(!t){console.warn(`Failed to create keyframe: Asset not found - ${e.value}`);continue}const a=Object.keys(t.subAssets);e.value=t.subAssets[a[0]].uuid}m.push({frame:s,value:{newValue:{uuid:e.value}},nodePath:t.param[0],prop:t.param[1]}),s+=p}animation_ctrl_1.animationCtrl.createKeyBatch(m)},onRowMouseDown(e){const t=this;t.selectInfo&&animation_editor_1.animationEditor.stickInfo&&2!==e.button&&animation_editor_1.animationEditor.stickInfo.left<e.offsetX&&animation_editor_1.animationEditor.stickInfo.width+animation_editor_1.animationEditor.stickInfo.left>e.offsetX&&(global_data_1.Flags.mouseDownName="stick",t.selectInfo.startX=e.x,t.selectInfo.offset=0,t.selectInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"},e.stopPropagation())},async onMouseDown(e,t){if(e.stopPropagation(),e.stopImmediatePropagation(),0!==e.button)return;const a=this,r=JSON.parse(JSON.stringify(a.keyFrames[t]));a.dbKeyClick?(a.draggable&&r.value&&Editor.Message.send("assets","twinkle",r.value),animation_editor_1.animationEditor.updateCurrentFrame(r.frame)):(a.dbKeyClick=!0,setTimeout(()=>{a.dbKeyClick=!1},300));const o={nodePath:a.param[0],prop:r.prop,frame:r.frame};let i=a.selectInfo||{};const n=animation_editor_1.animationEditor.getPositionAtSelect(o),s=utils_1.checkCtrlOrCommand(e);if(a.selectInfo&&s&&-1===n)i.keyFrames.push(Object.assign(Object.assign(Object.assign({},o),r),{rawFrame:r.frame}));else{if(-1!==n&&s){const e=[];return a.type?e.push(o):a.keyFrames.forEach(t=>{t.frame===r.frame&&e.push({nodePath:a.param[0],prop:t.prop||a.param[1],frame:t.frame})}),void animation_editor_1.animationEditor.removeSelectKey(e)}-1===n&&(i={startX:e.x,offset:0,offsetFrame:0,nodePath:o.nodePath,prop:o.prop,keyFrames:[Object.assign(Object.assign(Object.assign({},o),r),{rawFrame:r.frame})]})}if(a.type){const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o.nodePath][o.prop].partKeys;e&&e.forEach(e=>{const t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[o.nodePath][e];t&&t.keyFrames.find(e=>e.frame===o.frame)&&i.keyFrames.push({nodePath:a.param[0],prop:r.prop||a.param[1],frame:r.frame,rawFrame:r.frame,x:r.x})})}else a.keyFrames.forEach(e=>{e.frame===r.frame&&e.prop!==r.prop&&i.keyFrames.push({nodePath:a.param[0],prop:e.prop||a.param[1],frame:e.frame,rawFrame:e.frame,x:e.x})});i.startX=e.x,i.sortDump&&-1!==n&&(i.offset=0,i.offsetFrame=0),i.location=a.param[1]?"prop":"node",animation_editor_1.animationEditor.startDragKey(i,s)},onPopMenu(e){var t;const a=this;if(a.lock||2!==e.button||"grid"===global_data_1.Flags.mouseDownName&&(null===(t=global_data_1.Flags.startDragGridInfo)||void 0===t?void 0:t.start)!==e.x)return;global_data_1.Flags.mouseDownName="",e.stopPropagation();const r=e.target,o=r.getAttribute("name");if(!a.type&&"key"!==o)return;const i=r.getAttribute("index");let n;const s={nodePath:a.param[0],prop:a.param[1]},p=[];let m=!1,l=[];const c=i?a.keyFrames[i].frame:grid_ctrl_1.gridCtrl.pageToFrame(e.x);if(i){n={frame:a.keyFrames[i].frame,prop:a.param[1]||a.keyFrames[i].prop,nodePath:a.param[0]},s.prop=n.prop;const{frame:e}=a.keyFrames[i];if(l=[e],a.selectInfo&&Array.isArray(a.selectInfo.keyFrames)){for(const t of a.selectInfo.keyFrames)if(t.frame===e){m=!0;break}m&&(l=a.selectInfo.keyFrames.map(e=>e.frame))}!a.type&&m&&l.length>1&&p.push({label:a.t("spacing_key","property."),click(){animation_ctrl_1.animationCtrl.spacingKeys(animation_editor_1.animationEditor.spacingFrame)}})}else a.param[1]&&p.push({label:Editor.I18n.t("animator.property.create_key"),accelerator:"Enter",click(){animation_ctrl_1.animationCtrl.createKey({frame:c,nodePath:a.param[0],prop:a.param[1]})}});if(a.type&&animation_editor_1.animationEditor.checkPropTypeInCopyKeyInfo(a.type)&&p.push({label:a.t("paste_key","property."),accelerator:"CmdOrCtrl+V",click(){animation_ctrl_1.animationCtrl.pasteKey({target:c,prop:s.prop,nodePath:s.nodePath})}}),l.length){const e=[];a.type?p.push({label:a.t("copy_key","property."),accelerator:"CmdOrCtrl+C",click(){animation_ctrl_1.animationCtrl.copyKey(m?void 0:Object.assign(s,{frame:l[0]}))}}):a.keyFrames.forEach(t=>{l.includes(t.frame)&&e.push({prop:t.prop,nodePath:n.nodePath,frame:t.frame})});const t=e.length?e:s;p.push({label:a.t("remove_key","property."),accelerator:"Delete",click(){animation_ctrl_1.animationCtrl.removeKey(m?void 0:Object.assign(t,{frame:l[0]}))}})}p.push({label:`frame: ${c}`,enabled:!1}),Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:p})}},exports.mounted=mounted;