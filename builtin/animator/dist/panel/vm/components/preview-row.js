"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),grid_ctrl_1=require("../../share/grid-ctrl"),global_data_1=require("../../share/global-data"),utils_1=require("../../utils"),pop_menu_1=require("../../share/pop-menu"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-row.html"),"utf-8");let KeyFrames=[];function data(){return{keyData:[],refreshTask:null,refreshTaskNumber:0,dbKeyClick:!1,tips:"",selectKey:null,combine:!1}}async function mounted(){this.formatKey=getFormatKeyFunc(this.keyType),await this.refresh(),this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}function getLineInfo(e,t){const a=Math.min(e,t);return{x:0|a,w:Math.max(e,t)-a}}function getFormatKeyFunc(e){return"image"===e?function(e,t){return{x:e.x,i:t,value:e.value}}:function(e,t){return{x:e.x,i:t}}}exports.props=["keyFrames","selectInfo","param","type","index","listIndex","scroll","lock","offset","updateFrame","updatePosition","updateSelect","hidden"],exports.data=data,exports.watch={async updateFrame(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},updatePosition(){const e=this;e.refreshTaskNumber++,e.display&&(cancelAnimationFrame(e.refreshTask),e.refreshTask=requestAnimationFrame(async()=>{await e.refresh()}))},selectInfo(e,t){this.$set(this,"selectKey",this.calcSelectKey(e))},updateSelect(){this.$set(this,"selectKey",this.calcSelectKey(this.selectInfo))}},exports.computed={display:()=>!0,previewStyle(){return{transform:`translateY(${this.offsetHeight}px)`,"pointer-events":`${"image"===this.keyType?"auto":"none"}`}},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},offsetHeight(){return this.listIndex*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top},draggable(){return"key"!==this.keyType||this.type&&this.type.extends&&this.type.extends.includes("cc.Asset")},keyType(){return this.type&&animation_editor_1.animationEditor.imageCCTypes.includes(this.type.value)?"image":"key"}},exports.components={},exports.methods={t:(e,t="preview_row.")=>Editor.I18n.t(`animator.${t}${e}`),calcSelectKey(e){const t=this;if(!e||!e.keyFrames||!animation_ctrl_1.animationCtrl.clipsDump)return null;const a=[];return(e=JSON.parse(JSON.stringify(e))).keyFrames.forEach((r,n)=>{const o=e.keyFrames[n];if(o.nodePath===t.param[0]&&!a.some(e=>e.key===r.key)){if("key"!==t.keyType){const e=t.keyFrames.find(e=>e.frame===r.rawFrame);e&&(r.value=e.value)}if(t.param[1]){const e=t.param[1],n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][o.prop].partKeys;if(Array.isArray(n)&&n.includes(e)){const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][e].keyFrames.find(e=>o.frame===e.frame);if(n&&n.prop===e){if(a.some(e=>e.key===n.key))return;a.push({frame:n.frame,rawFrame:n.frame,prop:n.prop,value:n.dump.value,key:n.key,x:r.x,nodePath:t.param[0]})}return}const i=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.param[0]][o.prop].parentPropKey;if("string"==typeof i&&i===e)return void a.push(r);if(e!==o.prop)return null;a.push(r)}else a.push(r)}}),Object.freeze(a)},async refresh(e){const t=this;if(t.refreshTaskNumber=0,!t.keyFrames||t.hidden)return void(t.keyData=null);if(t.keyFrames.length<1)return void(t.keyData=null);const a={};(KeyFrames=t.keyFrames).forEach((e,r)=>{a[e.frame]=t.formatKey(e,r)});const r=Object.values(a);r.sort((e,t)=>e.x-t.x);const n=[r[0]];for(let e=0;e<r.length-1;e++)r[(e=e)+1].x-n[n.length-1].x>5&&n.push(r[e+1]);var o;n.length!==r.length?t.combine=!0:t.combine=!1,t.keyData=Object.freeze(n.map(e=>e.i))},calcSelectClass(e){const t=["active"];return e&&this.type?t.push("image"):t.push("key"),t},queryKeyStyle(e){return"image"===this.keyType?`transform: translateX(${0|e}px);`:`transform: translateX(${e-4|0}px) rotate(45deg);`},onDragLeave(e){this.tips="",this.draggable&&animation_editor_1.animationEditor.updateMouseFrame()},onDragOver(e){const t=this;if(!t.draggable)return;const a=[],{additional:r,value:n}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};r?r.forEach(e=>{e.type===t.type.value&&a.push(e.value)}):n&&!a.includes(n)&&a.push(n),a.length?(requestAnimationFrame(()=>{animation_editor_1.animationEditor.updateMouseFrame({x:e.x,y:e.y})}),t.tips=t.t("asset_position_tips"),e.preventDefault(),e.dataTransfer.dropEffect="copy"):t.tips=`${t.t("asset_type_should_be")} ${t.type.value}`},async onDrop(e){const t=this;t.tips="",animation_editor_1.animationEditor.updateMouseFrame();const a=[],r=[],{additional:n,value:o,type:i}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(n&&n.forEach(e=>{e.type===t.type.value&&(r.push(e.value),a.push(e))}),o&&!r.includes(o)&&(r.push(o),a.push({type:i,value:o})),!r.length)return;let s=grid_ctrl_1.gridCtrl.pageToFrame(e.x);const p=await animation_editor_1.animationEditor.getConfig("spacingFrame")||1;a.sort((e,t)=>e.name>t.name?1:-1);const m=[];for(const e of a)if(e.type===t.type.value){if(-1===e.value.indexOf("@")){const t=await Editor.Message.request("asset-db","query-asset-info",e.value);if(!t){console.warn(`Failed to create keyframe: Asset not found - ${e.value}`);continue}const a=Object.keys(t.subAssets);e.value=t.subAssets[a[0]].uuid}m.push({frame:s,value:{newValue:{uuid:e.value}},nodePath:t.param[0],prop:t.param[1]}),s+=p}animation_ctrl_1.animationCtrl.createKeyBatch(m)},onRowMouseDown(e){const t=this;t.selectInfo&&animation_editor_1.animationEditor.stickInfo&&2!==e.button&&animation_editor_1.animationEditor.stickInfo.left<e.offsetX&&animation_editor_1.animationEditor.stickInfo.width+animation_editor_1.animationEditor.stickInfo.left>e.offsetX&&(global_data_1.Flags.mouseDownName="stick",t.selectInfo.startX=e.x,t.selectInfo.offset=0,t.selectInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"},e.stopPropagation())},async onMouseDown(e,t){if(e.stopPropagation(),e.stopImmediatePropagation(),0!==e.button)return;const a=this,r=JSON.parse(JSON.stringify(a.keyFrames[t]));a.dbKeyClick?(a.draggable&&r.value&&Editor.Message.send("assets","twinkle",r.value),animation_editor_1.animationEditor.updateCurrentFrame(r.frame)):(a.dbKeyClick=!0,setTimeout(()=>{a.dbKeyClick=!1},300));const n={nodePath:a.param[0],prop:r.prop,frame:r.frame};let o=a.selectInfo||{};const i=animation_editor_1.animationEditor.getPositionAtSelect(n),s=(0,utils_1.checkCtrlOrCommand)(e);if(a.selectInfo&&s&&-1===i)o.keyFrames.push(Object.assign(Object.assign(Object.assign({},n),r),{rawFrame:r.frame,key:(0,utils_1.calcKeyFrameKey)(r)}));else{if(-1!==i&&s){const e=[];return a.type?e.push(n):a.keyFrames.forEach(t=>{t.frame===r.frame&&e.push({nodePath:a.param[0],prop:t.prop||a.param[1],frame:t.frame})}),void animation_editor_1.animationEditor.removeSelectKey(e)}-1===i&&(o={startX:e.x,offset:0,offsetFrame:0,nodePath:n.nodePath,prop:n.prop,keyFrames:[Object.assign(Object.assign(Object.assign({},n),r),{rawFrame:r.frame,key:(0,utils_1.calcKeyFrameKey)(r)})]})}if(a.type){const e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[n.nodePath][n.prop].partKeys;e&&e.forEach(e=>{const t=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[n.nodePath][e];t&&t.keyFrames.find(e=>e.frame===n.frame&&e.prop===r.prop)&&o.keyFrames.push({nodePath:a.param[0],prop:e,frame:r.frame,rawFrame:r.frame,x:r.x,key:(0,utils_1.calcKeyFrameKey)(r)})})}else a.keyFrames.forEach(e=>{e.frame===r.frame&&e.prop!==r.prop&&o.keyFrames.push({nodePath:a.param[0],prop:e.prop||a.param[1],frame:e.frame,rawFrame:e.frame,x:e.x,key:(0,utils_1.calcKeyFrameKey)(e)})});o.startX=e.x,o.sortDump&&-1!==i&&(o.offset=0,o.offsetFrame=0),o.location=a.param[1]?"prop":"node",animation_editor_1.animationEditor.startDragKey(o,s)},onPopMenu(e){var t;if(this.lock||2!==e.button||"grid"===global_data_1.Flags.mouseDownName&&(null===(t=global_data_1.Flags.startDragGridInfo)||void 0===t?void 0:t.start)!==e.x)return;e.preventDefault(),global_data_1.Flags.mouseDownName="",global_data_1.Flags.startDragGridInfo=null,e.stopPropagation();const a=e.target,r=a.getAttribute("name");if(!this.type&&"key"!==r)return;const n=Number(a.getAttribute("index")),o=n?this.keyFrames[n].frame:grid_ctrl_1.gridCtrl.pageToFrame(e.x),i="number"==typeof n&&"key"===r?this.getKeyMenu(n):this.getPropContextMenu(o);i.push({label:`frame: ${o}`,enabled:!1}),Editor.Menu.popup({x:e.pageX,y:e.pageY+10,menu:i})},getKeyMenu(e){const t=this;let a=!1;const r=(0,pop_menu_1.getPopMenuMap)(t.type?pop_menu_1.onPropKeyMenus:pop_menu_1.onNodeKeyMenus,!1),n={frame:t.keyFrames[e].frame,prop:t.param[1]||t.keyFrames[e].prop,nodePath:t.param[0]},o={nodePath:t.param[0],prop:n.prop},{frame:i}=t.keyFrames[e];let s=[i];if(t.selectInfo&&Array.isArray(t.selectInfo.keyFrames)){for(const e of t.selectInfo.keyFrames)if(e.frame===i){a=!0;break}a&&(s=t.selectInfo.keyFrames.map(e=>e.frame))}s=Array.from(new Set(s)),!t.type&&a&&s.length>1&&(r.spacingKeys.enabled=!0,r.spacingKeys.click=(()=>{animation_editor_1.animationEditor.spacingSelectedKeys(animation_editor_1.animationEditor.spacingFrame)}));const p=[];t.type?(r.copyKey.enabled=!0,r.copyKey.click=(()=>{animation_ctrl_1.animationCtrl.copyKey(a?void 0:Object.assign(o,{frame:s[0]}))}),animation_editor_1.animationEditor.checkPropTypeInCopyKeyInfo(t.type)?(r.pasteKey.enabled=!0,r.pasteKey.click=(()=>{animation_ctrl_1.animationCtrl.pasteKey({target:i,prop:o.prop,nodePath:o.nodePath})})):r.pasteKey.enabled=!1):t.keyFrames.forEach(e=>{s.includes(e.frame)&&p.push({prop:e.prop,nodePath:n.nodePath,frame:e.frame})});const m=p.length?p:o;return r.removeKey.enabled=!0,r.removeKey.click=(()=>{animation_ctrl_1.animationCtrl.removeKey(a?void 0:Object.assign(m,{frame:s[0]}))}),Object.values(r)},getPropContextMenu(e){const t=this,a={nodePath:t.param[0],prop:t.param[1]},r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onPropContextMenus,!1);return r.createKey=Object.assign(Object.assign({},pop_menu_1.popMenuMap.createKey),{enabled:!0,click(){animation_ctrl_1.animationCtrl.createKey({frame:e,nodePath:t.param[0],prop:t.param[1]})}}),animation_editor_1.animationEditor.checkPropTypeInCopyKeyInfo(t.type)&&(r.pasteKey.enabled=!0,r.pasteKey.click=(()=>{animation_ctrl_1.animationCtrl.pasteKey({target:e,prop:a.prop,nodePath:a.nodePath})})),Object.values(r)}},exports.mounted=mounted;