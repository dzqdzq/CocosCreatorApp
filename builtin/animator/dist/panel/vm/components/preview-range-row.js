"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const path_1=require("path"),animation_ctrl_1=require("../../share/animation-ctrl"),animation_editor_1=require("../../share/animation-editor"),global_data_1=require("../../share/global-data"),pop_menu_1=require("../../share/pop-menu"),utils_1=require("../../utils"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");function data(){return{refreshTask:null,refreshTaskNumber:0,tips:"",selectEmbeddedPlayerKeys:[],selectInfos:[]}}async function mounted(){await this.refresh()}function patchEmbeddedPlayer(e){const t=utils_1.EmbeddedPlayerMenuMap[e.playable.type],a=e.playable.path;return Object.assign(Object.assign({},e),{icon:t.icon,label:t.label,displayName:e.displayName,defaultDisplayName:a&&(0,path_1.basename)(a)||t.label})}exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/preview-range-row.html"),"utf-8"),exports.props=["trackInfo","selectPlayers","lock","index","offset","scroll","updatePosition"],exports.data=data,exports.watch={selectPlayers(e,t){this.$set(this,"selectEmbeddedPlayerKeys",this.calcSelectKey(e))},updatePosition(){this.$set(this,"selectEmbeddedPlayerKeys",this.calcSelectKey(this.selectInfo))}},exports.computed={previewStyle(){return{transform:`translateY(${this.index*animation_editor_1.animationEditor.LINE_HEIGHT-this.scroll.top}px)`,"pointer-events":"auto"}},previewClass(){let e="";return["content-item","preview-row",e=this.index%2==0?"dark":"light",this.lock?"lock":""]},draggable(){return this.type&&this.type.extends&&this.type.extends.includes("cc.Asset")},displayEmbeddedPlayerInfo(){const e=this;return e.trackInfo&&e.trackInfo.embeddedPlayers?e.trackInfo.embeddedPlayers.map(t=>{const a=e.selectInfos.find(e=>e.key===t.key);return patchEmbeddedPlayer(a||t)}):null}},exports.components={},exports.methods={t:(e,t="preview_row.")=>Editor.I18n.t(`animator.${t}${e}`),refresh(e){},queryKeyStyle:e=>`transform: translateX(${e.x||0}px); width: ${e.width||20}px;`,onRangeMouseDown(e,t){2!==e.button&&animation_editor_1.animationEditor.onStartDragSuregion(e,t)},onDragOver(e){const{value:t}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(!t||!e.dataTransfer)return;JSON.parse(t).playable.type!==this.trackInfo.type?e.dataTransfer.dropEffect="none":e.dataTransfer.dropEffect="move"},onDragStart(e,t){const a=e.target.getAttribute("name");if(["left","right"].includes(a))return;if(global_data_1.Flags.startDragEmbeddedPlayerInfo.type="drop",e.target.style.cursor="grabbing",!e.dataTransfer)return;const r=e.target.parentNode;e.dataTransfer.setDragImage(r,0,0),e.dataTransfer.setData("value",JSON.stringify(t)),e.dataTransfer.effectAllowed="move"},showRangePopMenu(e,t,a){const r=(0,pop_menu_1.getPopMenuMap)(pop_menu_1.onEmbeddedPlayerMenus);r.removeEmbeddedPlayer.click=(()=>{a?animation_editor_1.animationEditor.deleteSelecteEmbeddedPlayers():animation_ctrl_1.animationCtrl.deleteEmbeddedPlayer(animation_editor_1.animationEditor.transEmbeddedPlayerInfoToDump(t,!1))}),r.copyEmbeddedPlayer.click=(()=>{animation_ctrl_1.animationCtrl.copyEmbeddedPlayerDump=[animation_editor_1.animationEditor.transEmbeddedPlayerInfoToDump(t,!1)]}),Editor.Menu.popup({menu:Object.values(r)})},onDrop(e){animation_editor_1.animationEditor.onEmbeddedPlayerDrop(e,this.trackInfo.key)},async showContextMenu(e){global_data_1.Flags.mouseDownName="",await animation_editor_1.animationEditor.onEmbeddedPlayerContextMenu(e,this.trackInfo)},calcSelectKey(){const e=this;return e.selectPlayers&&e.selectPlayers.length?e.selectInfos=e.selectPlayers.filter(t=>t.group===e.trackInfo.key):e.selectInfos=[],e.selectInfos.map(e=>e.key)}},exports.mounted=mounted;