"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=exports.props=exports.template=void 0;const ipc_event_1=require("../../share/ipc-event"),utils_1=require("../../utils"),animation_editor_1=require("../../share/animation-editor"),bezier_presets_1=require("../../share/bezier-presets"),{join:join}=require("path"),{readFileSync:readFileSync}=require("fs-extra");function data(){return{presets:Object.assign(Object.assign({},bezier_presets_1.defaultBezier),{User:{}}),currentPreset:"Linear",currentBerzier:[],bezierData:"",ctrlPoints:{},size:500,offset:{x:100,y:100},bezierTransform:"",mouseDownInfo:null,applyName:"Default",movePosition:null,moveStyle:null,userPresetName:"",tips:"",tipsTimer:null}}async function mounted(){const e=this;e.keyframe&&e.keyframe.curve?"string"==typeof e.keyframe.curve?e.currentBerzier=JSON.parse(JSON.stringify(e.findBezierData(e.keyframe.curve))):(e.applyName="",e.bezierName="",e.currentBerzier=Array.from(e.keyframe.curve)):e.currentBerzier=Array.from(e.presets.Linear.Default.data),document.addEventListener("mouseup",e.onMouseUp),e.presets.User=await animation_editor_1.animationEditor.getConfig("userPresets")||{},e.init()}exports.template=readFileSync(join(__dirname,"./../../../../static/template/components/bezier-editor.html"),"utf-8"),exports.props=["keyframe","uuid"],exports.data=data,exports.watch={},exports.computed={},exports.components={},exports.methods={onBerzierConfirm(e){let t=e.target.value;const r=this;if(!t)return void(t=r.currentBerzier.toString());const s=t.split(",");if(s&&s.length>=4){const e=[];for(let i=0;i<4;i++){const n=Number(s[i]);if(!(!Number.isNaN(n)&&n<=1&&n>=0))return void(t=r.currentBerzier.toString());e.push(n)}r.currentBerzier=e,r.updateBezier(),r.saveData(),t=e.toString()}else t=r.currentBerzier.toString()},addUserPreset(){this.userPresetName&&(this.$set(this.presets.User,this.userPresetName,{data:Array.from(this.currentBerzier),name:this.userPresetName}),animation_editor_1.animationEditor.setConfig("userPresets",this.presets.User))},delUserPreset(e){this.$set(this.presets.User,e,null),animation_editor_1.animationEditor.setConfig("userPresets",this.presets.User)},onPresetChange(e){this.currentPreset=e.target.value},applyPreset(e){const t=this.presets[this.currentPreset][e].data;this.applyName=e,this.bezierName=this.presets[this.currentPreset][e].name,this.currentBerzier=Array.from(t),this.updateBezier(),this.saveData()},async saveData(){const e=this,{prop:t,frame:r,curve:s,path:i}=e.keyframe;if(s&&s.toString()===e.currentBerzier.toString())return!0;let n=null;n="User"===e.currentPreset?e.currentBerzier:e.applyName&&e.bezierName?e.bezierName:e.findRightBezier(e.currentBerzier),await ipc_event_1.IApplyOperation(ipc_event_1.ImodifyCurveOfKey(e.uuid,i,t,r,n)),this.showTips("i18n:animator.bezier.saving")},showTips(e){const t=this;clearTimeout(t.tipsTimer),t.tips=e,t.tipsTimer=setTimeout(()=>{t.tips=""},500)},exit(){animation_editor_1.animationEditor.closeBezierEditor()},onMouseDown(e,t){this.mouseDownInfo={index:t,startX:e.x,startY:e.y,offsetX:0,offsetY:0}},onMouseMove(e){const t=this;if(!t.mouseDownInfo)return;const{startX:r,startY:s,index:i}=t.mouseDownInfo,n=(e.x-r)/t.size,o=(s-e.y)/t.size;if(!n&&!o)return;if(t.mouseDownInfo.offsetX+=n,t.mouseDownInfo.offsetY+=o,t.mouseDownInfo.startX=e.x,t.mouseDownInfo.startY=e.y,2===i){const e=Number((t.currentBerzier[0]+n).toFixed(2)),r=Number((t.currentBerzier[1]+o).toFixed(2));t.movePosition=`${e},${r}`,t.currentBerzier.splice(0,2,e,r)}else if(3===i){const e=Number((t.currentBerzier[2]+n).toFixed(2)),r=Number((t.currentBerzier[3]+o).toFixed(2));t.movePosition=`${e},${r}`,t.currentBerzier.splice(2,2,e,r)}const{top:a,left:u}=t.$refs.bezier.getBoundingClientRect();t.moveStyle={left:`${e.x-u+10}px`,top:`${e.y-a+20}px`},requestAnimationFrame(()=>{t.applyName="",t.updateBezier()})},onMouseUp(){const e=this;e.mouseDownInfo&&(e.saveData(),e.mouseDownInfo=null,e.movePosition=null,e.moveStyle=null)},onMouseWheel(e){const t=utils_1.smoothScale(-e.deltaY,this.size);this.size=t,this.bezierTransform=`translate(${this.offset.x} ${this.offset.y}) scale(${this.size})`},calcBezier(e){if(!e||e.length<1)return"M0 0";const t=this.calcControl(e);return this.calcBezierData(t)},calcBezierData(e){const{p1:t,p2:r,p3:s,p4:i}=e;return`M${t[0]} ${t[1]} C ${r[0]} ${r[1]}, ${s[0]} ${s[1]}, ${i[0]} ${i[1]}`},calcControl:e=>({p1:[0,1],p2:[e[0],1-e[1]],p3:[e[2],1-e[3]],p4:[1,0]}),init(){const{clientHeight:e}=this.$refs.main;this.size=Math.min(Math.round(.6*e),400),this.updateBezier(),this.bezierTransform=`translate(${this.offset.x} ${this.offset.y}) scale(${this.size})`},updateBezier(){const e=this;if(0===e.currentBerzier.length)return e.ctrlPoints=null,void(e.bezierData="M0 0");e.ctrlPoints=e.calcControl(e.currentBerzier),e.bezierData=e.calcBezierData(e.ctrlPoints)},findRightBezier(e){const t=this;for(const r of Object.keys(t.presets))for(const s of Object.keys(t.presets[r])){const i=t.presets[r][s];if(i&&i.data&&(i.data.toString()===e.toString()&&i.name))return i.name}return e},findBezierData(e){const t=this;for(const r of Object.keys(t.presets))for(const s of Object.keys(t.presets[r])){const i=t.presets[r][s];if(i&&e===i.name)return t.currentPreset=r,t.applyName=s,t.bezierName=i.name,i.data}return t.presets.Linear.Default.data}},exports.mounted=mounted;