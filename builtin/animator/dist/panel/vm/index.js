"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.components=exports.methods=exports.watch=exports.computed=exports.data=void 0;const animation_ctrl_1=require("../share/animation-ctrl"),ipc_event_1=require("../share/ipc-event"),utils_1=require("./../utils"),grid_ctrl_1=require("../share/grid-ctrl"),global_data_1=require("../share/global-data"),animation_editor_1=require("../share/animation-editor"),maskComp=__importStar(require("./components/mask")),bezier_presets_1=require("../share/bezier-presets"),lodash=require("lodash"),changeFailedClips=[],data=function(){return{loading:"wait_scene_ready",offset:240,toast:{message:""},currentFrame:0,root:"",selectedId:"",selectedIds:new Set,selectPath:"",moveNodePath:"",selectProperty:null,nodeDump:null,eventsDump:null,currentClip:"",clipConfig:null,clipsMenu:[],selectKeyInfo:null,selectEventInfo:null,compIndex:0,animationMode:!1,animationState:"stop",editEventFrame:0,maskPanel:"",selectDataChange:0,nodesHeight:0,nodeScrollInfo:null,propertyScrollInfo:null,moveInfo:null,boxInfo:null,boxStyle:null,boxData:null,previewPointer:null,propertiesMenu:null,properties:null,updateKeyFrame:0,updatePosition:0,updateSelectKey:1,updateSelectNode:1,scrolling:!1,expandInfo:{},layout:{topPec:"30%",leftPec:"30%"},filterInvalid:!1,filterName:"",active:!0,wrapModeList:[],showAnimCurve:!1,lightCurve:null,hasSelectedCurveClip:!1,curveDisabledCCtypes:animation_editor_1.animationEditor.curveDisabledCCtypes,presetSize:110,expandTab:"",searchPresetName:""}};async function mounted(){const e=this;animation_ctrl_1.animationCtrl.init(e),animation_editor_1.animationEditor.init(e),e.wrapModeList=await Editor.Message.request("scene","query-enum-list-with-path","AnimationClip.WrapMode"),e.wrapModeList.forEach(e=>{e.tip=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.tip`)||e.name,e.name=Editor.I18n.t(`animator.animationCurve.WrapMode.${e.name}.label`)||e.name});const t=await animation_editor_1.animationEditor.getConfig("layout");t&&"object"==typeof t&&(t.topPec||(t.topPec=t.top/e.$refs.container.offsetHeight*100+"%",t.leftPec=t.left/e.$refs.container.offsetWidth*100+"%"),Object.assign(e.layout,t)),global_data_1.Flags.sceneReady=await Editor.Message.request("scene","query-is-ready"),global_data_1.Flags.sceneReady&&await animation_editor_1.animationEditor.debounceRefresh(),e.selectedIds=new Set(Editor.Selection.getSelected("node")),e.selectedId=Editor.Selection.getLastSelected("node")}exports.data=data,exports.computed={presetArr(){const e=this;return e.searchPresetName?bezier_presets_1.defaultBezier.filter(t=>new RegExp(e.searchPresetName,"i").test(t.name)):bezier_presets_1.defaultBezier},lock(){return Boolean(!this.clipConfig||this.clipConfig.isLock||this.maskPanel||!this.animationMode)},selectPropData(){if(!animation_ctrl_1.animationCtrl.clipsDump||!this.selectProperty)return null;const{prop:e,nodePath:t}=this.selectProperty;return animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t][e]},computeSelectPath(){const e=this;if(!e.updateSelectNode)return"";if(e.selectPath)return e.selectPath;let t="";return e.selectedId&&e.nodeDump&&(t=animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e.selectedId]),t},sample(){let e=60;return this.clipConfig&&(e=this.clipConfig.sample),animation_editor_1.animationEditor.updateSample(e),e},lastFrameInfo(){const e=this;let t=0;return e.clipConfig&&e.clipConfig.duration&&(t=utils_1.timeToFrame(e.clipConfig.duration,e.sample)),{frame:t,x:grid_ctrl_1.gridCtrl.frameToCanvas(t)}},propertyHeight(){const e=this;if(!e.properties)return 0;let t=0;return Object.keys(e.properties).forEach(o=>{e.properties[o].hidden||(t+=animation_editor_1.animationEditor.LINE_HEIGHT)}),t},stickInfo(){const e=this;if(!e.properties||!e.selectKeyInfo||!e.selectKeyInfo.keyFrames||e.selectKeyInfo.keyFrames.length<2||!e.updateSelectKey||!e.updatePosition||!e.propertyScrollInfo)return animation_editor_1.animationEditor.hasShowStick=!1,null;const t=[],o=[],i=[];return e.selectKeyInfo.keyFrames.forEach((r,a)=>{e.computeSelectPath&&e.selectKeyInfo.keyFrames[a]&&e.selectKeyInfo.keyFrames[a].nodePath!==e.computeSelectPath||(t.push(r.x||0),e.properties[r.prop]&&o.push(e.properties[r.prop].top),i.push(r.frame))}),i.sort((e,t)=>e-t),animation_editor_1.animationEditor.stickInfo.leftFrame=i[0],animation_editor_1.animationEditor.stickInfo.rightFrame=i[i.length-1],t.sort((e,t)=>e-t),o.sort((e,t)=>e-t),t[t.length-1]===t[0]?(animation_editor_1.animationEditor.hasShowStick=!1,null):(animation_editor_1.animationEditor.stickInfo.width=t[t.length-1]-t[0]+18,animation_editor_1.animationEditor.stickInfo.height=o[o.length-1]-o[0]+animation_editor_1.animationEditor.LINE_HEIGHT,animation_editor_1.animationEditor.stickInfo.left=t[0]+grid_ctrl_1.gridCtrl.grid.xAxisOffset-10,animation_editor_1.animationEditor.stickInfo.top=o[0]-e.propertyScrollInfo.top,animation_editor_1.animationEditor.hasShowStick=!0,JSON.parse(JSON.stringify(animation_editor_1.animationEditor.stickInfo)))},curveData(){var e;const t=this;if(!t.selectProperty||!t.showAnimCurve||!t.properties)return animation_editor_1.animationEditor.repaintCurve(),null;const o=null===(e=animation_ctrl_1.animationCtrl.clipsDump)||void 0===e?void 0:e.pathsDump[t.selectProperty.nodePath];if(!o)return null;const i=o[t.selectProperty.prop];if(!(i&&i.isCurveSupport&&i.type&&t.properties[t.selectProperty.prop]))return animation_editor_1.animationEditor.repaintCurve(),null;if(i.type&&animation_editor_1.animationEditor.curveDisabledCCtypes.includes(i.type.value))return animation_editor_1.animationEditor.repaintCurve(),null;const r={curveInfos:{},wrapMode:t.clipConfig.wrapMode,duration:t.clipConfig.duration*t.clipConfig.sample};let a=!1;if(i.partKeys)for(const e of i.partKeys){const i=o[e];r.curveInfos[e]={keys:i.keyFrames.map(e=>e.curve),preWrapMode:i.preExtrap,postWrapMode:i.postExtrap,color:t.properties[e].color},a=!(!a&&!r.curveInfos[e].keys.find(e=>e.easingMethod))}else r.curveInfos={[t.selectProperty.prop]:{keys:i.keyFrames.map(e=>e.curve),preWrapMode:i.preExtrap,postWrapMode:i.postExtrap,color:t.properties[t.selectProperty.prop].color}},a=!(!a&&!r.curveInfos[t.selectProperty.prop].keys.find(e=>e.easingMethod));return animation_editor_1.animationEditor.checkCurveDataDirty(r)&&animation_editor_1.animationEditor.repaintCurve(r),Object.assign(Object.assign({},r),{hasUserEasingMethod:a})},curveStyle(){return this.showAnimCurve&&this.computeSelectPath?{width:"100%",height:"100%"}:{display:"none"}},stickBoxStyle(){return this.stickInfo?{width:this.stickInfo.width+"px",height:this.stickInfo.height+"px",top:this.stickInfo.top+"px",left:this.stickInfo.left+"px"}:null}},exports.watch={async selectedId(e,t){const o=this,i=o.computeSelectPath;if(o.selectKeyInfo){o.selectKeyInfo.keyFrames.find(e=>e.nodePath!==i)&&(o.selectKeyInfo=null)}if(!e&&animation_ctrl_1.animationCtrl.nodesDump){if(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[t]!==i&&i)return}if(o.updateSelectNode=-o.updateSelectNode,await animation_editor_1.animationEditor.updateSelectedId(),o.properties&&(o.selectProperty&&o.selectProperty.nodePath!==i||!o.selectProperty)){const e=Object.keys(o.properties)[0];animation_editor_1.animationEditor.updateSelectProperty({nodePath:i,prop:e,missing:o.properties[e].missing,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid,isCurveSupport:o.properties[e].isCurveSupport})}else o.selectProperty=null},selectKeyInfo(){this.showAnimCurve?animation_editor_1.animationEditor.selectKeyUpdateFlag&&animation_editor_1.animationEditor.updateCurveSelecteKeys():animation_editor_1.animationEditor.selectKeyUpdateFlag=!0},root(){this.filterInvalid=!1,this.filterName="",this.nodesHeight=0},async currentClip(e,t){const o=this;if(e===t||!e)return;if(!await ipc_event_1.IsetEditClip(e))return changeFailedClips.push(e),console.warn(`Set edit clip failed!${e}`),void(changeFailedClips.includes(t)?o.currentClip="":o.currentClip=t);o.selectEventInfo=null,o.selectKeyInfo=null;const i=await ipc_event_1.IqueryPlayingClipTime(o.currentClip),r=utils_1.timeToFrame(i,o.sample);animation_editor_1.animationEditor.setCurrentFrame(r)},layout:{deep:!0,handler(){process.nextTick(()=>{animation_editor_1.animationEditor.resize()})}},currentFrame(){this.calcSelectProperty(null,!0)},boxData(){const e=this;if(!e.boxData)return;const{origin:t,h:o,w:i,type:r}=e.boxData;if("property"===r&&!e.properties)return;const a=[],n="node"===r?e.nodeScrollInfo.top:e.propertyScrollInfo.top;function s(r,s){Object.values(r).forEach(r=>{const l=r.top+animation_editor_1.animationEditor.LINE_HEIGHT/2+animation_editor_1.animationEditor.KEY_SIZE_R-n;!s&&(l<t.y||l>t.y+o)||r.keyFrames.forEach(o=>{const n=o.x+e.offset;n>t.x&&n<t.x+i&&a.push({frame:o.frame,rawFrame:o.frame,nodePath:r.nodePath,x:o.x,prop:r.prop})})})}"node"===r?Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump).forEach(i=>{const r=e.nodeDump.find(e=>e.path===i);if(!r)return;const a=r.top+animation_editor_1.animationEditor.LINE_HEIGHT/2+animation_editor_1.animationEditor.KEY_SIZE_R-n;a<t.y||a>t.y+o||s(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i],!0)}):s(e.properties),a.sort((e,t)=>e.frame-t.frame),e.selectKeyInfo={nodePath:e.computeSelectPath,keyFrames:a}}},exports.methods={onClipCurvePreset(e){this.$refs.curve.curveCtrl.applyBezierToSelectedCurveClip(e)},showAllKeys(){const e=this.curveData,t=[0,this.clipConfig.duration*this.clipConfig.sample+10],o=[];Object.values(e.curveInfos).forEach(e=>{if(!e.keys.length)return;e.keys.sort((e,t)=>e.point.y-t.point.y);const t=e.keys[0].point.y-20,i=e.keys[e.keys.length-1].point.y+20;o[0]?o[0]=Math.min(o[0],t):o[0]=t,o[1]?o[1]=Math.max(o[1],i):o[1]=i}),this.$refs.curve.curveCtrl.setDisplayRange(t,o)},onUpdateEvent(e,t,o){0!==o.length?ipc_event_1.IApplyOperation(ipc_event_1.IupdateEvent(e,t,o)):animation_ctrl_1.animationCtrl.deleteEvent()},toggleInvalidNode(){this.filterInvalid=!this.filterInvalid,this.$refs.nodes.scrollTop=this.nodeScrollInfo.top=0,animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips()},onFilter(e){e.stopPropagation(),e.preventDefault(),this.filterName!==e.target.value&&animation_editor_1.animationEditor.debounceFilterNode(e.target.value)},async calcSelectProperty(e,t=!1){const o=this;if(t&&o.selectProperty&&(e=o.selectProperty),!e)return;const i=await ipc_event_1.IgetPropValueAtFrame(o.currentClip,e.nodePath,e.prop,o.currentFrame);o.selectProperty=Object.assign(e,{dump:i})},queryDurationStyle(e){if(!e||!grid_ctrl_1.gridCtrl.grid)return"";let t=grid_ctrl_1.gridCtrl.grid.valueToPixelH(0);t<0&&(t=0);let o=grid_ctrl_1.gridCtrl.grid.valueToPixelH(e)-t;return o<0&&(t=o,o=0),`transform: translateX(${t}px); width: ${o}px`},pointerPosition(e=0){return grid_ctrl_1.gridCtrl.frameToCanvas(this.currentFrame)+(e||grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset||0)-grid_ctrl_1.gridCtrl.startOffset},onMouseWheel(e){e.shiftKey?animation_editor_1.animationEditor.moveTimeLine("darwin"===process.platform?e.deltaX:e.deltaY):Math.abs(e.deltaX)>Math.abs(e.deltaY)?animation_editor_1.animationEditor.moveTimeLine(e.deltaY):animation_editor_1.animationEditor.scaleTimeLine(-e.deltaY,Math.round(e.offsetX))},onMouseDown(e){const t=this;t.moveNodePath="",t.boxInfo=null,t.boxStyle=null;const o=e.target.getAttribute("name");"event"!==o&&(t.selectEventInfo=null),"key"!==o&&"stick"!==o&&(t.selectKeyInfo=null);let i=null;function r(){e.offsetY>t.$refs["property-content"].offsetTop?global_data_1.Flags.mouseDownName="property":e.offsetY>t.$refs["node-content"].offsetTop&&e.offsetY<t.$refs["property-content"].offsetTop&&(global_data_1.Flags.mouseDownName="node")}switch(o){case"time-pointer":global_data_1.Flags.mouseDownName="time-pointer";break;case"pointer":0===e.button&&(global_data_1.Flags.mouseDownName="pointer");break;case"stick":global_data_1.Flags.mouseDownName="stick",t.selectKeyInfo.startX=e.x,t.selectKeyInfo.offset=0,t.selectKeyInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"};break;default:if(1===e.button||2===e.button){if(global_data_1.Flags.startDragGridInfo={start:e.x,lastStart:e.x},2===e.button&&(r(),global_data_1.Flags.mouseDownName))break;return void(global_data_1.Flags.mouseDownName="grid")}if(!o)break;global_data_1.Flags.mouseDownName=o}if(i||global_data_1.Flags.mouseDownName||(r(),global_data_1.Flags.mouseDownName&&(i={type:global_data_1.Flags.mouseDownName})),["node","property"].includes(global_data_1.Flags.mouseDownName)&&i){const o=grid_ctrl_1.gridCtrl.pageToCtrl(e.x,e.y);i.startX=o.x,i.startY=o.y,t.boxInfo=i}},onScroll(e,t){const o=this;if(global_data_1.Flags.onScrolling)return;const i="node"===t?o.nodeScrollInfo:o.propertyScrollInfo,r=e.target.scrollTop;r!==i.top&&(global_data_1.Flags.lastScrollTops.splice(0,0,r),global_data_1.Flags.lastScrollTops.length=3,global_data_1.Flags.lastScrollTops[0]!==global_data_1.Flags.lastScrollTops[2]&&(o.scrolling||(global_data_1.Flags.onScrolling=!0,o.scrolling=!0,requestAnimationFrame(()=>{var e;i.top=r,(null===(e=animation_ctrl_1.animationCtrl.nodesDump)||void 0===e?void 0:e.nodesDump)||animation_editor_1.animationEditor.calcNodes(),animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips(),o.updateKeyFrame++,o.scrolling=!1,global_data_1.Flags.onScrolling=!1}))))},async onConfirm(e){const t=e.target.getAttribute("name"),o=e.target.value;"sample"===t&&animation_editor_1.animationEditor.updateSample(o),await animation_ctrl_1.animationCtrl.updateConfig(t,o)},onStartResize(e,t){animation_editor_1.animationEditor.onStartResize(e,t)},toggleAniCurve(){this.showAnimCurve=!this.showAnimCurve,animation_editor_1.animationEditor.initCurve()},async onEditEasingMethodCurve(e){const t=this;if(t.showAnimCurve&&t.curveData&&t.curveData.hasUserEasingMethod){if(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),0===(await Editor.Dialog.warn(Editor.I18n.t("animator.tips.abort_easing_method"),{buttons:[Editor.I18n.t("animator.cancel"),Editor.I18n.t("animator.abort")],default:0,cancel:0})).response)return;const o=[],{nodePath:i}=t.selectProperty;for(const e of Object.keys(t.curveData.curveInfos)){t.curveData.curveInfos[e].keys.forEach(r=>{r.easingMethod&&o.push(ipc_event_1.ImodifyCurveOfKey(t.currentClip,i,e,Math.round(r.point.x),{easingMethod:0}))})}ipc_event_1.IApplyOperation(o)}},onPropConfirm(e){this.selectProperty&&ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(this.currentClip,this.computeSelectPath,this.selectProperty.prop,this.currentFrame,{newValue:e.target.dump.value}))}},exports.components={"control-preview":require("./components/control-pointer"),"preview-row":require("./components/preview-row"),"tool-bar":require("./components/toolbar"),"node-tree":require("./components/node-tree"),"property-tree":require("./components/property-tree"),"tips-mask":require("./components/tips-mask"),events:require("./components/events"),"property-tools":require("./components/property-tools"),"event-editor":require("./components/event-editor"),"ctrl-stick":require("./components/ctrl-stick"),"ani-mask":maskComp},exports.mounted=mounted;