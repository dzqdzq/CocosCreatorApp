"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,n){void 0===n&&(n=i),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.components=exports.methods=exports.watch=exports.computed=exports.data=void 0;const animation_ctrl_1=require("../share/animation-ctrl"),ipc_event_1=require("../share/ipc-event"),utils_1=require("./../utils"),grid_ctrl_1=require("../share/grid-ctrl"),global_data_1=require("../share/global-data"),animation_editor_1=require("../share/animation-editor"),maskComp=__importStar(require("./components/mask")),lodash=require("lodash");let aniPlayTask=null;const changeFailedClips=[];async function mounted(){const t=this;animation_ctrl_1.animationCtrl.init(t),animation_editor_1.animationEditor.init(t),t.refresh=lodash.debounce(t._refresh,500,{leading:!1,trailing:!0}),t.wrapModeList=await Editor.Message.request("scene","query-wrap-mode-enum-list");const e=await animation_editor_1.animationEditor.getConfig("spacingFrame");t.spacingFrame=e||1;const i=await animation_editor_1.animationEditor.getConfig("layout");i&&"object"==typeof i&&(i.topPec||(i.topPec=i.top/t.$refs.container.offsetHeight*100+"%",i.leftPec=i.left/t.$refs.container.offsetWidth*100+"%"),Object.assign(t.layout,i)),global_data_1.Flags.sceneReady=await Editor.Message.request("scene","query-is-ready"),global_data_1.Flags.sceneReady&&await t.refresh(),t.selectedIds=new Set(Editor.Selection.getSelected("node")),t.selectedId=Editor.Selection.getLastSelected("node")}function T(t,e=""){return Editor.I18n.t(`animator.${e}${t}`)}exports.data={loading:"wait_scene_ready",offset:240,toast:{message:""},currentFrame:0,root:"",selectedId:"",selectedIds:new Set,selectPath:null,moveNodePath:"",selectProperty:null,nodeDump:null,eventsDump:null,currentClip:"",clipConfig:null,currentBezierData:null,clipsMenu:[],selectKeyInfo:null,selectEventInfo:null,compIndex:0,animationMode:!1,animationState:"stop",editEventFrame:0,maskPanel:"",selectDataChange:0,nodesHeight:0,nodeScrollInfo:null,propertyScrollInfo:null,moveInfo:null,boxInfo:null,boxStyle:null,boxData:null,previewPointer:null,propertiesMenu:null,properties:null,updateKeyFrame:0,updatePosition:0,updateSelectKey:1,updateSelectNode:1,expandInfo:{},layout:{topPec:"30%",leftPec:"30%"},filterInvalid:!1,filterName:"",active:!0,wrapModeList:{}},exports.computed={lock(){return Boolean(!this.clipConfig||this.clipConfig.isLock||this.maskPanel||!this.animationMode)},selectPropData(){if(!animation_ctrl_1.animationCtrl.clipsDump||!this.selectProperty)return null;const{prop:t,nodePath:e}=this.selectProperty;return animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e][t]},computeSelectPath(){const t=this;if(!t.updateSelectNode)return;if(t.selectPath)return t.selectPath;let e="";return t.selectedId&&t.nodeDump&&(e=animation_ctrl_1.animationCtrl.nodesDump.uuid2path[t.selectedId]),e},sample(){let t=60;return this.clipConfig&&(t=this.clipConfig.sample),t},lastFrameInfo(){const t=this;let e=0;return t.clipConfig&&t.clipConfig.duration&&(e=utils_1.timeToFrame(t.clipConfig.duration,t.sample)),{frame:e,x:grid_ctrl_1.gridCtrl.frameToCanvas(e)}},propertyHeight(){const t=this;if(!t.properties)return 0;let e=0;return Object.keys(t.properties).forEach(i=>{t.properties[i].hidden||(e+=animation_editor_1.animationEditor.LINE_HEIGHT)}),e},stickInfo(){const t=this;if(!t.selectKeyInfo||!t.selectKeyInfo.data||t.selectKeyInfo.data.length<2||!t.updateSelectKey||!t.updatePosition)return animation_editor_1.animationEditor.hasShowStick=!1,null;const e=[],i=[],n=[];return t.selectKeyInfo.data.forEach((a,o)=>{t.computeSelectPath&&t.selectKeyInfo.params[o]&&t.selectKeyInfo.params[o].nodePath!==t.computeSelectPath||(e.push(a.x||0),t.properties[a.prop]&&i.push(t.properties[a.prop].top),n.push(a.frame))}),n.sort((t,e)=>t-e),animation_editor_1.animationEditor.stickInfo.leftFrame=n[0],animation_editor_1.animationEditor.stickInfo.rightFrame=n[n.length-1],e.sort((t,e)=>t-e),i.sort((t,e)=>t-e),e[e.length-1]===e[0]?(animation_editor_1.animationEditor.hasShowStick=!1,null):(animation_editor_1.animationEditor.stickInfo.width=e[e.length-1]-e[0]+18,animation_editor_1.animationEditor.stickInfo.height=i[i.length-1]-i[0]+animation_editor_1.animationEditor.LINE_HEIGHT,animation_editor_1.animationEditor.stickInfo.left=e[0]+grid_ctrl_1.gridCtrl.grid.xAxisOffset-10,animation_editor_1.animationEditor.stickInfo.top=i[0]-24-t.propertyScrollInfo.top,animation_editor_1.animationEditor.hasShowStick=!0,JSON.parse(JSON.stringify(animation_editor_1.animationEditor.stickInfo)))}},exports.watch={async selectedId(t,e){const i=this;if(i.selectKeyInfo=null,i.selectProperty=null,!t&&animation_ctrl_1.animationCtrl.nodesDump){if(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e]!==i.computeSelectPath&&i.computeSelectPath)return}i.updateSelectNode=-i.updateSelectNode,await i.updateSelectedId()},root(){this.filterInvalid=!1,this.filterName="",this.nodesHeight=0},async currentClip(t,e){const i=this;if(t===e||!t)return;if(!await ipc_event_1.IsetEditClip(t))return changeFailedClips.push(t),console.warn(`Set edit clip failed!${t}`),void(changeFailedClips.includes(e)?i.currentClip=null:i.currentClip=e);i.selectEventInfo=null,i.selectKeyInfo=null;const n=await ipc_event_1.IqueryPlayingClipTime(i.currentClip),a=utils_1.timeToFrame(n,i.sample);i.setCurrentFrame(a)},layout:{deep:!0,handler(){const t=this;process.nextTick(()=>{t.resize()})}},currentFrame(){this.calcSelectProperty(null,!0)}},exports.methods={onUpdateEvent(t,e,i){0!==i.length?ipc_event_1.IApplyOperation(ipc_event_1.IupdateEvent(t,e,i)):animation_ctrl_1.animationCtrl.deleteEvent()},toggleInvalidNode(){this.filterInvalid=!this.filterInvalid,this.$refs.nodes.scrollTop=this.nodeScrollInfo.top=0,animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips()},onFilter(t){t.stopPropagation(),t.preventDefault(),this.filterName!==t.target.value&&animation_editor_1.animationEditor.debounceFilterNode(t.target.value)},async updateSelectedId(){const t=this;if(!t.selectedId&&t.animationMode)return;if(t.selectedId?(t.propertiesMenu=await ipc_event_1.IqueryPropertieMenu(t.selectedId),console.debug("propertiesMenu",t.selectedId,t.propertiesMenu.length)):(t.root="",t.resetState(),t.propertiesMenu=null),t.properties=animation_editor_1.animationEditor.calcProperty(),!animation_ctrl_1.animationCtrl.nodesDump)return;const e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,i=e.findIndex(e=>e.uuid===t.selectedId&&"number"==typeof e.listIndex);if(-1===i)return;const n=e[i].listIndex*animation_editor_1.animationEditor.LINE_HEIGHT,{top:a,height:o}=t.nodeScrollInfo;(n-a>o||n-a<0)&&(t.nodeScrollInfo.top=n-o/2,animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips())},async calcSelectProperty(t,e=!1){const i=this;if(e&&!i.selectProperty||!t&&!e)return;e&&(t=i.selectProperty);const n=await ipc_event_1.IgetPropValueAtFrame(i.currentClip,t.nodePath,t.prop,i.currentFrame);i.selectProperty=Object.assign(t,{value:n&&n.value})},async init(){const t=this;t.$refs.chart.style.width=`${t.$refs.right.offsetWidth}px`;const e=await animation_editor_1.animationEditor.getConfig("showType");grid_ctrl_1.gridCtrl.init({$canvas:t.$refs.gridCanvas,$left:t.$refs.left,$right:t.$refs.right,$xAxis:t.$refs.xAxis,showType:e,minScale:1,maxScale:100}),animation_editor_1.animationEditor.updateLayoutConfig(),t.offset=t.$refs.left.offsetWidth,requestAnimationFrame(()=>{grid_ctrl_1.gridCtrl.grid.resize(),t.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,t.setCurrentFrame(t.currentFrame)})},queryDurationStyle(t){if(!t||!grid_ctrl_1.gridCtrl.grid)return"";let e=grid_ctrl_1.gridCtrl.grid.valueToPixelH(0);e<0&&(e=0);let i=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t)-e;return i<0&&(e=i,i=0),`transform: translateX(${e}px); width: ${i}px`},async _refresh(){const t=this,e={w:t.$refs.right.offsetWidth,h:t.$refs.right.offsetHeight};if(!e.w||!e.h)return void(global_data_1.Flags.domReady=!1);if(!animation_editor_1.animationEditor.refreshTask&&global_data_1.Flags.domReady&&t.$refs.gridCanvas.width===e.w&&t.$refs.gridCanvas.height===e.h)return void(t.loading="");t.loading="init_animation_data",global_data_1.Flags.domReady=!0,t.nodeScrollInfo={size:e,height:t.$refs["node-content"].offsetHeight,top:t.$refs.nodes.scrollTop},t.propertyScrollInfo={size:e,height:t.$refs["property-content"].offsetHeight,top:0};const i=Editor.Selection.getLastSelected("node"),n=await ipc_event_1.IquerySceneMode();if(t.animationMode="animation"===n,await t.init(),i)console.debug("update"),console.time("update"),await t.update(i),console.timeEnd("update");else if(t.animationMode){const{rootid:t,clipid:e}=await ipc_event_1.IgetEditAnimationInfo(),i=await Editor.Message.request("scene","query-node-tree",t);console.time("updateRoot"),await animation_editor_1.animationEditor.updateRoot(i),console.timeEnd("updateRoot"),console.time("updateClips"),await animation_editor_1.animationEditor.updateClips(e),console.timeEnd("updateClips")}else t.resetState();await t.updateSelectedId(),t.loading="",global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask=0},resetState(){animation_editor_1.animationEditor.updateClips(null),this.compIndex=null,this.animationMode=!1,this.clipConfig=null,this.nodeDump=null},async update(t,e){var i;const n=this;if(t===n.root&&"node-change"===e){const e=await Editor.Message.request("scene","query-node-tree",t);animation_editor_1.animationEditor.updateRoot(e);const i=await ipc_event_1.IqueryclipsMenuInfo(n.root);if(!i||i&&i.clipsMenu&&0===i.clipsMenu.length)n.clipsMenu=[],animation_editor_1.animationEditor.updateClips(null);else if(n.clipsMenu=Object.freeze(i.clipsMenu),n.currentClip!==i.defaultClip){(-1===i.clipsMenu.findIndex(t=>t.uuid===n.currentClip)&&n.animationMode||!n.animationMode)&&(i.defaultClip||(i.defaultClip=i.clipsMenu[0].uuid),await animation_editor_1.animationEditor.updateClips(i.defaultClip))}else animation_editor_1.animationEditor.calcNodes(),animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips(),n.properties=animation_editor_1.animationEditor.calcProperty(),animation_editor_1.animationEditor.checkSelectData(),n.updateKeyFrame++;return void(n.compIndex=animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.nodesDump.compIndex)}let a;if("node-change"!==e&&n.animationMode)t!==n.selectedId?n.selectedId=t:n.selectPath&&(n.selectPath=null,n.properties=animation_editor_1.animationEditor.calcProperty());else if(a=await ipc_event_1.IqueryAnimationRoot(t)){console.debug("start queryAnimationRootInfo"),console.time("queryAnimationRootInfo");const e=await ipc_event_1.IqueryAnimationRootInfo(a);if(console.timeEnd("queryAnimationRootInfo"),!e.nodeTreeDump.name)return void animation_editor_1.animationEditor.updateRoot(e.nodeTreeDump);if(console.time("updateRoot"),animation_editor_1.animationEditor.updateRoot(e.nodeTreeDump),console.timeEnd("updateRoot"),n.root=e.root,n.compIndex=null===(i=animation_ctrl_1.animationCtrl.nodesDump)||void 0===i?void 0:i.compIndex,"number"==typeof n.compIndex){n.clipsMenu=Object.freeze(e.clipsMenu);const{defaultClip:i}=e;if(!(i||n.clipsMenu&&0!==n.clipsMenu.length))return animation_editor_1.animationEditor.updateClips(null),n.selectedId=t,void(n.nodeDump=Object.freeze(JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))));if(i&&n.defaultClip===i)return animation_editor_1.animationEditor.updateClips(null),void(n.selectedId=t);n.updateState(e.state),"number"==typeof e.time&&0!==e.time&&n.setCurrentFrame(utils_1.timeToFrame(e.time,n.sample)),n.currentClip=e.defaultClip||e.clipsMenu[0].uuid,await animation_editor_1.animationEditor.updateClips(e.clipDump||n.currentClip,"update"),n.selectedId=t;const a=await ipc_event_1.IquerySceneMode();n.animationMode="animation"===a}else n.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes),await animation_editor_1.animationEditor.updateClips(null)}else{n.root=t;const e=await Editor.Message.request("scene","query-node-tree",t);animation_editor_1.animationEditor.updateRoot(e),n.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump?animation_ctrl_1.animationCtrl.nodesDump.nodes:null),n.compIndex=null,await animation_editor_1.animationEditor.updateClips(null),n.selectedId=t}},updateState(t){const e=this;switch(t){case 0:e.animationState="stop",aniPlayTask&&cancelAnimationFrame(aniPlayTask);break;case 1:"playing"!==e.animationState&&(e.animationState="playing",e.runPointer());break;case 2:e.animationState="pause",aniPlayTask&&cancelAnimationFrame(aniPlayTask)}},pointerPosition(t=0){return grid_ctrl_1.gridCtrl.frameToCanvas(this.currentFrame)+(t||grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset||0)-grid_ctrl_1.gridCtrl.startOffset},setCurrentFrame(t){const e=this;t<0&&(t=0),e.currentFrame=t,0!==t?animation_editor_1.animationEditor.showFrameInGrid(t):grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset!==grid_ctrl_1.gridCtrl.startOffset&&e.moveTimeLine(grid_ctrl_1.gridCtrl.startOffset-grid_ctrl_1.gridCtrl.grid.xAxisOffset)},resize(){if(!this.$refs.right)return void(global_data_1.Flags.domReady=!1);const{offsetWidth:t,offsetHeight:e}=this.$refs.right;this.$refs.chart.style.width=`${t}px`;const i={w:this.$refs.right.offsetWidth,h:this.$refs.right.offsetHeight};grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.resize(t,e),this.nodeScrollInfo={size:i,height:this.$refs["node-content"].offsetHeight,top:this.$refs.nodes.scrollTop},this.propertyScrollInfo={size:i,height:this.$refs["property-content"].offsetHeight,top:0},requestAnimationFrame(()=>{animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips()})},moveTimeLine(t){grid_ctrl_1.gridCtrl.grid.transferX(t),this.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.updatePosition++,animation_editor_1.animationEditor.updatePositionInfo("move"),grid_ctrl_1.gridCtrl.grid.render()},scaleTimeLine(t,e){const i=utils_1.smoothScale(t,grid_ctrl_1.gridCtrl.scale);t<0&&i<=grid_ctrl_1.gridCtrl.grid.xMinScale||t>0&&i>=grid_ctrl_1.gridCtrl.grid.xMaxScale||(grid_ctrl_1.gridCtrl.grid.xAxisScaleAt(e,i),this.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,animation_editor_1.animationEditor.updatePositionInfo(),this.updatePosition++,grid_ctrl_1.gridCtrl.grid.render())},onMouseWheel(t){const e=this;Math.abs(t.deltaX)>Math.abs(t.deltaY)?e.moveTimeLine(t.deltaY):e.scaleTimeLine(-t.deltaY,Math.round(t.offsetX))},onMouseDown(t){const e=this;e.moveNodePath=null,e.boxInfo=null,e.boxStyle=null;const i=t.target.getAttribute("name");"event"!==i&&(e.selectEventInfo=null),"key"!==i&&(e.selectKeyInfo=null);let n=null;switch(i){case"time-pointer":const e=grid_ctrl_1.gridCtrl.pageToFrame(t.x);if(2===t.button){const i=[{label:T("create","event."),click(){animation_ctrl_1.animationCtrl.addEvent(e)}}];return animation_ctrl_1.animationCtrl.copyEventInfo&&i.push({label:T("paste","event."),accelerator:"CmdOrCtrl+V",click(){animation_ctrl_1.animationCtrl.pasteEvent(e)}}),void Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:i})}global_data_1.Flags.mouseDownName="time-pointer";break;case"pointer":0===t.button&&(global_data_1.Flags.mouseDownName="pointer");break;case"node":case"property":if(0!==t.button)return global_data_1.Flags.mouseDownName="grid",void(global_data_1.Flags.startDragGridInfo={start:t.x,lastStart:t.x});n={type:i},global_data_1.Flags.mouseDownName=i;break;default:if(1===t.button||2===t.button)return global_data_1.Flags.mouseDownName="grid",void(global_data_1.Flags.startDragGridInfo={start:t.x,lastStart:t.x});if(!i)break;global_data_1.Flags.mouseDownName=i}if(!n){const e=t.path.find(t=>t.getAttribute&&["node","property"].includes(t.getAttribute("name")));if(!e)return;global_data_1.Flags.mouseDownName=e.getAttribute("name"),n={type:e.getAttribute("name")}}if(["node","property"].includes(global_data_1.Flags.mouseDownName)){const i=grid_ctrl_1.gridCtrl.pageToCtrl(t.x,t.y);n.startX=i.x,n.startY=i.y,e.boxInfo=n}},onScroll(t,e){const i=this;if(global_data_1.Flags.onScrolling)return;global_data_1.Flags.onScrolling=!0;const n=t.target.scrollTop;i.scrolling||(i.scrolling=!0,requestAnimationFrame(()=>{var t;i[`${e}ScrollInfo`].top=n,(null===(t=animation_ctrl_1.animationCtrl.nodesDump)||void 0===t?void 0:t.nodesDump)||animation_editor_1.animationEditor.calcNodes(),animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips(),i.updateKeyFrame++,i.scrolling=!1,global_data_1.Flags.onScrolling=!1}))},async onConfirm(t){const e=t.target.getAttribute("name"),i=t.target.value;await animation_ctrl_1.animationCtrl.updateConfig(e,i)},onStartResize(t,e){animation_editor_1.animationEditor.onStartResize(t,e)},async saveData(){if(await ipc_event_1.IsaveClip())return!0},runPointer(){const t=this;aniPlayTask=requestAnimationFrame(async()=>{if("playing"===t.animationState&&t.animationMode&&!global_data_1.Flags.timeLock){global_data_1.Flags.timeLock=!0;const e=await ipc_event_1.IqueryPlayingClipTime(t.currentClip),i=utils_1.timeToFrame(e,t.sample);if(utils_1.timeToFrame(e,t.sample)!==t.currentFrame&&t.setCurrentFrame(i),global_data_1.Flags.timeLock=!1,!1===e)return;t.runPointer()}else{cancelAnimationFrame(aniPlayTask);const e=await ipc_event_1.IqueryPlayingClipTime(t.currentClip),i=utils_1.timeToFrame(e,t.sample);if(i===t.currentFrame)return;t.setCurrentFrame(i)}})},onPropConfirm(t){const e=t.target.value;let i=this.selectProperty.value;const n=t.target.getAttribute("path");n?i[n]=e:i=e,"cc.Color"===this.selectProperty.type.value&&(i={r:e[0],g:e[1],b:e[2],a:e[3]}),ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(this.currentClip,this.computeSelectPath,this.selectProperty.prop,this.currentFrame,{newValue:i}))}},exports.components={"control-preview":require("./components/control-pointer"),"preview-row":require("./components/preview-row"),"tool-bar":require("./components/toolbar"),"node-tree":require("./components/node-tree"),"property-tree":require("./components/property-tree"),"tips-mask":require("./components/tips-mask"),events:require("./components/events"),"property-tools":require("./components/property-tools"),"event-editor":require("./components/event-editor"),"bezier-editor":require("./components/bezier-editor"),"ani-prop":require("./components/ani-prop"),"ctrl-stick":require("./components/ctrl-stick"),"ani-mask":maskComp},exports.mounted=mounted;