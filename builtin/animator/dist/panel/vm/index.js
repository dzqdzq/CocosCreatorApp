"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.components=exports.methods=exports.watch=exports.computed=exports.data=void 0;const animation_ctrl_1=require("../share/animation-ctrl"),ipc_event_1=require("../share/ipc-event"),utils_1=require("./../utils"),grid_ctrl_1=require("../share/grid-ctrl"),global_data_1=require("../share/global-data"),animation_editor_1=require("../share/animation-editor");let aniPlayTask=null;const changeFailedClips=[];async function mounted(){const t=this;animation_ctrl_1.animationCtrl.init(t),animation_editor_1.animationEditor.init(t);const e=await animation_editor_1.animationEditor.getConfig("spacingFrame");t.spacingFrame=e||1;const i=await animation_editor_1.animationEditor.getConfig("layout");i&&"object"==typeof i&&(i.topPec||(i.topPec=i.top/t.$refs.container.offsetHeight*100+"%",i.leftPec=i.left/t.$refs.container.offsetWidth*100+"%"),Object.assign(t.layout,i)),global_data_1.Flags.sceneReady=await Editor.Message.request("scene","query-is-ready"),global_data_1.Flags.sceneReady&&await t.refresh(),t.selectedIds=new Set(Editor.Selection.getSelected("node")),t.selectedId=Editor.Selection.getLastSelected("node")}function T(t,e=""){return Editor.I18n.t(`animator.${e}${t}`)}function hasKeyData(t){if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t])return!1;for(const e of Object.values(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t]))if(0!==e.keyFrames.length)return!0;return!1}exports.data={loading:"wait_scene_ready",offset:240,toast:{message:""},currentFrame:0,root:"",selectedId:"",selectedIds:new Set,selectPath:null,moveNodePath:"",selectProperty:null,nodeDump:null,eventsDump:null,currentClip:"",clipConfig:null,currentBezierData:null,clipsMenu:[],selectKeyInfo:null,selectEventInfo:null,compIndex:0,animationMode:!1,animationState:"stop",editEventFrame:0,showEventEditor:!1,showBezierEditor:!1,selectDataChange:0,nodesHeight:0,nodeScrollInfo:null,propertyScrollInfo:null,moveInfo:null,boxInfo:null,boxStyle:null,boxData:null,previewPointer:null,propertiesMenu:null,properties:null,updateKeyFrame:0,updatePosition:0,updateSelectKey:1,updateSelectNode:1,expandInfo:{},layout:{topPec:"30%",leftPec:"30%"},filterInvalid:!1,filterName:"",active:!0},exports.computed={lock(){return Boolean(!this.clipConfig||this.clipConfig.isLock||this.showBezierEditor||this.currentBezierData||!this.animationMode)},selectPropData(){if(!animation_ctrl_1.animationCtrl.clipsDump||!this.selectProperty)return null;const{prop:t,nodePath:e}=this.selectProperty;return animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e][t]},computeSelectPath(){const t=this;if(!t.updateSelectNode)return;if(t.selectPath||!animation_ctrl_1.animationCtrl.nodesDump)return t.selectPath;let e="";return t.selectedId&&t.nodeDump&&(e=animation_ctrl_1.animationCtrl.nodesDump.uuid2path[t.selectedId]),e},sample(){let t=60;return this.clipConfig&&(t=this.clipConfig.sample),t},lastFrameInfo(){const t=this;let e=0;return t.clipConfig&&t.clipConfig.duration&&(e=utils_1.timeToFrame(t.clipConfig.duration,t.sample)),{frame:e,x:grid_ctrl_1.gridCtrl.frameToCanvas(e)}},propertyHeight(){const t=this;if(!t.properties)return 0;let e=0;return Object.keys(t.properties).forEach(i=>{t.properties[i].hidden||(e+=animation_editor_1.animationEditor.LINE_HEIGHT)}),e},stickInfo(){const t=this;if(!t.selectKeyInfo||!t.selectKeyInfo.data||t.selectKeyInfo.data.length<2||!t.updateSelectKey||!t.updatePosition)return animation_editor_1.animationEditor.hasShowStick=!1,null;const e=[],i=[],n=[];return t.selectKeyInfo.data.forEach((a,r)=>{t.computeSelectPath&&t.selectKeyInfo.params[r]&&t.selectKeyInfo.params[r].nodePath!==t.computeSelectPath||(e.push(a.x||0),t.properties[a.prop]&&i.push(t.properties[a.prop].top),n.push(a.frame))}),n.sort((t,e)=>t-e),animation_editor_1.animationEditor.stickInfo.leftFrame=n[0],animation_editor_1.animationEditor.stickInfo.rightFrame=n[n.length-1],e.sort((t,e)=>t-e),i.sort((t,e)=>t-e),e[e.length-1]===e[0]?(animation_editor_1.animationEditor.hasShowStick=!1,null):(animation_editor_1.animationEditor.stickInfo.width=e[e.length-1]-e[0]+18,animation_editor_1.animationEditor.stickInfo.height=i[i.length-1]-i[0]+animation_editor_1.animationEditor.LINE_HEIGHT,animation_editor_1.animationEditor.stickInfo.left=e[0]+grid_ctrl_1.gridCtrl.grid.xAxisOffset-10,animation_editor_1.animationEditor.stickInfo.top=i[0]-24-t.propertyScrollInfo.top,animation_editor_1.animationEditor.hasShowStick=!0,JSON.parse(JSON.stringify(animation_editor_1.animationEditor.stickInfo)))}},exports.watch={async selectedId(t,e){const i=this;if(i.selectKeyInfo=null,i.selectProperty=null,!t&&animation_ctrl_1.animationCtrl.nodesDump){if(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e]!==i.computeSelectPath&&i.computeSelectPath)return}i.updateSelectNode=-i.updateSelectNode,await i.updateSelectedId()},root(){this.filterInvalid=!1,this.filterName="",this.nodesHeight=0},async currentClip(t,e){const i=this;if(t===e||!t)return;if(!await ipc_event_1.IsetEditClip(t))return changeFailedClips.push(t),console.warn(`Set edit clip failed!${t}`),void(changeFailedClips.includes(e)?i.currentClip=null:i.currentClip=e);i.selectEventInfo=null,i.selectKeyInfo=null;const n=await ipc_event_1.IqueryPlayingClipTime(i.currentClip),a=utils_1.timeToFrame(n,i.sample);i.setCurrentFrame(a)},layout:{deep:!0,handler(){const t=this;process.nextTick(()=>{t.resize()})}},currentFrame(){this.calcSelectProperty(null,!0)}},exports.methods={t:(t,e="")=>Editor.I18n.t(`animator.${e}${t}`),toggleInvalidNode(){this.filterInvalid=!this.filterInvalid,this.$refs.nodes.scrollTop=this.nodeScrollInfo.top=0,this.calcDisplayNodes(),this.calcDisplayClips()},onFilter(t){t.stopPropagation();t.stopPropagation(),t.preventDefault(),this.filterName!==t.target.value&&animation_editor_1.animationEditor.debounceFilterNode(t.target.value)},async updateSelectedId(){const t=this;if(!t.selectedId&&t.animationMode)return;if(t.selectedId?t.propertiesMenu=await ipc_event_1.IqueryPropertieMenu(t.selectedId):(t.root="",t.resetState(),t.propertiesMenu=null),t.properties=t.calcProperty(),!animation_ctrl_1.animationCtrl.nodesDump)return;const e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,i=e.findIndex(e=>e.uuid===t.selectedId&&"number"==typeof e.listIndex);if(-1===i)return;const n=e[i].listIndex*animation_editor_1.animationEditor.LINE_HEIGHT,{top:a,height:r}=t.nodeScrollInfo;(n-a>r||n-a<0)&&(t.nodeScrollInfo.top=n-r/2,t.calcDisplayNodes(),t.calcDisplayClips())},async calcSelectProperty(t,e=!1){const i=this;if(e&&!i.selectProperty||!t&&!e)return;e&&(t=i.selectProperty);const n=await ipc_event_1.IgetPropValueAtFrame(i.currentClip,t.nodePath,t.prop,i.currentFrame);i.selectProperty=Object.assign(t,{value:n&&n.value})},async init(){const t=this;t.$refs.chart.style.width=`${t.$refs.right.offsetWidth}px`;const e=await animation_editor_1.animationEditor.getConfig("showType");grid_ctrl_1.gridCtrl.init({$canvas:t.$refs.gridCanvas,$left:t.$refs.left,$right:t.$refs.right,$xAxis:t.$refs.xAxis,showType:e}),animation_editor_1.animationEditor.updateLayoutConfig(),t.offset=t.$refs.left.offsetWidth,requestAnimationFrame(()=>{grid_ctrl_1.gridCtrl.grid.resize(),t.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,t.setCurrentFrame(t.currentFrame)})},async refresh(){const t=this,e={w:t.$refs.right.offsetWidth,h:t.$refs.right.offsetHeight};if(!e.w||!e.h)return void(global_data_1.Flags.domReady=!1);if(!animation_editor_1.animationEditor.refreshTask&&global_data_1.Flags.domReady&&t.$refs.gridCanvas.width===e.w&&t.$refs.gridCanvas.height===e.h)return void(t.loading="");t.loading="init_animation_data",global_data_1.Flags.domReady=!0,t.nodeScrollInfo={size:e,height:t.$refs["node-content"].offsetHeight,top:t.$refs.nodes.scrollTop},t.propertyScrollInfo={size:e,height:t.$refs["property-content"].offsetHeight,top:0};const i=Editor.Selection.getLastSelected("node"),n=await ipc_event_1.IquerySceneMode();if(t.animationMode="animation"===n,await t.init(),i)await t.update(i);else if(t.animationMode){const{rootid:e,clipid:i}=await ipc_event_1.IgetEditAnimationInfo(),n=await Editor.Message.request("scene","query-node-tree",e);await t.updateRoot(n),await t.updateClips(i)}else t.resetState();await t.updateSelectedId(),t.loading="",global_data_1.Flags.sceneReady=!0,animation_editor_1.animationEditor.refreshTask=0},resetState(){this.updateClips(null),this.compIndex=null,this.animationMode=!1,this.clipConfig=null,this.nodeDump=null},async update(t,e){var i;const n=this;if(t===n.root&&"node-change"===e){const e=await Editor.Message.request("scene","query-node-tree",t);n.updateRoot(e);const i=await ipc_event_1.IqueryclipsMenuInfo(n.root);if(!i||i&&i.clipsMenu&&0===i.clipsMenu.length)n.clipsMenu=[],n.updateClips(null);else if(n.clipsMenu=Object.freeze(i.clipsMenu),n.currentClip!==i.defaultClip){(-1===i.clipsMenu.findIndex(t=>t.uuid===n.currentClip)&&n.animationMode||!n.animationMode)&&(i.defaultClip||(i.defaultClip=i.clipsMenu[0].uuid),await n.updateClips(i.defaultClip))}else n.calcNodes(),n.calcDisplayNodes(),n.calcDisplayClips(),n.properties=n.calcProperty(),n.checkSelectData(),n.updateKeyFrame++;return void(n.compIndex=animation_ctrl_1.animationCtrl.nodesDump&&animation_ctrl_1.animationCtrl.nodesDump.compIndex)}let a;if("node-change"!==e&&n.animationMode)t!==n.selectedId?n.selectedId=t:n.selectPath&&(n.selectPath=null,n.properties=n.calcProperty());else if(a=await ipc_event_1.IqueryAnimationRoot(t)){const e=await ipc_event_1.IqueryAnimationRootInfo(a);if(!e.nodeTreeDump.name)return void n.updateRoot(e.nodeTreeDump);if(n.updateRoot(e.nodeTreeDump),n.root=e.root,n.compIndex=null===(i=animation_ctrl_1.animationCtrl.nodesDump)||void 0===i?void 0:i.compIndex,"number"==typeof n.compIndex){n.clipsMenu=Object.freeze(e.clipsMenu);const{defaultClip:i}=e;if(!(i||n.clipsMenu&&0!==n.clipsMenu.length))return n.updateClips(null),n.selectedId=t,void(n.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump.nodes));if(i&&n.defaultClip===i)return n.updateClips(null),void(n.selectedId=t);n.updateState(e.state),"number"==typeof e.time&&0!==e.time&&n.setCurrentFrame(utils_1.timeToFrame(e.time,n.sample)),n.currentClip=e.defaultClip||e.clipsMenu[0].uuid,await n.updateClips(e.clipDump||n.currentClip,"update"),n.selectedId=t;const a=await ipc_event_1.IquerySceneMode();n.animationMode="animation"===a}else n.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes),await n.updateClips(null)}else{n.root=t;const e=await Editor.Message.request("scene","query-node-tree",t);n.updateRoot(e),n.nodeDump=Object.freeze(animation_ctrl_1.animationCtrl.nodesDump?animation_ctrl_1.animationCtrl.nodesDump.nodes:null),n.compIndex=null,await n.updateClips(null),n.selectedId=t}},updateState(t){const e=this;switch(t){case 0:e.animationState="stop",aniPlayTask&&cancelAnimationFrame(aniPlayTask);break;case 1:"playing"!==e.animationState&&(e.animationState="playing",e.runPointer());break;case 2:e.animationState="pause",aniPlayTask&&cancelAnimationFrame(aniPlayTask)}},pointerPosition(t=0){return grid_ctrl_1.gridCtrl.frameToCanvas(this.currentFrame)+(t||grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset||0)-grid_ctrl_1.gridCtrl.startOffset},checkSelectData(){this.checkSelectProperty(),this.checkSelectEvents(),this.checkSelectKeys()},checkSelectProperty(){const t=this;t.selectProperty&&animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.nodesDump&&(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid).includes(t.selectProperty.nodePath)||(t.selectProperty=null),animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.selectProperty.nodePath]&&animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.selectProperty.nodePath]||(t.selectProperty=null))},checkSelectEvents(){const t=this;if(!t.selectEventInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump||!animation_ctrl_1.animationCtrl.clipsDump.events)return void(t.selectEventInfo=null);const e=animation_ctrl_1.animationCtrl.clipsDump.events.map(t=>t.frame);if(!e.length)return void(t.selectEventInfo=null);const i=[];for(const n of t.selectEventInfo.frames){-1!==e.indexOf(n)&&i.push(n)}0===i.length?t.selectEventInfo=null:t.selectEventInfo.frames=i},checkSelectKeys(){const t=this;if(!t.selectKeyInfo)return;if(!animation_ctrl_1.animationCtrl.clipsDump)return void(t.selectKeyInfo=null);const e=[],i=[];if(t.selectKeyInfo.params.forEach((n,a)=>{if(!animation_ctrl_1.animationCtrl.clipsDump.pathsDump[n.nodePath][n.prop])return;animation_ctrl_1.animationCtrl.clipsDump.pathsDump[n.nodePath][n.prop].keyFrames.map(t=>t.frame).includes(t.selectKeyInfo.data[a].frame)&&(e.push(n),i.push(t.selectKeyInfo.data[a]))}),0===e.length)return void(t.selectKeyInfo=null);const n=utils_1.sortSelectParams(e);Object.assign(t.selectKeyInfo,{params:e,data:i,sortDump:n}),t.updateSelectKey++},calcProperty(){const t=this;if(!animation_ctrl_1.animationCtrl.clipsDump||!t.computeSelectPath||!grid_ctrl_1.gridCtrl.grid)return null;let e=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t.computeSelectPath];if(!e)return null;e=JSON.parse(JSON.stringify(e));let i=0;return Object.keys(e).forEach((n,a)=>{let r=e[n];"string"==typeof e[n].parentPropKey?(r=e[e[n].parentPropKey],!0!==t.expandInfo[r.prop]?(t.expandInfo[r.prop]=!1,e[n].hidden=!0):i++):i++,e[n].index=Math.max(0,i-1),e[n].top=i*animation_editor_1.animationEditor.LINE_HEIGHT,t.propertiesMenu&&!utils_1.isExitProperty(r,t.propertiesMenu)&&(e[n].missing=!0),e[n].keyFrames=Object.freeze(t.calcFrames(e[n].keyFrames))}),e},setCurrentFrame(t){const e=this;t<0&&(t=0),e.currentFrame=t,0!==t?animation_editor_1.animationEditor.showFrameInGrid(t):grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset!==grid_ctrl_1.gridCtrl.startOffset&&e.moveTimeLine(grid_ctrl_1.gridCtrl.startOffset-grid_ctrl_1.gridCtrl.grid.xAxisOffset)},updateRoot(t){const e=this;if(t){if(""===t.name||t.isScene)return e.selectedId=null,e.root=null,e.nodeDump=null,animation_ctrl_1.animationCtrl.clipsDump=null,void(animation_ctrl_1.animationCtrl.nodesDump=null);animation_ctrl_1.animationCtrl.nodesDump=utils_1.formatNodeDump(t),e.active=t.active,t.active?e.compIndex=animation_ctrl_1.animationCtrl.nodesDump.compIndex:e.nodeDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes))}},async updateClips(t,e){const i=this;if(i.nodesDump&&!i.active)return void i.clearClips();if(!t)return void i.clearClips();let n=t;if("string"==typeof t){if(i.currentClip===t&&"update"!==e)return;if(!(n=await ipc_event_1.IqueryClipDump(i.root,t))&&!global_data_1.Flags.sceneReady)return void animation_editor_1.animationEditor.refreshTask++;if(!n)return console.warn(`Get animation clip data failed! node ${i.root}, clip ${i.currentClip}`),void i.clearClips();i.currentClip=t}n&&(animation_ctrl_1.animationCtrl.clipsDump=Object.assign(utils_1.formatClipDump(n),{uuid:i.currentClip}),n.sample!==grid_ctrl_1.gridCtrl.grid.sample&&(grid_ctrl_1.gridCtrl.grid.sample=n.sample,grid_ctrl_1.gridCtrl.grid.render()),Object.keys(animation_ctrl_1.animationCtrl.clipConfig).forEach(t=>{var e;animation_ctrl_1.animationCtrl.clipConfig[t]=null!==(e=animation_ctrl_1.animationCtrl.clipsDump[t])&&void 0!==e?e:animation_ctrl_1.animationCtrl.clipConfig[t]}),i.clipConfig=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.clipConfig)),await i.calcSelectProperty(null,!0)),i.calcEventsDump(),i.calcNodes(),i.calcDisplayNodes(),i.calcDisplayClips(),i.properties=i.calcProperty(),i.checkSelectData(),i.updateKeyFrame++},async clearClips(){this.currentClip=null,animation_ctrl_1.animationCtrl.exit(),animation_ctrl_1.animationCtrl.clipsDump=null,this.clipConfig=null,this.eventsDump=null,this.calcDisplayNodes(),this.properties=this.calcProperty(),this.checkSelectData(),this.updateKeyFrame++},calcEventsDump(){let t=[];return animation_ctrl_1.animationCtrl.clipsDump&&grid_ctrl_1.gridCtrl.grid&&(t=animation_ctrl_1.animationCtrl.clipsDump.events.map(t=>(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,t))),this.eventsDump=Object.freeze(t)},calcNodes(){if(!animation_ctrl_1.animationCtrl.nodesDump)return null;if(!animation_ctrl_1.animationCtrl.clipsDump)return;const t=JSON.parse(JSON.stringify(Object.keys(animation_ctrl_1.animationCtrl.nodesDump.path2uuid)));function e(i,n=!1){const a=i.match(/\//g);if(!a)return;const r=a.length;let o=t.findIndex(t=>!!t.match(/\//g)&&t.match(/\//g).length===r);const l=i.match(/\/([^\/]*)$/);if(l){if(0===o&&(o=1),-1===o){o=t.length;const a=i.match(/\/([^\/]+)/g);if(a&&!n){let i="";for(const n of a)i+=n,t.includes(i)||e(i,!0);return}}t.splice(o,0,i),animation_ctrl_1.animationCtrl.nodesDump.nodesDump.splice(o,0,{indent:2*r,path:i,name:l[1],uuid:"",keyFrames:[],top:0,rawIndex:o,listIndex:o})}}animation_ctrl_1.animationCtrl.nodesDump.nodesDump=JSON.parse(JSON.stringify(animation_ctrl_1.animationCtrl.nodesDump.nodes));for(const i of Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump))-1===t.indexOf(i)&&e(i)},calcDisplayNodes(){const t=this;if(!animation_ctrl_1.animationCtrl.nodesDump)return void(t.nodeDump=null);const e=animation_ctrl_1.animationCtrl.nodesDump.nodesDump||animation_ctrl_1.animationCtrl.nodesDump.nodes,i=[];let n=-1;const a=t.filterInvalid||t.filterName;e.forEach((e,r)=>{if(delete e.listIndex,delete e.top,delete e.rawIndex,a){if(!hasKeyData(e.path)&&t.filterInvalid)return;if(t.filterName&&!new RegExp(t.filterName,"i").test(e.name))return;n++}else n=r;const o=n*animation_editor_1.animationEditor.LINE_HEIGHT-t.nodeScrollInfo.top;e.top=n*animation_editor_1.animationEditor.LINE_HEIGHT,e.rawIndex=r,e.listIndex=n,o>=1.5*-animation_editor_1.animationEditor.LINE_HEIGHT&&o<=t.nodeScrollInfo.height+animation_editor_1.animationEditor.LINE_HEIGHT&&i.push(e)}),t.nodesHeight=a?n*animation_editor_1.animationEditor.LINE_HEIGHT:e.length*animation_editor_1.animationEditor.LINE_HEIGHT,animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump=i,t.nodeDump=i,Math.abs(t.nodeScrollInfo.top-t.$refs.nodes.scrollTop)>animation_editor_1.animationEditor.LINE_HEIGHT&&(t.$refs.nodes.scrollTop=t.nodeScrollInfo.top)},calcDisplayClips(){const t=this;if(!t.nodeDump||!animation_ctrl_1.animationCtrl.nodesDump||!animation_ctrl_1.animationCtrl.clipsDump)return void(t.clipConfig=null);0===t.nodeDump.length&&(t.clipConfig=null);const e=Object.create(null);animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump.forEach(i=>{e[i.path]=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i.path],i.disabled||(i.keyFrames=Object.freeze(JSON.parse(JSON.stringify(t.calcNodeFrames(i.path)))))}),t.nodeDump=animation_ctrl_1.animationCtrl.nodesDump.displayNodesDump,animation_ctrl_1.animationCtrl.clipsDump.displayClipsDump=e},queryDurationStyle(t){if(!t||!grid_ctrl_1.gridCtrl.grid)return"";let e=grid_ctrl_1.gridCtrl.grid.valueToPixelH(0);e<0&&(e=0);let i=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t)-e;return i<0&&(e=i,i=0),`transform: translateX(${e}px); width: ${i}px`},calcNodeFrames(t,e=!1){const i=this;if(!animation_ctrl_1.animationCtrl.clipsDump)return;const n=animation_ctrl_1.animationCtrl.clipsDump.pathsDump[t];if(!n)return[];let a=[];for(const t of Object.keys(n)){const e=i.calcFrames(n[t].keyFrames);a=a.concat(e)}return e&&0!==a.length&&a.sort((t,e)=>t.frame-e.frame),a},calcFrames(t){if(!t)return[];return t.map(t=>(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset,t))},calcBoxStyle(){if(!this.boxInfo)return;const{startX:t,startY:e,type:i,x:n,y:a}=this.boxInfo,r=grid_ctrl_1.gridCtrl.pageToCtrl(n,a),{offsetTop:o,offsetHeight:l,offsetWidth:s}=this.$refs[`${i}-content`],c=Editor.Utils.Math.clamp(r.x,0,s),d=Editor.Utils.Math.clamp(r.y,o,o+l),p=t-c,m=e-d;if(!p||!m)return;const u={};return p>0&&m>0?(u.x=c,u.y=d-o):p<0&&m<0?(u.x=t,u.y=e-o):p<0&&m>0?(u.x=t,u.y=d-o):p>0&&m<0&&(u.x=c,u.y=e-o),this.boxData={origin:u,w:Math.abs(p),h:Math.abs(m),type:this.boxInfo.type},{top:`${u.y}px`,left:`${u.x}px`,right:`${s-u.x-Math.abs(p)}px`,bottom:`${l-u.y-Math.abs(m)}px`}},resize(){const t=this;if(!t.$refs.right)return void(global_data_1.Flags.domReady=!1);const{offsetWidth:e,offsetHeight:i}=t.$refs.right;t.$refs.chart.style.width=`${e}px`;const n={w:t.$refs.right.offsetWidth,h:t.$refs.right.offsetHeight};grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.resize(e,i),t.nodeScrollInfo={size:n,height:t.$refs["node-content"].offsetHeight,top:t.$refs.nodes.scrollTop},t.propertyScrollInfo={size:n,height:t.$refs["property-content"].offsetHeight,top:0},requestAnimationFrame(()=>{t.calcDisplayNodes(),t.calcDisplayClips()})},updatePositionInfo(t){const e=this;if(e.previewPointer&&(e.previewPointer=null),"move"!==t){if(e.nodeDump&&animation_ctrl_1.animationCtrl.clipsDump&&e.nodeDump.forEach(t=>{t.keyFrames=Object.freeze(e.calcNodeFrames(t.path))}),e.properties&&Object.values(e.properties).forEach(t=>{t.keyFrames=e.calcFrames(t.keyFrames)}),e.selectKeyInfo){for(const t of e.selectKeyInfo.data)t&&(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset);e.updateSelectKey++}if(animation_ctrl_1.animationCtrl.clipsDump&&animation_ctrl_1.animationCtrl.clipsDump.events&&e.calcEventsDump(),e.selectEventInfo)for(const t of e.selectEventInfo.data)t&&(t.x=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t.frame)-grid_ctrl_1.gridCtrl.grid.xAxisOffset)}},resetSelectedKeyInfo(){if(!this.selectKeyInfo)return;const t=JSON.parse(JSON.stringify(this.selectKeyInfo));t.offsetFrame=0,t.offset=0,delete t.sortDump,t.data.forEach((e,i)=>{t.params[i].frame=e.frame,delete t.params[i].offsetFrame}),t.frames=t.params.map(t=>t.frame),t.sortDump=utils_1.sortSelectParams(t.params),this.selectKeyInfo=t},moveTimeLine(t){grid_ctrl_1.gridCtrl.grid.transferX(t),this.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.updatePosition++,this.updatePositionInfo("move"),grid_ctrl_1.gridCtrl.grid.render()},scaleTimeLine(t,e){if(t<0&&grid_ctrl_1.gridCtrl.scale<=animation_editor_1.animationEditor.scaleRange.min||t>0&&grid_ctrl_1.gridCtrl.scale>=animation_editor_1.animationEditor.scaleRange.max)return;const i=utils_1.smoothScale(t,grid_ctrl_1.gridCtrl.scale);grid_ctrl_1.gridCtrl.scale=grid_ctrl_1.gridCtrl.grid.xAxisScaleAt(e,i),this.offset=grid_ctrl_1.gridCtrl.grid.xAxisOffset,this.updatePositionInfo(),this.updatePosition++,grid_ctrl_1.gridCtrl.grid.render()},onMouseWheel(t){const e=this;Math.abs(t.deltaX)>Math.abs(t.deltaY)?e.moveTimeLine(t.deltaY):e.scaleTimeLine(-t.deltaY,Math.round(t.offsetX))},onMouseDown(t){const e=this;e.moveNodePath=null,e.boxInfo=null,e.boxStyle=null;const i=t.target.getAttribute("name");"event"!==i&&(e.selectEventInfo=null),"key"!==i&&(e.selectKeyInfo=null);let n=null;switch(i){case"time-pointer":const a=grid_ctrl_1.gridCtrl.pageToFrame(t.x);if(2===t.button){const i=[{label:e.t("create","event."),click(){animation_ctrl_1.animationCtrl.addEvent(a)}}];return animation_ctrl_1.animationCtrl.copyEventInfo&&i.push({label:e.t("paste","event."),accelerator:"CmdOrCtrl+V",click(){animation_ctrl_1.animationCtrl.pasteEvent(a)}}),void Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:i})}global_data_1.Flags.mouseDownName="time-pointer";break;case"pointer":0===t.button&&(global_data_1.Flags.mouseDownName="pointer");break;case"node":case"property":if(0!==t.button)return global_data_1.Flags.mouseDownName="grid",void(global_data_1.Flags.startDragGridInfo={start:t.x,lastStart:t.x});n={type:i},global_data_1.Flags.mouseDownName=i;break;default:if(1===t.button||2===t.button)return global_data_1.Flags.mouseDownName="grid",void(global_data_1.Flags.startDragGridInfo={start:t.x,lastStart:t.x});if(!i)break;global_data_1.Flags.mouseDownName=i}if(!n){const e=t.path.find(t=>t.getAttribute&&["node","property"].includes(t.getAttribute("name")));if(!e)return;global_data_1.Flags.mouseDownName=e.getAttribute("name"),n={type:e.getAttribute("name")}}if(["node","property"].includes(global_data_1.Flags.mouseDownName)){const i=grid_ctrl_1.gridCtrl.pageToCtrl(t.x,t.y);n.startX=i.x,n.startY=i.y,e.boxInfo=n}},onScroll(t,e){const i=this;if(global_data_1.Flags.onScrolling)return;global_data_1.Flags.onScrolling=!0;const n=t.target.scrollTop;i.scrolling||(i.scrolling=!0,requestAnimationFrame(()=>{i[`${e}ScrollInfo`].top=n,i.calcDisplayNodes(),i.calcDisplayClips(),i.updateKeyFrame++,i.scrolling=!1,global_data_1.Flags.onScrolling=!1}))},async onConfirm(t){const e=t.target.getAttribute("name"),i=t.target.value;await animation_ctrl_1.animationCtrl.updateConfig(e,i)},onStartResize(t,e){animation_editor_1.animationEditor.onStartResize(t,e)},async saveData(){if(await ipc_event_1.IsaveClip())return!0},runPointer(){const t=this;aniPlayTask=requestAnimationFrame(async()=>{if("playing"===t.animationState&&t.animationMode&&!global_data_1.Flags.timeLock){global_data_1.Flags.timeLock=!0;const e=await ipc_event_1.IqueryPlayingClipTime(t.currentClip),i=utils_1.timeToFrame(e,t.sample);if(utils_1.timeToFrame(e,t.sample)!==t.currentFrame&&t.setCurrentFrame(i),global_data_1.Flags.timeLock=!1,!1===e)return;t.runPointer()}else{cancelAnimationFrame(aniPlayTask);const e=await ipc_event_1.IqueryPlayingClipTime(t.currentClip),i=utils_1.timeToFrame(e,t.sample);if(i===t.currentFrame)return;t.setCurrentFrame(i)}})},onPropConfirm(t){const e=t.target.value;let i=this.selectProperty.value;const n=t.target.getAttribute("path");n?i[n]=e:i=e,"cc.Color"===this.selectProperty.type.value&&(i={r:e[0],g:e[1],b:e[2],a:e[3]}),ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(this.currentClip,this.computeSelectPath,this.selectProperty.prop,this.currentFrame,{newValue:i}))}},exports.components={"control-preview":require("./components/control-pointer"),"preview-row":require("./components/preview-row"),"tool-bar":require("./components/toolbar"),"node-tree":require("./components/node-tree"),"property-tree":require("./components/property-tree"),"tips-mask":require("./components/tips-mask"),events:require("./components/events"),"property-tools":require("./components/property-tools"),"event-editor":require("./components/event-editor"),"bezier-editor":require("./components/bezier-editor"),"ani-prop":require("./components/ani-prop"),"ctrl-stick":require("./components/ctrl-stick")},exports.mounted=mounted;