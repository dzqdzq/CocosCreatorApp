"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,o,i){void 0===i&&(i=o),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[o]}})}:function(t,e,o,i){void 0===i&&(i=o),t[i]=e[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)"default"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&__createBinding(e,t,o);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.components=exports.methods=exports.watch=exports.computed=exports.data=void 0;const animation_ctrl_1=require("../share/animation-ctrl"),ipc_event_1=require("../share/ipc-event"),utils_1=require("./../utils"),grid_ctrl_1=require("../share/grid-ctrl"),global_data_1=require("../share/global-data"),animation_editor_1=require("../share/animation-editor"),maskComp=__importStar(require("./components/mask")),bezier_presets_1=require("../share/bezier-presets"),lodash=require("lodash"),changeFailedClips=[],data=function(){return{loading:"wait_scene_ready",offset:240,toast:{message:""},currentFrame:0,root:"",selectedId:"",selectedIds:new Set,selectPath:"",moveNodePath:"",selectProperty:null,nodeDump:null,eventsDump:null,currentClip:"",clipConfig:null,clipsMenu:[],selectKeyInfo:null,selectEventInfo:null,compIndex:0,animationMode:!1,animationState:"stop",editEventFrame:0,maskPanel:"",selectDataChange:0,nodesHeight:0,nodeScrollInfo:null,propertyScrollInfo:null,moveInfo:null,boxInfo:null,boxStyle:null,boxData:null,previewPointer:null,propertiesMenu:null,properties:null,updateKeyFrame:0,updatePosition:0,updateSelectKey:1,updateSelectNode:1,scrolling:!1,expandInfo:{},layout:{topPec:"30%",leftPec:"30%"},filterInvalid:!1,filterName:"",active:!0,wrapModeList:[],showAnimCurve:!1,lightCurve:null,hasSelectedCurveClip:!1,curveDisabledCCtypes:animation_editor_1.animationEditor.curveDisabledCCtypes,presetSize:110,expandTab:"",searchPresetName:""}};async function mounted(){const t=this;animation_ctrl_1.animationCtrl.init(t),animation_editor_1.animationEditor.init(t),t.wrapModeList=await Editor.Message.request("scene","query-enum-list-with-path","AnimationClip.WrapMode"),t.wrapModeList.forEach(t=>{t.tip=Editor.I18n.t(`animator.animationCurve.WrapMode.${t.name}.tip`)||t.name,t.name=Editor.I18n.t(`animator.animationCurve.WrapMode.${t.name}.label`)||t.name});const e=await animation_editor_1.animationEditor.getConfig("layout");e&&"object"==typeof e&&(e.topPec||(e.topPec=e.top/t.$refs.container.offsetHeight*100+"%",e.leftPec=e.left/t.$refs.container.offsetWidth*100+"%"),Object.assign(t.layout,e)),global_data_1.Flags.sceneReady=await Editor.Message.request("scene","query-is-ready"),global_data_1.Flags.sceneReady&&await animation_editor_1.animationEditor.debounceRefresh(),t.selectedIds=new Set(Editor.Selection.getSelected("node")),t.selectedId=Editor.Selection.getLastSelected("node")}function T(t,e=""){return Editor.I18n.t(`animator.${e}${t}`)}exports.data=data,exports.computed={presetArr(){const t=this;return t.searchPresetName?bezier_presets_1.defaultBezier.filter(e=>new RegExp(t.searchPresetName,"i").test(e.name)):bezier_presets_1.defaultBezier},lock(){return Boolean(!this.clipConfig||this.clipConfig.isLock||this.maskPanel||!this.animationMode)},selectPropData(){if(!animation_ctrl_1.animationCtrl.clipsDump||!this.selectProperty)return null;const{prop:t,nodePath:e}=this.selectProperty;return animation_ctrl_1.animationCtrl.clipsDump.pathsDump[e][t]},computeSelectPath(){const t=this;if(!t.updateSelectNode)return"";if(t.selectPath)return t.selectPath;let e="";return t.selectedId&&t.nodeDump&&(e=animation_ctrl_1.animationCtrl.nodesDump.uuid2path[t.selectedId]),e},sample(){let t=60;return this.clipConfig&&(t=this.clipConfig.sample),animation_editor_1.animationEditor.updateSample(t),t},lastFrameInfo(){const t=this;let e=0;return t.clipConfig&&t.clipConfig.duration&&(e=utils_1.timeToFrame(t.clipConfig.duration,t.sample)),{frame:e,x:grid_ctrl_1.gridCtrl.frameToCanvas(e)}},propertyHeight(){const t=this;if(!t.properties)return 0;let e=0;return Object.keys(t.properties).forEach(o=>{t.properties[o].hidden||(e+=animation_editor_1.animationEditor.LINE_HEIGHT)}),e},stickInfo(){const t=this;if(!t.properties||!t.selectKeyInfo||!t.selectKeyInfo.keyFrames||t.selectKeyInfo.keyFrames.length<2||!t.updateSelectKey||!t.updatePosition||!t.propertyScrollInfo)return animation_editor_1.animationEditor.hasShowStick=!1,null;const e=[],o=[],i=[];return t.selectKeyInfo.keyFrames.forEach((a,r)=>{t.computeSelectPath&&t.selectKeyInfo.keyFrames[r]&&t.selectKeyInfo.keyFrames[r].nodePath!==t.computeSelectPath||(e.push(a.x||0),t.properties[a.prop]&&o.push(t.properties[a.prop].top),i.push(a.frame))}),i.sort((t,e)=>t-e),animation_editor_1.animationEditor.stickInfo.leftFrame=i[0],animation_editor_1.animationEditor.stickInfo.rightFrame=i[i.length-1],e.sort((t,e)=>t-e),o.sort((t,e)=>t-e),e[e.length-1]===e[0]?(animation_editor_1.animationEditor.hasShowStick=!1,null):(animation_editor_1.animationEditor.stickInfo.width=e[e.length-1]-e[0]+18,animation_editor_1.animationEditor.stickInfo.height=o[o.length-1]-o[0]+animation_editor_1.animationEditor.LINE_HEIGHT,animation_editor_1.animationEditor.stickInfo.left=e[0]+grid_ctrl_1.gridCtrl.grid.xAxisOffset-10,animation_editor_1.animationEditor.stickInfo.top=o[0]-t.propertyScrollInfo.top,animation_editor_1.animationEditor.hasShowStick=!0,JSON.parse(JSON.stringify(animation_editor_1.animationEditor.stickInfo)))},curveData(){var t;const e=this;if(!e.selectProperty||!e.showAnimCurve||!e.properties)return animation_editor_1.animationEditor.repaintCurve(),null;const o=null===(t=animation_ctrl_1.animationCtrl.clipsDump)||void 0===t?void 0:t.pathsDump[e.selectProperty.nodePath];if(!o)return null;const i=o[e.selectProperty.prop];if(!(i&&i.isCurveSupport&&i.type&&e.properties[e.selectProperty.prop]))return animation_editor_1.animationEditor.repaintCurve(),null;if(i.type&&animation_editor_1.animationEditor.curveDisabledCCtypes.includes(i.type.value))return animation_editor_1.animationEditor.repaintCurve(),null;const a={curveInfos:{},wrapMode:e.clipConfig.wrapMode,duration:e.clipConfig.duration*e.clipConfig.sample};let r=!1;if(i.partKeys)for(const t of i.partKeys){const i=o[t];a.curveInfos[t]={keys:i.keyFrames.map(t=>t.curve),preWrapMode:i.preExtrap,postWrapMode:i.postExtrap,color:e.properties[t].color},r=!(!r&&!a.curveInfos[t].keys.find(t=>t.easingMethod))}else a.curveInfos={[e.selectProperty.prop]:{keys:i.keyFrames.map(t=>t.curve),preWrapMode:i.preExtrap,postWrapMode:i.postExtrap,color:e.properties[e.selectProperty.prop].color}},r=!(!r&&!a.curveInfos[e.selectProperty.prop].keys.find(t=>t.easingMethod));return animation_editor_1.animationEditor.repaintCurve(a),Object.assign(Object.assign({},a),{hasUserEasingMethod:r})},curveStyle(){return this.showAnimCurve&&this.computeSelectPath?{width:"100%",height:"100%"}:{display:"none"}},stickBoxStyle(){return this.stickInfo?{width:this.stickInfo.width+"px",height:this.stickInfo.height+"px",top:this.stickInfo.top+"px",left:this.stickInfo.left+"px"}:null}},exports.watch={async selectedId(t,e){const o=this,i=o.computeSelectPath;if(o.selectKeyInfo){o.selectKeyInfo.keyFrames.find(t=>t.nodePath!==i)&&(o.selectKeyInfo=null)}if(!t&&animation_ctrl_1.animationCtrl.nodesDump){if(animation_ctrl_1.animationCtrl.nodesDump.uuid2path[e]!==i&&i)return}if(o.updateSelectNode=-o.updateSelectNode,await animation_editor_1.animationEditor.updateSelectedId(),o.properties&&(o.selectProperty&&o.selectProperty.nodePath!==i||!o.selectProperty)){const t=Object.keys(o.properties)[0];animation_editor_1.animationEditor.updateSelectProperty({nodePath:i,prop:t,missing:o.properties[t].missing,clipUuid:animation_ctrl_1.animationCtrl.clipsDump.uuid,isCurveSupport:o.properties[t].isCurveSupport})}else o.selectProperty=null},selectKeyInfo(){this.showAnimCurve?animation_editor_1.animationEditor.selectKeyUpdateFlag&&animation_editor_1.animationEditor.updateCurveSelecteKeys():animation_editor_1.animationEditor.selectKeyUpdateFlag=!0},root(){this.filterInvalid=!1,this.filterName="",this.nodesHeight=0},async currentClip(t,e){const o=this;if(t===e||!t)return;if(!await ipc_event_1.IsetEditClip(t))return changeFailedClips.push(t),console.warn(`Set edit clip failed!${t}`),void(changeFailedClips.includes(e)?o.currentClip="":o.currentClip=e);o.selectEventInfo=null,o.selectKeyInfo=null;const i=await ipc_event_1.IqueryPlayingClipTime(o.currentClip),a=utils_1.timeToFrame(i,o.sample);animation_editor_1.animationEditor.setCurrentFrame(a)},layout:{deep:!0,handler(){process.nextTick(()=>{animation_editor_1.animationEditor.resize()})}},currentFrame(){this.calcSelectProperty(null,!0)},boxData(){const t=this;if(!t.boxData)return;const{origin:e,h:o,w:i,type:a}=t.boxData;if("property"===a&&!t.properties)return;const r=[],n="node"===a?t.nodeScrollInfo.top:t.propertyScrollInfo.top;function s(a,s){Object.values(a).forEach(a=>{const l=a.top+animation_editor_1.animationEditor.LINE_HEIGHT/2+animation_editor_1.animationEditor.KEY_SIZE_R-n;!s&&(l<e.y||l>e.y+o)||a.keyFrames.forEach(o=>{const n=o.x+t.offset;n>e.x&&n<e.x+i&&r.push({frame:o.frame,rawFrame:o.frame,nodePath:a.nodePath,x:o.x,prop:a.prop})})})}"node"===a?Object.keys(animation_ctrl_1.animationCtrl.clipsDump.pathsDump).forEach(i=>{const a=t.nodeDump.find(t=>t.path===i);if(!a)return;const r=a.top+animation_editor_1.animationEditor.LINE_HEIGHT/2+animation_editor_1.animationEditor.KEY_SIZE_R-n;r<e.y||r>e.y+o||s(animation_ctrl_1.animationCtrl.clipsDump.pathsDump[i],!0)}):s(t.properties),r.sort((t,e)=>t.frame-e.frame),t.selectKeyInfo={nodePath:t.computeSelectPath,keyFrames:r}}},exports.methods={onClipCurvePreset(t){this.$refs.curve.curveCtrl.applyBezierToSelectedCurveClip(t)},showAllKeys(){const t=this.curveData,e=[0,this.clipConfig.duration*this.clipConfig.sample+10],o=[];Object.values(t.curveInfos).forEach(t=>{if(!t.keys.length)return;t.keys.sort((t,e)=>t.point.y-e.point.y);const e=t.keys[0].point.y-20,i=t.keys[t.keys.length-1].point.y+20;o[0]?o[0]=Math.min(o[0],e):o[0]=e,o[1]?o[1]=Math.max(o[1],i):o[1]=i}),this.$refs.curve.curveCtrl.setDisplayRange(e,o)},onUpdateEvent(t,e,o){0!==o.length?ipc_event_1.IApplyOperation(ipc_event_1.IupdateEvent(t,e,o)):animation_ctrl_1.animationCtrl.deleteEvent()},toggleInvalidNode(){this.filterInvalid=!this.filterInvalid,this.$refs.nodes.scrollTop=this.nodeScrollInfo.top=0,animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips()},onFilter(t){t.stopPropagation(),t.preventDefault(),this.filterName!==t.target.value&&animation_editor_1.animationEditor.debounceFilterNode(t.target.value)},async calcSelectProperty(t,e=!1){const o=this;if(e&&o.selectProperty&&(t=o.selectProperty),!t)return;const i=await ipc_event_1.IgetPropValueAtFrame(o.currentClip,t.nodePath,t.prop,o.currentFrame);o.selectProperty=Object.assign(t,{dump:i})},queryDurationStyle(t){if(!t||!grid_ctrl_1.gridCtrl.grid)return"";let e=grid_ctrl_1.gridCtrl.grid.valueToPixelH(0);e<0&&(e=0);let o=grid_ctrl_1.gridCtrl.grid.valueToPixelH(t)-e;return o<0&&(e=o,o=0),`transform: translateX(${e}px); width: ${o}px`},pointerPosition(t=0){return grid_ctrl_1.gridCtrl.frameToCanvas(this.currentFrame)+(t||grid_ctrl_1.gridCtrl.grid&&grid_ctrl_1.gridCtrl.grid.xAxisOffset||0)-grid_ctrl_1.gridCtrl.startOffset},onMouseWheel(t){t.shiftKey?animation_editor_1.animationEditor.moveTimeLine("darwin"===process.platform?t.deltaX:t.deltaY):Math.abs(t.deltaX)>Math.abs(t.deltaY)?animation_editor_1.animationEditor.moveTimeLine(t.deltaY):animation_editor_1.animationEditor.scaleTimeLine(-t.deltaY,Math.round(t.offsetX))},onMouseDown(t){const e=this;e.moveNodePath="",e.boxInfo=null,e.boxStyle=null;const o=t.target.getAttribute("name");"event"!==o&&(e.selectEventInfo=null),"key"!==o&&"stick"!==o&&(e.selectKeyInfo=null);let i=null;function a(){t.offsetY>e.$refs["property-content"].offsetTop?global_data_1.Flags.mouseDownName="property":t.offsetY>e.$refs["node-content"].offsetTop&&t.offsetY<e.$refs["property-content"].offsetTop&&(global_data_1.Flags.mouseDownName="node")}switch(o){case"time-pointer":{const e=grid_ctrl_1.gridCtrl.pageToFrame(t.x);if(global_data_1.Flags.mouseDownName="time-pointer",2===t.button){const o=[{label:T("create","event."),click(){animation_ctrl_1.animationCtrl.addEvent(e),global_data_1.Flags.mouseDownName=""}}];return animation_ctrl_1.animationCtrl.copyEventInfo&&o.push({label:T("paste","event."),accelerator:"CmdOrCtrl+V",click(){animation_ctrl_1.animationCtrl.pasteEvent(e),global_data_1.Flags.mouseDownName=""}}),void Editor.Menu.popup({x:t.pageX,y:t.pageY,menu:o})}}break;case"pointer":0===t.button&&(global_data_1.Flags.mouseDownName="pointer");break;case"stick":global_data_1.Flags.mouseDownName="stick",e.selectKeyInfo.startX=t.x,e.selectKeyInfo.offset=0,e.selectKeyInfo.offsetFrame=0,global_data_1.Flags.startDragStickInfo={type:"center"};break;default:if(1===t.button||2===t.button){if(global_data_1.Flags.startDragGridInfo={start:t.x,lastStart:t.x},2===t.button&&(a(),global_data_1.Flags.mouseDownName))break;return void(global_data_1.Flags.mouseDownName="grid")}if(!o)break;global_data_1.Flags.mouseDownName=o}if(i||global_data_1.Flags.mouseDownName||(a(),global_data_1.Flags.mouseDownName&&(i={type:global_data_1.Flags.mouseDownName})),["node","property"].includes(global_data_1.Flags.mouseDownName)&&i){const o=grid_ctrl_1.gridCtrl.pageToCtrl(t.x,t.y);i.startX=o.x,i.startY=o.y,e.boxInfo=i}},onScroll(t,e){const o=this;if(global_data_1.Flags.onScrolling)return;const i="node"===e?o.nodeScrollInfo:o.propertyScrollInfo,a=t.target.scrollTop;a!==i.top&&(global_data_1.Flags.lastScrollTops.splice(0,0,a),global_data_1.Flags.lastScrollTops.length=3,global_data_1.Flags.lastScrollTops[0]!==global_data_1.Flags.lastScrollTops[2]&&(o.scrolling||(global_data_1.Flags.onScrolling=!0,o.scrolling=!0,requestAnimationFrame(()=>{var t;i.top=a,(null===(t=animation_ctrl_1.animationCtrl.nodesDump)||void 0===t?void 0:t.nodesDump)||animation_editor_1.animationEditor.calcNodes(),animation_editor_1.animationEditor.calcDisplayNodes(),animation_editor_1.animationEditor.calcDisplayClips(),o.updateKeyFrame++,o.scrolling=!1,global_data_1.Flags.onScrolling=!1}))))},async onConfirm(t){const e=t.target.getAttribute("name"),o=t.target.value;"sample"===e&&animation_editor_1.animationEditor.updateSample(o),await animation_ctrl_1.animationCtrl.updateConfig(e,o)},onStartResize(t,e){animation_editor_1.animationEditor.onStartResize(t,e)},toggleAniCurve(){this.showAnimCurve=!this.showAnimCurve,animation_editor_1.animationEditor.initCurve()},async onEditEasingMethodCurve(t){const e=this;if(e.showAnimCurve&&e.curveData&&e.curveData.hasUserEasingMethod){if(t.stopPropagation(),t.stopImmediatePropagation(),t.preventDefault(),0===(await Editor.Dialog.warn(Editor.I18n.t("animator.tips.abort_easing_method"),{buttons:[Editor.I18n.t("animator.cancel"),Editor.I18n.t("animator.abort")],default:0,cancel:0})).response)return;const o=[],{nodePath:i}=e.selectProperty;for(const t of Object.keys(e.curveData.curveInfos)){e.curveData.curveInfos[t].keys.forEach(a=>{a.easingMethod&&o.push(ipc_event_1.ImodifyCurveOfKey(e.currentClip,i,t,Math.round(a.point.x),{easingMethod:0}))})}ipc_event_1.IApplyOperation(o)}},onPropConfirm(t){this.selectProperty&&ipc_event_1.IApplyOperation(ipc_event_1.IcreateKey(this.currentClip,this.computeSelectPath,this.selectProperty.prop,this.currentFrame,{newValue:t.target.dump.value}))}},exports.components={"control-preview":require("./components/control-pointer"),"preview-row":require("./components/preview-row"),"tool-bar":require("./components/toolbar"),"node-tree":require("./components/node-tree"),"property-tree":require("./components/property-tree"),"tips-mask":require("./components/tips-mask"),events:require("./components/events"),"property-tools":require("./components/property-tools"),"event-editor":require("./components/event-editor"),"ctrl-stick":require("./components/ctrl-stick"),"ani-mask":maskComp},exports.mounted=mounted;