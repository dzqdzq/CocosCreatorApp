"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),d3=require("d3"),Vue=require("vue/dist/vue.js"),{cloneDeep:cloneDeep}=require("lodash");Vue.config.productionTip=!1,Vue.config.devtools=!1;let cache,panel=null,vm=null;function mergeStops(t,e,i){const r=t.concat(e).map(t=>t.time).sort((t,e)=>t-e),a=[...new Set(r)].reduce((i,r)=>{const a=t.find(t=>!t.hide&&t.time===r)||{},o=e.find(t=>!t.hide&&t.time===r)||{};return void 0===a.time&&void 0===o.time||i.push(Object.assign(Object.assign({},a),o)),i},[]);cache.colorKeys=t,cache.alphaKeys=e.map(t=>{const e=Object.assign(t);return e.alpha=Number((255*t.alpha).toFixed()),e}),cache.mode=i,Editor.Message.send("inspector","gradient-change",cache);for(const[t,e]of a.entries()){const{time:r,color:o,alpha:s}=e;void 0===o&&(e.color=getValByType(t,r,a,"color",i)),void 0===s&&(e.alpha=getValByType(t,r,a,"alpha",i))}if(1===i){const t=[];for(const[e,i]of a.entries()){const{time:r}=i;if(t.push(i),e<a.length-1){const i=a[e+1];t.push(Object.assign(Object.assign({},i),{time:r}))}}return t}return a}function getValByType(t,e,i,r,a){let o,s;for(let e=t+1;e<i.length;e++){const t=i[e];if(void 0!==t[r]){o=t;break}}for(let e=t-1;e>=0;e--){const t=i[e];if(void 0!==t[r]){s=t;break}}if(s||(s=o),o||(o=s),1===a)return o[r];s||(s={color:[255,255,255],time:0}),o||(o={color:[255,255,255],time:1});let n=s[r];return s!==o&&(n=interpolateStopProperty(s,o,e,r)),n}function interpolateStopProperty(t,e,i,r){const{time:a}=t,{time:o}=e,s=(i-a)/(o-a),n=1-s;return"color"===r?[0,1,2].map(i=>Math.round(t.color[i]*n+e.color[i]*s)):Math.round(100*t.alpha*n+100*e.alpha*s)/100}async function ready(){vm=new Vue({el:(panel=this).$.content,data:{enumList:[{name:"Blend",value:0},{name:"Fixed",value:1}],gradient:{mode:0,alphaKeys:[{time:0,alpha:0,hide:!1},{time:1,alpha:1,hide:!1}],colorKeys:[{time:.5,color:[249,49,83],hide:!1},{time:1,color:[255,255,255],hide:!1}]},margin:{top:15,bottom:15,left:5,right:5},config:{anchorWidth:10,anchorHeight:15,width:0,height:75,defaultColor:[255,255,255],defaultAlpha:1,colorLength:8,alphaLength:8},selectedItem:null},async mounted(){},methods:{init(t){t.colorKeys.map(t=>t.type="color"),t.alphaKeys.map(t=>{t.type="alpha",t.alpha=t.alpha/255}),this.gradient=t,this.selectedItem=null,this.resize()},getVal(t){if(this.selectedItem)switch(t){case"color":return JSON.stringify([...this.selectedItem.color,255]);case"time":return`${(100*this.selectedItem.time).toFixed()}`;case"alpha":return`${(255*this.selectedItem.alpha).toFixed()}`;default:return this.selectedItem[t]}},confirm(t,e){const{value:i}=e.target;this.update({operation:"assign",data:{value:i,type:t}})},getAnchors(){const{gradient:{alphaKeys:t,colorKeys:e}}=this,i=e.map((t,e)=>Object.assign(Object.assign({},t),{index:e})),r=t.map((t,e)=>Object.assign(Object.assign({},t),{index:e}));return i.concat(r).sort((t,e)=>{if(t.time===e.time){if(t.active)return!0;if(e.active)return!1}return t.time-e.time})},getStops(){const{gradient:{alphaKeys:t,colorKeys:e,mode:i}}=this;return mergeStops(cloneDeep(e).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),cloneDeep(t).sort((t,e)=>{if(t.time===e.time){if(t.active)return!1;if(e.active)return!0}return t.time-e.time}),i)},drawStops(t,e){const i=this.getStops(t,e),r=this._grad.selectAll("stop").data(i,(t,e)=>{const{color:i,alpha:r,time:a}=t;return`${a}${r}${i}${e}`});r.exit().remove(),r.enter().append("stop").merge(r).attr("offset",t=>100*t.time+"%").style("stop-color",t=>d3.rgb(...t.color)).style("stop-opacity",t=>void 0!==t.alpha?t.alpha:1)},drawAnchors(t){const e=this.getAnchors(),{config:{width:i},margin:r}=this,a=i-r.left-r.right,o=this,s=this._svg.selectAll("path").data(e,(t,e)=>{const{color:i,alpha:r,time:a,type:o}=t;return`${o}${a}${r}${i}${e}`});s.exit().remove();let n=!1;s.enter().append("path").merge(s).attr("class",t=>["hide","add","active"].filter(e=>t[e]).concat(["anchor"]).join(" ")).attr("index",t=>t.index).attr("type",t=>t.type).attr("d",t=>this.drawAnchor(t)).attr("transform",t=>`translate(${t.time*a}, 0)`).attr("fill",t=>"color"===t.type?d3.rgb(...t.color):d3.rgb(...Array.from({length:3},()=>255*t.alpha))).order().call(d3.drag().filter(["dragstart","drag"]).on("start",function(){const t=d3.select(this).datum();o.update({data:t,operation:"active"})}).on("drag",function(){(d3.event.dx||d3.event.dy)&&(n=!0,o.update({operation:"move"}))}).on("end",function(){n&&(n=!1,o.update({operation:"drop"}))}))},update(t){const{config:{width:e,height:i},margin:r}=this,{data:a,operation:o}=t;switch(o){case"active":{this.gradient.colorKeys.map(t=>{t.active=!1}),this.gradient.alphaKeys.map(t=>{t.active=!1});const{type:t,index:e}=a,i=this.gradient[`${t}Keys`][e];i.active=!0,this.selectedItem=i,this.drawAnchors();break}case"move":{const{type:t,index:a}=this._svg.select(".anchor.active").datum(),o=this.gradient[`${t}Keys`],s=o[a],[n,c]=d3.mouse(this._svg.node()),h="color"===t?c<i-r.bottom||c>i:c>r.top||c<0,d=Math.round((n-r.left)/(e-r.left-r.right)*100)/100,l=Math.max(Math.min(d,1),0);if(s.time=l,s.hide&&h)return;s.hide=o.length>1&&h,this.drawAnchors(),this.drawStops();break}case"drop":{const{type:t,index:a}=this._svg.select(".anchor.active").datum(),o=this.gradient[`${t}Keys`],s=o[a],[n,c]=d3.mouse(this._svg.node()),h="color"===t?c<i-r.bottom||c>i:c>r.top||c<0,d=Math.round((n-r.left)/(e-r.left-r.right)*100)/100,l=Math.max(Math.min(d,1),0);if(s.time=l,s.hide=o.length>1&&h,s.hide)o.splice(a,1),this.selectedItem=null;else{const t=[...new Set(o.map(t=>t.time))];if(o.length>t.length){let t;for(const[e,i]of o.entries())if(i.time===l&&e!==a){t=e;break}o.splice(t,1)}}this.drawAnchors(),this.drawStops();break}case"create":{const[t,a]=d3.mouse(this._svg.node());if(a>r.top&&a<i-r.bottom)return!1;const o=a>r.top?"color":"alpha",s=this.gradient[`${o}Keys`],n=s.length;if(n>=this.config[`${o}Length`])return!1;const c=Math.round((t-r.left)/(e-r.left-r.right)*100)/100,h={time:Math.max(Math.min(c,1),0),type:o,[o]:"color"===o?[...this.config.defaultColor]:this.config.defaultAlpha,index:n};return s.push(h),this.drawStops(),this.update({data:h,operation:"active"}),!0}case"assign":{const{type:t,value:e}=a;if("mode"===t)return this.gradient.mode=parseInt(e,10),this.drawStops();if(this.selectedItem){switch(t){case"time":this.selectedItem.time=e/100;break;case"alpha":this.selectedItem.alpha=Math.floor(100*e/255)/100;break;case"color":this.selectedItem.color=e.slice(0,-1)}this.drawAnchors(),this.drawStops()}break}}},resize(){const t=this,e=this.$el.querySelector(".gradient");this.config.width=e.clientWidth;const{config:{width:i,height:r},margin:a}=this,o=i-a.left-a.right,s=r-a.top-a.bottom;this._svg?(this._svg.attr("width",i),this._rect.attr("width",o).attr("height",s).attr("fill","url(#grad)")):(this._svg=d3.select(e).append("svg").attr("width",i).attr("height",r),this._grad=this._svg.append("defs").append("linearGradient").attr("id","grad").attr("x1","0").attr("x2","100%").attr("y1","0").attr("y2",0),this._rect=this._svg.append("rect").attr("class","canvas").attr("x",a.left).attr("y",a.top).attr("width",o).attr("height",s).attr("fill","url(#grad)"));let n=!1;this._svg.call(d3.drag().on("start",function(){n=t.update({operation:"create"})}).on("drag",function(){n&&t.update({operation:"move"})}).on("end",function(){n&&(n=!1,t.update({operation:"drop"}))})),this.drawStops(),this.drawAnchors()},drawAnchor(t){const{margin:e,config:{height:i,anchorWidth:r,anchorHeight:a}}=this,{type:o}=t,s="color"===o,n=e.left,c=s?i-e.bottom:e.top,h=s?1:-1;return`M${n} ${c}\n                    L${n-r/2} ${c+a/3*h}\n                    ${n-r/2} ${c+a*h}\n                    ${n+r/2} ${c+a*h}\n                    ${n+r/2} ${c+a/3*h}z`}}}),Editor.Message.send("inspector","gradient-state",!0)}async function beforeClose(){}async function close(){Editor.Message.send("inspector","gradient-state",!1)}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/gradient-editor.html"),"utf8"),exports.fonts=[{name:"inspector"}],exports.$={content:".gradient-editor"},exports.methods={data(t){t&&(cache=t,vm.init({colorKeys:t.colorKeys,alphaKeys:t.alphaKeys,mode:t.mode}))}},exports.listeners={resize(){vm&&vm.resize()}},window.addEventListener("resize",()=>{vm.resize()}),exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;