"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.listeners=exports.methods=exports.$=exports.fonts=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),curve_control_1=__importDefault(require("./curve-control")),grid_1=__importDefault(require("./grid")),Vue=require("vue/dist/vue.js"),{drawHermite:drawHermite,DEFAULT_KEYFRAMES:DEFAULT_KEYFRAMES}=require("./utils");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null;const AXIS_MARGIN=40;async function ready(e){vm=new Vue({el:(panel=this).$.content,data:{domReady:!1,scale:1,showPresets:!1,showMulti:!1,currentPoint:null,mainCtx:null,gridCtx:null,ctrlCxt:null,dump:{keyFrames:DEFAULT_KEYFRAMES[0]},axis:{piece:10,rangeX:1,rangeY:1},ctrlConfig:{fillColor:"red",strokeStyle:"white",radius:2,lineWidth:1,handlerSize:40,focusColor:"rgba(245, 240, 32, 0.44)"},curveConfig:{strokeStyle:"red",lineWidth:.1},defaultKeyFrames:DEFAULT_KEYFRAMES,toolCanvas:[],isReady:!1,toolCanvasSize:{w:30,h:30}},computed:{multiplier(){const e=this;return e.dump.multiplier?e.dump.radian?Number((180*e.dump.multiplier/Math.PI).toFixed(2)):e.dump.multiplier:1}},async mounted(){panel.clientWidth&&(this.init(),this.domReady=!0)},methods:{T:e=>Editor.I18n.t(e),updateToolCanvasSize(){this.toolCanvasSize={w:this.mainCtx.canvas.width/10,h:this.mainCtx.canvas.height/5}},rePaint(){this.initCanvas(),this.curveControl.rePaint(),this.drawThumb(this.$refs.tools,this.defaultKeyFrames)},init(){panel.clientWidth&&panel.clientHeight&&(this.initCanvas(),this.drawGrid(),this.drawCurve(),this.isReady=!0)},onMulti(e){let t=e.target.value;0!==e.target.value&&(this.grid.multiplier=t,this.dump.radian&&(t=t/180*Math.PI),this.dump.multiplier=t,Editor.Message.send("inspector","curve-change",this.dump))},onTools(e){const t=e.target.getAttribute("index");t&&(this.dump.keyFrames=this.defaultKeyFrames[t],this.curveControl.update(this.dump.keyFrames,this.dump.negative),Editor.Message.send("inspector","curve-change",this.dump))},onShowPresets(e){this.showPresets=!0;const{offsetX:t,offsetY:i}=e.target;this.drawThumb(this.$refs.presets,this.defaultKeyFrames)},checkAndUpdate(e){e&&((!Array.isArray(e.value.keyFrames)||e.value.keyFrames.length<1)&&(!e&&(e={}),e.keyFrames=DEFAULT_KEYFRAMES[0]),this.dump=e.value,this.dump.key=e.key,this.dump.name=e.name,this.dump.negative=e.negative,this.dump.radian=e.radian,"number"!=typeof e.multiplier?this.dump.multiplier=1:(this.dump.multiplier=e.multiplier,this.showMulti=!0),this.grid.multiplier=this.multiplier,this.curveControl.update(this.dump.keyFrames,e.negative),this.drawThumb(this.$refs.tools,this.defaultKeyFrames))},drawThumb(e,t){t.map((i,s)=>{let r;this.toolCanvas.length!==t.length?((r=document.createElement("canvas")).setAttribute("index",String(s)),e.append(r),this.toolCanvas.push(r)):r=this.toolCanvas[s],this.resizeCanvas([r],this.toolCanvasSize);const a=r.getContext("2d");a.strokeStyle="white",drawHermite(i,a,this.dump.negative)})},initCanvas(){this.gridCtx=this.$refs.gridCanvas.getContext("2d"),this.mainCtx=this.$refs.mainCanvas.getContext("2d"),this.ctrlCxt=this.$refs.controlCanvas.getContext("2d"),this.resizeCanvas([this.gridCtx.canvas,this.mainCtx.canvas,this.ctrlCxt.canvas],{w:panel.clientWidth,h:.8*panel.clientHeight-40}),this.updateToolCanvasSize()},resizeCanvas(e,t){for(const i of e)i.width=t.w,i.height=t.h},drawCurve(){this.curveControl=new curve_control_1.default({context:this.ctrlCxt,mainCtx:this.mainCtx,grid:this.grid,ctrlConfig:this.ctrlConfig,curveConfig:this.curveConfig}),this.curveControl.on("change",e=>{this.dump.keyFrames=e.keyFrames,Editor.Message.send("inspector","curve-change",this.dump)})},onWrapMode(e){const t=e.target.getAttribute("name");this.dump[t]=parseInt(e.target.value),Editor.Message.send("inspector","curve-change",this.dump)},drawGrid(){const e={context:this.gridCtx,axisMargin:AXIS_MARGIN,lineWidth:1,axis:this.axis,multiplier:this.multiplier};this.grid=new grid_1.default(e),this.grid.draw()},onMouseWheel(e){e.stopPropagation();const{wheelDelta:t}=e,i=this.scale/100*Math.pow(2,.002*t);this.scale=Math.ceil(100*i)}}}),Editor.Message.send("inspector","curve-state",!0),localStorage.getItem("curve-dump")&&e&&(e.name+="(disconnect)",vm.checkAndUpdate(e))}async function beforeClose(){}async function close(){Editor.Message.send("inspector","curve-state",!1)}exports.style=fs_1.readFileSync(path_1.join(__dirname,"../index.css"),"utf8"),exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../static","/template/curve-editor.html"),"utf8"),exports.fonts=[{name:"inspector"}],exports.$={content:".curve-editor"},exports.methods={currentKeys(e){vm&&(vm.domReady||(vm.init(),vm.domReady=!0),vm.checkAndUpdate(e),localStorage.setItem("curve-dump",e))}},exports.listeners={resize(){vm&&(vm.isReady||vm.init(),vm.rePaint())},show(){vm.domReady||(vm.init(),vm.domReady=!0)}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;