"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.scrolls=exports.expands=void 0;const Vue=require("vue/dist/vue"),{get:get}=require("lodash");Vue.config.productionTip=!1,Vue.config.devtools=!1;let subEditUuids=[],subEditUuidsDiff=[],subEditUuidsBreaking=!1;async function init(e){const t=await Editor.Profile.getConfig("inspector","panel.label_width"),s=new Vue({el:e,data:{leftPercentage:t,loading:!1,type:Editor.Project.type,style:{"--prop-name-width":0},state:{db:"close",scene:"close"},item:{type:"",uuids:[]},sureitem:{type:"",uuids:[]},width:0,height:0,language:"default",lock:!1,mode:"",materialUuids:{},subEditUuids:[],copiedComponent:{type:"",dump:null},copiedNode:{attrs:["position","rotation","scale","layer"],dump:null},history:{allow:["node","asset"],current:null,forwards:[],backwards:[]}},watch:{item:{deep:!0,async handler(e){const t=this,s=Editor.Selection.getLastSelectedType(),i=Editor.Selection.getLastSelected(s);let r;return t.$refs.node&&!t.$refs.node.uuids.includes(i)&&!1===(r=await t.$refs.node.break())?(Editor.Selection.clear("node"),void Editor.Selection.select("node",t.$refs.node.uuids)):t.$refs.asset&&!t.$refs.asset.uuids.includes(i)&&!1===(r=await t.$refs.asset.break())?(Editor.Selection.clear("asset"),void Editor.Selection.select("asset",t.sureitem.uuids)):void(JSON.stringify(e)!==JSON.stringify(t.sureitem)&&(t.sureitem=JSON.parse(JSON.stringify(e))))}},materialUuids:{deep:!0,async handler(){const e=this;subEditUuids=[];for(const t in e.materialUuids)e.materialUuids[t]&&subEditUuids.push(t);if(subEditUuids.length?e.mode="both":e.mode="",e.$refs.node){for(const t of e.subEditUuids)subEditUuids.includes(t)||subEditUuidsDiff.includes(t)||subEditUuidsDiff.push(t);try{if(!subEditUuidsBreaking&&subEditUuidsDiff.length){for(const t of subEditUuidsDiff){const s=e.$refs.node.$refs[t];s&&s[0]&&(subEditUuidsBreaking=!0,await s[0].break())}subEditUuidsBreaking=!1,subEditUuidsDiff=[]}}catch(e){console.error(e),subEditUuidsBreaking=!1,subEditUuidsDiff=[]}}subEditUuidsBreaking||(e.subEditUuids=subEditUuids)}}},methods:{t:e=>Editor.I18n.t(`inspector.${e}`),resize(){const e=this,t=e.$el.getBoundingClientRect();e.width=t.width,e.height=t.height,e.width&&(e.style["--prop-name-width"]=`${(e.width-12)*e.leftPercentage}px`)},reset(e){const t=e.target,s=t.getAttribute("default");void 0!==s&&null!==s&&(t.setAttribute("value",s),t.dispatch&&t.dispatch("change"))},toggleLock(){if(s.lock=!s.lock,!s.lock){const e=Editor.Selection.getLastSelectedType(),t=Editor.Selection.getSelected(e);s.item.type=e,s.item.uuids=t}},record(e,t){const{allow:i,forwards:r,backwards:o,current:n}=s.history;if(!i.includes(e))return;const d=JSON.stringify(t);n&&e===n.type&&d===JSON.stringify(n.uuids)||(o.unshift(s.history.current),s.history.forwards=[],s.history.current={type:e,uuids:t},o.length>100&&o.pop())},forward(){const{forwards:e,backwards:t}=s.history;t.unshift(s.history.current),s.history.current=e.shift(),s.reselect("forward")},backward(){const{forwards:e,backwards:t}=s.history;e.unshift(s.history.current),s.history.current=t.shift(),s.reselect("backward")},async reselect(e){if(!s.history.current)return Editor.Selection.clear("node"),void Editor.Selection.clear("asset");const{type:t}=s.history.current;if("node"===t){const t=[];for(const e of s.history.current.uuids){const s=await Editor.Message.request("scene","query-node",e);s&&s.parent.value.uuid&&t.push(e)}if(0===t.length)return void s[e]();s.history.current.uuids=t}const{uuids:i}=s.history.current;Editor.Selection.clear(t),Editor.Selection.select(t,i)},rebase(){const{forwards:e,backwards:t}=s.history;e.length=0,t.length=0},expand(e,t=!1){if(!Array.isArray(s.sureitem.uuids)||!s.sureitem.uuids[0])return t;if("string"==typeof e){const s=exports.expands[e];return void 0!==s?s:t}const i=e.target,r=i.getAttribute("expand-key")||"",o=i.hasAttribute("expand");return exports.expands[r]=o,o},scroll(e){const t={scrollHeight:0,scrollLeft:0,scrollTop:0};if("string"==typeof e){const s=exports.scrolls[e];return void 0!==s?s:t}let s=e.target||e.path[0];const i=s.getAttribute("expand-key")||s.getAttribute("scroll-key")||"";exports.scrolls[i]||(exports.scrolls[i]=t);const r=exports.scrolls[i];return"ui-section"===s.tagName.toLowerCase()&&(s=s.$content),r.scrollHeight=s.scrollHeight,r.scrollLeft=s.scrollLeft,r.scrollTop=s.scrollTop,r}},components:{asset:require("./components/inspector-3d/asset/index"),node:require("./components/inspector-3d/node/index")},mounted(){window.requestIdleCallback(()=>{let e;this.resize(),this.$refs.container.addEventListener("scroll",t=>{window.clearTimeout(e),e=window.setTimeout(()=>{this.scroll(t)},100)}),new MutationObserver(()=>{const e=s.$refs.container;if(e.firstElementChild&&e.firstElementChild.style){const t=s.scroll(e.getAttribute("scroll-key"));let i=t.scrollHeight;i-=i>20?20:0,e.firstElementChild.style["min-height"]=`${i}px`,e.scrollTo(t.scrollLeft,t.scrollTop),setTimeout(()=>{e&&e.firstElementChild&&(e.firstElementChild.style["min-height"]="0px")},300)}}).observe(this.$refs.container,{characterData:!0,subtree:!0})})}});return s.$on("set-property",e=>{s.$refs.node&&s.$refs.node.dumps.forEach(t=>{if("type"in e&&"value"in e)return void Editor.Message.send("scene","set-property",{uuid:t.uuid.value,path:e.path,dump:{type:e.type,isArray:e.isArray,value:e.value}});const s=e.path.split(".");if(s.length>=2)for(let e=2;e<s.length;e+=2)s.splice(e,0,"value");const i=get(t,s.join("."));"layer"!==e.path||!0!==e.loopChild?Editor.Message.send("scene","set-property",{uuid:t.uuid.value,path:i.path,dump:{type:i.type,isArray:i.isArray,value:i.value}}):Editor.Message.send("scene","set-node-and-children-layer",{uuid:t.uuid.value,dump:{value:i.value}})})}),s}exports.expands={},exports.scrolls={},exports.init=init;