"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.data=exports.watch=exports.methods=exports.components=exports.styles=exports.props=exports.name=exports.template=void 0;const path_1=require("path"),utils_1=require("../../../utils"),importers=["effect","fbx","gltf","image","javascript","typescript","texture","texture-cube","sprite-frame","material","gltf-material","scene","prefab","render-pipeline","auto-atlas"],refusedMulti=["material","render-pipeline"];exports.template=utils_1.readTemplate("inspector-3d/asset/index.html"),exports.name="asset",exports.props=["uuids","language","width","from","expandPrefix","subEditUuids"],exports.styles={},exports.components={"asset-header":require("./public/header")};const defaultComponents={"ins-resize-line":require("../../public/ins-resize-line"),"asset-prop":require("../../public/ins-prop"),"ins-prop":require("../../public/ins-prop"),"ins-unknown":require("../../public/ins-unknown"),"ins-array":require("../../public/ins-array"),"ins-null":require("../../public/ins-null"),"ins-number":require("../../public/ins-number"),"ins-bool":require("../../public/ins-bool"),"ins-string":require("../../public/ins-string"),"ins-size":require("../../public/ins-size"),"ins-vec2":require("../../public/ins-vec2"),"ins-vec3":require("../../public/ins-vec3"),"ins-vec4":require("../../public/ins-vec4"),"ins-mat4":require("../../public/ins-mat4"),"ins-enum":require("../../public/ins-enum"),"ins-color":require("../../public/ins-color"),"ins-rect":require("../../public/ins-rect"),"ins-node":require("../../public/ins-node"),"ins-asset":require("../../public/ins-asset"),"ins-component":require("../../public/ins-component"),"ins-object":require("../../public/ins-object"),"ins-depend":require("../../public/ins-depend"),"ins-animation-curve":require("../../public/ins-animation-curve"),"ins-curve-range":require("../../public/ins-curve-range"),"ins-gradient":require("../../public/ins-gradient"),"ins-gradient-range":require("../../public/ins-gradient-range"),"ins-click-event":require("../../public/ins-click-event"),"ins-skeletal-animation-socket":require("../../public/ins-skeletal-animation-socket"),"ins-spine-animation-socket":require("../../public/ins-spine-animation-socket"),"ins-dragonbones-animation-socket":require("../../public/ins-dragonbones-animation-socket")};function updatePackagesExtension(){Editor.Package.getPackages({enable:!0}).forEach(e=>{if(!e||!e.info.contributions||!e.info.contributions.inspector)return;if("string"!=typeof e.info.contributions.inspector)return;const s=path_1.join(e.path,e.info.contributions.inspector);try{delete require.cache[s];const e=require(s);if(!e.assets||"object"!=typeof e.assets)return void console.error(`The 'assets' property of the extension '${s}' is not correct.`);Object.keys(e.assets).forEach(s=>{importers.includes(s)||importers.push(s),exports.styles[`asset-${s}`]=e.assets[s].style,exports.components[`asset-${s}`]=e.assets[s],exports.components[`asset-${s}`].props=exports.components[`asset-${s}`].props||[],Array.isArray(exports.components[`asset-${s}`].props)&&(exports.components[`asset-${s}`].props.push("infos"),exports.components[`asset-${s}`].props.push("metas"),exports.components[`asset-${s}`].props.push("width")),Object.keys(defaultComponents).forEach(e=>{exports.components[`asset-${s}`].components=exports.components[`asset-${s}`].components||{},exports.components[`asset-${s}`].components[e]=defaultComponents[e]})})}catch(e){console.error(e)}})}function data(){return{dirty:!1,info:null,meta:null,infos:[],metas:[],componentName:null,timer:0,readonly:!1,isDialoging:!1}}async function mounted(){this.isDialoging=!1,await this.refresh()}updatePackagesExtension(),Editor.Package.on("enable",updatePackagesExtension),Editor.Package.on("disable",updatePackagesExtension),exports.methods={async break(e){const s=this;if(s.isDialoging)return!1;if(!s.dirty)return!0;e=e||s.uuids;let t=2;if(await Editor.Profile.getConfig("inspector","asset.auto_save"))t=1;else{s.isDialoging=!0;const i=await Editor.Message.request("asset-db","query-asset-info",e[0]),n=i?Editor.I18n.t("inspector.check_is_saved.assetMessage").replace("${assetName}",i.name):"";t=(await Editor.Dialog.warn(n,{buttons:[Editor.I18n.t("inspector.check_is_saved.abort"),Editor.I18n.t("inspector.check_is_saved.save"),"Cancel"],default:1,cancel:2})).response,s.isDialoging=!1}return 0===t?(s.dirty=!1,await s._onReset(e),!0):1===t&&(await s._onApply(e),!0)},getComponentName:e=>e&&e.length?e.every(e=>e.isDirectory)?"asset-directory":e.some(s=>s.importer!==e[0].importer)?"":importers.includes(e[0].importer)?e.length>1&&-1!==refusedMulti.indexOf(e[0].importers)?"":"asset-"+e[0].importer:"":"",async refresh(e=!1){const s=this;if(!e&&s.dirty){if(!1===await s.break())return}const t=await Promise.all(s.uuids.map(e=>Editor.Message.request("asset-db","query-asset-info",e))),i=await Promise.all(s.uuids.map(e=>Editor.Message.request("asset-db","query-asset-meta",e)));if(s.infos=t.filter(Boolean),s.metas=i.filter(Boolean),s.info=s.infos[0],s.componentName=s.getComponentName(s.infos),exports.styles[s.componentName]){const e=s.$root.$el.previousElementSibling;"STYLE"===e.tagName&&(e.innerHTML=exports.styles[s.componentName])}s.readonly=s.info&&s.info.readonly;const n=s.meta!==s.metas[0];s.meta=s.metas[0],n&&(s.unwatch&&s.unwatch(),s.unwatch=s.$watch("meta",()=>{s.$refs.component.dirty?s.dirty=s.$refs.component.dirty():s.dirty=!0},{deep:!0}),s.dirty=!1)},_onConfirm(){const e=this;e.$refs.component.change&&e.$refs.component.change(),e.$refs.component.dirty?e.dirty=e.$refs.component.dirty():e.dirty=!0},async _onReset(){const e=this;if(e.$refs.component&&e.$refs.component.reset){if(!1===await e.$refs.component.reset())return void(e.dirty=!1)}await e.refresh(!0)},async _onApply(e){const s=this;if(Array.isArray(e)||(e=s.uuids),s.$refs.component&&s.$refs.component.apply){const e=await s.$refs.component.apply();if(!1===e)return;if(!0===e)return void(s.dirty=!1)}s.dirty=!1,s.metas.forEach((s,t)=>{const i=JSON.stringify(s),n=e[t];Editor.Message.request("asset-db","save-asset-meta",n,i),Editor.Message.send("assets","twinkle",n,"shrink")})}},exports.watch={uuids(e,s){JSON.stringify(e)!==JSON.stringify(s)&&this.refresh()}},exports.data=data,exports.mounted=mounted;