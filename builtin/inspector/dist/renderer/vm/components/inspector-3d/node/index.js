"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.destroyed=exports.mounted=exports.computed=exports.data=exports.watch=exports.methods=exports.components=exports.props=exports.name=exports.template=void 0;const event_1=require("../../../event"),utils_1=require("../../../utils");function getComponent(e,t,o=0){for(const s of e)if(s.type===t){if(!(o>0))return s;o--}return null}function data(){return{num:0,dump:null,dumps:[],complist:[],continue:!1,lock:!1}}function mounted(){const e=this;e.refresh(),event_1.on("commit",()=>{e.num++,e.lock=!1})}function destroyed(){event_1.off()}exports.template=utils_1.readTemplate("inspector-3d/node/index.html"),exports.name="node",exports.props=["width","height","uuids","language","subEditUuids"],exports.components={"ins-prop":require("../../public/ins-prop"),comp:require("./comp"),"scene-node":require("./scene"),"prefab-node":require("./prefab"),asset:require("../asset/index")},exports.methods={async break(){const e=this,t=[];if(e.subEditUuids.forEach(o=>{const s=e.$refs[o];s[0]&&s[0].dirty&&t.push(o)}),t.length>0){let o=2;if(await Editor.Profile.getConfig("inspector","asset.auto_save"))o=1;else{o=(await Editor.Dialog.warn(Editor.I18n.t("inspector.check_is_saved.message"),{buttons:[Editor.I18n.t("inspector.check_is_saved.abort"),Editor.I18n.t("inspector.check_is_saved.save"),"Cancel"],default:1,cancel:2})).response}if(2===o)return!1;for(const s of t){const t=e.$refs[s][0];0===o&&await t._onReset(),1===o&&await t._onApply()}return!0}},t(e){return Editor.I18n.t(`inspector.${e}`,this.language)},async refresh(){const e=this;if(e.lock)return void(e.continue=!0);e.lock=!0;const t=++e.num;if(e.uuids&&e.uuids.length)try{let o=!1,s=[];for(const n of e.uuids){let r=await Editor.Message.request("scene","query-node",n);if(r&&(r.isScene?(o=!0,s=[],r=utils_1.transSceneDump(r),s.push(r)):!1===o&&(r=utils_1.translationDump(r),s.push(r))),t!==e.num){s.length=0;break}}s.length>0&&(e.dump=s[0],e.dumps=s)}catch(e){console.error(e)}else e.dump=null;e.lock=!1,e.continue&&(e.continue=!1,e.refresh())},async _onAddComponentMenu(e){const t=this,o=e.target,s=t.uuids[0];if(await Editor.Profile.getConfig("inspector","laboratory.new_add_component")){const o=Date.now();return void Editor.Panel._kitControl.open({$kit:e.path[0],name:"ui-kit.searcher",timestamp:o,type:"add-component",events:{confirm(e,o){Editor.Message.send("scene","snapshot"),t.uuids.forEach(e=>{Editor.Message.send("scene","create-component",{uuid:e,component:o.name})})}}})}const{left:n,bottom:r}=o.getBoundingClientRect(),i=await Editor.Message.request("scene","query-components"),d=Math.round(n+5),a=Math.round(r+5),p={};i.forEach(e=>{if(e.path.startsWith("hidden:"))return;let t=e.path.split("/");const o=(t=t.map(e=>e.startsWith("i18n:")&&Editor.I18n.t("ENGINE."+e.substr(5))||e)).pop();let s=p;t.forEach(e=>{e in s||(s[e]={}),s=s[e]}),s[o]=e}),Editor.Menu.popup({x:d,y:a,menu:function e(t){return Object.keys(t).map(o=>{const n=t[o];return"name"in n?{label:o.replace(/\./g,"-"),click(){Editor.Message.send("scene","snapshot"),Editor.Message.send("scene","create-component",{uuid:s,component:n.name})}}:{label:o.replace(/\./g,"-"),submenu:e(n)}})}(p)})},_onDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},async _onDrop(){const e=this;if(e.dump.isScene)return;const t=[],{additional:o,value:s}=JSON.parse(JSON.stringify(Editor.UI.DragArea.currentDragInfo))||{};if(o&&o.forEach(e=>{"cc.Script"===e.type&&t.push(e.value)}),s&&!t.includes(s)&&t.push(s),t.length){Editor.Message.send("scene","snapshot");for(const o of t){const t=await Editor.Message.request("scene","query-script-name",o);if(t)for(const o of e.uuids)Editor.Message.send("scene","create-component",{uuid:o,component:t})}}},_onClickNodeMenu(e){const t=this,o=t.uuids.length>1,{left:s,bottom:n}=e.target.getBoundingClientRect(),r=Math.round(s+5),i=Math.round(n+5);Editor.Menu.popup({x:r,y:i,menu:[{label:Editor.I18n.t("inspector.menu.reset_node"),enabled:!t.dump.position.readonly&&!t.dump.rotation.readonly&&!t.dump.scale.readonly,click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids)Editor.Message.send("scene","reset-node",{uuid:e})}},{type:"separator"},{label:Editor.I18n.t("inspector.menu.copy_node_value"),enabled:!o,async click(){t.$root.copiedNode.dump=JSON.parse(JSON.stringify(t.dump))}},{label:Editor.I18n.t("inspector.menu.paste_node_value"),enabled:!!t.$root.copiedNode.dump,async click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids)t.$root.copiedNode.attrs.forEach(o=>{Editor.Message.send("scene","set-property",{uuid:e,path:o,dump:t.$root.copiedNode.dump[o]})})}},{type:"separator"},{label:Editor.I18n.t("inspector.menu.paste_component"),enabled:!(!t.$root.copiedComponent.type||!t.$root.copiedComponent.dump),async click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids){await Editor.Message.request("scene","create-component",{uuid:e,component:t.$root.copiedComponent.type});const o=await Editor.Message.request("scene","query-node",e),s=o.__comps__&&o.__comps__.length;if(s){const n=s-1,r=o.__comps__[n];r&&r.type===t.$root.copiedComponent.type&&await Editor.Message.request("scene","set-property",{uuid:e,path:`__comps__.${n}`,dump:t.$root.copiedComponent.dump})}}}},{type:"separator"},{label:Editor.I18n.t("inspector.menu.reset_node_position"),enabled:!t.dump.position.readonly&&JSON.stringify(t.dump.position.value)!==JSON.stringify(t.dump.position.default),click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids)Editor.Message.send("scene","reset-property",{uuid:e,path:"position"})}},{label:Editor.I18n.t("inspector.menu.reset_node_rotation"),enabled:JSON.stringify(t.dump.rotation.value)!==JSON.stringify(t.dump.rotation.default),click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids)Editor.Message.send("scene","reset-property",{uuid:e,path:"rotation"})}},{label:Editor.I18n.t("inspector.menu.reset_node_scale"),enabled:JSON.stringify(t.dump.scale.value)!==JSON.stringify(t.dump.scale.default),click(){Editor.Message.send("scene","snapshot");for(const e of t.uuids)Editor.Message.send("scene","reset-property",{uuid:e,path:"scale"})}}]})}},exports.watch={uuids(){this.refresh()},dumps(){const e=this;if(e.complist=[],e.dump.isScene)return;const t={};e.dump.__comps__.forEach(o=>{let s=[],n=0;const r=o.type||"";r in t?(void 0===t[r]&&(t[r]=-1),n=++t[r]):n=t[r]=0,e.dumps.some(e=>{const t=getComponent(e.__comps__,r,n);return t?(s.push(t),!1):(s=null,!0)}),s&&s.length>0&&e.complist.push(s)})}},exports.data=data,exports.computed={helpUrl:()=>Editor.I18n.t("ENGINE.help.cc.Node")},exports.mounted=mounted,exports.destroyed=destroyed;