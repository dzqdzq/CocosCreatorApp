"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getImageLikeAssetSource=exports.mergeDumps=exports.readTemplate=exports.transSceneDump=exports.translationDump=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),_=require("lodash");function translate(e,t){if(e&&"object"===typeof e){Array.isArray(e)&&e.forEach((e,a)=>{null!==e&&void 0!==e?"object"==typeof e&&(e.name=`[${a}]`,e.path=`${t}.${a}`,translate(e.value,e.path),delete e.displayName):console.warn(`data in node dump (${t} ${a}) is ${e}!`)});for(const a of Object.keys(e)){const r=e[a];null!==r&&void 0!==r?"object"==typeof r&&(r.name=a,r.path=`${t}.${a}`,translate(r.value,r.path)):console.warn(`data in node dump (${t} ${a}) is ${r}!`)}}}function translationDump(e){return e.active.name="Active",e.name.name="Name",e.position.name="Position",e.rotation.name="Rotation",e.scale.name="Scale",e.layer.name="Layer",e.active.path="active",e.name.path="name",e.position.path="position",e.rotation.path="rotation",e.scale.path="scale",e.layer.path="layer",e.__comps__.forEach((e,t)=>{e.name=e.type,e.path=`__comps__.${t}`,translate(e.value,e.path)}),e}function transSceneDump(e){e.active.name="Active",e.name.name="Name";const t=e.autoReleaseAssets;t.name="autoReleaseAssets",t.path="autoReleaseAssets";for(const t of Object.keys(e._globals)){const a=e._globals[t];a.name=t,translate(a.value,`_globals.${t}`)}return e}function readTemplate(e){return e=path_1.join(__dirname,"../../../static/template/components/",e),fs_extra_1.readFileSync(e,"utf8")}function mergeDumps(e){if(!e||0===e.length)return null;const t=e[0],a={uuid:e.map(e=>e&&e.uuid&&e.uuid.value),__type__:t.__type__,__prefab__:t.__prefab__,__comps__:[]},r=["__type__","uuid","parent","__comps__","children","__prefab__"];return Object.keys(t).forEach(t=>{if(-1!==r.indexOf(t))return;const s=[];e.every(e=>{const a=e[t];return s.push(a),!!a})&&(a[t]=merge(s))}),t.__comps__.forEach(t=>{const r=[];e.forEach(e=>{const a=e.__comps__.find(e=>e.type===t.type);a&&r.push(a)}),r.length===e.length&&a.__comps__.push(mergeComponent(r))}),a}function merge(e){const t=e[0],a=t,r=["default","extends"];return Object.keys(t||{}).forEach(s=>{if(-1!==r.indexOf(s))return void(a[s]=t[s]);if("object"==typeof t[s]){const t=e.map(e=>e[s]);return void(a[s]=merge(t))}const n=e.every(e=>t[s]===e[s]);n||"value"!==s&&t.type||(a[s]="-"),n&&(a[s]=t[s])}),a}function mergeComponent(e){const t=e[0],a=t;return Object.keys(t.value).forEach(r=>{if(!t.value[r].visible)return;const s=e.map(e=>JSON.parse(JSON.stringify(e.value[r])));a.value[r]=merge(s)}),a}async function getImageLikeAssetSource(e){switch(e.importer){case"image":case"gltf-embeded-image":return getLibrariedSource(e);case"texture":{const t=e.userData,a=t.imageUuidOrDatabaseUri;if(!a)return"";if(!t.isUuid){const e=await Editor.Message.request("asset-db","query-asset-info",a);return e?e.path:""}return a?getImageLikeAssetSource(await Editor.Message.request("asset-db","query-asset-meta",a)):""}default:return""}}async function getLibrariedSource(e){const t=await Editor.Message.request("asset-db","query-asset-info",e.uuid);if(!t)return;const a=t.library,r=Object.keys(a).find(e=>".json"!==e);return r?a[r]:""}exports.translationDump=translationDump,exports.transSceneDump=transSceneDump,exports.readTemplate=readTemplate,exports.mergeDumps=mergeDumps,exports.getImageLikeAssetSource=getImageLikeAssetSource;