"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.networkDialogMap=exports.dialogMap=void 0,exports.isExpired=isExpired,exports.checkInternetConnection=checkInternetConnection,exports.updateCachedFormInfos=updateCachedFormInfos,exports.handleNetworkStatus=handleNetworkStatus,exports.queryInfo=queryInfo,exports.openDialog=openDialog;const electron_1=require("electron"),querystring_1=require("querystring"),path_1=require("path"),url_1=require("url"),default_cache_time=(exports.dialogMap={},exports.networkDialogMap={},864e5);async function isExpired(e){var o=await Editor.Profile.getConfig("utils","information.cache_time")||default_cache_time;return Date.now()-e>o}async function checkInternetConnection(){return Editor.Network.__protected__.testConnectServer()}async function updateCachedFormInfos(e){if(e){var o=await Editor.Profile.getProject("information","information")||{};for(const r in o){var t=o[r];t.id===e.id&&(t[t.id].complete=e[e.id].complete,await Editor.Profile.setProject("information","information."+r,t))}}}async function handleNetworkStatus(e,o){var t,o=e.data&&e.data.id||o;return o&&exports.networkDialogMap[o]&&0<exports.networkDialogMap[o].length?{action:"reject"}:"network_failure"===e.status?(t=Date.now(),await openNetworkDialog((0,url_1.pathToFileURL)((0,path_1.join)(__dirname,"../../static/network-failure.html")).toString(),"network_failure",o),10<(Date.now()-t)/1e3?{action:"resolve"}:{action:"reject"}):"network_exception"===e.status?(await openNetworkDialog((0,url_1.pathToFileURL)((0,path_1.join)(__dirname,"../../static/network-exception.html")).toString(),"network_exception",o),{action:"reject"}):{action:"resolve"}}async function queryInfo(e){try{var o=await Editor.Profile.getConfig("utils","information.url"),t={form:e||"",uid:(await Editor.User.getData()).cocos_uid,pid:Editor.Project.uuid,ver:Editor.App.version,lang:Editor.I18n.getLanguage()},r=await Editor.Network.get(o,t);return JSON.parse(r.toString())}catch(e){return console.debug("[information] Query information:",e),null}}async function openDialog(e,o,t=""){var r=await Editor.User.getData();(o=o||{}).uid=r.cocos_uid,o.pid=Editor.Project.uuid,o.ver=Editor.App.version,o.lang=Editor.I18n.getLanguage();const i=electron_1.BrowserWindow.getFocusedWindow(),n=new electron_1.BrowserWindow({autoHideMenuBar:!0});i&&n!==i&&!i.isDestroyed()&&n.webContents.on("dom-ready",()=>{!n.isDestroyed()&&i&&n.setParentWindow(i)});let a=e;return/\?/.test(e)?a+="&"+(0,querystring_1.stringify)(o||{}):a+="?"+(0,querystring_1.stringify)(o||{}),n.loadURL(a),t&&(exports.dialogMap[t]?exports.dialogMap[t].push(n.id):exports.dialogMap[t]=[n.id]),new Promise(o=>{n.on("closed",()=>{var e;exports.dialogMap[t]&&exports.dialogMap[t].length&&-1!==(e=exports.dialogMap[t].indexOf(n.id))&&exports.dialogMap[t].splice(e,1),o(void 0)})})}function openNetworkDialog(e,o,t=""){const r=electron_1.BrowserWindow.getFocusedWindow(),i=new electron_1.BrowserWindow({autoHideMenuBar:!0}),n=(r&&i!==r&&!r.isDestroyed()&&i.webContents.on("dom-ready",()=>{!i.isDestroyed()&&r&&i.setParentWindow(r)}),i.loadURL(e),t||o);return exports.networkDialogMap[n]||(exports.networkDialogMap[n]=[]),exports.networkDialogMap[n].push(i.id),new Promise(t=>{i.on("closed",()=>{var e,o=exports.networkDialogMap[n];o&&o.length&&-1!==(e=o.indexOf(i.id))&&o.splice(e,1),t(void 0)})})}