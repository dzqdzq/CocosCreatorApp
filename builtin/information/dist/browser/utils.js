"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openDialog=exports.queryInfo=exports.handleNetworkStatus=exports.updateCachedFormInfos=exports.checkInternetConnection=exports.isExpired=exports.networkDialogMap=exports.dialogMap=void 0;const electron_1=require("electron"),querystring_1=require("querystring"),path_1=require("path"),url_1=require("url");exports.dialogMap={},exports.networkDialogMap={};const default_cache_time=864e5;async function isExpired(e){const t=await Editor.Profile.getConfig("utils","information.cache_time")||default_cache_time;return Date.now()-e>t}async function checkInternetConnection(){return await Editor.Network.__protected__.testConnectServer()}async function updateCachedFormInfos(e){if(!e)return;const t=await Editor.Profile.getProject("information","information")||{};for(const o in t){const r=t[o];r.id===e.id&&(r[r.id].complete=e[e.id].complete,await Editor.Profile.setProject("information",`information.${o}`,r))}}async function handleNetworkStatus(e,t){const o=e.data&&e.data.id||t;if(o&&exports.networkDialogMap[o]&&exports.networkDialogMap[o].length>0)return{action:"reject"};if("network_failure"===e.status){const e=Date.now(),t=(0,url_1.pathToFileURL)((0,path_1.join)(__dirname,"../../static/network-failure.html")).toString();return await openNetworkDialog(t,"network_failure",o),(Date.now()-e)/1e3>10?{action:"resolve"}:{action:"reject"}}if("network_exception"===e.status){const e=(0,url_1.pathToFileURL)((0,path_1.join)(__dirname,"../../static/network-exception.html")).toString();return await openNetworkDialog(e,"network_exception",o),{action:"reject"}}return{action:"resolve"}}async function queryInfo(e){try{const t=await Editor.Profile.getConfig("utils","information.url"),o=await Editor.User.getData(),r={form:e||"",uid:o.cocos_uid,pid:Editor.Project.uuid,ver:Editor.App.version,lang:Editor.I18n.getLanguage()},n=await Editor.Network.get(t,r);return JSON.parse(n.toString())}catch(e){return console.debug("[information] Query information:",e),null}}async function openDialog(e,t,o=""){const r=await Editor.User.getData();(t=t||{}).uid=r.cocos_uid,t.pid=Editor.Project.uuid,t.ver=Editor.App.version,t.lang=Editor.I18n.getLanguage();const n=electron_1.BrowserWindow.getFocusedWindow(),i=new electron_1.BrowserWindow({autoHideMenuBar:!0});n&&i!==n&&!n.isDestroyed()&&i.webContents.on("dom-ready",()=>{!i.isDestroyed()&&n&&i.setParentWindow(n)});let a=e;return/\?/.test(e)?a+="&"+(0,querystring_1.stringify)(t||{}):a+="?"+(0,querystring_1.stringify)(t||{}),i.loadURL(a),o&&(exports.dialogMap[o]?exports.dialogMap[o].push(i.id):exports.dialogMap[o]=[i.id]),new Promise(e=>{i.on("close",()=>{if(exports.dialogMap[o]&&exports.dialogMap[o].length){const e=exports.dialogMap[o].indexOf(i.id);-1!==e&&exports.dialogMap[o].splice(e,1)}e(void 0)})})}function openNetworkDialog(e,t,o=""){const r=electron_1.BrowserWindow.getFocusedWindow(),n=new electron_1.BrowserWindow({autoHideMenuBar:!0});r&&n!==r&&!r.isDestroyed()&&n.webContents.on("dom-ready",()=>{!n.isDestroyed()&&r&&n.setParentWindow(r)}),n.loadURL(e);const i=o||t;return exports.networkDialogMap[i]||(exports.networkDialogMap[i]=[]),exports.networkDialogMap[i].push(n.id),new Promise(e=>{n.on("close",()=>{const t=exports.networkDialogMap[i];if(t&&t.length){const e=t.indexOf(n.id);-1!==e&&t.splice(e,1)}e(void 0)})})}exports.isExpired=isExpired,exports.checkInternetConnection=checkInternetConnection,exports.updateCachedFormInfos=updateCachedFormInfos,exports.handleNetworkStatus=handleNetworkStatus,exports.queryInfo=queryInfo,exports.openDialog=openDialog;