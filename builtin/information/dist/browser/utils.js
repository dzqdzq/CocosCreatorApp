"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openDialog=exports.queryInfo=exports.handleNetworkStatus=exports.updateCachedFormInfos=exports.checkInternetConnection=exports.isExpired=exports.dialogMap=void 0;const electron_1=require("electron"),querystring_1=require("querystring"),path_1=require("path");exports.dialogMap={};const default_cache_time=864e5;async function isExpired(e){const t=await Editor.Profile.getConfig("utils","information.cache_time")||default_cache_time;return Date.now()-e>t}async function checkInternetConnection(){return await Editor.Network.__protected__.testConnectServer()}async function updateCachedFormInfos(e){if(!e)return;const t=await Editor.Profile.getProject("information","information")||{};for(const o in t){const r=t[o];r.id===e.id&&(r[r.id].complete=e[e.id].complete,await Editor.Profile.setProject("information",`information.${o}`,r))}}async function handleNetworkStatus(e){if("network_failure"===e.status){const e=Date.now();return await openDialog((0,path_1.join)(__dirname,"../../static/network-failure.html")),(Date.now()-e)/1e3>10?{action:"resolve"}:{action:"reject"}}return"network_exception"===e.status?(await openDialog((0,path_1.join)(__dirname,"../../static/network-exception.html")),{action:"reject"}):{action:"resolve"}}async function queryInfo(e){try{const t=await Editor.Profile.getConfig("utils","information.url"),o=await Editor.User.getData(),r={form:e||"",uid:o.cocos_uid,pid:Editor.Project.uuid,ver:Editor.App.version,lang:Editor.I18n.getLanguage()},n=await Editor.Network.get(t,r);return JSON.parse(n.toString())}catch(e){return console.debug("[information] Query information:",e),null}}async function openDialog(e,t,o=""){const r=await Editor.User.getData();(t=t||{}).uid=r.cocos_uid,t.pid=Editor.Project.uuid,t.ver=Editor.App.version,t.lang=Editor.I18n.getLanguage();const n=electron_1.BrowserWindow.getFocusedWindow(),i=new electron_1.BrowserWindow({autoHideMenuBar:!0});n&&i!==n&&!n.isDestroyed()&&i.webContents.on("dom-ready",()=>{i.setParentWindow(n)});let a=e;return/\?/.test(e)?a+="&"+(0,querystring_1.stringify)(t||{}):a+="?"+(0,querystring_1.stringify)(t||{}),i.loadURL(a),o&&(exports.dialogMap[o]?exports.dialogMap[o].push(i.id):exports.dialogMap[o]=[i.id]),new Promise(e=>{i.on("close",()=>{if(exports.dialogMap[o]&&exports.dialogMap[o].length){const e=exports.dialogMap[o].indexOf(i.id);-1!==e&&exports.dialogMap[o].splice(e,1)}e(void 0)})})}exports.isExpired=isExpired,exports.checkInternetConnection=checkInternetConnection,exports.updateCachedFormInfos=updateCachedFormInfos,exports.handleNetworkStatus=handleNetworkStatus,exports.queryInfo=queryInfo,exports.openDialog=openDialog;