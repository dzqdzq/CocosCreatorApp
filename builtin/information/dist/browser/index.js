"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const electron_1=require("electron"),utils_1=require("./utils");async function load(){const t=await Editor.Profile.getProject("information","information"),o=await Editor.Profile.getConfig("utils","information.timestamp");if(t){if(!o||await(0,utils_1.isExpired)(o)){const o=await exports.methods.queryAllInformation();if(Object.keys(o).length)await Editor.Profile.setProject("information","information",o);else for(const o in t){const t=await exports.methods.queryInformation(o);t&&"success"===t.status&&t.data&&await Editor.Profile.setProject("information",`information.${o}`,t.data)}await Editor.Profile.setConfig("utils","information.timestamp",Date.now())}}else{const t=await exports.methods.queryAllInformation();if(Object.keys(t).length)await Editor.Profile.setProject("information","information",t),await Editor.Profile.setConfig("utils","information.timestamp",Date.now());else{const t=await Editor.Profile.getConfig("utils","information.features");let o=!1;for(const i in t)if(t[i]){const t=await exports.methods.queryInformation(i);t&&"success"===t.status&&t.data&&(await Editor.Profile.setProject("information",`information.${i}`,t.data),o=!0)}o&&await Editor.Profile.setConfig("utils","information.timestamp",Date.now())}}!await Editor.Profile.getConfig("utils","network_connected")&&await(0,utils_1.checkInternetConnection)()&&Editor.Profile.setConfig("utils","network_connected",!0)}async function unload(){}exports.methods={async queryAllInformation(){const t=await(0,utils_1.queryInfo)();return t&&t.result,{}},async queryInformation(t,o){if(!1===(await Editor.Profile.getConfig("utils","information.features"))[t])return null;const i=await(0,utils_1.checkInternetConnection)(),e=await Editor.Profile.getConfig("utils","network_connected");if(!i&&!e)return null;const a=await Editor.Profile.getProject("information",`information.${t}`);if(!(null===o||void 0===o?void 0:o.force)&&a)return{status:"cache",data:a};if(!i)return{status:"network_failure"};const r=await(0,utils_1.queryInfo)(t);if(!r)return{status:"network_exception"};const n=r.result.id||t;return{status:"success",data:{id:n,label:r.result.label||t,enable:!!r.result.enable,[n]:{complete:!!r.result.complete,form:r.result.form||""}}}},async openInformationDialog(t,o){let i=await Editor.Profile.getProject("information",`information.${t}`);const e=await exports.methods.queryInformation(t,{force:!0});if(!i){if(!e)return{action:"resolve"};if("network_failure"===e.status||"network_exception"===e.status){if((await Editor.Profile.getConfig("utils","information.features"))[t])return await(0,utils_1.handleNetworkStatus)(e)}if(!e.data)return{action:"resolve"};i=e.data,await Editor.Profile.setProject("information",`information.${t}`,i),await Editor.Profile.setConfig("utils","information.timestamp",Date.now())}if(!i.enable||i[i.id]&&i[i.id].complete)return{action:"resolve"};if(e){if("network_failure"===e.status){await Editor.Profile.removeProject("information",`information.${t}.passByNetworkFailure`);const o=await(0,utils_1.handleNetworkStatus)(e);return"resolve"===o.action&&await Editor.Profile.setProject("information",`information.${t}.passByNetworkFailure`,!0),o}if("network_exception"===e.status){return await(0,utils_1.handleNetworkStatus)(e)}}await(0,utils_1.openDialog)(i[i.id].form,o,t);const a=await exports.methods.queryInformation(t,{force:!0});if("network_failure"===a.status||"network_exception"===a.status)return{action:"unusual"};const r=a.data;return r&&r.enable&&!r[r.id].complete?{action:"reject"}:(await(0,utils_1.updateCachedFormInfos)(r),await Editor.Profile.setConfig("utils","information.timestamp",Date.now()),{action:"resolve"})},hasDialog:t=>!!(t&&utils_1.dialogMap[t]&&utils_1.dialogMap[t].length),closeDialog(t){if(!t||!utils_1.dialogMap[t])return;const o=utils_1.dialogMap[t];utils_1.dialogMap[t]=[],o.forEach(t=>{const o=electron_1.BrowserWindow.fromId(t);null===o||void 0===o||o.close()})}},exports.load=load,exports.unload=unload;