"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=exports.contributions=void 0;const electron_1=require("electron"),querystring_1=require("querystring"),formURLMap={},dialogMap={};async function _openDialog(o,e,t=""){const r=await Editor.User.getData();(e=e||{}).uid=r.cocos_uid,e.pid=Editor.Project.uuid,e.ver=Editor.App.version,e.lang=Editor.I18n.getLanguage();const a=electron_1.BrowserWindow.getFocusedWindow(),n=new electron_1.BrowserWindow({autoHideMenuBar:!0});a&&n!==a&&!a.isDestroyed()&&n.webContents.on("dom-ready",()=>{n.setParentWindow(a)});let i=o;return/\?/.test(o)?i+="&"+(0,querystring_1.stringify)(e||{}):i+="?"+(0,querystring_1.stringify)(e||{}),n.loadURL(i),t&&(dialogMap[t]?dialogMap[t].push(n.id):dialogMap[t]=[n.id]),new Promise(o=>{n.on("close",()=>{if(dialogMap[t]&&dialogMap[t].length){const o=dialogMap[t].indexOf(n.id);-1!==o&&dialogMap[t].splice(o,1)}o(void 0)})})}async function load(){}async function unload(){}exports.contributions={enable(o,e){exports.methods.attach(o,e)}},exports.methods={attach(o,e){o.invalid||e.tags&&Array.isArray(e.tags)&&e.tags.forEach(o=>{exports.methods.queryInfo(o)})},async queryInfo(o){if(formURLMap[o])return formURLMap[o];try{const e=await Editor.Profile.getConfig("utils","information_url"),t=await Editor.User.getData(),r=await Editor.Network.get(e,{form:o,uid:t.cocos_uid,pid:Editor.Project.uuid,ver:Editor.App.version,lang:Editor.I18n.getLanguage()}),a=JSON.parse(r.toString());return formURLMap[o]={enable:!!a.result.enable,complete:!!a.result.complete,form:a.result.form}}catch(o){return null}},async queryInformation(o,e){e&&e.force&&delete formURLMap[o];const t=await exports.methods.queryInfo(o);return t?{enable:!!t.enable,complete:!!t.complete,form:t.form||""}:null},hasDialog:o=>!!(o&&dialogMap[o]&&dialogMap[o].length),closeDialog(o){if(!o||!dialogMap[o])return;const e=dialogMap[o];dialogMap[o]=[],e.forEach(o=>{const e=electron_1.BrowserWindow.fromId(o);null===e||void 0===e||e.close()})},async informationDialog(o,e){if(formURLMap[o]||await exports.methods.queryInfo(o),!formURLMap[o])return{action:"unusual"};const t=formURLMap[o];if(!t.enable)return{action:"cancel"};if(t.complete)return{action:"resolve"};const r=Object.assign({},formURLMap[o]);return await _openDialog(t.form,e,o),delete formURLMap[o],await exports.methods.queryInfo(o),formURLMap[o]?formURLMap[o].enable?formURLMap[o].complete?{action:"resolve"}:{action:"reject"}:{action:"cancel"}:(formURLMap[o]=r,{action:"unusual"})}},exports.load=load,exports.unload=unload;