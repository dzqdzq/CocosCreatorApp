"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.style=exports.template=void 0;const fs_1=require("fs"),path_1=require("path"),section=__importStar(require("./comps/section")),ipc=require("@base/electron-base-ipc"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1,exports.template=fs_1.readFileSync(path_1.join(__dirname,"../../../static","/template/panels/searcher.html"),"utf8"),exports.style=fs_1.readFileSync(path_1.join(__dirname,"../../../dist/searcher.css"),"utf8");let vm=null,panel=null;const allowCreateAssetTypes=["cc.Script","cc.RenderPipeline","cc.AnimationClip","cc.EffectAsset","cc.Material","cc.PhysicsMaterial","cc.RenderTexture","cc.SceneAsset","cc.SpriteAtlas","cc.TerrainAsset","cc.TextureCube"];let DataDumpCache=[];const maxLinesNumber=50;async function ready(){vm=new Vue({el:(panel=this).$.content,data:{loading:!0,search:"",selected:null,type:"",ccType:"",dataDump:null,dataDumpShowNumber:maxLinesNumber},components:{"data-section":section},computed:{expand(){return!!this.search}},watch:{selected(){const e=this.$refs.main.querySelector(".line[selected]");if(e&&e.removeAttribute("selected"),!this.selected)return;const t=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');t&&(t.setAttribute("selected",!0),t.scrollIntoViewIfNeeded(),t.parentNode&&!t.parentNode.expand&&(t.parentNode.expand=!0))}},methods:{t:e=>Editor.I18n.t(`ui-kit.searcher.${e}`),async updateData(e,t){const a=this;switch(a.$refs.searchInput.value="",a.type!==e&&(a.dataDump=null,a.dataDumpShowNumber=maxLinesNumber),a.type=e,a.ccType=t,a.type){case"add-component":await a.addComponentsInit();break;case"node":await a.searchNodeInit();break;case"component":a.ccType=await getExtendsClass(t),await a.searchComponentsInit();break;case"asset":a.ccType=await getExtendsClass(t),await a.searchAssetsInit();break;case"script":await a.searchScriptInit()}},async addComponentsInit(){(DataDumpCache=await Editor.Message.request("scene","query-components")).sort((e,t)=>{const a=e.path.match(/\//g).length,s=t.path.match(/\//g).length;return a===s?e.path.localeCompare(t.path):a-s}),this.dataDump=sortCompDump(DataDumpCache)},async searchComponentsInit(){const e=await Editor.Message.request("scene","query-node-tree");(DataDumpCache=sortNodeCompDump(e,this.ccType.split(","))).sort((e,t)=>e.name.localeCompare(t.name)),this.dataDump=DataDumpCache,this.selected=null},async searchAssetsInit(){const e=[],t=this.ccType.split(",");for(const a of t){const t=await Editor.Message.request("asset-db","query-assets",{ccType:a.trim()});for(let a=0;a<t.length;a++)e.push(t[a])}DataDumpCache=[];for(const t of e){const e=await getAssetIconInfo(t),a=t.displayName||t.name,s={type:t.type,name:a,uuid:t.uuid,path:t.url,sort:a+t.url,iconInfo:e};DataDumpCache.push(s)}DataDumpCache.sort((e,t)=>e.sort.localeCompare(t.sort)),this.dataDump=DataDumpCache,this.dataDumpShowNumber=maxLinesNumber},async searchNodeInit(){const e=await Editor.Message.request("scene","query-node-tree");DataDumpCache=sortNodeDump(e),this.dataDump=DataDumpCache,this.dataDumpShowNumber=maxLinesNumber},async searchScriptInit(){const e=this,t={excludeSelf:!0,extends:e.ccType};e.ccType&&"string"==typeof e.ccType&&(t.extends=[e.ccType]),(DataDumpCache=await Editor.Message.request("scene","query-classes",t)).sort((e,t)=>e.name.localeCompare(t.name)),e.dataDump=sortScriptDump(DataDumpCache)},onSearch(e){const t=this,a=e.target.value.trim();if(t.search===a)return;t.search=a;let s=DataDumpCache;try{if(t.search){const e=new RegExp(t.search,"i");s=DataDumpCache.filter(t=>{let a=!1;return t.name&&(a=-1!==t.name.search(e)),!a&&t.path&&(a=-1!==t.path.search(e)),a})}}catch(e){}"add-component"===t.type?t.dataDump=sortCompDump(s):("script"===t.type?t.dataDump=sortScriptDump(s):t.dataDump=s,t.dataDumpShowNumber=maxLinesNumber,t.$refs.container.scrollTop=0),window.requestIdleCallback(()=>{s&&s.length&&t.search?t.selected=s[0].name:t.selected=null})},searchKeydown(e){e.target.blur();const t=this.getValues();t.length&&(vm.selected=t[0])},getValues(){const e=[];return this.$refs.main.querySelectorAll(".line").forEach(t=>{const a=t.getAttribute("value");a&&e.push(a)}),e},upDownSelect(e){const t=this.getValues();let a=t.indexOf(this.selected)+e;a===t.length&&(a=0),a<=-1&&(a=t.length-1),this.selected=t[a]},enterSelect(){const e=this.$refs.main.querySelector('.line[value="'+this.selected+'"]');e&&e.click()},onSelect(e,t){"string"==typeof e&&(vm.selected=e,vm.search="",Editor.Panel._kitControl.emit("change",vm.timestamp,e,t),Editor.Panel._kitControl.emit("confirm",vm.timestamp,e,t),Editor.Panel._kitControl.hide())},twinkle(e){"asset"===this.type?Editor.Message.send("assets","twinkle",e.uuid):"node"===this.type?Editor.Message.send("hierarchy","twinkle",e.uuid):"component"===this.type&&Editor.Message.send("hierarchy","twinkle",e.nodeUuid)},checkAllowCreate:e=>allowCreateAssetTypes.includes(e),async createAsset(){const e=this;Editor.Panel._kitControl.hold();const t=await Editor.Message.request("asset-db","create-asset-dialog",e.ccType);if(t){const a=await Editor.Message.request("asset-db","query-asset-info",t);if(a)return void e.onSelect(t,a)}Editor.Panel._kitControl.hide()}},mounted(){this.$refs.container.addEventListener("scroll",()=>{const{scrollHeight:e,clientHeight:t,scrollTop:a}=this.$refs.container;e-t-a<100&&this.dataDump&&this.dataDumpShowNumber<this.dataDump.length&&(this.dataDumpShowNumber+=maxLinesNumber)})}}),exports.methods.init()}async function beforeClose(){}async function close(){}exports.$={content:".searcher"},exports.methods={reset(){exports.methods.init()},clear(){vm.loading=!0},async init(){vm.loading=!0;const e=await Editor.Panel._kitControl.getOptionsCache();e&&(await vm.updateData(e.type,e.droppable),vm.selected=e.value,vm.timestamp=e.timestamp,vm.loading=!1,requestAnimationFrame(()=>{vm.$refs.searchInput.focus()}))},up(){vm.upDownSelect(-1)},down(){vm.upDownSelect(1)},enter(){vm.enterSelect()},esc(){vm.$refs.searchInput.focus()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;const imageImporter=["image","texture","sprite-frame"];async function getAssetIconInfo(e){const t={type:"icon",value:"file"};if(!e)return t;if(imageImporter.includes(e.importer)){if(!e.source&&e.fatherInfo){const a=path_1.extname(e.fatherInfo.source).toLowerCase();let s=getLibraryImageSrc(e.fatherInfo.library,a);if(!s&&"texture"===e.importer){t.value=e.importer;const a=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!a||!a.userData||!a.userData.imageUuidOrDatabaseUri)return t;const r=await Editor.Message.request("asset-db","query-asset-info",a.userData.imageUuidOrDatabaseUri);if(!r)return t;const n=path_1.extname(r.name).toLowerCase();s=getLibraryImageSrc(r.library,n)}t.value=s}else{const a=path_1.extname(e.source);t.value=e.library[a]}return t.type="image",t}const a=e.importer;return a?(t.value=a,t):t}function getLibraryImageSrc(e,t){let a=e[t];if(!a){a=e[Object.keys(e).find(e=>".json"!==e)||""]}return a}function sortNodeDump(e,t=[],a){return e?0===e.children.length?t:(e.children.forEach(e=>{let s=a||"";s+=` / ${e.name}`,t.push({name:e.name,type:e.type,uuid:e.uuid,path:s}),e.children.length>0&&sortNodeDump(e,t,s)}),t):t}function sortNodeCompDump(e,t,a=[],s){if(!e)return a;if(0===e.children.length)return a;for(const r of t)e.children.forEach(e=>{let t=s||"";t+=` / ${e.name}`;const n=e.components.find(e=>e.type===r);n&&a.push({name:e.name,uuid:n.value,path:t,nodeUuid:e.uuid,iconName:r}),e.children.length>0&&sortNodeCompDump(e,[r],a,t)});return a}function sortCompDump(e){const t={};for(const a of e){if(a.path.startsWith("hidden:"))continue;const e=a.path.split("/");let s=t;e.forEach((t,r)=>{t.startsWith("i18n:")&&(t=Editor.I18n.t("ENGINE."+t.substr(5))||t),r===e.length-1?s[t]=Object.assign({iconName:a.name||"component"},a):s[t]||(s[t]={}),s=s[t]})}return t}function sortScriptDump(e){const t={};for(const a of e)t[a.name]=Object.assign({iconName:"component"},a);return t}async function getExtendsClass(e){const t=e.split(","),a=[];for(const e of t){if(!e)continue;const t=await Editor.Message.request("scene","query-classes",{extends:e});if(Array.isArray(t)&&t.length)for(const e of t)a.includes(e.name)||a.push(e.name)}return a.join(",")}