"use strict";const{existsSync:existsSync,outputFileSync:outputFileSync,readJsonSync:readJsonSync,readFileSync:readFileSync,removeSync:removeSync}=require("fs-extra"),{join:join,extname:extname,basename:basename}=require("path"),{parse:parse}=require("url"),ElectronModule=require("@base/electron-module"),iconMap=readJsonSync(join(__dirname,"./icon-map.json"));async function onDisconnected(){const e=await Editor.Panel._kitControl.getOptionsCache();e&&e.$kit&&e.$kit===this&&Editor.Panel._kitControl.hide()}exports.load=function(){Image.init();const e=require("./ui-components/asset");Editor.UI.register("ui-asset",e),Editor.UI.Asset=e;const t=require("./ui-components/node");Editor.UI.register("ui-node",t),Editor.UI.Node=t;const i=require("./ui-components/component");function n(e){e.target.disabled||e.target.readonly||Editor.Panel._kitControl.open({$kit:this,name:"ui-kit.color-picker",value:this.value,events:{confirm:e=>{this.value=e,this.dispatch("confirm",e)},change:e=>{this.value=e,this.dispatch("change",e)},cancel:e=>{this.value=e,this.dispatch("cancel",e)}}})}function s(e){e.target.disabled||e.target.readonly||Editor.Panel._kitControl.open({$kit:this,name:"ui-kit.gradient-picker",value:this.value,events:{confirm:e=>{this.value=e,this.dispatch("confirm",e)},change:e=>{this.value=e,this.dispatch("change",e)},cancel:e=>{this.value=e,this.dispatch("cancel",e)}}})}function a(){Editor.Panel._kitControl.open({$kit:this,name:"ui-kit.searcher",value:this.value,droppable:this.droppable,type:"asset",events:{confirm:e=>{this.value=e,this.dispatch("confirm",e)},change:e=>{this.value=e,this.dispatch("change",e)},cancel:e=>{this.value=e,this.dispatch("cancel",e)}}})}Editor.UI.register("ui-component",i),Editor.UI.Component=i,Editor.UI.Color.prototype._onConnected=async function(){this.addEventListener("click",n)},Editor.UI.Color.prototype._onDisconnected=async function(e){this.removeEventListener("click",n),onDisconnected.call(this)},Editor.UI.Gradient.prototype._onConnected=function(){this.addEventListener("click",s)},Editor.UI.Gradient.prototype._onDisconnected=function(){this.removeEventListener("click",s),onDisconnected.call(this)},Editor.UI.DragObject.prototype._onConnected=function(){this.addEventListener("type-click",a)},Editor.UI.DragObject.prototype._onDisconnected=function(){this.removeEventListener("type-click",a),onDisconnected.call(this)},Editor.UI.Icon.getIconName=((e,t)=>{const i=Editor.UI.Icon.iconList;switch(e){case"asset":return iconMap.asset[t]?iconMap.asset[t]:"file";case"component":const n=t.match(/cc.([a-zA-z]*)Component/);if(n){let e=n[1].charAt(0).toLowerCase()+n[1].slice(1);if(e=e.replace(/([A-Z])/g,e=>"-"+e.toLowerCase()),i.includes(e))return e}if(iconMap.component[t])return iconMap.component[t]}return null}),Editor.UI.Link.setLinkHandle(async function(e,t){if(!t)return!1;const i=ElectronModule.require("UuidUtils");switch(e=e.trim(),t){case"assetUrl":return e=await Editor.Message.request("asset-db","query-uuid",e),i.isUuid(e)&&Editor.Message.send("assets","twinkle",e),!0;case"assetUuid":return i.isUuid(e)&&Editor.Message.send("assets","twinkle",e),!0;case"nodeUuid":return i.isUuid(e)&&Editor.Message.send("hierarchy","twinkle",e),!0}})},exports.unload=function(){Editor.UI.Image.setNameTranslator(null),Editor.UI.Color.prototype._onConnected=null,Editor.UI.Gradient.prototype._onConnected=null,Editor.UI.Color.prototype._onDisconnected=null,Editor.UI.Gradient.prototype._onDisconnected=null};const Image={dbInfos:{},init(){Editor.UI.Image.setSrcTranslator(async function(e){if(!e)return"";if(e.startsWith("db://")&&(e=await Editor.Message.request("asset-db","query-uuid",e)),ElectronModule.require("UuidUtils").isUuid(e)){const t=await Editor.Message.request("asset-db","query-asset-info",e);return t?-1!==e.indexOf("@")?await Image.subImage(t,this.size):await Image.image(t,this.size):""}return e}),Editor.UI.Image.prototype._onConnected=function(){this.addEventListener("click",Image.bindClick)},Editor.UI.Image.prototype._onDisconnected=function(){this.removeEventListener("click",Image.bindClick)}},bindClick(){Editor.Message.send("assets","twinkle",this.value.trim())},async getThumbnail(e,t){const i=parse(e.path);let n=this.dbInfos[i.host];n||(n=await Editor.Message.request("asset-db","query-db-info",i.host),this.dbInfos[i.host]=n);const s=e.uuid.substr(0,2),a=join(n.temp,s,e.uuid,t);if(existsSync(a)){return readFileSync(a,"utf8")}return a},async setThumbnail(e,t,i={}){const n=document.createElement("img");if(n.src=e,!1===await new Promise(e=>{n.addEventListener("load",()=>{e(n)}),n.addEventListener("error",()=>{e(!1)})}))return"";const s=basename(t).split(","),a=Number(s[0])||n.width,r=Number(s[1])||n.height;let o=i.width||n.width,c=i.height||n.height;const d=o/a,u=c/r,l=document.createElement("canvas");l.width=a,l.height=r;const h=l.getContext("2d");if(i.rotated){const e=l.width/2,t=l.height/2;h.translate(e,t),h.rotate(-90*Math.PI/180),h.translate(-e,-t),o=i.height,c=i.width}h.drawImage(n,i.trimX||0,i.trimY||0,o,c,(a-o/d)/2,(r-c/u)/2,o/d,c/u);const m=l.toDataURL("image/png");return outputFileSync(t,m),m},async image(e,t){if(!t){return e.library[`${".tga"===e.fileExt?".png":extname(e.name).toLowerCase()}`]}const i=await this.getThumbnail(e,t);if(!i||i.startsWith("data:image"))return i;const n=extname(e.name).toLocaleLowerCase(),s=this.getLibraryImageSrc(e.library,n),a=await this.setThumbnail(`${s}?${Date.now()}`,i);return!1===a&&console.warn(`Load thumbnail failed: ${e.url}`),a},async subImage(e,t){const i=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!i||!i.userData)return"";const{userData:n}=i,s=(n.imageUuidOrDatabaseUri||i.uuid).split("@")[0],a=await Editor.Message.request("asset-db","query-asset-info",s);if(!a)return"";const r=extname(a.name).toLocaleLowerCase(),o=this.getLibraryImageSrc(a.library,r);if(!o){const e=await Editor.Message.request("asset-db","query-asset-info",i.uuid);if(!e||!e.library)return"";const t=[".png",".jpg",".jpge"];for(const i of t)if(i in e.library)return e.library[i]}if(!t&&o&&(!i.userData.width||!i.userData.height))return o;const c=await this.getThumbnail(e,t||`${i.userData.width},${i.userData.height}`);return!c||c.startsWith("data:image")?c:await this.setThumbnail(`${o}?${e.refreshTime}`,c,i.userData)},getLibraryImageSrc(e,t){let i=e[t];if(!i){i=e[Object.keys(e).find(e=>".json"!==e)||""]}return i}};