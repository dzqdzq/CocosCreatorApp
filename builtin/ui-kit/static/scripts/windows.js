"use strict";const{existsSync:existsSync,outputFileSync:outputFileSync,readJsonSync:readJsonSync,readFileSync:readFileSync,removeSync:removeSync}=require("fs-extra"),{join:join,extname:extname,basename:basename}=require("path"),{parse:parse}=require("url"),ElectronModule=require("@base/electron-module");function attach(e,t){const i=require(t);Editor.UI.register("ui-"+e,i.element)}exports.load=function(){function e(e){if(e.info.contributions&&e.info.contributions["ui-kit"]){if(e.info.contributions["ui-kit"].element)for(let t in e.info.contributions["ui-kit"].element){if(!e.info.contributions["ui-kit"].element[t])continue;const i=join(e.path,e.info.contributions["ui-kit"].element[t]),r=require(i);r.load&&r.load(),Editor.UI.register("ui-"+t,r.element)}if(e.info.contributions["ui-kit"]["ui-prop"]){const t=e.info.contributions["ui-kit"]["ui-prop"];for(let i in t.render)if(t.render[i])try{const r=require(join(e.path,t.render[i]));Editor.UI.Prop.registerRender(i,r)}catch(e){console.error(e)}}}}Editor.Package.getPackages({enable:!0}).forEach(e),Editor.Package.on("enable",e),Image.init(),Editor.UI.Link.setLinkHandle(async function(e,t){if(!t)return!1;const i=ElectronModule.require("UuidUtils");switch(e=e.trim(),t){case"assetUrl":return e=await Editor.Message.request("asset-db","query-uuid",e),i.isUuid(e)&&Editor.Message.send("assets","twinkle",e),!0;case"assetUuid":return i.isUuid(e)&&Editor.Message.send("assets","twinkle",e),!0;case"nodeUuid":return i.isUuid(e)&&Editor.Message.send("hierarchy","twinkle",e),!0}})},exports.unload=function(){Editor.UI.Image.setNameTranslator(null)};const Image={dbInfos:{},init(){Editor.UI.Image.setSrcTranslator(async function(e){if(!e)return"";e.startsWith("db://")&&(e=await Editor.Message.request("asset-db","query-uuid",e));const t=ElectronModule.require("UuidUtils"),i=e.split("@").shift();if(t.isUuid(i)){const t=await Editor.Message.request("asset-db","query-asset-info",e);return t?-1!==e.indexOf("@")?await Image.subImage(t,this.size):await Image.image(t,this.size):""}return e}),Editor.UI.Image.prototype._onConnected=function(){this.addEventListener("click",Image.bindClick)},Editor.UI.Image.prototype._onDisconnected=function(){this.removeEventListener("click",Image.bindClick)}},bindClick(){Editor.Message.send("assets","twinkle",this.value.trim())},async getThumbnail(e,t){const i=parse(e.path);let r=this.dbInfos[i.host];r||(r=await Editor.Message.request("asset-db","query-db-info",i.host),this.dbInfos[i.host]=r);const n=e.uuid.substr(0,2),s=join(r.temp,n,e.uuid,t);if(existsSync(s)){return readFileSync(s,"utf8")}return s},async setThumbnail(e,t,i={}){const r=document.createElement("img");if(r.src=e,!1===await new Promise(e=>{r.addEventListener("load",()=>{e(r)}),r.addEventListener("error",()=>{e(!1)})}))return"";const n=basename(t).split(","),s=Number(n[0])||r.width,a=Number(n[1])||r.height;let o=i.width||r.width,u=i.height||r.height;const c=o/s,d=u/a,l=document.createElement("canvas");l.width=s,l.height=a;const h=l.getContext("2d");if(i.rotated){const e=l.width/2,t=l.height/2;h.translate(e,t),h.rotate(-90*Math.PI/180),h.translate(-e,-t),o=i.height,u=i.width}h.drawImage(r,i.trimX||0,i.trimY||0,o,u,(s-o/c)/2,(a-u/d)/2,o/c,u/d);const m=l.toDataURL("image/png");return outputFileSync(t,m),m},async image(e,t){let i=extname(e.name).toLowerCase();if(!t)return[".tga",".hdr",".bmp"].includes(i)&&(i=".png"),`${e.library[i]}?${Date.now()}`;const r=await this.getThumbnail(e,t);if(!r||r.startsWith("data:image"))return r;const n=this.getLibraryImageSrc(e.library,i),s=await this.setThumbnail(`${n}?${Date.now()}`,r);return!1===s&&console.warn(`Load thumbnail failed: ${e.url}`),s},async subImage(e,t){const i=await Editor.Message.request("asset-db","query-asset-meta",e.uuid);if(!i||!i.userData)return"";const{userData:r}=i,n=(r.imageUuidOrDatabaseUri||i.uuid).split("@");n.length>1&&n.pop();const s=n.join("@"),a=await Editor.Message.request("asset-db","query-asset-info",s);if(!a)return"";const o=extname(a.name).toLocaleLowerCase(),u=this.getLibraryImageSrc(a.library,o);if(!u){const e=await Editor.Message.request("asset-db","query-asset-info",i.uuid);if(!e||!e.library)return"";const t=[".png",".jpg",".jpge"];for(const i of t)if(i in e.library)return`${e.library[i]}?${Date.now()}`}if(!t&&u&&(!i.userData.width||!i.userData.height))return`${u}?${Date.now()}`;const c=await this.getThumbnail(e,t||`${i.userData.width},${i.userData.height}`);return!c||c.startsWith("data:image")?c:await this.setThumbnail(`${u}?${e.refreshTime}`,c,i.userData)},getLibraryImageSrc(e,t){let i=e[t];if(!i){i=e[Object.keys(e).find(e=>".json"!==e)||""]}return i}};