"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.methods=void 0;const record_message_1=require("./record-message"),requestQueue=[];let id=0,hasRecord=!1,autoSave=!1;async function load(){Editor.Package.getPackages().forEach(exports.methods.attach),Editor.Package.__protected__.on("enable",e=>{exports.methods.attach(e)}),Editor.Package.__protected__.on("disable",exports.methods.detach),Editor.App.args.recordMessage&&(await exports.methods.startAutoSave(),exports.methods.addListener())}function unload(){Editor.Package.__protected__.removeListener("enable",exports.methods.attach),Editor.Package.__protected__.removeListener("disable",exports.methods.detach),exports.methods.removeListener()}exports.methods={request(e){if("messages"===e.name)return;const s=new Error("message").stack.match(/\(.*\)/g)||[],a={process:"browser",type:"request",name:e.name,message:e.message,source:s[4],timestamp:Date.now(),time:0,args:e.args,id:id++};e.id=a.id,requestQueue.push(a),Editor.Message.send("messages","request",a),autoSave&&(0,record_message_1.appendMessage)(a)},reply(e){if("messages"===e.name)return;const s=new Error("message").stack.match(/\(.*\)/g)||[],a=requestQueue.find((s,a)=>{if(s.id===e.id)return requestQueue.splice(a,1),!0}),t={process:"browser",type:"reply",name:e.name,message:e.message,source:s[3],timestamp:Date.now(),time:Date.now()-(a?a.timestamp:0),args:e.args,id:a?a.id:0};Editor.Message.send("messages","reply",t),autoSave&&(0,record_message_1.appendMessage)(t)},send(e){if("messages"===e.name)return;const s=new Error("message").stack.match(/\(.*\)/g)||[],a={process:"browser",type:"send",name:e.name,message:e.message,source:s[4],timestamp:Date.now(),time:0,args:e.args,id:0};Editor.Message.send("messages","send",a),autoSave&&(0,record_message_1.appendMessage)(a)},broadcast(e){if("messages"===e.name)return;const s=new Error("message").stack.match(/\(.*\)/g)||[],a={process:"browser",type:"broadcast",name:e.name,message:e.message,source:s[4],timestamp:Date.now(),time:0,args:e.args,id:0};Editor.Message.send("messages","broadcast",a),autoSave&&(0,record_message_1.appendMessage)(a)},addListener(){hasRecord||(Editor.Message.__eb__.on("request",exports.methods.request),Editor.Message.__eb__.on("reply",exports.methods.reply),Editor.Message.__eb__.on("send",exports.methods.send),Editor.Message.__eb__.on("broadcast",exports.methods.broadcast),hasRecord=!0)},removeListener(){hasRecord&&(Editor.Message.__eb__.removeListener("request",exports.methods.request),Editor.Message.__eb__.removeListener("reply",exports.methods.reply),Editor.Message.__eb__.removeListener("send",exports.methods.send),Editor.Message.__eb__.removeListener("broadcast",exports.methods.broadcast),hasRecord=!1)},open(){Editor.Panel.open("messages")},openDebug(){Editor.Panel.open("messages.debug")},attach(e){e.invalid||(e.name,e.info,e.info.contributions&&e.info.contributions.messages&&Editor.Message.__register__(e.name,e.info.contributions.messages))},detach(e){Editor.Message.__unregister__(e.name)},queryMessageState:()=>({hasRecord:hasRecord,autoSave:autoSave}),async startAutoSave(){autoSave||(await(0,record_message_1.saveMessageLog)(),autoSave=!0)},async stopAutoSave(){autoSave&&(autoSave=!1)}},exports.load=load,exports.unload=unload;