"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mounted=exports.methods=exports.components=exports.computed=exports.watch=exports.data=void 0;const path_1=require("path"),fs_1=__importDefault(require("fs")),image_1=__importDefault(require("../operation/image")),Chroma=require("chroma-js");var Modes;function delDir(t,e=!1){let s=[];fs_1.default.existsSync(t)&&((s=fs_1.default.readdirSync(t)).forEach((e,s)=>{const a=t+"/"+e;fs_1.default.statSync(a).isDirectory()?delDir(a,!0):fs_1.default.unlinkSync(a)}),e&&fs_1.default.rmdirSync(t))}async function mounted(){const t=this,e=await Editor.Message.request("lightmap","unstaging");e.isStart&&!e.isEnd&&(t.isGenerate=!0,t.progress=e.progress),t.setLogs(e.logInfos),e.isEnd&&(fs_1.default.existsSync(`${e.currPath}/output/`)?t.picInfos=await image_1.default(`${e.currPath}/output/`):t.picInfos=[],t.saveEdit())}!function(t){t[t.SCENE=0]="SCENE",t[t.BAKED=1]="BAKED"}(Modes||(Modes={})),exports.data={mode:Modes.SCENE,progress:0,logInfos:[],picInfos:[],selectInfos:{},isGenerate:!1,msaa:4,path:"",size:1024,gamma:2.2,giScale:.5,giSamples:25,giPathLength:4,aoLevel:0,aoStrength:.5,aoRadius:1,aoColor:"#888"},exports.watch={},exports.computed={},exports.components={},exports.methods={changeColor(t){this.aoColor=Chroma(t.target.value).hex(),this.saveEdit()},saveEdit(){const t=this;Editor.Profile.setConfig("lightmap","lightmap",{msaa:t.msaa,size:t.size,gamma:t.gamma,giScale:t.giScale,giSamples:t.giSamples,giPathLength:t.giPathLength,aoLevel:t.aoLevel,aoStrength:t.aoStrength,aoRadius:t.aoRadius,aoColor:t.aoColor}),t.onItemClick(0)},t(t){const e=`lightmap.${t}`;return Editor.I18n.t(e)},changeMode(t){this.mode=t},async onClear(){const t=this,e=await Editor.Message.request("lightmap","unstaging");""===e.currPath||t.isGenerate||(delDir(e.currPath),t.selectInfos={},t.picInfos=[],t.logInfos=[],await Editor.Message.request("scene","execute-lightmap-method",{name:"clear",args:[]}),await Editor.Message.request("lightmap","clear"),await Editor.Message.request("asset-db","refresh-asset","db://assets"))},async onCancel(){this.isGenerate=!1,this.logInfos=[],await Editor.Message.request("scene","execute-lightmap-method",{name:"cancel",args:[]})},async onBakerEnd(){this.isGenerate=!1;const t=await Editor.Message.request("lightmap","unstaging");this.picInfos=await image_1.default(path_1.join(t.currPath,"output")),this.saveEdit()},pushLog(t){this.logInfos.push(t)},setLogs(t){const e=this;e.logInfos=[];for(let s=0;s<t.length;s++)e.logInfos.push(t[s])},onItemClick(t){const e=this;e.selectInfos={};for(const s in e.picInfos[t])"path"!==s&&"uuid"!==s&&(e.selectInfos[s]=e.picInfos[t][s])},async onConfirm(){const t=this;t.progress=0,t.logInfos=[];const e=await Editor.Dialog.select({type:"directory",title:t.t("title"),path:path_1.join(Editor.Project.path,"assets"),multi:!1,filters:[{name:"Lightmap",extensions:["png"]}]});let s=e.filePaths?e.filePaths[0]:[];if(Array.isArray(s)&&(s=s[0]),!s)return!1;s=`${s}/LightFX`,t.path=s,await Editor.Message.request("lightmap","savePicPath",s),fs_1.default.existsSync(s)&&delDir(s),t.logInfos.push(t.t("start")+"\n"),t.isGenerate=!0,await Editor.Message.request("scene","execute-lightmap-method",{name:"apply",args:[t.$data,Editor.App.path]})}},exports.mounted=mounted;