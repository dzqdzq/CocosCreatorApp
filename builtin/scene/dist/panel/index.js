"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,n,t,i){void 0===i&&(i=t);var o=Object.getOwnPropertyDescriptor(n,t);o&&("get"in o?n.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,i,o)}:function(e,n,t,i){void 0===i&&(i=t),e[i]=n[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(n,e,t);return __setModuleDefault(n,e),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.listeners=exports.fonts=exports.$=exports.template=exports.style=void 0;const fs_1=require("fs"),path_1=require("path"),message_1=require("./message"),infobarPlugin=__importStar(require("../engine-view/plugin/infobar")),toolbarPlugin=__importStar(require("../engine-view/plugin/toolbar")),service_1=require("../engine-view/plugin/toolbar/service"),base_client_1=require("../engine-view/views/base-client"),engine_view_1=require("../engine-view/views/native/engine-view"),engine_view_2=require("../engine-view/views/web/engine-view"),ipc=require("@base/electron-base-ipc");let isNative,panel=null;function notifyScenePanelChange(){if(!panel||!0!==this.ready)return;const e=JSON.parse(JSON.stringify(panel.$.content.getBoundingClientRect()));ipc.send("editor-lib-windows:scene-resize",e),exports.methods["editor-preview-change-style"]()}function attach(e){if(e.invalid)return;if(!e.info.contributions||!e.info.contributions.scene)return;const n=e.info.contributions.scene;try{if(n.custom){const t=Editor.Module.requireFile((0,path_1.join)(e.path,n.custom));t.floatWindows&&panel.$.scene.attachFloatWindow(e.name,t.floatWindows),t.toolbars&&panel.$.scene.attachToolbar(e.name,t.toolbars),t.infobars&&panel.$.scene.attachInfobar(e.name,t.infobars)}}catch(e){console.log(e)}}function detach(e){panel.$.scene.detachFloatWindow(e.name),panel.$.scene.detachToolbar(e.name),panel.$.scene.detachInfobar(e.name)}async function updateIcon(){try{if(isNative){const e=panel.$.content.getRootNode().host.parentElement.parentElement.querySelector("img[src*=scene][src*=builtin]");if(!(e instanceof HTMLImageElement))throw new Error("scene panel icon error:img of selector is not exist");e.onerror=console.error,e.src=`file://${(0,path_1.join)(__dirname,"../../static/native-icon-2x.png")}`}}catch(e){console.error(e)}}async function ready(){(panel=this).updateIcon=updateIcon,isNative=await Editor.Profile.getConfig("scene","scene.native-engine","default");try{isNative=await panel["query-is-native"](),updateIcon()}catch(e){console.error(e)}window.customElements.get("engine-view")||(isNative?(window.customElements.define("engine-view",engine_view_1.NativeEngineView),window.document.body.setAttribute("mode","native")):window.customElements.define("engine-view",engine_view_2.WebEngineView));const e=toolbarPlugin.init(panel.$.toolbar);infobarPlugin.init(panel.$.infobar);(0,message_1.init)(panel);const n=panel.$.scene;isNative&&n.setAttribute("loading","loading"),await n.init();const t=isNative?(0,service_1.nativeToolbarAdapter)():(0,service_1.webviewToolbarAdapter)(e);n.connectToGameView(t),Editor.Package.getPackages({enable:!0}).forEach(attach),Editor.Package.__protected__.on("enable",attach),Editor.Package.__protected__.on("disable",detach),await n.callSceneMethod("changeSceneViewVisible",[!panel.hidden]),document.addEventListener("click",()=>{Editor.Message.broadcast("scene:toolbar-menu-active","")}),panel.ready=!0,notifyScenePanelChange.call(panel),isNative&&n.removeAttribute("loading")}async function beforeClose(){if(!panel.$.scene)return!0;if(base_client_1.BaseClient.isCrash)return!0;const e=await panel.$.scene.callSceneMethod("beforeClose",[],!0,!1);return await Editor.Message.request("scene","save-scene-cache-to-file"),e}async function close(){this.ready=!1,Editor.Package.__protected__.removeListener("enable",attach),Editor.Package.__protected__.removeListener("disable",detach),toolbarPlugin.close()}exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../dist/index.css"),"utf8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static","/template/index.html"),"utf8"),exports.$={loading:".loading",content:".content",toolbar:".toolbar",infobar:".infobar",scene:".scene",gizmos:".gizmos",uiTools:".ui-tools"},exports.fonts=[{name:"scene"}],exports.listeners={resize:notifyScenePanelChange,move:notifyScenePanelChange,show(){panel.$.scene.callSceneMethod("changeSceneViewVisible",[!0])},hide(){panel.$.scene.callSceneMethod("changeSceneViewVisible",[!1])}},exports.methods=(0,message_1.apply)(),exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;