"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=exports.listeners=void 0;const fs_1=require("fs"),path_1=require("path"),env_1=__importDefault(require("../script/utils/env")),preview_input_1=require("./preview-input"),toolbar_1=require("../engine-view/plugin/toolbar"),device_adapter_1=require("../script/utils/device-adapter");let panel;const isWin32="win32"===process.platform;function setBackgroundVisible(e=!1){var t;const i=null===(t=panel.$.preview.getRootNode())||void 0===t?void 0:t.host;i&&(e?i.removeAttribute("style"):i.setAttribute("style","background:none"))}function getRect(){var e;if(!(null===(e=null===panel||void 0===panel?void 0:panel.$)||void 0===e?void 0:e.preview))return;const t=JSON.parse(JSON.stringify(panel.$.preview.getBoundingClientRect())),i=isWin32?window.devicePixelRatio:1,r={x:t.left*i,y:(isWin32?t.top:window.innerHeight-t.bottom)*i,w:t.width*i,h:t.height*i};return toRoundRect(r),r}class EditorPreviewElement extends HTMLElement{constructor(){super(),this.rect={x:0,y:0,w:0,h:0},this.sceneWindow=null,this.previewWindow=null,this.currentWindow=null,this.isPreviewing=!1}updateBackground(){var e;const t=this.parentElement.querySelector(".game-view-toolbar"),i=this.parentElement.getBoundingClientRect(),r=t.getBoundingClientRect(),o=isWin32?window.devicePixelRatio:1,n="free"===(null===(e=panel.devicesInfo)||void 0===e?void 0:e.type),a=n?0:(i.height-r.height-this.rect.h/o)/2,s=n?0:(i.width-this.rect.w/o)/2;this.style.borderColor="var(--color-normal-fill)",this.style.borderStyle="solid",this.style.borderBottomWidth=`${a}px`,this.style.borderTopWidth=`${a}px`,this.style.borderLeftWidth=`${s}px`,this.style.borderRightWidth=`${s}px`}async init(e){if(e.previewWindow)this.previewWindow=e.previewWindow;else{"gameView"===await Editor.Profile.getConfig("preview","preview.current.platform","local")&&this.createWindow(!0)}e.sceneWindow?this.sceneWindow=e.previewWindow:this.createWindow(!1),this.onPreviewVisible(e.previewing)}async createWindow(e){e?this.previewWindow=await Editor.Message.request("scene","create-native-window",300,300,"preview",!0):(this.sceneWindow=await Editor.Message.request("scene","create-native-window",300,300,"preview"),this.currentWindow=this.sceneWindow),null===panel||void 0===panel||panel.editorPreviewChangeStyle(),setBackgroundVisible()}onPreviewVisible(e){this.currentWindow=e?this.previewWindow:this.sceneWindow,this.isPreviewing=e}async resize(e){this.rect=e||this.rect,toRoundRect(this.rect),this.updateBackground(),this.rect&&this.currentWindow&&await Editor.Message.request("scene","resize-native-window",this.rect,this.currentWindow.name)}changeTargetWindow(){this.currentWindow&&Editor.Message.request("scene","native-scene",this.currentWindow.isPreview,"redirectTargetWindow",this.currentWindow.name)}}function toRoundRect(e){e.x=Math.round(e.x),e.y=Math.round(e.y),e.w=Math.round(e.w),e.h=Math.round(e.h)}function onPreviewPanelChange(){if(panel){const e=getRect();e&&(device_adapter_1.NativeAdapter.reset(null===e||void 0===e?void 0:e.w,null===e||void 0===e?void 0:e.h),panel.editorPreviewChangeStyle())}}async function ready(){if(!await env_1.default.useNativeScene())return void Editor.Panel.close("scene.preview");if(panel=this,window.customElements.get("editor-preview")||window.customElements.define("editor-preview",EditorPreviewElement),(0,preview_input_1.registerInput)(panel.$.preview),device_adapter_1.NativeAdapter.enable=!0,await Editor.Message.request("scene","query-is-ready")){const e=await Editor.Message.request("scene","preview-panel-ready");e&&(await panel.$.preview.init(e),setTimeout(()=>{const e=getRect();e&&(device_adapter_1.NativeAdapter.reset(null===e||void 0===e?void 0:e.w,null===e||void 0===e?void 0:e.h),panel.editorPreviewChangeStyle())},5))}await panel.initToolbar();const e=getRect();e&&device_adapter_1.NativeAdapter.reset(null===e||void 0===e?void 0:e.w,null===e||void 0===e?void 0:e.h)}function beforeClose(){}function close(){this.destroyToolbar()}exports.listeners={async show(){panel&&(onPreviewPanelChange(),setBackgroundVisible())},hide(){panel&&setBackgroundVisible(!0)},resize:onPreviewPanelChange,move:onPreviewPanelChange},exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../dist/preview.css"),"utf-8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../static/template/preview.html"),"utf-8"),exports.$={toolbar:".toolbar",preview:".preview"},exports.methods={async onSceneReady(){panel&&(panel.$.preview.currentWindow||await panel.$.preview.createWindow(!1),panel.$.preview.changeTargetWindow())},onEditorPreviewStop(){},async setPreviewWindowVisible(e){panel&&(panel.$.preview.onPreviewVisible(e),panel.$.preview.changeTargetWindow())},async createPreviewWindow(e=!1){panel&&await panel.$.preview.createWindow(e)},async initToolbar(){if(!await Editor.Message.request("scene","is-native"))return void this.destroyToolbar();const e=new toolbar_1.ToolbarGameView({propsData:{isNative:!0,visible:!0}}).$mount(this.$.toolbar);this._toolbarVm=e},destroyToolbar(){var e;this._toolbarVm&&(null===(e=this._toolbarVm)||void 0===e||e.$destroy(),this._toolbarVm=void 0)},async getGameViewData(){if(!this._toolbarVm)throw new Error("preview toolbar is not initialized yet or it's disabled");const e=this._toolbarVm.gameViewData;return Object.assign({},e)},async editorPreviewChangeStyle(){if(panel&&panel._toolbarVm){const e=panel._toolbarVm.gameViewData,{rotate:t,scaleValue:i,devicesInfo:r,fullScreen:o}=e;let n=r.width,a=r.height;if("ratio"===r.type){const e=device_adapter_1.NativeAdapter.ratioToSize(n,a);n=e.width*window.devicePixelRatio,a=e.height*window.devicePixelRatio}else if("design"===r.type){const e=await Editor.Profile.getProject("project","general.designResolution");n=e.width,a=e.height}else"free"===r.type&&(n=device_adapter_1.NativeAdapter.screenWidth*window.devicePixelRatio,a=device_adapter_1.NativeAdapter.screenHeight*window.devicePixelRatio);device_adapter_1.NativeAdapter.fitScreen(n,a,o,t,i/100);const s=getRect();return s&&(s.x+=device_adapter_1.NativeAdapter.deltaX,s.y+=device_adapter_1.NativeAdapter.deltaY,s.w=device_adapter_1.NativeAdapter.width,s.h=device_adapter_1.NativeAdapter.height),panel.devicesInfo=r,panel.$.preview.resize(s),{scale:Math.floor(100*device_adapter_1.NativeAdapter.scale)}}},async editorPreviewChangeConfig(){}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;