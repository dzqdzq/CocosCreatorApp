"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.enableInput=enableInput,exports.registerInput=registerInput,exports.unregisterInput=unregisterInput;const device_adapter_1=require("../../script/utils/device-adapter"),ipc_1=require("./ipc");let leftButton=!1,middleButton=!1,rightButton=!1;const isWin32="win32"===process.platform;let previewElement=null,previewPanel=null;const utils={createMouseEvent(e,t){var n=t.getBoundingClientRect(),o=isWin32?devicePixelRatio:1/devicePixelRatio,n={ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,x:(e.pageX-n.x)*o,y:(e.pageY-n.y)*o,clientX:(e.clientX-n.x)*o,clientY:(e.clientY-n.y)*o,deltaX:e.deltaX||0,deltaY:e.deltaY||0,wheelDeltaX:e.wheelDeltaX||0,wheelDeltaY:e.wheelDeltaY||0,moveDeltaX:e.movementX||0,moveDeltaY:e.movementY||0,movementX:e.movementX,movementY:e.movementY,leftButton:leftButton,middleButton:middleButton,rightButton:rightButton,button:e.button,buttons:e.buttons};return device_adapter_1.NativeAdapter.enable&&(o=device_adapter_1.NativeAdapter.offsetX,0<(e=device_adapter_1.NativeAdapter.offsetY)?(n.y-=e,n.clientY-=e):(n.y+=t.scrollTop,n.clientY+=t.scrollTop),0<o?(n.x-=o,n.clientX-=o):(n.x+=t.scrollTop,n.clientX+=t.scrollLeft)),n},createKeyboardEvent(e){return{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,key:e.key,keyCode:e.keyCode,code:e.code,repeat:e.repeat}},createDragEvent(e,t){var{type:n,value:o,name:u,additional:r}=Editor.UI.__protected__.DragArea.currentDragInfo||{},e=utils.createMouseEvent(e,t);e.name=u,e.type=n,e.value=o,e.values=[];let i=[];return Array.isArray(r)&&(e.values=r,i=e.values.map(e=>e.value)),o&&!i.includes(o)&&e.values.push({value:o,type:n,name:u}),e},createConfirmEvent(e){return{path:e.target.getAttribute("path"),value:e.target.value}},sendToScene(e,t){previewPanel&&ipc_1.PanelIpc.sendToScene("handleInput",e,t)}};function checkMouseButtonState(e,t){leftButton=0===e.button?t:leftButton,middleButton=1===e.button?t:middleButton,rightButton=2===e.button?t:rightButton}let inputEnabled=!1;function enableInput(e){inputEnabled=e}function registerInput(o,e){previewElement=o,previewPanel=e,o.addEventListener("mousedown",e=>{function n(e){0===e.movementX&&0===e.movementY||utils.sendToScene("mouse-move",utils.createMouseEvent(e,o))}inputEnabled&&(document.body.style.pointerEvents="none",checkMouseButtonState(e,!0),utils.sendToScene("mouse-down",utils.createMouseEvent(e,o)),document.addEventListener("mouseup",function e(t){device_adapter_1.NativeAdapter.enable&&o._preview?.focus(),document.body.style.pointerEvents="",utils.sendToScene("mouse-up",utils.createMouseEvent(t,o)),checkMouseButtonState(t,!1),document.removeEventListener("mouseup",e),document.removeEventListener("mousemove",n)}),document.addEventListener("mousemove",n))}),o.addEventListener("mousemove",e=>{!inputEnabled||0===e.movementX&&0===e.movementY||utils.sendToScene("mouse-move",utils.createMouseEvent(e,o))}),o.addEventListener("wheel",e=>{inputEnabled&&utils.sendToScene("mouse-wheel",utils.createMouseEvent(e,o))}),o.addEventListener("keydown",e=>{inputEnabled&&utils.sendToScene("keydown",utils.createKeyboardEvent(e))}),o.addEventListener("keyup",e=>{inputEnabled&&utils.sendToScene("keyup",utils.createKeyboardEvent(e))})}function unregisterInput(e){e.removeEventListener("mousedown"),e.removeEventListener("mousemove"),e.removeEventListener("wheel"),e.removeEventListener("keydown"),e.removeEventListener("keyup")}