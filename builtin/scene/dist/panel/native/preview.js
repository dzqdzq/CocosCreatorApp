"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.close=exports.beforeClose=exports.ready=exports.methods=exports.$=exports.template=exports.style=exports.listeners=void 0;const fs_1=require("fs"),path_1=require("path"),env_1=__importDefault(require("../../script/utils/env")),toolbar_1=require("../../engine-view/plugin/toolbar"),device_adapter_1=require("../../script/utils/device-adapter"),native_window_panel_1=require("./native-window-panel"),panel_constant_1=require("../panel-constant"),panel_manager_1=require("../panel-manager");let panel;const isWin32="win32"===process.platform;function getRect(){var e;if(!(null===(e=null===panel||void 0===panel?void 0:panel.$)||void 0===e?void 0:e.preview))return;const t=JSON.parse(JSON.stringify(panel.$.preview.getBoundingClientRect())),i=isWin32?window.devicePixelRatio:1,a={x:t.left*i,y:(isWin32?t.top:window.innerHeight-t.bottom)*i,width:t.width*i,height:t.height*i};return toRoundRect(a),a}class EditorPreviewElement extends HTMLElement{constructor(){super(),this.rect={x:0,y:0,width:0,height:0},this.isPreviewing=!1}updateBackground(){var e;const t=this.parentElement.querySelector(".game-view-toolbar"),i=this.parentElement.getBoundingClientRect(),a=t.getBoundingClientRect(),n=isWin32?window.devicePixelRatio:1,r="free"===(null===(e=panel.devicesInfo)||void 0===e?void 0:e.type),o=r?0:(i.height-a.height-this.rect.height/n)/2,l=r?0:(i.width-this.rect.width/n)/2;this.style.borderColor="var(--color-normal-fill)",this.style.borderStyle="solid",this.style.borderBottomWidth=`${o}px`,this.style.borderTopWidth=`${o}px`,this.style.borderLeftWidth=`${l}px`,this.style.borderRightWidth=`${l}px`}async resize(e){this.rect=e||this.rect,toRoundRect(this.rect),this.updateBackground(),panel_manager_1.ScenePanelManager.resize(panel_constant_1.PanelName.Preview,this.rect)}}function toRoundRect(e){e.x=Math.round(e.x),e.y=Math.round(e.y),e.width=Math.round(e.width),e.height=Math.round(e.height)}function onPreviewPanelChange(){if(panel){const e=getRect();e&&(device_adapter_1.NativeAdapter.reset(null===e||void 0===e?void 0:e.width,null===e||void 0===e?void 0:e.height),panel.editorPreviewChangeStyle())}}async function ready(){if(!await env_1.default.useNativeScene())return void Editor.Panel.close("scene.preview");panel=this;const e=new native_window_panel_1.NativeWindowPanel(panel,panel_constant_1.PanelName.Preview);e.onPanelReady(),panel.nativeWindowPanel=e,panel_manager_1.ScenePanelManager.preview=panel,window.customElements.get("editor-preview")||window.customElements.define("editor-preview",EditorPreviewElement),device_adapter_1.NativeAdapter.enable=!0,await panel.initToolbar();const t=getRect();t&&device_adapter_1.NativeAdapter.reset(null===t||void 0===t?void 0:t.width,null===t||void 0===t?void 0:t.height)}function beforeClose(){}function close(){this.destroyToolbar(),panel_manager_1.ScenePanelManager.close(panel_constant_1.PanelName.Preview)}exports.listeners={async show(){panel_manager_1.ScenePanelManager.show(panel_constant_1.PanelName.Preview)},hide(){panel_manager_1.ScenePanelManager.hide(panel_constant_1.PanelName.Preview)},resize:onPreviewPanelChange,move:onPreviewPanelChange},exports.style=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../dist/preview.css"),"utf-8"),exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"../../../static/template/preview.html"),"utf-8"),exports.$={toolbar:".toolbar > template",preview:".preview",content:".preview"},exports.methods={async initToolbar(){if(!await Editor.Message.request("scene","is-native"))return void this.destroyToolbar();const e=new toolbar_1.ToolbarGameView({propsData:{isNative:!0,visible:!0}}).$mount(this.$.toolbar);this._toolbarVm=e},destroyToolbar(){var e;this._toolbarVm&&(null===(e=this._toolbarVm)||void 0===e||e.$destroy(),this._toolbarVm=void 0)},async getGameViewData(){if(!this._toolbarVm)throw new Error("preview toolbar is not initialized yet or it's disabled");const e=this._toolbarVm.gameViewData;return Object.assign({},e)},async editorPreviewChangeStyle(){if(panel&&panel._toolbarVm){const e=panel._toolbarVm.gameViewData,{rotate:t,scaleValue:i,devicesInfo:a,fullScreen:n}=e;let r=a.width,o=a.height;if("ratio"===a.type){const e=device_adapter_1.NativeAdapter.ratioToSize(r,o);r=e.width*window.devicePixelRatio,o=e.height*window.devicePixelRatio}else if("design"===a.type){const e=await Editor.Profile.getProject("project","general.designResolution");r=e.width,o=e.height}else"free"===a.type&&(r=device_adapter_1.NativeAdapter.screenWidth*window.devicePixelRatio,o=device_adapter_1.NativeAdapter.screenHeight*window.devicePixelRatio);device_adapter_1.NativeAdapter.fitScreen(r,o,n,t,i/100);const l=getRect();return l&&(l.x+=device_adapter_1.NativeAdapter.offsetX,l.y+=device_adapter_1.NativeAdapter.offsetY,l.width=device_adapter_1.NativeAdapter.width,l.height=device_adapter_1.NativeAdapter.height),panel.devicesInfo=a,panel.$.preview.resize(l),{scale:Math.floor(100*device_adapter_1.NativeAdapter.scale)}}},async editorPreviewChangeConfig(){},onEditorPreviewStop(){panel_manager_1.ScenePanelManager.onPreviewStop()}},exports.ready=ready,exports.beforeClose=beforeClose,exports.close=close;