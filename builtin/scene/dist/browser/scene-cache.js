"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCachePath=exports.sceneCacheManager=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),fs_1=require("fs"),_=require("lodash"),SCENE_CACHE_DIR=path_1.join(Editor.Project.tmpDir,"scene/cache");class SceneCacheManager{constructor(){this.cacheTimerList={},this.cacheJsonList={},this._currentSceneUUID="",this._mode="general",this._disabled=!1,this._saveInterval=5e3,this._maxFileNum=3,this._hasInit=!1,this._eventList={},this._sceneReady=!1}set disabled(e){e!==this._disabled&&(this._disabled=e,e?this._removeEventListener():this.init())}get disabled(){return this._disabled||"general"!==this._mode}async getCurrentSceneUUID(){return this._currentSceneUUID||(this._currentSceneUUID=await Editor.Message.request("scene","query-current-scene")),this._currentSceneUUID}async updateConfig(){const e=await Editor.Profile.getConfig("scene","scene_cache");this.disabled=!e.use,this._saveInterval=e.interval,this._maxFileNum=e.maxFileNum}async init(){if(this._hasInit)return void this._addEventListener();if(await this.updateConfig(),this.disabled)return console.log("The scene cache function is turned off"),!1;if(this.saveSceneCache=_.throttle(()=>{this._saveSceneDump()},this._saveInterval,{leading:!0,trailing:!0}),this.saveJsonToFile=_.debounce((e,t,s)=>{this._saveJsonToFile(e,t,s)},this._saveInterval+300,{leading:!0}),await Editor.Message.request("asset-db","query-ready"))this._initSceneCacheMap();else{const e=()=>{this._initSceneCacheMap(),Editor.Message.removeBroadcastListener("asset-db:ready",e)};Editor.Message.addBroadcastListener("asset-db:ready",e)}this._hasInit=!0,this._addEventListener()}async _initSceneCacheMap(){if(fs_1.existsSync(SCENE_CACHE_DIR)){const e=await fs_extra_1.readdir(SCENE_CACHE_DIR);await Promise.all(e.map(async e=>{if(!await Editor.Message.request("asset-db","query-asset-info",e))return;const t=(await fs_extra_1.readdir(path_1.join(SCENE_CACHE_DIR,e))).map(e=>Number(path_1.basename(e,path_1.extname(e)))),s=t.splice(this._maxFileNum-1,t.length-this._maxFileNum);await Promise.all(s.map(t=>fs_extra_1.remove(getCachePath(e,t)))),this.cacheTimerList[e]=t}))}}async _addEventListener(){this._hasInit&&!Object.keys(this._eventList).length&&(this._eventList={"scene:change-node":this.saveSceneCache.bind(this),"scene:ready":this._onSceneReady.bind(this),"scene:close":this._onSceneClosed.bind(this),"asset-db:asset-delete":this.clearSceneCache.bind(this),"scene:change-mode":e=>this._mode=e},Object.keys(this._eventList).forEach(e=>{Editor.Message.addBroadcastListener(e,this._eventList[e])}))}async _removeEventListener(){this._hasInit&&Object.keys(this._eventList).length&&Object.keys(this._eventList).forEach(e=>{Editor.Message.removeBroadcastListener(e,this._eventList[e])})}async _saveJsonToFile(e,t,s){return fs_extra_1.outputJSONSync(getCachePath(e,t),s)}async queryLatestCache(e){if(this.disabled||!this.cacheJsonList[e]&&!this.cacheTimerList[e])return;const t=await Editor.Message.request("asset-db","query-asset-info",e);if(!t)return;const s=this.cacheTimerList[e],i=fs_1.statSync(t.file).mtimeMs;if(this.cacheJsonList[e]&&this.cacheJsonList[e][0].time>i)return Object.assign({url:t.url},this.cacheJsonList[e][0]);if(s&&s[s.length-1]>i){const i=getCachePath(e,s[s.length-1]);if(fs_1.existsSync(i))return{time:s[s.length-1],file:i,url:t.url}}}queryLastCache(e=this._currentSceneUUID){if(!this.disabled)return this.cacheJsonList[e]?this.cacheJsonList[e][0]:this.cacheTimerList[e]?this.cacheTimerList[e][0]:void 0}async clearSceneCache(e){if(this.disabled)return;const t=e||await this.getCurrentSceneUUID();if(!t)return;const s=path_1.join(SCENE_CACHE_DIR,t);fs_1.existsSync(s)&&fs_extra_1.remove(s),delete this.cacheTimerList[t],delete this.cacheJsonList[t],this._currentSceneUUID=""}async save(){if(!this.disabled)for(const e of Object.keys(this.cacheJsonList))await Promise.all(this.cacheJsonList[e].map(t=>fs_extra_1.outputJSONSync(getCachePath(e,t.time),t.data)))}_onSceneReady(e){this._sceneReady=!1,this._currentSceneUUID=e,this.clearSceneCache(e),this._sceneReadyTimer=setTimeout(()=>{this._sceneReady=!0},1e3)}_onSceneClosed(){this._sceneReadyTimer&&clearTimeout(this._sceneReadyTimer),this._currentSceneUUID="",this._sceneReady=!1}async _saveSceneDump(){if(this.disabled||!this._sceneReady)return;const e=await this.getCurrentSceneUUID();if(!e)return;const t=await Editor.Message.request("scene","query-scene-json");if(t){this.cacheJsonList[e]||(this.cacheJsonList[e]=[]);const s=Date.now();return this.cacheJsonList[e].unshift({time:s,data:t}),this.cacheJsonList[e].length=Math.min(this._maxFileNum,this.cacheJsonList[e].length),this.saveJsonToFile(e,s,t),!0}return!1}}function getCachePath(e,t){return path_1.join(SCENE_CACHE_DIR,e,`${t}.json`)}exports.sceneCacheManager=new SceneCacheManager,exports.getCachePath=getCachePath;