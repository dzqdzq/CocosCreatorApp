"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCachePath=exports.sceneCacheManager=exports.SceneCacheManager=void 0;const path_1=require("path"),fs_extra_1=require("fs-extra"),fs_1=require("fs"),crypto_1=require("crypto"),_=require("lodash"),SCENE_CACHE_DIR=(0,path_1.join)(Editor.Project.tmpDir,"scene/cache"),UnSaveSceneId="unSave";class SceneCacheManager{constructor(){this.cacheTimerList={},this.cacheJsonList={},this._currentSceneUUID="",this._mode="general",this._disabled=!1,this._saveInterval=5e3,this._maxFileNum=3,this._hasInit=!1,this._eventList={},this._sceneReady=!1,this._deviceMd5="",this._unSaveSceneUUID="";const e=require("os");this._systemInfo={arch:e.arch(),cpu:e.cpus()[0].model,version:e.version()},this._deviceMd5=this._calcDeviceInfoMd5(this._systemInfo),this._cacheInfo={systemInfo:this._systemInfo,sceneListMap:{},deviceMd5:this._deviceMd5}}set disabled(e){e!==this._disabled&&(this._disabled=e,e?this._removeEventListener():this.init())}get disabled(){return this._disabled||"general"!==this._mode}async getCurrentSceneUUID(){return this._currentSceneUUID||(this._currentSceneUUID=await Editor.Message.request("scene","query-current-scene",!0)),this._currentSceneUUID}async getCurrentCacheID(e){if(this._unSaveSceneUUID===e)return UnSaveSceneId;const t=await Editor.Message.request("asset-db","query-asset-info",e);return t&&t.visible?e:(this._unSaveSceneUUID=e,UnSaveSceneId)}async updateConfig(){const e=await Editor.Profile.getConfig("scene","scene_cache");this.disabled=!e.use,this._saveInterval=e.interval,this._maxFileNum=e.maxFileNum}async init(){if(this._hasInit)return void this._addEventListener();if(await this.updateConfig(),this.disabled)return void console.log("The scene cache function is turned off");if(this.saveSceneCache=_.throttle(()=>{this._saveSceneDump()},this._saveInterval,{leading:!0,trailing:!0}),this.saveJsonToFile=_.debounce((e,t,s)=>{this._saveJsonToFile(e,t,s)},this._saveInterval+300,{leading:!0}),await Editor.Message.request("asset-db","query-ready"))this._initSceneCacheMap();else{const e=()=>{this._initSceneCacheMap(),Editor.Message.removeBroadcastListener("asset-db:ready",e)};Editor.Message.addBroadcastListener("asset-db:ready",e)}this._hasInit=!0,this._addEventListener()}async _initSceneCacheMap(){if((0,fs_1.existsSync)(SCENE_CACHE_DIR)){const e=(0,path_1.join)(SCENE_CACHE_DIR,"info.json");let t=!1;try{this._cacheInfo=(0,fs_extra_1.readJSONSync)(e),this._cacheInfo.sceneListMap=this._cacheInfo.sceneListMap||{},t=!0}catch(e){this._cacheInfo={systemInfo:this._systemInfo,sceneListMap:{},deviceMd5:this._deviceMd5}}const s=await(0,fs_extra_1.readdir)(SCENE_CACHE_DIR);await Promise.all(s.map(async e=>{const t=e&&await Editor.Message.request("asset-db","query-asset-info",e),s=getCacheDirWithId(e);if(!t&&e!==UnSaveSceneId)return void await(0,fs_extra_1.remove)(s);const i=(await(0,fs_extra_1.readdir)((0,path_1.join)(SCENE_CACHE_DIR,e))).map(e=>Number((0,path_1.basename)(e,(0,path_1.extname)(e))));i.sort((e,t)=>e-t);const a=i.splice(this._maxFileNum-1,i.length-this._maxFileNum);if(await Promise.all(a.map(t=>(0,fs_extra_1.remove)(getCachePath(e,t)))),t&&t.file!==this._cacheInfo.sceneListMap[e]||this._deviceMd5!==this._cacheInfo.deviceMd5)return console.debug(`invalid cache: uuid(${e}} file(${t&&t.file})`),await(0,fs_extra_1.remove)(s),void delete this._cacheInfo.sceneListMap[e];t&&(this._cacheInfo.sceneListMap[e]=t.file),this.cacheTimerList[e]=i})),this._cacheInfo.systemInfo=this._systemInfo,this._cacheInfo.deviceMd5=this._deviceMd5,console.debug("init cacheTimerList "+JSON.stringify(this.cacheTimerList)),t||(0,fs_extra_1.outputJSONSync)(e,this._cacheInfo,{spaces:4})}}async _addEventListener(){this._hasInit&&!Object.keys(this._eventList).length&&(this._eventList={"scene:save":this.onSceneSaved.bind(this),"scene:change-node":this.saveSceneCache.bind(this),"asset-db:asset-delete":this.clearSceneCache.bind(this),"scene:change-mode":e=>this._mode=e},Object.keys(this._eventList).forEach(e=>{Editor.Message.addBroadcastListener(e,this._eventList[e])}))}async _removeEventListener(){this._hasInit&&Object.keys(this._eventList).length&&(Object.keys(this._eventList).forEach(e=>{Editor.Message.removeBroadcastListener(e,this._eventList[e])}),this._eventList={})}async _saveJsonToFile(e,t,s){try{(0,fs_extra_1.outputJSONSync)(getCachePath(e,t),s,{spaces:4})}catch(e){console.log(e)}}onSceneSaved(e){this._unSaveSceneUUID=""}async queryLatestCache(e){const t=await this.getCurrentCacheID(e);if(this.disabled||!this.cacheJsonList[t]&&!this.cacheTimerList[t])return;const s=e&&await Editor.Message.request("asset-db","query-asset-info",e)||null,i=this.cacheTimerList[t],a=s&&(0,fs_1.statSync)(s.file).mtimeMs||0;if(this.cacheJsonList[t]&&this.cacheJsonList[t][0].time>a)return Object.assign({url:s&&s.url||""},this.cacheJsonList[t][0]);if(i&&i[i.length-1]>a){const e=getCachePath(t,i[i.length-1]);if((0,fs_1.existsSync)(e))return{time:i[i.length-1],file:e,url:s&&s.url||""}}}async clearSceneCache(e){if(this.disabled)return;const t=e||await this.getCurrentSceneUUID();if(!t)return;const s=await this.getCurrentCacheID(t),i=getCacheDirWithId(s);(0,fs_1.existsSync)(i)&&(0,fs_extra_1.remove)(i),delete this.cacheTimerList[s],delete this.cacheJsonList[s],this._currentSceneUUID=""}async save(){if(this.disabled)return;const e=(0,path_1.join)(SCENE_CACHE_DIR,"info.json");(0,fs_extra_1.outputJSONSync)(e,this._cacheInfo,{spaces:4})}_calcDeviceInfoMd5(e){return(0,crypto_1.createHash)("md5").update(JSON.stringify(e)).digest("hex")}async onSceneReady(e){this._sceneReady=!1,this._currentSceneUUID=e,this.clearSceneCache(e),this._sceneReadyTimer=setTimeout(()=>{this._sceneReady=!0},1e3)}onSceneClosed(){this._sceneReadyTimer&&clearTimeout(this._sceneReadyTimer),this._currentSceneUUID="",this._sceneReady=!1,this._unSaveSceneUUID=""}async _saveSceneDump(){if(this.disabled||!this._sceneReady)return!1;const e=await this.getCurrentSceneUUID();if(!e)return!1;if(!await Editor.Message.request("scene","query-dirty"))return!1;const t=await Editor.Message.request("scene","query-scene-json");if(t){const s=await this.getCurrentCacheID(e);this.cacheJsonList[s]||(this.cacheJsonList[s]=[]);const i=this.cacheJsonList[s];if(i.length&&i[0].data===t)return!1;const a=Date.now();if(i.unshift({time:a,data:t}),i.length=Math.min(this._maxFileNum,i.length),this.saveJsonToFile(s,a,t),e&&!this._cacheInfo.sceneListMap[s]){const t=e&&await Editor.Message.request("asset-db","query-asset-info",e);t&&(this._cacheInfo.sceneListMap[s]=t.file)}return this.save(),!0}return!1}}function getCachePath(e,t){return(0,path_1.join)(SCENE_CACHE_DIR,e,`${t}.json`)}function getCacheDirWithId(e){return(0,path_1.join)(SCENE_CACHE_DIR,e)}exports.SceneCacheManager=SceneCacheManager,exports.sceneCacheManager=new SceneCacheManager,exports.getCachePath=getCachePath;