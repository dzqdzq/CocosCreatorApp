"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,n,t){void 0===t&&(t=n);var s=Object.getOwnPropertyDescriptor(i,n);s&&("get"in s?i.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(e,t,s)}:function(e,i,n,t){void 0===t&&(t=n),e[t]=i[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(i,e,n);return __setModuleDefault(i,e),i};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeWindowBrowser=void 0;const path=__importStar(require("path"));let SceneWindowClass;const addonRoot=path.join(Editor.App.path,"../tools/native-scene"),isWin32="win32"===process.platform,NativeManager=require(path.join(addonRoot,"addon")).NativeEngineManager;SceneWindowClass=isWin32?require("./win32/scene-window").Win32SceneWindow:require("./mac/scene-window").MacSceneWindow;const electron_1=require("electron"),panel_constant_1=require("../../../panel/panel-constant"),ipc_1=require("../ipc");class NativeWindowBrowser{constructor(e){this._previewWindows={},this._sceneWindows={},this._isPreview=!1,this._panelMap={},this._window=e,this._windowHandle=e.getNativeWindowHandle(),this._initEvents(),this._nativeManager=new NativeManager,this._nativeManager.init(this._windowHandle,800,600)}_initEvents(){isWin32&&electron_1.powerMonitor.on("unlock-screen",()=>{console.log("unlock"),this.redraw(this._isPreview)}),this._window.on("restore",()=>{this.redraw(this._isPreview)}),this._window.on("focus",()=>{this.redraw(this._isPreview)}),this._window.on("move",()=>{this.redraw(this._isPreview)}),this._window.on("resized",()=>{this.redraw(this._isPreview)})}async initWindows(e=!1){[panel_constant_1.PanelName.Scene,panel_constant_1.PanelName.Preview].forEach(async i=>{if(!this._panelMap[i])return;const n=e?this._previewWindows:this._sceneWindows;if(n[i])return;const t=this._panelMap[i];this.redraw(!1);const s=new SceneWindowClass(this._nativeManager,this._windowHandle,i,e);await s.init(t),e&&(s.previewProcess=!0,s.setVisible(!1)),i!==panel_constant_1.PanelName.Preview||e||await this.showCameraOnPreviewPanel(),n[i]=s})}releaseWindows(e=!1){e?this._previewWindows={}:this._sceneWindows={}}onPanelReady(e,i){this._panelMap[e]=i}onPanelClose(e){this._previewWindows[e]&&(this._previewWindows[e].close(),delete this._previewWindows[e]),this._sceneWindows[e]&&(this._sceneWindows[e].close(),delete this._sceneWindows[e]),delete this._panelMap[e]}async onPanelResize(e,i){this._panelMap[e]&&(this._panelMap[e]=i);const n=this.getSceneWindow(e);if(n)return await n.resize(i)}async onPanelShow(e){const i=this.getSceneWindow(e);await(null===i||void 0===i?void 0:i.setVisible(!0))}async onPanelHide(e){const i=this.getSceneWindow(e,!1);await(null===i||void 0===i?void 0:i.setVisible(!1));const n=this.getSceneWindow(e,!0);await(null===n||void 0===n?void 0:n.setVisible(!1))}async switchWindows(e){if(this._isPreview===e)return;this._isPreview=e;const i=e?this._previewWindows:this._sceneWindows,n=e?this._sceneWindows:this._previewWindows;e||await this.showCameraOnPreviewPanel(),await this.setWindowsVisible(i,!0),await this.setWindowsVisible(n,!1),await this.redraw(e)}async setWindowsVisible(e,i){const n=Object.keys(e);for(let t=0;t<n.length;t++){const s=n[t],a=this._panelMap[s],o=e[s];i?(await o.setVisible(!0),await o.resize(a)):await o.setVisible(!1)}}async redraw(e){return e?await ipc_1.b2sIpc.requestToPreview("redraw"):await ipc_1.b2sIpc.requestToScene("redraw")}getSceneWindow(e,i){let n=this._isPreview;return void 0!==i&&(n=i),n?this._previewWindows[e]:this._sceneWindows[e]}async showCameraOnPreviewPanel(){const e=this.getSceneWindow(panel_constant_1.PanelName.Preview);if(!e)return;const i=await e.redirectTargetWindow();await ipc_1.b2pIpc.request(panel_constant_1.PanelName.Preview,"setCameraInvalid",0===i)}async setPanelBackgroundVisible(e){await this.redraw(this._isPreview),Object.keys(this._panelMap).forEach(i=>{ipc_1.b2pIpc.send(i,"setBackgroundVisible",e)})}}exports.NativeWindowBrowser=NativeWindowBrowser;