"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.InteractivePreview=void 0;const cc_1=require("cc"),buffer_1=__importDefault(require("./buffer")),preview_base_1=require("./preview-base"),node_1=__importDefault(require("../../../utils/node")),vec3_1=require("../../../utils/math/vec3"),preview_axis_1=require("./preview-axis"),grid_1=require("./grid"),camera_controller_3d_1=require("../camera/3d/camera-controller-3d"),node_2=__importDefault(require("../../../utils/node")),tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3;class InteractivePreview extends preview_base_1.PreviewBase{constructor(){super(...arguments),this.isMouseLeft=!1,this.isMouseMiddle=!1,this.enableAxis=!0,this.worldAxis=null,this.enableGrid=!0,this.grid=null,this.enableSkybox=!0,this.skybox=null,this.wheelBaseScale=1/12,this.lastMouseWheelDeltaY=0,this.maxMouseWheelDeltaY=1e3,this.disableMouseWheel=!1,this.disableRotate=!1,this.disablePan=!1,this.panningSpeed=4,this.orbitRotateSpeed=.01,this.viewDist=10,this.viewCenter=new cc_1.Vec3,this._isMouseDown=!1,this._right=new cc_1.Vec3,this._up=new cc_1.Vec3,this._v3a=cc.v3(),this._v3b=cc.v3(),this._curPos=cc.v3(),this._curRot=new cc_1.Quat,this._forward=cc.v3(cc_1.Vec3.UNIT_Z)}get wheelSpeed(){return(this.is2D?cce.Camera.controller2D:cce.Camera.controller3D).wheelSpeed}get is2D(){return!!this.scene.getComponentInChildren("cc.UITransform")}initScene(e,t){this.scene=new cc_1.Scene(e),this.enableSkybox&&(this.skybox=this.scene.globals.skybox,this.scene.globals.skybox.enabled=!0),this.previewBuffer=new buffer_1.default(e,t,this.scene)}createNodes(e){}initCamera(e){this.cameraComp=new cc_1.Node(e+"camera").addComponent(cc_1.Camera),this.cameraComp.node.setParent(this.scene),this.is2D?this.cameraComp.node.setPosition(0,0,0):this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.cameraComp.near=.01,this.cameraComp.far=1e4,this.cameraComp.enabled=!1,this.cameraComp.visibility=cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.PROFILER,cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO])}initSceneCamera(){this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.camera.clearFlag=cc_1.gfx.ClearFlagBit.STENCIL<<1|cc_1.gfx.ClearFlagBit.DEPTH_STENCIL,this.camera.cameraUsage=cc_1.renderer.scene.CameraUsage.EDITOR,this.camera.changeTargetWindow(this.previewBuffer.window)}loadScene(){this.scene._load(),this.scene._activate(),this.initSceneCamera()}initPreviewWorldAxis(){this.enableAxis&&(this.worldAxis=new preview_axis_1.PreviewWorldAxis(this.scene,this.cameraComp),this.worldAxis._sceneGizmoCamera.camera.changeTargetWindow(this.previewBuffer.window),this.worldAxisNode=this.worldAxis.shape,this.worldAxisNode.active=!0)}initGrid(){this.enableGrid&&(this.grid=new grid_1.Grid(this.scene,this.cameraComp))}init(e,t){this.initScene(e,t),this.initCamera(e),this.createNodes(this.scene),this.loadScene(),this.initPreviewWorldAxis(),this.initGrid()}resetCamera(e){this.is2D?tempVec3A.set(0,0,0):tempVec3A.set(0,1,2.5),this.cameraComp.node.setPosition(tempVec3A),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),e.getWorldPosition(tempVec3B),cc_1.Vec3.set(this.viewCenter,0,0,0),this.viewDist=cc_1.Vec3.distance(tempVec3A,tempVec3B),cce.Engine.repaintInEditMode()}autoPerfectCameraViewOnModel(e){this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([e]))}perfectCameraView(e){e?cc_1.Vec3.set(this.viewCenter,e.center.x,e.center.y,e.center.z):this._modelNode&&(e=node_2.default.getCenterWorldPos3D([this._modelNode]),cc_1.Vec3.set(this.viewCenter,e.x,e.y,e.z)),this.viewDist=cc_1.Vec3.distance(this.cameraComp.node.worldPosition,this.viewCenter),this.cameraComp.node.getWorldRotation(this._curRot),cc_1.Vec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curRot),cc_1.Vec3.multiplyScalar(tempVec3A,tempVec3A,this.viewDist),cc_1.Vec3.add(tempVec3B,this.viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this.viewCenter),cce.Engine.repaintInEditMode()}onMouseDown(e){this._isMouseDown=!0,this.cameraComp.node.getWorldRotation(this._curRot),this.cameraComp.node.getWorldPosition(this._curPos),e.button!==cc_1.EventMouse.BUTTON_LEFT&&e.button||this.disableRotate||(this.isMouseLeft=!0),e.button!==cc_1.EventMouse.BUTTON_MIDDLE||this.disablePan||(this.isMouseMiddle=!0,vec3_1.MVec3.transformQuat(this._right,cc_1.Vec3.UNIT_X,this._curRot),vec3_1.MVec3.normalize(this._right,this._right),vec3_1.MVec3.transformQuat(this._up,cc_1.Vec3.UNIT_Y,this._curRot),vec3_1.MVec3.normalize(this._up,this._up))}onMouseMove(e){this._isMouseDown&&(this.isMouseMiddle&&!this.disablePan&&this.pan(0|e.movementX,0|e.movementY),this.isMouseLeft)&&this.rotate(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1,this.isMouseLeft=!1,this.isMouseMiddle=!1}onMouseWheel(t){if(!this.disableMouseWheel){let e=t.wheelDeltaY;Math.abs(e-this.lastMouseWheelDeltaY)>this.maxMouseWheelDeltaY&&(e=this.lastMouseWheelDeltaY+Math.sign(e)*this.maxMouseWheelDeltaY),this.scale(e*this.wheelBaseScale)}}onKeyDown(e){this._isMouseDown}scale(e){var t=this.cameraComp.node;e=(0,camera_controller_3d_1.smoothMouseWheelScale)(e),t.getWorldPosition(this._curPos),t.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this._forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this._v3a,this._forward,e*this.wheelSpeed),vec3_1.MVec3.add(this._curPos,this._curPos,this._v3a),node_1.default.makeVec3InRange(this._curPos,-1e12,1e12),this._curPos.z<this.cameraComp.near||this._curPos.z>this.cameraComp.far||(this.viewDist=vec3_1.MVec3.distance(this._curPos,this.viewCenter),t.setWorldPosition(this._curPos))}rotate(e,t){var i,s;(this._isMouseDown||this.isMouseLeft)&&(this.cameraComp.node.getWorldRotation(this._curRot),i=this._curRot,s=cc.v3(),cc_1.Quat.rotateX(i,i,-t*this.orbitRotateSpeed),cc_1.Quat.rotateAround(i,i,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),cc_1.Quat.toEuler(s,i),cc_1.Quat.fromEuler(i,s.x,s.y,0),t=cc.v3(0,0,1),cc_1.Vec3.transformQuat(t,t,i),cc_1.Vec3.normalize(t,t),cc_1.Vec3.multiplyScalar(t,t,this.viewDist),cc_1.Vec3.add(this._curPos,this.viewCenter,t),this.cameraComp.node.setWorldPosition(this._curPos),e=cc.v3(0,1,0),cc_1.Vec3.transformQuat(e,e,i),cc_1.Vec3.normalize(e,e),this.cameraComp.node.lookAt(this.viewCenter,e))}pan(e,t){var i,s,c;(this._isMouseDown||this.isMouseMiddle)&&(i=this.viewDist/800,s=this.cameraComp.node,c=this._curPos,vec3_1.MVec3.multiplyScalar(this._v3a,this._right,-e*this.panningSpeed*i),vec3_1.MVec3.multiplyScalar(this._v3b,this._up,t*this.panningSpeed*i),s.getWorldPosition(c),vec3_1.MVec3.add(c,c,this._v3a),vec3_1.MVec3.add(c,c,this._v3b),s.setWorldPosition(c),vec3_1.MVec3.add(this.viewCenter,this.viewCenter,this._v3a),vec3_1.MVec3.add(this.viewCenter,this.viewCenter,this._v3b),this.viewDist=vec3_1.MVec3.distance(c,this.viewCenter))}updateViewCenterByDist(e){var t=this.cameraComp.node,i=this._curPos;t.getWorldPosition(i),t.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this._forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this._v3a,this._forward,e),vec3_1.MVec3.add(this.viewCenter,i,this._v3a)}hide(){this.cameraComp.enabled=!1}}exports.InteractivePreview=InteractivePreview;