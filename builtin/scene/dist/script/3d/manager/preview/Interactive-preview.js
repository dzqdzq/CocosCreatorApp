"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.InteractivePreview=void 0;const cc_1=require("cc"),buffer_1=__importDefault(require("./buffer")),preview_base_1=require("./preview-base"),node_1=__importDefault(require("../../../utils/node")),tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3;class InteractivePreview extends preview_base_1.PreviewBase{constructor(){super(...arguments),this._isMouseDown=!1,this._viewDist=10,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3}createNodes(e){}init(e,t){this.scene=new cc_1.Scene(e),this.cameraComp=new cc_1.Node(e+"camera").addComponent(cc_1.Camera),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.cameraComp.enabled=!1,this.createNodes(this.scene),this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.camera.cameraUsage=cc_1.renderer.scene.CameraUsage.EDITOR,this.previewBuffer=new buffer_1.default(e,t,this.scene),this.camera.changeTargetWindow(this.previewBuffer.window)}autoPerfectCameraViewOnModel(e){this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([e]))}perfectCameraView(e){this._viewDist=this.getFitDistance(e),this.cameraComp.node.getWorldRotation(this._curCameraRot),cc_1.Vec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),cc_1.Vec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),cc_1.Vec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(e){if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),c=this.cameraComp.fov,a=1.2*t/Math.tan(c/2*Math.PI/180);return this.cameraComp.near=a-t,this.cameraComp.far=a+t,a}onMouseDown(e){this._isMouseDown=!0,this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const c=this._curCameraRot;cc_1.Quat.rotateX(c,c,-t*this.orbitRotateSpeed),cc_1.Quat.rotateAround(c,c,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),cc_1.Quat.toEuler(tempVec3A,c),cc_1.Quat.fromEuler(c,tempVec3A.x,tempVec3A.y,0),cc_1.Vec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,c),cc_1.Vec3.normalize(tempVec3A,tempVec3A),cc_1.Vec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),cc_1.Vec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),cc_1.Vec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,c),cc_1.Vec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.InteractivePreview=InteractivePreview;