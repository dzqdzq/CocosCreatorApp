"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Grid=void 0;const cc_1=require("cc"),utils_1=require("../camera/utils"),linear_ticks_1=__importDefault(require("../camera/grid/linear-ticks")),_lineEnd=1e6,tempV3=new cc_1.Vec3;class Grid{constructor(e,t){this._lineColor=cc.color().fromHEX("#A6A6A6"),this._hide=!1,this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid"),this._gridMeshComp.node.layer=cc_1.Layers.Enum.DEFAULT,this._gridMeshComp.node.setRotationFromEuler(new cc_1.Vec3(90,0,0)),this._gridMeshComp.node.parent=e,this.synchronizeCamera=t,this.hTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.vTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.synchronizeCamera.node.on("transform-changed",this.updateGrid,this)}hide(){this._hide=!0,this._gridMeshComp.node.active=!1}_updateGridData(e,t,i,s=null){const r=this.hTicks,a=this.vTicks;this.synchronizeCamera.node.getWorldPosition(tempV3);const n=tempV3,c=5e3*(n.y/500)|0,o=-c+n.x,h=c+n.x,l=-c+n.z,u=c+n.z;r.range(o,h,5e3),a.range(l,u,5e3);const d=i.clone();d.a=0;for(let s=r.minTickLevel;s<=r.maxTickLevel;++s){const a=r.tickRatios[s];if(a>0){const o=r.ticksAtLevel(s,!0);for(let s=0;s<o.length;++s){const r=o[s],h=i.clone();h.a=200*a;const _=Math.abs(r-n.x);h.a*=1-_/c,e.push(r,n.z),e.push(r,l),e.push(r,n.z),e.push(r,u),t.push(h.x,h.y,h.z,h.w),t.push(d.x,d.y,d.z,d.w),t.push(h.x,h.y,h.z,h.w),t.push(d.x,d.y,d.z,d.w)}}}for(let s=a.minTickLevel;s<=a.maxTickLevel;++s){const r=a.tickRatios[s];if(r>0){const l=a.ticksAtLevel(s,!0);for(let s=0;s<l.length;++s){const a=l[s],u=i.clone();u.a=200*r;const _=Math.abs(a-n.z);u.a*=1-_/c,e.push(n.x,a),e.push(o,a),e.push(n.x,a),e.push(h,a),t.push(u.x,u.y,u.z,u.w),t.push(d.x,d.y,d.z,d.w),t.push(u.x,u.y,u.z,u.w),t.push(d.x,d.y,d.z,d.w)}}}}updateGrid(){if(this._hide)return;const e=[],t=[],i=[];if(this._updateGridData(e,t,this._lineColor,_lineEnd),e.length>0){for(let t=0;t<e.length;t+=2)i.push(t/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,e),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,t),utils_1.CameraUtils.updateIB(this._gridMeshComp,i)}}}exports.Grid=Grid;