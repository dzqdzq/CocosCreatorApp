"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Grid=void 0;const cc_1=require("cc"),utils_1=require("../camera/utils"),linear_ticks_1=__importDefault(require("../camera/grid/linear-ticks")),_lineEnd=1e6,tempV3=new cc_1.Vec3;class Grid{_gridMeshComp;synchronizeCamera;_lineColor=cc.color().fromHEX("#A6A6A6");hTicks;vTicks;constructor(e,i){this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid"),this._gridMeshComp.node.layer=cc_1.Layers.Enum.DEFAULT,this._gridMeshComp.node.setRotationFromEuler(new cc_1.Vec3(90,0,0)),this._gridMeshComp.node.parent=e,this.synchronizeCamera=i,this.hTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.vTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.synchronizeCamera.node.on("transform-changed",this.updateGrid,this)}_hide=!1;hide(){this._hide=!0,this._gridMeshComp.node.active=!1}show(){this._hide=!1,this._gridMeshComp.node.active=!0}_updateGridData(i,t,s,e=0){var r=this.hTicks,a=this.vTicks,h=(this.synchronizeCamera.node.getWorldPosition(tempV3),tempV3),o=5e3*(h.y/500)|0,c=-o+h.x,n=o+h.x,l=-o+h.z,d=o+h.z,u=(r.range(c,n,5e3),a.range(l,d,5e3),s.clone());u.a=0;for(let e=r.minTickLevel;e<=r.maxTickLevel;++e){var _=r.tickRatios[e];if(0<_){var p=r.ticksAtLevel(e,!0);for(let e=0;e<p.length;++e){var m=p[e],g=s.clone(),v=(g.a=200*_,Math.abs(m-h.x));g.a*=1-v/o,i.push(m,h.z),i.push(m,l),i.push(m,h.z),i.push(m,d),t.push(g.x,g.y,g.z,g.w),t.push(u.x,u.y,u.z,u.w),t.push(g.x,g.y,g.z,g.w),t.push(u.x,u.y,u.z,u.w)}}}for(let e=a.minTickLevel;e<=a.maxTickLevel;++e){var f=a.tickRatios[e];if(0<f){var C=a.ticksAtLevel(e,!0);for(let e=0;e<C.length;++e){var k=C[e],x=s.clone(),T=(x.a=200*f,Math.abs(k-h.z));x.a*=1-T/o,i.push(h.x,k),i.push(c,k),i.push(h.x,k),i.push(n,k),t.push(x.x,x.y,x.z,x.w),t.push(u.x,u.y,u.z,u.w),t.push(x.x,x.y,x.z,x.w),t.push(u.x,u.y,u.z,u.w)}}}}updateGrid(){if(!this._hide){var i=[],e=[],t=[];if(this._updateGridData(i,e,this._lineColor,_lineEnd),0<i.length){for(let e=0;e<i.length;e+=2)t.push(e/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,i),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,e),utils_1.CameraUtils.updateIB(this._gridMeshComp,t)}}}}exports.Grid=Grid;