"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpinePreview=void 0;const Interactive_preview_1=require("../Interactive-preview"),misc_1=require("../../../../utils/misc"),cc_1=require("cc"),node_1=__importDefault(require("../../../../utils/node"));class SpinePreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this.skeletonComp=null,this._animUpdateInterval=null,this._fps=30,this.spineData=null,this.currentAnimationIndex=0}createNodes(e){this.lightComp=new cc.Node("Spine Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e;e=new cc_1.Node("Canvas").addComponent(cc_1.Canvas);this.scene.addChild(e.node),this._modelNode=new cc_1.Node("Spine"),this._modelNode.setPosition(0,0,0),e.node.addChild(this._modelNode),this.skeletonComp=this._modelNode.addComponent(cc_1.sp.Skeleton),this.skeletonComp.loop=!1}async setSpine(e){if(!e)return console.warn("invalid uuid"),null;if(cc_1.assetManager.assets.has(e)&&(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),cc_1.assetManager.assets.remove(e)),!this.skeletonComp)return null;this.cameraComp.enabled=!0,this.resetCamera(this.skeletonComp.node);try{this.skeletonComp.skeletonData=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this.skeletonComp.node]));var{_enumSkins:t,_enumAnimations:i,_defaultSkinIndex:n,_animationIndex:s}=this.skeletonComp,a=Object.keys(i).map(e=>{e=this.skeletonComp&&this.skeletonComp.findAnimation(e);return e?e.duration:0});return this.spineData={loop:this.skeletonComp.loop,skin:{list:t,index:n},animation:{list:i,index:s,durations:a}},this.spineData}catch(e){return console.warn("spine preview invalid, ",e),null}}setSkinIndex(e){var t;this.skeletonComp&&(t=this.skeletonComp.skeletonData)&&(t=(t=t.getSkinsEnum())&&String(t[e]))&&(this.skeletonComp.setSkin(t),cce.Engine.repaintInEditMode())}play(e){var t;this.skeletonComp&&(t=this.skeletonComp.skeletonData)&&(t=(t=t.getAnimsEnum())&&String(t[e]))&&(this.skeletonComp.paused=!1,this.currentAnimationIndex=e,this.skeletonComp.animation=t,this.addUpdateListener(),cce.Engine.repaintInEditMode())}pause(){this.skeletonComp&&(this.skeletonComp.paused=!0)}stop(){var e;this.skeletonComp&&this.spineData&&(this.skeletonComp.paused=!1,this.skeletonComp.clearAnimation(),this.clearUpdateListener(),e=this.spineData.animation.durations[this.currentAnimationIndex]||0,Editor.Message.broadcast("scene:spine-preview-animation-time-change",!1,0,e))}setLoop(e){this.skeletonComp&&(this.skeletonComp.loop=e,cce.Engine.repaintInEditMode())}clearUpdateListener(){this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null)}addUpdateListener(){this.clearUpdateListener();var e=1/this._fps*1e3;this._animUpdateInterval=setInterval(this.update.bind(this),e)}update(e){var t,i,n,s;this.skeletonComp&&((t=this.skeletonComp&&(null==(t=this.skeletonComp.getState())?void 0:t.getCurrent(0)))?this.skeletonComp.paused||(i=t.animation.duration,n=!t.isComplete(),s=t.getAnimationTime(),t.isComplete()&&!t.loop?(Editor.Message.broadcast("scene:spine-preview-animation-time-change",n,s,i),this.clearUpdateListener()):Editor.Message.broadcast("scene:spine-preview-animation-time-change",n,s,i)):this.clearUpdateListener())}}exports.SpinePreview=SpinePreview;