"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpinePreview=void 0;const Interactive_preview_1=require("../Interactive-preview"),misc_1=require("../../../../utils/misc"),cc_1=require("cc"),node_1=__importDefault(require("../../../../utils/node")),ANIMATION_CHANGE_TAG="scene:spine-preview-animation-time-change";class SpinePreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this.enableGrid=!0,this.disablePan=!0,this.skeletonComponent=null,this._animUpdateInterval=null,this._fps=30,this.isPaused=!0,this.spineData=null,this.currentAnimationIndex=0,this.currentTime=0,this.trackTotals=6,this.trackIndex=0}createNodes(e){var t=new cc.Node("Spine Preview Light"),e=(t.addComponent(cc_1.DirectionalLight),t.setRotationFromEuler(-45,-45,0),e.addChild(t),new cc_1.Node("Canvas"));e.addComponent(cc_1.Canvas);this.scene.addChild(e),this._modelNode=new cc_1.Node("Spine"),this._modelNode.setPosition(0,0,0),e.addChild(this._modelNode),this.skeletonComponent=this._modelNode.addComponent(cc_1.sp.Skeleton)}releaseAsset(e){cc_1.assetManager.assets.has(e)&&(cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),cc_1.assetManager.assets.remove(e))}resetCameraView(){this.skeletonComponent&&(this.resetCamera(this.skeletonComponent.node),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this.skeletonComponent.node])))}async setTrackIndex(e){this.trackIndex=e}async setSpine(e){if(!e)return console.warn("invalid uuid"),null;if(this.releaseAsset(e),!this.skeletonComponent)return null;this.cameraComp.enabled=!0,this.resetCamera(this.skeletonComponent.node);try{this.skeletonComponent.node.active=!0,this.skeletonComponent.skeletonData=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this.skeletonComponent.node]));var{_enumSkins:t,_enumAnimations:n,_defaultSkinIndex:i,_animationIndex:s}=this.skeletonComponent,o=Object.keys(n).map(e=>{var t=null==(t=this.skeletonComponent)?void 0:t.findAnimation(e);return t?t.duration:0});return this.spineData={trackIndex:this.trackIndex,trackTotals:this.trackTotals,loop:this.skeletonComponent.loop,timeScale:this.skeletonComponent.timeScale,useTint:this.skeletonComponent.useTint,debugSlots:this.skeletonComponent.debugSlots,debugBones:this.skeletonComponent.debugBones,debugMesh:this.skeletonComponent.debugMesh,premultipliedAlpha:this.skeletonComponent.premultipliedAlpha,skin:{list:t,index:i},animation:{list:n,index:s,durations:o}},this.startAnimationUpdate(),this.spineData}catch(e){return console.warn("Failed to set Spine data:",e),null}}close(){this.skeletonComponent&&(this.clearAnimationUpdate(),this.skeletonComponent.skeletonData&&this.releaseAsset(this.skeletonComponent.skeletonData.uuid),this.skeletonComponent.node.active=!1)}setSkinIndex(e){var t;this.skeletonComponent&&this.skeletonComponent.skeletonData&&(t=(t=this.skeletonComponent.skeletonData.getSkinsEnum())&&String(t[e]))&&(this.skeletonComponent.setSkin(t),this.broadcastAnimationInfo())}setAnimationIndex(e=this.currentAnimationIndex){this.currentAnimationIndex=e,this.skeletonComponent&&this.skeletonComponent.skeletonData&&("<None>"===(e=this.getAnimationNameByIndex(e))?this.skeletonComponent.clearAnimation(this.trackIndex):this.skeletonComponent.setAnimation(this.trackIndex,e),this.broadcastAnimationInfo())}getAnimationNameByIndex(e){var t=null==(t=null==(t=this.skeletonComponent)?void 0:t.skeletonData)?void 0:t.getAnimsEnum();return t?String(t[e]):""}play(){this.skeletonComponent&&(this.isPaused=!1,this.skeletonComponent.paused=!1,this.isPlaying||this.setAnimationIndex())}pause(e){var t;this.skeletonComponent&&(this.isPaused=!0,this.skeletonComponent.paused=!0,t=this.getCurrent())&&this.setCurrentTime(null!=e?e:t.getAnimationTime(),t)}stop(){this.skeletonComponent&&this.spineData&&(this.isPaused=!0,this.setCurrentTime(0))}rewind(){this.isPaused=!0,this.setCurrentTime(0)}prevPlay(){this.isPaused=!0,this.setCurrentTime(this.currentTime-1/this._fps)}nextPlay(){this.isPaused=!0,this.setCurrentTime(this.currentTime+1/this._fps)}forward(){this.isPaused=!0;var e=this.getCurrent();e&&this.setCurrentTime(e.animationEnd,e)}setProperties(e,t){this.skeletonComponent&&(e in this.skeletonComponent&&(this.skeletonComponent[e]=t,"loop"===e)&&this.setAnimationIndex(),cce.Engine.repaintInEditMode(),this.broadcastAnimationInfo())}setCurrentTime(e,t){const n=this.skeletonComponent;n&&(t=null!=t?t:this.getCurrent())&&(n.paused=!1,t.trackTime=e,this.currentTime=e,cc_1.director.once(cc_1.Director.EVENT_END_FRAME,()=>{n.paused=!0,this.broadcastAnimationInfo({currentTime:e})}),cce.Engine.repaintInEditMode())}broadcastAnimationInfo(e={}){var t=this.getCurrent(),t=Object.assign({currentTime:this.currentTime,duration:null==t?void 0:t.animation.duration,isPlaying:!this.isPaused},e);Editor.Message.broadcast(ANIMATION_CHANGE_TAG,t)}startAnimationUpdate(){this.clearAnimationUpdate();var e=1/this._fps*1e3;this._animUpdateInterval=setInterval(this.update.bind(this),e)}clearAnimationUpdate(){this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null)}getCurrent(){var e;return null==(e=this.skeletonComponent)?void 0:e.getCurrent(this.trackIndex)}get isPlaying(){var e;return!(!this.skeletonComponent||!(e=this.getCurrent())||this.isPaused||this.skeletonComponent.paused||!this.skeletonComponent.loop&&!(e.trackTime<e.animation.duration))}update(){var e,t;this.skeletonComponent&&!this.isPaused&&(e=this.getCurrent())&&(t=e.trackTime>e.animation.duration,this.currentTime=e.getAnimationTime(),!this.isPlaying&&t?this.pause(e.animation.duration):this.broadcastAnimationInfo())}}exports.SpinePreview=SpinePreview;