"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),buffer_1=require("buffer"),editor_mask=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);class Preview{constructor(){this.width=0,this.height=0,this.data=buffer_1.Buffer.alloc(this.width*this.height*4)}init(){this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.previewBuffer=new cce.PreviewBuffer("scene:preview","query-preview-data"),this.previewBuffer.on("loadScene",this.patchSceneCameras.bind(this))}onNodeAdded(e){cce.Engine.repaintInEditMode();const i=e.getComponent("cc.Camera");if(i){const r=requestAnimationFrame(()=>{i.camera&&(cancelAnimationFrame(r),this.previewBuffer.createWindow(i.uuid),this.previewBuffer.switchCameras(i.camera,this.previewBuffer.window),Editor.Message.broadcast("scene:preview-add",e.uuid))})}}onNodeChanged(e){cce.Engine.repaintInEditMode(),e.getComponent("cc.Camera")&&Editor.Message.broadcast("scene:preview-change",e.uuid)}onNodeRemoved(e){cce.Engine.repaintInEditMode();const i=e.getComponent("cc.Camera");i&&this.previewBuffer.windows[i.uuid]&&(delete this.previewBuffer.windows[i.uuid],Editor.Message.broadcast("scene:preview-remove",e.uuid))}patchSceneCameras(){const e=this.previewBuffer.renderScene.cameras;for(const i of e){if(i.node.layer&editor_mask)continue;const e=i.node.getComponent("cc.Camera");e&&!i.node.isPrivatePreview&&(this.previewBuffer.createWindow(e.uuid),this.previewBuffer.switchCameras(i,this.previewBuffer.window))}}queryWindowList(){return this.previewBuffer.queryWindowList()}}const preview=new Preview;exports.default=preview;