"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),buffer_1=require("buffer"),message_1=require("../message"),buffer_2=__importDefault(require("./buffer")),scene_view_data_1=require("../scene-view/scene-view-data"),editor_mask=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);class Preview{constructor(){this.width=0,this.height=0,this.data=buffer_1.Buffer.alloc(this.width*this.height*4)}init(){this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.previewBuffer=new buffer_2.default("scene:preview","query-preview-data"),this.previewBuffer.on("loadScene",this.patchSceneCameras.bind(this)),scene_view_data_1.sceneViewData.on("target-resolution-changed",e=>{message_1.messageManager.broadcast("scene:target-resolution-changed",e)})}onComponentAdded(e){if(cce.Engine.repaintInEditMode(),e instanceof cc_1.Camera){const i=requestAnimationFrame(()=>{e.camera&&(cancelAnimationFrame(i),this.previewBuffer.createWindow(e.uuid),message_1.messageManager.broadcast("scene:preview-add",e.node.uuid))})}}onNodeChanged(e){cce.Engine.repaintInEditMode(),e.getComponent(cc_1.Camera)&&message_1.messageManager.broadcast("scene:preview-change",e.uuid)}onComponentRemoved(e){cce.Engine.repaintInEditMode(),e instanceof cc_1.Camera&&this.previewBuffer.windows[e.uuid]&&(delete this.previewBuffer.windows[e.uuid],message_1.messageManager.broadcast("scene:preview-remove",e.node.uuid))}patchSceneCameras(){const e=this.previewBuffer.renderScene.cameras;for(const i of e){if(i.node.layer&editor_mask)continue;const e=i.node.getComponent("cc.Camera");e&&!i.node.isPrivatePreview&&(this.previewBuffer.createWindow(e.uuid),this.previewBuffer.switchCameras(i,this.previewBuffer.window))}}queryWindowList(){return this.previewBuffer.queryWindowList()}changeCamera(e){this.previewBuffer.changeCamera(e)}}const preview=new Preview;exports.default=preview;