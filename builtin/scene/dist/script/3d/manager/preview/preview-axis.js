"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewWorldAxis=void 0;const external_1=__importDefault(require("../../../public/gizmos/utils/external")),cc_1=require("cc"),index_1=__importDefault(require("../../../public/gizmos/utils/engine/index")),controller_utils_1=__importDefault(require("../../../public/gizmos/3d/elements/utils/controller-utils")),controller_shape_1=__importDefault(require("../../../public/gizmos/3d/elements/utils/controller-shape")),controller_base_1=__importDefault(require("../../../public/gizmos/3d/elements/controller/controller-base")),misc_1=__importDefault(require("../../../public/gizmos/utils/misc")),NodeUtils=external_1.default.NodeUtils,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,{setNodeOpacity:setNodeOpacity,setMaterialProperty:setMaterialProperty,create3DNode:create3DNode,setMeshColor:setMeshColor}=index_1.default,camera_forward=new cc_1.Vec3(0,0,-1),tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class PreviewWorldAxis extends controller_base_1.default{constructor(e,t){super(e),this._cameraOffset=new cc_1.Vec3(0,0,40),this._textNodeMap=new Map,this.shape=null,this._hide=!1,this._sceneGizmoCamera=new cc_1.Node("axis-camera").addComponent(cc_1.Camera),this._sceneGizmoCamera.node.parent=e,this._sceneGizmoCamera.camera.visibility=cc_1.Layers.Enum.SCENE_GIZMO,this._sceneGizmoCamera.camera.clearFlag=cc_1.gfx.ClearFlagBit.DEPTH_STENCIL,this._sceneGizmoCamera.clearColor=t.clearColor;const a=cc.director.root.curWindow.width,i=cc.director.root.curWindow.height,c=i/3/i,r=(a-i)*c/2/a,o=30*window.devicePixelRatio/i;this._sceneGizmoCamera.rect=new cc_1.Rect(1-c+r,1-c-o,c,c),this.synchronizeCamera=t,this.initShape()}initShape(){this.createShapeNode("PreviewWorldAxis"),this.createAxis("x",cc.Color.RED,cc.v3(0,0,-90)),this.createAxis("y",cc.Color.GREEN,cc.v3()),this.createAxis("z",cc.Color.BLUE,cc.v3(90,0,0)),this.createAxisText(AxisName.x,"ac74fa2b-1f5b-4ff5-a3f0-f127f4483e91@6c48a",cc_1.Color.RED),this.createAxisText(AxisName.y,"7b5313d0-f1aa-4b1b-a3c8-59d523c35301@6c48a",cc_1.Color.GREEN),this.createAxisText(AxisName.z,"389d5fee-e29c-4221-b397-a4934a0a5694@6c48a",cc_1.Color.BLUE),this.registerCameraMovedEvent()}hide(){this.shape&&(this.shape.active=!1),this._hide=!0,this._sceneGizmoCamera.enabled=!1}createShapeNode(e){const t=create3DNode(e);t.parent=this._rootNode,this.shape=t}createAxis(e,t,a){const i=new cc_1.Node,c=controller_shape_1.default.calcLineData(new cc_1.Vec3(0,0,0),new cc_1.Vec3(0,6,0)),r={noDepthTestForLines:!0};Object.assign(r,{forwardPipeline:!0,bodyBBSize:0});const o=controller_utils_1.default.createShapeByData(c,t,r);o.name="ArrowLine",o.parent=i,setMeshColor(o,t),i.name=e+"Axis",i.children.forEach(e=>{e.layer=cc.Layers.Enum.SCENE_GIZMO}),i.parent=this.shape,NodeUtils.setEulerAngles(i,a),this.initHandle(i,e)}createAxisText(e,t,a){const i=this._handleDataMap[e],c=controller_utils_1.default.quad(cc_1.Vec3.ZERO,3,3,cc_1.Vec3.UNIT_Z,a,{texture:!0,needBoundingBox:!1});this.setTextureByUUID(c,t),c.setPosition(0,9,0),c.parent=i.topNode,c.layer=cc.Layers.Enum.SCENE_GIZMO,this._textNodeMap.set(e,c)}setTextureByUUID(e,t){cc_1.assetManager.loadAny(t,(t,a)=>{a&&(setMaterialProperty(e,"mainTexture",a),cce.Engine.repaintInEditMode())})}registerCameraMovedEvent(){this.synchronizeCamera.node.on("transform-changed",this.onEditorCameraMoved,this)}onEditorCameraMoved(){if(this._hide)return;const e=tempQuat_a;this.adjustControllerSize(),this.synchronizeCamera.camera.node.getWorldRotation(e),this._textNodeMap.forEach(t=>{null===t||void 0===t||t.setWorldRotation(e)}),cc_1.Vec3.transformQuat(tempVec3_a,camera_forward,e),Object.keys(this._handleDataMap).forEach(e=>{const t=this._handleDataMap[e],a=axisDirMap[e];if(a){const e=255*misc_1.default.LimitLerp(1,0,Math.abs(cc_1.Vec3.dot(tempVec3_a,a)),.9,1),i=t.rendererNodes;i&&i.forEach((a,i)=>{e<10?a.active=!1:(a.active=!0,setNodeOpacity(a,e),t.oriOpacities[i]=e)})}});const t=this._sceneGizmoCamera.node;cc_1.Vec3.transformQuat(tempVec3_b,this._cameraOffset,e),cc_1.Vec3.add(tempVec3_b,this.getPosition(),tempVec3_b),t.setWorldPosition(tempVec3_b),cc_1.Vec3.transformQuat(tempVec3_b,cc_1.Vec3.UNIT_Y,e),cc_1.Vec3.normalize(tempVec3_b,tempVec3_b),t.lookAt(this.getPosition(),tempVec3_b)}}exports.PreviewWorldAxis=PreviewWorldAxis;