"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_1=__importDefault(require("../scene")),buffer_1=require("buffer"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),electron_base_ipc_1=require("@base/electron-base-ipc"),cc_1=require("cc"),component_1=__importDefault(require("../component"));class PreviewBuffer extends EventEmitter_1.default{constructor(e,t,i=null){super(),this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.data=buffer_1.Buffer.alloc(this.width*this.height*4),this.renderScene=null,this.scene=null,this.windows={},this.window=null,this.windowList=[],this.regions=[new cc_1.gfx.BufferTextureCopy],this._curActiveCameraComp=null,this.renderData={width:this.width,height:this.height,buffer:this.data},this._name=t,this._registerName=e,electron_base_ipc_1.unregisterChannel(e),electron_base_ipc_1.registerChannel(e),electron_base_ipc_1.on(t,async(e,t)=>{const i=await this.getImageData(t.index,t.width,t.height);e.reply(null,i)}),i?this.onLoadScene(i):(scene_1.default.on("open",this.onLoadScene.bind(this)),scene_1.default.on("reload",this.onLoadScene.bind(this))),this.regions[0].texExtent.width=this.width,this.regions[0].texExtent.height=this.height,this.createWindow()}resize(e,t,i=null){i||(i=this.window),this.renderData.width=this.width=e,this.renderData.height=this.height=t,this.regions[0].texExtent.width=e,this.regions[0].texExtent.height=t,i.resize(e,t),this.renderData.buffer=this.data=buffer_1.Buffer.alloc(this.width*this.height*4)}queryWindowList(){const e=this.windows,t=[];if(!this.renderScene)return t;const i=this.renderScene.root.windows;this.windowList=[];for(let r=0;r<i.length;r++)for(const[n,s]of Object.entries(e)){const e=i[r];if(e===s){let s=e._title;const h=component_1.default.query(n);h&&h.node&&(s=h.node.name),t.push({index:r,uuid:n,name:s}),this.windowList.push({index:r,uuid:n,window:i[r],name:s})}}return t}createWindow(e=null){const t=new cc_1.gfx.ColorAttachment;t.endAccesses=[cc_1.gfx.AccessType.FRAGMENT_SHADER_READ_TEXTURE];const i=new cc_1.gfx.DepthStencilAttachment,r=cc.director.root.createWindow({title:this._name,width:this.width,height:this.height,renderPassInfo:{colorAttachments:[t],depthStencilAttachment:i},isOffscreen:!0});this.window=r,e&&(this.windows[e]=r)}onLoadScene(e){this.scene=e,this.renderScene=e.renderScene,this.emit("loadScene",e)}switchCameras(e,t){e.isWindowSize=!1,e.isEnable=!0,e.changeTargetWindow(t),cc.director.root.tempWindow=t}changeCamera(e){let t=null,i=null;for(const r of this.windowList)if(r.index===e){t=r.uuid,i=r.window;break}if(!t||!i||i&&i===this.window&&i.cameras.length>0)return;const r=cce.Component.query(t);r.camera.isWindowSize=!1,r.camera.changeTargetWindow(i),this.window=i,cc.director.root.tempWindow=i,this._curActiveCameraComp=r}copyFrameBuffer(e=null){return e||(e=this.window),this.device.copyTextureToBuffers(e.framebuffer.colorTextures[0],[new Uint8Array(this.renderData.buffer.buffer)],this.regions),this.emit("getData",this,this.data),this.renderData}async getImageData(e,t,i){if(!this.renderScene)return this.renderData;cce.Engine.repaintInEditMode(),e=parseInt(e);const r=this.renderScene.root;let n=this.window;if(!isNaN(e)){if(!r.windows[e]||!n)return this.renderData}if(this.beforeDataHandle&&!this.beforeDataHandle(this,e))return this.renderData;let s=null;if(r)for(const e of r.windows)e.cameras.length>0&&e===n&&(s=e.cameras[0]);if(!s&&this._curActiveCameraComp){const e=this.windows[this._curActiveCameraComp.uuid];e&&(s=this._curActiveCameraComp.camera,this.switchCameras(s,e),this.window=n=e)}if(!s)return this.renderData;return t&&i&&(t!==this.width||i!==this.height)&&this.resize(t,i,n),s.width===this.width&&s.height===this.height||s.resize(t,i),s.update(!0),await new Promise(e=>{cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{e(this.copyFrameBuffer(this.window))})})}}exports.default=PreviewBuffer;