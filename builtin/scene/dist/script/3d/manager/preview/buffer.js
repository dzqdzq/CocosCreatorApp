"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_1=__importDefault(require("../scene")),buffer_1=require("buffer"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),electron_base_ipc_1=require("@base/electron-base-ipc"),cc_1=require("cc");class PreviewBuffer extends EventEmitter_1.default{constructor(e,t,i=null){super(),this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.data=buffer_1.Buffer.alloc(this.width*this.height*4),this.renderScene=null,this.scene=null,this.windows={},this.window=null,this.windowList=[],this.regions=[new cc_1.gfx.BufferTextureCopy],this.renderData={width:this.width,height:this.height,buffer:this.data},this._name=t,this._registerName=e,electron_base_ipc_1.unregisterChannel(e),electron_base_ipc_1.registerChannel(e),electron_base_ipc_1.on(t,async(e,t)=>{const i=await this.getImageData(t.index,t.width,t.height);e.reply(null,i)}),i?this.onLoadScene(i):(scene_1.default.on("open",this.onLoadScene.bind(this)),scene_1.default.on("reload",this.onLoadScene.bind(this))),this.regions[0].texExtent.width=this.width,this.regions[0].texExtent.height=this.height,this.createWindow()}resize(e,t,i=null){i||(i=this.window),this.renderData.width=this.width=e,this.renderData.height=this.height=t,this.regions[0].texExtent.width=e,this.regions[0].texExtent.height=t,i.resize(e,t),this.renderData.buffer=this.data=buffer_1.Buffer.alloc(this.width*this.height*4)}queryWindowList(){const e=this.windows,t=[];if(!this.renderScene)return t;const i=this.renderScene.root.windows;this.windowList=[];for(let n=0;n<i.length;n++)for(const[r,s]of Object.entries(e))i[n]===s&&(t.push({index:n,uuid:r,name:i[n]._title}),this.windowList.push({index:n,uuid:r,window:i[n],name:i[n]._title}));return t}createWindow(e=null){const t=new cc_1.gfx.ColorAttachment;t.endLayout=cc_1.gfx.TextureLayout.SHADER_READONLY_OPTIMAL;const i=new cc_1.gfx.DepthStencilAttachment,n=cc.director.root.createWindow({title:this._name,width:this.width,height:this.height,renderPassInfo:{colorAttachments:[t],depthStencilAttachment:i},isOffscreen:!0});this.window=n,e&&(this.windows[e]=n)}onLoadScene(e){this.scene=e,this.renderScene=e.renderScene,this.emit("loadScene",e)}switchCameras(e,t){e.isWindowSize=!1,e.isEnable=!0,e.changeTargetWindow(t),cc.director.root.tempWindow=t}changeCamera(e){let t=null,i=null;for(const n of this.windowList)if(n.index===e){t=n.uuid,i=n.window;break}if(!t||!i||i&&i===this.window)return;const n=cce.Component.query(t);n.camera.isWindowSize=!1,n.camera.changeTargetWindow(i),this.window=i,cc.director.root.tempWindow=i}copyFrameBuffer(e=null){return e||(e=this.window),this.device.copyFramebufferToBuffer(e.framebuffer,this.renderData.buffer.buffer,this.regions),this.emit("getData",this,this.data),this.renderData}async getImageData(e,t,i){if(!this.renderScene)return this.renderData;cce.Engine.repaintInEditMode(),e=parseInt(e);const n=this.renderScene.root,r=this.window;if(!isNaN(e)){if(!n.windows[e]||!r)return this.renderData}if(this.beforeDataHandle&&!this.beforeDataHandle(this,e))return this.renderData;let s=null;if(n)for(const e of n.windows)e.cameras.length>0&&e===r&&(s=e.cameras[0]);if(!s)return this.renderData;const h=t&&i&&(t!==this.width||i!==this.height);return h&&(this.resize(t,i,r),s.resize(t,i)),s.update(!0),h?await new Promise(e=>{cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{e(this.copyFrameBuffer(this.window))})}):this.copyFrameBuffer(this.window)}}exports.default=PreviewBuffer;