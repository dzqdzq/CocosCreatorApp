"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),util_1=require("util"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function getBoundaryOfMeshNode(e){var t,o,i;if(e){const c=e.getComponent(cc_1.MeshRenderer);let s;if(c instanceof cc_1.SkinnedMeshRenderer)null===(t=c.model)||void 0===t||t.updateTransform(-1),s=null===(o=null===c||void 0===c?void 0:c.model)||void 0===o?void 0:o.worldBounds;else if(c&&c.mesh){if(!(s=c.model&&(null===(i=c.model.modelBounds)||void 0===i?void 0:i.clone()))){const e=c.mesh;e&&(s=cc_1.geometry.aabb.fromPoints(cc_1.geometry.aabb.create(),e.minPosition,e.maxPosition))}s&&cc_1.geometry.aabb.transform(s,s,e.worldMatrix)}return s}}function getBoundaryOfMeshNodes(e){let t;if(e){let o;return e.forEach(e=>{(o=getBoundaryOfMeshNode(e))&&(t?cc_1.geometry.aabb.merge(t,t,o):t=o),(o=getBoundaryOfMeshNodes(e.children))&&(t?cc_1.geometry.aabb.merge(t,t,o):t=o)}),t}return t}function calcModelInfo(e){let t=0,o=0;if(e){const i=e.getComponent(cc_1.MeshRenderer);if(i&&i.mesh)for(const e of i.mesh.struct.primitives){const c=i.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(t+=c);const s=e.indexView?e.indexView.count:c;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:o+=s/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:o+=s-2}}e.children.forEach(e=>{const i=calcModelInfo(e);t+=i.vertices,o+=i.polygons})}return{vertices:t,polygons:o}}class ModelPreview{constructor(){this._isMouseDown=!1,this._viewDist=0,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._modelInfo={vertices:0,polygons:0}}init(){this.scene=new cc.Scene("model preview"),this.cameraComp=new cc.Node("Model Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Model Preview Light").addComponent(cc_1.DirectionalLight),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:model-preview","query-model-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!0),this.cameraComp.enabled=!1}async setModel(e){if(!e)return void console.log(`setModel invalid uuid: ${e}`);cc_1.assetManager.assets.remove(e);const t=await util_1.promisify(cc_1.assetManager.loadAny)(e,{reloadAsset:!0});this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid&&this._modelNode.destroy()),this.cameraComp.enabled=!0,this._modelNode=cc_1.instantiate(t),this._modelNode.parent=this.scene,this._modelInfo=calcModelInfo(this._modelNode),this.perfectCameraView(),Editor.Message.broadcast("scene:model-preview-model-info",this._modelInfo)}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=getBoundaryOfMeshNodes([this._modelNode]);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),o=this.cameraComp.fov,i=1.2*t/Math.tan(o/2*Math.PI/180);return this.cameraComp.near=i-t,this.cameraComp.far=i+t,i}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const o=this._curCameraRot;quat_1.MQuat.rotateX(o,o,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(o,o,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,o),quat_1.MQuat.fromEuler(o,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,o),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,o),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.default=new ModelPreview;