"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),util_1=require("util"),node_1=__importDefault(require("../../../utils/node")),utils_1=require("../../manager/animation/utils"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;var PlayState;function calcModelInfo(e){let t=0,i=0;if(e){const a=e.getComponent(cc_1.MeshRenderer);if(a&&a.mesh)for(const e of a.mesh.struct.primitives){const n=a.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(t+=n);const o=e.indexView?e.indexView.count:n;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:i+=o/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:i+=o-2}}e.children.forEach(e=>{const a=calcModelInfo(e);t+=a.vertices,i+=a.polygons})}return{vertices:t,polygons:i}}!function(e){e[e.STOP=0]="STOP",e[e.PLAYING=1]="PLAYING",e[e.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));class ModelPreview{constructor(){this._isMouseDown=!1,this._viewDist=0,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._modelInfo={vertices:0,polygons:0},this._curEditClipUuid="",this._curEditTime=0,this._needRecallPlay=!1,this._animUpdateInterval=null,this._curPlayState=PlayState.STOP}init(){this.scene=new cc.Scene("model preview"),this.cameraComp=new cc.Node("Model Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Model Preview Light").addComponent(cc_1.DirectionalLight),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:model-preview","query-model-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!0),this.cameraComp.enabled=!1}async setModel(e){if(!e)return void console.log(`setModel invalid uuid: ${e}`);cc_1.assetManager.assets.remove(e);const t=await util_1.promisify(cc_1.assetManager.loadAny)(e,{reloadAsset:!0});return this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid&&this._modelNode.destroy()),this.cameraComp.enabled=!0,this._modelNode=cc_1.instantiate(t),this._modelNode.parent=this.scene,this._modelInfo=calcModelInfo(this._modelNode),this.initAnimation(),cce.Engine.repaintInEditMode(),await new Promise(e=>{cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{this.perfectCameraView(),e(this._modelInfo)})})}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=node_1.default.getBoundaryOfMeshNodes([this._modelNode]);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),i=this.cameraComp.fov,a=1.2*t/Math.tan(i/2*Math.PI/180);return this.cameraComp.near=a-t,this.cameraComp.far=a+t,a}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const i=this._curCameraRot;quat_1.MQuat.rotateX(i,i,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(i,i,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,i),quat_1.MQuat.fromEuler(i,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){if(this.cameraComp.enabled=!1,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),this._curEditClipUuid){const e=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animComp;e&&this._unregisterAnimStateEVents(e)}}executeAnimationOperation(e,t=[]){let i=this;i[e]||console.warn(`Method '${e}' does not exist to manipulate the animation.`);try{i[e](...t)}catch(e){console.error(e)}}_registerAnimStateEvents(e){e&&(e.on(cc_1.Animation.EventType.FINISHED,this._onAnimPlayEnd,this),e.on(cc_1.Animation.EventType.PLAY,this._onAnimPlay,this),e.on(cc_1.Animation.EventType.PAUSE,this._onAnimPause,this),e.on(cc_1.Animation.EventType.RESUME,this._onAnimResume,this),e.on(cc_1.Animation.EventType.STOP,this._onAnimStopped,this))}_unregisterAnimStateEVents(e){e&&(e.off(cc_1.Animation.EventType.FINISHED,this._onAnimPlayEnd,this),e.off(cc_1.Animation.EventType.PLAY,this._onAnimPlay,this),e.off(cc_1.Animation.EventType.PAUSE,this._onAnimPause,this),e.off(cc_1.Animation.EventType.RESUME,this._onAnimResume,this),e.off(cc_1.Animation.EventType.STOP,this._onAnimStopped,this))}setEditClip(e){this._curEditClipUuid=e}initAnimation(){if(!this._modelNode)return;this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100));const e=this._modelNode.getComponent(cc_1.SkeletalAnimation);e&&(e.useBakedAnimation=!1,this._registerAnimStateEvents(e))}update(){this._curPlayState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),Editor.Message.broadcast("scene:model-preview-animation-time-change",this._curEditTime))}play(e){e=e||this._curEditClipUuid;const t=utils_1.utils.queryNodeAnimationData(this._modelNode,e).animState;if(!t)return!1;const i=t.playbackRange.min;return t.setTime(i),t.weight=1,t.play(),cce.Engine.repaintInEditMode(),!0}stop(){const e=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animState;if(!e)return!1;e.play();return e.setTime(0),this._curEditTime=0,e.isPaused||e.pause(),e.sample(),e.stop(),cce.Engine.repaintInEditMode(),e.current,!0}pause(){const e=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animState;return!!e&&(e.pause(),cce.Engine.repaintInEditMode(),this._curEditTime=this.queryPlayingClipTime(),!0)}resume(){const e=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animState;return!!e&&(e.isPlaying||(e.weight=1,e.play()),e.resume(),cce.Engine.repaintInEditMode(),!0)}_onAnimPlay(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),this._needRecallPlay=!0,Editor.Message.broadcast("scene:model-preview-animation-time-change",this.queryPlayingClipTime())}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),Editor.Message.broadcast("scene:model-preview-animation-time-change",this._curEditTime)}changePlayState(e){this._curPlayState=e,Editor.Message.broadcast("scene:model-preview-animation-state-change",this._curPlayState)}queryPlayingClipTime(e){e=e||this._curEditClipUuid;const t=utils_1.utils.queryNodeAnimationData(this._modelNode,e).animState;return t?t.current:0}setCurEditTime(e){this._curEditTime=e;const t=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animState;if(!t)return!1;let i=e;return i>t.duration&&(i=t.duration),t.weight=1,t.play(),t.setTime(i),t.isPaused||t.pause(),t.sample(),cce.Engine.repaintInEditMode(),Editor.Message.broadcast("scene:model-preview-animation-time-change",this.queryPlayingClipTime()),!0}setPlaybackRange(e,t){const i=utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animState;return!!i&&(i.playbackRange={min:e,max:t},!0)}}exports.default=new ModelPreview;