"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModelPreview=void 0;const cc_1=require("cc"),misc_1=require("../../../utils/misc"),node_1=__importDefault(require("../../../utils/node")),utils_1=require("../../manager/animation/utils"),message_1=require("../message"),timer_util_1=require("../../utils/timer-util"),scene_view_1=require("../scene-view"),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy];var PlayState;function calcModelInfo(e){let t=0,i=0;if(e){const a=e.getComponent(cc_1.MeshRenderer);if(a&&a.mesh)for(const e of a.mesh.struct.primitives){const n=a.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(t+=n);const s=e.indexView?e.indexView.count:n;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:i+=s/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:i+=s-2}}e.children.forEach(e=>{const a=calcModelInfo(e);t+=a.vertices,i+=a.polygons})}return{vertices:t,polygons:i}}regions[0].texExtent.depth=1,function(e){e[e.STOP=0]="STOP",e[e.PLAYING=1]="PLAYING",e[e.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}class ModelPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this._modelInfo={vertices:0,polygons:0},this._curEditClipUuid="",this._curEditClipRawClipIndex=0,this._curEditTime=0,this._needRecallPlay=!1,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this._curPlaybackRange={min:0,max:1},this._animUpdateInterval=null,this._curPlayState=PlayState.STOP,this._fps=30}init(e,t){super.init(e,t),scene_view_1.sceneViewManager.on("isVisible",this.onSceneViewVisible.bind(this))}createNodes(e){this.lightComp=new cc.Node("Model Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e}onSceneViewVisible(e){this.addUpdateListener()}async setModel(e){if(!e)return console.log(`setModel invalid uuid: ${e}`),null;cc_1.assetManager.assets.remove(e);const t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e,{reloadAsset:!0});return this.cameraComp.enabled=!0,this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid&&this._modelNode.destroy()),this._modelNode=(0,cc_1.instantiate)(t),this._modelNode.parent=this.scene,this._modelInfo=calcModelInfo(this._modelNode),this._modelUUID=e,this.initAnimation(),cce.Engine.repaintInEditMode(),await new Promise(e=>{cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),e(this._modelInfo)})})}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),this.cameraComp.node.getWorldRotation(this._curCameraRot)}hide(){if(this.cameraComp.enabled=!1,this.clearUpdateListener(),this._curEditClipUuid){utils_1.utils.queryNodeAnimationData(this._modelNode,this._curEditClipUuid).animComp}}async executeAnimationOperation(e,t=[]){const i=this;i[e]||console.warn(`Method '${e}' does not exist to manipulate the animation.`);try{await i[e](...t)}catch(e){console.error(e)}}_registerAnimStateEvents(e){e&&(e.on(cc_1.Animation.EventType.FINISHED,this._onAnimPlayEnd,this),e.on(cc_1.Animation.EventType.PLAY,this._onAnimPlay,this),e.on(cc_1.Animation.EventType.PAUSE,this._onAnimPause,this),e.on(cc_1.Animation.EventType.RESUME,this._onAnimResume,this),e.on(cc_1.Animation.EventType.STOP,this._onAnimStopped,this))}_unregisterAnimStateEVents(e){e&&(e.off(cc_1.Animation.EventType.FINISHED,this._onAnimPlayEnd,this),e.off(cc_1.Animation.EventType.PLAY,this._onAnimPlay,this),e.off(cc_1.Animation.EventType.PAUSE,this._onAnimPause,this),e.off(cc_1.Animation.EventType.RESUME,this._onAnimResume,this),e.off(cc_1.Animation.EventType.STOP,this._onAnimStopped,this))}setEditClip(e,t){if(this._curEditClipUuid=e,this._animationStateMap.has(this._curEditClipRawClipIndex)){const e=this._animationStateMap.get(this._curEditClipRawClipIndex);null===e||void 0===e||e.stop()}this._curEditClipRawClipIndex=t}async getAnimationState(e){if(!this._modelNode)return null;if(!this._modelUUID)return null;if(this._animationStateMap.has(e))return this._animationStateMap.get(e);{const t=(await Editor.Selection.getSelected("asset"))[0];if(!t)return null;const i=await Editor.Message.request("asset-db","query-asset-info",t),a=null===i||void 0===i?void 0:i.library;if(!a)return null;const n=a[`__original-animation-${e}.cconb`];if(!n)return console.debug("can't find path:",n),null;const s=await new Promise((e,t)=>{cc_1.assetManager.loadAny({url:`file://${n}`,__isNative__:!1},(i,a)=>{i?t(i):e(a)})}),o=new cc_1.AnimationState(s);return o.initialize(this._modelNode),o._setEventTarget(this._eventTarget),this._animationStateMap.set(e,o),this._registerAnimStateEvents(o),o}}addUpdateListener(){this.clearUpdateListener();const e=1/this._fps*1e3;scene_view_1.sceneViewManager.isVisible?this._animUpdateInterval=setInterval(this.update.bind(this),e):this._animUpdateInterval=timer_util_1.TimerUtil.setMainProcessInterval(this.update.bind(this),e)}initAnimation(){if(!this._modelNode)return;this.addUpdateListener();const e=this._modelNode.getComponent(cc_1.SkeletalAnimation);e&&(e.useBakedAnimation=!1),this._animationStateMap.forEach(e=>{this._unregisterAnimStateEVents(e),e.destroy()}),this._animationStateMap.clear()}async update(){this._curPlayState===PlayState.PLAYING&&(this._curEditTime=await this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:model-preview-animation-time-change",this._curEditTime))}async play(e){e=e||this._curEditClipUuid;const t=await this.getAnimationState(this._curEditClipRawClipIndex);if(!t)return!1;t.playbackRange={min:this._curPlaybackRange.min,max:this._curPlaybackRange.max};const i=t.playbackRange.min;return t.setTime(i),t.weight=1,t.play(),cce.Engine.repaintInEditMode(),!0}async stop(){const e=await this.getAnimationState(this._curEditClipRawClipIndex);if(!e)return!1;e.play();const t=this._curPlaybackRange.min;return e.setTime(t),this._curEditTime=t,e.isPaused||e.pause(),e.sample(),e.stop(),cce.Engine.repaintInEditMode(),e.current,!0}async pause(){const e=await this.getAnimationState(this._curEditClipRawClipIndex);return!!e&&(e.pause(),cce.Engine.repaintInEditMode(),this._curEditTime=await this.queryPlayingClipTime(),!0)}async resume(){const e=await this.getAnimationState(this._curEditClipRawClipIndex);return!!e&&(e.isPlaying||(e.weight=1,e.play()),e.resume(),cce.Engine.repaintInEditMode(),!0)}_onAnimPlay(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}async _onAnimStopped(){this.changePlayState(PlayState.STOP),this._needRecallPlay=!0,message_1.messageManager.broadcast("scene:model-preview-animation-time-change",await this.queryPlayingClipTime())}async _onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=await this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:model-preview-animation-time-change",this._curEditTime)}changePlayState(e){this._curPlayState=e,message_1.messageManager.broadcast("scene:model-preview-animation-state-change",this._curPlayState)}async queryPlayingClipTime(e){e=e||this._curEditClipUuid;const t=await this.getAnimationState(this._curEditClipRawClipIndex);return t?t.current:0}async setCurEditTime(e){this._curEditTime=e;const t=await this.getAnimationState(this._curEditClipRawClipIndex);if(!t)return!1;let i=e;return i>t.duration&&(i=t.duration),t.weight=1,t.play(),t.setTime(i),t.isPaused||t.pause(),t.sample(),cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:model-preview-animation-time-change",await this.queryPlayingClipTime()),!0}async setPlaybackRange(e,t){this._curPlaybackRange={min:e,max:t};const i=await this.getAnimationState(this._curEditClipRawClipIndex);return!!i&&(i.playbackRange={min:e,max:t},!0)}clearUpdateListener(){this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),timer_util_1.TimerUtil.clearMainProcessInterval(this._animUpdateInterval),this._animUpdateInterval=null)}async setClipConfig(e){const t=await this.getAnimationState(this._curEditClipRawClipIndex);return!!t&&(void 0!==e.wrapMode&&(t.wrapMode=e.wrapMode),void 0!==e.speed&&(t.speed=e.speed),!0)}}exports.ModelPreview=ModelPreview;