"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),dump_1=__importDefault(require("../../utils/dump")),{get:get}=require("lodash"),ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),CompMgr=EditorExtends.Component,utils_1=__importDefault(require("./utils")),node_1=__importDefault(require("../../../utils/node")),event_enum_1=require("../../../public/event-enum");class CompManager extends EventEmitter{init(){this.registerCompMgrEvents()}registerCompMgrEvents(){this._onCompAdded=this.add.bind(this),CompMgr.on("add",this._onCompAdded),this._onCompRemoved=this.remove.bind(this),CompMgr.on("remove",this._onCompRemoved)}unregisterCompMgrEvents(){this._onCompAdded&&CompMgr.off("add",this._onCompAdded),this._onCompRemoved&&CompMgr.off("remove",this._onCompRemoved)}clear(){CompMgr.clear()}add(e,t){node_1.default.isEditorNode(t.node)||this.emit("add-component",t)}remove(e,t){node_1.default.isEditorNode(t.node)||this.emit("remove-component",t)}query(e){return CompMgr.getComponent(e)||null}queryAll(){return CompMgr.getComponents()}queryAllRecycle(){return CompMgr.getRecycleComponents()}queryRecycle(e){return CompMgr.getRecycleComponent(e)||null}recycle(e){CompMgr.recycle(e)}removeComponent(e){return e.node._getDependComponent(e)?(console.warn("Dependent components cannot be removed."),!1):(this.emit("before-remove-component",e),e.node.removeComponent(e),cc.Object._deferredDestroy(),!0)}async resetComponent(e){try{const t=(new cc.Node).addComponent(e.constructor),o=dump_1.default.dumpComponent(t);for(const t in o.value)await dump_1.default.restoreProperty(e,t,o.value[t]);e&&e.onRestore&&e.onRestore()}catch(e){return console.error(e),!1}return!0}queryDump(e){const t=this.query(e);return t?dump_1.default.dumpComponent(t):null}async executeComponentMethod(e,t,o){const n=this.query(e);if(!n)return null;const r=(t||"").split("."),d=r.pop()||"";if(r.length>0){const e=r.join("."),t=get(n,e);if(t&&d&&t[d])return await t[d](...o||[])}return n[d]?await n[d](...o||[]):null}async setProperty(e,t,o){const n=this.query(e);if(!n)return!1;const r=n.node;return this.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",e),await dump_1.default.restoreProperty(n,t,o),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),Editor.Message.broadcast("scene:change-node",e),!0}onComponentAddedFromEditor(e){e&&e.constructor&&utils_1.default.addComponentMap[e.constructor.name]&&utils_1.default.addComponentMap[e.constructor.name](e,e.node)}}exports.default=new CompManager;