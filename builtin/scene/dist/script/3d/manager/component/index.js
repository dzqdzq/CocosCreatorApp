"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompManager=void 0;const events_1=require("events"),dump_1=__importDefault(require("../../../export/dump")),get=require("lodash")["get"],CompMgr=EditorExtends.Component,utils_1=__importDefault(require("./utils")),cc_1=require("cc"),node_1=__importDefault(require("../../../utils/node"));class CompManager extends events_1.EventEmitter{init(){this.registerCompMgrEvents()}_onCompAdded;_onCompRemoved;registerCompMgrEvents(){this._onCompAdded=this.add.bind(this),CompMgr.on("add",this._onCompAdded),this._onCompRemoved=this.remove.bind(this),CompMgr.on("remove",this._onCompRemoved)}unregisterCompMgrEvents(){this._onCompAdded&&CompMgr.off("add",this._onCompAdded),this._onCompRemoved&&CompMgr.off("remove",this._onCompRemoved)}clear(){CompMgr.clear()}add(e,o){node_1.default.isEditorNode(o.node)||this.emit("added",o)}remove(e,o){node_1.default.isEditorNode(o.node)||this.emit("removed",o)}query(e){return CompMgr.getComponent(e)||null}queryAll(){return CompMgr.getComponents()}queryRecycle(e){return cce.SceneFacadeManager.getCurrentFacade().queryRecycleComponent(e)}removeComponent(e){return 0<e.node._getDependComponent(e).length?(console.warn("Dependent components cannot be removed."),!1):(this.emit("before-remove-component",e),e.node.removeComponent(e),cc.Object._deferredDestroy(),this.emit("remove",e),!0)}async resetComponent(e){var o;if(e instanceof cc_1.MissingScript)return o=e&&e._$erialized&&e._$erialized.__type__?e._$erialized.__type__:"unknown",console.warn(`Reset Component failed: ${o} does not exist`),!1;var t=["name","node","uuid","enabled","_name","_enabled","_objFlags","_isOnLoadCalled","__scriptAsset","__eventTargets"];try{var r=(new cc.Node).addComponent(e.constructor),n=dump_1.default.dumpComponent(r);for(const d in n.value)t.includes(d)||await dump_1.default.restoreProperty(e,d,n.value[d]);e&&e.resetInEditor&&e.resetInEditor(),e&&e.onRestore&&e.onRestore()}catch(e){return console.error(e),!1}return!0}queryDump(e){e=this.query(e);return e?dump_1.default.dumpComponent(e):null}async executeComponentMethod(e,o,t){e=this.query(e);if(!e)return null;var o=(o||"").split("."),r=o.pop()||"";if(0<o.length){o=o.join("."),o=get(e,o);if(o&&r&&o[r])return o[r](...t||[])}return e[r]?e[r](...t||[]):null}async setProperty(e,o,t){e=this.query(e);return!!e&&(await dump_1.default.restoreProperty(e,o,t),!0)}onComponentAddedFromEditor(e){e&&(this.emit("add",e),e.constructor)&&utils_1.default.addComponentMap[e.constructor.name]&&utils_1.default.addComponentMap[e.constructor.name](e,e.node)}changeUUID(e,o){CompMgr.changeUUID(e,o)}}exports.CompManager=CompManager,exports.default=new CompManager;