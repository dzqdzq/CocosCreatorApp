"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,n)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MiniPreview=void 0;const apply=__importStar(require("./apply")),private_1=require("./private"),cc_1=require("cc"),selection_1=__importDefault(require("../selection")),node_1=__importDefault(require("../../manager/node")),component_1=__importDefault(require("../../manager/component")),scene_view_data_1=require("../scene-view/scene-view-data"),preview_base_1=require("../preview/preview-base"),buffer_1=__importDefault(require("../preview/buffer"));class MiniPreview extends preview_base_1.PreviewBase{constructor(){super(...arguments),this.previewNodes={},this.scene=null,this.renderScene=null,this.currNode=null}init(e,t){this.previewBuffer=new buffer_1.default(e,t),cc.director.root.destroyWindow(this.previewBuffer.window),this._previewInfo={width:scene_view_data_1.sceneViewData.targetResolution.width,height:scene_view_data_1.sceneViewData.targetResolution.height},scene_view_data_1.sceneViewData.on("target-resolution-changed",()=>{this._previewInfo={width:scene_view_data_1.sceneViewData.targetResolution.width,height:scene_view_data_1.sceneViewData.targetResolution.height},selection_1.default.query().forEach(e=>{const t=node_1.default.query(e);t&&this.onNodeChanged(t)})}),scene_view_data_1.sceneViewData.on("is-scene-light-on",()=>{selection_1.default.query().forEach(e=>{const t=node_1.default.query(e);t&&this.onNodeChanged(t)})})}onResize(){cce.Plugin.sendToFloatWindow("cc.Camera","viewResize")}setAspect(e,t){e.targetTexture?t._aspect=e.camera.aspect:t._aspect=scene_view_data_1.sceneViewData.targetAspect}onNodeChanged(e){if(!e)return;const t=e.getComponent("cc.Camera");if(t&&e===this.currNode&&t){this.previewNodes[t.uuid]||this.createPreviewNode(t);const e=this.previewNodes[t.uuid];apply.applyCamera(t,e.camera),this.setAspect(t,e.camera),cce.Engine.repaintInEditMode(),requestAnimationFrame(()=>{this.setPreviewInfo()})}}onNodeRemoved(e){const t=e.getComponent("cc.Camera");t&&this.removePreviewNode(t)}handleSelect(e){const t=component_1.default.query(e);t&&t.node.active&&t.node.activeInHierarchy&&t.enabled&&(cce.Engine.repaintInEditMode(),this.createPreviewNode(t))}handleUnselect(e){const t=component_1.default.query(e);t&&t instanceof cc_1.Camera&&this.removePreviewNode(t)}onComponentRemoved(e){e instanceof cc_1.Camera&&(cce.Engine.repaintInEditMode(),this.removePreviewNode(e))}clearByComponent(e){if(e instanceof cc_1.Camera){const{uuid:t}=e;this.previewBuffer.windows[t]&&this.previewBuffer.removeWindow(t),this.previewNodes[t]&&(this.previewNodes[t].node.destroy(),this.previewNodes[t].camera.destroy(),delete this.previewNodes[t])}}removePreviewNode(e){const t=e.node;for(let i=0;i<t.children.length;++i){const r=t.children[i].getComponent("cc.Camera");if(t.children[i].isPrivatePreview&&r){const r=t.children[i];r.destroy(),e.node.removeChild(r)}}this.currNode=null,this.clearByComponent(e)}createPreviewNode(e){this.clearByComponent(e);const t=e.node.name,i=(0,private_1.createPreviewNode)(t),r=i.addComponent("cc.Camera");if(e.node.addChild(i),!r.camera)return;r.camera.cameraUsage=cc_1.renderer.scene.CameraUsage.PREVIEW,this.previewNodes[e.uuid]={node:i,camera:r.camera};const n=this.previewNodes[e.uuid];return apply.applyCamera(e,n.camera),this.setAspect(e,n.camera),this.previewBuffer.windows[e.uuid]?(this.previewBuffer.window=this.previewBuffer.windows[e.uuid],this.clearPreviewBuffer()):this.previewBuffer.createWindow(e.uuid),this.previewBuffer.switchCameras(n.camera,this.previewBuffer.window),this.currNode=e.node,n}setPreviewInfo(){this._previewInfo.name="preview-plugin",cce.Plugin.sendToFloatWindow("cc.Camera",this._previewInfo)}getPreviewInfo(){return this._previewInfo}}exports.MiniPreview=MiniPreview;