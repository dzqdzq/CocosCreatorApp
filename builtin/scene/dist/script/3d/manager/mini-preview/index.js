"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const apply_1=__importDefault(require("./apply")),private_1=__importDefault(require("./private"));class MiniPreview{constructor(){this.previewNodes={},this.scene=null,this.renderScene=null,this.currNode=null}init(){this.previewBuffer=new cce.PreviewBuffer("scene:mini-preview","query-mini-preview-data")}onResize(){cce.Plugin.sendToFloatWindow("cc.Camera","viewResize")}setAspect(e,i){e.targetTexture?i._aspect=e.camera.aspect:i._aspect=this.previewBuffer.window.width/this.previewBuffer.window.height}onNodeChanged(e){const i=e.getComponent("cc.Camera");if(e===this.currNode&&i){cce.Engine.repaintInEditMode();const e=this.previewNodes[i.uuid];apply_1.default.applyCamera(i,e.camera),this.setAspect(i,e.camera),cce.Plugin.sendToFloatWindow("cc.Camera","cameraUpdate")}}onNodeRemoved(e){const i=e.getComponent("cc.Camera");if(i){const e=this.previewBuffer.windows;for(const[r]of Object.entries(e))if(i.uuid===r){delete e[r];break}}}removePreviewNode(e){const i=e.node;for(let r=0;r<i.children.length;++r){const t=i.children[r].getComponent("cc.Camera");if(i.children[r].isPrivatePreview&&t){const t=i.children[r];return e.node.removeChild(t),t}}return null}createPreviewNode(e){this.removePreviewNode(e);const i=new private_1.default("PrivatePreview"),r=i.addComponent("cc.Camera");e.node.addChild(i),r.camera.isEnable=!0,this.previewNodes[e.uuid]={node:i,camera:r.camera};const t=this.previewNodes[e.uuid];return apply_1.default.applyCamera(e,t.camera),this.setAspect(e,t.camera),t}handleSelect(e){const i=cce.Component.query(e);if(!i)return;if(!i.node.active||!i.enabled)return;cce.Engine.repaintInEditMode(),this.currNode=i.node;const r=this.currNode.getComponent("cc.Camera");if(r){this.previewBuffer.windows[r.uuid]?this.previewBuffer.window=this.previewBuffer.windows[r.uuid]:this.previewBuffer.createWindow(r.uuid);const e=this.createPreviewNode(r);this.previewBuffer.switchCameras(e.camera,this.previewBuffer.window)}}queryWindowList(){return this.previewBuffer.queryWindowList()}setPreviewInfo(e){this._previewInfo=e,cce.Plugin.sendToFloatWindow("cc.Camera",e)}getPreviewInfo(){return this._previewInfo}}exports.default=new MiniPreview;