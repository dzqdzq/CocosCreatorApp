"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const apply_1=__importDefault(require("./apply")),private_1=__importDefault(require("./private")),cc_1=require("cc"),selection_1=__importDefault(require("../selection")),node_1=__importDefault(require("../../manager/node")),component_1=__importDefault(require("../../manager/component")),scene_view_data_1=require("../scene-view/scene-view-data");class MiniPreview{constructor(){this.previewNodes={},this.scene=null,this.renderScene=null,this.currNode=null}init(){this.previewBuffer=new cce.PreviewBuffer("scene:mini-preview","query-mini-preview-data"),this._previewInfo={width:scene_view_data_1.sceneViewData.targetResolution.width,height:scene_view_data_1.sceneViewData.targetResolution.height},scene_view_data_1.sceneViewData.on("target-resolution-changed",()=>{selection_1.default.query().forEach(e=>{const t=node_1.default.query(e);this.onNodeChanged(t)})})}onResize(){cce.Plugin.sendToFloatWindow("cc.Camera","viewResize")}setAspect(e,t){e.targetTexture?t._aspect=e.camera.aspect:t._aspect=scene_view_data_1.sceneViewData.targetAspect}onNodeChanged(e){if(!e)return;const t=e.getComponent("cc.Camera");if(e===this.currNode&&t){const e=this.previewNodes[t.uuid];apply_1.default.applyCamera(t,e.camera),this.setAspect(t,e.camera),cce.Engine.repaintInEditMode(),requestAnimationFrame(()=>{this.setPreviewInfo({width:scene_view_data_1.sceneViewData.targetResolution.width,height:scene_view_data_1.sceneViewData.targetResolution.height})})}}onNodeRemoved(e){const t=e.getComponent("cc.Camera");if(t){const e=this.previewBuffer.windows;for(const[i]of Object.entries(e))if(t.uuid===i){delete e[i];break}}}removePreviewNode(e){const t=e.node;for(let i=0;i<t.children.length;++i){const r=t.children[i].getComponent("cc.Camera");if(t.children[i].isPrivatePreview&&r){const r=t.children[i];return e.node.removeChild(r),r.destroy(),r}}return null}createPreviewNode(e){this.removePreviewNode(e);const t=new private_1.default("PrivatePreview"),i=t.addComponent("cc.Camera");e.node.addChild(t),i.camera.isEnable=!0,this.previewNodes[e.uuid]={node:t,camera:i.camera};const r=this.previewNodes[e.uuid];return apply_1.default.applyCamera(e,r.camera),this.setAspect(e,r.camera),r}handleSelect(e){const t=component_1.default.query(e);if(!t)return;if(!t.node.active||!t.node.activeInHierarchy||!t.enabled)return;cce.Engine.repaintInEditMode(),this.currNode=t.node;const i=this.currNode.getComponent("cc.Camera");if(i){this.previewBuffer.windows[i.uuid]?this.previewBuffer.window=this.previewBuffer.windows[i.uuid]:this.previewBuffer.createWindow(i.uuid);const e=this.createPreviewNode(i);this.previewBuffer.switchCameras(e.camera,this.previewBuffer.window)}}handleUnselect(e){const t=component_1.default.query(e);t&&t instanceof cc_1.Camera&&this.removePreviewNode(t)}queryWindowList(){return this.previewBuffer.queryWindowList()}setPreviewInfo(e){this._previewInfo=e,this._previewInfo.name="preview-plugin",cce.Plugin.sendToFloatWindow("cc.Camera",e)}getPreviewInfo(){return this._previewInfo}}exports.default=new MiniPreview;