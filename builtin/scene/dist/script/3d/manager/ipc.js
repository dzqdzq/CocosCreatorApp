"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startup=void 0;const webview_1=__importDefault(require("../../public/ipc/webview")),queue=[];let lock=!0;function startup(){lock=!1,step()}async function step(){if(lock)return;const e=queue.shift();if(!e)return;const t=e.options,o=cce[t.module];if(!o)throw new Error(`Module [${t.module}] does not exist.(Method: ${t.handler})`);if(!o[t.handler])throw new Error(`Method [${t.handler}] does not exist.(Module: ${t.module})`);lock=!0;try{const r=o[t.handler](...t.params);if(r instanceof Promise){const o=setTimeout(()=>{e.reject(new Error(`${t.module}.${t.handler} timeout.\n  ${JSON.stringify(t.params)}`))},3e4);r.then(t=>{clearTimeout(o),e.resolve(t)}).catch(t=>{clearTimeout(o),e.reject(t)})}else e.resolve(r)}catch(t){e.reject(t)}finally{lock=!1,step()}}exports.startup=startup,webview_1.default.startup=startup,webview_1.default.on("call-method",e=>{if(e.queue)return new Promise((t,o)=>{queue.push({options:e,resolve:t,reject:o}),step()});{const t=cce[e.module];if(!t)throw new Error(`Module [${e.module}] does not exist.(Method: ${e.handler})`);if(!t[e.handler])throw new Error(`Method [${e.handler}] does not exist.(Module: ${e.module})`);const o=t[e.handler](...e.params);return new Promise((t,r)=>{if(o instanceof Promise)if(e.timeout){const s=setTimeout(()=>{r(new Error(`${e.module}.${e.handler} timeout.\n  ${JSON.stringify(e.params)}`))},3e4);o.then(e=>{clearTimeout(s),t(e)}).catch(e=>{clearTimeout(s),r(e)})}else o.then(e=>{t(e)}).catch(e=>{r(e)});else t(o)})}}),exports.default=webview_1.default;