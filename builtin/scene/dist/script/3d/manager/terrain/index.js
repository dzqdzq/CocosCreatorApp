"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const _=require("lodash"),cc_1=require("cc"),path_1=require("path"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),node_1=__importDefault(require("../node")),plugin_1=__importDefault(require("../plugin")),selection_1=__importDefault(require("../selection"));class TerrainManager extends EventEmitter_1.default{constructor(){super(...arguments),this.editedComponents=[],this.selectedComponents=[]}get name(){return"cc.Terrain"}init(){selection_1.default.on("select",e=>{this.select(e)}),selection_1.default.on("unselect",e=>{this.unselect(e)})}select(e){const t=find(node_1.default.query(e)._components,this.name);t&&(t.manager=this,this.selectedComponents.includes(t)||this.selectedComponents.push(t),this.editedComponents.includes(t)||this.editedComponents.push(t))}unselect(e){const t=node_1.default.query(e),s=find(t._components,this.name);if(s){s.manager=null;const e=this.selectedComponents.indexOf(s);if(-1!==e&&this.selectedComponents.splice(e,1),t.objFlags&cc.Object.Flags.Destroying||t.objFlags&cc.Object.Flags.Destroyed){const e=this.editedComponents.indexOf(s);-1!==e&&this.editedComponents.splice(e,1)}}}set isTerrainChange(e){this.selectedComponents.forEach(t=>{t.isTerrainChange=e})}get isTerrainChange(){let e=!1;return this.editedComponents.forEach(t=>{t.isTerrainChange&&(e=t.isTerrainChange)}),e}onSculpt(e){this.emit("sculpt",e)}async close(){if(!this.isTerrainChange)return 1;return await this.saveAssetDialog("",!0)}async saveAssetDialog(e,t){let s=1;for(const e of this.editedComponents){if(!e.isTerrainChange)continue;if(e._asset&&e._asset._uuid){if(await Editor.Message.request("asset-db","query-asset-info",e._asset._uuid)){const n=await this.saveAsset(t,e);2===n&&(s=n);continue}}let n=(await Editor.Dialog.save({title:Editor.I18n.t("scene.terrain.is_create_message"),path:path_1.join(Editor.Project.path,"assets"),filters:[{name:"Terrains",extensions:["terrain"]}]})).filePath||"";if(!Array.isArray(n)){e.isTerrainChange=!1;continue}n=n[0];const i=path_1.join(Editor.Project.path,"assets");if(!Editor.Utils.Path.contains(i,n)){await Editor.Dialog.warn(Editor.I18n.t("scene.messages.warning"),{detail:Editor.I18n.t("scene.terrain.path_unlegal"),buttons:[Editor.I18n.t("scene.messages.confirm")]}),s=2;continue}const a=await Editor.Message.request("asset-db","query-url",n);if(a){const t=this.serialize(e);await Editor.Message.request("asset-db","create-asset",a,Buffer.from(t))?e.isTerrainChange=!1:s=2}}return s}async saveAsset(e=!1,t){let s=1,n=!1;if(t.isTerrainChange){if(e){let e="Terrain component";const n=await Editor.Message.request("asset-db","query-asset-info",t._asset._uuid);n&&(e=`${n.url}.\n${e}`),s=await cce.Ipc.send("dirty-dialog",e)}else s=0;switch(s){case 0:{const e=this.serialize(t);(n=await cce.Ipc.send("save-asset",t._asset._uuid,e))?t.isTerrainChange=!1:s=2}break;case 1:t.isTerrainChange=!1}}return s}serialize(e){return e.exportAsset()._exportNativeData()}onRemoveTerrain(e,t){for(const t of this.editedComponents)t._asset&&t._asset._uuid===e&&(node_1.default.emit("change",t.node),plugin_1.default.forceUpdateToolbar())}async addAssetToComp(e){for(const t of this.selectedComponents)e?await new Promise(s=>{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),cc_1.assetManager.loadAny(e,(e,n)=>{t._asset=n,node_1.default.emit("change",t.node),s(!0)})}):(t.gizmo&&t.gizmo.setCurrentEditMode(0),t._asset||(t._asset=new cc_1.TerrainAsset,t.isTerrainChange=!1)),cce.Plugin.forceUpdateToolbar()}}function find(e,t){return e.find(e=>e.__classname__===t)}exports.default=new TerrainManager;