"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ParticleManager=void 0;const node_1=__importDefault(require("./node")),component_1=__importDefault(require("./component")),cc_1=require("cc"),selection_1=__importDefault(require("./selection")),index_1=__importDefault(require("../manager/scene/index")),events_1=__importDefault(require("events")),scene_facade_state_interface_1=require("../facade/scene-facade-state-interface");class ParticleManager{constructor(){this.stoppedParticleSet=new WeakSet,this._selectedUUIDs=[],this._onSelect=null,this._onUnselect=null}get currentMode(){return this._currentMode||Editor.EditMode.getMode()}set currentMode(e){if(this._currentMode!==e){switch(this._currentMode){case scene_facade_state_interface_1.SceneModeType.Animation:this.onExitAnimationMode();break;case scene_facade_state_interface_1.SceneModeType.General:this.onExitGeneralMode();break;case scene_facade_state_interface_1.SceneModeType.Prefab:this.onExitPrefabMode()}switch(this._currentMode=e,this._currentMode){case scene_facade_state_interface_1.SceneModeType.Animation:this.onEnterAnimationMode();break;case scene_facade_state_interface_1.SceneModeType.General:this.onEnterGeneralMode();break;case scene_facade_state_interface_1.SceneModeType.Prefab:this.onEnterPrefabMode()}}}onResize(e){}onSceneOpened(e){}onSceneReload(e){}onSceneClosed(e){}onNodeChanged(e,t){}onAddNode(e){}onRemoveNode(e){}onNodeAdded(e,t){}onNodeRemoved(e,t){}onAddComponent(e){}onRemoveComponent(e){}onComponentAdded(e,t){e instanceof cc_1.ParticleSystemComponent&&this.getSelectedParticleSystemComponents().includes(e)&&!e.isPlaying&&e.play()}onComponentRemoved(e,t){}onSelect(e,t){this._selectedUUIDs=t.slice();const n=this.getSelectedParticleSystemComponents();n.some(e=>!this.stoppedParticleSet.has(e))&&n.forEach(e=>this.stoppedParticleSet.delete(e)),n.forEach(e=>{e.isPlaying||this.stoppedParticleSet.has(e)||e.play()})}onUnselect(e,t){this.getSelectedParticleSystemComponents().forEach(e=>{!t.includes(e.node.uuid)&&e.isPlaying&&e.pause()}),this._selectedUUIDs=t.slice()}onEnterGeneralMode(){this._onSelect||(this._onSelect=this.onSelect.bind(this)),this._onUnselect||(this._onUnselect=this.onUnselect.bind(this)),selection_1.default.on("select",this._onSelect),selection_1.default.on("unselect",this._onUnselect)}onExitGeneralMode(){this._onSelect&&selection_1.default.off("select",this._onSelect),this._onUnselect&&selection_1.default.off("unselect",this._onUnselect),this.getSelectedParticleSystemComponents().forEach(e=>{e.isPlaying&&e.stop()})}onEnterAnimationMode(){this.getSelectedParticleSystemComponents().forEach(e=>{!e.isPlaying&&e.playOnAwake&&e.play()})}onExitAnimationMode(){}onEnterPrefabMode(){this.onEnterGeneralMode()}onExitPrefabMode(){this.onExitGeneralMode()}init(){this.currentMode=Editor.EditMode.getMode(),index_1.default instanceof events_1.default&&index_1.default.on("mode-change",e=>{this.currentMode=e})}queryPlayInfo(e){const t=component_1.default.query(e);return t?{speed:t.simulationSpeed,time:t.time.toFixed(2),particle:t.getParticleCount(),isPlaying:t.isPlaying}:null}setPlaySpeed(e,t){const n=component_1.default.query(e);if(!n)return;n.simulationSpeed=t;const o=n.node,s=o._components.indexOf(n);if(-1===s)return;const i=`__comps__.${s}.simulationSpeed`;node_1.default.emit("change",o,{propPath:i})}play(){this.getSelectedParticleSystemComponents().forEach(e=>{e.isPlaying||(e.play(),this.stoppedParticleSet.delete(e))})}stop(){this.getSelectedParticleSystemComponents().forEach(e=>{e.isStopped||(e.stop(),this.stoppedParticleSet.add(e))})}pause(){this.getSelectedParticleSystemComponents().forEach(e=>{e.isPaused||(e.pause(),this.stoppedParticleSet.add(e))})}restart(){this.getSelectedParticleSystemComponents().forEach(e=>{e.isStopped||e.stop(),e.isPlaying||(e.play(),this.stoppedParticleSet.delete(e))})}getSelectedParticleSystemComponents(){const e=[];function t(n){if(n.getComponent(cc_1.ParticleSystemComponent)){const o=n.getParent();if(o&&null!==o.getComponent(cc_1.ParticleSystemComponent))t(o);else{!function(t){for(let n=0;n<t.length;n++){const o=t[n];e.includes(o)||e.push(o)}}(n.getComponentsInChildren(cc_1.ParticleSystemComponent))}}}for(let e=0;e<this._selectedUUIDs.length;e++){const n=this._selectedUUIDs[e],o=node_1.default.query(n);o&&t(o)}return e.filter(e=>e.enabled)}}exports.ParticleManager=ParticleManager,exports.default=new ParticleManager;