"use strict";var __importDefault=this&&this.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),ui_1=__importDefault(require("./ui")),stateInfo_1=__importDefault(require("./stateInfo")),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default,editor_mask=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);class GamePreview{constructor(i){this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.data=Buffer.alloc(this.width*this.height*4),this.uiData=Buffer.alloc(this.width*this.height*4),this.windows={},this.windowList=[],this.regions=[new cc_1.gfx.BufferTextureCopy],this.uiRegions=[new cc_1.gfx.BufferTextureCopy],this.renderScene=null,this.scene=null,this.glPreview=null,this.glUIPreview=null,this.gamePreview=null,this.ui=null,this.uiWindow=null,this.uiCamera=null,this.canvasComp=null,this._priorities=[],this.gamePreview=i,this.glPreview=new GlPreview,this.glPreview.isMulFramebuffer=!0,this.glPreview.initGL(i.canvas),this.regions[0].texExtent.width=this.width,this.regions[0].texExtent.height=this.height,this.regions[0].texExtent.depth=1,this.uiRegions[0].texExtent.width=this.width,this.uiRegions[0].texExtent.height=this.height,this.uiRegions[0].texExtent.depth=2,this.handleEvent(),cc.director._scene.active&&this.patchSceneCameras(cc.director._scene),cce.Scene.on("open",this.patchSceneCameras.bind(this)),cce.Scene.on("reload",this.patchSceneCameras.bind(this))}handleEvent(){cce.Node.on("add",i=>{!cc.GAME_VIEW&&cce.Engine.repaintInEditMode();const e=i.getComponent("cc.Camera");if(e){let i=this.scene.getComponentInChildren("cc.Canvas");if(i&&i.cameraComponent==e){const i=requestAnimationFrame(()=>{e.camera&&(cancelAnimationFrame(i),this._applyUI(),cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height)))});return}const t=requestAnimationFrame(()=>{e.camera&&(cancelAnimationFrame(t),this.createWindow(e.uuid),this.switchCameras(e.camera,this.window),this._applyPriorityCameras(e),this._applyCameraFramebuffer())})}}),cce.Node.on("change",i=>{const e=i.getComponent("cc.Camera");if(e){let i=this.scene.getComponentInChildren("cc.Canvas");i&&i.cameraComponent==e||(this._priorities.sort(this._sortByPriority),this._applyCameraFramebuffer())}cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height))}),cce.Node.on("remove",i=>{!cc.GAME_VIEW&&cce.Engine.repaintInEditMode();const e=i.getComponent("cc.Camera");if(e){if(e.camera===this.uiCamera)return this.uiData.fill(0),this.uiWindow=null,this.uiCamera=null,void(cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height)));this._priorities.includes(e)&&(this._priorities.splice(this._priorities.indexOf(e),1),this._priorities.sort(this._sortByPriority),this._applyCameraFramebuffer()),this.windows[e.uuid]&&delete this.windows[e.uuid]}})}createWindow(i,e="Preview",t=!0){if(this.windows[i])return this.window=this.windows[i],this.window;const s=new cc_1.gfx.ColorAttachment;s.endLayout=cc_1.gfx.TextureLayout.SHADER_READONLY_OPTIMAL;const r=new cc_1.gfx.DepthStencilAttachment,h=cc.director.root.createWindow({title:e,width:this.width,height:this.height,renderPassInfo:{colorAttachments:[s],depthStencilAttachment:r},isOffscreen:!0});return t&&(this.window=this.windows[i]=h),h}_applyUI(){const i=this.scene.getComponentInChildren("cc.Canvas");i&&(this.canvasComp=i,this.ui=new ui_1.default(this.gamePreview,i),this.uiWindow=this.createWindow(null,"uiPreview",!1),this.uiCamera=this.ui.camera,this.switchCameras(this.ui.camera,this.uiWindow,!1))}_sortByPriority(i,e){return i.priority<e.priority?1:i.priority>e.priority?-1:0}_applyPriorityCameras(i){return null===i?this._priorities:this._priorities.includes(i)?this._priorities:(this._priorities.push(i),this._priorities.sort(this._sortByPriority),this._priorities)}_applyCameraFramebuffer(){let i=this._priorities[0];i&&(this.createWindow(i.uuid),this.switchCameras(i.camera,this.window),!cc.GAME_VIEW&&this.applyFrameData(this.width,this.height))}patchSceneCameras(i){this.scene=i,this._priorities=[],this.renderScene=i.renderScene;const e=this.renderScene.cameras,t=this.scene.getComponentInChildren("cc.Canvas");for(const i of e){if(i.node.layer&editor_mask||t&&t.cameraComponent&&t.cameraComponent.camera==i)continue;const e=i.node.getComponent("cc.Camera");e&&!i.node.isPrivatePreview&&(this._applyPriorityCameras(e),this.createWindow(e.uuid),this.switchCameras(i,this.window),this.resize(this.width,this.height))}this._applyCameraFramebuffer(),this._applyUI()}switchCameras(i,e,t=!0){i&&(t&&(this.camera=i),i.isWindowSize=!1,i.isEnable=!0,i.changeTargetWindow(e),cc.director.root.tempWindow=e)}resize(i,e){this.width=i,this.height=e,this.regions[0].texExtent.width=i,this.regions[0].texExtent.height=e,this.uiRegions[0].texExtent.width=i,this.uiRegions[0].texExtent.height=e,this.glPreview.resizeGL(i,e),this.gamePreview.resize(i,e),this.window&&this.window.resize(i,e),this.camera&&this.camera.resize(i,e),this.uiWindow&&this.uiWindow.resize(i,e),this.uiCamera&&this.uiCamera.resize(i,e),this.data=Buffer.alloc(this.width*this.height*4),this.uiData=Buffer.alloc(this.width*this.height*4)}copyFrameBuffer(){const i=this.window.framebuffer;return this.device.copyFramebufferToBuffer(i,this.data.buffer,this.regions),this.data}copyUIFrameBuffer(){const i=this.uiWindow.framebuffer;return this.device.copyFramebufferToBuffer(i,this.uiData.buffer,this.uiRegions),this.uiData}applyFrameData(i,e){cc.gameView.isClose||(i===this.width&&e===this.height||this.resize(i,e),this.camera&&this.camera.update(!0),this.uiCamera&&this.uiCamera.update(!0),stateInfo_1.default.show(),cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{let t=this.data,s=this.uiData;this.window&&(t=this.copyFrameBuffer()),this.uiWindow&&(s=this.copyUIFrameBuffer()),this.glPreview.drawGLArray([t,s],i,e)}))}}exports.default=GamePreview;