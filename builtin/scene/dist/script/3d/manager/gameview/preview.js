"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),ui_1=__importDefault(require("./ui")),stateInfo_1=__importDefault(require("./stateInfo")),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default,editor_mask=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);class GamePreview{constructor(e){this.device=cc.director.root.device,this.width=this.device.width,this.height=this.device.height,this.data=Buffer.alloc(this.width*this.height*4),this.uiData=Buffer.alloc(this.width*this.height*4),this.windows={},this.windowList=[],this.regions=[new cc_1.gfx.BufferTextureCopy],this.uiRegions=[new cc_1.gfx.BufferTextureCopy],this.renderScene=null,this.scene=null,this.glPreview=null,this.glUIPreview=null,this.gamePreview=null,this.ui=null,this.uiWindow=null,this.uiCamera=null,this.canvasComp=null,this._priorities=[],this.gamePreview=e,this.glPreview=new GlPreview,this.glPreview.isMulFramebuffer=!0,this.glPreview.initGL(e.canvas),this.regions[0].texExtent.width=this.width,this.regions[0].texExtent.height=this.height,this.regions[0].texExtent.depth=1,this.uiRegions[0].texExtent.width=this.width,this.uiRegions[0].texExtent.height=this.height,this.uiRegions[0].texExtent.depth=2,this.handleEvent(),cc.director._scene.active&&this.patchSceneCameras(cc.director._scene),cce.Scene.on("open",this.patchSceneCameras.bind(this)),cce.Scene.on("reload",this.patchSceneCameras.bind(this))}handleEvent(){cce.Node.on("add",e=>{!cc.GAME_VIEW&&cce.Engine.repaintInEditMode();const i=e.getComponent("cc.Camera");if(i){let e=this.scene.getComponentInChildren("cc.Canvas");if(e&&e.cameraComponent==i){const e=requestAnimationFrame(()=>{i.camera&&(cancelAnimationFrame(e),this._applyUI(),cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height)))});return}const t=requestAnimationFrame(()=>{i.camera&&(cancelAnimationFrame(t),this.createWindow(i.uuid),this.switchCameras(i.camera,this.window),this._applyPriorityCameras(i),this._applyCameraFramebuffer())})}}),cce.Node.on("change",e=>{const i=e.getComponent("cc.Camera");if(i){let e=this.scene.getComponentInChildren("cc.Canvas");e&&e.cameraComponent==i||(this._priorities.sort(this._sortByPriority),this._applyCameraFramebuffer())}cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height))}),cce.Node.on("remove",e=>{!cc.GAME_VIEW&&cce.Engine.repaintInEditMode();const i=e.getComponent("cc.Camera");if(i){if(i.camera===this.uiCamera)return this.uiData.fill(0),this.uiWindow=null,this.uiCamera=null,void(cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.applyFrameData(this.width,this.height)));this._priorities.includes(i)&&(this._priorities.splice(this._priorities.indexOf(i),1),this._priorities.sort(this._sortByPriority),this._applyCameraFramebuffer()),this.windows[i.uuid]&&delete this.windows[i.uuid]}})}createWindow(e,i="Preview",t=!0){if(this.windows[e])return this.window=this.windows[e],this.window;const s=new cc_1.gfx.ColorAttachment;s.endAccesses=[cc_1.gfx.AccessType.FRAGMENT_SHADER_READ_TEXTURE];const r=new cc_1.gfx.DepthStencilAttachment,h=cc.director.root.createWindow({title:i,width:this.width,height:this.height,renderPassInfo:{colorAttachments:[s],depthStencilAttachment:r},isOffscreen:!0});return t&&(this.window=this.windows[e]=h),h}_applyUI(){const e=this.scene.getComponentInChildren("cc.Canvas");e&&(this.canvasComp=e,this.ui=new ui_1.default(this.gamePreview,e),this.uiWindow=this.createWindow(null,"uiPreview",!1),this.uiCamera=this.ui.camera,this.switchCameras(this.ui.camera,this.uiWindow,!1))}_sortByPriority(e,i){return e.priority<i.priority?1:e.priority>i.priority?-1:0}_applyPriorityCameras(e){return null===e?this._priorities:this._priorities.includes(e)?this._priorities:(this._priorities.push(e),this._priorities.sort(this._sortByPriority),this._priorities)}_applyCameraFramebuffer(){let e=this._priorities[0];e&&(this.createWindow(e.uuid),this.switchCameras(e.camera,this.window),!cc.GAME_VIEW&&this.applyFrameData(this.width,this.height))}patchSceneCameras(e){this.scene=e,this._priorities=[],this.renderScene=e.renderScene;const i=this.renderScene.cameras,t=this.scene.getComponentInChildren("cc.Canvas");for(const e of i){if(e.node.layer&editor_mask||t&&t.cameraComponent&&t.cameraComponent.camera==e)continue;const i=e.node.getComponent("cc.Camera");i&&!e.node.isPrivatePreview&&(this._applyPriorityCameras(i),this.createWindow(i.uuid),this.switchCameras(e,this.window),this.resize(this.width,this.height))}this._applyCameraFramebuffer(),this._applyUI()}switchCameras(e,i,t=!0){e&&(t&&(this.camera=e),e.isWindowSize=!1,e.isEnable=!0,e.changeTargetWindow(i),cc.director.root.tempWindow=i)}resize(e,i){this.width=e,this.height=i,this.regions[0].texExtent.width=e,this.regions[0].texExtent.height=i,this.uiRegions[0].texExtent.width=e,this.uiRegions[0].texExtent.height=i,this.glPreview.resizeGL(e,i),this.gamePreview.resize(e,i),this.window&&this.window.resize(e,i),this.camera&&this.camera.resize(e,i),this.uiWindow&&this.uiWindow.resize(e,i),this.uiCamera&&this.uiCamera.resize(e,i),this.data=Buffer.alloc(this.width*this.height*4),this.uiData=Buffer.alloc(this.width*this.height*4)}copyFrameBuffer(){const e=this.window.framebuffer;return this.device.copyTextureToBuffers(e.colorTextures[0],[new Uint8Array(this.data.buffer)],this.regions),this.data}copyUIFrameBuffer(){const e=this.uiWindow.framebuffer;return this.device.copyTextureToBuffers(e.colorTextures[0],[new Uint8Array(this.uiData.buffer)],this.uiRegions),this.uiData}applyFrameData(e,i){cc.gameView.isClose||(e===this.width&&i===this.height||this.resize(e,i),this.camera&&this.camera.update(!0),this.uiCamera&&this.uiCamera.update(!0),stateInfo_1.default.show(),cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{let t=this.data,s=this.uiData;this.window&&(t=this.copyFrameBuffer()),this.uiWindow&&(s=this.copyUIFrameBuffer()),this.glPreview.drawGLArray([t,s],e,i)}))}}exports.default=GamePreview;