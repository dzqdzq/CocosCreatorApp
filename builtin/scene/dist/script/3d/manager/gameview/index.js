"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const preview_1=__importDefault(require("./preview")),toolbar_1=__importDefault(require("./toolbar")),stateInfo_1=__importDefault(require("./stateInfo")),cc_1=require("cc"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),message_1=require("../message"),path=require("path");var Platform;!function(e){e.BROWSER="browser",e.GAME_VIEW="gameView"}(Platform||(Platform={}));let rtime=new Date,timeout=!1,delta=200;class GameView extends EventEmitter_1.default{constructor(){super(...arguments),this._currPlatform=Platform.BROWSER,this._isClose=!0,this.rotateRatio=0,this.currRatio=0,this.currRes=new cc_1.Vec2(0,0)}initStyle(){this._body.style.width="100%",this._body.style.height="100%",this._body.style.padding="0px",this._body.style.margin="0px",this._body.style.overflow="hidden"}createCanvas(){this.container=this._document.createElement("div"),this.canvas=this._document.createElement("canvas"),this.canvas.id="GameCanvas",this.container.appendChild(this.canvas),this._body.appendChild(this.container)}get document(){return this._document}get isClose(){return this._isClose}get head(){return this._head}changeGameMode(e){e?this.play():this.stop()}async getGameScene(){let e,t,i=await Editor.Profile.getConfig("preview","general.start_scene"),s=new Promise((i,s)=>{e=i,t=s});return"current_scene"!==i?cc_1.assetManager.loadAny(i,(i,s)=>{i?t(i):e(cce.Utils.serialize(s.scene))}):e(cce.Utils.serialize(this.preview.scene)),s}async play(){this._isClose&&(cc.internal.inputManager._isRegisterEvent=!1,this.init()),cc.GAME_VIEW=!0;const e=await Editor.Message.request("preview","generate-settings",{type:"game-view"});for(let t=0;t<e.bundleConfigs.length;t++){const i=e.bundleConfigs[t];if(i.importBase="import://",i.nativeBase="import://","resources"===i.name)cc.resources.init(i);else{(new cc.AssetManager.Bundle).init(i)}}let t=await this.getGameScene();this._currSceneData=cce.Utils.serialize(this.preview.scene),cce.SceneFacadeManager.softReloadScene(t),cce.Engine.pause(),cc.director.resume(),cc.game.resume(),cc.director.on(cc.Director.EVENT_AFTER_DRAW,this.repaint,this),cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeLaunch)}beforeLaunch(){cce.Node.clear()}repaint(){this._isClose||this.preview.applyFrameData(this.canvas.width,this.canvas.height)}pause(e){e?cc.director.pause():cc.director.resume()}platform(e){switch(this._currPlatform=e,e){case Platform.BROWSER:break;case Platform.GAME_VIEW:this._isClose&&(cc.internal.inputManager._isRegisterEvent=!1,this.init())}}close(){this._currPlatform===Platform.GAME_VIEW&&this.window&&this.window.close()}stop(){for(const e in cc.game._persistRootNodes)cc.game._persistRootNodes[e]!==cce.foregroundNode&&cc.game._persistRootNodes[e]!==cce.backgroundNode&&cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.GAME_VIEW=!1,cc.game.pause(),cce.Engine.resume(),cce.SceneFacadeManager.softReloadScene(this._currSceneData),cc.director._compScheduler.unscheduleAll(),cc.director.off(cc.Director.EVENT_AFTER_DRAW,this.repaint,this),this.emit("stop_gameview"),message_1.messageManager.broadcast("scene:gameview-stop")}step(){cc.director.resume(),setTimeout(()=>{cc.director.pause()},100)}_resizeEnd(e){new Date-rtime<delta?setTimeout(this._resizeEnd.bind(this,e),delta):(timeout=!1,this.setResolution(this.currRatio,toolbar_1.default.isRotate,this.currRes),cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.repaint()))}setResolution(e,t,i){let s=this.window.innerWidth,a=this.window.innerHeight;if(this.currRatio=e,this.currRes=i,i.x||i.y)s=i.x,a=i.y;else{if(e){const t=this.window.innerHeight*e;t<this.window.innerWidth?s=t:a=s/e}t&&(this.rotateRatio=a/s,s=a*this.rotateRatio)}this.preview.applyFrameData(s,a)}onResize(){this.window.addEventListener("resize",e=>{rtime=new Date,!1===timeout&&(timeout=!0,setTimeout(this._resizeEnd.bind(this,e),delta))},!1)}_loadStyle(){let e=this._document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href="packages://scene/static/style/gameview.css",this.head.appendChild(e)}init(){let e=cc.director.root.device;this.window=window.open("","GameView",`location=no,resizable=no,titlebar=no,width=${e.width+5},height=${e.height+30}`),this._document=this.window.document,this._head=this._document.head,this._body=this._document.body,this._loadStyle(),this.initStyle(),stateInfo_1.default.create(this._document),toolbar_1.default.statePanel=stateInfo_1.default.statePanel,toolbar_1.default.createToolbar(this._document),this.createCanvas(),this.preview=new preview_1.default(this),this.onResize(),this._isClose=!1,this.window.onbeforeunload=(()=>{this._isClose=!0})}setFps(e){cc.game.setFrameRate(e)}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`}}cc.gameView=new GameView,exports.default=cc.gameView;