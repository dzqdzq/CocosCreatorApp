"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const toolbar_1=__importDefault(require("./toolbar")),stateInfo_1=__importDefault(require("./stateInfo")),cc_1=require("cc"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),message_1=require("../message"),EDITOR_MASK=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);var Platform;!function(e){e.BROWSER="browser",e.GAME_VIEW="gameView"}(Platform||(Platform={}));let rtime=new Date,timeout=!1;const delta=200;class GameView extends EventEmitter_1.default{constructor(){super(...arguments),this._currPlatform=Platform.BROWSER,this._isClose=!0,this.rotateRatio=0,this.currRatio=0,this.currRes=new cc_1.Vec2(0,0)}initStyle(){this._body.style.width="100%",this._body.style.height="100%",this._body.style.padding="0px",this._body.style.margin="0px",this._body.style.overflow="hidden"}createCanvas(){this.container=this._document.createElement("div"),this.canvas=this._document.createElement("canvas"),this.canvas.id="GameCanvas",this.container.appendChild(this.canvas),this._body.appendChild(this.container)}get document(){return this._document}get isClose(){return this._isClose}get head(){return this._head}changeGameMode(e){e?this.play():this.stop()}async getGameScene(){const e=await Editor.Profile.getConfig("preview","general.start_scene");let t,i;const s=new Promise((e,s)=>{t=e,i=s});return console.log("getGameScene === current","current_scene"!==e),cc_1.assetManager.loadAny(e,(e,s)=>{e?i(e):t(cce.Utils.serialize(s.scene))}),s}async play(){this._isClose&&this.init(),cc.GAME_VIEW=!0;const e=await Editor.Message.request("preview","generate-settings",{type:"game-view"});for(let t=0;t<e.bundleConfigs.length;t++){const i=e.bundleConfigs[t];if(i.importBase="import://",i.nativeBase="import://","resources"===i.name)cc.resources.init(i);else{(new cc.AssetManager.Bundle).init(i)}}const t=await this.getGameScene();this._currSceneData=cce.Utils.serialize(this.preview.scene),cce.SceneFacadeManager.softReloadScene(t),cce.Engine.pause(),cc.director.resume(),cc.game.resume(),cc.director.on(cc.Director.EVENT_AFTER_DRAW,this.repaint,this),cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeLaunch)}beforeLaunch(){cce.Node.clear()}repaint(){this._isClose||this.preview.applyFrameData(this.canvas.width,this.canvas.height)}pause(e){e?cc.director.pause():cc.director.resume()}platform(e){switch(this._currPlatform=e,e){case Platform.BROWSER:break;case Platform.GAME_VIEW:this._isClose&&this.init()}}close(){this._currPlatform===Platform.GAME_VIEW&&this.window&&this.window.close()}step(){cc.director.resume(),setTimeout(()=>{cc.director.pause()},100)}_resizeEnd(e){new Date-rtime<delta?setTimeout(this._resizeEnd.bind(this,e),delta):(timeout=!1,this.setResolution(this.currRatio,toolbar_1.default.isRotate,this.currRes),cc.GAME_VIEW||(cce.Engine.repaintInEditMode(),this.repaint()))}setResolution(e,t,i){let s=this.window.innerWidth,a=this.window.innerHeight;if(this.currRatio=e,this.currRes=i,i.x||i.y)s=i.x,a=i.y;else{if(e){const t=this.window.innerHeight*e;t<this.window.innerWidth?s=t:a=s/e}t&&(this.rotateRatio=a/s,s=a*this.rotateRatio)}this.preview.applyFrameData(s,a)}onResize(){this.window.addEventListener("resize",e=>{rtime=new Date,!1===timeout&&(timeout=!0,setTimeout(this._resizeEnd.bind(this,e),delta))},!1)}_loadStyle(){const e=this._document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href="packages://scene/static/style/gameview.css",this.head.appendChild(e)}init(){const e=cc.director.root.device;this.window=window.open("","GameView",`location=no,resizable=no,titlebar=no,width=${e.width+5},height=${e.height+30}`),this._document=this.window.document,this._head=this._document.head,this._body=this._document.body,this._loadStyle(),this.initStyle(),stateInfo_1.default.create(this._document),toolbar_1.default.statePanel=stateInfo_1.default.statePanel,toolbar_1.default.createToolbar(this._document),this.createCanvas(),this.onResize(),this._isClose=!1,this.window.onbeforeunload=(()=>{this._isClose=!0})}setFps(e){cc.game.setFrameRate(e)}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`}async start(){console.log("start gameview"),cc.GAME_VIEW=!0;const e=await Editor.Message.request("preview","generate-settings",{type:"game-view"});for(let t=0;t<e.bundleConfigs.length;t++){const i=e.bundleConfigs[t];if(i.importBase="import://",i.nativeBase="import://","resources"===i.name)cc.resources.init(i);else{(new cc.AssetManager.Bundle).init(i)}}this._scene=cc.director.getScene(),this._currSceneData=cce.Utils.serialize(this._scene),await cce.SceneFacadeManager.softReloadScene(this._currSceneData),this._scene=cc.director.getScene(),this.hideEditorCamera(),cce.Engine.pause(),cc.director.resume(),cc.game.resume()}stop(){console.log("stop gameview"),cc.GAME_VIEW=!1,cc.game.pause(),cce.Engine.resume(),this.showEditorCamera(),cce.SceneFacadeManager.softReloadScene(this._currSceneData),cc.director._compScheduler.unscheduleAll(),cce.Engine.repaintInEditMode(),this.emit("stop_gameview"),message_1.messageManager.broadcast("scene:gameview-stop")}hideEditorCamera(){const e=this._scene.renderScene.cameras;for(const t of e)t.node.layer&EDITOR_MASK?(t.enabled=!1,t.changeTargetWindow(cc.director.root.tempWindow)):t.changeTargetWindow(cc.director.root.mainWindow)}showEditorCamera(){const e=this._scene.renderScene.cameras;for(const t of e)t.node.layer&EDITOR_MASK?(t.enabled=!0,t.changeTargetWindow(cc.director.root.mainWindow)):t.changeTargetWindow(cc.director.root.tempWindow)}}cc.gameView=new GameView,exports.default=cc.gameView;