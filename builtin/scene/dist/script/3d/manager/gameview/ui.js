"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),_worldPos=new cc.Vec3,raycast_1=__importDefault(require("../../../utils/raycast")),cmp=(e,t)=>e.distance-t.distance,ray=cc_1.geometry.Ray.create();class UI{constructor(e,t){this._pos=new cc.Vec3,this._isPress=!1,this.node=t.node,this.gameView=e,this._canvas=e.canvas,this.camera=t.cameraComponent.camera,this.camera.clearColor=new cc_1.Color(t.cameraComponent.clearColor.r,t.cameraComponent.clearColor.g,t.cameraComponent.clearColor.b,0)}alignWithScreen(){let e,t;this.node.getPosition(this._pos);const c=cc.visibleRect;e=c,t=cc.view.getDesignResolutionSize();let s=0,i=0;cc.view.getResolutionPolicy()===cc.view._rpNoBorder&&(s=.5*(t.width-c.width),i=.5*(t.height-c.height)),cc_1.Vec3.set(_worldPos,.5*c.width+s,.5*c.height+i,0),this._pos.equals(_worldPos)||this.node.setPosition(_worldPos);let o=this.node._uiProps.uiTransformComp;o.width!==e.width&&(o.width=e.width),o.height!==e.height&&(o.height=e.height),this.node.getWorldPosition(_worldPos);const r=this.camera;if(r){const e=cc.game.canvas;r.resize(e.width,e.height),r.orthoHeight=e.height/cc.view.getScaleY()/2,r.node.setPosition(_worldPos.x,_worldPos.y,1e3),r.update()}}getUINodes(e,t){this._canvas.getBoundingClientRect();this.camera.screenPointToRay(ray,e,t);const c=cc.director._scene._renderScene,s=[];if(raycast_1.default.raycastAll(c,ray)){const e=raycast_1.default.rayResultAll;e.sort(cmp);for(let t=0;t<e.length;t++){const c=e[t].node;c._objFlags&cc.Object.Flags.LockedInEditor||c._objFlags&cc.Object.Flags.HideInHierarchy||s.push(c)}}return s}_emitUI(e,t,c,s=null){for(let i=e.length-1;i>=0;i--)s?s(e[i],t,c):e[i].emit(t,c)}handleUI(e,t,c){if(!t)return;const s=this.getUINodes(e.x,e.y);t.touch&&(t.touch.getUILocation=cc_1.Touch.prototype.getUILocation.bind(t.touch));for(let e=0;e<t._touches.length;e++)t._touches[e].getUILocation=cc_1.Touch.prototype.getUILocation.bind(t._touches[e]);switch(c){case cc_1.SystemEventType.MOUSE_MOVE:this._isPress&&this._emitUI(this._currDown,cc_1.SystemEventType.TOUCH_MOVE,t,(t,c,i)=>{s.includes(t)?t.emit(c,i):t.emit(cc_1.SystemEventType.MOUSE_LEAVE,e)}),this._currMove?(this._emitUI(s,cc_1.SystemEventType.MOUSE_ENTER,e,(e,t,c)=>{this._currMove.includes(e)||e.emit(t,c)}),this._emitUI(this._currMove,cc_1.SystemEventType.MOUSE_LEAVE,e,(e,t,c)=>{s.includes(e)||e.emit(t,c)})):this._emitUI(s,cc_1.SystemEventType.MOUSE_ENTER,e),this._currMove=s;break;case cc_1.SystemEventType.MOUSE_DOWN:this._isPress=!0,this._currDown=s,this._emitUI(s,cc_1.SystemEventType.TOUCH_START,t);break;case cc_1.SystemEventType.MOUSE_UP:this._isPress=!1,this._currDown&&(this._emitUI(this._currDown,null,t,(e,t,c)=>{s.includes(e)?e.emit(cc_1.SystemEventType.TOUCH_END,c):e.emit(cc_1.SystemEventType.TOUCH_CANCEL,c)}),this._currDown=null)}}}exports.default=UI;