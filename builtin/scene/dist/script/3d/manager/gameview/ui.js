"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),_worldPos=new cc.Vec3,raycast_1=__importDefault(require("../../../utils/raycast")),ray_1=__importDefault(require("../../../utils/geom-utils/ray")),cmp=(e,t)=>e.distance-t.distance,ray=ray_1.default.create();class UI{constructor(e,t){this._pos=new cc.Vec3,this._isPress=!1,this.node=t.node,this.gameView=e,this._canvas=e.canvas,this.camera=t.cameraComponent.camera}alignWithScreen(){let e,t;this.node.getPosition(this._pos);const s=cc.visibleRect;e=s,t=cc.view.getDesignResolutionSize();let i=0,c=0;cc.view.getResolutionPolicy()===cc.view._rpNoBorder&&(i=.5*(t.width-s.width),c=.5*(t.height-s.height)),cc_1.Vec3.set(_worldPos,.5*s.width+i,.5*s.height+c,0),this._pos.equals(_worldPos)||this.node.setPosition(_worldPos);let o=this.node._uiProps.uiTransformComp;o.width!==e.width&&(o.width=e.width),o.height!==e.height&&(o.height=e.height),this.node.getWorldPosition(_worldPos);const r=this.camera;if(r){const e=cc.game.canvas;r.resize(e.width,e.height),r.orthoHeight=e.height/cc.view.getScaleY()/2,r.node.setPosition(_worldPos.x,_worldPos.y,1e3),r.update()}}getUINodes(e,t){this._canvas.getBoundingClientRect();this.camera.screenPointToRay(ray,e,t);const s=cc.director._scene._renderScene,i=[];if(raycast_1.default.raycastAll(s,ray)){const e=raycast_1.default.rayResultAll;e.sort(cmp);for(let t=0;t<e.length;t++){const s=e[t].node;s._objFlags&cc.Object.Flags.LockedInEditor||s instanceof cc.PrivateNode||i.push(s)}}return i}_emitUI(e,t,s,i=null){for(let c=e.length-1;c>=0;c--)i?i(e[c],t,s):e[c].emit(t,s)}handleUI(e,t,s){if(!t)return;const i=this.getUINodes(e.x,e.y);t.touch&&(t.touch.getUILocation=cc_1.Touch.prototype.getUILocation.bind(t.touch));for(let e=0;e<t._touches.length;e++)t._touches[e].getUILocation=cc_1.Touch.prototype.getUILocation.bind(t._touches[e]);switch(s){case cc_1.SystemEventType.MOUSE_MOVE:this._isPress&&this._emitUI(this._currDown,cc_1.SystemEventType.TOUCH_MOVE,t,(t,s,c)=>{i.includes(t)?t.emit(s,c):t.emit(cc_1.SystemEventType.MOUSE_LEAVE,e)}),this._currMove?(this._emitUI(i,cc_1.SystemEventType.MOUSE_ENTER,e,(e,t,s)=>{this._currMove.includes(e)||e.emit(t,s)}),this._emitUI(this._currMove,cc_1.SystemEventType.MOUSE_LEAVE,e,(e,t,s)=>{i.includes(e)||e.emit(t,s)})):this._emitUI(i,cc_1.SystemEventType.MOUSE_ENTER,e),this._currMove=i;break;case cc_1.SystemEventType.MOUSE_DOWN:this._isPress=!0,this._currDown=i,this._emitUI(i,cc_1.SystemEventType.TOUCH_START,t);break;case cc_1.SystemEventType.MOUSE_UP:this._isPress=!1,this._currDown&&(this._emitUI(this._currDown,null,t,(e,t,s)=>{i.includes(e)?e.emit(cc_1.SystemEventType.TOUCH_END,s):e.emit(cc_1.SystemEventType.TOUCH_CANCEL,s)}),this._currDown=null)}}}exports.default=UI;