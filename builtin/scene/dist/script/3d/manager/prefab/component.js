"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.componentOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),node_1=__importDefault(require("../node")),dump_1=__importDefault(require("../../../export/dump")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),undo_1=require("../../../export/undo"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo;class ApplyRemoveComponentCommand extends undo_1.SceneUndoCommand{constructor(e,t){super(),this.removedCompInfo=null,this._undoFunc=e,this._redoFunc=t}async undo(){this.removedCompInfo&&this._undoFunc(this.removedCompInfo)}async redo(){this.removedCompInfo&&this._redoFunc(this.removedCompInfo.nodeUUID,this.removedCompInfo.compData.__prefab.fileId)}}class ComponentOperation{constructor(){this.isRevertingRemovedComponents=!1,this.isRemovingMountedComponents=!1,this.compMap={}}cacheComp(e){this.compMap[e.uuid]=e._instantiate()}getCachedComp(e){return this.compMap[e]}clearCompCache(){this.compMap={}}onAddComponent(e){if(this.cacheComp(e),this.isRevertingRemovedComponents)return;const t=e.node;t&&t._prefab&&this.updateMountedComponents(t)}onComponentAdded(e,t){this.cacheComp(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}onRemoveComponentInGeneralMode(e,t){if(this.isRemovingMountedComponents)return;const n=e.node;if(n&&n._prefab){const t=utils_1.prefabUtils.getMountedRoot(e);e.__prefab&&!t?this.onPrefabComponentRemoved(e):this.updateMountedComponents(n)}}onPrefabComponentRemoved(e){var t;const n=e.__prefab;if(!n)return;const o=e.node;if(!o._prefab)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const r=s.targetPath,i=null===(t=a._prefab)||void 0===t?void 0:t.instance;i&&(r.splice(0,1),r.push(n.fileId),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.addRemovedComponent(i,r),utils_1.prefabUtils.fireChangeMsg(a))}onComponentRemovedInGeneralMode(e,t){this.isRemovingMountedComponents||utils_1.prefabUtils.checkToRemoveTargetOverride(e,t)}async doApplyRemovedComponent(e,t){var n,o,s;const a=node_1.default.query(e);if(!a)return null;const r=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(a),i=r.outMostPrefabInstanceNode;if(!i)return null;const p=r.targetPath,c=null===(n=i._prefab)||void 0===n?void 0:n.instance,f=i._prefab;if(c&&f&&f.asset){const n=f.asset._uuid;if(utils_1.prefabUtils.isSubAsset(n))return console.warn("can't apply RemovedComponent in SubAsset Prefab"),null;p.splice(0,1),p.push(t);const r=utils_1.prefabUtils.getPrefabAssetNodeInstance(f);if(!r)return null;const u=utils_1.prefabUtils.getTarget(p,r),d=u.node.components.indexOf(u),l=u._instantiate();if(!l)return null;if((null===(o=a._prefab)||void 0===o?void 0:o.instance)&&(null===(s=a._prefab)||void 0===s?void 0:s.instance)!==c){const e=r._prefab,t=e.instance;e.instance=void 0,this.onRemoveComponentInGeneralMode(u,r),e.instance=t}u._destroyImmediate();const m=r._prefab;m&&(m.instance=void 0);const _=utils_1.prefabUtils.generatePrefabDataFromNode(r);if(!_)return null;const b=_.prefabData,g=await Editor.Message.request("asset-db","query-asset-info",f.asset._uuid);return g?(utils_1.prefabUtils.fireBeforeChangeMsg(i),utils_1.prefabUtils.deleteRemovedComponent(c,p),utils_1.prefabUtils.fireChangeMsg(i),await Editor.Message.request("asset-db","create-asset",g.source,b,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot(),{nodeUUID:e,compIndex:d,compData:l}):null}return null}async undoApplyRemovedComponent(e){var t;if(!e)return;const n=node_1.default.query(e.nodeUUID);if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(n),s=o.outMostPrefabInstanceNode;if(!s)return;const a=o.targetPath,r=null===(t=s._prefab)||void 0===t?void 0:t.instance,i=s._prefab;if(r&&i&&i.asset){a.splice(0,1);const t=a.slice();t.push(n._prefab.fileId);const o=e.compData.__prefab.fileId;a.push(o);const p=utils_1.prefabUtils.getPrefabAssetNodeInstance(i);if(!p)return;utils_1.prefabUtils.getTarget(t,p)._addComponentAt(e.compData,e.compIndex);const c=utils_1.prefabUtils.generatePrefabDataFromNode(p);if(!c)return;const f=await Editor.Message.request("asset-db","query-asset-info",i.asset._uuid);if(!f)return;utils_1.prefabUtils.fireBeforeChangeMsg(s),utils_1.prefabUtils.addRemovedComponent(r,a),utils_1.prefabUtils.fireChangeMsg(s),await Editor.Message.request("asset-db","create-asset",f.source,c.prefabData,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot()}}async applyRemovedComponent(e,t){const n=new ApplyRemoveComponentCommand(this.undoApplyRemovedComponent.bind(this),this.doApplyRemovedComponent.bind(this)),o=cce.SceneFacadeManager.beginRecording(e,{customCommand:n}),s=await this.doApplyRemovedComponent(e,t);s?(n.removedCompInfo=s,cce.SceneFacadeManager.endRecording(o)):cce.SceneFacadeManager.cancelRecording(o)}async cloneComponentToNode(e,t){const n=dump_1.default.dumpComponent(t);delete n.value._objFlags;const o=e.addComponent(cc_1.js.getClassName(t)),s=e.components;if(s&&s.length){const a=s.length-1,r=s[a];r&&r===o&&(await dump_1.default.restoreProperty(e,`__comps__.${a}`,n),o instanceof cc_1.MissingScript&&(o._$erialized=t._$erialized))}}async revertRemovedComponent(e,t){var n;const o=node_1.default.query(e);if(!o)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const r=s.targetPath,i=null===(n=a._prefab)||void 0===n?void 0:n.instance,p=a._prefab;if(i&&p&&p.asset){r.splice(0,1),r.push(t);const n=(0,cc_1.instantiate)(p.asset);if(!n)return;const s=cce.SceneFacadeManager.beginRecording([a.uuid,e]),c=utils_1.prefabUtils.getTarget(r,n);utils_1.prefabUtils.fireBeforeChangeMsg(o),this.isRevertingRemovedComponents=!0,await this.cloneComponentToNode(o,c),this.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(o),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.deleteRemovedComponent(i,r),utils_1.prefabUtils.fireChangeMsg(a),cce.SceneFacadeManager.endRecording(s)}}updateMountedComponents(e){var t;const n=e._prefab;if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),s=o.outMostPrefabInstanceNode;if(!s)return null;const a=o.targetPath,r=s._prefab,i=null===r||void 0===r?void 0:r.instance;if(!s||!r||!i)return;const p=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!p)return;a.splice(0,1),a.push(n.fileId);const c=utils_1.prefabUtils.getTarget(a,p);if(!c)return;const f=c.components.map(e=>{var t;return null===(t=e.__prefab)||void 0===t?void 0:t.fileId}),u=[];for(let n=0;n<e.components.length;n++){const o=e.components[n];if(o.__prefab){if(!f.includes(null===(t=o.__prefab)||void 0===t?void 0:t.fileId)){const e=utils_1.prefabUtils.getMountedRoot(o);e&&e!==s||u.push(o)}}else u.push(o)}if(utils_1.prefabUtils.fireBeforeChangeMsg(s),u.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedComponents(i,a);e.components=u,e.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,s)})}else for(let e=0;e<i.mountedComponents.length;e++){const t=i.mountedComponents[e];if(t.isTarget(a)){t.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),i.mountedComponents.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(s)}applyMountedComponents(e){const t=e,n=t._prefab;if(!n)return;const o=n.instance;if(!o)return;const s=new Map,a=o.mountedComponents;for(let e=0;e<a.length;e++){const r=a[e],i=r.targetInfo;if(!i)continue;const p=utils_1.prefabUtils.getTarget(i.localID,t);p&&r.components.forEach(e=>{if(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid),i.localID.length>1){n.instance=void 0;const t=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(p);n.instance=o;const a=t.outMostPrefabInstanceNode;if(!a)return;const r=a._prefab;if(!r)return;const i=r.instance;if(!i)return;const c=p._prefab;if(!c)return;const f=t.targetPath.slice(1);f.push(c.fileId),utils_1.prefabUtils.getPrefabInstanceMountedComponents(i,f).components.push(e),utils_1.prefabUtils.setMountedRoot(e,a);const u=t.targetPath.slice();u.push(e.__prefab.fileId),s.set(u,{prefabInfo:null})}else s.set([e.__prefab.fileId],{prefabInfo:null}),utils_1.prefabUtils.setMountedRoot(e,void 0)})}return o.mountedComponents=[],s}}const componentOperation=new ComponentOperation;exports.componentOperation=componentOperation;