"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.componentOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),node_1=__importDefault(require("../node")),dump_1=__importDefault(require("../../utils/dump")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),undo_1=require("../../../export/undo"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo;class ApplyRemoveComponentCommand extends undo_1.SceneUndoCommand{constructor(e,t){super(),this.removedCompInfo=null,this._undoFunc=e,this._redoFunc=t}async undo(){this.removedCompInfo&&this._undoFunc(this.removedCompInfo)}async redo(){this.removedCompInfo&&this._redoFunc(this.removedCompInfo.nodeUUID,this.removedCompInfo.compData.__prefab.fileId)}}class ComponentOperation{constructor(){this.isRevertingRemovedComponents=!1,this.isRemovingMountedComponents=!1,this.compMap={}}cacheComp(e){this.compMap[e.uuid]=e._instantiate()}getCachedComp(e){return this.compMap[e]}clearCompCache(){this.compMap={}}onAddComponent(e){if(this.cacheComp(e),this.isRevertingRemovedComponents)return;const t=e.node;t&&t._prefab&&this.updateMountedComponents(t)}onComponentAdded(e,t){this.cacheComp(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}onRemoveComponentInGeneralMode(e,t){if(this.isRemovingMountedComponents)return;const n=e.node;if(n&&n._prefab){const t=utils_1.prefabUtils.getMountedRoot(e);e.__prefab&&!t?this.onPrefabComponentRemoved(e):this.updateMountedComponents(n)}}onPrefabComponentRemoved(e){var t;const n=e.__prefab;if(!n)return;const o=e.node;if(!o._prefab)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const i=s.targetPath,r=null===(t=a._prefab)||void 0===t?void 0:t.instance;r&&(i.splice(0,1),i.push(n.fileId),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.addRemovedComponent(r,i),utils_1.prefabUtils.fireChangeMsg(a))}onComponentRemovedInGeneralMode(e,t){this.isRemovingMountedComponents||utils_1.prefabUtils.checkToRemoveTargetOverride(e,t)}async doApplyRemovedComponent(e,t){var n,o,s;const a=node_1.default.query(e);if(!a)return null;const i=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(a),r=i.outMostPrefabInstanceNode;if(!r)return null;const c=i.targetPath,p=null===(n=r._prefab)||void 0===n?void 0:n.instance,f=r._prefab;if(p&&f&&f.asset){const n=f.asset._uuid;if(utils_1.prefabUtils.isSubAsset(n))return console.warn("can't apply RemovedComponent in SubAsset Prefab"),null;c.splice(0,1),c.push(t);const i=utils_1.prefabUtils.getPrefabAssetNodeInstance(f);if(!i)return null;const u=utils_1.prefabUtils.getTarget(c,i),l=u.node.components.indexOf(u),d=u._instantiate();if(!d)return null;if((null===(o=a._prefab)||void 0===o?void 0:o.instance)&&(null===(s=a._prefab)||void 0===s?void 0:s.instance)!==p){const e=i._prefab,t=e.instance;e.instance=void 0,this.onRemoveComponentInGeneralMode(u,i),e.instance=t}u._destroyImmediate();const m=i._prefab;m&&(m.instance=void 0);const _=utils_1.prefabUtils.generatePrefabDataFromNode(i);if(!_)return null;const b=_.prefabData,g=await Editor.Message.request("asset-db","query-asset-info",f.asset._uuid);return g?(utils_1.prefabUtils.fireBeforeChangeMsg(r),utils_1.prefabUtils.deleteRemovedComponent(p,c),utils_1.prefabUtils.fireChangeMsg(r),await Editor.Message.request("asset-db","create-asset",g.source,b,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot(),{nodeUUID:e,compIndex:l,compData:d}):null}return null}async undoApplyRemovedComponent(e){var t;if(!e)return;const n=node_1.default.query(e.nodeUUID);if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(n),s=o.outMostPrefabInstanceNode;if(!s)return;const a=o.targetPath,i=null===(t=s._prefab)||void 0===t?void 0:t.instance,r=s._prefab;if(i&&r&&r.asset){a.splice(0,1);const t=a.slice();t.push(n._prefab.fileId);const o=e.compData.__prefab.fileId;a.push(o);const c=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!c)return;utils_1.prefabUtils.getTarget(t,c)._addComponentAt(e.compData,e.compIndex);const p=utils_1.prefabUtils.generatePrefabDataFromNode(c);if(!p)return;const f=await Editor.Message.request("asset-db","query-asset-info",r.asset._uuid);if(!f)return;utils_1.prefabUtils.fireBeforeChangeMsg(s),utils_1.prefabUtils.addRemovedComponent(i,a),utils_1.prefabUtils.fireChangeMsg(s),await Editor.Message.request("asset-db","create-asset",f.source,p.prefabData,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot()}}async applyRemovedComponent(e,t){const n=new ApplyRemoveComponentCommand(this.undoApplyRemovedComponent.bind(this),this.doApplyRemovedComponent.bind(this)),o=cce.SceneFacadeManager.beginRecording(e,{customCommand:n}),s=await this.doApplyRemovedComponent(e,t);s?(n.removedCompInfo=s,cce.SceneFacadeManager.endRecording(o)):cce.SceneFacadeManager.cancelRecording(o)}async cloneComponentToNode(e,t){const n=dump_1.default.dumpComponent(t);delete n.value._objFlags;const o=e.addComponent(cc_1.js.getClassName(t)),s=e.components;if(s&&s.length){const a=s.length-1,i=s[a];i&&i===o&&(await dump_1.default.restoreProperty(e,`__comps__.${a}`,n),o instanceof cc_1.MissingScript&&(o._$erialized=t._$erialized))}}async revertRemovedComponent(e,t){var n;const o=node_1.default.query(e);if(!o)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const i=s.targetPath,r=null===(n=a._prefab)||void 0===n?void 0:n.instance,c=a._prefab;if(r&&c&&c.asset){i.splice(0,1),i.push(t);const e=(0,cc_1.instantiate)(c.asset);if(!e)return;const n=utils_1.prefabUtils.getTarget(i,e);utils_1.prefabUtils.fireBeforeChangeMsg(o),this.isRevertingRemovedComponents=!0,await this.cloneComponentToNode(o,n),this.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(o),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.deleteRemovedComponent(r,i),utils_1.prefabUtils.fireChangeMsg(a)}}updateMountedComponents(e){var t;const n=e._prefab;if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),s=o.outMostPrefabInstanceNode;if(!s)return null;const a=o.targetPath,i=s._prefab,r=null===i||void 0===i?void 0:i.instance;if(!s||!i||!r)return;const c=utils_1.prefabUtils.getPrefabAssetNodeInstance(i);if(!c)return;a.splice(0,1),a.push(n.fileId);const p=utils_1.prefabUtils.getTarget(a,c);if(!p)return;const f=p.components.map(e=>{var t;return null===(t=e.__prefab)||void 0===t?void 0:t.fileId}),u=[];for(let n=0;n<e.components.length;n++){const o=e.components[n];if(o.__prefab){if(!f.includes(null===(t=o.__prefab)||void 0===t?void 0:t.fileId)){const e=utils_1.prefabUtils.getMountedRoot(o);e&&e!==s||u.push(o)}}else u.push(o)}if(utils_1.prefabUtils.fireBeforeChangeMsg(s),u.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedComponents(r,a);e.components=u,e.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,s)})}else for(let e=0;e<r.mountedComponents.length;e++){const t=r.mountedComponents[e];if(t.isTarget(a)){t.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),r.mountedComponents.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(s)}applyMountedComponents(e){const t=e,n=t._prefab;if(!n)return;const o=n.instance;if(!o)return;const s=new Map,a=o.mountedComponents;for(let e=0;e<a.length;e++){const i=a[e],r=i.targetInfo;if(r)if(r.localID.length>1){const e=utils_1.prefabUtils.getTarget(r.localID,t);if(!e)continue;n.instance=void 0;const a=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e);n.instance=o;const c=a.outMostPrefabInstanceNode;if(!c)continue;const p=c._prefab;if(!p)continue;const f=p.instance;if(!f)continue;const u=a.targetPath.slice();u.splice(0,1);const l=e._prefab;if(!l)continue;const d=u.slice();d.push(l.fileId);const m=utils_1.prefabUtils.getPrefabInstanceMountedComponents(f,d);m.components.forEach(e=>{if(!e)return;const t=e.__prefab;utils_1.prefabUtils.addPrefabInfoToComponent(e),utils_1.prefabUtils.setMountedRoot(e,c);const n=e.__prefab;if(!n)return;const o=u.slice().concat([n.fileId]);s.set(o,{prefabInfo:t})}),m.components=m.components.concat(i.components)}else i.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)})}return o.mountedComponents=[],s}}const componentOperation=new ComponentOperation;exports.componentOperation=componentOperation;