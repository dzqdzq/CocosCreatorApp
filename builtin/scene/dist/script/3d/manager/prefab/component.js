"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.componentOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),node_1=__importDefault(require("../node")),dump_1=__importDefault(require("../../utils/dump")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo;class ApplyRemoveComponentCommand{constructor(e,t,n){this._removedCompInfo=e,this._undoFunc=t,this._redoFunc=n}async undo(){this._undoFunc(this._removedCompInfo)}async redo(){this._redoFunc(this._removedCompInfo.nodeUUID,this._removedCompInfo.compData.__prefab.fileId)}}class ComponentOperation{constructor(){this.isRevertingRemovedComponents=!1,this.isRemovingMountedComponents=!1,this.compMap={}}cacheComp(e){this.compMap[e.uuid]=e._instantiate()}getCachedComp(e){return this.compMap[e]}clearCompCache(){this.compMap={}}onAddComponent(e){if(this.cacheComp(e),this.isRevertingRemovedComponents)return;const t=e.node;t&&t._prefab&&this.updateMountedComponents(t)}onComponentAdded(e,t){this.cacheComp(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}onRemoveComponentInGeneralMode(e,t){if(this.isRemovingMountedComponents)return;const n=e.node;if(n&&n._prefab){const t=utils_1.prefabUtils.getMountedRoot(e);e.__prefab&&!t?this.onPrefabComponentRemoved(e):this.updateMountedComponents(n)}}onPrefabComponentRemoved(e){var t;const n=e.__prefab;if(!n)return;const o=e.node;if(!o._prefab)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const r=s.targetPath,i=null===(t=a._prefab)||void 0===t?void 0:t.instance;i&&(r.splice(0,1),r.push(n.fileId),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.addRemovedComponent(i,r),utils_1.prefabUtils.fireChangeMsg(a))}onComponentRemovedInGeneralMode(e,t){this.isRemovingMountedComponents||utils_1.prefabUtils.checkToRemoveTargetOverride(e,t)}async doApplyRemovedComponent(e,t){var n;const o=node_1.default.query(e);if(!o)return null;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return null;const r=s.targetPath,i=null===(n=a._prefab)||void 0===n?void 0:n.instance,c=a._prefab;if(i&&c&&c.asset){r.splice(0,1),r.push(t);const n=utils_1.prefabUtils.getPrefabAssetNodeInstance(c);if(!n)return null;const o={};cc_1.Prefab._utils.generateTargetMap(n,o,!0);const s=cc_1.Prefab._utils.getTarget(r,o),p=s.node.components.indexOf(s),f=s._instantiate();if(!f)return null;s._destroyImmediate();const u=n._prefab;u&&(u.instance=void 0);const l=utils_1.prefabUtils.generatePrefabDataFromNode(n);if(!l)return null;const d=await Editor.Message.request("asset-db","query-asset-info",c.asset._uuid);return d?(utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.deleteRemovedComponent(i,r),utils_1.prefabUtils.fireChangeMsg(a),await Editor.Message.request("asset-db","create-asset",d.source,l,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot(),{nodeUUID:e,compIndex:p,compData:f}):null}return null}async undoApplyRemovedComponent(e){var t;if(!e)return;const n=node_1.default.query(e.nodeUUID);if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(n),s=o.outMostPrefabInstanceNode;if(!s)return;const a=o.targetPath,r=null===(t=s._prefab)||void 0===t?void 0:t.instance,i=s._prefab;if(r&&i&&i.asset){a.splice(0,1);const t=a.slice();t.push(n._prefab.fileId);const o=e.compData.__prefab.fileId;a.push(o);const c=utils_1.prefabUtils.getPrefabAssetNodeInstance(i);if(!c)return;const p={};cc_1.Prefab._utils.generateTargetMap(c,p,!0),cc_1.Prefab._utils.getTarget(t,p)._addComponentAt(e.compData,e.compIndex);const f=utils_1.prefabUtils.generatePrefabDataFromNode(c);if(!f)return;const u=await Editor.Message.request("asset-db","query-asset-info",i.asset._uuid);if(!u)return;utils_1.prefabUtils.fireBeforeChangeMsg(s),utils_1.prefabUtils.addRemovedComponent(r,a),utils_1.prefabUtils.fireChangeMsg(s),await Editor.Message.request("asset-db","create-asset",u.source,f,{overwrite:!0}),cce.SceneFacadeManager.abortSnapshot()}}async applyRemovedComponent(e,t){cce.SceneFacadeManager.snapshot();const n=await this.doApplyRemovedComponent(e,t);n&&(cce.SceneFacadeManager.snapshot(new ApplyRemoveComponentCommand(n,this.undoApplyRemovedComponent.bind(this),this.doApplyRemovedComponent.bind(this))),cce.SceneFacadeManager.abortSnapshot())}async cloneComponentToNode(e,t){const n=dump_1.default.dumpComponent(t);delete n.value.objFlags;const o=e.addComponent(cc_1.js.getClassName(t)),s=e.components;if(s&&s.length){const t=s.length-1,a=s[t];a&&a===o&&await dump_1.default.restoreProperty(e,`__comps__.${t}`,n)}}async revertRemovedComponent(e,t){var n;const o=node_1.default.query(e);if(!o)return;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o),a=s.outMostPrefabInstanceNode;if(!a)return;const r=s.targetPath,i=null===(n=a._prefab)||void 0===n?void 0:n.instance,c=a._prefab;if(i&&c&&c.asset){r.splice(0,1),r.push(t);const e=cc_1.instantiate(c.asset);if(!e)return;const n={};cc_1.Prefab._utils.generateTargetMap(e,n,!0);const s=cc_1.Prefab._utils.getTarget(r,n);cce.SceneFacadeManager.snapshot(),utils_1.prefabUtils.fireBeforeChangeMsg(o),this.isRevertingRemovedComponents=!0,await this.cloneComponentToNode(o,s),this.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(o),utils_1.prefabUtils.fireBeforeChangeMsg(a),utils_1.prefabUtils.deleteRemovedComponent(i,r),utils_1.prefabUtils.fireChangeMsg(a)}}updateMountedComponents(e){var t;const n=e._prefab;if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),s=o.outMostPrefabInstanceNode;if(!s)return null;const a=o.targetPath,r=s._prefab,i=null===r||void 0===r?void 0:r.instance;if(!s||!r||!i)return;const c=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!c)return;a.splice(0,1),a.push(n.fileId);const p=utils_1.prefabUtils.getTargetMap(c),f=cc_1.Prefab._utils.getTarget(a,p).components.map(e=>{var t;return null===(t=e.__prefab)||void 0===t?void 0:t.fileId}),u=[];for(let n=0;n<e.components.length;n++){const o=e.components[n];if(o.__prefab){if(!f.includes(null===(t=o.__prefab)||void 0===t?void 0:t.fileId)){const e=utils_1.prefabUtils.getMountedRoot(o);e&&e!==s||u.push(o)}}else u.push(o)}if(utils_1.prefabUtils.fireBeforeChangeMsg(s),u.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedComponents(i,a);e.components=u,e.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,s)})}else for(let e=0;e<i.mountedComponents.length;e++){const t=i.mountedComponents[e];if(t.isTarget(a)){t.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),i.mountedComponents.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(s)}applyMountedComponents(e){const t=e,n=t._prefab;if(!n)return;const o=n.instance;if(!o)return;const s=new Map,a=o.mountedComponents;for(let e=0;e<a.length;e++){const r=a[e],i=r.targetInfo;if(i)if(i.localID.length>1){const e=utils_1.prefabUtils.getTargetMap(t),a=cc_1.Prefab._utils.getTarget(i.localID,e);if(!a)continue;n.instance=void 0;const c=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(a);n.instance=o;const p=c.outMostPrefabInstanceNode;if(!p)continue;const f=p._prefab;if(!f)continue;const u=f.instance;if(!u)continue;const l=c.targetPath.slice();l.splice(0,1);const d=a._prefab;if(!d)continue;const _=l.slice();_.push(d.fileId);const m=utils_1.prefabUtils.getPrefabInstanceMountedComponents(u,_);m.components.forEach(e=>{if(!e)return;const t=e.__prefab;utils_1.prefabUtils.addPrefabInfoToComponent(e),utils_1.prefabUtils.setMountedRoot(e,p);const n=e.__prefab;if(!n)return;const o=l.slice().concat([n.fileId]);s.set(o,{prefabInfo:t})}),m.components=m.components.concat(r.components)}else r.components.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)})}return o.mountedComponents=[],s}}const componentOperation=new ComponentOperation;exports.componentOperation=componentOperation;