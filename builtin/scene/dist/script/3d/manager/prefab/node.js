"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),component_1=require("./component"),node_1=__importDefault(require("../node")),component_2=__importDefault(require("../component")),util_1=require("util"),node_2=__importDefault(require("../../../utils/node")),event_enum_1=require("../../../../script/public/event-enum"),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),timer_util_1=require("../../utils/timer-util"),scene_1=__importDefault(require("../scene")),undo_1=require("../../../export/undo"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,RootReservedProperty=["_name","_lpos","_lrot","_euler"],compKey="_components",diffExcludePropMap={"cc.Node":["_objFlags","_parent","_children","_components","_prefab",cc_1.editorExtrasTag],"cc.Component":["node","_objFlags",cc_1.editorExtrasTag]};function getDiffExcludeProps(e){let t=[];return Object.keys(diffExcludePropMap).forEach(r=>{const n=cc_1.js.getClassByName(r);n&&cc_1.js.isChildClassOf(e,n)&&(t=t.concat(diffExcludePropMap[r]))}),t}class ApplyPrefabCommand extends undo_1.SceneUndoCommand{constructor(e,t){super(),this.applyPrefabInfo=null,this._undoFunc=e,this._redoFunc=t}async undo(){this.applyPrefabInfo&&this._undoFunc(this.applyPrefabInfo)}async redo(){this.applyPrefabInfo&&this._redoFunc(this.applyPrefabInfo.nodeUUID)}}class CreatePrefabCommand extends undo_1.SceneUndoCommand{constructor(){super()}async undo(){this.applyData(this.undoData)}async redo(){this.applyData(this.redoData)}}class NodeOperation{constructor(){this.assetToNodesMap=new Map,this.isRemovingMountedChildren=!1,this._timerUtil=new timer_util_1.TimerUtil}onSceneOpened(e){this.assetToNodesMap.clear(),component_1.componentOperation.clearCompCache(),utils_1.prefabUtils.clearCache(),this._timerUtil.clear(),node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t instanceof cc_1.Scene||t&&!node_2.default.isEditorNode(t)&&(this.checkToAddPrefabAssetMap(t),t.components.forEach(e=>{component_1.componentOperation.cacheComp(e)}))})}onNodeRemoved(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){const r=this.assetToNodesMap.get(t.asset._uuid);if(r){const t=r.indexOf(e);t>=0&&r.splice(t,1)}}}checkToAddOverrides(e,t,r){var n,o;if(!e)return;if(!t)return;const s=t.replace(/^__comps__/,compKey),i=(s||"").split("."),a=utils_1.prefabUtils.getPrefab(e);let c=null;t!==s&&i[0]===compKey&&(c=e[i[0]][i[1]]);const f=a&&!(null===(o=null===(n=a.root)||void 0===n?void 0:n._prefab)||void 0===o?void 0:o.instance);if(!a||f||c&&utils_1.prefabUtils.isMountedComponent(c))r&&this.addTargetOverrideWithModifyPath(e,i,r);else if(c&&2===i.length){c.constructor.__props__.forEach(t=>{!1!==cc.Class.attr(c,t).visible&&this.checkToAddPropertyOverrides(e,[...i,t],r)})}else this.checkToAddPropertyOverrides(e,i,r)}onNodeChangedInGeneralMode(e,t,r){var n;if(t)if(t.type!==event_enum_1.NodeEventType.CHILD_CHANGED){if(t.type===event_enum_1.NodeEventType.PARENT_CHANGED&&t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab){const t=null===(n=e._prefab)||void 0===n?void 0:n.instance;t&&(t.prefabRootNode=r)}if("children"!==t.propPath||t.type!==event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT){if(t.propPath){const n=e.uuid+"|"+t.propPath;this._timerUtil.callFunctionLimit(n,this.checkToAddOverrides.bind(this),e,t.propPath,r)}this._timerUtil.callFunctionLimit(e.uuid,this.updateSpecialComponent.bind(this),e,t.propPath,r)}}else this.updateChildrenData(e)}updateSpecialComponent(e,t,r){if("position"===t){const t=e.getComponent(cc_1.Widget);if(t&&!utils_1.prefabUtils.isMountedComponent(t)){const n=e.components.indexOf(t),o={isAlignLeft:"left",isAlignRight:"right",isAlignHorizontalCenter:"horizontalCenter",isAlignTop:"top",isAlignBottom:"bottom",isAbsoluteVerticalCenter:"verticalCenter"};Object.keys(o).forEach(s=>{t[s]&&this.checkToAddPropertyOverrides(e,["_components",`${n}`,o[s]],r)})}}}onAddNode(e){const t=e.parent;t&&(this.updateChildrenData(t),this.createReservedPropertyOverrides(e))}onNodeAdded(e,t){var r,n,o;if(this.checkToAddPrefabAssetMap(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab){const t=utils_1.prefabUtils.getPrefab(e),s=scene_1.default.rootNode;if(!s)return;const i=utils_1.prefabUtils.getPrefab(s);if(!i)return;(null===t||void 0===t?void 0:t.instance)?t.instance.prefabRootNode=null!==(r=t.instance.prefabRootNode)&&void 0!==r?r:i.root:t&&(null===(o=null===(n=t.root)||void 0===n?void 0:n._prefab)||void 0===o?void 0:o.instance)||(i.root?utils_1.prefabUtils.addPrefabInfo(e,i.root,i.asset):(console.warn("root of PrefabInfo is null, set to root node"),i.root=s,utils_1.prefabUtils.addPrefabInfo(e,i.root,i.asset)))}}checkToAddTargetOverride(e,t,r){var n;if(!(e instanceof cc_1.Component))return!1;const o=t.value,s=r._prefab;if((null===o||void 0===o)&&e)return utils_1.prefabUtils.removeTargetOverride(s,e,t.pathKeys),!1;let i=null;if(o instanceof cc_1.Node?i=o:o instanceof cc_1.Component&&(i=o.node),!i)return!1;if(!utils_1.prefabUtils.getPrefab(i))return!1;const a=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(i),c=a.outMostPrefabInstanceNode;if(!c)return!1;if(o instanceof cc_1.Node&&c===o)return utils_1.prefabUtils.removeTargetOverride(s,e,t.pathKeys),!1;const f=a.targetPath;if(null===(n=c._prefab)||void 0===n?void 0:n.instance){if(f.splice(0,1),o instanceof cc_1.Node){const e=o._prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab node: ${o.name}`),!1;f.push(e.fileId)}else if(o instanceof cc_1.Component){const e=o.__prefab;if(!e||!e.fileId)return utils_1.prefabUtils.getMountedRoot(o)||console.error(`can't get fileId of prefab component: ${o.name} in node: ${o.node.name}`),!1;f.push(e.fileId)}if(!r)return!1;r._prefab||(r._prefab=utils_1.prefabUtils.createPrefabInfo(r.uuid));const n=r._prefab,s=utils_1.prefabUtils.getTargetOverride(n,e,t.pathKeys);if(s){utils_1.prefabUtils.fireBeforeChangeMsg(r),s.target=c;const e=new TargetInfo;return e.localID=f,s.targetInfo=e,utils_1.prefabUtils.fireChangeMsg(r),!0}}return!1}checkToAddPropertyOverrides(e,t,r){const n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,t);if(!n)return;const o=n.outMostPrefabInstanceNode;if(!o)return;const s=o._prefab;if(!s||!s.asset)return;const i=null===s||void 0===s?void 0:s.instance;if(!i)return;const a=n.target,c=utils_1.prefabUtils.getMountedRoot(a);if(c&&c===o)return;const f=n.targetPath,l=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!l)return;const d=utils_1.prefabUtils.getTarget(f,l);if(!d)return void console.debug(`can't find item: ${a.name} in prefab asset ${s.asset._uuid}`);const p=utils_1.prefabUtils.getPropertyOverridesOfTarget(i,f),u=this.getDiffPropertyInfos(a,d,[],this.isInPropertyOverrides.bind(this,p));if(u&&u.length>0){utils_1.prefabUtils.fireBeforeChangeMsg(n.outMostPrefabInstanceNode);for(let e=0;e<u.length;e++){const t=u[e];a instanceof cc_1.Component&&this.checkToAddTargetOverride(a,t,r)||(utils_1.prefabUtils.getPropertyOverride(i,f,t.pathKeys).value=t.value)}r&&this.addTargetOverrideWithModifyPath(e,t,r),utils_1.prefabUtils.fireChangeMsg(n.outMostPrefabInstanceNode)}}isInTargetOverrides(e,t,r){return!!t&&utils_1.prefabUtils.isInTargetOverrides(t,e,r)}isInPropertyOverrides(e,t){return utils_1.prefabUtils.isInPropertyOverrides(t,e)}getDiffPropertyInfos(e,t,r,n){if(!e)return null;const o=e.constructor,s=t.constructor;if(!o||!s||o!==s)return null;const i=o.__values__,a=getDiffExcludeProps(o);let c=[];return i.map(s=>{if(a.includes(s))return;if(!1===cc_1.CCClass.attr(o,s).serializable)return;const i=e[s],f=t[s],l=this.handleDiffPropertyInfos(i,f,s,r,n);c=c.concat(l)}),c}handleDiffPropertyInfos(e,t,r,n,o){var s,i;let a=[];const c=n.concat(r),f={pathKeys:c,value:e};if(null===e||void 0===e)(e!==t||o(c))&&a.push(f);else if(null===t||void 0===t||o(c))a.push(f);else if(Array.isArray(e)){const r=c.concat("length");if(e.length!==t.length||o(r)){const t={pathKeys:r,value:e.length};a.push(t)}for(let r=0;r<e.length;r++){const n=this.handleDiffPropertyInfos(e[r],t[r],""+r,c,o);n&&n.length>0&&(a=a.concat(n))}}else if("object"==typeof e){if(e instanceof cc_1.Node){const r=e._prefab;(r&&r.fileId!==(null===(s=t._prefab)||void 0===s?void 0:s.fileId)||e.uuid!==t.uuid)&&a.push(f)}else if(e instanceof cc_1.Component)(e.__prefab&&e.__prefab.fileId!==(null===(i=t.__prefab)||void 0===i?void 0:i.filedId)||e.uuid!==t.uuid)&&a.push(f);else if(e instanceof cc_1.ValueType)e.equals(t)&&!o(c)||a.push(f);else if(e instanceof cc_1.Asset)(e._uuid!==t._uuid||o(c))&&a.push(f);else if(cc_1.CCClass.isCCClassOrFastDefined(e.constructor)){const r=this.getDiffPropertyInfos(e,t,c,o);r&&r.length>0&&(a=a.concat(r))}}else(e!==t||o(c))&&a.push(f);return a}addTargetOverrideWithModifyPath(e,t,r){let n=e,o=null;for(let e=0;e<t.length;e++){const r=t[e];if(!n)break;n=n[r],1===e&&"_components"===t[0]&&(o=n)}n!==e&&o&&(t.shift(),t.shift(),this.checkToAddTargetOverride(o,{pathKeys:t,value:n},r))}checkToAddPrefabAssetMap(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){let r=this.assetToNodesMap.get(t.asset._uuid);r||(r=[],this.assetToNodesMap.set(t.asset._uuid,r)),r.includes(e)||r.push(e)}}isReservedPropertyOverrides(e,t){const r=e.targetInfo;if(1===(null===r||void 0===r?void 0:r.localID.length)&&r.localID[0]===t){const t=e.propertyPath;if(1===t.length&&RootReservedProperty.includes(t[0]))return!0}return!1}removeModifiedPropertyOverrides(e,t){const r=[];for(let n=0;n<e.propertyOverrides.length;n++){const o=e.propertyOverrides[n];this.isReservedPropertyOverrides(o,t)&&r.push(o)}e.propertyOverrides=r}applyMountedChildren(e){var t;const r=e,n=utils_1.prefabUtils.getPrefab(r);if(!n||!n.instance)return;const o=n.instance,s=new Map,i=o.mountedChildren;for(let a=0;a<i.length;a++){const c=i[a],f=c.targetInfo;if(f)if(f.localID.length>1){const e=utils_1.prefabUtils.getTarget(f.localID,r);n.instance=void 0;const i=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e);n.instance=o;const a=i.outMostPrefabInstanceNode;if(!a)continue;const l=a._prefab;if(!l)continue;const d=l.instance;if(!d)continue;const p=i.targetPath.slice();p.splice(0,1);const u=p.slice(),_=null===(t=utils_1.prefabUtils.getPrefab(e))||void 0===t?void 0:t.fileId;if(!_)continue;u.push(_);const b=utils_1.prefabUtils.getPrefabInstanceMountedChildren(d,u);c.nodes.forEach(e=>{const t=e._prefab;utils_1.prefabUtils.addPrefabInfo(e,a,l.asset),utils_1.prefabUtils.setMountedRoot(e,a);const r=e._prefab;if(!r)return;const n=p.slice().concat([r.fileId]);s.set(n,{prefabInfo:t})}),b.nodes=b.nodes.concat(c.nodes)}else c.nodes.forEach(t=>{const r=t._prefab;utils_1.prefabUtils.setMountedRoot(t,void 0),r?(r.instance||utils_1.prefabUtils.addPrefabInfo(t,e,n.asset),s.set([r.fileId],{prefabInfo:null})):utils_1.prefabUtils.addPrefabInfo(t,e,n.asset)})}return o.mountedChildren=[],s}applyPropertyOverrides(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=n.propertyOverrides,s=[];for(let e=0;e<o.length;e++){const i=o[e];if(this.isReservedPropertyOverrides(i,r.fileId)){s.push(i);continue}const a=i.targetInfo;if(a&&a.localID.length>1){const e=utils_1.prefabUtils.getTarget(a.localID,t);if(!e)continue;let o=e;o instanceof cc_1.Component&&(o=o.node),r.instance=void 0;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o);r.instance=n;const c=s.outMostPrefabInstanceNode;if(!c)continue;const f=c._prefab;if(!f)continue;const l=f.instance;if(!l)continue;const d=s.targetPath.slice();d.splice(0,1);const p=e instanceof cc_1.Node?e._prefab:e.__prefab;if(!p)continue;d.push(p.fileId),utils_1.prefabUtils.getPropertyOverride(l,d,i.propertyPath).value=i.value}}n.propertyOverrides=s}applyTargetOverrides(e){var t,r;const n=[],o=scene_1.default.rootNode;if(!o)return n;const s=utils_1.prefabUtils.getPrefab(o);if(!s)return n;const i=utils_1.prefabUtils.getPrefab(e);if(!i)return n;const a=i.instance;if(!a)return n;if(s.targetOverrides)for(let o=s.targetOverrides.length-1;o>=0;o--){const c=s.targetOverrides[o];let f=c.source;const l=f instanceof cc_1.Component?f.node:f,d=c.sourceInfo;if(d&&f instanceof cc_1.Node){const e=utils_1.prefabUtils.getTarget(d.localID,f);f=e||f}const p=c.targetInfo;if(!p)continue;if(!(null===(r=null===(t=c.target)||void 0===t?void 0:t._prefab)||void 0===r?void 0:r.instance))continue;const u=c.target,_=u?utils_1.prefabUtils.getTarget(p.localID,u):null;if(!_)continue;const b=_ instanceof cc_1.Component?_.node:_;if(l&&b){if(node_2.default.isPartOfNode(l,e)&&node_2.default.isPartOfNode(b,e)){i.targetOverrides||(i.targetOverrides=[]);let t=f;(new TargetOverrideInfo).propertyPath=c.propertyPath;const r=null===d||void 0===d?void 0:d.localID;if(r&&c.source instanceof cc_1.Node){const e=utils_1.prefabUtils.getTarget(r,c.source);e&&(t=e)}let n=c.target;const l=p.localID;if(l&&c.target instanceof cc_1.Node){const e=utils_1.prefabUtils.getTarget(l,c.target);e&&(n=e)}i.instance=void 0,this.checkToAddTargetOverride(t,{pathKeys:c.propertyPath,value:n},e),i.instance=a,s.targetOverrides.splice(o,1)}n.push(c)}}return n}applyRemovedComponents(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!o)return null;const s=n.removedComponents;for(let e=0;e<s.length;e++){const i=s[e];if(i&&i.localID.length>1){const e=utils_1.prefabUtils.getTarget(i.localID,o);if(!e||!e.__prefab)continue;const s=e.node,a=utils_1.prefabUtils.getPrefab(s);if(!e||!a)continue;const c=i.localID.slice();c.pop(),c.push(a.fileId);const f=utils_1.prefabUtils.getTarget(c,t);r.instance=void 0;const l=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(f);r.instance=n;const d=l.outMostPrefabInstanceNode;if(!d)continue;const p=utils_1.prefabUtils.getPrefab(d);if(!p)continue;const u=p.instance;if(!u)continue;const _=l.targetPath.slice();_.splice(0,1),_.push(e.__prefab.fileId);const b=new TargetInfo;b.localID=_,u.removedComponents.push(b)}}n.removedComponents=[]}async waitForSceneLoaded(){return new Promise((e,t)=>{scene_1.default.once("soft-reload",e)})}async applyPrefab(e){const t=new ApplyPrefabCommand(this.undoApplyPrefab.bind(this),this.doApplyPrefab.bind(this)),r=cce.SceneFacadeManager.beginRecording(e,{customCommand:t}),n=await this.doApplyPrefab(e);return n?(t.applyPrefabInfo=n,cce.SceneFacadeManager.endRecording(r),await this.waitForSceneLoaded(),!1):(cce.SceneFacadeManager.cancelRecording(r),!1)}async doApplyPrefab(e){const t=node_1.default.query(e);if(!t)return null;const r=utils_1.prefabUtils.getPrefab(t),n=null===r||void 0===r?void 0:r.instance;if(!n||!(null===r||void 0===r?void 0:r.asset))return null;const o=r.asset;if(utils_1.prefabUtils.isSubAsset(o._uuid))return console.warn("can't apply data to SubAsset Prefab"),null;const s=o.data,i=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!i)return null;const a=this.applyMountedChildren(t);if(!a)return null;const c=component_1.componentOperation.applyMountedComponents(t);if(!c)return null;const f=n.propertyOverrides;this.applyPropertyOverrides(t);const l=n.removedComponents;this.applyRemovedComponents(t);const d=this.applyTargetOverrides(t),p=utils_1.prefabUtils.generatePrefabDataFromNode(t);return p?(p.clearedReference&&this.restoreClearedReference(t,p.clearedReference),await Editor.Message.request("asset-db","create-asset",i.source,p.prefabData,{overwrite:!0}),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(r),{nodeUUID:e,mountedChildrenInfoMap:a,mountedComponentsInfoMap:c,propertyOverrides:f,removedComponents:l,oldPrefabNodeData:s,targetOverrides:d}):null}async undoApplyPrefab(e){var t;const r=node_1.default.query(e.nodeUUID);if(!r)return;const n=r._prefab;if(!n)return;const o=n.instance;if(!o)return;const s=n.asset;if(!s)return;const i=await Editor.Message.request("asset-db","query-asset-info",s._uuid);if(!i)return;s.data=e.oldPrefabNodeData;const a=cce.Utils.serialize(s);o.mountedChildren=[];const c=utils_1.prefabUtils.getTargetMap(r);e.mountedChildrenInfoMap.forEach((e,t)=>{const n=cc_1.Prefab._utils.getTarget(t,c);n&&(utils_1.prefabUtils.setMountedRoot(n,r),n._prefab=e.prefabInfo,n.parent&&this.updateChildrenData(n.parent))}),e.mountedComponentsInfoMap.forEach((e,t)=>{const n=cc_1.Prefab._utils.getTarget(t,c);n&&(utils_1.prefabUtils.setMountedRoot(n,r),n.__prefab=e.prefabInfo,n.node&&component_1.componentOperation.updateMountedComponents(n.node))}),o.propertyOverrides=e.propertyOverrides,o.removedComponents=e.removedComponents;const f=scene_1.default.rootNode;if(f){const r=utils_1.prefabUtils.getPrefab(f);r&&(r.targetOverrides||(r.targetOverrides=[]),null===(t=e.targetOverrides)||void 0===t||t.forEach(e=>{var t;const n=new TargetOverrideInfo;if(e.sourceUUID){const t=node_1.default.query(e.sourceUUID);if(t)n.source=t;else{const t=component_2.default.query(e.sourceUUID);t&&(n.source=t)}}if(n.sourceInfo=e.sourceInfo,e.targetUUID){const t=node_1.default.query(e.targetUUID);if(t)n.target=t;else{const t=component_2.default.query(e.targetUUID);t&&(n.target=t)}}n.targetInfo=e.targetInfo,n.propertyPath=e.propertyPath,null===(t=r.targetOverrides)||void 0===t||t.push(n)}),cc_1.Prefab._utils.applyTargetOverrides(f))}await Editor.Message.request("asset-db","create-asset",i.source,a,{overwrite:!0})}updateChildrenData(e){if(!e)return;if(this.isRemovingMountedChildren)return;const t=e._prefab;if(!t)return;const r=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),n=r.outMostPrefabInstanceNode;if(!n)return;const o=r.targetPath,s=n._prefab,i=null===s||void 0===s?void 0:s.instance;if(!n||!s||!i)return;const a=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!a)return;o.splice(0,1),o.push(t.fileId);const c=utils_1.prefabUtils.getTarget(o,a);if(!c)return;const f=c.children.map(e=>{const t=e._prefab;if(t)return t.instance?t.instance.fileId:t.fileId}),l=[];for(let t=0;t<e.children.length;t++){const r=e.children[t],o=utils_1.prefabUtils.getPrefab(r),s=null===o||void 0===o?void 0:o.instance;if(o){const e=s?s.fileId:o.fileId;if(!f.includes(e)){const e=utils_1.prefabUtils.getMountedRoot(r);e&&e!==n||l.push(r)}}else l.push(r)}if(utils_1.prefabUtils.fireBeforeChangeMsg(n),l.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedChildren(i,o);e.nodes=l,e.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,n)})}else for(let e=0;e<i.mountedChildren.length;e++){const t=i.mountedChildren[e];if(t.isTarget(o)){t.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),i.mountedChildren.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(n)}isCircularRefPrefabInstance(e,t){const r=e._prefab;if(!r)return!1;if(!r.instance)return!1;if(e===t)return!1;function n(e,t){var r,n;const o=e._prefab,s=null===o||void 0===o?void 0:o.instance,i=t._prefab,a=null===i||void 0===i?void 0:i.instance;return!(!s||!a||(null===(r=null===o||void 0===o?void 0:o.asset)||void 0===r?void 0:r._uuid)!==(null===(n=null===i||void 0===i?void 0:i.asset)||void 0===n?void 0:n._uuid))}if(n(e,t))return!0;let o=e.parent;if(!o)return!1;for(;o&&o!==t;){if(n(e,o))return!0;o=o.parent}return!1}canBeMadeToPrefabAsset(e){let t=!1,r=!1;return e.walk(n=>{n.getComponent(cc_1.Terrain)&&(t=!0),this.isCircularRefPrefabInstance(n,e)&&(console.warn(`Circular reference prefab checked: [${n.name}]`),r=!0)}),t?(console.warn("Can't create prefabAsset from a node that contains terrain"),!1):!r||(console.warn("Can't create prefabAsset from a node that contains circular reference prefab"),!1)}async createPrefabAssetFromNode(e,t,r=!0){const n=node_1.default.query(e);if(!n)return null;const o=utils_1.prefabUtils.getPrefab(n);if(o){const{outMostPrefabInstanceNode:e}=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(n);if(e!==n&&n.isChildOf(e)&&!utils_1.prefabUtils.getMountedRoot(n))return console.warn("can't create prefabAsset from a prefabNode inside a prefabInstance"),null}if(!this.canBeMadeToPrefabAsset(n))return null;const s=utils_1.prefabUtils.generatePrefabDataFromNode(n);if(!s)return null;o&&o.asset&&this.assetToNodesMap.delete(o.asset._uuid);const i=await Editor.Message.request("asset-db","create-asset",t,s.prefabData);if(i){let t,o;const a=n.parent;r&&a&&(o=new CreatePrefabCommand,t=cce.SceneFacadeManager.beginRecording(e,{customCommand:o}),o.undoData=new Map,o.undoData.set(a.uuid,cce.Dump.encode.encodeNode(a)),o.undoData.set(e,cce.Dump.encode.encodeNode(n)));const c=await this.replaceNewPrefabAssetWithClearedReference(n,i.uuid,s.clearedReference);t&&o&&a&&(o.redoData=new Map,o.redoData.set(a.uuid,cce.Dump.encode.encodeNode(a)),o.redoData.set(c.uuid,cce.Dump.encode.encodeNode(c)),cce.SceneFacadeManager.endRecording(t))}return null===i||void 0===i?void 0:i.uuid}restoreClearedReference(e,t){const r={};cc_1.Prefab._utils.generateTargetMap(e,r,!0);for(const e in t){const n=t[e],o=[n.component],s=cc_1.Prefab._utils.getTarget(o,r);if(s){s[n.path]=n.value;const e=s.node,t={propPath:`__comps__.${s.node.components.indexOf(s)}.${n.path}`,type:"set-property"};this.onNodeChangedInGeneralMode(e,t,scene_1.default.rootNode)}}}async replaceNewPrefabAssetWithClearedReference(e,t,r){const n=e.parent;if(n){utils_1.prefabUtils.fireBeforeChangeMsg(n);const o=e.getSiblingIndex(),s=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t),i=(0,cc_1.instantiate)(s);return i._prefab.instance||(i._prefab.instance=utils_1.prefabUtils.createPrefabInstance()),e._prefab&&e._prefab.instance&&(i._prefab.instance.fileId=e._prefab.instance.fileId),this.createReservedPropertyOverrides(i),this.syncPropertyOverrides(i,scene_1.default.rootNode),this.restoreClearedReference(i,r),e.parent=null,n.insertChild(i,o),utils_1.prefabUtils.fireChangeMsg(n),i}}async linkNodeWithPrefabAsset(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;let n=t;if("string"==typeof t&&(n=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t)),!n)return console.error(`asset ${t} doesn't exist`),!1;const o=n.data;if(!o||!o._prefab)return;utils_1.prefabUtils.fireBeforeChangeMsg(r);let s=r._prefab;if(s||(s=new PrefabInfo,r._prefab=s),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(s),s.instance)utils_1.prefabUtils.removeMountedRootInfo(r);else{const e=utils_1.prefabUtils.createPrefabInstance(),t=r._prefab;t&&(e.prefabRootNode=t.root),t.instance=e}s.fileId=o._prefab.fileId,s.root=r;const i=null===s||void 0===s?void 0:s.instance;return s&&i&&(this.createReservedPropertyOverrides(r),i.mountedChildren=[],this.removeModifiedPropertyOverrides(i,s.fileId)),s.asset=n,utils_1.prefabUtils.fireChangeMsg(r),this.syncPrefabInfo(o,r,r),this.checkToAddPrefabAssetMap(r),!0}syncPropertyOverrides(e,t){var r,n;const o=[];if(utils_1.prefabUtils.findOutmostPrefabInstanceNodes(t,o),o.length>0){const t=new Map;e.walk(e=>{e._prefab&&e._prefab.instance&&t.set(e._prefab.instance.fileId,e)});for(let s=o.length-1;s>=0;s--){const i=o[s]._prefab,a=null===(r=null===i||void 0===i?void 0:i.instance)||void 0===r?void 0:r.fileId,c=null===(n=e._prefab.instance)||void 0===n?void 0:n.fileId;if(t.has(a)&&(null===i||void 0===i?void 0:i.instance)&&i.instance.propertyOverrides){const r=e._prefab.instance.propertyOverrides,n=t.get(a)._prefab.instance.propertyOverrides,o=new Map;n.forEach(e=>{o.set(e.propertyPath.join(),!0)}),i.instance.propertyOverrides.forEach(e=>{var t,n;o.has(e.propertyPath.join())||(r.push(e),a!==c&&a&&(null===(t=e.targetInfo)||void 0===t?void 0:t.localID[0])!==a&&(null===(n=e.targetInfo)||void 0===n||n.localID.unshift(a)))})}}const s={};cc_1.Prefab._utils.generateTargetMap(e,s,!0),cc_1.Prefab._utils.applyPropertyOverrides(e,e._prefab.instance.propertyOverrides,s)}}syncPrefabInfo(e,t,r){if(!e||!t||!r)return;const n=e._prefab;if(!n)return;utils_1.prefabUtils.fireBeforeChangeMsg(t),t._prefab||(t._prefab=new PrefabInfo);const o=t._prefab;if(!o)return;if(o.instance&&t!==r)return o.asset=n.asset,o.instance.prefabRootNode=r,void utils_1.prefabUtils.fireChangeMsg(t);if(o.fileId=n.fileId,o.asset=n.asset,o.root=r,e.components.length!==t.components.length)return void console.error("Prefab Component doesn't match");for(let r=0;r<e.components.length;r++){const n=e.components[r],o=t.components[r];n&&n.__prefab&&o&&(o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab.fileId=n.__prefab.fileId)}utils_1.prefabUtils.fireChangeMsg(t);const s=[];if(t.children.forEach(e=>{e.objFlags&cc_1.CCObject.Flags.HideInHierarchy||s.push(e)}),e.children.length===s.length)for(let t=0;t<e.children.length;t++){const n=e.children[t],o=s[t];this.syncPrefabInfo(n,o,r)}else console.error("Prefab Node doesn't match")}createReservedPropertyOverrides(e){const t=e._prefab,r=null===t||void 0===t?void 0:t.instance;if(t&&r)for(let n=0;n<RootReservedProperty.length;n++){const o=[t.fileId],s=[RootReservedProperty[n]],i=e[RootReservedProperty[n]];utils_1.prefabUtils.getPropertyOverride(r,o,s).value=i}}revertPropertyOverrideOfTarget(e,t){if(!t||!t.propPath)return!1;const r=(t.propPath.replace(/^__comps__/,compKey)||"").split("."),n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,r);if(!n)return!1;const o=n.outMostPrefabInstanceNode;if(!o)return!1;const s=o._prefab,i=null===s||void 0===s?void 0:s.instance;if(!i||!(null===s||void 0===s?void 0:s.asset))return!1;const a=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!a)return!1;const c={},f={};cc_1.Prefab._utils.generateTargetMap(a,c,!0),cc_1.Prefab._utils.generateTargetMap(e,f,!0),utils_1.prefabUtils.fireBeforeChangeMsg(e);for(let e=0;e<i.propertyOverrides.length;e++){const t=i.propertyOverrides[e];if(t.isTarget(n.targetPath,n.relativePathKeys)){this.revertPropertyOverride(t,f,c),i.propertyOverrides.splice(e,1);break}}return utils_1.prefabUtils.fireChangeMsg(e),!0}revertPropertyOverride(e,t,r){if(!e||!e.targetInfo)return!1;const n=e.targetInfo,o=cc_1.Prefab._utils.getTarget(n.localID,r),s=cc_1.Prefab._utils.getTarget(n.localID,t);if(!o||!s)return!1;let i=null;if(s instanceof cc_1.Node?i=s:s instanceof cc_1.Component&&(i=s.node),!i)return!1;let a=o,c=s,f=s,l="";const d=e.propertyPath.slice();if(d.length>0){const e=d.pop();if(!e)return!1;for(let e=0;e<d.length;e++){const t=d[e];l=t,a=a[t],f=c,c=c[t]}utils_1.prefabUtils.fireBeforeChangeMsg(i),c[e]=a[e],Array.isArray(c)&&f&&l&&(f[l]=c),utils_1.prefabUtils.fireChangeMsg(i)}else console.warn("property path is empty");return!0}async revertPrefab(e){var t;let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;const n=r._prefab,o=null===n||void 0===n?void 0:n.instance;if(!o||!(null===n||void 0===n?void 0:n.asset))return!1;const s=(0,cc_1.instantiate)(n.asset);if(!s)return!1;const i=r._prefab,a=s._prefab;if(!i||!a)return!1;const c={},f={};cc_1.Prefab._utils.generateTargetMap(s,c,!0),cc_1.Prefab._utils.generateTargetMap(r,f,!0),utils_1.prefabUtils.fireBeforeChangeMsg(r);const l=[];for(let e=0;e<o.propertyOverrides.length;e++){const t=o.propertyOverrides[e];this.isReservedPropertyOverrides(t,n.fileId)?l.push(t):this.revertPropertyOverride(t,f,c)}o.propertyOverrides=l,this.isRemovingMountedChildren=!0;for(let e=0;e<o.mountedChildren.length;e++){const t=o.mountedChildren[e];for(let e=0;e<t.nodes.length;e++)t.nodes[e].setParent(null)}o.mountedChildren=[],this.isRemovingMountedChildren=!1,component_1.componentOperation.isRemovingMountedComponents=!0;for(let e=0;e<o.mountedComponents.length;e++){const t=o.mountedComponents[e];for(let e=t.components.length-1;e>=0;e--){const r=t.components[e];r&&r.node&&r.node.removeComponent(r)}}cc.Object._deferredDestroy(),o.mountedComponents=[],component_1.componentOperation.isRemovingMountedComponents=!1,component_1.componentOperation.isRevertingRemovedComponents=!0;for(let e=0;e<o.removedComponents.length;e++){const r=o.removedComponents[e],n=cc_1.Prefab._utils.getTarget(r.localID,c);if(!n)continue;const s=r.localID.slice();s.pop(),s.push(null===(t=n.node._prefab)||void 0===t?void 0:t.fileId);const i=cc_1.Prefab._utils.getTarget(s,f);await component_1.componentOperation.cloneComponentToNode(i,n)}return o.removedComponents=[],component_1.componentOperation.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(r),await cce.SceneFacadeManager.softReloadScene(),!0}removePrefabInfoFromNode(e,t){e.children.forEach(e=>{var r;(null===(r=e._prefab)||void 0===r?void 0:r.instance)?t&&this.removePrefabInfoFromNode(e,t):this.removePrefabInfoFromNode(e,t)}),utils_1.prefabUtils.removePrefabInfo(e)}removePrefabInfoFromInstanceNode(e,t){const r=e._prefab;return!!r&&(!(!r.instance&&r.asset)&&(utils_1.prefabUtils.removeMountedRootInfo(e),utils_1.prefabUtils.walkNode(e,(r,n)=>{if(!n)return!1;const o=r._prefab;if(!o)return!0;const s=o.instance;if(s||!o.asset){if(s&&s.prefabRootNode===e&&(s.prefabRootNode=void 0,utils_1.prefabUtils.fireChangeMsg(r)),!t)return!0;this.removePrefabInfoFromInstanceNode(r)}else utils_1.prefabUtils.removePrefabInfo(r);return!1}),utils_1.prefabUtils.removePrefabInfo(e),!0))}removePrefabInstanceAndChangeRoot(e,t,r){e.children.forEach(e=>{var n;(null===(n=e._prefab)||void 0===n?void 0:n.instance)?r&&this.removePrefabInstanceAndChangeRoot(e,t,r):this.removePrefabInstanceAndChangeRoot(e,t,r)});const n=e._prefab;if(!n)return;utils_1.prefabUtils.fireBeforeChangeMsg(e);const o=t._prefab;o&&(n.root=t,n.asset=o.asset),n.instance&&(n.instance=void 0),n.fileId=e.uuid,e.components.forEach(e=>{e.__prefab&&(e.__prefab.fileId=e.uuid)}),utils_1.prefabUtils.fireChangeMsg(e)}unWrapPrefabInstance(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;const n=r._prefab;return!!n&&(!(!n.instance&&n.asset)&&this.removePrefabInfoFromInstanceNode(r,t))}unWrapPrefabInstanceInPrefabMode(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;const n=r._prefab;if(!n)return!1;let o=r;if(utils_1.prefabUtils.getMountedRoot(r)?o=scene_1.default.rootNode:r.parent&&r.parent._prefab&&(o=r.parent._prefab.root),!o)return!1;const s=o._prefab;if(!s)return!1;if(n.instance||!n.asset){this.removePrefabInfoFromInstanceNode(r,t),utils_1.prefabUtils.addPrefabInfo(r,o,s.asset);const e=[];return utils_1.prefabUtils.findOutmostPrefabInstanceNodes(r,e),e.forEach(e=>{var t;const r=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.instance;r&&(r.fileId=utils_1.prefabUtils.generateUUID(),utils_1.prefabUtils.fireChangeMsg(e))}),!0}return!1}}const nodeOperation=new NodeOperation;exports.nodeOperation=nodeOperation;