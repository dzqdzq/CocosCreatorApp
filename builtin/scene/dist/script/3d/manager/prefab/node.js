"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),component_1=require("./component"),node_1=__importDefault(require("../node")),util_1=require("util"),node_2=__importDefault(require("../../../utils/node")),event_enum_1=require("../../../../script/public/event-enum"),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),timer_util_1=require("../../utils/timer-util"),scene_1=__importDefault(require("../scene")),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,RootReservedProperty=["_name","_lpos","_lrot","_euler"],compKey="_components",diffExcludePropMap={"cc.Node":["_objFlags","_parent","_children","_components","_prefab",cc_1.editorExtrasTag],"cc.Component":["node","_objFlags",cc_1.editorExtrasTag]};function getDiffExcludeProps(e){let t=[];return Object.keys(diffExcludePropMap).forEach(r=>{const n=cc_1.js.getClassByName(r);n&&cc_1.js.isChildClassOf(e,n)&&(t=t.concat(diffExcludePropMap[r]))}),t}class ApplyPrefabCommand{constructor(e,t,r){this._applyPrefabInfo=e,this._undoFunc=t,this._redoFunc=r}async undo(){this._undoFunc(this._applyPrefabInfo)}async redo(){this._redoFunc(this._applyPrefabInfo.nodeUUID)}}class NodeOperation{constructor(){this.assetToNodesMap=new Map,this.isRemovingMountedChildren=!1,this._timerUtil=new timer_util_1.TimerUtil}onSceneOpened(e){this.assetToNodesMap.clear(),component_1.componentOperation.clearCompCache(),utils_1.prefabUtils.clearCache(),this._timerUtil.clear(),node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t instanceof cc_1.Scene||node_2.default.isEditorNode(t)||(this.checkToAddPrefabAssetMap(t),t.components.forEach(e=>{component_1.componentOperation.cacheComp(e)}))})}onNodeRemoved(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){const r=this.assetToNodesMap.get(t.asset._uuid);if(r){const t=r.indexOf(e);t>=0&&r.splice(t,1)}}}checkToAddOverrides(e,t,r){var n,o,s;if(!e)return;if(!t)return;const i=(t.replace(/^__comps__/,compKey)||"").split("."),a=utils_1.prefabUtils.getPrefab(e);let f=null;i.length>=3&&i[0]===compKey&&(f=e[i[0]][i[1]]);const c=a&&!(null===(o=null===(n=a.root)||void 0===n?void 0:n._prefab)||void 0===o?void 0:o.instance);if(!a||c||f&&utils_1.prefabUtils.isMountedComponent(f)){if(!r)return;if(f){const e=component_1.componentOperation.getCachedComp(f.uuid);if(!e)return void console.error(`can't get compared component of ${f.name}`);const t=this.getDiffPropertyInfos(f,e,[],this.isInTargetOverrides.bind(this,f,null===(s=r._prefab)||void 0===s?void 0:s.targetOverrides));if(t&&t.length>0)for(let e=0;e<t.length;e++){const n=t[e];this.checkToAddTargetOverride(f,n,r)}}}else this.checkToAddPropertyOverrides(e,i,r)}onNodeChangedInGeneralMode(e,t,r){var n,o;if(t)if(t.type!==event_enum_1.NodeEventType.CHILD_CHANGED){if(t.type===event_enum_1.NodeEventType.PARENT_CHANGED&&t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab){const t=null===(n=e._prefab)||void 0===n?void 0:n.instance,r=null===(o=e.parent)||void 0===o?void 0:o._prefab;t&&r&&(t.prefabRootNode=r.root)}if(("children"!==t.propPath||t.type!==event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT)&&t.propPath){const n=e.uuid+"|"+t.propPath;this._timerUtil.callFunctionLimit(n,this.checkToAddOverrides.bind(this),e,t.propPath,r)}}else this.updateChildrenData(e)}onAddNode(e){const t=e.parent;t&&(this.updateChildrenData(t),this.createReservedPropertyOverrides(e))}onNodeAdded(e,t){if(this.checkToAddPrefabAssetMap(e),t.modeName===scene_facade_state_interface_1.SceneModeType.Prefab){const t=utils_1.prefabUtils.getPrefab(e),r=scene_1.default.rootNode;if(!r)return;const n=utils_1.prefabUtils.getPrefab(r);if(!n)return;(null===t||void 0===t?void 0:t.instance)?t.instance.prefabRootNode=n.root:utils_1.prefabUtils.addPrefabInfo(e,n.root,n.asset)}}checkToAddTargetOverride(e,t,r){var n;if(!(e instanceof cc_1.Component))return!1;const o=t.value,s=r._prefab;if((null===o||void 0===o)&&e)return utils_1.prefabUtils.removeTargetOverride(s,e,t.pathKeys),!1;let i=null;if(o instanceof cc_1.Node?i=o:o instanceof cc_1.Component&&(i=o.node),!i)return!1;if(!utils_1.prefabUtils.getPrefab(i))return!1;const a=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(i),f=a.outMostPrefabInstanceNode;if(!f)return!1;if(o instanceof cc_1.Node&&f===o)return utils_1.prefabUtils.removeTargetOverride(s,e,t.pathKeys),!1;const c=a.targetPath;if(null===(n=f._prefab)||void 0===n?void 0:n.instance){if(c.splice(0,1),o instanceof cc_1.Node){const e=o._prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab node: ${o.name}`),!1;c.push(e.fileId)}else if(o instanceof cc_1.Component){const e=o.__prefab;if(!e||!e.fileId)return utils_1.prefabUtils.getMountedRoot(o)||console.error(`can't get fileId of prefab component: ${o.name} in node: ${o.node.name}`),!1;c.push(e.fileId)}if(!r)return!1;r._prefab||(r._prefab=utils_1.prefabUtils.createPrefabInfo(r.uuid));const n=r._prefab,s=utils_1.prefabUtils.getTargetOverride(n,e,t.pathKeys);if(s){utils_1.prefabUtils.fireBeforeChangeMsg(r),s.target=f;const e=new TargetInfo;return e.localID=c,s.targetInfo=e,utils_1.prefabUtils.fireChangeMsg(r),!0}}return!1}checkToAddPropertyOverrides(e,t,r){const n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,t);if(!n)return;const o=n.outMostPrefabInstanceNode;if(!o)return;const s=o._prefab;if(!s||!s.asset)return;const i=null===s||void 0===s?void 0:s.instance;if(!i)return;const a=n.target,f=utils_1.prefabUtils.getMountedRoot(a);if(f&&f===o)return;const c=n.targetPath,l=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!l)return;const d=utils_1.prefabUtils.getTargetMap(l),p=cc_1.Prefab._utils.getTarget(c,d);if(!p)return void console.debug(`can't find item: ${a.name} in prefab asset ${s.asset._uuid}`);const u=utils_1.prefabUtils.getPropertyOverridesOfTarget(i,c),_=this.getDiffPropertyInfos(a,p,[],this.isInPropertyOverrides.bind(this,u));if(_&&_.length>0){utils_1.prefabUtils.fireBeforeChangeMsg(n.outMostPrefabInstanceNode);for(let e=0;e<_.length;e++){const t=_[e];a instanceof cc_1.Component&&this.checkToAddTargetOverride(a,t,r)||(utils_1.prefabUtils.getPropertyOverride(i,c,t.pathKeys).value=t.value)}utils_1.prefabUtils.fireChangeMsg(n.outMostPrefabInstanceNode)}}isInTargetOverrides(e,t,r){return!!t&&utils_1.prefabUtils.isInTargetOverrides(t,e,r)}isInPropertyOverrides(e,t){return utils_1.prefabUtils.isInPropertyOverrides(t,e)}getDiffPropertyInfos(e,t,r,n){if(!e)return null;const o=e.constructor,s=t.constructor;if(!o||!s||o!==s)return null;const i=o.__values__,a=getDiffExcludeProps(o);let f=[];return i.map(s=>{if(a.includes(s))return;if(!1===cc_1.CCClass.attr(o,s).serializable)return;const i=e[s],c=t[s],l=this.handleDiffPropertyInfos(i,c,s,r,n);f=f.concat(l)}),f}handleDiffPropertyInfos(e,t,r,n,o){var s,i;let a=[];const f=n.concat(r),c={pathKeys:f,value:e};if(null===e||void 0===e)(e!==t||o(f))&&a.push(c);else if(null===t||void 0===t||o(f))a.push(c);else if(Array.isArray(e)){const r=f.concat("length");if(e.length!==t.length||o(r)){const t={pathKeys:r,value:e.length};a.push(t)}for(let r=0;r<e.length;r++){const n=this.handleDiffPropertyInfos(e[r],t[r],""+r,f,o);n&&n.length>0&&(a=a.concat(n))}}else if("object"==typeof e){if(e instanceof cc_1.Node){const r=e._prefab;(r&&r.fileId!==(null===(s=t._prefab)||void 0===s?void 0:s.fileId)||e.uuid!==t.uuid)&&a.push(c)}else if(e instanceof cc_1.Component)(e.__prefab&&e.__prefab.fileId!==(null===(i=t.__prefab)||void 0===i?void 0:i.filedId)||e.uuid!==t.uuid)&&a.push(c);else if(e instanceof cc_1.ValueType)e.equals(t)&&!o(f)||a.push(c);else if(e instanceof cc_1.Asset)(e._uuid!==t._uuid||o(f))&&a.push(c);else if(cc_1.CCClass._isCCClass(e.constructor)){const r=this.getDiffPropertyInfos(e,t,f,o);r&&r.length>0&&(a=a.concat(r))}}else(e!==t||o(f))&&a.push(c);return a}checkToAddPrefabAssetMap(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){let r=this.assetToNodesMap.get(t.asset._uuid);r||(r=[],this.assetToNodesMap.set(t.asset._uuid,r)),r.includes(e)||r.push(e)}}isReservedPropertyOverrides(e,t){const r=e.targetInfo;if(1===(null===r||void 0===r?void 0:r.localID.length)&&r.localID[0]===t){const t=e.propertyPath;if(1===t.length&&RootReservedProperty.includes(t[0]))return!0}return!1}removeModifiedPropertyOverrides(e,t){const r=[];for(let n=0;n<e.propertyOverrides.length;n++){const o=e.propertyOverrides[n];this.isReservedPropertyOverrides(o,t)&&r.push(o)}e.propertyOverrides=r}applyMountedChildren(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=new Map,s=n.mountedChildren;for(let i=0;i<s.length;i++){const a=s[i],f=a.targetInfo;if(f)if(f.localID.length>1){const e=utils_1.prefabUtils.getTargetMap(t),s=cc_1.Prefab._utils.getTarget(f.localID,e);r.instance=void 0;const i=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s);r.instance=n;const c=i.outMostPrefabInstanceNode;if(!c)continue;const l=c._prefab;if(!l)continue;const d=l.instance;if(!d)continue;const p=i.targetPath.slice();p.splice(0,1);const u=p.slice();u.push(l.fileId);const _=utils_1.prefabUtils.getPrefabInstanceMountedChildren(d,u);a.nodes.forEach(e=>{const t=e._prefab;utils_1.prefabUtils.addPrefabInfo(e,c,l.asset),utils_1.prefabUtils.setMountedRoot(e,c);const r=e._prefab;if(!r)return;const n=p.slice().concat([r.fileId]);o.set(n,{prefabInfo:t})}),_.nodes=_.nodes.concat(a.nodes)}else a.nodes.forEach(t=>{const n=t._prefab;utils_1.prefabUtils.setMountedRoot(t,void 0),n?(n.instance||utils_1.prefabUtils.addPrefabInfo(t,e,r.asset),o.set([n.fileId],{prefabInfo:null})):utils_1.prefabUtils.addPrefabInfo(t,e,r.asset)})}return n.mountedChildren=[],o}applyPropertyOverrides(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=n.propertyOverrides,s=[];for(let e=0;e<o.length;e++){const i=o[e];if(this.isReservedPropertyOverrides(i,r.fileId)){s.push(i);continue}const a=i.targetInfo;if(a&&a.localID.length>1){const e=utils_1.prefabUtils.getTargetMap(t),o=cc_1.Prefab._utils.getTarget(a.localID,e);if(!o)continue;let s=o;s instanceof cc_1.Component&&(s=s.node),r.instance=void 0;const f=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s);r.instance=n;const c=f.outMostPrefabInstanceNode;if(!c)continue;const l=c._prefab;if(!l)continue;const d=l.instance;if(!d)continue;const p=f.targetPath.slice();p.splice(0,1);const u=o instanceof cc_1.Node?o._prefab:o.__prefab;if(!u)continue;p.push(u.fileId),utils_1.prefabUtils.getPropertyOverride(d,p,i.propertyPath).value=i.value}}n.propertyOverrides=s}applyRemovedComponents(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!o)return null;const s={},i={};cc_1.Prefab._utils.generateTargetMap(t,s,!0),cc_1.Prefab._utils.generateTargetMap(o,i,!0);const a=n.removedComponents;for(let e=0;e<a.length;e++){const t=a[e];if(t&&t.localID.length>1){const e=cc_1.Prefab._utils.getTarget(t.localID,i);if(!e||!e.__prefab)continue;const o=e.node,a=utils_1.prefabUtils.getPrefab(o);if(!e||!a)continue;const f=t.localID.slice();f.pop(),f.push(a.fileId);const c=cc_1.Prefab._utils.getTarget(f,s);r.instance=void 0;const l=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(c);r.instance=n;const d=l.outMostPrefabInstanceNode;if(!d)continue;const p=utils_1.prefabUtils.getPrefab(d);if(!p)continue;const u=p.instance;if(!u)continue;const _=l.targetPath.slice();_.splice(0,1),_.push(e.__prefab.fileId);const b=new TargetInfo;b.localID=_,u.removedComponents.push(b)}}n.removedComponents=[]}async applyPrefab(e){cce.SceneFacadeManager.snapshot();const t=await this.doApplyPrefab(e);return!!t&&(cce.SceneFacadeManager.snapshot(new ApplyPrefabCommand(t,this.undoApplyPrefab.bind(this),this.doApplyPrefab.bind(this))),cce.SceneFacadeManager.abortSnapshot(),!1)}async doApplyPrefab(e){const t=node_1.default.query(e);if(!t)return null;const r=t._prefab,n=null===r||void 0===r?void 0:r.instance;if(!n||!(null===r||void 0===r?void 0:r.asset))return null;const o=r.asset;if(utils_1.prefabUtils.isSubAsset(o._uuid))return console.warn("can't apply data to SubAsset Prefab"),null;const s=o.data,i=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!i)return null;const a=this.applyMountedChildren(t);if(!a)return null;const f=component_1.componentOperation.applyMountedComponents(t);if(!f)return null;const c=n.propertyOverrides;this.applyPropertyOverrides(t);const l=n.removedComponents;this.applyRemovedComponents(t);const d=utils_1.prefabUtils.generatePrefabDataFromNode(t);return await Editor.Message.request("asset-db","create-asset",i.source,d,{overwrite:!0}),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(r),{nodeUUID:e,mountedChildrenInfoMap:a,mountedComponentsInfoMap:f,propertyOverrides:c,removedComponents:l,oldPrefabNodeData:s}}async undoApplyPrefab(e){const t=node_1.default.query(e.nodeUUID),r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=r.asset;if(!o)return;const s=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!s)return;o.data=e.oldPrefabNodeData;const i=cce.Utils.serialize(o);n.mountedChildren=[];const a=utils_1.prefabUtils.getTargetMap(t);e.mountedChildrenInfoMap.forEach((e,r)=>{const n=cc_1.Prefab._utils.getTarget(r,a);n&&(utils_1.prefabUtils.setMountedRoot(n,t),n._prefab=e.prefabInfo,n.parent&&this.updateChildrenData(n.parent))}),e.mountedComponentsInfoMap.forEach((e,r)=>{const n=cc_1.Prefab._utils.getTarget(r,a);n&&(utils_1.prefabUtils.setMountedRoot(n,t),n.__prefab=e.prefabInfo,n.node&&component_1.componentOperation.updateMountedComponents(n.node))}),n.propertyOverrides=e.propertyOverrides,n.removedComponents=e.removedComponents,await Editor.Message.request("asset-db","create-asset",s.source,i,{overwrite:!0})}updateChildrenData(e){if(!e)return;if(this.isRemovingMountedChildren)return;const t=e._prefab;if(!t)return;const r=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),n=r.outMostPrefabInstanceNode;if(!n)return;const o=r.targetPath,s=n._prefab,i=null===s||void 0===s?void 0:s.instance;if(!n||!s||!i)return;const a=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!a)return;o.splice(0,1),o.push(t.fileId);const f=utils_1.prefabUtils.getTargetMap(a),c=cc_1.Prefab._utils.getTarget(o,f);if(!c)return;const l=c.children.map(e=>{const t=e._prefab;if(t)return t.instance?t.instance.fileId:t.fileId}),d=[];for(let t=0;t<e.children.length;t++){const r=e.children[t],o=utils_1.prefabUtils.getPrefab(r),s=null===o||void 0===o?void 0:o.instance;if(o){const e=s?s.fileId:o.fileId;if(!l.includes(e)){const e=utils_1.prefabUtils.getMountedRoot(r);e&&e!==n||d.push(r)}}else d.push(r)}if(utils_1.prefabUtils.fireBeforeChangeMsg(n),d.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedChildren(i,o);e.nodes=d,e.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,n)})}else for(let e=0;e<i.mountedChildren.length;e++){const t=i.mountedChildren[e];if(t.isTarget(o)){t.nodes.forEach(e=>{utils_1.prefabUtils.setMountedRoot(e,void 0)}),i.mountedChildren.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(n)}isCircularRefPrefabInstance(e,t){const r=e._prefab;if(!r)return!1;if(!r.instance)return!1;if(e===t)return!1;function n(e,t){var r,n;const o=e._prefab,s=null===o||void 0===o?void 0:o.instance,i=t._prefab,a=null===i||void 0===i?void 0:i.instance;return!(!s||!a||(null===(r=null===o||void 0===o?void 0:o.asset)||void 0===r?void 0:r._uuid)!==(null===(n=null===i||void 0===i?void 0:i.asset)||void 0===n?void 0:n._uuid))}if(n(e,t))return!0;let o=e.parent;if(!o)return!1;for(;o&&o!==t;){if(n(e,o))return!0;o=o.parent}return!1}canBeMadeToPrefabAsset(e){let t=!1,r=!1;return e.walk(n=>{n.getComponent(cc_1.Terrain)&&(t=!0),this.isCircularRefPrefabInstance(n,e)&&(console.warn(`Circular reference prefab checked: [${n.name}]`),r=!0)}),t?(console.warn("Can't create prefabAsset from a node that contains terrain"),!1):!r||(console.warn("Can't create prefabAsset from a node that contains circular reference prefab"),!1)}async createPrefabAssetFromNode(e,t){const r=node_1.default.query(e),n=utils_1.prefabUtils.getPrefab(r);if(n&&n.root){const e=n.root;if(e._prefab.instance&&e!==r)return console.warn("can't create prefabAsset from a prefabNode inside a prefabInstance"),null}if(!this.canBeMadeToPrefabAsset(r))return null;const o=utils_1.prefabUtils.generatePrefabDataFromNode(r);if(!o)return null;n&&n.asset&&this.assetToNodesMap.delete(n.asset._uuid);const s=await Editor.Message.request("asset-db","create-asset",t,o,{overwrite:!0});return await this.linkNodeWithPrefabAsset(r,null===s||void 0===s?void 0:s.uuid),null===s||void 0===s?void 0:s.uuid}async linkNodeWithPrefabAsset(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;let n=t;if("string"==typeof t&&(n=await util_1.promisify(cc_1.assetManager.loadAny)(t)),!n)return console.error(`asset ${t} doesn't exist`),!1;const o=n.data;if(!o||!o._prefab)return;utils_1.prefabUtils.fireBeforeChangeMsg(r);let s=r._prefab;if(s||(s=new PrefabInfo,r._prefab=s),utils_1.prefabUtils.removePrefabAssetNodeInstanceCache(s),s.instance)utils_1.prefabUtils.removeMountedRootInfo(r);else{const e=utils_1.prefabUtils.createPrefabInstance(),t=r._prefab;t&&(e.prefabRootNode=t.root),t.instance=e}s.fileId=o._prefab.fileId,s.root=r;const i=null===s||void 0===s?void 0:s.instance;return s&&i&&(this.createReservedPropertyOverrides(r),i.mountedChildren=[],this.removeModifiedPropertyOverrides(i,s.fileId)),s.asset=n,utils_1.prefabUtils.fireChangeMsg(r),this.syncPrefabInfo(o,r,r),this.checkToAddPrefabAssetMap(r),!0}syncPrefabInfo(e,t,r){if(!e||!t||!r)return;const n=e._prefab;if(!n)return;utils_1.prefabUtils.fireBeforeChangeMsg(t),t._prefab||(t._prefab=new PrefabInfo);const o=t._prefab;if(!o)return;if(o.instance&&t!==r)return o.asset=n.asset,o.instance.prefabRootNode=r,void utils_1.prefabUtils.fireChangeMsg(t);if(o.fileId=n.fileId,o.asset=n.asset,o.root=r,e.components.length!==t.components.length)return void console.error("Prefab Component doesn't match");for(let r=0;r<e.components.length;r++){const n=e.components[r],o=t.components[r];n&&n.__prefab&&o&&(o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab.fileId=n.__prefab.fileId)}utils_1.prefabUtils.fireChangeMsg(t);const s=[];if(t.children.forEach(e=>{e.objFlags&cc_1.CCObject.Flags.HideInHierarchy||s.push(e)}),e.children.length===s.length)for(let t=0;t<e.children.length;t++){const n=e.children[t],o=s[t];this.syncPrefabInfo(n,o,r)}else console.error("Prefab Node doesn't match")}createReservedPropertyOverrides(e){const t=e._prefab,r=null===t||void 0===t?void 0:t.instance;if(t&&r)for(let n=0;n<RootReservedProperty.length;n++){const o=[t.fileId],s=[RootReservedProperty[n]],i=e[RootReservedProperty[n]];utils_1.prefabUtils.getPropertyOverride(r,o,s).value=i}}revertPropertyOverrideOfTarget(e,t){if(!t||!t.propPath)return!1;const r=(t.propPath.replace(/^__comps__/,compKey)||"").split("."),n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,r);if(!n)return!1;const o=n.outMostPrefabInstanceNode;if(!o)return!1;const s=o._prefab,i=null===s||void 0===s?void 0:s.instance;if(!i||!(null===s||void 0===s?void 0:s.asset))return!1;const a=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!a)return!1;const f={},c={};cc_1.Prefab._utils.generateTargetMap(a,f,!0),cc_1.Prefab._utils.generateTargetMap(e,c,!0),utils_1.prefabUtils.fireBeforeChangeMsg(e);for(let e=0;e<i.propertyOverrides.length;e++){const t=i.propertyOverrides[e];if(t.isTarget(n.targetPath,n.relativePathKeys)){this.revertPropertyOverride(t,c,f),i.propertyOverrides.splice(e,1);break}}return utils_1.prefabUtils.fireChangeMsg(e),!0}revertPropertyOverride(e,t,r){if(!e||!e.targetInfo)return!1;const n=e.targetInfo,o=cc_1.Prefab._utils.getTarget(n.localID,r),s=cc_1.Prefab._utils.getTarget(n.localID,t);if(!o||!s)return!1;let i=null;if(s instanceof cc_1.Node?i=s:s instanceof cc_1.Component&&(i=s.node),!i)return!1;let a=o,f=s,c=s,l="";const d=e.propertyPath.slice();if(d.length>0){const e=d.pop();if(!e)return!1;for(let e=0;e<d.length;e++){const t=d[e];l=t,a=a[t],c=f,f=f[t]}utils_1.prefabUtils.fireBeforeChangeMsg(i),f[e]=a[e],Array.isArray(f)&&c&&l&&(c[l]=f),utils_1.prefabUtils.fireChangeMsg(i)}else console.warn("property path is empty");return!0}async revertPrefab(e){var t;let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;const n=r._prefab,o=null===n||void 0===n?void 0:n.instance;if(!o||!(null===n||void 0===n?void 0:n.asset))return!1;const s=cc_1.instantiate(n.asset);if(!s)return!1;const i=r._prefab,a=s._prefab;if(!i||!a)return!1;const f={},c={};cc_1.Prefab._utils.generateTargetMap(s,f,!0),cc_1.Prefab._utils.generateTargetMap(r,c,!0),utils_1.prefabUtils.fireBeforeChangeMsg(r),cce.SceneFacadeManager.snapshot();const l=[];for(let e=0;e<o.propertyOverrides.length;e++){const t=o.propertyOverrides[e];this.isReservedPropertyOverrides(t,n.fileId)?l.push(t):this.revertPropertyOverride(t,c,f)}o.propertyOverrides=l,this.isRemovingMountedChildren=!0;for(let e=0;e<o.mountedChildren.length;e++){const t=o.mountedChildren[e];for(let e=0;e<t.nodes.length;e++)t.nodes[e].setParent(null)}o.mountedChildren=[],this.isRemovingMountedChildren=!1,component_1.componentOperation.isRemovingMountedComponents=!0;for(let e=0;e<o.mountedComponents.length;e++){const t=o.mountedComponents[e];for(let e=0;e<t.components.length;e++){const r=t.components[e];r&&r.node&&r.node.removeComponent(r)}}cc.Object._deferredDestroy(),o.mountedComponents=[],component_1.componentOperation.isRemovingMountedComponents=!1,component_1.componentOperation.isRevertingRemovedComponents=!0;for(let e=0;e<o.removedComponents.length;e++){const r=o.removedComponents[e],n=cc_1.Prefab._utils.getTarget(r.localID,f);if(!n)continue;const s=r.localID.slice();s.pop(),s.push(null===(t=n.node._prefab)||void 0===t?void 0:t.fileId);const i=cc_1.Prefab._utils.getTarget(s,c);await component_1.componentOperation.cloneComponentToNode(i,n)}return o.removedComponents=[],component_1.componentOperation.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(r),await cce.SceneFacadeManager.softReloadScene(),!0}removePrefabInfoFromNode(e,t){e.children.forEach(e=>{var r;(null===(r=e._prefab)||void 0===r?void 0:r.instance)?t&&this.removePrefabInfoFromNode(e,t):this.removePrefabInfoFromNode(e,t)}),utils_1.prefabUtils.removePrefabInfo(e)}removePrefabInfoFromInstanceNode(e,t){const r=e._prefab;r&&(!r.instance&&r.asset||(utils_1.prefabUtils.removeMountedRootInfo(e),utils_1.prefabUtils.walkNode(e,(r,n)=>{if(!n)return!1;const o=r._prefab;if(!o)return!0;const s=o.instance;if(s||!o.asset){if(s&&s.prefabRootNode===e&&(s.prefabRootNode=void 0,utils_1.prefabUtils.fireChangeMsg(r)),!t)return!0;this.removePrefabInfoFromInstanceNode(r)}else utils_1.prefabUtils.removePrefabInfo(r);return!1}),utils_1.prefabUtils.removePrefabInfo(e)))}removePrefabInstanceAndChangeRoot(e,t,r){e.children.forEach(e=>{var n;(null===(n=e._prefab)||void 0===n?void 0:n.instance)?r&&this.removePrefabInstanceAndChangeRoot(e,t,r):this.removePrefabInstanceAndChangeRoot(e,t,r)});const n=e._prefab;if(!n)return;utils_1.prefabUtils.fireBeforeChangeMsg(e);const o=t._prefab;o&&(n.root=t,n.asset=o.asset),n.instance&&(n.instance=void 0),n.fileId=e.uuid,e.components.forEach(e=>{e.__prefab&&(e.__prefab.fileId=e.uuid)}),utils_1.prefabUtils.fireChangeMsg(e)}unWrapPrefabInstance(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;n&&(!n.instance&&n.asset||(cce.SceneFacadeManager.snapshot(),this.removePrefabInfoFromInstanceNode(r,t)))}unWrapPrefabInstanceInPrefabMode(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;if(!n)return;let o=r;if(utils_1.prefabUtils.getMountedRoot(r)?o=scene_1.default.rootNode:r.parent&&r.parent._prefab&&(o=r.parent._prefab.root),!o)return;const s=o._prefab;if(s&&(n.instance||!n.asset)){cce.SceneFacadeManager.snapshot(),this.removePrefabInfoFromInstanceNode(r,t),utils_1.prefabUtils.addPrefabInfo(r,o,s.asset);const e=[];utils_1.prefabUtils.findOutmostPrefabInstanceNodes(r,e),e.forEach(e=>{var t;const r=null===(t=null===e||void 0===e?void 0:e._prefab)||void 0===t?void 0:t.instance;r&&(r.fileId=utils_1.prefabUtils.generateUUID(),utils_1.prefabUtils.fireChangeMsg(e))})}}}const nodeOperation=new NodeOperation;exports.nodeOperation=nodeOperation;