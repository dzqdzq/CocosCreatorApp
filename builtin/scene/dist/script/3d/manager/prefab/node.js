"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeOperation=void 0;const cc_1=require("cc"),utils_1=require("./utils"),component_1=require("./component"),node_1=__importDefault(require("../node")),util_1=require("util"),node_2=__importDefault(require("../../../utils/node")),event_enum_1=require("../../../../script/public/event-enum"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,RootReservedProperty=["_name","_lpos","_lrot"],compKey="_components",diffExcludePropMap={"cc.Node":["_objFlags","_parent","_children","_components"],"cc.Component":["node","_objFlags"]};function getDiffExcludeProps(e){let t=[];return Object.keys(diffExcludePropMap).forEach(r=>{const n=cc_1.js.getClassByName(r);n&&cc_1.js.isChildClassOf(e,n)&&(t=t.concat(diffExcludePropMap[r]))}),t}class ApplyPrefabCommand{constructor(e,t,r){this._applyPrefabInfo=e,this._undoFunc=t,this._redoFunc=r}async undo(){this._undoFunc(this._applyPrefabInfo)}async redo(){this._redoFunc(this._applyPrefabInfo.nodeUUID)}}class NodeOperation{constructor(){this.assetToNodesMap=new Map,this.isRemovingMountedChildren=!1}onSceneOpened(e){this.assetToNodesMap.clear(),node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t instanceof cc_1.Scene||node_2.default.isEditorNode(t)||(this.checkToAddPrefabAssetMap(t),t.components.forEach(e=>{component_1.componentOperation.cacheComp(e)}))})}onNodeRemoved(e,t){const r=e._prefab;if((null===r||void 0===r?void 0:r.instance)&&(null===r||void 0===r?void 0:r.asset)){const t=this.assetToNodesMap.get(r.asset._uuid);if(t){const r=t.indexOf(e);r>=0&&t.splice(r,1)}}}onNodeChangedInGeneralMode(e,t,r){var n;if(t&&t.type===event_enum_1.NodeEventType.CHILD_CHANGED)this.updateChildrenData(e);else if((!t||"children"!==t.propPath||t.type!==event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT)&&t&&t.propPath){const o=(t.propPath.replace(/^__comps__/,compKey)||"").split(".");if(utils_1.prefabUtils.getPrefab(e))this.checkToAddPropertyOverrides(e,o,r);else{if(!r)return;if(o.length>=3&&o[0]===compKey){const t=e[o[0]][o[1]],s=component_1.componentOperation.getCachedComp(t.uuid),a=this.getDiffPropertyInfos(t,s,[],this.isInTargetOverrides.bind(this,t,null===(n=r._prefab)||void 0===n?void 0:n.targetOverrides));if(a&&a.length>0)for(let e=0;e<a.length;e++){const n=a[e];this.checkToAddTargetOverride(t,n,r)}}}}}onNodeAddedInGeneralMode(e){const t=e.parent;t&&(this.updateChildrenData(t),this.checkToAddPrefabAssetMap(e),this.createReservedPropertyOverrides(e))}onNodeAddInPrefabMode(e){const t=e.parent;if(!t)return;const r=utils_1.prefabUtils.getPrefab(t);if(!r)return;const n=utils_1.prefabUtils.getPrefab(e);n&&r.root===n.root||utils_1.prefabUtils.addPrefabInfoToNode(e,r.root,r.asset),this.updateChildrenData(t),this.checkToAddPrefabAssetMap(e),this.createReservedPropertyOverrides(e)}checkToAddTargetOverride(e,t,r){var n;if(!(e instanceof cc_1.Component))return!1;const o=t.value;if((null===o||void 0===o)&&e){const n=r._prefab;return utils_1.prefabUtils.removeTargetOverride(n,e,t.pathKeys),!1}let s=null;if(o instanceof cc_1.Node?s=o:o instanceof cc_1.Component&&(s=o.node),!s)return!1;if(!utils_1.prefabUtils.getPrefab(s))return!1;const a=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s),i=a.outMostPrefabInstanceNode;if(!i)return!1;if(o instanceof cc_1.Node&&i===o)return!1;const f=a.targetPath;if(null===(n=i._prefab)||void 0===n?void 0:n.instance){if(f.splice(0,1),o instanceof cc_1.Node){const e=o._prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab node: ${o.name}`),!1;f.push(e.fileId)}else if(o instanceof cc_1.Component){const e=o.__prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab component: ${o.name} in node: ${o.node.name}`),!1;f.push(e.fileId)}if(!r)return!1;r._prefab||(r._prefab=new PrefabInfo);const n=r._prefab,s=utils_1.prefabUtils.getTargetOverride(n,e,t.pathKeys);if(s){utils_1.prefabUtils.fireBeforeChangeMsg(r),s.target=i;const e=new TargetInfo;return e.localID=f,s.targetInfo=e,utils_1.prefabUtils.fireChangeMsg(r),!0}}return!1}checkToAddPropertyOverrides(e,t,r){const n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,t);if(!n)return;const o=n.outMostPrefabInstanceNode;if(!o)return;const s=o._prefab;if(!s||!s.asset)return;const a=null===s||void 0===s?void 0:s.instance;if(!a)return;const i=n.target;if(i._mountedRoot&&i._mountedRoot===o)return;const f=n.targetPath,c=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!c)return;const l=utils_1.prefabUtils.getTargetMap(c),d=cc_1.Prefab._utils.getTarget(f,l);d||console.log(`can't find item: ${i.name} in prefab asset ${s.asset._uuid}`);const p=utils_1.prefabUtils.getPropertyOverridesOfTarget(a,f),u=this.getDiffPropertyInfos(i,d,[],this.isInPropertyOverrides.bind(this,p));if(utils_1.prefabUtils.removePropertyOverride(a,f,n.relativePathKeys),u&&u.length>0){utils_1.prefabUtils.fireBeforeChangeMsg(n.outMostPrefabInstanceNode);for(let e=0;e<u.length;e++){const t=u[e];i instanceof cc_1.Component&&this.checkToAddTargetOverride(i,t,r)||(utils_1.prefabUtils.getPropertyOverride(a,f,t.pathKeys).value=t.value)}utils_1.prefabUtils.fireChangeMsg(n.outMostPrefabInstanceNode)}}isInTargetOverrides(e,t,r){return!!t&&utils_1.prefabUtils.isInTargetOverrides(t,e,r)}isInPropertyOverrides(e,t){return utils_1.prefabUtils.isInPropertyOverrides(t,e)}getDiffPropertyInfos(e,t,r,n){if(!e)return null;const o=e.constructor,s=t.constructor;if(!o||!s||o!==s)return null;const a=o.__values__,i=getDiffExcludeProps(o);let f=[];return a.map(s=>{if(i.includes(s))return;if(!1===cc_1.CCClass.attr(o,s).serializable)return;const a=e[s],c=t[s],l=this.handleDiffPropertyInfos(a,c,s,r,n);f=f.concat(l)}),f}handleDiffPropertyInfos(e,t,r,n,o){var s,a;let i=[];const f=n.concat(r),c={pathKeys:f,value:e};if(null===e||void 0===e)(e!==t||o(f))&&i.push(c);else if(null===t||void 0===t||o(f))i.push(c);else if(Array.isArray(e)){const r=f.concat("length");if(e.length!==t.length||o(r)){const t={pathKeys:r,value:e.length};i.push(t)}for(let r=0;r<e.length;r++){const n=this.handleDiffPropertyInfos(e[r],t[r],""+r,f,o);n&&n.length>0&&(i=i.concat(n))}}else if("object"==typeof e){if(e instanceof cc_1.Node){const r=e._prefab;(r&&r.fileId!==(null===(s=t._prefab)||void 0===s?void 0:s.fileId)||e.uuid!==t.uuid)&&i.push(c)}else if(e instanceof cc_1.Component)(e.__prefab&&e.__prefab.fileId!==(null===(a=t.__prefab)||void 0===a?void 0:a.filedId)||e.uuid!==t.uuid)&&i.push(c);else if(e instanceof cc_1.ValueType)e.equals(t)&&!o(f)||i.push(c);else if(e instanceof cc_1.Asset)(e._uuid!==t._uuid||o(f))&&i.push(c);else if(cc_1.CCClass._isCCClass(e.constructor)){const r=this.getDiffPropertyInfos(e,t,f,o);r&&r.length>0&&i.concat(r)}}else(e!==t||o(f))&&i.push(c);return i}checkToAddPrefabAssetMap(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){let r=this.assetToNodesMap.get(t.asset._uuid);r||(r=[],this.assetToNodesMap.set(t.asset._uuid,r)),r.includes(e)||r.push(e)}}isReservedPropertyOverrides(e,t){const r=e.targetInfo;if(1===(null===r||void 0===r?void 0:r.localID.length)&&r.localID[0]===t){const t=e.propertyPath;if(1===t.length&&RootReservedProperty.includes(t[0]))return!0}return!1}removeModifiedPropertyOverrides(e,t){const r=[];for(let n=0;n<e.propertyOverrides.length;n++){const o=e.propertyOverrides[n];this.isReservedPropertyOverrides(o,t)&&r.push(o)}e.propertyOverrides=r}applyMountedChildren(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=new Map,s=n.mountedChildren;for(let a=0;a<s.length;a++){const i=s[a],f=i.targetInfo;if(f)if(f.localID.length>1){const e=utils_1.prefabUtils.getTargetMap(t),s=cc_1.Prefab._utils.getTarget(f.localID,e);r.instance=void 0;const a=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(s);r.instance=n;const c=a.outMostPrefabInstanceNode;if(!c)continue;const l=c._prefab;if(!l)continue;const d=l.instance;if(!d)continue;const p=a.targetPath.slice();p.splice(0,1);const u=p.slice();u.push(l.fileId);const _=utils_1.prefabUtils.getPrefabInstanceMountedChildren(d,u);i.nodes.forEach(e=>{const t=e._prefab;utils_1.prefabUtils.addPrefabInfoToNode(e,c,l.asset);const r=e._prefab;if(!r)return;const n=p.slice().concat([r.fileId]);o.set(n,{prefabInfo:t})}),_.nodes=_.nodes.concat(i.nodes)}else i.nodes.forEach(t=>{utils_1.prefabUtils.addPrefabInfoToNode(t,e,r.asset);const n=t._prefab;n&&o.set([n.fileId],{prefabInfo:null})})}return n.mountedChildren=[],o}applyPropertyOverrides(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=n.propertyOverrides,s=[];for(let e=0;e<o.length;e++){const a=o[e];if(this.isReservedPropertyOverrides(a,r.fileId)){s.push(a);continue}const i=a.targetInfo;if(i&&i.localID.length>1){const e=utils_1.prefabUtils.getTargetMap(t),o=cc_1.Prefab._utils.getTarget(i.localID,e);if(!o)continue;r.instance=void 0;const s=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(o);r.instance=n;const f=s.outMostPrefabInstanceNode;if(!f)continue;const c=f._prefab;if(!c)continue;const l=c.instance;if(!l)continue;const d=s.targetPath.slice();d.splice(0,1);const p=o._prefab;if(!p)continue;d.push(p.fileId),utils_1.prefabUtils.getPropertyOverride(l,d,a.propertyPath).value=a.value}}n.propertyOverrides=s}applyRemovedComponents(e){const t=e,r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=utils_1.prefabUtils.getPrefabAssetNodeInstance(r);if(!o)return null;const s={},a={};cc_1.Prefab._utils.generateTargetMap(t,s,!0),cc_1.Prefab._utils.generateTargetMap(o,a,!0);const i=n.removedComponents;for(let e=0;e<i.length;e++){const t=i[e];if(t&&t.localID.length>1){const e=cc_1.Prefab._utils.getTarget(t.localID,a);if(!e||!e.__prefab)continue;const o=e.node,i=utils_1.prefabUtils.getPrefab(o);if(!e||!i)continue;const f=t.localID.slice();f.pop(),f.push(i.fileId);const c=cc_1.Prefab._utils.getTarget(f,s);r.instance=void 0;const l=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(c);r.instance=n;const d=l.outMostPrefabInstanceNode;if(!d)continue;const p=utils_1.prefabUtils.getPrefab(d);if(!p)continue;const u=p.instance;if(!u)continue;const _=l.targetPath.slice();_.splice(0,1),_.push(e.__prefab.fileId);const b=new TargetInfo;b.localID=_,u.removedComponents.push(b)}}n.removedComponents=[]}async applyPrefab(e){cce.SceneFacadeManager.snapshot();const t=await this.doApplyPrefab(e);return!!t&&(cce.SceneFacadeManager.snapshot(new ApplyPrefabCommand(t,this.undoApplyPrefab.bind(this),this.doApplyPrefab.bind(this))),cce.SceneFacadeManager.abortSnapshot(),!1)}async doApplyPrefab(e){const t=node_1.default.query(e);if(!t)return null;const r=t._prefab,n=null===r||void 0===r?void 0:r.instance;if(!n||!(null===r||void 0===r?void 0:r.asset))return null;const o=r.asset,s=o.data,a=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!a)return null;const i=this.applyMountedChildren(t);if(!i)return null;const f=component_1.componentOperation.applyMountedComponents(t);if(!f)return null;const c=n.propertyOverrides;this.applyPropertyOverrides(t);const l=n.removedComponents;this.applyRemovedComponents(t);const d=utils_1.prefabUtils.generatePrefabDataFromNode(t);return await Editor.Message.request("asset-db","create-asset",a.source,d,{overwrite:!0}),{nodeUUID:e,mountedChildrenInfoMap:i,mountedComponentsInfoMap:f,propertyOverrides:c,removedComponents:l,oldPrefabNodeData:s}}async undoApplyPrefab(e){const t=node_1.default.query(e.nodeUUID),r=t._prefab;if(!r)return;const n=r.instance;if(!n)return;const o=r.asset;if(!o)return;const s=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!s)return;o.data=e.oldPrefabNodeData;const a=cce.Utils.serialize(o);n.mountedChildren=[];const i=utils_1.prefabUtils.getTargetMap(t);e.mountedChildrenInfoMap.forEach((e,r)=>{const n=cc_1.Prefab._utils.getTarget(r,i);n&&(n._mountedRoot=t,n._prefab=e.prefabInfo,n.parent&&this.updateChildrenData(n.parent))}),e.mountedComponentsInfoMap.forEach((e,r)=>{const n=cc_1.Prefab._utils.getTarget(r,i);n&&(n._mountedRoot=t,n.__prefab=e.prefabInfo,n.node&&component_1.componentOperation.updateMountedComponents(n.node))}),n.propertyOverrides=e.propertyOverrides,n.removedComponents=e.removedComponents,await Editor.Message.request("asset-db","create-asset",s.source,a,{overwrite:!0})}updateChildrenData(e){if(!e)return;if(this.isRemovingMountedChildren)return;const t=e._prefab;if(!t)return;const r=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),n=r.outMostPrefabInstanceNode;if(!n)return;const o=r.targetPath,s=n._prefab,a=null===s||void 0===s?void 0:s.instance;if(!n||!s||!a)return;const i=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!i)return;o.splice(0,1),o.push(t.fileId);const f=utils_1.prefabUtils.getTargetMap(i),c=cc_1.Prefab._utils.getTarget(o,f).children.map(e=>{const t=e._prefab;if(t)return t.instance?t.instance.fileId:t.fileId}),l=[];for(let t=0;t<e.children.length;t++){const r=e.children[t],o=utils_1.prefabUtils.getPrefab(r),s=null===o||void 0===o?void 0:o.instance;if(o){const e=s?s.fileId:o.fileId;c.includes(e)||r._mountedRoot&&r._mountedRoot!==n||l.push(r)}else l.push(r)}if(utils_1.prefabUtils.fireBeforeChangeMsg(n),l.length>0){const e=utils_1.prefabUtils.getPrefabInstanceMountedChildren(a,o);e.nodes=l,e.nodes.forEach(e=>{e._mountedRoot=n})}else for(let e=0;e<a.mountedChildren.length;e++){const t=a.mountedChildren[e];if(t.isTarget(o)){t.nodes.forEach(e=>{e._mountedRoot=void 0}),a.mountedChildren.splice(e,1);break}}utils_1.prefabUtils.fireChangeMsg(n)}canBeMadeToPrefabAsset(e){let t=!1;return e.walk(e=>{e.getComponent(cc_1.Terrain)&&(t=!0)}),!t||(console.warn("can't create prefabAsset from a node that contains terrain"),!1)}async createPrefabAssetFromNode(e,t){const r=node_1.default.query(e),n=utils_1.prefabUtils.getPrefab(r);if(n&&n.root){const e=n.root;if(e._prefab.instance&&e!==r)return console.warn("can't create prefabAsset from a prefabNode inside a prefabInstance"),null}if(!this.canBeMadeToPrefabAsset(r))return null;const o=utils_1.prefabUtils.generatePrefabDataFromNode(r);if(!o)return null;n&&n.asset&&this.assetToNodesMap.delete(n.asset._uuid);const s=await Editor.Message.request("asset-db","create-asset",t,o,{overwrite:!0});return this.linkNodeWithPrefabAsset(r,null===s||void 0===s?void 0:s.uuid),null===s||void 0===s?void 0:s.uuid}async linkNodeWithPrefabAsset(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;let n=t;if("string"==typeof t&&(n=await util_1.promisify(cc_1.assetManager.loadAny)(t)),!n)return console.error(`asset ${t} doesn't exist`),!1;const o=n.data;if(!o||!o._prefab)return;utils_1.prefabUtils.fireBeforeChangeMsg(r);let s=r._prefab;if(s||(s=new PrefabInfo,r._prefab=s),!s.instance){const e=utils_1.prefabUtils.createPrefabInstance(),t=r._prefab;t&&(e.prefabRootNode=t.root),t.instance=e}s.fileId=o._prefab.fileId,s.root=r;const a=null===s||void 0===s?void 0:s.instance;return s&&a&&(this.createReservedPropertyOverrides(r),a.mountedChildren=[],this.removeModifiedPropertyOverrides(a,s.fileId)),s.asset=n,utils_1.prefabUtils.fireChangeMsg(r),this.syncPrefabInfo(o,r,r),this.checkToAddPrefabAssetMap(r),!0}syncPrefabInfo(e,t,r){if(!e||!t||!r)return;const n=e._prefab;if(!n)return;utils_1.prefabUtils.fireBeforeChangeMsg(t),t._prefab||(t._prefab=new PrefabInfo);const o=t._prefab;if(!o)return;if(o.instance&&t!==r)return o.asset=n.asset,o.instance.prefabRootNode=r,void utils_1.prefabUtils.fireChangeMsg(t);if(o.fileId=n.fileId,o.asset=n.asset,o.root=r,e.components.length!==t.components.length)return void console.error("Prefab Component doesn't match");for(let r=0;r<e.components.length;r++){const n=e.components[r],o=t.components[r];n&&n.__prefab&&o&&(o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab.fileId=n.__prefab.fileId)}utils_1.prefabUtils.fireChangeMsg(t);const s=[];if(t.children.forEach(e=>{e._objFlags&cc_1.CCObject.Flags.HideInHierarchy||s.push(e)}),e.children.length===s.length)for(let t=0;t<e.children.length;t++){const n=e.children[t],o=s[t];this.syncPrefabInfo(n,o,r)}else console.error("Prefab Node doesn't match")}createReservedPropertyOverrides(e){const t=e._prefab,r=null===t||void 0===t?void 0:t.instance;if(t&&r)for(let n=0;n<RootReservedProperty.length;n++){const o=[t.fileId],s=[RootReservedProperty[n]],a=e[RootReservedProperty[n]];utils_1.prefabUtils.getPropertyOverride(r,o,s).value=a}}revertPropertyOverrideOfTarget(e,t){if(!t||!t.propPath)return!1;const r=(t.propPath.replace(/^__comps__/,compKey)||"").split("."),n=utils_1.prefabUtils.getPropertyOverrideLocationInfo(e,r);if(!n)return!1;const o=n.outMostPrefabInstanceNode;if(!o)return!1;const s=o._prefab,a=null===s||void 0===s?void 0:s.instance;if(!a||!(null===s||void 0===s?void 0:s.asset))return!1;const i=utils_1.prefabUtils.getPrefabAssetNodeInstance(s);if(!i)return!1;const f={},c={};cc_1.Prefab._utils.generateTargetMap(i,f,!0),cc_1.Prefab._utils.generateTargetMap(e,c,!0),utils_1.prefabUtils.fireBeforeChangeMsg(e);for(let e=0;e<a.propertyOverrides.length;e++){const t=a.propertyOverrides[e];if(t.isTarget(n.targetPath,n.relativePathKeys)){this.revertPropertyOverride(t,c,f),a.propertyOverrides.splice(e,1);break}}return utils_1.prefabUtils.fireChangeMsg(e),!0}revertPropertyOverride(e,t,r){if(!e||!e.targetInfo)return!1;const n=e.targetInfo,o=cc_1.Prefab._utils.getTarget(n.localID,r),s=cc_1.Prefab._utils.getTarget(n.localID,t);if(!o||!s)return!1;let a=null;if(s instanceof cc_1.Node?a=s:s instanceof cc_1.Component&&(a=s.node),!a)return!1;let i=o,f=s,c=s,l="";const d=e.propertyPath.slice();if(d.length>0){const e=d.pop();if(!e)return!1;for(let e=0;e<d.length;e++){const t=d[e];l=t,i=i[t],c=f,f=f[t]}utils_1.prefabUtils.fireBeforeChangeMsg(a),f[e]=i[e],Array.isArray(f)&&c&&l&&(c[l]=f),utils_1.prefabUtils.fireChangeMsg(a)}else console.warn("property path is empty");return!0}async revertPrefab(e){var t;let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;const n=r._prefab,o=null===n||void 0===n?void 0:n.instance;if(!o||!(null===n||void 0===n?void 0:n.asset))return!1;const s=cc_1.instantiate(n.asset);if(!s)return!1;const a=r._prefab,i=s._prefab;if(!a||!i)return!1;const f={},c={};cc_1.Prefab._utils.generateTargetMap(s,f,!0),cc_1.Prefab._utils.generateTargetMap(r,c,!0),utils_1.prefabUtils.fireBeforeChangeMsg(r),cce.SceneFacadeManager.snapshot();const l=[];for(let e=0;e<o.propertyOverrides.length;e++){const t=o.propertyOverrides[e];this.isReservedPropertyOverrides(t,n.fileId)?l.push(t):this.revertPropertyOverride(t,c,f)}o.propertyOverrides=l,this.isRemovingMountedChildren=!0;for(let e=0;e<o.mountedChildren.length;e++){const t=o.mountedChildren[e];for(let e=0;e<t.nodes.length;e++)t.nodes[e].setParent(null)}o.mountedChildren=[],this.isRemovingMountedChildren=!1,component_1.componentOperation.isRemovingMountedComponents=!0;for(let e=0;e<o.mountedComponents.length;e++){const t=o.mountedComponents[e];for(let e=0;e<t.components.length;e++){const r=t.components[e];r&&r.node&&r.node.removeComponent(r)}}cc.Object._deferredDestroy(),o.mountedComponents=[],component_1.componentOperation.isRemovingMountedComponents=!1,component_1.componentOperation.isRevertingRemovedComponents=!0;for(let e=0;e<o.removedComponents.length;e++){const r=o.removedComponents[e],n=cc_1.Prefab._utils.getTarget(r.localID,f);if(!n)continue;const s=r.localID.slice();s.pop(),s.push(null===(t=n.node._prefab)||void 0===t?void 0:t.fileId);const a=cc_1.Prefab._utils.getTarget(s,c);await component_1.componentOperation.cloneComponentToNode(a,n)}return o.removedComponents=[],component_1.componentOperation.isRevertingRemovedComponents=!1,utils_1.prefabUtils.fireChangeMsg(r),await cce.SceneFacadeManager.softReloadScene(),!0}removePrefabInfoFromNode(e,t){e.children.forEach(e=>{var r;(null===(r=e._prefab)||void 0===r?void 0:r.instance)?t&&this.removePrefabInfoFromNode(e,t):this.removePrefabInfoFromNode(e,t)}),utils_1.prefabUtils.fireBeforeChangeMsg(e),e._prefab=null,utils_1.prefabUtils.fireChangeMsg(e)}removePrefabInstanceAndChangeRoot(e,t,r){e.children.forEach(e=>{var n;(null===(n=e._prefab)||void 0===n?void 0:n.instance)?r&&this.removePrefabInstanceAndChangeRoot(e,t,r):this.removePrefabInstanceAndChangeRoot(e,t,r)}),utils_1.prefabUtils.fireBeforeChangeMsg(e);const n=e._prefab,o=t._prefab;n&&o&&(n.root=t,n.asset=o.asset),(null===n||void 0===n?void 0:n.instance)&&(n.instance=void 0),utils_1.prefabUtils.fireChangeMsg(e)}unWrapPrefabInstance(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;n&&(!n.instance&&n.asset||(cce.SceneFacadeManager.snapshot(),this.removePrefabInfoFromNode(r,t)))}unWrapPrefabInstanceInPrefabMode(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;if(!n)return;let o=r;r.parent&&r.parent._prefab&&(o=r.parent._prefab.root),o&&(!n.instance&&n.asset||this.removePrefabInstanceAndChangeRoot(r,o,t))}}const nodeOperation=new NodeOperation;exports.nodeOperation=nodeOperation;