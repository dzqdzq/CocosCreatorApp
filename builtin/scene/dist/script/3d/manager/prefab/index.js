"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../node")),utils_1=require("./utils"),cc_1=require("cc"),component_1=require("./component"),node_2=require("./node");class PrefabManager{constructor(){this._softReloadTimer=null}init(){}onSceneOpened(e){node_2.nodeOperation.onSceneOpened(e)}onNodeRemoved(e,n){node_2.nodeOperation.onNodeRemoved(e,n)}onNodeChangedInGeneralMode(e,n,o){node_2.nodeOperation.onNodeChangedInGeneralMode(e,n,o)}onNodeAddedInGeneralMode(e){node_2.nodeOperation.onNodeAddedInGeneralMode(e)}onNodeAddInPrefabMode(e){node_2.nodeOperation.onNodeAddInPrefabMode(e)}removePrefabInfoFromNode(e,n){node_2.nodeOperation.removePrefabInfoFromNode(e,n)}checkToRemoveTargetOverride(e,n){utils_1.prefabUtils.checkToRemoveTargetOverride(e,n)}async createPrefabAssetFromNode(e,n){return node_2.nodeOperation.createPrefabAssetFromNode(e,n)}async linkNodeWithPrefabAsset(e,n){node_2.nodeOperation.linkNodeWithPrefabAsset(e,n)}generatePrefabDataFromNode(e){utils_1.prefabUtils.generatePrefabDataFromNode(e)}async revertPrefab(e){return node_2.nodeOperation.revertPrefab(e)}unWrapPrefabInstance(e,n){node_2.nodeOperation.unWrapPrefabInstance(e,n)}unWrapPrefabInstanceInPrefabMode(e,n){node_2.nodeOperation.unWrapPrefabInstanceInPrefabMode(e,n)}async applyPrefab(e){return node_2.nodeOperation.applyPrefab(e)}onComponentAddedInGeneralMode(e){component_1.componentOperation.onComponentAddedInGeneralMode(e)}onComponentAddedInPrefabMode(e){component_1.componentOperation.onComponentAddedInPrefabMode(e)}onComponentRemovedInGeneralMode(e,n){component_1.componentOperation.onComponentRemovedInGeneralMode(e,n)}async revertRemovedComponent(e,n){component_1.componentOperation.revertRemovedComponent(e,n)}async applyRemovedComponent(e,n){component_1.componentOperation.applyRemovedComponent(e,n)}async onAssetChanged(e,n,o){clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(()=>{node_2.nodeOperation.assetToNodesMap.has(e)&&cce.SceneFacadeManager.softReloadScene()},500)}async onAssetDeleted(e){node_2.nodeOperation.assetToNodesMap.has(e)&&await cce.SceneFacadeManager.softReloadScene()}revert(e){}sync(e){}createNodeFromPrefabAsset(e){const n=cc_1.instantiate(e),o=n._prefab;return o?(o.instance||(o.instance=utils_1.prefabUtils.createPrefabInstance()),n):(console.error("Not a Prefab Asset:",e.uuid),null)}filterChildOfAssetOfPrefabInstance(e,n){var o;Array.isArray(e)||(e=[e]);let r=[];for(const t of e){const e=node_1.default.query(t);e&&(utils_1.prefabUtils.isPrefabInstanceRoot(e)||!utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?r.push(t):(console.warn(`Node [${e.name}] is a prefab child of prefabInstance [${null===(o=e._prefab.root)||void 0===o?void 0:o.name}], ${n}`),Editor.Message.broadcast("scene:change-node",e.uuid)))}return r}filterPartOfPrefabAsset(e,n){var o;Array.isArray(e)||(e=[e]);let r=[];for(const t of e){const e=node_1.default.query(t);e&&(utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?(console.warn(`Node [${e.name}] is part of prefabInstance [${null===(o=e._prefab.root)||void 0===o?void 0:o.name}], ${n}`),Editor.Message.broadcast("scene:change-node",e.uuid)):r.push(t))}return r}filterChildOfPrefabAssetWhenRemoveNode(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to delete in current context, you can delete it in it's prefabAsset or         do it after unlink prefab from root node")}filterChildOfPrefabAssetWhenSetParent(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to change parent in current context, you can modify it in it's prefabAsset or         do it after unlink prefab from root node")}canModifySibling(e,n,o){var r,t,a;if(0===o)return!1;const d=node_1.default.query(e);if(!d)return!1;if(d._prefab&&utils_1.prefabUtils.isPartOfPrefabAsset(d)&&(null===(r=d._prefab.root)||void 0===r?void 0:r._prefab.instance)&&d.children){const e=d.children.filter(e=>!(e._objFlags&cc.Object.Flags.HideInHierarchy)),r=d.children[n];if(!r)return!1;let s=!0;if(r._prefab){if(!(s=utils_1.prefabUtils.getPrefabStateInfo(r).isAddedChild))return console.warn(`Node [${r.name}] is a prefab child of prefabInstance [${null===(t=r._prefab.root)||void 0===t?void 0:t.name}],                     it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),Editor.Message.broadcast("scene:change-node",r.uuid),!1}const i=e[n+o];if(s&&i._prefab)return console.warn(`Node [${i.name}] is a prefab child of prefabInstance [${null===(a=i._prefab.root)||void 0===a?void 0:a.name}],                 it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),Editor.Message.broadcast("scene:change-node",r.uuid),!1}return!0}filterPartOfPrefabAssetWhenCreateComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to add component in current context currently, you can add component in it's prefabAsset or         do it after unlink prefab from root node")}filterPartOfPrefabAssetWhenRemoveComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to remove component in current context currently, you can remove component in it's prefabAsset or         do it after unlink prefab from root node")}}exports.default=new PrefabManager;