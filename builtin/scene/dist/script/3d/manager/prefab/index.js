"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../node")),utils_1=require("./utils"),cc_1=require("cc"),event_enum_1=require("../../../../script/public/event-enum"),util_1=require("util"),node_2=__importDefault(require("../node")),node_3=__importDefault(require("../../../utils/node")),compKey="_components",PrefabInfo=cc_1.Prefab._utils.PrefabInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,RootKeptProperty=["name","position","rotation"];function getPrefab(e){return e._prefab}class PrefabManager{constructor(){this.assetToNodesMap=new Map}init(){}onSceneOpened(e){this.assetToNodesMap.clear(),node_2.default.queryUuids().forEach(e=>{const t=node_2.default.query(e);t instanceof cc_1.Scene||node_3.default.isEditorNode(t)||this.checkToAddPrefabAssetMap(t)})}checkToAddPrefabAssetMap(e){const t=e._prefab;if((null===t||void 0===t?void 0:t.instance)&&(null===t||void 0===t?void 0:t.asset)){let r=this.assetToNodesMap.get(t.asset._uuid);r||(r=[],this.assetToNodesMap.set(t.asset._uuid,r)),r.includes(e)||r.push(e)}}onNodeRemoved(e,t){const r=e._prefab;if((null===r||void 0===r?void 0:r.instance)&&(null===r||void 0===r?void 0:r.asset)){const t=this.assetToNodesMap.get(r.asset._uuid);if(t){const r=t.indexOf(e);r>=0&&t.splice(r,1)}}}checkToRemoveTargetOverride(e,t){t&&utils_1.prefabUtils.removeTargetOverrideBySource(t._prefab,e)&&(node_1.default.emit("change",t),Editor.Message.broadcast("scene:change-node",t.uuid))}onComponentAddedInGeneralMode(e){e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}onComponentAddedInPrefabMode(e){e.node&&e.node._prefab&&(e.__prefab||(e.__prefab=new CompPrefabInfo,e.__prefab.fileId=e.uuid))}getPropertyOverrideLocationInfo(e,t){var r;const n=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),o=n.outMostPrefabInstanceNode;if(!o)return null;const a=n.targetPath;if(null===(r=o._prefab)||void 0===r?void 0:r.instance){a.splice(0,1);let r=[];if(t.length<=0)return null;if(t[0]===compKey){if(2===t.length)return null;if(1===t.length)return null;const n=e[t[0]][t[1]];n.__prefab?(a.push(n.__prefab.fileId),r=t.slice(2)):console.error(`component: ${n.name} doesn't have a prefabInfo`)}else{const n=e._prefab;n?(a.push(n.fileId),r=t):console.error(`node: ${e.name} doesn't have a prefabInfo`)}return{outMostPrefabInstanceNode:o,targetPath:a,relativePathKeys:r}}return null}checkToAddTargetOverride(e,t,r){var n;if(!r)return!1;if(t&&t.propPath){const o=(t.propPath.replace(/^__comps__/,compKey)||"").split(".");let a=e;for(let e=0;e<o.length;e++)a=a[o[e]];let s=[],i=null;if(o[0]===compKey){if(2===o.length)return!1;if(1===o.length)return!1;if(!(i=e[o[0]][o[1]]))return!1;s=o.slice(2)}if((null===a||void 0===a)&&i)return utils_1.prefabUtils.removeTargetOverride(r._prefab,i,s),!1;let d=null;if(a instanceof cc_1.Node?d=a:a instanceof cc_1.Component&&(d=a.node),!d)return!1;if(!getPrefab(d))return!1;const f=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(d),c=f.outMostPrefabInstanceNode;if(!c)return!1;if(a instanceof cc_1.Node&&c===a)return!1;const l=f.targetPath;if((null===(n=c._prefab)||void 0===n?void 0:n.instance)&&(l.splice(0,1),i)){if(a instanceof cc_1.Node){const e=a._prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab node: ${a.name}`),!1;l.push(e.fileId)}else if(a instanceof cc_1.Component){const e=a.__prefab;if(!e||!e.fileId)return console.error(`can't get fileId of prefab component: ${a.name} in node: ${a.node.name}`),!1;l.push(e.fileId)}if(!r)return!1;r._prefab||(r._prefab=new PrefabInfo);const e=r._prefab,t=utils_1.prefabUtils.getTargetOverride(e,i,s);if(t){node_1.default.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",r.uuid),t.target=c;const e=new TargetInfo;return e.localID=l,t.targetInfo=e,node_1.default.emit("change",r),Editor.Message.broadcast("scene:change-node",r.uuid),!0}}}return!1}getPropByPath(e,t){let r=e;for(let e=0;e<t.length;e++)r=r[t[e]];return r}checkToRenamePath(e,t){let r=t.indexOf("sharedMaterials");if(r>0){let n=this.getPropByPath(e,t.slice(0,r));n&&n instanceof cc_1.RenderableComponent&&(t[r]="_materials")}}onNodeChangedInGeneralMode(e,t,r){var n,o;if(t&&t.type===event_enum_1.NodeEventType.CHILD_CHANGED)return void this.updateChildrenData(e);if(t&&"children"===t.propPath&&t.type===event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT)return;if(this.checkToAddTargetOverride(e,t,r))return;if(getPrefab(e)&&t&&t.propPath){const r=(t.propPath.replace(/^__comps__/,compKey)||"").split(".");this.checkToRenamePath(e,r);const a=this.getPropertyOverrideLocationInfo(e,r);if(!a)return;const s=a.targetPath;let i=this.getPropByPath(e,r);const d=null===(o=null===(n=a.outMostPrefabInstanceNode)||void 0===n?void 0:n._prefab)||void 0===o?void 0:o.instance;if(!d)return;if(node_1.default.emit("before-change",a.outMostPrefabInstanceNode),Editor.Message.broadcast("scene:before-change-node",a.outMostPrefabInstanceNode.uuid),Array.isArray(i)){utils_1.prefabUtils.removePropertyOverride(d,s,a.relativePathKeys),utils_1.prefabUtils.getPropertyOverride(d,s,a.relativePathKeys.concat("length")).value=i.length,this.addOverrideForArrayProp(d,e,i,r)}else{if(utils_1.prefabUtils.getPropertyOverride(d,s,a.relativePathKeys).value=i,r.length>1&&"length"===r[r.length-1]){let t=r.slice(0,r.length-1),n=this.getPropByPath(e,t);Array.isArray(n)&&this.addOverrideForArrayProp(d,e,n,t)}}node_1.default.emit("change",a.outMostPrefabInstanceNode),Editor.Message.broadcast("scene:change-node",a.outMostPrefabInstanceNode.uuid)}}addOverrideForArrayProp(e,t,r,n){if(!Array.isArray(r))return;const o=this.getPropertyOverrideLocationInfo(t,n);o&&utils_1.prefabUtils.removePropertyOverride(e,o.targetPath,o.relativePathKeys);for(let o=0;o<r.length;o++){let a=n.concat(o+"");const s=r[o],i=this.getPropertyOverrideLocationInfo(t,a);i&&(utils_1.prefabUtils.getPropertyOverride(e,i.targetPath,i.relativePathKeys).value=s)}}onNodeAddedInGeneralMode(e){const t=e.parent;t&&(this.updateChildrenData(t),this.checkToAddPrefabAssetMap(e))}updateChildrenData(e){var t,r;if(!e)return;const n=e._prefab;if(!n)return;const o=utils_1.prefabUtils.getOutMostPrefabInstanceInfo(e),a=o.outMostPrefabInstanceNode,s=o.targetPath,i=null===(t=null===a||void 0===a?void 0:a._prefab)||void 0===t?void 0:t.instance;if(!a||!i)return;const d=[];for(let t=0;t<e.children.length;t++){const n=e.children[t],o=getPrefab(n),a=null===(r=n._prefab)||void 0===r?void 0:r.instance;(!o||a&&!a.prefabRootNode)&&d.push(n)}if(s.splice(0,1),s.push(n.fileId),node_1.default.emit("before-change",a),Editor.Message.broadcast("scene:before-change-node",a.uuid),d.length>0){utils_1.prefabUtils.getPrefabInstanceMountedChildren(i,s).nodes=d}else for(let e=0;e<i.mountedChildren.length;e++){if(i.mountedChildren[e].isTarget(s)){i.mountedChildren.splice(e,1);break}}node_1.default.emit("change",a),Editor.Message.broadcast("scene:change-node",a.uuid)}onNodeAddInPrefabMode(e){const t=e.parent;if(!t)return;const r=getPrefab(t);if(!r)return;const n=getPrefab(e);n&&r.root===n.root||utils_1.prefabUtils.addPrefabInfoToNode(e,r.root,r.asset),this.checkToAddPrefabAssetMap(e)}async onAssetChanged(e,t,r){this.assetToNodesMap.has(e)&&await cce.SceneFacadeManager.softReloadScene()}async onAssetDeleted(e){this.assetToNodesMap.has(e)&&await cce.SceneFacadeManager.softReloadScene()}revert(e){}sync(e){}async createPrefabAssetFromNode(e,t){const r=node_1.default.query(e),n=getPrefab(r);if(n&&n.root){const e=n.root;if(e._prefab.instance&&e!==r)return console.warn("can't create prefabAsset from a prefabNode inside a prefabInstance"),null}const o=this.generatePrefabDataFromNode(r);if(!o)return null;n&&n.asset&&this.assetToNodesMap.delete(n.asset._uuid);const a=await Editor.Message.request("asset-db","create-asset",t,o,{overwrite:!0});return this.linkNodeWithPrefabAsset(r,null===a||void 0===a?void 0:a.uuid),null===a||void 0===a?void 0:a.uuid}generatePrefabDataFromNode(e){let t=null;if(!(t="string"==typeof e?node_1.default.query(e):e))return null;const r=new cc_1.Prefab,n=utils_1.prefabUtils.generatePrefabDumpableNode(t,r);return n._prefab.instance=void 0,r.data=n,cce.Utils.serialize(r)}async linkNodeWithPrefabAsset(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return!1;let n=t;if("string"==typeof t&&(n=await util_1.promisify(cc_1.assetManager.loadAny)(t)),!n)return console.error(`asset ${t} doesn't exist`),!1;const o=n.data;if(!o||!o._prefab)return;node_1.default.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",r.uuid);let a=r._prefab;if(a||(a=new PrefabInfo,r._prefab=a),!a.instance){const e=utils_1.prefabUtils.createPrefabInstance(),t=r._prefab;t&&(e.prefabRootNode=t.root),t.instance=e}a.fileId=o._prefab.fileId,a.root=r;const s=null===a||void 0===a?void 0:a.instance;return a&&s&&(this.createKeptPropertyOverrides(r),s.mountedChildren=[],this.removeModifiedPropertyOverrides(s,a.fileId)),a.asset=n,node_1.default.emit("change",r),Editor.Message.broadcast("scene:change-node",r.uuid),this.syncPrefabInfo(o,r,r),this.checkToAddPrefabAssetMap(r),!0}syncPrefabInfo(e,t,r){if(!e||!t||!r)return;const n=e._prefab;if(!n)return;node_1.default.emit("before-change",t),Editor.Message.broadcast("scene:before-change-node",t.uuid),t._prefab||(t._prefab=new PrefabInfo);const o=t._prefab;if(o){if(o.instance&&t!==r)return o.asset=n.asset,o.instance.prefabRootNode=r,node_1.default.emit("change",t),void Editor.Message.broadcast("scene:change-node",t.uuid);if(o.fileId=n.fileId,o.asset=n.asset,o.root=r,e.components.length===t.components.length){for(let r=0;r<e.components.length;r++){const n=e.components[r],o=t.components[r];n&&n.__prefab&&o&&(o.__prefab||(o.__prefab=new CompPrefabInfo),o.__prefab.fileId=n.__prefab.fileId)}if(node_1.default.emit("change",t),Editor.Message.broadcast("scene:change-node",t.uuid),e.children.length===t.children.length)for(let n=0;n<e.children.length;n++){const o=e.children[n],a=t.children[n];this.syncPrefabInfo(o,a,r)}else console.error("Prefab Node doesn't match")}else console.error("Prefab Component doesn't match")}}createNodeFromPrefabAsset(e){const t=cc_1.instantiate(e),r=t._prefab;return r?(r.instance||(r.instance=utils_1.prefabUtils.createPrefabInstance()),this.createKeptPropertyOverrides(t),t):(console.error("Not a Prefab Asset:",e.uuid),null)}removePrefabInfoFromNode(e,t){e.children.forEach(e=>{var r;(null===(r=e._prefab)||void 0===r?void 0:r.instance)?t&&this.removePrefabInfoFromNode(e,t):this.removePrefabInfoFromNode(e,t)}),node_1.default.emit("before-change",e),Editor.Message.broadcast("scene:before-change-node",e.uuid),e._prefab=null,node_1.default.emit("change",e),Editor.Message.broadcast("scene:change-node",e.uuid)}removePrefabInstanceAndChangeRoot(e,t,r){e.children.forEach(e=>{var n;(null===(n=e._prefab)||void 0===n?void 0:n.instance)?r&&this.removePrefabInstanceAndChangeRoot(e,t,r):this.removePrefabInstanceAndChangeRoot(e,t,r)}),node_1.default.emit("before-change",e),Editor.Message.broadcast("scene:before-change-node",e.uuid);const n=e._prefab,o=t._prefab;n&&o&&(n.root=t,n.asset=o.asset),(null===n||void 0===n?void 0:n.instance)&&(n.instance=void 0),node_1.default.emit("change",e),Editor.Message.broadcast("scene:change-node",e.uuid)}unWrapPrefabInstance(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;n&&(!n.instance&&n.asset||(cce.SceneFacadeManager.snapshot(),this.removePrefabInfoFromNode(r,t)))}unWrapPrefabInstanceInPrefabMode(e,t){let r=null;if(!(r="string"==typeof e?node_1.default.query(e):e))return;const n=r._prefab;if(!n)return;let o=r;r.parent&&r.parent._prefab&&(o=r.parent._prefab.root),o&&(!n.instance&&n.asset||this.removePrefabInstanceAndChangeRoot(r,o,t))}revertPropertyOverrideOfTarget(e,t){if(!t||!t.propPath)return!1;const r=(t.propPath.replace(/^__comps__/,compKey)||"").split("."),n=this.getPropertyOverrideLocationInfo(e,r);if(!n)return!1;const o=n.outMostPrefabInstanceNode;if(!o)return!1;const a=o._prefab,s=null===a||void 0===a?void 0:a.instance;if(!s||!(null===a||void 0===a?void 0:a.asset))return!1;const i=a.asset.data;if(!i)return!1;const d={},f={};cc_1.Prefab._utils.generateTargetMap(i,d,!0),cc_1.Prefab._utils.generateTargetMap(e,f,!0),node_1.default.emit("before-change",e),Editor.Message.broadcast("scene:before-change-node",e.uuid);for(let e=0;e<s.propertyOverrides.length;e++){const t=s.propertyOverrides[e];if(t.isTarget(n.targetPath,n.relativePathKeys)){this.revertPropertyOverride(t,f,d),s.propertyOverrides.splice(e,1);break}}return node_1.default.emit("change",e),Editor.Message.broadcast("scene:change-node",e.uuid),!0}revertPropertyOverride(e,t,r){if(!e||!e.targetInfo)return!1;const n=e.targetInfo,o=cc_1.Prefab._utils.getTarget(n.localID,r),a=cc_1.Prefab._utils.getTarget(n.localID,t);if(!o||!a)return!1;let s=null;if(a instanceof cc_1.Node?s=a:a instanceof cc_1.Component&&(s=a.node),!s)return!1;let i=o,d=a,f=a,c="";const l=e.propertyPath.slice();if(l.length>0){const e=l.pop();if(!e)return!1;for(let e=0;e<l.length;e++){const t=l[e];c=t,i=i[t],f=d,d=d[t]}node_1.default.emit("before-change",s),Editor.Message.broadcast("scene:before-change-node",s.uuid),d[e]=i[e],Array.isArray(d)&&f&&c&&(f[c]=d),node_1.default.emit("change",s),Editor.Message.broadcast("scene:change-node",s.uuid)}else console.warn("property path is empty");return!0}revertPrefab(e){let t=null;if(!(t="string"==typeof e?node_1.default.query(e):e))return!1;const r=t._prefab,n=null===r||void 0===r?void 0:r.instance;if(!n||!(null===r||void 0===r?void 0:r.asset))return!1;const o=cc_1.instantiate(r.asset);if(!o)return!1;const a=t._prefab,s=o._prefab;if(!a||!s)return!1;const i={},d={};cc_1.Prefab._utils.generateTargetMap(o,i,!0),cc_1.Prefab._utils.generateTargetMap(t,d,!0),node_1.default.emit("before-change",t),Editor.Message.broadcast("scene:before-change-node",t.uuid);const f=[];for(let e=0;e<n.propertyOverrides.length;e++){const t=n.propertyOverrides[e];this.isKeptPropertyOverrides(t,r.fileId)?f.push(t):this.revertPropertyOverride(t,d,i)}n.propertyOverrides=f;for(let e=0;e<n.mountedChildren.length;e++){const t=n.mountedChildren[e];for(let e=0;e<t.nodes.length;e++)t.nodes[e].setParent(null)}return node_1.default.emit("change",t),Editor.Message.broadcast("scene:change-node",t.uuid),!0}isKeptPropertyOverrides(e,t){const r=e.targetInfo;if(1===(null===r||void 0===r?void 0:r.localID.length)&&r.localID[0]===t){const t=e.propertyPath;if(1===t.length&&RootKeptProperty.includes(t[0]))return!0}return!1}removeModifiedPropertyOverrides(e,t){const r=[];for(let n=0;n<e.propertyOverrides.length;n++){const o=e.propertyOverrides[n];this.isKeptPropertyOverrides(o,t)&&r.push(o)}e.propertyOverrides=r}createKeptPropertyOverrides(e){const t=e._prefab,r=null===t||void 0===t?void 0:t.instance;if(t&&r)for(let n=0;n<RootKeptProperty.length;n++){const o=[t.fileId],a=[RootKeptProperty[n]],s=e[RootKeptProperty[n]];utils_1.prefabUtils.getPropertyOverride(r,o,a).value=s}}async applyPrefab(e){const t=node_1.default.query(e);if(!t)return!1;const r=t._prefab,n=null===r||void 0===r?void 0:r.instance;if(!n||!(null===r||void 0===r?void 0:r.asset))return!1;const o=r.asset,a=await Editor.Message.request("asset-db","query-asset-info",o._uuid);if(!a)return!1;const s=this.generatePrefabDataFromNode(t);return n.mountedChildren=[],this.removeModifiedPropertyOverrides(n,r.fileId),await Editor.Message.request("asset-db","create-asset",a.source,s,{overwrite:!0}),!0}filterChildOfAssetOfPrefabInstance(e,t){var r;Array.isArray(e)||(e=[e]);let n=[];for(const o of e){const e=node_1.default.query(o);e&&(utils_1.prefabUtils.isPrefabInstanceRoot(e)||!utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?n.push(o):(console.warn(`Node [${e.name}] is a prefab child of prefabInstance [${null===(r=e._prefab.root)||void 0===r?void 0:r.name}], ${t}`),Editor.Message.broadcast("scene:change-node",e.uuid)))}return n}filterPartOfPrefabAsset(e,t){var r;Array.isArray(e)||(e=[e]);let n=[];for(const o of e){const e=node_1.default.query(o);e&&(utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?(console.warn(`Node [${e.name}] is part of prefabInstance [${null===(r=e._prefab.root)||void 0===r?void 0:r.name}], ${t}`),Editor.Message.broadcast("scene:change-node",e.uuid)):n.push(o))}return n}filterChildOfPrefabAssetWhenRemoveNode(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to delete in current context, you can delete it in it's prefabAsset or         do it after unlink prefab from root node")}filterChildOfPrefabAssetWhenSetParent(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to change parent in current context, you can modify it in it's prefabAsset or         do it after unlink prefab from root node")}canModifySibling(e,t,r){var n,o,a;const s=node_1.default.query(e);if(!s)return!1;if(s._prefab&&utils_1.prefabUtils.isPartOfPrefabAsset(s)&&(null===(n=s._prefab.root)||void 0===n?void 0:n._prefab.instance)&&s.children){const e=s.children.filter(e=>!(e._objFlags&cc.Object.Flags.HideInHierarchy)),n=s.children[t];if(!n)return!1;let i=!0;if(n._prefab){if(!(i=utils_1.prefabUtils.getPrefabStateInfo(n).isAddedChild))return console.warn(`Node [${n.name}] is a prefab child of prefabInstance [${null===(o=n._prefab.root)||void 0===o?void 0:o.name}],                     it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),Editor.Message.broadcast("scene:change-node",n.uuid),!1}const d=e[t+r];if(i&&d._prefab)return console.warn(`Node [${d.name}] is a prefab child of prefabInstance [${null===(a=d._prefab.root)||void 0===a?void 0:a.name}],                 it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),Editor.Message.broadcast("scene:change-node",n.uuid),!1}return!0}filterPartOfPrefabAssetWhenCreateComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to add component in current context currently, you can add component in it's prefabAsset or         do it after unlink prefab from root node")}filterPartOfPrefabAssetWhenRemoveComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to remove component in current context currently, you can remove component in it's prefabAsset or         do it after unlink prefab from root node")}}exports.default=new PrefabManager;