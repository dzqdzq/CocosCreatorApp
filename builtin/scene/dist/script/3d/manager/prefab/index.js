"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../node")),utils_1=require("./utils"),cc_1=require("cc"),component_1=require("./component"),node_2=require("./node"),message_1=require("../message");class PrefabManager{constructor(){this._softReloadTimer=null}init(){}onSceneOpened(e){node_2.nodeOperation.onSceneOpened(e)}onNodeRemoved(e){node_2.nodeOperation.onNodeRemoved(e)}onNodeChangedInGeneralMode(e,n,o){node_2.nodeOperation.onNodeChangedInGeneralMode(e,n,o)}onAddNode(e){node_2.nodeOperation.onAddNode(e)}onNodeAdded(e,n){node_2.nodeOperation.onNodeAdded(e,n)}removePrefabInfoFromNode(e,n){node_2.nodeOperation.removePrefabInfoFromNode(e,n)}checkToRemoveTargetOverride(e,n){utils_1.prefabUtils.checkToRemoveTargetOverride(e,n)}async createPrefabAssetFromNode(e,n){return node_2.nodeOperation.createPrefabAssetFromNode(e,n)}async linkNodeWithPrefabAsset(e,n){node_2.nodeOperation.linkNodeWithPrefabAsset(e,n)}generatePrefabDataFromNode(e){utils_1.prefabUtils.generatePrefabDataFromNode(e)}async revertPrefab(e){return node_2.nodeOperation.revertPrefab(e)}unWrapPrefabInstance(e,n){node_2.nodeOperation.unWrapPrefabInstance(e,n)}unWrapPrefabInstanceInPrefabMode(e,n){node_2.nodeOperation.unWrapPrefabInstanceInPrefabMode(e,n)}async applyPrefab(e){return node_2.nodeOperation.applyPrefab(e)}onAddComponent(e){component_1.componentOperation.onAddComponent(e)}onComponentAdded(e,n){component_1.componentOperation.onComponentAdded(e,n)}onRemoveComponentInGeneralMode(e,n){component_1.componentOperation.onRemoveComponentInGeneralMode(e,n)}onComponentRemovedInGeneralMode(e,n){component_1.componentOperation.onComponentRemovedInGeneralMode(e,n)}async revertRemovedComponent(e,n){component_1.componentOperation.revertRemovedComponent(e,n)}async applyRemovedComponent(e,n){component_1.componentOperation.applyRemovedComponent(e,n)}async onAssetChanged(e,n,o){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}async onAssetDeleted(e){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}revert(e){}sync(e){}createNodeFromPrefabAsset(e){const n=cc_1.instantiate(e),o=n._prefab;return o?(o.instance||(o.instance=utils_1.prefabUtils.createPrefabInstance()),n):(console.error("Not a Prefab Asset:",e.uuid),null)}filterChildOfAssetOfPrefabInstance(e,n){var o;Array.isArray(e)||(e=[e]);const t=[];for(const r of e){const e=node_1.default.query(r);e&&(utils_1.prefabUtils.isOutmostPrefabInstanceMountedChildren(e)?t.push(r):utils_1.prefabUtils.isPrefabInstanceRoot(e)||!utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?t.push(r):(console.warn(`Node [${e.name}] is a prefab child of prefabInstance [${null===(o=e._prefab.root)||void 0===o?void 0:o.name}], ${n}`),message_1.messageManager.broadcast("scene:change-node",e.uuid)))}return t}filterPartOfPrefabAsset(e,n){var o;Array.isArray(e)||(e=[e]);const t=[];for(const r of e){const e=node_1.default.query(r);e&&(utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?(console.warn(`Node [${e.name}] is part of prefabInstance [${null===(o=e._prefab.root)||void 0===o?void 0:o.name}], ${n}`),message_1.messageManager.broadcast("scene:change-node",e.uuid)):t.push(r))}return t}filterChildOfPrefabAssetWhenRemoveNode(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to delete in current context, you can delete it in it's prefabAsset or         do it after unlink prefab from root node")}filterChildOfPrefabAssetWhenSetParent(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to change parent in current context, you can modify it in it's prefabAsset or         do it after unlink prefab from root node")}canModifySibling(e,n,o){var t,r,a;if(0===o)return!1;const s=node_1.default.query(e);if(!s)return!1;if(s._prefab&&utils_1.prefabUtils.isPartOfPrefabAsset(s)&&(null===(t=s._prefab.root)||void 0===t?void 0:t._prefab.instance)&&s.children){const e=s.children.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),t=s.children[n];if(!t)return!1;let i=!0;if(t._prefab){if(!(i=utils_1.prefabUtils.getPrefabStateInfo(t).isAddedChild))return console.warn(`Node [${t.name}] is a prefab child of prefabInstance [${null===(r=t._prefab.root)||void 0===r?void 0:r.name}],                     it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",t.uuid),!1}const d=e[n+o];if(i&&d._prefab)return console.warn(`Node [${d.name}] is a prefab child of prefabInstance [${null===(a=d._prefab.root)||void 0===a?void 0:a.name}],                 it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",t.uuid),!1}return!0}filterPartOfPrefabAssetWhenCreateComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to add component in current context currently, you can add component in it's prefabAsset or         do it after unlink prefab from root node")}filterPartOfPrefabAssetWhenRemoveComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to remove component in current context currently, you can remove component in it's prefabAsset or         do it after unlink prefab from root node")}}exports.default=new PrefabManager;