"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabManager=void 0;const node_1=__importDefault(require("../node")),utils_1=require("./utils"),cc_1=require("cc"),component_1=require("./component"),node_2=require("./node"),message_1=require("../message");class PrefabManager{constructor(){this._softReloadTimer=null,this._utils=utils_1.prefabUtils}init(){}onSceneOpened(e){node_2.nodeOperation.onSceneOpened(e)}onNodeRemoved(e){node_2.nodeOperation.onNodeRemoved(e)}onNodeChangedInGeneralMode(e,n,o){node_2.nodeOperation.onNodeChangedInGeneralMode(e,n,o)}onAddNode(e){node_2.nodeOperation.onAddNode(e)}onNodeAdded(e,n){node_2.nodeOperation.onNodeAdded(e,n)}removePrefabInfoFromNode(e,n){node_2.nodeOperation.removePrefabInfoFromNode(e,n)}checkToRemoveTargetOverride(e,n){utils_1.prefabUtils.checkToRemoveTargetOverride(e,n)}async createPrefabAssetFromNode(e,n){return await node_2.nodeOperation.createPrefabAssetFromNode(e,n)}async linkNodeWithPrefabAsset(e,n){node_2.nodeOperation.linkNodeWithPrefabAsset(e,n)}generatePrefabDataFromNode(e){return utils_1.prefabUtils.generatePrefabDataFromNode(e)}async revertPrefab(e){return node_2.nodeOperation.revertPrefab(e)}getUnlinkNodeUuids(e,n){const o=[],t=node_1.default.query(e);return t&&(o.push(e),t.children.forEach(e=>{!function e(t){const r=utils_1.prefabUtils.getPrefab(t);n?(o.push(t.uuid),t.children.forEach(n=>{e(n)})):r&&(r.instance||(o.push(t.uuid),t.children.forEach(n=>{e(n)})))}(e)})),o}unWrapPrefabInstance(e,n){return node_2.nodeOperation.unWrapPrefabInstance(e,n)}unWrapPrefabInstanceInPrefabMode(e,n){return node_2.nodeOperation.unWrapPrefabInstanceInPrefabMode(e,n)}async applyPrefab(e){return await node_2.nodeOperation.applyPrefab(e)}onAddComponent(e){component_1.componentOperation.onAddComponent(e)}onComponentAdded(e,n){component_1.componentOperation.onComponentAdded(e,n)}onRemoveComponentInGeneralMode(e,n){component_1.componentOperation.onRemoveComponentInGeneralMode(e,n)}onComponentRemovedInGeneralMode(e,n){component_1.componentOperation.onComponentRemovedInGeneralMode(e,n)}async revertRemovedComponent(e,n){component_1.componentOperation.revertRemovedComponent(e,n)}async applyRemovedComponent(e,n){component_1.componentOperation.applyRemovedComponent(e,n)}async onAssetChanged(e,n,o){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}async onAssetDeleted(e){node_2.nodeOperation.assetToNodesMap.has(e)&&(clearTimeout(this._softReloadTimer),this._softReloadTimer=setTimeout(async()=>{await cce.SceneFacadeManager.softReloadScene()},500))}revert(e){}sync(e){}createNodeFromPrefabAsset(e){const n=(0,cc_1.instantiate)(e),o=n._prefab;return o?(o.instance||(o.instance=utils_1.prefabUtils.createPrefabInstance()),n):(console.error("Not a Prefab Asset:",e.uuid),null)}filterChildOfAssetOfPrefabInstance(e,n){var o,t;Array.isArray(e)||(e=[e]);const r=[];for(const a of e){const e=node_1.default.query(a);e&&(utils_1.prefabUtils.isOutmostPrefabInstanceMountedChildren(e)?r.push(a):utils_1.prefabUtils.isPrefabInstanceRoot(e)||!utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?r.push(a):(console.warn(`Node [${e.name}] is a prefab child of prefabInstance [${null===(t=null===(o=e._prefab)||void 0===o?void 0:o.root)||void 0===t?void 0:t.name}], ${n}`),message_1.messageManager.broadcast("scene:change-node",e.uuid)))}return r}filterPartOfPrefabAsset(e,n){var o,t;Array.isArray(e)||(e=[e]);const r=[];for(const a of e){const e=node_1.default.query(a);e&&(utils_1.prefabUtils.isPartOfAssetInPrefabInstance(e)?(console.warn(`Node [${e.name}] is part of prefabInstance [${null===(t=null===(o=e._prefab)||void 0===o?void 0:o.root)||void 0===t?void 0:t.name}], ${n}`),message_1.messageManager.broadcast("scene:change-node",e.uuid)):r.push(a))}return r}filterChildOfPrefabAssetWhenRemoveNode(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to delete in current context, you can delete it in it's prefabAsset or         do it after unlink prefab from root node")}filterChildOfPrefabAssetWhenSetParent(e){return this.filterChildOfAssetOfPrefabInstance(e,"it's not allowed to change parent in current context, you can modify it in it's prefabAsset or         do it after unlink prefab from root node")}canModifySibling(e,n,o){var t,r,a,s,i;if(0===o)return!1;const d=node_1.default.query(e);if(!d)return!1;if(d._prefab&&utils_1.prefabUtils.isPartOfPrefabAsset(d)&&(null===(a=null===(r=null===(t=d._prefab)||void 0===t?void 0:t.root)||void 0===r?void 0:r._prefab)||void 0===a?void 0:a.instance)&&d.children){const e=d.children.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),t=d.children[n];if(!t)return!1;let r=!0;if(t._prefab){if(!(r=utils_1.prefabUtils.getPrefabStateInfo(t).isAddedChild))return console.warn(`Node [${t.name}] is a prefab child of prefabInstance [${null===(s=t._prefab.root)||void 0===s?void 0:s.name}],                     it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",t.uuid),!1}const a=e[n+o];if(r&&a._prefab)return console.warn(`Node [${a.name}] is a prefab child of prefabInstance [${null===(i=a._prefab.root)||void 0===i?void 0:i.name}],                 it's not allowed to modify hierarchy in current context, you can modify it in it's prefabAsset or do it after unlink prefab from root node`),message_1.messageManager.broadcast("scene:change-node",t.uuid),!1}return!0}filterPartOfPrefabAssetWhenCreateComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to add component in current context currently, you can add component in it's prefabAsset or         do it after unlink prefab from root node")}filterPartOfPrefabAssetWhenRemoveComponent(e){return this.filterPartOfPrefabAsset(e,"it's not allow to remove component in current context currently, you can remove component in it's prefabAsset or         do it after unlink prefab from root node")}findPathWithRule(e,n){const o=[],t=new Map,r=function(e,a){Object.keys(e).forEach(s=>{"object"==typeof e[s]&&e[s]&&(t.get(e[s])||(t.set(e[s],!0),n(e[s])?(console.log("找到了",a+"|"+s),o.push(a+"|"+s)):r(e[s],a+"|"+s)))})};return r(e,""),o}}exports.PrefabManager=PrefabManager,exports.default=new PrefabManager;