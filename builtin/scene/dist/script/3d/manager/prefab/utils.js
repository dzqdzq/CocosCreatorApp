"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabState=exports.prefabUtils=void 0;const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),node_1=__importDefault(require("../node")),event_enum_1=require("../../../../script/public/event-enum"),cc_1=require("cc"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInstance=cc_1.Prefab._utils.PrefabInstance,TargetInfo=cc_1.Prefab._utils.TargetInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,MountedChildrenInfo=cc_1.Prefab._utils.MountedChildrenInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,MountedComponentsInfo=cc_1.Prefab._utils.MountedComponentsInfo;var PrefabState;!function(e){e[e.NotAPrefab=0]="NotAPrefab",e[e.PrefabChild=1]="PrefabChild",e[e.PrefabInstance=2]="PrefabInstance",e[e.PrefabLostAsset=3]="PrefabLostAsset"}(PrefabState||(PrefabState={})),exports.PrefabState=PrefabState;const compKey="_components";function compareStringArray(e,t){return!(!e||!t)&&(e.length===t.length&&e.every((e,r)=>e===t[r]))}class PrefabUtil{constructor(){this.assetTargetMapCache=new Map,this.prefabAssetNodeInstanceMap=new Map}getPrefab(e){return e._prefab}fireBeforeChangeMsg(e){node_1.default.emit("before-change",e)}fireChangeMsg(e,t={}){t.type=event_enum_1.NodeEventType.PREFAB_INFO_CHANGED,node_1.default.emit("change",e,t)}getPrefabAssetNodeInstance(e){if(this.prefabAssetNodeInstanceMap.has(e))return this.prefabAssetNodeInstanceMap.get(e);let t=void 0;if(e&&e.asset&&(t=cc_1.instantiate(e.asset)),t){const r=t._prefab;r&&(r.instance=e.instance),this.prefabAssetNodeInstanceMap.set(e,t)}return t}clearCache(){this.assetTargetMapCache.clear(),this.prefabAssetNodeInstanceMap.clear()}removePrefabAssetNodeInstanceCache(e){this.prefabAssetNodeInstanceMap.has(e)&&this.prefabAssetNodeInstanceMap.delete(e)}getTargetMap(e,t=!1){if(t&&this.assetTargetMapCache.has(e))return this.assetTargetMapCache.get(e);const r={};return this.generateTargetMap(e,r,!0),this.assetTargetMapCache.set(e,r),r}generateTargetMap(e,t,r){var n;let o=t;const a=null===(n=e._prefab)||void 0===n?void 0:n.instance;!r&&a&&(t[a.fileId]={},o=t[a.fileId]);const s=e._prefab;s&&(o[s.fileId]=e);const i=e.components;for(let e=0;e<i.length;e++){const t=i[e];t.__prefab&&(o[t.__prefab.fileId]=t)}for(let t=0;t<e.children.length;t++){const r=e.children[t];this.generateTargetMap(r,o,!1)}if(a&&a.mountedChildren.length>0)for(let e=0;e<a.mountedChildren.length;e++){const r=a.mountedChildren[e];if(r&&r.targetInfo){let e=t;const n=r.targetInfo.localID;if(n.length>0)for(let t=0;t<n.length-1;t++)e=e[n[t]];if(r.nodes)for(let t=0;t<r.nodes.length;t++){const n=r.nodes[t];n&&this.generateTargetMap(n,e,!1)}}}}getPropertyOverrideLocationInfo(e,t){var r;const n=this.getOutMostPrefabInstanceInfo(e),o=n.outMostPrefabInstanceNode;if(!o)return null;const a=n.targetPath;let s=e;if(null===(r=o._prefab)||void 0===r?void 0:r.instance){a.splice(0,1);let r=[];if(t.length<=0)return null;if(t[0]===compKey){if(2===t.length)return null;if(1===t.length)return null;const n=e[t[0]][t[1]];if(!n.__prefab)return null;a.push(n.__prefab.fileId),r=t.slice(2),s=n}else{const n=e._prefab;n?(a.push(n.fileId),r=t):console.error(`node: ${e.name} doesn't have a prefabInfo`)}return{outMostPrefabInstanceNode:o,targetPath:a,relativePathKeys:r,target:s}}return null}getDumpableNode(e,t){const r=cc.instantiate(e);return EditorExtends.PrefabUtils.checkAndStripNode(r,t),r}addPrefabInfoToNode(e,t,r){return EditorExtends.PrefabUtils.addPrefabInfoToNode(e,t,r)}addPrefabInfoToComponent(e){e.__prefab||(e.__prefab=new CompPrefabInfo),e.__prefab&&(e.__prefab.fileId=e.__prefab.fileId?e.__prefab.fileId:e.uuid)}generatePrefabDumpableNode(e,t){const r=cc.instantiate(e);return EditorExtends.PrefabUtils.addPrefabInfo(r,r,t),EditorExtends.PrefabUtils.checkAndStripNode(r),r}generatePrefabDataFromNode(e){const t=this.generatePrefabFromNode(e);return t?(this.removeMountedRootInfo(t.data),t.data._prefab.instance=void 0,cce.Utils.serialize(t)):null}removeMountedRootInfo(e){const t=e._prefab;t&&t.instance&&(t.instance.mountedChildren.forEach(e=>{e.nodes.forEach(e=>{this.setMountedRoot(e,void 0)})}),t.instance.mountedComponents.forEach(e=>{e.components.forEach(e=>{this.setMountedRoot(e,void 0)})}))}generatePrefabFromNode(e){let t=null;if(!(t="string"==typeof e?node_1.default.query(e):e))return null;const r=new cc_1.Prefab,n=this.generatePrefabDumpableNode(t,r);return r.data=n,r}createPrefabInstance(){const e=new PrefabInstance;return e.fileId=EditorExtends.UuidUtils.uuid(),e}cloneInstanceWithNewFileId(e){const t=this.createPrefabInstance(),r=e.propertyOverrides;t.propertyOverrides=[];for(let e=0;e<r.length;e++){const n=r[e],o=new PropertyOverrideInfo;o.targetInfo=n.targetInfo,o.propertyPath=n.propertyPath,o.value=n.value,t.propertyOverrides.push(o)}return t}getPrefabInstanceRoot(e){var t;let r=e,n=null;for(;r;){if(null===(t=r._prefab)||void 0===t?void 0:t.instance){n=r;break}r=r.parent}return n}isSameSourceTargetOverride(e,t,r,n){var o;return!(e.source!==t||(r||e.sourceInfo)&&!compareStringArray(r,null===(o=e.sourceInfo)||void 0===o?void 0:o.localID)||!compareStringArray(e.propertyPath,n))}getSourceData(e){var t,r;let n,o=e;const a=e.node;if(!a)return null;if(a._prefab&&!this.isMountedComponent(e)){const s=this.getOutMostPrefabInstanceInfo(a),i=s.outMostPrefabInstanceNode;i&&(o=i,(n=s.targetPath).splice(0,1),(null===(t=e.__prefab)||void 0===t?void 0:t.fileId)?n.push(null===(r=e.__prefab)||void 0===r?void 0:r.fileId):console.error(`can't get fileId of component: ${e.name} in node: ${e.node.name}`))}return{sourceTarget:o,sourceLocalID:n}}removeTargetOverrideBySource(e,t){if(!e)return!1;if(!e.targetOverrides)return!1;let r=!1;for(let n=e.targetOverrides.length-1;n>=0;n--){e.targetOverrides[n].source===t&&(e.targetOverrides.splice(n,1),r=!0)}return r}removeTargetOverride(e,t,r){if(!e)return!1;if(!e.targetOverrides)return!1;const n=this.getSourceData(t);if(!n)return!1;const o=n.sourceTarget,a=n.sourceLocalID;let s=!1;for(let t=e.targetOverrides.length-1;t>=0;t--){const n=e.targetOverrides[t];this.isSameSourceTargetOverride(n,o,a,r)&&(e.targetOverrides.splice(t,1),s=!0)}return s}isInTargetOverrides(e,t,r){const n=this.getSourceData(t);if(!n)return!1;const o=n.sourceTarget,a=n.sourceLocalID;for(let t=0;t<e.length;t++){const n=e[t];if(this.isSameSourceTargetOverride(n,o,a,r))return!0}return!1}getTargetOverride(e,t,r){let n=null;e.targetOverrides||(e.targetOverrides=[]);const o=this.getSourceData(t);if(!o)return null;const a=o.sourceTarget,s=o.sourceLocalID;for(let t=0;t<e.targetOverrides.length;t++){const o=e.targetOverrides[t];if(this.isSameSourceTargetOverride(o,a,s,r)){n=o;break}}return n||((n=new TargetOverrideInfo).source=a,s&&(n.sourceInfo=new TargetInfo,n.sourceInfo.localID=s),n.propertyPath=r,e.targetOverrides.push(n)),n}getPropertyOverridesOfTarget(e,t){var r;const n=[];for(let o=0;o<e.propertyOverrides.length;o++){const a=e.propertyOverrides[o];compareStringArray(null===(r=a.targetInfo)||void 0===r?void 0:r.localID,t)&&n.push(a)}return n}isInPropertyOverrides(e,t){for(let r=0;r<t.length;r++){if(compareStringArray(t[r].propertyPath,e))return!0}return!1}getPropertyOverride(e,t,r){var n;let o=null,a=null;for(let s=0;s<e.propertyOverrides.length;s++){const i=e.propertyOverrides[s];if(compareStringArray(null===(n=i.targetInfo)||void 0===n?void 0:n.localID,t)&&(a=i.targetInfo,compareStringArray(i.propertyPath,r))){o=i;break}}return o||(o=new PropertyOverrideInfo,a||((a=new TargetInfo).localID=t),o.targetInfo=a,o.propertyPath=r,e.propertyOverrides.push(o)),o}removePropertyOverride(e,t,r){var n;for(let o=e.propertyOverrides.length-1;o>=0;o--){const a=e.propertyOverrides[o];compareStringArray(null===(n=a.targetInfo)||void 0===n?void 0:n.localID,t)&&compareStringArray(a.propertyPath,r)&&e.propertyOverrides.splice(o,1)}}findPrefabInstanceMountedChildren(e,t){let r=null;const n=e.mountedChildren;for(let e=0;e<n.length;e++){const o=n[e];if(o.isTarget(t)){r=o;break}}return r}createMountedChildrenInfo(e){const t=new TargetInfo;t.localID=e;const r=new MountedChildrenInfo;return r.targetInfo=t,r}getPrefabInstanceMountedChildren(e,t){let r=this.findPrefabInstanceMountedChildren(e,t);return r||(r=this.createMountedChildrenInfo(t),e.mountedChildren.push(r)),r}getPrefabInstanceMountedComponents(e,t){let r=null;const n=e.mountedComponents;for(let e=0;e<n.length;e++){const o=n[e];if(o.isTarget(t)){r=o;break}}if(!r){const n=new TargetInfo;n.localID=t,(r=new MountedComponentsInfo).targetInfo=n,e.mountedComponents.push(r)}return r}addRemovedComponent(e,t){const r=e.removedComponents;for(let e=0;e<r.length;e++){if(compareStringArray(r[e].localID,t))return}const n=new TargetInfo;n.localID=t,r.push(n)}deleteRemovedComponent(e,t){const r=e.removedComponents;for(let e=0;e<r.length;e++){if(compareStringArray(r[e].localID,t)){r.splice(e,1);break}}}isChildOfPrefabInstance(e){var t;let r=e.parent,n=!1;for(;r;){if(null===(t=r._prefab)||void 0===t?void 0:t.instance){n=!0;break}r=r.parent}return n}isPrefabInstanceRoot(e){const t=e._prefab;return!(!t||!t.instance)&&(!t.instance.prefabRootNode||!t.instance.prefabRootNode._prefab.instance)}isChildOfPrefabAsset(e){var t;const r=e._prefab;if(!r)return!1;const n=e.parent;if(!n)return!1;const o=n._prefab;return!!o&&(r.root===o.root||(null===(t=r.instance)||void 0===t?void 0:t.prefabRootNode)===o.root)}isPartOfPrefabAsset(e){const t=e._prefab,r=this.getOutMostPrefabInstanceInfo(e);return!(!t||!r.outMostPrefabInstanceNode)&&!this.isMountedChildOf(r.outMostPrefabInstanceNode,e)}isPartOfPrefabInstance(e){var t;let r=e,n=!1;for(;r;){if(null===(t=r._prefab)||void 0===t?void 0:t.instance){n=!0;break}r=r.parent}return n}isPartOfAssetInPrefabInstance(e){return!!this.isPartOfPrefabInstance(e)&&this.isPartOfPrefabAsset(e)}getOutMostPrefabInstanceInfo(e){var t;const r=[];let n=null,o=e;for(;o;){const a=null===(t=o._prefab)||void 0===t?void 0:t.instance;if(a&&(r.unshift(a.fileId),n=o,!a.prefabRootNode||a.prefabRootNode===e))break;o=o.parent}return{outMostPrefabInstanceNode:n,targetPath:r}}isSceneNode(e){return e instanceof cc_1.Scene}getPrefabStateInfo(e){var t;let r=PrefabState.NotAPrefab,n=!1,o=!1,a=!1,s=!1,i="";if(this.isSceneNode(e))return{state:r,isUnwrappable:n,isRevertable:o,isApplicable:a,isAddedChild:s,assetUuid:i};if(e._prefab){e._prefab.asset&&(i=e._prefab.asset._uuid);const s=e._prefab.instance;if(s){n=!0,o=!0,a=!0,r=PrefabState.PrefabInstance;const i=s.prefabRootNode;i&&(null===(t=i._prefab)||void 0===t?void 0:t.instance)&&i!==e&&(n=!1,o=!1,a=!1)}else r=PrefabState.PrefabChild;e._prefab.asset&&!e._prefab.asset.isDefault&&""!==e._prefab.asset.uuid||(r=PrefabState.PrefabLostAsset,n=!0)}if(e.parent&&!this.isSceneNode(e.parent)){if(e.parent._prefab){const t=this.getOutMostPrefabInstanceInfo(e.parent);t&&t.outMostPrefabInstanceNode&&this.isMountedChildOf(t.outMostPrefabInstanceNode,e)&&(s=!0)}}return{state:r,isUnwrappable:n,isRevertable:o,isApplicable:a,isAddedChild:s,assetUuid:i}}getMountedRoot(e){var t;return null===(t=e[cc_1.editorExtrasTag])||void 0===t?void 0:t.mountedRoot}setMountedRoot(e,t){e&&(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=t)}isMountedChildOf(e,t){const r=this.getMountedRoot(t);return!(!r||r!==e)}isMountedComponent(e){const t=e.node;if(!t)return!1;const r=this.getOutMostPrefabInstanceInfo(t).outMostPrefabInstanceNode;if(!r)return!1;const n=this.getMountedRoot(e);return!(!n||n!==r)}getRemovedComponents(e){var t;const r=[],n=e._prefab;if(!n)return r;const o=this.getOutMostPrefabInstanceInfo(e),a=o.outMostPrefabInstanceNode;if(!a)return r;const s=o.targetPath,i=null===(t=a._prefab)||void 0===t?void 0:t.instance,f=a._prefab;if(i&&f&&f.asset){if(i.removedComponents.length<=0)return r;s.splice(0,1),s.push(n.fileId);const t=this.getPrefabAssetNodeInstance(f);if(!t)return r;const o=this.getTargetMap(t,!0),a=cc_1.Prefab._utils.getTarget(s,o);if(!a)return r;const c=e.components.map(e=>{var t;return null===(t=e.__prefab)||void 0===t?void 0:t.fileId}).filter(e=>!!e);for(const e of a.components)e.__prefab&&(c.includes(e.__prefab.fileId)||r.push(e))}return r}checkToRemoveTargetOverride(e,t){t&&this.removeTargetOverrideBySource(t._prefab,e)&&this.fireChangeMsg(t)}}PrefabUtil.PrefabState=PrefabState;const prefabUtils=new PrefabUtil;exports.prefabUtils=prefabUtils;