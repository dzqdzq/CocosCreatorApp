"use strict";var PrefabState,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabState=exports.prefabUtils=void 0;const event_enum_1=require("../../../../script/public/event-enum"),cc_1=require("cc"),node_1=__importDefault(require("../../../utils/node")),PrefabInfo=cc_1.Prefab._utils.PrefabInfo,CompPrefabInfo=cc_1.Prefab._utils.CompPrefabInfo,PrefabInstance=cc_1.Prefab._utils.PrefabInstance,TargetInfo=cc_1.Prefab._utils.TargetInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,MountedChildrenInfo=cc_1.Prefab._utils.MountedChildrenInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,MountedComponentsInfo=cc_1.Prefab._utils.MountedComponentsInfo,compKey=(!function(e){e[e.NotAPrefab=0]="NotAPrefab",e[e.PrefabChild=1]="PrefabChild",e[e.PrefabInstance=2]="PrefabInstance",e[e.PrefabLostAsset=3]="PrefabLostAsset"}(PrefabState||(exports.PrefabState=PrefabState={})),"_components"),DELIMETER=cc_1.CCClass.Attr.DELIMETER;function compareStringArray(e,r){return!(!e||!r)&&e.length===r.length&&e.every((e,t)=>e===r[t])}function isInClassChain(e,t){var r;return!(!e||!t)&&((r=cc_1.CCClass.getInheritanceChain(e)).push(e),r.includes(t))}function isSameNode(e,t){return e.getPathInHierarchy()===t.getPathInHierarchy()&&e.getSiblingIndex()===t.getSiblingIndex()}function pushNestedPrefab(e,t,r){let a=e.parent;for(;a&&a!==t;)a._prefab?.instance&&r.unshift(a._prefab?.instance.fileId),a=a.parent}class PrefabUtil{static PrefabState=PrefabState;assetTargetMapCache=new Map;prefabAssetNodeInstanceMap=new Map;getPrefab(e){return e._prefab}fireBeforeChangeMsg(e){cce.Node.emit("before-change",e)}fireChangeMsg(e,t={}){t.type=event_enum_1.NodeEventType.PREFAB_INFO_CHANGED,cce.Node.emit("change",e,t)}getPrefabAssetNodeInstance(e){if(this.prefabAssetNodeInstanceMap.has(e))return this.prefabAssetNodeInstanceMap.get(e);let t=void 0;var r;return(t=e&&e.asset?(0,cc_1.instantiate)(e.asset):t)&&((r=t._prefab)&&(r.instance=e.instance),this.prefabAssetNodeInstanceMap.set(e,t)),t}clearCache(){this.assetTargetMapCache.clear(),this.prefabAssetNodeInstanceMap.clear()}removePrefabAssetNodeInstanceCache(e){this.prefabAssetNodeInstanceMap.has(e)&&this.prefabAssetNodeInstanceMap.delete(e)}getTargetMap(e,t=!1){return t&&this.assetTargetMapCache.has(e)?this.assetTargetMapCache.get(e):(this.generateTargetMap(e,t={},!0),this.assetTargetMapCache.set(e,t),t)}getTarget(e,t,r=!1){t=this.getTargetMap(t,r);return cc_1.Prefab._utils.getTarget(e,t)}generateTargetMap(t,e,a){if(t){let r=e;var n=t._prefab?.instance,a=(!a&&n&&(e[n.fileId]={},r=e[n.fileId]),t._prefab),o=(a&&(r[a.fileId]=t),t.components);for(let e=0;e<o.length;e++){var s=o[e];s.__prefab&&(r[s.__prefab.fileId]=s)}for(let e=0;e<t.children.length;e++){var i=t.children[e];this.generateTargetMap(i,r,!1)}if(n&&0<n.mountedChildren.length)for(let e=0;e<n.mountedChildren.length;e++){var f=n.mountedChildren[e];if(f&&f.targetInfo){let t=r;var c=f.targetInfo.localID;if(0<c.length)for(let e=0;e<c.length-1;e++)t=t[c[e]];if(f.nodes&&t)for(let e=0;e<f.nodes.length;e++){var d=f.nodes[e];d&&this.generateTargetMap(d,t,!1)}}}}}getPropertyOverrideLocationInfo(r,a){var n=this.getOutMostPrefabInstanceInfo(r),o=n.outMostPrefabInstanceNode;if(o){n=n.targetPath;let t=r;if(o._prefab?.instance){n.splice(0,1);let e=[];if(a.length<=0)return null;if(a[0]===compKey){if(2===a.length)return null;if(1===a.length)return null;var s=r[a[0]][a[1]];if(!s.__prefab)return null;n.push(s.__prefab.fileId),e=a.slice(2),t=s}else{s=r._prefab;s?(n.push(s.fileId),e=a):console.error(`node: ${r.name} doesn't have a prefabInfo`)}return{outMostPrefabInstanceNode:o,targetPath:n,relativePathKeys:e,target:t}}}return null}getPrefabForSerialize(e,t=void 0){const o=(0,cc_1.instantiate)(e);this.removeMountedRootInfo(o);var r=new cc.Prefab;const s=prefabUtils.createPrefabInfo(e.uuid);s.asset=r,s.root=o;e=this.getPrefab(o);e&&(r.optimizationPolicy=e.asset?.optimizationPolicy,r.persistent=e.asset?.persistent,s.targetOverrides=e.targetOverrides,s.fileId=e.fileId),o._prefab=s;const i=[];this.walkNode(o,(t,e)=>{if(!(t.objFlags&cc.Object.Flags.HideInHierarchy)){var r,a=this.getPrefab(t);if(a?a.instance?(r=this.getOutMostPrefabInstanceInfo(t)["outMostPrefabInstanceNode"],r===t&&(a.nestedPrefabInstanceRoots=void 0,a.instance.prefabRootNode=o,i.push(t))):t._prefab&&(t._prefab.root=s.root,t._prefab.asset=s.asset):((r=new PrefabInfo).root=s.root,r.asset=s.asset,r.fileId=t.uuid,t._prefab=r),t.components&&t.components.length)for(let e=0;e<t.components.length;e++){var n=t.components[e];n.__prefab||(n.__prefab=new CompPrefabInfo,n.__prefab.fileId=n.uuid)}}}),s.nestedPrefabInstanceRoots=0<i.length?i:void 0;e=EditorExtends.PrefabUtils.checkAndStripNode(o,t);return this.removeInvalidPrefabData(o),this.setMountedRoot(o,void 0),r.data=o,{prefab:r,clearedReference:e}}addPrefabInfo(e,t,r){return EditorExtends.PrefabUtils.addPrefabInfo(e,t,r)}walkNode(e,t,r=!1){EditorExtends.PrefabUtils.walkNode(e,t,r)}addPrefabInfoToComponent(e){e.__prefab||(e.__prefab=new CompPrefabInfo),e.__prefab&&(e.__prefab.fileId=e.__prefab.fileId||e.uuid)}generatePrefabDataFromNode(e){let t=null;var r;return(t="string"==typeof e?cce.Node.query(e):e)&&({prefab:e,clearedReference:r}=this.getPrefabForSerialize(t),e)?(e.data._prefab.instance=void 0,this.removeInvalidPropertyOverrideReference(e.data),{prefabData:cce.Utils.serialize(e),clearedReference:r}):null}removeMountedRootInfo(e){e=e._prefab;e&&e.instance&&(e.instance.mountedChildren.forEach(e=>{e.nodes.forEach(e=>{this.setMountedRoot(e,void 0)})}),e.instance.mountedComponents.forEach(e=>{e.components.forEach(e=>{this.setMountedRoot(e,void 0)})}))}generateUUID(){return EditorExtends.UuidUtils.uuid()}createPrefabInstance(){var e=new PrefabInstance;return e.fileId=this.generateUUID(),e}createPrefabInfo(e){var t=new PrefabInfo;return t.fileId=e,t}cloneInstanceWithNewFileId(e){var t=this.createPrefabInstance(),r=e.propertyOverrides;t.propertyOverrides=[];for(let e=0;e<r.length;e++){var a=r[e],n=new PropertyOverrideInfo;n.targetInfo=a.targetInfo,n.propertyPath=a.propertyPath,n.value=a.value,t.propertyOverrides.push(n)}var o=e.mountedChildren;t.mountedChildren=[];for(let e=0;e<o.length;e++){var s=o[e],i=new MountedChildrenInfo;i.targetInfo=s.targetInfo,i.nodes=s.nodes.slice(),t.mountedChildren.push(i)}var f=e.mountedComponents;t.mountedComponents=[];for(let e=0;e<f.length;e++){var c=f[e],d=new MountedComponentsInfo;d.targetInfo=c.targetInfo,d.components=c.components.slice(),t.mountedComponents.push(d)}return t.removedComponents=e.removedComponents.slice(),t}getPrefabInstanceRoot(e){let t=e,r=null;for(;t;){if(t._prefab?.instance){r=t;break}t=t.parent}return r}isSameSourceTargetOverride(e,t,r,a){return!(e.source!==t||(r||e.sourceInfo)&&!compareStringArray(r,e.sourceInfo?.localID)||!compareStringArray(e.propertyPath,a))}getSourceData(e){let t=e,r;var a,n=e.node;return n?(n._prefab&&!this.isMountedComponent(e)&&(a=(n=this.getOutMostPrefabInstanceInfo(n)).outMostPrefabInstanceNode)&&(t=a,(r=n.targetPath).splice(0,1),e.__prefab?.fileId?r.push(e.__prefab?.fileId):console.error(`can't get fileId of component: ${e.name} in node: `+e.node.name)),{sourceTarget:t,sourceLocalID:r}):null}removeTargetOverrideBySource(t,r){if(!t)return!1;if(!t.targetOverrides)return!1;let a=!1;for(let e=t.targetOverrides.length-1;0<=e;e--)t.targetOverrides[e].source===r&&(t.targetOverrides.splice(e,1),a=!0);return a}removeTargetOverride(t,e,r){if(!t)return!1;if(!t.targetOverrides)return!1;e=this.getSourceData(e);if(!e)return!1;var a=e.sourceTarget,n=e.sourceLocalID;let o=!1;for(let e=t.targetOverrides.length-1;0<=e;e--){var s=t.targetOverrides[e];this.isSameSourceTargetOverride(s,a,n,r)&&(t.targetOverrides.splice(e,1),o=!0)}return o}isInTargetOverrides(t,e,r){e=this.getSourceData(e);if(e){var a=e.sourceTarget,n=e.sourceLocalID;for(let e=0;e<t.length;e++){var o=t[e];if(this.isSameSourceTargetOverride(o,a,n,r))return!0}}return!1}getTargetOverride(t,e,r){let a=null;t.targetOverrides||(t.targetOverrides=[]);e=this.getSourceData(e);if(!e)return null;var n=e.sourceTarget,o=e.sourceLocalID;for(let e=0;e<t.targetOverrides.length;e++){var s=t.targetOverrides[e];if(this.isSameSourceTargetOverride(s,n,o,r)){a=s;break}}return a||((a=new TargetOverrideInfo).source=n,o&&(a.sourceInfo=new TargetInfo,a.sourceInfo.localID=o),a.propertyPath=r,t.targetOverrides.push(a)),a}getPropertyOverridesOfTarget(t,r){var a=[];for(let e=0;e<t.propertyOverrides.length;e++){var n=t.propertyOverrides[e];compareStringArray(n.targetInfo?.localID,r)&&a.push(n)}return a}isInPropertyOverrides(t,r){for(let e=0;e<r.length;e++)if(compareStringArray(r[e].propertyPath,t))return!0;return!1}getPropertyOverride(t,r,a){let n=null,o=null;for(let e=0;e<t.propertyOverrides.length;e++){var s=t.propertyOverrides[e];if(compareStringArray(s.targetInfo?.localID,r)&&(o=s.targetInfo,compareStringArray(s.propertyPath,a))){n=s;break}}return n||(n=new PropertyOverrideInfo,o||((o=new TargetInfo).localID=r),n.targetInfo=o,n.propertyPath=a,t.propertyOverrides.push(n)),n}removePropertyOverride(t,r,a){for(let e=t.propertyOverrides.length-1;0<=e;e--){var n=t.propertyOverrides[e];compareStringArray(n.targetInfo?.localID,r)&&compareStringArray(n.propertyPath,a)&&t.propertyOverrides.splice(e,1)}}findPrefabInstanceMountedChildren(e,t){let r=null;var a=e.mountedChildren;for(let e=0;e<a.length;e++){var n=a[e];if(n.isTarget(t)){r=n;break}}return r}createMountedChildrenInfo(e){var t=new TargetInfo,e=(t.localID=e,new MountedChildrenInfo);return e.targetInfo=t,e}getPrefabInstanceMountedChildren(e,t){let r=this.findPrefabInstanceMountedChildren(e,t);return r||(r=this.createMountedChildrenInfo(t),e.mountedChildren.push(r)),r}getPrefabInstanceMountedComponents(e,t){let r=null;var a,n=e.mountedComponents;for(let e=0;e<n.length;e++){var o=n[e];if(o.isTarget(t)){r=o;break}}return r||((a=new TargetInfo).localID=t,(r=new MountedComponentsInfo).targetInfo=a,e.mountedComponents.push(r)),r}addRemovedComponent(e,t){var r=e.removedComponents;for(let e=0;e<r.length;e++){const a=r[e];if(compareStringArray(a.localID,t))return}const a=new TargetInfo;a.localID=t,r.push(a)}deleteRemovedComponent(e,t){var r=e.removedComponents;for(let e=0;e<r.length;e++)if(compareStringArray(r[e].localID,t)){r.splice(e,1);break}}isChildOfPrefabInstance(e){let t=e.parent,r=!1;for(;t;){if(t._prefab?.instance){r=!0;break}t=t.parent}return r}isPrefabInstanceRoot(e){e=e._prefab;return!(!e||!e.instance||e.instance.prefabRootNode&&e.instance.prefabRootNode._prefab?.instance)}isChildOfPrefabAsset(e){var t=e._prefab;return!!t&&!(!(e=e.parent)||!(e=e._prefab)||t.root!==e.root&&t.instance?.prefabRootNode!==e.root)}isPartOfPrefabAsset(e){var t=e._prefab,r=this.getOutMostPrefabInstanceInfo(e);return!(!t||!r.outMostPrefabInstanceNode||this.isMountedChildOf(r.outMostPrefabInstanceNode,e))}isPartOfPrefabInstance(e){let t=e,r=!1;for(;t;){if(t._prefab?.instance){r=!0;break}t=t.parent}return r}isPartOfAssetInPrefabInstance(e){return!!this.isPartOfPrefabInstance(e)&&this.isPartOfPrefabAsset(e)}getOutMostPrefabInstanceInfo(e){var t=[];let r=null,a=e;for(;a;){var n=a._prefab?.instance;if(n){if(t.unshift(n.fileId),r=a,!n.prefabRootNode)break;var o=n.prefabRootNode,s=cce.Scene.rootNode;if(o&&s&&isSameNode(o,s))break;if(pushNestedPrefab(a,n.prefabRootNode,t),a===n.prefabRootNode){console.warn("getOutMostPrefabInstanceInfo failed: prefab instance root node has loop");break}a=n.prefabRootNode}else a=a.parent}return{outMostPrefabInstanceNode:r,targetPath:t}}isSceneNode(e){return e instanceof cc_1.Scene}isNestedPrefab(t){var r=t._prefab,a=r?.asset?.uuid;if(r&&a){let e=t.parent;for(;e&&e!==e.scene;){var n=e._prefab;if(n&&a!==n.asset?.uuid){if(r.instance)return!0;if(!this.isNestedPrefab(e))return!0}e=e.parent}}return!1}getPrefabStateInfo(e){let t=PrefabState.NotAPrefab,r=!1,a=!1,n=!1,o=!1,s=!1,i="";var f;return this.isSceneNode(e)||(e._prefab&&(e._prefab.asset&&(i=e._prefab.asset._uuid),e._prefab.instance?(r=!0,a=!0,n=!0,t=PrefabState.PrefabInstance,f=this.getOutMostPrefabInstanceInfo(e)["outMostPrefabInstanceNode"],f!==e&&(r=!1,a=!1,n=!1)):t=PrefabState.PrefabChild,s=this.isNestedPrefab(e),e._prefab.asset&&!e._prefab.asset.isDefault&&""!==e._prefab.asset.uuid||(t=PrefabState.PrefabLostAsset,r=!0),this.isSubAsset(i))&&(n=!1),e.parent&&!this.isSceneNode(e.parent)&&e.parent._prefab&&(f=this.getOutMostPrefabInstanceInfo(e.parent))&&f.outMostPrefabInstanceNode&&this.isMountedChildOf(f.outMostPrefabInstanceNode,e)&&(o=!0)),{state:t,isUnwrappable:r,isRevertable:a,isApplicable:n,isAddedChild:o,isNested:s,assetUuid:i}}getMountedRoot(e){return e[cc_1.editorExtrasTag]?.mountedRoot}setMountedRoot(e,t){e&&(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=t)}isMountedChildOf(e,t){t=this.getMountedRoot(t);return!(!t||t!==e)}isMountedComponent(e){var t=e.node;return!!t&&!!(t=this.getOutMostPrefabInstanceInfo(t).outMostPrefabInstanceNode)&&!(!(e=this.getMountedRoot(e))||e!==t)}getRemovedComponents(e){var t=[],r=e._prefab;if(r){var a=this.getOutMostPrefabInstanceInfo(e),n=a.outMostPrefabInstanceNode;if(n){var a=a.targetPath,o=n._prefab?.instance,n=n._prefab;if(o&&n&&n.asset){if(o.removedComponents.length<=0)return t;a.splice(0,1),a.push(r.fileId);o=this.getPrefabAssetNodeInstance(n);if(!o)return t;r=this.getTarget(a,o,!0);if(!r)return t;var s=e.components.map(e=>e.__prefab?.fileId).filter(e=>!!e);for(const i of r.components)!i.__prefab||s.includes(i.__prefab.fileId)||t.push(i)}}}return t}checkToRemoveTargetOverride(e,t){t&&this.removeTargetOverrideBySource(t._prefab,e)&&this.fireChangeMsg(t)}findOutmostPrefabInstanceNodes(e,t){var r;e&&((r=e._prefab)?.instance?(t.push(e),r.nestedPrefabInstanceRoots&&(r.nestedPrefabInstanceRoots.forEach(e=>{e._prefab&&(e._prefab.nestedPrefabInstanceRoots=void 0)}),r.nestedPrefabInstanceRoots=void 0),r.instance?.mountedChildren?.forEach(e=>{e.nodes.forEach(e=>{this.findOutmostPrefabInstanceNodes(e,t)})})):e.children.forEach(e=>{this.findOutmostPrefabInstanceNodes(e,t)}))}gatherPrefabInstanceRoots(e){const t=[];e.children.forEach(e=>{node_1.default.isEditorNode(e)||this.findOutmostPrefabInstanceNodes(e,t)}),0<t.length?(e._prefab||(e._prefab=prefabUtils.createPrefabInfo(e.uuid)),e._prefab.nestedPrefabInstanceRoots=t):(e=e._prefab)&&(e.nestedPrefabInstanceRoots=void 0)}isSubAsset(e){return e.includes("@")}removePrefabInfo(e){this.fireBeforeChangeMsg(e),e._prefab=null,e.components.forEach(e=>{e.__prefab=null}),this.fireChangeMsg(e)}checkMountedRootData(r,e){var a=this.getMountedRoot(r);if(a){let t=!1;var n=a._prefab?.instance;if(n&&n.mountedChildren)for(let e=0;e<n.mountedChildren.length;e++)if(n.mountedChildren[e].nodes.includes(r)){t=!0;break}t||this.setMountedRoot(r,void 0)}r.components.forEach(r=>{var e=this.getMountedRoot(r);if(e){let t=!1;var a=e._prefab?.instance;if(a&&a.mountedComponents)for(let e=0;e<a.mountedComponents.length;e++)if(a.mountedComponents[e].components.includes(r)){t=!0;break}t||this.setMountedRoot(r,void 0)}}),e&&r.children.forEach(e=>{this.checkMountedRootData(e,!0)})}removePrefabInstanceRoots(e){e=e._prefab;e&&(e.nestedPrefabInstanceRoots=void 0)}checkTargetOverridesData(e){e=e._prefab;if(e){var t=e.targetOverrides;if(t)for(let e=t.length-1;0<=e;e--){var r=t[e];r&&r.source||t.splice(e,1)}}}isOutmostPrefabInstanceMountedChildren(e){let t=e;for(;t;){var r=this.getMountedRoot(t);if(r)if(this.getOutMostPrefabInstanceInfo(r).outMostPrefabInstanceNode===r)return!0;if(!(t=t.parent)||this.isPrefabInstanceRoot(t))break}return!1}removeInvalidPropertyOverrides(e){var t=e._prefab;if(t&&t.instance){var r=t.instance.propertyOverrides,t=r.length,a=this.getTargetMap(e);if(a&&0!==Object.keys(a).length)for(let e=t-1;0<=e;e--){var n=r[e].targetInfo;n&&!cc_1.Prefab._utils.getTarget(n.localID,a)&&r.splice(e,1)}else console.debug("removeInvalidPropertyOverrides return,targetMap is empty",e)}}removeInvalidTargetOverrides(e){e=e?._prefab;if(e){var n=e.targetOverrides;if(n)for(let a=n.length-1;0<=a;a--){var o=n[a];let e=o.source;var t=o.sourceInfo;let r=null;var s=o.targetInfo;if((e=t&&o.source instanceof cc_1.Node?this.getTarget(t.localID,o.source):e)||o.target){if(!e&&o.target&&s&&s.localID&&!(r=this.getTarget(s.localID,o.target)))n.splice(a,1);else if(e&&s&&o.target instanceof cc_1.Node&&(r=this.getTarget(s.localID,o.target))){var i=o.propertyPath.slice();let t=e;for(let e=0;e<i.length;e++){var f=i[e],c=cc_1.CCClass.Attr.getClassAttrs(t.constructor);if(!(t=t[f])){n.splice(a,1);break}e===i.length-1&&(f=f+DELIMETER+"ctor",!isInClassChain(t.constructor,r.constructor)||c&&c[f]&&!isInClassChain(r.constructor,c[f]))&&n.splice(a,1)}}}else n.splice(a,1)}}}removeInvalidPrefabData(e){this.removeInvalidTargetOverrides(e);e=e._prefab?.nestedPrefabInstanceRoots;e&&e.forEach(e=>{this.removeInvalidPropertyOverrides(e)})}removeInvalidPropertyOverrideReference(o){var e=this.getPrefab(o);const s=new Map;return e&&e.nestedPrefabInstanceRoots?.forEach(r=>{var a=this.getPrefab(r)?.instance?.propertyOverrides;if(a)for(let t=a.length-1;0<=t;t--){var n=a[t];let e=n.value;if(e instanceof cc.Component.EventHandler?e=e.target:e instanceof cc.Component&&(e=e.node),e&&e instanceof cc.Node&&!e.isChildOf(o)){a.splice(t,1);let e=s.get(r);e||(e=[],s.set(r,e)),e.push(n)}}}),s}}const prefabUtils=new PrefabUtil;exports.prefabUtils=prefabUtils;