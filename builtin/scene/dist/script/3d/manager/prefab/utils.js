"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrefabState=exports.prefabUtils=void 0;const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),cc_1=require("cc"),PrefabInstance=cc_1.Prefab._utils.PrefabInstance,TargetInfo=cc_1.Prefab._utils.TargetInfo,PropertyOverrideInfo=cc_1.Prefab._utils.PropertyOverrideInfo,MountedChildrenInfo=cc_1.Prefab._utils.MountedChildrenInfo,TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo;var PrefabState;function compareStringArray(e,r){return!(!e||!r)&&(e.length===r.length&&e.every((e,t)=>e===r[t]))}!function(e){e[e.NotAPrefab=0]="NotAPrefab",e[e.PrefabChild=1]="PrefabChild",e[e.PrefabInstance=2]="PrefabInstance",e[e.PrefabLostAsset=3]="PrefabLostAsset"}(PrefabState||(PrefabState={})),exports.PrefabState=PrefabState;class PrefabUtil{getDumpableNode(e,r){const t=cc.instantiate(e);return EditorExtends.PrefabUtils.checkAndStripNode(t,r),t}addPrefabInfoToNode(e,r,t){return EditorExtends.PrefabUtils.addPrefabInfoToNode(e,r,t)}generatePrefabDumpableNode(e,r){const t=cc.instantiate(e);return EditorExtends.PrefabUtils.addPrefabInfo(t,t,r),EditorExtends.PrefabUtils.checkAndStripNode(t),t}createPrefabInstance(){const e=new PrefabInstance;return e.fileId=EditorExtends.UuidUtils.uuid(),e}getPrefabInstanceRoot(e){var r;let t=e,n=null;for(;t;){if(null===(r=t._prefab)||void 0===r?void 0:r.instance){n=t;break}t=t.parent}return n}isSameSourceTargetOverride(e,r,t,n){var a;return!(e.source!==r||(t||e.sourceInfo)&&!compareStringArray(t,null===(a=e.sourceInfo)||void 0===a?void 0:a.localID)||!compareStringArray(e.propertyPath,n))}getSourceData(e){var r,t;let n,a=e,o=e.node;if(!o)return null;if(o._prefab){const i=this.getOutMostPrefabInstanceInfo(o),s=i.outMostPrefabInstanceNode;s&&(a=s,(n=i.targetPath).splice(0,1),(null===(r=e.__prefab)||void 0===r?void 0:r.fileId)?n.push(null===(t=e.__prefab)||void 0===t?void 0:t.fileId):console.error(`can't get fileId of component: ${e.name} in node: ${e.node.name}`))}return{sourceTarget:a,sourceLocalID:n}}removeTargetOverrideBySource(e,r){if(!e)return!1;if(!e.targetOverrides)return!1;let t=!1;for(let n=e.targetOverrides.length-1;n>=0;n--){e.targetOverrides[n].source===r&&(e.targetOverrides.splice(n,1),t=!0)}return t}removeTargetOverride(e,r,t){if(!e)return!1;if(!e.targetOverrides)return!1;const n=this.getSourceData(r);if(!n)return!1;let a=n.sourceTarget,o=n.sourceLocalID,i=!1;for(let r=e.targetOverrides.length-1;r>=0;r--){const n=e.targetOverrides[r];this.isSameSourceTargetOverride(n,a,o,t)&&(e.targetOverrides.splice(r,1),i=!0)}return i}getTargetOverride(e,r,t){let n=null;e.targetOverrides||(e.targetOverrides=[]);const a=this.getSourceData(r);if(!a)return;let o=a.sourceTarget,i=a.sourceLocalID;for(let r=0;r<e.targetOverrides.length;r++){const a=e.targetOverrides[r];if(this.isSameSourceTargetOverride(a,o,i,t)){n=a;break}}return n||((n=new TargetOverrideInfo).source=o,i&&(n.sourceInfo=new TargetInfo,n.sourceInfo.localID=i),n.propertyPath=t,e.targetOverrides.push(n)),n}getPropertyOverride(e,r,t){var n;let a=null,o=null;for(let i=0;i<e.propertyOverrides.length;i++){const s=e.propertyOverrides[i];if(compareStringArray(null===(n=s.targetInfo)||void 0===n?void 0:n.localID,r)&&(o=s.targetInfo,compareStringArray(s.propertyPath,t))){a=s;break}}return a||(a=new PropertyOverrideInfo,o||((o=new TargetInfo).localID=r),a.targetInfo=o,a.propertyPath=t,e.propertyOverrides.push(a)),a}removePropertyOverride(e,r,t){var n;for(let a=e.propertyOverrides.length-1;a>=0;a--){const o=e.propertyOverrides[a];compareStringArray(null===(n=o.targetInfo)||void 0===n?void 0:n.localID,r)&&compareStringArray(o.propertyPath,t)&&e.propertyOverrides.splice(a,1)}}findPrefabInstanceMountedChildren(e,r){let t=null;const n=e.mountedChildren;for(let e=0;e<n.length;e++){const a=n[e];if(a.isTarget(r)){t=a;break}}return t}createMountedChildrenInfo(e){const r=new TargetInfo;r.localID=e;const t=new MountedChildrenInfo;return t.targetInfo=r,t}getPrefabInstanceMountedChildren(e,r){let t=this.findPrefabInstanceMountedChildren(e,r);return t||(t=this.createMountedChildrenInfo(r),e.mountedChildren.push(t)),t}isChildOfPrefabInstance(e){var r;let t=e.parent,n=!1;for(;t;){if(null===(r=t._prefab)||void 0===r?void 0:r.instance){n=!0;break}t=t.parent}return n}isPrefabInstanceRoot(e){const r=e._prefab;return!(!r||!r.instance)&&(!r.instance.prefabRootNode||!r.instance.prefabRootNode._prefab.instance)}isChildOfPrefabAsset(e){var r;const t=e._prefab;if(!t)return!1;const n=e.parent;if(!n)return!1;const a=n._prefab;return!!a&&(t.root===a.root||(null===(r=t.instance)||void 0===r?void 0:r.prefabRootNode)===a.root)}isPartOfPrefabAsset(e){return!!e._prefab}isPartOfPrefabInstance(e){var r;let t=e,n=!1;for(;t;){if(null===(r=t._prefab)||void 0===r?void 0:r.instance){n=!0;break}t=t.parent}return n}isPartOfAssetInPrefabInstance(e){return!!this.isPartOfPrefabInstance(e)&&this.isPartOfPrefabAsset(e)}getOutMostPrefabInstanceInfo(e){var r;const t=[];let n=null,a=e;for(;a;){const o=null===(r=a._prefab)||void 0===r?void 0:r.instance;if(o&&(t.unshift(o.fileId),n=a,!o.prefabRootNode||o.prefabRootNode===e))break;a=a.parent}return{outMostPrefabInstanceNode:n,targetPath:t}}isSceneNode(e){return e instanceof cc_1.Scene}getPrefabStateInfo(e){var r,t;let n=PrefabState.NotAPrefab,a=!1,o=!1,i=!1,s=!1;if(this.isSceneNode(e))return{state:n,isUnwrappable:a,isRevertable:o,isApplicable:i,isAddedChild:s};if(e._prefab){const t=e._prefab.instance;if(t){a=!0,o=!0,i=!0,n=PrefabState.PrefabInstance;const s=t.prefabRootNode;s&&(null===(r=s._prefab)||void 0===r?void 0:r.instance)&&s!==e&&(a=!1,o=!1,i=!1)}else n=PrefabState.PrefabChild;e._prefab.asset&&""!==e._prefab.asset.uuid||(n=PrefabState.PrefabLostAsset,a=!0)}if(e.parent&&!this.isSceneNode(e.parent)){if(e.parent._prefab){const r=this.getOutMostPrefabInstanceInfo(e.parent);if(r&&r.outMostPrefabInstanceNode){const n=null===(t=r.outMostPrefabInstanceNode._prefab)||void 0===t?void 0:t.instance;this.isMountedChild(n,e)&&(s=!0)}}}return{state:n,isUnwrappable:a,isRevertable:o,isApplicable:i,isAddedChild:s}}isMountedChild(e,r){if(!e)return!1;const t=e.mountedChildren;if(!t)return!1;for(let e=0;e<t.length;e++){const n=t[e];for(let e=0;e<n.nodes.length;e++)if(n.nodes[e]===r)return!0}return!1}}PrefabUtil.PrefabState=PrefabState;const prefabUtils=new PrefabUtil;exports.prefabUtils=prefabUtils;