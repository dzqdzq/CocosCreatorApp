"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const selection_1=__importDefault(require("./selection")),node_1=__importDefault(require("./node")),scene_1=__importDefault(require("./scene")),gizmo_manager_1=__importDefault(require("../../public/gizmos/3d/gizmo-manager")),ipc_1=__importDefault(require("./ipc")),path_1=require("path"),ScriptModuleMap={},DropTypesMap={},info={nodes:[],gizmo:{is2D:gizmo_manager_1.default.queryIs2D()},modes:[]};class PluginManager{init(){scene_1.default.on("mode-change",e=>{info.modes=[e],ipc_1.default.send("update-plugin",info)}),selection_1.default.on("select",(e,n)=>{n.forEach(e=>{const n=node_1.default.query(e);if(n&&n._components&&!info.nodes.find(n=>n.uuid===e)){const o={uuid:e,components:[]};n.components.forEach(e=>{o.components.push({type:e.__classname__,uuid:e.uuid,enabled:!!n.active&&e.enabled})}),info.nodes.push(o)}}),ipc_1.default.send("update-plugin",info)}),selection_1.default.on("unselect",()=>{info.nodes.length=0,ipc_1.default.send("update-plugin",info)}),gizmo_manager_1.default.on("info-update",()=>{info.gizmo.is2D=gizmo_manager_1.default.queryIs2D(),ipc_1.default.send("update-plugin",info)})}onNodeChanged(e){const n=info.nodes.find(n=>n.uuid===e.uuid);n&&requestAnimationFrame(()=>{const o=[];e.components.forEach(n=>{o.push({type:n.__classname__,uuid:n.uuid,enabled:!!e.active&&n.enabled})}),JSON.stringify(n.components)!==JSON.stringify(o)?(n.components=o,ipc_1.default.send("update-plugin",info)):this.forceUpdateFloatWindow()})}sendToFloatWindow(e,n){ipc_1.default.send("send-plugin","float-window",e,n)}forceUpdateToolbar(){ipc_1.default.send("force-update","toolbar",info)}forceUpdateFloatWindow(){ipc_1.default.send("force-update","float-window",info)}async executeSceneScript(e){if(!ScriptModuleMap[e.name])throw"Scenario scripts do not exist: "+e.name;if(ScriptModuleMap[e.name].methods&&ScriptModuleMap[e.name].methods[e.method])return await ScriptModuleMap[e.name].methods[e.method](...e.args||[])}getDropHandle(e){for(const n in DropTypesMap)if(DropTypesMap[n][e])return{name:n,item:DropTypesMap[n][e]};return null}}const attach=function(e){if(e.invalid)return;if(!e.info.contributions||!e.info.contributions.scene)return;const n=e.info.contributions.scene;if(n.script)try{if(n.script){const o=require(path_1.join(e.path,n.script));o.load&&o.load(),ScriptModuleMap[e.name]=o}}catch(e){console.log(e)}if(n.drop){const o={};n.drop.forEach(e=>{o[e.type]=e}),DropTypesMap[e.name]=o}},detach=function(e){if(!e.info.contributions||!e.info.contributions.scene)return;const n=e.info.contributions.scene;if(ScriptModuleMap[e.name]){const o=ScriptModuleMap[e.name];delete ScriptModuleMap[e.name],o.unload&&o.unload(),delete require.cache[path_1.join(e.path,n.script)]}DropTypesMap[e.name]&&delete DropTypesMap[e.name]},pkgs=Editor.Package.getPackages({enable:!0});pkgs.forEach(attach),Editor.Package.on("enable",attach),Editor.Package.on("disable",detach),exports.default=new PluginManager;