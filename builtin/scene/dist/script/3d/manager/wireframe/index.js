"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),wireframe_1=__importDefault(require("./wireframe")),event_enum_1=require("../../../public/event-enum"),pool_1=__importDefault(require("../../../../utils/pool"));var WireframeMode;!function(e){e[e.NONE=0]="NONE",e[e.LINE=1]="LINE",e[e.BLEND=2]="BLEND"}(WireframeMode||(WireframeMode={}));const _subModelPool=new pool_1.default(()=>new cc.renderer.scene.SubModel,32);function initSubModel(e,r,t,i=-1){modelWireframe.currMode===WireframeMode.LINE&&(t=modelWireframe.material);let n=this;if(null==n._subModels[e]?n._subModels[e]=_subModelPool.alloc():n._subModels[e].destroy(),-1!==i&&e>=i){let r=e-i;if(n._mesh.struct.morph){let e=n._mesh.struct.morph.subMeshMorphs,t={attributes:e[r].attributes,targets:e[r].targets};n._mesh.struct.morph.subMeshMorphs.push(t)}}n._subModels[e].initialize(r,t.passes,n.getMacroPatches(e)),n._updateAttributesAndBinding(e),n._inited=!0}let _setMaterial=null;function setMaterial(e,r){_setMaterial.call(this,e,r),modelWireframe.generateWireframe(this)}cc.renderer.models.SkinningModel.prototype.initSubModel=function(e,r,t){const i=r.vertexBuffers;r.vertexBuffers=r.jointMappedBuffers,initSubModel.bind(this),initSubModel(e,r,t),r.vertexBuffers=i};class ModelWireframe{constructor(){this.currMode=WireframeMode.NONE,this.color=[255,255,255,255],this.primitiveIndex=0,this.extrude=.001,this.blockCount={}}async init(){const e=await Editor.Profile.getConfig("scene","wireframe");e&&(this.currMode=parseInt(e.mode)-1,this.color=e.color),this.applyStorage(this.currMode,this.color),this.material=new cc_1.Material,this.material.initialize({effectName:"builtin-wireframe",states:{primitive:cc_1.gfx.PrimitiveMode.LINE_LIST}}),this.handleColor=this.material.passes[0].getHandle("lineColor"),this.initEventListener()}initEventListener(){cce.Terrain.on("sculpt",e=>{this._change(e)})}onSceneOpened(e){this._onLoadScene(e)}onSceneReload(e){this._onLoadScene(e)}_nodeChildrenAdd(e,r=!1){let t=e.children,i=t.length;r&&this._create(e,this.currMode,new cc_1.Color(...this.color));for(let e=0;e<i;e++){let r=t[e];if(r.isWireframeNode)return;0!==r.children.length&&this._nodeChildrenAdd(r),this._create(r,this.currMode,new cc_1.Color(...this.color),!1)}}_nodeChildrenActive(e,r=!1){let t=e.children,i=t.length;r&&this._change(e,!0);for(let e=0;e<i;e++){let r=t[e];if(r.isWireframeNode)return;0!==r.children.length&&this._nodeChildrenActive(r),this._change(r,!0,!1)}}onNodeAdded(e,r){this._nodeChildrenAdd(e,!0)}onNodeRemoved(e){e.off(event_enum_1.NodeEventType.ACTIVE_IN_HIERARCHY_CHANGE)}onNodeChanged(e,r){r&&r.blockCount&&(this.blockCount[e.uuid]=r.blockCount),this._change(e)}_change(e,r=!1,t=!0){if(this.currMode===WireframeMode.NONE&&!r)return;const i=e.getComponent(cc_1.Terrain)||e.getComponent(cc_1.MeshRenderer),n=e.getComponent(cc_1.SkinnedMeshRenderer),o=this._getWireframeInChild(e);if(i){let r;if(r=i instanceof cc_1.Terrain?i.enabled&&e.activeInHierarchy:i.mesh&&i.enabled&&e.activeInHierarchy)if(o){const e=o.getComponent(cc_1.MeshRenderer);e.mesh=this._generateMesh(i),this.currMode===WireframeMode.NONE?e.enabled=!1:e.enabled=!0}else this._create(e,this.currMode,new cc_1.Color(...this.color),t);else{if(o){o.getComponent(cc_1.MeshRenderer).enabled=!1}n&&this.generateWireframe(n)}this.currMode===WireframeMode.LINE&&!n&&i.onDisable(),cce.Engine.repaintInEditMode(),cce.GameView.repaint()}else if(o){o.getComponent(cc_1.MeshRenderer).enabled=!1,cce.Engine.repaintInEditMode()}}applyStorage(e=WireframeMode.LINE,r=[255,255,255,255]){this.currMode=e,this.color=r}async _onLoadScene(e){this.scene=e,this.applyScene(this.currMode,this.color)}_traverse(e,r,t=!0){if(e&&r&&!(e._objFlags&cc.Object.Flags.DontSave)){t&&r(e);for(let t=0;t<e.children.length;t++){let i=e.children[t];r(i),i.children.length>0&&this._traverse(i,r,!1)}}}_generateWireframeVB(e,r){const t=new cc_1.Vec3,i=new cc_1.Vec3,n=new cc_1.Vec2,o=e.length/3,s=[],c=[[0,1],[0,0],[1,0]],a=[];for(let l=0;l<o;l++)cc_1.Vec3.fromArray(t,e,3*l),r&&cc_1.Vec3.fromArray(i,r,3*l),cc_1.Vec3.scaleAndAdd(t,t,cc_1.Vec3.normalize(i,i),this.extrude),cc_1.Vec3.toArray(s,t,3*l),cc_1.Vec2.fromArray(n,c[(l+1)%3]),cc_1.Vec2.toArray(a,n,2*l);return{vertices:s,uvs:a}}_generateWireframeIB(e){const r=[],t=e.length/3;for(let i=0;i<t;i++){const t=e[3*i+0],n=e[3*i+1],o=e[3*i+2];r.push(t,n,n,o,o,t)}return r}applyScene(e=WireframeMode.LINE,r=[255,255,255,255]){e=parseInt(e),this.currMode=e,this.color=r;const t=new cc_1.Color(...r);this._traverse(this.scene,e=>{e!==this.scene&&e!==cce.backgroundNode&&e!==cce.foregroundNode&&this._create(e,this.currMode,t)})}setColor(e=[255,255,255,255]){this.color=e;const r=new cc_1.Color(...e);this.material.passes[0].setUniform(this.handleColor,r),cce.Engine.repaintInEditMode(),cce.GameView.repaint()}setMode(e=WireframeMode.LINE){this.applyScene(e,this.color),cce.Engine.repaintInEditMode(),cce.GameView.repaint()}_getTerrainAttrs(e){const r=this.blockCount[e.node.uuid]||[1,1],t=r[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY,i=r[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY,n=[t,i];n[0]+=1,n[1]+=1;const o=new Float32Array(3*n[0]*n[1]),s=new Float32Array(3*n[0]*n[1]);let c=0,a=0;for(let r=0;r<n[1];++r)for(let t=0;t<n[0];++t){const i=t,n=r,l=e.getPosition(i,n),d=e.getNormal(i,n);o[c++]=l.x,o[c++]=l.y,o[c++]=l.z,s[a++]=d.x,s[a++]=d.y,s[a++]=d.z}const l=new Uint16Array(t*i*6);let d=0;for(let e=0;e<i;++e)for(let r=0;r<t;++r){const t=e*n[0]+r,i=e*n[0]+r+1,o=(e+1)*n[0]+r,s=(e+1)*n[0]+r+1;l[d++]=t,l[d++]=o,l[d++]=i,l[d++]=i,l[d++]=o,l[d++]=s}return{positions:o,normals:s,indices:l}}_generateMesh(e){let r,t,i,n=new cc.Mesh;if(e instanceof cc_1.Terrain){let n=this._getTerrainAttrs(e);r=n.positions,t=n.normals,i=n.indices}else r=e.mesh.readAttribute(this.primitiveIndex,cc_1.gfx.AttributeName.ATTR_POSITION),t=e.mesh.readAttribute(this.primitiveIndex,cc_1.gfx.AttributeName.ATTR_NORMAL),i=e.mesh.readIndices(this.primitiveIndex);const o=this._generateWireframeVB(r,t);return cc_1.utils.createMesh({positions:o.vertices,indices:this._generateWireframeIB(i),primitiveMode:cc_1.gfx.PrimitiveMode.LINE_LIST},n,{calculateBounds:!0}),n}_getWireframeInChild(e){for(let r=0;r<e.children.length;r++)if(e.children[r]instanceof wireframe_1.default)return e.children[r];return null}_onHierarchyChanged(e){e.on(event_enum_1.NodeEventType.ACTIVE_IN_HIERARCHY_CHANGE,e=>{e.activeInHierarchy&&this._nodeChildrenActive(e,!0)})}generateWireframe(e){const r=e.mesh?e.mesh.subMeshCount:0,t=e.mesh.renderingSubMeshes;let i=r;if(t&&r)for(let n=0;n<r;++n){const o=e.getRenderMaterial(n),s=t[n];if(s&&e.model){let t=this._generateMesh(s).renderingSubMeshes[0],c=new cc_1.RenderingSubMesh(s.vertexBuffers,s.attributes,cc_1.gfx.PrimitiveMode.LINE_LIST);c.indexBuffer=t.indexBuffer,!_setMaterial&&(_setMaterial=e.setMaterial),e.setMaterial=setMaterial.bind(e),e.model instanceof cc.renderer.models.SkinningModel||(e.model.initSubModel=initSubModel.bind(e.model)),this.currMode!==WireframeMode.LINE?(e.model.initSubModel(n,s,o),this.currMode===WireframeMode.NONE?e.model.initSubModel(i,s,o,r):e.model.initSubModel(i,c,this.material,r)):(e.model.initSubModel(n,c,this.material),e.model.initSubModel(i,c,this.material,r)),i++}}}_create(e,r=WireframeMode.LINE,t=cc_1.Color.WHITE.clone(),i=!0){const n=this._getWireframeInChild(e);if(i&&this._onHierarchyChanged(e),n){const i=n.getComponent(cc_1.MeshRenderer),o=e.getComponent(cc_1.Terrain)||e.getComponent(cc_1.MeshRenderer);i.mesh=this._generateMesh(o),this.material.setProperty("lineColor",t),r===WireframeMode.NONE?(i.enabled=!1,o.onEnable()):r===WireframeMode.LINE?(o.onDisable(),i.enabled=!0):r===WireframeMode.BLEND&&(o.onEnable(),i.enabled=!0),o.onLoad(),!e.activeInHierarchy&&o.onDisable()}else{let i,n=e.getComponent(cc_1.MeshRenderer),o=e.getComponent(cc_1.Terrain),s=e.getComponent(cc_1.SkinnedMeshRenderer);if(this.material.passes[0].setUniform(this.handleColor,t),o)i=this._generateMesh(o),r===WireframeMode.LINE?o.onDisable():o.onEnable();else{if(s&&s.mesh&&!e.isWireframeNode)return void this.generateWireframe(s);if(!n||!n.mesh||e.isWireframeNode)return;i=this._generateMesh(n),r===WireframeMode.LINE?n.onDisable():n.onEnable()}const c=new wireframe_1.default("WireframeNode");c.layer|=cc_1.Layers.Enum.DEFAULT,c.parent=e;const a=c.addComponent(cc_1.MeshRenderer);a.material=this.material,this.material.passes[0].setUniform(this.handleColor,t),a.mesh=i,r===WireframeMode.NONE&&(a.enabled=!1)}}open(e,r=WireframeMode.LINE,t=[255,255,255,255]){if(!e)return;const i=new cc_1.Color(...t),n=cce.Node.query(e);n&&this._create(n,r,i)}close(e){this.open(e,WireframeMode.NONE)}}const modelWireframe=new ModelWireframe;exports.default=modelWireframe;