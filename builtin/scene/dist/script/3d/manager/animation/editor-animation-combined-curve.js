"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,i)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var i=function(e){return(i=Object.getOwnPropertyNames||function(e){var t,r=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&__createBinding(t,e,r[a]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),editor_animation_curve_1=__importDefault(require("./editor-animation-curve")),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),utils_1=require("./utils"),uniform_handler_1=require("./uniform-handler"),dumpEncode=__importStar(require("../../../export/dump/encode"));class EditorAnimationCombinedCurve extends editor_animation_curve_base_1.default{get maxPartNumber(){return this._maxPartNumber}set maxPartNumber(e){this._maxPartNumber=e}canMerge=!0;_partEditorAnimCurves=[];_maxPartNumber=0;get curveInfo(){return this._curveInfo}set curveInfo(e){super.curveInfo=e}constructor(e,t){super(),this._node=e,this._clipData=t}updateType(t){t&&(this._curveInfo.type=t,this._partEditorAnimCurves.forEach(e=>{e.curveInfo.combinedType=t}))}async getDumpData(){await this.updateCurveData();var e,t=utils_1.utils.dumpKeyframeData(this._keyframeData);let r=!1;return this._partEditorAnimCurves&&0<this._partEditorAnimCurves.length&&(e=this._partEditorAnimCurves[0].curveInfo.type?.value,r=utils_1.utils.isTypeSupportCurve(e)),{nodePath:this._curveInfo.nodePath,keyframes:t,displayName:this._curveInfo.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type,isCurveSupport:r}}getClipSample(){return this._clipData.sharedData.sample}getClipDuration(){return this._clipData.sharedData.duration}changeNodePath(e){var t=this._curveInfo.targetPaths;0<t.length&&(t.isHierarchyAt(0)?"/"===e?this._curveInfo.targetPaths=this._curveInfo.targetPaths.slice(1):(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(this._curveInfo.targetPaths.slice(1))):"/"!==e&&(t=e.substr(1),this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(t).append(this._curveInfo.targetPaths))),this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths)}initFromTrack(e,t){this._curveInfo=e,this._partEditorAnimCurves=[];var e=this._curveInfo.type?.value,r=utils_1.utils.getPartsOfType(e);if(r){let a=null;const h=uniform_handler_1.uniformHandler.isUniformCurve(this._curveInfo.valueAdapter);h&&(a=uniform_handler_1.uniformHandler.getValueToArrayIndexMapByType(e)),this.maxPartNumber=r.length,r.forEach(e=>{var t,r=this.curveInfo.targetPaths.slice().toProperty(e),r={nodePath:this._curveInfo.nodePath,propKey:this._curveInfo.propKey+"."+e,combinedType:this._curveInfo.type,type:{value:"Number"},targetPaths:r,partName:e,displayName:this._curveInfo.displayName+"."+e,propName:this._curveInfo.propName,compName:this._curveInfo.compName},e=(h&&(r.targetPaths=this._curveInfo.targetPaths,t=utils_1.utils.cloneCCClass(this._curveInfo.valueAdapter),a&&(e=a[e],t.channelIndex=e),r.valueAdapter=t),new editor_animation_curve_1.default(this._node,this._clipData));e.curveInfo=r,(e.parentCurve=this)._partEditorAnimCurves.push(e)});var i=t.channels();for(let e=0;e<this._partEditorAnimCurves.length;e++)if(e<i.length){var n=this._partEditorAnimCurves[e],s=i[e].curve;if(n.partName&&s){var u,o,l=[];for([u,o]of s.keyframes())l.push({frame:Math.round(u*this._clipData.sharedData.sample),value:o.value,inTangent:o.leftTangent,inTangentWeight:o.leftTangentWeight,outTangent:o.rightTangent,outTangentWeight:o.rightTangentWeight,interpMode:o.interpolationMode,tangentWeightMode:o.tangentWeightMode,easingMethod:o.easingMethod,broken:o.__editorExtras__&&o.__editorExtras__.broken});n.keyframeData=l}}this.updateCurveData()}}async updateCurveData(){let n=new Map;await this.iteratorPartAnimCurves(async(e,t)=>{var r=e.keyframeData;if(r)for(let e=0;e<r.length;e++){var a=r[e];if(!n.has(a.frame)){let e=await utils_1.utils.getValueFrom(this._node,this.propData);var i={value:e=void 0===e&&this.propData.type?utils_1.utils.getDefaultValue(this.propData.type.value):e,keyNumber:0,isEasingMethodSame:!0};n.set(a.frame,i)}i=n.get(a.frame);i&&(i.keyNumber++,void 0!==i.value)&&null!==i.value&&(i.value[t]=a.value)}}),n=new Map([...n.entries()].sort((e,t)=>e[0]-t[0])),this._keyframeData=[],n.forEach((e,t)=>{t={frame:t,value:e.value};this._keyframeData.push(t)}),this.canMerge=!0;var t=Array.from(n.values());for(let e=0;e<t.length;e++){var r=t[e];if(r.keyNumber!==this.maxPartNumber||!r.isEasingMethodSame){this.canMerge=!1;break}}this._partEditorAnimCurves.forEach(e=>{e.isActive=!this.canMerge})}separateDataIntoParts(){this._partEditorAnimCurves=[];var e=this._curveInfo.type?.value,t=utils_1.utils.getPartsOfType(e);if(t){let a=null;const o=uniform_handler_1.uniformHandler.isUniformCurve(this._curveInfo.valueAdapter);o&&(a=uniform_handler_1.uniformHandler.getValueToArrayIndexMapByType(e)),this.maxPartNumber=t.length,t.forEach(e=>{var t,r=this.curveInfo.targetPaths.slice().toProperty(e),r={nodePath:this._curveInfo.nodePath,propKey:this._curveInfo.propKey+"."+e,combinedType:this._curveInfo.type,type:{value:"Number"},targetPaths:r,partName:e,displayName:this._curveInfo.displayName+"."+e,propName:this._curveInfo.propName,compName:this._curveInfo.compName},e=(o&&(r.targetPaths=this._curveInfo.targetPaths,t=utils_1.utils.cloneCCClass(this._curveInfo.valueAdapter),a&&(e=a[e],t.channelIndex=e),r.valueAdapter=t),new editor_animation_curve_1.default(this._node,this._clipData));e.curveInfo=r,(e.parentCurve=this)._partEditorAnimCurves.push(e)});for(let e=0;e<this._partEditorAnimCurves.length;e++){var r=this._partEditorAnimCurves[e],i=r.partName;if(i){var n=[];for(let t=0;t<this._keyframeData.length;t++){var s=this._keyframeData[t],u=s.value;let e=0;void 0!==u&&(e=u[i]),n.push({frame:s.frame,value:e})}r.keyframeData=n}}}}addPartEditorAnimCurve(e){this._partEditorAnimCurves.push(e),this.maxPartNumber<this._partEditorAnimCurves.length&&(this.maxPartNumber=this._partEditorAnimCurves.length)}getPartEditorAnimCurves(){return this._partEditorAnimCurves}async iteratorPartAnimCurves(t){for(let e=0;e<this._partEditorAnimCurves.length;e++){var r=this._partEditorAnimCurves[e],a=r.partName;a&&await t(r,a)}}hasKey(t){let r=!1;return this._partEditorAnimCurves.forEach(e=>{e.hasKey(t)&&(r=!0)}),r}async createKey(a=0,i){let n=!0;return await this.iteratorPartAnimCurves(async(e,t)=>{let r;i&&i.newValue&&(r={newValue:i.newValue[t]}),await e.createKey(a,r)||(n=!1)}),this._isDirty=!0,n}async moveKeys(a,i){let n=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(a);const r=[];t&&0<t.length&&(t.forEach(e=>{e=a.indexOf(e);r.push(i[e])}),e.moveKeys(t,r)||(n=!1))}),this._isDirty=!0,n}async removeKey(r){let a=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(r);t&&0<t.length&&(e.removeKey(t)||(a=!1))}),this._isDirty=!0,a}async updateKey(r){let a=!0;return await this.iteratorPartAnimCurves(async e=>{var t=e.getValidKeys(r);t&&0<t.length&&(await e.updateKey(t)||(a=!1))}),this._isDirty=!0,a}async copyKeysTo(r,a){let i=!0;return await this.iteratorPartAnimCurves(async e=>{var t=e.getValidKeys(r);t&&0<t.length&&(await e.copyKeysTo(t,a)||(i=!1))}),this._isDirty=!0,i}async spacingKeys(r,a){let i=!0;return this._partEditorAnimCurves.forEach(e=>{var t=e.getValidKeys(r);t&&0<t.length&&(e.spacingKeys(t,a)||(i=!1))}),this._isDirty=!0,i}async clearKeys(){let t=!0;return this._partEditorAnimCurves.forEach(e=>{e.clearKeys()||(t=!1)}),this._isDirty=!0,t}async modifyCurveOfKey(t,r){let a=!0;return this._partEditorAnimCurves.forEach(e=>{!e.hasKey(t)||e.modifyCurveOfKey(t,r)||(a=!1)}),this._isDirty=!0,a}async getPropValueAtFrame(i){let t=null;var r=this.propData;if(0===this._keyframeData.length){let e=await utils_1.utils.getValueFrom(this._node,r);null!==(e=null!==e&&void 0!==e?e:utils_1.utils.getDefaultValue(r.type?.value))&&void 0!==e&&(t=dumpEncode.encodeObject(e,{default:void 0}))}else{const n=this.getClipSample();let a=await utils_1.utils.getValueFrom(this._node,r);null!==a&&void 0!==a||(a=utils_1.utils.getDefaultValue(r.type?.value)),await this.iteratorPartAnimCurves(async(e,t)=>{var e=e.keyframeData,r=new cc_1.RealCurve;r.assignSorted(e.map(e=>[e.frame/n,{value:e.value,interpolationMode:e.interpMode,leftTangent:e.inTangent,rightTangent:e.outTangent,leftTangentWeight:e.inTangentWeight,rightTangentWeight:e.outTangentWeight,tangentWeightMode:e.tangentWeightMode}])),a[t]=r.evaluate(i/n)}),null!==(a=null!==a&&void 0!==a?a:utils_1.utils.getDefaultValue(r.type?.value))&&void 0!==a&&(t=dumpEncode.encodeObject(a,{default:void 0}))}return t}}exports.default=EditorAnimationCombinedCurve;