"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),editor_animation_curve_1=__importDefault(require("./editor-animation-curve")),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),utils_1=require("./utils"),uniform_handler_1=require("./uniform-handler");class EditorAnimationCombinedCurve extends editor_animation_curve_base_1.default{constructor(t,e){super(),this.canMerge=!0,this._partEditorAnimCurves=[],this._maxPartNumber=0,this._commonTargetForPart=null,this._node=t,this._clipData=e}get maxPartNumber(){return this._maxPartNumber}set maxPartNumber(t){this._maxPartNumber=t}get curveInfo(){return this._curveInfo}set curveInfo(t){super.curveInfo=t,this._commonTargetForPart={modifiers:this._curveInfo.targetPaths,valueAdapter:this._curveInfo.valueAdapter}}updateType(t){t&&(this._curveInfo.type=t,this._partEditorAnimCurves.forEach(e=>{e.curveInfo.combinedType=t}))}async getDumpData(){await this.updateCurveData();const t=utils_1.utils.dumpKeyframeData(this._keyframeData);return{nodePath:this._curveInfo.nodePath,keyframes:t,displayName:this._curveInfo.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type}}getClipSample(){return this._clipData.sharedData.sample}getClipDuration(){return this._clipData.sharedData.duration}changeNodePath(t){if(this._curveInfo.targetPaths.length>0){const e=this._curveInfo.targetPaths[0];if(utils_1.isHierarchyPath(e))if("/"===t)this._curveInfo.targetPaths.splice(0,1);else{const r=t.substr(1);e.path=r}else if("/"!==t){const e=t.substr(1);this._curveInfo.targetPaths.unshift(new cc_1.animation.HierarchyPath(e))}}this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths)}async updateCurveData(){let t=new Map;await this.iteratorPartAnimCurves(async(e,r)=>{const a=e.keyframeData;if(a)for(let e=0;e<a.length;e++){const i=a[e];if(!t.has(i.frame)){let e=await utils_1.utils.getValueFrom(this._node,this.propData);void 0===e&&this.propData.type&&(e=utils_1.utils.getDefaultValue(this.propData.type.value));const r={value:e,keyNumber:0,easingMethod:i.easingMethod,isEasingMethodSame:!0};t.set(i.frame,r)}const s=t.get(i.frame);s&&(s.keyNumber++,void 0!==s.value&&(s.value[r]=i.value),s.easingMethod!==i.easingMethod&&(s.isEasingMethodSame=!1))}}),t=new Map([...t.entries()].sort((t,e)=>t[0]-e[0])),this._keyframeData=[],t.forEach((t,e)=>{const r={frame:e,value:t.value,easingMethod:t.easingMethod};this._keyframeData.push(r)}),this.canMerge=!0;const e=Array.from(t.values());for(let t=0;t<e.length;t++){const r=e[t];if(r.keyNumber!==this.maxPartNumber||!r.isEasingMethodSame){this.canMerge=!1;break}}this._partEditorAnimCurves.forEach(t=>{t.isActive=!this.canMerge})}separateDataIntoParts(){var t;this._partEditorAnimCurves=[];const e=null===(t=this._curveInfo.type)||void 0===t?void 0:t.value,r=utils_1.utils.getPartsOfType(e);if(!r)return;let a=null;const i=uniform_handler_1.uniformHandler.isUniformCombinedCurve(this._curveInfo.valueAdapter);i&&(a=uniform_handler_1.uniformHandler.getValueToArrayIndexMapByType(e)),this.maxPartNumber=r.length,r.forEach(t=>{const e={nodePath:this._curveInfo.nodePath,propKey:this._curveInfo.propKey+"."+t,combinedType:this._curveInfo.type,type:{value:"Number"},targetPaths:[t],partName:t,displayName:this._curveInfo.displayName+"."+t,propName:this._curveInfo.propName,compName:this._curveInfo.compName};if(i){e.targetPaths=this._curveInfo.targetPaths;const r=utils_1.utils.cloneCCClass(this._curveInfo.valueAdapter);if(a){const e=a[t];r.channelIndex=e}e.valueAdapter=r}else e.commonTarget=this._commonTargetForPart;const r=new editor_animation_curve_1.default(this._node,this._clipData);r.curveInfo=e,this._partEditorAnimCurves.push(r)});for(let t=0;t<this._partEditorAnimCurves.length;t++){const e=this._partEditorAnimCurves[t],r=e.partName;if(r){const t=[];for(let e=0;e<this._keyframeData.length;e++){const a=this._keyframeData[e],i=a.value;let s=0;void 0!==i&&(s=i[r]),t.push({frame:a.frame,value:s,easingMethod:a.easingMethod})}e.keyframeData=t}}}addPartEditorAnimCurve(t){this._partEditorAnimCurves.push(t),this.maxPartNumber<this._partEditorAnimCurves.length&&(this.maxPartNumber=this._partEditorAnimCurves.length)}getPartEditorAnimCurves(){return this._partEditorAnimCurves}async iteratorPartAnimCurves(t){for(let e=0;e<this._partEditorAnimCurves.length;e++){const r=this._partEditorAnimCurves[e],a=r.partName;a&&await t(r,a)}}hasKey(t){let e=!1;return this._partEditorAnimCurves.forEach(r=>{r.hasKey(t)&&(e=!0)}),e}async createKey(t=0,e){let r=!0;return await this.iteratorPartAnimCurves(async(a,i)=>{let s;e&&e.newValue&&(s={newValue:e.newValue[i]}),await a.createKey(t,s)||(r=!1)}),this._isDirty=!0,r}async moveKeys(t,e){let r=!0;return this._partEditorAnimCurves.forEach(a=>{const i=a.getValidKeys(t),s=[];i&&i.length>0&&(i.forEach(r=>{const a=t.indexOf(r);s.push(e[a])}),a.moveKeys(i,s)||(r=!1))}),this._isDirty=!0,r}async removeKey(t){let e=!0;return this._partEditorAnimCurves.forEach(r=>{const a=r.getValidKeys(t);a&&a.length>0&&(r.removeKey(a)||(e=!1))}),this._isDirty=!0,e}async updateKey(t){let e=!0;return await this.iteratorPartAnimCurves(async r=>{const a=r.getValidKeys(t);a&&a.length>0&&(await r.updateKey(a)||(e=!1))}),this._isDirty=!0,e}async copyKeysTo(t,e){let r=!0;return await this.iteratorPartAnimCurves(async a=>{const i=a.getValidKeys(t);i&&i.length>0&&(await a.copyKeysTo(i,e)||(r=!1))}),this._isDirty=!0,r}async spacingKeys(t,e){let r=!0;return this._partEditorAnimCurves.forEach(a=>{const i=a.getValidKeys(t);i&&i.length>0&&(a.spacingKeys(i,e)||(r=!1))}),this._isDirty=!0,r}async clearKeys(){let t=!0;return this._partEditorAnimCurves.forEach(e=>{e.clearKeys()||(t=!1)}),this._isDirty=!0,t}async modifyCurveOfKey(t,e){let r=!0;return this._partEditorAnimCurves.forEach(a=>{a.hasKey(t)&&(a.modifyCurveOfKey(t,e)||(r=!1))}),this._isDirty=!0,r}}exports.default=EditorAnimationCombinedCurve;