"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,n){void 0===n&&(n=a),e[n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),dumpEncode=__importStar(require("../../../../utils/dump/encode")),type_defines_1=require("./type-defines"),utils_1=require("./utils");class EditorAnimationCurveBase{constructor(){this._keyframeData=[],this._isDirty=!1,this._preExtrap=cc_1.ExtrapolationMode.CLAMP,this._postExtrap=cc_1.ExtrapolationMode.CLAMP}set node(e){this._node=e}get dirty(){return this._isDirty}set dirty(e){this._isDirty=e}get curveInfo(){return this._curveInfo}set curveInfo(e){this._curveInfo=e}get keyframeData(){return this._keyframeData}set keyframeData(e){this._keyframeData=e}get nodePath(){return this._curveInfo.nodePath}get propKey(){return this._curveInfo.propKey}get propData(){return{combinedType:this._curveInfo.combinedType,type:this._curveInfo.type,targetPaths:this._curveInfo.targetPaths,valueAdapter:this._curveInfo.valueAdapter,commonTarget:this._curveInfo.commonTarget}}get preExtrap(){return this._preExtrap}set preExtrap(e){this._preExtrap=e}get postExtrap(){return this._postExtrap}set postExtrap(e){this._postExtrap=e}getClipSample(){return this._clipData.sharedData.sample}getClipDuration(){return this._clipData.sharedData.duration}initFromCurve(e,t){if(this._keyframeData=[],this.curveInfo=e,!t)return;const a=[...t.times()];if(a.length<=0)return;const n=[...t.values()];for(let e=0;e<a.length;e++){const r=a[e],i={frame:Math.round(r*this._clipData.sharedData.sample),value:0};if(t instanceof cc_1.RealCurve){const t=n[e];i.value=t.value,i.interpMode=t.interpolationMode,i.inTangent=t.leftTangent,i.inTangentWeight=t.leftTangentWeight,i.outTangent=t.rightTangent,i.outTangentWeight=t.rightTangentWeight,i.tangentWeightMode=t.tangentWeightMode,i.easingMethod=t.easingMethod}else if(t instanceof cc_1.QuatCurve){const t=n[e];i.value=t.value}else{const t=n[e];i.value=t}this._keyframeData.push(i)}(t instanceof cc_1.RealCurve||t instanceof cc_1.QuatCurve)&&(this.preExtrap=t.preExtrapolation,this.postExtrap=t.postExtrapolation)}async getPropValueAtFrame(e){var t,a;let n=null;const r=this.propData;if(0===this._keyframeData.length){let e=await utils_1.utils.getValueFrom(this._node,r);null!==e&&void 0!==e||(e=utils_1.utils.getDefaultValue(null===(t=r.type)||void 0===t?void 0:t.value)),null!==e&&void 0!==e&&(n=dumpEncode.encodeObject(e,{default:null}))}else{const t=this.getClipSample(),i=new cc_1.RealCurve;i.assignSorted(this._keyframeData.map(e=>[e.frame/t,{value:e.value,interpolationMode:e.interpMode,leftTangent:e.inTangent,rightTangent:e.outTangent,leftTangentWeight:e.inTangentWeight,rightTangentWeight:e.outTangentWeight,tangentWeightMode:e.tangentWeightMode}]));let o=i.evaluate(e/t);null!==o&&void 0!==o||(o=utils_1.utils.getDefaultValue(null===(a=r.type)||void 0===a?void 0:a.value)),null!==o&&void 0!==o&&(n=dumpEncode.encodeObject(o,{default:null}))}return n}async decodeDump(e){this._curveInfo.nodePath=e.nodePath,this._curveInfo.propKey=e.key,this._curveInfo.type=e.type,this._keyframeData=await utils_1.utils.getKeyframeDataFromDump(e.keyframes)}autoSetTangents(){var e;if("Number"===(null===(e=this._curveInfo.type)||void 0===e?void 0:e.value))for(let e=0;e<this._keyframeData.length;e++){const t=this._keyframeData[e];let a=t.inTangent,n=t.outTangent,r=t,i=t,o=t,u=!1;if(0===e?e<this._keyframeData.length-1&&t.tangentMode===type_defines_1.TangentMode.AUTO&&(n=0,t.interpMode===cc_1.RealInterpolationMode.CUBIC&&(i=o=this._keyframeData[e+1],u=!0)):e<this._keyframeData.length-1?(r=this._keyframeData[e-1],t.interpMode===cc_1.RealInterpolationMode.CUBIC&&t.tangentMode===type_defines_1.TangentMode.AUTO?(o=this._keyframeData[e+1],u=!0):r.interpMode!==cc_1.RealInterpolationMode.CONSTANT&&t.interpMode!==cc_1.RealInterpolationMode.CONSTANT||(n=0,r.interpMode!==cc_1.RealInterpolationMode.CUBIC&&(a=0))):t.interpMode===cc_1.RealInterpolationMode.CUBIC&&t.tangentMode===type_defines_1.TangentMode.AUTO&&(a=0,this._keyframeData.length>1&&(r=this._keyframeData[e-1],u=!0)),u){const e=this.getClipSample(),t=this.calculateCurveTangent(r.frame/e,r.value,i.frame/e,i.value,o.frame/e,o.value);n=a=null!==t&&void 0!==t?t:a}}}calculateCurveTangent(e,t,a,n,r,i){let o;if(utils_1.utils.isNumber(n)){o=n-t+(i-n),o/=r-e}return o}}exports.default=EditorAnimationCurveBase;