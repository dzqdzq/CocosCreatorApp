"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,i)}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorAnimationCurve=void 0;const cc_1=require("cc"),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),utils_1=require("./utils"),dumpEncode=__importStar(require("../../../export/dump/encode"));class EditorAnimationCurve extends editor_animation_curve_base_1.default{get parentCurve(){return this._parentCurve}set parentCurve(e){this._parentCurve=e}get isPartCurve(){return this._parentCurve}get partName(){return this._curveInfo.partName}get targetPaths(){return this._curveInfo.targetPaths}get combinedPropKey(){const e=this._curveInfo.propKey.lastIndexOf(".");return this._curveInfo.propKey.substring(0,e)}get combinedCurveKeyData(){return null}get combinedDisplayName(){const e=this._curveInfo.displayName.lastIndexOf(".");return this._curveInfo.displayName.substring(0,e)}get displayName(){let e=this._curveInfo.displayName;if(this.isPartCurve){let t=this._curveInfo.displayName.lastIndexOf(".");const a=this._curveInfo.displayName.substring(0,t),r=this._curveInfo.displayName.substring(t+1);let i="";(t=a.lastIndexOf("."))>=0&&(i=a.substring(t+1)+"."),e=i+r}return e}constructor(e,t){super(),this._parentCurve=null,this.isActive=!0,this._node=e,this._clipData=t}async getDumpData(){var e;const t=utils_1.utils.dumpKeyframeData(this._keyframeData),a=null===(e=this._curveInfo.type)||void 0===e?void 0:e.value,r=utils_1.utils.isTypeSupportCurve(a);return{nodePath:this._curveInfo.nodePath,keyframes:t,displayName:this.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type,preExtrap:this.preExtrap,postExtrap:this.postExtrap,isCurveSupport:r}}getCompName(){return this._curveInfo.compName}getPropName(){return this._curveInfo.propName}changeNodePath(e){let t=null;if((t=this._curveInfo.targetPaths)&&t.length>0)if(t.isHierarchyAt(0))if("/"===e)this._curveInfo.targetPaths=t.slice(1);else{const a=e.substr(1);this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(a).append(t.slice(1))}else if("/"!==e){const a=e.substr(1);this._curveInfo.targetPaths=(new cc_1.animation.TrackPath).toHierarchy(a).append(t)}this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths)}queryKeyIndex(e){if(!this._keyframeData)return-1;for(let t=0;t<this._keyframeData.length;t++){if(this._keyframeData[t].frame===e)return t}return-1}queryKeyframe(e){if(!this._keyframeData)return null;for(let t=0;t<this._keyframeData.length;t++){const a=this._keyframeData[t];if(a.frame===e)return a}return null}getValidKeys(e){if(!this._keyframeData)return null;const t=[];for(let a=0;a<this._keyframeData.length;a++){const r=this._keyframeData[a].frame;e.includes(r)&&t.push(r)}return t}hasKey(e){return null!==this.queryKeyframe(e)}async createKey(e=0,t){var a;const r=this.propData,i=await utils_1.utils.getValueFrom(this._node,r,t),s=this.queryKeyframe(e);if(s)return s.value=i,t&&utils_1.utils.copyCurveData(t,s),!0;let n=0;for(n=0;n<this._keyframeData.length&&!(this._keyframeData[n].frame>e);n++);const u={frame:e,value:i,interpMode:cc_1.RealInterpolationMode.LINEAR};return utils_1.utils.isTypeSupportCurve(null===(a=r.type)||void 0===a?void 0:a.value)&&(u.inTangent=0,u.inTangentWeight=1,u.outTangent=0,u.outTangentWeight=1,u.tangentWeightMode=cc_1.TangentWeightMode.NONE,u.tangentMode=0),t&&utils_1.utils.copyCurveData(t,u),this._keyframeData.splice(n,0,u),this._isDirty=!0,!0}async moveKeys(e,t){if(!this._keyframeData)return!1;const a=[];for(let t=0;t<e.length;t++){const r=e[t],i=this.queryKeyIndex(r);if(i<0)return!1;a.push(this._keyframeData[i]),this._keyframeData.splice(i,1)}for(let e=0;e<a.length;e++){const r=a[e];let i=r.frame+t[e];i<0&&(i=0);let s=0,n=!1,u=!1;if(this._keyframeData.length>0){for(let e=0;e<this._keyframeData.length;e++){const t=this._keyframeData[e].frame;if(t>=i){s=e,n=!0,t===i&&(u=!0);break}}n||(i<=this._keyframeData[0].frame?s=0:i>this._keyframeData[this._keyframeData.length-1].frame&&(s=this._keyframeData.length))}const o=u?1:0,l={frame:i,value:r.value};utils_1.utils.copyCurveData(r,l),this._keyframeData.splice(s,o,l)}return this._isDirty=!0,!0}async removeKey(e){return e.forEach(e=>{const t=this.queryKeyIndex(e);t<0||this._keyframeData.splice(t,1)}),this._isDirty=!0,!0}async updateKey(e){const t=this.propData;for(let a=0;a<e.length;a++){const r=e[a],i=this.queryKeyframe(r);if(!i)return!1;const s=await utils_1.utils.getValueFrom(this._node,t,null);i.value=s}return this._isDirty=!0,!0}async copyKeysTo(e,t){for(let a=0;a<e.length;a++){const r=e[a],i=this.queryKeyframe(r);if(i){const a={newValue:i.value};utils_1.utils.copyCurveData(i,a),await this.createKey(t+r-e[0],a)}}return this._isDirty=!0,!0}async spacingKeys(e,t){if(e.sort((e,t)=>e-t),e.length>1){const a=e[0],r=[],i=[];for(let s=1;s<e.length;s++)r.push(e[s]),i.push(a+s*t-e[s]);return this.moveKeys(r,i),this._isDirty=!0,!0}return!1}async clearKeys(){return this._keyframeData=[],!0}async modifyCurveOfKey(e,t){const a=this.queryKeyframe(e);return!!a&&(utils_1.utils.copyCurveData(t,a),this._isDirty=!0,!0)}getCurveDuration(){let e=0;if(this._keyframeData&&this._keyframeData.length>0){const t=this._keyframeData[this._keyframeData.length-1].frame,a=this.getCompName(),r=this.getPropName(),i=this.getClipSample();e=a===cc_1.js.getClassName(cc_1.Sprite)&&"spriteFrame"===r?(t+1)/i:t/i}return e}async getPropValueAtFrame(e){var t,a;let r=null;const i=this.propData;if(0===this._keyframeData.length){let e=await utils_1.utils.getValueFrom(this._node,i);null!==e&&void 0!==e||(e=utils_1.utils.getDefaultValue(null===(t=i.type)||void 0===t?void 0:t.value)),null!==e&&void 0!==e&&(r=dumpEncode.encodeObject(e,{default:void 0}))}else{const t=this.getClipSample();let s=null;switch(this.curveInfo.type.value){case"cc.Quat":(s=new cc_1.QuatCurve).assignSorted(this._keyframeData.map(e=>[e.frame/t,{value:e.value}])),s.preExtrapolation=this.preExtrap,s.postExtrapolation=this.postExtrap;break;case"cc.Number":case"Number":case"Integer":case"Float":(s=new cc_1.RealCurve).assignSorted(this._keyframeData.map(e=>[e.frame/t,{value:e.value,interpolationMode:e.interpMode,leftTangent:e.inTangent,rightTangent:e.outTangent,leftTangentWeight:e.inTangentWeight,rightTangentWeight:e.outTangentWeight,tangentWeightMode:e.tangentWeightMode}])),s.preExtrapolation=this.preExtrap,s.postExtrapolation=this.postExtrap;break;default:(s=new cc_1.ObjectCurve).assignSorted(this._keyframeData.map(e=>[e.frame/t,e.value]))}let n=s.evaluate(e/t);null!==n&&void 0!==n||(n=utils_1.utils.getDefaultValue(null===(a=i.type)||void 0===a?void 0:a.value)),null!==n&&void 0!==n&&(r=dumpEncode.encodeObject(n,{default:void 0}))}return r}}exports.EditorAnimationCurve=EditorAnimationCurve,exports.default=EditorAnimationCurve;