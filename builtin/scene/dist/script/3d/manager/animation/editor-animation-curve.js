"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),editor_animation_curve_base_1=__importDefault(require("./editor-animation-curve-base")),uniform_handler_1=require("./uniform-handler"),utils_1=require("./utils");class EditorAnimationCurve extends editor_animation_curve_base_1.default{constructor(e,t){super(),this.isActive=!0,this._node=e,this._clipData=t}get isPartCurve(){return void 0!==this._curveInfo.commonTarget||!!uniform_handler_1.uniformHandler.isUniformPartCurve(this._curveInfo.valueAdapter)}get partName(){return this._curveInfo.partName}get targetPaths(){return this._curveInfo.targetPaths}get combinedPropKey(){const e=this._curveInfo.propKey.lastIndexOf(".");return this._curveInfo.propKey.substring(0,e)}get combinedCurveKeyData(){if(void 0!==this._curveInfo.commonTarget){const e=this._curveInfo.commonTarget;return{targetPaths:e.modifiers,valueAdapter:e.valueAdapter}}return null}get combinedDisplayName(){const e=this._curveInfo.displayName.lastIndexOf(".");return this._curveInfo.displayName.substring(0,e)}get displayName(){let e=this._curveInfo.displayName;if(this.isPartCurve){let t=this._curveInfo.displayName.lastIndexOf(".");const r=this._curveInfo.displayName.substring(0,t),a=this._curveInfo.displayName.substring(t+1);let s="";(t=r.lastIndexOf("."))>=0&&(s=r.substring(t+1)+"."),e=s+a}return e}async getDumpData(){const e=utils_1.utils.dumpKeyframeData(this._keyframeData);return{nodePath:this._curveInfo.nodePath,keyframes:e,displayName:this.displayName,key:this._curveInfo.propKey,type:this._curveInfo.type}}getCompName(){return this._curveInfo.compName}getPropName(){return this._curveInfo.propName}changeNodePath(e){let t=null;if((t=this.isPartCurve&&this._curveInfo.commonTarget?this._curveInfo.commonTarget.modifiers:this._curveInfo.targetPaths).length>0){const r=t[0];if(utils_1.isHierarchyPath(r))if("/"===e)t.splice(0,1);else{const t=e.substr(1);r.path=t}else if("/"!==e){const r=e.substr(1);t.unshift(new cc_1.animation.HierarchyPath(r))}}this._curveInfo.nodePath=utils_1.utils.getNodePath(this._curveInfo.targetPaths,this._curveInfo.commonTarget)}queryKeyIndex(e){if(!this._keyframeData)return-1;for(let t=0;t<this._keyframeData.length;t++){if(this._keyframeData[t].frame===e)return t}return-1}queryKeyframe(e){if(!this._keyframeData)return null;for(let t=0;t<this._keyframeData.length;t++){const r=this._keyframeData[t];if(r.frame===e)return r}return null}getValidKeys(e){if(!this._keyframeData)return null;const t=[];for(let r=0;r<this._keyframeData.length;r++){const a=this._keyframeData[r].frame;e.includes(a)&&t.push(a)}return t}hasKey(e){return null!==this.queryKeyframe(e)}async createKey(e=0,t){const r=this.propData,a=await utils_1.utils.getValueFrom(this._node,r,t),s=this.queryKeyframe(e);if(s)return s.value=a,(null===t||void 0===t?void 0:t.easingMethod)&&(s.easingMethod=t.easingMethod),!0;let i=0;for(i=0;i<this._keyframeData.length&&!(this._keyframeData[i].frame>e);i++);const n={frame:e,value:a,easingMethod:null===t||void 0===t?void 0:t.easingMethod};return this._keyframeData.splice(i,0,n),this._isDirty=!0,!0}async moveKeys(e,t){if(!this._keyframeData)return!1;const r=[];for(let t=0;t<e.length;t++){const a=e[t],s=this.queryKeyIndex(a);if(s<0)return!1;r.push(this._keyframeData[s]),this._keyframeData.splice(s,1)}for(let e=0;e<r.length;e++){const a=r[e];let s=a.frame+t[e];s<0&&(s=0);let i=0,n=!1,o=!1;if(this._keyframeData.length>0){for(let e=0;e<this._keyframeData.length;e++){const t=this._keyframeData[e].frame;if(t>=s){i=e,n=!0,t===s&&(o=!0);break}}n||(s<=this._keyframeData[0].frame?i=0:s>this._keyframeData[this._keyframeData.length-1].frame&&(i=this._keyframeData.length))}const u=o?1:0;this._keyframeData.splice(i,u,{frame:s,value:a.value,easingMethod:a.easingMethod})}return this._isDirty=!0,!0}async removeKey(e){return e.forEach(e=>{const t=this.queryKeyIndex(e);t<0||this._keyframeData.splice(t,1)}),this._isDirty=!0,!0}async updateKey(e){const t=this.propData;for(let r=0;r<e.length;r++){const a=e[r],s=this.queryKeyframe(a);if(!s)return!1;const i=await utils_1.utils.getValueFrom(this._node,t,null);s.value=i}return this._isDirty=!0,!0}async copyKeysTo(e,t){for(let r=0;r<e.length;r++){const a=e[r],s=this.queryKeyframe(a);if(s){const r={newValue:s.value,easingMethod:s.easingMethod};await this.createKey(t+a-e[0],r)}}return this._isDirty=!0,!0}async spacingKeys(e,t){if(e.sort((e,t)=>e-t),e.length>1){const r=e[0],a=[],s=[];for(let i=1;i<e.length;i++)a.push(e[i]),s.push(r+i*t-e[i]);return this.moveKeys(a,s),this._isDirty=!0,!0}return!1}async clearKeys(){return this._keyframeData=[],!0}async modifyCurveOfKey(e,t){const r=this.queryKeyframe(e);return!!r&&(r.easingMethod=t,this._isDirty=!0,!0)}getCurveDuration(){let e=0;if(this._keyframeData&&this._keyframeData.length>0){const t=this._keyframeData[this._keyframeData.length-1].frame,r=this.getCompName(),a=this.getPropName(),s=this.getClipSample();e=r===cc_1.js.getClassName(cc_1.Sprite)&&"spriteFrame"===a?(t+1)/s:t/s}return e}}exports.default=EditorAnimationCurve;