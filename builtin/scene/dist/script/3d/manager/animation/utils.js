"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isHierarchyPath=exports.utils=void 0;const cc_1=require("cc"),uniform_handler_1=require("./uniform-handler"),dumpEncode=__importStar(require("../../../../utils/dump/encode")),dumpUtil=__importStar(require("../../../../utils/dump/utils")),dumpDecode=__importStar(require("../../../../utils/dump/decode")),node_1=__importDefault(require("../node")),pathUtil=require("path"),{promisify:promisify}=require("util"),propToDisplayNameMap={eulerAngles:"rotation(eulerAngles)",rotation:"rotation(quaternion)"};function generateAnimablePropData(e,t){let n=e;return propToDisplayNameMap[e]&&(n=propToDisplayNameMap[e]),{name:e,key:e,displayName:n,type:{value:t},menuName:n,propData:{targetPaths:(new cc_1.animation.TrackPath).toProperty(e),type:{value:t}}}}const defaultProperties=[generateAnimablePropData("position","cc.Vec3"),generateAnimablePropData("eulerAngles","cc.Vec3"),generateAnimablePropData("rotation","cc.Quat"),generateAnimablePropData("scale","cc.Vec3")],activeProperty=generateAnimablePropData("active","cc.Boolean"),excludeComponentAnimProps={"*":["type","__scriptAsset"],"cc.ParticleSystem":["materials"]},excludeCCClass=["cc.Mesh","cc.ColorOvertimeModule","cc.CurveRange","cc.ForceOvertimeModule","cc.GradientRange","cc.LimitVelocityOvertimeModule","cc.RotationOvertimeModule","cc.SizeOvertimeModule","cc.TextureAnimationModule","cc.VelocityOvertimeModule","cc.ShapeModule","cc.TrailModule","cc.Terrain","cc.TerrainAsset"],valueTypePartMap={"cc.Vec2":["x","y"],"cc.Vec3":["x","y","z"],"cc.Vec4":["x","y","z","w"],"cc.Color":["r","g","b","a"],"cc.Size":["width","height"]},valueTypeParts=Object.keys(valueTypePartMap);function isHierarchyPath(e){return cc_1.animation.isCustomPath(e,cc_1.animation.HierarchyPath)}function isComponentPath(e){return e instanceof cc_1.animation.ComponentPath}function isPropPath(e){return"string"==typeof e}function isElementPath(e){return"number"==typeof e}function getExcludeAnimProps(e){const t=[];return Object.keys(excludeComponentAnimProps).forEach(n=>{if("*"===n)t.concat(excludeComponentAnimProps[n]);else{const a=cc_1.js.getClassByName(n);a&&cc_1.js.isChildClassOf(e,a)&&t.concat(excludeComponentAnimProps[n])}}),t}exports.isHierarchyPath=isHierarchyPath;class AnimationUtil{cloneCCClass(e){let t=null;return e&&(t=cc_1.deserialize(cce.Utils.serialize(e),null,null)),t}getNodePathFromAnimRoot(e,t){let n=null,a=!1;if(e===t)n="/",a=!0;else{n="/"+t.name;let r=t.parent;for(;r;){if(r===e){a=!0;break}n="/"+r.name+n,r=r.parent}}return a?n:null}getCustomModifierData(e){const t={};return e instanceof cc_1.animation.HierarchyPath?t.path=e.path:e instanceof cc_1.animation.ComponentPath?t.component=e.component:console.log(`Unknown modifier ${e.constructor.name}`),t}getPropDumpData(e,t,n,a){const r={displayName:"",propData:{}};let o;if(a){if(a instanceof cc_1.animation.UniformProxyFactory){const e=uniform_handler_1.uniformHandler.getUniformDumpData(t,a);r.displayName=e.displayName,r.key=e.key,o=e.type}r.propData.valueAdapter=a}else{let a=null;e&&cc_1.CCClass._isCCClass(e.constructor)&&(a=cc_1.CCClass.attr(e.constructor,n));const r=dumpUtil.getConstructor(t,a);o={value:""},a&&!a.ctor&&a.type?o.value=a.type:o.value=dumpUtil.getTypeName(r),r&&(o.extends=dumpUtil.getTypeInheritanceChain(r))}return r.type=o,r}dumpKeyframeData(e){const t=[];return e.forEach((e,n)=>{const a=e.value,r={frame:e.frame,dump:dumpEncode.encodeObject(a,{default:null}),inTangent:e.inTangent,inTangentWeight:e.inTangentWeight,outTangent:e.outTangent,outTangentWeight:e.outTangentWeight,interpMode:e.interpMode,tangentWeightMode:e.tangentWeightMode,easingMethod:e.easingMethod};t.push(r)}),t}async getKeyframeDataFromDump(e){const t=[],n=[];for(let a=0;a<e.length;a++){const r=e[a];null===r.dump.value||void 0===r.dump.value?n[a]=r.dump.value:await dumpDecode.decodePatch(""+a,r.dump,n);const o={frame:r.frame,value:n[a],inTangent:r.inTangent,inTangentWeight:r.inTangentWeight,outTangent:r.outTangent,outTangentWeight:r.outTangentWeight,interpMode:r.interpMode,tangentWeightMode:r.tangentWeightMode};t.push(o)}return t}getPartsOfType(e){return e&&valueTypeParts.includes(e)?valueTypePartMap[e]:null}createPropertyCurve(e,t,n,a){const r=[],o=[];a.forEach((e,t)=>{r.push(e.frame/n),o.push(e.value)});const i={keys:t.push(r)-1,values:o,easingMethods:{}};return{modifiers:e.targetPaths,valueAdapter:e.valueAdapter,data:i}}getNodePath(e,t){let n="/",a=e.slice();if(a&&(t&&(a=t.modifiers.concat(a)),a.length>0&&a.isHierarchyAt(0))){const e=a.parseHierarchyAt(0);"/"!==e.substr(0,1)&&(n+=e)}return n}generateHierarchyPath(e){if(e&&"/"!==e){const t=e.substr(1);return(new cc_1.animation.TrackPath).toHierarchy(t)}return null}getPropInfo(e,t){let n,a="",r="",o="",i="/",c=null,s=t,l="",u=t;for(let t=0;t<e.length;t++){let l="";if(e.isPropertyAt(t)||e.isElementAt(t)){const n=e.isPropertyAt(t)?e.parsePropertyAt(t):e.parseElementAt(t);e.isPropertyAt(t)&&(a=e.parsePropertyAt(t)),l=e.isElementAt(t)?`[${n}]`:`.${n}`,r+=`.${n}`,s&&(u=s,s=s[n])}else if(e.isHierarchyAt(t)){const n=e.parseHierarchyAt(t);if("/"!==n&&("/"===n.substr(0,1)?i=n:i+=n,s))try{u=s=s.getChildByPath(n)}catch(e){}}else if(e.isComponentAt(t)){const a=e.parseComponentAt(t);l=a,n=a,s&&(s=c=s.getComponent(n),u=c),r+=a}o+=l}return"."===o.charAt(0)&&(o=o.substr(1)),"."===r.charAt(0)&&(r=r.substr(1)),l=o,propToDisplayNameMap[o]&&(l=propToDisplayNameMap[o]),{nodePath:i,propPath:o,propKey:r,compName:n,propName:a,displayName:l,propObject:s,propOwnerObject:u}}getCurveInfoByTrack(e,t){const n=t.path,a=t.proxy,r=this.getPropInfo(n,e),o=this.getPropDumpData(r.propOwnerObject,r.propObject,r.propName,a),i=o.key?(null===r||void 0===r?void 0:r.propKey)+"."+o.key:null===r||void 0===r?void 0:r.propKey,c=o.displayName?(null===r||void 0===r?void 0:r.displayName)+"."+o.displayName:null===r||void 0===r?void 0:r.displayName;return o.type&&"Unknown"!==o.type.value||(o.type=this.getTypeByTrack(t)),o.type&&"Unknown"!==o.type.value||console.warn(`Can't find type of ${c}`),{nodePath:null===r||void 0===r?void 0:r.nodePath,propKey:i,combinedType:void 0,type:o.type,targetPaths:n,valueAdapter:a,displayName:c,propName:null===r||void 0===r?void 0:r.propName,compName:null===r||void 0===r?void 0:r.compName,partName:void 0}}getTypeByTrack(e){let t,n="";if(e instanceof cc_1.animation.VectorTrack)switch(e.componentsCount){case 2:n="cc.Vec2";break;case 3:n="cc.Vec3";break;case 4:n="cc.Vec4"}else if(e instanceof cc_1.animation.RealTrack)n="Number";else if(e instanceof cc_1.animation.QuatTrack)n="cc.Quat";else if(e instanceof cc_1.animation.ColorTrack)n="cc.Color";else if(e instanceof cc_1.animation.ObjectTrack){const a=e.channel.curve.keyframes();for(const[e,r]of a)if(void 0!==r&&null!==r){const e=dumpEncode.encodeObject(r,{default:null});n=e.type,t=e.extends;break}}return{value:n||"",extends:t}}copyClip(e,t){e.name=t.name,e.duration=t.duration,e.sample=t.sample,e.speed=t.speed,e.wrapMode=t.wrapMode,e.clearTracks();for(const n of t.tracks)e.addTrack(n);e.events=t.events}queryEvents(e){return e?e.events:(console.warn("Clip is not valid"),null)}isObject(e){return"object"==typeof e}handleAnimableProp(e,t,n,a,r,o){let i=[];if(excludeCCClass.includes(n))return i;if(Array.isArray(a)){const c=this.handleArrayProp(e,t,n,a,r,o);c&&(i=c)}else if(this.isObject(a)){const c=this.handlePrimitiveProp(e,t,n,r);c&&(i=i.concat(c));const s=this.handleObjectProp(e,t,n,a,r,o);s&&(i=i.concat(s))}else{const a=this.handlePrimitiveProp(e,t,n,r);a&&(i=[a])}return i}generatePropDumpData(e,t,n){const a={propData:{}},r=(new cc_1.animation.TrackPath).toComponent(e);if(a.category=e,n){r.append(n);for(let e=0;e<n.length;++e){let t="";switch(!0){default:t="UnknownPath";break;case n.isPropertyAt(e):t=n.parsePropertyAt(e);break;case n.isElementAt(e):t=`${n.parseElementAt(e)}`;break;case n.isHierarchyAt(e):t=n.parseHierarchyAt(e);break;case n.isComponentAt(e):t=n.parseComponentAt(e)}a.category+=`/${t}`}}r.toProperty(t);const o=this.getPropInfo(r);return a.key=o.propKey,a.displayName=o.displayName,a.name=o.propName,a.menuName=o.propName,a.propData.targetPaths=r,a}handlePrimitiveProp(e,t,n,a){const r=this.generatePropDumpData(e,t,a);r.comp=e;const o={value:n},i=cc_1.js.getClassByName(n);return i&&(o.extends=dumpUtil.getTypeInheritanceChain(i)),r.type=o,r.propData.type=r.type,r}handleObjectProp(e,t,n,a,r,o){if(!a)return null;if(excludeCCClass.includes(n))return null;if(o.includes(n))return null;let i=[];if(n===cc_1.js.getClassName(cc_1.Material)){const n=uniform_handler_1.uniformHandler.getAnimablePropsFromMaterial(a);n&&n.length>0&&n.forEach(n=>{const a=this.generatePropDumpData(e,t,r);a.type=n.type,a.comp=e,a.name=n.name,a.category+=`/${t}`;const o=uniform_handler_1.uniformHandler.getUniformNameData(n.passIndex,n.name);a.key+="."+o.key,a.displayName+="."+o.displayName,a.menuName=o.displayName,n.uniformAdapter&&(a.propData.valueAdapter=n.uniformAdapter),i.push(a)})}else{let c=!1,s=[];cc_1.js.getClassByName(n)?(c=!0,a.constructor&&a.constructor.__props__&&(s=a.constructor.__props__)):s=Object.keys(a);const l=(null!==r&&void 0!==r?r:new cc_1.animation.TrackPath).toProperty(t);s.forEach(t=>{const r=a[t];let s=null;c?s=this.getCCClassAnimablePropType(a,t):r&&(s=typeof r),s&&(o.includes(n)||o.push(n),i=i.concat(this.handleAnimableProp(e,t,s,r,l,o)))})}return i}handleArrayProp(e,t,n,a,r,o){let i=[];const c=r.slice().toProperty(t);return a.forEach((t,a)=>{i=i.concat(this.handleAnimableProp(e,a,n,t,c,o))}),i}getCCClassAnimablePropType(e,t){if(!this.isObject(e))return null;const n=e.constructor,a=cc_1.CCClass.attr(n,t);if(!a)return null;let r=!0;if(!(r=a.type!==cc_1.js.getClassName(cc_1.Node)&&(void 0!==a.animatable?a.animatable:void 0===a.visible||a.visible)))return null;const o=e[t],i=dumpUtil.getConstructor(o,a);let c=null;if(!a.ctor&&a.type)c=a.type;else if(Array.isArray(o)){const e=o[0];e&&e.constructor&&(c=dumpUtil.getTypeName(e.constructor))}else c=dumpUtil.getTypeName(i);return"Unknown"===c&&(c=null),c}getAnimablePropsFromProperty(e,t){let n=this.getCCClassAnimablePropType(e,t);if(!n)return null;let a="";a=n instanceof cc_1.CCClass.Attr.PrimitiveType?n.name:n;const r=e[t],o=dumpUtil.getTypeName(e.constructor);return cc_1.js.isChildClassOf(e.constructor,cc_1.RenderableComponent)&&"sharedMaterials"===t&&(t="materials"),this.handleAnimableProp(o,t,a,r,new cc_1.animation.TrackPath,[o])}getAnimablePropsFromComponent(e){let t=[];const n=e.constructor;if(n){const a=n.__props__,r=getExcludeAnimProps(a);a.map(n=>{if(r.includes(n))return;const a=this.getAnimablePropsFromProperty(e,n);null!==a&&(t=t.concat(a))})}return t}getAnimableProperties(e,t){if(!e)return null;const n=[];return t&&n.push(activeProperty),defaultProperties.forEach(e=>{n.push(e)}),e.components.forEach(e=>{if(e instanceof cc_1.Animation)return;if(excludeCCClass.includes(cc_1.js.getClassName(e)))return;for(let t=0;t<n.length;++t)if(n[t].name.startsWith(cc_1.js.getClassName(e)))return;this.getAnimablePropsFromComponent(e).forEach(e=>{n.push(e)})}),n}getClipName(e,t){if(!e)return null;let n=null;return t.clips.forEach(t=>{t&&t._uuid===e&&(n=t.name)}),n}queryNodeAnimationData(e,t){const n={};if(!e)return console.log(`Node(${e}) doesn't exist`),n;let a=null;if(!(a="string"==typeof e?node_1.default.query(e):e))return console.log(`Node(${e}) doesn't exist`),n;n.node=a;const r=a.getComponent(cc_1.Animation);if(!r)return console.debug(`Node(${e}) lacks Animation`),n;if(n.animComp=r,!t)return n;const o=this.getClipName(t,r);if(!o)return console.debug(`Node(${e})doesn't contain clip(${t})`),n;if(""===o)return console.debug(`ClipName is empty Node(${e}) Clip(${t})`),n;const i=r.getState(o);return i?(n.animState=i,n):(console.debug(`Can't find AnimationState Node(${e}) Clip(${t})`),n)}getDefaultValue(e){let t=null;const n=cc_1.js.getClassByName(e);if(n)t=new n;else switch(e){case"Boolean":t=!1;break;case"Number":case"Integer":case"Float":t=0;break;case"String":t=""}return t}async getValueFrom(e,t,n=null){var a,r;if(!t)return;let o;if(n&&void 0!==n.newValue){const e=t.type.value;if(o=n.newValue,cc_1.js.getClassByName(e))if(t.type.extends&&t.type.extends.includes("cc.Asset")){const e=(null===(a=n.newValue)||void 0===a?void 0:a.uuid)||(null===(r=n.newValue)||void 0===r?void 0:r._uuid);o=e&&""!==e?await promisify(cc_1.assetManager.loadAny)(e):null}else{const t={};t.__type__=e,Object.assign(t,n.newValue),o=cc_1.deserialize(t,null,null)}else o=n.newValue}else{let n=e;const a=t.targetPaths,r=t.valueAdapter;n=a.trace(n),r?r instanceof cc_1.animation.UniformProxyFactory&&(o=await uniform_handler_1.uniformHandler.getCurrentValue(n,r,t)):(n&&(o=n),o&&o.constructor&&cc_1.js.isChildClassOf(o.constructor,cc_1.ValueType)&&(o=o.clone()))}return o}loadJsonWithUuid(e,t,n){cc_1.assetManager.assets.remove(e),cc_1.assetManager.loadWithJson(t,{assetId:e},(e,t)=>{n&&n(e,t)})}copyCurveData(e,t){var n,a,r,o,i,c,s,l;t.inTangent=null!==(n=e.inTangent)&&void 0!==n?n:t.inTangent,t.inTangentWeight=null!==(a=e.inTangentWeight)&&void 0!==a?a:t.inTangentWeight,t.outTangent=null!==(r=e.outTangent)&&void 0!==r?r:t.outTangent,t.outTangentWeight=null!==(o=e.outTangentWeight)&&void 0!==o?o:t.outTangentWeight,t.interpMode=null!==(i=e.interpMode)&&void 0!==i?i:t.interpMode,t.tangentWeightMode=null!==(c=e.tangentWeightMode)&&void 0!==c?c:t.tangentWeightMode,t.tangentMode=null!==(s=e.tangentMode)&&void 0!==s?s:t.tangentMode,t.easingMethod=null!==(l=e.easingMethod)&&void 0!==l?l:t.easingMethod}isNumber(e){return"number"==typeof e&&!isNaN(e)}getTrackTypeBy(e){let t=null;switch(e){case"cc.Vec2":t="vec2";break;case"cc.Vec3":t="vec3";break;case"cc.Vec4":t="vec4";break;case"cc.Color":t="color";break;case"cc.Size":t="size"}return t}}const utils=new AnimationUtil;exports.utils=utils;