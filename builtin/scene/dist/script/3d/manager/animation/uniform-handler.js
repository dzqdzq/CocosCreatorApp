"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var n=Object.getOwnPropertyDescriptor(r,t);n&&("get"in n?r.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,a,n)}:function(e,r,t,a){e[a=void 0===a?t:a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var r,t=[];for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t})(e)};return function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t=n(e),a=0;a<t.length;a++)"default"!==t[a]&&__createBinding(r,e,t[a]);return __setModuleDefault(r,e),r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.uniformHandler=void 0;const cc_1=require("cc"),dumpUtil=__importStar(require("../../../export/dump/utils")),math_1=__importDefault(require("../../../utils/math")),asset_1=__importDefault(require("../../../export/dump/asset")),util_1=require("util"),ValuePartToArrayIndexMap={"cc.Vec2":{x:0,y:1},"cc.Vec3":{x:0,y:1,z:2},"cc.Vec4":{x:0,y:1,z:2,w:3},"cc.Color":{r:0,g:1,b:2,a:3}},ArrayIndexToValuePartMap={"cc.Vec2":{0:"x",1:"y"},"cc.Vec3":{0:"x",1:"y",2:"z"},"cc.Vec4":{0:"x",1:"y",2:"z",3:"w"},"cc.Color":{0:"r",1:"g",2:"b",3:"a"}};class UniformHandler{isUniformCurve(e){return e instanceof cc_1.animation.UniformProxyFactory}getValueToArrayIndexMapByType(e){return e?ValuePartToArrayIndexMap[e]:null}getArrayIndexToValuePartMapByType(e){return e?ArrayIndexToValuePartMap[e]:null}getUniformNameData(e,r){return{key:`pass.${e}.`+r,displayName:`pass[${e}].`+r}}getDumpTypeOfUniform(e,r){var t={value:""},a=e.getHandle(r),a=cc_1.renderer.Pass.getTypeFromHandle(a);let n=asset_1.default.GFXToValueTypeMap[a];a=e.properties[r],a&&a.editor&&"color"===a.editor.type&&(n="cc.Color"),t.value=n,e=cc_1.js.getClassByName(n);return e&&(t.extends=dumpUtil.getTypeInheritanceChain(e)),t}getUniformDumpData(e,r){var{passIndex:r,uniformName:t}=r,a=this.getUniformNameData(r,t);let n;return e&&e.passes&&0<=r&&r<e.passes.length&&(e=e.passes[r],n=uniformHandler.getDumpTypeOfUniform(e,t)),{displayName:a.displayName,key:a.key,type:n}}getAnimablePropsFromMaterial(e){if(!e)return null;const o=[];return e.passes.forEach((a,n)=>{var e=a.properties;Object.keys(e).forEach(e=>{var r=new cc_1.animation.UniformProxyFactory,t=(r.passIndex=n,r.uniformName=e,this.getDumpTypeOfUniform(a,e)),e={name:e,passIndex:n,type:t,uniformAdapter:r};o.push(e)})}),o}getDefaultValue(e){let r=null;var t=cc_1.js.getClassByName(e);if(t)r=new t;else switch(e){case"Boolean":r=!1;break;case"Number":r=0;break;case"String":r=""}return r}async getCurrentValue(e,r,t){let a;var n,o,u;return e&&e.passes&&(n=e.passes[r.passIndex],o=t.type?.value,n)&&(void 0!==r.channelIndex?(u=n.getHandle(r.uniformName,r.channelIndex,cc_1.gfx.Type.FLOAT))&&(a=n.getUniform(u,0),"cc.Color"===t.combinedType?.value)&&(a=math_1.default.clamp(Math.round(255*a),0,255)):(u=n.getHandle(r.uniformName))&&o&&(cc_1.renderer.Pass.getTypeFromHandle(u)<cc_1.gfx.Type.SAMPLER1D?(a=this.getDefaultValue(o),n.getUniform(u,a)):(t=e.getProperty(r.uniformName))&&t._uuid&&(a=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t._uuid)))),a}colorFloatToInt(e){let r=e.concat();return r=r.map(e=>math_1.default.clamp(Math.round(255*e),0,255))}}const uniformHandler=new UniformHandler;exports.uniformHandler=uniformHandler;