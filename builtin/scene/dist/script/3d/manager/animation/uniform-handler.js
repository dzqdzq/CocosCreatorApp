"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t),Object.defineProperty(e,a,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,a){void 0===a&&(a=t),e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.uniformHandler=void 0;const cc_1=require("cc"),dumpUtil=__importStar(require("../../../../utils/dump/utils")),math_1=__importDefault(require("../../../utils/math")),utils_1=__importDefault(require("../asset/utils")),{promisify:promisify}=require("util"),ValuePartToArrayIndexMap={"cc.Vec2":{x:0,y:1},"cc.Vec3":{x:0,y:1,z:2},"cc.Vec4":{x:0,y:1,z:2,w:3},"cc.Color":{r:0,g:1,b:2,a:3}},ArrayIndexToValuePartMap={"cc.Vec2":{0:"x",1:"y"},"cc.Vec3":{0:"x",1:"y",2:"z"},"cc.Vec4":{0:"x",1:"y",2:"z",3:"w"},"cc.Color":{0:"r",1:"g",2:"b",3:"a"}};class UniformHandler{isUniformPartCurve(e){return e instanceof cc_1.animation.UniformProxyFactory&&void 0!==e.channelIndex}isUniformCombinedCurve(e){return e instanceof cc_1.animation.UniformProxyFactory&&void 0===e.channelIndex}getValueToArrayIndexMapByType(e){return e?ValuePartToArrayIndexMap[e]:null}getArrayIndexToValuePartMapByType(e){return e?ArrayIndexToValuePartMap[e]:null}getUniformNameData(e,r){return{key:`pass.${e}.${r}`,displayName:`pass[${e}].${r}`}}getDumpTypeOfUniform(e,r){const t={value:""},a=e._propertyHandleMap[r],n=cc_1.renderer.Pass.getTypeFromHandle(a);let o=utils_1.default.GFXToValueTypeMap[n];const i=e._properties[r];i&&i.editor&&"color"===i.editor.type&&(o="cc.Color"),t.value=o;const s=cc_1.js.getClassByName(o);return s&&(t.extends=dumpUtil.getTypeInheritanceChain(s)),t}getUniformDumpData(e,r){const t=this.getUniformNameData(r.passIndex,r.uniformName);let a;if(e&&e.passes){const t=e.passes[r.passIndex];a=uniformHandler.getDumpTypeOfUniform(t,r.uniformName)}return{displayName:t.displayName,key:t.key,type:a}}getAnimablePropsFromMaterial(e){if(!e)return null;const r=[];return e.passes.forEach((e,t)=>{const a=e.properties;Object.keys(a).forEach(a=>{const n=new cc_1.animation.UniformProxyFactory;n.passIndex=t,n.uniformName=a;const o=this.getDumpTypeOfUniform(e,a),i={name:a,passIndex:t,type:o,uniformAdapter:n};r.push(i)})}),r}getDefaultValue(e){let r=null;const t=cc_1.js.getClassByName(e);if(t)r=new t;else switch(e){case"Boolean":r=!1;break;case"Number":r=0;break;case"String":r=""}return r}async getCurrentValue(e,r,t){var a,n;let o;if(e&&e.passes){const i=e.passes[r.passIndex],s=null===(a=t.type)||void 0===a?void 0:a.value;if(i)if(void 0!==r.channelIndex){const e=i.getHandle(r.uniformName,r.channelIndex,cc_1.gfx.Type.FLOAT);e&&(o=i.getUniform(e,0),"cc.Color"===(null===(n=t.combinedType)||void 0===n?void 0:n.value)&&(o=math_1.default.clamp(Math.round(255*o),0,255)))}else{const t=i.getHandle(r.uniformName);if(t&&s){const a=cc_1.renderer.Pass.getPropertyTypeFromHandle(t);if(a===cc_1.renderer.Pass.PropertyType.UBO)o=this.getDefaultValue(s),i.getUniform(t,o);else if(a===cc_1.renderer.Pass.PropertyType.SAMPLER){const t=e.getProperty(r.uniformName);t&&t._uuid&&(o=await promisify(cc_1.assetManager.loadAny)(t._uuid))}}}}return o}checkToProcessColorOfUniformCurve(e,r){var t;if(this.isUniformPartCurve(e.valueAdapter)&&"cc.Color"===(null===(t=e.combinedType)||void 0===t?void 0:t.value)){const e=r.data.values.concat();r.data.values=e.map(e=>e=math_1.default.toPrecision(e/255,3))}}colorFloatToInt(e){let r=e.concat();return r=r.map(e=>math_1.default.clamp(Math.round(255*e),0,255))}}const uniformHandler=new UniformHandler;exports.uniformHandler=uniformHandler;