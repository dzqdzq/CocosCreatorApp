"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.uniformHandler=void 0;const cc_1=require("cc"),dumpUtil=__importStar(require("../../../utils/dump/utils")),math_1=__importDefault(require("../../../utils/math")),utils_1=__importDefault(require("../asset/utils")),util_1=require("util"),ValuePartToArrayIndexMap={"cc.Vec2":{x:0,y:1},"cc.Vec3":{x:0,y:1,z:2},"cc.Vec4":{x:0,y:1,z:2,w:3},"cc.Color":{r:0,g:1,b:2,a:3}},ArrayIndexToValuePartMap={"cc.Vec2":{0:"x",1:"y"},"cc.Vec3":{0:"x",1:"y",2:"z"},"cc.Vec4":{0:"x",1:"y",2:"z",3:"w"},"cc.Color":{0:"r",1:"g",2:"b",3:"a"}};class UniformHandler{isUniformCurve(e){return e instanceof cc_1.animation.UniformProxyFactory}getValueToArrayIndexMapByType(e){return e?ValuePartToArrayIndexMap[e]:null}getArrayIndexToValuePartMapByType(e){return e?ArrayIndexToValuePartMap[e]:null}getUniformNameData(e,t){return{key:`pass.${e}.${t}`,displayName:`pass[${e}].${t}`}}getDumpTypeOfUniform(e,t){const r={value:""},a=e.getHandle(t),n=cc_1.renderer.Pass.getTypeFromHandle(a);let o=utils_1.default.GFXToValueTypeMap[n];const i=e.properties[t];i&&i.editor&&"color"===i.editor.type&&(o="cc.Color"),r.value=o;const u=cc_1.js.getClassByName(o);return u&&(r.extends=dumpUtil.getTypeInheritanceChain(u)),r}getUniformDumpData(e,t){const{passIndex:r,uniformName:a}=t,n=this.getUniformNameData(r,a);let o;if(e&&e.passes&&r>=0&&r<e.passes.length){const t=e.passes[r];o=uniformHandler.getDumpTypeOfUniform(t,a)}return{displayName:n.displayName,key:n.key,type:o}}getAnimablePropsFromMaterial(e){if(!e)return null;const t=[];return e.passes.forEach((e,r)=>{const a=e.properties;Object.keys(a).forEach(a=>{const n=new cc_1.animation.UniformProxyFactory;n.passIndex=r,n.uniformName=a;const o=this.getDumpTypeOfUniform(e,a),i={name:a,passIndex:r,type:o,uniformAdapter:n};t.push(i)})}),t}getDefaultValue(e){let t=null;const r=cc_1.js.getClassByName(e);if(r)t=new r;else switch(e){case"Boolean":t=!1;break;case"Number":t=0;break;case"String":t=""}return t}async getCurrentValue(e,t,r){var a,n;let o;if(e&&e.passes){const i=e.passes[t.passIndex],u=null===(a=r.type)||void 0===a?void 0:a.value;if(i)if(void 0!==t.channelIndex){const e=i.getHandle(t.uniformName,t.channelIndex,cc_1.gfx.Type.FLOAT);e&&(o=i.getUniform(e,0),"cc.Color"===(null===(n=r.combinedType)||void 0===n?void 0:n.value)&&(o=math_1.default.clamp(Math.round(255*o),0,255)))}else{const r=i.getHandle(t.uniformName);if(r&&u){if(cc_1.renderer.Pass.getTypeFromHandle(r)<cc_1.gfx.Type.SAMPLER1D)o=this.getDefaultValue(u),i.getUniform(r,o);else{const r=e.getProperty(t.uniformName);r&&r._uuid&&(o=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(r._uuid))}}}}return o}colorFloatToInt(e){let t=e.concat();return t=t.map(e=>math_1.default.clamp(Math.round(255*e),0,255))}}const uniformHandler=new UniformHandler;exports.uniformHandler=uniformHandler;