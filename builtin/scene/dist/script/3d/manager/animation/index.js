"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimationManager=void 0;const event_enum_1=require("../../../public/event-enum"),cc_1=require("cc"),events_1=require("events"),node_1=__importDefault(require("../node")),scene_1=__importDefault(require("../scene")),selection_1=__importDefault(require("../../../public/selection")),utils_1=require("./utils"),editor_animation_clip_1=__importDefault(require("./editor-animation-clip")),node_2=__importDefault(require("../../../utils/node")),message_1=require("../message"),embedded_player_1=require("cc/editor/embedded-player"),new_gen_anim_1=require("cc/editor/new-gen-anim");var PlayState;!function(t){t[t.STOP=0]="STOP",t[t.PLAYING=1]="PLAYING",t[t.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));const AnimEditState={record:!1,dirty:!1,playState:PlayState.STOP},skelAnimAllowOperations=["addEvent","deleteEvent","updateEvent","moveEvents","copyEventsTo","changeSpeed","changeWrapMode","changeSample","copyEvent","addEmbeddedPlayer","updateEmbeddedPlayer","deleteEmbeddedPlayer","clearEmbeddedPlayer","addEmbeddedPlayerGroup","removeEmbeddedPlayerGroup","clearEmbeddedPlayerGroup"],keysOperations=["createKey","moveKeys","removeKey","updateKey","copyKeysTo","spacingKeys","clearKeys","copyPropTo"];class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}class AnimationManager extends events_1.EventEmitter{constructor(){super(),this._lastSaveClipDump=null,this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditAnimClip=null,this._curEditTime=0,this._animUpdateInterval=null,this._isDirty=!1,this._isInEdit=!1,this._curDefaultClip=null,this._isUseBakedAnimation=!0,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this.init(),node_1.default.on("gizmo-control-end",this.onNodeChanged.bind(this))}get curEditClipUuid(){return this._curEditClipUuid}set curEditTime(t){this._curEditTime!==t&&(this._curEditTime=t,message_1.messageManager.broadcast("scene:animation-time-change",t),this.emit("scene:animation-time-change",t))}get curEditRootNodeUuid(){return this._curEditRootNodeUuid}set curEditRootNodeUuid(t){this._curEditRootNodeUuid=t}set curDefaultClip(t){this._curDefaultClip=t}init(){this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditTime=0}setCurDefaultClipByUuid(t){t?cc_1.assetManager.loadAny(t,(t,e)=>{t?console.error(t):this._curDefaultClip=e}):this._curDefaultClip=null}async record(t,e,i){var n;if(e)return!!t&&(!!(i=i||this._curEditRootNodeUuid||(null===(n=this.queryNodeAnimationData(t).defaultClip)||void 0===n?void 0:n._uuid))&&(this._isInEdit=!0,AnimEditState.record=!0,this._curEditRootNodeUuid=t,i&&this._curEditClipUuid!==i&&this.setEditClip(i),await this.registerAndFireEvents(t,this._curEditClipUuid),this.emit("scene:animation-clip-change",t,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100)),this.storeData(),this.setCurEditTime(0),this.emit("scene:animation-record-start"),!0));{if(!this._isInEdit)return!1;try{this.stop()}catch(t){console.error(t)}this.changePlayState(PlayState.STOP);const t=this.queryRecordAnimState();if(t)try{this._unregisterAnimStateEVents(t),null===t||void 0===t||t.destroy()}catch(t){console.error(t)}return this._curEditRootNodeUuid="",AnimEditState.record=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),this.clearAnimationState(),cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE),this.emit("scene:animation-record-end"),!0}}storeData(){const t=this.queryRecordAnimData();t.animComp&&this._curEditRootNodeUuid&&t.animComp instanceof cc_1.SkeletalAnimation&&(this._isUseBakedAnimation=t.animComp.useBakedAnimation,t.animComp.useBakedAnimation=!1,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid))}restoreData(){const t=this.queryRecordAnimData();t.animComp&&t.animComp instanceof cc_1.SkeletalAnimation&&(t.animComp.useBakedAnimation=this._isUseBakedAnimation)}_registerAnimStateEvents(t){t&&(t.on("finished",this._onAnimPlayEnd,this),t.on("play",this._onAnimPlay,this),t.on("pause",this._onAnimPause,this),t.on("resume",this._onAnimResume,this),t.on("stop",this._onAnimStopped,this))}_unregisterAnimStateEVents(t){t&&(t.off("finished",this._onAnimPlayEnd,this),t.off("play",this._onAnimPlay,this),t.off("pause",this._onAnimPause,this),t.off("resume",this._onAnimResume,this),t.off("stop",this._onAnimStopped,this))}isDirty(){return this._isDirty}async saveCheck(t){if(t||(t=this.queryRecordAnimState()),!t)return!0;if(this.isDirty()){switch(await cce.Ipc.send("dirty-dialog",t.clip.name+".anim")){case 0:case"0":await this.save();break;case 1:case"1":await this.restoreFromDump(this._curEditRootNodeUuid,this._curEditClipUuid,this._lastSaveClipDump);break;case 2:case"2":return!1}}return!0}registerAndFireEvents(t,e){var i;const n=this.queryNodeAnimationData(t),a=null===(i=n.clips)||void 0===i?void 0:i.find(t=>(null===t||void 0===t?void 0:t._uuid)===e);if(!a)return!1;const s=this.queryAnimState(a);return!!s&&(this._curDefaultClip=n.defaultClip,utils_1.utils.initAninState(s,n.node),this._registerAnimStateEvents(s),this._isDirty=!1,this._lastSaveClipDump=this.dumpClip(t,e),this._curEditAnimClip=new editor_animation_clip_1.default(n.node,e,s),this.curEditTime=0,!0)}async changeAnimNode(t,e){if(!t||!e)return!1;if(!this._isInEdit)return!1;const i=this.queryRecordAnimState();return!!i&&(!!await this.saveCheck(i)&&(this.stop(),this._unregisterAnimStateEVents(i),!!scene_1.default.modes.animation.open(t)&&(this.setEditClip(e),!0)))}async save(){return await this.saveClip(this._curEditClipUuid)}async saveClip(t){const e=this.queryRecordAnimState();if(!e)return!1;const i=e.clip,n=cce.Utils.serialize(i);if(this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,t),this.isSkeletonClip(t)){const t=await cce.Ipc.send("query-asset-meta",i._uuid);if(t&&t.userData){const e=utils_1.utils.queryEvents(i);e?t.userData.events=e.map(t=>({frame:t.frame,func:t.func,params:t.params})):console.error("Event data error"),t.userData.embeddedPlayers=Array.from(i[embedded_player_1.getEmbeddedPlayersTag]()).map(t=>({begin:t.begin,end:t.end,reconciledSpeed:t.reconciledSpeed,editorExtras:{group:t[cc_1.editorExtrasTag]&&t[cc_1.editorExtrasTag].group},playable:utils_1.utils.getPlayableInfo(t.playable)})),t.userData.editorExtras={embeddedPlayerGroups:i[cc_1.editorExtrasTag].embeddedPlayerGroups},t.userData.wrapMode=i.wrapMode,t.userData.speed=i.speed,t.userData.sample=i.sample,await cce.Ipc.send("save-asset-meta",i._uuid,JSON.stringify(t))}}else{const t=await cce.Ipc.send("query-asset-info",i._uuid);if(t)await cce.Ipc.send("save-asset",t.url,n);else{const t="db://assets/"+i.name+".anim";await cce.Ipc.send("create-asset",t,n)}}return this._isDirty=!1,this.emit("scene:animation-save",this.curEditRootNodeUuid,i._uuid),!0}isSkeletonClip(t){if(!t)return!1;return t.indexOf("@")>=0}needLock(t,e){const i=this.queryNodeAnimationData(t).animComp;return!!(i&&i instanceof cc_1.SkeletalAnimation)||this.isSkeletonClip(e)}getEditAnimationInfo(){return{rootid:this._curEditRootNodeUuid,clipid:this._curEditClipUuid}}getSerializedEditClip(){if(!this._isInEdit)return null;if(!this._curEditClipUuid)return null;const t=this.queryRecordAnimState();if(!t||!t.clip)return null;const e=t.clip;return cce.Utils.serialize(e)}queryAnimationNodeEditInfo(t){var e;const i={state:"failure",result:null};if(!node_1.default.query(t))return i.reson=`Animation node(${t}) doesn't exist`,i;const n=(this._isInEdit?this._curEditRootNodeUuid:null)||this.queryAnimationRoot(t);i.state="success",i.result={root:n};const a=this.queryNodeAnimationData(n);return i.result.node=cce.Scene.queryNodeTree(n),Object.assign(i.result,{aniComp:a.animComp&&cc.js.getClassName(a.animComp)||"",clipsMenu:a.clips&&utils_1.utils.decodeClipsMenu(a.clips)||[],defaultClip:null===(e=a.defaultClip)||void 0===e?void 0:e._uuid,root:n}),i}queryRecordAniClips(){return this.queryRecordAniData().clips}queryRecordAniData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryRecordAnimState(t,e){t=t||this._curEditClipUuid,e=e||this._curEditRootNodeUuid;const i=this.queryAnimationClip(t,e);return i&&this.queryAnimState(i)}queryRecordAnimData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryAnimationClip(t,e){var i;const n=this.queryNodeAnimationData(e);return n&&(null===(i=n.clips)||void 0===i?void 0:i.find(e=>(null===e||void 0===e?void 0:e._uuid)===t))}queryNodeAnimationData(t){var e;const i={defaultClip:null};if(!t)return console.debug(`Node(${t}) doesn't exist`),i;let n=null;if(!(n="string"==typeof t?node_1.default.query(t):t))return console.debug(`Node(${t}) doesn't exist`),i;i.node=n;let a=[];const s=this.queryAnimComp(n);return s?(s instanceof cc_1.animation.AnimationController?(a=[...(0,new_gen_anim_1.visitAnimationClipsInController)(s)],i.animComp=s):(a=s.clips,i.animComp=s,i.defaultClip=s.defaultClip),i.clips=a.filter(t=>!!(null===t||void 0===t?void 0:t.name)),i.defaultClip=i.defaultClip||a[0],(null===(e=i.defaultClip)||void 0===e?void 0:e.name)||(i.defaultClip=null),i):i}queryAnimComp(t){const e=t.getComponent(cc_1.animation.AnimationController);return e||t.getComponent(cc_1.Animation)}queryAnimState(t,e=!1){if(!t.name)return null;let i=null;return this._animationStateMap.has(t._uuid)?i=this._animationStateMap.get(t._uuid):!1===e&&((i=new cc_1.AnimationState(t))._setEventTarget(this._eventTarget),this._animationStateMap.set(t._uuid,i)),i}queryAnimClipsInfo(t){var e;const i=this.queryNodeAnimationData(t);return i.clips?{clipsMenu:utils_1.utils.decodeClipsMenu(i.clips),defaultClip:null===(e=i.defaultClip)||void 0===e?void 0:e._uuid}:null}queryPlayState(){return AnimEditState.playState}async setEditClip(t){if(!t)return console.log("Clip uuid is empty"),!1;if(t===this._curEditClipUuid)return!0;if(this._isInEdit){const e=this.queryRecordAnimState();if(e){if(!await this.saveCheck(e))return!1;this._unregisterAnimStateEVents(e)}if(!this.queryRecordAnimState(t))return!1;this.stop(),this._curEditClipUuid=t,await this.registerAndFireEvents(this._curEditRootNodeUuid,t),cce.Engine.repaintInEditMode()}else this._curEditClipUuid=t;return this.emit("scene:animation-clip-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),!0}setCurEditTime(t){if(this._curEditTime=t,!this._isInEdit)return!1;const e=this.queryRecordAnimState();if(!e)return!1;let i=t;i>e.duration&&(i=e.duration),e.weight=1,e.setTime(i),e.isPaused||e.pause();try{e.sample()}catch(t){console.error(t)}return cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:animation-time-change",i),this.emit("scene:animation-time-change",i),!0}changePlayState(t){switch(AnimEditState.playState=t,t){case PlayState.PLAYING:cce.Engine.enterState(cce.NeedAnimState.ANIMATION_MODE);break;case PlayState.PAUSE:case PlayState.STOP:cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE)}message_1.messageManager.broadcast("scene:animation-state-change",AnimEditState.playState)}play(t){const e=this._animationStateMap.get(t);return!!e&&(e.weight=1,e.isPlaying&&e.isPaused?e.resume():e.play(),cce.Engine.repaintInEditMode(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PLAY),!0)}pause(){const t=this._animationStateMap.get(this._curEditClipUuid);return!!t&&(t.pause(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PAUSE),this._curEditTime=this.queryPlayingClipTime(),cce.Engine.repaintInEditMode(),!0)}resume(){const t=this._animationStateMap.get(this._curEditClipUuid);return!!t&&(t.isPlaying||(t.weight=1,t.play()),t.resume(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.RESUME),cce.Engine.repaintInEditMode(),!0)}stop(){const t=this._animationStateMap.get(this._curEditClipUuid);if(!t)return!1;t.setTime(0),this._curEditTime=0,t.isPaused||t.pause();try{t.sample()}catch(t){console.error(t)}return t.stop(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.STOP),cce.Engine.repaintInEditMode(),this.changePlayState(PlayState.STOP),!0}async queryAnimationClipDump(t,e){DEBUG_TIME_COST&&console.time("queryClipDumpCost");const i=this.queryRecordAnimState(e,t);if(!i)return!1;const n=this.queryNodeAnimationData(t);let a=this._curEditAnimClip;this._curEditAnimClip&&this._curEditAnimClip.rootNode===n.node&&this._curEditClipUuid===e||(a=new editor_animation_clip_1.default(n.node,e,i)),Editor.Metrics.trackTimeStart("scene:query-animation-clip-dump");const s=await a.getDumpData();return Editor.Metrics.trackTimeEnd("scene:query-animation-clip-dump",{output:!0,label:`scene:query-animation-clip-dump ${e}`}),this.needLock(t,e)&&s&&(s.isLock=!0),DEBUG_TIME_COST&&console.timeEnd("queryClipDumpCost"),"2d"===cce.SceneFacadeManager._projectType&&s&&(s.curves=s.curves.filter(t=>("position"!==t.key&&"scale"!==t.key||(t.partKeys=t.partKeys.filter(t=>!t.includes(".z"))),"rotation"===t.key&&(t.partKeys=t.partKeys.filter(t=>t.includes(".z"))),!["position.z","rotation.x","rotation.y","scale.z"].includes(t.key)))),s}dumpClip(t,e){const i=this.queryAnimationClip(e,t);if(!i)return null;const n=this.queryAnimState(i);return n?cce.Utils.serialize(n.clip):null}restoreFromDump(t,e,i){var n;const a=this.queryNodeAnimationData(t),s=null===(n=a.clips)||void 0===n?void 0:n.find(t=>(null===t||void 0===t?void 0:t._uuid)===e);if(!s)return!1;const r=this.queryAnimState(s);if(!r)return!1;utils_1.utils.initAninState(r,a.node);const o=r.clip;return new Promise((n,s)=>{utils_1.utils.loadJsonWithUuid(e,i,async(i,u)=>{i?s(i):u&&(utils_1.utils.copyClip(o,u),this._curEditAnimClip=new editor_animation_clip_1.default(a.node,e,r),await this._curEditAnimClip.updateCurveData(),this._isDirty=!0,this.setCurEditTime(this._curEditTime),this.emit("scene:animation-change",t,e,"undo"),message_1.messageManager.broadcast("scene:animation-change",t,e),n(!0))})})}queryAnimationRoot(t){let e=node_1.default.query(t);if(e)do{if(this.queryAnimComp(e))return e.uuid;e=e.parent}while(e);return t}async queryAnimationRootInfo(t){const e=cce.Scene.queryNodeTree(t),i=this.queryAnimClipsInfo(t);if(!i||i&&i.clipsMenu&&0===i.clipsMenu.length)return{root:t,nodeTreeDump:e};const n=i.defaultClip;return{root:t,nodeTreeDump:e,clipsMenu:i.clipsMenu,defaultClip:n,clipDump:n?await this.queryAnimationClipDump(t,n):null,time:this.queryPlayingClipTime(n),state:this.queryPlayState()}}queryProperties(t){const e=node_1.default.query(t);if(!e)return console.log(`Animation node(${t})doesn't exist`),[];let i=e;for(;i&&!i.getComponent(cc_1.Animation);){if(i.parent instanceof cc_1.Scene){i=e;break}i=i.parent}const n=utils_1.utils.getAnimableProperties(e,i!==e);let a=[];return n&&(a=n),a}queryPlayingClipTime(t){if(!this._isInEdit)return 0;t=t||this._curEditClipUuid;const e=this._animationStateMap.get(t);return e?e.current:0}async getPropValueAtFrame(t,e,i,n){return this._animationStateMap.get(t)?t!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${t}`),null):this._curEditAnimClip?await this._curEditAnimClip.getPropValueAtFrame(e,i,n):null:null}async getAllPropValueAtFrame(t,e,i,n){const a={};return await Promise.all(i.map(async i=>{a[i]=await this.getPropValueAtFrame(t,e,i,n)})),a}async operation(t){const e={state:"success",result:!0};let i=!1;cce.SceneFacadeManager.snapshot();for(let n=0;n<t.length;n++){const a=t[n],s=a.funcName,r=a.args;if(this.needLock(this._curEditRootNodeUuid,this._curEditClipUuid)&&!skelAnimAllowOperations.includes(s)){e.reson=`Method '${s}' does not allowed in skeleton animation.`,e.state="failure",console.log(e.reson);break}const o=r[0];if(o!==this._curEditClipUuid){e.state="failure",e.reson=`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${o}`,console.log(e.reson);break}if(!this._curEditAnimClip[s]){e.state="failure",e.reson=`Method '${s}' does not exist to manipulate the animation.`,console.log(e.reson);break}if(r.splice(0,1),!await this._curEditAnimClip[s](...r)){e.state="failure",e.reson=`call method ${s} failed`,console.log(e.reson);break}keysOperations.includes(s)&&(i=!0)}return"success"===e.state?(i&&this.setCurEditTime(this._curEditTime),this._isDirty=!0,cce.Engine.repaintInEditMode(),this.emit("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid)):e.result=!1,cce.SceneFacadeManager.snapshot(),e}async onNodeChanged(t,e){if(!AnimEditState.record)return;if((null===e||void 0===e?void 0:e.source)===event_enum_1.EventSourceType.ENGINE)return;const i=e.propPath;if(!t||!i||"string"!=typeof i)return;const n=node_1.default.query(this._curEditRootNodeUuid);if(!n)return;const a=this.queryRecordAnimState();if(!a)return void console.log(`AnimationState of '(${this._curEditClipUuid})' clip doesn't exist`);if(!this._curEditAnimClip)return;const s=utils_1.utils.getNodePathFromAnimRoot(n,t);if(!s)return;const r=[],o=utils_1.utils.generateHierarchyPath(s);o&&r.push(o);const u=node_2.default.getNameDataByPropPath(t,i);let d=u.propName;const c=u.compName,l=u.propName;c&&(r.push(new cc_1.animation.ComponentPath(c)),d=c+"."+d);const m=a.clip;let p=null;if("rotation"===l?(p=this._curEditAnimClip.getCreatedCurve(s,"eulerAngles"))?d="eulerAngles":(d=l,p=this._curEditAnimClip.getCreatedCurve(s,d)):p=this._curEditAnimClip.getCreatedCurve(s,d),!p)return;const h=m.sample,_=Math.round(this._curEditTime*h);p.hasKey(_)?await this.operation([{funcName:"updateKey",args:[this._curEditClipUuid,s,d,[_]]}]):await this.operation([{funcName:"createKey",args:[this._curEditClipUuid,s,d,_,null]}])}_onAnimPlay(){this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),message_1.messageManager.broadcast("scene:animation-time-change",0)}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime),this.emit("scene:animation-time-change",this._curEditTime)}update(){AnimEditState.playState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime))}onAssetDeleted(t){if(!t)return;const e=this.queryRecordAniClips();if(!e)return;let i=!1;for(let n=0;n<e.length;n++)e[n]&&e[n]._uuid===t&&(i=!0);i&&this._isInEdit&&(this._isDirty=!1,cce.SceneFacadeManager.closeScene())}onAssetRefreshed(t){var e;if(!t)return;const i=this.queryRecordAnimData(),n=null===(e=i.clips)||void 0===e?void 0:e.find(e=>(null===e||void 0===e?void 0:e._uuid)===t);if(n&&(i.animComp instanceof cc_1.Animation&&i.clips&&i.clips.length>0&&n&&i.animComp instanceof cc_1.Animation&&(i.animComp.defaultClip=this._curDefaultClip,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid)),t===this._curEditClipUuid)){let t=this._curEditRootNodeUuid;if(!t){const e=selection_1.default.query();e.length>0&&(t=e[0])}this.removeAnimationState(this._curEditClipUuid);const e=this.queryAnimState(n);e&&(utils_1.utils.initAninState(e,i.node),this._curEditAnimClip=new editor_animation_clip_1.default(i.node,this._curEditClipUuid,e)),this.emit("scene:animation-change",t,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",t,this._curEditClipUuid)}}removeAnimationState(t){const e=this._animationStateMap.get(t);e&&(this.pause(),this._registerAnimStateEvents(e),e.destroy(),this._animationStateMap.delete(t))}clearAnimationState(){this._animationStateMap.forEach((t,e)=>{this.removeAnimationState(e)})}onSceneOpened(t){if(!this._isInEdit)return;this.storeData(),this.removeAnimationState(this._curEditClipUuid);const e=this.queryRecordAnimData(),i=this.queryRecordAnimState();i&&this._registerAnimStateEvents(i),this._curEditAnimClip?this._curEditAnimClip.refreshData(e.node,this._curEditClipUuid):this._curEditAnimClip=new editor_animation_clip_1.default(e.node,this._curEditClipUuid,i),this.setCurEditTime(this._curEditTime)}}exports.AnimationManager=AnimationManager,exports.default=new AnimationManager;