"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimationManager=void 0;const event_enum_1=require("../../../public/event-enum"),cc_1=require("cc"),events_1=require("events"),node_1=__importDefault(require("../node")),scene_1=__importDefault(require("../scene")),selection_1=__importDefault(require("../../../public/selection")),utils_1=require("./utils"),editor_animation_clip_1=__importDefault(require("./editor-animation-clip")),node_2=__importDefault(require("../../../utils/node")),message_1=require("../message"),embedded_player_1=require("cc/editor/embedded-player"),new_gen_anim_1=require("cc/editor/new-gen-anim");var PlayState;!function(e){e[e.STOP=0]="STOP",e[e.PLAYING=1]="PLAYING",e[e.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));const AnimEditState={record:!1,dirty:!1,playState:PlayState.STOP},skelAnimAllowOperations=["addEvent","deleteEvent","updateEvent","moveEvents","copyEventsTo","changeSpeed","changeWrapMode","changeSample","copyEvent","addEmbeddedPlayer","updateEmbeddedPlayer","deleteEmbeddedPlayer","clearEmbeddedPlayer","addEmbeddedPlayerGroup","removeEmbeddedPlayerGroup","clearEmbeddedPlayerGroup","addAuxiliaryCurve","removeAuxiliaryCurve","renameAuxiliaryCurve","createAuxKey","removeAuxKey","copyAuxKey","moveAuxKeys","modifyAuxCurveOfKey"],keysOperations=["createKey","moveKeys","removeKey","updateKey","copyKeysTo","spacingKeys","clearKeys","copyPropTo","changeWrapMode"];class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}const animationComponentName=cc_1.js.getClassName(cc_1.AnimationComponent);class AnimationManager extends events_1.EventEmitter{get curEditClipUuid(){return this._curEditClipUuid}set curEditTime(e){this._curEditTime!==e&&(this._curEditTime=e,message_1.messageManager.broadcast("scene:animation-time-change",e),this.emit("scene:animation-time-change",e))}get curEditRootNodeUuid(){return this._curEditRootNodeUuid}set curEditRootNodeUuid(e){this._curEditRootNodeUuid=e}set curDefaultClip(e){this._curDefaultClip=e}constructor(){super(),this._lastSaveClipDump=null,this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditAnimClip=null,this._curEditTime=0,this._animUpdateInterval=null,this._isDirty=!1,this._componentDirty=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this.isNewClip=!0,this.init(),node_1.default.on("gizmo-control-end",this.onNodeChanged.bind(this))}init(){this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditTime=0}setCurDefaultClipByUuid(e){e?cc_1.assetManager.loadAny(e,(e,t)=>{e?console.error(e):this._curDefaultClip=t}):this._curDefaultClip=null}async record(e,t,i){var n;if(t)return!!e&&(!!(i=i||this._curEditRootNodeUuid||(null===(n=this.queryNodeAnimationData(e).defaultClip)||void 0===n?void 0:n._uuid))&&(this._isInEdit=!0,AnimEditState.record=!0,this._curEditRootNodeUuid=e,i&&this._curEditClipUuid!==i&&await this.setEditClip(i),await this.registerAndFireEvents(e,this._curEditClipUuid),this.emit("scene:animation-clip-change",e,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100)),this.storeData(),this.setCurEditTime(0),this.emit("scene:animation-record-start"),!0));{if(!this._isInEdit)return!1;try{this.stop()}catch(e){console.error(e)}this.changePlayState(PlayState.STOP);const e=this.queryRecordAnimState();if(e)try{this._unregisterAnimStateEVents(e),null===e||void 0===e||e.destroy()}catch(e){console.error(e)}return this._curEditRootNodeUuid="",AnimEditState.record=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),this.clearAnimationState(),cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE),this.emit("scene:animation-record-end"),!0}}storeData(){}restoreData(){}_registerAnimStateEvents(e){e&&(e.on("finished",this._onAnimPlayEnd,this),e.on("play",this._onAnimPlay,this),e.on("pause",this._onAnimPause,this),e.on("resume",this._onAnimResume,this),e.on("stop",this._onAnimStopped,this))}_unregisterAnimStateEVents(e){e&&(e.off("finished",this._onAnimPlayEnd,this),e.off("play",this._onAnimPlay,this),e.off("pause",this._onAnimPause,this),e.off("resume",this._onAnimResume,this),e.off("stop",this._onAnimStopped,this))}isComponentDirty(){return this._componentDirty}setComponentDirty(e){this._componentDirty=e}isDirty(){return this._isDirty}async saveCheck(e){if(e||(e=this.queryRecordAnimState()),!e)return!0;const t=e=>{Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"AnimatorSave",value:{save_result:`save_result_${e}`}})};if(this.isDirty()){switch(await cce.Ipc.send("dirty-dialog",e.clip.name+".anim")){case 0:case"0":await this.save(),t(1);break;case 1:case"1":await this.restoreFromDump(this._curEditRootNodeUuid,this._curEditClipUuid,this._lastSaveClipDump),t(2);break;case 2:case"2":return!1}}return!0}registerAndFireEvents(e,t){var i;const n=this.queryNodeAnimationData(e),a=null===(i=n.clips)||void 0===i?void 0:i.find(e=>(null===e||void 0===e?void 0:e._uuid)===t);if(!a)return!1;const s=this.queryAnimState(a);return!!s&&(this._curDefaultClip=n.defaultClip,utils_1.utils.initAninState(s,n.node),this._registerAnimStateEvents(s),this._isDirty=!1,this._lastSaveClipDump=this.dumpClip(e,t),this._curEditAnimClip=new editor_animation_clip_1.default(n.node,t,s),this.curEditTime=0,!0)}async changeAnimNode(e,t){if(!e||!t)return!1;if(!this._isInEdit)return!1;const i=this.queryRecordAnimState();return!!i&&(!!await this.saveCheck(i)&&(this.stop(),this._unregisterAnimStateEVents(i),!!scene_1.default.modes.animation.open(e)&&(await this.setEditClip(t),!0)))}async enter(e,t){if(this.isNewClip=!1,this._curEditAnimClip){const e=await this._curEditAnimClip.getDumpData();this.isNewClip=0===(null===e||void 0===e?void 0:e.curves.length)&&!this.isSkeletonClip(t)}else{const e=await Editor.Message.request("asset-db","query-asset-info",t);this.isNewClip=Boolean(e)}Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"hippoAnimator",value:{project_id:Editor.Project.uuid,clip_id:t,version:Editor.App.version}})}async save(){const e=await this.saveClip(this._curEditClipUuid);return await this.trackUserData(),e}async saveClip(e){const t=this.queryRecordAnimState();if(!t)return!1;const i=t.clip,n=cce.Utils.serialize(i);if(this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,e),this.isSkeletonClip(e)){const e=await cce.Ipc.send("query-asset-meta",i._uuid);if(e&&e.userData){const t=utils_1.utils.queryEvents(i);t?e.userData.events=t.map(e=>({frame:e.frame,func:e.func,params:e.params})):console.error("Event data error"),e.userData.embeddedPlayers=Array.from(i[embedded_player_1.getEmbeddedPlayersTag]()).map(e=>({begin:e.begin,end:e.end,reconciledSpeed:e.reconciledSpeed,editorExtras:{group:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].group,displayName:e[cc_1.editorExtrasTag]&&e[cc_1.editorExtrasTag].displayName},playable:utils_1.utils.getPlayableInfo(e.playable)})),e.userData.editorExtras={embeddedPlayerGroups:i[cc_1.editorExtrasTag].embeddedPlayerGroups},e.userData.wrapMode=i.wrapMode,e.userData.speed=i.speed,e.userData.sample=i.sample,e.userData.auxiliaryCurves=(0,utils_1.getSerializedAuxCurves)(i),await cce.Ipc.send("save-asset-meta",i._uuid,JSON.stringify(e))}}else{const e=await cce.Ipc.send("query-asset-info",i._uuid);if(e)await cce.Ipc.send("save-asset",e.url,n);else{const e="db://assets/"+i.name+".anim";await cce.Ipc.send("create-asset",e,n)}}return this._isDirty=!1,this.emit("scene:animation-save",this.curEditRootNodeUuid,i._uuid),!0}async trackUserData(){const e=new Set,t=new Set;let i=0,n=0;const a=new Set,s=new Set;let r=0;const o=new Set,u={project_id:Editor.Project.uuid,version:Editor.App.version,is_new:`is_new_${this.isNewClip?1:2}`,clip_id:this._curEditClipUuid,is_skeleton:`is_skeleton_${this.isSkeletonClip(this._curEditClipUuid)?1:2}`};if(this._curEditAnimClip){const d=await this._curEditAnimClip.getDumpData();if(d){n=d.duration*d.sample|0;for(const t in d.auxiliaryCurves){const i=d.auxiliaryCurves[t];e.add(t),i.keyframes&&i.keyframes.forEach(e=>{s.add(e.frame)})}for(let e=0;e<d.curves.length;e++){const n=d.curves[e];n.parentPropKey||(t.add(n.nodePath),i++,n.keyframes&&n.keyframes.forEach(e=>{a.add(e.frame),"position"===n.key&&o.add(e.frame)}),"position"===n.key&&r++)}u.auxiliary_curve_no=e.size,u.auxiliary_curve_frame_no=s.size,u.node_no=t.size,u.property_no=i,u.frame_no=n,u.key_frame_no=a.size,u.position_no=r,u.position_frame_no=o.size}}Editor.Metrics.trackEvent({sendToNewCocosAnalyticsOnly:!0,category:"AnimatorSave",value:u})}isSkeletonClip(e){if(!e)return!1;return e.indexOf("@")>=0}needLock(e,t){const i=this.queryNodeAnimationData(e).animComp;return!!(i&&i instanceof cc_1.SkeletalAnimation)||this.isSkeletonClip(t)}getEditAnimationInfo(){return{rootid:this._curEditRootNodeUuid,clipid:this._curEditClipUuid}}getSerializedEditClip(){if(!this._isInEdit)return null;if(!this._curEditClipUuid)return null;const e=this.queryRecordAnimState();if(!e||!e.clip)return null;const t=e.clip;return cce.Utils.serialize(t)}queryAnimationNodeEditInfo(e){var t;const i={state:"failure",result:null};if(!node_1.default.query(e))return i.reason=`Animation node(${e}) doesn't exist`,i;const n=(this._isInEdit?this._curEditRootNodeUuid:null)||this.queryAnimationRoot(e);i.state="success",i.result={root:n};const a=this.queryNodeAnimationData(n);return i.result.node=cce.Scene.queryNodeTree(n),Object.assign(i.result,{aniComp:a.animComp&&cc.js.getClassName(a.animComp)||"",clipsMenu:a.clips&&utils_1.utils.decodeClipsMenu(a.clips)||[],defaultClip:null===(t=a.defaultClip)||void 0===t?void 0:t._uuid,root:n}),i}queryRecordAniClips(){return this.queryRecordAniData().clips}queryRecordAniData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryRecordAnimState(e,t){e=e||this._curEditClipUuid,t=t||this._curEditRootNodeUuid;const i=this.queryAnimationClip(e,t);return i&&this.queryAnimState(i)}queryRecordAnimData(){return this.queryNodeAnimationData(this._curEditRootNodeUuid)}queryAnimationClip(e,t){var i;const n=this.queryNodeAnimationData(t);return n&&(null===(i=n.clips)||void 0===i?void 0:i.find(t=>(null===t||void 0===t?void 0:t._uuid)===e))}queryNodeAnimationData(e){var t;const i={defaultClip:null};if(!e)return console.debug(`Node(${e}) doesn't exist`),i;let n=null;if(!(n="string"==typeof e?node_1.default.query(e):e))return console.debug(`Node(${e}) doesn't exist`),i;i.node=n;let a=[];const s=this.queryAnimComp(n);return s?(s instanceof cc_1.animation.AnimationController?(a=(0,utils_1.uniqAnimationClips)([...(0,new_gen_anim_1.visitAnimationClipsInController)(s)]),i.animComp=s):(a=(0,utils_1.uniqAnimationClips)(s.clips),i.animComp=s,i.defaultClip=s.defaultClip),i.clips=a.filter(e=>!!(null===e||void 0===e?void 0:e.name)),i.defaultClip=i.defaultClip||a[0],(null===(t=i.defaultClip)||void 0===t?void 0:t.name)||(i.defaultClip=null),i):i}queryAnimComp(e){const t=e.getComponent(cc_1.animation.AnimationController);return t||e.getComponent(cc_1.Animation)}queryAnimState(e,t=!1){if(!e.name)return null;let i=null;return this._animationStateMap.has(e._uuid)?i=this._animationStateMap.get(e._uuid):!1===t&&((i=new cc_1.AnimationState(e))._setEventTarget(this._eventTarget),this._animationStateMap.set(e._uuid,i)),i}queryAnimClipsInfo(e,t){var i;return(t=t||this.queryNodeAnimationData(e)).clips?{clipsMenu:utils_1.utils.decodeClipsMenu(t.clips),defaultClip:null===(i=t.defaultClip)||void 0===i?void 0:i._uuid}:null}queryPlayState(){return AnimEditState.playState}async setEditClip(e){if(!e)return console.log("Clip uuid is empty"),!1;if(e===this._curEditClipUuid)return!0;if(this._isInEdit){const t=this.queryRecordAnimState();if(t){if(!await this.saveCheck(t))return!1;this._unregisterAnimStateEVents(t)}if(!this.queryRecordAnimState(e))return!1;this.stop(),this._curEditClipUuid=e,await this.registerAndFireEvents(this._curEditRootNodeUuid,e),cce.Engine.repaintInEditMode()}else this._curEditClipUuid=e;return this.emit("scene:animation-clip-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),!0}setCurEditTime(e){if(this._curEditTime=e,!this._isInEdit)return!1;const t=this.queryRecordAnimState();if(!t)return!1;let i=e;i>t.duration&&(i=t.duration),t.weight=1,t.setTime(i),t.isPaused||t.pause();try{t.sample()}catch(e){console.error(e)}return cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:animation-time-change",i),this.emit("scene:animation-time-change",i),!0}changePlayState(e){switch(AnimEditState.playState=e,e){case PlayState.PLAYING:cce.Engine.enterState(cce.NeedAnimState.ANIMATION_MODE);break;case PlayState.PAUSE:case PlayState.STOP:cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE)}message_1.messageManager.broadcast("scene:animation-state-change",AnimEditState.playState)}play(e){const t=this._animationStateMap.get(e);return!!t&&(t.weight=1,t.isPlaying&&t.isPaused?t.resume():t.play(),cce.Engine.repaintInEditMode(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PLAY),!0)}pause(){const e=this._animationStateMap.get(this._curEditClipUuid);return!!e&&(e.pause(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.PAUSE),this._curEditTime=this.queryPlayingClipTime(),cce.Engine.repaintInEditMode(),!0)}resume(){const e=this._animationStateMap.get(this._curEditClipUuid);return!!e&&(e.isPlaying||(e.weight=1,e.play()),e.resume(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.RESUME),cce.Engine.repaintInEditMode(),!0)}stop(){const e=this._animationStateMap.get(this._curEditClipUuid);if(!e)return!1;e.setTime(0),this._curEditTime=0,e.isPaused||e.pause();try{e.sample()}catch(e){console.error(e)}return e.stop(),this.emit("scene:animation-state-change",cc_1.Animation.EventType.STOP),cce.Engine.repaintInEditMode(),this.changePlayState(PlayState.STOP),!0}async queryAnimationClipDump(e,t){DEBUG_TIME_COST&&console.time("queryClipDumpCost");const i=this.queryRecordAnimState(t,e);if(!i)return!1;const n=this.queryNodeAnimationData(e);let a=this._curEditAnimClip;this._curEditAnimClip&&this._curEditAnimClip.rootNode===n.node&&this._curEditClipUuid===t||(a=new editor_animation_clip_1.default(n.node,t,i)),Editor.Metrics.trackTimeStart("scene:query-animation-clip-dump");const s=await a.getDumpData();return Editor.Metrics.trackTimeEnd("scene:query-animation-clip-dump",{output:!0,label:`scene:query-animation-clip-dump ${t}`}),this.needLock(e,t)&&s&&(s.isLock=!0),DEBUG_TIME_COST&&console.timeEnd("queryClipDumpCost"),"2d"===cce.SceneFacadeManager._projectType&&s&&(s.curves=s.curves.filter(e=>("position"!==e.key&&"scale"!==e.key||(e.partKeys=e.partKeys.filter(e=>!e.includes(".z"))),"eulerAngles"===e.key&&(e.partKeys=e.partKeys.filter(e=>e.includes(".z"))),!["position.z","eulerAngles.x","eulerAngles.y","scale.z"].includes(e.key)))),s}dumpClip(e,t){const i=this.queryAnimationClip(t,e);if(!i)return null;const n=this.queryAnimState(i);return n?cce.Utils.serialize(n.clip):null}restoreFromDump(e,t,i){var n;const a=this.queryNodeAnimationData(e),s=null===(n=a.clips)||void 0===n?void 0:n.find(e=>(null===e||void 0===e?void 0:e._uuid)===t);if(!s)return!1;const r=this.queryAnimState(s);if(!r)return!1;utils_1.utils.initAninState(r,a.node);const o=r.clip;return new Promise((n,s)=>{utils_1.utils.loadJsonWithUuid(t,i,async(i,u)=>{i?s(i):u&&(utils_1.utils.copyClip(o,u),this._curEditAnimClip=new editor_animation_clip_1.default(a.node,t,r),await this._curEditAnimClip.updateCurveData(),this._isDirty=!0,this.setCurEditTime(this._curEditTime),this.emit("scene:animation-change",e,t,"undo"),message_1.messageManager.broadcast("scene:animation-change",e,t),n(!0))})})}queryAnimationRoot(e){let t=node_1.default.query(e);if(t)do{if(this.queryAnimComp(t))return t.uuid;t=t.parent}while(t);return e}async queryAnimationRootInfo(e){const t=cce.Scene.queryNodeTree(e),i=this.queryNodeAnimationData(e),n=this.queryAnimClipsInfo(e,i);if(!n||n&&n.clipsMenu&&0===n.clipsMenu.length)return{root:e,nodeTreeDump:t};const a=n.defaultClip;let s=!1;return i.animComp instanceof cc_1.SkeletalAnimation&&(s=i.animComp.useBakedAnimation),{root:e,nodeTreeDump:t,clipsMenu:n.clipsMenu,defaultClip:a,clipDump:a?await this.queryAnimationClipDump(e,a):null,time:this.queryPlayingClipTime(a),state:this.queryPlayState(),useBakedAnimation:s}}queryProperties(e){const t=node_1.default.query(e);if(!t)return console.debug(`Animation node(${e})doesn't exist`),[];let i=t;for(;i&&!i.getComponent(cc_1.Animation);){if(i.parent instanceof cc_1.Scene){i=t;break}i=i.parent}const n=utils_1.utils.getAnimableProperties(t,i!==t);let a=[];return n&&(a=n),a}queryPlayingClipTime(e){if(!this._isInEdit)return 0;e=e||this._curEditClipUuid;const t=this._animationStateMap.get(e);return t?t.current:0}async getPropValueAtFrame(e,t,i,n){return this._animationStateMap.get(e)?e!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${e}`),null):this._curEditAnimClip?await this._curEditAnimClip.getPropValueAtFrame(t,i,n):null:null}async getAuxCurveValueAtFrame(e,t,i){return this._animationStateMap.get(e)?e!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${e}`),null):this._curEditAnimClip?this._curEditAnimClip.getAuxCurveValueAtFrame(t,i):null:null}async getAllPropValueAtFrame(e,t,i,n){const a={};return await Promise.all(i.map(async i=>{a[i]=await this.getPropValueAtFrame(e,t,i,n)})),a}async operation(e,t){var i;const n={state:"success",result:!0};let a=!1;const s=null===(i=null===t||void 0===t?void 0:t.recordUndo)||void 0===i||i;let r;s&&(r=await cce.SceneFacadeManager.beginRecording(this._curEditRootNodeUuid,{external:{animation:!0}}));for(let t=0;t<e.length;t++){const i=e[t],s=i.funcName,r=i.args;if(this.needLock(this._curEditRootNodeUuid,this._curEditClipUuid)&&!skelAnimAllowOperations.includes(s)){n.reason=`Method '${s}' does not allowed in skeleton animation.`,n.state="failure",console.log(n.reason);break}const o=r[0];if(o!==this._curEditClipUuid){n.state="failure",n.reason=`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${o}`,console.log(n.reason);break}if(!this._curEditAnimClip[s]){n.state="failure",n.reason=`Method '${s}' does not exist to manipulate the animation.`,console.log(n.reason);break}r.splice(0,1);try{if(!await this._curEditAnimClip[s](...r)){n.state="failure",n.reason=`call method ${s} failed`,console.log(n.reason);break}keysOperations.includes(s)&&(a=!0)}catch(e){console.error(e),n.state="failure",n.reason=`call method ${s} failed`;break}}return"success"===n.state?(a&&this.setCurEditTime(this._curEditTime),this._isDirty=!0,cce.Engine.repaintInEditMode(),this.emit("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid)):n.result=!1,s&&"string"==typeof r&&(n.result?cce.SceneFacadeManager.endRecording(r):cce.SceneFacadeManager.cancelRecording(r)),n}async onNodeChanged(e,t={}){if(!AnimEditState.record)return;if((null===t||void 0===t?void 0:t.source)===event_enum_1.EventSourceType.ENGINE)return;const i=t.propPath;if(!e||!i||"string"!=typeof i)return;const n=node_1.default.query(this._curEditRootNodeUuid);if(!n)return;const a=this.queryRecordAnimState();if(!a)return void console.log(`AnimationState of '(${this._curEditClipUuid})' clip doesn't exist`);if(!this._curEditAnimClip)return;const s=utils_1.utils.getNodePathFromAnimRoot(n,e);if(!s)return;const r=[],o=utils_1.utils.generateHierarchyPath(s);o&&r.push(o);const u=node_2.default.getNameDataByPropPath(e,i);u.compName===animationComponentName&&this.setComponentDirty(!0);let d=u.propName;const c=u.compName,l=u.propName;c&&(r.push(new cc_1.animation.ComponentPath(c)),d=c+"."+d);const m=a.clip;let p=null;if("rotation"===l?(p=this._curEditAnimClip.getCreatedCurve(s,"eulerAngles"))?d="eulerAngles":(d=l,p=this._curEditAnimClip.getCreatedCurve(s,d)):p=this._curEditAnimClip.getCreatedCurve(s,d),!p)return;const h=m.sample,_=Math.round(this._curEditTime*h);p.hasKey(_)?await this.operation([{funcName:"updateKey",args:[this._curEditClipUuid,s,d,[_]]}]):await this.operation([{funcName:"createKey",args:[this._curEditClipUuid,s,d,_,null]}])}_onAnimPlay(){this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),message_1.messageManager.broadcast("scene:animation-time-change",0)}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime),this.emit("scene:animation-time-change",this._curEditTime)}update(){AnimEditState.playState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime))}onAssetDeleted(e){if(!e)return;const t=this.queryRecordAniClips();if(!t)return;let i=!1;for(let n=0;n<t.length;n++)t[n]&&t[n]._uuid===e&&(i=!0);i&&this._isInEdit&&(this._isDirty=!1,cce.SceneFacadeManager.closeScene())}onAssetRefreshed(e){var t;if(!e)return;const i=this.queryRecordAnimData(),n=null===(t=i.clips)||void 0===t?void 0:t.find(t=>(null===t||void 0===t?void 0:t._uuid)===e);if(n&&(i.animComp instanceof cc_1.Animation&&i.clips&&i.clips.length>0&&n&&i.animComp instanceof cc_1.Animation&&(i.animComp.defaultClip=this._curDefaultClip,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid)),e===this._curEditClipUuid)){let e=this._curEditRootNodeUuid;if(!e){const t=selection_1.default.query();t.length>0&&(e=t[0])}this.removeAnimationState(this._curEditClipUuid);const t=this.queryAnimState(n);t&&(utils_1.utils.initAninState(t,i.node),this._curEditAnimClip=new editor_animation_clip_1.default(i.node,this._curEditClipUuid,t)),this.emit("scene:animation-change",e,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",e,this._curEditClipUuid)}}removeAnimationState(e){const t=this._animationStateMap.get(e);t&&(this.pause(),this._registerAnimStateEvents(t),t.destroy(),this._animationStateMap.delete(e))}clearAnimationState(){this._animationStateMap.forEach((e,t)=>{this.removeAnimationState(t)})}onSceneOpened(e){if(!this._isInEdit)return;this.storeData(),this.removeAnimationState(this._curEditClipUuid);const t=this.queryRecordAnimData(),i=this.queryRecordAnimState();i&&this._registerAnimStateEvents(i),this._curEditAnimClip?this._curEditAnimClip.refreshData(t.node,this._curEditClipUuid):this._curEditAnimClip=new editor_animation_clip_1.default(t.node,this._curEditClipUuid,i),this.setCurEditTime(this._curEditTime)}async queryAuxiliaryCurves(e){const t=this._curEditAnimClip;return t&&t.clipUUID===e?await t.getAuxiliaryCurves():{}}}exports.AnimationManager=AnimationManager,exports.default=new AnimationManager;