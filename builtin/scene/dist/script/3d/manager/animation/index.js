"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const event_enum_1=require("../../../public/event-enum"),cc_1=require("cc"),{EventEmitter:EventEmitter}=require("events"),node_1=__importDefault(require("../node")),scene_1=__importDefault(require("../scene")),selection_1=__importDefault(require("../../../public/selection")),utils_1=require("./utils"),editor_animation_clip_1=__importDefault(require("./editor-animation-clip")),node_2=__importDefault(require("../../../utils/node")),message_1=require("../message");var PlayState;!function(t){t[t.STOP=0]="STOP",t[t.PLAYING=1]="PLAYING",t[t.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));const AnimEditState={record:!1,dirty:!1,playState:PlayState.STOP},skelAnimAllowOperations=["addEvent","deleteEvent","updateEvent","moveEvents","copyEventsTo","changeSpeed","changeWrapMode","changeSample","copyEvent"],keysOperations=["createKey","moveKeys","removeKey","updateKey","copyKeysTo","spacingKeys","clearKeys","copyPropTo"];class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}class AnimationManager extends EventEmitter{constructor(){super(),this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditAnimClip=null,this._curEditTime=0,this._stateWrappedInfo={},this._animUpdateInterval=null,this._isDirty=!1,this._needRecallPlay=!0,this._isInEdit=!1,this._curDefaultClip=null,this._isUseBakedAnimation=!0,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this.init(),node_1.default.on("gizmo-control-end",this.onNodeChanged.bind(this))}get curEditClipUuid(){return this._curEditClipUuid}get curEditRootNodeUuid(){return this._curEditRootNodeUuid}set curEditRootNodeUuid(t){this._curEditRootNodeUuid=t}set curDefaultClip(t){this._curDefaultClip=t}init(){this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditTime=0}setCurDefaultClipByUuid(t){t?cc_1.assetManager.loadAny(t,(t,e)=>{t?console.error(t):this._curDefaultClip=e}):this._curDefaultClip=null}async record(t,e){if(!e){if(!this._isInEdit)return!1;const t=this.queryRecordAnimData();try{this.stop()}catch(t){console.error(t)}return this.changePlayState(PlayState.STOP),t&&this._unregisterAnimStateEVents(t.animState),this._curEditRootNodeUuid="",AnimEditState.record=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE),!0}if(t){this._isInEdit=!0,AnimEditState.record=!0,this._curEditRootNodeUuid=t,this._needRecallPlay=!0,await this.registerAndFireEvents(t,this._curEditClipUuid),this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100));const e=this.queryRecordAnimComp();return e&&(this._curDefaultClip=e.defaultClip),this.storeData(),this.setCurEditTime(0),!0}return!1}storeData(){const t=this.queryRecordAnimComp();t&&this._curEditRootNodeUuid&&t instanceof cc_1.SkeletalAnimation&&(this._isUseBakedAnimation=t.useBakedAnimation,t.useBakedAnimation=!1,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid))}restoreData(){const t=this.queryRecordAnimData();t.animComp&&t.animComp instanceof cc_1.SkeletalAnimation&&(t.animComp.useBakedAnimation=this._isUseBakedAnimation)}_registerAnimStateEvents(t){t&&(t.on("finished",this._onAnimPlayEnd,this),t.on("play",this._onAnimPlay,this),t.on("pause",this._onAnimPause,this),t.on("resume",this._onAnimResume,this),t.on("stop",this._onAnimStopped,this))}_unregisterAnimStateEVents(t){t&&(t.off("finished",this._onAnimPlayEnd,this),t.off("play",this._onAnimPlay,this),t.off("pause",this._onAnimPause,this),t.off("resume",this._onAnimResume,this),t.off("stop",this._onAnimStopped,this))}isDirty(){return this._isDirty}async saveCheck(t){if(t){if(t.animState&&this.isDirty()){const e=utils_1.utils.getClipName(this._curEditClipUuid,t.animComp);switch(await cce.Ipc.send("dirty-dialog",e+".anim")){case 0:case"0":await this.save();break;case 1:case"1":await this.restoreFromDump(this._curEditRootNodeUuid,this._curEditClipUuid,this._lastSaveClipDump);break;case 2:case"2":return!1}}}return!0}async registerAndFireEvents(t,e){const i=this.queryNodeAnimationData(t,e),n=i.animState;n&&(n._curveLoaded=!1,n.initialize(i.node),this._registerAnimStateEvents(n),this._isDirty=!1,this._lastSaveClipDump=this.dumpClip(t,e),this._curEditAnimClip=new editor_animation_clip_1.default(i.node,e,n)),this.emit("scene:animation-clip-change",t,e),message_1.messageManager.broadcast("scene:animation-clip-change",e)}async changeAnimNode(t,e){if(!t||!e)return!1;if(!this._isInEdit)return!1;const i=this.queryRecordAnimData();return!!await this.saveCheck(i)&&(this.stop(),i&&this._unregisterAnimStateEVents(i.animState),!!scene_1.default.modes.animation.open(t)&&(this.setEditClip(e),await this.registerAndFireEvents(t,e),!0))}async save(){return this.saveClip(this._curEditClipUuid)}async saveClip(t){const e=this.queryRecordAnimState(t);if(!e)return!1;const i=e.clip,n=cce.Utils.serialize(i);if(this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,t),this.isSkeletonClip(t)){const t=await cce.Ipc.send("query-asset-meta",i._uuid);if(t&&t.userData){const e=utils_1.utils.queryEvents(i);e?t.userData.events=e.map(t=>({frame:t.frame,func:t.func,params:t.params})):console.error("Event data error"),t.userData.wrapMode=i.wrapMode,t.userData.speed=i.speed,t.userData.sample=i.sample,await cce.Ipc.send("save-asset-meta",i._uuid,cce.Utils.serialize(t))}}else{const t=await cce.Ipc.send("query-asset-info",i._uuid);if(t)await cce.Ipc.send("save-asset",t.url,n);else{const t="db://assets/"+i.name+".anim";await cce.Ipc.send("create-asset",t,n)}}return this._isDirty=!1,!0}isSkeletonClip(t){if(!t)return!1;return t.indexOf("@")>=0}needLock(t,e){const i=this.queryNodeAnimationData(t).animComp;return!!(i&&i instanceof cc_1.SkeletalAnimation)||this.isSkeletonClip(e)}getEditAnimationInfo(){return{rootid:this._curEditRootNodeUuid,clipid:this._curEditClipUuid}}getSerializedEditClip(){if(!this._isInEdit)return null;if(!this._curEditClipUuid)return null;const t=this.queryRecordAnimState(this._curEditClipUuid);if(!t||!t.clip)return null;const e=t.clip;return cce.Utils.serialize(e)}queryRecordNode(){const t=this._curEditRootNodeUuid,e=node_1.default.query(t);return e||console.warn(`Animation node(${t}) doesn't exist`),e}queryRecordAnimComp(){const t=this._curEditRootNodeUuid;return this.queryNodeAnimationData(t).animComp}queryRecordAnimState(t){return this.queryRecordAnimData(t).animState}queryRecordAnimData(t){return t=t||this._curEditClipUuid,this.queryNodeAnimationData(this._curEditRootNodeUuid,t)}queryNodeAnimationData(t,e){const i={};if(!t)return console.debug(`Node(${t}) doesn't exist`),i;let n=null;if(!(n="string"==typeof t?node_1.default.query(t):t))return console.debug(`Node(${t}) doesn't exist`),i;i.node=n;const a=n.getComponent(cc_1.Animation);if(!a)return console.debug(`Node(${t}) lacks Animation`),i;if(i.animComp=a,!e)return i;let s=null;if(a.clips.forEach(t=>{t&&t._uuid===e&&(s=t)}),!s)return i;let r=null;return this._animationStateMap.has(e)?r=this._animationStateMap.get(e):((r=new cc_1.AnimationState(s)).initialize(n),r._setEventTarget(this._eventTarget),this._animationStateMap.set(e,r)),i.animState=r,i}queryAnimClipsInfo(t){const e=this.queryNodeAnimationData(t).animComp;if(!e)return null;const i=e.clips,n=[];i.forEach(t=>{if(t){const e={name:t.name,uuid:t._uuid};n.push(e)}});let a=e.defaultClip?e.defaultClip._uuid:void 0;return!a&&i[0]&&(a=i[0]._uuid),{clipsMenu:n,defaultClip:a}}queryPlayState(){return AnimEditState.playState}async setEditClip(t){if(!t)return console.log("Clip uuid is empty"),!1;if(t===this._curEditClipUuid)return!0;if(this._isInEdit){const e=this._curEditClipUuid,i=this.queryRecordAnimData(e);if(i){if(!await this.saveCheck(i))return!1;this._unregisterAnimStateEVents(i.animState)}const n=this.queryRecordAnimData(t),a=n.animState;if(!a)return!1;this.stop(),this._curEditClipUuid=t,this._isDirty=!1,this._curEditAnimClip=new editor_animation_clip_1.default(n.node,t,a),this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,t),a.initialize(n.node),a.setTime(0),message_1.messageManager.broadcast("scene:animation-time-change",0),this._registerAnimStateEvents(a),this._curEditTime=0,this._needRecallPlay=!0}else this._curEditClipUuid=t;return this.emit("scene:animation-clip-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),!0}setCurEditTime(t){if(this._curEditTime=t,!this._isInEdit)return!1;const e=this.queryRecordAnimState(this._curEditClipUuid);if(!e)return!1;let i=t;i>e.duration&&(i=e.duration),e.weight=1,this._needRecallPlay&&e.play(),e.setTime(i),e.isPaused||e.pause();try{e.sample()}catch(t){console.error(t)}return cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:animation-time-change",i),!0}changePlayState(t){switch(AnimEditState.playState=t,t){case PlayState.PLAYING:cce.Engine.enterState(cce.NeedAnimState.ANIMATION_MODE);break;case PlayState.PAUSE:case PlayState.STOP:cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE)}message_1.messageManager.broadcast("scene:animation-state-change",AnimEditState.playState)}play(t){t=t||this._curEditClipUuid;const e=this.queryRecordAnimData(t).animState;return!!e&&(e.setTime(0),e.weight=1,e.play(),cce.Engine.repaintInEditMode(),!0)}pause(){const t=this.queryRecordAnimData().animState;return!!t&&(t.pause(),cce.Engine.repaintInEditMode(),this._curEditTime=this.queryPlayingClipTime(),!0)}resume(){const t=this.queryRecordAnimData().animState;return!!t&&(t.isPlaying||(t.weight=1,t.play()),t.resume(),cce.Engine.repaintInEditMode(),!0)}stop(){const t=this.queryRecordAnimData().animState;if(!t)return!1;t.setTime(0),this._curEditTime=0,this._needRecallPlay&&t.play(),t.isPaused||t.pause();try{t.sample()}catch(t){console.error(t)}return t.stop(),cce.Engine.repaintInEditMode(),!0}async queryClip(t,e){DEBUG_TIME_COST&&console.time("queryClipDumpCost");const i=this.queryNodeAnimationData(t,e);if(!i.animComp)return null;const n=i.animState;if(!n)return null;let a=this._curEditAnimClip;this._curEditAnimClip&&this._curEditAnimClip.rootNode===i.node&&this._curEditClipUuid===e||(a=new editor_animation_clip_1.default(i.node,e,n));const s=await a.getDumpData();return this.needLock(t,e)&&s&&(s.isLock=!0),DEBUG_TIME_COST&&console.timeEnd("queryClipDumpCost"),s}dumpClip(t,e){const i=this.queryNodeAnimationData(t,e).animState;return i?cce.Utils.serialize(i.clip):null}async restoreFromDump(t,e,i){const n=this.queryNodeAnimationData(t,e);if(!n.animComp)return!1;const a=n.animState;if(!a)return!1;const s=a.clip;return new Promise((r,o)=>{utils_1.utils.loadJsonWithUuid(e,i,async(i,u)=>{i?o(i):u&&(utils_1.utils.copyClip(s,u),this._curEditAnimClip=new editor_animation_clip_1.default(n.node,e,a),await this._curEditAnimClip.updateCurveData(),this._isDirty=!0,this.setCurEditTime(this._curEditTime),this.emit("scene:animation-change",t,e,"undo"),message_1.messageManager.broadcast("scene:animation-change",t,e),r(!0))})})}queryAnimationRoot(t){let e=node_1.default.query(t);if(e)do{if(e.getComponent(cc_1.Animation))return e.uuid;e=e.parent}while(e);return null}async queryAnimationRootInfo(t){const e=cce.Scene.queryNodeTree(t),i=this.queryAnimClipsInfo(t);if(!i||i&&i.clipsMenu&&0===i.clipsMenu.length)return{root:t,nodeTreeDump:e};const n=i.defaultClip;return{root:t,nodeTreeDump:e,clipsMenu:i.clipsMenu,defaultClip:n,clipDump:await this.queryClip(t,n),time:this.queryPlayingClipTime(n),state:this.queryPlayState()}}queryProperties(t){const e=node_1.default.query(t);e||console.log(`Animation node(${t})doesn't exist`);let i=e;for(;i&&!i.getComponent(cc_1.Animation);){if(i.parent instanceof cc_1.Scene){i=e;break}i=i.parent}const n=utils_1.utils.getAnimableProperties(e,i!==e);let a=[];return n&&(a=n),a}queryPlayingClipTime(t){if(!this._isInEdit)return 0;t=t||this._curEditClipUuid;const e=this.queryRecordAnimState(t);return e?e.current:0}async getPropValueAtFrame(t,e,i,n){return this.queryRecordAnimData(t).animState?t!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${t}`),null):this._curEditAnimClip?await this._curEditAnimClip.getPropValueAtFrame(e,i,n):null:null}async getAllPropValueAtFrame(t,e,i,n){const a={};return await Promise.all(i.map(async i=>{a[i]=await this.getPropValueAtFrame(t,e,i,n)})),a}async operation(t){let e=!0,i=!1;cce.SceneFacadeManager.snapshot();for(let n=0;n<t.length;n++){const a=t[n],s=a.funcName,r=a.args;if(this.needLock(this._curEditRootNodeUuid,this._curEditClipUuid)&&!skelAnimAllowOperations.includes(s))return console.warn(`Method '${s}' does not allowed in skeleton animation.`),!1;const o=r[0];if(o!==this._curEditClipUuid)return console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${o}`),!1;if(!this._curEditAnimClip[s])return console.warn(`Method '${s}' does not exist to manipulate the animation.`),!1;r.splice(0,1),await this._curEditAnimClip[s](...r)?keysOperations.includes(s)&&(i=!0):(console.warn(`call method ${s} failed`),e=!1)}return e&&(this._needRecallPlay=!0,i&&this.setCurEditTime(this._curEditTime),this._isDirty=!0,cce.Engine.repaintInEditMode(),this.emit("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid)),e}async onNodeChanged(t,e){if(!AnimEditState.record)return;if((null===e||void 0===e?void 0:e.source)===event_enum_1.EventSourceType.ENGINE)return;const i=e.propPath;if(!t||!i||"string"!=typeof i)return;const n=node_1.default.query(this._curEditRootNodeUuid);if(!n)return;const a=this.queryRecordAnimState(this._curEditClipUuid);if(!a)return void console.log(`AnimationState of '(${this._curEditClipUuid})' clip doesn't exist`);if(!this._curEditAnimClip)return;const s=utils_1.utils.getNodePathFromAnimRoot(n,t);if(!s)return;const r=[],o=utils_1.utils.generateHierarchyPath(s);o&&r.push(o);const u=node_2.default.getNameDataByPropPath(t,i);let c=u.propName;const d=u.compName,l=u.propName;d&&(r.push(new cc_1.animation.ComponentPath(d)),c=d+"."+c);const m=a.clip;let h=null;if("rotation"===l?(h=this._curEditAnimClip.getCreatedCurve(s,"eulerAngles"))?c="eulerAngles":(c=l,h=this._curEditAnimClip.getCreatedCurve(s,c)):h=this._curEditAnimClip.getCreatedCurve(s,c),!h)return;const p=m.sample,_=Math.round(this._curEditTime*p);h.hasKey(_)?await this.operation([{funcName:"updateKey",args:[this._curEditClipUuid,s,c,[_]]}]):await this.operation([{funcName:"createKey",args:[this._curEditClipUuid,s,c,_,null]}])}_onAnimPlay(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this._needRecallPlay=!1,this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),this._needRecallPlay=!0,message_1.messageManager.broadcast("scene:animation-time-change",0)}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime)}update(){AnimEditState.playState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime))}onAssetDeleted(t){if(!t)return;const e=this.queryRecordAnimComp();if(!e)return;const i=e.clips;let n=!1;for(let e=0;e<i.length;e++)i[e]&&i[e]._uuid===t&&(n=!0);n&&this._isInEdit&&cce.SceneFacadeManager.closeScene()}onAssetRefreshed(t){if(!t)return;const e=this.queryRecordAnimComp();if(e&&e.clips&&e.clips.length>0){let i=!1;const n=e.clips;for(let e=0;e<n.length;e++)n[e]&&n[e]._uuid===t&&(i=!0);i&&(e.defaultClip=this._curDefaultClip,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid))}if(t===this._curEditClipUuid){let t=this._curEditRootNodeUuid;if(!t){const e=selection_1.default.query();e.length>0&&(t=e[0])}this._animationStateMap.delete(this._curEditClipUuid);const e=this.queryRecordAnimData(this._curEditClipUuid),i=e.animState;i&&(this._curEditAnimClip=new editor_animation_clip_1.default(e.node,this._curEditClipUuid,i)),this.emit("scene:animation-change",t,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",t,this._curEditClipUuid)}}onSceneOpened(t){if(!this._isInEdit)return;this.storeData(),this._animationStateMap.delete(this._curEditClipUuid);const e=this.queryRecordAnimData(this._curEditClipUuid),i=e.animState;i&&this._registerAnimStateEvents(i),this._curEditAnimClip?this._curEditAnimClip.refreshData(e.node,this._curEditClipUuid):this._curEditAnimClip=new editor_animation_clip_1.default(e.node,this._curEditClipUuid,i),this.setCurEditTime(this._curEditTime)}}exports.default=new AnimationManager;