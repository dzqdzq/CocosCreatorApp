"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const event_enum_1=require("../../../public/event-enum"),cc_1=require("cc"),{EventEmitter:EventEmitter}=require("events"),node_1=__importDefault(require("../node")),scene_1=__importDefault(require("../scene")),selection_1=__importDefault(require("../../../public/selection")),utils_1=require("./utils"),editor_animation_clip_1=__importDefault(require("./editor-animation-clip")),node_2=__importDefault(require("../../../utils/node")),message_1=require("../message");var PlayState;!function(t){t[t.STOP=0]="STOP",t[t.PLAYING=1]="PLAYING",t[t.PAUSE=2]="PAUSE"}(PlayState||(PlayState={}));const AnimEditState={record:!1,dirty:!1,playState:PlayState.STOP},skelAnimAllowOperations=["addEvent","deleteEvent","updateEvent","moveEvents","copyEventsTo","changeSpeed","changeWrapMode","changeSample","copyEvent"],keysOperations=["createKey","moveKeys","removeKey","updateKey","copyKeysTo","spacingKeys","clearKeys","copyPropTo"];class EditorAnimationEventTarget extends cc_1.EventTarget{isValid(){return!0}}class AnimationManager extends EventEmitter{constructor(){super(),this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditAnimClip=null,this._curEditTime=0,this._stateWrappedInfo={},this._animUpdateInterval=null,this._isDirty=!1,this._isInEdit=!1,this._curDefaultClip=null,this._isUseBakedAnimation=!0,this._animationStateMap=new Map,this._eventTarget=new EditorAnimationEventTarget,this.init(),node_1.default.on("gizmo-control-end",this.onNodeChanged.bind(this))}get curEditClipUuid(){return this._curEditClipUuid}get curEditRootNodeUuid(){return this._curEditRootNodeUuid}set curEditRootNodeUuid(t){this._curEditRootNodeUuid=t}set curDefaultClip(t){this._curDefaultClip=t}init(){this._curEditRootNodeUuid="",this._curEditClipUuid="",this._curEditTime=0}setCurDefaultClipByUuid(t){t?cc_1.assetManager.loadAny(t,(t,i)=>{t?console.error(t):this._curDefaultClip=i}):this._curDefaultClip=null}async record(t,i){if(!i){if(!this._isInEdit)return!1;const t=this.queryRecordAnimData();try{this.stop()}catch(t){console.error(t)}return this.changePlayState(PlayState.STOP),t&&this._unregisterAnimStateEVents(t.animState),this._curEditRootNodeUuid="",AnimEditState.record=!1,this._isInEdit=!1,this._curDefaultClip=null,this._animUpdateInterval&&(clearInterval(this._animUpdateInterval),this._animUpdateInterval=null),this._animationStateMap.clear(),cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE),!0}if(t){this._isInEdit=!0,AnimEditState.record=!0,this._curEditRootNodeUuid=t,await this.registerAndFireEvents(t,this._curEditClipUuid),this._animUpdateInterval||(this._animUpdateInterval=setInterval(this.update.bind(this),100));const i=this.queryRecordAnimComp();return i&&(this._curDefaultClip=i.defaultClip),this.storeData(),this.setCurEditTime(0),!0}return!1}storeData(){const t=this.queryRecordAnimComp();t&&this._curEditRootNodeUuid&&t instanceof cc_1.SkeletalAnimation&&(this._isUseBakedAnimation=t.useBakedAnimation,t.useBakedAnimation=!1,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid))}restoreData(){const t=this.queryRecordAnimData();t.animComp&&t.animComp instanceof cc_1.SkeletalAnimation&&(t.animComp.useBakedAnimation=this._isUseBakedAnimation)}_registerAnimStateEvents(t){t&&(t.on("finished",this._onAnimPlayEnd,this),t.on("play",this._onAnimPlay,this),t.on("pause",this._onAnimPause,this),t.on("resume",this._onAnimResume,this),t.on("stop",this._onAnimStopped,this))}_unregisterAnimStateEVents(t){t&&(t.off("finished",this._onAnimPlayEnd,this),t.off("play",this._onAnimPlay,this),t.off("pause",this._onAnimPause,this),t.off("resume",this._onAnimResume,this),t.off("stop",this._onAnimStopped,this))}isDirty(){return this._isDirty}async saveCheck(t){if(t){if(t.animState&&this.isDirty()){const i=utils_1.utils.getClipName(this._curEditClipUuid,t.animComp);switch(await cce.Ipc.send("dirty-dialog",i+".anim")){case 0:case"0":await this.save();break;case 1:case"1":await this.restoreFromDump(this._curEditRootNodeUuid,this._curEditClipUuid,this._lastSaveClipDump);break;case 2:case"2":return!1}}}return!0}async registerAndFireEvents(t,i){const e=this.queryNodeAnimationData(t,i),n=e.animState;n&&(n._curveLoaded=!1,n.initialize(e.node),this._registerAnimStateEvents(n),this._isDirty=!1,this._lastSaveClipDump=this.dumpClip(t,i),this._curEditAnimClip=new editor_animation_clip_1.default(e.node,i,n)),this.emit("scene:animation-clip-change",t,i),message_1.messageManager.broadcast("scene:animation-clip-change",i)}async changeAnimNode(t,i){if(!t||!i)return!1;if(!this._isInEdit)return!1;const e=this.queryRecordAnimData();return!!await this.saveCheck(e)&&(this.stop(),e&&this._unregisterAnimStateEVents(e.animState),!!scene_1.default.modes.animation.open(t)&&(this.setEditClip(i),await this.registerAndFireEvents(t,i),!0))}async save(){return this.saveClip(this._curEditClipUuid)}async saveClip(t){const i=this.queryRecordAnimState(t);if(!i)return!1;const e=i.clip,n=cce.Utils.serialize(e);if(this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,t),this.isSkeletonClip(t)){const t=await cce.Ipc.send("query-asset-meta",e._uuid);if(t&&t.userData){const i=utils_1.utils.queryEvents(e);i?t.userData.events=i.map(t=>({frame:t.frame,func:t.func,params:t.params})):console.error("Event data error"),t.userData.wrapMode=e.wrapMode,t.userData.speed=e.speed,t.userData.sample=e.sample,await cce.Ipc.send("save-asset-meta",e._uuid,cce.Utils.serialize(t))}}else{const t=await cce.Ipc.send("query-asset-info",e._uuid);if(t)await cce.Ipc.send("save-asset",t.url,n);else{const t="db://assets/"+e.name+".anim";await cce.Ipc.send("create-asset",t,n)}}return this._isDirty=!1,!0}isSkeletonClip(t){if(!t)return!1;return t.indexOf("@")>=0}needLock(t,i){const e=this.queryNodeAnimationData(t).animComp;return!!(e&&e instanceof cc_1.SkeletalAnimation)||this.isSkeletonClip(i)}getEditAnimationInfo(){return{rootid:this._curEditRootNodeUuid,clipid:this._curEditClipUuid}}getSerializedEditClip(){if(!this._isInEdit)return null;if(!this._curEditClipUuid)return null;const t=this.queryRecordAnimState(this._curEditClipUuid);if(!t||!t.clip)return null;const i=t.clip;return cce.Utils.serialize(i)}queryRecordNode(){const t=this._curEditRootNodeUuid,i=node_1.default.query(t);return i||console.warn(`Animation node(${t}) doesn't exist`),i}queryRecordAnimComp(){const t=this._curEditRootNodeUuid;return this.queryNodeAnimationData(t).animComp}queryRecordAnimState(t){return this.queryRecordAnimData(t).animState}queryRecordAnimData(t){return t=t||this._curEditClipUuid,this.queryNodeAnimationData(this._curEditRootNodeUuid,t)}queryNodeAnimationData(t,i){const e={};if(!t)return console.debug(`Node(${t}) doesn't exist`),e;let n=null;if(!(n="string"==typeof t?node_1.default.query(t):t))return console.debug(`Node(${t}) doesn't exist`),e;e.node=n;const a=n.getComponent(cc_1.Animation);if(!a)return console.debug(`Node(${t}) lacks Animation`),e;if(e.animComp=a,!i)return e;let s=null;if(a.clips.forEach(t=>{t&&t._uuid===i&&(s=t)}),!s)return e;let r=null;return this._animationStateMap.has(i)?r=this._animationStateMap.get(i):((r=new cc_1.AnimationState(s)).initialize(n),r._setEventTarget(this._eventTarget),this._animationStateMap.set(i,r)),e.animState=r,e}queryAnimClipsInfo(t){const i=this.queryNodeAnimationData(t).animComp;if(!i)return null;const e=i.clips,n=[];e.forEach(t=>{if(t){if(!t.name)return;const i={name:t.name,uuid:t._uuid};n.push(i)}});let a=i.defaultClip?i.defaultClip._uuid:void 0;return!a&&e[0]&&(a=e[0]._uuid),{clipsMenu:n,defaultClip:a}}queryPlayState(){return AnimEditState.playState}async setEditClip(t){if(!t)return console.log("Clip uuid is empty"),!1;if(t===this._curEditClipUuid)return!0;if(this._isInEdit){const i=this._curEditClipUuid,e=this.queryRecordAnimData(i);if(e){if(!await this.saveCheck(e))return!1;this._unregisterAnimStateEVents(e.animState)}const n=this.queryRecordAnimData(t),a=n.animState;if(!a)return!1;this.stop(),this._curEditClipUuid=t,this._isDirty=!1,this._curEditAnimClip=new editor_animation_clip_1.default(n.node,t,a),this._lastSaveClipDump=this.dumpClip(this._curEditRootNodeUuid,t),a.initialize(n.node),a.setTime(0),message_1.messageManager.broadcast("scene:animation-time-change",0),this._registerAnimStateEvents(a),this._curEditTime=0}else this._curEditClipUuid=t;return this.emit("scene:animation-clip-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-clip-change",this._curEditClipUuid),!0}setCurEditTime(t){if(this._curEditTime=t,!this._isInEdit)return!1;const i=this.queryRecordAnimState(this._curEditClipUuid);if(!i)return!1;let e=t;e>i.duration&&(e=i.duration),i.weight=1,i.setTime(e),i.isPaused||i.pause();try{i.sample()}catch(t){console.error(t)}return cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:animation-time-change",e),!0}changePlayState(t){switch(AnimEditState.playState=t,t){case PlayState.PLAYING:cce.Engine.enterState(cce.NeedAnimState.ANIMATION_MODE);break;case PlayState.PAUSE:case PlayState.STOP:cce.Engine.exitState(cce.NeedAnimState.ANIMATION_MODE)}message_1.messageManager.broadcast("scene:animation-state-change",AnimEditState.playState)}play(t){t=t||this._curEditClipUuid;const i=this.queryRecordAnimData(t).animState;return!!i&&(i.setTime(0),i.weight=1,i.play(),cce.Engine.repaintInEditMode(),!0)}pause(){const t=this.queryRecordAnimData().animState;return!!t&&(t.pause(),cce.Engine.repaintInEditMode(),this._curEditTime=this.queryPlayingClipTime(),!0)}resume(){const t=this.queryRecordAnimData().animState;return!!t&&(t.isPlaying||(t.weight=1,t.play()),t.resume(),cce.Engine.repaintInEditMode(),!0)}stop(){const t=this.queryRecordAnimData().animState;if(!t)return!1;t.setTime(0),this._curEditTime=0,t.isPaused||t.pause();try{t.sample()}catch(t){console.error(t)}return t.stop(),cce.Engine.repaintInEditMode(),this.changePlayState(PlayState.STOP),!0}async queryClip(t,i){DEBUG_TIME_COST&&console.time("queryClipDumpCost");const e=this.queryNodeAnimationData(t,i);if(!e.animComp)return null;const n=e.animState;if(!n)return null;let a=this._curEditAnimClip;this._curEditAnimClip&&this._curEditAnimClip.rootNode===e.node&&this._curEditClipUuid===i||(a=new editor_animation_clip_1.default(e.node,i,n));const s=await a.getDumpData();return this.needLock(t,i)&&s&&(s.isLock=!0),DEBUG_TIME_COST&&console.timeEnd("queryClipDumpCost"),s}dumpClip(t,i){const e=this.queryNodeAnimationData(t,i).animState;return e?cce.Utils.serialize(e.clip):null}async restoreFromDump(t,i,e){const n=this.queryNodeAnimationData(t,i);if(!n.animComp)return!1;const a=n.animState;if(!a)return!1;const s=a.clip;return new Promise((r,o)=>{utils_1.utils.loadJsonWithUuid(i,e,async(e,u)=>{e?o(e):u&&(utils_1.utils.copyClip(s,u),this._curEditAnimClip=new editor_animation_clip_1.default(n.node,i,a),await this._curEditAnimClip.updateCurveData(),this._isDirty=!0,this.setCurEditTime(this._curEditTime),this.emit("scene:animation-change",t,i,"undo"),message_1.messageManager.broadcast("scene:animation-change",t,i),r(!0))})})}queryAnimationRoot(t){let i=node_1.default.query(t);if(i)do{if(i.getComponent(cc_1.Animation))return i.uuid;i=i.parent}while(i);return null}async queryAnimationRootInfo(t){const i=cce.Scene.queryNodeTree(t),e=this.queryAnimClipsInfo(t);if(!e||e&&e.clipsMenu&&0===e.clipsMenu.length)return{root:t,nodeTreeDump:i};const n=e.defaultClip;return{root:t,nodeTreeDump:i,clipsMenu:e.clipsMenu,defaultClip:n,clipDump:await this.queryClip(t,n),time:this.queryPlayingClipTime(n),state:this.queryPlayState()}}queryProperties(t){const i=node_1.default.query(t);i||console.log(`Animation node(${t})doesn't exist`);let e=i;for(;e&&!e.getComponent(cc_1.Animation);){if(e.parent instanceof cc_1.Scene){e=i;break}e=e.parent}const n=utils_1.utils.getAnimableProperties(i,e!==i);let a=[];return n&&(a=n),a}queryPlayingClipTime(t){if(!this._isInEdit)return 0;t=t||this._curEditClipUuid;const i=this.queryRecordAnimState(t);return i?i.current:0}async getPropValueAtFrame(t,i,e,n){return this.queryRecordAnimData(t).animState?t!==this._curEditClipUuid?(console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${t}`),null):this._curEditAnimClip?await this._curEditAnimClip.getPropValueAtFrame(i,e,n):null:null}async getAllPropValueAtFrame(t,i,e,n){const a={};return await Promise.all(e.map(async e=>{a[e]=await this.getPropValueAtFrame(t,i,e,n)})),a}async operation(t){let i=!0,e=!1;cce.SceneFacadeManager.snapshot();for(let n=0;n<t.length;n++){const a=t[n],s=a.funcName,r=a.args;if(this.needLock(this._curEditRootNodeUuid,this._curEditClipUuid)&&!skelAnimAllowOperations.includes(s))return console.warn(`Method '${s}' does not allowed in skeleton animation.`),!1;const o=r[0];if(o!==this._curEditClipUuid)return console.warn(`current edit clip: '${this._curEditClipUuid}' but you want to operate: '${o}`),!1;if(!this._curEditAnimClip[s])return console.warn(`Method '${s}' does not exist to manipulate the animation.`),!1;r.splice(0,1),await this._curEditAnimClip[s](...r)?keysOperations.includes(s)&&(e=!0):(console.warn(`call method ${s} failed`),i=!1)}return i&&(e&&this.setCurEditTime(this._curEditTime),this._isDirty=!0,cce.Engine.repaintInEditMode(),this.emit("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",this._curEditRootNodeUuid,this._curEditClipUuid)),i}async onNodeChanged(t,i){if(!AnimEditState.record)return;if((null===i||void 0===i?void 0:i.source)===event_enum_1.EventSourceType.ENGINE)return;const e=i.propPath;if(!t||!e||"string"!=typeof e)return;const n=node_1.default.query(this._curEditRootNodeUuid);if(!n)return;const a=this.queryRecordAnimState(this._curEditClipUuid);if(!a)return void console.log(`AnimationState of '(${this._curEditClipUuid})' clip doesn't exist`);if(!this._curEditAnimClip)return;const s=utils_1.utils.getNodePathFromAnimRoot(n,t);if(!s)return;const r=[],o=utils_1.utils.generateHierarchyPath(s);o&&r.push(o);const u=node_2.default.getNameDataByPropPath(t,e);let c=u.propName;const d=u.compName,l=u.propName;d&&(r.push(new cc_1.animation.ComponentPath(d)),c=d+"."+c);const m=a.clip;let h=null;if("rotation"===l?(h=this._curEditAnimClip.getCreatedCurve(s,"eulerAngles"))?c="eulerAngles":(c=l,h=this._curEditAnimClip.getCreatedCurve(s,c)):h=this._curEditAnimClip.getCreatedCurve(s,c),!h)return;const p=m.sample,_=Math.round(this._curEditTime*p);h.hasKey(_)?await this.operation([{funcName:"updateKey",args:[this._curEditClipUuid,s,c,[_]]}]):await this.operation([{funcName:"createKey",args:[this._curEditClipUuid,s,c,_,null]}])}_onAnimPlay(){this.changePlayState(PlayState.PLAYING)}_onAnimPause(){this.changePlayState(PlayState.PAUSE)}_onAnimResume(){this.changePlayState(PlayState.PLAYING)}_onAnimStopped(){this.changePlayState(PlayState.STOP),message_1.messageManager.broadcast("scene:animation-time-change",0)}_onAnimPlayEnd(){this.changePlayState(PlayState.STOP),this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime)}update(){AnimEditState.playState===PlayState.PLAYING&&(this._curEditTime=this.queryPlayingClipTime(),message_1.messageManager.broadcast("scene:animation-time-change",this._curEditTime))}onAssetDeleted(t){if(!t)return;const i=this.queryRecordAnimComp();if(!i)return;const e=i.clips;let n=!1;for(let i=0;i<e.length;i++)e[i]&&e[i]._uuid===t&&(n=!0);n&&this._isInEdit&&(this._isDirty=!1,cce.SceneFacadeManager.closeScene())}onAssetRefreshed(t){if(!t)return;const i=this.queryRecordAnimComp();if(i&&i.clips&&i.clips.length>0){let e=!1;const n=i.clips;for(let i=0;i<n.length;i++)n[i]&&n[i]._uuid===t&&(e=!0);e&&(i.defaultClip=this._curDefaultClip,message_1.messageManager.broadcast("scene:change-node",this._curEditRootNodeUuid))}if(t===this._curEditClipUuid){let t=this._curEditRootNodeUuid;if(!t){const i=selection_1.default.query();i.length>0&&(t=i[0])}this._animationStateMap.delete(this._curEditClipUuid);const i=this.queryRecordAnimData(this._curEditClipUuid),e=i.animState;e&&(this._curEditAnimClip=new editor_animation_clip_1.default(i.node,this._curEditClipUuid,e)),this.emit("scene:animation-change",t,this._curEditClipUuid),message_1.messageManager.broadcast("scene:animation-change",t,this._curEditClipUuid)}}onSceneOpened(t){if(!this._isInEdit)return;this.storeData(),this._animationStateMap.delete(this._curEditClipUuid);const i=this.queryRecordAnimData(this._curEditClipUuid),e=i.animState;e&&this._registerAnimStateEvents(e),this._curEditAnimClip?this._curEditAnimClip.refreshData(i.node,this._curEditClipUuid):this._curEditAnimClip=new editor_animation_clip_1.default(i.node,this._curEditClipUuid,e),this.setCurEditTime(this._curEditTime)}}exports.default=new AnimationManager;