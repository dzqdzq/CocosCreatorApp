"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const multi_undo_1=require("./multi-undo"),multi_selection_1=require("./multi-selection"),multi_assets_1=require("./multi-assets"),cc_1=require("cc"),proxy_utils_1=require("../scene/proxy/proxy-utils"),DEFAULT_SCENE_COUNT=100;class MultiSceneManager{useMultipleEdit=!1;sceneMap=new Map;_maxSceneCount=DEFAULT_SCENE_COUNT;undoManager=new multi_undo_1.MultiUndoManager;selection=new multi_selection_1.MultiSelection;multiAssets=new multi_assets_1.MultiAssets;_curFocus="";_reloadCount=0;get reloadCount(){return this._reloadCount}get curFocus(){return this._curFocus}set curFocus(e){this._curFocus=e}get maxSceneCount(){return this._maxSceneCount}set maxSceneCount(e){this._maxSceneCount=e,this._reduceScene()}constructor(){Editor.Profile.getConfig("scene","scene.multi").then(async e=>{this.useMultipleEdit=Boolean(e),await this._initData()})}async onProfileChanged(e,t,s,i){"packages/scene.json"===t&&"scene.multi"===s&&(t=this.useMultipleEdit,s=Boolean(i),t&&!s||!t&&s&&await this._initData(),this.useMultipleEdit=Boolean(i))}async _initData(){(await Editor.Profile.getConfig("scene","tabs")||[]).forEach(e=>{this.sceneMap.set(e,{scene:null,rootNode:null,uuid:e,persisted:!0,loaded:!1,reloadCount:0})}),this.maxSceneCount=this.useMultipleEdit?DEFAULT_SCENE_COUNT:1}stashScene(e,t,s){var i;this.useMultipleEdit&&((i=this.sceneMap.get(e))&&i.loaded||this.sceneMap.set(e,{persisted:!0,scene:t,rootNode:s,uuid:e,loaded:!0,reloadCount:this.reloadCount}),this.sceneMap.size>=this.maxSceneCount)&&this._reduceScene()}multiSceneOpen(e,t,s,i){var n;this.useMultipleEdit&&(n=this.sceneMap.get(e),this.curFocus=e,n&&n.loaded?this.broadcast("multi-scene-focus",this.curFocus):(this.stashScene(e,t,s),this.overrideSceneDestroy(t),this.broadcastSceneOpen(e,i)))}updateSceneRef(e,t,s){this.useMultipleEdit&&(e=this.sceneMap.get(e))&&(e.scene,e.scene=t,e.rootNode=s,this.overrideSceneDestroy(t))}multiEmptySceneOpen(e,t){this.useMultipleEdit&&(this.sceneMap.set(e,{scene:t,rootNode:t,uuid:e,loaded:!0,persisted:!1,reloadCount:0}),this.overrideSceneDestroy(t),this.broadcastSceneOpen(e,"scene"),this.broadcastSceneFocus(e))}multiSceneClose(e,t){this.useMultipleEdit&&(this.remove(e),this.broadcastSceneClose(e))}async multiSceneFocus(e){this.useMultipleEdit&&this.sceneMap.has(e)&&(await cce.SceneFacadeManager.openScene(e),this.broadcastSceneFocus(e))}broadcastSceneFocus(e){this.useMultipleEdit&&this.curFocus!==e&&(this.curFocus=e,this.broadcast("multi-scene-focus",this.curFocus))}async multiSceneFocusQuery(){return this.curFocus}async multiSceneQuery(){return this.useMultipleEdit?await this.queryScenesInfo():[]}_reduceScene(){for(;this.sceneMap.size>this.maxSceneCount;){var e=this.sceneMap.keys().next().value;e&&this.remove(e)}}getStashScene(e){return this.useMultipleEdit&&(e=this.sceneMap.get(e))&&e.loaded?e:void 0}clearStashScene(){this.sceneMap.clear()}broadcastSceneOpen(e,t){this.broadcast("multi-open-scene",e,t)}broadcastSceneClose(e){this.broadcast("multi-close-scene",e)}broadcastSceneDirty(e,t){this.broadcast("multi-scene-dirty",e,t)}broadcast(e,t,s){!this.useMultipleEdit||isPreviewProcess||(this.queryScenesInfo().then(e=>{Editor.Profile.setConfig("scene","tabs",e.filter(e=>this.sceneMap.get(e.uuid)?.persisted).map(e=>e.uuid))}),s?cce.Ipc.send(e,t,s):cce.Ipc.send(e,t))}async _checkClose(e){var t=this.sceneMap.get(e),s=await this.queryAssetInfo(e);if(!(t&&t.loaded&&s&&s.dirty))return!0;if(!this.undoManager.querySceneDirty(e))return!0;switch(await(0,proxy_utils_1.checkClose)(s.name+`
`)){case 0:return await this.saveScene(e),!0;case 1:return await Editor.Message.request("scene","clear-scene-cache",e),!0;default:return!1}}async closeAllScene(){var e;return!this.useMultipleEdit||(e=this.getAllSceneUuid().reverse(),this._closeByIds(e))}async _closeByIds(e){let t=!1;for(const n of e){var s=await this._checkClose(n),i=await this.queryAssetInfo(n);if(i&&this.broadcastSceneDirty(n,i.type),console.debug("close-scene",n,s),!s){t=!0;break}}return t}async saveAllScene(){this.useMultipleEdit&&await Promise.all(this.getAllSceneUuid().map(async e=>this.saveScene(e)))}async closeOthers(t){var e,s;return!this.useMultipleEdit||(e=this.getAllSceneUuid().filter(e=>e!==t).reverse(),!!(s=await this._closeByIds(e)))||(e.forEach(e=>this.remove(e)),await this.multiSceneFocus(t),this.broadcastSceneClose(""),s)}async closeToTheRight(e){if(!this.useMultipleEdit)return!0;let t=this.getAllSceneUuid();var s=t.indexOf(e);if(-1===s||s===t.length-1)return!0;t=t.slice(s+1);s=await this._closeByIds(t);return!!s||(t.includes(this.curFocus)&&await this.multiSceneFocus(e),t.forEach(e=>this.remove(e)),this.broadcastSceneClose(""),s)}async moveSceneTo(t,s){if(this.sceneMap.has(t)&&t!==s){if("end"===s){const i=Array.from(this.sceneMap.entries()),n=i.findIndex(([e])=>e===t),[r]=i.splice(n,1);return i.push(r),this.sceneMap.clear(),i.forEach(([e,t])=>{this.sceneMap.set(e,t)}),this.broadcastSceneDirty(this.curFocus)}if(this.sceneMap.has(s)){const i=Array.from(this.sceneMap.entries()),n=i.findIndex(([e])=>e===t);var e=i.findIndex(([e])=>e===s);if(-1!==n&&-1!==e){const[r]=i.splice(n,1);i.splice((n,e),0,r),this.sceneMap.clear(),i.forEach(([e,t])=>{this.sceneMap.set(e,t)}),this.broadcastSceneDirty(this.curFocus)}}}}async closeScene(e,t=!0){if(!this.useMultipleEdit)return!1;if(!this.sceneMap.get(e)||1===this.sceneMap.size)return console.debug("scene not found or only one scene"),!1;var s,i=await this._checkClose(e);if(!i)return i;let n="";return e===this.curFocus&&(s=(i=this.getAllSceneUuid()).indexOf(e),n=0<=s-1?i[s-1]:i[s+1]),this.remove(e,t),this.broadcastSceneClose(e),n&&await this.multiSceneFocus(n),!0}overrideSceneDestroy(e){e.destroy=function(){return e._activeInHierarchy=!1,cc_1.director._compScheduler.unscheduleAll(),!1}}getAllScene(){return Array.from(this.sceneMap.values())}getAllSceneUuid(){return Array.from(this.sceneMap.keys())}remove(e,t=!0){var s=this.sceneMap.get(e);s?(this.undoManager.delete(e),this.sceneMap.delete(e),this.selection.clearSelection(e),t&&s.loaded&&this._destroyScene(s.scene)):console.debug("scene not found",e)}beforeUpdateSceneRef(e){if(this.useMultipleEdit){const t=this.sceneMap.get(e);t&&t.loaded&&cc_1.director.once(cc_1.DirectorEvent.BEFORE_SCENE_LAUNCH,()=>{console.debug("BEFORE_SCENE_LAUNCH invoke ",e),this._destroyScene(t.scene)})}}_destroyScene(e){e.destroy=function(){var e=cc_1.CCObject.prototype.destroy.call(this);if(e){var t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return this._renderScene&&cc_1.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,cc_1.CCObject._deferredDestroy(),e}}generateUndoManager(e){this.useMultipleEdit&&this.undoManager.generateUndoManager(e)}getUndoManager(e){return this.undoManager.getUndoManager(e)}delete(e){this.useMultipleEdit&&this.undoManager.delete(e)}beginRecording(e,t,s){return this.undoManager.beginRecording(e,t,s)}cancelRecording(e,t){return this.undoManager.cancelRecording(e,t)}endRecording(e,t){return this.undoManager.endRecording(e,t)}updateDump(e,t,s){this.undoManager.updateDump(e,t,s)}querySceneDirty(e){return this.undoManager.querySceneDirty(e)}async undo(e){return this.undoManager.undo(e)}async redo(e){return this.undoManager.redo(e)}record(e,t,s=!0){this.undoManager.record(e,t,s)}stashSelection(e,t){this.useMultipleEdit&&this.selection.stashSelection(e,t)}getSelection(e){if(this.useMultipleEdit)return this.selection.getSelection(e)}clearSelection(e){this.useMultipleEdit&&this.selection.clearSelection(e)}async queryAssetsInfo(e){return this.useMultipleEdit?this.multiAssets.queryAssetsInfo(e):[]}async queryAssetInfo(e){if(!this.useMultipleEdit)return null;let t=await this.multiAssets.queryAssetInfo(e);var s;return t||(s=this.sceneMap.get(e))&&!s.persisted&&(t=this._generateEmptySceneInfo(e)),t&&(t.dirty=this.undoManager.querySceneDirty(e)),t}_generateEmptySceneInfo(e){return{name:"Untitled.scene",uuid:e,dirty:this.undoManager.querySceneDirty(e),type:"scene",url:""}}async queryScenesInfo(){var e,t,s=[];for([e,t]of this.sceneMap){var i=await this.queryAssetInfo(e);i&&s.push(i)}return s}getCurrentScene(){return this.useMultipleEdit?this.sceneMap.get(this.curFocus)?.scene:cc_1.director.getScene()}async getSceneInfo(e){e=this.sceneMap.get(e);return e&&e.loaded?e:null}async saveScene(e){var t,s;return!this.useMultipleEdit||(t=this.sceneMap.get(e),!!((s=await this.queryAssetInfo(e))&&s.dirty&&t)&&("scene"===s.type?await(0,proxy_utils_1.serializeScene)(e,t.scene):"prefab"===s.type?await(0,proxy_utils_1.serializePrefab)(e,t.rootNode):console.warn("invalid type,",s.type),this.getUndoManager(e).save(),!0))}abortSnapshot(e){this.useMultipleEdit&&this.undoManager.abortSnapshot(e)}snapshot(e,t){this.useMultipleEdit&&this.undoManager.snapshot(e,t)}incReloadCount(e){var t;this.useMultipleEdit&&(this._reloadCount++,e)&&((t=this.sceneMap.get(e))&&(t.loaded=!1),t)&&console.debug("stash scene needs hard reload",e)}needReload(e){var t;return!!this.useMultipleEdit&&!!(t=this.sceneMap.get(e))&&(t.reloadCount<this._reloadCount&&console.debug(`scene ${e} needs reload`),t.reloadCount<this._reloadCount)}endReload(e){this.useMultipleEdit&&(e=this.sceneMap.get(e))&&(e.reloadCount=this._reloadCount)}}const multiSceneManager=new MultiSceneManager;exports.default=multiSceneManager,globalThis.__multiScene__=multiSceneManager;