"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialHandler=void 0;const cc_1=require("cc"),base_handler_1=require("./base-handler"),node_1=__importDefault(require("../../../node"));class MaterialHandler extends base_handler_1.BaseHandler{acceptedTypes=["cc.Material"];dragNode=[];_highlightedNodes=new Map;_lastDragNode=null;get firstDragNode(){return this.dragNode[0]||null}getSharedMaterialPathByNode(e,a=0){e=e.components.findIndex(e=>e instanceof cc_1.MeshRenderer);if(-1===e)throw new Error("Node does not have MeshRenderer");return`__comps__.${e}.sharedMaterials.`+a}async setMaterial(e,a,t=0){t=this.getSharedMaterialPathByNode(e,t);await node_1.default.setProperty(e.uuid,t,{type:"cc.Material",value:{uuid:a}})}async showHighlightNode(a,e,t=0){var r=a.getComponent(cc_1.MeshRenderer);if(r){if(!this._highlightedNodes.has(a)){let e="";r.material&&r.material.parent&&(e=r.material.parent.uuid),this._highlightedNodes.set(a,{materialUuid:e,materialIndex:t})}await this.setMaterial(a,e.value,t)}}async restoreAllHighlights(){for(var[e,a]of this._highlightedNodes.entries())await this.setMaterial(e,a.materialUuid,a.materialIndex);this._highlightedNodes.clear()}async onDragLeave(e,a){0!==a.length&&(await this.restoreAllHighlights(),this._lastDragNode=null)}async onDragOver(e,a){this.dragNode=this.getRaycastResultNodes(e.x,e.y);const t=this.firstDragNode;t!==this._lastDragNode&&(await this.restoreAllHighlights(),requestAnimationFrame(async()=>{t&&await this.showHighlightNode(t,e.values[0])}),this._lastDragNode=t)}async onDrop(e,a){if(await this.restoreAllHighlights(),this._lastDragNode=null,this.firstDragNode){var t=cce.SceneFacadeManager.beginRecording(this.firstDragNode.uuid);try{for(let e=0;e<a.length;e++)await this.setMaterial(this.firstDragNode,a[e].value,e);cce.SceneFacadeManager.endRecording(t)}catch(e){cce.SceneFacadeManager.cancelRecording(t)}}}}exports.MaterialHandler=MaterialHandler;