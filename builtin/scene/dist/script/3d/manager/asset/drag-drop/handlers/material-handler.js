"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialHandler=void 0;const cc_1=require("cc"),base_handler_1=require("./base-handler"),gizmos_1=__importDefault(require("../../../gizmos")),node_1=__importDefault(require("../../../node"));let baseMaterialUuid="",lastHighlightMC=null;class MaterialHandler extends base_handler_1.BaseHandler{constructor(){super(...arguments),this.acceptedTypes=["cc.Material"],this.dragNode=[]}get firstDragNode(){return this.dragNode[0]||null}getSelectedMeshRenderer(){var e=Editor.Selection.getLastSelected("node"),e=e&&cce.Node.query(e);return e?e.getComponent(cc_1.MeshRenderer):null}async hideHighlightNode(e=!1){lastHighlightMC&&(e||lastHighlightMC.gizmo&&gizmos_1.default.hideGizmo(lastHighlightMC.gizmo),await this.setMaterial(lastHighlightMC.node,baseMaterialUuid))}async showHighlightNode(e){lastHighlightMC&&(lastHighlightMC.material&&lastHighlightMC.material.parent&&(baseMaterialUuid=lastHighlightMC.material.parent.uuid),gizmos_1.default.showGizmo("component",lastHighlightMC,!0),await this.setMaterial(lastHighlightMC.node,e.value))}getSharedMaterialPathByNode(e,t=0){return`__comps__.${e.components.findIndex(e=>e instanceof cc_1.MeshRenderer)}.sharedMaterials.`+t}async setMaterial(e,t,i=0){i=this.getSharedMaterialPathByNode(e,i);await node_1.default.setProperty(e.uuid,i,{type:"cc.Material",value:{uuid:t}})}async onDragLeave(e,t){}async onDragOver(e,t){var i;this.dragNode=this.getRaycastResultNodes(e.x,e.y),this.firstDragNode?(lastHighlightMC||(i=this.getSelectedMeshRenderer())&&i.gizmo&&i.gizmo.visible()&&(lastHighlightMC=i),lastHighlightMC&&lastHighlightMC.node===this.firstDragNode||(this.hideHighlightNode(),(i=this.firstDragNode.getComponent(cc_1.MeshRenderer))&&(lastHighlightMC=i,this.showHighlightNode(e.values[0])))):(this.hideHighlightNode(),lastHighlightMC=null)}async onDrop(e,t){var i=this.getSelectedMeshRenderer(),a=!((i&&i.node.uuid)!==(lastHighlightMC&&lastHighlightMC.node.uuid));if(await this.hideHighlightNode(a),!a&&i&&gizmos_1.default.showGizmo("component",i,!0),this.firstDragNode){a=cce.SceneFacadeManager.beginRecording(this.firstDragNode.uuid);try{for(let e=0;e<t.length;e++)await this.setMaterial(this.firstDragNode,t[e].value,e);cce.SceneFacadeManager.endRecording(a)}catch(e){cce.SceneFacadeManager.cancelRecording(a)}lastHighlightMC=null}}}exports.MaterialHandler=MaterialHandler;