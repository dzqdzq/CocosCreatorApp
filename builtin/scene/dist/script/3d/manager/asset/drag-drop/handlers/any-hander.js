"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnyHandler=void 0;const cc_1=require("cc"),base_handler_1=require("./base-handler"),create_1=require("../../../node/create"),utils_1=require("./utils"),plugin_1=__importDefault(require("../../../plugin")),dump_1=__importDefault(require("../../../../../export/dump"));class AnyHandler extends base_handler_1.BaseHandler{excludedTypes=["cc.Material"];dragItems=[];temporaryNodes=[];currentRaycastResultNodes=[];editorCanvasNode=null;isDragging=!1;clear(){this.clearEditorCanvas(),this.clearDragItems()}clearDragItems(){for(const e of this.temporaryNodes)e.isValid&&e._destroyImmediate();this.dragItems.length=0,this.temporaryNodes.length=0,this.currentRaycastResultNodes.length=0,cce.Engine.repaintInEditMode()}clearEditorCanvas(){this.editorCanvasNode&&this.editorCanvasNode.isValid&&this.editorCanvasNode._destroyImmediate(),this.editorCanvasNode=null,cce.Engine.repaintInEditMode()}findEditorCanvas(){let e=this.editorCanvasNode||(0,utils_1.findCanvas)();return e||(this.editorCanvasNode=e=new cc_1.Node("Drag Drop Editor Canvas"),e.addComponent(cc_1.Canvas),(0,utils_1.setNodeEditorFlag)(e),cc_1.director.getScene()?.addChild(e)),e}async createNode(e){try{var t=[];for(const s of e)try{var{node:a,canvasRequired:r}=await(0,create_1.createNodeByAsset)({uuid:s.value,type:s.type,autoAdaptToCreate:!0,canvasRequired:s.canvasRequired});(0,utils_1.setNodeEditorFlag)(a),r?this.findEditorCanvas().addChild(a):cc_1.director.getScene()?.addChild(a),a.position=new cc_1.Vec3(999,0,0),t.push(a)}catch(e){console.error(e)}return t}catch(e){return console.error(e),[]}}async drop(e,t){var a=cc_1.director.getScene();if(a&&0!==this.temporaryNodes.length){var r=a.uuid,a=cce.SceneFacadeManager.beginRecording(r);try{var s=t[0].type,i=this.temporaryNodes[0].worldPosition.clone(),n=plugin_1.default.getDropHandle(s);if(n)Editor.Message.send(n.name,n.item.message,this.currentRaycastResultNodes.map(dump_1.default.dumpNode),{x:i.x,y:i.y,z:i.z},t);else for(const d of t)await cce.SceneFacadeManager.createNode({parent:r,assetUuid:d.value,name:d.name,type:d.type,canvasRequired:d.canvasRequired,unlinkPrefab:d.unlinkPrefab,position:i});cce.SceneFacadeManager.endRecording(a)}catch(e){cce.SceneFacadeManager.cancelRecording(a),console.error(e)}}}async onDragLeave(e,t){this.isDragging=!1,this.clear()}async onDragOver(e,t){this.isDragging=!0,this.dragItems.length!==t.length&&(this.clear(),this.dragItems=t,this.createNode(t).then(e=>{if(this.isDragging)this.temporaryNodes=e;else for(const t of e)t.isValid&&t.destroy()})),0<this.temporaryNodes.length&&(t=(0,utils_1.adjustXY)(e.x,e.y),this.currentRaycastResultNodes=this.getRaycastResultNodes(e.x,e.y),(0,utils_1.setPositionInNode)(t.x,t.y,this.temporaryNodes,this.currentRaycastResultNodes[0],this.editorCanvasNode)),cce.Engine.repaintInEditMode()}async onDrop(e,t){this.clearEditorCanvas(),await this.drop(e,t),this.clearDragItems()}}exports.AnyHandler=AnyHandler;