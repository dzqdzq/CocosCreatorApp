"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),util_1=__importDefault(require("util")),{EventEmitter:EventEmitter}=require("events"),material_1=__importDefault(require("./material")),physics_material_1=__importDefault(require("./physics-material")),render_pipeline_1=__importDefault(require("./render-pipeline")),render_stage_1=__importDefault(require("./render-stage")),render_flow_1=__importDefault(require("./render-flow")),node_1=__importDefault(require("../node")),gizmos_1=__importDefault(require("./../gizmos")),selection_1=__importDefault(require("../selection")),node_2=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../utils/dump")),camera_1=__importDefault(require("../camera")),asset_watcher_1=require("./asset-watcher"),plugin_1=__importDefault(require("../plugin")),scripts_1=__importDefault(require("../scripts")),operation_1=__importDefault(require("../../../public/operation")),creatableAssetTypes=node_1.default.creatableAssetTypes;let lastHighlightNode;const ray=cc_1.geometry.ray.create();let lastHighlightMC=null;class AssetManager extends EventEmitter{init(){scripts_1.default.on(scripts_1.default.EXECUTION_FINISHED,this.onScriptExecutedEnd),operation_1.default.on("onDragOver",this.onDragOver.bind(this)),operation_1.default.on("onDrop",this.onDrop.bind(this))}onScriptExecutedEnd(){cc_1.assetManager.assets.forEach((e,t)=>{e instanceof cc_1.Prefab&&cc_1.assetManager.releaseAsset(e)})}removeAllAssetListeners(){const e=cc_1.assetManager.assetListener;e&&e._callbackTable&&Object.keys(e._callbackTable).forEach(t=>{e.removeAll(t)})}onSceneOpened(){this.removeAllAssetListeners(),node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t instanceof cc_1.Scene?asset_watcher_1.assetWatcherManager.startWatch(t.globals):node_2.default.isEditorNode(t)||t.components.forEach(e=>{asset_watcher_1.assetWatcherManager.startWatch(e)})})}onNodeChanged(e){e.components.forEach(e=>{asset_watcher_1.assetWatcherManager.stopWatch(e),asset_watcher_1.assetWatcherManager.startWatch(e)})}onComponentAdded(e){asset_watcher_1.assetWatcherManager.startWatch(e)}onComponentRemoved(e){asset_watcher_1.assetWatcherManager.stopWatch(e)}queryAllEffects(){return material_1.default.queryAllEffects()}queryEffect(e){return material_1.default.queryEffect(e)}async queryMaterial(e){return material_1.default.queryMaterial(e)}async applyMaterial(e,t){const a=await material_1.default.decodeMaterial(t);await cce.Ipc.send("save-asset",e,a)}async previewMaterial(e,t){return material_1.default.previewMaterial(e,t)}async queryPhysicsMaterial(e){let t;try{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),t=await util_1.default.promisify(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}return t?(physics_material_1.default.cacheComponent(t),physics_material_1.default.encodeComponent(t)):null}async changePhysicsMaterial(e){return physics_material_1.default.updateComponent(e)}async applyPhysicsMaterial(e){const t=physics_material_1.default.getComponent(),a=cce.Utils.serialize(t);await cce.Ipc.send("save-asset",e,a)}async queryRenderStage(e){let t;try{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),t=await util_1.default.promisify(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}return t?(render_stage_1.default.cacheComponent(t),render_stage_1.default.encodeComponent(t)):null}async changeRenderStage(e){return render_stage_1.default.updateComponent(e)}async applyRenderStage(e){const t=render_stage_1.default.getComponent(),a=cce.Utils.serialize(t);await cce.Ipc.send("save-asset",e,a)}async queryRenderFlow(e){let t;try{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),t=await util_1.default.promisify(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}return t?(render_flow_1.default.cacheComponent(t),render_flow_1.default.encodeComponent(t)):null}async changeRenderFlow(e){return render_flow_1.default.updateComponent(e)}async applyRenderFlow(e){const t=render_flow_1.default.getComponent(),a=cce.Utils.serialize(t);await cce.Ipc.send("save-asset",e,a)}async applyRenderTexture(e,t){let a;try{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),a=await util_1.default.promisify(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}if(!a||!t)return;a.resize(t.width||1,t.height||1);const n=cce.Utils.serialize(a);cce.Ipc.send("save-asset",e,n)}onAssetChanged(e){asset_watcher_1.assetWatcherManager.onAssetChanged(e),this.emit("asset-change",e)}onAssetDeleted(e,t){asset_watcher_1.assetWatcherManager.onAssetDeleted(e,t.url),this.emit("asset-delete",e)}getAllReferenceAssets(e,t=[]){var a;let n=[];const r=null===(a=cc_1.assetManager.references)||void 0===a?void 0:a.get(e);if(r)for(let e=0,a=r.length;e<a;e++){const a=r[e][0].deref();a&&(t.includes(a)||cc_1.isValid(a,!0)&&(t.push(a),n.push(a),n=n.concat(this.getAllReferenceAssets(a._uuid,t))))}return n}releaseAsset(e){const t=cc_1.assetManager.assets.get(e);t&&(t instanceof cc_1.Prefab?(cc_1.assetManager.assets.forEach((t,a)=>{cc_1.assetManager.dependUtil.getDepsRecursively(a).includes(e)&&cc_1.assetManager.releaseAsset(t)}),cc_1.assetManager.releaseAsset(t)):cc_1.assetManager.releaseAsset(t))}canDrop(e){return creatableAssetTypes.includes(e)}onDragOver(e){if(!e)return;const t=node_2.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO])),a=t.length>0?t[0]:null;if(!a)return lastHighlightMC&&!selection_1.default.isSelect(lastHighlightMC.node.uuid)&&gizmos_1.default.hideComponentGizmo(lastHighlightMC),void(lastHighlightNode=null);if(lastHighlightNode!==a&&e.values.some(e=>"cc.Material"===e.type)){const e=a.components.find(e=>e instanceof cc_1.MeshRenderer);if(!e)return;lastHighlightNode=a,lastHighlightMC&&!selection_1.default.isSelect(lastHighlightMC.node.uuid)&&gizmos_1.default.hideComponentGizmo(lastHighlightMC),lastHighlightMC=e,gizmos_1.default.showComponentGizmo(lastHighlightMC)}}async onDrop(e){if(!e)return;const t=node_2.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO])),a=t.length>0?t[0]:null;let n=cc.geometry.plane.create(0,1,0,0);const r=e.x,s=cc.game.canvas.height-e.y;camera_1.default.is2D&&(n=cc.geometry.plane.create(0,0,1,0)),camera_1.default.getCamera().screenPointToRay(ray,r,s);const l=cc.geometry.intersect.rayPlane(ray,n);let c=new cc.Vec3;cc.Vec3.scaleAndAdd(c,ray.o,ray.d,l),c=node_2.default.makeVec3InPrecision(c,0);let i=0;const o={};for(const t of e.values)switch(t.type){case"cc.Material":if(a){const e={type:t.type,value:""},n=`__comps__.${a.components.findIndex(e=>e instanceof cc_1.MeshRenderer)}.sharedMaterials.${i}`;e.value={uuid:t.value},await node_1.default.setProperty(a.uuid,n,e),i++}break;default:if(plugin_1.default.getDropHandle(t.type)){o[t.type]=o[t.type]||[],o[t.type].push(t);continue}if(!this.canDrop(t.type))continue;const e=await node_1.default.createNodeFromAsset(a?a.uuid:cc.director._scene.uuid,t.value,{name:t.name,type:t.type,canvasRequired:t.canvasRequired,unlinkPrefab:t.unlinkPrefab,position:c}),n=node_1.default.query(e);gizmos_1.default.showNodeGizmoOfNode(n)}for(const e in o){const a=plugin_1.default.getDropHandle(e);a&&Editor.Message.send(a.name,a.item.message,t.map(dump_1.default.dumpNode),{x:c.x,y:c.y,z:c.z},o[e])}lastHighlightMC&&!selection_1.default.isSelect(lastHighlightMC.node.uuid)&&(gizmos_1.default.hideComponentGizmo(lastHighlightMC),lastHighlightMC=null),lastHighlightNode=null}queryAllRenderPipelines(){return render_pipeline_1.default.getComponent().map(e=>{const t="hidden:render_pipeline/";if(-1!==e.menuPath.indexOf(t)&&e.component)return{name:e.menuPath.replace(t,"")}}).filter(Boolean)}async queryRenderPipeline(e){let t;try{cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e)),t=await util_1.default.promisify(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}return t?(render_pipeline_1.default.cacheComponent(t),{name:t.constructor.name,value:render_pipeline_1.default.encodeComponent(t)}):null}async selectRenderPipeline(e){const t=new(render_pipeline_1.default.getComponent(e));return render_pipeline_1.default.cacheComponent(t),{name:t.constructor.name,value:render_pipeline_1.default.encodeComponent(t)}}async changeRenderPipeline(e){const t=await render_pipeline_1.default.updateComponent(e.value);return{name:e.name,value:t}}async applyRenderPipeline(e,t){const a=render_pipeline_1.default.getRenderPipeline(),n=cce.Utils.serialize(a);await cce.Ipc.send("save-asset",e,n)}async previewRenderPipeline(e,t){return render_pipeline_1.default.previewRenderPipeline(e,t)}queryAllRenderFlows(){return render_pipeline_1.default.getComponent().map(e=>{const t="hidden:render_flow/";if(-1!==e.menuPath.indexOf(t)&&e.component)return{name:e.menuPath.replace(t,""),value:render_pipeline_1.default.encodeComponent(e.component)}}).filter(Boolean)}queryAllRenderStages(){return render_pipeline_1.default.getComponent().map(e=>{const t="hidden:render_stage/";if(-1!==e.menuPath.indexOf(t)&&e.component)return{name:e.menuPath.replace(t,""),value:render_pipeline_1.default.encodeComponent(e.component)}}).filter(Boolean)}async selectRenderFlow(e,t){return render_pipeline_1.default.updateFlowComponent(e,t),!0}async selectRenderStage(e,t,a){return render_pipeline_1.default.updateStageComponent(e,t,a),!0}}exports.default=new AssetManager;