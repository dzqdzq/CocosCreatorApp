"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),material_1=require("cc/editor/material"),dumpUtil=__importStar(require("../../../export/dump/utils")),dumpDecode=__importStar(require("../../../export/dump/decode")),dumpEncode=__importStar(require("../../../export/dump/encode")),misc_1=require("../../../utils/misc"),utils_1=__importDefault(require("./utils")),message_1=require("../message");function getObjectKeys(e){if(!e)return[];if(e.constructor.__isJSB){const t=[];for(const s in e)t.push(s);return t}return Object.keys(e)}function tryGetEffectTooltip(e,t){if("string"==typeof t&&""!==t)return t;const s=`ENGINE.assets.effect.propertyTips.${e}`;return""!==Editor.I18n.t(s)?`i18n:${s}`:void 0}function deepCopyProperty(e,t,s,r){if(!e)return;const a=e[s],n=t[s];if(void 0!==n)if(Array.isArray(a)){if(Array.isArray(n)){const e=n.length,t=a.length;if(r&&e>t)for(let s=0;s<e-t;s++)a.push(new r);for(let e=0;e<n.length;e++)deepCopyProperty(a,n,e,r)}}else if(cc_1.CCClass._isCCClass(a.constructor)){const e=a.constructor;e.__props__.map(t=>{if(void 0!==a[t]&&void 0!==n[t]){const s=cc_1.CCClass.attr(e,t),r=dumpUtil.getConstructor(n[t],s);deepCopyProperty(a,n,t,r)}})}else e[s]=t[s]}function changePassStateToCCClass(e){const t=new material_1.PassStatesEditor;t.blendState.init(e.blendState);const s=t.constructor;return s.__props__.map(r=>{if(void 0!==t[r]&&void 0!==e[r]){const a=cc_1.CCClass.attr(s,r),n=dumpUtil.getConstructor(e[r],a);deepCopyProperty(t,e,r,n)}}),t}function getPassDefaultValue(e){let t=null;const s=cc_1.js.getClassByName(e);if(s)t=new s;else switch(e){case"Boolean":t=!1;break;case"Number":case"Float":case"Integer":case"Enum":t=0;break;case"String":t=""}return t}function patchNameToDump(e,t){if(!e)return;e.name=t;const s=e.value;if(Array.isArray(s))for(let e=0;e<s.length;e++)patchNameToDump(s[e],""+e);else"object"==typeof s&&(e.isObject=!0,Object.keys(s).forEach(e=>{patchNameToDump(s[e],e)}))}function patchDumpData(e,t){if(!e)return;e.name=t;const s=e.value;if(Array.isArray(s)){const r=getPassDefaultValue(e.type);e.elementTypeData=dumpEncode.encodeObject(r,{type:e.type,enumList:e.enumList}),patchNameToDump(e.elementTypeData,t);for(let e=0;e<s.length;e++)patchDumpData(s[e],""+e)}else"object"!=typeof s||e.extends.includes("cc.ValueType")?e.default=s:(e.isObject=!0,Object.keys(s).forEach(e=>{patchDumpData(s[e],e)}));e.isMat=!0}const getPropData=(e,t)=>{const s={},r=t.blocks.find(t=>void 0!==t.members.find(t=>t.name===e));if(r){s.defines=r.defines;const t=r.members.find(t=>t.name===e);t&&(s.count=t.count)}const a=t.samplerTextures.find(t=>t.name===e);return a&&(s.defines=a.defines,s.count=a.count),s},_previewLocker={},attributeProps=["visible","displayName","min","max","step","slide","tooltip","range"];function checkInspectorAttr(e){const t={};return attributeProps.forEach(s=>{if(e&&void 0!==e[s])if("range"===s){const r=e[s];r.length>=2&&(t.min=r[0],t.max=r[1],r.length>2&&(t.step=r[2]))}else t[s]=e[s]}),t}class MaterialAsset{async queryAllEffects(){var e;try{const t=cc_1.EffectAsset.getAll(),s={};for(const r in t){const a=t[r];if(a.uuid)try{const t=await Editor.Message.request("asset-db","query-asset-info",a.uuid);s[r]={uuid:a.uuid,name:a.name,hideInEditor:a.hideInEditor,assetPath:null!==(e=null===t||void 0===t?void 0:t.path)&&void 0!==e?e:""}}catch(e){console.error(e);continue}}return s}catch(e){return console.error(e),{}}}queryEffect(e){const t=cc_1.EffectAsset.get(e);return t?this.encodeEffect(t):{}}encodeEffect(e){return e.techniques.map(t=>{const s=t.passes.map((t,s)=>{const r=[],a=[],n=e.shaders.find(e=>e.name===t.program);n.defines.forEach(e=>{var t;if(e.name.startsWith("CC_"))return;const s=utils_1.default.GFXToValueTypeMap[e.type]||e.type;let r;switch(s){case"Number":r=e.range[0];break;case"String":r=e.options[0];break;default:r=!1}const n=dumpEncode.encodeObject(r,{default:r}),i=tryGetEffectTooltip(e.name,null===(t=e.editor)||void 0===t?void 0:t.tooltip);Object.assign(n,{name:e.name,defines:e.defines,type:s,options:e.options,range:e.range,default:n.value,tooltip:i}),a.push(n)}),t.properties&&getObjectKeys(t.properties).forEach(e=>{var s;const a=t.properties[e];if(a.editor&&a.editor.deprecated)return;const i=a.handleInfo&&a.handleInfo[0]||e;let o=a.editor&&a.editor.parent;o&&!Array.isArray(o)&&(o=[o]);const c=getPropData(i,n);let l=utils_1.default.GFXToValueTypeMap[a.type]||a.type;a.editor&&"color"===a.editor.type&&(l="cc.Color");let u=utils_1.default.getDefaultValue(l,a.value);if(c.count&&c.count>1){const e=[];for(let t=0;t<c.count;t++)e.push(u);u=e}let d={};a&&a.editor&&(d=checkInspectorAttr(a.editor));const f=tryGetEffectTooltip(e,null===(s=a.editor)||void 0===s?void 0:s.tooltip),p=dumpEncode.encodeObject(u,Object.assign({default:u,displayName:a.editor&&a.editor.displayName,visible:a.editor&&a.editor.visible,tooltip:f,range:a.editor&&a.editor.range,type:l},d));Array.isArray(p.value)&&p.value.forEach(e=>{e.default=e.value}),Object.assign(p,{name:e,defines:o||c.defines,default:p.value}),r.push(p)});const i=changePassStateToCCClass(t),o=dumpEncode.encodeObject(i,{});patchDumpData(o,"pipelineStates");const c=void 0!==t.propertyIndex&&t.propertyIndex!==s;return{switch:{name:t.switch,value:!1},propertyIndex:{value:void 0===t.propertyIndex?s:t.propertyIndex},props:c?[]:r,defines:c?[]:a,states:o,phase:t.phase}});return{name:t.name,passes:s}})}async decodeMaterial(e){const t=new cc_1.Material;t._effectAsset=cc_1.EffectAsset.get(e.effect),t._props=[],t._defines=[],t._techIdx=e.technique;const s=e.data[e.technique],r=[];function a(e){return e.default!==e.value&&JSON.stringify(e.default)!==JSON.stringify(e.value)}function n(e,t){if(e.isObject)t[e.name]={},Object.keys(e.value).forEach(s=>{n(e.value[s],t[e.name])});else if(e.isArray)if(cc_1.js.getClassByName(e.type)||"Object"===e.type||"Array"===e.type){t[e.name]=[];for(let s=0;s<e.value.length;s++)n(e.value[s],t[e.name])}else{t[e.name]=void 0;let n=!1;for(let t=0;t<e.value.length;t++)if(a(e.value[t])){n=!0;break}n&&(s=e.name,i=e,o=t,r.push(dumpDecode.decodePatch(`${s}`,i,o)))}else{if(!a(e))return!1;t[e.name]=void 0,((e,t,s)=>{r.push(dumpDecode.decodePatch(`${e}`,t,s))})(e.name,e,t)}var s,i,o;return!0}const i=s&&s.passes||[],o=[],c=[],l=[];for(let e=0;e<i.length;e++){const t=i[e];o[e]={},c[e]={},l[e]={},t.switch&&t.switch.name&&t.switch.value&&(c[e][t.switch.name]=t.switch.value);for(let s=0;s<t.defines.length;s++){n(t.defines[s],c[e])}for(let s=0;s<t.props.length;s++){n(t.props[s],o[e])}const s=Object.values(t.states.value);for(let t=0;t<s.length;t++){n(s[t],l[e])}}if(await Promise.all(r),t._props=o,t._defines=c,t._states=l,t._effectAsset&&t._effectAsset.techniques){const e=t._effectAsset.techniques[t._techIdx];if(e)for(let s=e.passes.length-1;s>=0;s--){const r=e.passes[s];void 0!==r.propertyIndex&&r.propertyIndex!==s&&(t._props[s]={},t._defines[s]={})}}return cce.Utils.serialize(t)}async queryMaterial(e){let t=void 0;try{t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}if(!t)return null;const s=cc_1.EffectAsset.get(t.effectName);if(!s)return{effect:"",technique:0,data:[]};const r=this.encodeEffect(s);function a(e,t){if(void 0!==e)if(e.isObject){const s=t;getObjectKeys(s).forEach(t=>{a(e.value[t],s[t])})}else if(e.isArray){if(t.length>e.value.length){const s=t.length-e.value.length;for(let t=0;t<s;t++){const t=JSON.parse(JSON.stringify(e.elementTypeData));t.name=""+e.value.length,t.displayName=""+e.value.length,e.value.push(t)}}for(let s=0;s<t.length;s++)a(e.value[s],t[s])}else{const s=dumpEncode.encodeObject(t,{});"Unknown"!==s.type&&(e.value=s.value)}}return r[t._techIdx].passes.forEach((e,s)=>{getObjectKeys(t._defines[s]||{}).forEach(r=>{const n=e.defines.find(e=>e.name===r);n?a(n,t._defines[s][r]):e.switch.name===r&&(e.switch.value=t._defines[s][r])}),getObjectKeys(t._props[s]||{}).forEach(r=>{const n=e.props.find(e=>e.name===r);n&&a(n,t._props[s][r])}),getObjectKeys(t._states[s]||{}).forEach(r=>{const n=Object.values(e.states.value).find(e=>e.name===r);n&&a(n,t._states[s][r])})}),{effect:t.effectName,technique:t._techIdx,data:r}}async previewMaterial(e,t,s){if(void 0!==_previewLocker[e])return void(_previewLocker[e]={uuid:e,data:t});if(await Editor.Message.request("asset-db","query-asset-info",e)){_previewLocker[e]=null;try{if(t){const r=await this.decodeMaterial(t),a=await(0,misc_1.promisify)(cc_1.assetManager.loadWithJson.bind(cc_1.assetManager))(r);a._uuid=e,cce.Preview.materialPreview.setMaterial(a),s&&!1===s.emit||cc_1.assetManager.assetListener.emit(e,a)}else{const t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);cce.Preview.materialPreview.setMaterial(t),s&&!1===s.emit||cc_1.assetManager.assetListener.emit(e,t)}}catch(e){console.error(e)}if(null!==_previewLocker[e]){const t=_previewLocker[e];process.nextTick((e,t,s)=>{this.previewMaterial(e,t,s)},t.uuid,t.data,s)}cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:material-preview-dirty"),delete _previewLocker[e]}else delete _previewLocker[e]}}exports.default=new MaterialAsset;