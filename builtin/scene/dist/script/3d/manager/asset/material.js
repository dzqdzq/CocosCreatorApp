"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var c=Object.getOwnPropertyDescriptor(t,r);c&&("get"in c?t.__esModule:!c.writable&&!c.configurable)||(c={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,c)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,r,o){var c,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(c=e[i])&&(s=(a<3?c(s):a>3?c(t,r,s):c(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const dumpUtil=__importStar(require("../../../utils/dump/utils")),cc_1=require("cc"),dumpDecode=__importStar(require("../../../utils/dump/decode")),dumpEncode=__importStar(require("../../../utils/dump/encode")),misc_1=require("../../../utils/misc"),utils_1=__importDefault(require("./utils")),message_1=require("../message");function isNumber(e){return"number"==typeof e&&!isNaN(e)}function getEnumData(e){const t={};return Object.keys(e).forEach(r=>{isNumber(Number(r))||(t[r]=e[r])}),t}function getObjectKeys(e){if(!e)return[];if(e.constructor.__isJSB){const t=[];for(const r in e)t.push(r);return t}return Object.keys(e)}const enumMap=(()=>{const e=e=>(0,cc_1.Enum)(getEnumData(e));return{PrimitiveMode:e(cc_1.gfx.PrimitiveMode),RenderPassStage:e(cc_1.pipeline.RenderPassStage),DynamicStateFlagBit:e(cc_1.gfx.DynamicStateFlagBit),PolygonMode:e(cc_1.gfx.PolygonMode),ShadeModel:e(cc_1.gfx.ShadeModel),CullMode:e(cc_1.gfx.CullMode),ComparisonFunc:e(cc_1.gfx.ComparisonFunc),StencilOp:e(cc_1.gfx.StencilOp),BlendFactor:e(cc_1.gfx.BlendFactor),BlendOp:e(cc_1.gfx.BlendOp),ColorMask:e(cc_1.gfx.ColorMask)}})();let RasterizerState=class{constructor(){this.isDiscard=!1,this.polygonMode=cc_1.gfx.PolygonMode.FILL,this.shadeModel=cc_1.gfx.ShadeModel.GOURAND,this.cullMode=cc_1.gfx.CullMode.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}};__decorate([cc_1._decorator.property],RasterizerState.prototype,"isDiscard",void 0),__decorate([cc_1._decorator.property({type:enumMap.PolygonMode})],RasterizerState.prototype,"polygonMode",void 0),__decorate([cc_1._decorator.property({type:enumMap.ShadeModel})],RasterizerState.prototype,"shadeModel",void 0),__decorate([cc_1._decorator.property({type:enumMap.CullMode})],RasterizerState.prototype,"cullMode",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"isFrontFaceCCW",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"depthBias",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"depthBiasClamp",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"depthBiasSlop",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"isDepthClip",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"isMultisample",void 0),__decorate([cc_1._decorator.property],RasterizerState.prototype,"lineWidth",void 0),RasterizerState=__decorate([cc_1._decorator.ccclass("RasterizerState")],RasterizerState);let DepthStencilState=class{constructor(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=cc_1.gfx.ComparisonFunc.LESS,this.stencilTestFront=!1,this.stencilFuncFront=cc_1.gfx.ComparisonFunc.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=cc_1.gfx.StencilOp.KEEP,this.stencilZFailOpFront=cc_1.gfx.StencilOp.KEEP,this.stencilPassOpFront=cc_1.gfx.StencilOp.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=cc_1.gfx.ComparisonFunc.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=cc_1.gfx.StencilOp.KEEP,this.stencilZFailOpBack=cc_1.gfx.StencilOp.KEEP,this.stencilPassOpBack=cc_1.gfx.StencilOp.KEEP,this.stencilRefBack=1}};__decorate([cc_1._decorator.property],DepthStencilState.prototype,"depthTest",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"depthWrite",void 0),__decorate([cc_1._decorator.property({type:enumMap.ComparisonFunc})],DepthStencilState.prototype,"depthFunc",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilTestFront",void 0),__decorate([cc_1._decorator.property({type:enumMap.ComparisonFunc})],DepthStencilState.prototype,"stencilFuncFront",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilReadMaskFront",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilWriteMaskFront",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilFailOpFront",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilZFailOpFront",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilPassOpFront",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilRefFront",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilTestBack",void 0),__decorate([cc_1._decorator.property({type:enumMap.ComparisonFunc})],DepthStencilState.prototype,"stencilFuncBack",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilReadMaskBack",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilWriteMaskBack",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilFailOpBack",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilZFailOpBack",void 0),__decorate([cc_1._decorator.property({type:enumMap.StencilOp})],DepthStencilState.prototype,"stencilPassOpBack",void 0),__decorate([cc_1._decorator.property],DepthStencilState.prototype,"stencilRefBack",void 0),DepthStencilState=__decorate([cc_1._decorator.ccclass("DepthStencilState")],DepthStencilState);let BlendTarget=class{constructor(){this.blend=!1,this.blendSrc=cc_1.gfx.BlendFactor.ONE,this.blendDst=cc_1.gfx.BlendFactor.ZERO,this.blendEq=cc_1.gfx.BlendOp.ADD,this.blendSrcAlpha=cc_1.gfx.BlendFactor.ONE,this.blendDstAlpha=cc_1.gfx.BlendFactor.ZERO,this.blendAlphaEq=cc_1.gfx.BlendOp.ADD,this.blendColorMask=cc_1.gfx.ColorMask.ALL}};__decorate([cc_1._decorator.property],BlendTarget.prototype,"blend",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendFactor})],BlendTarget.prototype,"blendSrc",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendFactor})],BlendTarget.prototype,"blendDst",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendOp})],BlendTarget.prototype,"blendEq",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendFactor})],BlendTarget.prototype,"blendSrcAlpha",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendFactor})],BlendTarget.prototype,"blendDstAlpha",void 0),__decorate([cc_1._decorator.property({type:enumMap.BlendOp})],BlendTarget.prototype,"blendAlphaEq",void 0),__decorate([cc_1._decorator.property({type:enumMap.ColorMask})],BlendTarget.prototype,"blendColorMask",void 0),BlendTarget=__decorate([cc_1._decorator.ccclass("BlendTarget")],BlendTarget);let BlendState=class{constructor(){this.isA2C=!1,this.isIndepend=!1,this.blendColor=cc_1.Color.WHITE,this.targets=[]}init(e){let t=1;e&&e.targets&&(t=e.targets.length);for(let e=0;e<t;e++)this.targets.push(new BlendTarget)}};__decorate([cc_1._decorator.property],BlendState.prototype,"isA2C",void 0),__decorate([cc_1._decorator.property],BlendState.prototype,"isIndepend",void 0),__decorate([cc_1._decorator.property(cc.Color)],BlendState.prototype,"blendColor",void 0),__decorate([cc_1._decorator.property([BlendTarget])],BlendState.prototype,"targets",void 0),BlendState=__decorate([cc_1._decorator.ccclass("BlendState")],BlendState);let PassStates=class{constructor(){this.priority=128,this.primitive=cc_1.gfx.PrimitiveMode.TRIANGLE_LIST,this.stage=cc_1.pipeline.RenderPassStage.DEFAULT,this.rasterizerState=null,this.depthStencilState=null,this.blendState=null,this.dynamics=[],this.customizations=[],this.phase=""}init(e){this.rasterizerState=new RasterizerState,this.depthStencilState=new DepthStencilState,this.blendState=new BlendState,this.blendState.init(e.blendState)}};function deepCopyProperty(e,t,r,o){if(!e)return;const c=e[r],a=t[r];if(void 0!==a)if(Array.isArray(c)){if(Array.isArray(a)){const e=a.length,t=c.length;if(o&&e>t)for(let r=0;r<e-t;r++)c.push(new o);for(let e=0;e<a.length;e++)deepCopyProperty(c,a,e,o)}}else if(cc_1.CCClass._isCCClass(c.constructor)){const e=c.constructor;e.__props__.map(t=>{if(void 0!==c[t]&&void 0!==a[t]){const r=cc_1.CCClass.attr(e,t),o=dumpUtil.getConstructor(a[t],r);deepCopyProperty(c,a,t,o)}})}else e[r]=t[r]}function changePassStateToCCClass(e){const t=new PassStates;t.init(e);const r=t.constructor;return r.__props__.map(o=>{if(void 0!==t[o]&&void 0!==e[o]){const c=cc_1.CCClass.attr(r,o),a=dumpUtil.getConstructor(e[o],c);deepCopyProperty(t,e,o,a)}}),t}function getPassDefaultValue(e){let t=null;const r=cc_1.js.getClassByName(e);if(r)t=new r;else switch(e){case"Boolean":t=!1;break;case"Number":case"Float":case"Integer":case"Enum":t=0;break;case"String":t=""}return t}function patchNameToDump(e,t){if(!e)return;e.name=t;const r=e.value;if(Array.isArray(r))for(let e=0;e<r.length;e++)patchNameToDump(r[e],""+e);else"object"==typeof r&&(e.isObject=!0,Object.keys(r).forEach(e=>{patchNameToDump(r[e],e)}))}function patchDumpData(e,t){if(!e)return;e.name=t;const r=e.value;if(Array.isArray(r)){const o=getPassDefaultValue(e.type);e.elementTypeData=dumpEncode.encodeObject(o,{type:e.type,enumList:e.enumList}),patchNameToDump(e.elementTypeData,t);for(let e=0;e<r.length;e++)patchDumpData(r[e],""+e)}else"object"!=typeof r||e.extends.includes("cc.ValueType")?e.default=r:(e.isObject=!0,Object.keys(r).forEach(e=>{patchDumpData(r[e],e)}));e.isMat=!0}__decorate([cc_1._decorator.property({type:cc_1.CCInteger})],PassStates.prototype,"priority",void 0),__decorate([cc_1._decorator.property({type:enumMap.PrimitiveMode})],PassStates.prototype,"primitive",void 0),__decorate([cc_1._decorator.property({type:enumMap.RenderPassStage})],PassStates.prototype,"stage",void 0),__decorate([cc_1._decorator.property({type:RasterizerState})],PassStates.prototype,"rasterizerState",void 0),__decorate([cc_1._decorator.property({type:DepthStencilState})],PassStates.prototype,"depthStencilState",void 0),__decorate([cc_1._decorator.property({type:BlendState})],PassStates.prototype,"blendState",void 0),__decorate([cc_1._decorator.property({type:[enumMap.DynamicStateFlagBit]})],PassStates.prototype,"dynamics",void 0),__decorate([cc_1._decorator.property({type:[cc_1.CCString]})],PassStates.prototype,"customizations",void 0),__decorate([cc_1._decorator.property],PassStates.prototype,"phase",void 0),PassStates=__decorate([cc_1._decorator.ccclass("PassStates")],PassStates);const getPropData=(e,t)=>{const r={},o=t.blocks.find(t=>void 0!==t.members.find(t=>t.name===e));if(o){r.defines=o.defines;const t=o.members.find(t=>t.name===e);t&&(r.count=t.count)}const c=t.samplerTextures.find(t=>t.name===e);return c&&(r.defines=c.defines,r.count=c.count),r},_previewLocker={},attributeProps=["visible","displayName","min","max","step","slide","tooltip","range"];function checkInspectorAttr(e){const t={};return attributeProps.forEach(r=>{if(e&&void 0!==e[r])if("range"===r){const o=e[r];o.length>=2&&(t.min=o[0],t.max=o[1],o.length>2&&(t.step=o[2]))}else t[r]=e[r]}),t}class MaterialAsset{queryAllEffects(){try{const e=cc_1.EffectAsset.getAll(),t={};return Object.keys(e).map(r=>{const o=e[r];t[r]={uuid:o._uuid,name:o.name,hideInEditor:o.hideInEditor}}),t}catch(e){return[]}}queryEffect(e){const t=cc_1.EffectAsset.get(e);return t?this.encodeEffect(t):{}}encodeEffect(e){return e.techniques.map(t=>{const r=t.passes.map((t,r)=>{const o=[],c=[],a=e.shaders.find(e=>e.name===t.program);a.defines.forEach(e=>{if(e.name.startsWith("CC_"))return;const t=utils_1.default.GFXToValueTypeMap[e.type]||e.type;let r;switch(t){case"Number":r=e.range[0];break;case"String":r=e.options[0];break;default:r=!1}const o=dumpEncode.encodeObject(r,{default:r});Object.assign(o,{name:e.name,defines:e.defines,type:t,options:e.options,range:e.range,default:o.value}),c.push(o)}),t.properties&&getObjectKeys(t.properties).forEach(e=>{const r=t.properties[e];if(r.editor&&r.editor.deprecated)return;const c=r.handleInfo&&r.handleInfo[0]||e;let s=r.editor&&r.editor.parent;s&&!Array.isArray(s)&&(s=[s]);const i=getPropData(c,a);let n=utils_1.default.GFXToValueTypeMap[r.type]||r.type;r.editor&&"color"===r.editor.type&&(n="cc.Color");let p=utils_1.default.getDefaultValue(n,r.value);if(i.count&&i.count>1){const e=[];for(let t=0;t<i.count;t++)e.push(p);p=e}let d={};r&&r.editor&&(d=checkInspectorAttr(r.editor));const l=dumpEncode.encodeObject(p,Object.assign({default:p,displayName:r.editor&&r.editor.displayName,visible:r.editor&&r.editor.visible,tooltip:r.editor&&r.editor.tooltip,range:r.editor&&r.editor.range,type:n},d));Array.isArray(l.value)&&l.value.forEach(e=>{e.default=e.value}),Object.assign(l,{name:e,defines:s||i.defines,default:l.value}),o.push(l)});const s=changePassStateToCCClass(t),i=dumpEncode.encodeObject(s,{});patchDumpData(i,"pipelineStates");const n=void 0!==t.propertyIndex&&t.propertyIndex!==r;return{switch:{name:t.switch,value:!1},propertyIndex:{value:void 0===t.propertyIndex?r:t.propertyIndex},props:n?[]:o,defines:n?[]:c,states:i}});return{name:t.name,passes:r}})}async decodeMaterial(e){const t=new cc_1.Material;t._effectAsset=cc_1.EffectAsset.get(e.effect),t._props=[],t._defines=[],t._techIdx=e.technique;const r=e.data[e.technique],o=[];function c(e){return e.default!==e.value&&JSON.stringify(e.default)!==JSON.stringify(e.value)}function a(e,t){if(e.isObject)t[e.name]={},Object.keys(e.value).forEach(r=>{a(e.value[r],t[e.name])});else if(e.isArray)if(cc_1.js.getClassByName(e.type)||"Object"===e.type||"Array"===e.type){t[e.name]=[];for(let r=0;r<e.value.length;r++)a(e.value[r],t[e.name])}else{t[e.name]=void 0;let a=!1;for(let t=0;t<e.value.length;t++)if(c(e.value[t])){a=!0;break}a&&(r=e.name,s=e,i=t,o.push(dumpDecode.decodePatch(`${r}`,s,i)))}else{if(!c(e))return!1;t[e.name]=void 0,((e,t,r)=>{o.push(dumpDecode.decodePatch(`${e}`,t,r))})(e.name,e,t)}var r,s,i;return!0}const s=r&&r.passes||[],i=[],n=[],p=[];for(let e=0;e<s.length;e++){const t=s[e];i[e]={},n[e]={},p[e]={},t.switch&&t.switch.name&&t.switch.value&&(n[e][t.switch.name]=t.switch.value);for(let r=0;r<t.defines.length;r++){a(t.defines[r],n[e])}for(let r=0;r<t.props.length;r++){a(t.props[r],i[e])}const r=Object.values(t.states.value);for(let t=0;t<r.length;t++){a(r[t],p[e])}}if(await Promise.all(o),t._props=i,t._defines=n,t._states=p,t._effectAsset&&t._effectAsset.techniques){const e=t._effectAsset.techniques[t._techIdx];if(e)for(let r=e.passes.length-1;r>=0;r--){const o=e.passes[r];void 0!==o.propertyIndex&&o.propertyIndex!==r&&(t._props[r]={},t._defines[r]={})}}return cce.Utils.serialize(t)}async queryMaterial(e){let t=void 0;try{t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e)}catch(e){console.error(e)}if(!t)return null;const r=cc_1.EffectAsset.get(t.effectName);if(!r)return{effect:"",technique:0,data:[]};const o=this.encodeEffect(r);function c(e,t){if(void 0!==e)if(e.isObject){const r=t;getObjectKeys(r).forEach(t=>{c(e.value[t],r[t])})}else if(e.isArray){if(t.length>e.value.length){const r=t.length-e.value.length;for(let t=0;t<r;t++){const t=JSON.parse(JSON.stringify(e.elementTypeData));t.name=""+e.value.length,t.displayName=""+e.value.length,e.value.push(t)}}for(let r=0;r<t.length;r++)c(e.value[r],t[r])}else{const r=dumpEncode.encodeObject(t,{});"Unknown"!==r.type&&(e.value=r.value)}}return o[t._techIdx].passes.forEach((e,r)=>{getObjectKeys(t._defines[r]||{}).forEach(o=>{const a=e.defines.find(e=>e.name===o);a?c(a,t._defines[r][o]):e.switch.name===o&&(e.switch.value=t._defines[r][o])}),getObjectKeys(t._props[r]||{}).forEach(o=>{const a=e.props.find(e=>e.name===o);a&&c(a,t._props[r][o])}),getObjectKeys(t._states[r]||{}).forEach(o=>{const a=Object.values(e.states.value).find(e=>e.name===o);a&&c(a,t._states[r][o])})}),{effect:t.effectName,technique:t._techIdx,data:o}}async previewMaterial(e,t,r){if(void 0===_previewLocker[e]){_previewLocker[e]=null;try{if(t){const o=await this.decodeMaterial(t),c=await(0,misc_1.promisify)(cc_1.assetManager.loadWithJson.bind(cc_1.assetManager))(o);c._uuid=e,cce.Preview.materialPreview.setMaterial(c),r&&!1===r.emit||cc_1.assetManager.assetListener.emit(e,c)}else{const t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);cce.Preview.materialPreview.setMaterial(t),r&&!1===r.emit||cc_1.assetManager.assetListener.emit(e,t)}}catch(e){console.error(e)}if(null!==_previewLocker[e]){const t=_previewLocker[e];process.nextTick((e,t,r)=>{this.previewMaterial(e,t,r)},t.uuid,t.data,r)}cce.Engine.repaintInEditMode(),message_1.messageManager.broadcast("scene:material-preview-dirty"),delete _previewLocker[e]}else _previewLocker[e]={uuid:e,data:t}}}exports.default=new MaterialAsset;