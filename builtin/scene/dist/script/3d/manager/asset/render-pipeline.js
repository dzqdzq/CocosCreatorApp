"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),dumpEncode=__importStar(require("../../../../utils/dump/encode")),dumpUtil=__importStar(require("../../../../utils/dump/utils")),util_1=require("util");let cachePipeline=null;const _previewLocker={};class RenderPipeline{modifyProp(e,t){if(e.name=t,e.isRPP=!0,e.value&&"object"==typeof e.value)for(const t in e.value)"object"==typeof e.value[t]&&this.modifyProp(e.value[t],t)}encodeComponent(e){const t=e.constructor;if(!t.__props__)return;const r={};return t.__props__.forEach(o=>{try{if(void 0===e[o])return;const i=cc.Class.attr(t,o);r[o]=dumpEncode.encodeObject(e[o],i,e),this.modifyProp(r[o],o)}catch(t){console.warn(`Component property dump failed:\n Component: ${e.constructor.name}\n Property: ${o}`),console.warn(t)}}),r}getComponent(e){const t=EditorExtends.Component.getMenus();if(e){return t.filter(t=>t.menuPath.endsWith(e))[0].component}return t}resetProperty(e){const t=e.constructor;t.__props__&&t.__props__.forEach(r=>{try{const o=cc.Class.attr(t,r);if(o&&cc.Class._isCCClass(o.ctor)&&null===e[r]&&(e[r]=new o.ctor),Array.isArray(e[r]))for(const t of e[r])this.resetProperty(t)}catch(e){console.warn(e)}})}cacheComponent(e){this.resetProperty(e),cachePipeline=e}getRenderPipeline(){return cachePipeline}async updateComponent(e){const t=Object.keys(e);for(const o of t)await r(cachePipeline,e,o);async function r(e,t,o){if(null!==t){if("object"!=typeof t)return"uuid"!==o||"uuid"in e?void(e[o]=t):void(e._uuid=t);if(t.isArray||void 0===t.value)if(t.isArray&&void 0!==t.value){Array.isArray(e[o])||(e[o]=[]);const i=t.value,n=cc.Class.attr(e.constructor,o),c=e[o].length,l=i.length;if(l>c)for(let t=c;t<l;t++)e[o][t]=dumpUtil.ccClassAttrPropertyDefaultValue(n);else{const t=e[o].slice();e[o]=[];for(let n=0;n<c;n++){if(void 0===i[n])continue;const c=i[n].name;e[o][n]=t[c],await r(e[o],i,n.toString())}for(let t=c;t<l;t++)e[o][t]=dumpUtil.ccClassAttrPropertyDefaultValue(n)}}else if(t[o].isArray){Array.isArray(e[o])||(e[o]=[]);const i=t[o].value,n=cc.Class.attr(e.constructor,o),c=e[o].length,l=i.length;if(l>c)for(let t=c;t<l;t++)e[o][t]=dumpUtil.ccClassAttrPropertyDefaultValue(n);else{const t=e[o].slice();e[o]=[];for(let n=0;n<c;n++){if(void 0===i[n])continue;const c=i[n].name;e[o][n]=t[c],await r(e[o],i,n.toString())}for(let t=c;t<l;t++)e[o][t]=dumpUtil.ccClassAttrPropertyDefaultValue(n)}}else if("object"==typeof t[o].value)if(null===e[o]||"object"!=typeof e[o])e[o]=t[o].value;else{const i=Object.keys(t[o].value);for(const n of i)await r(e[o],t[o].value[n],n)}else e[o]=t[o].value;else if(null===t.value||"object"!=typeof t.value)e[o]=t.value;else if(null===e[o]||"object"!=typeof e[o])"uuid"in t.value?t.value.uuid&&(e[o]=await util_1.promisify(cc_1.assetManager.loadAny)(t.value.uuid)):e[o]=t.value;else{const i=Object.keys(t.value);for(const n of i)"uuid"===n?t.value[n]?e[o]=await util_1.promisify(cc_1.assetManager.loadAny)(t.value[n]):e[o]=null:await r(e[o],t.value[n],n)}}}return this.encodeComponent(cachePipeline)}updateFlowComponent(e,t){const r=new(this.getComponent(e));this.resetProperty(r),cachePipeline.flows.splice(t,1,r)}updateStageComponent(e,t,r){const o=new(this.getComponent(e));this.resetProperty(o),cachePipeline.flows[t].stages.splice(r,1,o)}async previewRenderPipeline(e,t){if(void 0===_previewLocker[e]){_previewLocker[e]=null;try{if(t){const t=cc.director.root.pipeline;if(t&&t._uuid===e){const t=await util_1.promisify(cc.assetManager.loadAny)(e);t._uuid=e,cc.director.root.setRenderPipeline(t),cc_1.assetManager.assetListener.emit(e,t)}}}catch(e){console.error(e)}if(null!==_previewLocker[e]){const t=_previewLocker[e];process.nextTick(()=>{this.previewRenderPipeline(t.uuid,t.data)})}cce.Engine.repaintInEditMode(),delete _previewLocker[e]}else _previewLocker[e]={uuid:e,data:t}}}exports.default=new RenderPipeline;