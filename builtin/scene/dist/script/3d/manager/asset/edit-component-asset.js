"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var u=Object.getOwnPropertyDescriptor(t,o);u&&("get"in u?t.__esModule:!u.writable&&!u.configurable)||(u={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,u)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const encode_1=__importDefault(require("../../../utils/dump/encode")),dumpUtil=__importStar(require("../../../utils/dump/utils")),asset_1=require("../../../utils/asset"),utils_1=__importDefault(require("./utils"));class EditComponentAsset{constructor(){this.component=null}modifyProp(e,t){if(e.name=t,e.value&&"object"==typeof e.value)for(const t in e.value)"object"==typeof e.value[t]&&this.modifyProp(e.value[t],t)}encodeComponent(e){const t=e.constructor;if(!t.__props__)return null;const o={};return t.__props__.forEach(n=>{try{if(n in e){const u=cc.Class.attr(t,n),r=encode_1.default.encodeObject(e[n],u,e,n);"Unknown"!==r.type&&(o[n]=r,this.modifyProp(o[n],n))}}catch(t){console.warn(`Component property dump failed:\n Component: ${e.constructor.name}\n Property: ${n}`),console.warn(t)}}),o}cacheComponent(e){this.component=e}getComponent(){return this.component}async updateComponent(e){for(const o in e)e[o].visible&&await t(this.component,e,o);async function t(e,o,n){if(o){if("object"!=typeof o)return"uuid"===n&&"_uuid"in e?void(e._uuid=o):void(e[n]=o);if(o[n].isArray){const u=cc.Class.attr(e.constructor,n);if(Array.isArray(e[n])||(e[n]=dumpUtil.ccClassAttrPropertyDefaultValue(u)),Array.isArray(e[n])){const u=e[n].length,r=o[n].value.length;if(r>u)for(let i=u;i<r;i++)if(o[n].value[i].type){const u=cc.js.getClassByName(o[n].value[i].type);u?(e[n][i]=new u,await t(e[n],o[n].value,i.toString())):e[n][i]=utils_1.default.getDefaultValue(o[n].value[i].type)}else e[n][i]=null;else if(r<u)for(;e[n].length>r;)e[n].pop();else if(u){const t=e[n].slice();e[n]=[];for(let r=0;r<u;r++)void 0!==o[n].value[r]&&(e[n][r]=t[o[n].value[r].name])}for(let u=0;u<e[n].length;u++){if(o[n].value[u].type&&o[n].value[u].type!==e[n][u].constructor.name){const t=cc.js.getClassByName(o[n].value[u].type);t&&(e[n][u]=new t)}await t(e[n],o[n].value,u.toString())}}else delete e[n]}else if(null===o[n].value||"object"!=typeof o[n].value)e[n]=o[n].value;else{const u=Object.keys(o[n].value);for(const r of u)"uuid"===r?o[n].value[r]?(!e[n]||void 0!==e[n]._uuid&&e[n]._uuid!==o[n].value[r])&&(e[n]=await(0,asset_1.loadAssetUncached)(o[n].value.uuid)):e[n]=null:await t(e[n],o[n].value,r)}}}return this.encodeComponent(this.component)}}exports.default=EditComponentAsset;