"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),util_1=require("util"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function getBoundaryOfMeshNode(e){var t;if(e){const i=e.getComponent(cc_1.MeshRenderer);let o;if(i instanceof cc_1.SkinnedMeshRenderer)o=null===(t=null===i||void 0===i?void 0:i.model)||void 0===t?void 0:t.worldBounds;else if(i&&i.mesh){if(!(o=i.model&&i.model.modelBounds)){const e=i.mesh;e&&(o=cc_1.geometry.aabb.fromPoints(cc_1.geometry.aabb.create(),e.minPosition,e.maxPosition))}o&&cc_1.geometry.aabb.transform(o,o,e.worldMatrix)}return o}}function calcModelInfo(e){let t=0,i=0,o=[];if(e){const s=e.getComponent(cc_1.MeshRenderer);if(s&&s.mesh){for(const e of s.mesh.struct.primitives){const o=s.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(t+=o);const c=e.indexView?e.indexView.count:o;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:i+=c/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:i+=c-2}}if(s.mesh.struct.vertexBundles){const e=s.mesh.struct.vertexBundles;for(const t of e)for(const e of t.attributes){const t=e.name;if(0===t.indexOf(cc_1.gfx.AttributeName.ATTR_TEX_COORD)){let e=0,i=t.charAt(cc_1.gfx.AttributeName.ATTR_TEX_COORD.length);i&&(e=Number.parseInt(i)),o.includes(e)||o.push(e)}}}}e.children.forEach(e=>{const o=calcModelInfo(e);t+=o.vertices,i+=o.polygons})}return{vertices:t,polygons:i,uvs:o}}class MeshPreview{constructor(){this._isMouseDown=!1,this._viewDist=0,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._modelInfo={vertices:0,polygons:0,uvs:[]}}init(){this.scene=new cc.Scene,this.cameraComp=new cc.Node("Mesh Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Mesh Preview Light").addComponent(cc_1.DirectionalLight),this._modelNode=new cc_1.Node("Mesh Preview Mesh"),this._modelNode.parent=this.scene,this._modelComp=this._modelNode.addComponent(cc_1.MeshRenderer),this._defaultMat=new cc_1.Material,this._defaultMat.initialize({effectName:"builtin-standard"}),this._modelComp.material=this._defaultMat,this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:mesh-preview","query-mesh-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!0),this.cameraComp.enabled=!1}async setMesh(e){if(!e)return void console.warn("invalid uuid");if(!this._modelNode)return void console.warn("invalid mode node");cc_1.assetManager.assets.remove(e);const t=await util_1.promisify(cc_1.assetManager.loadAny)(e);this._modelComp.mesh=t,this._modelNode.parent=this.scene;for(let e=0;e<this._modelComp.mesh.struct.primitives.length;e++)this._modelComp.setMaterial(this._defaultMat,e);this._modelInfo=calcModelInfo(this._modelNode),this.cameraComp.enabled=!0,this.perfectCameraView(),Editor.Message.broadcast("scene:mesh-preview-mesh-info",this._modelInfo)}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=getBoundaryOfMeshNode(this._modelNode);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),i=this.cameraComp.fov,o=1.2*t/Math.tan(i/2*Math.PI/180);return this.cameraComp.near=o-t,this.cameraComp.far=o+t,o}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const i=this._curCameraRot;quat_1.MQuat.rotateX(i,i,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(i,i,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,i),quat_1.MQuat.fromEuler(i,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.default=new MeshPreview;