"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MeshPreview=void 0;const cc_1=require("cc"),misc_1=require("../../../utils/misc"),node_1=__importDefault(require("../../../utils/node")),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function calcModelInfo(e){const t={vertices:0,polygons:0,uvs:[]};let i=0,s=0;const o=[];if(e){const n=e.getComponent(cc_1.MeshRenderer);if(n&&n.mesh){for(const e of n.mesh.struct.primitives){const t=n.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(i+=t);const o=e.indexView?e.indexView.count:t;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:s+=o/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:s+=o-2}}if(n.mesh.struct.vertexBundles){const e=n.mesh.struct.vertexBundles;for(const t of e)for(const e of t.attributes){const t=e.name;if(0===t.indexOf(cc_1.gfx.AttributeName.ATTR_TEX_COORD)){let e=0;const i=t.charAt(cc_1.gfx.AttributeName.ATTR_TEX_COORD.length);i&&(e=Number.parseInt(i)),o.includes(e)||o.push(e)}}}if(n.mesh.struct.minPosition){const e=n.mesh.struct.minPosition;t.minPosition={x:e.x,y:e.y,z:e.z}}if(n.mesh.struct.maxPosition){const e=n.mesh.struct.maxPosition;t.maxPosition={x:e.x,y:e.y,z:e.z}}}e.children.forEach(e=>{const t=calcModelInfo(e);i+=t.vertices,s+=t.polygons}),t.vertices=i,t.polygons=s,t.uvs=o}return t}class MeshPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this._modelInfo={vertices:0,polygons:0,uvs:[]}}init(e,t){super.init(e,t)}createNodes(e){this.lightComp=new cc.Node("Mesh Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e,this._modelNode=new cc_1.Node("Mesh Preview Mesh"),this._modelNode.parent=this.scene,this._modelComp=this._modelNode.addComponent(cc_1.MeshRenderer),this._defaultMat=new cc_1.Material,this._defaultMat.initialize({effectName:"builtin-standard"}),this._modelComp.material=this._defaultMat}async setMesh(e){if(!e)return console.warn("invalid uuid"),null;if(!this._modelNode)return console.warn("invalid mode node"),null;cc_1.assetManager.assets.remove(e);const t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);this._modelComp.mesh=t,this._modelNode.parent=this.scene;for(let e=0;e<this._modelComp.mesh.struct.primitives.length;e++)this._modelComp.setMaterial(this._defaultMat,e);return this._modelInfo=calcModelInfo(this._modelNode),this.cameraComp.enabled=!0,this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),this._modelInfo}async getModelUVs(e){if(!e)return console.warn("invalid uuid"),null;if(!this._modelNode)return console.warn("invalid mode node"),null;this._modelComp.mesh||this.setMesh(e);const t=this._modelComp.mesh;if(!t.allowDataAccess)return[];const i=t.readIndices(0),s=[];for(const[e,o]of Object.entries(cc_1.gfx.AttributeName))if(e.includes("ATTR_TEX_COORD")){const e=t.readAttributeFormat(0,o);if(!e)continue;const n=t.readAttribute(0,o);s.push({name:o,buffer:n,format:{count:e.count},index:i})}return s}getModelInfo(){return this._modelInfo}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),this.cameraComp.node.getWorldRotation(this._curCameraRot)}}exports.MeshPreview=MeshPreview;