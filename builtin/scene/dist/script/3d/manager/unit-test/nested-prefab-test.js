"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nestedPrefabTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc");function getPrefabInfo(e){return e._prefab}const cubeAssetUUID="30da77a1-f02d-4ede-aa56-403452ee7fde",boxColliderClassName=cc_1.js.getClassName(cc_1.BoxCollider),testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",cubeNode2PrefabAssetUrl="db://assets/cubeNode2Prefab.prefab";class NestedPrefabTest{async test(e){var n;console.log("NestedPrefabTest-----------");let t=await e.createNode({name:"testPrefabRootNode"});if(!t)return!1;const r=await e.createPrefab(t,testPrefabAssetUrl);if(!r)return!1;await new Promise(e=>{setTimeout(function(){e()},1200)});let a=node_1.default.query(t);const i=getPrefabInfo(a);if(!(null===i||void 0===i?void 0:i.fileId))return!1;const o=null===(n=i.instance)||void 0===n?void 0:n.propertyOverrides;if(!o||4!==o.length)return console.error("property overrides doesn't match"),!1;e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)});let s=cc_1.director.getScene();if(!s)return console.error("scene is null"),!1;let c=(a=s.children[0]).uuid;await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:c});const d=await e.createNode({name:"childNode",assetUuid:cubeAssetUUID,parent:c}),l=(await e.createNode({name:"CubeNode",assetUuid:cubeAssetUUID,parent:d}),await e.createPrefab(d,childPrefabAssetUrl));if(await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(l),await new Promise(e=>{setTimeout(function(){e()},500)}),await e.saveScene(),await e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)}),!(s=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(a=s.children[0]).uuid;let u=a.children[1];let f=await e.createNode({name:"CubeNode2",assetUuid:cubeAssetUUID,parent:u.uuid}),b=(await e.createNode({name:"CubeNode2Child",assetUuid:cubeAssetUUID,parent:f}),u.children[0]);if(node_1.default.createComponent(b.uuid,boxColliderClassName),await e.saveScene(),await e.closeScene(),await e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)}),!(s=cc_1.director.getScene()))return console.error("scene is null"),!1;if(c=(a=s.children[0]).uuid,2!==(u=a.children[1]).children.length)return console.error(`mounted child in nested prefab save failed. ${u.children.length}`),!1;if(!(b=u.children[0]).getComponent(boxColliderClassName))return console.error("mounted component in nested prefab save failed"),!1;1!==u.children[1].children.length&&console.error(`mounted child in nested prefab save failed. ${u.children.length}`),f=u.children[1].uuid;await e.createPrefab(f,cubeNode2PrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),!(s=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(a=s.children[0]).uuid;let m=(u=a.children[1]).children[1];"CubeNode2"!==m.name&&console.error("mounted prefabInstance node in nested prefab save failed");if(await e.setNodeProperty({uuid:m.uuid,path:"name",dump:{type:"String",value:"CubeNode2NewName"}}),await e.saveScene(),await e.closeScene(),await e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)}),!(s=cc_1.director.getScene()))return console.error("scene is null"),!1;if(c=(a=s.children[0]).uuid,"CubeNode2NewName"!==(m=(u=a.children[1]).children[1]).name)return console.error("mounted prefabInstance node in nested prefab change name failed"),!1;if(await e.unlinkPrefab(m.uuid,!1),await e.saveScene(),await e.closeScene(),await e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)}),!(s=cc_1.director.getScene()))return console.error("scene is null"),!1;if(c=(a=s.children[0]).uuid,"CubeNode2NewName"!==(m=(u=a.children[1]).children[1]).name)return console.error("mounted prefabInstance node in nested prefab change name failed"),!1;if(1!==m.children.length)return console.error("mounted prefabInstance node in nested prefab unWrap failed"),!1;await e.duplicateNode(u.uuid);let h=a.children[2],p=getPrefabInfo(u),w=getPrefabInfo(h);return(null===p||void 0===p?void 0:p.instance)&&(null===w||void 0===w?void 0:w.instance)&&p.instance.fileId===w.instance.fileId?(console.error("duplicate prefabInstance node has the same fileId"),!1):(e.unlinkPrefab(u.uuid,!1),e.unlinkPrefab(h.uuid,!1),await e.saveScene(),await e.closeScene(),await new Promise(e=>{setTimeout(function(){e()},500)}),(s=cc_1.director.getScene())?(c=(a=s.children[0]).uuid,u=a.children[1],h=a.children[2],u.uuid===h.uuid?(console.error("unWrap duplicate prefabInstance node has the same uuid"),!1):(p=getPrefabInfo(u),w=getPrefabInfo(h),p&&w&&p.fileId===w.fileId?(console.error("unWrap duplicate prefabInstance node has the same fileId"),!1):(s=cc_1.director.getScene())?(t=(a=null===s||void 0===s?void 0:s.children[0]).uuid,e.removeNode({uuid:t}),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),!0):(console.error("scene is null"),!1))):(console.error("scene is null"),!1))}}const nestedPrefabTest=new NestedPrefabTest;exports.nestedPrefabTest=nestedPrefabTest;