"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nestedPrefabTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc"),common_1=require("./common"),cubeAssetUUID="30da77a1-f02d-4ede-aa56-403452ee7fde",boxColliderClassName=cc_1.js.getClassName(cc_1.BoxCollider),testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",cubeNode2PrefabAssetUrl="db://assets/CubeNode2.prefab";class NestedPrefabTest{async test(e){var t;console.log("NestedPrefabTest-----------");await e.openScene("");let a=await e.createNode({name:"testPrefab"});if(!a)return(0,common_1.returnFalseWithLog)("testNodeUUID check failed");const n=await e.createPrefab(a,testPrefabAssetUrl);if(!n)return(0,common_1.returnFalseWithLog)("testPrefabAssetUUID check failed");a=(await e.queryNodesByAssetUuid(n))[0],await new Promise(e=>{setTimeout(function(){e()},1200)});let r=node_1.default.query(a);const i=(0,common_1.getPrefabInfo)(r);if(!(null===i||void 0===i?void 0:i.fileId))return(0,common_1.returnFalseWithLog)("rootNodePrefabInfo.fileID check failed");const o=null===(t=i.instance)||void 0===t?void 0:t.propertyOverrides;if(!o||4!==o.length)return(0,common_1.returnFalseWithLog)("property overrides doesn't match");let s="",d=null;async function c(t,a="testPrefab"){if(e.openScene(t),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");r=d.getChildByName(a),s=r.uuid}await c(n);await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:s});const u=await e.createNode({name:"childPrefab",assetUuid:cubeAssetUUID,parent:s}),l=(await e.createNode({name:"CubeNode",assetUuid:cubeAssetUUID,parent:u}),await e.createPrefab(u,childPrefabAssetUrl));await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(l),await new Promise(e=>{setTimeout(function(){e()},500)}),await e.saveScene(),await c(n);let f=r.children[1];let m=await e.createNode({name:"CubeNode2",assetUuid:cubeAssetUUID,parent:f.uuid});await e.createNode({name:"CubeNode2Child",assetUuid:cubeAssetUUID,parent:m});let b=f.children[0];if(node_1.default.createComponent(b.uuid,boxColliderClassName),await e.saveScene(),await e.closeScene(),await c(n),2!==(f=r.children[1]).children.length)return(0,common_1.returnFalseWithLog)(`mounted child in nested prefab save failed. ${f.children.length}`);if(!(b=f.children[0]).getComponent(boxColliderClassName))return(0,common_1.returnFalseWithLog)("mounted component in nested prefab save failed");if(1!==f.children[1].children.length)return(0,common_1.returnFalseWithLog)("mounted component in nested prefab save failed");m=f.children[1].uuid;await e.createPrefab(m,cubeNode2PrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");r=d.getChildByName("testPrefab"),s=r.uuid;let h=(f=r.children[1]).children[1];if("CubeNode2"!==h.name)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab save failed");if(await e.setNodeProperty({uuid:h.uuid,path:"name",dump:{type:"String",value:"CubeNode2NewName"}}),await e.saveScene(),await e.closeScene(),await c(n),"CubeNode2NewName"!==(h=(f=r.children[1]).children[1]).name)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab change name failed");if(await e.unlinkPrefab(h.uuid,!1),await e.saveScene(),await e.closeScene(),await c(n),"CubeNode2NewName"!==(h=(f=r.children[1]).children[1]).name)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab change name failed");if(1!==h.children.length)return(0,common_1.returnFalseWithLog)("mounted prefabInstance node in nested prefab unWrap failed");await e.duplicateNode(f.uuid);let p=r.children[2],w=(0,common_1.getPrefabInfo)(f),_=(0,common_1.getPrefabInfo)(p);if((null===w||void 0===w?void 0:w.instance)&&(null===_||void 0===_?void 0:_.instance)&&w.instance.fileId===_.instance.fileId)return(0,common_1.returnFalseWithLog)("duplicate prefabInstance node has the same fileId");if(e.unlinkPrefab(f.uuid,!1),e.unlinkPrefab(p.uuid,!1),await e.saveScene(),await e.closeScene(),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");if(r=d.getChildByName("testPrefab"),s=r.uuid,f=r.children[1],p=r.children[2],f.uuid===p.uuid)return(0,common_1.returnFalseWithLog)("unWrap duplicate prefabInstance node has the same uuid");if(w=(0,common_1.getPrefabInfo)(f),_=(0,common_1.getPrefabInfo)(p),w&&_&&w.fileId===_.fileId)return(0,common_1.returnFalseWithLog)("unWrap duplicate prefabInstance node has the same fileId");await c(n),f=r.children[1],p=r.children[2],e.removeNode({uuid:f.uuid}),e.removeNode({uuid:p.uuid});e.createNode({parent:s,type:"cc.Prefab",assetUuid:l});await new Promise(e=>{setTimeout(function(){e()},500)}),b=(f=r.children[1]).children[0],e.setNodeProperty({uuid:b.uuid,path:"__comps__.0.shadowCastingMode",dump:{type:"Enum",value:1}}),await e.saveScene(),await e.closeScene(),await c(n);const g=(b=(f=r.children[1]).children[0]).getComponent(cc_1.MeshRenderer);return 1!==(null===g||void 0===g?void 0:g.shadowCastingMode)?(0,common_1.returnFalseWithLog)("component value in nested prefab not saved correctly"):(await e.saveScene(),await e.closeScene(),(d=cc_1.director.getScene())?(a=(r=d.getChildByName("testPrefab")).uuid,e.removeNode({uuid:a}),!0):(0,common_1.returnFalseWithLog)("scene is null"))}async clear(){return cce.Selection.clear(),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",cubeNode2PrefabAssetUrl),!0}}const nestedPrefabTest=new NestedPrefabTest;exports.nestedPrefabTest=nestedPrefabTest;