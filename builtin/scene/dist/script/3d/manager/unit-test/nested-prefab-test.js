"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nestedPrefabTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc");function getPrefabInfo(e){return e._prefab}const cubeAssetUUID="30da77a1-f02d-4ede-aa56-403452ee7fde",boxColliderClassName=cc_1.js.getClassName(cc_1.BoxCollider),testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",cubeNode2PrefabAssetUrl="db://assets/cubeNode2Prefab.prefab";class NestedPrefabTest{async test(e){var t;console.log("NestedPrefabTest-----------");let a=await e.createNode({name:"testPrefabRootNode"});if(!a)return!1;const n=await e.createPrefab(a,testPrefabAssetUrl);if(!n)return!1;await new Promise(e=>{setTimeout(function(){e()},1200)});let r=node_1.default.query(a);const i=getPrefabInfo(r);if(!(null===i||void 0===i?void 0:i.fileId))return!1;const s=null===(t=i.instance)||void 0===t?void 0:t.propertyOverrides;if(!s||4!==s.length)return console.error("property overrides doesn't match"),!1;let o="",d=null;async function c(t){e.openScene(t),await new Promise(e=>{setTimeout(function(){e()},500)}),(d=cc_1.director.getScene())?(r=d.children[0],o=r.uuid):console.error("scene is null")}await c(n);await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:o});const l=await e.createNode({name:"childNode",assetUuid:cubeAssetUUID,parent:o}),u=(await e.createNode({name:"CubeNode",assetUuid:cubeAssetUUID,parent:l}),await e.createPrefab(l,childPrefabAssetUrl));await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(u),await new Promise(e=>{setTimeout(function(){e()},500)}),await e.saveScene(),await c(n);let f=r.children[1];let b=await e.createNode({name:"CubeNode2",assetUuid:cubeAssetUUID,parent:f.uuid}),h=(await e.createNode({name:"CubeNode2Child",assetUuid:cubeAssetUUID,parent:b}),f.children[0]);if(node_1.default.createComponent(h.uuid,boxColliderClassName),await e.saveScene(),await e.closeScene(),await c(n),2!==(f=r.children[1]).children.length)return console.error(`mounted child in nested prefab save failed. ${f.children.length}`),!1;if(!(h=f.children[0]).getComponent(boxColliderClassName))return console.error("mounted component in nested prefab save failed"),!1;1!==f.children[1].children.length&&console.error(`mounted child in nested prefab save failed. ${f.children.length}`),b=f.children[1].uuid;await e.createPrefab(b,cubeNode2PrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;r=d.children[0],o=r.uuid;let p=(f=r.children[1]).children[1];"CubeNode2"!==p.name&&console.error("mounted prefabInstance node in nested prefab save failed");if(await e.setNodeProperty({uuid:p.uuid,path:"name",dump:{type:"String",value:"CubeNode2NewName"}}),await e.saveScene(),await e.closeScene(),await c(n),"CubeNode2NewName"!==(p=(f=r.children[1]).children[1]).name)return console.error("mounted prefabInstance node in nested prefab change name failed"),!1;if(await e.unlinkPrefab(p.uuid,!1),await e.saveScene(),await e.closeScene(),await c(n),"CubeNode2NewName"!==(p=(f=r.children[1]).children[1]).name)return console.error("mounted prefabInstance node in nested prefab change name failed"),!1;if(1!==p.children.length)return console.error("mounted prefabInstance node in nested prefab unWrap failed"),!1;await e.duplicateNode(f.uuid);let m=r.children[2],w=getPrefabInfo(f),P=getPrefabInfo(m);if((null===w||void 0===w?void 0:w.instance)&&(null===P||void 0===P?void 0:P.instance)&&w.instance.fileId===P.instance.fileId)return console.error("duplicate prefabInstance node has the same fileId"),!1;if(e.unlinkPrefab(f.uuid,!1),e.unlinkPrefab(m.uuid,!1),await e.saveScene(),await e.closeScene(),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;if(r=d.children[0],o=r.uuid,f=r.children[1],m=r.children[2],f.uuid===m.uuid)return console.error("unWrap duplicate prefabInstance node has the same uuid"),!1;if(w=getPrefabInfo(f),P=getPrefabInfo(m),w&&P&&w.fileId===P.fileId)return console.error("unWrap duplicate prefabInstance node has the same fileId"),!1;await c(n),f=r.children[1],m=r.children[2],e.removeNode({uuid:f.uuid}),e.removeNode({uuid:m.uuid});e.createNode({parent:o,type:"cc.Prefab",assetUuid:u});await new Promise(e=>{setTimeout(function(){e()},500)}),h=(f=r.children[1]).children[0],e.setNodeProperty({uuid:h.uuid,path:"__comps__.0.shadowCastingMode",dump:{type:"Enum",value:1}}),await e.saveScene(),await e.closeScene(),await c(n);const N=(h=(f=r.children[1]).children[0]).getComponent(cc_1.MeshRenderer);return 1!==(null===N||void 0===N?void 0:N.shadowCastingMode)?(console.error("component value in nested prefab not saved correctly"),!1):(await e.saveScene(),await e.closeScene(),(d=cc_1.director.getScene())?(a=(r=null===d||void 0===d?void 0:d.children[0]).uuid,e.removeNode({uuid:a}),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),!0):(console.error("scene is null"),!1))}}const nestedPrefabTest=new NestedPrefabTest;exports.nestedPrefabTest=nestedPrefabTest;