"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetOverrideTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc"),common_1=require("./common"),testPrefabAssetUrl="db://assets/Root.prefab",childPrefabAssetUrl="db://assets/childNode.prefab",testRefClassName="TestPrefabRef",testRefCompUrl="db://assets/__testRef__.ts",testRefCompContent=` \n    import { _decorator, Component, Node } from 'cc';\n    const { ccclass, property, type } = _decorator;\n\n    @ccclass('${testRefClassName}')\n    export class TestRef extends Component {\n        @type(Node)\n        public refNode: Node|null = null;\n        \n        @type(Component)\n        public refComp: Component|null = null;\n\n        start () {\n        }\n    }\n`;let testRefScriptURL=null;class TargetOverrideTest{async test(e){var t;console.log("targetOverrideTest-----------"),await e.openScene("");let o=await e.createNode({name:"Root"});if(!o)return(0,common_1.returnFalseWithLog)("tetsNodeUUID is null");const r=await e.createPrefab(o,testPrefabAssetUrl);if(!r)return(0,common_1.returnFalseWithLog)("testPrefabAssetUUID is null");if(await new Promise(e=>{setTimeout(function(){e()},1200)}),!(o=(await e.queryNodesByAssetUuid(r))[0]))return(0,common_1.returnFalseWithLog)("testNodeUUID is null");let n=node_1.default.query(o);if(!n)return(0,common_1.returnFalseWithLog)("can't find rootNode");let a=(0,common_1.getPrefabInfo)(n);if(!(null===a||void 0===a?void 0:a.fileId))return!1;const s=null===(t=a.instance)||void 0===t?void 0:t.propertyOverrides;if(!s||4!==s.length)return(0,common_1.returnFalseWithLog)("property overrides doesn't match");await e.openScene(r);const i=await Editor.Message.request("asset-db","create-asset",testRefCompUrl,testRefCompContent,{overwrite:!0});if(!i)return(0,common_1.returnFalseWithLog)("assetInfo is null");if(testRefScriptURL=i.url,await new Promise(e=>{setTimeout(function(){e()},2e3)}),!cc.js.getClassByName(testRefClassName))return(0,common_1.returnFalseWithLog)(`创建${testRefClassName}失败,请确保脚本创建后有触发编译`);let d=cc_1.director.getScene();if(!d)return(0,common_1.returnFalseWithLog)("scene is null");let u=(n=d.getChildByName("Root")).uuid;await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:u});let c=await e.createNode({name:"childNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde",parent:u}),l=await e.createNode({name:"testOutRef",parent:c});await e.createComponent({uuid:l,component:testRefClassName});let m=await e.createNode({name:"testInRef",parent:c});await e.createComponent({uuid:m,component:testRefClassName});const f=await e.createPrefab(c,childPrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(f),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");u=(n=d.children[0]).uuid;let p=node_1.default.query(u);if(l=p.children[0].uuid,m=p.children[1].uuid,await e.setNodeProperty({uuid:m,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:u}}}),node_1.default.query(m).getComponent(testRefClassName).refNode=n,await e.saveScene(),await e.openScene(r),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");u=(n=d.getChildByName("Root")).uuid;const g=await e.createNode({name:"childNode2",assetUuid:f,parent:u,type:"cc.Prefab"});let _=node_1.default.query(g),N=_.children[0];e.createComponent({uuid:u,component:testRefClassName}),await e.setNodeProperty({uuid:u,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:N.uuid}}});let h=(p=node_1.default.query(u)).children[1],C=h.children[0];if(await e.setNodeProperty({uuid:C.uuid,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:N.uuid}}}),!(a=(0,common_1.getPrefabInfo)(n))||!a.targetOverrides||2!==a.targetOverrides.length)return(0,common_1.returnFalseWithLog)("wrong targetOverrides in prefabInfo");if(a.targetOverrides[0].target!==_||a.targetOverrides[1].target!==_)return(0,common_1.returnFalseWithLog)("wrong target in targetOverride");if(console.log("override in prefab mode:",a.targetOverrides[0].targetInfo),await e.saveScene(),await e.closeScene(),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");u=(n=d.getChildByName("Root")).uuid;const w=await e.createNode({name:"mountedNode",parent:u});e.createComponent({uuid:w,component:testRefClassName});const R=node_1.default.query(w);N=(_=n.getChildByName("childNode2")).getChildByName("testOutRef"),await e.setNodeProperty({uuid:w,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:N.uuid}}}),await e.setNodeProperty({uuid:w,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:_.components[0].uuid}}});let v=(0,common_1.getPrefabInfo)(d);if(!v||!v.targetOverrides||v.targetOverrides.length<0)return(0,common_1.returnFalseWithLog)("no targetOverrides in scene prefabInfo");if(console.log(v),v.targetOverrides[0].source!==R.getComponent(testRefClassName)||v.targetOverrides[0].target!==n)return(0,common_1.returnFalseWithLog)("wrong targetOverrides in scene prefabInfo");if(await e.softReloadScene(),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");u=(n=d.getChildByName("Root")).uuid,c=(h=n.children[1]).uuid,_=n.children[2];const y=n.children[3];if(l=(C=h.children[0]).uuid,N=_.children[0],C.getComponent(testRefClassName).refNode!==N)return(0,common_1.returnFalseWithLog)("wrong testOutRef in prefab");if(y.getComponent(testRefClassName).refNode!==N)return(0,common_1.returnFalseWithLog)("wrong testOutRef in scene");if(y.getComponent(testRefClassName).refComp!==_.components[0])return(0,common_1.returnFalseWithLog)("wrong testOutRef component in scene");if(e.createComponent({uuid:c,component:testRefClassName}),await e.setNodeProperty({uuid:c,path:"__comps__.1.refNode",dump:{type:"cc.Node",value:{uuid:l}}}),await e.softReloadScene(),!(d=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");if(!(h=(0,cc_1.find)("Root/childNode")))return(0,common_1.returnFalseWithLog)("can't find childNode");if(!(C=(0,cc_1.find)("Root/childNode/testOutRef")))return(0,common_1.returnFalseWithLog)("can't find testOutRefNode");if(h.getComponent(testRefClassName).refNode!==C)return(0,common_1.returnFalseWithLog)("wrong mountedComponent ref to prefab");u=(n=d.getChildByName("Root")).uuid,cce.Selection.clear();let b=await e.createNode({name:"normalNode"});e.createComponent({uuid:b,component:testRefClassName});let O=node_1.default.query(b);return N=(_=n.children[2]).children[0],await e.setNodeProperty({uuid:b,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:N.uuid}}}),await e.setNodeProperty({uuid:b,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:_.components[0].uuid}}}),!(v=(0,common_1.getPrefabInfo)(d))||!v.targetOverrides||v.targetOverrides.length<0?(0,common_1.returnFalseWithLog)("no targetOverrides in scene prefabInfo"):(console.log(v),v.targetOverrides[4].source!==O.getComponent(testRefClassName)||v.targetOverrides[4].target!==n?(0,common_1.returnFalseWithLog)("wrong targetOverrides in scene prefabInfo"):(await e.softReloadScene(),(d=cc_1.director.getScene())?(n=d.getChildByName("Root"),O=d.getChildByName("normalNode"),u=n.uuid,c=(h=n.children[1]).uuid,_=n.children[2],l=(C=h.children[0]).uuid,N=_.children[0],C.getComponent(testRefClassName).refNode!==N?(0,common_1.returnFalseWithLog)("wrong testOutRef in prefab"):O.getComponent(testRefClassName).refNode!==N?(0,common_1.returnFalseWithLog)("wrong testOutRef in scene"):O.getComponent(testRefClassName).refComp!==_.components[0]?(0,common_1.returnFalseWithLog)("wrong testOutRef component in scene"):(o=n.uuid,b=O.uuid,e.removeNode({uuid:o}),e.removeNode({uuid:b}),!0)):(0,common_1.returnFalseWithLog)("scene is null")))}async clear(){return cce.Selection.clear(),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",testRefCompUrl),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),!0}}const targetOverrideTest=new TargetOverrideTest;exports.targetOverrideTest=targetOverrideTest;