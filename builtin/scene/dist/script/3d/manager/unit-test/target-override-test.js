"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetOverrideTest=void 0;const unit_test_interface_1=require("./unit-test-interface"),node_1=__importDefault(require("../node")),cc_1=require("cc"),common_1=require("./common"),multi_scene_1=__importDefault(require("../multi-scene")),testPrefabAssetUrl=(0,unit_test_interface_1.getTestDir)()+"/Root.prefab",childPrefabAssetUrl=(0,unit_test_interface_1.getTestDir)()+"/childNode.prefab",testRefClassName="TestPrefabRef",testRefCompUrl=(0,unit_test_interface_1.getTestDir)()+"/__testRef__.ts",testRefCompContent=` 
    import { _decorator, Component, Node } from 'cc';
    const { ccclass, property, type } = _decorator;

    @ccclass('${testRefClassName}')
    export class TestRef extends Component {
        @type(Node)
        public refNode: Node|null = null;
        
        @type(Component)
        public refComp: Component|null = null;

        start () {
        }
    }
`;let testRefScriptURL=null;class TargetOverrideTest{async test(e){console.log("targetOverrideTest-----------"),await e.loadEmptyScene();var t=1e3,r=await e.createNode({name:"Root"});if(!r)return(0,common_1.returnFalseWithLog)("testsNodeUUID is null");var o=await e.createPrefab(r,testPrefabAssetUrl);if(!o)return(0,common_1.returnFalseWithLog)("testPrefabAssetUUID is null");if(await(0,unit_test_interface_1.delay)(t),!(r=(await e.queryNodesByAssetUuid(o))[0]))return(0,common_1.returnFalseWithLog)("testNodeUUID is null");let n=node_1.default.query(r);if(!n)return(0,common_1.returnFalseWithLog)("can't find rootNode");var a=(0,common_1.getPrefabInfo)(n);if(!a?.fileId)return!1;var i=a.instance?.propertyOverrides;if(!i||4!==i.length)return(0,common_1.returnFalseWithLog)("property overrides doesn't match");await e.openScene(o);i=await Editor.Message.request("asset-db","create-asset",testRefCompUrl,testRefCompContent,{overwrite:!0});if(!i)return(0,common_1.returnFalseWithLog)("assetInfo is null");if(testRefScriptURL=i.url,await(0,unit_test_interface_1.delay)(2e3),!cc.js.getClassByName(testRefClassName))return(0,common_1.returnFalseWithLog)(`创建${testRefClassName}失败,请确保脚本创建后有触发编译`);let s=cc_1.director.getScene();if(!s)return(0,common_1.returnFalseWithLog)("scene is null");var i=(n=s.getChildByName("Root")).uuid,u=(await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:i}),await e.createNode({name:"childNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde",parent:i})),c=await e.createNode({name:"testOutRef",parent:u}),d=(await e.createComponent({uuid:c,component:testRefClassName}),await e.createNode({name:"testInRef",parent:u})),l=(await e.createComponent({uuid:d,component:testRefClassName}),await e.createPrefab(u,childPrefabAssetUrl));if(await e.saveScene(),await(0,unit_test_interface_1.delay)(t),await e.openScene(l),multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.multiSceneClose(o,"prefab"),await(0,unit_test_interface_1.delay)(t),!(s=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");var i=(n=s.children[0]).uuid,m=node_1.default.query(i),d=(m.children[0].uuid,m.children[1].uuid);if(await e.setNodeProperty({uuid:d,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:i}}}),node_1.default.query(d).getComponent(testRefClassName).refNode=n,await e.saveScene(),await(0,unit_test_interface_1.delay)(t),await e.openScene(o),multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.multiSceneClose(l,"prefab"),await(0,unit_test_interface_1.delay)(t),!(s=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");i=(n=s.getChildByName("Root")).uuid;m=await e.createNode({name:"childNode2",assetUuid:l,parent:i,type:"cc.Prefab"});let f=node_1.default.query(m);d=f.children[0];e.createComponent({uuid:i,component:testRefClassName}),await e.setNodeProperty({uuid:i,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:d.uuid}}});let _=node_1.default.query(i).children[1],p=_.children[0];if(await e.setNodeProperty({uuid:p.uuid,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:d.uuid}}}),!(a=(0,common_1.getPrefabInfo)(n))||!a.targetOverrides||2!==a.targetOverrides.length)return(0,common_1.returnFalseWithLog)("wrong targetOverrides in prefabInfo");if(a.targetOverrides[0].target!==f||a.targetOverrides[1].target!==f)return(0,common_1.returnFalseWithLog)("wrong target in targetOverride");if(console.log("override in prefab mode:",a.targetOverrides[0].targetInfo),await e.saveScene(),await e.closeScene(),!(s=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");i=(n=s.getChildByName("Root")).uuid;o=await e.createNode({name:"mountedNode",parent:i}),e.createComponent({uuid:o,component:testRefClassName}),t=node_1.default.query(o),d=(f=n.getChildByName("childNode2")).getChildByName("testOutRef"),await e.setNodeProperty({uuid:o,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:d.uuid}}}),await e.setNodeProperty({uuid:o,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:f.components[0].uuid}}}),l=(0,common_1.getPrefabInfo)(s);if(!l||!l.targetOverrides||l.targetOverrides.length<0)return(0,common_1.returnFalseWithLog)("no targetOverrides in scene prefabInfo");if(console.log(l),l.targetOverrides[0].source!==t.getComponent(testRefClassName)||l.targetOverrides[0].target!==n)return(0,common_1.returnFalseWithLog)("wrong targetOverrides in scene prefabInfo");if(await e.softReloadScene(),!(s=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");(n=s.getChildByName("Root")).uuid,u=(_=n.children[1]).uuid,f=n.children[2];m=n.children[3];if(c=(p=_.children[0]).uuid,d=f.children[0],p.getComponent(testRefClassName).refNode!==d)return(0,common_1.returnFalseWithLog)("wrong testOutRef in prefab");if(m.getComponent(testRefClassName).refNode!==d)return(0,common_1.returnFalseWithLog)("wrong testOutRef in scene");if(m.getComponent(testRefClassName).refComp!==f.components[0])return(0,common_1.returnFalseWithLog)("wrong testOutRef component in scene");if(e.createComponent({uuid:u,component:testRefClassName}),await e.setNodeProperty({uuid:u,path:"__comps__.1.refNode",dump:{type:"cc.Node",value:{uuid:c}}}),await e.softReloadScene(),!(s=cc_1.director.getScene()))return(0,common_1.returnFalseWithLog)("scene is null");if(!(_=(0,cc_1.find)("Root/childNode")))return(0,common_1.returnFalseWithLog)("can't find childNode");if(!(p=(0,cc_1.find)("Root/childNode/testOutRef")))return(0,common_1.returnFalseWithLog)("can't find testOutRefNode");if(_.getComponent(testRefClassName).refNode!==p)return(0,common_1.returnFalseWithLog)("wrong mountedComponent ref to prefab");(n=s.getChildByName("Root")).uuid,cce.Selection.clear();a=await e.createNode({name:"normalNode"});e.createComponent({uuid:a,component:testRefClassName});let g=node_1.default.query(a);return d=(f=n.children[2]).children[0],await e.setNodeProperty({uuid:a,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:d.uuid}}}),await e.setNodeProperty({uuid:a,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:f.components[0].uuid}}}),!(l=(0,common_1.getPrefabInfo)(s))||!l.targetOverrides||l.targetOverrides.length<0?(0,common_1.returnFalseWithLog)("no targetOverrides in scene prefabInfo"):(console.log(l),l.targetOverrides[4].source!==g.getComponent(testRefClassName)||l.targetOverrides[4].target!==n?(0,common_1.returnFalseWithLog)("wrong targetOverrides in scene prefabInfo"):(await e.softReloadScene(),(s=cc_1.director.getScene())?(n=s.getChildByName("Root"),g=s.getChildByName("normalNode"),n.uuid,(_=n.children[1]).uuid,f=n.children[2],(p=_.children[0]).uuid,d=f.children[0],p.getComponent(testRefClassName).refNode!==d?(0,common_1.returnFalseWithLog)("wrong testOutRef in prefab"):g.getComponent(testRefClassName).refNode!==d?(0,common_1.returnFalseWithLog)("wrong testOutRef in scene"):g.getComponent(testRefClassName).refComp!==f.components[0]?(0,common_1.returnFalseWithLog)("wrong testOutRef component in scene"):(r=n.uuid,a=g.uuid,e.removeNode({uuid:r}),e.removeNode({uuid:a}),!0)):(0,common_1.returnFalseWithLog)("scene is null")))}async clear(){return cce.Selection.clear(),await(0,unit_test_interface_1.clearTestDir)(),!0}}const targetOverrideTest=new TargetOverrideTest;exports.targetOverrideTest=targetOverrideTest;