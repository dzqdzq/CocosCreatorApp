"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetOverrideTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc");function getPrefabInfo(e){return e._prefab}const testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",testRefClassName="TestPrefabRef",testRefCompUrl="db://assets/__testRef__.ts",testRefCompContent=` \n    import { _decorator, Component, Node } from 'cc';\n    const { ccclass, property, type } = _decorator;\n\n    @ccclass('${testRefClassName}')\n    export class TestRef extends Component {\n        @type(Node)\n        public refNode: Node|null = null;\n        \n        @type(Component)\n        public refComp: Component|null = null;\n\n        start () {\n        }\n    }\n`;let testRefScriptURL=null;class TargetOverrideTest{async test(e){var t;console.log("targetOverrideTest-----------");let r=await e.createNode({name:"Root"});if(!r)return!1;const o=await e.createPrefab(r,testPrefabAssetUrl);if(!o)return!1;await new Promise(e=>{setTimeout(function(){e()},1200)});let n=node_1.default.query(r),s=getPrefabInfo(n);if(!(null===s||void 0===s?void 0:s.fileId))return!1;const a=null===(t=s.instance)||void 0===t?void 0:t.propertyOverrides;if(!a||4!==a.length)return console.error("property overrides doesn't match"),!1;e.openScene(o),await new Promise(e=>{setTimeout(function(){e()},500)});const i=await Editor.Message.request("asset-db","create-asset",testRefCompUrl,testRefCompContent,{overwrite:!0});if(!i)return!1;testRefScriptURL=i.url,await new Promise(e=>{setTimeout(function(){e()},1500)});let d=cc_1.director.getScene();if(!d)return console.error("scene is null"),!1;let c=(n=d.children[0]).uuid;await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:c});let u=await e.createNode({name:"childNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde",parent:c}),l=await e.createNode({name:"testOutRef",parent:u});await e.createComponent({uuid:l,component:testRefClassName});let f=await e.createNode({name:"testInRef",parent:u});await e.createComponent({uuid:f,component:testRefClassName});const p=await e.createPrefab(u,childPrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(p),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;let m=node_1.default.query(c);if(l=m.children[0].uuid,f=m.children[1].uuid,await e.setNodeProperty({uuid:f,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:c}}}),node_1.default.query(f).getComponent(testRefClassName).refNode=n,await e.saveScene(),await e.openScene(o),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;const g=await e.createNode({name:"childNode2",assetUuid:p,parent:c,type:"cc.Prefab"});let N=node_1.default.query(g),_=N.children[0];e.createComponent({uuid:c,component:testRefClassName}),await e.setNodeProperty({uuid:c,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}});let w=(m=node_1.default.query(c)).children[1],C=w.children[0];if(await e.setNodeProperty({uuid:C.uuid,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}}),!(s=getPrefabInfo(n))||!s.targetOverrides||2!==s.targetOverrides.length)return console.error("wrong targetOverrides in prefabInfo"),!1;if(s.targetOverrides[0].target!==N||s.targetOverrides[1].target!==N)return console.error("wrong target in targetOverride"),!1;if(console.log("override in prefab mode:",s.targetOverrides[0].targetInfo),await e.saveScene(),await e.closeScene(),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;const h=await e.createNode({name:"mountedNode",parent:c});e.createComponent({uuid:h,component:testRefClassName});const v=node_1.default.query(h);_=(N=n.children[2]).children[0],await e.setNodeProperty({uuid:h,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}}),await e.setNodeProperty({uuid:h,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:N.components[0].uuid}}});let R=getPrefabInfo(d);if(!R||!R.targetOverrides||R.targetOverrides.length<0)return console.error("no targetOverrides in scene prefabInfo"),!1;if(console.log(R),R.targetOverrides[0].source!==v.getComponent(testRefClassName)||R.targetOverrides[0].target!==n)return console.error("wrong targetOverrides in scene prefabInfo"),!1;if(await e.softReloadScene(),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid,u=(w=n.children[1]).uuid,N=n.children[2];const b=n.children[3];if(l=(C=w.children[0]).uuid,_=N.children[0],C.getComponent(testRefClassName).refNode!==_)return console.error("wrong testOutRef in prefab"),!1;if(b.getComponent(testRefClassName).refNode!==_)return console.error("wrong testOutRef in scene"),!1;if(b.getComponent(testRefClassName).refComp!==N.components[0])return console.error("wrong testOutRef component in scene"),!1;if(e.createComponent({uuid:u,component:testRefClassName}),await e.setNodeProperty({uuid:u,path:"__comps__.1.refNode",dump:{type:"cc.Node",value:{uuid:l}}}),await e.softReloadScene(),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;if(!(w=cc_1.find("Root/childNode")))return console.error("can't find childNode"),!1;if(!(C=cc_1.find("Root/childNode/testOutRef")))return console.error("can't find testOutRefNode"),!1;if(w.getComponent(testRefClassName).refNode!==C)return console.error("wrong mountedComponent ref to prefab"),!1;c=(n=d.children[0]).uuid,cce.Selection.clear();let O=await e.createNode({name:"normalNode"});e.createComponent({uuid:O,component:testRefClassName});let y=node_1.default.query(O);return _=(N=n.children[2]).children[0],await e.setNodeProperty({uuid:O,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}}),await e.setNodeProperty({uuid:O,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:N.components[0].uuid}}}),!(R=getPrefabInfo(d))||!R.targetOverrides||R.targetOverrides.length<0?(console.error("no targetOverrides in scene prefabInfo"),!1):(console.log(R),R.targetOverrides[4].source!==y.getComponent(testRefClassName)||R.targetOverrides[4].target!==n?(console.error("wrong targetOverrides in scene prefabInfo"),!1):(await e.softReloadScene(),(d=cc_1.director.getScene())?(n=d.children[0],y=d.children[1],c=n.uuid,u=(w=n.children[1]).uuid,N=n.children[2],l=(C=w.children[0]).uuid,_=N.children[0],C.getComponent(testRefClassName).refNode!==_?(console.error("wrong testOutRef in prefab"),!1):y.getComponent(testRefClassName).refNode!==_?(console.error("wrong testOutRef in scene"),!1):y.getComponent(testRefClassName).refComp!==N.components[0]?(console.error("wrong testOutRef component in scene"),!1):(r=n.uuid,O=y.uuid,e.removeNode({uuid:r}),e.removeNode({uuid:O}),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",testRefScriptURL),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),!0)):(console.error("scene is null"),!1)))}}const targetOverrideTest=new TargetOverrideTest;exports.targetOverrideTest=targetOverrideTest;