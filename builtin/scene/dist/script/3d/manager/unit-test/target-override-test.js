"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetOverrideTest=void 0;const node_1=__importDefault(require("../node")),cc_1=require("cc");function getPrefabInfo(e){return e._prefab}const testPrefabAssetUrl="db://assets/testPrefab.prefab",childPrefabAssetUrl="db://assets/childPrefab.prefab",testRefClassName="TestPrefabRef",testRefCompUrl="db://assets/__testRef__.ts",testRefCompContent=` \n    import { _decorator, Component, Node } from 'cc';\n    const { ccclass, property, type } = _decorator;\n\n    @ccclass('${testRefClassName}')\n    export class TestRef extends Component {\n        @type(Node)\n        public refNode: Node|null = null;\n        \n        @type(Component)\n        public refComp: Component|null = null;\n\n        start () {\n        }\n    }\n`;let testRefScriptURL=null;class TargetOverrideTest{async test(e){var t;console.log("targetOverrideTest-----------");const r=await e.createNode({name:"testPrefabRootNode"});if(!r)return!1;const o=await e.createPrefab(r,testPrefabAssetUrl);if(!o)return!1;await new Promise(e=>{setTimeout(function(){e()},1200)});let n=node_1.default.query(r),a=getPrefabInfo(n);if(!(null===a||void 0===a?void 0:a.fileId))return!1;const s=null===(t=a.instance)||void 0===t?void 0:t.propertyOverrides;if(!s||3!==s.length)return console.error("property overrides doesn't match"),!1;e.openScene(o),await new Promise(e=>{setTimeout(function(){e()},500)});const i=await Editor.Message.request("asset-db","create-asset",testRefCompUrl,testRefCompContent,{overwrite:!0});if(!i)return!1;testRefScriptURL=i.url,await new Promise(e=>{setTimeout(function(){e()},1500)});let d=cc_1.director.getScene();if(!d)return console.error("scene is null"),!1;let c=(n=d.children[0]).uuid,u=(await e.createNode({name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:c}),await e.createNode({name:"childNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde",parent:c})),l=await e.createNode({name:"testOutRef",parent:u});await e.createComponent({uuid:l,component:testRefClassName});let f=await e.createNode({name:"testInRef",parent:u});await e.createComponent({uuid:f,component:testRefClassName});let p=await e.createPrefab(u,childPrefabAssetUrl);if(await new Promise(e=>{setTimeout(function(){e()},1200)}),await e.saveScene(),await e.openScene(p),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;let m=node_1.default.query(c);if(l=m.children[0].uuid,f=m.children[1].uuid,await e.setNodeProperty({uuid:f,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:c}}}),node_1.default.query(f).getComponent(testRefClassName).refNode=n,await e.saveScene(),await e.openScene(o),await new Promise(e=>{setTimeout(function(){e()},500)}),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;let g=await e.createNode({name:"childNode2",assetUuid:p,parent:c,type:"cc.Prefab"}),w=node_1.default.query(g),_=w.children[0],N=(m=node_1.default.query(c)).children[1],b=N.children[0];if(await e.setNodeProperty({uuid:b.uuid,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}}),!(a=getPrefabInfo(n))||!a.targetOverrides||a.targetOverrides.length<=0)return console.error("wrong targetOverrides in prefabInfo"),!1;if(a.targetOverrides[0].target!==w)return console.error("wrong target in targetOverride"),!1;if(console.log("override in prefab mode:",a.targetOverrides[0].targetInfo),await e.saveScene(),await e.closeScene(),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid;let v=await e.createNode({name:"normalNode",parent:c});await e.createComponent({uuid:v,component:testRefClassName});let h=node_1.default.query(v);_=(w=n.children[2]).children[0],await e.setNodeProperty({uuid:v,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:_.uuid}}}),await e.setNodeProperty({uuid:v,path:"__comps__.0.refComp",dump:{type:"cc.Component",value:{uuid:w.components[0].uuid}}});let C=getPrefabInfo(d);if(!C||!C.targetOverrides||C.targetOverrides.length<0)return console.error("no targetOverrides in scene prefabInfo"),!1;if(console.log(C),C.targetOverrides[0].source!==h.getComponent(testRefClassName)||C.targetOverrides[0].target!==n)return console.error("wrong targetOverrides in scene prefabInfo"),!1;if(await e.softReloadScene(),!(d=cc_1.director.getScene()))return console.error("scene is null"),!1;c=(n=d.children[0]).uuid,N=n.children[1],w=n.children[2];const R=n.children[3];return b=N.children[0],_=w.children[0],b.getComponent(testRefClassName).refNode!==_?(console.error("wrong testOutRef in prefab"),!1):R.getComponent(testRefClassName).refNode!==_?(console.error("wrong testOutRef in scene"),!1):R.getComponent(testRefClassName).refComp!==w.components[0]?(console.error("wrong testOutRef component in scene"),!1):(e.removeNode({uuid:r}),await Editor.Message.request("asset-db","delete-asset",testPrefabAssetUrl),await Editor.Message.request("asset-db","delete-asset",testRefScriptURL),await Editor.Message.request("asset-db","delete-asset",childPrefabAssetUrl),!0)}}const targetOverrideTest=new TargetOverrideTest;exports.targetOverrideTest=targetOverrideTest;