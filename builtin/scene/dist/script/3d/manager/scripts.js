"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),ipc_1=__importDefault(require("./ipc")),executor_1=require("@editor/lib-programming/dist/executor"),editor_1=require("editor"),cc_1=require("cc"),events_1=require("events"),loader_1=require("@cocos/creator-programming-quick-pack/lib/loader"),sort_plugin_scripts_1=require("@editor/lib-programming/dist/executor/sort-plugin-scripts"),url_1=require("url"),remote_1=require("@electron/remote"),remoteEditor=remote_1.getGlobal("Editor");class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}const importExceptionLogTag="::SceneExecutorImportExceptionHandler::",importExceptionLogRegex=new RegExp(importExceptionLogTag);class ScriptManager extends events_1.EventEmitter{constructor(){super(),this.EXECUTION_FINISHED="execution-finished",this._suspendPromise=null,this._asyncIteration=new AsyncIterationConcurrency1(()=>this._execute())}suspend(e){this._suspendPromise=e}async init(){const e=require("cc");EditorExtends.on("class-registered",(t,r,i)=>{r&&e.js.isChildClassOf(t,cc_1.Component)&&EditorExtends.Component.addMenu(t,"i18n:menu.custom_script/"+i,-1)});const t=await Editor.Message.request("programming","packer-driver/get-loader-context","editor"),r=await loader_1.QuickPackLoaderContext.deserialize(t),{default:i}=await Promise.resolve().then(()=>__importStar(require("cc/mods-mgr")));var o;this._executor=await executor_1.Executor.create({importEngineMod:e=>i.syncImport(e),quickPackLoaderContext:r,beforeUnregisterClass:e=>{EditorExtends.Component.removeMenu(e)},logger:{loadException:(e,t,r)=>{},possibleCircularReference:(e,t,r,i)=>{var s;console.warn(editor_1.I18n.t("scene.scripting.crReport",{source:t,imported:e,importer:(o=r.url,o.startsWith("project:///")?`{asset(db://${o.substr("project:///".length).replace(".js",".ts")})}`:o)}),null===(s=null===i||void 0===i?void 0:i.error)||void 0===s?void 0:s.stack)}},importExceptionHandler:(...e)=>this._handleImportException(...e)}),this._executor.addPolyfillFile(require.resolve("@editor/build-polyfills/prebuilt/editor/bundle")),await this._loadPluginScripts(),await this._asyncIteration.nextIteration(),Editor.Module.setImportProjectModuleDelegate(async e=>{const t=await Editor.Message.request("asset-db","query-path",e);if(!t)throw new Error(`${e} is not a valid database URL.`);const r=url_1.pathToFileURL(t);return await this._executor.import(r.href)})}async investigatePackerDriver(){this._executeAsync()}async queryScriptName(e){const t=Editor.Utils.UUID.compressUUID(e,!1),r=this._executor.queryClassesInModule(t);if(!r)return null;const i=r.find(e=>cc_1.js.isChildClassOf(e,cc_1.Component));return i?cc_1.js.getClassName(i):null}async _loadScripts(){}async loadScript(e){}async removeScript(e){}async scriptChange(e){}_executeAsync(){cc.GAME_VIEW?!cce.GameView.eventNames().includes("stop_gameview")&&cce.GameView.once("stop_gameview",()=>{this._asyncIteration.nextIteration()}):this._asyncIteration.nextIteration()}_execute(){var e;return Promise.resolve(null!==(e=this._suspendPromise)&&void 0!==e?e:void 0).catch(e=>{console.error(e)}).finally(()=>(this._suspendPromise=null,remoteEditor.Logger.clear(importExceptionLogRegex),this._executor.reload().finally(()=>{this.emit(this.EXECUTION_FINISHED)})))}async _loadPluginScripts(){const e=await ipc_1.default.send("query-scripts"),t=[],r={};await Promise.all(e.map(async e=>{const i=await ipc_1.default.send("query-asset-meta",e.uuid);if(!i.userData.isPlugin||!i.userData.loadPluginInEditor)return;const o=e.library[".js"];o?(t.push([e.uuid,sort_plugin_scripts_1.getPluginScriptDependencies(i.userData)]),r[e.uuid]={file:o,source:e.source}):console.warn(`Plugin Script ${e.source} is not successfully imported, it will not be load therefor.`)}));const i=sort_plugin_scripts_1.sortPluginScripts(t);for(const e of i)try{console.debug(`Loading plugin script ${r[e].source}`),require(r[e].file)}catch(e){console.error(e)}}_handleImportException(e){console.error(`{hidden(${importExceptionLogTag})}`,e)}}exports.default=new ScriptManager;