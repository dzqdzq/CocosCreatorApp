"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),ipc_1=__importDefault(require("./ipc")),executor_1=require("@editor/lib-programming/dist/executor"),editor_1=require("editor"),cc_1=require("cc"),events_1=require("events"),loader_1=require("@editor/lib-programming/dist/mod-assembling/quick-pack/loader");class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}class ScriptManager extends events_1.EventEmitter{constructor(){super(),this.EXECUTION_FINISHED="execution-finished",this._suspendPromise=null,this._asyncIteration=new AsyncIterationConcurrency1(()=>this._execute())}suspend(e){this._suspendPromise=e}async init(){const e=require("cc");EditorExtends.on("class-registered",(t,i,r)=>{i&&e.js.isChildClassOf(t,cc_1.Component)&&EditorExtends.Component.addMenu(t,"i18n:menu.custom_script/"+r,-1)});const t=await Editor.Message.request("programming","packer-driver/get-loader-context","editor"),i=await loader_1.QuickPackLoaderContext.deserialize(t),{default:r}=await Promise.resolve().then(()=>__importStar(require("cc/mods-mgr")));var s;this._executor=await executor_1.Executor.create({importEngineMod:e=>r.syncImport(e),quickPackLoaderContext:i,beforeUnregisterClass:e=>{EditorExtends.Component.removeMenu(e)},logger:{loadException:(e,t,i)=>{},possibleCircularReference:(e,t,i,r)=>{var n;console.warn(editor_1.I18n.t("scene.scripting.crReport",{source:t,imported:e,importer:(s=i.url,s.startsWith("project:///")?`{asset(db://${s.substr("project:///".length).replace(".js",".ts")})}`:s)}),null===(n=null===r||void 0===r?void 0:r.error)||void 0===n?void 0:n.stack)}}}),this._executor.addPolyfillFile(require.resolve("@editor/build-polyfills/prebuilt/editor/bundle")),await this._loadPluginScripts(),await this._asyncIteration.nextIteration()}async investigatePackerDriver(){this._executeAsync()}async queryScriptName(e){const t=EditorExtends.UuidUtils.compressUuid(e),i=this._executor.queryClassesInModule(t);if(!i)return null;const r=i.find(e=>cc_1.js.isChildClassOf(e,cc_1.Component));return r?cc_1.js.getClassName(r):null}async _loadScripts(){}async loadScript(e){}async removeScript(e){}async scriptChange(e){}_executeAsync(){cc.GAME_VIEW?!cce.GameView.eventNames().includes("stop_gameview")&&cce.GameView.once("stop_gameview",()=>{this._asyncIteration.nextIteration()}):this._asyncIteration.nextIteration()}_execute(){var e;return Promise.resolve(null!==(e=this._suspendPromise)&&void 0!==e?e:void 0).catch(e=>{console.error(e)}).finally(()=>(this._suspendPromise=null,this._executor.reload().finally(()=>{this.emit(this.EXECUTION_FINISHED)})))}async _loadPluginScripts(){const e=await ipc_1.default.send("query-scripts");await Promise.all(e.map(async e=>{const t=await ipc_1.default.send("query-asset-meta",e.uuid);if(!t.userData.importAsPlugin&&!t.userData.isPlugin||!t.userData.loadPluginInEditor)return;const i=e.library[".js"];i?(console.debug(`Loading plugin script ${e.source}`),require(i)):console.warn(`Plugin Script ${e.source} is not successfully imported, it will not be load therefor.`)}))}}exports.default=new ScriptManager;