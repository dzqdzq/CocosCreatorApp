"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,o)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScriptManager=void 0,module.paths.push(AppModulePath);const executor_1=require("@editor/lib-programming/dist/executor"),cc_1=require("cc"),events_1=require("events"),loader_1=require("@cocos/creator-programming-quick-pack/lib/loader"),sort_plugin_scripts_1=require("@editor/lib-programming/dist/executor/sort-plugin-scripts"),url_1=require("url"),remote_1=require("@electron/remote"),remoteEditor=(0,remote_1.getGlobal)("Editor");class AsyncIterationConcurrency1{constructor(e){this._executionPromise=null,this._pendingPromise=null,this._iterate=e}nextIteration(){return this._executionPromise?this._pendingPromise?this._pendingPromise:this._pendingPromise=this._executionPromise.finally(()=>(this._pendingPromise=null,this.nextIteration())):this._executionPromise=Promise.resolve(this._iterate()).finally(()=>{this._executionPromise=null})}}const importExceptionLogTag="::SceneExecutorImportExceptionHandler::",importExceptionLogRegex=new RegExp(importExceptionLogTag);class GlobalEnv{constructor(){this._incrementalKeys=new Set}async record(e){const t=Object.keys(globalThis);await e();const r=Object.keys(globalThis);for(const e of r)t.includes(e)||this._incrementalKeys.add(e);console.debug(`Incremental keys: ${Array.from(this._incrementalKeys)}`)}clear(){for(const e of this._incrementalKeys)delete globalThis[e]}}const globalEnv=new GlobalEnv;class ScriptManager extends events_1.EventEmitter{constructor(){super(),this.EXECUTION_FINISHED="execution-finished",this._suspendPromise=null,this._asyncIteration=new AsyncIterationConcurrency1(()=>this._execute())}suspend(e){this._suspendPromise=e}async init(){const e=require("cc");EditorExtends.on("class-registered",(t,r,i)=>{r&&e.js.isChildClassOf(t,cc_1.Component)&&EditorExtends.Component.addMenu(t,"i18n:menu.custom_script/"+i,-1)});const t=await Editor.Message.request("programming","packer-driver/get-loader-context","editor"),r=await loader_1.QuickPackLoaderContext.deserialize(t),{loadDynamic:i}=await Promise.resolve().then(()=>__importStar(require("cc/preload"))),o=await Editor.Message.request("programming","packer-driver/query-cc-editor-module-map");var s;this._executor=await executor_1.Executor.create({importEngineMod:async e=>await i(e),quickPackLoaderContext:r,beforeUnregisterClass:e=>{EditorExtends.Component.removeMenu(e)},logger:{loadException:(e,t,r)=>{},possibleCircularReference:(e,t,r,i)=>{var o;console.warn(Editor.I18n.t("scene.scripting.crReport",{source:t,imported:e,importer:(s=r.url,s.startsWith("project:///")?`{asset(db://${s.substr("project:///".length).replace(".js",".ts")})}`:s)}),null===(o=null===i||void 0===i?void 0:i.error)||void 0===o?void 0:o.stack)}},importExceptionHandler:(...e)=>this._handleImportException(...e),cceModuleMap:o}),this._executor.addPolyfillFile(require.resolve("@editor/build-polyfills/prebuilt/editor/bundle")),await this._loadPluginScripts(),await this._asyncIteration.nextIteration(),Editor.Module.__protected__.setImportProjectModuleDelegate(async e=>{const t=await Editor.Message.request("asset-db","query-path",e);if(!t)throw new Error(`${e} is not a valid database URL.`);const r=(0,url_1.pathToFileURL)(t);return await this._executor.import(r.href)})}async investigatePackerDriver(){this._executeAsync()}async queryScriptName(e){const t=Editor.Utils.UUID.compressUUID(e,!1),r=this._executor.queryClassesInModule(t);if(!r)return null;const i=r.find(e=>cc_1.js.isChildClassOf(e,cc_1.Component));return i?cc_1.js.getClassName(i):null}async queryScriptCid(e){const t=Editor.Utils.UUID.compressUUID(e,!1),r=this._executor.queryClassesInModule(t);if(!r)return null;const i=r.find(e=>cc_1.js.isChildClassOf(e,cc_1.Component));return i?cc_1.js.getClassId(i):null}async _loadScripts(){}async loadScript(e){}async removeScript(e){}async scriptChange(e){}_executeAsync(){this._asyncIteration.nextIteration()}_execute(){var e;return Promise.resolve(null!==(e=this._suspendPromise)&&void 0!==e?e:void 0).catch(e=>{console.error(e)}).finally(()=>(this._suspendPromise=null,remoteEditor.Logger.clear(importExceptionLogRegex),globalEnv.clear(),globalEnv.record(()=>this._executor.reload().finally(()=>{this.emit(this.EXECUTION_FINISHED)}))))}async _loadPluginScripts(){let e=[],t={};const r=await Editor.Message.request("asset-db","execute-script",{name:"scene",method:"queryPluginScripts"});e=r.pluginScriptDependencyMap,t=r.scriptFileMap;const i=(0,sort_plugin_scripts_1.sortPluginScripts)(e);for(const e of i)try{console.debug(`Loading plugin script ${t[e].source}`),Editor.Module.__protected__.requireFile(t[e].file)}catch(e){console.error(e)}}_handleImportException(e){console.error(`{hidden(${importExceptionLogTag})}`,e)}}exports.ScriptManager=ScriptManager,exports.default=new ScriptManager;