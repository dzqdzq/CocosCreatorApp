"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const sharp_1=__importDefault(require("sharp")),cc_1=require("cc"),component_1=__importDefault(require("../component")),marching_squares_1=__importDefault(require("./marching-squares")),node_1=__importDefault(require("../node"));function getNodeRectPoints(e,t){if(!e||0===e.width&&0===e.height)return t&&t(null,[new cc_1.Vec2(-50,-50),new cc_1.Vec2(50,-50),new cc_1.Vec2(50,50),new cc_1.Vec2(-50,50)]);const o=-e.anchorX*e.width,n=-e.anchorY*e.height,r=o+e.width,c=n+e.height;t&&t(null,[new cc_1.Vec2(o,n),new cc_1.Vec2(o,c),new cc_1.Vec2(r,c),new cc_1.Vec2(r,n)])}class Physics2DManager{async getContourPoints(e,t={threshold:1,loop:!0},o){const n=e.getComponent(cc_1.UITransform);if(!n)return getNodeRectPoints(n,o);const r=e.getComponent(cc_1.SpriteComponent);if(!r)return getNodeRectPoints(n,o);const c=r.spriteFrame;if(!c)return getNodeRectPoints(n,o);const i=c._uuid.split("@")[0],s=await Editor.Message.request("asset-db","query-path",i);if(!s)return getNodeRectPoints(n,o);const h=require("./rdp"),a=c.getRect();let u=a.width,d=a.height;const l=c.isRotated();l&&(u=a.height,d=a.width),sharp_1.default(s).extract({left:a.x,top:a.y,width:u,height:d}).rotate(l?90:0).raw().toBuffer((e,r)=>{if(e)return o&&o(e);let c=marching_squares_1.default.getBlobOutlinePoints(r,a.width,a.height,t.loop);(c=h(c,t.threshold)).length>0&&c[0].equals(c[c.length-1])&&(c.length-=1),c.forEach(e=>{e.y=a.height-e.y,e.x*=n.width/a.width,e.y*=n.height/a.height,e.x-=n.anchorX*n.width,e.y-=n.anchorY*n.height}),cc_1.Physics2DUtils.PolygonSeparator.ForceCounterClockWise(c),o&&o(null,c)})}resetPoints(e){this.getContourPoints(e.node,{threshold:e.threshold,loop:!0},(t,o)=>{if(t)return console.error(t);cce.SceneFacadeManager.snapshot(),e.points=o,node_1.default.emit("change",e.node),Editor.Message.broadcast("scene:change-node",e.node.uuid)})}resetPointsByUuid(e){const t=component_1.default.query(e);this.resetPoints(t)}}exports.default=new Physics2DManager;