"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Physics2DManager=void 0;const sharp_1=__importDefault(require("sharp")),cc_1=require("cc"),component_1=__importDefault(require("../component")),marching_squares_1=__importDefault(require("./marching-squares")),node_1=__importDefault(require("../node"));function getNodeRectPoints(e,t){if(!e||0===e.width&&0===e.height)return t&&t(null,[new cc_1.Vec2(-50,-50),new cc_1.Vec2(50,-50),new cc_1.Vec2(50,50),new cc_1.Vec2(-50,50)]);const o=-e.anchorX*e.width,r=-e.anchorY*e.height,n=o+e.width,i=r+e.height;t&&t(null,[new cc_1.Vec2(o,r),new cc_1.Vec2(o,i),new cc_1.Vec2(n,i),new cc_1.Vec2(n,r)])}class Physics2DManager{async getContourPoints(e,t={threshold:1,loop:!0},o){const r=e.getComponent(cc_1.UITransform);if(!r)return getNodeRectPoints(r,o);const n=e.getComponent(cc_1.SpriteComponent);if(!n)return getNodeRectPoints(r,o);const i=n.spriteFrame;if(!i)return getNodeRectPoints(r,o);const c=i._uuid.split("@")[0],s=await Editor.Message.request("asset-db","query-path",c);if(!s)return getNodeRectPoints(r,o);const h=require("./rdp"),a=i.getRect();let u=a.width,l=a.height;const d=i.isRotated();d&&(u=a.height,l=a.width),(0,sharp_1.default)(s).extract({left:a.x,top:a.y,width:u,height:l}).rotate(d?90:0).raw().toBuffer((e,n)=>{if(e)return o&&o(e);let i=marching_squares_1.default.getBlobOutlinePoints(n,a.width,a.height,t.loop);(i=h(i,t.threshold)).length>0&&i[0].equals(i[i.length-1])&&(i.length-=1),i.forEach(e=>{e.y=a.height-e.y,e.x*=r.width/a.width,e.y*=r.height/a.height,e.x-=r.anchorX*r.width,e.y-=r.anchorY*r.height}),cc_1.Physics2DUtils.PolygonSeparator.ForceCounterClockWise(i),o&&o(null,i)})}resetPoints(e){this.getContourPoints(e.node,{threshold:e.threshold,loop:!0},(t,o)=>{if(t)return console.error(t);e.points=o,cce.SceneFacadeManager.snapshot(),node_1.default.emit("change",e.node)})}resetPointsByUuid(e){const t=component_1.default.query(e);t?this.resetPoints(t):console.error(`Component with UUID ${e} does not exist!`)}}exports.Physics2DManager=Physics2DManager,exports.default=new Physics2DManager;