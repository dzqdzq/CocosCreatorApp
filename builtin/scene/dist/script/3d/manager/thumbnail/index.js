"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const mesh_thumbnail_generator_1=__importDefault(require("./mesh-thumbnail-generator")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path"));class ThumbnailManager{constructor(){this._generator=new Map,this._projectCacheMap=new Map}register(e,t){this._generator.has(e)?console.error("Thumbnail registed $type already"):this._generator.set(e,t)}unRegister(e){this._generator.has(e)&&this._generator.delete(e)}async uuidToPath(e,t=null){if(this._projectCacheMap.has(e)){return this._projectCacheMap.get(e)}t||(t=await Editor.Message.request("asset-db","query-asset-info",e));const s=t.url.match(/db:\/\/([^\/]*)/)[1];return path_1.default.join(Editor.Project.tmpDir,"asset-db",s,e.substr(0,2),e,e+".png")}async queryThumbnailSingle(e,t=""){if(""===t){const s=await Editor.Message.request("asset-db","query-asset-info",e);t=null===s||void 0===s?void 0:s.type}if(!this._generator.has(t))return"";const s=await this.uuidToPath(e);return fs_1.default.existsSync(s)?s:this._generator.get(t).getThumbnail(e,s)}async queryThumbnail(e,t=[]){return new Promise((s,a)=>{(async()=>{const a=[],r=t.length===e.length;let i=0,n=e.length;for(const o in e){const u=e[o];this.queryThumbnailSingle(u,r?t[o]:"").then(e=>{a[o]=e,++i===n&&s(a)}).catch(e=>{n-=1,a[o]="",console.debug("queryThumbnail fail",u,e),i===n&&s(a)})}})()})}async delete(e,t){if(this._generator.get(t.type)){const s=await this.uuidToPath(e,t);fs_1.default.existsSync(s)&&fs_1.default.rmSync(s),this._projectCacheMap.delete(e)}}init(){isPreviewProcess||(this.register("cc.Mesh",new mesh_thumbnail_generator_1.default),this.generateAll())}assetChange(e,t,s){this.queryThumbnailSingle(e,null===t||void 0===t?void 0:t.type).then(t=>{this._projectCacheMap.set(e,t)})}async assetDelete(e,t){t||(t=await Editor.Message.request("asset-db","query-asset-info",e)),this.delete(e,t)}async generateAll(){const e=[],t=[],s=this,a=function(r){s._generator.has(r.type)&&(e.push(r.uuid),t.push(r.type)),r.subAssets&&Object.keys(r.subAssets).forEach(async e=>{a(r.subAssets[e])})};(await Editor.Message.request("asset-db","query-assets",{importer:"gltf-mesh"})).forEach(e=>{a(e)}),console.time("Thumbnail Generate Cost Time"),this.queryThumbnail(e,t).then(t=>{for(let s=0;s<e.length;s++){const a=e[s];this._projectCacheMap.set(a,t[s])}console.timeEnd("Thumbnail Generate Cost Time")})}}exports.default=new ThumbnailManager;