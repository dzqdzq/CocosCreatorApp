"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const thumbnail_generator_interface_1=require("./thumbnail-generator-interface"),cc_1=require("cc"),vec3_1=require("../../../utils/math/vec3"),util_1=require("util"),node_1=__importDefault(require("../../../utils/node")),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),sharp_1=__importDefault(require("sharp")),buffer_1=__importDefault(require("../preview/buffer")),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3;function calcModelInfo(e){const t={vertices:0,polygons:0,uvs:[]};let i=0,s=0;const r=[];if(e){const o=e.getComponent(cc_1.MeshRenderer);if(o&&o.mesh){for(const e of o.mesh.struct.primitives){const t=o.mesh.struct.vertexBundles[e.vertexBundelIndices[0]].view.count;0!==e.vertexBundelIndices.length&&(i+=t);const r=e.indexView?e.indexView.count:t;switch(e.primitiveMode){case cc_1.gfx.PrimitiveMode.TRIANGLE_LIST:s+=r/3;break;case cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP:case cc_1.gfx.PrimitiveMode.TRIANGLE_FAN:s+=r-2}}if(o.mesh.struct.vertexBundles){const e=o.mesh.struct.vertexBundles;for(const t of e)for(const e of t.attributes){const t=e.name;if(0===t.indexOf(cc_1.gfx.AttributeName.ATTR_TEX_COORD)){let e=0;const i=t.charAt(cc_1.gfx.AttributeName.ATTR_TEX_COORD.length);i&&(e=Number.parseInt(i)),r.includes(e)||r.push(e)}}}if(o.mesh.struct.minPosition){const e=o.mesh.struct.minPosition;t.minPosition={x:e.x,y:e.y,z:e.z}}if(o.mesh.struct.maxPosition){const e=o.mesh.struct.maxPosition;t.maxPosition={x:e.x,y:e.y,z:e.z}}}e.children.forEach(e=>{const t=calcModelInfo(e);i+=t.vertices,s+=t.polygons}),t.vertices=i,t.polygons=s,t.uvs=r}return t}class MeshPreview{constructor(){this._viewDist=0,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._modelInfo={vertices:0,polygons:0,uvs:[]},this.width=0,this.height=0}init(e,t){this.scene=new cc.Scene,this.cameraComp=new cc.Node("Mesh Thumbnail Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Mesh Thumbnail Light").addComponent(cc_1.DirectionalLight),this._modelNode=new cc_1.Node("Mesh Thumbnail Mesh"),this._modelNode.parent=this.scene,this._modelComp=this._modelNode.addComponent(cc_1.MeshRenderer),this._defaultMat=new cc_1.Material,this._defaultMat.initialize({effectName:"builtin-standard"}),this._modelComp.material=this._defaultMat,this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new buffer_1.default("scene:mesh-thumbnail","query-mesh-thumbnail-data",this.scene),this.width=e,this.height=t,this.previewBuffer.resize(e,t),this.camera.changeTargetWindow(this.previewBuffer.window),this.cameraComp.enabled=!1}async setMesh(e){if(!e)return void console.warn("invalid uuid");if(!this._modelNode)return void console.warn("invalid mode node");cc_1.assetManager.assets.remove(e);const t=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(e);this._modelComp.mesh=t,this._modelNode.parent=this.scene;for(let e=0;e<this._modelComp.mesh.struct.primitives.length;e++)this._modelComp.setMaterial(this._defaultMat,e);return this._modelInfo=calcModelInfo(this._modelNode),this.cameraComp.enabled=!0,this.perfectCameraView(),this._modelInfo}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=node_1.default.getBoundaryOfMeshNode(this._modelNode);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),i=this.cameraComp.fov,s=1.2*t/Math.tan(i/2*Math.PI/180),r=s-t,o=s+t;return r!==o&&(this.cameraComp.near=r,this.cameraComp.far=o),s}getModelInfo(){return this._modelInfo}async generateThumbnail(e,t){const i=await this.previewBuffer.getImageData(void 0,this.width,this.height);fs_1.default.mkdirSync(path_1.default.dirname(e),{recursive:!0});const s=(0,sharp_1.default)(i.buffer,{raw:{width:this.width,height:this.height,channels:4}});s.flip(),s.toFile(e,t)}}class MeshThumbnailGenerator extends thumbnail_generator_interface_1.BaseThumbnailGenerator{constructor(){super(),this._queueLock=!1,this._mesh=new MeshPreview,this._mesh.init(this.width,this.height),this._queue=[]}getThumbnail(e,t){return new Promise((i,s)=>{this._queue.push({uuid:e,path:t,resolve:i,reject:s}),this.step()})}step(){if(this._queueLock)return;const e=this._queue.shift();e&&(this._queueLock=!0,this.generate(e.uuid,e.path).then(()=>{e.resolve(e.path)}).catch(t=>{e.reject(t)}).finally(()=>{setTimeout(()=>{this._queueLock=!1,this.step()})}))}async generate(e,t){return await this._mesh.setMesh(e),new Promise((e,i)=>{this._mesh.generateThumbnail(t,(t,s)=>{t?i(t):e(s)})})}}exports.default=MeshThumbnailGenerator;