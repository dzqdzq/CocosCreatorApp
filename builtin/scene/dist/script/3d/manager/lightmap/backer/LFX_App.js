"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LFX_App=void 0;const cc_1=require("cc"),cc_2=require("cc"),child_process_1=__importDefault(require("child_process")),fs_1=__importDefault(require("fs")),LFX_Baker_1=require("./LFX_Baker"),LFX_Types_1=require("./LFX_Types"),utils_1=require("../../../../utils/math/utils"),path_1=require("path"),Editor=require("editor"),portFinder=require("./Port");let filesList;async function readImageList(e,t=!1,i=null){t||(filesList={});const s=fs_1.default.readdirSync(e);return await Editor.Message.request("asset-db","refresh-asset",e),await Promise.all(s.map(async t=>{const i=e+t,s=fs_1.default.statSync(i);if(s.isDirectory())await readImageList(i+"/",!0);else if(t.endsWith(".png")){const r={};r.path=e,r.filename=t,r.size=parseInt(`${s.size/1e3}`)+"KB";const n=await Editor.Message.request("asset-db","query-url",i)||"";r.uuid=await Editor.Message.request("asset-db","query-uuid",n),filesList[`${r.filename}`]=r,await new Promise((e,t)=>{cc_2.assetManager.loadAny(r.uuid+"@6c48a",(i,s)=>{i?t(i):(r.texture=s,e())})})}})),i&&i(filesList),filesList}class LFX_App{constructor(){this.Baker=new LFX_Baker_1.LFX_Baker,this.Scene=null,this.Models=[],this.Lights=[],this.Terrains=[],this.MainCamera=null,this._currentTicks=0,this._lastTicks=0,this._uploadPath="",this._process=null,this._timer=null}static Reset(e){const t=e.getComponent(cc_2.Terrain);if(null!=t&&t.enabled)for(let e=0;e<t.getBlocks().length;++e)t._updateLightmap(e,null,0,0,1,1);const i=e.getComponents(cc_2.MeshRenderer);for(const e of i)e._updateLightmap(null,0,0,1,1);const s=e.getComponents(cc_2.Light);for(const e of s)e.baked=!1;for(const t of e.children)t.active&&(1024&t._objFlags||this.Reset(t))}static DirtyBaked(e){const t=e.getComponents(cc_2.Light);for(const e of t)e.baked=!0;for(const t of e.children)t.active&&(1024&t._objFlags||this.DirtyBaked(t))}Init(e={}){this.Baker.World=new LFX_Types_1.LFX_World,this.Scene=null,this.Models=[],this.Lights=[],this.Terrains=[],this.MainCamera=null,this._currentTicks=0,this._lastTicks=0,this.Baker.World.Name=e.name||"Test",this.Baker.World.Settings.SkyRadiance=e.skyRadiance||[.5,.5,.5],this.Baker.World.Settings.MSAA=e.msaa||4,this.Baker.World.Settings.Size=e.size||1024,this.Baker.World.Settings.Gamma=e.gamma||2.2,this.Baker.World.Settings.GIScale=e.giScale||0,this.Baker.World.Settings.GISamples=e.giSamples||10,this.Baker.World.Settings.AOLevel=e.aoLevel||0,this.Baker.World.Settings.GIPathLength=e.giPathLength||4,this.Baker.World.Settings.Threads=e.threads||1,this._uploadPath=e.path||""}Index2Str(e){let t="";return e<1e3&&(t+="0"),e<100&&(t+="0"),e<10&&(t+="0"),t+=e}Cancel(){this._timer&&(clearInterval(this._timer),this.Baker.Stop(),this.Baker.Close(),this._timer=null,this.Baker.emit("cancel",!0),null!==this._process&&(this._process.kill("SIGKILL"),this._process=null))}async Bake(e){this.Scene=e,this._export(e);for(const e of this.Baker.World.Meshes)for(const t of e.MaterialBuffer){if(0===t.Texture.length)continue;const e=t.Texture;if(-1===e.search("@")){const i=await Editor.Message.request("asset-db","query-path",e);t.Texture=null!==i?i:""}else t.Texture=path_1.join(Editor.Project.path,"library",e.substr(0,2),e);0===t.Texture.length&&console.warn("query-path texture "+e+" failed")}if(null!=this.MainCamera){const e=this.MainCamera.camera.exposure;for(const t of this.Baker.World.Lights)t.Color[0]*=t.Illuminance*e,t.Color[1]*=t.Illuminance*e,t.Color[2]*=t.Illuminance*e}this.Baker.Upload(this._uploadPath),this._run()}async _export(e){this._exportImp(e)}_exportImp(e){e instanceof cc_1.Scene||this._exportNode(e);for(const t of e.children)t.active&&(1024&t._objFlags||this._exportImp(t))}_exportNode(e){const t=e.getComponent(cc_2.Terrain);null!=t&&t.enabled&&this._exportTerrain(t);const i=e.getComponents(cc_2.MeshRenderer);for(const e of i)e.enabled&&this._exportModel(e);const s=e.getComponents(cc_2.Light);for(const e of s)e.enabled&&this._exportLight(e);const r=e.getComponents(cc_1.Camera);for(const e of r)e.enabled&&this._exportCamera(e)}_exportTerrain(e){const t=new LFX_Types_1.LFX_Terrain;t.Position[0]=e.node.getWorldPosition().x,t.Position[1]=e.node.getWorldPosition().y,t.Position[2]=e.node.getWorldPosition().z,t.TileSize=e.info.tileSize,t.BlockCount[0]=e.info.blockCount[0],t.BlockCount[1]=e.info.blockCount[1],t.LightMapSize=e.info.lightMapSize,t.HeightField=e.getHeightField(),this.Baker.World.Terrains.push(t),this.Terrains.push(e)}_exportModel(e){const t=e.mesh;if(null==t)return!1;if(!e.lightmapSettings.bakeable&&!e.lightmapSettings.castShadow)return!1;const i=new LFX_Types_1.LFX_Mesh;i.CastShadow=e.lightmapSettings.castShadow,i.ReceiveShadow=e.lightmapSettings.receiveShadow,e.lightmapSettings.bakeable&&(i.LightMapSize=e.lightmapSettings.lightmapSize);const s=e.node.getWorldMatrix();for(let r=0;r<t.struct.primitives.length;++r){const n=t.readAttribute(r,cc_1.gfx.AttributeName.ATTR_POSITION),a=t.readAttribute(r,cc_1.gfx.AttributeName.ATTR_NORMAL),o=t.readAttribute(r,cc_1.gfx.AttributeName.ATTR_TEX_COORD),l=t.readAttribute(r,cc_1.gfx.AttributeName.ATTR_TEX_COORD1),c=t.readIndices(r);if(!n||!a||!c)return!1;if(n.length!==a.length)return!1;if(null!=o&&n.length/3!=o.length/2)return!1;if(null!=l&&n.length/3!=l.length/2)return!1;null==l&&(i.ReceiveShadow=!1);for(let e=0;e<n.length/3;++e){const t=new cc_1.Vec3;t.x=n[3*e+0],t.y=n[3*e+1],t.z=n[3*e+2],cc_1.Vec3.transformMat4(t,t,s);const r=new cc_1.Vec3;r.x=a[3*e+0],r.y=a[3*e+1],r.z=a[3*e+2],cc_1.Vec3.transformMat4Normal(r,r,s),r.normalize();const c=new LFX_Types_1.LFX_Vertex;c.Position[0]=t.x,c.Position[1]=t.y,c.Position[2]=t.z,c.Normal[0]=r.x,c.Normal[1]=r.y,c.Normal[2]=r.z,null!=o&&(c.UV[0]=o[2*e+0],c.UV[1]=o[2*e+1]),null!=l&&(c.LUV[0]=l[2*e+0],c.LUV[1]=l[2*e+1]),i.VertexBuffer.push(c)}for(let t=0;t<c.length/3;++t){const s=new LFX_Types_1.LFX_Triangle;c.length<256?(s.Index[0]=c[3*t+0],s.Index[1]=c[3*t+1],s.Index[2]=c[3*t+2]):(c.length,s.Index[0]=c[3*t+0],s.Index[1]=c[3*t+1],s.Index[2]=c[3*t+2]),e.materials.length>0?s.MaterialId=utils_1.clamp(r,0,e.materials.length-1):s.MaterialId=0,i.TriangleBuffer.push(s)}}if(e.materials.length>0){const t=cc.Texture2D.PixelFormat;for(let s=0;s<e.materials.length;++s){const r=new LFX_Types_1.LFX_Material;r.Diffuse[0]=1,r.Diffuse[1]=1,r.Diffuse[2]=1;const n=e.materials[s];if(null!==n){const e=n.getProperty("mainTexture",0);if(null!==e&&e.getPixelFormat()===t.RGBA8888){const t=e.mipmaps[0];null!==t&&(-1!==t._uuid.search("@")?r.Texture=t._uuid+t._native:r.Texture=t._uuid)}}i.MaterialBuffer.push(r)}}else{const e=new LFX_Types_1.LFX_Material;e.Diffuse[0]=1,e.Diffuse[1]=1,e.Diffuse[2]=1,i.MaterialBuffer.push(e)}this.Baker.World.Meshes.push(i),this.Models.push(e)}_exportLight(e){if(!e.staticSettings.bakeable)return;const t=new LFX_Types_1.LFX_Light;t.Type=LFX_Types_1.LFX_Light.DIRECTION,t.GIEnable=!1,t.CastShadow=e.staticSettings.castShadow,t.Position[0]=e.node.getWorldPosition().x,t.Position[1]=e.node.getWorldPosition().y,t.Position[2]=e.node.getWorldPosition().z;const i=new cc_1.Vec3(0,0,-1);cc_1.Vec3.transformQuat(i,i,e.node.getWorldRotation()),t.Direction[0]=i.x,t.Direction[1]=i.y,t.Direction[2]=i.z,t.Color[0]=e.color.x,t.Color[1]=e.color.y,t.Color[2]=e.color.z;if(e instanceof cc_2.DirectionalLight){const i=e;t.Type=LFX_Types_1.LFX_Light.DIRECTION,t.Illuminance=i.illuminance}else if(e instanceof cc_2.SphereLight){const i=e;t.Type=LFX_Types_1.LFX_Light.POINT,t.AttenStart=i.size,t.AttenEnd=i.range,t.AttenFallOff=1,t.Illuminance=1e4*i.luminance}else{if(!(e instanceof cc_2.SpotLight))return;{const i=e;t.Type=LFX_Types_1.LFX_Light.SPOT,t.AttenStart=i.size,t.AttenEnd=i.range,t.AttenFallOff=1,t.SpotInner=Math.cos(i.spotAngle/4*(Math.PI/180)),t.SpotOuter=Math.cos(i.spotAngle/2*(Math.PI/180)),t.SpotFallOff=1,t.Illuminance=1e4*i.luminance}}t.DirectScale=1,t.IndirectScale=1,this.Baker.World.Lights.push(t),this.Lights.push(e)}_exportCamera(e){null===this.MainCamera?this.MainCamera=e:"MainCamera"===e.node.name&&(this.MainCamera=e)}_run(){let e=!1,t=3e3;t=0,portFinder.getPort((e,i)=>{e?(t=-1,console.log("Configure port failed")):t=i}),this._timer=setInterval(()=>{if(e)if(this.Baker.closed)clearInterval(this._timer);else{if(this.Baker.Started){if(this.Baker.Finished){console.log("End");let e=null;try{e=this.Baker.Download()}catch(t){console.error("LightFX get result file failed."),e=null}if(null!==e)for(let t=0;t<e.MeshInfos.length;++t){const i=e.MeshInfos[t],s="Mesh "+i.Id+": Index("+i.Index+")  Offset("+i.Offset[0]+", "+i.Offset[1]+")  Scale("+i.Scale[0]+", "+i.Scale[1]+")";this.Baker.emit("log",s)}this.Baker.Stop(),clearInterval(this._timer),this.Baker.Close(),this._timer=null,this.Baker.emit("end",!0),null!==this._process&&(this._process.kill("SIGKILL"),this._process=null),null!=this.Scene&&LFX_App.DirtyBaked(this.Scene);for(const e of this.Terrains)e.lightMapSize>0&&e._resetLightmap(!0);null!==e&&readImageList(this._uploadPath+"/output/",!1,t=>{for(const i of e.TerrainInfos){const e=this.Terrains[i.Id],s=t["LFX_Terrain_"+this.Index2Str(i.Index)+".png"];if(s){if(null!==s.texture){const t=s.texture;e._updateLightmap(i.BlockId,t,i.Offset[0],i.Offset[1],i.Scale[0],i.Scale[1])}else e._updateLightmap(i.BlockId,null,i.Offset[0],i.Offset[1],i.Scale[0],i.Scale[1]);Editor.Message.broadcast("scene:change-node",e.node.uuid)}}for(const i of e.MeshInfos){const e=this.Models[i.Id],s=t["LFX_Mesh_"+this.Index2Str(i.Index)+".png"];if(s)if(null!==s.texture){const t=s.texture;e._updateLightmap(t,i.Offset[0],i.Offset[1],i.Scale[0],i.Scale[1]),e.node._dirtyFlags=1}else e._updateLightmap(null,i.Offset[0],i.Offset[1],i.Scale[0],i.Scale[1])}cce.Engine.repaintInEditMode()})}}else this.Baker.connected&&(this.Baker.Start(),this.Baker.client.on("Tick",e=>{this._lastTicks=this._currentTicks}));this._currentTicks+=100}else if(t>0){this.Baker.Launch(t);{const e="http://127.0.0.1:"+t,i=this.Baker.lfxpath+"/LightFX";console.log("Launching "+i),this._process=child_process_1.default.execFile(i,[e],{cwd:this._uploadPath},(e,t,i)=>{e&&"SIGKILL"!==e.signal&&(this.Baker.Error=!0,console.error(e),console.error("If it's aborted with an exception, try to lower the number of Resolution or MSAA."),this.Baker.Stop(),clearInterval(this._timer),this.Baker.Close(),this._timer=null,this.Baker.emit("end",!0),this._process.kill("SIGKILL"))}),this._process||(console.log("Launching lightfx failed."),clearInterval(this._timer))}e=!0}else t<0&&clearInterval(this._timer)},100)}}exports.LFX_App=LFX_App,exports.default=LFX_App;