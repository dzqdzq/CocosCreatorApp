"use strict";var fs=require("fs"),os=require("os"),net=require("net"),path=require("path"),_async=require("async"),debug=require("debug"),mkdirp=require("mkdirp").mkdirp,debugTestPort=debug("portfinder:testPort"),debugGetPort=debug("portfinder:getPort"),debugDefaultHosts=debug("portfinder:defaultHosts"),internals={testPort:function(t,r){function e(){debugTestPort("done w/ testPort(): OK",t.host,"port",t.port),t.server.removeListener("error",o),t.server.close(),r(null,t.port)}function o(o){if(debugTestPort("done w/ testPort(): failed",t.host,"w/ port",t.port,"with error",o.code),t.server.removeListener("listening",e),"EADDRINUSE"!=o.code&&"EACCES"!=o.code)return r(o);var s=exports.nextPort(t.port);if(s>exports.highestPort)return r(new Error("No open ports available"));internals.testPort({port:s,host:t.host,server:t.server},r)}r||(r=t,t={}),t.server=t.server||net.createServer(function(){}),debugTestPort("entered testPort(): trying",t.host,"port",t.port),t.server.once("error",o),t.server.once("listening",e),t.host?t.server.listen(t.port,t.host):t.server.listen(t.port)}};exports.basePort=8e3,exports.highestPort=65535,exports.basePath="/tmp/portfinder",exports.getPort=function(t,r){if(r||(r=t,t={}),t.port=Number(t.port)||Number(exports.basePort),t.host=t.host||null,t.stopPort=Number(t.stopPort)||Number(exports.highestPort),!t.startPort){if(t.startPort=Number(t.port),t.startPort<0)throw Error("Provided options.startPort("+t.startPort+") is less than 0, which are cannot be bound.");if(t.stopPort<t.startPort)throw Error("Provided options.stopPort("+t.stopPort+"is less than options.startPort ("+t.startPort+")")}if(t.host){for(var e,o=0;o<exports._defaultHosts.length;o++)if(exports._defaultHosts[o]===t.host){e=!0;break}e||exports._defaultHosts.push(t.host)}var s,n=[];return _async.eachSeries(exports._defaultHosts,function(r,e){return debugGetPort("in eachSeries() iteration callback: host is",r),internals.testPort({host:r,port:t.port},function(t,o){return t?(debugGetPort("in eachSeries() iteration callback testPort() callback","with an err:",t.code),s=r,e(t)):(debugGetPort("in eachSeries() iteration callback testPort() callback","with a success for port",o),n.push(o),e())})},function(e){if(e){if(debugGetPort("in eachSeries() result callback: err is",e),"EADDRNOTAVAIL"===e.code||"EINVAL"===e.code){if(t.host===s){var o="Provided host "+t.host+" could NOT be bound. Please provide a different host address or hostname";return r(Error(o))}var i=exports._defaultHosts.indexOf(s);return exports._defaultHosts.splice(i,1),exports.getPort(t,r)}return r(e)}if(n.sort(function(t,r){return t-r}),debugGetPort("in eachSeries() result callback: openPorts is",n),n[0]===n[n.length-1]){if(n[0]<=t.stopPort)return r(null,n[0]);o="No open ports found in between "+t.startPort+" and "+t.stopPort;return r(Error(o))}return exports.getPort({port:n.pop(),host:t.host,startPort:t.startPort,stopPort:t.stopPort},r)})},exports.getPortPromise=function(t){if("function"!=typeof Promise)throw Error("Native promise support is not available in this version of node.Please install a polyfill and assign Promise to global.Promise before calling this method");return t||(t={}),new Promise(function(r,e){exports.getPort(t,function(t,o){if(t)return e(t);r(o)})})},exports.getPorts=function(t,r,e){e||(e=r,r={});var o=null;_async.timesSeries(t,function(t,e){o&&(r.port=exports.nextPort(o)),exports.getPort(r,function(t,r){t?e(t):(o=r,e(null,r))})},e)},exports.getSocket=function(t,r){function e(){fs.stat(t.path,function(e){e?"ENOENT"==e.code?r(null,t.path):r(e):(t.path=exports.nextSocket(t.path),exports.getSocket(t,r))})}return r||(r=t,t={}),t.mod=t.mod||parseInt("755",8),t.path=t.path||exports.basePath+".sock",t.exists?e():(o=path.dirname(t.path),void fs.stat(o,function(s,n){if(s||!n.isDirectory())return function(o){mkdirp(o,t.mod,function(o){if(o)return r(o);t.exists=!0,e()})}(o);t.exists=!0,e()}));var o},exports.nextPort=function(t){return t+1},exports.nextSocket=function(t){var r=path.dirname(t),e=path.basename(t,".sock").match(/^([a-zA-z]+)(\d*)$/i),o=parseInt(e[2]),s=e[1];return isNaN(o)&&(o=0),o+=1,path.join(r,s+o+".sock")},exports._defaultHosts=function(){var t={};try{t=os.networkInterfaces()}catch(t){if("uv_interface_addresses"!==t.syscall)throw t}for(var r=Object.keys(t),e=["0.0.0.0"],o=0;o<r.length;o++)for(var s=t[r[o]],n=0;n<s.length;n++){var i=s[n];e.push(i.address)}return e.push(null),debugDefaultHosts("exports._defaultHosts is: %o",e),e}();