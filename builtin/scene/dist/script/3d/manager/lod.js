"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LODManager=void 0;const cc_1=require("cc"),camera_1=__importDefault(require("./camera")),component_1=__importDefault(require("./component")),lod_group_utils_1=require("cc/editor/lod-group-utils"),selection_1=__importDefault(require("./selection")),node_1=__importDefault(require("./node")),component_2=__importDefault(require("./component"));class LODManager{constructor(){this._selectedUUIDs=[],this._selectedMeshRendererSet=new Set,this._selectedLODSet=new Set}onResize(e){}onSceneOpened(e){}onSceneReload(e){}onSceneClosed(e){}onNodeChanged(e,t){}onAddNode(e){}onRemoveNode(e){}onNodeAdded(e,t){}onNodeRemoved(e,t){}onAddComponent(e){}onRemoveComponent(e){}onComponentAdded(e,t){}onComponentRemoved(e,t){}applyCurrentCameraSize(e){const t=component_1.default.query(e);if(t instanceof cc_1.LODGroup){return lod_group_utils_1.LODGroupEditorUtility.getRelativeHeight(t,camera_1.default.camera.camera)}return null}onSelect(e,t){for(let e=0;e<t.length;e++){const n=t[e];if(!this._selectedUUIDs.includes(n)){const e=node_1.default.query(n);if(e){const t=e.getComponent(cc_1.MeshRenderer);t&&this.onSelectMeshRenderer(t);const n=e.getComponent(cc_1.LODGroup);n&&this.onSelectLOD(n),(n||t)&&this.updateAllLODGroupLockedVisibility()}}}this._selectedUUIDs.length=0,this._selectedUUIDs.push(...t)}onUnselect(e,t){for(let e=0;e<this._selectedUUIDs.length;e++){const n=this._selectedUUIDs[e];if(!t.includes(n)){const e=node_1.default.query(n);if(e){const t=e.getComponent(cc_1.MeshRenderer);t&&this.onUnselectMeshRenderer(t);const n=e.getComponent(cc_1.LODGroup);n&&this.onUnselectLOD(n),(n||t)&&this.updateAllLODGroupLockedVisibility()}}}this._selectedUUIDs.length=0,this._selectedUUIDs.push(...t)}onSelectMeshRenderer(e){this._selectedMeshRendererSet.add(e)}onUnselectMeshRenderer(e){this._selectedMeshRendererSet.has(e)&&this._selectedMeshRendererSet.delete(e)}onSelectLOD(e){this._selectedLODSet.add(e)}onUnselectLOD(e){this._selectedLODSet.has(e)&&this._selectedLODSet.delete(e)}updateAllLODGroupLockedVisibility(){var e;null===(e=cc_1.director.getScene())||void 0===e||e.getComponentsInChildren(cc_1.LODGroup).forEach(e=>{if(e.enabled){const t=e.LODs.map((t,n)=>{if(!this._selectedLODSet.has(e)&&t.renderers.some(e=>e&&this._selectedMeshRendererSet.has(e)))return n}).filter(e=>"number"==typeof e);lod_group_utils_1.LODGroupEditorUtility.forceLODs(e,t)}})}insertLOD(e,...t){const n=component_2.default.query(e);n instanceof cc_1.LODGroup&&(n.insertLOD(...t),cce.Node.emit("change",n.node))}eraseLOD(e,...t){const n=component_2.default.query(e);n instanceof cc_1.LODGroup&&(n.eraseLOD(...t),cce.Node.emit("change",n.node))}init(){var e,t;null!==(e=this._onSelect)&&void 0!==e||(this._onSelect=this.onSelect.bind(this)),null!==(t=this._onUnselect)&&void 0!==t||(this._onUnselect=this.onUnselect.bind(this)),selection_1.default.on("select",this._onSelect),selection_1.default.on("unselect",this._onUnselect)}}exports.LODManager=LODManager,exports.default=new LODManager;