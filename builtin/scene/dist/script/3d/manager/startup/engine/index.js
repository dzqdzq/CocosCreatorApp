"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,n)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EngineStartup=void 0;const fs_extra_1=require("fs-extra"),path_1=require("path"),adapter_util_1=require("./adapter-util"),requiredModules=["cc","cc/editor/populate-internal-constants","cc/editor/serialization","cc/editor/new-gen-anim","cc/editor/embedded-player","cc/editor/reflection-probe","cc/editor/lod-group-utils","cc/editor/material","cc/editor/2d-misc","cc/editor/offline-mappings","cc/editor/custom-pipeline"],Backends={"physics-cannon":"cannon.js","physics-ammo":"bullet","physics-builtin":"builtin","physics-physx":"physx"},Backends2D={"physics-2d-box2d":"box2d","physics-2d-builtin":"builtin"};async function queryInternalAssetList(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=await(0,fs_extra_1.readJSON)((0,path_1.join)(e,"cc.config.json")),i=[];for(const e in t.features)t.features[e].dependentAssets&&i.push(...t.features[e].dependentAssets);return Array.from(new Set(i))}let cc;class EngineStartup{constructor(){this.nativeEngine=null}async loadNativeEngine(){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path;await Editor.Profile.getConfig("scene","scene.debug-native")&&await Editor.Dialog.warn(Editor.I18n.t("scene.messages.debug_native"),{detail:`process id: ${process.pid},isPreview:${isPreviewProcess}`,buttons:[Editor.I18n.t("scene.messages.confirm")]}),this.nativeEngine=await(0,adapter_util_1.importNativeEngine)((0,path_1.join)(e,"bin/.editor/EngineAddon")),(0,adapter_util_1.importWebAdapter)((0,path_1.join)(e,"bin/.editor/web-adapter"));const{default:t}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await t({dist:(0,path_1.join)(e,"bin/.editor"),requiredModules:requiredModules}),(cc=require("cc")).assetManager.downloader.appendTimeStamp=!1,require((0,path_1.join)(e,"bin/.editor/engine-adapter")),EditorExtends.start(),setInterval(()=>{var e;null===(e=this.nativeEngine)||void 0===e||e.tick()},3)}async requireEngine(){try{if(isSceneNative)await this.loadNativeEngine();else{const{default:e}=await Promise.resolve().then(()=>__importStar(require("cc/preload")));await e({requiredModules:requiredModules}),cc=require("cc"),EditorExtends.start()}}catch(e){throw console.log(`Load engine failed: ${e.message}`),e}}async openEngine(e={}){var t,i;const r=await queryInternalAssetList(),n=await Editor.Profile.getProject("engine","modules.includeModules"),a=await Editor.Profile.getProject("project","physics"),s=await Editor.Profile.getProject("engine","macroConfig"),o=(0,path_1.join)(Editor.Project.tmpDir,"asset-db/effect/effect.bin"),c={debugMode:cc.DebugMode.WARN,overrideSettings:{engine:{builtinAssets:r,macros:s},profiling:{showFPS:!1},screen:{frameRate:30},rendering:{renderMode:2,effectSettingsPath:isSceneNative?o:`file://${o.replace(/\\/g,"/")}`},physics:a,assets:{importBase:isSceneNative?(0,path_1.join)(Editor.Project.path,"library"):"import://",nativeBase:isSceneNative?(0,path_1.join)(Editor.Project.path,"library"):"import://"}},exactFitScreen:!0};c.overrideSettings.engine&&(null===(t=null===e||void 0===e?void 0:e.overrideSettings)||void 0===t?void 0:t.engine)&&Object.assign(c.overrideSettings.engine,e.overrideSettings.engine),cc.physics.selector.runInEditor=!0,await cc.game.init(c),isPreviewProcess&&(cc.cclegacy.GAME_VIEW=!0);try{const{default:e}=await Promise.resolve().then(()=>__importStar(require("../../scripts")));cce.Script=e,await e.init()}catch(e){console.error(e)}await cc.game.run();let d="builtin",u="builtin";n.forEach(e=>{e in Backends?d=Backends[e]:e in Backends2D&&(u=Backends2D[e])}),cc.physics.selector.switchTo(d),cc.physics.PhysicsSystem.instance.enable=!1,window.cc.internal.physics2d.selector.switchTo(u),null===(i=cce.NativeScene)||void 0===i||i.sendToBrowser("onEngineReady",isPreviewProcess)}async configureStartup(){}configureEngine(){}async loadEffect(){const{default:e}=await Promise.resolve().then(()=>__importStar(require("../../effects"))),t=await cce.Ipc.send("query-effects");await Promise.all(t.map(t=>e.registerEffect(t)))}}exports.EngineStartup=EngineStartup;const engineStartup=new EngineStartup;exports.default=engineStartup;