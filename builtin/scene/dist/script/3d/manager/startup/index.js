"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),globalThis.DEBUG_TIME_COST=!0,DEBUG_TIME_COST&&console.time("Import Electron and EditorExtends");const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends");DEBUG_TIME_COST&&console.timeEnd("Import Electron and EditorExtends"),window.EditorExtends=EditorExtends,DEBUG_TIME_COST&&console.time("Import files");const engine_1=__importDefault(require("./engine")),log_1=__importDefault(require("./log")),buffer_1=__importDefault(require("../preview/buffer")),scene_facade_manager_1=require("../../facade/scene-facade-manager"),index_1=__importDefault(require("../gameview/index")),scene_cache_1=require("../scene/scene-cache");DEBUG_TIME_COST&&console.timeEnd("Import files");const LOCK={engine:!1,manager:!1},layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;class StartupManager{async initEngine(e,n,i){if(e.renderPipeline=n,DEBUG_TIME_COST&&console.time("Require engine time"),LOCK.engine)return;LOCK.engine=!0;Date.now();Editor.Metrics.trackTimeStart("[Scene] Require engine code"),await engine_1.default.requireEngine(),Editor.Metrics.trackTimeEnd("[Scene] Require engine code"),DEBUG_TIME_COST&&console.timeEnd("Require engine time");const t=ElectronModule.require("Serialize");window.cce.Utils={serialize:t.serialize},Editor.Metrics.trackTimeStart("[Scene] Startup engine"),await engine_1.default.configureStartup(),Editor.Metrics.trackTimeEnd("[Scene] Startup engine"),DEBUG_TIME_COST&&console.time("Open engine time"),Editor.Metrics.trackTimeStart("[Scene] Open engine"),await engine_1.default.openEngine(e),DEBUG_TIME_COST&&console.timeEnd("Open engine time"),Editor.Metrics.trackTimeEnd("[Scene] Open engine"),DEBUG_TIME_COST&&console.time("Configure engine time"),Editor.Metrics.trackTimeStart("[Scene] Configure engine"),await engine_1.default.configureEngine(),Editor.Metrics.trackTimeEnd("[Scene] Configure engine"),DEBUG_TIME_COST&&console.timeEnd("Configure engine time"),this.initCustomLayer(i)}async initDesignResolution(e,n){e-=0,n-=0,isNaN(e)&&(e=cc.view._designResolutionSize.width),isNaN(n)&&(n=cc.view._designResolutionSize.height),cc.view.setDesignResolutionSize(e,n,cc.ResolutionPolicy.SHOW_ALL)}async initCustomLayer(e){if(e){for(let e=0;e<=19;e++)cc.Layers.deleteLayer(e);e.forEach(e=>{const n=layerMask.findIndex(n=>e.value===n);-1!==n&&cc.Layers.addLayer(e.name,n)})}}async initManager(e){if(LOCK.manager)return;LOCK.manager=!0,DEBUG_TIME_COST&&console.time("InitManager"),log_1.default.init();const n=window.cce;n.project=e.project;const i=new cc.Node("Editor Scene Foreground"),t=new cc.Node("Editor Scene Background");i.objFlags|=cc.Object.Flags.DontSave|cc.Object.Flags.HideInHierarchy,t.objFlags|=cc.Object.Flags.DontSave|cc.Object.Flags.HideInHierarchy,cc.game.addPersistRootNode(i),cc.game.addPersistRootNode(t),n.foregroundNode=i,n.backgroundNode=t;try{await require("../effects").default.init()}catch(e){console.error(e)}n.GameView=index_1.default,n.PreviewBuffer=buffer_1.default;const r=new scene_facade_manager_1.SceneFacadeManager;n.SceneFacadeManager=r,r.init(),await scene_cache_1.sceneCacheManager.init(),DEBUG_TIME_COST&&console.timeEnd("InitManager")}}exports.default=new StartupManager;