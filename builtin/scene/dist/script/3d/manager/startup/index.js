"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,n,t){void 0===t&&(t=n);var r=Object.getOwnPropertyDescriptor(i,n);r&&("get"in r?i.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(e,t,r)}:function(e,i,n,t){void 0===t&&(t=n),e[t]=i[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(i,e,n);return __setModuleDefault(i,e),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),globalThis.DEBUG_TIME_COST=!0,DEBUG_TIME_COST&&console.time("Import Electron and EditorExtends"),DEBUG_TIME_COST&&console.timeEnd("Import Electron and EditorExtends"),DEBUG_TIME_COST&&console.time("Import files");const index_1=__importDefault(require("./engine/index")),scene_view_data_1=require("../scene-view/scene-view-data"),log_1=__importDefault(require("./log"));DEBUG_TIME_COST&&console.timeEnd("Import files");const LOCK={engine:!1,manager:!1,config:!1},layerMask=[];for(let e=0;e<=19;e++)layerMask[e]=1<<e;class StartupManager{async requireEngine(){if(LOCK.engine)return;LOCK.engine=!0,DEBUG_TIME_COST&&console.time("Require engine time");Date.now();Editor.Metrics.trackTimeStart("[Scene] Require engine code"),await index_1.default.requireEngine(),Editor.Metrics.trackTimeEnd("[Scene] Require engine code",{output:!1}),DEBUG_TIME_COST&&console.timeEnd("Require engine time")}async configEngine(e,i,n,t){LOCK.config||(LOCK.config=!0,window.cce.Utils={serialize:EditorExtends.serialize,deserializeFull:EditorExtends.deserializeFull},DEBUG_TIME_COST&&console.time("Open engine time"),Editor.Metrics.trackTimeStart("[Scene] Open engine"),await index_1.default.openEngine(e),DEBUG_TIME_COST&&console.timeEnd("Open engine time"),Editor.Metrics.trackTimeEnd("[Scene] Open engine",{output:!0}),DEBUG_TIME_COST&&console.time("Configure engine time"),Editor.Metrics.trackTimeStart("[Scene] Configure engine"),await index_1.default.configureEngine(),Editor.Metrics.trackTimeEnd("[Scene] Configure engine",{output:!0}),DEBUG_TIME_COST&&console.timeEnd("Configure engine time"),this.initCustomLayer(n),this.initSortingLayer(t),cc.game.canvas.requestPointerLock=function(){},cc.game.canvas.exitPointerLock=function(){},cc.game.canvas.requestFullscreen=function(){})}async initEngine(e,i,n,t){await this.requireEngine(),await this.configEngine(e,i,n,t)}async initDesignResolution(e,i){e-=0,i-=0,isNaN(e)&&(e=cc.view._designResolutionSize.width),isNaN(i)&&(i=cc.view._designResolutionSize.height),cc.view.setDesignResolutionSize(e,i,cc.ResolutionPolicy.SHOW_ALL),"__default_design__"===scene_view_data_1.sceneViewData.targetDeviceName&&(scene_view_data_1.sceneViewData.targetResolution={width:e,height:i})}async initCustomLayer(e){if(e){for(let e=0;e<=19;e++)cc.Layers.deleteLayer(e);e.forEach(e=>{const i=layerMask.findIndex(i=>e.value===i);-1!==i&&cc.Layers.addLayer(e.name,i)})}}async initSortingLayer(e){if(!Array.isArray(e))return;cc.settings.overrideSettings("engine","sortingLayers",e);const{SortingLayers:i}=await Promise.resolve().then(()=>__importStar(require("cc")));i.init()}async initManager(e){if(LOCK.manager)return;LOCK.manager=!0,DEBUG_TIME_COST&&console.time("InitManager"),log_1.default.init();const i=window.cce;i.project=e.project;const n=new cc.Node("Editor Scene Foreground"),t=new cc.Node("Editor Scene Background");n.objFlags|=cc.Object.Flags.DontSave|cc.Object.Flags.HideInHierarchy,t.objFlags|=cc.Object.Flags.DontSave|cc.Object.Flags.HideInHierarchy,cc.director.addPersistRootNode(n),cc.director.addPersistRootNode(t),i.foregroundNode=n,i.backgroundNode=t;const{SceneFacadeManager:r}=await Promise.resolve().then(()=>__importStar(require("../../facade/scene-facade-manager"))),a=new r;i.SceneFacadeManager=a,await a.init();const{sceneCacheManager:o}=await Promise.resolve().then(()=>__importStar(require("../scene/scene-cache")));await o.init(),DEBUG_TIME_COST&&console.timeEnd("InitManager")}}exports.default=new StartupManager;