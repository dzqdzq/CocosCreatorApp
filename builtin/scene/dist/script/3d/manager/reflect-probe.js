"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReflectProbeManager=void 0;const cc_1=require("cc"),reflection_probe_1=require("cc/editor/reflection-probe"),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),graphics_1=require("../../utils/graphics"),misc_1=require("../../utils/misc"),component_1=__importDefault(require("./component"));class ReflectProbeManager{constructor(){this._bakeQueue=[],this._isBusy=!1,this._currentBakingUUID="",ReflectProbeManager.INSTANCE=this}static GET_INSTANCE(){var e;return null!==(e=this.INSTANCE)&&void 0!==e?e:new ReflectProbeManager}onResize(e){}onSceneOpened(e){}onSceneReload(e){}onSceneClosed(e){this.stopBaking()}onNodeChanged(e,t){}onAddNode(e){}onRemoveNode(e){}onNodeAdded(e,t){}onNodeRemoved(e,t){}onAddComponent(e){}onRemoveComponent(e){}onComponentAdded(e,t){}onComponentRemoved(e,t){}init(){}stopBaking(){this._bakeQueue.length=0,this._currentBakingUUID="",this.isBusy=!1}isBaking(e){return this._bakeQueue.some(t=>t.uuid===e)||this._currentBakingUUID===e}get isBusy(){return this._isBusy}set isBusy(e){this._isBusy=e}bakeCubemaps(e){for(let t=0;t<e.length;t++){const s=e[t];this.bakeCubemap(s)}}async bakeCubemap(e){if(!this.isBaking(e))return this.isBusy&&await new Promise(t=>{this._bakeQueue.push({uuid:e,resolve:t})}),new Promise((t,s)=>{this.isBusy=!0,this._currentBakingUUID=e;const r=()=>{const e=this._bakeQueue.pop();e?e.resolve(void 0):(this._isBusy=!1,this._currentBakingUUID="")};this.captureCube(e).then(e=>{t(e)}).catch(e=>{s(e)}).finally(()=>r())})}async captureCube(e){const t=component_1.default.query(e);if(!(t instanceof cc_1.ReflectionProbe))return;t.probe.captureCubemap(),await this.waitForNextFrame();const s=cc_1.director.root.device.capabilities,r=[];for(let e=0;e<6;e++){const o=`capture_${e}.png`;r.push(o);let i=(0,graphics_1.readPixels)(t.probe.bakedCubeTextures[e]);-1===s.clipSpaceMinZ&&(i=(0,graphics_1.flipImage)(i,t._resolution,t._resolution)),(0,cc_1.assert)(null!==i),await(0,graphics_1.saveDataToImage)(Buffer.from(i),t._resolution,t._resolution,t.node.scene.name,o)}const o=cc_1.director.root.pipeline.pipelineSceneData.isHDR;await this.bakeReflectionProbe(r,o,t.node.scene.name,t.probe.getProbeId(),e=>{t.cubemap=e}),t._cubemap&&reflection_probe_1.ReflectionProbeManager.probeManager.updateBakedCubemap(t.probe)}async waitForNextFrame(){return new Promise((e,t)=>{cc.director.once(cc.Director.EVENT_END_FRAME,()=>{e()}),cce.Engine.repaintInEditMode()})}async bakeReflectionProbe(e,t,s,r,o){var i;if(6!==e.length)return void console.error("cubemap face is incomplete");const a=await Editor.Message.request("asset-db","query-path","db://assets");if(null===a)return void console.error("no asset directory");const n=[];for(let t=0;t<e.length;t++){const r=e[t],o=(0,misc_1.join)(a,s,r);if(n.push(o),!(0,fs_extra_1.existsSync)(o))return void console.error(o+" not exist")}const c=(0,misc_1.join)(a,s);(0,fs_extra_1.existsSync)(c)||(0,fs_extra_1.mkdirSync)(c);const u=(0,misc_1.join)(c,"reflectionProbe"),p=u+"_"+r.toString(),l=u+"_"+r.toString()+".png",_=t?"rgbm":"bgra8";try{let e;const s=["--bypassoutputtype","--output0params","png,"+_+",latlong","--inputFacePosX",n[0],"--inputFaceNegX",n[1],"--inputFacePosY",n[2],"--inputFaceNegY",n[3],"--inputFacePosZ",n[4],"--inputFaceNegZ",n[5],"--output0",p];t&&s.splice(0,0,"--rgbm"),e="darwin"===process.platform?(0,child_process_1.spawn)((0,misc_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64"),s):(0,child_process_1.spawn)((0,misc_1.join)(Editor.App.path,"../tools/cmft/cmftRelease64.exe"),s),await new Promise((t,s)=>{e.on("close",e=>{if(0!==e)return console.error("bake reflectionProbe failed."),console.error(e),void s(e);t(e)})});for(let e=0;e<n.length;e++)await(0,fs_extra_1.remove)(n[e]);const r=l+".meta";if((0,fs_extra_1.existsSync)(r)){const e=(0,fs_extra_1.readJSONSync)(r);e.userData.type="texture cube",(0,fs_extra_1.outputJSONSync)(r,e,{spaces:2})}else(0,fs_extra_1.outputJSONSync)(r,{ver:"0.0.0",importer:"*",userData:{type:"texture cube",isRGBE:!0}},{spaces:2});if(await Editor.Message.request("asset-db","refresh-asset",l),(0,fs_extra_1.existsSync)(r)){const e=(0,fs_extra_1.readJSONSync)(r);(null===(i=e.subMetas)||void 0===i?void 0:i.b47c0)&&(e.subMetas.b47c0.userData.mipBakeMode=2,(0,fs_extra_1.outputJSONSync)(r,e,{spaces:2}),await Editor.Message.request("asset-db","refresh-asset",l))}if(l){const e=await Editor.Message.request("asset-db","query-uuid",l);if(e){const t=await new Promise(t=>{cc.assetManager.loadAny(`${e}@b47c0`,(s,r)=>{s?(console.error(`asset can't be load:${e}`),t(null)):t(r)})});t&&o(t)}}}catch(e){console.error(e)}}}exports.ReflectProbeManager=ReflectProbeManager,exports.default=ReflectProbeManager.GET_INSTANCE();