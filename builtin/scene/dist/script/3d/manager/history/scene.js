"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneUndoCommand=exports.SceneUndoManager=void 0;const node_1=__importDefault(require("../node")),selection_1=__importDefault(require("../selection")),dump_1=__importDefault(require("../../utils/dump")),undo_manager_base_1=__importDefault(require("./undo-manager-base")),snapshot_command_1=__importDefault(require("./snapshot-command")),event_enum_1=require("../../../public/event-enum"),cc_1=require("cc");class SceneUndoManager extends undo_manager_base_1.default{constructor(){super(),this.name="scene",this._lightProbeEditMode=!1,this._lightProbeUndoArray=[],this.cacheDump={},this.scene={uuid:"",animationMode:!1},this.records=[]}set undoArray(e){this._lightProbeEditMode?this._lightProbeUndoArray=e:super.undoArray=e}get undoArray(){return this._lightProbeEditMode?this._lightProbeUndoArray:super.undoArray}getUndoData(e=this.records){const t={};return e.forEach(e=>{t[e]=this.cacheDump[e]}),t}getRedoData(e=this.records){return this.updateCache(e),this.getUndoData(e)}updateCache(e=[]){e.forEach(e=>{try{const t=node_1.default.query(e);if(!t||t.objFlags&cc.Object.Flags.HideInHierarchy)return;this.cacheDump[e]=node_1.default.queryDumpAtAll(e)}catch(e){console.error(e)}})}abort(){this.records.length=0}record(e){this.records.includes(e.uuid)||this.records.push(e.uuid)}snapshot(e){try{if(!e){const t=this.getUndoData(),r=this.getRedoData();if(JSON.stringify(t)===JSON.stringify(r))return this.records.length=0,!1;(e=new SceneUndoCommand(t,r)).manager=this,this.records.length=0}if(!e)return!1;this.push(e)}catch(e){console.error(e)}return!0}async undo(){this.records.length&&this.snapshot(),await super.undo(),this.abort()}async redo(){this.records.length&&this.snapshot(),await super.redo(),this.abort()}reset(e,t){this.scene.uuid!==t.uuid&&(this.scene.uuid=t.uuid,this.cacheDump=Object.create(null),e.forEach(e=>{const t=node_1.default.query(e);!t||t.objFlags&cc.Object.Flags.HideInHierarchy||(this.cacheDump[e]=node_1.default.queryDumpAtAll(e))}),this.rebase())}lightProbeEditModeChanged(e){let t;if(this._lightProbeEditMode=e,!e){if(this.records.length>0&&this.snapshot(),0===this._lightProbeUndoArray.length)return;const e=this._lightProbeUndoArray.length-1;if(e<0)return;const r=0;this._lightProbeUndoArray[e].redoData=this._lightProbeUndoArray[r].redoData,t=this._lightProbeUndoArray[e],this._lightProbeUndoArray.length=0,this.isDirty()||this.save()}t&&this.push(t)}save(){this.undoSizeWhenSave=super.undoArray.length+this._lightProbeUndoArray.length}isDirty(){return super.undoArray.length+this._lightProbeUndoArray.length!==this.undoSizeWhenSave}}exports.SceneUndoManager=SceneUndoManager;const sceneUndoManager=new SceneUndoManager;class SceneUndoCommand extends snapshot_command_1.default{constructor(){super(...arguments),this.manager=null}async excute(e){var t,r;const n=Object.keys(e),o={},s=null===(t=this.manager)||void 0===t?void 0:t.getUndoData(n);for(const t of n){const r=s[t],n=e[t];if(!n){selection_1.default.unselect(t),o[t]="remove";continue}if(r&&r.isScene){o[t]="change";continue}let a="change";const i=r.parent.value.uuid,d=n.parent.value.uuid;""===i&&""!==d&&(a="add"),""!==i&&""===d&&(a="remove"),o[t]=a}for(const t of n){const r=node_1.default.query(t);if(r)if("change"===o[t])try{await dump_1.default.restoreNode(r,e[t])}catch(e){console.error(e)}else"add"===o[t]&&r.walk(e=>{e.objFlags&=~cc_1.CCObject.Flags.Destroyed})}for(const e of n){const t=node_1.default.query(e),r=o[e];t&&node_1.default.emit(r,t,{source:event_enum_1.EventSourceType.UNDO})}null===(r=this.manager)||void 0===r||r.updateCache(n)}}exports.SceneUndoCommand=SceneUndoCommand,exports.default=sceneUndoManager;