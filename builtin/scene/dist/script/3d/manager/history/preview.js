"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../node")),selection_1=__importDefault(require("../selection")),dump_1=__importDefault(require("../../utils/dump")),undo_manager_base_1=__importDefault(require("./undo-manager-base")),snapshot_command_1=__importDefault(require("./snapshot-command")),event_enum_1=require("../../../public/event-enum");class PreviewUndoManager extends undo_manager_base_1.default{constructor(){super(),this.cacheDump={},this.scene={uuid:"",animationMode:!1},this.records=[]}getUndoData(e=this.records){const t={};return e.forEach(e=>{t[e]=this.cacheDump[e]}),t}getRedoData(e=this.records){return this.updateCache(e),this.getUndoData(e)}updateCache(e=[]){e.forEach(e=>{try{const t=node_1.default.query(e);if(!t||t.objFlags&cc.Object.Flags.HideInHierarchy)return;this.cacheDump[e]=node_1.default.queryDumpAtAll(e)}catch(e){console.error(e)}})}abort(){this.records.length=0}record(e){this.records.includes(e.uuid)||this.records.push(e.uuid)}snapshot(e){try{if(!e){const t=this.getUndoData(),r=this.getRedoData();if(JSON.stringify(t)===JSON.stringify(r))return this.records.length=0,!1;e=new SceneUndoCommand(t,r),this.records.length=0}if(!e)return!1;this.push(e)}catch(e){console.error(e)}return!0}async undo(){this.records.length&&this.snapshot(),await super.undo(),this.abort()}async redo(){this.records.length&&this.snapshot(),await super.redo(),this.abort()}reset(e,t){this.scene.uuid!==t.uuid&&(this.scene.uuid=t.uuid,this.cacheDump=Object.create(null),e.forEach(e=>{const t=node_1.default.query(e);!t||t.objFlags&cc.Object.Flags.HideInHierarchy||(this.cacheDump[e]=node_1.default.queryDumpAtAll(e))}),this.rebase())}}const previewUndoManager=new PreviewUndoManager;class SceneUndoCommand extends snapshot_command_1.default{async excute(e){const t=Object.keys(e),r={},n=previewUndoManager.getUndoData(t);for(const o of t){const t=n[o],a=e[o];if(!a){selection_1.default.unselect(o),r[o]="remove";continue}if(t&&t.isScene){r[o]="change";continue}let s="change";const u=t.parent.value.uuid,c=a.parent.value.uuid;""===u&&""!==c&&(s="add"),""!==u&&""===c&&(s="remove"),r[o]=s}for(const n of t){const t=node_1.default.query(n);if(t&&"change"===r[n])try{await dump_1.default.restoreNode(t,e[n])}catch(e){console.error(e)}}for(const e of t){const t=node_1.default.query(e),n=r[e];t&&node_1.default.emit(n,t,{source:event_enum_1.EventSourceType.UNDO})}previewUndoManager.updateCache(t)}}exports.default=previewUndoManager;