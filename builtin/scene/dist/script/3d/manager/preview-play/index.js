"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewPlay=void 0;const cc_1=require("cc"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),message_1=require("../message"),scene_view_1=require("../../manager/scene-view"),env_1=__importDefault(require("../../../utils/env")),path_1=__importDefault(require("path")),EDITOR_MASK=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]),PlayState={Play:"play",Stop:"stop",Pause:"pause"};class PreviewPlay extends EventEmitter_1.default{constructor(){super(),this._state=PlayState.Stop,this._fps=60,this._scene=null,this._updateInspectorHandler=null,this._sceneLightOn=!1,this._isNative=!1,this._rotate=!1,this.firstResume=!0,this._onSceneLaunch=this.onSceneLaunch.bind(this),this._onSceneBeforeLaunch=this.onSceneBeforeLaunch.bind(this),this._onDirectorEndFrame=this.onDirectorEndFrame.bind(this)}async getGameScene(e=""){const t=await Editor.Profile.getConfig("preview","general.start_scene");let i,s;const a=new Promise((e,t)=>{i=e,s=t});return"current_scene"===t?i(e):cc_1.assetManager.loadAny(t,(e,t)=>{e?s(e):i(cce.Utils.serialize(t.scene))}),a}beforeLaunch(){cce.Node.clear()}rotateScene(e){this._rotate=e}setResolution(e,t){}showState(e){this._state===PlayState.Play&&cc.debug.setDisplayStats(e)}setFps(e){e>0&&(this._fps=e,this._state===PlayState.Play&&(cc_1.game.frameRate=e))}isPause(){return this._state===PlayState.Pause}pause(e){if(e){if(this._state===PlayState.Pause)return;cc_1.director.pause(),cc_1.game.pause(),this._state=PlayState.Pause,this.showEditorCamera(),this.firstResume&&(cce.Camera.focus(),this.firstResume=!1),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),cce.Engine.resume()}else cc_1.director.resume(),cc_1.game.resume(),this._state=PlayState.Play,this.hideEditorCamera(),scene_view_1.sceneViewManager.setSceneLightOn(!0),cce.Engine.pause()}async step(){cc_1.director.resume(),cc_1.director.tick(1/this._fps),cc_1.director.pause()}async start(e=""){console.debug("start gameview"),this._state=PlayState.Play,cce.Camera.setRulerVisible(!1),this._sceneLightOn=scene_view_1.sceneViewManager.querySceneLightOn(),scene_view_1.sceneViewManager.setSceneLightOn(!0);const t=await Editor.Profile.getConfig("scene","camera.size");if(cce.SceneFacadeManager.changeTargetResolution(t),this._registerEvent(),this._isNative=await env_1.default.useNativeScene(),isSceneNative){const e=(await Editor.Message.request("engine","query-engine-info")).typescript.path,t=path_1.default.join(e,"bin/.editor");await Editor.Message.request("preview","write-setting-file",t),jsb.fileUtils.addSearchPath(t),await cc.settings.init(path_1.default.join(t,"src/settings.json")),await cc_1.game._loadProjectBundles()}else{const e=await Editor.Message.request("server","query-port"),t=await Editor.Message.request("preview","get-preview-ip");await cc.settings.init(`http://${t}:${e}/settings.json`),cc.assetManager.downloader.init(`http://${t}:${e}/`,{},cc.settings.querySettings("assets","projectBundles")),await cc_1.game._loadProjectBundles()}this.startSceneJson=await this.getGameScene(e),await cce.SceneFacadeManager.softReloadScene(this.startSceneJson),this.hideEditorCamera(),cc.physics.PhysicsSystem.instance.enable=!0,cce.Engine.pause(),cc_1.director.resume(),cc_1.game.resume();const i=await Editor.Profile.getConfig("scene","game-view.stats"),s=await Editor.Profile.getConfig("scene","game-view.fps");this.setFps(s),this.showState(i),await Editor.Profile.getConfig("scene","console.extend.clearOnPlay.value","global")&&Editor.Message.send("console","clear")}async stop(){console.debug("stop gameview"),cc.debug.setDisplayStats(!1),cc_1.game.setFrameRate(60),this._state=PlayState.Stop,cce.Camera.setRulerVisible(!0),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),this._unregisterEvent(),await cce.SceneFacadeManager.softReloadScene(this._currSceneData),cc.physics.PhysicsSystem.instance.enable=!1,cc_1.game.pause(),cc_1.director.pause(),this.showEditorCamera(),message_1.messageManager.broadcast("scene:preview-stop")}hideEditorCamera(){var e,t,i,s,a;if(this._isNative)return void cce.NativeScene.redirectTargetWindow("preview");const c=null===(e=cc_1.director.getScene())||void 0===e?void 0:e.renderScene,n=null!==(t=null===c||void 0===c?void 0:c.cameras)&&void 0!==t?t:[];let r=null;for(let e=n.length-1;e>=0;e--){const t=n[e];if(t.node.layer&EDITOR_MASK)t.enabled=!1,t.changeTargetWindow(null===(i=cc_1.director.root)||void 0===i?void 0:i.tempWindow);else{r=t;const e=null===(s=t.node)||void 0===s?void 0:s.getComponent(cc.Camera);(null===e||void 0===e?void 0:e.targetTexture)&&e.targetTexture.window?t.changeTargetWindow(e.targetTexture.window):t.changeTargetWindow(null===(a=cc_1.director.root)||void 0===a?void 0:a.mainWindow)}}r&&(r.visibility|=cc_1.Layers.Enum.PROFILER)}showEditorCamera(){var e,t,i,s;if(this._isNative)return;const a=null===(e=cc_1.director.getScene())||void 0===e?void 0:e.renderScene,c=null!==(t=null===a||void 0===a?void 0:a.cameras)&&void 0!==t?t:[];for(let e=c.length-1;e>=0;e--){const t=c[e];t.node.layer&EDITOR_MASK?(t.enabled=!0,t.changeTargetWindow(null===(i=cc_1.director.root)||void 0===i?void 0:i.mainWindow)):t.changeTargetWindow(null===(s=cc_1.director.root)||void 0===s?void 0:s.tempWindow)}}setPlatform(e){}onSceneLaunch(e){this._state===PlayState.Play&&(cce.Scene.sendSceneOpenMsg(e,e.uuid,e),this.hideEditorCamera()),this._scene=e}onSceneBeforeLaunch(e){this._scene&&(cce.Scene.sendSceneCloseMsg(this._scene),cce.Selection.clear())}onDirectorEndFrame(){this._updateInspector(),isSceneNative&&cce.Engine.emitUpdate()}_updateInspector(){this._updateInspectorHandler||(this._updateInspectorHandler=setTimeout(()=>{if(this._updateInspectorHandler=null,this._state===PlayState.Play){const e=cce.Selection.query();e.length>0&&Editor.Message.broadcast("scene:change-node",e[0])}},500))}_recordGlobal(){this._windowKeys=Object.keys(window)}_resetGlobal(){for(const e in window)this._windowKeys.includes(e)||delete window[e]}_registerEvent(){cc_1.director.on(cc_1.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc_1.director.on(cc_1.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc_1.director.on(cc_1.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}_unregisterEvent(){cc_1.director.off(cc_1.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc_1.director.off(cc_1.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc_1.director.off(cc_1.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}}exports.PreviewPlay=PreviewPlay;const preview=new PreviewPlay;exports.default=preview;