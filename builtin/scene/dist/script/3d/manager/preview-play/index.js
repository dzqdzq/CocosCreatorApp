"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),message_1=require("../message"),scene_view_1=require("../../manager/scene-view"),EDITOR_MASK=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]),PlayState={Play:"play",Stop:"stop",Pause:"pause"};class PreviewPlay extends EventEmitter_1.default{constructor(){super(),this._state=PlayState.Stop,this._fps=60,this._scene=null,this._updateInspectorHandler=null,this._sceneLightOn=!1,this._onSceneLaunch=this.onSceneLaunch.bind(this),this._onSceneBeforeLaunch=this.onSceneBeforeLaunch.bind(this),this._onDirectorEndFrame=this.onDirectorEndFrame.bind(this)}async getGameScene(e=""){const t=await Editor.Profile.getConfig("preview","general.start_scene");let c,s;const a=new Promise((e,t)=>{c=e,s=t});return"current_scene"===t?c(e):cc_1.assetManager.loadAny(t,(e,t)=>{e?s(e):c(cce.Utils.serialize(t.scene))}),a}beforeLaunch(){cce.Node.clear()}rotateScene(e){this._rotate=e}setResolution(e,t){}showState(e){this._state===PlayState.Play&&cc.debug.setDisplayStats(e)}setFps(e){e>0&&(this._fps=e,this._state===PlayState.Play&&cc.game.setFrameRate(e))}isPause(){return this._state===PlayState.Pause}pause(e){e?(cc.director.pause(),cc.game.pause(),this._state=PlayState.Pause,cce.Camera.focus(),this.showEditorCamera(),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),cce.Engine.resume()):(cc.director.resume(),cc.game.resume(),this._state=PlayState.Play,this.hideEditorCamera(),scene_view_1.sceneViewManager.setSceneLightOn(!0),cce.Engine.pause())}async step(){cc.director.resume(),cc.director.tick(1/this._fps),cc.director.pause()}async start(e=""){console.debug("start gameview"),this._state=PlayState.Play,cce.Camera.setRulerVisible(!1),this._sceneLightOn=scene_view_1.sceneViewManager.querySceneLightOn(),scene_view_1.sceneViewManager.setSceneLightOn(!0),this._recordGlobal(),this._registerEvent();const t=await Editor.Message.request("server","query-port"),c=await Editor.Message.request("preview","get-preview-ip");await cc.settings.init(`http://${c}:${t}/settings.json`),cc.assetManager.downloader.init(`http://${c}:${t}/`,{},cc.settings.querySettings("assets","projectBundles")),await cc.game._loadProjectBundles(),this._currSceneData=cce.Utils.serialize(cc.director.getScene()),this.startSceneJson=await this.getGameScene(e),await cce.SceneFacadeManager.softReloadScene(this.startSceneJson),this.hideEditorCamera(),cc.physics.PhysicsSystem.instance.enable=!0,cce.Engine.pause(),cc.director.resume(),cc.game.resume();const s=await Editor.Profile.getConfig("scene","game-view.stats"),a=await Editor.Profile.getConfig("scene","game-view.fps");this.setFps(a),this.showState(s),await Editor.Profile.getConfig("scene","console.extend.clearOnPlay.value","global")&&Editor.Message.send("console","clear")}async stop(){console.debug("stop gameview"),cc.debug.setDisplayStats(!1),cc.game.setFrameRate(60),this._state=PlayState.Stop,cce.Camera.setRulerVisible(!0),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),this._resetGlobal(),this._unregisterEvent(),await cce.SceneFacadeManager.softReloadScene(this._currSceneData),cc.physics.PhysicsSystem.instance.enable=!1,cc.game.pause(),cc.director.pause(),cce.Engine.resume(),this.showEditorCamera(),message_1.messageManager.broadcast("scene:preview-stop")}hideEditorCamera(){var e;const t=cc.director.getScene().renderScene,c=null===t||void 0===t?void 0:t.cameras;for(const t of c)if(t.node.layer&EDITOR_MASK)t.enabled=!1,t.changeTargetWindow(cc.director.root.tempWindow);else{const c=null===(e=t.node)||void 0===e?void 0:e.getComponent(cc.Camera);(null===c||void 0===c?void 0:c.targetTexture)&&c.targetTexture.window?t.changeTargetWindow(c.targetTexture.window):t.changeTargetWindow(cc.director.root.mainWindow)}}showEditorCamera(){const e=cc.director.getScene().renderScene,t=null===e||void 0===e?void 0:e.cameras;for(const e of t)e.node.layer&EDITOR_MASK?(e.enabled=!0,e.changeTargetWindow(cc.director.root.mainWindow)):e.changeTargetWindow(cc.director.root.tempWindow)}setPlatform(){}onSceneLaunch(e){this._state===PlayState.Play&&(cce.Scene.sendSceneOpenMsg(e,e.uuid,e),this.hideEditorCamera()),this._scene=e}onSceneBeforeLaunch(e){cce.Scene.sendSceneCloseMsg(this._scene),cce.Selection.clear()}onDirectorEndFrame(){this._updateInspector()}_updateInspector(){this._updateInspectorHandler||(this._updateInspectorHandler=setTimeout(()=>{if(this._updateInspectorHandler=null,this._state===PlayState.Play){const e=cce.Selection.query();e.length>0&&Editor.Message.broadcast("scene:change-node",e[0])}},500))}_recordGlobal(){this._windowKeys=Object.keys(window)}_resetGlobal(){for(const e in window)this._windowKeys.includes(e)||delete window[e]}_registerEvent(){cc.director.on(cc.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}_unregisterEvent(){cc.director.off(cc.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc.director.off(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc.director.off(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}}const preview=new PreviewPlay;exports.default=preview;