"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewPlay=void 0;const cc_1=require("cc"),EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),message_1=require("../message"),scene_view_1=require("../../manager/scene-view"),env_1=__importDefault(require("../../../utils/env")),scene_view_data_1=require("../scene-view/scene-view-data"),EDITOR_MASK=cc_1.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]),PlayState={Play:"play",Stop:"stop",Pause:"pause"};class PreviewPlay extends EventEmitter_1.default{get sceneLightOn(){return this._sceneLightOn}constructor(){super(),this._state=PlayState.Stop,this._fps=60,this._scene=null,this._updateInspectorHandler=null,this._sceneLightOn=!1,this._isNative=!1,this._rotate=!1,this.firstResume=!0,this._onSceneLaunch=this.onSceneLaunch.bind(this),this._onSceneBeforeLaunch=this.onSceneBeforeLaunch.bind(this),this._onDirectorEndFrame=this.onDirectorEndFrame.bind(this)}async getGameScene(e=""){var t=await Editor.Profile.getConfig("preview","general.start_scene");let c,i;var s=new Promise((e,t)=>{c=e,i=t});return"current_scene"===t?c(e):cc_1.assetManager.loadAny(t,(e,t)=>{e?i(e):c(cce.Utils.serialize(t.scene))}),s}beforeLaunch(){cce.Node.clear()}rotateScene(e){this._rotate=e}setResolution(e,t){}showState(e){this._state===PlayState.Play&&cc.debug.setDisplayStats(e)}setFps(e){0<e&&(this._fps=e,this._state===PlayState.Play)&&(cc_1.game.frameRate=e)}isPause(){return this._state===PlayState.Pause}async pause(e){e?this._state!==PlayState.Pause&&(cc_1.director.pause(),cc_1.game.pause(),this._state=PlayState.Pause,this.showEditorCamera(),this.firstResume&&(cce.Camera.defaultFocus(null!=(e=null==(e=this._scene)?void 0:e.uuid)?e:""),this.firstResume=!1),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),cce.Engine.resume()):(cc_1.director.resume(),cc_1.game.resume(),this._state=PlayState.Play,this.hideEditorCamera(),e=this._sceneLightOn,scene_view_1.sceneViewManager.setSceneLightOn(!0),this._sceneLightOn=e,cce.Engine.pause())}async step(){cc_1.director.resume(),cc_1.director.tick(1/this._fps),cc_1.director.pause()}async start(e=""){await Editor.Profile.getConfig("scene","console.extend.clearOnPlay.value","global")&&Editor.Message.send("console","clear"),console.debug("start gameview"),this._state=PlayState.Play,cce.Camera.setRulerVisible(!1),this._sceneLightOn=await Editor.Profile.getConfig("scene","scene_view.isSceneLightOn"),scene_view_data_1.sceneViewData.on("is-scene-light-on",e=>{scene_view_data_1.sceneViewData.isGameViewPlaying()||(this._sceneLightOn=e)}),scene_view_1.sceneViewManager.setSceneLightOn(!0),cce.SceneFacadeManager.changeTargetResolution(),this._registerEvent(),this._isNative=await env_1.default.useNativeScene(),this.startSceneJson=await this.getGameScene(e),await cce.SceneFacadeManager.softReloadScene(this.startSceneJson),this.hideEditorCamera(),cc.physics.PhysicsSystem.instance.enable=!0,cce.Engine.pause(),cc_1.director.resume(),cc_1.game.resume();var e=await Editor.Profile.getConfig("scene","game-view.stats"),t=await Editor.Profile.getConfig("scene","game-view.fps");this.setFps(t),this.showState(e)}async stop(){console.debug("stop gameview"),cc.debug.setDisplayStats(!1),cc_1.game.setFrameRate(60),this._state=PlayState.Stop,cce.Selection.clear(),cce.Camera.setRulerVisible(!0),scene_view_1.sceneViewManager.setSceneLightOn(this._sceneLightOn),this._unregisterEvent(),await cce.SceneFacadeManager.saveSceneConfig(),cc.physics.PhysicsSystem.instance.enable=!1,cc_1.game.pause(),cc_1.director.pause(),cce.Engine.stopTick(),message_1.messageManager.broadcast("scene:preview-stop")}hideEditorCamera(){var c;if(this._isNative)cce.NativeScene.redirectTargetWindow("preview");else{var e=null==(e=cc_1.director.getScene())?void 0:e.renderScene,i=null!=(e=null==e?void 0:e.cameras)?e:[];let t=null;for(let e=i.length-1;0<=e;e--){var s,a=i[e];a.node.layer&EDITOR_MASK?(a.enabled=!1,a.changeTargetWindow(null==(c=cc_1.director.root)?void 0:c.tempWindow)):null!=(s=null==(c=(t=a).node)?void 0:c.getComponent(cc.Camera))&&s.targetTexture&&s.targetTexture.window?a.changeTargetWindow(s.targetTexture.window):a.changeTargetWindow(null==(s=cc_1.director.root)?void 0:s.mainWindow)}t&&(t.visibility|=cc_1.Layers.Enum.PROFILER)}}showEditorCamera(){var t;if(!this._isNative){var e=null==(e=cc_1.director.getScene())?void 0:e.renderScene,c=null!=(e=null==e?void 0:e.cameras)?e:[];for(let e=c.length-1;0<=e;e--){var i=c[e];i.node.layer&EDITOR_MASK?(i.enabled=!0,i.changeTargetWindow(null==(t=cc_1.director.root)?void 0:t.mainWindow)):i.changeTargetWindow(null==(t=cc_1.director.root)?void 0:t.tempWindow)}}}setPlatform(e){}onSceneLaunch(e){this._state===PlayState.Play&&(cce.Scene.sendSceneOpenMsg(e,e.uuid,e),this.hideEditorCamera()),this._scene=e}onSceneBeforeLaunch(e){this._scene&&(cce.Scene.sendSceneCloseMsg(this._scene),cce.Selection.clear())}onDirectorEndFrame(){this._updateInspector(),isSceneNative&&cce.Engine.emitUpdate()}_updateInspector(){this._updateInspectorHandler||(this._updateInspectorHandler=setTimeout(()=>{var e;this._updateInspectorHandler=null,this._state===PlayState.Play&&0<(e=cce.Selection.query()).length&&Editor.Message.broadcast("scene:change-node",e[0])},500))}_recordGlobal(){this._windowKeys=Object.keys(window)}_resetGlobal(){for(const e in window)this._windowKeys.includes(e)||delete window[e]}_registerEvent(){cc_1.director.on(cc_1.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc_1.director.on(cc_1.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc_1.director.on(cc_1.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}_unregisterEvent(){cc_1.director.off(cc_1.Director.EVENT_END_FRAME,this._onDirectorEndFrame),cc_1.director.off(cc_1.Director.EVENT_AFTER_SCENE_LAUNCH,this._onSceneLaunch),cc_1.director.off(cc_1.Director.EVENT_BEFORE_SCENE_LAUNCH,this._onSceneBeforeLaunch)}}const preview=new(exports.PreviewPlay=PreviewPlay);exports.default=preview;