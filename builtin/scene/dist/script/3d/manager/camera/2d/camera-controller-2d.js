"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraController2D=void 0;const camera_controller_base_1=__importDefault(require("../camera-controller-base")),utils_1=require("../utils"),transform_tool_data_1=require("../../../../public/gizmos/utils/transform-tool-data"),grid_1=__importDefault(require("../grid")),math_1=__importDefault(require("../../../../utils/math")),tween_1=require("../tween"),cc_1=require("cc"),finite_state_machine_1=__importDefault(require("../../../utils/state-machine/finite-state-machine")),idle_mode_1=require("./mode/idle-mode"),pan_mode_1=require("./mode/pan-mode"),ruler_1=require("./web/ruler"),ruler_2=require("./native/ruler"),window_1=require("../../../../utils/window"),_defaultMargin=5,_lineEnd=1e6,_scales=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,3,4,5];var ModeCommand;!function(e){e.ToIdle="toIdle",e.ToPan="toPan"}(ModeCommand||(ModeCommand={}));class CameraController2D extends camera_controller_base_1.default{constructor(){super(...arguments),this._lineColor=cc.color().fromHEX("#555555"),this._wheelSpeed=6,this._near=1,this._far=1e4}isMoving(){return this._modeFSM.currentState!==this._idleMode}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e}get grid(){return this._grid}init(e){super.init(e),this._size=(0,window_1.getMainWindowSize)(),this._contentRect=new cc_1.Rect(0,0,this._size.width,this._size.height),this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid-2d"),this._gridNode=this._gridMeshComp.node,this._gridNode.active=!1,this._initGrid(),this._initRuler(),this._initMode()}_initMode(){this._idleMode=new idle_mode_1.IdleMode(this,utils_1.CameraMoveMode.IDLE),this._panMode=new pan_mode_1.PanMode(this,utils_1.CameraMoveMode.PAN),this._modeFSM=new finite_state_machine_1.default([this._idleMode,this._panMode]),this._modeFSM.addTransition(this._idleMode,this._panMode,ModeCommand.ToPan).addTransition(this._panMode,this._idleMode,ModeCommand.ToIdle),this._modeFSM.Begin(this._idleMode)}_initRuler(){isSceneNative?this._ruler=new ruler_2.Ruler:this._ruler=new ruler_1.Ruler,this._ruler.init(),this.updateRuler()}updateRuler(){this._ruler.updateTicks(this._grid)}_initGrid(){const e=new grid_1.default(this._size.width,this._size.height),t=[0,1,1],i=[1,0,1];e.setScaleH([5,2],.01,5e3),e.setMappingH(t[0],t[1],t[2]),e.setScaleV([5,2],.01,5e3),e.setMappingV(i[0],i[1],i[2]),e.setAnchor(.5,.5),this._grid=e}updateGrid(){const e=[],t=[],i=[];this._updateGridData(e,t,this._lineColor,_lineEnd);for(let t=0;t<e.length;t+=2)i.push(t/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,e),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,t),utils_1.CameraUtils.updateIB(this._gridMeshComp,i),this.updateRuler()}set active(e){if(this._ruler.show(e),this.updateGrid(),this.showGrid(e),e){this._camera.projection=0;const e=cc.quat();this.node.setWorldRotation(e),this._camera.far=this.far,this._camera.near=this.near,this.onResize()}}_adjustToCenter(e,t=null,i=!1,o){let s=0,r=0,a=0,n=0;t?(s=t.x,r=t.y,a=t.width,n=t.height):(a=this._size.width,n=this._size.height);let h=null!==o&&void 0!==o?o:1;const d=this._size,_=d.width-2*e,l=d.height-2*e;if(!o)if(a<=_&&n<=l)h=1;else{const e=this.fitSize(a,n,_,l);h=this.getSizeScale(e[0],e[1],a,n),a=e[0],n=e[1]}transform_tool_data_1.transformToolData.scale2D=h;const c=((d.width-a)/2-s*h)*this._grid.xDirection,u=((d.height-n)/2-r*h)*this._grid.yDirection;this._grid.xAxisSync(c,h),this._grid.yAxisSync(u,h),this.updateGrid(),this.adjustCamera(i),this._contentRect.width=a,this._contentRect.height=n}adjustCamera(e=!0){const t=transform_tool_data_1.transformToolData.scale2D,i=this._grid,o=i.xDirection*i.xAxisOffset,s=i.yDirection*i.yAxisOffset,r=cc.v3(this._size.width/2/t-o/t,this._size.height/2/t-s/t,5e3);if(this._contentRect.x=((this._size.width-this._contentRect.width)/2-i.xAxisOffset/i.xDirection)/t,this._contentRect.y=((this._size.height-this._contentRect.height)/2-i.yAxisOffset/i.yDirection)/t,e)this.node.setWorldPosition(r),this._updateOrthoHeight(t),cce.Engine.repaintInEditMode();else{const e=this.node.getWorldPosition();(0,tween_1.tweenPosition)(e,r,200).step(e=>{this.node.setWorldPosition(e),this._updateOrthoHeight(t),cce.Engine.repaintInEditMode()})}}_updateGridData(e,t,i,o){const s=this._grid;if(s.updateRange(),s.hTicks)for(let r=s.hTicks.minTickLevel;r<=s.hTicks.maxTickLevel;r++){const a=s.hTicks.tickRatios[r];if(a>0){const n=i.clone();n.a=255*a;const h=s.hTicks.ticksAtLevel(r,!0);for(let i=0;i<h.length;i++){const s=h[i];e.push(s,-o),e.push(s,o),t.push(n.x,n.y,n.z,n.w),t.push(n.x,n.y,n.z,n.w)}}}if(s.vTicks)for(let r=s.vTicks.minTickLevel;r<=s.vTicks.maxTickLevel;r++){const a=s.vTicks.tickRatios[r];if(a>0){const n=i.clone();n.a=255*a;const h=s.vTicks.ticksAtLevel(r,!0);for(let i=0;i<h.length;i++){const s=h[i];e.push(-o,s),e.push(o,s),t.push(n.x,n.y,n.z,n.w),t.push(n.x,n.y,n.z,n.w)}}}}_updateOrthoHeight(e){this._camera.orthoHeight=this._size.height/2/e}focus(e,t,i=!1){let o=null,s=-1e10,r=-1e10,a=1e10,n=1e10;const{contentRect:h,scale:d}=t||{};h?o=(0,cc_1.rect)(h.x,h.y,h.width,h.height):e&&(e.forEach(e=>{const t=cce.Node.query(e);if(!t)return void console.error(`Node with UUID ${e} is not exist!`);const i=t.getComponent(cc_1.UITransform);if(i){const e=i.getBoundingBoxToWorld();s=Math.max(e.xMax,s),r=Math.max(e.yMax,r),a=Math.min(e.xMin,a),n=Math.min(e.yMin,n)}else{const e=t.getWorldPosition();s=Math.max(e.x,s),r=Math.max(e.y,r),a=Math.min(e.x,a),n=Math.min(e.y,n)}}),o=cc.rect(a,n,s-a,r-n)),this._adjustToCenter(_defaultMargin,o,i,d)}smoothScale(e,t){let i=e;return i=Math.pow(2,.002*t)*i}fitSize(e,t,i,o){let s=0,r=0;return e>i&&t>o?(s=i,(r=t*i/e)>o&&(r=o,s=e*o/t)):e>i?(s=i,r=t*i/e):t>o?(s=e*o/t,r=o):(s=e,r=t),[s,r]}getSizeScale(e,t,i,o){const s=i<=0?1:e/i,r=o<=0?1:t/o;return Math.max(s,r)}scale(e,t,i){let o=this.smoothScale(transform_tool_data_1.transformToolData.scale2D,e*this.wheelSpeed);o=math_1.default.clamp(o,this._grid.hTicks.minValueScale,this._grid.hTicks.maxValueScale),this._grid.xAxisScaleAt(t,o),this._grid.yAxisScaleAt(i,o),transform_tool_data_1.transformToolData.scale2D=o,this.updateGrid(),this.adjustCamera()}onMouseDown(e){return e.middleButton||e.rightButton?(this._modeFSM.issueCommand(ModeCommand.ToPan),!1):this._modeFSM.currentState.onMouseDown(e)}onMouseMove(e){return this._modeFSM.currentState.onMouseMove(e)}onMouseUp(e){return this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN?(this._modeFSM.issueCommand(ModeCommand.ToIdle),!1):this._modeFSM.currentState.onMouseUp(e)}onMouseWheel(e){this.scale(e.wheelDeltaY*this._wheelBaseScale,e.x,e.y)}onKeyDown(e){switch(e.key.toLowerCase()){case" ":this._modeFSM.issueCommand(ModeCommand.ToPan)}}onKeyUp(e){switch(e.key.toLowerCase()){case" ":this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this._modeFSM.issueCommand(ModeCommand.ToIdle)}}onUpdate(e){}onDesignResolutionChange(){this._adjustToCenter(_defaultMargin,null,!0)}onResize(e){null!==e&&void 0!==e||(e=(0,window_1.getMainWindowSize)()),this._size=e,this._grid.resize(e.width,e.height),this._ruler.resize(e.width,e.height),this.updateGrid(),this.adjustCamera()}refresh(){this.updateGrid(),this.adjustCamera()}zoomTo(e,t,i){t=void 0!==t?t:this._size.width/2,i=void 0!==i?i:this._size.height/2,this._grid.xAxisScaleAt(t,e),this._grid.yAxisScaleAt(i,e),transform_tool_data_1.transformToolData.scale2D=e,this.updateGrid(),this.adjustCamera()}zoomUp(){this.zoomTo(1.5*transform_tool_data_1.transformToolData.scale2D)}zoomDown(){this.zoomTo(transform_tool_data_1.transformToolData.scale2D/1.5)}zoomReset(){this.zoomTo(1)}get contentRect(){return this._contentRect}}exports.CameraController2D=CameraController2D;