"use strict";var ModeCommand,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraController2D=void 0;const camera_controller_base_1=__importDefault(require("../camera-controller-base")),utils_1=require("../utils"),grid_1=__importDefault(require("../grid")),math_1=__importDefault(require("../../../../utils/math")),tween_1=require("../tween"),cc_1=require("cc"),finite_state_machine_1=__importDefault(require("../../../utils/state-machine/finite-state-machine")),idle_mode_1=require("./mode/idle-mode"),pan_mode_1=require("./mode/pan-mode"),ruler_1=require("./web/ruler"),ruler_2=require("./native/ruler"),window_1=require("../../../../utils/window"),_defaultMarginPercentage=30,_scales=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,3,4,5];!function(e){e.ToIdle="toIdle",e.ToPan="toPan"}(ModeCommand=ModeCommand||{});class CameraController2D extends camera_controller_base_1.default{_size;_modeFSM;_idleMode;_panMode;_lineColor=cc.color().fromHEX("#555555");_grid;_ruler;_contentRect;isMoving(){return this._modeFSM.currentState!==this._idleMode}_wheelSpeed=6;_near=1;_far=1e4;get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e}get grid(){return this._grid}showGrid(e){super.showGrid(e),this._originAxisHorizontalMeshComp.node.active=e}init(e){super.init(e),this._size=(0,window_1.getMainWindowSize)(),this._contentRect=new cc_1.Rect(0,0,this._size.width,this._size.height),this._gridMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid-2d"),this._gridMeshComp.node.active=!1,this._initGrid(),this._initRuler(),this._initMode(),this.initOriginAxis()}_initMode(){this._idleMode=new idle_mode_1.IdleMode(this,utils_1.CameraMoveMode.IDLE),this._panMode=new pan_mode_1.PanMode(this,utils_1.CameraMoveMode.PAN),this._modeFSM=new finite_state_machine_1.default([this._idleMode,this._panMode]),this._modeFSM.addTransition(this._idleMode,this._panMode,ModeCommand.ToPan).addTransition(this._panMode,this._idleMode,ModeCommand.ToIdle),this._modeFSM.Begin(this._idleMode)}_initRuler(){isSceneNative?this._ruler=new ruler_2.Ruler:this._ruler=new ruler_1.Ruler,this._ruler.init(),this.updateRuler()}updateRuler(){this._ruler.updateTicks(this._grid)}_initGrid(){var e=new grid_1.default(this._size.width,this._size.height),i=[0,1,1],t=[1,0,1];e.setScaleH([5,2],.01,5e3),e.setMappingH(i[0],i[1],i[2]),e.setScaleV([5,2],.01,5e3),e.setMappingV(t[0],t[1],t[2]),e.setAnchor(.5,.5),this._grid=e}updateGrid(){var i=[],e=[],t=[];this._updateGridData(i,e,this._lineColor);for(let e=0;e<i.length;e+=2)t.push(e/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,i),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,e),utils_1.CameraUtils.updateIB(this._gridMeshComp,t),this.updateRuler(),this.updateOriginAxis()}set active(e){this._ruler.show(e),this.updateGrid(),this.showGrid(e),e&&(this._camera.projection=0,e=cc.quat(),this.node.setWorldRotation(e),this._camera.far=this.far,this._camera.near=this.near,this.onResize())}_adjustToCenter(e,i=null,t=!1,s){let o=0,r=0,a=0,n=0,h=(n=(i?(o=i.x,r=i.y,a=i.width,i):(a=this._size.width,this._size)).height,s??1);var d=this._size,l=e/100*d.width,e=e/100*d.height,l=d.width-l,e=d.height-e,l=(s||(a<=l&&n<=e?0===a||0===a?h=1:(s=a/n,h=l/e<s?l/a:e/n,a*=h,n*=h):(s=this.fitSize(a,n,l,e),h=this.getSizeScale(s[0],s[1],a,n),a=s[0],n=s[1])),cce.Gizmo.transformToolData.scale2D=h,((d.width-a)/2-o*h)*this._grid.xDirection),e=((d.height-n)/2-r*h)*this._grid.yDirection;this._grid.xAxisSync(l,h),this._grid.yAxisSync(e,h),this.updateGrid(),this.adjustCamera(t),i&&(this._contentRect.x=o,this._contentRect.y=r,this._contentRect.width=a,this._contentRect.height=n)}adjustCamera(e=!0){const i=cce.Gizmo.transformToolData.scale2D;var t=this._grid,s=t.xDirection*t.xAxisOffset,o=t.yDirection*t.yAxisOffset,s=cc.v3(this._size.width/2/i-s/i,this._size.height/2/i-o/i,5e3);this._contentRect.x=((this._size.width-this._contentRect.width)/2-t.xAxisOffset/t.xDirection)/i,this._contentRect.y=((this._size.height-this._contentRect.height)/2-t.yAxisOffset/t.yDirection)/i,this._contentRect.width=this._size.width,this._contentRect.height=this._size.height,e?(this.node.setWorldPosition(s),this._updateOrthoHeight(i),cce.Engine.repaintInEditMode()):(o=this.node.getWorldPosition(),(0,tween_1.tweenPosition)(o,s,200).step(e=>{this.node.setWorldPosition(e),this._updateOrthoHeight(i),cce.Engine.repaintInEditMode()}))}_updateGridData(i,t,s){var o=this._grid;if(o.updateRange(),o.hTicks){var{top:e,bottom:r}=o,a=Math.fround(Math.min(e,r))-100,n=Math.fround(Math.max(e,r))+100;for(let e=o.hTicks.minTickLevel;e<=o.hTicks.maxTickLevel;e++){var h=o.hTicks.tickRatios[e];if(0<h){var d=s.clone(),l=(d.a=255*h,o.hTicks.ticksAtLevel(e,!0));for(let e=0;e<l.length;e++){var _=l[e];this.originAxisY_Visible&&0===_||(i.push(_,a),i.push(_,n),t.push(d.x,d.y,d.z,d.w),t.push(d.x,d.y,d.z,d.w))}}}}if(o.vTicks){var{left:e,right:r}=o,c=Math.fround(Math.min(e,r))-100,u=Math.fround(Math.max(e,r))+100;for(let e=o.vTicks.minTickLevel;e<=o.vTicks.maxTickLevel;e++){var m=o.vTicks.tickRatios[e];if(0<m){var g=s.clone(),M=(g.a=255*m,o.vTicks.ticksAtLevel(e,!0));for(let e=0;e<M.length;e++){var p=M[e];this.originAxisX_Visible&&0===p||(i.push(c,p),i.push(u,p),t.push(g.x,g.y,g.z,g.w),t.push(g.x,g.y,g.z,g.w))}}}}}_updateOrthoHeight(e){this._camera.orthoHeight=this._size.height/2/e}focus(e,i,t=!1){let s=null,o=-1e10,r=-1e10,a=1e10,n=1e10;var{contentRect:i,scale:h}=i||{};i?s=(0,cc_1.rect)(i.x,i.y,i.width,i.height):e&&(e.forEach(e=>{var i,t=cce.Node.query(e);t?(i=t.getComponent(cc_1.UITransform))?(i=i.getBoundingBoxToWorld(),o=Math.max(i.xMax,o),r=Math.max(i.yMax,r),a=Math.min(i.xMin,a),n=Math.min(i.yMin,n)):(i=t.getComponent(cc_1.MeshRenderer)||t.getComponent(cc_1.SpriteRenderer))&&i.model&&i.model.worldBounds?(i=i.model.worldBounds,a=Math.min(a,i.center.x-i.halfExtents.x),n=Math.min(n,i.center.y-i.halfExtents.y),o=Math.max(o,i.center.x+i.halfExtents.x),r=Math.max(r,i.center.y+i.halfExtents.y)):(i=t.getWorldPosition(),o=Math.max(i.x,o),r=Math.max(i.y,r),a=Math.min(i.x,a),n=Math.min(i.y,n)):console.error(`Node with UUID ${e} is not exist!`)}),s=cc.rect(a,n,o-a,r-n)),this._adjustToCenter(_defaultMarginPercentage,s,t,h)}smoothScale(e,i){return Math.pow(2,.002*i)*e}fitSize(e,i,t,s){let o=0,r=0;return t<e&&s<i?(o=t,(r=i*t/e)>s&&(r=s,o=e*s/i)):r=t<e?i*(o=t)/e:s<i?(o=e*s/i,s):(o=e,i),[o,r]}getSizeScale(e,i,t,s){return Math.max(t<=0?1:e/t,s<=0?1:i/s)}scale(e,i,t){e=this.smoothScale(cce.Gizmo.transformToolData.scale2D,e*this.wheelSpeed),e=math_1.default.clamp(e,this._grid.hTicks.minValueScale,this._grid.hTicks.maxValueScale);this._grid.xAxisScaleAt(i,e),this._grid.yAxisScaleAt(t,e),cce.Gizmo.transformToolData.scale2D=e,this.updateGrid(),this.adjustCamera()}onMouseDBlDown(e){return this._modeFSM.currentState.onMouseDBlDown(e)}onMouseDown(e){var i=cce.SceneFacadeManager.queryIsViewMode();return e.middleButton||e.rightButton||i?(this._modeFSM.issueCommand(ModeCommand.ToPan),!1):this._modeFSM.currentState.onMouseDown(e)}onMouseMove(e){return this._modeFSM.currentState.onMouseMove(e)}onMouseUp(e){return this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN?(this._modeFSM.issueCommand(ModeCommand.ToIdle),!1):this._modeFSM.currentState.onMouseUp(e)}onMouseWheel(e){this.scale(e.wheelDeltaY*this._wheelBaseScale,e.x,e.y)}onKeyDown(e){" "===e.key.toLowerCase()&&this._modeFSM.issueCommand(ModeCommand.ToPan)}onKeyUp(e){" "===e.key.toLowerCase()&&this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this._modeFSM.issueCommand(ModeCommand.ToIdle)}onUpdate(e){}onDesignResolutionChange(){}onResize(e){e??=(0,window_1.getMainWindowSize)(),this._size=e,this._grid.resize(e.width,e.height),this._ruler.resize(e.width,e.height),this.updateGrid(),this.adjustCamera()}refresh(){this.updateGrid(),this.adjustCamera()}zoomTo(e,i,t){i=void 0!==i?i:this._size.width/2,t=void 0!==t?t:this._size.height/2,this._grid.xAxisScaleAt(i,e),this._grid.yAxisScaleAt(t,e),cce.Gizmo.transformToolData.scale2D=e,this.updateGrid(),this.adjustCamera()}zoomUp(){this.zoomTo(1.5*cce.Gizmo.transformToolData.scale2D)}zoomDown(){this.zoomTo(cce.Gizmo.transformToolData.scale2D/1.5)}zoomReset(){this.zoomTo(1)}get contentRect(){return this._contentRect}initOriginAxis(){Editor.Profile.getConfig("scene","gizmos-infos").then(e=>{this._originAxisHorizontalMeshComp=utils_1.CameraUtils.createGrid("internal/editor/grid-2d"),this.updateOriginAxisByConfig(e.originAxis2D,!1);Editor.Profile.__protected__.on("change",(e,i,t,s)=>{"packages/scene.json"===i&&"gizmos-infos.originAxis2D"===t&&(this.updateOriginAxisByConfig(s,!1),this.updateGrid())})})}updateOriginAxisByConfig(e,i=!0){this.originAxisX_Visible=e.x_visible,this.originAxisY_Visible=e.y_visible,this._originAxisHorizontalMeshComp.node.active=this.originAxisX_Visible||this.originAxisY_Visible,i&&this.updateOriginAxis(),cce.Engine.repaintInEditMode()}updateOriginAxis(){var i=[],t=[],s=[];if(this.originAxisX_Visible){var{left:e,right:o}=this._grid,r=Math.fround(Math.min(e,o))-100,e=Math.fround(Math.max(e,o))+100,a=(i.push(r,0),i.push(e,0),this.originAxisX_Color);for(let e=0;e<2;e++)t.push(a.x,a.y,a.z,a.w)}if(this.originAxisY_Visible){var{top:o,bottom:r}=this._grid,e=Math.fround(Math.min(o,r))-100,o=Math.fround(Math.max(o,r))+100,n=(i.push(0,e),i.push(0,o),this.originAxisY_Color);for(let e=0;e<2;e++)t.push(n.x,n.y,n.z,n.w)}if(0<i.length){for(let e=0;e<i.length;e+=2)s.push(e/2);utils_1.CameraUtils.updateVBAttr(this._originAxisHorizontalMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,i),utils_1.CameraUtils.updateVBAttr(this._originAxisHorizontalMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,t),utils_1.CameraUtils.updateIB(this._originAxisHorizontalMeshComp,s)}cce.Engine.repaintInEditMode()}}exports.CameraController2D=CameraController2D;