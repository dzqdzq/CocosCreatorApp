"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraController2D=void 0;const camera_controller_base_1=__importDefault(require("../camera-controller-base")),utils_1=require("../utils"),transform_tool_data_1=require("../../../../public/gizmos/utils/transform-tool-data"),grid_1=__importDefault(require("../grid")),math_1=__importDefault(require("../../../../utils/math")),node_1=__importDefault(require("../../node")),tween_1=require("../tween"),cc_1=require("cc"),finite_state_machine_1=__importDefault(require("../../../utils/state-machine/finite-state-machine")),idle_mode_1=require("./mode/idle-mode"),pan_mode_1=require("./mode/pan-mode"),_defaultMargin=5,_lineEnd=1e6;let _scales=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,3,4,5];var ModeCommand;!function(e){e.ToIdle="toIdle",e.ToPan="toPan"}(ModeCommand||(ModeCommand={}));class CameraController2D extends camera_controller_base_1.default{constructor(){super(...arguments),this._lineColor=cc.color().fromHEX("#555555"),this._wheelSpeed=6,this._near=1,this._far=1e4}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e}get grid(){return this._grid}init(e){super.init(e),this._gridMeshComp=utils_1.CameraUtils.createGrid("editor/grid-2d"),this._gridNode=this._gridMeshComp.node,this._gridNode.active=!1,this._initGrid(),this._initRuler(),this._initMode()}_initMode(){this._idleMode=new idle_mode_1.IdleMode(this,utils_1.CameraMoveMode.IDLE),this._panMode=new pan_mode_1.PanMode(this,utils_1.CameraMoveMode.PAN),this._modeFSM=new finite_state_machine_1.default([this._idleMode,this._panMode]),this._modeFSM.addTransition(this._idleMode,this._panMode,ModeCommand.ToPan).addTransition(this._panMode,this._idleMode,ModeCommand.ToIdle),this._modeFSM.Begin(this._idleMode)}valueToPixelH(e){return e*this._grid.xAxisScale+this._grid.xAxisOffset}valueToPixelV(e){let{height:t}=cc.screen.windowSize;return-e*this._grid.yAxisScale+t+this._grid.yAxisOffset}_initRuler(){const e=document.querySelector("#hLabels"),t=document.querySelector("#vLabels");this.hRulerCanvas=e,this.vRulerCanvas=t,this.hRulerCtx=this.hRulerCanvas.getContext("2d"),this.vRulerCtx=this.vRulerCanvas.getContext("2d"),this.rulerlen=35;let{width:i,height:s}=cc.screen.windowSize;this.hRulerCanvas.width=i,this.hRulerCanvas.height=this.rulerlen,this.vRulerCanvas.width=this.rulerlen,this.vRulerCanvas.height=s,this.updateRuler()}updateRuler(){let{width:e,height:t}=cc.screen.windowSize;if(this.hRulerCtx.clearRect(0,0,e,this.rulerlen),this.vRulerCtx.clearRect(0,0,this.rulerlen,t),!this.isShowRuler)return;let i=this._grid.hTicks.levelForStep(50),s=this._grid.hTicks.ticksAtLevel(i,!1);this.hRulerCtx.beginPath(),s.forEach((e,t)=>{e=Math.floor(10*e)/10;let i=Math.floor(this.valueToPixelH(e))+5;this.hRulerCtx.font="10px Arial",this.hRulerCtx.fillStyle="gray",this.hRulerCtx.fillText(e,i,20)}),this.hRulerCtx.closePath();let a=this._grid.vTicks.levelForStep(50),o=this._grid.vTicks.ticksAtLevel(a,!1);this.vRulerCtx.beginPath(),o.forEach((e,t)=>{e=Math.floor(10*e)/10;let i=Math.floor(this.valueToPixelV(e))-5;this.vRulerCtx.font="10px Arial",this.vRulerCtx.fillStyle="gray",this.vRulerCtx.fillText(e,0,i)}),this.vRulerCtx.closePath()}_initGrid(){let e=cc.screen.windowSize,t=new grid_1.default(e.width,e.height),i=[0,1,1],s=[1,0,1];t.setScaleH([5,2],.01,5e3),t.setMappingH(i[0],i[1],i[2]),t.setScaleV([5,2],.01,5e3),t.setMappingV(s[0],s[1],s[2]),t.setAnchor(.5,.5),this._grid=t}updateGrid(){let e=[],t=[],i=[];this._updateGridData(e,t,this._lineColor,_lineEnd);for(let t=0;t<e.length;t+=2)i.push(t/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,e),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,t),utils_1.CameraUtils.updateIB(this._gridMeshComp,i),this.updateRuler()}set active(e){if(this.isShowRuler=e,this.updateGrid(),this.showGrid(e),e){this._camera.projection=0;let e=cc.quat();this.node.setWorldRotation(e),this._camera.far=this.far,this._camera.near=this.near,this.onResize(),this._adjustToCenter(_defaultMargin,null,!0)}}_adjustToCenter(e,t=null,i=!1){let s=0,a=0,o=0,r=0;if(t)s=t.x,a=t.y,o=t.width,r=t.height;else{let e=cc.view.getDesignResolutionSize();o=e.width,r=e.height}let l=1,h=cc.screen.windowSize,n=h.width-2*e,d=h.height-2*e;if(o<=n&&r<=d)l=1;else{let e=this.fitSize(o,r,n,d);l=this.getSizeScale(e[0],e[1],o,r),o=e[0],r=e[1]}transform_tool_data_1.transformToolData.scale2D=l;let c=((h.width-o)/2-s*l)*this._grid.xDirection,u=((h.height-r)/2-a*l)*this._grid.yDirection;this._grid.xAxisSync(c,l),this._grid.yAxisSync(u,l),this.updateGrid(),this.adjustCamera(i)}adjustCamera(e=!0){let t=transform_tool_data_1.transformToolData.scale2D,i=this._grid.xDirection*this._grid.xAxisOffset,s=this._grid.yDirection*this._grid.yAxisOffset,a=cc.v3(cc.game.canvas.width/2/t-i/t,cc.game.canvas.height/2/t-s/t,5e3);if(e)this.node.setWorldPosition(a),cce.Engine.repaintInEditMode();else{const e=this.node.getPosition();tween_1.tweenPosition(e,a,200).step(e=>{this.node.setWorldPosition(e),cce.Engine.repaintInEditMode()})}this._updateOrthoHeight(t)}_updateGridData(e,t,i,s){let a=this._grid;if(a.updateRange(),a.hTicks)for(let o=a.hTicks.minTickLevel;o<=a.hTicks.maxTickLevel;o++){let r=a.hTicks.tickRatios[o];if(r>0){let l=i.clone();l.a=255*r;let h=a.hTicks.ticksAtLevel(o,!0);for(let i=0;i<h.length;i++){let a=h[i];e.push(a,-s),e.push(a,s),t.push(l.x,l.y,l.z,l.w),t.push(l.x,l.y,l.z,l.w)}}}if(a.vTicks)for(let o=a.vTicks.minTickLevel;o<=a.vTicks.maxTickLevel;o++){let r=a.vTicks.tickRatios[o];if(r>0){let l=i.clone();l.a=255*r;let h=a.vTicks.ticksAtLevel(o,!0);for(let i=0;i<h.length;i++){let a=h[i];e.push(-s,a),e.push(s,a),t.push(l.x,l.y,l.z,l.w),t.push(l.x,l.y,l.z,l.w)}}}}_updateOrthoHeight(e){this._camera.orthoHeight=cc.game.canvas.height/2/e}focus(e,t,i,s,a=!1){let o,r=-1e10,l=-1e10,h=1e10,n=1e10;e&&(e.forEach(e=>{let t=node_1.default.query(e),i=t.getComponent(cc_1.UITransform);if(i){let e=i.getBoundingBoxToWorld();r=Math.max(e.xMax,r),l=Math.max(e.yMax,l),h=Math.min(e.xMin,h),n=Math.min(e.yMin,n)}else{let e=t.getWorldPosition();r=Math.max(e.x,r),l=Math.max(e.y,l),h=Math.min(e.x,h),n=Math.min(e.y,n)}}),o=cc.rect(h,n,r-h,l-n)),this._adjustToCenter(_defaultMargin,o,a)}smoothScale(e,t){let i=e;return i=Math.pow(2,.002*t)*i}fitSize(e,t,i,s){let a=0,o=0;return e>i&&t>s?(a=i,(o=t*i/e)>s&&(o=s,a=e*s/t)):e>i?(a=i,o=t*i/e):t>s?(a=e*s/t,o=s):(a=e,o=t),[a,o]}getSizeScale(e,t,i,s){let a=i<=0?1:e/i,o=s<=0?1:t/s;return Math.max(a,o)}scale(e,t,i){let s=this.smoothScale(transform_tool_data_1.transformToolData.scale2D,e*this.wheelSpeed);s=math_1.default.clamp(s,this._grid.hTicks.minValueScale,this._grid.hTicks.maxValueScale),this._grid.xAxisScaleAt(t,s),this._grid.yAxisScaleAt(i,s),transform_tool_data_1.transformToolData.scale2D=s,this.updateGrid(),this.adjustCamera()}onMouseDown(e){return e.middleButton||e.rightButton?(this._modeFSM.issueCommand(ModeCommand.ToPan),!1):this._modeFSM.currentState.onMouseDown(e)}onMouseMove(e){return this._modeFSM.currentState.onMouseMove(e)}onMouseUp(e){return this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN?(this._modeFSM.issueCommand(ModeCommand.ToIdle),!1):this._modeFSM.currentState.onMouseUp(e)}onMouseWheel(e){this.scale(e.wheelDeltaY/12,e.x,e.y)}onKeyDown(e){switch(e.key.toLowerCase()){case" ":this._modeFSM.issueCommand(ModeCommand.ToPan)}}onKeyUp(e){switch(e.key.toLowerCase()){case" ":this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this._modeFSM.issueCommand(ModeCommand.ToIdle)}}onUpdate(e){}onDesignResolutionChange(){this._adjustToCenter(_defaultMargin,null,!0)}onResize(){this._grid.resize(cc.game.canvas.width,cc.game.canvas.height);let{width:e,height:t}=cc.screen.windowSize;this.hRulerCanvas.width=e,this.hRulerCanvas.height=this.rulerlen,this.vRulerCanvas.width=this.rulerlen,this.vRulerCanvas.height=t,this.updateGrid(),this.adjustCamera()}refresh(){this.updateGrid(),this.adjustCamera()}zoomTo(e,t,i){t=void 0!==t?t:cc.game.canvas.width/2,i=void 0!==i?i:cc.game.canvas.height/2,this._grid.xAxisScaleAt(t,e),this._grid.yAxisScaleAt(i,e),transform_tool_data_1.transformToolData.scale2D=e,this.updateGrid(),this.adjustCamera()}zoomUp(){let e=transform_tool_data_1.transformToolData.scale2D;for(let t=0;t<_scales.length;t++)if(e<_scales[t])return this.zoomTo(_scales[t])}zoomDown(){let e=transform_tool_data_1.transformToolData.scale2D;for(let t=_scales.length-1;t>=0;t--)if(e>_scales[t])return this.zoomTo(_scales[t])}zoomReset(){this.zoomTo(1)}}exports.CameraController2D=CameraController2D;