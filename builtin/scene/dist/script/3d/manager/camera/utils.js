"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraUtils=exports.CameraMoveMode=void 0;const cc_1=require("cc"),editor_camera_components_1=__importDefault(require("./editor-camera-components")),node_1=__importDefault(require("../node")),path_1=require("path"),_maxTicks=100,vbMap=new Map,ibMap=new Map;class Utils{constructor(){this.$cameraMoveInfo=this._createHtml({rootID:"cameraInfo",innerHTML:'\n            <style>\n                #cameraInfo { \n                    position: absolute;\n                    bottom: 10px;\n                    left: 10px;\n                    text-align: center;\n                }\n                #cameraInfo #wasd {\n                    width: 104px;\n                    height: 52px;\n                }\n            </style>\n            <img id="wasd"/>\n            ',imgInfos:[{selector:"#wasd",src:`file://${(0,path_1.join)(__dirname,"../../../../../static/icons/wasd.png")}`}]}).root;const e=this._createHtml({rootID:"snapInfo",innerHTML:'\n            <style>    \n                #snapInfo { \n                    position: absolute;\n                    bottom: 10px;\n                    left: 10px;\n                }\n            </style>\n            <img class="snap" width="215px" height="66px" id="snapInfoEN">\n            <img class="snap" width="162px" height="66px" id="snapInfoZH">\n            ',imgInfos:[{selector:"#snapInfoEN",src:`file://${(0,path_1.join)(__dirname,"../../../../../static/icons/snap-ui-en.png")}`},{selector:"#snapInfoZH",src:`file://${(0,path_1.join)(__dirname,"../../../../../static/icons/snap-ui-zh.png")}`}]});this.$snapInfoEN=e.imgs[0],this.$snapInfoZH=e.imgs[1],this.$snapInfoRoot=e.root}_createHtml(e){const t=document.createElement("div");let n;if(t.hidden=!0,t.id=e.rootID,t.innerHTML=e.innerHTML,e.imgInfos){n=[];for(let o=0;o<e.imgInfos.length;o++){const s=e.imgInfos[o],r=t.querySelector(s.selector);r.onerror=(e=>{console.error(e)}),r.src=s.src,n.push(r)}}return document.body.appendChild(t),{imgs:n,root:t}}updateSnapInfoUI(){"zh"===Editor.I18n.getLanguage()?(this.$snapInfoEN.hidden=!0,this.$snapInfoZH.hidden=!1):(this.$snapInfoZH.hidden=!0,this.$snapInfoEN.hidden=!1)}showSnapTip(){this.$snapInfoRoot.hidden=!1,this.updateSnapInfoUI()}hideSnapTip(){this.$snapInfoRoot.hidden=!0}showCameraMoveTip(){this.$cameraMoveInfo.hidden=!1}hideCameraMoveTip(){this.$cameraMoveInfo.hidden=!0}updateVBAttr(e,t,n){const o=e&&e.model&&e.model.subModels[0];if(!o||!o.inputAssembler||!o.subMesh)return;const{inputAssembler:s,subMesh:r}=o,i=vbMap.get(r);if(!i)return void console.error(r,i);let a=0,c=cc_1.gfx.Format.UNKNOWN;for(const e of s.attributes){if(e.name===t){c=e.format;break}a+=cc_1.gfx.FormatInfos[e.format].size}const d=s.vertexBuffers[0];c&&d&&(cc_1.utils.writeBuffer(new DataView(i),n,c,a,d.stride),d.update(i,d.stride*d.count),r.geometricInfo&&r.geometricInfo.positions.set(n))}updateIB(e,t){const n=e&&e.model&&e.model.subModels[0];if(!n||!n.inputAssembler||!n.subMesh)return;const{inputAssembler:o,subMesh:s}=n,r=ibMap.get(s);if(!r)return void console.error(s,r);const i=o.indexCount,a=o.indexBuffer;if(!i||!a)return;const c=cc_1.gfx.Format[`R${8*a.stride}UI`];cc_1.utils.writeBuffer(new DataView(r),t,c),a.update(r,a.stride*a.count),o.indexCount=t.length}grid(e,t,n,o){const s=[],r=[],i=[],a=.5*e,c=.5*t,d=e/n,u=t/o,p=cc.v3(-a,-.1,-c),l=cc.v3(a,.1,c);function f(e,t,n,o){const a=s.length/3;e===n?(s.push(e+.01,0,t),r.push(1,0),s.push(e-.01,0,t),r.push(0,0),s.push(e+.01,0,o),r.push(1,0),s.push(e-.01,0,o),r.push(0,0)):(s.push(e,0,t-.01),r.push(0,1),s.push(e,0,t+.01),r.push(1,1),s.push(n,0,t-.01),r.push(0,1),s.push(n,0,t+.01),r.push(1,1)),i.push(a,a+1,a+2,a+2,a+1,a+3)}for(let e=-a;e<=a;e+=d)f(e,-c,e,c);for(let e=-c;e<=c;e+=u)f(-a,e,a,e);return{positions:s,uvs:r,indices:i,minPos:p,maxPos:l}}createStrokeGrid(e,t){const n=new cc.Node("Editor Grid");n.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,n.parent=cce.backgroundNode;const o=n.addComponent(cc_1.MeshRenderer);o.mesh=cc_1.utils.createMesh(this.grid(e,t,e,t));const s=o.onEnable.bind(o);o.onEnable=(()=>{s()});const r=new cc.Material;return r.initialize({effectName:"internal/editor/grid-stroke"}),o.material=r,o}createGrid(e){const t=new cc.Node(e);t.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,t.parent=cce.backgroundNode,t.setWorldPosition(cc.v3(0,0,0));const n=t.addComponent(cc_1.MeshRenderer),o=n.onEnable.bind(n);n.onEnable=(()=>{o()});const s=[],r=[],i=[];for(let e=0;e<_maxTicks*_maxTicks;e++)s.push(0,0),r.push(1,1,1,1);for(let e=0;e<s.length;e+=2)i.push(e/2);const a=cc_1.gfx.PrimitiveMode.LINE_LIST,c=[{name:cc_1.gfx.AttributeName.ATTR_POSITION,format:cc_1.gfx.Format.RG32F}],d=cc.utils.createMesh({positions:s,indices:i,colors:r,primitiveMode:a,attributes:c}),u=d.renderingSubMeshes[0],p=d.struct.vertexBundles[0].view,l=d.data.buffer.slice(p.offset,p.offset+p.length);vbMap.set(u,l);const f=d.struct.primitives[0].indexView,m=d.data.buffer.slice(f.offset,f.offset+f.length);ibMap.set(u,m),n.mesh=d;const h=new cc.Material;return h.initialize({effectName:e,states:{primitive:a}}),n.material=h,n}createCamera(e){const t=new cc.Node("Editor Camera");t.layer=cc.Layers.Enum.EDITOR,t.parent=cce.backgroundNode;const n=t.addComponent(editor_camera_components_1.default);return n.clearFlags=cc_1.Camera.ClearFlag.SKYBOX|cc_1.gfx.ClearFlagBit.COLOR,n.clearColor=e,n.visibility=cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.PROFILER,cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO]),n.far=1e5,n.near=.1,n}queryLightNodes(e){const t=[];return node_1.default.queryUuids().forEach(n=>{const o=node_1.default.query(n);o&&!e.includes(o)&&o.getComponent(cc_1.Light)&&t.push(o)}),t}isSceneHasActiveLight(e){let t=!1;const n=[];return e.forEach(e=>{if(e.active){const o=e.getComponent(cc_1.Light);o?!0===o.enabled&&(t=!0):n.push(e)}}),n.forEach(t=>{const n=e.indexOf(t);e.splice(n,1)}),t}queryComponent(e){const t=[];return node_1.default.queryUuids().forEach(n=>{const o=node_1.default.query(n);if(!o)return;const s=o.getComponent(e);s&&t.push(s)}),t}}var CameraMoveMode;!function(e){e[e.IDLE=0]="IDLE",e[e.ORBIT=1]="ORBIT",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM",e[e.WANDER=4]="WANDER"}(CameraMoveMode||(CameraMoveMode={})),exports.CameraMoveMode=CameraMoveMode;const CameraUtils=new Utils;exports.CameraUtils=CameraUtils;