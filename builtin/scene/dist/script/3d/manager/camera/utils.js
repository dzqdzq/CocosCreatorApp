"use strict";var CameraMoveMode,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraUtils=exports.CameraMoveMode=void 0;const cc_1=require("cc"),editor_camera_components_1=__importDefault(require("./editor-camera-components")),wander_shortcut_1=require("./htmls/wander-shortcut"),snap_shortcut_1=require("./htmls/snap-shortcut"),shortcut_1=require("../shortcut"),wander_speed_tips_1=require("./htmls/wander-speed-tips"),_maxTicks=100,vbMap=new Map,ibMap=new Map,hideTipTime=5e3;class Utils{$wanderSpeedTips=null;$cameraMoveInfo=null;$snapInfoRoot=null;wanderSpeedTipsTimeoutID=null;snapTipsTimeoutID=null;_createHtml(t){var r,s=document.createElement("div");if(s.hidden=t.hidden??!0,s.id=t.rootID,s.innerHTML=t.innerHTML,t.imgInfos){r=[];for(let e=0;e<t.imgInfos.length;e++){var i=t.imgInfos[e],a=s.querySelector(i.selector);a.onerror=e=>{console.error(e)},a.src=i.src,r.push(a)}}return document.body.appendChild(s),s}updateWanderShortcutUI(){var{style:e,script:t}=(0,wander_shortcut_1.createWanderShortcutHtml)();this.$cameraMoveInfo&&this.$cameraMoveInfo.parentNode&&this.$cameraMoveInfo.parentNode.removeChild(this.$cameraMoveInfo),this.$cameraMoveInfo=this._createHtml({rootID:"cameraInfo",hidden:!1,innerHTML:`
                ${e}
            `}),t(this.$cameraMoveInfo,shortcut_1.Shortcut.wanderMap)}updateSnapShortcutUI(){var{style:e,script:t}=(0,snap_shortcut_1.createSnapShortcut)();this.$snapInfoRoot&&this.$snapInfoRoot.parentNode&&this.$snapInfoRoot.parentNode.removeChild(this.$snapInfoRoot),this.$snapInfoRoot=this._createHtml({rootID:"snapInfo",hidden:!1,innerHTML:`
                ${e}
            `}),t(this.$snapInfoRoot,shortcut_1.Shortcut.snapMap)}showSnapTip(){this.$snapInfoRoot&&(this.$snapInfoRoot.hidden=!1),this.updateSnapShortcutUI(),this.snapTipsTimeoutID&&clearTimeout(this.snapTipsTimeoutID),this.snapTipsTimeoutID=setTimeout(()=>{this.hideSnapTip()},hideTipTime)}hideSnapTip(){this.snapTipsTimeoutID&&clearTimeout(this.snapTipsTimeoutID),this.$snapInfoRoot&&(this.$snapInfoRoot.hidden=!0)}showCameraMoveTip(){this.$cameraMoveInfo&&(this.$cameraMoveInfo.hidden=!1),this.updateWanderShortcutUI(),this.wanderSpeedTipsTimeoutID&&clearTimeout(this.wanderSpeedTipsTimeoutID),this.wanderSpeedTipsTimeoutID=setTimeout(()=>{this.hideCameraMoveTip()},hideTipTime)}hideCameraMoveTip(){this.wanderSpeedTipsTimeoutID&&clearTimeout(this.wanderSpeedTipsTimeoutID),this.$cameraMoveInfo&&(this.$cameraMoveInfo.hidden=!0)}clearTimeID=0;showCameraWanderSpeed(e,t){var r,e=`${e.toFixed(2)}x (${t.toFixed(2)})`;this.$wanderSpeedTips||({style:t,script:r}=(0,wander_speed_tips_1.createWanderSpeedTipsHtml)(),t=this._createHtml({rootID:"CameraWanderSpeed",hidden:!1,innerHTML:`
                ${t}
            `}),this.$wanderSpeedTips=r(t,e));const s=this.$wanderSpeedTips.parentElement;s&&(s.hidden=!1,s.classList.remove("hidden"),this.$wanderSpeedTips.setAttribute("value",e),clearTimeout(this.clearTimeID),this.clearTimeID=setTimeout(()=>{s&&(s.classList.add("hidden"),s.hidden=!0)},1e3))}updateVBAttr(r,s,i){r=r&&r.model&&r.model.subModels[0];if(r&&r.inputAssembler&&r.subMesh){var{inputAssembler:r,subMesh:a}=r,o=vbMap.get(a);if(o){let e=0,t=cc_1.gfx.Format.UNKNOWN;for(const n of r.attributes){if(n.name===s){t=n.format;break}e+=cc_1.gfx.FormatInfos[n.format].size}r=r.vertexBuffers[0];t&&r&&(cc_1.utils.writeBuffer(new DataView(o),i,t,e,r.stride),r.update(o,r.stride*r.count),a.geometricInfo)&&a.geometricInfo.positions.set(i)}else console.error(a,o)}}updateIB(e,t){var r,s,i,a,e=e&&e.model&&e.model.subModels[0];e&&e.inputAssembler&&e.subMesh&&({inputAssembler:e,subMesh:r}=e,(s=ibMap.get(r))?(a=e.indexCount,i=e.indexBuffer,a&&i&&(a=cc_1.gfx.Format[`R${8*i.stride}UI`],cc_1.utils.writeBuffer(new DataView(s),t,a),i.update(s,i.stride*i.count),e.indexCount=t.length)):console.error(r,s))}grid(e,t,r,s){const a=[],o=[],n=[];var i=.5*e,c=.5*t,d=e/r,p=t/s,e=cc.v3(-i,-.1,-c),r=cc.v3(i,.1,c);function u(e,t,r,s){var i=a.length/3;e===r?(a.push(e+.01,0,t),o.push(1,0),a.push(e-.01,0,t),o.push(0,0),a.push(e+.01,0,s),o.push(1,0),a.push(e-.01,0,s),o.push(0,0)):(a.push(e,0,t-.01),o.push(0,1),a.push(e,0,t+.01),o.push(1,1),a.push(r,0,t-.01),o.push(0,1),a.push(r,0,t+.01),o.push(1,1)),n.push(i,1+i,2+i,2+i,1+i,3+i)}for(let e=-i;e<=i;e+=d)u(e,-c,e,c);for(let e=-c;e<=c;e+=p)u(-i,e,i,e);return{positions:a,uvs:o,indices:n,minPos:e,maxPos:r}}createStrokeGrid(e,t){var r=new cc.Node("Editor Grid"),r=(r.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,r.parent=cce.backgroundNode,r.addComponent(cc_1.MeshRenderer));r.mesh=cc_1.utils.createMesh(this.grid(e,t,e,t));const s=r.onEnable.bind(r);r.onEnable=()=>{s()};e=new cc.Material;return e.initialize({effectName:"internal/editor/grid-stroke"}),r.material=e,r}createGrid(e){var t=new cc.Node(e),t=(t.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,t.parent=cce.backgroundNode,t.setWorldPosition(cc.v3(0,0,0)),t.addComponent(cc_1.MeshRenderer));const r=t.onEnable.bind(t);t.onEnable=()=>{r()};var s=[],i=[],a=[];for(let e=0;e<_maxTicks*_maxTicks;e++)s.push(0,0),i.push(1,1,1,1);for(let e=0;e<s.length;e+=2)a.push(e/2);var o=cc_1.gfx.PrimitiveMode.LINE_LIST,n=[{name:cc_1.gfx.AttributeName.ATTR_POSITION,format:cc_1.gfx.Format.RG32F}],n=cc.utils.createMesh({positions:s,indices:a,colors:i,primitiveMode:o,attributes:n}),c=n.renderingSubMeshes[0],d=n.struct.vertexBundles[0].view,d=n.data.buffer.slice(d.offset,d.offset+d.length),d=(vbMap.set(c,d),n.struct.primitives[0].indexView),d=n.data.buffer.slice(d.offset,d.offset+d.length),c=(ibMap.set(c,d),t.mesh=n,new cc.Material);return c.initialize({effectName:e,states:{primitive:o}}),t.material=c,t}createCamera(e){var t=new cc.Node("Editor Camera"),t=(t.layer=cc.Layers.Enum.EDITOR,t.parent=cce.backgroundNode,t.addComponent(editor_camera_components_1.default));return t.clearFlags=cc_1.Camera.ClearFlag.SKYBOX|cc_1.gfx.ClearFlagBit.COLOR,t.clearColor=e,t.visibility=cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.PROFILER,cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO]),t.far=1e5,t.near=.1,t}queryLightNodes(t){const r=[];return cce.Node.queryUuids().forEach(e=>{e=cce.Node.query(e);e&&!t.includes(e)&&e.getComponent(cc_1.Light)&&r.push(e)}),r}isSceneHasActiveLight(t){let r=!1;const s=[];return t.forEach(e=>{var t;e.active&&((t=e.getComponent(cc_1.Light))?!0===t.enabled&&(r=!0):s.push(e))}),s.forEach(e=>{e=t.indexOf(e);t.splice(e,1)}),r}queryComponent(t){const r=[];return cce.Node.queryUuids().forEach(e=>{var e=cce.Node.query(e);e&&(e=e.getComponent(t))&&r.push(e)}),r}}!function(e){e[e.IDLE=0]="IDLE",e[e.ORBIT=1]="ORBIT",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM",e[e.WANDER=4]="WANDER"}(CameraMoveMode||(exports.CameraMoveMode=CameraMoveMode={}));const CameraUtils=new Utils;exports.CameraUtils=CameraUtils;