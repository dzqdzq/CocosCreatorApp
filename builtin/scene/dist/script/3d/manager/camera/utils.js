"use strict";var CameraMoveMode,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraUtils=exports.CameraMoveMode=void 0;const cc_1=require("cc"),editor_camera_components_1=__importDefault(require("./editor-camera-components")),wander_shortcut_1=require("./htmls/wander-shortcut"),snap_shortcut_1=require("./htmls/snap-shortcut"),shortcut_1=require("../shortcut"),_maxTicks=100,vbMap=new Map,ibMap=new Map;class Utils{constructor(){this.$cameraMoveInfo=null,this.$snapInfoRoot=null}_createHtml(t){var e,r,o=document.createElement("div");if(o.hidden=null==(e=t.hidden)||e,o.id=t.rootID,o.innerHTML=t.innerHTML,t.imgInfos){r=[];for(let e=0;e<t.imgInfos.length;e++){var a=t.imgInfos[e],s=o.querySelector(a.selector);s.onerror=e=>{console.error(e)},s.src=a.src,r.push(s)}}return document.body.appendChild(o),o}updateWanderShortcutUI(){var{style:e,script:t}=(0,wander_shortcut_1.createWanderShortcutHtml)();this.$cameraMoveInfo&&this.$cameraMoveInfo.parentNode&&this.$cameraMoveInfo.parentNode.removeChild(this.$cameraMoveInfo),this.$cameraMoveInfo=this._createHtml({rootID:"cameraInfo",hidden:!1,innerHTML:`
                ${e}
            `}),t(this.$cameraMoveInfo,shortcut_1.Shortcut.wanderMap)}updateSnapShortcutUI(){var{style:e,script:t}=(0,snap_shortcut_1.createSnapShortcut)();this.$snapInfoRoot&&this.$snapInfoRoot.parentNode&&this.$snapInfoRoot.parentNode.removeChild(this.$snapInfoRoot),this.$snapInfoRoot=this._createHtml({rootID:"snapInfo",hidden:!1,innerHTML:`
                ${e}
            `}),t(this.$snapInfoRoot,shortcut_1.Shortcut.snapMap)}showSnapTip(){this.$snapInfoRoot&&(this.$snapInfoRoot.hidden=!1),this.updateSnapShortcutUI()}hideSnapTip(){this.$snapInfoRoot&&(this.$snapInfoRoot.hidden=!0)}showCameraMoveTip(){this.$cameraMoveInfo&&(this.$cameraMoveInfo.hidden=!1),this.updateWanderShortcutUI()}hideCameraMoveTip(){this.$cameraMoveInfo&&(this.$cameraMoveInfo.hidden=!0)}updateVBAttr(r,o,a){r=r&&r.model&&r.model.subModels[0];if(r&&r.inputAssembler&&r.subMesh){var{inputAssembler:r,subMesh:s}=r,n=vbMap.get(s);if(n){let e=0,t=cc_1.gfx.Format.UNKNOWN;for(const c of r.attributes){if(c.name===o){t=c.format;break}e+=cc_1.gfx.FormatInfos[c.format].size}r=r.vertexBuffers[0];t&&r&&(cc_1.utils.writeBuffer(new DataView(n),a,t,e,r.stride),r.update(n,r.stride*r.count),s.geometricInfo)&&s.geometricInfo.positions.set(a)}else console.error(s,n)}}updateIB(e,t){var r,o,a,s,e=e&&e.model&&e.model.subModels[0];e&&e.inputAssembler&&e.subMesh&&({inputAssembler:e,subMesh:r}=e,(o=ibMap.get(r))?(s=e.indexCount,a=e.indexBuffer,s&&a&&(s=cc_1.gfx.Format[`R${8*a.stride}UI`],cc_1.utils.writeBuffer(new DataView(o),t,s),a.update(o,a.stride*a.count),e.indexCount=t.length)):console.error(r,o))}grid(e,t,r,o){const s=[],n=[],c=[];var a=.5*e,i=.5*t,u=e/r,d=t/o,e=cc.v3(-a,-.1,-i),r=cc.v3(a,.1,i);function h(e,t,r,o){var a=s.length/3;e===r?(s.push(e+.01,0,t),n.push(1,0),s.push(e-.01,0,t),n.push(0,0),s.push(e+.01,0,o),n.push(1,0),s.push(e-.01,0,o),n.push(0,0)):(s.push(e,0,t-.01),n.push(0,1),s.push(e,0,t+.01),n.push(1,1),s.push(r,0,t-.01),n.push(0,1),s.push(r,0,t+.01),n.push(1,1)),c.push(a,1+a,2+a,2+a,1+a,3+a)}for(let e=-a;e<=a;e+=u)h(e,-i,e,i);for(let e=-i;e<=i;e+=d)h(-a,e,a,e);return{positions:s,uvs:n,indices:c,minPos:e,maxPos:r}}createStrokeGrid(e,t){var r=new cc.Node("Editor Grid"),r=(r.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,r.parent=cce.backgroundNode,r.addComponent(cc_1.MeshRenderer));r.mesh=cc_1.utils.createMesh(this.grid(e,t,e,t));const o=r.onEnable.bind(r);r.onEnable=()=>{o()};e=new cc.Material;return e.initialize({effectName:"internal/editor/grid-stroke"}),r.material=e,r}createGrid(e){var t=new cc.Node(e),t=(t.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,t.parent=cce.backgroundNode,t.setWorldPosition(cc.v3(0,0,0)),t.addComponent(cc_1.MeshRenderer));const r=t.onEnable.bind(t);t.onEnable=()=>{r()};var o=[],a=[],s=[];for(let e=0;e<_maxTicks*_maxTicks;e++)o.push(0,0),a.push(1,1,1,1);for(let e=0;e<o.length;e+=2)s.push(e/2);var n=cc_1.gfx.PrimitiveMode.LINE_LIST,c=[{name:cc_1.gfx.AttributeName.ATTR_POSITION,format:cc_1.gfx.Format.RG32F}],c=cc.utils.createMesh({positions:o,indices:s,colors:a,primitiveMode:n,attributes:c}),i=c.renderingSubMeshes[0],u=c.struct.vertexBundles[0].view,u=c.data.buffer.slice(u.offset,u.offset+u.length),u=(vbMap.set(i,u),c.struct.primitives[0].indexView),u=c.data.buffer.slice(u.offset,u.offset+u.length),i=(ibMap.set(i,u),t.mesh=c,new cc.Material);return i.initialize({effectName:e,states:{primitive:n}}),t.material=i,t}createCamera(e){var t=new cc.Node("Editor Camera"),t=(t.layer=cc.Layers.Enum.EDITOR,t.parent=cce.backgroundNode,t.addComponent(editor_camera_components_1.default));return t.clearFlags=cc_1.Camera.ClearFlag.SKYBOX|cc_1.gfx.ClearFlagBit.COLOR,t.clearColor=e,t.visibility=cc_1.Layers.makeMaskExclude([cc_1.Layers.BitMask.PROFILER,cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO]),t.far=1e5,t.near=.1,t}queryLightNodes(t){const r=[];return cce.Node.queryUuids().forEach(e=>{e=cce.Node.query(e);e&&!t.includes(e)&&e.getComponent(cc_1.Light)&&r.push(e)}),r}isSceneHasActiveLight(t){let r=!1;const o=[];return t.forEach(e=>{var t;e.active&&((t=e.getComponent(cc_1.Light))?!0===t.enabled&&(r=!0):o.push(e))}),o.forEach(e=>{e=t.indexOf(e);t.splice(e,1)}),r}queryComponent(t){const r=[];return cce.Node.queryUuids().forEach(e=>{var e=cce.Node.query(e);e&&(e=e.getComponent(t))&&r.push(e)}),r}}!function(e){e[e.IDLE=0]="IDLE",e[e.ORBIT=1]="ORBIT",e[e.PAN=2]="PAN",e[e.ZOOM=3]="ZOOM",e[e.WANDER=4]="WANDER"}(CameraMoveMode=CameraMoveMode||{}),exports.CameraMoveMode=CameraMoveMode;const CameraUtils=new Utils;exports.CameraUtils=CameraUtils;