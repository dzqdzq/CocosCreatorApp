"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CameraController3D=void 0;const node_1=__importDefault(require("../../../../utils/node")),node_2=__importDefault(require("../../node")),camera_controller_base_1=__importDefault(require("../camera-controller-base")),linear_ticks_1=__importDefault(require("../grid/linear-ticks")),tween_1=require("../tween"),utils_1=require("../utils"),cc_1=require("cc"),quat_1=require("../../../../utils/math/quat"),transform_tool_data_1=require("../../../../public/gizmos/utils/transform-tool-data"),vec3_1=require("../../../../utils/math/vec3"),finite_state_machine_1=__importDefault(require("../../../utils/state-machine/finite-state-machine")),orbit_mode_1=require("./mode/orbit-mode"),pan_mode_1=require("./mode/pan-mode"),wander_mode_1=require("./mode/wander-mode"),idle_mode_1=require("./mode/idle-mode"),_lineColor=cc.color().fromHEX("#555555"),_lineEnd=1e6,ORTHO=cc_1.Camera.ProjectionType.ORTHO,PERSPECTIVE=cc_1.Camera.ProjectionType.PERSPECTIVE,tempVec3A=new cc_1.Vec3,tempQuatA=new cc_1.Quat;var ModeCommand;!function(e){e.ToIdle="toIdle",e.ToPan="toPan",e.ToOrbit="toOrbit",e.ToWander="toWander"}(ModeCommand||(ModeCommand={}));class CameraController3D extends camera_controller_base_1.default{constructor(){super(...arguments),this.v3a=new cc_1.Vec3,this.v3b=new cc_1.Vec3,this.v3c=new cc_1.Vec3,this.v3d=new cc_1.Vec3,this._wheelSpeed=.01,this.homePos=cc.v3(50,50,50),this.homeRot=quat_1.MQuat.fromViewUp(new cc_1.Quat,vec3_1.MVec3.normalize(this.v3a,this.homePos)),this._sceneViewCenter=cc.v3(),this.defaultViewDist=20,this.viewDist=20,this.forward=cc.v3(cc_1.Vec3.UNIT_Z),this._curRot=new cc_1.Quat,this._curEye=new cc_1.Vec3,this._lineColor=cc.color().fromHEX("#555555")}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e}get wheelSpeed(){return this._wheelSpeed}set wheelSpeed(e){this._wheelSpeed=e}get sceneViewCenter(){return this._sceneViewCenter}set sceneViewCenter(e){this._sceneViewCenter=e}get wanderSpeed(){return this._wanderMode.wanderSpeed}set wanderSpeed(e){this._wanderMode.wanderSpeed=e}get enableAcceleration(){return this._wanderMode.enableAcceleration}set enableAcceleration(e){this._wanderMode.enableAcceleration=e}init(e){super.init(e),this._gridMeshComp=utils_1.CameraUtils.createGrid("editor/grid"),this._gridNode=this._gridMeshComp.node,this._gridNode.active=!1,this._gridNode.setWorldRotationFromEuler(90,0,0),this._initMode(),this.reset(),this._initLinearTick()}_initMode(){this._idleMode=new idle_mode_1.IdleMode(this,utils_1.CameraMoveMode.IDLE),this._orbitMode=new orbit_mode_1.OrbitMode(this,utils_1.CameraMoveMode.ORBIT),this._panMode=new pan_mode_1.PanMode(this,utils_1.CameraMoveMode.PAN),this._wanderMode=new wander_mode_1.WanderMode(this,utils_1.CameraMoveMode.WANDER),this._modeFSM=new finite_state_machine_1.default([this._idleMode,this._orbitMode,this._panMode,this._wanderMode]),this._modeFSM.addTransition(this._idleMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._idleMode,this._panMode,ModeCommand.ToPan).addTransition(this._idleMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._orbitMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._orbitMode,this._panMode,ModeCommand.ToPan).addTransition(this._orbitMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._panMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._panMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._panMode,this._wanderMode,ModeCommand.ToWander).addTransition(this._wanderMode,this._idleMode,ModeCommand.ToIdle).addTransition(this._wanderMode,this._orbitMode,ModeCommand.ToOrbit).addTransition(this._wanderMode,this._panMode,ModeCommand.ToPan),this._modeFSM.Begin(this._idleMode)}_initLinearTick(){this.hTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80),this.vTicks=(new linear_ticks_1.default).initTicks([5,2],1,1e4).spacing(15,80)}set active(e){e?(this._camera.projection=1,this.node.setWorldPosition(this._curEye),this.node.setWorldRotation(this._curRot)):(this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot)),this.showGrid(e)}changeMode(e){this._modeFSM.issueCommand(e);let t=utils_1.CameraMoveMode.IDLE;switch(e){case ModeCommand.ToIdle:t=utils_1.CameraMoveMode.IDLE;break;case ModeCommand.ToOrbit:t=utils_1.CameraMoveMode.ORBIT;break;case ModeCommand.ToPan:t=utils_1.CameraMoveMode.PAN;break;case ModeCommand.ToWander:t=utils_1.CameraMoveMode.WANDER}this.emit("mode",t)}reset(){this.node.getWorldRotation(this._curRot),this.node.getWorldPosition(this._curEye)}updateViewCenterByDist(e){this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,e),vec3_1.MVec3.add(this.sceneViewCenter,this._curEye,this.v3a)}scale(e){e<0?e=-10:e>0&&(e=10),this.node.getWorldPosition(this._curEye),this.node.getWorldRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot);let t=this.viewDist;if(Math.abs(t)<.1&&(t=1),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,e*this._wheelSpeed*t),vec3_1.MVec3.add(this._curEye,this._curEye,this.v3a),node_1.default.makeVec3InRange(this._curEye,-1e12,1e12),this.node.setWorldPosition(this._curEye),this.viewDist=vec3_1.MVec3.distance(this._curEye,this.sceneViewCenter),this.isOrtho()){const e=this.getDepthSize()*this.viewDist;this.setOrthoHeight(e)}this.updateGrid(),cce.Engine.repaintInEditMode()}focus(e=null,t,i,o,s){if(this.camera_move_mode!==utils_1.CameraMoveMode.IDLE)return;if(e){if(e.length<=0)return;const t=e.map(e=>node_2.default.query(e)).filter(Boolean);if(t.length<=0)return;const i=node_1.default.getCenterWorldPos3D(t),o=node_1.default.getMaxRangeOfNodes(t);let n=3*Math.sqrt(o);n>6&&(n=6);const r=o*n;if(this.sceneViewCenter=i,this.node.getRotation(this._curRot),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,this._curRot),vec3_1.MVec3.multiplyScalar(this.v3c,this.forward,r),vec3_1.MVec3.add(this.v3d,i,this.v3c),this.isOrtho()){const e=this.getDepthSize()*r;s?(this._camera.orthoHeight=e,transform_tool_data_1.transformToolData.cameraOrthoHeight=e,cce.Engine.repaintInEditMode()):tween_1.tweenNumber(this._camera.orthoHeight,e,300).step(e=>{this._camera.orthoHeight=e,transform_tool_data_1.transformToolData.cameraOrthoHeight=e,cce.Engine.repaintInEditMode()})}if(s)this.node.setPosition(this.v3d),this._curEye=this.v3d,this.viewDist=vec3_1.MVec3.distance(this.v3d,this.sceneViewCenter),this.updateGrid(),cce.Engine.repaintInEditMode();else{const e=this.node.getPosition();tween_1.tweenPosition(e,this.v3d,300).step(e=>{this.node.setPosition(e),this._curEye=e,this.viewDist=vec3_1.MVec3.distance(e,this.sceneViewCenter),this.updateGrid(),cce.Engine.repaintInEditMode()})}return}const n=this.node.getPosition(),r=this.node.getRotation();t?(this._curEye.x=t.x||0,this._curEye.y=t.y||0,this._curEye.z=t.z||0):(this._curEye.x=this.homePos.x||0,this._curEye.y=this.homePos.y||0,this._curEye.z=this.homePos.z||0),i?(this._curRot.x=i.x||0,this._curRot.y=i.y||0,this._curRot.z=i.z||0,this._curRot.w=i.w||0):(this._curRot.x=this.homeRot.x||0,this._curRot.y=this.homeRot.y||0,this._curRot.z=this.homeRot.z||0,this._curRot.w=this.homeRot.w||0),this.sceneViewCenter=o||cc.v3(),this.viewDist=vec3_1.MVec3.distance(this._curEye,this.sceneViewCenter),s?(this.node.setPosition(this._curEye),this.node.setRotation(this._curRot),this.updateGrid(),cce.Engine.repaintInEditMode()):(tween_1.tweenPosition(n,this._curEye,300).step(e=>{this.node.setPosition(e),this.updateGrid(),cce.Engine.repaintInEditMode()}),tween_1.tweenRotation(r,this._curRot,300).step(e=>{this.node.setRotation(e),this.updateGrid()}))}alignNodeToSceneView(e){if(e&&e.length>0){const t=e.map(e=>node_2.default.query(e)),i=t[0],o=i.getWorldRT();cc_1.Mat4.invert(o,o);const s=i.getWorldRotation();quat_1.MQuat.invert(s,s);const n=this.node.getWorldPosition(),r=this.node.getWorldRotation(),a=this.node.getWorldRT();if(cce.SceneFacadeManager.snapshot(),i.setWorldPosition(n),i.setWorldRotation(r),t.length>1)for(let e=1;e<t.length;e++){const i=t[e],n=i.getWorldPosition(),d=i.getWorldRotation();vec3_1.MVec3.transformMat4(n,n,o),quat_1.MQuat.multiply(d,s,d),vec3_1.MVec3.transformMat4(n,n,a),i.setWorldPosition(n),quat_1.MQuat.multiply(d,r,d),i.setWorldRotation(d)}}}alignSceneViewToNode(e){if(e&&e.length>0){const t=e.map(e=>node_2.default.query(e))[0],i=t.getWorldPosition(),o=t.getWorldRotation();this.node.setWorldPosition(i),this.node.setWorldRotation(o),cce.Engine.repaintInEditMode()}}onMouseDown(e){return e.middleButton?this.changeMode(ModeCommand.ToPan):e.rightButton&&this.changeMode(ModeCommand.ToWander),this._modeFSM.currentState.onMouseDown(e)}onMouseMove(e){return e.altKey?this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToOrbit):this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToIdle),this._modeFSM.currentState.onMouseMove(e)}onMouseUp(e){return e.middleButton?this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this.changeMode(ModeCommand.ToIdle):e.rightButton&&this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.WANDER&&this.changeMode(ModeCommand.ToIdle),this._modeFSM.currentState.onMouseUp(e)}onMouseWheel(e){this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.WANDER&&this.scale(-e.wheelDeltaY/12),this._modeFSM.currentState.onMouseWheel(e)}onKeyDown(e){switch(this.shiftKey=e.shiftKey,this.altKey=e.altKey,e.altKey&&this._modeFSM.currentState.modeName!==utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToOrbit),e.key.toLowerCase()){case" ":this.changeMode(ModeCommand.ToPan)}this._modeFSM.currentState.onKeyDown(e)}onKeyUp(e){switch(this.shiftKey=e.shiftKey,this.altKey=e.altKey,e.altKey||this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.ORBIT&&this.changeMode(ModeCommand.ToIdle),e.key.toLowerCase()){case" ":this._modeFSM.currentState.modeName===utils_1.CameraMoveMode.PAN&&this.changeMode(ModeCommand.ToIdle);break;case"h":this.focus()}this._modeFSM.currentState.onKeyUp(e)}onUpdate(e){this._modeFSM.currentState.onUpdate(e)}_updateGridData(e,t,i,o=null){const s=this.hTicks,n=this.vTicks,r=cc.v3();this.node.getPosition(r);const a=5e3*(r.y/500)|0,d=-a+r.x,h=a+r.x,c=-a+r.z,_=a+r.z;s.range(d,h,5e3),n.range(c,_,5e3);const l=i.clone();l.a=0;for(let o=s.minTickLevel;o<=s.maxTickLevel;++o){const n=s.tickRatios[o];if(n>0){const d=s.ticksAtLevel(o,!0);for(let o=0;o<d.length;++o){const s=d[o],h=i.clone();h.a=200*n;const u=Math.abs(s-r.x);h.a*=1-u/a,e.push(s,r.z),e.push(s,c),e.push(s,r.z),e.push(s,_),t.push(h.x,h.y,h.z,h.w),t.push(l.x,l.y,l.z,l.w),t.push(h.x,h.y,h.z,h.w),t.push(l.x,l.y,l.z,l.w)}}}for(let o=n.minTickLevel;o<=n.maxTickLevel;++o){const s=n.tickRatios[o];if(s>0){const c=n.ticksAtLevel(o,!0);for(let o=0;o<c.length;++o){const n=c[o],_=i.clone();_.a=200*s;const u=Math.abs(n-r.z);_.a*=1-u/a,e.push(r.x,n),e.push(d,n),e.push(r.x,n),e.push(h,n),t.push(_.x,_.y,_.z,_.w),t.push(l.x,l.y,l.z,l.w),t.push(_.x,_.y,_.z,_.w),t.push(l.x,l.y,l.z,l.w)}}}}updateGrid(){const e=[],t=[],i=[];if(this._updateGridData(e,t,this._lineColor,_lineEnd),e.length>0){for(let t=0;t<e.length;t+=2)i.push(t/2);utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_POSITION,e),utils_1.CameraUtils.updateVBAttr(this._gridMeshComp,cc_1.gfx.AttributeName.ATTR_COLOR,t),utils_1.CameraUtils.updateIB(this._gridMeshComp,i)}}refresh(){this.updateGrid(),cce.Engine.repaintInEditMode()}rotateCameraToDir(e){const t=cc.v3(),i=cc.quat();this.node.getPosition(t),this.node.getRotation(i),quat_1.MQuat.rotationTo(this._curRot,cc_1.Vec3.UNIT_Z,e);const o=cc.v3(0,0,this.viewDist);vec3_1.MVec3.transformQuat(o,o,this._curRot),vec3_1.MVec3.add(this._curEye,this.sceneViewCenter,o),tween_1.tweenPosition(t,this._curEye,300).step(e=>{this.node.setPosition(e),this.updateGrid(),cce.Engine.repaintInEditMode()}),tween_1.tweenRotation(i,this._curRot,300).step(e=>{this.node.setRotation(e),this.updateGrid()})}getDepthSize(){const e=this._camera.fov;return Math.tan(e/2*Math.PI/180)}calcCameraPosInOrtho(){const e=this.getDepthSize(),t=this._camera.orthoHeight/e;return this.viewDist<t&&(this.viewDist=t),this.node.getWorldRotation(tempQuatA),vec3_1.MVec3.transformQuat(this.forward,cc_1.Vec3.UNIT_Z,tempQuatA),vec3_1.MVec3.normalize(this.forward,this.forward),vec3_1.MVec3.multiplyScalar(this.v3a,this.forward,this.viewDist),vec3_1.MVec3.add(this.v3b,this.sceneViewCenter,this.v3a),this.v3b}isOrtho(){return this._camera._projection===ORTHO}setOrthoHeight(e){e<1&&(e=1),this._camera.orthoHeight=e,transform_tool_data_1.transformToolData.cameraOrthoHeight=e}changeProjection(){if(this.isOrtho()){const e=this.calcCameraPosInOrtho();this.node.setWorldPosition(e),this._camera.projection=PERSPECTIVE,this.emit("projection-changed",PERSPECTIVE),this.updateGrid()}else{this._camera.projection=ORTHO;const e=this.getDepthSize()*this.viewDist;this.setOrthoHeight(e),this.emit("projection-changed",ORTHO)}}onResize(){this.updateGrid(),cce.Engine.repaintInEditMode()}}exports.CameraController3D=CameraController3D;