"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ipc_1=__importDefault(require("../ipc")),{EventEmitter:EventEmitter}=require("events"),listener_1=__importDefault(require("./listener")),utils_1=require("./utils"),cc_1=require("cc"),camera_controller_2d_1=require("./2d/camera-controller-2d"),camera_controller_3d_1=require("./3d/camera-controller-3d");class Camera extends EventEmitter{constructor(){super(...arguments),this._controller2D=new camera_controller_2d_1.CameraController2D,this._controller3D=new camera_controller_3d_1.CameraController3D,this._controller=this._controller3D,this._camera=null}get controller2D(){return this._controller2D}get controller3D(){return this._controller3D}get controller(){return this._controller}set is2D(e){this._controller&&(this._controller.active=!1),this._controller=e?this._controller2D:this._controller3D,this._controller.active=!0,cce.Engine.repaintInEditMode()}get is2D(){return this._controller===this._controller2D}init(){this._camera=utils_1.CameraUtils.createCamera(cc.color(48,48,48,255)),this._controller2D.init(this._camera),this._controller3D.init(this._camera),this._controller3D.on("mode",e=>{this.onControl3DModeChanged(e)}),this.initFromConfig(),cc_1.view.on("design-resolution-changed",this.onDesignResolutionChange.bind(this)),listener_1.default(this)}async initFromConfig(){const e=await Editor.Profile.getConfig("scene","camera");this.setCameraProperty({fov:e.fov,far:e.far,near:e.near,clearColor:e.color}),this.setWheelSpeed(e.wheelSpeed),this.setWanderSpeed(e.wanderSpeed);const r=await Editor.Profile.getConfig("scene","gizmos-infos");void 0!==r.gridVisible&&null!==r.gridVisible&&this.setGridVisible(r.gridVisible),r.gridColor&&this.setGridLineColor(r.gridColor),this.is2D=r.is2D}onSceneOpened(e){this.refresh()}onSceneClosed(e){if(!e||!e.uuid)return;const r=this.getCurCameraInfo();ipc_1.default.send("record-camera",e.uuid,r),ipc_1.default.send("record-gizmos",{isGridVisible:this.controller.isGridVisible})}getCurCameraInfo(){const e=this.controller3D.node,r=e.getWorldPosition(cc.v3()),o=e.getWorldRotation(cc.quat()),t={x:r.x,y:r.y,z:r.z},i={x:o.x,y:o.y,z:o.z,w:o.w},n=this.controller3D.sceneViewCenter;return{position:t,rotation:i,viewCenter:{x:n.x,y:n.y,z:n.z}}}setGridVisible(e){if(void 0===e||null===e)return;this._controller2D&&(this._controller2D.isGridVisible=e),this._controller3D&&(this._controller3D.isGridVisible=e),(this._controller===this._controller3D?this._controller2D:this._controller3D).active=!1,this._controller.active=!0,cce.Engine.repaintInEditMode()}isGridVisible(){return this._controller.isGridVisible}setGridLineColor(e){!e||e.length<4||(this._controller3D.lineColor=new cc.Color(e[0],e[1],e[2],e[3]),this._controller3D.updateGrid(),this._controller2D.lineColor=new cc.Color(e[0],e[1],e[2],e[3]),this._controller2D.updateGrid(),cce.Engine.repaintInEditMode())}getCameraFov(){if(this._camera)return this._camera.fov}getCameraFar(){if(this._camera)return this._camera.far}getCameraNear(){if(this._camera)return this._camera.near}getCameraColor(){if(this._camera)return this._camera.clearColor}getWheelSpeed(){return this.controller3D.wheelSpeed}setWheelSpeed(e){this.controller3D.wheelSpeed=e,this.controller2D.wheelSpeed=e}getWanderSpeed(){return this.controller3D.wanderSpeed}setWanderSpeed(e){this.controller3D.wanderSpeed=e}getCameraProperty(){if(this._camera)return{fov:this._camera.fov,far:this._camera.far,near:this._camera.near,clearColor:this._camera.clearColor}}setCameraProperty(e){"object"==typeof e&&(Object.keys(e).forEach(r=>{e[r]&&(this._camera[r]="clearColor"===r?cc.color(e[r][0],e[r][1],e[r][2],e[r][3]):e[r])}),cce.Engine.repaintInEditMode())}focus(e=null,r,o,t,i=!1){this._controller.focus(e,r,o,t,i)}rotateCameraToDir(e){this._controller.rotateCameraToDir(e)}changeProjection(){this._controller.changeProjection()}reset(e,r){this._controller.reset(e,r)}copyCameraDataToNodes(e){this._controller.copyCameraDataToNodes(e)}onMouseDown(e){return this._controller.onMouseDown(e)}onMouseMove(e){return this._controller.onMouseMove(e)}onMouseUp(e){return this._controller.onMouseUp(e)}onMouseWheel(e){this._controller.onMouseWheel(e)}onKeyDown(e){this._controller.onKeyDown(e)}onKeyUp(e){this._controller.onKeyUp(e)}onUpdate(e){this._controller.onUpdate(e)}onDesignResolutionChange(){this._controller.onDesignResolutionChange()}onResize(){this._controller.onResize()}refresh(){this._controller.refresh()}zoomUp(){this._controller.zoomUp()}zoomDown(){this._controller.zoomDown()}zoomReset(){this._controller.zoomReset()}getCamera(){var e;return null===(e=this._camera)||void 0===e?void 0:e.camera}onControl3DModeChanged(e){this.emit("control-3d-mode",e)}}exports.default=new Camera;