"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Camera=void 0;const index_1=__importDefault(require("../ipc/index")),events_1=require("events"),listener_1=__importDefault(require("./listener")),utils_1=require("./utils"),cc_1=require("cc"),camera_controller_2d_1=require("./2d/camera-controller-2d"),camera_controller_3d_1=require("./3d/camera-controller-3d"),index_2=__importDefault(require("../../utils/dump/index"));class Camera extends events_1.EventEmitter{constructor(){super(...arguments),this._controller2D=new camera_controller_2d_1.CameraController2D,this._controller3D=new camera_controller_3d_1.CameraController3D,this._controller=this._controller3D}get controller2D(){return this._controller2D}get controller3D(){return this._controller3D}get controller(){return this._controller}set is2D(e){this._controller&&(this._controller.active=!1),this._controller=e?this._controller2D:this._controller3D,this._controller.active=!0,cce.Engine.repaintInEditMode()}get is2D(){return this._controller===this._controller2D}get camera(){return this._camera}bindOperation(){(0,listener_1.default)(this)}init(){this._camera=utils_1.CameraUtils.createCamera(cc.color(48,48,48,0)),this._controller2D.init(this._camera),this._controller3D.init(this._camera),this._controller3D.on("mode",e=>{this.onControl3DModeChanged(e)}),this.initFromConfig(),this.bindOperation(),cc_1.view.on("design-resolution-changed",this.onDesignResolutionChange.bind(this))}async initFromConfig(){const e=await Editor.Profile.getConfig("scene","camera");e&&(void 0!==e.iso&&this.setCameraISO(e.iso),void 0!==e.aperture&&this.setCameraAperture(e.aperture),void 0!==e.shutter&&this.setCameraShutter(e.shutter),void 0!==e.fov&&this.setCameraProperty({fov:e.fov}),void 0!==e.color&&this.setCameraProperty({clearColor:e.color}),void 0!==e.far&&(this.controller3D.far=e.far),void 0!==e.near&&(this.controller3D.near=e.near),void 0!==e.wheelSpeed&&(this.controller3D.wheelSpeed=e.wheelSpeed),void 0!==e.far2D&&(this.controller2D.far=e.far2D),void 0!==e.near2D&&(this.controller2D.near=e.near2D),void 0!==e.wheelSpeed2D&&(this.controller2D.wheelSpeed=e.wheelSpeed2D),void 0!==e.wanderSpeed&&(this.controller3D.wanderSpeed=e.wanderSpeed),void 0!==e.enableAcceleration&&this.setEnableAcceleration(e.enableAcceleration));const r=await Editor.Profile.getConfig("scene","gizmos-infos");void 0!==r.gridVisible&&null!==r.gridVisible&&this.setGridVisible(r.gridVisible),r.gridColor&&this.setGridLineColor(r.gridColor),this.is2D=r.is2D}onSceneOpened(e){this.refresh()}async onSceneClosed(e){if(!e||!e.uuid)return;const r=this.getCurCameraInfo();index_1.default.send("record-camera",e.uuid,r),index_1.default.send("record-gizmos",{isGridVisible:this.controller.isGridVisible});const t={fov:this.getCameraFov(),far:this.controller3D.far,near:this.controller3D.near,color:this.colorToArray(this.getCameraColor()),wheelSpeed:this.controller3D.wheelSpeed,wanderSpeed:this.getWanderSpeed(),enableAcceleration:this.getEnableAcceleration(),far2D:this.controller2D.far,near2D:this.controller2D.near,wheelSpeed2D:this.controller2D.wheelSpeed,size:await Editor.Profile.getConfig("scene","camera.size")};index_1.default.send("record-camera-config",t)}getCurCameraInfo(){const e=this.controller3D.node,r=e.getWorldPosition(cc.v3()),t=e.getWorldRotation(cc.quat()),o={x:r.x,y:r.y,z:r.z},i={x:t.x,y:t.y,z:t.z,w:t.w},n=this.controller3D.sceneViewCenter;return{position:o,rotation:i,viewCenter:{x:n.x,y:n.y,z:n.z}}}setGridVisible(e){if(void 0===e||null===e)return;this._controller2D&&(this._controller2D.isGridVisible=e),this._controller3D&&(this._controller3D.isGridVisible=e),(this._controller===this._controller3D?this._controller2D:this._controller3D).showGrid(!1),cce.Engine.repaintInEditMode()}isGridVisible(){return this._controller.isGridVisible}setGridLineColor(e){!e||e.length<4||(this._controller3D.lineColor=new cc.Color(e[0],e[1],e[2],e[3]),this._controller3D.updateGrid(),this._controller2D.lineColor=new cc.Color(e[0],e[1],e[2],e[3]),this._controller2D.updateGrid(),cce.Engine.repaintInEditMode())}getCameraFov(){if(this._camera)return this._camera.fov}getCameraFar(){return this.controller.far}getCameraNear(){return this.controller.near}getCameraColor(){if(this._camera)return this._camera.clearColor}getCameraISO(){return this._camera.iso}setCameraISO(e){this._camera.iso=e}setCameraAperture(e){this._camera.aperture=e}getCameraAperture(e){return this._camera.aperture}getCameraShutter(e){return this._camera.shutter}setCameraShutter(e){this._camera.shutter=e}getWheelSpeed(){return this.controller.wheelSpeed}setWheelSpeed(e){this.controller.wheelSpeed=e}getWanderSpeed(){return this.controller3D.wanderSpeed}setWanderSpeed(e){this.controller3D.wanderSpeed=e}getEnableAcceleration(){return this.controller3D.enableAcceleration}setEnableAcceleration(e){this.controller3D.enableAcceleration=e}colorToArray(e){return e?[e.r,e.g,e.b,e.a]:[0,0,0,0]}arrayToColor(e){return new cc.Color(e[0],e[1],e[2],e[3])}getCameraProperty(){if(this._camera){return index_2.default.dumpComponent(this._camera).value}}setCameraProperty(e){"object"==typeof e&&(Object.keys(e).forEach(r=>{void 0!==e[r]&&null!==e[r]&&("clearColor"===r?this._camera[r]=cc.color(e[r][0],e[r][1],e[r][2],e[r][3]):"near"===r||"far"===r?(this.controller[r]=e[r],this._camera[r]=e[r]):"fov"===r?(this.emit("fov-changed",e[r]),this._camera[r]=e[r]):this._camera[r]=e[r])}),cce.Engine.repaintInEditMode())}focus(e=null,r,t,o,i=!1){this._controller.focus(e,r,t,o,i)}rotateCameraToDir(e,r){this._controller.rotateCameraToDir(e,r)}changeProjection(){this._controller.changeProjection()}reset(e,r){this._controller instanceof camera_controller_3d_1.CameraController3D&&this._controller.reset()}alignNodeToSceneView(e){this._controller.alignNodeToSceneView(e)}alignSceneViewToNode(e){this._controller.alignSceneViewToNode(e)}onMouseDown(e){return this._controller.onMouseDown(e)}onMouseMove(e){return this._controller.onMouseMove(e)}onMouseUp(e){return this._controller.onMouseUp(e)}onMouseWheel(e){return this._controller.onMouseWheel(e)}onKeyDown(e){return this._controller.onKeyDown(e)}onKeyUp(e){return this._controller.onKeyUp(e)}onUpdate(e){this._controller.onUpdate(e)}onDesignResolutionChange(){this._controller.onDesignResolutionChange()}async onResize(e){await this._controller.onResize(e)}refresh(){this._controller.refresh()}zoomUp(){this._controller.zoomUp()}zoomDown(){this._controller.zoomDown()}zoomReset(){this._controller.zoomReset()}getCamera(){var e;return null===(e=this._camera)||void 0===e?void 0:e.camera}onControl3DModeChanged(e){this.emit("control-3d-mode",e)}setRulerVisible(e){this._controller===this._controller2D&&(this._controller._ruler.show(e),this._controller.updateRuler())}}exports.Camera=Camera,exports.default=new Camera;