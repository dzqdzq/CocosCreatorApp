"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NeedAnimState=exports.engineManager=void 0;const time_1=__importDefault(require("./time")),cc_1=require("cc"),selection_1=__importDefault(require("../../../public/selection")),event_enum_1=require("../../../public/event-enum"),timer_util_1=require("../../utils/timer-util"),scene_view_1=require("../scene-view");var NeedAnimState;!function(e){e[e.CAMERA_ORBIT=0]="CAMERA_ORBIT",e[e.CAMERA_PAN=1]="CAMERA_PAN",e[e.CAMERA_WANDER=2]="CAMERA_WANDER",e[e.ANIMATION_MODE=3]="ANIMATION_MODE",e[e.PARTICLE_SYSTEM_MODE=4]="PARTICLE_SYSTEM_MODE",e[e.TERRAIN_SYSTEM_MODE=5]="TERRAIN_SYSTEM_MODE",e[e.GAME_VIEW_MODE=6]="GAME_VIEW_MODE"}(NeedAnimState||(NeedAnimState={})),exports.NeedAnimState=NeedAnimState;class EngineManager{constructor(){this._requestId=null,this._maxDeltaTimeInEM=1/30,this._stateRecord=0,this._shouldRepaintInEM=!1,this._tickInEM=!1,this._bindTick=this._tick.bind(this)}init(){cc.game.pause(),this.startTick(),scene_view_1.sceneViewManager.on("isVisible",this.onSceneViewVisible.bind(this))}setTimeout(e,t){return scene_view_1.sceneViewManager.isVisible?requestAnimationFrame(e):timer_util_1.TimerUtil.setMainProcessTimeout(e,t)}clearTimeout(e){cancelAnimationFrame(e),timer_util_1.TimerUtil.clearMainProcessTimeout(e)}onSceneViewVisible(e){this.stopTick(),this.startTick()}onSceneOpened(e){this.repaintInEditMode()}onComponentAdded(e){const t=selection_1.default.query();e.node&&t.includes(e.node.uuid)&&engineManager.checkToSetAnimState([e.node])}onComponentRemoved(e){const t=selection_1.default.query();e.node&&t.includes(e.node.uuid)&&engineManager.checkToSetAnimState([e.node])}onNodeChanged(e,t){const i=null===t||void 0===t?void 0:t.type;i===event_enum_1.NodeEventType.TRANSFORM_CHANGED||i===event_enum_1.NodeEventType.SIZE_CHANGED||i===event_enum_1.NodeEventType.ANCHOR_CHANGED||i===event_enum_1.NodeEventType.COMPONENT_CHANGED||i===event_enum_1.NodeEventType.PARENT_CHANGED||i===event_enum_1.NodeEventType.CHILD_CHANGED||this.checkToSetAnimState([e])}repaintInEditMode(){CC_EDITOR&&(this._shouldRepaintInEM=!0)}setFrameRate(e){this._maxDeltaTimeInEM=1/e}startTick(){null===this._requestId&&this._tick()}stopTick(){null!==this._requestId&&(this.clearTimeout(this._requestId),this._requestId=null)}tickInEditMode(e){cc.director.tick(e)}enterState(e){void 0!==e?(this._stateRecord|=1<<e,this._updateTickState()):console.error("undefined need animation state")}exitState(e){void 0!==e?(this._stateRecord&=~(1<<e),this._updateTickState()):console.error("undefined need animation state")}resume(){this.startTick()}pause(){this.stopTick()}checkToSetAnimState(e){let t=!1,i=!1;e.forEach(e=>{e&&e.components&&e.components.forEach(e=>{e instanceof cc_1.ParticleSystem||e instanceof cc_1.ParticleSystem2D?t=!0:e instanceof cc_1.Terrain&&(i=!0)})}),t?cce.Engine.enterState(cce.NeedAnimState.PARTICLE_SYSTEM_MODE):cce.Engine.exitState(cce.NeedAnimState.PARTICLE_SYSTEM_MODE),i?cce.Engine.enterState(cce.NeedAnimState.TERRAIN_SYSTEM_MODE):cce.Engine.exitState(cce.NeedAnimState.TERRAIN_SYSTEM_MODE)}_tick(){this._requestId=this.setTimeout(this._bindTick,1e3/60);const e=performance.now()/1e3;time_1.default.update(e,!1,this._maxDeltaTimeInEM),(this._shouldRepaintInEM||this._tickInEM)&&(this._shouldRepaintInEM=!1,this.tickInEditMode(time_1.default.deltaTime))}_updateTickState(){this._tickInEM=this._stateRecord>0}}const engineManager=new EngineManager;exports.engineManager=engineManager;