"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),{ipcRenderer:ipcRenderer}=require("electron"),utils_1=require("../../../../public/ipc/utils"),v_stacks_1=require("v-stacks"),utils_2=require("../../../../utils/ipc/utils"),sendChannel=isPreviewProcess?utils_2.IPCChannel.PreviewSend:utils_2.IPCChannel.NativeSend,replyChannel=isPreviewProcess?utils_2.IPCChannel.PreviewReply:utils_2.IPCChannel.NativeReply;class WebviewIpc extends events_1.EventEmitter{constructor(){super(...arguments),this._storage=new utils_1.DataStorage}get storage(){return this._storage}send(e,...s){return new Promise((t,n)=>{const r={message:e,arguments:s.map(utils_1.encodeArgs),callback:function(e,s){e?n(e):t(s)},stack:""},c=this._storage.add(r);ipcRenderer.sendToHost(sendChannel,c,r.message,r.arguments)})}request(e,...s){return this.send(e,...s)}}const ipc=new WebviewIpc;exports.default=ipc,ipcRenderer.on(sendChannel,async(e,s,t,n)=>{const r=ipc._events[t];try{const e=await r(...n.map(utils_1.decodeArgs));ipcRenderer.sendToHost(replyChannel,s,null,(0,utils_1.encodeArgs)(e))}catch(e){return console.log(e),void ipcRenderer.sendToHost(replyChannel,s,(0,v_stacks_1.encode)(e))}}),ipcRenderer.on(replyChannel,(e,s,t,n)=>{const r=ipc.storage.get(s);if(r){if(r.callback){t&&("string"==typeof t.stack&&(t.stack=t.stack.replace(/^[^\n]+/,e=>e+"\n    at <process:scene>")),t=(0,v_stacks_1.decode)(t));try{r.callback(t,(0,utils_1.decodeArgs)(n))}catch(e){console.error(e)}}}else console.warn("IPC message has been lost.");ipc.storage.remove(s)});