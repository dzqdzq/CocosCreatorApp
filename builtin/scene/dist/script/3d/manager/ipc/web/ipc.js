"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startup=void 0;const webview_1=__importDefault(require("./webview")),queue=[];let lock=!0;const outTime=18e4,customIpc=webview_1.default;function startup(){lock=!1,step(),Editor.Metrics.trackTimeEnd("scene:scene-view-startup",{output:!0})}async function step(e=!1){if(e&&(lock=!1),lock)return;const t=queue.shift();if(!t)return;const o=t.options,r=cce[o.module];if(!r)throw new Error(`Module [${o.module}] does not exist.(Method: ${o.handler})`);if(!r[o.handler])throw new Error(`Method [${o.handler}] does not exist.(Module: ${o.module})`);lock=!0;try{const e=r[o.handler](...o.params);if(e instanceof Promise){let r;Promise.race([e,new Promise((e,t)=>{r=setTimeout(async()=>{console.debug("Scene Not Response",`${o.module}.${o.handler}`),queue.forEach(e=>{console.debug("ipc queue",e.options.module,e.options.handler)}),await Editor.Dialog.warn(Editor.I18n.t("scene.messages.warning"),{detail:Editor.I18n.t("scene.messages.not_response"),buttons:[Editor.I18n.t("scene.messages.confirm")]}),t(new Error(`${o.module}.${o.handler} timeout.\n  ${JSON.stringify(o.params)}`))},outTime)})]).then(e=>{t.resolve(e)}).catch(e=>{t.reject(e)}).finally(()=>{r&&clearTimeout(r),step(!0)})}else t.resolve(e),step(!0)}catch(e){t.reject(e),step(!0)}}customIpc.startup=startup,customIpc.clearQueue=(()=>{queue.length=0}),exports.startup=startup,customIpc.on("call-method",e=>{if(e.queue)return new Promise((t,o)=>{queue.push({options:e,resolve:t,reject:o}),step()});{const t=cce[e.module];if(!t)throw new Error(`Module [${e.module}] does not exist.(Method: ${e.handler})`);if(!t[e.handler])throw new Error(`Method [${e.handler}] does not exist.(Module: ${e.module})`);const o=t[e.handler](...e.params);return new Promise((t,r)=>{if(o instanceof Promise)if(e.timeout){const s=setTimeout(()=>{r(new Error(`${e.module}.${e.handler} timeout.\n  ${JSON.stringify(e.params)}`))},3e4);o.then(e=>{clearTimeout(s),t(e)}).catch(e=>{clearTimeout(s),r(e)})}else o.then(e=>{t(e)}).catch(e=>{r(e)});else t(o)})}}),exports.default=customIpc;