"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),{ipcRenderer:ipcRenderer}=require("electron"),utils_1=require("../../../../public/ipc/utils"),v_stacks_1=require("v-stacks"),utils_2=require("../../../../utils/ipc/utils"),sendChannel=isPreviewProcess?utils_2.IPCChannel.PreviewSend:utils_2.IPCChannel.SceneWebSend,replyChannel=isPreviewProcess?utils_2.IPCChannel.PreviewReply:utils_2.IPCChannel.SceneWebReply;class WebviewIpc extends events_1.EventEmitter{constructor(){super(...arguments),this._storage=new utils_1.DataStorage}get storage(){return this._storage}send(e,...s){return new Promise((n,t)=>{const r={message:e,arguments:s.map(utils_1.encodeArgs),callback:function(e,s){e?t(e):n(s)},stack:""},c=this._storage.add(r);ipcRenderer.sendToHost(sendChannel,c,r.message,r.arguments)})}request(e,...s){return this.send(e,...s)}}const ipc=new WebviewIpc;exports.default=ipc,ipcRenderer.on(sendChannel,async(e,s,n,t)=>{const r=ipc._events[n];try{const e=await r(...t.map(utils_1.decodeArgs));ipcRenderer.sendToHost(replyChannel,s,null,(0,utils_1.encodeArgs)(e))}catch(e){return console.log(e),void ipcRenderer.sendToHost(replyChannel,s,(0,v_stacks_1.encode)(e))}}),ipcRenderer.on(replyChannel,(e,s,n,t)=>{const r=ipc.storage.get(s);if(r){if(r.callback){n&&("string"==typeof n.stack&&(n.stack=n.stack.replace(/^[^\n]+/,e=>e+"\n    at <process:scene>")),n=(0,v_stacks_1.decode)(n));try{r.callback(n,(0,utils_1.decodeArgs)(t))}catch(e){console.error(e)}}}else console.warn("IPC message has been lost.");ipc.storage.remove(s)});