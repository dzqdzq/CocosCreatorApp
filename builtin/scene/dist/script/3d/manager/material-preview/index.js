"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialPreview=void 0;const cc_1=require("cc"),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy];function insertAdditionals(e){return e.customAttributes||(e.customAttributes=[]),e.customAttributes.push({attr:new cc_1.gfx.Attribute(cc_1.gfx.AttributeName.ATTR_TANGENT,cc_1.gfx.Format.RGBA32F),values:EditorExtends.GeometryUtils.calculateTangents(e.positions,e.indices,e.normals,e.uvs)}),e}regions[0].texExtent.depth=1;const primitiveData={box:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.box())),scale:new cc_1.Vec3(1,1,1)},sphere:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.sphere())),scale:new cc_1.Vec3(1,1,1)},capsule:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.capsule())),scale:new cc_1.Vec3(.8,.8,.8)},cylinder:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cylinder())),scale:new cc_1.Vec3(.8,.8,.8)},torus:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.torus())),scale:new cc_1.Vec3(1,1,1)},cone:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cone())),scale:new cc_1.Vec3(1,1,1)},quad:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.quad())),scale:new cc_1.Vec3(1,1,1)}},tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat,_matInsInfo={parent:null,owner:null,subModelIdx:0};class MaterialPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this.primitive="sphere",this.material=null}init(e,t){super.init(e,t);const i=cc_1.director.root.device;this.dummyBuffer=i.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.UNIFORM,cc_1.gfx.MemoryUsageBit.HOST|cc_1.gfx.MemoryUsageBit.DEVICE,16)),this.dummyTexture=i.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D,cc_1.gfx.TextureUsageBit.SAMPLED,cc_1.gfx.Format.RGBA8,4,4)),this.dummySampler=i.getSampler(new cc_1.gfx.SamplerInfo)}createNodes(e){this.lightComp=new cc.Node("Material Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e,this.modelComp=new cc_1.Node("Material Preview Model").addComponent(cc_1.MeshRenderer),this.modelComp.mesh=primitiveData.sphere.mesh,this.modelComp.node.parent=this.scene}setMaterial(e){if(e&&e!==this.material){const t=this.modelComp;_matInsInfo.parent=e,_matInsInfo.owner=t;const i=new cc_1.renderer.MaterialInstance(_matInsInfo);t.material=i,this.material=e,this.updateDs(),this.cameraComp.enabled=!0}}updateDs(){const e=this.modelComp.model;if(e)for(let t=0;t<e.subModels.length;t++){const i=e.subModels[t].descriptorSet,c=i.layout.bindings;for(let e=0;e<c.length;e++){const t=c[e],s=t.binding;t.descriptorType&cc_1.gfx.DESCRIPTOR_BUFFER_TYPE?i.getBuffer(s)||i.bindBuffer(s,this.dummyBuffer):t.descriptorType&cc_1.gfx.DESCRIPTOR_SAMPLER_TYPE&&(i.getTexture(s)||i.bindTexture(s,this.dummyTexture),i.getSampler(s)||i.bindSampler(s,this.dummySampler))}i.update()}}setPrimitive(e){e&&e!==this.primitive&&(this.modelComp.mesh=primitiveData[e].mesh,this.updateDs(),this.modelComp.node.setScale(primitiveData[e].scale),this.primitive=e,this.cameraComp.enabled=!0)}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this.cameraComp.node.getWorldPosition(tempVec3A),this.modelComp.node.getWorldPosition(tempVec3B),this._viewDist=cc_1.Vec3.distance(tempVec3A,tempVec3B)}}exports.MaterialPreview=MaterialPreview;