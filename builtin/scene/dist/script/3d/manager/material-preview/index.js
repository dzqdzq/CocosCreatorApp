"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaterialPreview=void 0;const cc_1=require("cc"),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy];function insertAdditionals(e){return e.customAttributes||(e.customAttributes=[]),e.customAttributes.push({attr:new cc_1.gfx.Attribute(cc_1.gfx.AttributeName.ATTR_TANGENT,cc_1.gfx.Format.RGBA32F),values:EditorExtends.GeometryUtils.calculateTangents(e.positions,e.indices,e.normals,e.uvs)}),e}regions[0].texExtent.depth=1;const primitiveData={box:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.box())),scale:new cc_1.Vec3(1,1,1)},sphere:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.sphere())),scale:new cc_1.Vec3(1,1,1)},capsule:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.capsule())),scale:new cc_1.Vec3(.8,.8,.8)},cylinder:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cylinder())),scale:new cc_1.Vec3(.8,.8,.8)},torus:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.torus())),scale:new cc_1.Vec3(1,1,1)},cone:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cone())),scale:new cc_1.Vec3(1,1,1)},quad:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.quad())),scale:new cc_1.Vec3(1,1,1)}},tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat,_matInsInfo={parent:null,owner:null,subModelIdx:0};class MaterialPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this.primitive="sphere",this.material=null}init(e,t){super.init(e,t);const i=cc_1.director.root.device;this.uniformBuffer=i.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.UNIFORM,cc_1.gfx.MemoryUsageBit.HOST|cc_1.gfx.MemoryUsageBit.DEVICE,16)),this.dummyUniformBuffer=i.createBuffer(new cc_1.gfx.BufferViewInfo(this.uniformBuffer,0,this.uniformBuffer.size)),this.storageBuffer=isSceneNative?i.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.STORAGE,cc_1.gfx.MemoryUsageBit.HOST|cc_1.gfx.MemoryUsageBit.DEVICE,16)):this.uniformBuffer,this.dummyStorageBuffer=isSceneNative?i.createBuffer(new cc_1.gfx.BufferViewInfo(this.storageBuffer,0,this.storageBuffer.size)):this.dummyUniformBuffer,this.dummySampleTexture=i.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D,cc_1.gfx.TextureUsageBit.SAMPLED,cc_1.gfx.Format.RGBA8,4,4)),this.dummyStorageTexture=isSceneNative?i.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D,cc_1.gfx.TextureUsageBit.STORAGE,cc_1.gfx.Format.RGBA8,4,4)):this.dummySampleTexture,this.dummySampler=i.getSampler(new cc_1.gfx.SamplerInfo)}createNodes(e){this.lightComp=new cc.Node("Material Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.setParent(e),this.modelComp=new cc_1.Node("Material Preview Model").addComponent(cc_1.MeshRenderer),this.modelComp.mesh=primitiveData.sphere.mesh;const t=new cc_1.Material;t.initialize({effectName:"builtin-standard"}),this.modelComp.material=t,this.setMaterial(t),this.modelComp.node.setParent(this.scene)}setMaterial(e){if(e&&e!==this.material){const t=this.modelComp;_matInsInfo.parent=e,_matInsInfo.owner=t;const i=new cc_1.renderer.MaterialInstance(_matInsInfo);t.material=i,this.material=e,this.updateDs(),this.cameraComp.enabled=!0}}updateDs(){const e=this.modelComp.model;if(e)for(let t=0;t<e.subModels.length;t++){const i=e.subModels[t].descriptorSet,c=i.layout.bindings;cc_1.director.root.device;for(let e=0;e<c.length;e++){const t=c[e],r=t.binding,s=t.descriptorType;s&cc_1.gfx.DescriptorType.UNIFORM_BUFFER||s&cc_1.gfx.DescriptorType.DYNAMIC_UNIFORM_BUFFER?i.getBuffer(r)||i.bindBuffer(r,this.dummyUniformBuffer):s&cc_1.gfx.DescriptorType.STORAGE_BUFFER||s&cc_1.gfx.DescriptorType.DYNAMIC_STORAGE_BUFFER?i.getBuffer(r)||i.bindBuffer(r,this.dummyStorageBuffer):s&cc_1.gfx.DESCRIPTOR_SAMPLER_TYPE&&(i.getTexture(r)||(s&cc_1.gfx.DescriptorType.SAMPLER_TEXTURE||s&cc_1.gfx.DescriptorType.TEXTURE?i.bindTexture(r,this.dummySampleTexture):s&cc_1.gfx.DescriptorType.STORAGE_IMAGE&&i.bindTexture(r,this.dummyStorageTexture)),i.getSampler(r)||i.bindSampler(r,this.dummySampler))}i.update()}}setPrimitive(e){e&&e!==this.primitive&&(this.modelComp.mesh=primitiveData[e].mesh,this.updateDs(),this.modelComp.node.setScale(primitiveData[e].scale),this.primitive=e,this.cameraComp.enabled=!0)}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this.cameraComp.node.getWorldPosition(tempVec3A),this.modelComp.node.getWorldPosition(tempVec3B),this._viewDist=cc_1.Vec3.distance(tempVec3A,tempVec3B)}}exports.MaterialPreview=MaterialPreview;