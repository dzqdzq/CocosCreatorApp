"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),regions=[new cc_1.gfx.BufferTextureCopy];function insertAdditionals(e){return e.customAttributes||(e.customAttributes=[]),e.customAttributes.push({attr:new cc_1.gfx.Attribute(cc_1.gfx.AttributeName.ATTR_TANGENT,cc_1.gfx.Format.RGBA32F),values:EditorExtends.GeometryUtils.calculateTangents(e.positions,e.indices,e.normals,e.uvs)}),e}regions[0].texExtent.depth=1;const primitiveData={box:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.box())),scale:new cc_1.Vec3(1,1,1)},sphere:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.sphere())),scale:new cc_1.Vec3(1,1,1)},capsule:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.capsule())),scale:new cc_1.Vec3(.8,.8,.8)},cylinder:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cylinder())),scale:new cc_1.Vec3(.8,.8,.8)},torus:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.torus())),scale:new cc_1.Vec3(1,1,1)},cone:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cone())),scale:new cc_1.Vec3(1,1,1)},quad:{mesh:cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.quad())),scale:new cc_1.Vec3(1,1,1)}},tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat,_matInsInfo={parent:null,owner:null,subModelIdx:0};class MaterialPreview{constructor(){this.primitive="sphere",this.material=null,this._isMouseDown=!1,this._viewDist=0,this.id_up=new cc_1.Vec3(0,1,0),this.id_forward=new cc_1.Vec3(0,0,1),this.orbitRotateSpeed=.01}init(){this.scene=new cc.Scene,this.cameraComp=new cc.Node("Material Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Material Preview Light").addComponent(cc_1.DirectionalLight),this.modelComp=new cc.Node("Material Preview Model").addComponent(cc_1.MeshRenderer),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.modelComp.mesh=primitiveData.sphere.mesh,this.modelComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:material-preview","query-material-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!!this.material);const e=cc_1.director.root.device;this.dummyBuffer=e.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.UNIFORM,cc_1.gfx.MemoryUsageBit.HOST|cc_1.gfx.MemoryUsageBit.DEVICE,16)),this.dummyTexture=e.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D,cc_1.gfx.TextureUsageBit.SAMPLED,cc_1.gfx.Format.RGBA8,4,4)),this.dummySampler=e.createSampler(new cc_1.gfx.SamplerInfo),this.cameraComp.enabled=!1}setMaterial(e){if(e&&e!==this.material){const t=this.modelComp;_matInsInfo.parent=e,_matInsInfo.owner=t;const i=new cc_1.renderer.MaterialInstance(_matInsInfo);t.material=i,this.material=e;const c=t.model;if(c)for(let e=0;e<c.subModels.length;e++){const t=c.subModels[e].descriptorSet,i=t.layout.bindings;for(let e=0;e<i.length;e++){const c=i[e],s=c.binding;c.descriptorType&cc_1.gfx.DESCRIPTOR_BUFFER_TYPE?t.getBuffer(s)||t.bindBuffer(s,this.dummyBuffer):c.descriptorType&cc_1.gfx.DESCRIPTOR_SAMPLER_TYPE&&(t.getTexture(s)||t.bindTexture(s,this.dummyTexture),t.getSampler(s)||t.bindSampler(s,this.dummySampler))}}this.cameraComp.enabled=!0}}setPrimitive(e){e&&e!==this.primitive&&(this.modelComp.mesh=primitiveData[e].mesh,this.modelComp.node.setScale(primitiveData[e].scale),this.primitive=e,this.cameraComp.enabled=!0)}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this.cameraComp.node.getWorldPosition(tempVec3A),this.modelComp.node.getWorldPosition(tempVec3B),this._viewDist=vec3_1.MVec3.distance(tempVec3A,tempVec3B)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){this.cameraComp.node.getWorldRotation(tempQuatA);const i=tempQuatA;quat_1.MQuat.rotateX(i,i,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(i,i,this.id_up,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,i),quat_1.MQuat.fromEuler(i,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,this.id_forward,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),this.modelComp.node.getWorldPosition(tempVec3B),vec3_1.MVec3.add(tempVec3A,tempVec3B,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,this.id_up,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(tempVec3B,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.default=new MaterialPreview;