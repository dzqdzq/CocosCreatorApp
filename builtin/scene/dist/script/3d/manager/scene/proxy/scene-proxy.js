"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_1=__importDefault(require("../../node")),component_1=__importDefault(require("../../component")),message_1=require("../../message"),multi_scene_1=__importDefault(require("../../multi-scene"));class SceneProxy{_sceneMgr;_sceneFacade;isOpen=!1;_staging=null;rootUuid="";_isSoftReloading=!1;_needOneMoreReload=!1;_PrefabUUIDMap=new Map;constructor(e,r){this._sceneMgr=e,this._sceneFacade=r}async open(e){var r;return this.rootUuid=e,this.isOpen=!0,multi_scene_1.default.useMultipleEdit&&(r=multi_scene_1.default.getSelection(Editor.Utils.UUID.decompressUUID(e)),Editor.Selection.clear("node"),cce.Selection.clear(),r&&0<r.length&&Editor.Selection.select("node",r),console.debug(e,"scene-proxy, open finish")),Promise.resolve(!0)}async checkClose(){return Promise.resolve(!0)}async stash(){return Promise.resolve(!0)}async close(){return this.isOpen=!1,Promise.resolve(!0)}async reload(){return Promise.resolve(!0)}async softReload(e=0){return Promise.resolve(!0)}serialize(){return Promise.resolve(!0)}async queryDirty(){return Promise.resolve(!1)}async save(e){return Promise.resolve(!0)}async staging(){return Promise.resolve(!0)}async restore(e=0){return Promise.resolve(!0)}async patch(){return Promise.resolve(!0)}sendModeChangeMsg(e){this._sceneMgr.emit("mode-change",e),message_1.messageManager.broadcast("scene:change-mode",e)}queryCurrentSceneUuid(){return""}getRootNode(){return null}generatePrefabUUIDMap(r,e){if(e){var n=r._prefab;let t=e;n&&(n.instance&&(t=new Map,e.set(n.instance.fileId,t)),t.set(n.fileId,r.uuid),r.components.forEach(e=>{var r=e.__prefab;r?.fileId&&(t.has(r.fileId)?console.warn(`generatePrefabUUIDMap ${r.fileId} already exist`):t.set(r.fileId,e.uuid))}));for(let e=0;e<r.children.length;e++){var s=r.children[e];this.generatePrefabUUIDMap(s,t)}}}storePrefabUUID(r){var t=new Map;for(let e=0;e<r.children.length;e++){var n=r.children[e];this.generatePrefabUUIDMap(n,t)}return t}applyPrefabUUID(r,e){if(e){var n=r._prefab;let t=e;n&&(t=n.instance?e.get(n.instance.fileId):t)&&(e=t.get(n.fileId),node_1.default.changeNodeUUID(r.uuid,e),r.components.forEach(e=>{var r=e.__prefab;r?.fileId&&(r=t.get(r.fileId))&&component_1.default.changeUUID(e.uuid,r)}));for(let e=0;e<r.children.length;e++){var s=r.children[e];this.applyPrefabUUID(s,t)}}}restorePrefabUUID(r,t){for(let e=0;e<r.children.length;e++){var n=r.children[e];this.applyPrefabUUID(n,t)}}storeScenePrefabUUID(){var e,r=cc.director.getScene();r&&(e=this.storePrefabUUID(r),this._PrefabUUIDMap.set(r.uuid,e))}restoreScenePrefabUUID(){var e=cc.director.getScene(),e=this._PrefabUUIDMap.get(e.uuid);e&&this.restorePrefabUUID(cc.director.getScene(),e)}async loadEmptyScene(){return!0}}exports.default=SceneProxy;