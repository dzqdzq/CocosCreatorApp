"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkClose=checkClose,exports.serializePrefab=serializePrefab,exports.serializeScene=serializeScene;const cc_1=require("cc"),utils_1=require("../../prefab/utils"),component_1=__importDefault(require("../../component")),scene_cache_1=require("../scene-cache"),multi_scene_1=__importDefault(require("../../multi-scene"));async function checkClose(e){var a=await cce.Terrain.close();return 2===a?a:cce.Ipc.request("dirty-dialog",e)}async function serializePrefab(e,a){a=_serializePrefabData(a);await cce.Ipc.send("save-asset",e,a)}async function serializeScene(e,a){a&&(a.children.forEach(e=>{utils_1.prefabUtils.checkMountedRootData(e,!0)}),utils_1.prefabUtils.checkTargetOverridesData(a));var c=_serializeSceneData(a);if(!await cce.Ipc.request("query-asset-meta",e)){if(!(e=await cce.Ipc.send("create-asset","",c,"scene")))return;await cce.Ipc.send("set-scene",e)}await cce.Ipc.send("save-asset",e,c);for(const s of JSON.parse(c))if(s.__type__===cc.js.getClassName(cc_1.Terrain)){const e=s._id;var t=component_1.default.query(e);t&&t._asset&&t._asset._uuid&&await cce.Terrain.saveAssetDialog()}e!==a.uuid&&multi_scene_1.default.multiSceneClose(a.uuid,"scene"),scene_cache_1.sceneCacheManager.clearSceneCache(a.uuid),multi_scene_1.default.broadcastSceneDirty(e,"scene")}function _serializeSceneData(e){var a=new cc_1.SceneAsset;return utils_1.prefabUtils.gatherPrefabInstanceRoots(e),utils_1.prefabUtils.removeInvalidPrefabData(e),a.scene=e,cce.Utils.serialize(a)}function _serializePrefabData(e){e=utils_1.prefabUtils.getPrefabForSerialize(e).prefab;return cce.Utils.serialize(e)}