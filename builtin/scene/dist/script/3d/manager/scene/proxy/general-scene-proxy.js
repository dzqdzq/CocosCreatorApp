"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),utils_1=__importDefault(require("../utils")),cc_1=require("cc"),terrain_1=__importDefault(require("../../terrain")),component_1=__importDefault(require("../../component")),scene_cache_1=require("./../scene-cache"),message_1=require("../../message"),utils_2=require("../../prefab/utils"),serialize_1=require("../../../../export/serialize"),multi_scene_1=__importDefault(require("../../multi-scene"));class GeneralSceneProxy extends scene_proxy_1.default{current="";_sceneJustSaved=!1;get name(){return"scene"}async open(e){return this._open(e)}async _open(t,e=!0){cce.Ipc.send("clear-scene"),this._staging&&(s=new Error("Scene data has been temporarily stored. This data is about to be discarded."),console.warn(s),this._staging=null);var s=await cce.Ipc.request("query-scene");if(multi_scene_1.default.useMultipleEdit||t&&t===s||cce.Selection.clear(),t&&this.current===t&&!multi_scene_1.default.useMultipleEdit)return super.open(t),!0;if(e&&!multi_scene_1.default.useMultipleEdit){if(!await this.checkClose())return!1;await this.close()}else this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),this._staging=null;if(t&&"string"==typeof t){let e=await this._loadSceneByCache(t);if(e=e||await this._loadScene(t))return await this._afterLoadScene(),s=await Editor.Message.request("asset-db","query-asset-info",t),await cce.Ipc.send("set-scene",s?t:""),!0}return this.loadEmptyScene()}async _loadSceneByCache(e,t=!0){var s=multi_scene_1.default.getStashScene(e);return!!s&&(await utils_1.default.loadSceneByNode(s.scene),t&&multi_scene_1.default.broadcastSceneFocus(e),multi_scene_1.default.needReload(e)&&await this.softReload(),!0)}async _loadScene(t,s){try{if(s)await utils_1.default.loadSceneByJson(s);else{var a=await scene_cache_1.sceneCacheManager.loadCacheScene(t);let e=cc_1.director.getScene();a||(e=await utils_1.default.loadSceneByUuid(t)),multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.multiSceneOpen(t,e,e,"scene")}return!0}catch(e){if(console.error("Open scene failed: "+t),console.error(e),!s)return scene_cache_1.sceneCacheManager.loadCacheScene(t)}return!1}async loadEmptyScene(){return cce.Ipc.send("clear-scene"),this.current="",multi_scene_1.default.useMultipleEdit&&cce.Node.clear(),await this._loadEmptyScene(),await this._afterLoadScene(),cce.SceneFacadeManager.changeTitle(),await cce.Ipc.send("set-scene",""),!0}async _loadEmptyScene(){var e;return await scene_cache_1.sceneCacheManager.loadCacheScene("")||((e=await Editor.Message.request("asset-db","execute-custom-operation","scene","queryDefaultContent")).forEach(e=>{"cc.Scene"!==e.__type__&&e._id&&(e._id=Editor.Utils.UUID.generate())}),await utils_1.default.loadSceneByJson(e),(e=cc_1.director.getScene()?.uuid)&&(cce.Camera.updateForEmptyScene(e),multi_scene_1.default.useMultipleEdit)&&multi_scene_1.default.multiEmptySceneOpen(e,cc_1.director.getScene())),!0}async _afterLoadScene(){var e=cc_1.director.getScene(),t=e.uuid;this.current=t,this._sceneMgr.sendSceneOpenMsg(e,t,e),super.open(t)}async checkClose(){if(2===await terrain_1.default.close())return!1;var e=await this.queryDirty();if(e)switch(await cce.Ipc.request("dirty-dialog","Scene")){case 0:await this.save(!1,!1);break;case 1:await Editor.Message.request("scene","clear-scene-cache",this.current);break;case 2:return!1}return!0}async close(){var e;return this._staging&&(e=new Error("Scene data has been temporarily stored. This data is about to be discarded."),console.warn(e),this._staging=null),this.current="",this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),super.close(),!0}async reload(){var e;return this._sceneJustSaved?!(this._sceneJustSaved=!1):(e=this.current,!!await this.checkClose()&&(await this.close(),!!await this._open(e,!1)))}async softReload(e=null){var t=cc_1.director.getScene();if(!t)return!1;if(this._isSoftReloading)return!(this._needOneMoreReload=!0);try{this._isSoftReloading=!0;var s=this.storePrefabUUID(t),a=(e=e||this.serialize(!0),this._sceneMgr.sendSceneCloseMsg(t),multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.beforeUpdateSceneRef(t.uuid),await utils_1.default.loadSceneByJson(e),cc_1.director.getScene());return this.restorePrefabUUID(a,s),this._sceneMgr.sendSceneOpenMsg(a,a.uuid,a),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),multi_scene_1.default.useMultipleEdit&&this.current&&(multi_scene_1.default.updateSceneRef(a.uuid,a,a),multi_scene_1.default.endReload(a.uuid)),!0}catch(e){return console.error("Failed to refresh the current scene"),console.error(e),!1}}serialize(e=!1){var t,s;return this._staging||((t=cc_1.director.getScene())?(s=new cc_1.SceneAsset,utils_2.prefabUtils.gatherPrefabInstanceRoots(t),utils_2.prefabUtils.removeInvalidPrefabData(t),s.scene=t,e?(0,serialize_1.serializeSafe)(s):cce.Utils.serialize(s)):null)}async save(e,t=!0){var s=cc_1.director.getScene(),a=(s&&(s.children.forEach(e=>{utils_2.prefabUtils.checkMountedRootData(e,!0)}),utils_2.prefabUtils.checkTargetOverridesData(s)),this.serialize(!0));let c=!1,r="";if(c=this.current&&!e&&await cce.Ipc.request("query-asset-meta",this.current)?!0:c)this._sceneJustSaved=!0,await cce.Ipc.send("save-asset",this.current,a);else{if(!(r=await cce.Ipc.send("create-asset","",a,"scene")))return;this._sceneJustSaved=!0,await cce.Ipc.send("set-scene",r)}for(const n of JSON.parse(a))if(n.__type__===cc.js.getClassName(cc_1.Terrain)){const r=n._id;var i=component_1.default.query(r);i&&i._asset&&i._asset._uuid&&await terrain_1.default.saveAssetDialog()}return message_1.messageManager.broadcast("scene:save",r),this._sceneMgr.emit("save",cc_1.director.getScene()),await cce.Ipc.send("immediately-dump",[a,"",""]),(multi_scene_1.default.useMultipleEdit?multi_scene_1.default.getUndoManager(this.current):this._sceneFacade._undoMgr).save(),!c&&t&&await this.open(r),multi_scene_1.default.useMultipleEdit&&!c&&s&&(await multi_scene_1.default.closeScene(s.uuid,!1),scene_cache_1.sceneCacheManager.clearSceneCache(s.uuid)),c?this.current:r}async staging(){return this._staging||(this._staging=this.serialize()),!0}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene());try{var t,s;return multi_scene_1.default.useMultipleEdit&&!multi_scene_1.default.needReload(this.current)?(this._staging=null,await this._loadSceneByCache(this.current,!1),t=cc_1.director.getScene(),this._sceneMgr.sendSceneOpenMsg(t,t.uuid,t)):(this.current&&multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.beforeUpdateSceneRef(this.current),await utils_1.default.loadSceneByJson(this._staging),this.restoreScenePrefabUUID(),s=cc_1.director.getScene(),this._sceneMgr.sendSceneOpenMsg(s,s.uuid,s),this._staging=null,await super.open(s.uuid),multi_scene_1.default.useMultipleEdit&&(multi_scene_1.default.updateSceneRef(s.uuid,s,s),multi_scene_1.default.endReload(s.uuid))),!0}catch(e){return console.error(e),!1}}async queryDirty(){return cce.SceneFacadeManager.getCurrentFacade().querySceneDirty()}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return this._sceneMgr.rootNode}}exports.default=GeneralSceneProxy;