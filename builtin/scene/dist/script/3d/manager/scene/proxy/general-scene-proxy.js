"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),{existsSync:existsSync,readFileSync:readFileSync}=require("fs-extra"),editor_1=require("editor"),buffer_1=require("buffer"),utils_1=__importDefault(require("../utils")),ipc_1=__importDefault(require("../../ipc")),cc_1=require("cc"),terrain_1=__importDefault(require("../../terrain")),gameview_1=__importDefault(require("../../gameview")),component_1=__importDefault(require("../../component")),scene_cache_1=require("./../scene-cache"),message_1=require("../../message");class GeneralSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.current="",this.lastSaveData=null,this._sceneJustSaved=!1}get name(){return"scene"}async open(e){if(cc.GAME_VIEW){if(1===(await editor_1.Dialog.warn(editor_1.I18n.t("scene.contributions.messages.description.gameview_play_of_switch_scene"),{buttons:[editor_1.I18n.t("scene.contributions.messages.description.gameview_stop"),editor_1.I18n.t("scene.messages.cancel")],default:0})).response)return!1;gameview_1.default.stop()}return await this._open(e)}async _open(e,s=!0){if(cce.Ipc.send("clear-scene"),this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}const t=await cce.Ipc.send("query-scene");if(e&&e===t||cce.Selection.clear(),e&&this.current===e)return super.open(e),!0;if(s&&!await this.close())return!1;if(e&&"string"==typeof e){if(await this._loadScene(e))return await this._afterLoadScene(),await cce.Ipc.send("set-scene",e),!0}this.current="";let a="scene";const c=await Editor.Profile.getProject("engine","modules.includeModules");c&&!c.includes("3d")&&(a="scene-2d");const r=await ipc_1.default.send("query-uuid",`db://internal/default_file_content/${a}`),n=await ipc_1.default.send("query-asset-info",r);if(!existsSync(n.file))return console.error("Open scene failed: template file is not exist."),!1;let i=readFileSync(n.file);return buffer_1.Buffer.isBuffer(i)&&(i=i.toString()),await utils_1.default.loadSceneByJson(i),await this._afterLoadScene(),await cce.Ipc.send("set-scene",""),!0}async _loadScene(e,s){try{if(s)await utils_1.default.loadSceneByJson(s);else{const s=await scene_cache_1.sceneCacheManager.queryLatestCache(e);s?await utils_1.default.loadSceneByJson(s):await utils_1.default.loadSceneByUuid(e)}return!0}catch(t){if(console.error("Open scene failed: "+e),console.error(t),!s){const s=await ipc_1.default.send("query-asset-info",e),t=await scene_cache_1.sceneCacheManager.queryLastCacheInfo(e);if(t){if(0===(await Editor.Dialog.info(Editor.I18n.t("scene.messages.scene_cache.use_latest_scene",{time:scene_cache_1.formatTime(t.time),url:s&&s.url||e}),{buttons:[Editor.I18n.t("scene.messages.scene_cache.apply"),Editor.I18n.t("scene.messages.scene_cache.no")],default:1,cancel:1})).response)return await this._loadScene(e,t.json)}}}return!1}async _afterLoadScene(){const e=cc.director._scene.uuid;this.current=e,this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",e),cce.Ipc.send("scene:ready"),this.lastSaveData=this.serialize(),super.open(e)}async close(){if(this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}if(2===await terrain_1.default.close())return!1;const e=this.serialize();if(this.lastSaveData!==e){switch(await ipc_1.default.send("dirty-dialog","Scene")){case 0:await this.save();break;case 1:await Editor.Message.request("scene","clear-scene-cache");break;case 2:return!1}}return this.current="",this._sceneMgr.emit("close",cc.director._scene),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),this.lastSaveData=null,super.close(),!0}async reload(){if(this._sceneJustSaved)return this._sceneJustSaved=!1,!0;const e=this.current;return!!await this.close()&&!!await this._open(e,!1)}async softReload(e=null){const s=cc.director.getScene();if(!s)return!1;if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const t=this.storePrefabUUID(s),a=new cc.SceneAsset;return a.scene=s,e||(e=cce.Utils.serialize(a)),this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),await utils_1.default.loadSceneByJson(e),this.restorePrefabUUID(cc.director._scene,t),this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),!0}catch(e){return console.error("Failed to refresh the current scene"),console.error(e),!1}}serialize(){if(this._staging)return this._staging;const e=cc.director.getScene();if(!e)return null;const s=new cc.SceneAsset;return s.scene=e,cce.Utils.serialize(s)}async save(e){const s=this.serialize();let t=!1;if(this.current&&!e){await ipc_1.default.send("query-asset-meta",this.current)&&(t=!0)}if(this.lastSaveData=s,t)this._sceneJustSaved=!0,await ipc_1.default.send("save-asset",this.current,s);else{const e=await ipc_1.default.send("create-asset","",s,"scene");if(!e)return;this._sceneJustSaved=!0,this.open(e)}const a=JSON.parse(s);for(const e of a){if(e.__type__!==cc.js.getClassName(cc_1.Terrain))continue;const s=e._id,t=component_1.default.query(s);t._asset&&t._asset._uuid&&await terrain_1.default.saveAssetDialog()}return message_1.messageManager.broadcast("scene:save"),this._sceneMgr.emit("save",cc.director._scene),await cce.Ipc.send("immediately-dump",[this.serialize(),"",""]),this.current}async staging(){return!!this._staging||(this._staging=this.serialize(),!0)}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close");try{return await utils_1.default.loadSceneByJson(this._staging),this.restoreScenePrefabUUID(),this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._staging=null,super.open(cc.director._scene.uuid),!0}catch(e){return console.error(e),!1}}async queryDirty(){const e=this.serialize();return this.lastSaveData!==e}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return cc_1.director.getScene()}}exports.default=GeneralSceneProxy;