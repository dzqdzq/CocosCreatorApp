"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),misc_1=require("../../../../utils/misc"),utils_1=__importDefault(require("../utils")),index_1=__importDefault(require("../../ipc/index")),cc_1=require("cc"),terrain_1=__importDefault(require("../../terrain")),component_1=__importDefault(require("../../component")),scene_cache_1=require("./../scene-cache"),message_1=require("../../message"),utils_2=require("../../prefab/utils");class GeneralSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.current="",this.lastSaveData=null,this._sceneJustSaved=!1}get name(){return"scene"}async open(e){return await this._open(e)}async _open(e,t=!0){if(index_1.default.send("clear-scene"),this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}const s=await index_1.default.request("query-scene");if(e&&e===s||cce.Selection.clear(),e&&this.current===e)return super.open(e),!0;if(t){if(!await this.checkClose())return!1;await this.close()}if(e&&"string"==typeof e){if(await this._loadScene(e))return await this._afterLoadScene(),await index_1.default.send("set-scene",e),!0}return this.current="",await this._loadEmptyScene(),await this._afterLoadScene(),await index_1.default.send("set-scene",""),!0}async _loadScene(e,t){try{if(t)await utils_1.default.loadSceneByJson(t);else{await scene_cache_1.sceneCacheManager.loadCacheScene(e)||await utils_1.default.loadSceneByUuid(e)}return!0}catch(s){if(console.error("Open scene failed: "+e),console.error(s),!t)return await scene_cache_1.sceneCacheManager.loadCacheScene(e)}return!1}async _loadEmptyScene(){if(await scene_cache_1.sceneCacheManager.loadCacheScene(""))return!0;let e="scene";const t=await Editor.Profile.getProject("engine","modules.includeModules");if(t&&!t.includes("3d"))e="scene-2d";else{await Editor.Profile.getProject("project","general.highQuality")&&(e="scene-quality")}const s=await index_1.default.request("query-uuid",`db://internal/default_file_content/${e}`),a=await index_1.default.request("query-asset-info",s);if(!(0,misc_1.existsSync)(a.file))return console.error("Open scene failed: template file is not exist."),!1;const r=(0,misc_1.readFileSync)(a.file,"utf8");return await utils_1.default.loadSceneByJson(r),!0}async _afterLoadScene(){const e=cc_1.director.getScene(),t=e.uuid;this.current=t,this._sceneMgr.sendSceneOpenMsg(e,t,e),this.lastSaveData=this.serialize(),super.open(t)}async checkClose(){if(2===await terrain_1.default.close())return!1;if(await this.queryDirty()){switch(await index_1.default.request("dirty-dialog","Scene")){case 0:await this.save(!1,!1);break;case 1:await Editor.Message.request("scene","clear-scene-cache",this.current);break;case 2:return!1}}return!0}async close(){if(this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}return this.current="",this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),this.lastSaveData=null,super.close(),!0}async reload(){if(this._sceneJustSaved)return this._sceneJustSaved=!1,!0;const e=this.current;return!!await this.checkClose()&&(await this.close(),!!await this._open(e,!1))}async softReload(e=null){const t=cc_1.director.getScene();if(!t)return!1;if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const s=this.storePrefabUUID(t),a=new cc.SceneAsset;utils_2.prefabUtils.gatherPrefabInstanceRoots(t),a.scene=t,e||(e=cce.Utils.serialize(a)),this._sceneMgr.sendSceneCloseMsg(t),await utils_1.default.loadSceneByJson(e);const r=cc_1.director.getScene();return this.restorePrefabUUID(r,s),this._sceneMgr.sendSceneOpenMsg(r,r.uuid,r),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),!0}catch(e){return console.error("Failed to refresh the current scene"),console.error(e),!1}}serialize(){if(this._staging)return this._staging;const e=cc_1.director.getScene();if(!e)return null;const t=new cc.SceneAsset;return utils_2.prefabUtils.gatherPrefabInstanceRoots(e),utils_2.prefabUtils.removeInvalidPrefabData(e),t.scene=e,cce.Utils.serialize(t)}async save(e,t=!0){const s=cc_1.director.getScene();s&&(s.children.forEach(e=>{utils_2.prefabUtils.checkMountedRootData(e,!0)}),utils_2.prefabUtils.checkTargetOverridesData(s));const a=this.serialize();let r=!1;if(this.current&&!e){await index_1.default.request("query-asset-meta",this.current)&&(r=!0)}let n="";if(r)this._sceneJustSaved=!0,await index_1.default.send("save-asset",this.current,a);else{if(!(n=await index_1.default.send("create-asset","",a,"scene")))return;this._sceneJustSaved=!0,await index_1.default.send("set-scene",n)}this.lastSaveData=a;const i=JSON.parse(a);for(const e of i){if(e.__type__!==cc.js.getClassName(cc_1.Terrain))continue;const t=e._id,s=component_1.default.query(t);s&&s._asset&&s._asset._uuid&&await terrain_1.default.saveAssetDialog()}return message_1.messageManager.broadcast("scene:save",n),this._sceneMgr.emit("save",cc_1.director.getScene()),await index_1.default.send("immediately-dump",[this.serialize(),"",""]),!r&&t&&this.open(n),this._sceneFacade._undoMgr.save(),r?this.current:n}async staging(){return!!this._staging||(this._staging=this.serialize(),!0)}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene());try{await utils_1.default.loadSceneByJson(this._staging),this.restoreScenePrefabUUID();const e=cc_1.director.getScene();return this._sceneMgr.sendSceneOpenMsg(e,e.uuid,e),this._staging=null,super.open(e.uuid),!0}catch(e){return console.error(e),!1}}async queryDirty(){return await cce.SceneFacadeManager.getCurrentFacade().querySceneDirty()}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return this._sceneMgr.rootNode}}exports.default=GeneralSceneProxy;