"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),{existsSync:existsSync,readFileSync:readFileSync}=require("fs-extra"),editor_1=require("editor"),buffer_1=require("buffer"),utils_1=__importDefault(require("../utils")),ipc_1=__importDefault(require("../../ipc")),cc_1=require("cc"),terrain_1=__importDefault(require("../../terrain")),component_1=__importDefault(require("../../component"));class GeneralSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.current="",this.lastSaveData=null,this._sceneJustSaved=!1}get name(){return"scene"}async open(e){return cc.GAME_VIEW?!!await editor_1.Dialog.warn(editor_1.I18n.t("scene.contributions.messages.description.gameview_play_of_switch_scene"),{buttons:[editor_1.I18n.t("scene.messages.warning")],default:0}):await this._open(e)}async _open(e,t=!0){if(cce.Ipc.send("clear-scene"),this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}const s=await cce.Ipc.send("query-scene");if(e&&e===s||cce.Selection.clear(),e&&this.current===e)return super.open(e),!0;if(t&&!await this.close())return!1;if(e&&"string"==typeof e)try{return await utils_1.default.loadSceneByUuid(e),this.current=e,this._sceneMgr.emit("open",cc.director._scene),Editor.Message.broadcast("scene:ready",e),cce.Ipc.send("scene:ready"),this.lastSaveData=this.serialize(),super.open(e),await cce.Ipc.send("set-scene",e),this.changeTitle(),!0}catch(t){console.error("Open scene failed: "+e),console.error(t)}this.current="";const r=await ipc_1.default.send("query-uuid","db://internal/default_file_content/scene"),i=await ipc_1.default.send("query-asset-info",r);if(!existsSync(i.file))return console.error("Open scene failed: template file is not exist."),!1;let c=readFileSync(i.file);return buffer_1.Buffer.isBuffer(c)&&(c=c.toString()),await utils_1.default.loadSceneByJson(c),this._sceneMgr.emit("open",cc.director._scene),Editor.Message.broadcast("scene:ready",e),cce.Ipc.send("scene:ready"),this.lastSaveData=this.serialize(),super.open(cc.director._scene.uuid),await cce.Ipc.send("set-scene",e),this.changeTitle(),!0}async close(){if(this._staging){const e=new Error("Scene data has been temporarily stored. This data is about to be discarded.");console.warn(e),this._staging=null}if(2===await terrain_1.default.close())return!1;const e=this.serialize();if(this.lastSaveData!==e){switch(await ipc_1.default.send("dirty-dialog","Scene")){case 0:await this.save();break;case 1:break;case 2:return!1}}return this.current="",this._sceneMgr.emit("close",cc.director._scene),Editor.Message.broadcast("scene:close"),cce.Ipc.send("scene:close"),this.lastSaveData=null,super.close(),!0}async reload(){if(this._sceneJustSaved)return this._sceneJustSaved=!1,this.changeTitle(),!0;const e=this.current;return!!await this.close()&&!!await this._open(e,!1)}async softReload(e=null){const t=cc.director.getScene();if(!t)return!1;if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{return this._isSoftReloading=!0,e||(e=cce.Utils.serialize(t)),this._sceneMgr.emit("close"),Editor.Message.broadcast("scene:close"),cce.Ipc.send("scene:close"),await utils_1.default.loadSceneByJson(e),this._sceneMgr.emit("open",cc.director._scene),Editor.Message.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this.changeTitle(),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),!0}catch(e){return console.error("Failed to refresh the current scene"),console.error(e),!1}}serialize(){if(this._staging)return this._staging;const e=cc.director.getScene();if(!e)return null;const t=new cc.SceneAsset;return t.scene=e,cce.Utils.serialize(t)}async save(e){const t=this.serialize();let s=!1;if(this.current&&!e){await ipc_1.default.send("query-asset-meta",this.current)&&(s=!0)}if(this.lastSaveData=t,s)this._sceneJustSaved=!0,await ipc_1.default.send("save-asset",this.current,t);else{const e=await ipc_1.default.send("create-asset","",t,"scene");if(!e)return;this._sceneJustSaved=!0,this.current=this.rootUuid=e,await cce.Ipc.send("set-scene",e),this.changeTitle()}const r=JSON.parse(t);for(const e of r){if(e.__type__!==cc.js.getClassName(cc_1.Terrain))continue;const t=e._id,s=component_1.default.query(t);s._asset&&s._asset._uuid&&await terrain_1.default.saveAssetDialog()}return Editor.Message.broadcast("scene:save"),await cce.Ipc.send("immediately-dump",[this.serialize(),"",""]),this.current}async staging(){return!!this._staging||(this._staging=this.serialize(),!0)}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;this._sceneMgr.emit("close"),Editor.Message.broadcast("scene:close"),cce.Ipc.send("scene:close");try{return await utils_1.default.loadSceneByJson(this._staging),this._sceneMgr.emit("open",cc.director._scene),Editor.Message.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._staging=null,super.open(cc.director._scene.uuid),this.changeTitle(),!0}catch(e){return console.error(e),!1}}async queryDirty(){const e=this.serialize();return this.lastSaveData!==e}changeTitle(){setTimeout(()=>{cce.SceneFacadeManager.changeTitle()},200)}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return cc_1.director.getScene()}}exports.default=GeneralSceneProxy;