"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),misc_1=require("../../../../utils/misc"),cc_1=require("cc"),node_1=__importDefault(require("../../node")),utils_1=require("../../prefab/utils"),selection_1=__importDefault(require("../../selection")),utils_2=__importDefault(require("../utils")),node_2=__importDefault(require("../../../../utils/node")),serialize_1=require("../../../../export/serialize");class PrefabSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.node="",this._prefabJustSaved=!1}get name(){return"prefab"}async open(e){if(e&&this.current===e)return!1;if(this.current){if(!await this.checkClose())return!1;await this.close()}this._staging=null;const t=await utils_2.default.loadPrefab(e);if(await this._loadPrefabByData(e,t)){super.open(e);const t=this.getRootNode();return selection_1.default.select(t.uuid),this._prefabJustSaved=!1,!0}return!1}async _loadPrefabByData(e,t){if(!t)return this.current="",!1;const r=new cc.Scene,s=await Editor.Message.request("asset-db","query-uuid","db://internal/default_skybox/default_skybox.png");if(s){const t=await new Promise(t=>{cc.assetManager.loadAny(`${s}@b47c0`,(r,s)=>{r?(console.error(`asset can't be load:${e}`),t(null)):t(s)})});r.globals._skybox.envmap=t}const n=(0,cc_1.instantiate)(t);n._prefab.instance&&(n._prefab.instance=void 0);const i=n.components.some(e=>e&&"UITransform"===e.constructor.name),a=n.components.some(e=>e&&"Canvas"===e.constructor.name);n.parent=i&&!a?await this._sceneWrapCanvasNode(r):r,this.node=n.uuid;try{return await utils_2.default.loadSceneByNode(r),this.current=e,this._sceneMgr.sendSceneOpenMsg(r,this.current,n),super.open(e),!0}catch(t){console.error("Open prefab failed: "+e),console.error(t)}return this.current="",!1}async _sceneWrapCanvasNode(e){if(e.children[0]&&"should_hide_in_hierarchy"===e.children[0].name)return e.children[0];let t="f773db21-62b8-4540-956a-29bacf5ddbf5";"2d"===cce.SceneFacadeManager._projectType&&(t="4c33600e-9ca9-483b-b734-946008261697");const r=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(t),s=cc.instantiate(r);s.children.forEach(e=>{e.objFlags|=cc.Object.Flags.HideInHierarchy}),s._prefab=void 0,s.parent=e,s.name="should_hide_in_hierarchy",s.objFlags|=cc.Object.Flags.LockedInEditor;const n=null===s||void 0===s?void 0:s.children[0];return n&&(n.setParent=(()=>{console.error("禁止修改内置camera节点的Parent")})),s}async checkClose(){if(await this.queryDirty()){switch(await cce.Ipc.request("dirty-dialog","Prefab")){case 0:case"0":await this.save();break;case 1:case"1":break;case 2:case"2":return!1}}return!0}async close(){return selection_1.default.clear(),this.current&&utils_2.default.unloadPrefab(this.current),this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),this.current="",super.close(),!0}async reload(){if(this._prefabJustSaved)return this._prefabJustSaved=!1,!0;const e=this.current;return!!await this.checkClose()&&(await this.close(),!(!e||!await this.open(e)))}generateSceneAsset(e){const t=new cc_1.SceneAsset;utils_1.prefabUtils.removePrefabInstanceRoots(e),utils_1.prefabUtils.gatherPrefabInstanceRoots(e);const r=node_1.default.query(this.node);return r&&(utils_1.prefabUtils.removePrefabInstanceRoots(r),utils_1.prefabUtils.gatherPrefabInstanceRoots(r)),t.scene=e,t}async softReload(e=null){const t=cc_1.director.getScene();if(!t)return Promise.resolve(!1);if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const r=this.storePrefabUUID(t),s=this.generateSceneAsset(t);e||(e=(0,serialize_1.serializeSafe)(s)),this._sceneMgr.sendSceneCloseMsg(t),await utils_2.default.loadSceneByJson(e);const n=cc_1.director.getScene();utils_1.prefabUtils.removePrefabInstanceRoots(n),this.restorePrefabUUID(n,r);const i=node_1.default.query(this.node);if(!i)return console.error(`Node with UUID ${this.node} not exist!`),!1;cc_1.Prefab._utils.applyTargetOverrides(i),this._sceneMgr.sendSceneOpenMsg(n,this.current,i),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload())}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return Promise.resolve(!0)}serialize(e=!1){let t=node_1.default.query(this.node);if(!t){console.warn(`can't find node in current scene: ${this.node}`);const e=cc_1.director.getScene();if(!e)return"";let r=null;for(let t=0;t<e.children.length;t++){const s=e.children[t];if(!node_2.default.isEditorNode(s)){r=s;break}}if(!r)return"";if(r._prefab)t=r;else for(let e=0;e<r.children.length;e++){const s=r.children[e];if(s._prefab){t=s;break}}}if(!t)return console.warn("can't find prefab root node in current scene"),"";const{prefab:r}=utils_1.prefabUtils.getPrefabForSerialize(t);return e?(0,serialize_1.serializeSafe)(r):cce.Utils.serialize(r)}async save(e){const t=node_1.default.query(this.node);t&&utils_1.prefabUtils.checkMountedRootData(t,!0);let r=!1;if(this.current&&!e){await cce.Ipc.request("query-asset-meta",this.current)&&(r=!0)}const s=this.serialize(!0);if(r)this._prefabJustSaved=!0,await cce.Ipc.send("save-asset",this.current,s);else{const e=await cce.Ipc.request("create-asset","",s,"prefab");if(!e)return;this._prefabJustSaved=!0,this.open(e)}return this._sceneMgr.emit("save",cc_1.director.getScene()),this._sceneFacade._undoMgr.save(),Promise.resolve(!0)}async staging(){if(this._staging)return!0;const e=cc_1.director.getScene(),t=this.generateSceneAsset(e);return this._staging=(0,serialize_1.serializeSafe)(t),!0}async restore(e){if(e&&(this._staging=e),!this._staging)return!1;if(this.current){this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),super.restore(),await utils_2.default.loadSceneByJson(this._staging);const e=node_1.default.query(this.node);if(!e)return console.error(`Node with UUID ${this.node} does not exist!`),!1;cc_1.Prefab._utils.applyTargetOverrides(e);const t=cc_1.director.getScene();return this._sceneMgr.sendSceneOpenMsg(t,this.current,e),this._staging=null,super.open(t.uuid),!0}return!1}async queryDirty(){return await cce.SceneFacadeManager.getCurrentFacade().querySceneDirty()}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return this._sceneMgr.rootNode}}exports.default=PrefabSceneProxy;