"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),misc_1=require("../../../../utils/misc"),cc_1=require("cc"),node_1=__importDefault(require("../../node")),utils_1=require("../../prefab/utils"),selection_1=__importDefault(require("../../selection")),utils_2=__importDefault(require("../utils")),node_2=__importDefault(require("../../../../utils/node")),multi_scene_1=__importDefault(require("../../multi-scene")),serialize_1=require("../../../../export/serialize"),create_1=require("../../node/create");class PrefabSceneProxy extends scene_proxy_1.default{current;node="";_prefabJustSaved=!1;get name(){return"prefab"}async open(e){if(e&&this.current===e)return!1;if(this.current&&!multi_scene_1.default.useMultipleEdit){if(!await this.checkClose())return!1;await this.close()}else this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene());var t;return this._staging=null,!(!await this._loadPrefab(e)||(super.open(e),t=this.getRootNode(),multi_scene_1.default.useMultipleEdit&&!multi_scene_1.default.getSelection(e)&&selection_1.default.select(t.uuid),this._prefabJustSaved=!1))}async _loadPrefab(t){var e=multi_scene_1.default.getStashScene(t);if(e){try{return await utils_2.default.loadSceneByNode(e.scene),cce.Engine.repaintInEditMode(),this.current=t,this.node=e.rootNode.uuid,e.rootNode._prefab.instance&&(e.rootNode._prefab.instance=void 0),this._sceneMgr.sendSceneOpenMsg(e.scene,this.current,e.rootNode),multi_scene_1.default.broadcastSceneFocus(this.current),multi_scene_1.default.needReload(t)&&await this.softReload(),!0}catch(e){console.error("Open prefab failed: "+t),console.error(e)}return this.current="",!1}return this._loadPrefabById(t)}async _loadPrefabById(s){var e=await utils_2.default.loadPrefab(s);if(e){var t=new cc.Scene;t.name=e.name+"-scene";const a=await Editor.Message.request("asset-db","query-uuid","db://internal/default_skybox/default_skybox.png");a&&(r=await new Promise(r=>{cc_1.assetManager.loadAny(a+"@b47c0",(e,t)=>{e?(console.error("asset can't be load:"+s),r(null)):r(t)})}),t.globals)&&t.globals.skybox&&r&&(t.globals.skybox.envmap=r);var r=(0,cc_1.instantiate)(e),e=(r._prefab.instance&&(r._prefab.instance=void 0),r.getComponentsInChildren(cc_1.UITransform).some(e=>e&&"UITransform"===e.constructor.name)),n=r.components.some(e=>e&&"Canvas"===e.constructor.name);r.parent=e&&!n?await(0,create_1.createShouldHideInHierarchyCanvasNode)(t):t,this.node=r.uuid;try{return await utils_2.default.loadSceneByNode(t),this.current=s,this._sceneMgr.sendSceneOpenMsg(t,this.current,r),super.open(s),multi_scene_1.default.multiSceneOpen(s,t,r,"prefab"),!0}catch(e){console.error("Open prefab failed: "+s),console.error(e)}}return this.current="",!1}async _sceneWrapCanvasNode(e){if(e.children[0]&&"should_hide_in_hierarchy"===e.children[0].name)return e.children[0];let t="f773db21-62b8-4540-956a-29bacf5ddbf5";"2d"===cce.SceneFacadeManager._projectType&&(t="4c33600e-9ca9-483b-b734-946008261697");var r=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(t),r=cc.instantiate(r),e=(r.children.forEach(e=>{e.objFlags|=cc.Object.Flags.HideInHierarchy}),r._prefab=void 0,r.parent=e,r.name="should_hide_in_hierarchy",r.objFlags|=cc.Object.Flags.LockedInEditor,r?.children[0]);return e&&(e.setParent=()=>{console.error("禁止修改内置camera节点的Parent")}),r}async _checkClose(){var e=await this.queryDirty();if(e)switch(await cce.Ipc.request("dirty-dialog","Prefab")){case 0:case"0":await this.save();break;case 1:case"1":break;case 2:case"2":return!1}return!0}async checkClose(){return!!multi_scene_1.default.useMultipleEdit||this._checkClose()}async close(){return selection_1.default.clear(),this.current&&utils_2.default.unloadPrefab(this.current),this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),this.current="",super.close(),!0}async reload(){var e;return this._prefabJustSaved?!(this._prefabJustSaved=!1):(e=this.current,!(!await this._checkClose()||(await this.close(),!e)||!await this.open(e)))}generateSceneAsset(e){var t=new cc_1.SceneAsset,r=(utils_1.prefabUtils.removePrefabInstanceRoots(e),utils_1.prefabUtils.gatherPrefabInstanceRoots(e),node_1.default.query(this.node));return r&&(utils_1.prefabUtils.removePrefabInstanceRoots(r),utils_1.prefabUtils.gatherPrefabInstanceRoots(r)),t.scene=e,t}async softReload(e=null){var t=cc_1.director.getScene();if(!t)return Promise.resolve(!1);if(this._isSoftReloading)return!(this._needOneMoreReload=!0);try{this._isSoftReloading=!0;var r=this.storePrefabUUID(t),s=this.generateSceneAsset(t),n=(e=e||(0,serialize_1.serializeSafe)(s),this._sceneMgr.sendSceneCloseMsg(t),this.current&&multi_scene_1.default.useMultipleEdit&&multi_scene_1.default.beforeUpdateSceneRef(this.current),await utils_2.default.loadSceneByJson(e),cc_1.director.getScene()),a=(utils_1.prefabUtils.removePrefabInstanceRoots(n),this.restorePrefabUUID(n,r),node_1.default.query(this.node));if(!a)return console.error(`Node with UUID ${this.node} not exist!`),!1;cc_1.Prefab._utils.applyTargetOverrides(a),this._sceneMgr.sendSceneOpenMsg(n,this.current,a),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload()),multi_scene_1.default.useMultipleEdit&&this.current&&(multi_scene_1.default.updateSceneRef(this.current,n,a),multi_scene_1.default.endReload(this.current))}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return Promise.resolve(!0)}serialize(e=!1){if(!this.node)return"";let r=node_1.default.query(this.node);if(!r){console.warn("can't find node in current scene: "+this.node);var s=cc_1.director.getScene();if(!s)return"";let t=null;for(let e=0;e<s.children.length;e++){var n=s.children[e];if(!node_2.default.isEditorNode(n)){t=n;break}}if(!t)return"";if(t._prefab)r=t;else for(let e=0;e<t.children.length;e++){var a=t.children[e];if(a._prefab){r=a;break}}}var t;return r?(t=utils_1.prefabUtils.getPrefabForSerialize(r)["prefab"],e?(0,serialize_1.serializeSafe)(t):cce.Utils.serialize(t)):(console.warn("can't find prefab root node in current scene"),"")}async save(e){var t=node_1.default.query(this.node);t&&utils_1.prefabUtils.checkMountedRootData(t,!0);let r=!1;this.current&&!e&&await cce.Ipc.request("query-asset-meta",this.current)&&(r=!0);t=this.serialize(!0);if(r)this._prefabJustSaved=!0,await cce.Ipc.send("save-asset",this.current,t);else{e=await cce.Ipc.request("create-asset","",t,"prefab");if(!e)return;this._prefabJustSaved=!0,this.open(e)}return this._sceneMgr.emit("save",cc_1.director.getScene()),(multi_scene_1.default.useMultipleEdit&&this.current?multi_scene_1.default.getUndoManager(this.current):this._sceneFacade._undoMgr).save(),Promise.resolve(!0)}async staging(){var e;return this._staging||(e=cc_1.director.getScene(),e=this.generateSceneAsset(e),this._staging=(0,serialize_1.serializeSafe)(e)),!0}async restore(e=void 0){if(e&&(this._staging=e),this._staging&&this.current){this._sceneMgr.sendSceneCloseMsg(cc_1.director.getScene()),super.restore(),await utils_2.default.loadSceneByJson(this._staging);e=node_1.default.query(this.node);if(!e)return console.error(`Node with UUID ${this.node} does not exist!`),!1;cc_1.Prefab._utils.applyTargetOverrides(e);var t=cc_1.director.getScene();return this._sceneMgr.sendSceneOpenMsg(t,this.current,e),this._staging=null,multi_scene_1.default.useMultipleEdit&&this.current&&(multi_scene_1.default.updateSceneRef(this.current,t,e),multi_scene_1.default.endReload(this.current)),super.open(this.current),!0}return!1}async queryDirty(){return cce.SceneFacadeManager.getCurrentFacade().querySceneDirty()}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return this._sceneMgr.rootNode}}exports.default=PrefabSceneProxy;