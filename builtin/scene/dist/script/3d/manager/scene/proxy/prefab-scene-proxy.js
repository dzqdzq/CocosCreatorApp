"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),{promisify:promisify}=require("util"),cc_1=require("cc"),node_1=__importDefault(require("../../node")),utils_1=require("../../prefab/utils"),selection_1=__importDefault(require("../../selection")),utils_2=__importDefault(require("../utils")),ipc_1=__importDefault(require("../../ipc")),node_2=__importDefault(require("../../../../utils/node")),message_1=require("../../message");class PrefabSceneProxy extends scene_proxy_1.default{constructor(){super(...arguments),this.node="",this.lastSaveData=null,this._prefabJustSaved=!1}get name(){return"prefab"}async open(e){if(e&&this.current===e)return!1;if(this.current&&!await this.close())return!1;const t=await utils_2.default.loadPrefab(e);if(await this._loadPrefabByData(e,t)){super.open(e),selection_1.default.clear();const t=this.getRootNode();return selection_1.default.select(t.uuid),this._prefabJustSaved=!1,!0}return!1}async _loadPrefabByData(e,t){if(!t)return this.current="",!1;const s=new cc.Scene,r=cc_1.instantiate(t),a=r.components.some(e=>e&&"UITransform"===e.constructor.name),c=r.components.some(e=>e&&"Canvas"===e.constructor.name);r.parent=a&&!c?await this._sceneWrapCanvasNode(s):s,this.node=r.uuid;try{return await utils_2.default.loadSceneByNode(s),this.current=e,this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",this.current),cce.Ipc.send("scene:ready"),this.lastSaveData||(this.lastSaveData=this.serialize()),super.open(e),!0}catch(t){console.error("Open prefab failed: "+e),console.error(t)}return this.current="",!1}async _sceneWrapCanvasNode(e){if(e.children[0]&&"should_hide_in_hierarchy"===e.children[0].name)return e.children[0];const t=await promisify(cc_1.assetManager.loadAny)("f773db21-62b8-4540-956a-29bacf5ddbf5"),s=cc.instantiate(t);return s.children.forEach(e=>{e.objFlags|=cc.Object.Flags.HideInHierarchy}),s._prefab=void 0,s.parent=e,s.name="should_hide_in_hierarchy",s.objFlags|=cc.Object.Flags.LockedInEditor,s}async close(){selection_1.default.clear();const e=this.serialize();if(this.lastSaveData!==e){switch(await cce.Ipc.send("dirty-dialog","Prefab")){case 0:case"0":await this.save();break;case 1:case"1":break;case 2:case"2":return!1}}return this.current&&utils_2.default.unloadPrefab(this.current),this.current="",this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),this.lastSaveData=null,super.close(),!0}async reload(){if(this._prefabJustSaved)return this._prefabJustSaved=!1,!0;const e=this.current;return!!await this.close()&&!(!e||!await this.open(e))}async softReload(e=null){const t=cc.director.getScene();if(!t)return Promise.resolve(!1);if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const s=this.storePrefabUUID(t),r=new cc.SceneAsset;r.scene=t,e||(e=cce.Utils.serialize(r)),this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),await utils_2.default.loadSceneByJson(e),this.restorePrefabUUID(cc.director._scene,s),this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",this.current),cce.Ipc.send("scene:ready"),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload())}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return Promise.resolve(!0)}serialize(){let e=node_1.default.query(this.node);if(!e){console.warn(`can't find node in current scene: ${this.node}`);const t=cc_1.director.getScene();if(!t)return"";let s=null;for(let e=0;e<t.children.length;e++){const r=t.children[e];if(!node_2.default.isEditorNode(r)){s=r;break}}if(!s)return"";if(s._prefab)e=s;else for(let t=0;t<s.children.length;t++){const r=s.children[t];if(r._prefab){e=r;break}}}if(!e)return console.warn("can't find prefab root node in current scene"),"";const t=new cc.Prefab,s=utils_1.prefabUtils.getDumpableNode(e);return utils_2.default.recursiveNode(s,e=>{if(e.objFlags&cc.Object.Flags.HideInHierarchy)return;const r=e._prefab;r&&r.root===s&&(r.asset=t)}),t.data=s,null!==s.parent?(console.error("Error: serialize prefab failed."),""):cce.Utils.serialize(t)}async save(e){let t=!1;if(this.current&&!e){await ipc_1.default.send("query-asset-meta",this.current)&&(t=!0)}let s=this.serialize();if(s?this.lastSaveData=s:(console.error("The data used to save is empty, use last saved data to save"),s=this.lastSaveData),t)this._prefabJustSaved=!0,await cce.Ipc.send("save-asset",this.current,s);else{const e=await ipc_1.default.send("create-asset","",s,"prefab");if(!e)return;this._prefabJustSaved=!0,this.open(e)}return this._sceneMgr.emit("save",cc.director._scene),Promise.resolve(!0)}async staging(){if(this._staging)return!0;const e=cc.director.getScene(),t=new cc.SceneAsset;return t.scene=e,this._staging=cce.Utils.serialize(t),!0}async restore(e){return e&&(this._staging=e),!!this._staging&&(!!this.current&&(this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),super.restore(),await utils_2.default.loadSceneByJson(this._staging),this._sceneMgr.emit("open",cc.director._scene),message_1.messageManager.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._staging=null,super.open(cc.director._scene.uuid),!0))}async queryDirty(){const e=this.serialize();return this.lastSaveData!==e}queryCurrentSceneUuid(){return this.current||""}getRootNode(){return node_1.default.query(this.node)}}exports.default=PrefabSceneProxy;