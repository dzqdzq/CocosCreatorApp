"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,s)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),dumpEncode=__importStar(require("../../../../utils/dump/encode")),dumpDecode=__importStar(require("../../../../utils/dump/decode")),utils_1=__importDefault(require("../utils")),cc_1=require("cc"),animation_1=__importDefault(require("../../animation")),message_1=require("../../message"),animCompRE=/Animation/;class AnimationSceneProxy extends scene_proxy_1.default{constructor(e,t){super(e,t),this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[],this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[]}get name(){return"animation"}getType(e,t){let o=null;if(cc_1.CCClass._isCCClass(e.constructor)){o=require("../../animation/utils").utils.getCCClassAnimablePropType(e,t)}else{o=typeof e[t]}return o}async open(e){return this.root=e,this.rootNodeDump=null,cce.Node.query(this.root)?(this._sceneMgr.emit("animation-start",e),message_1.messageManager.broadcast("scene:animation-start",e),super.open(e),Promise.resolve(!0)):Promise.resolve(!1)}async checkClose(){return await animation_1.default.saveCheck()}async close(){const e=cce.Node.query(this.root);return!!e&&(animation_1.default.restoreData(),this.rootNodeDump=dumpEncode.encodeNode(e),animation_1.default.record(this.root,!1),this.root="",this._sceneMgr.emit("animation-end"),message_1.messageManager.broadcast("scene:animation-end"),super.close(),!0)}async reload(){return Promise.resolve(!0)}async softReload(){const e=cc_1.director.getScene();if(!e)return!1;if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const t=this.storePrefabUUID(e),o=new cc.SceneAsset;o.scene=e;const r=cce.Utils.serialize(o);this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),await utils_1.default.loadSceneByJson(r),this.restorePrefabUUID(cc.director._scene,t),this._sceneMgr.emit("open",cc_1.director._scene),message_1.messageManager.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload())}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return!0}serialize(){return animation_1.default.getSerializedEditClip()}async queryDirty(){return animation_1.default.isDirty()}async save(){const e=await animation_1.default.save();return e&&this._sceneFacade._undoMgr.save(),e}async patch(){if(!this.rootNodeDump)return Promise.resolve(!1);const e=cce.Node.query(this.rootNodeDump.uuid.value);if(!e)return Promise.resolve(!1);const t=e.getComponent("cc.Animation");let o=null;if(this.rootNodeDump.__comps__.some(e=>!!animCompRE.test(e.cid)&&(o=e,!0)),!t||!o)return Promise.resolve(!1);for(const e in o.value)e in o.value&&await dumpDecode.decodePatch(e,o.value[e],t);return dumpDecode.decodeMountedRoot(t,o.mountedRoot),cce.Node.emit("change",t.node),Promise.resolve(!0)}getRootNode(){return cc_1.director.getScene()}}exports.default=AnimationSceneProxy;