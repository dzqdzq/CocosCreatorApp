"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_proxy_1=__importDefault(require("./scene-proxy")),dumpEncode=__importStar(require("../../../../../utils/dump/encode")),dumpDecode=__importStar(require("../../../../../utils/dump/decode")),utils_1=__importDefault(require("../utils")),cc_1=require("cc"),animation_1=__importDefault(require("../../animation")),message_1=require("../../message"),animCompRE=/Animation/;class AnimationSceneProxy extends scene_proxy_1.default{constructor(e){super(e),this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[],this.root="",this.rootNodeDump=null,this.materialsDump=null,this.duplicateMatUuids=[]}get name(){return"animation"}getType(e,t){let r=null;if(cc_1.CCClass._isCCClass(e.constructor)){r=require("../../animation/utils").utils.getCCClassAnimablePropType(e,t)}else{r=typeof e[t]}return r}async open(e){return this.root=e,this.rootNodeDump=null,cce.Node.query(this.root)?(this._sceneMgr.emit("animation-start",e),message_1.messageManager.broadcast("scene:animation-start",e),super.open(e),Promise.resolve(!0)):Promise.resolve(!1)}async close(){const e=cce.Node.query(this.root);if(!e)return!1;const t=animation_1.default.queryRecordAnimData();return!!await animation_1.default.saveCheck(t)&&(animation_1.default.restoreData(),this.rootNodeDump=dumpEncode.encodeNode(e),this.root="",this._sceneMgr.emit("animation-end"),message_1.messageManager.broadcast("scene:animation-end"),super.close(),!0)}async reload(){return Promise.resolve(!0)}async softReload(){const e=cc_1.director.getScene();if(!e)return!1;if(this._isSoftReloading)return this._needOneMoreReload=!0,!1;try{this._isSoftReloading=!0;const t=this.storePrefabUUID(e),r=new cc.SceneAsset;r.scene=e;const o=cce.Utils.serialize(r);this._sceneMgr.emit("close"),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close"),await utils_1.default.loadSceneByJson(o),this.restorePrefabUUID(cc.director._scene,t),this._sceneMgr.emit("open",cc_1.director._scene),message_1.messageManager.broadcast("scene:ready",cc.director._scene.uuid),cce.Ipc.send("scene:ready"),this._isSoftReloading=!1,this._needOneMoreReload&&(this._needOneMoreReload=!1,this.softReload())}catch(e){console.error("Failed to refresh the current scene"),console.error(e)}return!0}serialize(){return animation_1.default.getSerializedEditClip()}async queryDirty(){return animation_1.default.isDirty()}async save(){return animation_1.default.save()}async patch(){if(!this.rootNodeDump)return Promise.resolve(!1);const e=cce.Node.query(this.rootNodeDump.uuid.value);if(!e)return Promise.resolve(!1);const t=e.getComponent("cc.Animation");let r=null;if(this.rootNodeDump.__comps__.some(e=>!!animCompRE.test(e.cid)&&(r=e,!0)),!t||!r)return Promise.resolve(!1);for(const e in r.value)e in r.value&&await dumpDecode.decodePatch(e,r.value[e],t);return dumpDecode.decodeMountedRoot(t,r.mountedRoot),Promise.resolve(!0)}getRootNode(){return cc_1.director.getScene()}}exports.default=AnimationSceneProxy;