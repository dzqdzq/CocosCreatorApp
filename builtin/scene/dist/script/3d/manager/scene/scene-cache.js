"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.formatTime=exports.sceneCacheManager=void 0;const fs_extra_1=require("fs-extra"),utils_1=__importDefault(require("./utils"));class SceneCacheManager{constructor(){this.useSceneCache=!0}async init(){const e=await Editor.Profile.getConfig("scene","scene_cache");this.useSceneCache=e.use,e.use||console.log("The scene instant cache function is turned off")}async queryLatestCache(e){if(!this.useSceneCache)return;const t=await this.queryLastCacheInfo(e);if(t&&0===(await Editor.Dialog.info(Editor.I18n.t("scene.messages.scene_cache.use_latest_scene",{time:formatTime(t.time),url:t.url}),{buttons:[Editor.I18n.t("scene.messages.scene_cache.apply"),Editor.I18n.t("scene.messages.scene_cache.no")],default:1,cancel:1})).response)try{return t.json}catch(e){console.error(e)}}async loadCacheScene(e=""){const t=await this.queryLatestCache(e);if(!t)return!1;try{return await utils_1.default.loadSceneByJson(t),!0}catch(t){return this.clearSceneCache(e),console.error("Open cache scene failedÔºÅ"),console.error(t),!1}}async queryLastCacheInfo(e){const t=await Editor.Message.request("scene","query-latest-cache",e);if(t)try{return{time:t.time,json:t.data||(0,fs_extra_1.readJSONSync)(t.file),url:t.url}}catch(e){console.error(e)}}clearSceneCache(e){Editor.Message.send("scene","clear-scene-cache",e)}}function formatTime(e){return new Date(e).toLocaleString()}exports.sceneCacheManager=new SceneCacheManager,exports.formatTime=formatTime;