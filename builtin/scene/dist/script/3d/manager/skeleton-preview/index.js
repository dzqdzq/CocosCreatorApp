"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),util_1=require("util"),controller_utils_1=__importDefault(require("../../../public/gizmos/3d/elements/utils/controller-utils")),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;function getBoundaryOfMeshNode(e){var t;if(e){const o=e.getComponent(cc_1.MeshRenderer);let i;if(o instanceof cc_1.SkinnedMeshRenderer)i=null===(t=null===o||void 0===o?void 0:o.model)||void 0===t?void 0:t.worldBounds;else if(o&&o.mesh){if(!(i=o.model&&o.model.modelBounds)){const e=o.mesh;e&&(i=cc_1.geometry.aabb.fromPoints(cc_1.geometry.aabb.create(),e.minPosition,e.maxPosition))}i&&cc_1.geometry.aabb.transform(i,i,e.worldMatrix)}return i}}class JointData{constructor(){this.childJoint=[],this.position=new cc_1.Vec3}}class SkeletonPreview{constructor(){this._isMouseDown=!1,this._viewDist=0,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._jointMap={}}init(){this.scene=new cc.Scene,this.cameraComp=new cc.Node("Skeleton Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Skeleton Preview Light").addComponent(cc_1.DirectionalLight),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(cc_1.Vec3.ZERO),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:skeleton-preview","query-skeleton-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!0),this.cameraComp.enabled=!1}async setSkeleton(e){if(!e)return void console.warn("invalid uuid");this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.destroy()),cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e));const t=await util_1.promisify(cc_1.assetManager.loadAny)(e);if(t.joints.length!==t.bindposes.length)return void console.error("joints number not equal to bindposes number");this._jointMap={};const o=[],i=[];for(let e=0;e<t.joints.length;e++){const o=t.joints[e],i=t.inverseBindposes[e],s=new JointData;cc_1.Vec3.transformMat4(s.position,s.position,i),this._jointMap[o]=s}for(let e=0;e<t.joints.length;e++){const s=t.joints[e],n=s.lastIndexOf("/");if(n>0){const e=s.substring(0,n),t=this._jointMap[e],c=this._jointMap[s];t&&(t.childJoint.push(c),o.push(t.position,c.position),i.push(o.length-2,o.length-1))}}const s=controller_utils_1.default.lines(o,i,cc_1.Color.GREEN,{forwardPipeline:!0});s.layer=cc_1.Layers.Enum.DEFAULT,s.parent=this.scene,this._modelNode=s,this.cameraComp.enabled=!0,this.perfectCameraView(),Editor.Message.broadcast("scene:skeleton-preview-skeleton-info",{jointCount:t.joints.length})}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=getBoundaryOfMeshNode(this._modelNode);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),o=this.cameraComp.fov,i=1.2*t/Math.tan(o/2*Math.PI/180);return this.cameraComp.near=i-t,this.cameraComp.far=i+t,i}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const o=this._curCameraRot;quat_1.MQuat.rotateX(o,o,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(o,o,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,o),quat_1.MQuat.fromEuler(o,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,o),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,o),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.default=new SkeletonPreview;