"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),quat_1=require("../../../utils/math/quat"),vec3_1=require("../../../utils/math/vec3"),controller_utils_1=__importDefault(require("../../../public/gizmos/3d/elements/utils/controller-utils")),node_1=__importDefault(require("../../../utils/node")),asset_1=require("../../../utils/asset"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;class JointData{constructor(){this.childJoint=[],this.position=new cc_1.Vec3}}class SkeletonPreview{constructor(){this._isMouseDown=!1,this._viewDist=0,this.orbitRotateSpeed=.01,this._curCameraRot=new cc_1.Quat,this._viewCenter=new cc_1.Vec3,this._jointMap={}}init(){this.scene=new cc.Scene,this.cameraComp=new cc.Node("Skeleton Preview Camera").addComponent(cc_1.Camera),this.lightComp=new cc.Node("Skeleton Preview Light").addComponent(cc_1.DirectionalLight),this.cameraComp.node.parent=this.scene,this.cameraComp.node.setPosition(0,1,2.5),this.cameraComp.node.lookAt(new cc_1.Vec3),this.cameraComp.near=.01,this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=this.scene,this.scene._load(),this.scene._activate(),this.cameraComp.clearColor=new cc_1.Color(71,71,71,255),this.camera=this.cameraComp.camera,this.camera.isWindowSize=!1,this.previewBuffer=new cce.PreviewBuffer("scene:skeleton-preview","query-skeleton-preview-data",this.scene),this.camera.changeTargetWindow(this.previewBuffer.window),this.previewBuffer.beforeDataHandle=(()=>!0),this.cameraComp.enabled=!1}async setSkeleton(e){if(!e)return void console.warn("invalid uuid");const t=await asset_1.loadAssetUncached(e,cc_1.Skeleton);if(t.joints.length!==t.bindposes.length)return void console.error("joints number not equal to bindposes number");this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.destroy());const i=new cc_1.Node("SkeletonRoot");i.layer=cc_1.Layers.Enum.DEFAULT,this._jointMap={};for(let e=0;e<t.joints.length;e++){const i=t.joints[e],o=t.inverseBindposes[e],s=new JointData;cc_1.Vec3.transformMat4(s.position,s.position,o),this._jointMap[i]=s}for(let e=0;e<t.joints.length;e++){const o=t.joints[e],s=o.lastIndexOf("/");if(s>0){const e=o.substring(0,s),t=this._jointMap[e],c=this._jointMap[o];if(t){t.childJoint.push(c);const e=controller_utils_1.default.octahedron(c.position,t.position,.15,.15,.8,cc_1.Color.GRAY,{effectName:"builtin-standard"});e.parent=i,e.layer=cc_1.Layers.Enum.DEFAULT}}}return i.parent=this.scene,this._modelNode=i,this.cameraComp.enabled=!0,this.perfectCameraView(),{jointCount:t.joints.length}}perfectCameraView(){this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,this._curCameraRot),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3B,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3B),this.cameraComp.node.lookAt(this._viewCenter),cce.Engine.repaintInEditMode()}getFitDistance(){const e=node_1.default.getBoundaryOfMeshNodes([this._modelNode]);if(!e)return 0;this._viewCenter=e.center;const t=e.halfExtents.length(),i=this.cameraComp.fov,o=1.2*t/Math.tan(i/2*Math.PI/180);return this.cameraComp.near=o-t,this.cameraComp.far=o+t,o}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}onMouseDown(e){this._isMouseDown=!0,this._viewDist=this.getFitDistance(),this.cameraComp.node.getWorldRotation(this._curCameraRot)}onMouseMove(e){this.move(0|e.movementX,0|e.movementY)}onMouseUp(e){this._isMouseDown=!1}move(e,t){if(this._isMouseDown){const i=this._curCameraRot;quat_1.MQuat.rotateX(i,i,-t*this.orbitRotateSpeed),quat_1.MQuat.rotateAround(i,i,cc_1.Vec3.UNIT_Y,-e*this.orbitRotateSpeed),quat_1.MQuat.toEuler(tempVec3A,i),quat_1.MQuat.fromEuler(i,tempVec3A.x,tempVec3A.y,0),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Z,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),vec3_1.MVec3.multiplyScalar(tempVec3A,tempVec3A,this._viewDist),vec3_1.MVec3.add(tempVec3A,this._viewCenter,tempVec3A),this.cameraComp.node.setWorldPosition(tempVec3A),vec3_1.MVec3.transformQuat(tempVec3A,cc_1.Vec3.UNIT_Y,i),vec3_1.MVec3.normalize(tempVec3A,tempVec3A),this.cameraComp.node.lookAt(this._viewCenter,tempVec3A)}}hide(){this.cameraComp.enabled=!1}}exports.default=new SkeletonPreview;