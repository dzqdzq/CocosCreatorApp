"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SkeletonPreview=void 0;const cc_1=require("cc"),misc_1=require("../../../utils/misc"),controller_utils_1=__importDefault(require("../../../public/gizmos/3d/elements/utils/controller-utils")),node_1=__importDefault(require("../../../utils/node")),Interactive_preview_1=require("../preview/Interactive-preview"),regions=[new cc_1.gfx.BufferTextureCopy];regions[0].texExtent.depth=1;const tempVec3A=new cc_1.Vec3,tempVec3B=new cc_1.Vec3,tempQuatA=new cc_1.Quat;class JointData{constructor(){this.childJoint=[],this.position=new cc_1.Vec3}}class SkeletonPreview extends Interactive_preview_1.InteractivePreview{constructor(){super(...arguments),this._jointMap={}}init(e,t){super.init(e,t)}createNodes(e){this.lightComp=new cc.Node("Skeleton Preview Light").addComponent(cc_1.DirectionalLight),this.lightComp.node.setRotationFromEuler(-45,-45,0),this.lightComp.node.parent=e}async setSkeleton(e){if(!e)return console.warn("invalid uuid"),null;this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid&&this._modelNode.destroy()),cc_1.assetManager.assets.has(e)&&cc_1.assetManager.releaseAsset(cc_1.assetManager.assets.get(e));const t=await(0,misc_1.promisify)(cc_1.assetManager.loadAny)(e);if(t.joints.length!==t.bindposes.length)return console.error("joints number not equal to bindposes number"),null;this._modelNode&&(this.scene.removeChild(this._modelNode),this._modelNode.isValid&&this._modelNode.destroy());const i=new cc_1.Node("SkeletonRoot");i.layer=cc_1.Layers.Enum.DEFAULT,this._jointMap={};for(let e=0;e<t.joints.length;e++){const i=t.joints[e],o=t.inverseBindposes[e],s=new JointData;cc_1.Vec3.transformMat4(s.position,s.position,o),this._jointMap[i]=s}for(let e=0;e<t.joints.length;e++){const o=t.joints[e],s=o.lastIndexOf("/");if(s>0){const e=o.substring(0,s),t=this._jointMap[e],n=this._jointMap[o];if(t){t.childJoint.push(n);const e=controller_utils_1.default.octahedron(n.position,t.position,.15,.15,.8,cc_1.Color.GRAY,{effectName:"builtin-standard"});e.parent=i,e.layer=cc_1.Layers.Enum.DEFAULT}}}return i.parent=this.scene,this._modelNode=i,this.cameraComp.enabled=!0,this.resetCamera(),this.perfectCameraView(node_1.default.getBoundaryOfMeshNodes([this._modelNode])),{jointCount:t.joints.length}}setLightEnable(e){this.lightComp.enabled!==e&&(this.lightComp.enabled=e)}resetCamera(){this._modelNode&&super.resetCamera(this._modelNode)}}exports.SkeletonPreview=SkeletonPreview;