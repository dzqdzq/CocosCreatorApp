"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeManager=void 0;const NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get:get,set:set,findLast:findLast}=require("lodash"),utils_1=require("./utils"),{promisify:promisify}=require("util"),{basename:basename,extname:extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../../export/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),utils_2=require("../prefab/utils"),selection_1=__importDefault(require("../selection")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),creatableAssetTypes=["cc.AnimationClip","cc.AudioClip","cc.BitmapFont","cc.LabelAtlas","cc.Mesh","cc.ParticleAsset","cc.Prefab","cc.Script","cc.SpriteFrame","cc.TTFFont","cc.TerrainAsset","cc.TiledMapAsset","cc.VideoClip","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{constructor(){super(...arguments),this._previewPropertysCache=new Map,this.requireComponentList=[]}get creatableAssetTypes(){return creatableAssetTypes}init(){}initWithScene(e){if(!e)return;const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),cce.Component.init(),this._previewPropertysCache=new Map,this.emit("inited",this.queryUuids(),e)}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){cce.Component.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this.unregisterNodeMgrEvents(),this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged,this),this._onLightProbeChanged=this.onLightProbeChanged.bind(this,e),e.on(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged),this._onLightProbeChanged&&e.off(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged))}onNodeTransformChanged(e,t){const n={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.EventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:n.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:n.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:n.propPath="scale"}this.emit("change",e,n)}onNodeSizeChanged(e){const t={type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);if(n){const o=e.components.indexOf(n);t.propPath=`_components.${o}.contentSize`}this.emit("change",e,t)}onNodeAnchorChanged(e){const t={type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);if(n){const o=e.components.indexOf(n);t.propPath=`_components.${o}.anchorPoint`}this.emit("change",e,t)}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),t.parent&&this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}))}onLightProbeChanged(e){const t={type:event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED,source:event_enum_1.EventSourceType.ENGINE};this.emit("change",e,t)}clear(){const e=NodeMgr.getNodes();Object.keys(e).forEach(t=>{this.unregisterEventListeners(e[t])}),NodeMgr.clear(),cce.Component.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||this.emit("added",t)}change(e,t){if(!node_1.default.isEditorNode(t)){let e="";const n=t.getComponent(cc_1.LODGroup);if(n){e=`__comps__.${t.components.indexOf(n)}`}this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e})}}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||this.emit("removed",t,{source:event_enum_1.EventSourceType.ENGINE})}query(e){var t;return void 0===e?null:null!==(t=NodeMgr.getNode(e))&&void 0!==t?t:cce.SceneFacadeManager.getCurrentFacade().queryRecycleNode(e)}queryUuids(){const e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){const t=NodeMgr.getNodesInScene()[e];return t?dump_1.default.dumpNode(t):null}queryDumpAtAll(e){const t=this.query(e);return t?dump_1.default.dumpNode(t):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}queryNodesMissAsset(){var e;const t=[];return EditorExtends.walkProperties(null===(e=cc_1.director.getScene())||void 0===e?void 0:e.children,(e,n,o,r)=>{if(o._uuid){if(!(cc.assetManager.assets.get(o._uuid)||cc.assetManager.assets.get(Editor.Utils.UUID.compressUUID(o._uuid,!0)))){const e=findLast(r,e=>e instanceof cc.Node);e&&!t.includes(e.uuid)&&t.push(e.uuid)}}},{dontSkipNull:!1,ignoreSubPrefabHelper:!0}),t}async previewSetNodeProperty(e,t,n){const o=this.query(e),r=dump_1.default.parsingPath(t,o);if(!o)return console.warn("previewSetNodeProperty failed：node not found",e),!1;if(!r.search)return console.warn("previewSetNodeProperty failed：property path error",t),!1;let a=get(o,r.search)?get(o,r.search)[r.key]:void 0;a||(a=dump_1.default.getDefaultValue(n.type));const s=dump_1.default.encodeObject(a,{type:n.type,ctor:a.constructor},a),c=this._previewPropertysCache.has(e)?this._previewPropertysCache.get(e):new Map;return(null===c||void 0===c?void 0:c.has(t))||null===c||void 0===c||c.set(t,s),this._previewPropertysCache.set(e,c),await this.setProperty(e,t,n,!1)}async cancelPreviewSetNodeProperty(e,t){const n=this.query(e),o=dump_1.default.parsingPath(t,n);if(!n)return console.warn("cancelPreviewSetNodeProperty failed:node not found",e),!1;if(!o.search)return console.warn("cancelPreviewSetNodeProperty failed:property path error",t),!1;const r=this._previewPropertysCache.get(e);if(!r)return!1;const a=null===r||void 0===r?void 0:r.get(t);return!!a&&(null===r||void 0===r||r.delete(t),await this.setProperty(e,t,a,!1))}async setProperty(e,t,n,o=!0){if(Array.isArray(e))return e.forEach(async e=>{await this.setProperty(e,t,n)}),!1;const r=this.query(e);return r?(this.emit("before-change",r),"parent"===t&&r.parent&&this.emit("before-change",r.parent),await dump_1.default.restoreProperty(r,t,n),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t,record:o}),"parent"===t&&r.parent&&this.emit("change",r.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children",record:o}),!0):(console.warn(`Set property failed: ${e} does not exist`),!1)}async resetProperty(e,t){if(Array.isArray(e))return e.forEach(e=>{this.resetProperty(e,t)}),!0;const n=this.query(e);return n?(this.emit("before-change",n),await dump_1.default.resetProperty(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),!0):(console.warn(`Set default value failed: ${e} does not exist`),!1)}async updatePropertyFromNull(e,t){if(Array.isArray(e))return e.forEach(e=>{this.updatePropertyFromNull(e,t)}),!0;const n=this.query(e);return n?(this.emit("before-change",n),await dump_1.default.updatePropertyFromNull(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),!0):(console.warn(`Set default value failed: ${e} does not exist`),!1)}async resetNode(e){if(Array.isArray(e))return e.forEach(e=>{this.resetNode(e)}),!0;const t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t);const n=["position","rotation","scale","mobility"];for(const e of n)await dump_1.default.resetProperty(t,e),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e});return!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);const n=this.query(e);n&&n.children&&n.children.length>0&&n.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,n,o){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,n,o)}),!1;const r=this.query(e);if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;const a=(t=t.replace("__comps__","_components"))?get(r,t):r;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",r),"children"===t){const e=a.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),t=e[n];if(!t)return!1;const r=a.indexOf(e[n+o]);t.setSiblingIndex(r)}else{const e=a.splice(n,1);a.splice(n+o,0,e[0]),set(r,t,a)}return this.emit("change",r,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),!0}removeArrayElement(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.removeArrayElement(e,t,n)}),!0;const o=this.query(e),r=(t||"").split(".").pop();if("children"===r)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;const a=(t=t.replace("__comps__","_components"))?get(o,t):o;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t}.${r} isn't an array`),!1;if(this.emit("before-change",o),"_components"===t){const e=a[n];this.removeComponent(e.uuid)}else a.splice(n,1),set(o,t,a);return this.emit("change",o,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:n}),!0}onComponentAdded(e,t){0!==this.requireComponentList.length&&this.requireComponentList.find(t=>e instanceof t)&&this.requireComponentList.find(t=>cc_1.js.getClassName(t)===cc_1.js.getClassName(e))&&cce.Component.onComponentAddedFromEditor(e)}createComponent(e,t){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,t)}),console.warn("don't add component to more than one node at one time"),!1;const n=this.query(e);if(!n)return console.warn(`create component failed: ${e} does not exist`),!1;if(!t)return console.warn(`create component failed: ${t} does not exist`),!1;{this.emit("before-change",n),this.emit("before-add-component",t,n);let e=null;try{if("MissingScript"===t||"cc.MissingScript"===t)throw new Error("Reset Component failed: MissingScript does not exist");let o=cc_1.js.getClassById(t);if(o||(o=cc_1.js.getClassByName(t)),cc_1.js.isChildClassOf(o,cc_1.Component)){let t=o;if(t._requireComponent)for(;t._requireComponent;)this.requireComponentList.push(t._requireComponent),t=t._requireComponent;e=n.addComponent(o),this.requireComponentList=[]}else console.error(`ctor with name ${t} is not child class of Component `);this.checkComponentsCollision(n),this.checkDynamicBodyShape(n)}catch(e){console.error(e)}e&&cce.Component.onComponentAddedFromEditor(e),this.emit("change",n,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT})}return!0}async resetComponent(e){const t=cce.Component.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node);const n=await cce.Component.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),n}removeComponent(e){const t=cce.Component.query(e);return t?cce.Component.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){function t(e){const n=e._prefab;if(n){if(n.instance)return;e._prefab=null;for(let t=0;t<e.components.length;t++){e.components[t].__prefab=null}}if(e.children.length>0){let n=e.children.length;for(;n--;){const o=e.children[n],r=o.objFlags&cc.Object.Flags.HideInHierarchy,a=o.objFlags&cc.Object.Flags.DontSave;r&&a?e.removeChild(o):t(o)}}}Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const n of e){const e=this.query(n);if(!e)continue;const o=cc.instantiate(e);t(o),stashInstants[n]={instant:o}}return e}duplicateNode(e){var t;Array.isArray(e)||(e=[e]);const n=[],o=stashInstants;e=this.copyNode(e);for(const o of e){const e=this.query(o);if(!e)continue;const r=this.createNode(null===(t=e.parent)||void 0===t?void 0:t.uuid,null,o,!1,!0);r&&n.push(r)}stashInstants=o;const r=n.filter(Boolean);return selection_1.default.clear(),r.forEach(e=>{selection_1.default.select(e)}),r}async pasteNode(e,t,n=!1){var o;Array.isArray(t)||(t=[t]);const r=[];for(const a of t){const t=this.createNode(e,null,a,n,!0);if(t){const a=this.query(t);if(a){const t=cce.SceneFacadeManager.getCurrentFacade().modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&this.checkNodeUseCanvasRequired(a),o=await this.checkCanvasRequired(a,t,this.getNewNodeParent(e),void 0);o!==a&&a.setParent(o,n)}if(r.push(t),!e){const n=this.query(t);n&&(e=null===(o=n.parent)||void 0===o?void 0:o.uuid)}}}const a=r.filter(Boolean);return selection_1.default.clear(),a.forEach(e=>{selection_1.default.select(e)}),a}setParent(e,t,n=!1){let o;Array.isArray(t)||(t=[t]),t=t.filter(e=>{const t=this.query(e);return!(!t||!t.parent)}),e&&(o=this.query(e)),o||(o=cc_1.director.getScene());for(const e of t){const t=this.query(e);null===t||void 0===t||t.setParent(o,n)}return t}generateAvailableName(e,t){e||(e="Node");let n=cc_1.director.getScene();if(t){const e=this.query(t);n=e||n}return(0,utils_1.getNodeName)(e,n)}createNode(e,t,n,o=!1,r=!1){if(!cc.director._scene)return;null===o&&(o=!0);const a=this.getNewNodeParent(e);let s=null;if(n&&stashInstants[n]){const{instant:e}=stashInstants[n];e&&(s=cc.instantiate(e))&&((0,utils_1.visitNode)(s,e=>{const t=e._prefab;if(null===t||void 0===t?void 0:t.instance)return t.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(t.instance),!0}),t=(0,utils_1.getNodeName)(s.name,a))}return s||(s=new cc.Node),s?(t&&(s.name=t),a.layer&&a!==cc_1.director.getScene()&&!r&&(s.layer=a.layer),this.emit("before-add",s),this.emit("before-change",a),s.setParent(a,o),n||this.ensureUITransformComponent(s),this.emit("add",s),a&&this.emit("change",a,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),cce.Selection.clear(),cce.Selection.select(s.uuid),s.uuid):void 0}ensureUITransformComponent(e){if(e instanceof cc.Node&&0===e.children.length){let t=!1,n=e.parent;for(;n;){if(n.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){t=!0;break}n=n.parent}if(t)try{e.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){var n;const o=this;if(!cc_1.director.getScene())return!1;const r=cce.Selection.query();cce.Selection.clear();const a=this.query,s=a(e),c={};const i={};const d={};function l(e){const t={};if(e){if(d[e.uuid])return d[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,n)=>{e&&e._prefab&&(t[e._prefab.fileId]=n)}),d[e.uuid]=t)}return t}try{!function e(t){t&&t._prefab&&(c[t._prefab.fileId]=t,Array.isArray(t.children)&&t.children.forEach(t=>{e(t)}))}(s);const e=await promisify(cc_1.assetManager.loadAny)(t),r=cc.instantiate(e);null===(n=s.parent)||void 0===n||n.addChild(r),await async function e(t,n,r){var d;if(t.objFlags&cc.Object.Flags.HideInHierarchy)return!1;const u=l(n),p=function(e){const t={};if(e){if(i[e.uuid])return i[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),i[e.uuid]=t)}return t}(r),h=dump_1.default.dumpNode(t),_=h.__prefab__.fileId,m=r?a(p[_]):s;if(m){if(o.emit("before-change",m),Array.isArray(m.children)){const e=l(t);let n=0,r=m.children[n];for(;r&&n<m.children.length;)r._prefab&&void 0===e[r._prefab.fileId]?o.removeNode(r.uuid):n++,r=m.children[n]}const n=dump_1.default.dumpNode(m);delete h.uuid,delete h.children,r?h.parent.value.uuid=r.uuid:(h.active.value=n.active.value,h.name.value=n.name.value,h.position.value=n.position.value,h.rotation.value=n.rotation.value),h.__prefab__=JSON.parse(JSON.stringify(n.__prefab__)),Array.isArray(h.__comps__)&&function e(t){t.forEach(t=>{var n;if(!t.value||"object"!=typeof t.value)return;const o=Object.keys(t.value);for(const r of o){if(["node"].includes(r))continue;const o=t.value[r];if(o.isArray&&Array.isArray(o.value))e(o.value);else if("cc.Node"===o.type){const e=a(o.value.uuid);if(!e||!(null===(n=null===e||void 0===e?void 0:e._prefab)||void 0===n?void 0:n.fileId))continue;const t=c[e._prefab.fileId];t&&(o.value.uuid=t.uuid)}}})}(h.__comps__),await dump_1.default.restoreNode(m,h),void 0!==u[_]&&m.setSiblingIndex(u[_]);let s=0,i=t.children[s];for(;i&&s<t.children.length;)await e(i,t,m)||s++,i=t.children[s];return o.emit("change",m),!1}const f=t._prefab;if(f&&r){o.emit("before-add",t),o.emit("before-change",r);const e=u[f.fileId];r.insertChild(t,e),f.root=null===(d=r._prefab)||void 0===d?void 0:d.root,o.emit("add",t),o.emit("change",r)}return!0}(r),r.parent=null,this.emit("change",s)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return setTimeout(()=>{r.forEach(e=>{cce.Selection.select(e)})}),!0}checkNodeUseCanvasRequired(e){if(!e)return!1;let t=!1;return!e.getComponent("cc.Canvas")&&(e.walk(e=>{t||e.components.forEach(e=>{t||(t="cc.UITransform"===cc_1.js.getClassName(e))})}),t)}async checkCanvasRequired(e,t,n,o){const r=cce.SceneFacadeManager.queryMode();let a=null,s=null;if("prefab"===r&&(s=(a=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy).getRootNode(),n===cc_1.director.getScene()&&(n=s)),t){let e=null;if("prefab"===r){e=(0,utils_1.getUICanvasNode)(n,!1);const t=(0,utils_1.getUITransformParentNode)(n);if(e)e.parent!==cc_1.director.getScene()&&(n=e);else if(t)e=t;else{const t=await Editor.Dialog.warn(Editor.I18n.t("scene.contributions.messages.description.UITransform_lack"),{buttons:[Editor.I18n.t("scene.contributions.messages.description.UITransform_add_to_root"),Editor.I18n.t("scene.contributions.messages.description.UITransform_within_canvas"),Editor.I18n.t("scene.contributions.messages.description.UITransform_cancel")],default:0,cancel:2});if(0===t.response){if(!s)return console.error("prefab Root is not exist"),null;s.addComponent("cc.UITransform"),s.parent&&!(0,utils_1.hasOneKindOfComponent)(s.parent,cc_1.Canvas)&&(e=await(null===a||void 0===a?void 0:a._sceneWrapCanvasNode(cc_1.director.getScene())),s.parent=e)}2===t.response&&(e=new cc_1.Node)}}else(e=(0,utils_1.getUICanvasNode)(n))&&(n=e);if(!e){let t="f773db21-62b8-4540-956a-29bacf5ddbf5";"2d"===cce.SceneFacadeManager._projectType&&(t="4c33600e-9ca9-483b-b734-946008261697"),cc_1.assetManager.assets.remove(t);const o=await promisify(cc_1.assetManager.loadAny)(t);e=cc.instantiate(o),cce.Prefab.removePrefabInfoFromNode(e),n.addChild(e),n=e}o&&(o.z=e.position.z)}return n}async createNodeFromAsset(e,t,n){if(!cc.director._scene)return;let o=this.getNewNodeParent(e);try{const{name:e,type:r,position:a,unlinkPrefab:s}=n;let c,i,{canvasRequired:d}=n;if(r&&!creatableAssetTypes.includes(r))return;switch(DEBUG_TIME_COST&&console.time("createNodeFromAsset"),r){case"cc.AnimationClip":{cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(i.name)).addComponent(cc_1.Animation);e&&(e.defaultClip=i)}break;case"cc.AudioClip":{cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(i.name)).addComponent(cc_1.AudioSource);e&&(e.clip=i)}break;case"cc.BitmapFont":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.Label);e&&(e.font=i)}break;case"cc.LabelAtlas":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.Label);e.font=i,e.fontSize=i.fontSize;const n=i.fntConfig.commonHeight;e.lineHeight=n||e.lineHeight}break;case"cc.Mesh":{cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(i.name)).addComponent(cc_1.MeshRenderer);e&&(e.mesh=i),await createNodeMetrics(t)}break;case"cc.ParticleAsset":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(i.name)).addComponent(cc_1.ParticleSystem2D);e&&(e.file=i)}break;case"cc.Prefab":cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),c=cce.Prefab.createNodeFromPrefabAsset(i),await createNodeMetrics(t),await createLODMetrics(c);break;case"cc.Script":{const e=await cce.Script.queryScriptName(t)||"",n=await cce.Script.queryScriptCid(t)||"";c=new cc_1.Node(e),n&&"MissingScript"!==n&&"cc.MissingScript"!==n&&c.addComponent(cc_1.js.getClassById(n))}break;case"cc.SpriteFrame":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e="9db8cd0b-cbe4-42e7-96a9-a239620c0a9d";cc_1.assetManager.assets.remove(e);const n=await promisify(cc_1.assetManager.loadAny)(e);n.name=i.name,(c=cc.instantiate(n)).layer=cc_1.Layers.Enum.UI_2D;const o=c.getComponent("cc.Sprite");if(o){o.spriteFrame=i;const e=await Editor.Message.request("asset-db","query-asset-meta",t);e&&"none"===e.userData.trimType&&(o.trim=!1,o.sizeMode=cc_1.Sprite.SizeMode.RAW)}}break;case"cc.TTFFont":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.Label);e&&(e.font=i)}break;case"cc.TerrainAsset":{cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(i.name)).addComponent(cc_1.Terrain);e&&(e._asset=i)}break;case"cc.TiledMapAsset":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.TiledMap);e&&(e.tmxAsset=i)}break;case"cc.VideoClip":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.VideoPlayer);e&&(e.clip=i)}break;case"dragonBones.DragonBonesAsset":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAsset=i)}break;case"dragonBones.DragonBonesAtlasAsset":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAtlasAsset=i)}break;case"sp.SkeletonData":{d=!0,cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),(c=new cc_1.Node(i.name)).layer=cc_1.Layers.Enum.UI_2D;const e=c.addComponent(cc_1.sp.Skeleton);e&&(e.skeletonData=i)}break;default:cc_1.assetManager.assets.remove(t),i=await promisify(cc_1.assetManager.loadAny)(t),c=cc.instantiate(i)}return o=await this.checkCanvasRequired(c,Boolean(d),o,a),e&&(c.name=basename(e,extname(e))),DEBUG_TIME_COST&&console.time("addNodeEvent"),this.emit("before-add",c),this.emit("before-change",o),("cc.Prefab"!==r||s)&&(cce.Prefab.removePrefabInfoFromNode(c),o.layer&&o!==cc_1.director.getScene()&&(c.layer=o.layer)),o.addChild(c),a&&c.setWorldPosition(a),this.emit("add",c),this.emit("change",o,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),DEBUG_TIME_COST&&console.timeEnd("addNodeEvent"),cce.Selection.clear(),cce.Selection.select(c.uuid),DEBUG_TIME_COST&&console.timeEnd("createNodeFromAsset"),c.uuid}catch(e){return void console.error(e)}}_walkNode(e,t){e&&e.children&&e.children.forEach(e=>{t(e),this._walkNode(e,t)})}removeNode(e,t){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e);for(const n of e){const e=this.query(n);if(!e)continue;const o=e.parent;this.emit("before-remove",e),o&&this.emit("before-change",o),console.time("NodeMgr::removeNode"),e.setParent(null,t),e._objFlags|=cc_1.CCObject.Flags.Destroyed;try{this._walkNode(e,e=>{e._objFlags|=cc_1.CCObject.Flags.Destroyed})}catch(e){console.warn(e)}console.timeEnd("NodeMgr::removeNode"),this.emit("remove",e,{source:event_enum_1.EventSourceType.EDITOR})}}changeNodeLock(e,t,n){Array.isArray(e)||(e=[e]);for(const o of e){const e=this.query(o);if(e){this.emit("before-change",e);try{t?e.objFlags|=cc.Object.Flags.LockedInEditor:e.objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",e),!0===n&&e.children&&e.children.length>0&&e.children.forEach(e=>{this.changeNodeLock(e.uuid,t,n)})}}}queryComponentFunctionOfNode(e){const t=this.query(e);return t?(0,get_component_function_of_node_1.default)(t):{}}canRemoveOrCopy(e){const t=this,n=[],o=[];for(const n of e){const e=t.query(n);!e||!e.parent||e.objFlags&cc.Object.Flags.DontDestroy||o.push(n)}for(const e of o){r(t.query(e))||n.push(e)}function r(e){return!!e.parent&&(!!o.includes(e.parent.uuid)||r(e.parent))}return n}getNewNodeParent(e){let t;if(e)t=this.query(e);else{const e=cce.Selection.query();t=Array.isArray(e)&&e[0]?this.query(e[0]):cc_1.director.getScene()}if(t||(t=cc_1.director.getScene()),"prefab"===cce.SceneFacadeManager.queryMode()){const e=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy.getRootNode();t===cc.director._scene&&(t=e)}return t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}addComponentAt(e,t,n){return!(!e||!t||n<0)&&(!(t instanceof cc_1.MissingScript&&!t._$erialized)&&(e._addComponentAt(t,n),cce.Component.emit("add",t),!0))}checkComponentsCollision(e){(0,utils_1.hasOneKindOfComponent)(e,cc_1.animation.AnimationController)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Animation)&&console.warn(Editor.I18n.t("scene.contributions.messages.description.animationComponentCollision"))}checkDynamicBodyShape(e){if((0,utils_1.hasOneKindOfComponent)(e,cc_1.RigidBody)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Collider)){const t=e.getComponent(cc_1.RigidBody);if(!t)return;const n=e.getComponent(cc_1.Collider);if(t.type===cc_1.ERigidBodyType.DYNAMIC)switch(null===n||void 0===n?void 0:n.type){case cc_1.EColliderType.PLANE:case cc_1.EColliderType.TERRAIN:console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"));break;case cc_1.EColliderType.MESH:n.convex||console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"))}}}}async function createNodeMetrics(e){if(e&&-1!==e.indexOf("@"))try{const[t,n]=e.split("@"),o=await Editor.Message.request("asset-db","query-asset-meta",t);o&&o.importer&&("fbx"===o.importer||"gltf"===o.importer)&&(o.userData&&o.userData.meshOptimizer&&o.userData.meshOptimizer.enable&&Editor.Metrics._trackEventWithTimer({category:"createNode",id:"A100010",value:1}),o.userData&&o.userData.fbx&&o.userData.fbx.smartMaterialEnabled&&Editor.Metrics._trackEventWithTimer({category:"createNode",id:"A100011",value:1}))}catch(e){console.debug(e)}}async function createLODMetrics(e){if(e&&e._components){e.getComponent("cc.LODGroup")&&Editor.Metrics._trackEventWithTimer({category:"LOD",id:"A100001",value:1})}}exports.NodeManager=NodeManager,exports.default=new NodeManager;