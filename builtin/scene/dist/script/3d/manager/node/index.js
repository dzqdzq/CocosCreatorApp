"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get:get,set:set}=require("lodash"),utils_1=require("./utils"),editor_1=require("editor"),index_1=__importDefault(require("./../component/index")),{promisify:promisify}=require("util"),{basename:basename,extname:extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../utils/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),prefab_1=__importDefault(require("../prefab")),utils_2=require("../prefab/utils"),scripts_1=__importDefault(require("../scripts")),timer_util_1=require("../../utils/timer-util"),creatableAssetTypes=["cc.AnimationClip","cc.AudioClip","cc.BitmapFont","cc.LabelAtlas","cc.Mesh","cc.ParticleAsset","cc.Prefab","cc.Script","cc.SpriteFrame","cc.TTFFont","cc.TerrainAsset","cc.TiledMapAsset","cc.VideoClip","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{constructor(){super(...arguments),this._timerUtil=new timer_util_1.TimerUtil}get creatableAssetTypes(){return creatableAssetTypes}init(){}initWithScene(e){if(!e)return;const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),index_1.default.init(),this.emit("inited",this.queryUuids(),e)}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){index_1.default.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged))}onNodeTransformChanged(e,t){const n={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.EventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:n.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:n.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:n.propPath="scale"}this.emit("change",e,n)}onNodeSizeChanged(e){const t={type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);if(n){const r=e.components.indexOf(n);t.propPath=`_components.${r}.contentSize`}this.emit("change",e,t)}onNodeAnchorChanged(e){const t={type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);if(n){const r=e.components.indexOf(n);t.propPath=`_components.${r}.anchorPoint`}this.emit("change",e,t)}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),t.parent&&this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}))}clear(){const e=NodeMgr.getNodes();Object.keys(e).forEach(t=>{this.unregisterEventListeners(e[t])}),NodeMgr.clear(),index_1.default.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||this.emit("added",t)}change(e,t){node_1.default.isEditorNode(t)||this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:""})}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||this.emit("removed",t,{source:event_enum_1.EventSourceType.ENGINE})}query(e){return NodeMgr.getNode(e)||null}queryUuids(){const e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){const t=NodeMgr.getNodesInScene()[e];return t?dump_1.default.dumpNode(t):null}queryDumpAtAll(e){const t=this.query(e);return t?dump_1.default.dumpNode(t):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}async setProperty(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.setProperty(e,t,n)}),!1;const r=this.query(e);return r?(this.emit("before-change",r),"parent"===t&&r.parent&&this.emit("before-change",r.parent),await dump_1.default.restoreProperty(r,t,n),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),"parent"===t&&r.parent&&this.emit("change",r.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children"}),!0):(console.warn(`Set property failed: ${e} does not exist`),!1)}async resetProperty(e,t){if(Array.isArray(e))return e.forEach(e=>{this.resetProperty(e,t)}),!0;const n=this.query(e);return n?(this.emit("before-change",n),await dump_1.default.resetProperty(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),!0):(console.warn(`Set default value failed: ${e} does not exist`),!1)}async resetNode(e){if(Array.isArray(e))return e.forEach(e=>{this.resetNode(e)}),!0;const t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t);const n=["position","rotation","scale"];for(const e of n)await dump_1.default.resetProperty(t,e),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e});return!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);const n=this.query(e);n.children&&n.children.length>0&&n.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,n,r){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,n,r)}),!1;const o=this.query(e);if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;const a=(t=t.replace("__comps__","_components"))?get(o,t):o;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",o),"children"===t){const e=a.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),t=e[n];if(!t)return!1;const o=a.indexOf(e[n+r]);t.setSiblingIndex(o)}else{const e=a.splice(n,1);a.splice(n+r,0,e[0]),set(o,t,a)}return this.emit("change",o,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),!0}removeArrayElement(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.removeArrayElement(e,t,n)}),!0;const r=this.query(e),o=(t||"").split(".").pop();if("children"===o)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;const a=(t=t.replace("__comps__","_components"))?get(r,t):r;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t}.${o} isn't an array`),!1;if(this.emit("before-change",r),"_components"===t){const e=a[n];this.removeComponent(e.uuid)}else a.splice(n,1),set(r,t,a);return this.emit("change",r,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:n}),!0}createComponent(e,t){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,t)}),console.warn("don't add component to more than one node at one time"),!1;const n=this.query(e);if(!n)return console.warn(`create component failed: ${e} does not exist`),!1;if(!t)return console.warn(`create component failed: ${t} does not exist`),!1;{this.emit("before-change",n),this.emit("before-add-component",t,n);let e=null;try{e=n.addComponent(t)}catch(e){console.error(e)}index_1.default.onComponentAddedFromEditor(e),this.emit("change",n,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT})}return!0}async resetComponent(e){const t=index_1.default.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node);const n=await index_1.default.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),n}removeComponent(e){const t=index_1.default.query(e);return t?index_1.default.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){function t(e){const n=e._prefab;if(n){if(n.instance)return void(n.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(n.instance));e._prefab=null;for(let t=0;t<e.components.length;t++){e.components[t].__prefab=null}}if(e.children.length>0){let n=e.children.length;for(;n--;){const r=e.children[n],o=r.objFlags&cc.Object.Flags.HideInHierarchy,a=r.objFlags&cc.Object.Flags.DontSave;o&&a?e.children.splice(n,1):t(r)}}}Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const n of e){const e=this.query(n);if(!e)continue;const r=cc.instantiate(e);t(r),stashInstants[n]={instant:r}}return e}duplicateNode(e){Array.isArray(e)||(e=[e]);const t=[];e=this.copyNode(e);for(const n of e){const e=this.query(n);if(!e)continue;const r=this.createNode(e.parent.uuid,null,n,!1);t.push(r)}return stashInstants={},t.filter(Boolean)}pasteNode(e,t,n=!1){Array.isArray(t)||(t=[t]);const r=[];for(const o of t){const t=this.createNode(e,null,o,n);r.push(t)}return r.filter(Boolean)}setParent(e,t,n=!1){Array.isArray(t)||(t=[t]),t=t.filter(e=>{const t=this.query(e);return!(!t||!t.parent)}),e=e?this.query(e):cc.director._scene;for(const r of t){this.query(r).setParent(e,n)}return t}generateAvailableName(e,t){e||(e="Node");let n=cc.director._scene;return t&&(n=this.query(t)),utils_1.getNodeName(e,n)}createNode(e,t,n,r=!1){if(!cc.director._scene)return null;null===r&&(r=!0);const o=this.getNewNodeParent(e);let a=null;if(n&&stashInstants[n]){const{instant:e}=stashInstants[n];e&&(a=cc.instantiate(e),t=utils_1.getNodeName(a.name,o))}return a||(a=new cc.Node),t&&(a.name=t),this.emit("before-add",a),this.emit("before-change",o),a.setParent(o,r),n||this.ensureUITransformComponent(a),this.emit("add",a),o&&this.emit("change",o,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),cce.Selection.clear(),cce.Selection.select(a.uuid),a.uuid}ensureUITransformComponent(e){if(e instanceof cc.Node&&0===e.children.length){let t=!1,n=e.parent;for(;n;){if(n.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){t=!0;break}n=n.parent}if(t)try{e.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){const n=this;if(!cc.director._scene)return!1;const r=cce.Selection.query();cce.Selection.clear();const o=this.query,a=o(e),s={};const i={};const c={};function d(e){const t={};if(e){if(c[e.uuid])return c[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,n)=>{e&&e._prefab&&(t[e._prefab.fileId]=n)}),c[e.uuid]=t)}return t}try{!function e(t){t&&t._prefab&&(s[t._prefab.fileId]=t,Array.isArray(t.children)&&t.children.forEach(t=>{e(t)}))}(a);const e=await promisify(cc_1.assetManager.loadAny)(t),r=cc.instantiate(e);a.parent.addChild(r),await async function e(t,r,c){if(t.objFlags&cc.Object.Flags.HideInHierarchy)return!1;const l=d(r),u=function(e){const t={};if(e){if(i[e.uuid])return i[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),i[e.uuid]=t)}return t}(c),_=dump_1.default.dumpNode(t),p=_.__prefab__.fileId,h=c?o(u[p]):a;if(h){if(n.emit("before-change",h),Array.isArray(h.children)){const e=d(t);let r=0,o=h.children[r];for(;o&&r<h.children.length;)o._prefab&&void 0===e[o._prefab.fileId]?n.removeNode(o.uuid):r++,o=h.children[r]}const r=dump_1.default.dumpNode(h);delete _.uuid,delete _.children,c?_.parent.value.uuid=c.uuid:(_.active.value=r.active.value,_.name.value=r.name.value,_.position.value=r.position.value,_.rotation.value=r.rotation.value),_.__prefab__=JSON.parse(JSON.stringify(r.__prefab__)),Array.isArray(_.__comps__)&&function e(t){t.forEach(t=>{if(!t.value||"object"!=typeof t.value)return;const n=Object.keys(t.value);for(const r of n){if(["node"].includes(r))continue;const n=t.value[r];if(n.isArray&&Array.isArray(n.value))e(n.value);else if("cc.Node"===n.type){const e=o(n.value.uuid);if(!e||!e._prefab.fileId)continue;const t=s[e._prefab.fileId];t&&(n.value.uuid=t.uuid)}}})}(_.__comps__),await dump_1.default.restoreNode(h,_),void 0!==l[p]&&h.setSiblingIndex(l[p]);let a=0,i=t.children[a];for(;i&&a<t.children.length;)await e(i,t,h)||a++,i=t.children[a];return n.emit("change",h),!1}n.emit("before-add",t),n.emit("before-change",c);const m=l[t._prefab.fileId];return c.insertChild(t,m),t._prefab.root=c._prefab.root,n.emit("add",t),n.emit("change",c),!0}(r),r.parent=null,this.emit("change",a)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return window.requestAnimationFrame(()=>{r.forEach(e=>{cce.Selection.select(e)})}),!0}async createNodeFromAsset(e,t,n){if(!cc.director._scene)return null;let r=this.getNewNodeParent(e);try{const{name:e,type:o,position:a,unlinkPrefab:s}=n;let i,c,{canvasRequired:d}=n;if(o&&!creatableAssetTypes.includes(o))return null;switch(DEBUG_TIME_COST&&console.time("createNodeFromAsset"),o){case"cc.AnimationClip":{cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(c.name)).addComponent(cc_1.Animation);e&&(e.defaultClip=c)}break;case"cc.AudioClip":{cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(c.name)).addComponent(cc_1.AudioSource);e&&(e.clip=c)}break;case"cc.BitmapFont":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.Label);e&&(e.font=c)}break;case"cc.LabelAtlas":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.Label);e.font=c,e.fontSize=c.fontSize;const n=c.fntConfig.commonHeight;e.lineHeight=n||e.lineHeight}break;case"cc.Mesh":{cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(c.name)).addComponent(cc_1.MeshRenderer);e&&(e.mesh=c)}break;case"cc.ParticleAsset":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(c.name)).addComponent(cc_1.ParticleSystem2D);e&&(e.file=c)}break;case"cc.Prefab":cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),i=prefab_1.default.createNodeFromPrefabAsset(c);break;case"cc.Script":{const e=await scripts_1.default.queryScriptName(t)||"";(i=new cc_1.Node(e)).addComponent(e)}break;case"cc.SpriteFrame":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e="9db8cd0b-cbe4-42e7-96a9-a239620c0a9d";cc_1.assetManager.assets.remove(e);const n=await promisify(cc_1.assetManager.loadAny)(e);n.name=c.name,(i=cc.instantiate(n)).layer=cc_1.Layers.Enum.UI_2D;const r=i.getComponent("cc.Sprite");if(r){r.spriteFrame=c;const e=await Editor.Message.request("asset-db","query-asset-meta",t);e&&"none"===e.userData.trimType&&(r.trim=!1,r.sizeMode=cc_1.Sprite.SizeMode.RAW)}}break;case"cc.TTFFont":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.Label);e&&(e.font=c)}break;case"cc.TerrainAsset":{cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(c.name)).addComponent(cc_1.Terrain);e&&(e._asset=c)}break;case"cc.TiledMapAsset":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.TiledMap);e&&(e.tmxAsset=c)}break;case"cc.VideoClip":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.VideoPlayer);e&&(e.clip=c)}break;case"dragonBones.DragonBonesAsset":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAsset=c)}break;case"dragonBones.DragonBonesAtlasAsset":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAtlasAsset=c)}break;case"sp.SkeletonData":{d=!0,cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),(i=new cc_1.Node(c.name)).layer=cc_1.Layers.Enum.UI_2D;const e=i.addComponent(cc_1.sp.Skeleton);e&&(e.skeletonData=c)}break;default:cc_1.assetManager.assets.remove(t),c=await promisify(cc_1.assetManager.loadAny)(t),i=cc.instantiate(c)}if(d){const e=cce.SceneFacadeManager.queryMode();let t=utils_1.getUICanvasNode(r);if(!t){if("prefab"===e){const e=cce.SceneFacadeManager._prefabSceneFacade._sceneProxy,n=e.getRootNode();if(utils_1.getUITransformParentNode(r))t=r;else{0===(await editor_1.Dialog.warn(editor_1.I18n.t("scene.contributions.messages.description.UITransform_lack"),{buttons:[editor_1.I18n.t("scene.contributions.messages.description.UITransform_add_to_root"),editor_1.I18n.t("scene.contributions.messages.description.UITransform_within_canvas")],default:0})).response&&r&&(n.addComponent("cc.UITransform"),utils_1.hasCanvasComponent(n.parent)||(t=await e._sceneWrapCanvasNode(cc.director._scene),n.parent=t),t=r)}}if(!t){const e="f773db21-62b8-4540-956a-29bacf5ddbf5";cc_1.assetManager.assets.remove(e);const n=await promisify(cc_1.assetManager.loadAny)(e);t=cc.instantiate(n),prefab_1.default.removePrefabInfoFromNode(t),r.addChild(t)}}r=t,a&&(a.z=t.position.z)}return e&&(i.name=basename(e,extname(e))),DEBUG_TIME_COST&&console.time("addNodeEvent"),this.emit("before-add",i),this.emit("before-change",r),("cc.Prefab"!==o||s)&&prefab_1.default.removePrefabInfoFromNode(i),r.addChild(i),a&&i.setWorldPosition(a),this.emit("add",i),this.emit("change",r,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),DEBUG_TIME_COST&&console.timeEnd("addNodeEvent"),cce.Selection.clear(),cce.Selection.select(i.uuid),DEBUG_TIME_COST&&console.timeEnd("createNodeFromAsset"),i.uuid}catch(e){return console.error(e),null}}removeNode(e,t=!0){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e);for(const n of e){const e=this.query(n);if(!e)continue;const r=e.parent;this.emit("before-remove",e),r&&this.emit("before-change",r),console.time("NodeMgr::removeNode"),e.setParent(null,t),console.timeEnd("NodeMgr::removeNode"),this.emit("remove",e,{source:event_enum_1.EventSourceType.EDITOR})}}changeNodeLock(e,t,n){Array.isArray(e)||(e=[e]);for(const r of e){const e=this.query(r);if(e){this.emit("before-change",e);try{t?e.objFlags|=cc.Object.Flags.LockedInEditor:e.objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",e),!0===n&&e.children&&e.children.length>0&&e.children.forEach(e=>{this.changeNodeLock(e.uuid,t,n)})}}}queryComponentFunctionOfNode(e){const t=this.query(e);return t?get_component_function_of_node_1.default(t):{}}canRemoveOrCopy(e){const t=this,n=[],r=[];for(const n of e){const e=t.query(n);!e||!e.parent||e.objFlags&cc.Object.Flags.DontDestroy||r.push(n)}for(const e of r){o(t.query(e))||n.push(e)}function o(e){return!!e.parent&&(!!r.includes(e.parent.uuid)||o(e.parent))}return n}getNewNodeParent(e){let t;if(e)t=this.query(e);else{const e=cce.Selection.query();t=Array.isArray(e)&&e[0]?this.query(e[0]):cc.director._scene}return t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}addComponentAt(e,t,n){return!(!e||!t||n<0)&&(e._addComponentAt(t,n),index_1.default.emit("add",t),!0)}}exports.default=new NodeManager;