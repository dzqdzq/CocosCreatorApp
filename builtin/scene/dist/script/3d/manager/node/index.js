"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get:get,set:set}=require("lodash"),utils_1=require("./utils"),index_1=__importDefault(require("./../component/index")),{promisify:promisify}=require("util"),{basename:basename,extname:extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../utils/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),prefab_1=__importDefault(require("../prefab")),utils_2=require("../prefab/utils"),scripts_1=__importDefault(require("../scripts")),supportTypes=["cc.Prefab","cc.Mesh","cc.SpriteFrame","cc.Script","cc.VideoClip","cc.LabelAtlas"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{get supportTypes(){return supportTypes}init(){}initWithScene(e){if(!e)return;const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),index_1.default.init(),this.emit("inited",this.queryUuids(),e)}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){index_1.default.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.SystemEventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.SystemEventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.SystemEventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.SystemEventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.SystemEventType.CHILD_REMOVED,this._onParentChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.SystemEventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.SystemEventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.SystemEventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.SystemEventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.SystemEventType.CHILD_REMOVED,this._onParentChanged))}onNodeTransformChanged(e,t){const n={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:n.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:n.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:n.propPath="scale"}this.emit("change",e,n)}onNodeSizeChanged(e){this.emit("change",e,{type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE}),e.getComponent(cc_1.Canvas)&&Editor.Message.broadcast("scene:change-node",e.uuid)}onNodeAnchorChanged(e){this.emit("change",e,{type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE})}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e.uuid),t.parent&&(this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}),Editor.Message.broadcast("scene:change-node",t.uuid)))}clear(){const e=NodeMgr.getNodes();Object.keys(e).forEach(t=>{this.unregisterEventListeners(e[t])}),NodeMgr.clear(),index_1.default.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||(this.emit("add",t),Editor.Message.broadcast("scene:add-node",t.uuid))}change(e,t){node_1.default.isEditorNode(t)||(this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:""}),Editor.Message.broadcast("scene:change-node",e))}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||(this.emit("remove",t),Editor.Message.broadcast("scene:remove-node",t.uuid))}query(e){return NodeMgr.getNode(e)||null}queryUuids(){const e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){const t=NodeMgr.getNodesInScene()[e];return t?dump_1.default.dumpNode(t):null}queryDumpAtAll(e){const t=this.query(e);return t?dump_1.default.dumpNode(t):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}async setProperty(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.setProperty(e,t,n)}),!1;const r=this.query(e);return r?(this.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",e),"parent"===t&&r.parent&&(Editor.Message.broadcast("scene:before-change-node",r.parent.uuid),this.emit("before-change",r.parent)),await dump_1.default.restoreProperty(r,t,n),this.emit("change",r,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),Editor.Message.broadcast("scene:change-node",e),"parent"===t&&r.parent&&(Editor.Message.broadcast("scene:change-node",r.parent.uuid),this.emit("change",r.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children"})),!0):(console.warn(`Set property failed: ${e} does not exist`),!1)}async resetProperty(e,t){if(Array.isArray(e))return e.forEach(e=>{this.resetProperty(e,t)}),!0;const n=this.query(e);return n?(this.emit("before-change",n),Editor.Message.broadcast("scene:before-change-node",e),await dump_1.default.resetProperty(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),Editor.Message.broadcast("scene:change-node",e),!0):(console.warn(`Set default value failed: ${e} does not exist`),!1)}async resetNode(e){if(Array.isArray(e))return e.forEach(e=>{this.resetNode(e)}),!0;const t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t),Editor.Message.broadcast("scene:before-change-node",e);const n=["position","rotation","scale"];for(const e of n)await dump_1.default.resetProperty(t,e),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e});return Editor.Message.broadcast("scene:change-node",e),!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);const n=this.query(e);n.children&&n.children.length>0&&n.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,n,r){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,n,r)}),!1;const o=this.query(e);if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;const s=(t=t.replace("__comps__","_components"))?get(o,t):o;if(!s)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(s))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",o),Editor.Message.broadcast("scene:before-change-node",e),"children"===t){const e=s.filter(e=>!(e._objFlags&cc.Object.Flags.HideInHierarchy)),t=e[n];if(!t)return!1;const o=s.indexOf(e[n+r]);t.setSiblingIndex(o)}else{const e=s.splice(n,1);s.splice(n+r,0,e[0]),set(o,t,s)}return this.emit("change",o,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),Editor.Message.broadcast("scene:change-node",e),!0}removeArrayElement(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.removeArrayElement(e,t,n)}),!0;const r=this.query(e),o=(t||"").split(".").pop();if("children"===o)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;const s=(t=t.replace("__comps__","_components"))?get(r,t):r;if(!s)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(s))return console.warn(`Move property failed: ${e} - ${t}.${o} isn't an array`),!1;if(this.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",e),"_components"===t){const e=s[n];this.removeComponent(e.uuid)}else s.splice(n,1),set(r,t,s);return this.emit("change",r,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:n}),Editor.Message.broadcast("scene:change-node",e),!0}createComponent(e,t){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,t)}),console.warn("don't add component to more than one node at one time"),!1;const n=this.query(e);if(!n)return console.warn(`create component failed: ${e} does not exist`),!1;if(!t)return console.warn(`create component failed: ${t} does not exist`),!1;this.emit("before-change",n),this.emit("before-add-component",t,n),Editor.Message.broadcast("scene:before-change-node",e);try{n.addComponent(t)}catch(e){console.error(e)}return this.emit("change",n,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT}),Editor.Message.broadcast("scene:change-node",e),!0}async resetComponent(e){const t=index_1.default.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node),Editor.Message.broadcast("scene:before-change-node",t.node.uuid);const n=await index_1.default.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),Editor.Message.broadcast("scene:change-node",t.node.uuid),n}removeComponent(e){const t=index_1.default.query(e);return t?index_1.default.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){function t(e){const n=e._prefab;if(n){if(n.instance)return void(n.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(n.instance));e._prefab=null;for(let t=0;t<e.components.length;t++){e.components[t].__prefab=null}}if(e.children.length>0){let n=e.children.length;for(;n--;){const r=e.children[n],o=r instanceof cc.PrivateNode,s=r._objFlags&cc.Object.Flags.DontSave;o&&s?e.children.splice(n,1):t(r)}}}Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const n of e){const e=this.query(n);if(!e)continue;const r=cc.instantiate(e);t(r),stashInstants[n]={instant:r}}return e}duplicateNode(e){Array.isArray(e)||(e=[e]);const t=[];e=this.copyNode(e);for(const n of e){const e=this.query(n);if(!e)continue;const r=this.createNode(e.parent.uuid,null,n,!1);t.push(r)}return stashInstants={},t.filter(Boolean)}pasteNode(e,t,n=!1){Array.isArray(t)||(t=[t]);const r=[];for(const o of t){const t=this.createNode(e,null,o,n);r.push(t)}return r.filter(Boolean)}setParent(e,t,n=!1){Array.isArray(t)||(t=[t]),t=t.filter(e=>{const t=this.query(e);return!(!t||!t.parent)}),e=e?this.query(e):cc.director._scene;for(const r of t){this.query(r).setParent(e,n)}return t}generateAvailableName(e,t){e||(e="Node");let n=cc.director._scene;return t&&(n=this.query(t)),utils_1.getNodeName(e,n)}createNode(e,t,n,r=!1){if(!cc.director._scene)return null;null===r&&(r=!0);const o=this.getNewNodeParent(e);let s=null;if(n&&stashInstants[n]){const{instant:e}=stashInstants[n];e&&(s=cc.instantiate(e),t=utils_1.getNodeName(s.name,o))}return s||(s=new cc.Node),t&&(s.name=t),this.emit("before-add",s),Editor.Message.broadcast("scene:before-add-node",s.uuid),this.emit("before-change",o),Editor.Message.broadcast("scene:before-change-node",e),s.setParent(o,r),n||this.ensureUITransformComponent(s),this.emit("change",o,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e),cce.Selection.clear(),cce.Selection.select(s.uuid),s.uuid}ensureUITransformComponent(e){if(e instanceof cc.Node&&0===e.children.length){let t=!1,n=e.parent;for(;n;){if(n.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){t=!0;break}n=n.parent}if(t)try{e.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){const n=this;if(!cc.director._scene)return!1;const r=cce.Selection.query();cce.Selection.clear();const o=this.query,s=o(e),a={};const i={};const c={};function d(e){const t={};if(e){if(c[e.uuid])return c[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,n)=>{e&&e._prefab&&(t[e._prefab.fileId]=n)}),c[e.uuid]=t)}return t}try{!function e(t){t&&t._prefab&&(a[t._prefab.fileId]=t,Array.isArray(t.children)&&t.children.forEach(t=>{e(t)}))}(s);const e=await promisify(cc_1.assetManager.loadAny)(t),r=cc.instantiate(e);s.parent.addChild(r),await async function e(t,r,c){if(t instanceof cc.PrivateNode)return!1;const u=d(r),h=function(e){const t={};if(e){if(i[e.uuid])return i[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),i[e.uuid]=t)}return t}(c),l=dump_1.default.dumpNode(t),f=l.__prefab__.fileId,p=c?o(h[f]):s;if(p){if(n.emit("before-change",p),Editor.Message.broadcast("scene:before-change-node",p.uuid),Array.isArray(p.children)){const e=d(t);let r=0,o=p.children[r];for(;o&&r<p.children.length;)o._prefab&&void 0===e[o._prefab.fileId]?n.removeNode(o.uuid):r++,o=p.children[r]}const r=dump_1.default.dumpNode(p);delete l.uuid,delete l.children,c?l.parent.value.uuid=c.uuid:(l.active.value=r.active.value,l.name.value=r.name.value,l.position.value=r.position.value,l.rotation.value=r.rotation.value),l.__prefab__=JSON.parse(JSON.stringify(r.__prefab__)),Array.isArray(l.__comps__)&&function e(t){t.forEach(t=>{if(!t.value||"object"!=typeof t.value)return;const n=Object.keys(t.value);for(const r of n){if(["node"].includes(r))continue;const n=t.value[r];if(n.isArray&&Array.isArray(n.value))e(n.value);else if("cc.Node"===n.type){const e=o(n.value.uuid);if(!e||!e._prefab.fileId)continue;const t=a[e._prefab.fileId];t&&(n.value.uuid=t.uuid)}}})}(l.__comps__),await dump_1.default.restoreNode(p,l),void 0!==u[f]&&p.setSiblingIndex(u[f]);let s=0,i=t.children[s];for(;i&&s<t.children.length;)await e(i,t,p)||s++,i=t.children[s];return n.emit("change",p),Editor.Message.broadcast("scene:change-node",p.uuid),!1}n.emit("before-add",t),Editor.Message.broadcast("scene:before-add-node",t.uuid),n.emit("before-change",c),Editor.Message.broadcast("scene:before-change-node",c.uuid);const _=u[t._prefab.fileId];return c.insertChild(t,_),t._prefab.root=c._prefab.root,n.emit("add",t),Editor.Message.broadcast("scene:add-node",t.uuid),n.emit("change",c),Editor.Message.broadcast("scene:change-node",c.uuid),!0}(r),r.parent=null,this.emit("change",s),Editor.Message.broadcast("scene:change-node",s.uuid)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return window.requestAnimationFrame(()=>{r.forEach(e=>{cce.Selection.select(e)})}),!0}async createNodeFromAsset(e,t,n){if(!cc.director._scene)return null;let r=this.getNewNodeParent(e);try{const{name:o,type:s,position:a,unlinkPrefab:i}=n;let c,d,{canvasRequired:u}=n;if(s&&!supportTypes.includes(s))return null;switch(s){case"cc.Mesh":{cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(d.name)).addComponent(cc_1.MeshRenderer);e&&(e.mesh=d)}break;case"cc.SpriteFrame":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(d.name)).addComponent(cc_1.Sprite);if(e){e.spriteFrame=d;const n=await Editor.Message.request("asset-db","query-asset-meta",t);n&&"none"===n.userData.trimType&&(e.trim=!1,e.sizeMode=cc_1.Sprite.SizeMode.RAW)}}break;case"cc.Script":{const e=await scripts_1.default.queryScriptName(t)||"";(c=new cc_1.Node(e)).addComponent(e)}break;case"cc.VideoClip":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(d.name)).addComponent(cc_1.VideoPlayer);e&&(e.clip=d)}break;case"cc.LabelAtlas":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(c=new cc_1.Node(d.name)).addComponent(cc_1.Label);e.font=d,e.fontSize=d.fontSize;const n=d.fntConfig.commonHeight;e.lineHeight=n||e.lineHeight}break;case"cc.Prefab":cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t),c=prefab_1.default.createNodeFromPrefabAsset(d);break;default:cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t),c=cc.instantiate(d)}if(u){let e=utils_1.getUIParentNode(r);if(!e){const t="f773db21-62b8-4540-956a-29bacf5ddbf5";cc_1.assetManager.assets.remove(t);const n=await promisify(cc_1.assetManager.loadAny)(t);e=cc.instantiate(n),prefab_1.default.removePrefabInfoFromNode(e),r.addChild(e)}r=e,a&&(a.z=e.position.z)}return o&&(c.name=basename(o,extname(o))),this.emit("before-add",c),Editor.Message.broadcast("scene:before-add-node",c.uuid),this.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",e),("cc.Prefab"!==s||i)&&prefab_1.default.removePrefabInfoFromNode(c),r.addChild(c),a&&c.setWorldPosition(a),this.emit("change",r,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e),cce.Selection.clear(),cce.Selection.select(c.uuid),c.uuid}catch(e){return console.error(e),null}}removeNode(e,t=!0){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e);for(const n of e){const e=this.query(n);if(!e)continue;const r=e.parent;this.emit("before-remove",e),Editor.Message.broadcast("scene:before-remove-node",e.uuid),this.emit("before-change",r),Editor.Message.broadcast("scene:before-change-node",r.uuid),e.setParent(null,t)}}changeNodeLock(e,t){Array.isArray(e)||(e=[e]);for(const n of e){const e=this.query(n);if(e){this.emit("before-change",e),Editor.Message.broadcast("scene:before-change-node",e.uuid);try{t?e._objFlags|=cc.Object.Flags.LockedInEditor:e._objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",e),Editor.Message.broadcast("scene:change-node",e.uuid)}}}queryComponentFunctionOfNode(e){const t=this.query(e);return t?get_component_function_of_node_1.default(t):{}}canRemoveOrCopy(e){const t=this,n=[],r=[];for(const n of e){const e=t.query(n);!e||!e.parent||e._objFlags&cc.Object.Flags.DontDestroy||r.push(n)}for(const e of r){o(t.query(e))||n.push(e)}function o(e){return!!e.parent&&(!!r.includes(e.parent.uuid)||o(e.parent))}return n}getNewNodeParent(e){let t;if(e)t=this.query(e);else{const e=cce.Selection.query();t=Array.isArray(e)&&e[0]?this.query(e[0]):cc.director._scene}return t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}}exports.default=new NodeManager;