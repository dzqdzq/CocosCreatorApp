"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeManager=void 0;const NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get,set,findLast}=require("lodash"),utils_1=require("./utils"),promisify=require("util")["promisify"],{basename,extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../../export/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),utils_2=require("../prefab/utils"),selection_1=__importDefault(require("../selection")),scene_facade_state_interface_1=require("../../facade/scene-facade-state-interface"),create_1=require("./create"),creatableAssetTypes=["cc.AnimationClip","cc.AudioClip","cc.BitmapFont","cc.LabelAtlas","cc.Mesh","cc.ParticleAsset","cc.Prefab","cc.Script","cc.SpriteFrame","cc.TTFFont","cc.TerrainAsset","cc.TiledMapAsset","cc.VideoClip","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{_onNodeAdded;_onNodeChanged;_onNodeRemoved;_onTransformChanged;_onSizeChanged;_onAnchorChanged;_onParentChanged;_onLightProbeChanged;_previewPropertysCache=new Map;get creatableAssetTypes(){return creatableAssetTypes}init(){}initWithScene(e){if(e){const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),cce.Component.init(),this._previewPropertysCache=new Map,this.emit("inited",this.queryUuids(),e)}}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){cce.Component.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this.unregisterNodeMgrEvents(),this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged,this),this._onLightProbeChanged=this.onLightProbeChanged.bind(this,e),e.on(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.Node.EventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.Node.EventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.Node.EventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.Node.EventType.CHILD_REMOVED,this._onParentChanged),this._onLightProbeChanged)&&e.off(cc_1.Node.EventType.LIGHT_PROBE_CHANGED,this._onLightProbeChanged)}onNodeTransformChanged(e,t){var n={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.EventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:n.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:n.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:n.propPath="scale"}this.emit("change",e,n)}onNodeSizeChanged(e){var t={type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);n&&(n=e.components.indexOf(n),t.propPath=`_components.${n}.contentSize`),this.emit("change",e,t)}onNodeAnchorChanged(e){var t={type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.EventSourceType.ENGINE},n=e.getComponent(cc_1.UITransform);n&&(n=e.components.indexOf(n),t.propPath=`_components.${n}.anchorPoint`),this.emit("change",e,t)}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),t.parent&&this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}))}onLightProbeChanged(e){var t={type:event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED,source:event_enum_1.EventSourceType.ENGINE};this.emit("change",e,t)}clear(){const t=NodeMgr.getNodes();Object.keys(t).forEach(e=>{this.unregisterEventListeners(t[e])}),NodeMgr.clear(),cce.Component.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||this.emit("added",t)}change(e,t){if(!node_1.default.isEditorNode(t)){let e="";var n=t.getComponent(cc_1.LODGroup);n&&(n=t.components.indexOf(n),e="__comps__."+n),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e})}}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||this.emit("removed",t,{source:event_enum_1.EventSourceType.ENGINE})}query(e){return void 0===e?null:NodeMgr.getNode(e)??cce.SceneFacadeManager.getCurrentFacade().queryRecycleNode(e)}queryUuids(){var e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){e=NodeMgr.getNodesInScene()[e];return e?dump_1.default.dumpNode(e):null}queryDumpAtAll(e){e=this.query(e);return e?dump_1.default.dumpNode(e):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}async queryNodesMissAsset(){const o=[],a=[];EditorExtends.walkProperties(cc_1.director.getScene()?.children,(e,t,n,r)=>{n._uuid&&!(cc.assetManager.assets.get(n._uuid)||cc.assetManager.assets.get(Editor.Utils.UUID.compressUUID(n._uuid,!0)))&&(r=findLast(r,e=>e instanceof cc.Node))&&!o.includes(r.uuid)&&o.push(r.uuid),n instanceof cc_1.MissingScript&&(r=n._$erialized?.__type__,a.push({nodeUuid:n.node.uuid,scriptUuid:EditorExtends.UuidUtils.decompressUuid(r)}))},{dontSkipNull:!1,ignoreSubPrefabHelper:!0});const t=(await Editor.Message.request("asset-db","batch-message-handler",a.map(e=>({name:"query-asset-info",args:[e.scriptUuid]})))).map(e=>e&&e.uuid);return a.forEach(e=>{t.includes(e.scriptUuid)||o.includes(e.nodeUuid)||o.push(e.nodeUuid)}),o}async previewSetNodeProperty(e,t,n){var r=this.query(e),o=dump_1.default.parsingPath(t,r);if(!r)return console.warn("previewSetNodeProperty failed：node not found",e),!1;if(!o.search)return console.warn("previewSetNodeProperty failed：property path error",t),!1;let a=get(r,o.search)?get(r,o.search)[o.key]:void 0;a=a||dump_1.default.getDefaultValue(n.type);r=dump_1.default.encodeObject(a,{type:n.type,ctor:a.constructor},a),o=this._previewPropertysCache.has(e)?this._previewPropertysCache.get(e):new Map;return o?.has(t)||o?.set(t,r),this._previewPropertysCache.set(e,o),this.setProperty(e,t,n,!1)}async cancelPreviewSetNodeProperty(e,t){var n=this.query(e),r=dump_1.default.parsingPath(t,n);return n?r.search?!!(n=this._previewPropertysCache.get(e))&&!!(r=n?.get(t))&&(n?.delete(t),this.setProperty(e,t,r,!1)):(console.warn("cancelPreviewSetNodeProperty failed:property path error",t),!1):(console.warn("cancelPreviewSetNodeProperty failed:node not found",e),!1)}async setProperty(t,n,r,o=!0){if(Array.isArray(t))try{for(let e=0;e<t.length;e++)await this.setProperty(t[e],n,r);return!0}catch(e){return console.error(e),!1}const a=this.query(t);return a?(this.emit("before-change",a),"parent"===n&&a.parent&&this.emit("before-change",a.parent),await dump_1.default.restoreProperty(a,n,r),this.emit("change",a,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:n,record:o}),r.isArray&&Array.isArray(r.value)&&r.value.forEach((e,t)=>{this.emit("change",a,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:n+"."+t,record:o})}),"parent"===n&&a.parent&&this.emit("change",a.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children",record:o}),!0):(console.warn(`Set property failed: ${t} does not exist`),!1)}async resetProperty(e,t){if(Array.isArray(e))e.forEach(e=>{this.resetProperty(e,t)});else{var n=this.query(e);if(!n)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",n),await dump_1.default.resetProperty(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t})}return!0}async updatePropertyFromNull(e,t){if(Array.isArray(e))e.forEach(e=>{this.updatePropertyFromNull(e,t)});else{var n=this.query(e);if(!n)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",n),await dump_1.default.updatePropertyFromNull(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t})}return!0}async resetNode(e){if(Array.isArray(e))e.forEach(e=>{this.resetNode(e)});else{var t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t);for(const n of["position","rotation","scale","mobility"])await dump_1.default.resetProperty(t,n),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:n})}return!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);e=this.query(e);e&&e.children&&0<e.children.length&&e.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,n,r){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,n,r)}),!1;var o=this.query(e);if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;var a=(t=t.replace("__comps__","_components"))?get(o,t):o;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",o),"children"===t){var e=a.filter(e=>!(e.objFlags&cc.Object.Flags.HideInHierarchy)),i=e[n];if(!i)return!1;e=a.indexOf(e[n+r]);i.setSiblingIndex(e)}else{i=a.splice(n,1);a.splice(n+r,0,i[0]),set(o,t,a)}return this.emit("change",o,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),!0}removeArrayElement(e,t,n){if(Array.isArray(e))e.forEach(e=>{this.removeArrayElement(e,t,n)});else{var r=this.query(e),o=(t||"").split(".").pop();if("children"===o)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;var a=(t=t.replace("__comps__","_components"))?get(r,t):r;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(a))return console.warn(`Move property failed: ${e} - ${t}.${o} isn't an array`),!1;this.emit("before-change",r),"_components"===t?(e=a[n],this.removeComponent(e.uuid)):(a.splice(n,1),set(r,t,a)),this.emit("change",r,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:n})}return!0}onComponentAdded(t,e){0!==this.requireComponentList.length&&this.requireComponentList.find(e=>t instanceof e)&&this.requireComponentList.find(e=>cc_1.js.getClassName(e)===cc_1.js.getClassName(t))&&cce.Component.onComponentAddedFromEditor(t)}requireComponentList=[];createComponent(e,r){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,r)}),console.warn("don't add component to more than one node at one time"),!1;var o=this.query(e);if(!o)return console.warn(`create component failed: ${e} does not exist`),!1;if(!r)return console.warn(`create component failed: ${r} does not exist`),!1;{this.emit("before-change",o),this.emit("before-add-component",r,o);let n=null;try{if("MissingScript"===r||"cc.MissingScript"===r)throw new Error("Reset Component failed: MissingScript does not exist");let t=cc_1.js.getClassById(r);if(t=t||cc_1.js.getClassByName(r),cc_1.js.isChildClassOf(t,cc_1.Component)){let e=t;if(e._requireComponent)for(;e._requireComponent;)this.requireComponentList.push(e._requireComponent),e=e._requireComponent;n=o.addComponent(t),this.requireComponentList=[]}else console.error(`ctor with name ${r} is not child class of Component `);if("prefab"===cce.SceneFacadeManager.queryMode()){const a=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy.getRootNode();(0,utils_1.hasOneKindOfComponent)(o,cc_1.UITransform)&&!(0,utils_1.hasOneKindOfComponent)(a,cc_1.Canvas)&&(0,create_1.createShouldHideInHierarchyCanvasNode)(cc_1.director.getScene()).then(e=>{a.parent=e})}this.checkComponentsCollision(o),this.checkDynamicBodyShape(o)}catch(e){console.error(e)}n&&cce.Component.onComponentAddedFromEditor(n),this.emit("change",o,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT})}return!0}async resetComponent(e){var t=cce.Component.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node);e=await cce.Component.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),e}removeComponent(e){var t=cce.Component.query(e);return t?cce.Component.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const n of e){var t=this.query(n);t&&(function t(n){var e=n._prefab;if(e){if(e.instance)return;n._prefab=null;for(let e=0;e<n.components.length;e++)n.components[e].__prefab=null}if(0<n.children.length){let e=n.children.length;for(;e--;){var r=n.children[e],o=r.objFlags&cc.Object.Flags.HideInHierarchy,a=r.objFlags&cc.Object.Flags.DontSave;o&&a?n.removeChild(r):t(r)}}}(t=cc.instantiate(t)),stashInstants[n]={instant:t})}return e}duplicateNode(e){Array.isArray(e)||(e=[e]);var t=[],n=stashInstants;for(const o of e=this.copyNode(e)){var r=this.query(o);r&&(r=this.createNode(r.parent?.uuid,null,o,!1,!0))&&t.push(r)}stashInstants=n;e=t.filter(Boolean);return selection_1.default.clear(),e.forEach(e=>{selection_1.default.select(e)}),e}async pasteNode(e,t,n=!1){var r=[];for(const s of t=Array.isArray(t)?t:[t]){var o,a,i=this.createNode(e,null,s,n,!0);i&&((a=this.query(i))&&(o=cce.SceneFacadeManager.getCurrentFacade().modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&this.checkNodeUseCanvasRequired(a),(o=await this.checkCanvasRequired(a,o,this.getNewNodeParent(e),void 0))!==a)&&a.setParent(o,n),r.push(i),e||(a=this.query(i))&&(e=a.parent?.uuid))}t=r.filter(Boolean);return selection_1.default.clear(),t.forEach(e=>{selection_1.default.select(e)}),t}setParent(e,t,n=!1){t=(t=Array.isArray(t)?t:[t]).filter(e=>{e=this.query(e);return!(!e||!e.parent)});let r;e&&(r=this.query(e)),r||=cc_1.director.getScene();for(const o of t)this.query(o)?.setParent(r,n);return t}generateAvailableName(e,t){e=e||"Node";let n=cc_1.director.getScene();return t&&(t=this.query(t),n=t||n),(0,utils_1.getNodeName)(e,n)}createNode(t,n,r,o=!1,a=!1){if(cc.director.getScene()){null===o&&(o=!0);var i,t=this.getNewNodeParent(t);let e=null;if(r&&stashInstants[r]&&(i=stashInstants[r]["instant"],i)&&(e=cc.instantiate(i))&&((0,utils_1.visitNode)(e,e=>{e=e._prefab;if(e?.instance)return e.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(e.instance),!0}),n=(0,utils_1.getNodeName)(e.name,t)),e=e||new cc.Node)return n&&(e.name=n),t.layer&&t!==cc_1.director.getScene()&&!a&&(0,utils_1.setLayer)(e,t.layer,!0),this.emit("before-add",e),this.emit("before-change",t),e.setParent(t,o),r||this.ensureUITransformComponent(e),this.emit("add",e),t&&this.emit("change",t,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),cce.Selection.clear(),cce.Selection.select(e.uuid),e.uuid}}ensureUITransformComponent(n){if(n instanceof cc.Node&&0===n.children.length){let e=!1,t=n.parent;for(;t;){if(t.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){e=!0;break}t=t.parent}if(e)try{n.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){const h=this;if(!cc_1.director.getScene())return!1;const n=cce.Selection.query(),u=(cce.Selection.clear(),this.query),l=u(e),p={};const _={};const r={};function f(e){const n={};if(e){if(r[e.uuid])return r[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,t)=>{e&&e._prefab&&(n[e._prefab.fileId]=t)}),r[e.uuid]=n)}return n}async function m(n,r,o){if(n.objFlags&cc.Object.Flags.HideInHierarchy)return!1;var r=f(r),a=function(e){const t={};if(e){if(_[e.uuid])return _[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),_[e.uuid]=t)}return t}(o),i=dump_1.default.dumpNode(n),s=i.__prefab__.fileId,c=o?u(a[s]):l;if(c){if(h.emit("before-change",c),Array.isArray(c.children)){var d=f(n);let e=0,t=c.children[e];for(;t&&e<c.children.length;)t._prefab&&void 0===d[t._prefab.fileId]?h.removeNode(t.uuid):e++,t=c.children[e]}a=dump_1.default.dumpNode(c);delete i.uuid,delete i.children,o?i.parent.value.uuid=o.uuid:(i.active.value=a.active.value,i.name.value=a.name.value,i.position.value=a.position.value,i.rotation.value=a.rotation.value),i.__prefab__=JSON.parse(JSON.stringify(a.__prefab__)),Array.isArray(i.__comps__)&&!function o(e){e.forEach(e=>{var t,n;if(e.value&&"object"==typeof e.value)for(const r of Object.keys(e.value))["node"].includes(r)||((t=e.value[r]).isArray&&Array.isArray(t.value)?o(t.value):"cc.Node"===t.type&&(n=u(t.value.uuid))&&n?._prefab?.fileId&&(n=p[n._prefab.fileId])&&(t.value.uuid=n.uuid))})}(i.__comps__),await dump_1.default.restoreNode(c,i),void 0!==r[s]&&c.setSiblingIndex(r[s]);let e=0,t=n.children[e];for(;t&&e<n.children.length;)await m(t,n,c)||e++,t=n.children[e];return h.emit("change",c),!1}a=n._prefab;return a&&o&&(h.emit("before-add",n),h.emit("before-change",o),i=r[a.fileId],o.insertChild(n,i),a.root=o._prefab?.root,h.emit("add",n),h.emit("change",o)),!0}try{!function t(e){e&&e._prefab&&(p[e._prefab.fileId]=e,Array.isArray(e.children))&&e.children.forEach(e=>{t(e)})}(l);var o=await(0,create_1.loadAny)(t),a=cc.instantiate(o);l.parent?.addChild(a),await m(a),a.parent=null,this.emit("change",l)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return setTimeout(()=>{n.forEach(e=>{cce.Selection.select(e)})}),!0}checkNodeUseCanvasRequired(e){if(!e)return!1;let t=!1;return!e.getComponent("cc.Canvas")&&(e.walk(e=>{t||e.components.forEach(e=>{t=t||"cc.UITransform"===cc_1.js.getClassName(e)})}),t)}async checkCanvasRequired(e,n,r,o){var a=cce.SceneFacadeManager.queryMode(),i=null;let s=null;if("prefab"===a&&(i=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy,s=i.getRootNode(),r===cc_1.director.getScene())&&(r=s),n){let t=null;if("prefab"===a){t=(0,utils_1.getUICanvasNode)(r,!1);i=(0,utils_1.getUITransformParentNode)(r);if(t)t.parent!==cc_1.director.getScene()&&(r=t);else if(i)t=i;else{n=await Editor.Dialog.warn(Editor.I18n.t("scene.contributions.messages.description.UITransform_lack"),{buttons:[Editor.I18n.t("scene.contributions.messages.description.UITransform_add_to_root"),Editor.I18n.t("scene.contributions.messages.description.UITransform_within_canvas"),Editor.I18n.t("scene.contributions.messages.description.UITransform_cancel")],default:0,cancel:2});if(0===n.response){if(!s)return console.error("prefab Root is not exist"),null;s.addComponent("cc.UITransform"),s.parent&&!(0,utils_1.hasOneKindOfComponent)(s.parent,cc_1.Canvas)&&(t=await(0,create_1.createShouldHideInHierarchyCanvasNode)(cc_1.director.getScene()),s.parent=t)}2===n.response&&(t=new cc_1.Node)}}else(t=(0,utils_1.getUICanvasNode)(r))&&(r=t);if(!t){let e="f773db21-62b8-4540-956a-29bacf5ddbf5";"2d"===cce.SceneFacadeManager._projectType&&(e="4c33600e-9ca9-483b-b734-946008261697"),cc_1.assetManager.assets.remove(e);a=await(0,create_1.loadAny)(e);t=cc.instantiate(a),cce.Prefab.removePrefabInfoFromNode(t),r.addChild(t),r=t}o&&(o.z=t.position.z)}return r}async createNodeFromAsset(e,t,n){try{if(cc.director.getScene()){var r,o,a=this.getNewNodeParent(e),{name:i,type:s,position:c,unlinkPrefab:d}=n;if(!s||creatableAssetTypes.includes(s))return DEBUG_TIME_COST&&console.time("createNodeFromAsset"),void 0===n.autoAdaptToCreate&&(n.autoAdaptToCreate=!0),{node:r,canvasRequired:o}=await(0,create_1.createNodeByAsset)({uuid:t,type:s,canvasRequired:n.canvasRequired,autoAdaptToCreate:n.autoAdaptToCreate}),a=await this.checkCanvasRequired(r,Boolean(o),a,c),i&&(r.name=basename(i,extname(i))),DEBUG_TIME_COST&&console.time("addNodeEvent"),this.emit("before-add",r),this.emit("before-change",a),("cc.Prefab"!==s||d)&&(cce.Prefab.removePrefabInfoFromNode(r),a.layer)&&a!==cc_1.director.getScene()&&(0,utils_1.setLayer)(r,a.layer,!0),a.addChild(r),c&&r.setWorldPosition(c),this.emit("add",r),this.emit("change",a,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),DEBUG_TIME_COST&&console.timeEnd("addNodeEvent"),cce.Selection.clear(),cce.Selection.select(r.uuid),DEBUG_TIME_COST&&console.timeEnd("createNodeFromAsset"),r.uuid}}catch(e){console.error(e)}}_walkNode(e,t){e&&e.children&&e.children.forEach(e=>{t(e),this._walkNode(e,t)})}removeNode(e,t){Array.isArray(e)||(e=[e]);for(const o of e=this.canRemoveOrCopy(e)){var n=this.query(o);if(n){var r=n.parent;this.emit("before-remove",n),r&&this.emit("before-change",r),console.time("NodeMgr::removeNode"),n.setParent(null,t),n._objFlags|=cc_1.CCObject.Flags.Destroyed;try{this._walkNode(n,e=>{e._objFlags|=cc_1.CCObject.Flags.Destroyed})}catch(e){console.warn(e)}console.timeEnd("NodeMgr::removeNode"),this.emit("remove",n,{source:event_enum_1.EventSourceType.EDITOR})}}}changeNodeLock(e,t,n){for(const o of e=Array.isArray(e)?e:[e]){var r=this.query(o);if(r){this.emit("before-change",r);try{t?r.objFlags|=cc.Object.Flags.LockedInEditor:r.objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",r),!0===n&&r.children&&0<r.children.length&&r.children.forEach(e=>{this.changeNodeLock(e.uuid,t,n)})}}}queryComponentFunctionOfNode(e){e=this.query(e);return e?(0,get_component_function_of_node_1.default)(e):{}}canRemoveOrCopy(e){var t=[];const n=[];for(const o of e){var r=this.query(o);!r||!r.parent||r.objFlags&cc.Object.Flags.DontDestroy||n.push(o)}for(const a of n)!function e(t){if(!t.parent)return!1;return!!n.includes(t.parent.uuid)||e(t.parent)}(this.query(a))&&t.push(a);return t}getNewNodeParent(e){let t;t=(t=e?this.query(e):(e=cce.Selection.query(),Array.isArray(e)&&e[0]?this.query(e[0]):cc_1.director.getScene()))||cc_1.director.getScene();var e=cce.SceneFacadeManager.queryMode();return t="prefab"===e&&(e=cce.SceneFacadeManager._facadeFSM.prefabSceneFacade._sceneProxy.getRootNode(),t===cc.director.getScene())?e:t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}addComponentAt(e,t,n){return!(!e||!t||n<0||t instanceof cc_1.MissingScript&&!t._$erialized||(e._addComponentAt(t,n),cce.Component.emit("add",t),0))}checkComponentsCollision(e){(0,utils_1.hasOneKindOfComponent)(e,cc_1.animation.AnimationController)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Animation)&&console.warn(Editor.I18n.t("scene.contributions.messages.description.animationComponentCollision"))}checkDynamicBodyShape(e){if((0,utils_1.hasOneKindOfComponent)(e,cc_1.RigidBody)&&(0,utils_1.hasOneKindOfComponent)(e,cc_1.Collider)){var t=e.getComponent(cc_1.RigidBody);if(t){var n=e.getComponent(cc_1.Collider);if(t.type===cc_1.ERigidBodyType.DYNAMIC)switch(n?.type){case cc_1.EColliderType.PLANE:case cc_1.EColliderType.TERRAIN:console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"));break;case cc_1.EColliderType.MESH:n.convex||console.warn(Editor.I18n.t("scene.contributions.messages.description.physicsDynamicBodyShape"))}}}}}exports.NodeManager=NodeManager,exports.default=new NodeManager;