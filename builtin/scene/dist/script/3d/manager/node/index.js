"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ElectronModule=require("@base/electron-module"),EditorExtends=ElectronModule.require("EditorExtends"),NodeMgr=EditorExtends.Node,EventEmitter_1=__importDefault(require("../../../public/EventEmitter")),{get:get,set:set}=require("lodash"),utils_1=require("./utils"),index_1=__importDefault(require("./../component/index")),{promisify:promisify}=require("util"),{basename:basename,extname:extname}=require("path"),node_1=__importDefault(require("../../../utils/node")),dump_1=__importDefault(require("../../utils/dump")),get_component_function_of_node_1=__importDefault(require("../../utils/get-component-function-of-node")),cc_1=require("cc"),event_enum_1=require("../../../public/event-enum"),prefab_1=__importDefault(require("../prefab")),utils_2=require("../prefab/utils"),scripts_1=__importDefault(require("../scripts")),creatableAssetTypes=["cc.AnimationClip","cc.AudioClip","cc.BitmapFont","cc.LabelAtlas","cc.Mesh","cc.ParticleAsset","cc.Prefab","cc.Script","cc.SpriteFrame","cc.TTFFont","cc.TerrainAsset","cc.TiledMapAsset","cc.VideoClip","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"];let stashInstants=null;class NodeManager extends EventEmitter_1.default{get creatableAssetTypes(){return creatableAssetTypes}init(){}initWithScene(e){if(!e)return;const t=NodeMgr.getNodesInScene();Object.keys(t).forEach(e=>{this.registerEventListeners(t[e])}),this.registerNodeMgrEvents(),index_1.default.init(),this.emit("inited",this.queryUuids(),e)}onSceneOpened(e){this.initWithScene(e)}onSceneClosed(){index_1.default.unregisterCompMgrEvents(),this.unregisterNodeMgrEvents(),this.clear()}registerNodeMgrEvents(){this._onNodeAdded=this.add.bind(this),NodeMgr.on("add",this._onNodeAdded),this._onNodeChanged=this.change.bind(this),NodeMgr.on("change",this._onNodeChanged),this._onNodeRemoved=this.remove.bind(this),NodeMgr.on("remove",this._onNodeRemoved)}unregisterNodeMgrEvents(){this._onNodeAdded&&NodeMgr.off("add",this._onNodeAdded),this._onNodeChanged&&NodeMgr.off("change",this._onNodeChanged),this._onNodeRemoved&&NodeMgr.off("remove",this._onNodeRemoved)}registerEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged=this.onNodeTransformChanged.bind(this,e),e.on(cc_1.SystemEventType.TRANSFORM_CHANGED,this._onTransformChanged,this),this._onSizeChanged=this.onNodeSizeChanged.bind(this,e),e.on(cc_1.SystemEventType.SIZE_CHANGED,this._onSizeChanged,this),this._onAnchorChanged=this.onNodeAnchorChanged.bind(this,e),e.on(cc_1.SystemEventType.ANCHOR_CHANGED,this._onAnchorChanged,this),this._onParentChanged=this.onNodeParentChanged.bind(this,e),e.on(cc_1.SystemEventType.CHILD_ADDED,this._onParentChanged,this),e.on(cc_1.SystemEventType.CHILD_REMOVED,this._onParentChanged,this))}unregisterEventListeners(e){e&&e.isValid&&!node_1.default.isEditorNode(e)&&(this._onTransformChanged&&e.off(cc_1.SystemEventType.TRANSFORM_CHANGED,this._onTransformChanged),this._onSizeChanged&&e.off(cc_1.SystemEventType.SIZE_CHANGED,this._onSizeChanged),this._onAnchorChanged&&e.off(cc_1.SystemEventType.ANCHOR_CHANGED,this._onAnchorChanged),this._onParentChanged&&e.off(cc_1.SystemEventType.CHILD_ADDED,this._onParentChanged),this._onParentChanged&&e.off(cc_1.SystemEventType.CHILD_REMOVED,this._onParentChanged))}onNodeTransformChanged(e,t){const n={type:event_enum_1.NodeEventType.TRANSFORM_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE};switch(t){case cc_1.Node.TransformBit.POSITION:n.propPath="position";break;case cc_1.Node.TransformBit.ROTATION:n.propPath="rotation";break;case cc_1.Node.TransformBit.SCALE:n.propPath="scale"}this.emit("change",e,n)}onNodeSizeChanged(e){this.emit("change",e,{type:event_enum_1.NodeEventType.SIZE_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE}),e.getComponent(cc_1.Canvas)&&Editor.Message.broadcast("scene:change-node",e.uuid)}onNodeAnchorChanged(e){this.emit("change",e,{type:event_enum_1.NodeEventType.ANCHOR_CHANGED,source:event_enum_1.NodeEventSourceType.ENGINE})}onNodeParentChanged(e,t){node_1.default.isEditorNode(t)||(this.emit("change",e,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e.uuid),t.parent&&(this.emit("change",t,{type:event_enum_1.NodeEventType.PARENT_CHANGED}),Editor.Message.broadcast("scene:change-node",t.uuid)))}clear(){const e=NodeMgr.getNodes();Object.keys(e).forEach(t=>{this.unregisterEventListeners(e[t])}),NodeMgr.clear(),index_1.default.clear()}add(e,t){this.registerEventListeners(t),node_1.default.isEditorNode(t)||(this.emit("add",t),Editor.Message.broadcast("scene:add-node",t.uuid))}change(e,t){node_1.default.isEditorNode(t)||(this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:""}),Editor.Message.broadcast("scene:change-node",e))}remove(e,t){this.unregisterEventListeners(t),node_1.default.isEditorNode(t)||(this.emit("remove",t),Editor.Message.broadcast("scene:remove-node",t.uuid))}query(e){return NodeMgr.getNode(e)||null}queryUuids(){const e=NodeMgr.getNodes();return Object.keys(e)}queryDump(e){const t=NodeMgr.getNodesInScene()[e];return t?dump_1.default.dumpNode(t):null}queryDumpAtAll(e){const t=this.query(e);return t?dump_1.default.dumpNode(t):null}queryNodesByAssetUuid(e){return e?NodeMgr.getNodesByAsset(e):[]}async setProperty(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.setProperty(e,t,n)}),!1;const a=this.query(e);return!a&&await index_1.default.setProperty(e,t,n)?(console.warn(`Set property failed: ${e} does not exist`),!1):(this.emit("before-change",a),Editor.Message.broadcast("scene:before-change-node",e),"parent"===t&&a.parent&&(Editor.Message.broadcast("scene:before-change-node",a.parent.uuid),this.emit("before-change",a.parent)),await dump_1.default.restoreProperty(a,t,n),this.emit("change",a,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),Editor.Message.broadcast("scene:change-node",e),"parent"===t&&a.parent&&(Editor.Message.broadcast("scene:change-node",a.parent.uuid),this.emit("change",a.parent,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:"children"})),!0)}async resetProperty(e,t){if(Array.isArray(e))return e.forEach(e=>{this.resetProperty(e,t)}),!0;const n=this.query(e);return n?(this.emit("before-change",n),Editor.Message.broadcast("scene:before-change-node",e),await dump_1.default.resetProperty(n,t),this.emit("change",n,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:t}),Editor.Message.broadcast("scene:change-node",e),!0):(console.warn(`Set default value failed: ${e} does not exist`),!1)}async resetNode(e){if(Array.isArray(e))return e.forEach(e=>{this.resetNode(e)}),!0;const t=this.query(e);if(!t)return console.warn(`Set default value failed: ${e} does not exist`),!1;this.emit("before-change",t),Editor.Message.broadcast("scene:before-change-node",e);const n=["position","rotation","scale"];for(const e of n)await dump_1.default.resetProperty(t,e),this.emit("change",t,{type:event_enum_1.NodeOperationType.SET_PROPERTY,propPath:e});return Editor.Message.broadcast("scene:change-node",e),!0}async setNodeAndChildrenLayer(e,t){await this.setProperty(e,"layer",t);const n=this.query(e);n.children&&n.children.length>0&&n.children.forEach(e=>{this.setNodeAndChildrenLayer(e.uuid,t)})}moveArrayElement(e,t,n,a){if(Array.isArray(e))return e.forEach(e=>{this.moveArrayElement(e,t,n,a)}),!1;const o=this.query(e);if(!o)return console.warn(`Move property failed: ${e} does not exist`),!1;const r=(t=t.replace("__comps__","_components"))?get(o,t):o;if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(r))return console.warn(`Move property failed: ${e} - ${t} isn't an array`),!1;if(this.emit("before-change",o),Editor.Message.broadcast("scene:before-change-node",e),"children"===t){const e=r.filter(e=>!(e._objFlags&cc.Object.Flags.HideInHierarchy)),t=e[n];if(!t)return!1;const o=r.indexOf(e[n+a]);t.setSiblingIndex(o)}else{const e=r.splice(n,1);r.splice(n+a,0,e[0]),set(o,t,r)}return this.emit("change",o,{type:event_enum_1.NodeOperationType.MOVE_ARRAY_ELEMENT,propPath:t}),Editor.Message.broadcast("scene:change-node",e),!0}removeArrayElement(e,t,n){if(Array.isArray(e))return e.forEach(e=>{this.removeArrayElement(e,t,n)}),!0;const a=this.query(e),o=(t||"").split(".").pop();if("children"===o)return console.warn("Unable to change `children` of the parent, Please change the `parent` of the child"),!1;if(!a)return console.warn(`Move property failed: ${e} does not exist`),!1;const r=(t=t.replace("__comps__","_components"))?get(a,t):a;if(!r)return console.warn(`Move property failed: ${e} does not exist`),!1;if(!Array.isArray(r))return console.warn(`Move property failed: ${e} - ${t}.${o} isn't an array`),!1;if(this.emit("before-change",a),Editor.Message.broadcast("scene:before-change-node",e),"_components"===t){const e=r[n];this.removeComponent(e.uuid)}else r.splice(n,1),set(a,t,r);return this.emit("change",a,{type:event_enum_1.NodeOperationType.REMOVE_ARRAY_ELEMENT,propPath:t,index:n}),Editor.Message.broadcast("scene:change-node",e),!0}createComponent(e,t){if(Array.isArray(e))return e.forEach(e=>{this.createComponent(e,t)}),console.warn("don't add component to more than one node at one time"),!1;const n=this.query(e);if(!n)return console.warn(`create component failed: ${e} does not exist`),!1;if(!t)return console.warn(`create component failed: ${t} does not exist`),!1;{this.emit("before-change",n),this.emit("before-add-component",t,n),Editor.Message.broadcast("scene:before-change-node",e);let a=null;try{a=n.addComponent(t)}catch(e){console.error(e)}index_1.default.onComponentAddedFromEditor(a),this.emit("change",n,{type:event_enum_1.NodeOperationType.CREATE_COMPONENT}),Editor.Message.broadcast("scene:change-node",e)}return!0}async resetComponent(e){const t=index_1.default.query(e);if(!t)return console.warn(`Reset Component failed: ${e} does not exist`),!1;this.emit("before-change",t.node),Editor.Message.broadcast("scene:before-change-node",t.node.uuid);const n=await index_1.default.resetComponent(t);return this.emit("change",t.node,{type:event_enum_1.NodeOperationType.RESET_COMPONENT}),Editor.Message.broadcast("scene:change-node",t.node.uuid),n}removeComponent(e){const t=index_1.default.query(e);return t?index_1.default.removeComponent(t):(console.warn(`Remove Component failed: ${e} does not exist`),!1)}copyNode(e){function t(e){const n=e._prefab;if(n){if(n.instance)return void(n.instance=utils_2.prefabUtils.cloneInstanceWithNewFileId(n.instance));e._prefab=null;for(let t=0;t<e.components.length;t++){e.components[t].__prefab=null}}if(e.children.length>0){let n=e.children.length;for(;n--;){const a=e.children[n],o=a._objFlags&cc.Object.Flags.HideInHierarchy,r=a._objFlags&cc.Object.Flags.DontSave;o&&r?e.children.splice(n,1):t(a)}}}Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e),stashInstants={};for(const n of e){const e=this.query(n);if(!e)continue;const a=cc.instantiate(e);t(a),stashInstants[n]={instant:a}}return e}duplicateNode(e){Array.isArray(e)||(e=[e]);const t=[];e=this.copyNode(e);for(const n of e){const e=this.query(n);if(!e)continue;const a=this.createNode(e.parent.uuid,null,n,!1);t.push(a)}return stashInstants={},t.filter(Boolean)}pasteNode(e,t,n=!1){Array.isArray(t)||(t=[t]);const a=[];for(const o of t){const t=this.createNode(e,null,o,n);a.push(t)}return a.filter(Boolean)}setParent(e,t,n=!1){Array.isArray(t)||(t=[t]),t=t.filter(e=>{const t=this.query(e);return!(!t||!t.parent)}),e=e?this.query(e):cc.director._scene;for(const a of t){this.query(a).setParent(e,n)}return t}generateAvailableName(e,t){e||(e="Node");let n=cc.director._scene;return t&&(n=this.query(t)),utils_1.getNodeName(e,n)}createNode(e,t,n,a=!1){if(!cc.director._scene)return null;null===a&&(a=!0);const o=this.getNewNodeParent(e);let r=null;if(n&&stashInstants[n]){const{instant:e}=stashInstants[n];e&&(r=cc.instantiate(e),t=utils_1.getNodeName(r.name,o))}return r||(r=new cc.Node),t&&(r.name=t),this.emit("before-add",r),Editor.Message.broadcast("scene:before-add-node",r.uuid),this.emit("before-change",o),Editor.Message.broadcast("scene:before-change-node",e),r.setParent(o,a),n||this.ensureUITransformComponent(r),this.emit("change",o,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e),cce.Selection.clear(),cce.Selection.select(r.uuid),r.uuid}ensureUITransformComponent(e){if(e instanceof cc.Node&&0===e.children.length){let t=!1,n=e.parent;for(;n;){if(n.components.map(e=>cc.js.getClassName(e.constructor)).includes("cc.Canvas")){t=!0;break}n=n.parent}if(t)try{e.addComponent("cc.UITransform")}catch(e){console.error(e)}}}async restorePrefab(e,t){const n=this;if(!cc.director._scene)return!1;const a=cce.Selection.query();cce.Selection.clear();const o=this.query,r=o(e),s={};const c={};const i={};function d(e){const t={};if(e){if(i[e.uuid])return i[e.uuid];Array.isArray(e.children)&&(e.children.forEach((e,n)=>{e&&e._prefab&&(t[e._prefab.fileId]=n)}),i[e.uuid]=t)}return t}try{!function e(t){t&&t._prefab&&(s[t._prefab.fileId]=t,Array.isArray(t.children)&&t.children.forEach(t=>{e(t)}))}(r);const e=await promisify(cc_1.assetManager.loadAny)(t),a=cc.instantiate(e);r.parent.addChild(a),await async function e(t,a,i){if(t._objFlags&cc.Object.Flags.HideInHierarchy)return!1;const u=d(a),l=function(e){const t={};if(e){if(c[e.uuid])return c[e.uuid];Array.isArray(e.children)&&(e.children.forEach(e=>{e&&e._prefab&&(t[e._prefab.fileId]=e.uuid)}),c[e.uuid]=t)}return t}(i),h=dump_1.default.dumpNode(t),f=h.__prefab__.fileId,p=i?o(l[f]):r;if(p){if(n.emit("before-change",p),Editor.Message.broadcast("scene:before-change-node",p.uuid),Array.isArray(p.children)){const e=d(t);let a=0,o=p.children[a];for(;o&&a<p.children.length;)o._prefab&&void 0===e[o._prefab.fileId]?n.removeNode(o.uuid):a++,o=p.children[a]}const a=dump_1.default.dumpNode(p);delete h.uuid,delete h.children,i?h.parent.value.uuid=i.uuid:(h.active.value=a.active.value,h.name.value=a.name.value,h.position.value=a.position.value,h.rotation.value=a.rotation.value),h.__prefab__=JSON.parse(JSON.stringify(a.__prefab__)),Array.isArray(h.__comps__)&&function e(t){t.forEach(t=>{if(!t.value||"object"!=typeof t.value)return;const n=Object.keys(t.value);for(const a of n){if(["node"].includes(a))continue;const n=t.value[a];if(n.isArray&&Array.isArray(n.value))e(n.value);else if("cc.Node"===n.type){const e=o(n.value.uuid);if(!e||!e._prefab.fileId)continue;const t=s[e._prefab.fileId];t&&(n.value.uuid=t.uuid)}}})}(h.__comps__),await dump_1.default.restoreNode(p,h),void 0!==u[f]&&p.setSiblingIndex(u[f]);let r=0,c=t.children[r];for(;c&&r<t.children.length;)await e(c,t,p)||r++,c=t.children[r];return n.emit("change",p),Editor.Message.broadcast("scene:change-node",p.uuid),!1}n.emit("before-add",t),Editor.Message.broadcast("scene:before-add-node",t.uuid),n.emit("before-change",i),Editor.Message.broadcast("scene:before-change-node",i.uuid);const _=u[t._prefab.fileId];return i.insertChild(t,_),t._prefab.root=i._prefab.root,n.emit("add",t),Editor.Message.broadcast("scene:add-node",t.uuid),n.emit("change",i),Editor.Message.broadcast("scene:change-node",i.uuid),!0}(a),a.parent=null,this.emit("change",r),Editor.Message.broadcast("scene:change-node",r.uuid)}catch(e){return console.warn("The prefab asset no longer exist."),console.error(e),!1}return window.requestAnimationFrame(()=>{a.forEach(e=>{cce.Selection.select(e)})}),!0}async createNodeFromAsset(e,t,n){if(!cc.director._scene)return null;let a=this.getNewNodeParent(e);try{const{name:o,type:r,position:s,unlinkPrefab:c}=n;let i,d,{canvasRequired:u}=n;if(r&&!creatableAssetTypes.includes(r))return null;switch(r){case"cc.AnimationClip":{cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.Animation);e&&(e.defaultClip=d)}break;case"cc.AudioClip":{cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.AudioSource);e&&(e.clip=d)}break;case"cc.BitmapFont":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.Label);e&&(e.font=d)}break;case"cc.LabelAtlas":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.Label);e.font=d,e.fontSize=d.fontSize;const n=d.fntConfig.commonHeight;e.lineHeight=n||e.lineHeight}break;case"cc.Mesh":{cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.MeshRenderer);e&&(e.mesh=d)}break;case"cc.ParticleAsset":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.ParticleSystem2D);e&&(e.file=d)}break;case"cc.Prefab":cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t),i=prefab_1.default.createNodeFromPrefabAsset(d);break;case"cc.Script":{const e=await scripts_1.default.queryScriptName(t)||"";(i=new cc_1.Node(e)).addComponent(e)}break;case"cc.SpriteFrame":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e="9db8cd0b-cbe4-42e7-96a9-a239620c0a9d";cc_1.assetManager.assets.remove(e);const n=await promisify(cc_1.assetManager.loadAny)(e);n.name=d.name;const a=(i=cc.instantiate(n)).getComponent("cc.Sprite");if(a){a.spriteFrame=d;const e=await Editor.Message.request("asset-db","query-asset-meta",t);e&&"none"===e.userData.trimType&&(a.trim=!1,a.sizeMode=cc_1.Sprite.SizeMode.RAW)}}break;case"cc.TTFFont":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.Label);e&&(e.font=d)}break;case"cc.TerrainAsset":{cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.Terrain);e&&(e._asset=d)}break;case"cc.TiledMapAsset":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.TiledMap);e&&(e.tmxAsset=d)}break;case"cc.VideoClip":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.VideoPlayer);e&&(e.clip=d)}break;case"dragonBones.DragonBonesAsset":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAsset=d)}break;case"dragonBones.DragonBonesAtlasAsset":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.dragonBones.ArmatureDisplay);e&&(e.dragonAtlasAsset=d)}break;case"sp.SkeletonData":{u=!0,cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t);const e=(i=new cc_1.Node(d.name)).addComponent(cc_1.sp.Skeleton);e&&(e.skeletonData=d)}break;default:cc_1.assetManager.assets.remove(t),d=await promisify(cc_1.assetManager.loadAny)(t),i=cc.instantiate(d)}if(u){let e=utils_1.getUIParentNode(a);if(!e){const t="f773db21-62b8-4540-956a-29bacf5ddbf5";cc_1.assetManager.assets.remove(t);const n=await promisify(cc_1.assetManager.loadAny)(t);e=cc.instantiate(n),prefab_1.default.removePrefabInfoFromNode(e),a.addChild(e)}a=e,s&&(s.z=e.position.z)}return o&&(i.name=basename(o,extname(o))),this.emit("before-add",i),Editor.Message.broadcast("scene:before-add-node",i.uuid),this.emit("before-change",a),Editor.Message.broadcast("scene:before-change-node",e),("cc.Prefab"!==r||c)&&prefab_1.default.removePrefabInfoFromNode(i),a.addChild(i),s&&i.setWorldPosition(s),this.emit("change",a,{type:event_enum_1.NodeEventType.CHILD_CHANGED}),Editor.Message.broadcast("scene:change-node",e),cce.Selection.clear(),cce.Selection.select(i.uuid),i.uuid}catch(e){return console.error(e),null}}removeNode(e,t=!0){Array.isArray(e)||(e=[e]),e=this.canRemoveOrCopy(e);for(const n of e){const e=this.query(n);if(!e)continue;const a=e.parent;this.emit("before-remove",e),Editor.Message.broadcast("scene:before-remove-node",e.uuid),this.emit("before-change",a),Editor.Message.broadcast("scene:before-change-node",a.uuid),e.setParent(null,t)}}changeNodeLock(e,t,n){Array.isArray(e)||(e=[e]);for(const a of e){const e=this.query(a);if(e){this.emit("before-change",e),Editor.Message.broadcast("scene:before-change-node",e.uuid);try{t?e._objFlags|=cc.Object.Flags.LockedInEditor:e._objFlags&=~cc.Object.Flags.LockedInEditor}catch(e){console.error(e)}this.emit("change",e),Editor.Message.broadcast("scene:change-node",e.uuid),!0===n&&e.children&&e.children.length>0&&e.children.forEach(e=>{this.changeNodeLock(e.uuid,t,n)})}}}queryComponentFunctionOfNode(e){const t=this.query(e);return t?get_component_function_of_node_1.default(t):{}}canRemoveOrCopy(e){const t=this,n=[],a=[];for(const n of e){const e=t.query(n);!e||!e.parent||e._objFlags&cc.Object.Flags.DontDestroy||a.push(n)}for(const e of a){o(t.query(e))||n.push(e)}function o(e){return!!e.parent&&(!!a.includes(e.parent.uuid)||o(e.parent))}return n}getNewNodeParent(e){let t;if(e)t=this.query(e);else{const e=cce.Selection.query();t=Array.isArray(e)&&e[0]?this.query(e[0]):cc.director._scene}return t}changeNodeUUID(e,t){e&&t&&NodeMgr.changeNodeUUID(e,t)}}exports.default=new NodeManager;