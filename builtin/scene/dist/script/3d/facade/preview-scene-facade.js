"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),gameview_scene_proxy_1=__importDefault(require("../manager/scene/proxy/gameview-scene-proxy")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),preview_play_1=__importDefault(require("../manager/preview-play")),cc_1=require("cc"),event_enum_1=require("../../public/event-enum"),operation_1=__importDefault(require("../../public/operation")),preview_1=__importDefault(require("../manager/history/preview")),stopPropagation=()=>{},preventDefault=()=>{},Events={[cc_1.Input.EventType.MOUSE_DOWN]:"_dispatchMouseDownEvent",[cc_1.Input.EventType.MOUSE_MOVE]:"_dispatchMouseMoveEvent",[cc_1.Input.EventType.MOUSE_UP]:"_dispatchMouseUpEvent",[cc_1.Input.EventType.MOUSE_WHEEL]:"_dispatchMouseScrollEvent",[cc_1.Input.EventType.KEY_DOWN]:"_dispatchKeyboardDownEvent",[cc_1.Input.EventType.KEY_UP]:"_dispatchKeyboardUpEvent"};class PreviewSceneFacade extends general_scene_facade_1.default{constructor(){super(...arguments),this._previewPlay=preview_play_1.default,this._isEnter=!1}init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Preview,this._sceneProxy=new gameview_scene_proxy_1.default(this._sceneMgr,this),this._undoMgr=preview_1.default,this.initEventListener(),this.redirectInput()}async enter(e){console.debug("enter gameview scene facade"),this.fireCloseEvent(),Editor.EditMode.enter(this.modeName.toLocaleLowerCase()),this._sceneProxy.sendModeChangeMsg(this.modeName);const t=e.sceneJson;await this.enterGameview(t),this._isEnter=!0}async exit(){console.debug("exit gameview scene facade"),await this._previewPlay.stop(),this._undoMgr.reset([],cc.director.getScene()),this._isEnter=!1}async enterGameview(e=""){await this._previewPlay.start(e)}async callPreviewPlayMethod(e,...t){return await this._previewPlay[e](...t)}redirectInput(){Object.keys(Events).forEach(e=>{this.registerOperation(e)})}registerOperation(e){const t=Events[e];e=e.replace("-",""),operation_1.default.on(e,e=>{if(this.isInputRedirected())return e.stopPropagation=stopPropagation,e.preventDefault=preventDefault,cc_1.input[t](e),!1},999)}isInputRedirected(){return this._isEnter&&!this._previewPlay.isPause()}dispatchEvents(e,...t){this._sceneEventListener.forEach(n=>{n&&n[e]&&n!==cce.Prefab&&n[e].apply(n,t)})}dispatchEventsOnly(e,...t){[cce.Gizmo].forEach(n=>{n&&n[e]&&n[e].apply(n,t)})}onSceneOpened(e){this.dispatchEvents("onSceneOpened",e),this.resetUndoData()}onNodeChanged(e,t){!1!==t.record&&this.recordNode(e),t&&t.type===event_enum_1.NodeOperationType.SET_PROPERTY?this.dispatchEvents("onNodeChanged",e,t):this.dispatchEventsOnly("onNodeChanged",e,t)}onAddNode(e){var t;e.getComponent(cc_1.Camera)&&(null===(t=e.getComponent(cc_1.Camera))||void 0===t||t.camera.changeTargetWindow(cc.director.root.mainWindow)),this.dispatchEvents("onAddNode",e),e.parent&&this.recordNode(e)}onRemoveNode(e){this.dispatchEvents("onRemoveNode",e),e.parent||this.recordNode(e)}onNodeAdded(e,t={}){this.dispatchEvents("onNodeAdded",e,t),e.parent&&this.recordNode(e)}onNodeRemoved(e,t){this.dispatchEvents("onNodeRemoved",e,t),Editor.Selection.unselect("node",e.uuid),e.parent||this.recordNode(e)}async saveScene(e){return!1}}exports.default=PreviewSceneFacade;