"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),animation_scene_proxy_1=__importDefault(require("../manager/scene/proxy/animation-scene-proxy")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),animation_1=__importDefault(require("../manager/history/animation")),node_1=__importDefault(require("../../utils/node")),cc_1=require("cc"),message_1=require("../manager/message");class AnimationSceneFacade extends general_scene_facade_1.default{init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Animation,this._sceneProxy=new animation_scene_proxy_1.default(this._sceneMgr),this._undoMgr=animation_1.default,this._animationMgr.on("scene:animation-change",(e,n,t)=>{"undo"!==t&&this._undoMgr.changed()}),this._animationMgr.on("scene:animation-clip-change",(e,n)=>{this._undoMgr.reset(e,n)}),this.initEventListener()}initEventListener(){super.initEventListener(),this._sceneEventListener.push(this._animationMgr)}async enter(e){this._sceneProxy.sendModeChangeMsg(this.modeName),console.debug("enter animation scene facade"),e.uuid&&await this.openScene(e.uuid),Editor.EditMode.enter(this.modeName.toLocaleLowerCase())}async exit(){console.debug("exit animation scene facade"),this._animationMgr.record("",!1)}async openScene(e){const n=this._sceneProxy.open(e);return this._animationMgr.record(e,!0),n}async closeScene(){return!0}queryCurrentAnimationState(){return this._animationMgr.queryPlayState()}queryCurrentAnimationInfo(){return this._animationMgr.getEditAnimationInfo()}queryAnimationRootNode(e){return this._animationMgr.queryAnimationRoot(e)}queryAnimationRootInfo(e){return this._animationMgr.queryAnimationRootInfo(e)}queryAnimationClip(e,n){return this._animationMgr.queryClip(e,n)}queryAnimationProperties(e){return this._animationMgr.queryProperties(e)}queryAnimationClipsInfo(e){return this._animationMgr.queryAnimClipsInfo(e)}queryAnimationClipCurrentTime(e){return this._animationMgr.queryPlayingClipTime(e)}queryAnimationPropValueAtFrame(e,n,t,i){return this._animationMgr.getPropValueAtFrame(e,n,t,i)}async recordAnimation(e,n){return await this._animationMgr.record(e,n)}async changeAnimationRootNode(e,n){return await this._animationMgr.changeAnimNode(e,n)}async setCurEditTime(e){return await this._animationMgr.setCurEditTime(e)}async changeClipState(e,n){return await this._animationMgr[e](n)}async setEditClip(e){return await this._animationMgr.setEditClip(e)}async saveClip(){return await this._animationMgr.save()}async applyAnimationOperation(e){return await this._animationMgr.operation(e)}async createNode(e){}async removeNode(e){}async setNodeProperty(e){var n;if("name"===e.path)return!1;const t=this._nodeMgr.query(e.uuid),{compName:i,propName:a}=node_1.default.getNameDataByPropPath(t,e.path);if(i===cc_1.js.getClassName(cc_1.Animation)||i===cc_1.js.getClassName(cc_1.SkeletalAnimation)){if("clips"===a)return message_1.messageManager.broadcast("scene:change-node",e.uuid),!1;if("defaultClip"===a){const t=this._nodeMgr.setProperty(e.uuid,e.path,e.dump);return this._animationMgr.setCurDefaultClipByUuid(null===(n=e.dump.value)||void 0===n?void 0:n.uuid),t}}return this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}isOperationOnAnimationClip(e,n){const t=this._nodeMgr.query(e),{compName:i,propName:a}=node_1.default.getNameDataByPropPath(t,n);return(i===cc_1.js.getClassName(cc_1.Animation)||i===cc_1.js.getClassName(cc_1.SkeletalAnimation))&&"clips"===a}async removeNodeArrayElement(e){return"__comps__"!==e.path&&(this.isOperationOnAnimationClip(e.uuid,e.path)?(message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.removeArrayElement(e.uuid,e.path,e.index))}onNodeChanged(e,n){this.dispatchEvents("onNodeChanged",e,n),this.recordNode(e)}async createComponent(e){}async removeComponent(e){}onComponentAdded(e){this.dispatchEvents("onComponentAdded",e)}selectNode(e){const n=this._nodeMgr.query(e);if(!n)return;let t=!1,i=n;for(;i;)i.uuid===this._sceneProxy.rootUuid&&(t=!0),i=i.parent;t&&this._selectionMgr.select(e)}}exports.default=AnimationSceneFacade;