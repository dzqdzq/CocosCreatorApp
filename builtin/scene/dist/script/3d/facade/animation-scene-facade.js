"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),animation_scene_proxy_1=__importDefault(require("../manager/scene/proxy/animation-scene-proxy")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),animation_1=require("../../export/undo/animation"),node_1=__importDefault(require("../../utils/node")),cc_1=require("cc"),message_1=require("../manager/message");class AnimationSceneFacade extends general_scene_facade_1.default{constructor(){super(...arguments),this._undoMgr=new animation_1.AnimationUndoManager}init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Animation,this._sceneProxy=new animation_scene_proxy_1.default(this._sceneMgr,this),this._animationMgr.on("scene:animation-clip-change",(e,t)=>{this._undoMgr.reset(e,t)}),this.initEventListener()}initEventListener(){super.initEventListener(),this._sceneEventListener.push(this._animationMgr)}async enter(e){console.debug("enter animation scene facade"),e.uuid&&await this.openScene(e.uuid,e.clipUuid),Editor.EditMode.enter(this.modeName.toLocaleLowerCase()),this._sceneProxy.sendModeChangeMsg(this.modeName)}async exit(){console.debug("exit animation scene facade"),await this.closeSceneState()}async openScene(e,t){const n=this._sceneProxy.open(e);return this._animationMgr.record(e,!0,t),n}async closeScene(){return!0}queryCurrentAnimationState(){return this._animationMgr.queryPlayState()}queryCurrentAnimationInfo(){return this._animationMgr.getEditAnimationInfo()}queryAnimationRootNode(e){return this._animationMgr.queryAnimationRoot(e)}queryAnimationRootInfo(e){return this._animationMgr.queryAnimationRootInfo(e)}queryAnimationClipDump(e,t){return this._animationMgr.queryAnimationClipDump(e,t)}queryAnimationProperties(e){return this._animationMgr.queryProperties(e)}queryAnimationClipsInfo(e){return this._animationMgr.queryAnimClipsInfo(e)}queryAnimationClipCurrentTime(e){return this._animationMgr.queryPlayingClipTime(e)}queryAnimationPropValueAtFrame(e,t,n,i){return this._animationMgr.getPropValueAtFrame(e,t,n,i)}queryAuxCurveValueAtFrame(e,t,n){return this._animationMgr.getAuxCurveValueAtFrame(e,t,n)}async recordAnimation(e,t,n){return await this._animationMgr.record(e,t,n)}async changeAnimationRootNode(e,t){return await this._animationMgr.changeAnimNode(e,t)}async setCurEditTime(e){return await this._animationMgr.setCurEditTime(e)}async changeClipState(e,t){return await this._animationMgr[e](t)}async setEditClip(e){return await this._animationMgr.setEditClip(e)}async saveClip(){return await this._animationMgr.save()}async applyAnimationOperation(e){return await this._animationMgr.operation(e)}queryAnimationNodeEditInfo(e){return this._animationMgr.queryAnimationNodeEditInfo(e)}async createNode(e){}async removeNode(e){}async setNodeProperty(e){var t;if("name"===e.path)return!1;const n=this._nodeMgr.query(e.uuid),{compName:i,propName:a}=node_1.default.getNameDataByPropPath(n,e.path);if(i===cc_1.js.getClassName(cc_1.Animation)||i===cc_1.js.getClassName(cc_1.SkeletalAnimation))if("clips"===a){const t=e.path.match(/clips.(.*)/);if(!t||!t[1]||isNaN(Number(t[1])))return Array.isArray(e.dump.value)&&e.dump.value.find(e=>e.value&&e.value.uuid===this._animationMgr.curEditClipUuid)?this._nodeMgr.setProperty(e.uuid,e.path,e.dump):(console.warn(Editor.I18n.t("scene.animation.delete_edit_clip_limit")),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1);{const n=t[1],i=this._animationMgr.queryRecordAniClips()[Number(n)];if(i&&i._uuid===this._animationMgr.curEditClipUuid)return console.warn(Editor.I18n.t("scene.animation.delete_edit_clip_limit")),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1}}else if("defaultClip"===a){const n=this._nodeMgr.setProperty(e.uuid,e.path,e.dump);return this._animationMgr.setCurDefaultClipByUuid(null===(t=e.dump.value)||void 0===t?void 0:t.uuid),n}return this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}isOperationOnAnimationClip(e,t){const n=this._nodeMgr.query(e),{compName:i,propName:a}=node_1.default.getNameDataByPropPath(n,t);return(i===cc_1.js.getClassName(cc_1.Animation)||i===cc_1.js.getClassName(cc_1.SkeletalAnimation))&&"clips"===a}async removeNodeArrayElement(e){return"__comps__"!==e.path&&(this.isOperationOnAnimationClip(e.uuid,e.path)?(message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.removeArrayElement(e.uuid,e.path,e.index))}onNodeChanged(e,t){this.dispatchEvents("onNodeChanged",e,t),this.recordNode(e)}async createComponent(e){}async removeComponent(e){}onComponentAdded(e){this.dispatchEvents("onComponentAdded",e)}selectNode(e){const t=this._nodeMgr.query(e);if(!t)return;let n=!1,i=t;for(;i;)i.uuid===this._sceneProxy.rootUuid&&(n=!0),i=i.parent;n&&this._selectionMgr.select(e)}queryCurrentSceneUuid(){var e;return(null===(e=this.fromState)||void 0===e?void 0:e.queryCurrentSceneUuid())||""}async previewMaterial(e,t){await this._assetMgr.previewMaterial(e,t,{emit:!1})}async saveScene(e){return await this._sceneProxy.save(e)}}exports.default=AnimationSceneFacade;