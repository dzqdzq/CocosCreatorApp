"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const scene_facade_state_interface_1=require("./scene-facade-state-interface"),scene_1=__importDefault(require("../manager/scene")),camera_1=__importDefault(require("../manager/camera")),node_1=__importDefault(require("../manager/node")),component_1=__importDefault(require("../manager/component")),asset_1=__importDefault(require("../manager/asset")),gizmos_1=__importDefault(require("../manager/gizmos")),material_preview_1=__importDefault(require("../manager/material-preview")),mini_preview_1=__importDefault(require("../manager/mini-preview")),animation_1=__importDefault(require("../manager/animation")),scripts_1=__importDefault(require("../manager/scripts")),preview_1=__importDefault(require("../manager/preview")),selection_1=__importDefault(require("../manager/selection")),effects_1=__importDefault(require("../manager/effects")),terrain_1=__importDefault(require("../manager/terrain")),general_scene_proxy_1=__importDefault(require("../manager/scene/proxy/general-scene-proxy")),prefab_1=__importDefault(require("../manager/prefab")),scene_2=__importDefault(require("../manager/history/scene")),cc_1=require("cc"),engine_1=require("../manager/engine"),plugin_1=__importDefault(require("../manager/plugin")),gameview_1=__importDefault(require("../manager/gameview")),ui_1=__importDefault(require("../manager/ui")),particle_1=__importDefault(require("../manager/particle")),model_preview_1=__importDefault(require("../manager/model-preview")),mesh_preview_1=__importDefault(require("../manager/mesh-preview")),physics_2d_1=__importDefault(require("../manager/physics-2d")),particle_2d_1=__importDefault(require("../manager/particle-2d")),message_1=require("../manager/message"),scene_view_1=require("../manager/scene-view"),time_1=__importDefault(require("../manager/engine/time")),doNotSupportFunc="don't support this function in current mode";class GeneralSceneFacade{constructor(){this._sceneMgr=scene_1.default,this._cameraMgr=camera_1.default,this._nodeMgr=node_1.default,this._compMgr=component_1.default,this._assetMgr=asset_1.default,this._gizmoMgr=gizmos_1.default,this._materialPreviewMgr=material_preview_1.default,this._miniPreviewMgr=mini_preview_1.default,this._scriptMgr=scripts_1.default,this._previewMgr=preview_1.default,this._animationMgr=animation_1.default,this._selectionMgr=selection_1.default,this._effectMgr=effects_1.default,this._terrainMgr=terrain_1.default,this._prefabMgr=prefab_1.default,this._undoMgr=scene_2.default,this._engineMgr=engine_1.engineManager,this._pluginMgr=plugin_1.default,this._gameViewMgr=gameview_1.default,this._uiMgr=ui_1.default,this._particleMgr=particle_1.default,this._modelPreviewMgr=model_preview_1.default,this._meshPreviewMgr=mesh_preview_1.default,this._physics2DMgr=physics_2d_1.default,this._particle2DMgr=particle_2d_1.default,this.isHold=!1,this.modeName=scene_facade_state_interface_1.SceneModeType.General,this._sceneEventListener=[]}init(){this.modeName=scene_facade_state_interface_1.SceneModeType.General,this._sceneProxy=new general_scene_proxy_1.default(this._sceneMgr),this.initEventListener()}initEventListener(){this._sceneEventListener.push(this._nodeMgr),this._sceneEventListener.push(this._gizmoMgr),this._sceneEventListener.push(this._cameraMgr),this._sceneEventListener.push(this._prefabMgr),this._sceneEventListener.push(this._miniPreviewMgr),this._sceneEventListener.push(this._previewMgr),this._sceneEventListener.push(this._undoMgr),this._sceneEventListener.push(this._engineMgr),this._sceneEventListener.push(this._pluginMgr),this._sceneEventListener.push(this._assetMgr),this._sceneEventListener.push(scene_view_1.sceneViewManager)}async enter(e){console.debug("enter general scene facade"),this._sceneProxy.sendModeChangeMsg(this.modeName),void 0!==e.uuid&&null!==e.uuid&&await this.openScene(e.uuid),this.fromState&&this.fromState.patchSceneState(),Editor.EditMode.enter(this.modeName.toLocaleLowerCase())}resetUndoData(){window.requestAnimationFrame(()=>{this.querySceneDirty()||this._undoMgr.abort()}),this._undoMgr.reset(this._nodeMgr.queryUuids(),cc_1.director.getScene())}async exit(){this._sceneProxy.storeScenePrefabUUID(),console.debug("exit general scene facade")}async closeSceneState(){return await this._sceneProxy.close()}async stagingSceneState(){return this._stagingCameraInfo=this._cameraMgr.getCurCameraInfo(),await this._sceneProxy.staging()}fireCloseEvent(){this._sceneMgr.emit("close",cc.director._scene),message_1.messageManager.broadcast("scene:close"),cce.Ipc.send("scene:close")}async openScene(e){var t,r,i,n;console.time("general-scene-open");let a=!1;if(this.isHold&&e===this.queryCurrentSceneUuid()){await this._sceneProxy.restore();"prefab"===(null===(t=this.fromState)||void 0===t?void 0:t.modeName)&&this._stagingCameraInfo&&this._cameraMgr.focus(null,null===(r=this._stagingCameraInfo)||void 0===r?void 0:r.position,null===(i=this._stagingCameraInfo)||void 0===i?void 0:i.rotation,null===(n=this._stagingCameraInfo)||void 0===n?void 0:n.viewCenter,!0),this.isHold=!1,a=!0}else if(a=await this._sceneProxy.open(e)){this._stagingCameraInfo=null;const t=await Editor.Profile.getConfig("scene",`camera-infos.${e}`);this._cameraMgr.focus(null,null===t||void 0===t?void 0:t.position,null===t||void 0===t?void 0:t.rotation,null===t||void 0===t?void 0:t.viewCenter)}return console.timeEnd("general-scene-open"),a}async closeScene(){const e=await this._sceneProxy.close();return this._sceneProxy.sendModeChangeMsg(""),e}async saveScene(e){return await this._sceneProxy.save(e)}dumpSceneState(){return this._sceneProxy.serialize()}async patchSceneState(){return await this._sceneProxy.patch()}async restoreSceneState(e){return await this._sceneProxy.restore(e)}async softReloadScene(e){return await this._sceneProxy.softReload(e)}async reloadScene(){return await this._sceneProxy.reload()}async queryNodeTree(e){return await this._sceneMgr.queryNodeTree(e)}async queryNodesByAssetUuid(e){return await this._sceneMgr.queryNodesByAssetUuid(e)}async querySceneSerializedData(){return await this._sceneProxy.serialize()}async querySceneDirty(){return await this._sceneProxy.queryDirty()}async queryComponents(){return await this._sceneMgr.queryComponents()}async queryComponentHasScript(e){return await this._sceneMgr.queryComponentHasScript(e)}async queryLayerBuiltin(){return await this._sceneMgr.queryLayerBuiltin()}queryMode(){return this.modeName}queryCurrentSceneUuid(){return this._sceneProxy.queryCurrentSceneUuid()}dispatchEvents(e,...t){this._sceneEventListener.forEach(r=>{r&&r[e]&&r[e].apply(r,t)})}onSceneOpened(e){this.dispatchEvents("onSceneOpened",e),this.resetUndoData()}onSceneReload(e){this.dispatchEvents("onSceneReload",e)}onSceneClosed(e){this.dispatchEvents("onSceneClosed",e)}onResize(e){this.dispatchEvents("onResize",e)}async queryNodeDump(e){return await this._nodeMgr.queryDump(e)}async queryComponentFunctionOfNode(e){return await this._nodeMgr.queryComponentFunctionOfNode(e)}async setNodeProperty(e){return await this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}async resetNode(e){return await this._nodeMgr.resetNode(e)}async resetNodeProperty(e){return await this._nodeMgr.resetProperty(e.uuid,e.path)}async setNodeAndChildrenLayer(e){return await this._nodeMgr.setNodeAndChildrenLayer(e.uuid,e.dump)}async moveNodeArrayElement(e){return!("children"===e.path&&!this._prefabMgr.canModifySibling(e.uuid,e.target,e.offset))&&this._nodeMgr.moveArrayElement(e.uuid,e.path,e.target,e.offset)}async removeNodeArrayElement(e){return this._nodeMgr.removeArrayElement(e.uuid,e.path,e.index)}async generateNodeAvailableName(e,t){return this._nodeMgr.generateAvailableName(e,t)}copyNode(e){return this._nodeMgr.copyNode(e)}duplicateNode(e){return this._nodeMgr.duplicateNode(e)}async pasteNode(e){let t=e.target;const r=await this.queryNodeDump(e.target);return r&&r.parent&&(t=r.parent.value.uuid),this._nodeMgr.pasteNode(t,e.uuids,e.keepWorldTransform)}async setNodeParent(e){const t=this._prefabMgr.filterChildOfPrefabAssetWhenSetParent(e.uuids);return!t||t.length<=0?t:this._nodeMgr.setParent(e.parent,t,e.keepWorldTransform)}async createNode(e){return(e=e||{}).assetUuid?await this._nodeMgr.createNodeFromAsset(e.parent,e.assetUuid,e):this._nodeMgr.createNode(e.parent,e.name||"",null,e.keepWorldTransform)}async removeNode(e){const t=this._prefabMgr.filterChildOfPrefabAssetWhenRemoveNode(e.uuid);this._nodeMgr.removeNode(t,e.keepWorldTransform)}async changeNodeLock(e,t,r){this._nodeMgr.changeNodeLock(e,t,r)}async restorePrefab(e,t){return await this._prefabMgr.revertPrefab(e)}onNodeChanged(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onNodeChanged",e,t),this._prefabMgr.onNodeChangedInGeneralMode(e,t,this._sceneProxy.getRootNode()),this.recordNode(e)}onAddNode(e){this.dispatchEvents("onAddNode",e),e.parent&&this.recordNode(e)}onRemoveNode(e){this.dispatchEvents("onRemoveNode",e),Editor.Selection.unselect("node",e.uuid),e.parent||this.recordNode(e)}onNodeAdded(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onNodeAdded",e,t),e.parent&&this.recordNode(e)}onNodeRemoved(e,t){t.modeName=this.modeName,this.dispatchEvents("onNodeRemoved",e,t),this._prefabMgr.checkToRemoveTargetOverride(e,this._sceneProxy.getRootNode()),e.parent||this.recordNode(e)}async queryComponent(e){return await this._compMgr.queryDump(e)}createComponent(e){this._nodeMgr.createComponent(e.uuid,e.component)}async resetComponent(e){this._nodeMgr.resetComponent(e)}async removeComponent(e){this._nodeMgr.removeComponent(e.uuid)}async executeComponentMethod(e){return await this._compMgr.executeComponentMethod(e.uuid,e.name,e.args)}async executeSceneScriptMethod(e){return await this._pluginMgr.executeSceneScript(e)}onAddComponent(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onAddComponent",e,t)}onRemoveComponent(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onRemoveComponent",e,t),this._prefabMgr.onRemoveComponentInGeneralMode(e,this._sceneProxy.getRootNode())}onComponentAdded(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onComponentAdded",e,t)}onComponentRemoved(e,t={}){t.modeName=this.modeName,this.dispatchEvents("onComponentRemoved",e),this._prefabMgr.onComponentRemovedInGeneralMode(e,this._sceneProxy.getRootNode())}async snapshot(e){this._undoMgr.snapshot(e)}async abortSnapshot(){this._undoMgr.abort()}async undo(){this._undoMgr.undo()}async redo(){this._undoMgr.redo()}recordNode(e,t=!0){t&&this._undoMgr.record(e)}async queryAllEffects(){return this._assetMgr.queryAllEffects()}async queryMaterial(e){return this._assetMgr.queryMaterial(e)}async queryEffect(e){return this._assetMgr.queryEffect(e)}async queryAllRenderPipelines(){return this._assetMgr.queryAllRenderPipelines()}async previewRenderPipeline(e,t){return this._assetMgr.previewRenderPipeline(e,t)}async queryRenderPipeline(e){return this._assetMgr.queryRenderPipeline(e)}async queryAllRenderFlows(){return this._assetMgr.queryAllRenderFlows()}async queryAllRenderStages(){return this._assetMgr.queryAllRenderStages()}async previewMaterial(e,t){await this._assetMgr.previewMaterial(e,t)}async applyMaterial(e,t){await this._assetMgr.applyMaterial(e,t)}async changePhysicsMaterial(e){return await this._assetMgr.changePhysicsMaterial(e)}async applyPhysicsMaterial(e){this._assetMgr.applyPhysicsMaterial(e)}async changeRenderStage(e){return await this._assetMgr.changeRenderStage(e)}async applyRenderStage(e){this._assetMgr.applyRenderStage(e)}async changeRenderFlow(e){return await this._assetMgr.changeRenderFlow(e)}async applyRenderFlow(e){this._assetMgr.applyRenderFlow(e)}async changeRenderTexture(e){return this._assetMgr.changeRenderTexture(e)}async applyRenderTexture(e,t){this._assetMgr.applyRenderTexture(e,t)}async selectRenderPipeline(e){return await this._assetMgr.selectRenderPipeline(e)}async changeRenderPipeline(e){return await this._assetMgr.changeRenderPipeline(e)}async applyRenderPipeline(e,t){await this._assetMgr.applyRenderPipeline(e,t)}async selectRenderFlow(e,t){await this._assetMgr.selectRenderFlow(e,t)}async selectRenderStage(e,t,r){return await this._assetMgr.selectRenderStage(e,t,r)}queryPhysicsMaterial(e){return this._assetMgr.queryPhysicsMaterial(e)}queryRenderStage(e){return this._assetMgr.queryRenderStage(e)}queryRenderFlow(e){return this._assetMgr.queryRenderFlow(e)}queryRenderTexture(e){return this._assetMgr.queryRenderTexture(e)}queryCreatableAssetTypes(){return this._nodeMgr.creatableAssetTypes}async assetChange(e,t,r){this.dispatchEvents("onAssetChanged",e,t,r)}assetDelete(e,t){this.dispatchEvents("onAssetDeleted",e,t)}assetRefresh(e){this._animationMgr.onAssetRefreshed(e)}async queryGizmoToolName(){return this._gizmoMgr.queryToolName()}async queryGizmoPivot(){return this._gizmoMgr.queryPivot()}async queryGizmoCoordinate(){return this._gizmoMgr.queryCoordinate()}async queryIs2D(){return this._gizmoMgr.queryIs2D()}queryIsIconGizmo3D(){return this._gizmoMgr.isIconGizmo3D()}queryIconGizmoSize(){return this._gizmoMgr.queryIconGizmoSize()}async setTransformToolName(e){await this._gizmoMgr.setTransformToolName(e)}async setPivot(e){await this._gizmoMgr.setPivot(e)}async setCoordinate(e){await this._gizmoMgr.setCoordinate(e)}async setIs2D(e){await this._gizmoMgr.setIs2D(e)}async setIconGizmo3D(e){await this._gizmoMgr.setIconGizmo3D(e)}async setIconGizmoSize(e){await this._gizmoMgr.setIconGizmoSize(e)}focus(e=null,t,r,i,n=!1){this._cameraMgr.focus(e,t,r,i,n)}alignNodeToSceneView(e){this._cameraMgr.alignNodeToSceneView(e)}queryIsGridVisible(){return this._cameraMgr.isGridVisible()}setGridVisible(e){this._cameraMgr.setGridVisible(e)}alignWithView(){const e=Editor.Selection.getSelected("node");e&&this._cameraMgr.alignNodeToSceneView(e)}alignViewWithNode(){const e=Editor.Selection.getSelected("node");e&&this._cameraMgr.alignSceneViewToNode(e)}setGridLineColor(e){this._cameraMgr.setGridLineColor(e)}getCameraProperty(){return this._cameraMgr.getCameraProperty()}setCameraProperty(e){this._cameraMgr.setCameraProperty(e)}getCameraWheelSpeed(){return this._cameraMgr.getWheelSpeed()}setCameraWheelSpeed(e){this._cameraMgr.setWheelSpeed(e)}getCameraWanderSpeed(){return this._cameraMgr.getWanderSpeed()}setCameraWanderSpeed(e){this._cameraMgr.setWanderSpeed(e)}zoomSceneViewUp(){this._cameraMgr.zoomUp()}zoomSceneViewDown(){this._cameraMgr.zoomDown()}resetSceneViewZoom(){this._cameraMgr.zoomReset()}queryCurrentAnimationState(){return console.log(doNotSupportFunc,"queryCurrentAnimationState"),null}queryCurrentAnimationInfo(){return this._animationMgr.getEditAnimationInfo()}queryAnimationRootNode(e){return this._animationMgr.queryAnimationRoot(e)}queryAnimationRootInfo(e){return this._animationMgr.queryAnimationRootInfo(e)}queryAnimationClip(e,t){return this._animationMgr.queryClip(e,t)}queryAnimationProperties(e){return this._animationMgr.queryProperties(e)}queryAnimationClipsInfo(e){return this._animationMgr.queryAnimClipsInfo(e)}queryAnimationClipCurrentTime(e){return this._animationMgr.queryPlayingClipTime(e)}queryAnimationPropValueAtFrame(e,t,r,i){return console.log(doNotSupportFunc,this.modeName,"queryAnimationPropValueAtFrame"),null}async recordAnimation(e,t){return this._animationMgr.curEditRootNodeUuid=e,!1}async changeAnimationRootNode(e,t){return await animation_1.default.changeAnimNode(e,t)}async setCurEditTime(e){return console.log(doNotSupportFunc,this.modeName,"setCurEditTime"),!1}async changeClipState(e,t){return console.log(doNotSupportFunc,this.modeName,"changeClipState"),!1}async setEditClip(e){return await animation_1.default.setEditClip(e)}async saveClip(){return console.log(doNotSupportFunc,this.modeName,"saveClip"),!1}async applyAnimationOperation(e){return console.log(doNotSupportFunc,this.modeName,"applyAnimationOperation"),!1}executeMiniPreviewMethod(e){this._miniPreviewMgr[e.name](e.args)}handleMiniPreviewSelect(e){this._miniPreviewMgr.handleSelect(e)}queryMiniPreviewWindowList(){return this._miniPreviewMgr.queryWindowList()}getMiniPreviewInfo(){return this._miniPreviewMgr.getPreviewInfo()}queryPreviewWindowList(){return this._previewMgr.queryWindowList()}async queryScriptName(e){return await this._scriptMgr.queryScriptName(e)}async loadScript(e){return this._scriptMgr.loadScript(e)}async removeScript(e){return this._scriptMgr.removeScript(e)}async scriptChange(e){return this._scriptMgr.scriptChange(e)}_selectNode(e){this._selectionMgr._select(e)}_unselectNode(e){this._selectionMgr._unselect(e)}querySelection(){return this._selectionMgr.query()}isSelectNode(e){return this._selectionMgr.isSelect(e)}selectNode(e){this._selectionMgr.select(e)}unselectNode(e){this._selectionMgr.unselect(e)}clearSelection(){this._selectionMgr.clear()}registerEffects(e){this._effectMgr.registerEffects(e)}removeEffects(e){this._effectMgr.removeEffects(e)}updateEffect(e){this._effectMgr.updateEffect(e)}onRemoveTerrain(e,t){this._terrainMgr.onRemoveTerrain(e,t)}createPrefab(e,t){return this._prefabMgr.createPrefabAssetFromNode(e,t)}getPrefabData(e){return this._prefabMgr.generatePrefabDataFromNode(e)}linkPrefab(e,t){return this._prefabMgr.linkNodeWithPrefabAsset(e,t)}unlinkPrefab(e,t){return this._prefabMgr.unWrapPrefabInstance(e,t)}applyPrefab(e){return this._prefabMgr.applyPrefab(e)}distributeSelectionUI(e){this._uiMgr.distributeSelection(e)}alignSelectionUI(e){this._uiMgr.alignSelection(e)}queryParticlePlayInfo(e){return this._particleMgr.queryPlayInfo(e)}setParticlePlaySpeed(e,t){this._particleMgr.setPlaySpeed(e,t)}changeGameMode(e){this._gameViewMgr.changeGameMode(e)}pauseGameView(e){this._gameViewMgr.pause(e)}stepGameView(){this._gameViewMgr.step()}platformGameView(e){this._gameViewMgr.platform(e)}async updatePhysicsGroup(){const e={};for(const t in cc.internal.PhysicsGroup){const r=cc.internal.PhysicsGroup[t];e[r]=t}const t={};(await Editor.Profile.getProject("project","physics.collisionGroups")||[]).forEach(r=>{const i=1<<r.index,n=e[i];n&&(delete cc.internal.PhysicsGroup[i],delete cc.internal.PhysicsGroup[n]),t[r.name]=i}),Object.assign(cc.internal.PhysicsGroup,t),cc.Enum.update(cc.internal.PhysicsGroup)}onEngineUpdate(){this._cameraMgr.onUpdate(time_1.default.deltaTime),this._gizmoMgr.onUpdate(time_1.default.deltaTime)}regeneratePolygon2DPoints(e){this._physics2DMgr.resetPointsByUuid(e)}async exportParticlePlist(e){return await this._particle2DMgr.exportParticlePlist(e)}}exports.default=GeneralSceneFacade;