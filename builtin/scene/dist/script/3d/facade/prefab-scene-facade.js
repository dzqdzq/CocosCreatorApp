"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),general_scene_facade_1=__importDefault(require("./general-scene-facade")),prefab_scene_proxy_1=__importDefault(require("../manager/scene/proxy/prefab-scene-proxy")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),message_1=require("../manager/message");class PrefabSceneFacade extends general_scene_facade_1.default{init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Prefab,this._sceneProxy=new prefab_scene_proxy_1.default(this._sceneMgr,this),this._undoMgr.init(),this.initEventListener()}async enter(e){console.debug("enter prefab scene facade"),this.clearSelection(),this.fireCloseEvent();const t=this._sceneProxy.queryCurrentSceneUuid();if(e.uuid&&await this.openScene(e.uuid),this.isHold&&(e.uuid&&t!==e.uuid||await this._sceneProxy.restore(),this.isHold=!1),this.fromState){this.snapshot(),await this.fromState.patchSceneState()?(this.snapshot(),cce.SceneFacadeManager.changeTitle()):this.abortSnapshot()}Editor.EditMode.enter(this.modeName.toLocaleLowerCase()),this._sceneProxy.sendModeChangeMsg(this.modeName)}async exit(){console.debug("exit prefab scene facade"),await this.closeSceneState()}async openScene(e){return await this._sceneProxy.open(e)}async setNodeProperty(e){const t=this._sceneProxy.getRootNode();return e.uuid===(null===t||void 0===t?void 0:t.uuid)&&"name"===e.path?(console.warn("can't change name of prefab root in prefab mode, you can modify it by changing the filename of this prefab"),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}async createNode(e){const t=this._sceneProxy.getRootNode(),a=null===t||void 0===t?void 0:t._prefab;return a&&a.asset&&a.asset._uuid===e.assetUuid?(console.warn("The prefab you are trying to add is the same with the prefab in editing, this is not allowed."),null):await super.createNode(e)}async pasteNode(e){var t,a;if(!e){const t=this.querySelection()[0],a=Editor.Clipboard.read("nodes-info");if(!a)return[];const{type:n,uuids:s}=a;if(e={target:t,uuids:s},"cut"===n){let e=!1;const a=[];if(s.every(n=>{if(t===n)return console.warn(Editor.I18n.t("scene.messages.cannot_cut_to_self")),e=!0,!1;const s=this._nodeMgr.query(n);(null===s||void 0===s?void 0:s.parent)&&!a.includes(s.parent.uuid)&&a.push(s.parent.uuid)}),e||!t)return[];a.push(t);const n=this.beginRecording(a),r=await this.setNodeParent({parent:t,uuids:s,keepWorldTransform:!1});return this.endRecording(n),Editor.Clipboard.clear(),r}}let n=e.target;if(!e.pasteAsChild){const s=await this.queryNodeDump(e.target);s&&s.parent&&(n=s.parent.value.uuid);const r=this._sceneProxy.getRootNode(),o=null===(t=null===r||void 0===r?void 0:r.parent)||void 0===t?void 0:t.uuid;n!==(null===(a=cc_1.director.getScene())||void 0===a?void 0:a.uuid)&&n!==o||(n=s.uuid.value)}const s=await this.beginRecording(n),r=this._nodeMgr.pasteNode(n,e.uuids,e.keepWorldTransform);return await this.endRecording(s),r}async removeNode(e){const t=this._sceneProxy.getRootNode();t&&e&&(t.uuid===e.uuid||e.uuid.includes(t.uuid))?console.warn("can't remove root node of prefabAsset"):await super.removeNode(e)}async createPrefab(e,t){const a=this._sceneProxy.getRootNode();if(!a||a.uuid!==e)return await this._prefabMgr.createPrefabAssetFromNode(e,t);console.warn("can't create prefabAsset from root node of prefabAsset")}doUnlinkPrefab(e,t){return this._prefabMgr.unWrapPrefabInstanceInPrefabMode(e,t)}async saveScene(e){return await this._sceneProxy.save(e)}}exports.default=PrefabSceneFacade;