"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),prefab_scene_proxy_1=__importDefault(require("../manager/scene/proxy/prefab-scene-proxy")),prefab_1=__importDefault(require("../manager/history/prefab")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),message_1=require("../manager/message");class PrefabSceneFacade extends general_scene_facade_1.default{init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Prefab,this._sceneProxy=new prefab_scene_proxy_1.default(this._sceneMgr),this._undoMgr=prefab_1.default,this.initEventListener()}async enter(e){console.debug("enter prefab scene facade"),this._sceneProxy.sendModeChangeMsg(this.modeName),e.uuid&&await this.openScene(e.uuid),this.isHold&&(await this._sceneProxy.restore(),this.isHold=!1),this.fromState&&this.fromState.patchSceneState(),Editor.EditMode.enter(this.modeName.toLocaleLowerCase())}async exit(){console.debug("exit prefab scene facade")}async openScene(e){const a=await this._sceneProxy.open(e),t=await Editor.Profile.getConfig("scene",`camera-infos.${e}`);return this._cameraMgr.focus(null,null===t||void 0===t?void 0:t.position,null===t||void 0===t?void 0:t.rotation,null===t||void 0===t?void 0:t.viewCenter),a}async setNodeProperty(e){const a=this._sceneProxy.getRootNode();return e.uuid===(null===a||void 0===a?void 0:a.uuid)&&"name"===e.path?(console.warn("can't change name of prefab root in prefab mode, you can modify it by changing the filename of this prefab"),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}async createNode(e){const a=this._sceneProxy.getRootNode(),t=null===a||void 0===a?void 0:a._prefab;return t&&t.asset&&t.asset._uuid===e.assetUuid?(console.warn("The prefab you are trying to add is the same with the prefab in editing, this is not allowed."),null):super.createNode(e)}async pasteNode(e){let a=e.target;const t=await this.queryNodeDump(e.target);return t&&t.parent&&(a=t.parent.value.uuid),a===cc.director._scene.uuid&&(a=t.uuid.value),this._nodeMgr.pasteNode(a,e.uuids,e.keepWorldTransform)}unlinkPrefab(e,a){return this._prefabMgr.unWrapPrefabInstanceInPrefabMode(e,a)}}exports.default=PrefabSceneFacade;