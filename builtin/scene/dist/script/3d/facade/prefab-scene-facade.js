"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),prefab_scene_proxy_1=__importDefault(require("../manager/scene/proxy/prefab-scene-proxy")),prefab_1=__importDefault(require("../manager/history/prefab")),scene_facade_state_interface_1=require("./scene-facade-state-interface"),message_1=require("../manager/message");class PrefabSceneFacade extends general_scene_facade_1.default{init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Prefab,this._sceneProxy=new prefab_scene_proxy_1.default(this._sceneMgr,this),this._undoMgr=prefab_1.default,this.initEventListener()}async enter(e){console.debug("enter prefab scene facade"),this.fireCloseEvent(),this._sceneProxy.sendModeChangeMsg(this.modeName),e.uuid&&await this.openScene(e.uuid),this.isHold&&(await this._sceneProxy.restore(),this.isHold=!1),this.fromState&&this.fromState.patchSceneState(),Editor.EditMode.enter(this.modeName.toLocaleLowerCase())}async exit(){console.debug("exit prefab scene facade"),await this.closeSceneState()}async openScene(e){const t=await this._sceneProxy.open(e),a=await Editor.Profile.getConfig("scene",`camera-infos.${e}`);return this._cameraMgr.focus(null,null===a||void 0===a?void 0:a.position,null===a||void 0===a?void 0:a.rotation,null===a||void 0===a?void 0:a.viewCenter),t}async setNodeProperty(e){const t=this._sceneProxy.getRootNode();return e.uuid===(null===t||void 0===t?void 0:t.uuid)&&"name"===e.path?(console.warn("can't change name of prefab root in prefab mode, you can modify it by changing the filename of this prefab"),message_1.messageManager.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}async createNode(e){const t=this._sceneProxy.getRootNode(),a=null===t||void 0===t?void 0:t._prefab;return a&&a.asset&&a.asset._uuid===e.assetUuid?(console.warn("The prefab you are trying to add is the same with the prefab in editing, this is not allowed."),null):super.createNode(e)}async pasteNode(e){var t;let a=e.target;const r=await this.queryNodeDump(e.target);r&&r.parent&&(a=r.parent.value.uuid);const o=this._sceneProxy.getRootNode(),s=null===(t=null===o||void 0===o?void 0:o.parent)||void 0===t?void 0:t.uuid;return a!==cc.director._scene.uuid&&a!==s||(a=r.uuid.value),this._nodeMgr.pasteNode(a,e.uuids,e.keepWorldTransform)}async removeNode(e){const t=this._sceneProxy.getRootNode();!t||t.uuid!==e.uuid&&!e.uuid.includes(t.uuid)?super.removeNode(e):console.warn("can't remove root node of prefabAsset")}createPrefab(e,t){const a=this._sceneProxy.getRootNode();if(!a||a.uuid!==e)return this._prefabMgr.createPrefabAssetFromNode(e,t);console.warn("can't create prefabAsset from root node of prefabAsset")}unlinkPrefab(e,t){return this._prefabMgr.unWrapPrefabInstanceInPrefabMode(e,t)}async querySceneDirty(){return this._undoMgr.isDirty()}async saveScene(e){return await this._sceneProxy.save(e)}}exports.default=PrefabSceneFacade;