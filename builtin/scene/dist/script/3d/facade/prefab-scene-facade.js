"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const general_scene_facade_1=__importDefault(require("./general-scene-facade")),prefab_scene_proxy_1=__importDefault(require("../manager/scene/proxy/prefab-scene-proxy")),prefab_1=__importDefault(require("../manager/history/prefab")),scene_facade_state_interface_1=require("./scene-facade-state-interface");class PrefabSceneFacade extends general_scene_facade_1.default{init(){this.modeName=scene_facade_state_interface_1.SceneModeType.Prefab,this._sceneProxy=new prefab_scene_proxy_1.default(this._sceneMgr),this._undoMgr=prefab_1.default,this.initEventListener()}async enter(e){console.log("enter prefab scene facade"),this._sceneProxy.sendModeChangeMsg(this.modeName),e.uuid&&await this.openScene(e.uuid),this.isHold&&(await this._sceneProxy.restore(),this.isHold=!1),this.fromState&&this.fromState.patchSceneState(),Editor.EditMode.enter(this.modeName.toLocaleLowerCase())}async exit(){console.log("exit prefab scene facade")}async openScene(e){const t=await this._sceneProxy.open(e),a=await Editor.Profile.getConfig("scene",`camera-infos.${e}`);return this._cameraMgr.focus(null,null===a||void 0===a?void 0:a.position,null===a||void 0===a?void 0:a.rotation,null===a||void 0===a?void 0:a.viewCenter),t}async setNodeProperty(e){const t=this._sceneProxy.getRootNode();return e.uuid===(null===t||void 0===t?void 0:t.uuid)&&"name"===e.path?(console.warn("can't change name of prefab root in prefab mode, you can modify it by changing the filename of this prefab"),Editor.Message.broadcast("scene:change-node",e.uuid),!1):this._nodeMgr.setProperty(e.uuid,e.path,e.dump)}async createNode(e){const t=this._sceneProxy.getRootNode(),a=null===t||void 0===t?void 0:t._prefab;if(!a||!a.asset||a.asset._uuid!==e.assetUuid)return super.createNode(e);console.warn("The prefab you are trying to add is the same with the prefab in editing, this is not allowed.")}async pasteNode(e){let t=e.target;const a=await this.queryNodeDump(e.target);return a&&a.parent&&(t=a.parent.value.uuid),t===cc.director._scene.uuid&&(t=a.uuid),this._nodeMgr.pasteNode(t,e.uuids,e.keepWorldTransform)}onNodeAdded(e,t){this.dispatchEvents("onNodeAdded",e,t),this._prefabMgr.onNodeAddInPrefabMode(e),e.parent&&this.recordNode(e)}onComponentAdded(e){this.dispatchEvents("onComponentAdded",e),this._prefabMgr.onComponentAddedInPrefabMode(e)}unlinkPrefab(e,t){return this._prefabMgr.unWrapPrefabInstanceInPrefabMode(e,t)}}exports.default=PrefabSceneFacade;