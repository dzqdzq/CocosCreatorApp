"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneFacadeFSM=exports.createSceneFacadeFSM=void 0;const scene_facade_state_interface_1=require("./scene-facade-state-interface"),general_scene_facade_1=__importDefault(require("./general-scene-facade")),animation_scene_facade_1=__importDefault(require("./animation-scene-facade")),prefab_scene_facade_1=__importDefault(require("./prefab-scene-facade")),preview_scene_facade_1=__importDefault(require("./preview-scene-facade")),finite_state_machine_1=__importDefault(require("../utils/state-machine/finite-state-machine")),scene_facade_state_transition_1=require("./scene-facade-state-transition"),generalFacade=new general_scene_facade_1.default,animationFacade=new animation_scene_facade_1.default,prefabFacade=new prefab_scene_facade_1.default,previewFacade=new preview_scene_facade_1.default,sceneFacades=[generalFacade,animationFacade,prefabFacade,previewFacade];let init=!1;class SceneFacadeFSM extends finite_state_machine_1.default{constructor(){super(...arguments),this.generalSceneFacade=generalFacade,this.animationSceneFacade=animationFacade,this.prefabSceneFacade=prefabFacade,this.previewSceneFacade=previewFacade}start(){this.Begin(generalFacade),generalFacade._sceneProxy.sendModeChangeMsg(generalFacade.modeName.toLocaleLowerCase()),Editor.EditMode.enter(generalFacade.modeName.toLocaleLowerCase())}async toGeneral(e={}){e.uuid||(e.uuid=this.generalSceneFacade.queryCurrentSceneUuid()),Editor.Metrics.trackTimeStart("[Metrics]Enter Mode:toGeneral");const a=await this.issueCommand("toGeneral",e);return Editor.Metrics.trackTimeEnd("[Metrics]Enter Mode:toGeneral",{output:!0}),a}async toAnimation(e={}){Editor.Metrics.trackTimeStart("[Metrics]Enter Mode:toAnimation");const a=await this.issueCommand("toAnimation",e);return Editor.Metrics.trackTimeEnd("[Metrics]Enter Mode:toAnimation",{output:!0}),a}async toPrefab(e={}){Editor.Metrics.trackTimeStart("[Metrics]Enter Mode:toPrefab");const a=await this.issueCommand("toPrefab",e);return Editor.Metrics.trackTimeEnd("[Metrics]Enter Mode:toPrefab",{output:!0}),a}async toPreview(e={}){return await this.issueCommand("toPreview",e)}dumpAllScenes(){return sceneFacades.map(e=>e.dumpSceneState())}restoreAllScenes(e){sceneFacades.forEach((a,n)=>{a.restoreSceneState(e[n])})}async closeScene(){const e=this.currentState;let a=!1;try{if(e.modeName===scene_facade_state_interface_1.SceneModeType.Animation){const n=e.fromState;(null===n||void 0===n?void 0:n.modeName)===scene_facade_state_interface_1.SceneModeType.General?a=await this.toGeneral():n.modeName===scene_facade_state_interface_1.SceneModeType.Prefab&&(a=await this.toPrefab())}else e.modeName===scene_facade_state_interface_1.SceneModeType.Prefab||e.modeName===scene_facade_state_interface_1.SceneModeType.Preview?a=await this.toGeneral():(console.warn("Trying to close current edit scene in general edit mode is not allowed"),a=!1)}catch(e){console.error("close scene Failed",e)}return a}async closeSceneToGeneral(){for(;this.currentState.modeName!==scene_facade_state_interface_1.SceneModeType.General;)if(!await this.closeScene())return!1}}function createSceneFacadeFSM(){init||(generalFacade.init(),animationFacade.init(),prefabFacade.init(),previewFacade.init(),init=!0);const e=new SceneFacadeFSM(sceneFacades);return e.addTransition(generalFacade,animationFacade,"toAnimation",new scene_facade_state_transition_1.ToAnimationTransition(generalFacade,animationFacade)).addTransition(generalFacade,prefabFacade,"toPrefab",new scene_facade_state_transition_1.ToPrefabTransition(generalFacade,prefabFacade)).addTransition(generalFacade,previewFacade,"toPreview",new scene_facade_state_transition_1.ToPreviewTransition(generalFacade,previewFacade)),e.addTransition(animationFacade,generalFacade,"toGeneral",new scene_facade_state_transition_1.ToGeneralTransition(animationFacade,generalFacade)).addTransition(animationFacade,prefabFacade,"toPrefab",new scene_facade_state_transition_1.ToPrefabTransition(animationFacade,prefabFacade)).addTransition(animationFacade,previewFacade,"toPreview",new scene_facade_state_transition_1.ToPreviewTransition(animationFacade,previewFacade)),e.addTransition(prefabFacade,generalFacade,"toGeneral",new scene_facade_state_transition_1.ToGeneralTransition(prefabFacade,generalFacade)).addTransition(prefabFacade,animationFacade,"toAnimation",new scene_facade_state_transition_1.ToAnimationTransition(prefabFacade,animationFacade)).addTransition(prefabFacade,previewFacade,"toPreview",new scene_facade_state_transition_1.ToPreviewTransition(prefabFacade,previewFacade)),e.addTransition(previewFacade,generalFacade,"toGeneral",new scene_facade_state_transition_1.ToGeneralTransition(previewFacade,generalFacade)).addTransition(previewFacade,prefabFacade,"toPrefab",new scene_facade_state_transition_1.ToPrefabTransition(previewFacade,prefabFacade)).addTransition(previewFacade,animationFacade,"toAnimation",new scene_facade_state_transition_1.ToAnimationTransition(previewFacade,animationFacade)),e}exports.SceneFacadeFSM=SceneFacadeFSM,exports.createSceneFacadeFSM=createSceneFacadeFSM;