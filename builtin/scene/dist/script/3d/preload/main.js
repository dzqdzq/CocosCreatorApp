"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.preload=void 0,require("@editor/creator");const log_1=__importDefault(require("../manager/startup/log"));function check(){require("@base/electron-base-ipc").sendSync("scene:check-ipc")?startup():setTimeout(()=>{window.location.reload()},1e3)}async function initPreview(){try{await cce.Ipc.startup(),await cce.Startup.requireEngine(),log_1.default.setLevel(4),console.info(Editor.I18n.t("scene.game_view.ready")),cce.Ipc.send("preview-ready")}catch(e){console.error(Editor.I18n.t("scene.game_view.failed")+":"+e),cce.Ipc.send("preview-failed")}}async function startup(){const{join:e}=require("path");await require("editor/preload").init(),window.Editor=require("editor"),Editor.Metrics.trackTimeStart("scene:scene-view-startup");const r=require("../manager/startup").default,i=require("../manager/ipc/index").default;if(window.cce={Startup:r,Ipc:i},isSceneNative){const e=require("./native/native-scene").default;cce.NativeScene=e}if(window.AppModulePath=e(Editor.App.path,"node_modules"),isPreviewProcess){const e=require("./editor-preview").default;cce.EditorPreview=e,log_1.default.changePrefix("PreviewInEditor"),log_1.default.setLevel(2),initPreview()}else i.send("ready");Editor.Message.send("process","register-process-info",process.pid,"webview:scene-web")}function preload(e){window.isSceneNative=e.isSceneNative,window.isPreviewProcess=e.isPreviewProcess,check();let r=0;window.addEventListener("beforeunload",async e=>{if(isSceneNative&&cce.NativeScene.sendToBrowser("onEngineClose",isPreviewProcess),isPreviewProcess)return void cce.Ipc.send("preview-close");const i=require("../manager/ipc/index").default;if(1!==r)return cce.Scene&&2!==r?(i.send("immediately-dump",cce.SceneFacadeManager.dumpAllScenes()),r=1,e.returnValue=!0,void(await cce.SceneFacadeManager.beforeClose()?(r=2,window.location.reload()):r=0)):void i.send("close");e.returnValue=!0}),require("electron").ipcRenderer.send("fire-web-contents")}exports.preload=preload;