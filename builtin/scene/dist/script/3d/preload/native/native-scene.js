"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var i=function(e){return(i=Object.getOwnPropertyNames||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[n.length]=t);return n})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=i(e),r=0;r<n.length;r++)"default"!==n[r]&&__createBinding(t,e,n[r]);return __setModuleDefault(t,e),t}}();Object.defineProperty(exports,"__esModule",{value:!0});const ipc=__importStar(require("@base/electron-base-ipc")),Events={"mouse-down":"_dispatchMouseDownEvent","mouse-move":"_dispatchMouseMoveEvent","mouse-up":"_dispatchMouseUpEvent","mouse-wheel":"_dispatchMouseScrollEvent",keydown:"_dispatchKeyboardDownEvent",keyup:"_dispatchKeyboardUpEvent"},isPreview=isPreviewProcess,ReceiveChannel=isPreview?"native-from-browser-preview":"native-from-browser",SendChannel=isPreview?"native-from-scene-preview":"native-from-scene",isWin32="win32"===process.platform,minLength=isWin32?10:30;let ccInput=null;class NativeScene{windowMap=new Map;intervalHandle=null;redrawTimes=0;constructor(){ipc.registerChannel(ReceiveChannel),ipc.on("native-scene",(async(e,t)=>{var{message:t,params:n}=t;this[t]?(n=await this[t].call(this,...n),e.reply(null,n)):console.warn(`browserToScene ${t} not exist`)}).bind(this))}createWindow(e,t,n){n=Buffer.from(n,"base64");let r=this.windowMap.get(t);return r||(e.width<=0&&(e.width=minLength),e.height<=0&&(e.height=minLength),r=new NativeWindow(e.width,e.height,n),this.windowMap.set(t,r),this.resize(e.x,e.y,e.width,e.height,t)),{handler:r.handler,isPreviewProcess:isPreview}}close(e){this.setVisible(e,!1),this.redirectTargetWindow(e,!0)}async resize(e,t,n,r,i){i=this.windowMap.get(i);if(i)return e&&t&&(i.x=e,i.y=t,i.setPos(e,t)),n&&r&&(i.width=n,i.height=r,i.setSize(n,r)),i.updateContextID?.(),await this.redraw(),i.handler}redirectTargetWindow(e,t=!1){var n=this.windowMap.get(e);let r=0;if(n){n.renderWindow.clearCameras();var i,e=cc.director.getScene().renderScene?.cameras??[],s=cc.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);for(const a of e)a.node.layer&s||(i=t?cc.director.root.tempWindow:n.renderWindow,a.changeTargetWindow(i),a.update(!0),r++)}return r}async handleInput(e,t){var n,e=Events[e];e&&(ccInput||(n=(await Promise.resolve().then(()=>__importStar(require("cc"))))["input"],ccInput=n),ccInput)&&(t.windowId=2,ccInput[e]?.(t))}async setVisible(e,t){e=this.windowMap.get(e);if(e&&(t?(e.setPos(e.x,e.y),e.setSize(e.width,e.height)):(e.setPos(10,10),e.setSize(minLength,minLength)),await this.redraw(),!isWin32))return e.updateContextID?.(),e.handler}async redraw(){return new Promise(e=>{cce.Engine?.repaintInEditMode(),cc.director&&cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{e(!0)})})}sendToBrowser(e,...t){ipc.send(SendChannel,e,...t)}}exports.default=new NativeScene;