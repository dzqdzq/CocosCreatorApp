"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&("get"in r?t.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const ipc=__importStar(require("@base/electron-base-ipc")),Events={"mouse-down":"_dispatchMouseDownEvent","mouse-move":"_dispatchMouseMoveEvent","mouse-up":"_dispatchMouseUpEvent","mouse-wheel":"_dispatchMouseScrollEvent",keydown:"_dispatchKeyboardDownEvent",keyup:"_dispatchKeyboardUpEvent"},isPreview=isPreviewProcess,ReceiveChannel=isPreview?"native-from-browser-preview":"native-from-browser",SendChannel=isPreview?"native-from-scene-preview":"native-from-scene",isWin32="win32"===process.platform,minLength=isWin32?10:30;let ccInput=null;class NativeScene{constructor(){this.windowMap=new Map,this.intervalHandle=null,this.redrawTimes=0,ipc.registerChannel(ReceiveChannel),ipc.on("native-scene",(async(e,t)=>{const{message:i,params:n}=t;if(this[i]){const t=await this[i].call(this,...n);e.reply(null,t)}else console.warn(`browserToScene ${i} not exist`)}).bind(this))}createWindow(e,t,i){const n=Buffer.from(i,"base64");let r=this.windowMap.get(t);return r||(e.width<=0&&(e.width=minLength),e.height<=0&&(e.height=minLength),r=new NativeWindow(e.width,e.height,n),this.windowMap.set(t,r),this.resize(e.x,e.y,e.width,e.height,t)),{handler:r.handler,isPreviewProcess:isPreview}}close(e){this.setVisible(e,!1),this.redirectTargetWindow(e,!0)}async resize(e,t,i,n,r){var s;const o=this.windowMap.get(r);if(o)return e&&t&&(o.x=e,o.y=t,o.setPos(e,t)),i&&n&&(o.width=i,o.height=n,o.setSize(i,n)),null===(s=o.updateContextID)||void 0===s||s.call(o),await this.redraw(),o.handler}redirectTargetWindow(e,t=!1){var i,n;let r=!1;const s=this.windowMap.get(e);let o=0;if(s){s.renderWindow.clearCameras();const e=null!==(n=null===(i=cc.director.getScene().renderScene)||void 0===i?void 0:i.cameras)&&void 0!==n?n:[],c=cc.Layers.makeMaskInclude([cc.Layers.Enum.GIZMOS,cc.Layers.Enum.SCENE_GIZMO,cc.Layers.Enum.EDITOR]);for(const i of e){if(i.node.layer&c)continue;isPreview&&!r&&(i.visibility|=cc.Layers.Enum.PROFILER,r=!0);const e=t?cc.director.root.tempWindow:s.renderWindow;i.changeTargetWindow(e),i.update(!0),o++}}return o}async handleInput(e,t){var i;const n=Events[e];if(n){if(!ccInput){const{input:e}=await Promise.resolve().then(()=>__importStar(require("cc")));ccInput=e}ccInput&&(t.windowId=2,null===(i=ccInput[n])||void 0===i||i.call(ccInput,t))}}async setVisible(e,t){var i;const n=this.windowMap.get(e);if(n&&(t?(n.setPos(n.x,n.y),n.setSize(n.width,n.height)):(n.setPos(10,10),n.setSize(minLength,minLength)),await this.redraw(),!isWin32))return null===(i=n.updateContextID)||void 0===i||i.call(n),n.handler}async redraw(){return new Promise(e=>{var t;null===(t=cce.Engine)||void 0===t||t.repaintInEditMode(),cc.director&&cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{e(!0)})})}sendToBrowser(e,...t){ipc.send(SendChannel,e,...t)}}exports.default=new NativeScene;