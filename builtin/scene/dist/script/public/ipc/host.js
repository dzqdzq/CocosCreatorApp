"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),utils_1=require("./utils"),v_stacks_1=require("v-stacks");class HostIpc extends EventEmitter{constructor(e){super(),this._storage=new utils_1.DataStorage,this.$webview=null,this.isReady=!1,this.messageBuffer=[],this.$webview=e,this.$webview.addEventListener("ipc-message",e=>{"webview-ipc:send"===e.channel?this._onWebviewSend(e):"webview-ipc:send-reply"===e.channel&&this._onWebviewSendReply(e)})}setReady(e){this.isReady=e,this.isReady&&this.messageBuffer.forEach(e=>{this.$webview.send("webview-ipc:send",e.id,e.data.message,e.data.arguments)}),this.messageBuffer.length=0}send(e,...s){return new Promise((t,i)=>{const n={message:e,arguments:s.map(utils_1.encodeArgs),callback:function(e,s){e?i(e):t(s)},stack:""},a=this._storage.add(n);if(!this.isReady)return this.messageBuffer.push({id:a,data:n});this.$webview.send("webview-ipc:send",a,n.message,n.arguments)})}async _onWebviewSend(e){const[s,t,i]=e.args,n=i.map(utils_1.decodeArgs),a=this._events[t];if(a)try{const e=await a(...n);if(!this.$webview.contentWindow)return;this.$webview.send("webview-ipc:send-reply",s,null,utils_1.encodeArgs(e))}catch(e){if(console.error(e),!this.$webview.contentWindow)return;return void this.$webview.send("webview-ipc:send-reply",s,v_stacks_1.encode(e))}else{const e=new Error(`Could not find the message: ${t}`);if(console.warn(e),!this.$webview.contentWindow)return;this.$webview.send("webview-ipc:send-reply",s,e)}}_onWebviewSendReply(e){const s=e.args[0];let t=e.args[1];const i=utils_1.decodeArgs(e.args[2]),n=this._storage.get(s);n?n.callback&&(t&&(t.stack?t.stack=t.stack.replace(/^[^\n]+/,e=>e+"\n    at <process:scene>"):t.stack=`${t.message}\n    at <process:scene>`,t=v_stacks_1.decode(t)),n.callback(t,i)):console.warn("IPC message has been lost."),this._storage.remove(s)}}exports.default=HostIpc;