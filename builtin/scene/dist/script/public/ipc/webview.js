"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),{ipcRenderer:ipcRenderer}=require("electron"),utils_1=require("./utils"),v_stacks_1=require("v-stacks"),utils_2=require("./utils");class WebviewIpc extends EventEmitter{constructor(){super(...arguments),this._storage=new utils_1.DataStorage}get storage(){return this._storage}send(e,...s){return new Promise((t,r)=>{const c={message:e,arguments:s.map(utils_2.encodeArgs),callback:function(e,s){e?r(e):t(s)},stack:""},n=this._storage.add(c);ipcRenderer.sendToHost("webview-ipc:send",n,c.message,c.arguments)})}}const ipc=new WebviewIpc;exports.default=ipc,ipcRenderer.on("webview-ipc:send",async(e,s,t,r)=>{const c=ipc._events[t];try{const e=await c(...r.map(utils_2.decodeArgs));ipcRenderer.sendToHost("webview-ipc:send-reply",s,null,utils_2.encodeArgs(e))}catch(e){return console.log(e),void ipcRenderer.sendToHost("webview-ipc:send-reply",s,v_stacks_1.encode(e))}}),ipcRenderer.on("webview-ipc:send-reply",(e,s,t,r)=>{const c=ipc.storage.get(s);if(c){if(c.callback){t&&("string"==typeof t.stack&&(t.stack=t.stack.replace(/^[^\n]+/,e=>e+"\n    at <process:scene>")),t=v_stacks_1.decode(t));try{c.callback(t,utils_2.decodeArgs(r))}catch(e){console.error(e)}}}else console.warn("IPC message has been lost.");ipc.storage.remove(s)});