"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,i){void 0===i&&(i=t);var n=Object.getOwnPropertyDescriptor(o,t);n&&("get"in n?o.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,i,n)}:function(e,o,t,i){void 0===i&&(i=t),e[i]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),camera_1=__importDefault(require("../../../3d/manager/camera")),node_1=__importDefault(require("../../../utils/node")),operation_1=__importStar(require("../../operation")),selection_1=__importDefault(require("../../selection")),gizmo_selection_1=__importDefault(require("../../selection/gizmo-selection")),index_1=__importDefault(require("../utils/engine/index")),set_util_1=__importStar(require("../utils/set-util")),light_probe_gizmo_1=__importDefault(require("./elements/components/light/light-probe-gizmo")),position_gizmo_1=__importDefault(require("./elements/transform/position-gizmo")),{getRaycastResults:getRaycastResults,raycast:raycast}=index_1.default,hitPoint=cc.v3(),SceneGizmoLayer=cc_1.Layers.Enum.SCENE_GIZMO;let GizmoManager;const isWin32="win32"===process.platform;function copyEventKeys(e,o){e.altKey=o.altKey,e.metaKey=o.metaKey,e.ctrlKey=o.ctrlKey,e.shiftKey=o.shiftKey,e.leftButton=o.leftButton,e.middleButton=o.middleButton,e.rightButton=o.rightButton}function adjustY(e){if(isSceneNative){return jsb.ISystemWindowManager.getInstance().getWindow(1).getViewSize().height-e}return cc.game.canvas.height-e}var RegionSelectMode;!function(e){e[e.Node=0]="Node",e[e.Gizmo=1]="Gizmo"}(RegionSelectMode||(RegionSelectMode={}));class GizmoOperation{constructor(){this._regionSelecting=!1,this._hoverinGizmo=null,this._curSelectGizmo=null,this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._regionSelectMode=RegionSelectMode.Node,this._anyKeyDown=!1,this._gizmoOperationEventListeners=[],this._gizmoSelection=new gizmo_selection_1.default(this._gizmoOperationEventListeners)}raycastGizmos(e,o){let t=raycast(cc.director._scene.renderScene,GizmoManager._sceneGizmoCamera._camera,SceneGizmoLayer,e,o);return(!t||t.length<=0)&&(t=getRaycastResults(GizmoManager.gizmoRootNode,e,o,1/0,cc_1.Layers.Enum.IGNORE_RAYCAST)),t}_emitEventToNode(e,o){e.emit(o.type,o),cce.Engine.repaintInEditMode()}_onNotGizmoMouseDown(e){this._noGizmoMouseDownEvent=e,this._gizmoOperationEventListeners.forEach(o=>o.onNotGizmoMouseDown(e))}_onNotGizmoMouseUp(e){if(this._noGizmoMouseDownEvent=null,e.leftButton){if(this._regionSelecting)this._regionSelecting=!1,GizmoManager.hideSelectionRegion(),this._regionSelectMode===RegionSelectMode.Gizmo&&this._gizmoSelection.confirm();else switch(e.y=adjustY(e.y),this._regionSelectMode){case RegionSelectMode.Node:this._select(e);break;case RegionSelectMode.Gizmo:this._gizmoSelection.unselectAll()}this._gizmoOperationEventListeners.forEach(o=>o.onNotGizmoMouseUp(e))}}_onNotGizmoMouseMove(e){const o=this._noGizmoMouseDownEvent;if(e.leftButton&&o){this._regionSelecting=!0;const t=o.x>e.x,i=o.y<e.y,n=t?e.x:o.x,s=t?o.x:e.x,r=i?o.y:e.y,l=i?e.y:o.y;switch(this._regionSelectMode){case RegionSelectMode.Node:this._regionSelectNode(n,s,l,r);break;case RegionSelectMode.Gizmo:this._regionSelectGizmo(n,s,l,r,e)}return this._gizmoOperationEventListeners.forEach(o=>o.onNotGizmoMouseMove(e)),!1}}_onGizmoMouseDown(e,o){if(camera_1.default.controller.isMoving())return!0;if(this._gizmoMouseDownEvent=e,e.leftButton){const t=o[0];return e.hitPoint=t.hitPoint.clone(),this._curSelectGizmo=t.node,this._emitEventToNode(this._curSelectGizmo,e),this._regionSelectMode===RegionSelectMode.Gizmo&&(this._selectGizmo([t.node],e),this._gizmoSelection.confirm()),!1}return!0}_onGizmoMouseUp(e){if(this._gizmoMouseDownEvent=null,this._curSelectGizmo)return this._emitEventToNode(this._curSelectGizmo,e),this._curSelectGizmo=null,!1;const{x:o,y:t}=e,i=this.raycastGizmos(o,t);for(let o=0;o<i.length;o++)this._emitEventToNode(i[o].node,e);return!0}_onGizmoMouseMove(e){this._curSelectGizmo&&this._emitEventToNode(this._curSelectGizmo,e)}_select(e){const o=node_1.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR,cc_1.Layers.Enum.IGNORE_RAYCAST]));if(o.length>0){let t=null;for(let e=0;e<o.length;e++){const i=o[e];if(!(i.objFlags&cc.Object.Flags.LockedInEditor)){t=i;break}}if(!t)return;const i=selection_1.default.query();if(e.ctrlKey||e.shiftKey||selection_1.default.clear(),e.ctrlKey)selection_1.default.isSelect(t.uuid)?selection_1.default.unselect(t.uuid):selection_1.default.select(t.uuid);else{const e=i[0];for(let i=0;i<o.length-1;i++)if(o[i]&&e===o[i].uuid){t=o[i+1];break}selection_1.default.select(t.uuid)}}else e.leftButton&&(e.ctrlKey||e.shiftKey||selection_1.default.clear())}_regionSelectNode(e,o,t,i){GizmoManager.showSelectionRegion(e,o,t,i);const n=cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR]),s=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,o,t,i,n),r=selection_1.default.query(),l=new Map;r.forEach(e=>{l.set(e,!0)}),s.forEach(e=>{l.has(e.uuid)||selection_1.default.select(e.uuid),l.set(e.uuid,!1)});for(const e of l.keys())l.get(e)&&selection_1.default.unselect(e)}_selectGizmo(e,o){this._gizmoSelection.processCurrent(e.map(e=>e.uuid),!1,o.metaKey||o.ctrlKey)}_regionSelectGizmo(e,o,t,i,n){GizmoManager.showSelectionRegion(e,o,t,i);const s=cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.GIZMOS]),r=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,o,t,i,s,!1);this._gizmoSelection.processCurrent(r.map(e=>e.uuid),!0,n.metaKey||n.ctrlKey)}init(e){GizmoManager=e,operation_1.default.on("mousedown",this.onMouseDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousemove",this.onMouseMove.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mouseup",this.onMouseUp.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousewheel",this.onMouseWheel.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keydown",this.onKeyDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keyup",this.onKeyUp.bind(this),operation_1.OperationPriority.Gizmo)}onMouseDown(e){this._anyKeyDown||(this._anyKeyDown=e.altKey||e.ctrlKey||e.shiftKey||e.metaKey);const o=e.x,t=adjustY(e.y),i=new cc.Event("mouseDown",!0);i.x=o,i.y=t,copyEventKeys(i,e);const n=this.raycastGizmos(o,t);return n.length>0?this._onGizmoMouseDown(i,n):this._onNotGizmoMouseDown(i)}onMouseUp(e){if(camera_1.default.controller.isMoving()&&!this._regionSelecting&&!this._gizmoMouseDownEvent)return this._noGizmoMouseDownEvent=null,!0;const o=e.x,t=adjustY(e.y),i=new cc.Event("mouseUp",!0);return i.x=o,i.y=t,copyEventKeys(i,e),this._gizmoMouseDownEvent?this._onGizmoMouseUp(i):!this._noGizmoMouseDownEvent||this._onNotGizmoMouseUp(i)}onMouseMove(e){const o=e.x,t=adjustY(e.y);let i=new cc.Event("mouseMove",!0);if(i.x=o,i.y=t,i.moveDeltaX=e.moveDeltaX,i.moveDeltaY=-e.moveDeltaY,copyEventKeys(i,e),this._gizmoMouseDownEvent&&this._gizmoMouseDownEvent.leftButton)return this._onGizmoMouseMove(i),!1;if(this._noGizmoMouseDownEvent){if(!this._anyKeyDown)return this._onNotGizmoMouseMove(i);if(this._regionSelecting)return!1}else{if(GizmoManager.transformTool instanceof position_gizmo_1.default&&!GizmoManager.transformTool.onVertexSnapMove(i))return;const e=this.raycastGizmos(o,t);if(e.length>0){const n=e.ray;for(let o=0;o<e.length;o++)cc_1.Vec3.multiplyScalar(hitPoint,n.d,e[o].distance),cc_1.Vec3.add(hitPoint,n.o,hitPoint),i.hitPoint=hitPoint,e[o].node.emit(i.type,i);const s=e[0].node;s!==this._hoverinGizmo&&(this._hoverinGizmo&&(i=new cc.Event("hoverOut",!0),this._emitEventToNode(this._hoverinGizmo,i)),this._hoverinGizmo=s,(i=new cc.Event("hoverIn",!0)).x=o,i.y=t,this._emitEventToNode(this._hoverinGizmo,i))}else this._hoverinGizmo&&(i=new cc.Event("hoverOut",!0),this._emitEventToNode(this._hoverinGizmo,i)),this._hoverinGizmo=null}}onMouseWheel(){}clear(){this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._curSelectGizmo=null,this._hoverinGizmo=null}onMouseLeave(){const e=new cc.Event("mouseLeave",!0);this._curSelectGizmo&&this._emitEventToNode(this._curSelectGizmo,e),this.clear()}onKeyDown(e){var o;if(this._regionSelecting)return!1;this._anyKeyDown=!0;let t=!0;return GizmoManager.transformTool&&GizmoManager.transformTool.onGizmoKeyDown&&(t=GizmoManager.transformTool.onGizmoKeyDown(e)),t=GizmoManager.callAllGizmoFuncOfNode(null===(o=GizmoManager.transformTool)||void 0===o?void 0:o.node,"onKeyDown",e)}onKeyUp(e){var o;this._anyKeyDown=!1;let t=!0;return GizmoManager.transformTool&&GizmoManager.transformTool.onGizmoKeyUp&&(t=GizmoManager.transformTool.onGizmoKeyUp(e)),t=GizmoManager.callAllGizmoFuncOfNode(null===(o=GizmoManager.transformTool)||void 0===o?void 0:o.node,"onKeyUp",e)}registerGizmoOperationEventListener(e){this._gizmoOperationEventListeners.push(e)}lightProbeEditModeChanged(e){e?(this._regionSelectMode=RegionSelectMode.Gizmo,this._gizmoSelection.clear()):(this._regionSelectMode=RegionSelectMode.Node,this._gizmoSelection.clear())}boundingBoxEditModeChanged(e){e?(this._regionSelectMode=RegionSelectMode.Gizmo,this._gizmoSelection.clear()):(this._regionSelectMode=RegionSelectMode.Node,this._gizmoSelection.clear())}selectAllLightProbes(){for(const e of this._gizmoOperationEventListeners)if(e instanceof light_probe_gizmo_1.default){if(!e.checkCurrentTargetPointingSelf()||!e.visible())continue;e.selectAll();const o=e.shouldEmitNodes();this._gizmoSelection.logic.selected.addAll(o)}this._gizmoSelection.confirm()}unselectAllLightProbes(){for(const e of this._gizmoOperationEventListeners)e instanceof light_probe_gizmo_1.default&&(e.unselectAll(),this._gizmoSelection.logic.selected.clear());this._gizmoSelection.confirm()}duplicateCurrentSelectedProbes(){const e=new set_util_1.default;for(const o of this._gizmoOperationEventListeners)if(o instanceof light_probe_gizmo_1.default){if(!o.checkCurrentTargetPointingSelf()||!o.visible())continue;e.addAll(o.duplicateCurrentSelectedProbes())}this._gizmoSelection.processCurrent(e.map(e=>e.uuid)),this._gizmoSelection.confirm()}removeCurrentSelectedProbes(){for(const e of this._gizmoOperationEventListeners)if(e instanceof light_probe_gizmo_1.default){if(!e.checkCurrentTargetPointingSelf()||!e.visible())continue;const o=e.deleteCurrentSelectedProbes();this._gizmoSelection.unselect((0,set_util_1.toSet)(o.map(e=>e.uuid)))}this._gizmoSelection.confirm()}}exports.default=new GizmoOperation;