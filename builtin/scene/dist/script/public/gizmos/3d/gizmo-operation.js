"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const{getRaycastResults:getRaycastResults,raycast:raycast}=require("../utils/engine/index"),cc_1=require("cc"),operation_1=__importDefault(require("../../operation")),node_1=__importDefault(require("../../../utils/node")),selection_1=__importDefault(require("../../selection")),camera_1=__importDefault(require("../../../3d/manager/camera")),hitPoint=cc.v3(),SceneGizmoLayer=cc_1.Layers.Enum.SCENE_GIZMO;let GizmoManager=null;function copyEventKeys(e,o){e.altKey=o.altKey,e.metaKey=o.metaKey,e.ctrlKey=o.ctrlKey,e.shiftKey=o.shiftKey,e.leftButton=o.leftButton,e.middleButton=o.middleButton,e.rightButton=o.rightButton}class GizmoOperation{constructor(){this._regionSelecting=!1,this._hoverinGizmo=null,this._curSelectGizmo=null,this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null}raycastGizmos(e,o){let t=raycast(cc.director._scene.renderScene,GizmoManager._sceneGizmoCamera._camera,SceneGizmoLayer,e,o);return(!t||t.length<=0)&&(t=getRaycastResults(GizmoManager.gizmoRootNode,e,o)),t}_emitEventToNode(e,o){e.emit(o.type,o),cce.Engine.repaintInEditMode()}_onNotGizmoMouseDown(e){this._noGizmoMouseDownEvent=e}_onNotGizmoMouseUp(e){this._noGizmoMouseDownEvent=null,e.leftButton&&(this._regionSelecting?(this._regionSelecting=!1,GizmoManager.hideSelectionRegion()):(e.y=cc.game.canvas.height-e.y,this._select(e)))}_onNotGizmoMouseMove(e){if(e.leftButton){this._regionSelecting=!0;const o=this._noGizmoMouseDownEvent,t=o.x>e.x,n=o.y<e.y,i=t?e.x:o.x,s=t?o.x:e.x,a=n?o.y:e.y,r=n?e.y:o.y;this._regionSelect(i,s,r,a)}}_onGizmoMouseDown(e,o){if(this._gizmoMouseDownEvent=e,e.leftButton){const t=o[0];return e.hitPoint=t.hitPoint.clone(),this._curSelectGizmo=t.node,this._emitEventToNode(this._curSelectGizmo,e),!1}return!0}_onGizmoMouseUp(e){if(this._gizmoMouseDownEvent=null,this._curSelectGizmo)return this._emitEventToNode(this._curSelectGizmo,e),this._curSelectGizmo=null,!1;const{x:o,y:t}=e,n=this.raycastGizmos(o,t);for(let o=0;o<n.length;o++)this._emitEventToNode(n[o].node,e);return!0}_onGizmoMouseMove(e){this._curSelectGizmo&&this._emitEventToNode(this._curSelectGizmo,e)}_setKeyState(e){}_select(e){const o=node_1.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR]));if(o.length>0){let t=null;for(let e=0;e<o.length;e++){const n=o[e];if(!(n.objFlags&cc.Object.Flags.LockedInEditor)){t=n;break}}if(!t)return;const n=selection_1.default.query();if(e.ctrlKey||e.shiftKey||selection_1.default.clear(),e.ctrlKey)selection_1.default.isSelect(t.uuid)?selection_1.default.unselect(t.uuid):selection_1.default.select(t.uuid);else{const e=n[0];for(let n=0;n<o.length-1;n++)if(o[n]&&e===o[n].uuid){t=o[n+1];break}selection_1.default.select(t.uuid)}}else e.leftButton&&(e.ctrlKey||e.shiftKey||selection_1.default.clear())}_regionSelect(e,o,t,n){GizmoManager.showSelectionRegion(e,o,t,n);const i=cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR]),s=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,o,t,n,i),a=selection_1.default.query(),r=new Map;a.forEach(e=>{r.set(e,!0)}),s.forEach(e=>{r.has(e.uuid)||selection_1.default.select(e.uuid),r.set(e.uuid,!1)});for(const e of r.keys())r.get(e)&&selection_1.default.unselect(e)}init(e){GizmoManager=e,operation_1.default.on("mousedown",this.onMouseDown.bind(this)),operation_1.default.on("mousemove",this.onMouseMove.bind(this)),operation_1.default.on("mouseup",this.onMouseUp.bind(this)),operation_1.default.on("mousewheel",this.onMouseWheel.bind(this)),operation_1.default.on("keydown",this.onKeyDown.bind(this)),operation_1.default.on("keyup",this.onKeyUp.bind(this))}onMouseDown(e){const o=e.x,t=cc.game.canvas.height-e.y,n=new cc.Event("mouseDown",!0);n.x=o,n.y=t,copyEventKeys(n,e);const i=this.raycastGizmos(o,t);return i.length>0?this._onGizmoMouseDown(n,i):this._onNotGizmoMouseDown(n)}onMouseUp(e){const o=e.x,t=cc.game.canvas.height-e.y,n=new cc.Event("mouseUp",!0);return n.x=o,n.y=t,copyEventKeys(n,e),this._gizmoMouseDownEvent?this._onGizmoMouseUp(n):this._noGizmoMouseDownEvent&&this._onNotGizmoMouseUp(n),!0}onMouseMove(e){const o=e.x,t=cc.game.canvas.height-e.y;let n=new cc.Event("mouseMove",!0);if(n.x=o,n.y=t,n.moveDeltaX=e.moveDeltaX,n.moveDeltaY=-e.moveDeltaY,copyEventKeys(n,e),this._gizmoMouseDownEvent)this._onGizmoMouseMove(n);else if(this._noGizmoMouseDownEvent)this._onNotGizmoMouseMove(n);else{if(GizmoManager.transformTool&&GizmoManager.transformTool.onVertexSnapMove&&!GizmoManager.transformTool.onVertexSnapMove(n))return;const e=this.raycastGizmos(o,t);if(e.length>0){const i=e.ray;for(let o=0;o<e.length;o++)cc_1.Vec3.multiplyScalar(hitPoint,i.d,e[o].distance),cc_1.Vec3.add(hitPoint,i.o,hitPoint),n.hitPoint=hitPoint,e[o].node.emit(n.type,n);const s=e[0].node;s!==this._hoverinGizmo&&(this._hoverinGizmo&&(n=new cc.Event("hoverOut",!0),this._emitEventToNode(this._hoverinGizmo,n)),this._hoverinGizmo=s,(n=new cc.Event("hoverIn",!0)).x=o,n.y=t,this._emitEventToNode(this._hoverinGizmo,n))}else this._hoverinGizmo&&(n=new cc.Event("hoverOut",!0),this._emitEventToNode(this._hoverinGizmo,n)),this._hoverinGizmo=null}}onMouseWheel(){}clear(){this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._curSelectGizmo=null,this._hoverinGizmo=null}onMouseLeave(){const e=new cc.Event("mouseLeave",!0);this._curSelectGizmo&&this._emitEventToNode(this._curSelectGizmo,e),this.clear()}onKeyDown(e){this._setKeyState(e),GizmoManager.transformTool&&(GizmoManager.transformTool.onGizmoKeyDown&&GizmoManager.transformTool.onGizmoKeyDown(e),GizmoManager.callAllGizmoFuncOfNode(GizmoManager.transformTool.node,"onKeyDown",e))}onKeyUp(e){this._setKeyState(e),GizmoManager.transformTool&&(GizmoManager.transformTool.onGizmoKeyUp&&GizmoManager.transformTool.onGizmoKeyUp(e),GizmoManager.callAllGizmoFuncOfNode(GizmoManager.transformTool.node,"onKeyUp",e))}}exports.default=new GizmoOperation;