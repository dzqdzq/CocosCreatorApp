"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),position_gizmo_1=__importDefault(require("../transform/position-gizmo")),external_1=__importDefault(require("../../../utils/external")),box_controller_1=__importDefault(require("./box-controller")),index_1=__importDefault(require("../../../utils/engine/index")),NodeUtils=external_1.default.NodeUtils,AxisName=controller_utils_1.default.AxisName,{setMeshColor:setMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var t;return null===(t=cc_1.director.getScene())||void 0===t?void 0:t.globals};class LightProbeBoundingBoxController extends box_controller_1.default{constructor(t,e){super(t),this.targetDelegate=e,this._editable=!0,this._boundingBoxScale=new cc_1.Vec3,this._minPos=new cc_1.Vec3,this._maxPos=new cc_1.Vec3,this._editMode=!1,this._positionNode=controller_utils_1.default.create3DNode("PositionNode"),this._positionGizmo=new position_gizmo_1.default([this._positionNode]),this._gizmoEventListenerIndex="",this._positionMouseDown=!1,this.setColor(cc_1.Color.GREEN),this.edit=!0,this.initPositionGizmo()}get editMode(){return this._editMode}initPositionGizmo(){this._positionNode.parent=this._rootNode,this._positionNode.noNeedCommitChanges=!0,this.updatePositionGizmo(),this._positionGizmo.init(),this._positionGizmo.hide()}updateController(){super.updateController(),this.updateSize((0,cc_1.v3)(this.targetDelegate.target.maxPos).add(this.targetDelegate.target.minPos).divide((0,cc_1.v3)(2,2,2)),(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos)),this.updatePositionGizmo()}updatePositionGizmo(){if(this._positionMouseDown)return;const t=this.targetDelegate.target.maxPos,e=this.targetDelegate.target.minPos;this._positionNode.setPosition((0,cc_1.v3)(t.x,e.y,t.z)),this._positionGizmo.onNodeChanged()}onMouseDown(t){this._boundingBoxScale=NodeUtils.getWorldScale3D(this._rootNode),this._maxPos=(0,cc_1.v3)(this.targetDelegate.target.maxPos),this._minPos=(0,cc_1.v3)(this.targetDelegate.target.minPos),super.onMouseDown(t)}updateDataFromBBController(t){if(this.updated){const e=this.getDeltaSize();e.divide(this._boundingBoxScale),t.handleName.includes("neg")?this.targetDelegate.target.minPos.set((0,cc_1.v3)(this._minPos).subtract(e)):(e.divide((0,cc_1.v3)(2,2,2)),this.targetDelegate.target.maxPos.set((0,cc_1.v3)(this._maxPos).add(e)))}}onShow(){super.onShow(),this.updateSize(this.getBoundingBoxCenter(),(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos));const t=this,e={nodePosition:(0,cc_1.v3)(),center:(0,cc_1.v3)()};this._gizmoEventListenerIndex=this._positionGizmo.addMouseEventListener(new class{onControllerMouseDown(o){t._positionMouseDown=!0,e.nodePosition=(0,cc_1.v3)(t._positionNode.position),e.center=(0,cc_1.v3)(t.getBoundingBoxCenter())}onControllerMouseMove(o){t._positionMouseDown=!0;const i=(0,cc_1.v3)(e.center).add((0,cc_1.v3)(t._positionNode.position).subtract(e.nodePosition));t.setBoundingBoxCenter(i)}onControllerMouseUp(o){t._positionMouseDown=!1,e.center=(0,cc_1.v3)(),e.nodePosition=(0,cc_1.v3)(),t.updatePositionGizmo(),t.targetDelegate.target.onProbeChanged(!1,!0)}}),this._positionGizmo.show()}onHide(){var t,e;super.onHide(),null===(t=this._positionGizmo)||void 0===t||t.hide(),this._gizmoEventListenerIndex&&(null===(e=this._positionGizmo)||void 0===e||e.removeMouseEventListener(this._gizmoEventListenerIndex),this._gizmoEventListenerIndex="")}getBoundingBoxCenter(){return(0,cc_1.v3)(this.targetDelegate.target.maxPos).add(this.targetDelegate.target.minPos).divide((0,cc_1.v3)(2,2,2))}setBoundingBoxCenter(t){let e=(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos);e=e.divide((0,cc_1.v3)(2,2,2)),this.targetDelegate.target.maxPos.set((0,cc_1.v3)(t).add(e)),this.targetDelegate.target.minPos.set((0,cc_1.v3)(t).subtract(e)),this.updateController()}lightProbeEditModeChanged(t){this.hide(),cce.Engine.repaintInEditMode()}boundingBoxEditModeChanged(t){this._editMode=t,t?(this.show(),cce.Engine.repaintInEditMode()):(this.hide(),cce.Engine.repaintInEditMode())}}exports.default=LightProbeBoundingBoxController;