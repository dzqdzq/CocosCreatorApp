"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),position_gizmo_1=__importDefault(require("../transform/position-gizmo")),external_1=__importDefault(require("../../../utils/external")),box_controller_1=__importDefault(require("./box-controller")),index_1=__importDefault(require("../../../utils/engine/index")),NodeUtils=external_1.default.NodeUtils,AxisName=controller_utils_1.default.AxisName,{setMeshColor:setMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null===(e=cc_1.director.getScene())||void 0===e?void 0:e.globals};class LightProbeBoundingBoxController extends box_controller_1.default{constructor(e,t){super(e),this.targetDelegate=t,this._editable=!0,this._boundingBoxScale=new cc_1.Vec3,this._minPos=new cc_1.Vec3,this._maxPos=new cc_1.Vec3,this._editMode=!1,this._positionNode=controller_utils_1.default.create3DNode("PositionNode"),this._positionGizmo=new position_gizmo_1.default([this._positionNode]),this._gizmoEventListenerIndex="",this._positionMouseDown=!1,this.setColor(cc_1.Color.GREEN),this.edit=!0,this.initPositionGizmo()}get editMode(){return this._editMode}initPositionGizmo(){this._positionNode.parent=this._rootNode,this._positionNode.noNeedCommitChanges=!0,this.updatePositionGizmo(),this._positionGizmo.init(),this._positionGizmo.hide()}show(){super.show(),this.updateController()}updateController(){super.updateController(),this.updateSize((0,cc_1.v3)(this.targetDelegate.target.maxPos).add(this.targetDelegate.target.minPos).divide((0,cc_1.v3)(2,2,2)),(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos)),this.updatePositionGizmo()}updatePositionGizmo(){if(this._positionMouseDown)return;const e=this.targetDelegate.target.maxPos,t=this.targetDelegate.target.minPos;this._positionNode.setPosition((0,cc_1.v3)(e.x,t.y,e.z)),this._positionGizmo.onNodeChanged()}onMouseDown(e){this._boundingBoxScale=NodeUtils.getWorldScale3D(this._rootNode),this._maxPos=(0,cc_1.v3)(this.targetDelegate.target.maxPos),this._minPos=(0,cc_1.v3)(this.targetDelegate.target.minPos),super.onMouseDown(e)}onMouseMove(e){super.onMouseMove(e),this.updateController()}onMouseUp(e){super.onMouseUp(e),this.updateController()}updateDataFromBBController(e){if(this.updated){const t=this.getDeltaSize();t.divide(this._boundingBoxScale),e.handleName.includes("neg")?this.targetDelegate.target.minPos.set((0,cc_1.v3)(this._minPos).subtract(t)):(t.divide((0,cc_1.v3)(2,2,2)),this.targetDelegate.target.maxPos.set((0,cc_1.v3)(this._maxPos).add(t)))}}onShow(){super.onShow(),this.updateSize(this.getBoundingBoxCenter(),(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos));const e=this,t={nodePosition:(0,cc_1.v3)(),center:(0,cc_1.v3)()};this._gizmoEventListenerIndex=this._positionGizmo.addMouseEventListener(new class{onControllerMouseDown(o){e._positionMouseDown=!0,t.nodePosition=(0,cc_1.v3)(e._positionNode.position),t.center=(0,cc_1.v3)(e.getBoundingBoxCenter())}onControllerMouseMove(o){e._positionMouseDown=!0;const i=(0,cc_1.v3)(t.center).add((0,cc_1.v3)(e._positionNode.position).subtract(t.nodePosition));e.setBoundingBoxCenter(i)}onControllerMouseUp(o){e._positionMouseDown=!1,t.center=(0,cc_1.v3)(),t.nodePosition=(0,cc_1.v3)(),e.updatePositionGizmo(),e.targetDelegate.target.onProbeChanged(!1,!0)}}),this._positionGizmo.show()}onHide(){var e,t;super.onHide(),null===(e=this._positionGizmo)||void 0===e||e.hide(),this._gizmoEventListenerIndex&&(null===(t=this._positionGizmo)||void 0===t||t.removeMouseEventListener(this._gizmoEventListenerIndex),this._gizmoEventListenerIndex="")}getBoundingBoxCenter(){return(0,cc_1.v3)(this.targetDelegate.target.maxPos).add(this.targetDelegate.target.minPos).divide((0,cc_1.v3)(2,2,2))}setBoundingBoxCenter(e){let t=(0,cc_1.v3)(this.targetDelegate.target.maxPos).subtract(this.targetDelegate.target.minPos);t=t.divide((0,cc_1.v3)(2,2,2)),this.targetDelegate.target.maxPos.set((0,cc_1.v3)(e).add(t)),this.targetDelegate.target.minPos.set((0,cc_1.v3)(e).subtract(t)),this.updateController()}lightProbeEditModeChanged(e){this.hide(),cce.Engine.repaintInEditMode()}boundingBoxEditModeChanged(e){this._editMode=e,e?(this.show(),cce.Engine.repaintInEditMode()):(this.hide(),cce.Engine.repaintInEditMode())}}exports.default=LightProbeBoundingBoxController;