"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const external_1=__importDefault(require("../../../../utils/external")),NodeUtils=external_1.default.NodeUtils,cone_controller_1=__importDefault(require("../../controller/cone-controller")),sphere_controller_1=__importDefault(require("../../controller/sphere-controller")),gizmo_base_1=__importDefault(require("../../gizmo-base")),cc_1=require("cc"),engine_1=__importDefault(require("../../../../utils/engine")),{create3DNode:create3DNode,setMaterialProperty:setMaterialProperty}=engine_1.default,MathUtil=external_1.default.EditorMath,tempQuat_a=new cc_1.Quat;class SpotLightComponentGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._lightGizmoColor=new cc_1.Color(255,255,50),this._lightCtrlHoverColor=new cc_1.Color(0,255,0),this._range=0,this._angle=0,this._baseSize=.5,this._glowSize=.4,this._controller=null,this._sizeSphereCtrl=null,this._rangePropPath=null,this._anglePropPath=null,this._rangeChanged=!1,this._angleChanged=!1,this._coneTopPos=new cc_1.Vec3}init(){this.createController(),this._isInited=!0}onShow(){var t;this._controller.show(),null===(t=this._sizeSphereCtrl)||void 0===t||t.show(),this.updateControllerData()}onHide(){var t;this._controller.hide(),null===(t=this._sizeSphereCtrl)||void 0===t||t.hide()}createController(){const t=this.getGizmoRoot(),e=create3DNode("SpotLightGizmo");e.parent=t,this._controller=new cone_controller_1.default(e),this._controller.direction=cc_1.EAxisDirection.Z_AXIS,this._controller.setColor(this._lightGizmoColor),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller.editable=!0,this._controller.hoverColor=this._lightCtrlHoverColor,this._sizeSphereCtrl=new sphere_controller_1.default(e),this._sizeSphereCtrl.editable=!1}onControllerMouseDown(){this._isInited&&null!==this.target&&(this._range=this.target.range,this._angle=this.target.spotAngle,this._rangePropPath=this.getCompPropPath("range"),this._anglePropPath=this.getCompPropPath("spotAngle"),this._rangeChanged=!1,this._angleChanged=!1)}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this._rangeChanged&&this.onControlEnd(this._rangePropPath),this._angleChanged&&this.onControlEnd(this._anglePropPath)}getConeRadius(t,e){return Math.tan(t/2*MathUtil.D2R)*e}updateDataFromController(){if(this._controller.updated){const t=this.node,e=this._controller.getDeltaRadius(),o=this._controller.getDeltaHeight();let r=this._range;0!==o&&(r=this._range+o,r=MathUtil.toPrecision(r,3),(r=Math.abs(r))<.01&&(r=.01),this._rangeChanged=!0);let i=this.getConeRadius(this._angle,r),l=this._angle;0!==e&&(i=this.getConeRadius(this._angle,r)+e,i=Math.abs(i),(l=2*Math.atan2(i,r))<MathUtil.D2R&&(l=MathUtil.D2R),l*=MathUtil.R2D,l=MathUtil.toPrecision(l,3),this._angleChanged=!0),this._rangeChanged&&this.onControlUpdate(this._rangePropPath),this._angleChanged&&this.onControlUpdate(this._anglePropPath),this.target.spotAngle=l,this.target.range=r,this.onComponentChanged(t)}}updateControllerTransform(){var t,e,o;const r=this.node,i=tempQuat_a;NodeUtils.getWorldRotation3D(r,i);const l=NodeUtils.getWorldPosition3D(r);null===(t=this._controller)||void 0===t||t.setPosition(l),null===(e=this._controller)||void 0===e||e.setRotation(i),null===(o=this._sizeSphereCtrl)||void 0===o||o.setPosition(l)}updateControllerData(){var t;if(!this._isInited||null===this.target)return;this.updateControllerTransform(),this._controller.checkEdit();const e=this.target,o=this.getConeRadius(e.spotAngle,e.range);this._controller.updateSize(this._coneTopPos.set(0,0,-e.range/2),o,e.range);const r=e.color.clone();if(e.useColorTemperature){const t=e._light.colorTemperatureRGB;r.r*=t.x,r.g*=t.y,r.b*=t.z}const i=cc.v4();i.x=e.luminance,i.y=this._glowSize,null===(t=this._sizeSphereCtrl)||void 0===t||t.setColor(r),this._sizeSphereCtrl.radius=e.size}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=SpotLightComponentGizmo;