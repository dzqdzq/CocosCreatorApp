"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../../utils/external")),box_controller_1=__importDefault(require("../controller/box-controller")),gizmo_base_1=__importDefault(require("../gizmo-base")),NodeUtils=external_1.default.NodeUtils,tempVec3_a=new cc_1.Vec3;class ReflectionProbeGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._controller=null,this._bbHalfSize=new cc_1.Vec3,this._sphereMeshRenderer=null,this._planeMeshRenderer=null,this._sphere=null,this._plane=null}onBBControllerMouseDown(e){this._isInitialized&&null!=this.target&&this.target instanceof cc_1.ReflectionProbe&&this._bbHalfSize.set(this.target.size)}onBBControllerMouseMove(e){var t;if(this.target instanceof cc_1.ReflectionProbe&&(null===(t=this._controller)||void 0===t?void 0:t.updated)){this.recordChanges();const e=this.node,t=this._controller.getDeltaSize();this.target.size=this._bbHalfSize,cc_1.Vec3.add(tempVec3_a,this._bbHalfSize,t),this.target.size.set(tempVec3_a.x>0?tempVec3_a.x:0,tempVec3_a.y>0?tempVec3_a.y:0,tempVec3_a.z>0?tempVec3_a.z:0),this.onComponentChanged(e)}}onBBControllerMouseUp(e){this.commitChanges()}init(){this.createController()}onShow(){var e;this._isInitialized&&(this.updateControllerTransform(),this._controller.show(),this.target instanceof cc_1.ReflectionProbe&&(null===(e=this.target.iconGizmo)||void 0===e||e.hide(),this._sphere&&(this.target.previewSphere=this._sphere),this._plane&&(this.target.previewPlane=this._plane)))}generateMaterial(e){const t=new cc_1.Material;return t.initialize(null!==e&&void 0!==e?e:{effectName:"builtin-standard"}),t}onHide(){var e;this._controller.hide(),this._sphere&&(this._sphere.active=!1),this._plane&&(this._plane.active=!1),this.target instanceof cc_1.ReflectionProbe&&(null===(e=this.target.iconGizmo)||void 0===e||e.show(),this.target.previewSphere=null)}createController(){const e=this.getGizmoRoot();this._controller=new box_controller_1.default(e),this._controller.setColor(cc_1.Color.GREEN),this._controller.editable=!0,this._controller.edit=!0,this._controller.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onBBControllerMouseUp.bind(this),this.onHide(),this.loadPlane((t,i)=>{this._plane=(0,cc_1.instantiate)(i),this._plane.layer=cc_1.Layers.Enum.IGNORE_RAYCAST|cc_1.Layers.Enum.GIZMOS,this._plane.name=ReflectionProbeGizmo.PLANE_NODE_NAME,this._planeMeshRenderer=this._plane.getComponent(cc_1.MeshRenderer),this._planeMeshRenderer.material=this.generateMaterial({effectName:"builtin-standard",technique:1}),this._planeMeshRenderer.material.setProperty("albedo",(0,cc_1.color)(255,255,255,145)),this._planeMeshRenderer.material.setProperty("metallic",1),this._planeMeshRenderer.material.setProperty("roughness",0),this._planeMeshRenderer.bakeSettings.reflectionProbe=cc_1.ReflectionProbeType.PLANAR_REFLECTION,this._plane.active=!1,this._plane.parent=e,this.loadSphere((t,i)=>{this._sphere=(0,cc_1.instantiate)(i),this._sphere.layer=cc_1.Layers.Enum.IGNORE_RAYCAST|cc_1.Layers.Enum.GIZMOS,this._sphere.name=ReflectionProbeGizmo.SPHERE_NODE_NAME,this._sphereMeshRenderer=this._sphere.getComponent(cc_1.MeshRenderer),this._sphereMeshRenderer.material=this.generateMaterial({effectName:"builtin-reflection-probe-preview",technique:0}),this._sphereMeshRenderer.bakeSettings.reflectionProbe=cc_1.ReflectionProbeType.BAKED_CUBEMAP,this._sphereMeshRenderer.bakeSettings.bakeToReflectionProbe=!1,this._sphere.parent=e,this._isInitialized=!0,this.onShow(),cce.Engine.repaintInEditMode()})})}loadSphere(e){ReflectionProbeGizmo._SPHERE_PREFAB?e(null,ReflectionProbeGizmo._SPHERE_PREFAB):cc_1.assetManager.loadAny("655c9519-1a37-472b-bae6-29fefac0b550",(t,i)=>{i instanceof cc_1.Prefab&&(ReflectionProbeGizmo._SPHERE_PREFAB=i,e(t,i))})}loadPlane(e){ReflectionProbeGizmo._PLANE_PREFAB?e(null,ReflectionProbeGizmo._PLANE_PREFAB):cc_1.assetManager.loadAny("40563723-f8fc-4216-99ea-a81636435c10",(t,i)=>{i instanceof cc_1.Prefab&&(ReflectionProbeGizmo._PLANE_PREFAB=i,e(t,i))})}updateControllerTransform(){this.updateControllerData()}updateControllerData(){var e;if(!this._isInitialized||null==this.target)return;const t=this.node;if(this.target instanceof cc_1.ReflectionProbe){const i=NodeUtils.getWorldPosition3D(t),r=NodeUtils.getWorldRotation(t),o=this.target.probeType===cc_1.renderer.scene.ProbeType.CUBE;this._controller.setScale(cc_1.Vec3.ONE),this._controller.updateSize(cc_1.Vec3.ZERO,cc_1.Vec3.multiplyScalar(tempVec3_a,this.target.size,2)),this._controller.setRotation(o?cc_1.Quat.IDENTITY:r),null===(e=this._controller)||void 0===e||e.setPosition(i),this._sphere&&this._sphereMeshRenderer&&(o?(this._sphere.active=!0,this._sphere.setWorldPosition(i)):this._sphere.active=!1),this._plane&&this._planeMeshRenderer&&(o?this._plane.active=!1:(this._plane.active=!0,this._plane.setWorldPosition(i),this._plane.setRotation(r),this._plane.setScale(this.target.size.x/5,this.target.size.y/5,this.target.size.z/5)))}}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}ReflectionProbeGizmo.SPHERE_NODE_NAME="Reflection Probe Sphere",ReflectionProbeGizmo.PLANE_NODE_NAME="Reflection Probe Plane",exports.default=ReflectionProbeGizmo;