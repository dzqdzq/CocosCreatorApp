"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const gizmo_base_1=__importDefault(require("../gizmo-base")),image_controller_1=__importDefault(require("../controller/image-controller")),cc_1=require("cc"),external_1=__importDefault(require("../../../utils/external")),cc_2=require("cc"),NodeUtils=external_1.default.NodeUtils,Utils=require("../../../utils"),tempQuat_a=new cc_2.Quat;class VideoPlayerGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._videoElem=document.createElement("video"),this._canvasElem=document.createElement("canvas"),this._canvas2D=null,this._image=new Image,this._tex2D=new cc_1.Texture2D,this._curUrl=""}init(){this.createController(),this._videoElem&&(this._videoElem.style.position="absolute",this._videoElem.style.bottom="0px",this._videoElem.style.left="0px",this._videoElem.className="cocosVideo",this._videoElem.hidden=!0,this._videoElem.addEventListener("loadeddata",this.onVideoLoaded.bind(this)),this._canvasElem&&(this._canvas2D=this._canvasElem.getContext("2d")),document.body.append(this._videoElem))}onShow(){this._controller.show(),this.updateController()}onHide(){this._controller.hide()}createController(){let e=this.getGizmoRoot();this._controller=new image_controller_1.default(e,{texture:!0}),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){}onControllerMouseMove(){}onControllerMouseUp(){this.node&&Utils.select(this.node.uuid)}updateControllerData(){var e;if(this._isInited&&this.target&&this._videoElem&&this.target instanceof cc_1.VideoPlayer){let t=this.node.getComponent(cc_2.UITransform);if(t){this.target.keepAspectRatio&&this._videoElem.readyState>0&&t.setContentSize(this._videoElem.videoWidth,this._videoElem.videoHeight);let e=t.contentSize;this._controller.show(),this._controller.updateSize(cc.v3(),cc.v2(e.width,e.height))}let o="";o=this.target.resourceType===cc_1.VideoPlayer.ResourceType.REMOTE?this.target.remoteURL:(null===(e=this.target.clip)||void 0===e?void 0:e.nativeUrl)||"",this.target.enabled?this._controller.show():this._controller.hide(),o?this._curUrl!==o&&this._videoElem&&(this._videoElem.src=o,this._curUrl=o):(this._controller.hide(),this._curUrl=o)}}onVideoLoaded(){var e,t;if(!this._videoElem||!this._canvasElem)return;if(this._canvasElem.width=this._videoElem.videoWidth,this._canvasElem.height=this._videoElem.videoHeight,this.node&&this.target.keepAspectRatio){let e=this.node.getComponent(cc_2.UITransform);null===e||void 0===e||e.setContentSize(this._videoElem.videoWidth,this._videoElem.videoHeight)}null===(e=this._canvas2D)||void 0===e||e.scale(1,-1),null===(t=this._canvas2D)||void 0===t||t.drawImage(this._videoElem,0,0,this._videoElem.videoWidth,-this._videoElem.videoHeight),this._image.src=this._canvasElem.toDataURL();let o=new cc_1.ImageAsset(this._image),i=()=>{this._tex2D.image=o,this._controller.setTexture(this._tex2D),this._controller.show(),cce.Engine.repaintInEditMode()};o.loaded?i():o.once("load",()=>{i()})}updateControllerTransform(){if(!this._isInited||null===this.target)return;let e=this.node,t=NodeUtils.getWorldPosition3D(e);const o=tempQuat_a;NodeUtils.getWorldRotation3D(e,o),this._controller.setPosition(t),this._controller.setRotation(o)}updateController(){this.updateControllerData(),this.updateControllerTransform()}onTargetUpdate(){this.updateController()}onNodeChanged(){this.updateController()}}exports.default=VideoPlayerGizmo;