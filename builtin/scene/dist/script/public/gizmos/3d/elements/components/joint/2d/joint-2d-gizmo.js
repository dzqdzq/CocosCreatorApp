"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const joint_2d_controller_1=require("../../../controller/joint-2d-controller"),gizmo_base_1=__importDefault(require("../../../gizmo-base")),external_1=__importDefault(require("../../../../../utils/external")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,Utils=require("../../../../../utils"),tempVec2_a=new cc_1.Vec2,tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempQuat_a=new cc_1.Quat,tempMat4=new cc_1.Mat4;class Joint2DGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._anchor=new cc_1.Vec2,this._connectedAnchor=new cc_1.Vec2,this._propPath=null,this._anchorColor=new cc_1.Color(16,180,245),this._connectedAnchorColor=new cc_1.Color(207,105,40)}init(){this.createController()}createController(){let t=this.getGizmoRoot();this._anchorController=new joint_2d_controller_1.Joint2DController(t),this._anchorController.editable=!0,this._anchorController.edit=!0,this._anchorController.setColor(this._anchorColor),this._anchorController.onControllerMouseDown=this.onAnchorControllerMouseDown.bind(this),this._anchorController.onControllerMouseMove=this.onAnchorControllerMouseMove.bind(this),this._anchorController.onControllerMouseUp=this.onAnchorControllerMouseUp.bind(this),this._connectedAnchorController=new joint_2d_controller_1.Joint2DController(t),this._connectedAnchorController.editable=!0,this._connectedAnchorController.edit=!0,this._connectedAnchorController.setColor(this._connectedAnchorColor),this._connectedAnchorController.onControllerMouseDown=this.onConnectedAnchorControllerMouseDown.bind(this),this._connectedAnchorController.onControllerMouseMove=this.onConnectedAnchorControllerMouseMove.bind(this),this._connectedAnchorController.onControllerMouseUp=this.onAnchorControllerMouseUp.bind(this)}onShow(){this._anchorController.show(),this.updateControllerData()}onHide(){this._anchorController.hide(),this._connectedAnchorController.hide()}onAnchorControllerMouseDown(){this._anchor.set(this.target.anchor),this._propPath=this.getCompPropPath("anchor")}onAnchorControllerMouseMove(){if(this._anchorController.updated){this.onControlUpdate(this._propPath);let t=this.node,o=this._anchorController.getDeltaPos();tempVec3_a.set(o),t&&(t.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),cc_1.Vec3.transformMat4(tempVec3_a,tempVec3_a,tempMat4)),NodeUtils.makeVec3InPrecision(tempVec3_a,1),this.target.anchor.set(tempVec3_a.x,tempVec3_a.y),this.onComponentChanged(t)}}onAnchorControllerMouseUp(){this.onControlEnd(this._propPath)}onConnectedAnchorControllerMouseDown(){this._isInited&&null!==this.target&&(this._connectedAnchor.set(this.target.connectedAnchor),this._propPath=this.getCompPropPath("connectedAnchor"))}onConnectedAnchorControllerMouseMove(){var t,o;if(this._connectedAnchorController.updated){this.onControlUpdate(this._propPath);let e=this.node,n=this._connectedAnchorController.getDeltaPos();tempVec3_a.set(n);const r=this.target;(null===(t=r.connectedBody)||void 0===t?void 0:t.node)&&(null===(o=r.connectedBody)||void 0===o||o.node.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),cc_1.Vec3.transformMat4(tempVec3_a,tempVec3_a,tempMat4)),NodeUtils.makeVec3InPrecision(tempVec3_a,1),this.target.connectedAnchor.set(tempVec3_a.x,tempVec3_a.y),this.onComponentChanged(e)}}updateControllerData(){this._isInited&&null!==this.target&&this.updateAnchorControllerData()}updateAnchorControllerData(){const t=this.target;let o=t.anchor;tempVec3_a.set(o.x,o.y,0);let e=this.node;e&&e.getWorldMatrix(tempMat4);let n=e.getWorldPosition();if(cc_1.Vec3.transformMat4(tempVec3_a,tempVec3_a,tempMat4),this._anchorController.updatePosition(n,tempVec3_a),t.connectedBody){this._connectedAnchorController.show();let o=t.connectedAnchor;tempVec3_a.set(o.x,o.y,0),t.connectedBody.node.getWorldMatrix(tempMat4),cc_1.Vec3.transformMat4(tempVec3_a,tempVec3_a,tempMat4),n=t.connectedBody.node.getWorldPosition(),this._connectedAnchorController.updatePosition(n,tempVec3_a)}else this._connectedAnchorController.hide()}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=Joint2DGizmo;