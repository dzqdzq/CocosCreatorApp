"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{AttributeName:AttributeName,setNodeOpacity:setNodeOpacity,getModel:getModel,updatePositions:updatePositions,ProjectionType:ProjectionType,FOVAxis:FOVAxis}=require("../../../utils/engine"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),EditorMath=external_1.default.EditorMath,MVec3=EditorMath.MVec3,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,tempVec3=new cc_1.Vec3;class FrustumController extends editable_controller_1.default{constructor(t){super(t),this._aspect=1,this._near=1,this._far=10,this._cameraProjection=1,this._fov=30,this._fovAxis=FOVAxis.VERTICAL,this._orthoHeight=0,this._oriDir=new cc_1.Vec3(0,0,-1),this._deltaWidth=0,this._deltaHeight=0,this._deltaDistance=0,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._frustumNode=null,this._frustumMeshRenderer=null,this._editHandleKeys=[AxisName.x,AxisName.y,AxisName.neg_x,AxisName.neg_y,AxisName.neg_z],this.initShape()}getFarClipSize(t,e,i,s,o,a){let r,l;return t?l=(r=e)*s:a===FOVAxis.VERTICAL?l=(r=Math.tan(EditorMath.deg2rad(i/2))*o)*s:r=(l=Math.tan(EditorMath.deg2rad(i/2))*o)/s,{farHalfHeight:r,farHalfWidth:l}}_updateEditHandle(t){let e=this._handleDataMap[t].topNode,i=axisDirMap[t],s=new cc_1.Vec3;if(MVec3.multiplyScalar(s,this._oriDir,this._far),"neg_z"!==t){let e=this.getFarClipSize(this._cameraProjection===ProjectionType.ORTHO,this._orthoHeight,this._fov,this._aspect,this._far,this._fovAxis);"x"===t||"neg_x"===t?MVec3.multiplyScalar(tempVec3,i,e.farHalfWidth):"y"!==t&&"neg_y"!==t||MVec3.multiplyScalar(tempVec3,i,e.farHalfHeight),s.add(tempVec3)}MVec3.multiply(s,s,this.getScale()),e.setPosition(s)}initShape(){this.createShapeNode("FrustumController"),this._frustumNode=controller_utils_1.default.frustum(this._cameraProjection===ProjectionType.ORTHO,this._orthoHeight,this._fov,this._aspect,this._near,this._far,this._color,{forwardPipeline:!0}),setNodeOpacity(this._frustumNode,150),this._frustumNode.parent=this.shape,this._frustumMeshRenderer=getModel(this._frustumNode),this.hide()}updateSize(t,e,i,s,o,a,r){this._cameraProjection=t,this._orthoHeight=e,this._fov=i,this._aspect=s,this._near=o,this._far=a,this._fovAxis=r;const l=controller_shape_1.default.calcFrustum(this._cameraProjection===ProjectionType.ORTHO,this._orthoHeight,this._fov,this._aspect,this._near,this._far,this._fovAxis===FOVAxis.VERTICAL).positions;updatePositions(this._frustumMeshRenderer,l),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}onMouseDown(t){this._mouseDeltaPos=cc.v2(0,0);let e=new cc_1.Vec3;t.node.getWorldPosition(e),this._curDistScalar=this.getCameraDistScalar(e),this._deltaWidth=0,this._deltaHeight=0,this._deltaDistance=0,this.onControllerMouseDown&&this.onControllerMouseDown(t)}onMouseMove(t){if(this._isMouseDown){this._mouseDeltaPos.x+=t.moveDeltaX,this._mouseDeltaPos.y+=t.moveDeltaY;let e=axisDirMap[t.handleName],i=this.getAlignAxisMoveDistance(this.localToWorldDir(e),this._mouseDeltaPos)*this._curDistScalar;"neg_z"===t.handleName?this._deltaDistance=i:"x"===t.handleName||"neg_x"===t.handleName?this._deltaWidth=i:"y"!==t.handleName&&"neg_y"!==t.handleName||(this._deltaHeight=i),this.onControllerMouseMove&&this.onControllerMouseMove(t)}}onMouseUp(t){this.onControllerMouseUp&&this.onControllerMouseUp(t)}onMouseLeave(t){this.onMouseUp(t)}getDeltaWidth(){return this._deltaWidth}getDeltaHeight(){return this._deltaHeight}getDeltaDistance(){return this._deltaDistance}}exports.default=FrustumController;