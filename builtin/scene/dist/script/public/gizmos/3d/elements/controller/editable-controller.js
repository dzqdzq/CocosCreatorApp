"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{create3DNode:create3DNode,setMeshColor:setMeshColor}=require("../../../utils/engine/index"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),EditorCamera=external_1.default.EditorCamera,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class EditableController extends controller_base_1.default{constructor(e){super(e),this._editable=!1,this._edit=!1,this._editHandlesShape=null,this._defaultEditHandleSize=7,this._hoverColor=cc_1.Color.GREEN,this._editHandleScales={},this._editHandleColor=cc_1.Color.WHITE,this._editHandleKeys=[],EditorCamera.camera.node.on(cc_1.Node.EventType.TRANSFORM_CHANGED,this.onEditorCameraMoved,this)}get editable(){return this._editable}set editable(e){this._editable=e}get edit(){return this._edit}set edit(e){this._editable&&(this._edit=e,!0===this._edit?(this.initEditHandles(),this.showEditHandles()):this.hideEditHandles())}get hoverColor(){return this._hoverColor}set hoverColor(e){this._hoverColor=e}createEditHandleShape(){this._editHandlesShape=create3DNode("EditControllerShape"),this._editHandlesShape.parent=this._rootNode,this._editHandlesShape.setPosition(this.getPosition()),this._editHandlesShape.setRotation(this.getRotation()),this.registerEvents()}setRoot(e){super.setRoot(e),this._editHandlesShape&&(this._editHandlesShape.parent=this._rootNode)}setEditHandlesColor(e){this.editable&&this._editHandlesShape&&this._editHandleKeys.forEach(t=>{const i=this._handleDataMap[t];if(i){const t=[];i.rendererNodes.forEach(i=>{setMeshColor(i,e),t.push(e)}),i.oriColors=t}}),this._editHandleColor=e}showEditHandles(){this._editHandlesShape&&(this._editHandlesShape.active=!0)}hideEditHandles(){this._editHandlesShape&&(this._editHandlesShape.active=!1)}createEditHandle(e,t){const i=this._defaultEditHandleSize,s=controller_utils_1.default.quad(new cc_1.Vec3,i,i,new cc_1.Vec3(0,0,1),t,{unlit:!0,priority:255});return s.name=e,s.parent=this._editHandlesShape,this._editHandleScales[e]=1,this.initHandle(s,e)}initEditHandles(){this._editHandlesShape||(this.createEditHandleShape(),this._editHandleKeys.forEach(e=>{this.createEditHandle(e,this._editHandleColor),this._updateEditHandle(e)}),this.onInitEditHandles&&this.onInitEditHandles())}_updateEditHandle(e){}updateEditHandles(){this._editHandleKeys.forEach(e=>{this._updateEditHandle(e)})}checkEdit(){this.editable?this.edit=!0:this.hideEditHandles()}onHoverIn(e){this.setHandleColor(e.handleName,this.hoverColor)}onHoverOut(e){this.resetHandleColor()}onEditorCameraMoved(){this.adjustEditHandlesSize()}adjustControllerSize(){super.adjustControllerSize(),this.adjustEditHandlesSize()}adjustEditHandlesSize(){this.edit&&this._editHandleKeys.forEach(e=>{const t=this._handleDataMap[e];if(t){const i=t.topNode;i.getWorldPosition(tempVec3);let s=1;s=this.is2D?1/this.scale2D:this.getCameraDistScalar(tempVec3),i.getPosition(tempVec3),this._editHandleScales[e]=s,i.setWorldScale(s,s,s);const a=tempQuat_a;EditorCamera.camera.node.getWorldRotation(a),i.setWorldRotation(a)}})}setPosition(e){super.setPosition(e),this._editHandlesShape&&this._editHandlesShape.setPosition(e)}setRotation(e){super.setRotation(e),this._editHandlesShape&&this._editHandlesShape.setRotation(e)}onShow(){this._editHandlesShape&&(this.registerEvents(),this._editHandlesShape.active=!0)}onHide(){this.unregisterEvents(),this._editHandlesShape&&(this._editHandlesShape.active=!1)}}exports.default=EditableController;