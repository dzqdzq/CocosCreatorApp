"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),operation_1=__importDefault(require("../../../../operation")),NodeUtils=external_1.default.NodeUtils,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,tempVec3_a=new cc_1.Vec3;class ScaleController extends controller_base_1.default{constructor(e){super(e),this._deltaScale=new cc_1.Vec3,this._scaleFactor=125,this._axisSliderNodes={},this._mouseDeltaPos=new cc_1.Vec2,this._cubeDragValue=0,this._moveAxisName="",this._axisDirMap={},this._lockSize=!0,this._axisDirMap.x=axisDirMap.x.clone(),this._axisDirMap.y=axisDirMap.y.clone(),this._axisDirMap.z=axisDirMap.z.clone(),this._axisDirMap.xyz=new cc_1.Vec3(1,1,1),this.initShape()}get scaleFactor(){return this._scaleFactor}get moveAxisName(){return this._moveAxisName}createAxis(e,t,s){const i=controller_utils_1.default.scaleSlider(ScaleController._baseCubeSize,ScaleController._baseAxisLength,t,{priority:1e3});i.name=e+"Slider",i.parent=this.shape,NodeUtils.setEulerAngles(i,s);const o=this._axisDirMap[e];cc_1.Vec3.multiplyScalar(tempVec3_a,o,ScaleController._baseCubeSize/2),i.setPosition(tempVec3_a),this.initHandle(i,e);const l={};l.head=i.getChildByName("ScaleSliderHead"),l.body=i.getChildByName("ScaleSliderBody"),this._axisSliderNodes[e]=l}initShape(){this.createShapeNode("ScaleController"),this.registerEvents(),this._axisSliderNodes={},this.createAxis("x",cc_1.Color.RED,new cc_1.Vec3(-90,-90,0)),this.createAxis("y",cc_1.Color.GREEN,new cc_1.Vec3(0,0,0)),this.createAxis("z",cc_1.Color.BLUE,new cc_1.Vec3(90,0,90));const e=controller_utils_1.default.cube(ScaleController._baseCubeSize,ScaleController._baseCubeSize,ScaleController._baseCubeSize,cc.Color.GRAY,void 0,{priority:1e3});e.name="xyzScale",e.parent=this.shape,this.initHandle(e,"xyz"),this.shape.active=!1}onAxisSliderMove(e,t){for(let s=0;s<e.length;s++){const i=e.charAt(s);if(null===i)return;const o=this._axisSliderNodes[i].head,l=this._axisSliderNodes[i].body,a=ScaleController._baseAxisLength+t,r=a/ScaleController._baseAxisLength;l.setScale(r,1,1),o.setPosition(0,a,0)}}getAlignAxisDeltaScale(e,t){const s=this._axisDirMap[e],i=this.getAlignAxisMoveDistance(this.localToWorldDir(s),t),o=cc.v3(),l=i/this._scaleFactor;return cc_1.Vec3.multiplyScalar(o,s,l),this.onAxisSliderMove(e,i),o}getAllAxisDeltaScale(e,t){let s=0,i=!1;const o=Math.abs(t.x),l=Math.abs(t.y);Math.abs(o-l)/Math.max(o,l)>.1&&o<l&&(i=!0);const a=t.length();s=i?Math.sign(t.y)*a:Math.sign(t.x)*a,this._cubeDragValue+=s;const r=this._cubeDragValue/this._scaleFactor,c=cc.v3(r,r,r);return this.onAxisSliderMove(e,this._cubeDragValue),c}onMouseDown(e){this._deltaScale.set(0,0,0),this._mouseDeltaPos.set(0,0),this._cubeDragValue=0,cc.game.canvas.style.cursor="pointer",this._moveAxisName=e.handleName,this.onAxisSliderMove(e.handleName,0),this.onControllerMouseDown&&this.onControllerMouseDown(e),operation_1.default.requestPointerLock()}onMouseMove(e){if(this._isMouseDown){if(this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY,cc_1.Vec3.set(this._deltaScale,0,0,0),"xyz"===e.handleName?this._deltaScale=this.getAllAxisDeltaScale(e.handleName,cc.v2(e.moveDeltaX,e.moveDeltaY)):this._deltaScale=this.getAlignAxisDeltaScale(e.handleName,this._mouseDeltaPos),this.isLock)return void(this.onControllerMouseMove&&this.onControllerMouseMove(e));this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController()}}onMouseUp(e){cc_1.game.canvas.style.cursor="default",this.onAxisSliderMove(this._moveAxisName,0),this.onControllerMouseUp&&this.onControllerMouseUp(e),operation_1.default.exitPointerLock()}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this.setHandleColor(e.handleName,cc_1.Color.YELLOW)}onHoverOut(){this.resetHandleColor()}getDeltaScale(){return this._deltaScale}onShow(){this.registerEvents(),this.is2D?(this._handleDataMap.z.topNode.active=!1,this.updateController()):this._handleDataMap.z.topNode.active=!0,this.onAxisSliderMove(this._moveAxisName,0)}onHide(){this.unregisterEvents()}}ScaleController._baseCubeSize=12.5,ScaleController._baseAxisLength=70,exports.default=ScaleController;