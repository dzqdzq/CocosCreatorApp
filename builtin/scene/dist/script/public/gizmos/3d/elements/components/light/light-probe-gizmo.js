"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0});const gizmo_base_1=__importDefault(require("../../gizmo-base")),light_probe_controller_1=__importDefault(require("../../controller/light-probe-controller")),cc_1=require("cc");require("../../../../utils/set-util");const light_probe_bounding_box_controller_1=__importDefault(require("../../controller/light-probe-bounding-box-controller")),event_enum_1=require("../../../../../event-enum");class LightProbeGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this.shouldRegisterGizmoOperationEvent=!0,this._minPosPath=null,this._maxPosPath=null,this._isInited=!1}set target(o){super.target=o}get target(){return super.target}init(){this._isInited=!0;const o=this.getGizmoRoot();this.createController(o),cce.Gizmo.registerLightProbeEditModeListener(this)}createController(o){this._lightProbeRoot=new cc_1.Node("LightProbeController"),this._lightProbeRoot.parent=o,this._controller=new light_probe_controller_1.default(this._lightProbeRoot,this,this),this._boundingBoxRoot=new cc_1.Node("LightProbeBoundingBoxController"),this._boundingBoxRoot.parent=o,this._boundingBoxController=new light_probe_bounding_box_controller_1.default(this._boundingBoxRoot,this),this._boundingBoxController.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._boundingBoxController.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._boundingBoxController.onControllerMouseUp=this.onBBControllerMouseUp.bind(this),this._boundingBoxController.hide()}onShow(){this._controller.show(),this._boundingBoxController.editMode&&this._boundingBoxController.show(),this.checkIconGizmoStats()}onHide(){this._controller.hide(),this._boundingBoxController.hide(),this.checkIconGizmoStats()}onNodeChanged(o){this._isInited&&this.checkCurrentTargetPointingSelf()&&(this.updateNodeTransformInfo(this._controller.probeSphere),this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._checkShouldSkipUpdateLightProbeController(o)&&this._controller.updateController(),o.type===event_enum_1.NodeEventType.COMPONENT_CHANGED&&this._boundingBoxController.updateController(),this.checkIconGizmoStats())}checkIconGizmoStats(){this.target&&this.target.iconGizmo&&(this.visible()?this.target.iconGizmo.show():this.target.iconGizmo.hide())}afterPositionGizmoSetPositions(){LightProbeGizmo.debounceUpdateLines&&clearTimeout(LightProbeGizmo.debounceUpdateLines),LightProbeGizmo.debounceUpdateLines=setTimeout(()=>{this.target.onProbeChanged(!1,!1),this._controller.updateLines(!1),this._controller.adjustControllerSize(),cce.Engine.repaintInEditMode(),LightProbeGizmo.debounceUpdateLines=null},0)}_checkShouldSkipUpdateLightProbeController(o){var e;switch(null===o||void 0===o?void 0:o.type){case event_enum_1.NodeEventType.TRANSFORM_CHANGED:return this.afterPositionGizmoSetPositions(),LightProbeGizmo.debounceUpdateController&&clearTimeout(LightProbeGizmo.debounceUpdateController),LightProbeGizmo.debounceUpdateController=setTimeout(()=>{this._controller.updateController(),this._controller.adjustControllerSize(),LightProbeGizmo.debounceUpdateController=null},250),!1;case event_enum_1.NodeOperationType.SET_PROPERTY:return(null===(e=o.propPath)||void 0===e?void 0:e.includes("__comps__."))?(this.target.onProbeChanged(!0,!0),!0):(this.afterPositionGizmoSetPositions(),!1);case event_enum_1.NodeOperationType.RESET_COMPONENT:return this.target.onProbeChanged(!0,!0),!0;case event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED:return!0;case event_enum_1.NodeOperationType.CREATE_COMPONENT:case event_enum_1.NodeEventType.NOTIFY_NODE_CHANGED:}return(null===o||void 0===o?void 0:o.source)===event_enum_1.EventSourceType.UNDO&&(this.target.onProbeChanged(!0,!0),!0)}onTargetUpdate(){var o;null===(o=super.onTargetUpdate)||void 0===o||o.call(this),this._isInited&&(this._originTarget&&this.target===this._originTarget||(this._originTarget=this.target,this.updateNodeTransformInfo(this._controller.probeSphere),this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._controller.updateController(),this._boundingBoxController.updateController(),this.checkIconGizmoStats()))}onBBControllerMouseDown(o){this._isInited&&null!=this.target&&(this._minPosPath=this.getCompPropPath("minPos"),this._maxPosPath=this.getCompPropPath("maxPos"))}onBBControllerMouseMove(o){this.onControlUpdate(this._minPosPath),this.onControlUpdate(this._maxPosPath),this._boundingBoxController.updateDataFromBBController(o),this.onComponentChanged(this.node)}onBBControllerMouseUp(o){this.onControlEnd(this._minPosPath),this.onControlEnd(this._maxPosPath)}updateNodeTransformInfo(o){this.checkCurrentTargetPointingSelf()&&o.setWorldPosition(this.target.node.worldPosition)}get currentTransformTool(){return cce.Gizmo.getGizmoToolByName(cce.Gizmo.transformToolName)}updateCurrentTransformToolVisible(o){o?this.currentTransformTool.hide():this.currentTransformTool.show()}lightProbeEditModeChanged(o){o&&!this.checkCurrentTargetPointingSelf()||(this.updateCurrentTransformToolVisible(o),this._controller.lightProbeEditModeChanged(o),this.checkIconGizmoStats())}lightProbeInfoChanged(){this._controller.lightProbeInfoChanged()}boundingBoxEditModeChanged(o){o&&!this.checkCurrentTargetPointingSelf()||(this.updateCurrentTransformToolVisible(o),this._controller.boundingBoxEditModeChanged(o),this._boundingBoxRoot&&this.updateNodeTransformInfo(this._boundingBoxRoot),this._boundingBoxController.boundingBoxEditModeChanged(o),this.checkIconGizmoStats())}checkCurrentTargetPointingSelf(){if(!this.target)return!1;if(!this.target.node)return!1;const o=this.target.node.getComponent(cc_1.LightProbeGroup);return!!o&&(null===o||void 0===o?void 0:o.gizmo)===this}duplicateCurrentSelectedProbes(){return this._controller.duplicateCurrentSelectedProbes()}deleteCurrentSelectedProbes(){return this._controller.deleteCurrentSelectedProbes()}select(o){this._controller.select(o)}selectAll(){this._controller.selectAll()}unselect(o){this._controller.unselect(o)}unselectAll(){this._controller.unselectAll()}onNotGizmoMouseDown(o){this._controller.onNotGizmoMouseDown(o)}onNotGizmoMouseMove(o){this._controller.onNotGizmoMouseMove(o)}onNotGizmoMouseUp(o){this._controller.onNotGizmoMouseUp(o)}shouldEmitNodes(){return this._controller.shouldEmitNodes()}currentSelectedNodes(){return this._controller.currentSelectedNodes()}}exports.default=LightProbeGizmo,LightProbeGizmo.debounceUpdateController=null,LightProbeGizmo.debounceUpdateLines=null;