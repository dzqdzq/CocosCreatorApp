"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Joint2DControllerType=exports.Joint2DController=void 0;const controller_utils_1=__importDefault(require("../utils/controller-utils")),controller_shape_1=__importDefault(require("../utils/controller-shape")),cc_1=require("cc"),editable_controller_1=__importDefault(require("./editable-controller")),{updateVBAttr:updateVBAttr,getModel:getModel,updatePositions:updatePositions,setMeshColor:setMeshColor,setNodeOpacity:setNodeOpacity,getNodeOpacity:getNodeOpacity,panPlaneLayer:panPlaneLayer,updateBoundingBox:updateBoundingBox}=require("../../../utils/engine"),tempVec3_a=new cc_1.Vec3;var Joint2DControllerType;!function(e){e[e.Revolute=0]="Revolute",e[e.Distance=1]="Distance",e[e.Fixed=2]="Fixed",e[e.Hinge=3]="Hinge",e[e.Slider=4]="Slider",e[e.Spring=5]="Spring",e[e.Wheel=6]="Wheel"}(Joint2DControllerType||(Joint2DControllerType={})),exports.Joint2DControllerType=Joint2DControllerType;class Joint2DController extends editable_controller_1.default{constructor(e,t){super(e),this._lineNode=null,this._lineMR=null,this._anchor=new cc_1.Vec3,this._panPlane=null,this._mouseDownOnPlanePos=new cc_1.Vec3,this._deltaPos=new cc_1.Vec3,this._type=Joint2DControllerType.Revolute,this._center=new cc_1.Vec3,this._editHandleColor=cc_1.Color.BLUE,this._hoverColor=cc_1.Color.YELLOW,this._editHandleKeys=["Head"],t&&(this._type=t),this.initShape()}setColor(e){this.setEditHandlesColor(e),setMeshColor(this._lineNode,e)}createEditHandle(e,t){const o=this.createHeadNode(this._anchor,e,t);return setNodeOpacity(o,80),o.parent=this._editHandlesShape,this._editHandleScales[e]=1,this.initHandle(o,e)}createHeadNode(e,t,o){const n=controller_shape_1.default.calcDiscData(e,cc_1.Vec3.UNIT_Z,10),i=controller_utils_1.default.createShapeByData(n,o,{unlit:!0});i.name=t;const l=controller_shape_1.default.calcCircleData(cc_1.Vec3.ZERO,cc_1.Vec3.UNIT_Z,10);controller_utils_1.default.createShapeByData(l,o,{unlit:!0}).parent=i;const s=controller_shape_1.default.calcDiscData(e,cc_1.Vec3.UNIT_Z,3);return controller_utils_1.default.createShapeByData(s,o,{unlit:!0}).parent=i,i}createLineNode(e,t,o,n){const i=controller_shape_1.default.calcLineData(e,t),l=controller_utils_1.default.createShapeByData(i,n,{unlit:!0,dashed:!0});return l.name=o,l.parent=this.shape,l}initShape(){this.createShapeNode("Joint2DController");const e=controller_utils_1.default.quad(new cc_1.Vec3,1e5,1e5);e.parent=this._rootNode,e.name="JointPanPlane",e.active=!1,e.layer=panPlaneLayer,setNodeOpacity(e,0),this._panPlane=e,this._lineNode=this.createLineNode(this._center,this._anchor,"JointLine",cc_1.Color.BLUE),this._lineMR=getModel(this._lineNode)}_updateEditHandle(e){const t=this._handleDataMap[e].topNode,o=this._editHandleScales[e];t.setScale(o/this.getScale().x,o/this.getScale().y,o/this.getScale().z),tempVec3_a.set(this._anchor),cc_1.Vec3.multiply(tempVec3_a,tempVec3_a,this.getScale()),t.setPosition(tempVec3_a)}updatePosition(e,t){this._center.set(e),this._anchor.set(t);const o=controller_shape_1.default.calcLineData(this._center,this._anchor),n=[];n[0]=0,n[1]=cc_1.Vec3.distance(this._center,this._anchor),updatePositions(this._lineMR,o.positions),updateVBAttr(this._lineMR,"a_lineDistance",n),updatePositions(this._lineMR,o.positions),updateBoundingBox(this._lineMR,o.minPos,o.maxPos),this._edit&&this.updateEditHandles(),this.adjustControllerSize()}onMouseDown(e){this.edit&&(cc_1.Vec3.set(this._deltaPos,0,0,0),this._panPlane.active=!0,this._mouseDownOnPlanePos=new cc_1.Vec3,this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._panPlane),this.onControllerMouseDown&&this.onControllerMouseDown(e))}onMouseMove(e){if(this.edit&&this._isMouseDown){const t=new cc_1.Vec3;this.getPositionOnPanPlane(t,e.x,e.y,this._panPlane)&&(this._deltaPos=t),this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this._panPlane.active=!1,this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){super.onHoverIn(e),this.onControllerHoverIn&&this.onControllerHoverIn(e)}onHoverOut(e){super.onHoverOut(e),this.onControllerHoverOut&&this.onControllerHoverOut(e)}getDeltaPos(){return this._deltaPos}}exports.Joint2DController=Joint2DController;