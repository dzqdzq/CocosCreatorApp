"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{AttributeName:AttributeName,getModel:getModel,updatePositions:updatePositions,setMeshColor:setMeshColor,setNodeOpacity:setNodeOpacity,updateBoundingBox:updateBoundingBox}=require("../../../utils/engine"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),EditorCamera=external_1.default.EditorCamera,EditorMath=external_1.default.EditorMath,MVec3=EditorMath.MVec3,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName;class BoxController extends editable_controller_1.default{constructor(e){super(e),this._center=new cc_1.Vec3,this._size=new cc_1.Vec3(1,1,1),this._deltaSize=new cc_1.Vec3,this._wireframeBoxNode=null,this._wireframeBoxMeshRenderer=null,this._planeIndicatorNode=null,this._planeIndicatorMR=null,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._curHoverAxis=null,this._editHandleKeys=Object.keys(axisDirMap),this.initShape()}setColor(e){this._wireframeBoxNode&&(this._color=e,setMeshColor(this._wireframeBoxNode,e),this.setEditHandlesColor(e))}setOpacity(e){this._wireframeBoxNode&&setNodeOpacity(this._wireframeBoxNode,e)}_updateEditHandle(e){let t=this._handleDataMap[e].topNode,i=axisDirMap[e],s=new cc_1.Vec3;MVec3.multiply(s,i,this._size),MVec3.multiplyScalar(s,s,.5);let o=new cc_1.Vec3(s);o.add(this._center);let a=this._editHandleScales[e],r=this.getScale();t.setScale(a/r.x,a/r.y,a/r.z),MVec3.multiply(o,o,r),t.setPosition(o)}initShape(){this.createShapeNode("BoxController"),this._wireframeBoxNode=controller_utils_1.default.wireframeBox(this._center,this._size,this._color,{forwardPipeline:!0}),this._wireframeBoxNode.parent=this.shape,this._wireframeBoxMeshRenderer=getModel(this._wireframeBoxNode),this._planeIndicatorNode=controller_utils_1.default.quad(this._center,1,1,MVec3.UNIT_Y,cc_1.Color.YELLOW,{unlit:!0}),this._planeIndicatorNode.parent=this.shape,setNodeOpacity(this._planeIndicatorNode,80),this._planeIndicatorMR=getModel(this._planeIndicatorNode),updateBoundingBox(this._planeIndicatorMR,MVec3.ZERO,MVec3.ZERO),this._planeIndicatorNode.active=!1,this.hide(),EditorCamera._camera.node.on("transform-changed",this.onEditorCameraMoved,this)}updateSize(e,t){this._center=e,this._size=t;let i=controller_shape_1.default.calcBoxPoints(this._center,this._size);updatePositions(this._wireframeBoxMeshRenderer,i),this._planeIndicatorNode.active&&this._curHoverAxis&&this._updatePlaneIndicatorPos(this._curHoverAxis),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}onMouseDown(e){this._mouseDeltaPos=cc.v2(0,0),this._curDistScalar=super.getDistScalar(),MVec3.set(this._deltaSize,0,0,0),this.onControllerMouseDown&&this.onControllerMouseDown(e)}onMouseMove(e){if(this._isMouseDown){this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY;let t=axisDirMap[e.handleName],i=this.getAlignAxisMoveDistance(this.localToWorldDir(t),this._mouseDeltaPos)*this._curDistScalar;e.handleName===AxisName.x||e.handleName===AxisName.neg_x?this._deltaSize.x=i:e.handleName===AxisName.y||e.handleName===AxisName.neg_y?this._deltaSize.y=i:e.handleName!==AxisName.z&&e.handleName!==AxisName.neg_z||(this._deltaSize.z=i),this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}_updatePlaneIndicatorPos(e){let t=null,i=axisDirMap[e],s=new cc_1.Vec3;0!==i.x?(MVec3.add(s,this._center,new cc_1.Vec3(this._size.x*i.x/2,0,0)),t=controller_shape_1.default.calcQuadData(s,this._size.z,this._size.y,i)):0!==i.y?(MVec3.add(s,this._center,new cc_1.Vec3(0,this._size.y*i.y/2,0)),t=controller_shape_1.default.calcQuadData(s,this._size.x,this._size.z,i)):0!==i.z&&(MVec3.add(s,this._center,new cc_1.Vec3(0,0,this._size.z*i.z/2)),t=controller_shape_1.default.calcQuadData(s,this._size.x,this._size.y,i)),updatePositions(this._planeIndicatorMR,t.positions)}onHoverIn(e){this.setHandleColor(e.handleName,controller_utils_1.default.YELLOW),this._updatePlaneIndicatorPos(e.handleName),this._curHoverAxis=e.handleName,this._planeIndicatorNode.active=!0}onHoverOut(){this.resetHandleColor(),this._curHoverAxis=null,this._planeIndicatorNode.active=!1}getDeltaSize(){return this._deltaSize}}exports.default=BoxController;