"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{AttributeName:AttributeName,setMeshColor:setMeshColor,getModel:getModel,updatePositions:updatePositions}=require("../../../utils/engine"),cc_1=require("cc");let tempVec3=new cc_1.Vec3;class ParticleSystemConeController extends editable_controller_1.default{constructor(t){super(t),this._oriDir=new cc_1.Vec3(0,0,-1),this._center=new cc_1.Vec3,this._radius=100,this._height=100,this._bottomRadius=120,this._deltaRadius=0,this._deltaHeight=0,this._deltaBottomRadius=0,this._coneLineNode=null,this._circleNode=null,this._bottomCircleNode=null,this._circleFromDir=new cc_1.Vec3(1,0,0),this._coneLineMR=null,this._circleMR=null,this._bottomCircleMR=null,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._axisDir={},this._axisDir.x=new cc_1.Vec3(1,0,0),this._axisDir.y=new cc_1.Vec3(0,1,0),this._axisDir.neg_x=new cc_1.Vec3(-1,0,0),this._axisDir.neg_y=new cc_1.Vec3(0,-1,0),this._axisDir.bottom_x=new cc_1.Vec3(1,0,0),this._axisDir.bottom_y=new cc_1.Vec3(0,1,0),this._axisDir.bottom_neg_x=new cc_1.Vec3(-1,0,0),this._axisDir.bottom_neg_y=new cc_1.Vec3(0,-1,0),this._axisDir.bottom_neg_z=new cc_1.Vec3(0,0,-1),this._editHandleKeys=Object.keys(this._axisDir),this.initShape()}get radius(){return this._radius}set radius(t){this.updateSize(this._center,t,this._height,this._bottomRadius)}get height(){return this._height}set height(t){this.updateSize(this._center,this._radius,t,this._bottomRadius)}setColor(t){setMeshColor(this._coneLineNode,t),setMeshColor(this._circleNode,t),setMeshColor(this._bottomCircleNode,t),this.setEditHandlesColor(t),this._color=t}_updateEditHandle(t){let e=this._handleDataMap[t].topNode,i=this._axisDir[t],s=new cc_1.Vec3;"bottom"===t.substr(0,6)?(cc_1.Vec3.multiplyScalar(s,this._oriDir,this._height),"bottom_neg_z"!==t&&(cc_1.Vec3.multiplyScalar(tempVec3,i,this._bottomRadius),s.add(tempVec3))):(cc_1.Vec3.multiplyScalar(tempVec3,i,this._radius),s.add(tempVec3));let o=new cc_1.Vec3(s);o.add(this._center),cc_1.Vec3.multiply(o,o,this.getScale()),e.setPosition(o)}initShape(){this.createShapeNode("ConeController");let t=this.getConeLineData(),e=controller_utils_1.default.lines(t.vertices,t.indices,this._color);e.parent=this.shape,this._coneLineNode=e,this._coneLineMR=getModel(e);let i=controller_utils_1.default.arc(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius,this._color);i.parent=this.shape,this._circleNode=i,this._circleMR=getModel(i);let s=controller_utils_1.default.arc(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius,this._color);s.parent=this.shape;let o=new cc_1.Vec3;cc_1.Vec3.multiplyScalar(o,this._oriDir,this._height),s.setPosition(o.x,o.y,o.z),this._bottomCircleNode=s,this._bottomCircleMR=getModel(s),this.hide()}getConeLineData(){let t=[],e=[],i=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius,5);i=i.slice(0,i.length-1);let s=new cc_1.Vec3;cc_1.Vec3.multiplyScalar(s,this._oriDir,this._height);let o=new cc_1.Vec3;cc_1.Vec3.add(o,this._center,s);let r=controller_shape_1.default.calcArcPoints(o,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius,5);r=r.slice(0,r.length-1);for(let s=0;s<i.length;s++){t.push(i[s]),t.push(r[s]);let o=2*s;e.push(o,o+1)}return{vertices:t,indices:e}}updateSize(t,e,i,s){this._center=t,this._radius=e,this._height=i,this._bottomRadius=s;let o=this.getConeLineData();updatePositions(this._coneLineMR,o.vertices);let r=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius);updatePositions(this._circleMR,r);let l=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._bottomRadius);updatePositions(this._bottomCircleMR,l);let c=new cc_1.Vec3;cc_1.Vec3.multiplyScalar(c,this._oriDir,this._height),this._bottomCircleNode.setPosition(c.x,c.y,c.z),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}onMouseDown(t){this._mouseDeltaPos=new cc_1.Vec2(0,0),this._curDistScalar=super.getDistScalar(),this._deltaRadius=0,this._deltaHeight=0,this._deltaBottomRadius=0,this.onControllerMouseDown&&this.onControllerMouseDown(t)}onMouseMove(t){if(this._isMouseDown){this._mouseDeltaPos.x+=t.moveDeltaX,this._mouseDeltaPos.y+=t.moveDeltaY;let e=this._axisDir[t.handleName],i=this.getAlignAxisMoveDistance(this.localToWorldDir(e),this._mouseDeltaPos)*this._curDistScalar;"bottom_neg_z"===t.handleName?this._deltaHeight=i:"bottom"===t.handleName.substr(0,6)?this._deltaBottomRadius=i:this._deltaRadius=i,this.onControllerMouseMove&&this.onControllerMouseMove(t)}}onMouseUp(t){this.onControllerMouseUp&&this.onControllerMouseUp(t)}onMouseLeave(t){this.onMouseUp(t)}getDeltaRadius(){return this._deltaRadius}getDeltaHeight(){return this._deltaHeight}getDeltaBottomRadius(){return this._deltaBottomRadius}}exports.default=ParticleSystemConeController;