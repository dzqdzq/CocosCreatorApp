"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=__importDefault(require("../../utils")),event_enum_1=require("../../../event-enum"),external_1=__importDefault(require("../../utils/external")),EditorCamera=external_1.default.EditorCamera;class GizmoBase{constructor(t){this._hovering=!1,this._selecting=!1,this._editing=!1,this._isInitialized=!1,this._hidden=!0,this._target=null,this._rootNode=null,this._isControlBegin=!1,this._recorded=!1,this.shouldRegisterGizmoOperationEvent=!1,this.undoID="",this.target=t}isNodeLocked(t){return!1}get target(){return this._target}get hidden(){return this._hidden}set target(t){let e=this.nodes;this._target=t,(e=this.nodes)&&e.length>0?this.onTargetUpdate&&this.onTargetUpdate():this.hide()}layer(){return"scene"}getGizmoRoot(){return this._rootNode||(this._rootNode=utils_1.default.getGizmoRoot()),this._rootNode}onControlBegin(t){this._isControlBegin=!0,this.recordChanges(),this.nodes.forEach(e=>{utils_1.default.emitNodeMessage("gizmo-control-begin",e,{propPath:t}),utils_1.default.broadcastMessage("scene:gizmo-control-begin",e.uuid,{propPath:t})})}onControlUpdate(t){this._isControlBegin||this.onControlBegin(t)}onControlEnd(t){this._isControlBegin=!1,this.commitChanges(),this.nodes.forEach(e=>{utils_1.default.emitNodeMessage("gizmo-control-end",e,{propPath:t}),utils_1.default.broadcastMessage("scene:gizmo-control-end",e.uuid,{propPath:t})})}recordChanges(){this._recorded||(this.undoID=utils_1.default.recordChanges(this.nodes.map(t=>t.uuid)),this._recorded=!0)}commitChanges(){this._recorded=!1,""!==this.undoID&&utils_1.default.commitChanges(this.undoID),this.undoID=""}_checkLockStatus(){return this.node.objFlags&cc.Object.Flags.LockedInEditor}targetValid(){let t=this.target;return Array.isArray(t)&&(t=t[0]),t&&t.isValid}visible(){return!this._hidden}hide(){this._hidden||(this.onHide&&this.onHide(),this._hidden=!0)}destroy(){this.onDestroy&&this.onDestroy(),this.hide(),this._target=null}show(){this._hidden&&(this._isInitialized||(this.init&&this.init(),this._isInitialized=!0),this.onShow&&this.onShow(),this._hidden=!1)}update(t){this.onUpdate&&this.onUpdate(t)}get node(){let t=this.target;return Array.isArray(t)&&(t=t[0]),cc.Node.isNode(t)?t:t instanceof cc.Component?t.node:null}get nodes(){const t=[],e=this.target;if(Array.isArray(e))for(let i=0;i<e.length;++i){const o=e[i];cc.Node.isNode(o)?t.push(o):o instanceof cc.Component&&t.push(o.node)}else cc.Node.isNode(e)?t.push(e):e instanceof cc.Component&&t.push(e.node);return t}get topNodes(){return this.target.filter(t=>{if(this.isNodeLocked(t))return!1;let e=t.parent;for(;e;){if(this.target.includes(e)&&!this.isNodeLocked(e))return!1;e=e.parent}return!0})}getCompPropPath(t){const e=this.node,i=this.target;if(e&&i){return"_components."+e._components.indexOf(i)+"."+t}return null}onComponentChanged(t){utils_1.default.onNodeChanged(t,{type:event_enum_1.NodeEventType.COMPONENT_CHANGED})}onEditorCameraMoved(){}registerCameraMovedEvent(){EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}unregisterCameraMoveEvent(){EditorCamera.camera.node.off("transform-changed",this.onEditorCameraMoved,this)}}exports.default=GizmoBase;