"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PolygonController=void 0;const cc_1=require("cc"),editable_controller_1=__importDefault(require("./editable-controller")),controller_utils_1=__importDefault(require("../utils/controller-utils")),controller_shape_1=__importDefault(require("../utils/controller-shape")),engine_1=__importDefault(require("../../../utils/engine")),_2d_misc_1=require("cc/editor/2d-misc"),{AttributeName:AttributeName,getModel:getModel,updatePositions:updatePositions,updateIB:updateIB,setMeshColor:setMeshColor,setNodeOpacity:setNodeOpacity,getNodeOpacity:getNodeOpacity,panPlaneLayer:panPlaneLayer,updateBoundingBox:updateBoundingBox,create3DNode:create3DNode}=engine_1.default;var PolygonHandleType;!function(e){e.None="none",e.Point="point",e.Line="line",e.Area="area"}(PolygonHandleType||(PolygonHandleType={}));const flat=(e,t)=>e.map(t).reduce((e,t)=>e.concat(t),[]),tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3;class PolygonController extends editable_controller_1.default{get points(){return this._points}constructor(e){super(e),this._panPlane=null,this._points=[],this._mouseDownOnPlanePos=new cc_1.Vec3,this._curHandleData={type:PolygonHandleType.None,deltaPos:new cc_1.Vec3,index:-1},this._lineGroup=null,this._pointsHandleData=[],this._linesHandleData=[],this._hitPoint=null,this._areaNode=null,this._areaMR=null,this._areaOpacity=80,this._panSize=1e5,this._hoverColor=cc_1.Color.YELLOW,this.initShape()}initShape(){this.createShapeNode("PolygonController"),this._lineGroup=create3DNode("LineGroup"),this._lineGroup.parent=this.shape}onInitEditHandles(){const e=controller_utils_1.default.quad(new cc_1.Vec3,this._panSize,this._panSize);e.parent=this._rootNode,e.name="RectPanPlane",e.active=!1,e.layer=panPlaneLayer,setNodeOpacity(e,0),this._panPlane=e,this.createPolygonAreaHandle()}showEditHandles(){super.showEditHandles(),this._areaNode&&(this._areaNode.active=!0)}hideEditHandles(){super.hideEditHandles(),this._areaNode&&(this._areaNode.active=!1)}createPolygonAreaHandle(){const e=controller_shape_1.default.calcPolygonData(this._points),t=controller_utils_1.default.createShapeByData(e,this._color,{unlit:!0});t.name="RectArea",t.parent=this.shape,t.setPosition(new cc_1.Vec3(0,0,-.1)),setNodeOpacity(t,this._areaOpacity),this._areaNode=t,this._areaMR=getModel(t),this.initHandle(t,PolygonHandleType.Area)}setColor(e){this._lineGroup&&(this._color=e,this._lineGroup.children.forEach(t=>{setMeshColor(t,e)}))}updateData(e){this.updatePanRectByPoints(e),this.resetEditHandlesFromPoints(e)}updatePanRectByPoints(e){if(!this._panPlane)return;const t=getModel(this._panPlane);if(!t)return;let a=0,n=0;e.forEach(e=>{a=Math.max(a,e.x),n=Math.max(n,e.y)});const o=2*(a>n?a:n)+100,i=controller_shape_1.default.calcPositionData(new cc_1.Vec3,o,o,new cc_1.Vec3(0,0,1),!0);updatePositions(t,i.positions),updateBoundingBox(t,i.minPos,i.maxPos)}resetEditHandlesFromPoints(e){if(this._points=e,this._editHandlesShape){if(this._editHandleKeys=[],this._points.forEach((e,t)=>{this._editHandleKeys.push("p"+t)}),this._points.length>this._pointsHandleData.length){for(let e=this._pointsHandleData.length;e<this._points.length;e++){const t=this.createEditHandle(this._editHandleKeys[e],this._editHandleColor);t.customData={},t.customData.index=e,this._pointsHandleData.push(t)}}else if(this._points.length<this._pointsHandleData.length){for(let e=this._pointsHandleData.length-1;e>=this._points.length;e--)this._editHandlesShape.removeChild(this._pointsHandleData[e].topNode),this.removeHandle("p"+e);this._pointsHandleData.length=this._points.length}this._editHandleKeys.forEach(e=>{this._updateEditHandle(e)}),this.adjustEditHandlesSize()}if(this._lineGroup){if(this._points.length<2&&(this._lineGroup.removeAllChildren(),this._linesHandleData.forEach(e=>{this.removeHandle(e.name)}),this._linesHandleData=[]),this._points.length>this._linesHandleData.length){for(let e=this._linesHandleData.length;e<this._points.length;e++){const t=e===this._points.length-1?0:e+1,a=this._points[e],n=this._points[t],o=this.createLineHandle(a,n,e);o.customData={},o.customData.index=e,o.customData.lineMR=getModel(o.topNode),this._linesHandleData.push(o)}}else if(this._points.length<this._linesHandleData.length){for(let e=this._linesHandleData.length-1;e>=this._points.length;e--)this._lineGroup.removeChild(this._linesHandleData[e].topNode),this.removeHandle("l"+e);this._linesHandleData.length=this._points.length}this._updateLinesHandle()}if(this._areaNode){const e=controller_shape_1.default.calcPolygonData(this._points);updatePositions(this._areaMR,e.positions);const t=flat(e.positions,e=>[e.x,e.y,e.z]),a=(0,_2d_misc_1.earcut)(t,[],3);updateIB(this._areaMR,a),updateBoundingBox(this._areaMR,e.minPos,e.maxPos)}}createLineHandle(e,t,a){const n=controller_utils_1.default.lineTo(e,t,this._color,{unlit:!0});return n.parent=this._lineGroup,this.initHandle(n,"l"+a)}_updateLinesHandle(){this._linesHandleData.forEach((e,t)=>{const a=t===this._points.length-1?0:t+1,n=this._points[t],o=this._points[a],i=controller_shape_1.default.calcLineData(n,o);updatePositions(e.customData.lineMR,i.positions),updateBoundingBox(e.customData.lineMR,i.minPos,i.maxPos)})}_updateEditHandle(e){if(e){const t=this._handleDataMap[e],a=t.topNode,n=t.customData.index,o=this._points[n];tempVec3_a.set(o);const i=this.getScale(),s=this._editHandleScales[e];a.setScale(s/i.x,s/i.y,s/i.z),cc_1.Vec3.multiply(tempVec3_a,tempVec3_a,i),a.setPosition(tempVec3_a)}}onMouseDown(e){if(this.edit){if("l"===e.handleName.charAt(0)){this._curHandleData.type=PolygonHandleType.Line,this._curHandleData.hitPos=e.hitPoint;const t=this._handleDataMap[e.handleName];this._curHandleData.index=t.customData.index}else if("p"===e.handleName.charAt(0)){this._curHandleData.type=PolygonHandleType.Point,this._curHandleData.hitPos=e.hitPoint;const t=this._handleDataMap[e.handleName];this._curHandleData.index=t.customData.index}else e.handleName===PolygonHandleType.Area&&(this._curHandleData.type=PolygonHandleType.Area,this._curHandleData.deltaPos=new cc_1.Vec3);this._panPlane.active=!0,this._mouseDownOnPlanePos=new cc_1.Vec3,this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._panPlane),this.onControllerMouseDown&&this.onControllerMouseDown(e)}}onMouseMove(e){if(this.edit){if(this._isMouseDown&&"l"!==e.handleName.charAt(0)){const t=new cc_1.Vec3;if(this.getPositionOnPanPlane(t,e.x,e.y,this._panPlane))if("p"===e.handleName.charAt(0)){const a=new cc_1.Vec3(t);a.subtract(this._mouseDownOnPlanePos),this._curHandleData.type=PolygonHandleType.Point,this._curHandleData.deltaPos=a,this._curHandleData.index=this._handleDataMap[e.handleName].customData.index}else if(e.handleName===PolygonHandleType.Area){const e=new cc_1.Vec3(t);e.subtract(this._mouseDownOnPlanePos),this._curHandleData.type=PolygonHandleType.Area,this._curHandleData.deltaPos=e}}this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this.edit&&(this._hitPoint=null,this._panPlane.active=!1,this._curHandleData.type=PolygonHandleType.None,this._curHandleData.deltaPos=new cc_1.Vec3,this.onControllerMouseUp&&this.onControllerMouseUp(e))}onHoverIn(e){if(this.edit){if("p"===e.handleName.charAt(0)||"l"===e.handleName.charAt(0)){const t=this._handleDataMap[e.handleName];e.customData={index:t.customData.index},this.setHandleColor(e.handleName,this._hoverColor)}else if(e.handleName===PolygonHandleType.Area){const t=getNodeOpacity(this._areaNode);t>0&&this.setHandleColor(e.handleName,this._hoverColor,t)}this.onControllerHoverIn&&this.onControllerHoverIn(e)}}onHoverOut(e){super.onHoverOut(e),this.onControllerHoverOut&&this.onControllerHoverOut(e)}getHitPoint(){return this._hitPoint}getHandleData(){return this._curHandleData}}exports.PolygonController=PolygonController,PolygonController.PolygonHandleType=PolygonHandleType;