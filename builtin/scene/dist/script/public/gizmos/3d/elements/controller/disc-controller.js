"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),cc_1=require("cc"),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),engine_1=__importDefault(require("../../../utils/engine")),external_1=__importDefault(require("../../../utils/external")),{AttributeName:AttributeName,setMeshColor:setMeshColor,setNodeOpacity:setNodeOpacity,getNodeOpacity:getNodeOpacity,getModel:getModel,updatePositions:updatePositions,panPlaneLayer:panPlaneLayer,updateBoundingBox:updateBoundingBox}=engine_1.default,EditorMath=external_1.default.EditorMath,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,tempVec3=new cc_1.Vec3,tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3;var DiscHandleType;!function(e){e.None="none",e.Left="neg_x",e.Right="x",e.Top="y",e.Bottom="neg_y",e.Area="area"}(DiscHandleType||(DiscHandleType={}));class DiscController extends editable_controller_1.default{constructor(e){super(e),this._oriDir=new cc_1.Vec3(0,0,-1),this._center=new cc_1.Vec3,this._radius=100,this._arc=360,this._deltaRadius=0,this._deltaPos=new cc_1.Vec3,this._circleNode=null,this._circleFromDir=new cc_1.Vec3(1,0,0),this._circleMR=null,this._panPlane=null,this._areaMR=null,this._areaColor=cc_1.Color.GREEN,this._areaOpacity=0,this._mouseDeltaPos=new cc_1.Vec2,this._mouseDownOnPlanePos=new cc_1.Vec3,this._curDistScalar=0,this._controlDir=new cc_1.Vec3,this._curHandleType=DiscHandleType.None,this._editHandleKeys=[AxisName.x,AxisName.y,AxisName.neg_x,AxisName.neg_y],this.initShape()}get radius(){return this._radius}set radius(e){this.updateSize(this._center,e,this._arc)}setColor(e){setMeshColor(this._circleNode,e),this.setEditHandlesColor(e),this._color=e}setAreaColor(e){this._areaColor=e,this._areaNode&&setMeshColor(this._areaNode,e)}setAreaOpacity(e){this._areaOpacity=e,this._areaNode&&setNodeOpacity(this._areaNode,e)}showEditHandles(){super.showEditHandles(),this._areaNode&&(this._areaNode.active=!0)}hideEditHandles(){super.hideEditHandles(),this._areaNode&&(this._areaNode.active=!1)}isBorder(e){return e===DiscHandleType.Left||e===DiscHandleType.Right||e===DiscHandleType.Top||e===DiscHandleType.Bottom}initShape(){this.createShapeNode("CircleController");const e=controller_utils_1.default.arc(this._center,this._oriDir,this._circleFromDir,this._twoPI,this._radius,this._color);e.parent=this.shape,this._circleNode=e,this._circleMR=getModel(e),this.hide()}onInitEditHandles(){const e=controller_utils_1.default.quad(new cc_1.Vec3,1e5,1e5);e.parent=this._rootNode,e.name="DiscPanPlane",e.active=!1,e.layer=panPlaneLayer,setNodeOpacity(e,0),this._panPlane=e;const t=controller_utils_1.default.disc(new cc_1.Vec3,new cc_1.Vec3(0,0,1),this._radius,this._areaColor,{unlit:!0});t.name="DiscArea",t.parent=this.shape,t.setPosition(new cc_1.Vec3(0,0,-.1)),setNodeOpacity(t,this._areaOpacity),this._areaNode=t,this._areaMR=getModel(t),this.initHandle(t,DiscHandleType.Area)}_updateEditHandle(e){const t=this._handleDataMap[e].topNode,i=axisDirMap[e],s=this._editHandleScales[e],a=tempVec3_a;a.x=i.x*this._radius,a.y=i.y*this._radius;const o=a;o.add(this._center);const r=this.getScale();t.setScale(s/r.x,s/r.y,s/r.z),cc_1.Vec3.multiply(o,o,r),t.setPosition(o)}updateSize(e,t,i=360){this._center.set(e),this._radius=t,this._arc=i;const s=controller_shape_1.default.calcArcPoints(this._center,this._oriDir,this._circleFromDir,-this._arc*this._degreeToRadianFactor,this._radius);if(updatePositions(this._circleMR,s),this._edit){this.updateEditHandles();const e=controller_shape_1.default.calcDiscData(this._center,cc_1.Vec3.UNIT_Z,this._radius);updatePositions(this._areaMR,e.positions),updateBoundingBox(this._areaMR,e.minPos,e.maxPos)}this.adjustEditHandlesSize()}onMouseDown(e){this.edit&&(this._mouseDeltaPos=new cc_1.Vec2(0,0),cc_1.Vec3.set(this._deltaPos,0,0,0),this._curDistScalar=super.getDistScalar(),this._deltaRadius=0,this._controlDir=cc.v3(),this._panPlane.active=!0,this._mouseDownOnPlanePos=new cc_1.Vec3,this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._panPlane),this.onControllerMouseDown&&this.onControllerMouseDown(e))}onMouseMove(e){if(this.edit&&this._isMouseDown){this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY;const t=new cc_1.Vec3;if(this.getPositionOnPanPlane(t,e.x,e.y,this._panPlane)){const i=new cc_1.Vec3(t);i.subtract(this._mouseDownOnPlanePos),this._curHandleType=e.handleName;const s=axisDirMap[e.handleName];this._controlDir=s;let a=0;this.isBorder(e.handleName)?(cc_1.Vec3.transformQuat(tempVec3,s,this.getRotation()),a=i.dot(tempVec3)):this._deltaPos=i,this._deltaRadius=a}this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this._curHandleType=DiscHandleType.None,this._panPlane.active=!1,this.onControllerMouseUp&&this.onControllerMouseUp(e)}onHoverIn(e){if(this.edit)if(e.handleName!==DiscHandleType.Area)this.setHandleColor(e.handleName,cc_1.Color.YELLOW);else{const t=getNodeOpacity(this._areaNode);t>0&&this.setHandleColor(e.handleName,cc_1.Color.YELLOW,t)}}onMouseLeave(e){this.onMouseUp(e)}getDeltaRadius(){return this._deltaRadius}getControlDir(){return this._controlDir}getDeltaPos(){return this._deltaPos}getCurHandleType(){return this._curHandleType}}DiscController.DiscHandleType=DiscHandleType,exports.default=DiscController;