"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),position_gizmo_1=__importDefault(require("../transform/position-gizmo")),index_1=__importDefault(require("../../../utils/engine/index")),set_util_1=__importStar(require("../../../utils/set-util")),external_1=__importDefault(require("../../../utils/external")),{setMeshColor:setMeshColor,getMeshColor:getMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null===(e=cc_1.director.getScene())||void 0===e?void 0:e.globals},EditorCamera=external_1.default.EditorCamera,NodeUtils=external_1.default.NodeUtils;class LightProbeController extends controller_base_1.default{constructor(e,t,o){super(e),this.targetDelegate=t,this.gizmo=o,this._lockSize=!0,this._isInitialized=!1,this._probePool=new cc_1.NodePool,this._currentProbes=new Map,this._currentSelectedProbeNames=new set_util_1.default,this._probeSphere=controller_utils_1.default.create3DNode("ProbeSphere"),this._reuseAbleMaterial=new cc_1.Material,this._shouldDiffOnNextUpdate=!1,this._editMode=!1,this._lightProbeInfo=new LightProbeInfo,this.tempAdjustSizeV3=new cc_1.Vec3,this.delta=Math.pow(.25,3),this.initShape(),LightProbeController.positionGizmo.controller||LightProbeController.positionGizmo.init(),LightProbeController.positionGizmo.hide(),this.registerCameraMovedEvent(),LightProbeController.OuterCell.layer=LightProbeController.TetrahedronNode.layer=cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.EDITOR,cc_1.Layers.Enum.IGNORE_RAYCAST])}static get Name(){return`LightProbeGroupController_${LightProbeController.Count++}`}get currentProbesArray(){return Array.from(this._currentProbes.entries()).map(e=>({key:e[0],nodeProbe:e[1]}))}get currentProbeNames(){return new Set(Array.from(this._currentProbes.values()).map(e=>e.node.name))}get probeSphere(){return this._probeSphere}initShape(){this.createShapeNode(LightProbeController.Name),this._probeSphere.parent=this.shape,LightProbeController.TetrahedronNode.parent&&LightProbeController.OuterCell.parent||(LightProbeController.TetrahedronNode.parent=this.shape,LightProbeController.OuterCell.parent=this.shape),LightProbeController._positionNode.parent=this._probeSphere,LightProbeController._positionNode.noNeedCommitChanges=!0,this.clearLayer(LightProbeController.TetrahedronNode),this.clearLayer(LightProbeController.OuterCell),this.clearLayer(LightProbeController._positionNode)}adjustControllerSize(){if(!this._lockSize)return;const e=NodeUtils.getWorldPosition3D(EditorCamera.camera.node);for(const[t,o]of this._currentProbes){const t=cc_1.Vec3.distance(o.node.getWorldPosition(this.tempAdjustSizeV3),e);if(this.tempAdjustSizeV3.set(1,1,1),this.is2D)this.tempAdjustSizeV3.multiplyScalar(1.5*this.getDistScalar(o.node));else{const e=t/this._baseDist;this.tempAdjustSizeV3.multiplyScalar(Math.min(1.6*e,e+Math.exp(-e*this.delta)/50))}o.node.setScale(this.tempAdjustSizeV3)}}updateController(){this.updateNodeTransformInfo(this._probeSphere),this.updateLightProbeInfo(),this._probeSphere.active=this._lightProbeInfo.showProbe,this._probeSphere.active&&this.updateProbes(),LightProbeController.debounceUpdate&&clearTimeout(LightProbeController.debounceUpdate),this.updateLines(!1),LightProbeController.debounceUpdate=setTimeout(()=>{this.updateLines(),this.updateProbesColor(),LightProbeController.debounceUpdate=null},250),this._isInitialized=!0,super.updateController()}updateProbes(){const e=this.targetDelegate.target,t=this.targetDelegate.target.node.worldPosition,o=(0,cc_1.v3)();if(e.probes.length!==this._currentProbes.size||this._shouldDiffOnNextUpdate){this._shouldDiffOnNextUpdate=!1;const e=this.diff();this.releaseProbeNodes(e),cce.Engine.repaintInEditMode()}else for(const[r,i]of this.currentProbesArray.entries())i.nodeProbe.probe=e.probes[r],o.set(t),i.nodeProbe.node.setWorldPosition(o.add(i.nodeProbe.probe));this.updateProbesColor(),this.updatePositionGizmo()}updateLines(e=!0){e&&this.targetDelegate.target.onProbeChanged(!0,!1);const t=this._lightProbeInfo.showWireframe;LightProbeController.TetrahedronNode.active=t;const o=t?this.updateWireframe():new Set;LightProbeController.OuterCell.active=this._lightProbeInfo.showConvex,LightProbeController.OuterCell.active&&this.updateConvex(o)}updateWireframe(){var e,t,o,r;const i=null===(t=null===(e=sceneGlobals())||void 0===e?void 0:e.lightProbeInfo)||void 0===t?void 0:t.data,n=null!==(o=null===i||void 0===i?void 0:i.probes)&&void 0!==o?o:[];if(0===n.length)return LightProbeController.TetrahedronNode.active=!1,new Set;LightProbeController.TetrahedronNode.active=!0;const l=n.map(e=>e.position),s=null!==(r=null===i||void 0===i?void 0:i.tetrahedrons)&&void 0!==r?r:[],a=[],h=new Set;for(const e of s)if(e.isInnerTetrahedron()&&e.vertex3>=0){const t=[e.vertex0,e.vertex1,e.vertex2,e.vertex3],o=LightProbeController.TetrahedronLines.map(e=>t[e]);for(let e=0;e<o.length;e+=2){const t=o[e],r=o[e+1],i=`${t}${r}`;h.has(i)||h.has(`${r}${t}`)||(a.push(o[e],o[e+1]),h.add(i))}}return l.length>0&&a.length>0&&this.updateLinesNode(LightProbeController.TetrahedronNode,(0,cc_1.v3)(0,0,0),l,a),h}updateConvex(e=new Set){var t,o,r,i;LightProbeController.OuterCell.active=this._lightProbeInfo.showConvex;const n=null===(o=null===(t=sceneGlobals())||void 0===t?void 0:t.lightProbeInfo)||void 0===o?void 0:o.data,l=null!==(r=null===n||void 0===n?void 0:n.probes)&&void 0!==r?r:[];if(0===l.length)return LightProbeController.OuterCell.active=!1,[];LightProbeController.OuterCell.active=!0;const s=null!==(i=null===n||void 0===n?void 0:n.tetrahedrons)&&void 0!==i?i:[],a=l.map(e=>e.position),h=new Vec3Set,d=[];for(const t of s)if(t.isOuterCell()&&t.vertex3<0){const o=(0,cc_1.v3)(a[t.vertex0]).add(l[t.vertex0].normal),r=(0,cc_1.v3)(a[t.vertex1]).add(l[t.vertex1].normal),i=(0,cc_1.v3)(a[t.vertex2]).add(l[t.vertex2].normal),n=h.add(o)+a.length,s=h.add(r)+a.length,c=h.add(i)+a.length,u=[t.vertex0,t.vertex1,t.vertex2,n,s,c],b=LightProbeController.OuterCellLines.map(e=>u[e]);for(let t=0;t<b.length;t+=2){const o=b[t],r=b[t+1],i=`${o}${r}`;e.has(i)||e.has(`${r}${o}`)||(d.push(b[t],b[t+1]),e.add(i))}}return h.forEach(e=>{a.push(e)}),a.length>0&&d.length>0&&this.updateLinesNode(LightProbeController.OuterCell,(0,cc_1.v3)(0,0,0),a,d,LightProbeController.ConvexColor),[]}updateLightProbeInfo(){var e;this._lightProbeInfo.update(null===(e=sceneGlobals())||void 0===e?void 0:e.lightProbeInfo)}createProbeNode(e){let t=this._probePool.get();if(!t)if(this._reuseAbleMesh)t=controller_utils_1.default.create3DNode(),addMeshToNode(t,this._reuseAbleMesh,{instancing:!0,depthTestForTriangles:!0},this._reuseAbleMaterial);else{t=controller_utils_1.default.sphere((0,cc_1.v3)(0,0,0),5,LightProbeController.ProbeColor,{instancing:!0,depthTestForTriangles:!0},this._reuseAbleMaterial),this._reuseAbleMaterial.isInitialized=!0;const e=t.getComponent(cc_1.MeshRenderer);(null===e||void 0===e?void 0:e.mesh)&&(this._reuseAbleMesh=e.mesh)}return t.noNeedCommitChanges=!0,t.name=`${LightProbeController.LightProbeSphereName}_${t.uuid.replace(/\//g,"_")}`,t.parent=this._probeSphere,t.setPosition((0,cc_1.v3)(e)),this._editMode&&this.initHandle(t,t.name),this._currentProbes.set(t.name,{node:t,probe:e}),t}updateProbesColor(){for(const[e,t]of this._currentProbes)setMeshColor(t.node,LightProbeController.ProbeColor);this.currentSelectedProbes.forEach(e=>{setMeshColor(e.node,LightProbeController.SelectedProbeColor)})}updateLinesNode(e,t,o,r,i=LightProbeController.WireFrameColor){controller_utils_1.default.drawLines(e,o,r,i),e.setPosition(t)}releaseProbeNodes(e){for(const t of e)this._probePool.put(t.node),this.removeHandle(t.node.name),this._currentProbes.delete(t.node.name);this.clearCurrentSelectedProbe(e.map(e=>e.node.name)),this.changePositionTarget([LightProbeController._positionNode,...cce.Gizmo.globalSelectProbes.map(e=>e.node)])}updateNodeTransformInfo(e){e.setWorldPosition(this.targetDelegate.target.node.worldPosition)}onShow(){this._editMode||this.clearCurrentSelectedProbe(),LightProbeController._gizmoEventListener||(LightProbeController._gizmoEventListener=new LightProbeGizmoMouseEventListener(this)),LightProbeController._gizmoEventListenerIndex||(LightProbeController._gizmoEventListenerIndex=LightProbeController.positionGizmo.addMouseEventListener(LightProbeController._gizmoEventListener)),this._isInitialized||this.updateController()}onHide(){LightProbeController._gizmoEventListenerIndex&&(LightProbeController.positionGizmo.removeMouseEventListener(LightProbeController._gizmoEventListenerIndex),LightProbeController._gizmoEventListenerIndex="")}onMouseDown(e){var t;this._editMode&&(null===(t=super.onMouseDown)||void 0===t||t.call(this,e))}onMouseMove(e){var t;this._editMode&&(null===(t=super.onMouseMove)||void 0===t||t.call(this,e))}onMouseUp(e){var t;this._editMode&&(null===(t=super.onMouseUp)||void 0===t||t.call(this,e))}get currentSelectedProbes(){return Array.from(this._currentSelectedProbeNames).filter(e=>this._currentProbes.has(e)).map(e=>this._currentProbes.get(e))}changePositionTarget(e){this._editMode&&(LightProbeController.positionGizmo.target=e)}selectProbe(e){this._currentSelectedProbeNames.addAll(e),this.updateProbesColor(),this.updatePositionGizmo(),cce.Engine.repaintInEditMode()}unselectProbe(e){this._currentSelectedProbeNames.deleteAll(e),this.updateProbesColor(),this.updatePositionGizmo(),cce.Engine.repaintInEditMode()}clearCurrentSelectedProbe(e){e=null!==e&&void 0!==e?e:Array.from(this._currentSelectedProbeNames);for(const t of e)this._currentSelectedProbeNames.has(t)&&this._currentSelectedProbeNames.delete(t);this.updateProbesColor()}updatePositionGizmo(){const e=cce.Gizmo.globalSelectProbes,t=e.map(e=>e.node.worldPosition),o=controller_utils_1.default.findMinPosition(t),r=controller_utils_1.default.findMaxPosition(t),i=(0,cc_1.v3)(r).add(o).divide((0,cc_1.v3)(2,2,2));LightProbeController._positionNode.setWorldPosition(i),this.changePositionTarget([LightProbeController._positionNode,...e.map(e=>e.node)]),this._editMode&&e.length>0?LightProbeController.positionGizmo.show():LightProbeController.positionGizmo.hide()}lightProbeEditModeChanged(e){if(this._editMode=e,e){for(const[e,t]of this._currentProbes)this.initHandle(t.node,e);cce.Engine.repaintInEditMode()}else{for(const[e,t]of this._currentProbes)this.removeHandle(e);this.clearCurrentSelectedProbe(),LightProbeController.positionGizmo.hide(),cce.Engine.repaintInEditMode()}}boundingBoxEditModeChanged(e){e?this.clearProbeNodesLayer():this.restoreProbeNodesLayer()}duplicateCurrentSelectedProbes(){const e=this.currentSelectedProbes,t=new set_util_1.default;for(const o of e){const e=(0,cc_1.v3)(o.probe),r=this.createProbeNode(e);t.add(r),this.targetDelegate.target.probes.push(e)}return this._shouldDiffOnNextUpdate=!0,this.targetDelegate.target.onProbeChanged(!0,!0),this.gizmo.onControlEnd(null),this.adjustControllerSize(),t}deleteCurrentSelectedProbes(){const e=this.currentSelectedProbes,t=new set_util_1.default;this.releaseProbeNodes(this.currentSelectedProbes),this.clearCurrentSelectedProbe();for(const o of e)this._currentProbes.delete(o.node.name),t.add(o.node);return this.targetDelegate.target.probes=Array.from(this._currentProbes.values()).map(e=>e.probe),this._shouldDiffOnNextUpdate=!0,this.targetDelegate.target.onProbeChanged(),this.gizmo.onControlEnd(null),t}clearLayer(e,t=!1){e.layer=cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.IGNORE_RAYCAST,cc_1.Layers.Enum.GIZMOS]),t&&e.children.forEach(e=>this.clearLayer(e,t))}restoreLayer(e,t=!1){e.layer=cc_1.Layers.Enum.GIZMOS,t&&e.children.forEach(e=>this.restoreLayer(e,t))}clearProbeNodesLayer(){this.clearLayer(this._probeSphere,!0)}restoreProbeNodesLayer(){this.restoreLayer(this._probeSphere,!0)}diff(){const e=this.targetDelegate.target.probes,t=Array.from(this._currentProbes.values());this._currentProbes.clear();for(let o=0;o<e.length;o++){const r=t.findIndex(t=>{var r;return null!==(r=null===t||void 0===t?void 0:t.probe.equals(e[o]))&&void 0!==r&&r});if(-1===r)this.createProbeNode(e[o]);else if(t[r]){const e=t[r];this._currentProbes.set(e.node.name,e),t[r]=null}}return t.filter(e=>!!e)}onNotGizmoMouseDown(e){}onNotGizmoMouseMove(e){}onNotGizmoMouseUp(e){}shouldEmitNodes(){return(0,set_util_1.toSet)(Array.from(this._currentProbes.values()).map(e=>e.node.uuid))}select(e){if(!this.gizmo.visible())return;const t=e.mapSet(e=>e.name);this.selectProbe(t)}selectAll(){if(!this.gizmo.visible())return;const e=this._currentProbes.keys();this.selectProbe(e)}unselect(e){if(!this.gizmo.visible())return;const t=e.mapSet(e=>e.name);this.unselectProbe(t)}unselectAll(){if(!this.gizmo.visible())return;const e=this._currentProbes.keys();this.unselectProbe(e)}currentSelectedNodes(){return(0,set_util_1.toSet)(this.currentSelectedProbes.map(e=>e.node))}lightProbeInfoChanged(){this.updateController(),cce.Engine.repaintInEditMode()}hideAllChildren(){var e,t;for(const o of null!==(t=null===(e=this.shape)||void 0===e?void 0:e.children)&&void 0!==t?t:[])o.active=!1}}exports.default=LightProbeController,LightProbeController.ProbeColor=new cc_1.Color("F1A348"),LightProbeController.SelectedProbeColor=new cc_1.Color("40AACA"),LightProbeController.WireFrameColor=new cc_1.Color("FCE7C4"),LightProbeController.ConvexColor=cc_1.Color.WHITE,LightProbeController.Count=0,LightProbeController._gizmoEventListenerIndex="",LightProbeController.globalNodeCurrentProbes=new Map,LightProbeController.LightProbeSphereName="LightProbeSphere",LightProbeController.TetrahedronNode=controller_utils_1.default.create3DNode("InnerTetrahedron"),LightProbeController.OuterCell=controller_utils_1.default.create3DNode("OuterCell"),LightProbeController._positionNode=controller_utils_1.default.create3DNode("PositionNode"),LightProbeController.positionGizmo=new position_gizmo_1.default([LightProbeController._positionNode]),LightProbeController.debounceUpdate=null,LightProbeController.TetrahedronLines=[0,1,0,2,0,3,1,2,1,3,2,3],LightProbeController.OuterCellLines=[0,1,0,2,1,2,0,3,1,4,2,5];class LightProbeGizmoMouseEventListener{constructor(e){this.controller=e}onControllerMouseMove(e){cce.Gizmo.walkAllLightProbeGizmoListener(e=>{e.onControlUpdate(null);const t=e._controller.currentSelectedProbes;for(const e of t)e.probe.set(e.node.position);e._controller.adjustControllerSize()}),this.controller.targetDelegate.target.onProbeChanged(!1,!1),this.controller.updateLines(!1)}onControllerMouseUp(e){cce.Gizmo.walkAllLightProbeGizmoListener(e=>{const t=e._controller.currentSelectedProbes;for(const e of t)e.probe.set(e.node.position);e.onControlEnd(null),e._controller.adjustControllerSize()}),this.controller.targetDelegate.target.onProbeChanged(!0,!1),this.controller.updateLines(!1)}}class LightProbeInfo{constructor(e=!0,t=!0,o=!1){this.showProbe=e,this.showWireframe=t,this.showConvex=o}update(e){var t,o,r;this.showProbe=null!==(t=null===e||void 0===e?void 0:e.showProbe)&&void 0!==t?t:this.showProbe,this.showWireframe=null!==(o=null===e||void 0===e?void 0:e.showWireframe)&&void 0!==o?o:this.showWireframe,this.showConvex=null!==(r=null===e||void 0===e?void 0:e.showConvex)&&void 0!==r?r:this.showConvex}}class Vec3Set{constructor(e=[]){this._v3s=e,this._map=new Map;for(const[t,o]of e.entries())this._map.set(o.toString(),t)}get v3s(){return this._v3s}add(e){const t=e.toString();return this._map.has(t)?this._map.get(t):(this._map.set(t,this._v3s.length),this._v3s.push(e),this._v3s.length-1)}clear(){this._map.clear(),this._v3s.length=0}has(e){return this._map.has(e.toString())}get size(){return this._v3s.length}indexOf(e){var t;return null!==(t=this._map.get(e.toString()))&&void 0!==t?t:-1}forEach(e){this._v3s.forEach(e)}}