"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,GizmoUtils=Utils.GizmoUtils,transform_gizmo_1=__importDefault(require("./transform-gizmo")),scale_controller_1=__importDefault(require("../controller/scale-controller")),transform_tool_data_1=require("../../../utils/transform-tool-data"),cc_1=require("cc"),tempQuat_a=new cc_1.Quat;class ScaleGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._localScaleList=[],this._offsetList=[],this._center=new cc_1.Vec3}init(){this.createController()}layer(){return"foreground"}createController(){this._controller=new scale_controller_1.default(this.getGizmoRoot()),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._localScaleList=[];let t=this.topNodes;for(let e=0;e<t.length;++e){let o=t[e],r=cc.v3();o.getScale(r),this._localScaleList.push(r)}if("center"===transform_tool_data_1.transformToolData.pivot){this._center=GizmoUtils.getCenterWorldPos3D(this.target),this._offsetList.length=0;for(let e=0;e<t.length;++e){let o=NodeUtils.getWorldPosition3D(t[e]),r=new cc_1.Vec3(o);r.subtract(this._center),this._offsetList.push(r)}}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("scale")}onGizmoKeyDown(t){if(!this.target)return;let e=t.key.toLowerCase();if("arrowleft"!==e&&"arrowright"!==e&&"arrowup"!==e&&"arrowdown"!==e)return;let o=t.shiftKey?1:.1,r=cc.v2();"arrowleft"===e?r.x=-1*o:"arrowright"===e?r.x=o:"arrowup"===e?r.y=o:"arrowdown"===e&&(r.y=-1*o),this.onControlUpdate("scale");let l=cc.v3();this.topNodes.forEach(t=>{t.getScale(l),l.x=l.x+r.x,l.y=l.y+r.y,this.setScaleWithPrecision(t,l,3),this.broadcastNodeChangeMessage(t)}),Utils.repaintEngine()}onGizmoKeyUp(t){if(!this.target)return;let e=t.key.toLowerCase();"arrowleft"!==e&&"arrowright"!==e&&"arrowup"!==e&&"arrowdown"!==e||this.onControlEnd("scale")}setScaleWithPrecision(t,e,o){e=NodeUtils.makeVec3InPrecision(e,o),t.setScale(e.x,e.y,e.z)}updateDataFromController(){if(this._controller.updated){let t;this.onControlUpdate("scale");let e=this._controller.getDeltaScale(),o=cc.v3(1+e.x,1+e.y,1+e.z),r=cc.v3(),l=this.topNodes;if("center"===transform_tool_data_1.transformToolData.pivot){let e=new cc.Vec3;for(t=0;t<this._localScaleList.length;++t){r.x=this._localScaleList[t].x*o.x,r.y=this._localScaleList[t].y*o.y,r.z=this._localScaleList[t].z*o.z,this.setScaleWithPrecision(l[t],r,3);let s=cc.v3(this._offsetList[t].x*o.x,this._offsetList[t].y*o.y,this._offsetList[t].z*o.z);e.set(this._center),e.add(s),NodeUtils.setWorldPosition3D(l[t],e),this.broadcastNodeChangeMessage(l[t])}}else for(t=0;t<this._localScaleList.length;++t)r.x=this._localScaleList[t].x*o.x,r.y=this._localScaleList[t].y*o.y,r.z=this._localScaleList[t].z*o.z,this.setScaleWithPrecision(l[t],r,3),this.broadcastNodeChangeMessage(l[t])}}updateControllerTransform(){let t,e=this.node;if(!e)return;const o=tempQuat_a;t="center"===transform_tool_data_1.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.target):NodeUtils.getWorldPosition3D(e),NodeUtils.getWorldRotation3D(e,o),this._controller.setPosition(t),this._controller.setRotation(o)}}exports.default=ScaleGizmo;