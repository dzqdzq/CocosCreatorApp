"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=__importDefault(require("../../../utils")),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,GizmoUtils=utils_1.default.GizmoUtils,transform_gizmo_1=__importDefault(require("./transform-gizmo")),scale_controller_1=__importDefault(require("../controller/scale-controller")),transform_tool_data_1=require("../../../utils/transform-tool-data"),cc_1=require("cc"),tempQuat_a=new cc_1.Quat;class ScaleGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._localScaleList=[],this._offsetList=[],this._center=new cc_1.Vec3}isNodeLocked(t){return!!t&&t.components.some(t=>t._objFlags&cc_1.CCObject.Flags.IsScaleLocked)}init(){this.createController()}layer(){return"foreground"}createController(){this._controller=new scale_controller_1.default(this.getGizmoRoot()),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._controller&&(this._controller.isLock=this.target.some(t=>this.isNodeLocked(t))),this._localScaleList=[];const t=this.topNodes;for(let o=0;o<t.length;++o){const e=t[o],r=cc.v3();e.getScale(r),this._localScaleList.push(r)}if("center"===transform_tool_data_1.transformToolData.pivot){this._center=GizmoUtils.getCenterWorldPos3D(this.target),this._offsetList.length=0;for(let o=0;o<t.length;++o){const e=NodeUtils.getWorldPosition3D(t[o]),r=new cc_1.Vec3(e);r.subtract(this._center),this._offsetList.push(r)}}}onControllerMouseMove(t){this.updateDataFromController(t)}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("scale")}onGizmoKeyDown(t){if(!this.target)return!0;const o=t.key.toLowerCase();if("arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o)return super.onGizmoKeyUp(t);const e=t.shiftKey?1:.1,r=cc.v2();"arrowleft"===o?r.x=-1*e:"arrowright"===o?r.x=e:"arrowup"===o?r.y=e:"arrowdown"===o&&(r.y=-1*e),this.onControlUpdate("scale");const s=cc.v3();return this.topNodes.forEach(t=>{t.getScale(s),s.x=s.x+r.x,s.y=s.y+r.y,this.setScaleWithPrecision(t,s,3)}),utils_1.default.repaintEngine(),!1}onGizmoKeyUp(t){if(!this.target)return!0;const o=t.key.toLowerCase();return"arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o?super.onGizmoKeyUp(t):(this.onControlEnd("scale"),!1)}setScaleWithPrecision(t,o,e){o=NodeUtils.makeVec3InPrecision(o,e),t.setScale(o.x,o.y,o.z)}checkSnap(t,o){const e=this._controller,r=e.moveAxisName;if(r){let s=0;s="xyz"===r?t.x:t[r],s=this.getSnappedValue(s,o),"xyz"===r?(t.x=s,t.y=s,t.z=s):t[r]=s;const l=s*e.scaleFactor;e.onAxisSliderMove(r,l)}}updateDataFromController(t){if(this._controller.updated){let o;this.onControlUpdate("scale");const e=this._controller.getDeltaScale(),r=transform_tool_data_1.transformToolData.snapConfigs;(this.isControlKeyPressed(t)||r.isScaleSnapEnabled)&&this.checkSnap(e,r.scale);const s=cc.v3(1+e.x,1+e.y,1+e.z),l=cc.v3(),i=this.topNodes,n=new cc.Vec3;for(o=0;o<this._localScaleList.length;++o)if(l.x=this._localScaleList[o].x*s.x,l.y=this._localScaleList[o].y*s.y,l.z=this._localScaleList[o].z*s.z,this.setScaleWithPrecision(i[o],l,3),"center"===transform_tool_data_1.transformToolData.pivot){const t=cc.v3(this._offsetList[o].x*s.x,this._offsetList[o].y*s.y,this._offsetList[o].z*s.z);n.set(this._center),n.add(t),NodeUtils.setWorldPosition3D(i[o],n)}}}updateControllerTransform(){const t=this.node;if(!t)return;let o;const e=tempQuat_a;o="center"===transform_tool_data_1.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.target):NodeUtils.getWorldPosition3D(t),NodeUtils.getWorldRotation3D(t,e),this._controller.setPosition(o),this._controller.setRotation(e)}}exports.default=ScaleGizmo;