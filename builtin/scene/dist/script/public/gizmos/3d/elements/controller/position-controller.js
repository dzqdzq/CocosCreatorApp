"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,EditorCamera=external_1.default.EditorCamera,{getRaycastResults:getRaycastResults,setNodeOpacity:setNodeOpacity,panPlaneLayer:panPlaneLayer,create3DNode:create3DNode,getModel:getModel}=require("../../../utils/engine/index"),cc_1=require("cc"),axisDirMap=controller_utils_1.default.axisDirectionMap,SnapPlaneName="SnapPlane",TempVec3A=new cc_1.Vec3,TempVec3B=new cc_1.Vec3,TempQuatA=new cc_1.Quat;class PositionController extends controller_base_1.default{constructor(e){super(e),this._deltaPosition=new cc_1.Vec3,this._mouseDownPos=new cc_1.Vec3,this._ctrlPlaneGroup=null,this._mouseDownAxis="",this._curDistScalar=0,this._dragPanPlane=null,this._isInPanDrag=!1,this._mouseDownOnPlanePos=new cc_1.Vec3,this._snapDragPlane=null,this._lockSize=!0,this.initShape()}createAxis(e,t,a){const o=controller_utils_1.default.arrow(25,10,140,t,{priority:1e3});o.name=e+"Axis",o.parent=this.shape,NodeUtils.setEulerAngles(o,a),this.initHandle(o,e)}createControlPlane(e,t,a){const o=new cc_1.Vec3;for(let t=0;t<e.length;t++){const a=cc.v3();cc_1.Vec3.multiplyScalar(a,axisDirMap[e.charAt(t)],12.5),o.add(a)}const n=controller_utils_1.default.borderPlane(25,25,t,128);n.name=e+"Plane",n.parent=this.shape,NodeUtils.setEulerAngles(n,a),n.setPosition(o.x,o.y,o.z);const s=controller_utils_1.default.quad(cc.v3(),1e8,1e8,cc.v3(0,0,1),t);s.parent=this._ctrlPlaneGroup,s.name=e+"PanPlane",s.active=!1,s.layer=panPlaneLayer,NodeUtils.setEulerAngles(s,a),setNodeOpacity(s,0),this.initHandle(n,e),this._handleDataMap[e].panPlane=s}createSnapPlane(){this._snapDragPlane=controller_utils_1.default.quad(new cc_1.Vec3(0,0,0),30,30,new cc_1.Vec3(0,0,1),cc_1.Color.WHITE,{unlit:!0}),this._snapDragPlane.parent=this.shape,setNodeOpacity(this._snapDragPlane,80),this._snapDragPlane.active=!1,this.initHandle(this._snapDragPlane,SnapPlaneName)}initShape(){this.createShapeNode("PositionController"),this.registerEvents(),this.createAxis("x",cc.Color.RED,cc.v3(-90,-90,0)),this.createAxis("y",cc.Color.GREEN,cc.v3()),this.createAxis("z",cc.Color.BLUE,cc.v3(90,0,90));const e=create3DNode("ctrlPlaneGroup");e.parent=this._rootNode,this._ctrlPlaneGroup=e,this.createControlPlane("xy",cc.Color.BLUE,cc.v3()),this.createControlPlane("xz",cc.Color.GREEN,cc.v3(-90,-90,0)),this.createControlPlane("yz",cc.Color.RED,cc.v3(0,90,90)),this.createSnapPlane(),this.hide()}getDeltaPosition(){return this._deltaPosition}onMouseDown(e){var t;if(this._deltaPosition.set(0,0,0),this._mouseDownPos=this.getPosition(),this._mouseDownAxis=e.handleName,this._curDistScalar=this.getDistScalar(),this.isSnaping())this.onControllerMouseDown&&this.onControllerMouseDown(e);else{if(this._dragPanPlane=this.getPanPlane(e.handleName),this._dragPanPlane){this._isInPanDrag=!0,this._ctrlPlaneGroup.setPosition(this.getPosition()),this._ctrlPlaneGroup.setRotation(this.getRotation()),this._dragPanPlane.active=!0,null===(t=getModel(this._dragPanPlane).model)||void 0===t||t.updateTransform(-1),this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._dragPanPlane)}cc.game.canvas.style.cursor="move",this.onControllerMouseDown&&this.onControllerMouseDown(e)}}getPanPlane(e){let t=null;if(e.length>1)t=this._handleDataMap[e].panPlane;else{const a="xyz",o=a.replace(e,"");let n=1e-5;for(let e=0;e<o.length;e++){const s=o.charAt(e),i=axisDirMap[s],l=TempVec3A;cc_1.Vec3.transformQuat(l,i,this.getRotation()),cc_1.Vec3.normalize(l,l);const r=TempVec3B;EditorCamera.camera.node.getWorldPosition(r);const c=cc.v3();cc_1.Vec3.subtract(c,r,this.getPosition()),cc_1.Vec3.normalize(c,c);const h=Math.abs(cc_1.Vec3.dot(l,c));if(h>n){const e=a.replace(s,"");t=this._handleDataMap[e].panPlane,n=h}}}return t}getAlignAxisDeltaPosition(e,t){const a=axisDirMap[e],o=this.getAlignAxisMoveDistance(this.localToWorldDir(a),t),n=cc.v3();return cc_1.Vec3.multiplyScalar(n,a,o*this._curDistScalar),n}getPositionOnPanPlane(e,t,a,o){const n=getRaycastResults(o,t,a),s=n.ray;if(n.length>0){const t=n[0];return cc_1.Vec3.multiplyScalar(e,s.d,t.distance),cc_1.Vec3.add(e,s.o,e),!0}return!1}onMouseMove(e){if(this.isSnaping())this.onControllerMouseMove&&this.onControllerMouseMove(e);else if(this._isMouseDown&&this._isInPanDrag){const t=new cc_1.Vec3;if(this.getPositionOnPanPlane(t,e.x,e.y,this._dragPanPlane)&&(this._deltaPosition.set(t),this._deltaPosition.subtract(this._mouseDownOnPlanePos),1===this._mouseDownAxis.length)){const e=axisDirMap[this._mouseDownAxis];cc_1.Vec3.transformQuat(TempVec3A,e,this.getRotation()),cc_1.Vec3.project(this._deltaPosition,this._deltaPosition,TempVec3A)}const a=new cc_1.Vec3(this._mouseDownPos);a.add(this._deltaPosition),this.setPosition(a),this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController()}}onMouseUp(e){this.isSnaping()?this.onControllerMouseUp&&this.onControllerMouseUp(e):(this._isInPanDrag&&(this._dragPanPlane.active=!1,this._isInPanDrag=!1),cc.game.canvas.style.cursor="default",this.onControllerMouseUp&&this.onControllerMouseUp(e))}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this.setHandleColor(e.handleName,cc_1.Color.YELLOW)}onHoverOut(){this.resetHandleColor()}onShow(){this.registerEvents(),this.is2D?(this._handleDataMap.z.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1,this.updateController()):(this._handleDataMap.z.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0)}onHide(){this.unregisterEvents()}isSnaping(){return this._snapDragPlane.active}updateSnapUI(e){if(this._snapDragPlane.active=e,e){const e=TempQuatA;EditorCamera.camera.node.getWorldRotation(e),this._snapDragPlane.setWorldRotation(e),this._handleDataMap.xy.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1}else this._handleDataMap.xy.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0}}exports.default=PositionController;