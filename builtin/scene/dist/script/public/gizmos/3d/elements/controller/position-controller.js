"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),external_1=__importDefault(require("../../../utils/external")),engine_1=__importDefault(require("../../../utils/engine")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,EditorCamera=external_1.default.EditorCamera,{getRaycastResultsByNodes:getRaycastResultsByNodes,getRaycastResults:getRaycastResults,setNodeOpacity:setNodeOpacity,panPlaneLayer:panPlaneLayer,create3DNode:create3DNode,getModel:getModel}=engine_1.default,axisDirMap=controller_utils_1.default.axisDirectionMap,SnapPlaneName="SnapPlane",TempVec3A=new cc_1.Vec3,TempVec3B=new cc_1.Vec3,TempQuatA=new cc_1.Quat;class PositionController extends controller_base_1.default{constructor(e){super(e),this._deltaPosition=new cc_1.Vec3,this._mouseDownPos=new cc_1.Vec3,this._ctrlPlaneGroup=null,this._mouseDownAxis="",this._curDistScalar=0,this._dragPanPlane=null,this._isInPanDrag=!1,this._mouseDownOnPlanePos=new cc_1.Vec3,this._snapDragPlane=null,this.onCameraFovChanged=(e=>{if(cce.Gizmo.transformToolData.is2D)return;const t=cc_1.Vec3.multiplyScalar(new cc_1.Vec3,PositionController.scale3D,e/45);this.setScale(t)}),this._lockSize=!0,this.initShape(),this.onDimensionChanged()}onDimensionChanged(){var e;null===(e=super.onDimensionChanged)||void 0===e||e.call(this),this.setScale(cce.Gizmo.transformToolData.is2D?PositionController.scale2D:PositionController.scale3D)}createAxis(e,t,o){const a=controller_utils_1.default.arrow(PositionController.baseArrowHeadHeight,PositionController.baseArrowHeadRadius,PositionController.baseArrowBodyHeight,t,{priority:1e3});a.name=e+"Axis",a.parent=this.shape,NodeUtils.setEulerAngles(a,o),this.initHandle(a,e)}createControlPlane(e,t,o){const a=PositionController.planeWidth/2,n=new cc_1.Vec3;for(let t=0;t<e.length;t++){const o=cc.v3();cc_1.Vec3.multiplyScalar(o,axisDirMap[e.charAt(t)],a),n.add(o)}const i=controller_utils_1.default.borderPlane(PositionController.planeWidth,PositionController.planeWidth,t,128);i.name=e+"Plane",i.parent=this.shape,NodeUtils.setEulerAngles(i,o),i.setPosition(n.x,n.y,n.z);const s=controller_utils_1.default.quad(cc.v3(),1e8,1e8,cc.v3(0,0,1),t);s.parent=this._ctrlPlaneGroup,s.name=e+"PanPlane",s.active=!1,s.layer=panPlaneLayer,NodeUtils.setEulerAngles(s,o),setNodeOpacity(s,0),this.initHandle(i,e),this._handleDataMap[e].panPlane=s}createSnapPlane(){this._snapDragPlane=controller_utils_1.default.quad(new cc_1.Vec3(0,0,0),PositionController.planeWidth,PositionController.planeWidth,new cc_1.Vec3(0,0,1),cc_1.Color.WHITE,{unlit:!0}),this._snapDragPlane.parent=this.shape,setNodeOpacity(this._snapDragPlane,80),this._snapDragPlane.active=!1,this.initHandle(this._snapDragPlane,SnapPlaneName)}initShape(){this.createShapeNode("PositionController"),this.registerEvents(),this.createAxis("x",cc.Color.RED,cc.v3(-90,-90,0)),this.createAxis("y",cc.Color.GREEN,cc.v3()),this.createAxis("z",cc.Color.BLUE,cc.v3(90,0,90));const e=create3DNode("ctrlPlaneGroup");e.parent=this._rootNode,this._ctrlPlaneGroup=e,this.createControlPlane("xy",cc.Color.BLUE,cc.v3()),this.createControlPlane("xz",cc.Color.GREEN,cc.v3(-90,-90,0)),this.createControlPlane("yz",cc.Color.RED,cc.v3(0,90,90)),this.createSnapPlane(),this.hide()}getDeltaPositionOfAxis(e,t){null!==e&&void 0!==e||(e=new cc_1.Vec3);const o=axisDirMap[t];return cc_1.Vec3.transformQuat(TempVec3A,o,this.getRotation()),cc_1.Vec3.project(e,this._deltaPosition,TempVec3A)}getDeltaPosition(){return this._deltaPosition}onMouseDown(e){var t;if(this._deltaPosition.set(0,0,0),this._mouseDownPos=this.getPosition(),this._mouseDownAxis=e.handleName,this._curDistScalar=this.getDistScalar(),this.isSnaping())this.onControllerMouseDown&&this.onControllerMouseDown(e);else{if(this._dragPanPlane=this.getPanPlane(e.handleName),this._dragPanPlane){this._isInPanDrag=!0,this._ctrlPlaneGroup.setPosition(this.getPosition()),this._ctrlPlaneGroup.setRotation(this.getRotation()),this._dragPanPlane.active=!0,null===(t=getModel(this._dragPanPlane).model)||void 0===t||t.updateTransform(-1),this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._dragPanPlane)}cc.game.canvas.style.cursor="move",this.onControllerMouseDown&&this.onControllerMouseDown(e)}}getPanPlane(e){let t=null;if(e.length>1)t=this._handleDataMap[e].panPlane;else{const o="xyz",a=o.replace(e,"");let n=1e-5;for(let e=0;e<a.length;e++){const i=a.charAt(e),s=axisDirMap[i],l=TempVec3A;cc_1.Vec3.transformQuat(l,s,this.getRotation()),cc_1.Vec3.normalize(l,l);const r=TempVec3B;EditorCamera.camera.node.getWorldPosition(r);const c=cc.v3();cc_1.Vec3.subtract(c,r,this.getPosition()),cc_1.Vec3.normalize(c,c);const h=Math.abs(cc_1.Vec3.dot(l,c));if(h>n){const e=o.replace(i,"");t=this._handleDataMap[e].panPlane,n=h}}}return t}static isXYZ(e){return 1===e.length&&["x","y","z"].includes(e)}static isPlane(e){return 2===e.length&&["xy","yz","xz"].includes(e)}getAlignAxisDeltaPosition(e,t){const o=axisDirMap[e],a=this.getAlignAxisMoveDistance(this.localToWorldDir(o),t),n=cc.v3();return cc_1.Vec3.multiplyScalar(n,o,a*this._curDistScalar),n}getPositionOnPanPlane(e,t,o,a){const n=getRaycastResultsByNodes([a],t,o,1/0,this.isSnaping()),i=n.ray;if(n.length>0){const t=n[0];return cc_1.Vec3.multiplyScalar(e,i.d,t.distance),cc_1.Vec3.add(e,i.o,e),!0}return!1}onMouseMove(e){if(this.isSnaping())this.onControllerMouseMove&&this.onControllerMouseMove(e);else if(this._isMouseDown&&this._isInPanDrag){const t=new cc_1.Vec3;this.getPositionOnPanPlane(t,e.x,e.y,this._dragPanPlane)&&(this._deltaPosition.set(t),this._deltaPosition.subtract(this._mouseDownOnPlanePos),PositionController.isXYZ(this._mouseDownAxis)&&this.getDeltaPositionOfAxis(this._deltaPosition,this._mouseDownAxis));const o=new cc_1.Vec3(this._mouseDownPos);if(o.add(this._deltaPosition),this.isLock)return void(this.onControllerMouseMove&&this.onControllerMouseMove(e));this.setPosition(o),this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController()}}onMouseUp(e){this.isSnaping()?this.onControllerMouseUp&&this.onControllerMouseUp(e):(this._isInPanDrag&&(this._dragPanPlane.active=!1,this._isInPanDrag=!1),cc.game.canvas.style.cursor="default",this.onControllerMouseUp&&this.onControllerMouseUp(e))}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this.setHandleColor(e.handleName,cc_1.Color.YELLOW)}onHoverOut(){this.resetHandleColor()}onShow(){this.registerEvents(),this.onCameraFovChanged(cce.Camera.getCameraFov()),this.is2D?(this._handleDataMap.z.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1,this.updateController()):(this._handleDataMap.z.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0)}onHide(){this.unregisterEvents()}isSnaping(){return this._snapDragPlane.active}updateSnapUI(e){if(this._snapDragPlane.active=e,e){const e=TempQuatA;EditorCamera.camera.node.getWorldRotation(e),this._snapDragPlane.setWorldRotation(e),this._handleDataMap.xy.topNode.active=!1,this._handleDataMap.xz.topNode.active=!1,this._handleDataMap.yz.topNode.active=!1}else this._handleDataMap.xy.topNode.active=!0,this._handleDataMap.xz.topNode.active=!0,this._handleDataMap.yz.topNode.active=!0}}PositionController.baseArrowHeadHeight=12.5,PositionController.baseArrowHeadRadius=5,PositionController.baseArrowBodyHeight=70,PositionController.planeWidth=12.5,PositionController.scale2D=new cc_1.Vec3(2,2,2),PositionController.scale3D=new cc_1.Vec3(1,1,1),exports.default=PositionController;