"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorPaint=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_1=require("./terrain-editor"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorPaint extends terrain_editor_mode_1.TerrainEditorMode{constructor(r){super(r),this._undo=null,this._currentLayer=-1;const e=new terrain_brush_1.TerrainCircleBrush;e.strength=5;const t=new terrain_brush_1.TerrainImageBrush;t.strength=5,this._brushes=[e,t],this._currentBrush=this._brushes[0]}setCurrentBrush(r){const e=this._currentBrush.position,t=this._currentBrush.radius,i=this._currentBrush.strength,s=this._currentBrush._setHeight,n=this._currentBrush._rotation;this._currentBrush=this._brushes[r],this._currentBrush.position=e,this._currentBrush.radius=t,this._currentBrush.strength=i,this._currentBrush._setHeight=s,this._currentBrush._rotation=n}getCurrentBrush(){return this._currentBrush}getBrush(r){return this._brushes[r]}setBrushImage(r){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=r,null!==r?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setCurrentLayer(r){this._currentLayer=r}getCurrentLayer(){return this._currentLayer}onUpdate(r,e){null!=this._undo&&(this._updateWeight(r,e),r.isTerrainChange=!0)}onUpdateBrushPosition(r,e){const t=this._currentBrush;t.update(r,e);const i=r.getBlocks();for(const e of i){const i=e.getIndex(),s=new cc_1.Rect;s.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize;const n=new cc_1.Rect;n.x=t.position.x-t.radius,n.y=t.position.z-t.radius,n.width=2*t.radius,n.height=2*t.radius,s.intersects(n)?e.setBrushMaterial(t.material):e.setBrushMaterial(null)}}onMouseDown(r){cce.SceneFacadeManager.snapshot(),-1!==this._currentLayer&&(this._undo=new terrain_operation_1.TerrainWeightUndoRedo(this.gizmo._target),cce.SceneFacadeManager.snapshot())}onMouseUp(){this._undo&&(cce.SceneFacadeManager.snapshot(this._undo),cce.SceneFacadeManager.abortSnapshot()),this._undo=null}onDeactivate(){const r=terrain_editor_1.TerrainEditor.Instance.getEditTerrain();r&&null!==r._asset||(this._currentLayer=-1)}_updateWeight(r,e){const t=r.info.weightMapSize*r.info.blockCount[0],i=r.info.weightMapSize*r.info.blockCount[1];if(0===t||0===i)return;const s=this._currentBrush;let n=s.position.x-s.radius,a=s.position.z-s.radius,o=s.position.x+s.radius,h=s.position.z+s.radius;if(n/=r.info.size.width,a/=r.info.size.height,o/=r.info.size.width,h/=r.info.size.height,n*=t-1,a*=i-1,o*=t-1,h*=i-1,n=Math.floor(n),a=Math.floor(a),o=Math.floor(o),h=Math.floor(h),n>t-1||o<0)return;if(a>i-1||h<0)return;n=clamp(n,0,t-1),a=clamp(a,0,i-1),o=clamp(o,0,t-1),h=clamp(h,0,i-1);const u=new terrain_operation_1.TerrainWeightOperation(r);this._undo&&this._undo.redoOperations.push(u);for(let c=a;c<=h;++c)for(let a=n;a<=o;++a){const n=r.getWeight(a,c),o=Math.floor(a/r.info.weightMapSize),h=Math.floor(c/r.info.weightMapSize),_=r.getBlock(o,h),d=[_.getLayer(0),_.getLayer(1),_.getLayer(2),_.getLayer(3)],l=a/(t-1)*r.info.size.width,p=c/(i-1)*r.info.size.height,g=s.getDelta(l,p)*e;if(0===g)continue;if(d[0]===this._currentLayer)n.x+=g;else if(d[1]===this._currentLayer)n.y+=g;else if(d[2]===this._currentLayer)n.z+=g;else if(d[3]===this._currentLayer)n.w+=g;else if(-1===d[0])_.setLayer(0,this._currentLayer),n.x+=g;else if(-1===d[1])_.setLayer(1,this._currentLayer),n.y+=g;else if(-1===d[2])_.setLayer(2,this._currentLayer),n.z+=g;else{if(-1!==d[3])continue;_.setLayer(3,this._currentLayer),n.w+=g}const f=n.x+n.y+n.z+n.w;f>0&&n.multiplyScalar(1/f),null!=this._undo&&(this._undo.push(a,c,r.getWeight(a,c)),this._undo.pushBlock(_,d,_.layers)),u.push(a,c,n)}u.apply()}}exports.TerrainEditorPaint=TerrainEditorPaint;