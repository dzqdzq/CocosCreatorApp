"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorPaint=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_1=require("./terrain-editor"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorPaint extends terrain_editor_mode_1.TerrainEditorMode{constructor(e){super(e),this._undo=null,this._currentLayer=-1;const r=new terrain_brush_1.TerrainCircleBrush;r.strength=5;const t=new terrain_brush_1.TerrainImageBrush;t.strength=5,this._brushes=[r,t],this._currentBrush=this._brushes[0]}setCurrentBrush(e){const r=this._currentBrush.position,t=this._currentBrush.radius,i=this._currentBrush.strength,s=this._currentBrush._setHeight;this._currentBrush=this._brushes[e],this._currentBrush.position=r,this._currentBrush.radius=t,this._currentBrush.strength=i,this._currentBrush._setHeight=s}getCurrentBrush(){return this._currentBrush}getBrush(e){return this._brushes[e]}setBrushImage(e){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=e,null!==e?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setCurrentLayer(e){this._currentLayer=e}getCurrentLayer(){return this._currentLayer}onUpdate(e,r){null!=this._undo&&(this._updateWeight(e,r),e.isTerrainChange=!0)}onUpdateBrushPosition(e,r){const t=this._currentBrush;t.update(e,r);const i=e.getBlocks();for(const r of i){const i=r.getIndex(),s=new cc_1.Rect;s.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize;const n=new cc_1.Rect;n.x=t.position.x-t.radius,n.y=t.position.z-t.radius,n.width=2*t.radius,n.height=2*t.radius,s.intersects(n)?r.setBrushMaterial(t.material):r.setBrushMaterial(null)}}onMouseDown(e){cce.SceneFacadeManager.snapshot(),-1!==this._currentLayer&&(this._undo=new terrain_operation_1.TerrainWeightUndoRedo(this.gizmo._target))}onMouseUp(){this._undo&&(cce.SceneFacadeManager.snapshot(this._undo),cce.SceneFacadeManager.abortSnapshot()),this._undo=null}onDeactivate(){const e=terrain_editor_1.TerrainEditor.Instance.getEditTerrain();e&&null!==e._asset||(this._currentLayer=-1)}_updateWeight(e,r){const t=e.info.weightMapSize*e.info.blockCount[0],i=e.info.weightMapSize*e.info.blockCount[1];if(0===t||0===i)return;const s=this._currentBrush;let n=s.position.x-s.radius,a=s.position.z-s.radius,o=s.position.x+s.radius,h=s.position.z+s.radius;if(n/=e.info.size.width,a/=e.info.size.height,o/=e.info.size.width,h/=e.info.size.height,n*=t-1,a*=i-1,o*=t-1,h*=i-1,n=Math.floor(n),a=Math.floor(a),o=Math.floor(o),h=Math.floor(h),n>t-1||o<0)return;if(a>i-1||h<0)return;n=clamp(n,0,t-1),a=clamp(a,0,i-1),o=clamp(o,0,t-1),h=clamp(h,0,i-1);const u=new terrain_operation_1.TerrainWeightOperation(e);this._undo&&this._undo.redoOperations.push(u);for(let _=a;_<=h;++_)for(let a=n;a<=o;++a){const n=e.getWeight(a,_),o=Math.floor(a/e.info.weightMapSize),h=Math.floor(_/e.info.weightMapSize),c=e.getBlock(o,h),d=[c.getLayer(0),c.getLayer(1),c.getLayer(2),c.getLayer(3)],l=a/(t-1)*e.info.size.width,p=_/(i-1)*e.info.size.height,g=s.getDelta(l,p)*r;if(0===g)continue;if(d[0]===this._currentLayer)n.x+=g;else if(d[1]===this._currentLayer)n.y+=g;else if(d[2]===this._currentLayer)n.z+=g;else if(d[3]===this._currentLayer)n.w+=g;else if(-1===d[0])c.setLayer(0,this._currentLayer),n.x+=g;else if(-1===d[1])c.setLayer(1,this._currentLayer),n.y+=g;else if(-1===d[2])c.setLayer(2,this._currentLayer),n.z+=g;else{if(-1!==d[3])continue;c.setLayer(3,this._currentLayer),n.w+=g}const f=n.x+n.y+n.z+n.w;f>0&&n.multiplyScalar(1/f),null!=this._undo&&(this._undo.push(a,_,e.getWeight(a,_)),this._undo.pushBlock(c,d,c.layers)),u.push(a,_,n)}u.apply()}}exports.TerrainEditorPaint=TerrainEditorPaint;