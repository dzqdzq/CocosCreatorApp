"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorPaint=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorPaint extends terrain_editor_mode_1.TerrainEditorMode{constructor(e){super(e),this._undo=null,this._currentLayer=-1;const r=new terrain_brush_1.TerrainCircleBrush;r.strength=5;const t=new terrain_brush_1.TerrainImageBrush;t.strength=5,this._brushes=[r,t],this._currentBrush=this._brushes[0]}setCurrentBrush(e){const r=this._currentBrush.position,t=this._currentBrush.radius,i=this._currentBrush.strength;this._currentBrush=this._brushes[e],this._currentBrush.position=r,this._currentBrush.radius=t,this._currentBrush.strength=i}getCurrentBrush(){return this._currentBrush}getBrush(e){return this._brushes[e]}setBrushImage(e){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=e,null!==e?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setCurrentLayer(e){this._currentLayer=e}getCurrentLayer(){return this._currentLayer}onUpdate(e,r){null!=this._undo&&(this._updateWeight(e,r),e.isTerrainChange=!0)}onUpdateBrushPosition(e,r){const t=this._currentBrush;t.update(e,r);const i=e.getBlocks();for(const r of i){const i=r.getIndex(),s=new cc_1.Rect;s.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,s.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize;const n=new cc_1.Rect;n.x=t.position.x-t.radius,n.y=t.position.z-t.radius,n.width=2*t.radius,n.height=2*t.radius,s.intersects(n)?r.setBrushMaterial(t.material):r.setBrushMaterial(null)}}onMouseDown(){cce.SceneFacadeManager.snapshot(),-1!==this._currentLayer&&(this._undo=new terrain_operation_1.TerrainWeightUndoRedo(this.gizmo._target))}onMouseUp(){this._undo&&(cce.SceneFacadeManager.snapshot(this._undo),cce.SceneFacadeManager.abortSnapshot()),this._undo=null}_updateWeight(e,r){const t=e.info.weightMapSize*e.info.blockCount[0],i=e.info.weightMapSize*e.info.blockCount[1];if(0===t||0===i)return;const s=this._currentBrush;let n=s.position.x-s.radius,o=s.position.z-s.radius,a=s.position.x+s.radius,h=s.position.z+s.radius;if(n/=e.info.size.width,o/=e.info.size.height,a/=e.info.size.width,h/=e.info.size.height,n*=t-1,o*=i-1,a*=t-1,h*=i-1,n=Math.floor(n),o=Math.floor(o),a=Math.floor(a),h=Math.floor(h),n>t-1||a<0)return;if(o>i-1||h<0)return;n=clamp(n,0,t-1),o=clamp(o,0,i-1),a=clamp(a,0,t-1),h=clamp(h,0,i-1);const u=new terrain_operation_1.TerrainWeightOperation(e);this._undo&&this._undo.redoOperations.push(u);for(let c=o;c<=h;++c)for(let o=n;o<=a;++o){const n=e.getWeight(o,c),a=Math.floor(o/e.info.weightMapSize),h=Math.floor(c/e.info.weightMapSize),_=e.getBlock(a,h),l=[_.getLayer(0),_.getLayer(1),_.getLayer(2),_.getLayer(3)],d=o/(t-1)*e.info.size.width,p=c/(i-1)*e.info.size.height,g=s.getDelta(d,p)*r;if(0===g)continue;if(l[0]===this._currentLayer)n.x+=g;else if(l[1]===this._currentLayer)n.y+=g;else if(l[2]===this._currentLayer)n.z+=g;else if(l[3]===this._currentLayer)n.w+=g;else if(-1===l[0])_.setLayer(0,this._currentLayer),n.x+=g;else if(-1===l[1])_.setLayer(1,this._currentLayer),n.y+=g;else if(-1===l[2])_.setLayer(2,this._currentLayer),n.z+=g;else{if(-1!==l[3])continue;_.setLayer(3,this._currentLayer),n.w+=g}const f=n.x+n.y+n.z+n.w;f>0&&n.multiplyScalar(1/f),null!=this._undo&&(this._undo.push(o,c,e.getWeight(o,c)),this._undo.pushBlock(_,l,_.layers)),u.push(o,c,n)}u.apply()}}exports.TerrainEditorPaint=TerrainEditorPaint;