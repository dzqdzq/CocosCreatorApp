"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorPaint=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorPaint extends terrain_editor_mode_1.TerrainEditorMode{constructor(r){super(r),this._undo=null,this._currentLayer=-1;const e=new terrain_brush_1.TerrainCircleBrush;e.strength=5;const t=new terrain_brush_1.TerrainImageBrush;t.strength=5,this._brushes=[e,t],this._currentBrush=this._brushes[0]}setCurrentBrush(r){const e=this._currentBrush.position,t=this._currentBrush.radius,i=this._currentBrush.strength,s=this._currentBrush._setHeight,n=this._currentBrush._rotation;this._currentBrush=this._brushes[r],this._currentBrush.position=e,this._currentBrush.radius=t,this._currentBrush.strength=i,this._currentBrush._setHeight=s,this._currentBrush._rotation=n}getCurrentBrush(){return this._currentBrush}getBrush(r){return this._brushes[r]}setBrushImage(r){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=r,null!==r?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setCurrentLayer(r){this._currentLayer=r}getCurrentLayer(){return this._currentLayer}onUpdate(r,e){null!=this._undo&&(this._updateWeight(r,e),r.isTerrainChange=!0)}onUpdateBrushPosition(r,e){const t=this._currentBrush;t.update(r,e);const i=r.getBlocks();for(const e of i){const i=e.getIndex(),s=new cc_1.Rect;s.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,s.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize;const n=new cc_1.Rect;n.x=t.position.x-t.radius,n.y=t.position.z-t.radius,n.width=2*t.radius,n.height=2*t.radius,s.intersects(n)?e.setBrushMaterial(t.material):e.setBrushMaterial(null)}}onMouseDown(r){-1!==this._currentLayer&&(this._undo=new terrain_operation_1.TerrainWeightUndoRedo(this.gizmo._target))}onMouseUp(){this._undo&&cce.SceneFacadeManager.beginRecording("",{customCommand:this._undo,auto:!0}),this._undo=null}onDeactivate(){const r=this._gizmo.editor.getEditTerrain();r&&null!==r._asset||(this._currentLayer=-1)}_updateWeight(r,e){const t=r.info.weightMapSize*r.info.blockCount[0],i=r.info.weightMapSize*r.info.blockCount[1];if(0===t||0===i)return;const s=this._currentBrush;let n=s.position.x-s.radius,o=s.position.z-s.radius,u=s.position.x+s.radius,h=s.position.z+s.radius;if(n/=r.info.size.width,o/=r.info.size.height,u/=r.info.size.width,h/=r.info.size.height,n*=t-1,o*=i-1,u*=t-1,h*=i-1,n=Math.floor(n),o=Math.floor(o),u=Math.floor(u),h=Math.floor(h),n>t-1||u<0)return;if(o>i-1||h<0)return;n=clamp(n,0,t-1),o=clamp(o,0,i-1),u=clamp(u,0,t-1),h=clamp(h,0,i-1);const a=new terrain_operation_1.TerrainWeightOperation(r);this._undo&&this._undo.redoOperations.push(a);for(let _=o;_<=h;++_)for(let o=n;o<=u;++o){const n=r.getWeight(o,_),u=Math.floor(o/r.info.weightMapSize),h=Math.floor(_/r.info.weightMapSize),c=r.getBlock(u,h),l=[c.getLayer(0),c.getLayer(1),c.getLayer(2),c.getLayer(3)],d=o/(t-1)*r.info.size.width,g=_/(i-1)*r.info.size.height,p=s.getDelta(d,g)*e;if(0===p)continue;if(l[0]===this._currentLayer)n.x+=p;else if(l[1]===this._currentLayer)n.y+=p;else if(l[2]===this._currentLayer)n.z+=p;else if(l[3]===this._currentLayer)n.w+=p;else if(-1===l[0])c.setLayer(0,this._currentLayer),n.x+=p;else if(-1===l[1])c.setLayer(1,this._currentLayer),n.y+=p;else if(-1===l[2])c.setLayer(2,this._currentLayer),n.z+=p;else{if(-1!==l[3])continue;c.setLayer(3,this._currentLayer),n.w+=p}const f=n.x+n.y+n.z+n.w;f>0&&n.multiplyScalar(1/f),null!=this._undo&&(this._undo.push(o,_,r.getWeight(o,_)),this._undo.pushBlock(c,l,c.layers)),a.push(o,_,n)}a.apply()}}exports.TerrainEditorPaint=TerrainEditorPaint;