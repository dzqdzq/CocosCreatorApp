"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../../utils"),external_1=__importDefault(require("../../../../utils/external")),NodeUtils=external_1.default.NodeUtils,cc_1=require("cc"),terrain_controller_1=__importDefault(require("../../controller/terrain-controller")),gizmo_base_1=__importDefault(require("../../gizmo-base")),terrain_editor_1=require("./terrain-editor"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_brush_1=require("./terrain-brush"),EditorCamera=external_1.default.EditorCamera;class TerrainGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._editor=null,this._controller=null,this._isEditorInit=!1,this._isShiftDown=!1,this._isConcave=!1,this._isSmooth=!1,this._isFlatten=!1,this._isSetHeight=!1}init(){this._editor=new terrain_editor_1.TerrainEditor(EditorCamera.camera,this),this.createController(),this._isInited=!0}get isSmooth(){return this._isSmooth}get isFlatten(){return this._isFlatten}get isSetHeight(){return this._isSetHeight}applySmooth(e){this._isSmooth=e}get isTerrainChange(){return this.target.manager&&this.target.manager.isTerrainChange}set isTerrainChange(e){this.target.manager&&(this.target.manager.isTerrainChange=e)}onShow(){this._controller.show(),this.updateControllerData(),cce.Engine.repaintInEditMode()}onHide(){this._isEditorInit=!1,this._editor.clearBrush(),this._editor.setEditTerrain(null),this._controller.hide(),cce.Engine.repaintInEditMode()}createController(){const e=this.getGizmoRoot();this._controller=new terrain_controller_1.default(e),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller.onControllerHoverOut=this.onControllerHoverOut.bind(this)}onControllerMouseDown(e){this._editor&&(cce.SceneFacadeManager.snapshot(),this._editor.onMouseDown(e.id,e.x,e.y),cce.Engine.repaintInEditMode())}onControllerMouseMove(e){this._editor&&(this._editor.onMouseMove(e.x,e.y),cce.Engine.repaintInEditMode())}onControllerMouseUp(e){this._editor&&(this._editor.isChanged&&Utils.onNodeChanged(this.node),e?this._editor.onMouseUp(e.id,e.x,e.y):this._editor.onMouseUp(),cce.Engine.repaintInEditMode())}onControllerHoverOut(){this._editor&&(this._editor.clearBrush(),cce.Engine.repaintInEditMode())}updateControllerData(){if(!this._isInited||null===this.target)return;this.initEditor();const e=this.target.info;e&&this._controller.updateSize(e.size.width,e.size.height),cce.Engine.repaintInEditMode()}initEditor(){this._isEditorInit||this._editor&&(this._editor.setEditTerrain(this.target),this._isEditorInit=!0,cce.Engine.repaintInEditMode())}async addLayerByUuid(e){return this.target?new Promise((t,i)=>{cc_1.assetManager.loadAny(e,(e,r)=>{if(e)i(e);else if(r){const e=new cc_1.TerrainLayer;e.detailMap=r,e.tileSize=1,this.isTerrainChange=!0;const i=this.target.addLayer(e);Utils.onNodeChanged(this.node),t(i),cce.Engine.repaintInEditMode()}})}):-1}async setSculptBrush(e){const t=this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT);if(e)return new Promise((i,r)=>{cc_1.assetManager.loadAny(e,(e,n)=>{t.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image===n&&i(!0),e?r(e):n&&(t.setBrushImage(n),this.isTerrainChange=!0,i(!0),cce.Engine.repaintInEditMode())})});t.setBrushImage(null)}async setSculptBrushRotation(e){this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT).setSculptBrushRotation(e)}async setPaintBrush(e){const t=this._editor.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT);if(e)return new Promise((i,r)=>{cc_1.assetManager.loadAny(e,(e,n)=>{t.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image===n&&i(!0),e?r(e):n&&(t.setBrushImage(n),this.isTerrainChange=!0,i(!0),cce.Engine.repaintInEditMode())})});t.setBrushImage(null)}async setLayerValue(e,t,i){const r=this.target.getLayer(e);return new Promise((n,o)=>{if(i)if("tileSize"in i&&(r.tileSize=i.tileSize),"metallic"in i&&(r.metallic=i.metallic),"roughness"in i&&(r.roughness=i.roughness),"normalMap"in i)if(i.normalMap){const e=i.normalMap;cc_1.assetManager.loadAny(e,(e,t)=>{e?o(e):t&&(r.normalMap=t,this.isTerrainChange=!0,Utils.onNodeChanged(this.node),cce.Engine.repaintInEditMode())})}else r.normalMap=null,this.isTerrainChange=!0,Utils.onNodeChanged(this.node),cce.Engine.repaintInEditMode();else this.isTerrainChange=!0,Utils.onNodeChanged(this.node),cce.Engine.repaintInEditMode();t?cc_1.assetManager.loadAny(t,(t,i)=>{t?o(t):i&&(r.detailMap=i,this.isTerrainChange=!0,Utils.onNodeChanged(this.node),n(e),cce.Engine.repaintInEditMode())}):n(e)})}removeLayerByIndex(e){this.target&&(this.target.removeLayer(e),this.isTerrainChange=!0,Utils.onNodeChanged(this.node),cce.Engine.repaintInEditMode())}setCurrentEditLayer(e){this._editor.setCurrentLayer(e),cce.Engine.repaintInEditMode()}getLayers(){const e=[];if(this.target)for(let t=0;t<cc_1.TERRAIN_MAX_LAYER_COUNT;t++){const i=this.target.getLayer(t);i?e.push({detailMap:i.detailMap?i.detailMap._uuid:null,metallic:i.metallic,normalMap:i.normalMap?i.normalMap._uuid:null,roughness:i.roughness,tileSize:i.tileSize}):e.push(null)}return e}getCurrentEditLayer(){return this._editor.getCurrentLayer()}setCurrentEditMode(e,t){const i=Object.assign({isSculptDown:!1,isSmooth:!1,isFlatten:!1,isSetHeight:!1},t||{});this._isConcave=this._isShiftDown=i.isSculptDown,this._isSmooth=i.isSmooth,this._isFlatten=i.isFlatten,this._isSetHeight=i.isSetHeight,0!==e&&this.alignQuadShape(),this._editor.setMode(e),cce.Engine.repaintInEditMode()}queryTerrainInfo(){const e=this.target;let t=null;return e&&(t={tileSize:e.info.tileSize,weightMapSize:e.info.weightMapSize,lightMapSize:e.info.lightMapSize,blockCount:e.info.blockCount}),t}changeTerrainInfo(e){const t=this.target;if(t){const i=new cc_1.TerrainInfo;this.isTerrainChange=!0,Object.assign(i,e),t.rebuild(i),Utils.onNodeChanged(this.node,e),cce.Engine.repaintInEditMode()}}queryBrushOfMode(e){let t=null;if(e===terrain_editor_mode_1.eTerrainEditorMode.SCULPT||e===terrain_editor_mode_1.eTerrainEditorMode.PAINT){const i=this._editor.getMode(e);t={radius:i.getCurrentBrush().radius,strength:i.getCurrentBrush().strength,_setHeight:i.getCurrentBrush()._setHeight}}return t}setBrushOfMode(e,t){let i=null;if(e===terrain_editor_mode_1.eTerrainEditorMode.SCULPT||e===terrain_editor_mode_1.eTerrainEditorMode.PAINT){const t=this._editor.getMode(e);i=t.getCurrentBrush()}i&&Object.keys(t).forEach(e=>{"material"!==e&&null!==i[e]&&void 0!==i[e]&&(i[e]=t[e])})}getBlockInfo(){var e;const t=null===(e=this._editor)||void 0===e?void 0:e.getMode(3),i=t.getCurrentBlockIndex()||[0,0],r=t.getCurrentWeightData()||null,n=t.getCurrentLayerList();return{index:{x:i[0],y:i[1]},weight:r?{data:Array.from(r.data),width:r.width,height:r.height}:r,layers:n.map(e=>e?e._uuid:"")}}alignQuadShape(){this._controller&&(this._controller.shape.children[0].setWorldPosition(this.target.node.getWorldPosition()),cce.Engine.repaintInEditMode())}onTargetUpdate(){this.alignQuadShape(),this.updateControllerData(),cce.Engine.repaintInEditMode()}onNodeChanged(){this.alignQuadShape(),this.updateControllerData(),cce.Engine.repaintInEditMode()}onKeyDown(e){e.shiftKey&&(this._isShiftDown=!0)}onKeyUp(e){16===e.keyCode&&(this._isConcave?this._isShiftDown=!0:this._isShiftDown=!1)}onUpdate(e){this._editor&&(cce.Engine.repaintInEditMode(),this._editor.update(e,this._isShiftDown),cce.Engine.repaintInEditMode())}onCameraControlModeChanged(e){0!==e&&this.onControllerMouseUp(null)}}exports.default=TerrainGizmo;