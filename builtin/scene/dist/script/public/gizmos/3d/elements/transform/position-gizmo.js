"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,GizmoUtils=Utils.GizmoUtils,position_controller_1=__importDefault(require("../controller/position-controller")),transform_gizmo_1=__importDefault(require("./transform-gizmo")),transform_tool_data_1=require("../../../utils/transform-tool-data"),tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class PositionGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._nodesWorldPosList=[]}init(){this.createController()}layer(){return"foreground"}createController(){const o=new position_controller_1.default(this.getGizmoRoot());o.onControllerMouseDown=this.onControllerMouseDown.bind(this),o.onControllerMouseMove=this.onControllerMouseMove.bind(this),o.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller=o}onControllerMouseDown(){this._nodesWorldPosList.length=0;const o=this.topNodes;for(let t=0;t<o.length;++t)this._nodesWorldPosList.push(NodeUtils.getWorldPosition3D(o[t]))}onControllerMouseMove(o){this.updateDataFromController(o)}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("position")}onGizmoKeyDown(o){if(!this.target)return;const t=o.key.toLowerCase();if("arrowleft"!==t&&"arrowright"!==t&&"arrowup"!==t&&"arrowdown"!==t)return;const e=o.shiftKey?10:1,r=cc.v3();"arrowleft"===t?r.x=-e:"arrowright"===t?r.x=e:"arrowup"===t?r.y=e:"arrowdown"===t&&(r.y=-e),this.onControlUpdate("position");const s=cc.v3();this.topNodes.forEach(o=>{o.getPosition(s),s.add(r),o.setPosition(s.x,s.y,s.z)}),Utils.repaintEngine()}onGizmoKeyUp(o){if(!this.target)return;const t=o.key.toLowerCase();"arrowleft"!==t&&"arrowright"!==t&&"arrowup"!==t&&"arrowdown"!==t||this.onControlEnd("position")}checkSnap(o,t){0!==o.x&&(o.x=this.getSnappedValue(o.x,t.x)),0!==o.y&&(o.y=this.getSnappedValue(o.y,t.y)),0!==o.z&&(o.z=this.getSnappedValue(o.z,t.z))}updateDataFromController(o){if(this._controller.updated){this.onControlUpdate("position");const t=this._controller.getDeltaPosition(),e=this.topNodes,r=tempVec3_a;for(let s=0;s<this._nodesWorldPosList.length;++s){r.set(this._nodesWorldPosList[s]);const i=transform_tool_data_1.transformToolData.snapConfigs;(o.ctrlKey||i.isPositionSnapEnabled)&&this.checkSnap(t,i.position),r.add(t);const n=e[s];NodeUtils.setWorldPosition3D(n,r),tempVec3_b.set(n.position),NodeUtils.makeVec3InPrecision(tempVec3_b,3),n.position=tempVec3_b}}}updateControllerTransform(){const o=this.node;if(!o)return;let t;const e=tempQuat_a;cc_1.Quat.identity(e),t="center"===transform_tool_data_1.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.target):NodeUtils.getWorldPosition3D(o),"global"!==transform_tool_data_1.transformToolData.coordinate&&NodeUtils.getWorldRotation3D(o,e),this._controller.setPosition(t),this._controller.setRotation(e)}}exports.default=PositionGizmo;