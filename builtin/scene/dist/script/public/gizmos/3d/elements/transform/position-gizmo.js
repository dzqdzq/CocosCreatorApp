"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),utils_1=require("../../../../../3d/manager/camera/utils"),window_1=require("../../../../../utils/window"),utils_2=__importDefault(require("../../../utils")),engine_1=__importDefault(require("../../../utils/engine")),external_1=__importDefault(require("../../../utils/external")),transform_tool_data_1=require("../../../utils/transform-tool-data"),position_controller_1=__importDefault(require("../controller/position-controller")),transform_gizmo_1=__importDefault(require("./transform-gizmo")),NodeUtils=external_1.default.NodeUtils,EditorCamera=external_1.default.EditorCamera,GizmoUtils=utils_2.default.GizmoUtils,{raycastAllColliders:raycastAllColliders,raycast:raycast}=engine_1.default,TempVec3A=new cc_1.Vec3,TempVec3B=new cc_1.Vec3,TempQuatA=new cc_1.Quat,ArrowKeys=Object.keys({arrowleft:1,arrowright:1,arrowdown:1,arrowup:1});var SnapMode;!function(e){e[e.Undefined=0]="Undefined",e[e.Grid=1]="Grid",e[e.Surface=2]="Surface",e[e.Vertex=3]="Vertex"}(SnapMode||(SnapMode={}));class PositionGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._controller=null,this._nodesWorldPosList=[],this._snapMode=SnapMode.Undefined,this._snapMouseDown=!1,this._handler=null,this._event=null,this._mouseDown=!1,this._nodeToSnapVertex=new cc_1.Vec3(0,0,0),this._gizmoMouseEventListeners={}}getFirstLockNode(){var e;return null===(e=this.target)||void 0===e?void 0:e.find(e=>this.isNodeLocked(e))}isNodeLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsPositionLocked)}init(){this.createController()}layer(){return"foreground"}createController(){const e=new position_controller_1.default(this.getGizmoRoot());e.onControllerMouseDown=this.onControllerMouseDown.bind(this),e.onControllerMouseMove=this.onControllerMouseMove.bind(this),e.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller=e}get controller(){return this._controller}set controller(e){this._controller=e}addMouseEventListener(e){const t=(1e6*performance.now()).toString();return this._gizmoMouseEventListeners[t]=e,t}removeMouseEventListener(e){e in this._gizmoMouseEventListeners&&delete this._gizmoMouseEventListeners[e]}onControllerMouseDown(e){var t;if(utils_1.CameraUtils.showSnapTip(),this._controller){const e="center"===transform_tool_data_1.transformToolData.pivot,o=null===(t=this.target)||void 0===t?void 0:t.some(e=>this.isNodeLocked(e));this._controller.isLock=e||o}this._mouseDown=!0,this._snapMode!==SnapMode.Surface&&this._snapMode!==SnapMode.Vertex||(this._snapMouseDown=!0),this._nodesWorldPosList.length=0;const o=this.topNodes;for(let e=0;e<o.length;++e)this._nodesWorldPosList.push(NodeUtils.getWorldPosition3D(o[e]));Object.values(this._gizmoMouseEventListeners).forEach(t=>{var o;return null===(o=t.onControllerMouseDown)||void 0===o?void 0:o.call(t,e)})}onControllerMouseMove(e){this.updateDataFromController(e),Object.values(this._gizmoMouseEventListeners).forEach(t=>{var o;return null===(o=t.onControllerMouseMove)||void 0===o?void 0:o.call(t,e)})}onControllerMouseUp(e){var t;utils_1.CameraUtils.hideSnapTip(),this._mouseDown=!1,this._snapMouseDown=!1,this._controller.updated&&this.onControlEnd("position"),(null===(t=this.target)||void 0===t?void 0:t.every(e=>!this.isNodeLocked(e)))&&this.updateControllerTransform(),this._handler&&(clearTimeout(this._handler),this._handler=null),Object.values(this._gizmoMouseEventListeners).forEach(t=>{var o;return null===(o=t.onControllerMouseUp)||void 0===o?void 0:o.call(t,e)})}onGizmoKeyDown(e){var t;return null===(t=this.target)||void 0===t||!t.length||!!this.onArrowDown(e)&&(!!this.onSurfaceSnapDown(e)&&(!!this.onVertexSnapDown(e)&&super.onGizmoKeyDown(e)))}onGizmoKeyUp(e){var t;return null===(t=this.target)||void 0===t||!t.length||!!this.onArrowUp(e)&&(!!this.onSurfaceSnapUp(e)&&(!!this.onVertexSnapUp(e)&&super.onGizmoKeyUp(e)))}checkSnap(e,t){0!==e.x&&(e.x=this.getSnappedValue(e.x,t.x)),0!==e.y&&(e.y=this.getSnappedValue(e.y,t.y)),0!==e.z&&(e.z=this.getSnappedValue(e.z,t.z))}updateDataFromController(e){this._controller.updated&&(this.onControlUpdate("position"),this._event=e,this._handler||(this._handler=setTimeout((()=>{const e=this._controller.getDeltaPosition(),t=this.topNodes,o=TempVec3A;this.updateSnapPosition(e,this._event);const n=e.equals(cc_1.Vec3.ZERO);if(!(this._snapMode===SnapMode.Surface||this._snapMode===SnapMode.Vertex)||!n)for(let n=0;n<this._nodesWorldPosList.length;++n){const s=t[n];o.set(this._nodesWorldPosList[n]),o.add(e),NodeUtils.setWorldPosition3D(s,o),TempVec3B.set(s.position),NodeUtils.makeVec3InPrecision(TempVec3B,3),s.position=TempVec3B}this._handler=null}).bind(this),16)),"center"===transform_tool_data_1.transformToolData.pivot&&this.updateControllerTransform(!0))}updateControllerTransform(e){var t;const o=null!==(t=this.getFirstLockNode())&&void 0!==t?t:this.node;if(!o||!e&&this._mouseDown&&!this._snapMouseDown)return;let n;const s=TempQuatA;cc_1.Quat.identity(s),n="center"===transform_tool_data_1.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.target):NodeUtils.getWorldPosition3D(o),this._snapMouseDown&&n.add(this._nodeToSnapVertex),"global"!==transform_tool_data_1.transformToolData.coordinate&&NodeUtils.getWorldRotation3D(o,s),this._controller.setPosition(n),this._controller.setRotation(s)}onArrowDown(e){const t=e.key.toLowerCase();if(!ArrowKeys.includes(t))return!0;const o=e.shiftKey?10:1,n=cc.v3();"arrowleft"===t?n.x=-o:"arrowright"===t?n.x=o:"arrowup"===t?n.y=o:"arrowdown"===t&&(n.y=-o),this.onControlUpdate("position");const s=cc.v3();return this.topNodes.forEach(e=>{e.getPosition(s),s.add(n),e.setPosition(s.x,s.y,s.z)}),utils_2.default.repaintEngine(),!1}onArrowUp(e){const t=e.key.toLowerCase();return!ArrowKeys.includes(t)||(this.onControlEnd("position"),!1)}onSurfaceSnapDown(e){return!e.shiftKey||!e.ctrlKey||(17===e.keyCode||16===e.keyCode?(this._snapMode=SnapMode.Surface,this.updateSnapUI(!0)):(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1)),!1)}onSurfaceSnapUp(e){return!!(e.shiftKey&&e.ctrlKey||this._snapMode!==SnapMode.Surface)||(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1),!1)}onVertexSnapDown(e){const t=e.key.toLowerCase();return e.ctrlKey||e.shiftKey||e.metaKey||e.altKey?(this._snapMode===SnapMode.Vertex&&(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1)),!0):"v"!==t||(this._snapMode=SnapMode.Vertex,this.updateSnapUI(!0),!1)}onVertexSnapUp(e){const t=e.key.toLowerCase();return!!(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey)||("v"!==t||(this._snapMode=SnapMode.Undefined,this.updateSnapUI(!1),!1))}updateSnapUI(e){e||(this._nodeToSnapVertex.set(0,0,0),this._mouseDown&&!this._snapMouseDown||this.updateControllerTransform()),this._controller.updateSnapUI(e),utils_2.default.repaintEngine()}updateSnapPosition(e,t){const o=(0,window_1.getMainWindowSize)();if(this._snapMode===SnapMode.Surface){if(e.set(0,0,0),!this._snapMouseDown)return;const n=raycastAllColliders(EditorCamera.getCamera(),t.x,t.y),s=this.getNodeExcludeTarget(n);if(s){const t=s.hitPoint;this.calculateDeltaPos(e,t)}else{const n=t.x,s=o.height-t.y,r=NodeUtils.getRaycastResultsForSnap(EditorCamera.getCamera(),n,s,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR])),i=this.getNodeExcludeTarget(r);if(i){const t=i.hitPoint;this.calculateDeltaPos(e,t)}}}else if(this._snapMode===SnapMode.Vertex){if(e.set(0,0,0),!this._snapMouseDown)return;const n=t.x,s=o.height-t.y,r=NodeUtils.getRaycastResultNodes(EditorCamera.getCamera(),n,s,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR])),i=this.getNodeExcludeTarget(r);if(i){const o=NodeUtils.getMeshVertexAroundMouse(i,EditorCamera.getCamera(),t.x,t.y,10);if(o.length>0){const t=o[0],n=i.getWorldMatrix(),s=new cc_1.Vec3;cc_1.Vec3.transformMat4(s,new cc_1.Vec3(t.x,t.y,t.z),n),this.calculateDeltaPos(e,s)}}}else{const o=transform_tool_data_1.transformToolData.snapConfigs;(this.isControlKeyPressed(t)||o.isPositionSnapEnabled)&&this.checkSnap(e,o.position)}}updateVertexPos(e){const t=this.target[0],o=NodeUtils.getMeshVertexAroundMouse(t,EditorCamera.getCamera(),e.x,e.y,10);if(o.length>0){const e=o[0],n=t.getWorldRS();this._nodeToSnapVertex=new cc_1.Vec3(e.x,e.y,e.z).transformMat4(n);const s=t.getWorldMatrix(),r=new cc_1.Vec3;cc_1.Vec3.transformMat4(r,e,s),this.setGizmoPosition(r)}}onVertexSnapMove(e){return!!(this._snapMouseDown||this._snapMode!==SnapMode.Vertex&&this._snapMode!==SnapMode.Surface)||(this.updateVertexPos(e),!1)}setGizmoPosition(e){var t,o;null===(o=null===(t=this._controller)||void 0===t?void 0:t.shape)||void 0===o||o.setPosition(e),utils_2.default.repaintEngine()}calculateDeltaPos(e,t){const o=new cc_1.Vec3(t),n=this._nodesWorldPosList[0];e.set(o.subtract(this._nodeToSnapVertex).subtract(n))}getNodeExcludeTarget(e){let t=null;if(!e)return t;for(let o=0;o<e.length;o++){t=e[o];let n=cc_1.Node.isNode(t)?t:t.node;if(n||(n=t.collider.node),!this.target.includes(n))break;t=null}return t}drawHitPoint(e){cce.Engine.getGeometryRenderer().removeData("addSphere"),cce.Engine.getGeometryRenderer().addSphere(e,.1,new cc_1.Color(255,0,0))}}exports.default=PositionGizmo;