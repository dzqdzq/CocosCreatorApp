"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,GizmoUtils=Utils.GizmoUtils,position_controller_1=__importDefault(require("../controller/position-controller")),transform_gizmo_1=__importDefault(require("./transform-gizmo")),transform_tool_data_1=require("../../../utils/transform-tool-data"),tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class PositionGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._nodesWorldPosList=[]}init(){this.createController()}layer(){return"foreground"}createController(){const t=new position_controller_1.default(this.getGizmoRoot());t.onControllerMouseDown=this.onControllerMouseDown.bind(this),t.onControllerMouseMove=this.onControllerMouseMove.bind(this),t.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller=t}onControllerMouseDown(){this._nodesWorldPosList.length=0;let t=this.topNodes;for(let o=0;o<t.length;++o)this._nodesWorldPosList.push(NodeUtils.getWorldPosition3D(t[o]))}onControllerMouseMove(t){this.updateDataFromController(t)}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("position")}onGizmoKeyDown(t){if(!this.target)return;let o=t.key.toLowerCase();if("arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o)return;let e=t.shiftKey?10:1,r=cc.v3();"arrowleft"===o?r.x=-e:"arrowright"===o?r.x=e:"arrowup"===o?r.y=e:"arrowdown"===o&&(r.y=-e),this.onControlUpdate("position");let s=cc.v3();this.topNodes.forEach(t=>{t.getPosition(s),s.add(r),t.setPosition(s.x,s.y,s.z),this.broadcastNodeChangeMessage(t)}),Utils.repaintEngine()}onGizmoKeyUp(t){if(!this.target)return;let o=t.key.toLowerCase();"arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o||this.onControlEnd("position")}getSnappedValue(t,o){return Math.round(t/o)*o}updateDataFromController(t){if(this._controller.updated){this.onControlUpdate("position");const o=this._controller.getDeltaPosition(),e=this.topNodes,r=tempVec3_a;for(let s=0;s<this._nodesWorldPosList.length;++s){if(r.set(this._nodesWorldPosList[s]),r.add(o),"global"===transform_tool_data_1.transformToolData.coordinate&&t.ctrlKey){let t=1,e=r.x;0!==o.x&&(e=this.getSnappedValue(r.x,t));let s=r.y;0!==o.y&&(s=this.getSnappedValue(r.y,t));let i=r.z;0!==o.z&&(i=this.getSnappedValue(r.z,t)),r.set(e,s,i)}const i=e[s];NodeUtils.setWorldPosition3D(i,r),tempVec3_b.set(i.position),NodeUtils.makeVec3InPrecision(tempVec3_b,3),i.position=tempVec3_b,this.broadcastNodeChangeMessage(i)}}}updateControllerTransform(){const t=this.node;if(!t)return;let o;const e=tempQuat_a;cc_1.Quat.identity(e),o="center"===transform_tool_data_1.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.target):NodeUtils.getWorldPosition3D(t),"global"!==transform_tool_data_1.transformToolData.coordinate&&NodeUtils.getWorldRotation3D(t,e),this._controller.setPosition(o),this._controller.setRotation(e)}}exports.default=PositionGizmo;