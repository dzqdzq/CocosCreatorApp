"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,frustum_controller_1=__importDefault(require("../controller/frustum-controller")),gizmo_base_1=__importDefault(require("../gizmo-base")),cc_1=require("cc"),scene_view_data_1=require("../../../../../3d/manager/scene/scene-view-data"),{getCameraData:getCameraData,setCameraData:setCameraData,ProjectionType:ProjectionType,FOVAxis:FOVAxis}=require("../../../utils/engine"),EditorMath=external_1.default.EditorMath,tempQuat_a=new cc_1.Quat;class CameraComponentGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._fov=0,this._near=0,this._far=0,this._aspect=0,this._farHalfWidth=0,this._farHalfHeight=0,this._projection=0,this._fovAxis=FOVAxis.VERTICAL,this._controller=null}init(){this.createController(),this._isInited=!0,scene_view_data_1.sceneViewData.on("target-resolution-changed",()=>{this.updateControllerData(),cce.Engine.repaintInEditMode()})}onShow(){this._controller.show(),this.updateControllerData()}onHide(){this._controller.hide()}createController(){let t=this.getGizmoRoot();this._controller=new frustum_controller_1.default(t),this._controller.editable=!0,this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){if(!this._isInited||null==this.target)return;let t=getCameraData(this.target);this._projection=t.projection,this._fov=t.fov,this._near=t.near,this._far=t.far,this._aspect=t.aspect,this._fovAxis=t.fovAxis,this._projection===ProjectionType.PERSPECTIVE?this._fovAxis===FOVAxis.VERTICAL?(this._farHalfHeight=Math.tan(EditorMath.deg2rad(this._fov/2))*this._far,this._farHalfWidth=this._farHalfHeight*this._aspect):(this._farHalfWidth=Math.tan(EditorMath.deg2rad(this._fov/2))*this._far,this._farHalfHeight=this._farHalfWidth/this._aspect):(this._farHalfHeight=t.orthoHeight,this._farHalfWidth=this._farHalfHeight*this._aspect)}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){}updateDataFromController(){if(this._controller.updated){let t=this._controller.getDeltaWidth(),e=this._controller.getDeltaHeight(),o=this._controller.getDeltaDistance(),i=this._farHalfHeight,r=this._farHalfWidth;0!==t&&(i=(r=this._farHalfWidth+t)/this._aspect),0!==e&&(r=(i=this._farHalfHeight+e)*this._aspect);let a=this._far;if(0!==o&&(a=this._far+o,(a=Math.abs(a))<this._near&&(a=this._near+.01),a=EditorMath.toPrecision(a,3)),i=Math.abs(i),this._projection===ProjectionType.PERSPECTIVE){let t=this._fov,e=i;this._fovAxis===FOVAxis.HORIZONTAL&&(e=r),i===this._farHalfHeight&&r===this._farHalfWidth||((t=2*Math.atan2(e,this._far))<EditorMath.D2R&&(t=EditorMath.D2R),t*=EditorMath.R2D,t=EditorMath.toPrecision(t,3)),setCameraData(this.target,{fov:t,far:a})}else i=EditorMath.toPrecision(i,3),setCameraData(this.target,{orthoHeight:i,far:a});const s=this.node;this.onComponentChanged(s)}}updateControllerTransform(){let t=this.node,e=NodeUtils.getWorldPosition3D(t);const o=tempQuat_a;NodeUtils.getWorldRotation3D(t,o),this._controller.setPosition(e),this._controller.setRotation(o)}updateControllerData(){if(!this._isInited||null==this.target)return;let t=getCameraData(this.target);const e=scene_view_data_1.sceneViewData.targetAspect;t&&(this._controller.checkEdit(),this._controller.updateSize(t.projection,t.orthoHeight,t.fov,e,t.near,t.far,t.fovAxis),this.updateControllerTransform())}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=CameraComponentGizmo;