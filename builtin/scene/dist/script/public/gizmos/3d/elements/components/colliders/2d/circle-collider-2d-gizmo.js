"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const gizmo_base_1=__importDefault(require("../../../gizmo-base")),external_1=__importDefault(require("../../../../../utils/external")),cc_1=require("cc"),disc_controller_1=__importDefault(require("../../../controller/disc-controller")),Utils=require("../../../../../utils"),NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,GizmoUtils=Utils.GizmoUtils,MVec3=EditorMath.MVec3,HandleType=disc_controller_1.default.DiscHandleType,tempQuat_a=new cc_1.Quat,tempMat4=new cc_1.Mat4,tempVec2=new cc_1.Vec2;class CircleCollider2DGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._radius=0,this._offset=new cc_1.Vec2,this._propRadiusPath=null,this._propOffsetPath=null,this._maxScale=1}init(){this.createController()}onShow(){this._controller.show(),this.updateController()}onHide(){this._controller.hide()}createController(){this._controller=new disc_controller_1.default(this.getGizmoRoot()),this._controller.editable=!0,this._controller.setColor(new cc.Color(107,194,53)),this._controller.setEditHandlesColor(new cc.Color(107,194,53)),this._controller.setAreaOpacity(50),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._radius=this.target.radius,this._offset=this.target.offset.clone(),this._propRadiusPath=this.getCompPropPath("radius"),this._propOffsetPath=this.getCompPropPath("offset");const t=NodeUtils.getWorldScale3D(this.node);this._maxScale=GizmoUtils.getMaxCompInVec3(t)}onControllerMouseMove(){if(this._controller.updated){let t=this._controller.getCurHandleType();if(this._curHandleType=t,t===HandleType.Area){this.onControlUpdate(this._propRadiusPath);let t=this._controller.getDeltaPos();this.handleAreaMove(t)}else{let t=this._controller.getDeltaRadius();this.handleRadius(t)}}}onControllerMouseUp(){this._curHandleType===HandleType.Area?this.onControlEnd(this._propOffsetPath):this.onControlEnd(this._propRadiusPath)}handleAreaMove(t){let e=this.node,o=t.clone();e&&(e.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,MVec3.transformMat4(o,o,tempMat4)),NodeUtils.makeVec3InPrecision(o,1),o.z=0,tempVec2.set(this._offset),tempVec2.add2f(o.x,o.y),this.target.offset=tempVec2,this.onComponentChanged(e)}handleRadius(t){const e=EditorMath.toPrecision(this._radius+t/this._maxScale,1);this.target.radius=e,this.onComponentChanged(this.node)}updateControllerData(){if(!this._isInited||null===this.target)return;let t=this.target;if(t){let e=this.node;e&&e.getWorldMatrix(tempMat4);let o=t.radius,r=t.offset,l=cc.v3();l.x=r.x,l.y=r.y;let i=NodeUtils.getWorldScale3D(e);cc_1.Vec3.transformMat4(l,l,tempMat4);let s=tempQuat_a;NodeUtils.getWorldRotation3D(e,s),this._controller.setPosition(l),this._controller.setRotation(s);let n=i.x;this._controller.updateSize(cc_1.Vec3.ZERO,o*n),this._controller.edit=t.editing}else this._controller.hide()}updateController(){this.updateControllerData()}onTargetUpdate(){this.updateController()}onNodeChanged(){this.updateController()}}exports.default=CircleCollider2DGizmo;