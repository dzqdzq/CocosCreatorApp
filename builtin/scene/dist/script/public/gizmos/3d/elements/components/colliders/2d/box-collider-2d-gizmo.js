"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const gizmo_base_1=__importDefault(require("../../../gizmo-base")),rectangle_controller_1=__importDefault(require("../../../controller/rectangle-controller")),external_1=__importDefault(require("../../../../../utils/external")),cc_1=require("cc"),Utils=require("../../../../../utils"),NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,HandleType=rectangle_controller_1.default.RectHandleType,tempQuat_a=new cc_1.Quat,tempMat4=new cc_1.Mat4,tempVec2=new cc_1.Vec2;class BoxCollider2DGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._size=new cc_1.Size,this._offset=new cc_1.Vec2,this._anchor=new cc_1.Vec2(.5,.5),this._altKey=!1,this._propPath=null}init(){this.createController()}onShow(){this._controller.show(),this.updateController()}onHide(){this._controller.hide()}createController(){this._controller=new rectangle_controller_1.default(this.getGizmoRoot()),this._controller.editable=!0,this._controller.setColor(new cc.Color(107,194,53)),this._controller.setEditHandlesColor(new cc.Color(107,194,53)),this._controller.setAreaOpacity(50),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._size=this.target.size.clone(),this._offset=this.target.offset.clone(),this._propPath=this.getCompPropPath("size")}onControllerMouseMove(){if(this._controller.updated){this.onControlUpdate(this._propPath);let t=this._controller.getCurHandleType(),e=this._controller.getDeltaSize();if(t===HandleType.Area)this.handleAreaMove(e);else{let o=this._altKey;this.handleTargetSize(t,e,o)}}}onControllerMouseUp(){this.onControlEnd(this._propPath)}onKeyDown(t){this._altKey=t.altKey}onKeyUp(t){this._altKey=t.altKey}handleAreaMove(t){let e=this.node,o=t.clone();e&&(e.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(o,o,tempMat4)),o.z=0,tempVec2.set(this._offset),tempVec2.add2f(o.x,o.y),NodeUtils.makeVec2InPrecision(tempVec2,1),this.target.offset.set(tempVec2),this.onComponentChanged(e)}modifyPosDeltaWithAnchor(t,e,o,r,l){t===HandleType.Right||t===HandleType.TopRight||t===HandleType.BottomRight?(l&&(o.x/=1-r.x),e.x=o.x*r.x):(l&&(o.x/=r.x),e.x=-o.x*(1-r.x)),t===HandleType.Bottom||t===HandleType.BottomRight||t===HandleType.BottomLeft?(l&&(o.y/=r.y),e.y=-o.y*(1-r.y)):(l&&(o.y/=1-r.y),e.y=o.y*r.y)}handleTargetSize(t,e,o){let r=e.clone(),l=new cc_1.Vec2(e.x,e.y);l.x=EditorMath.toPrecision(l.x,3),l.y=EditorMath.toPrecision(l.y,3),this.modifyPosDeltaWithAnchor(t,r,l,this._anchor,o);let i=this.node;if(i&&(i.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(r,r,tempMat4)),!o){let t=tempQuat_a;i.getRotation(t),cc_1.Vec3.transformQuat(r,r,t),r.z=0,tempVec2.set(this._offset),tempVec2.add2f(r.x,r.y),NodeUtils.makeVec2InPrecision(tempVec2,1),this.target.offset=tempVec2}let n=new cc_1.Vec3;i.getWorldScale(n),l.x=l.x/n.x,l.y=l.y/n.y;let s=this._size.width+l.x,a=this._size.height+l.y;s=EditorMath.toPrecision(s,1),a=EditorMath.toPrecision(a,1),this.target.size=cc.size(s,a),this.onComponentChanged(i)}updateControllerData(){if(!this._isInited||null===this.target)return;let t=this.target;if(t){let e=this.node;e&&e.getWorldMatrix(tempMat4);let o=t.size,r=t.offset,l=cc.v3();l.x=r.x,l.y=r.y;let i=NodeUtils.getWorldScale3D(e);cc_1.Vec3.transformMat4(l,l,tempMat4);let n=tempQuat_a;NodeUtils.getWorldRotation3D(e,n),this._controller.setPosition(l),this._controller.setRotation(n),this._controller.updateSize(cc_1.Vec3.ZERO,cc.v2(o.width*i.x,o.height*i.y)),this._controller.edit=t.editing}else this._controller.hide()}updateController(){this.updateControllerData()}onTargetUpdate(){this.updateController()}onNodeChanged(){this.updateController()}}exports.default=BoxCollider2DGizmo;