"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),light_probe_controller_1=__importDefault(require("./light-probe-controller")),index_1=__importDefault(require("../../../utils/engine/index")),{setMeshColor:setMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null===(e=cc_1.director.getScene())||void 0===e?void 0:e.globals};class LightProbeTetrahedronController extends controller_base_1.default{constructor(e,r){super(e),this.targetDelegate=r,this._lockSize=!0,this._isInitialized=!1,this._probeSphere=controller_utils_1.default.create3DNode("ProbeSphere"),this._innerTetrahedron=controller_utils_1.default.create3DNode("InnerTetrahedron"),this._probeSphereNodes=[],this._currentTetrahedronIndex=0,this.initShape(),this.registerCameraMovedEvent()}static get Name(){return`LightProbeGroupController_${LightProbeTetrahedronController.Count++}`}initShape(){this.createShapeNode(LightProbeTetrahedronController.Name),this._probeSphere.parent=this.shape,this.initProbeSphere(),this._innerTetrahedron.parent=this.shape,this.clearLayer(this._probeSphere),this.clearLayer(this._innerTetrahedron),this.hide(),this.updateController()}initProbeSphere(){const e=new cc_1.Material,r=controller_utils_1.default.sphere((0,cc_1.v3)(0,0,0),5,LightProbeTetrahedronController.ProbeColor,{instancing:!0,depthTestForTriangles:!0},e);e.isInitialized=!0;const t=r.getComponent(cc_1.MeshRenderer).mesh;this._probeSphereNodes.push(r);for(let r=0;r<3;r++){const r=controller_utils_1.default.create3DNode();addMeshToNode(r,t,{instancing:!0,depthTestForTriangles:!0},e),setMeshColor(r,LightProbeTetrahedronController.ProbeColor),this._probeSphereNodes.push(r)}for(const[e,r]of this._probeSphereNodes.entries())r.noNeedCommitChanges=!0,r.name=`TetrahedronController_ProbeSphere_${e}`,this.clearLayer(r),r.parent=this._probeSphere}show(){var e,r;null!==(r=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())&&void 0!==r&&r&&super.show()}updateController(){var e,r;if(null===(r=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())||void 0===r||!r)return;super.updateController();const t=this.getTetrahedronIndex();t>=0&&this.updateInnerTetrahedron(t)}updateInnerTetrahedron(e){var r,t,o,n;const l=null===(t=null===(r=sceneGlobals())||void 0===r?void 0:r.lightProbeInfo)||void 0===t?void 0:t.data,i=null!==(o=null===l||void 0===l?void 0:l.probes)&&void 0!==o?o:[];if(0===i.length)return;const s=i.map(e=>e.position),a=null!==(n=null===l||void 0===l?void 0:l.tetrahedrons)&&void 0!==n?n:[];if(0===a.length)return;const h=a[e],d=[h.vertex0,h.vertex1,h.vertex2];if(h.isInnerTetrahedron()&&d.push(h.vertex3),this._probeSphereNodes[this._probeSphereNodes.length-1].active=h.isInnerTetrahedron(),d.forEach((e,r)=>{this._probeSphereNodes[r].setPosition(s[e])}),h.isInnerTetrahedron())controller_utils_1.default.drawLines(this._innerTetrahedron,d.map(e=>s[e]),light_probe_controller_1.default.TetrahedronLines,LightProbeTetrahedronController.LineColor);else if(h.isOuterCell()){const e=d.map(e=>(0,cc_1.v3)(i[e].position));e.push(...d.map(e=>(0,cc_1.v3)(i[e].position).add(i[e].normal))),s.length>0&&controller_utils_1.default.drawLines(this._innerTetrahedron,e,light_probe_controller_1.default.OuterCellLines,LightProbeTetrahedronController.LineColor)}}clearLayer(e){e.layer=cc_1.Layers.Enum.IGNORE_RAYCAST}getProbesData(){}getTetrahedronIndex(){const e=this.targetDelegate.target.model;return!e||e.tetrahedronIndex<0?-1:e.tetrahedronIndex}adjustControllerSize(){for(const e of this._probeSphereNodes){let r=1;this._lockSize&&(r=this.getDistScalar(e));const t=new cc_1.Vec3((0,cc_1.v3)(1,1,1));t.multiplyScalar(r),e.setScale(t)}}}exports.default=LightProbeTetrahedronController,LightProbeTetrahedronController.Count=0,LightProbeTetrahedronController.ProbeColor=new cc_1.Color("ACEDCF"),LightProbeTetrahedronController.LineColor=new cc_1.Color("CEF6E2");