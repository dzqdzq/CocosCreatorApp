"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),light_probe_controller_1=__importDefault(require("./light-probe-controller")),index_1=__importDefault(require("../../../utils/engine/index")),{setMeshSHCoefficients:setMeshSHCoefficients,setMeshColor:setMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null===(e=cc_1.director.getScene())||void 0===e?void 0:e.globals};class LightProbeTetrahedronController extends controller_base_1.default{constructor(e,r){super(e),this.targetDelegate=r,this._lockSize=!0,this._isInitialized=!1,this._probeSphere=controller_utils_1.default.create3DNode("ProbeSphere"),this._innerTetrahedron=controller_utils_1.default.create3DNode("InnerTetrahedron"),this._probeSphereNodes=[],this._currentTetrahedronIndex=0,this._probeSHData=new Float32Array(cc_1.pipeline.UBOSH.COUNT),this.initShape(),this.registerCameraMovedEvent()}static get Name(){return`LightProbeGroupController_${LightProbeTetrahedronController.Count++}`}initShape(){this.createShapeNode(LightProbeTetrahedronController.Name),this._probeSphere.parent=this.shape,this.initProbeSphere(),this._innerTetrahedron.parent=this.shape,this.clearLayer(this._probeSphere),this.clearLayer(this._innerTetrahedron),this.hide(),this.updateController()}initProbeSphere(){const e=new cc_1.Material,r={instancing:!1,depthTestForTriangles:!0,effectName:"internal/editor/light-probe-visualization",technique:0,useLightProbe:!0},t=controller_utils_1.default.sphere((0,cc_1.v3)(0,0,0),5,LightProbeTetrahedronController.ProbeColor,r,e),o=t.getComponent(cc_1.MeshRenderer).mesh;this._probeSphereNodes.push(t);for(let t=0;t<3;t++){const t=controller_utils_1.default.create3DNode();addMeshToNode(t,o,r,e),setMeshColor(t,LightProbeTetrahedronController.ProbeColor),this._probeSphereNodes.push(t)}for(const[e,r]of this._probeSphereNodes.entries())r.noNeedCommitChanges=!0,r.name=`TetrahedronController_ProbeSphere_${e}`,this.clearLayer(r),r.parent=this._probeSphere}show(){var e,r;null!==(r=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())&&void 0!==r&&r&&super.show()}updateController(){var e,r;if(null===(r=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())||void 0===r||!r)return;super.updateController();const t=this.getTetrahedronIndex();t>=0&&this.updateInnerTetrahedron(t)}updateInnerTetrahedron(e){var r,t,o,n,i,l;const s=null===(t=null===(r=sceneGlobals())||void 0===r?void 0:r.lightProbeInfo)||void 0===t?void 0:t.data,a=null===(n=null===(o=sceneGlobals())||void 0===o?void 0:o.lightProbeInfo)||void 0===n?void 0:n.reduceRinging,h=null!==(i=null===s||void 0===s?void 0:s.probes)&&void 0!==i?i:[];if(0===h.length)return;const d=h.map(e=>e.position),c=h.map(e=>e.coefficients),_=null!==(l=null===s||void 0===s?void 0:s.tetrahedrons)&&void 0!==l?l:[];if(0===_.length)return;const p=_[e],u=[p.vertex0,p.vertex1,p.vertex2];if(p.isInnerTetrahedron()&&u.push(p.vertex3),this._probeSphereNodes[this._probeSphereNodes.length-1].active=p.isInnerTetrahedron(),u.forEach((e,r)=>{if(this._probeSphereNodes[r].setPosition(d[e]),c[e].length>0){const r=c[e].slice();cc_1.SH.reduceRinging(r,a||0),cc_1.SH.updateUBOData(this._probeSHData,cc_1.pipeline.UBOSH.SH_LINEAR_CONST_R_OFFSET,r)}else for(let e=0;e<cc_1.pipeline.UBOSH.COUNT;e++)this._probeSHData[e]=0;setMeshSHCoefficients(this._probeSphereNodes[r],this._probeSHData)}),p.isInnerTetrahedron())controller_utils_1.default.drawLines(this._innerTetrahedron,u.map(e=>d[e]),light_probe_controller_1.default.TetrahedronLines,LightProbeTetrahedronController.LineColor);else if(p.isOuterCell()){const e=u.map(e=>(0,cc_1.v3)(h[e].position));e.push(...u.map(e=>(0,cc_1.v3)(h[e].position).add(h[e].normal))),d.length>0&&controller_utils_1.default.drawLines(this._innerTetrahedron,e,light_probe_controller_1.default.OuterCellLines,LightProbeTetrahedronController.LineColor)}}clearLayer(e){e.layer=cc_1.Layers.Enum.IGNORE_RAYCAST,e.children.forEach(e=>this.clearLayer(e))}getProbesData(){}getTetrahedronIndex(){const e=this.targetDelegate.target.model;return!e||e.tetrahedronIndex<0?-1:e.tetrahedronIndex}adjustControllerSize(){for(const e of this._probeSphereNodes){let r=1;this._lockSize&&(r=this.getDistScalar(e));const t=new cc_1.Vec3((0,cc_1.v3)(1,1,1));t.multiplyScalar(r),e.setScale(t)}}}exports.default=LightProbeTetrahedronController,LightProbeTetrahedronController.Count=0,LightProbeTetrahedronController.ProbeColor=new cc_1.Color("ACEDCF"),LightProbeTetrahedronController.LineColor=new cc_1.Color("CEF6E2");