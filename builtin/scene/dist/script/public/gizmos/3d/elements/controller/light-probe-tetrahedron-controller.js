"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const controller_base_1=__importDefault(require("./controller-base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),cc_1=require("cc"),light_probe_controller_1=__importStar(require("./light-probe-controller")),index_1=__importDefault(require("../../../utils/engine/index")),{setMeshSHCoefficients:setMeshSHCoefficients,setMeshColor:setMeshColor,addMeshToNode:addMeshToNode}=index_1.default,sceneGlobals=()=>{var e;return null===(e=cc_1.director.getScene())||void 0===e?void 0:e.globals};class LightProbeTetrahedronController extends controller_base_1.default{constructor(e,t){super(e),this.targetDelegate=t,this._lockSize=!0,this._isInitialized=!1,this._probeSphere=controller_utils_1.default.create3DNode("ProbeSphere"),this._innerTetrahedron=controller_utils_1.default.create3DNode("InnerTetrahedron"),this._probeSphereNodes=[],this._currentTetrahedronIndex=0,this._probeSHData=new Float32Array(cc_1.pipeline.UBOSH.COUNT),this.lightProbeInfo=light_probe_controller_1.lightProbeInfo,this.tempAdjustSizeV3=new cc_1.Vec3,this.initShape(),this.registerCameraMovedEvent()}static get Name(){return`LightProbeGroupController_${LightProbeTetrahedronController.Count++}`}initShape(){this.createShapeNode(LightProbeTetrahedronController.Name),this._probeSphere.parent=this.shape,this.initProbeSphere(),this._innerTetrahedron.parent=this.shape,this.clearLayer(this._probeSphere),this.clearLayer(this._innerTetrahedron),this.hide(),cce.Engine.repaintInEditMode(),cc.director.once(cc.Director.EVENT_AFTER_DRAW,()=>{this.updateController()})}initProbeSphere(){const e=new cc_1.Material,t={instancing:!1,depthTestForTriangles:!0,effectName:"internal/editor/light-probe-visualization",technique:0,useLightProbe:!0},r=controller_utils_1.default.sphere((0,cc_1.v3)(0,0,0),5,LightProbeTetrahedronController.ProbeColor,t,e),o=r.getComponent(cc_1.MeshRenderer).mesh;this._probeSphereNodes.push(r);for(let r=0;r<3;r++){const r=controller_utils_1.default.create3DNode();addMeshToNode(r,o,t,e),setMeshColor(r,LightProbeTetrahedronController.ProbeColor),this._probeSphereNodes.push(r)}for(const[e,t]of this._probeSphereNodes.entries())t.noNeedCommitChanges=!0,t.name=`TetrahedronController_ProbeSphere_${e}`,this.clearLayer(t),t.parent=this._probeSphere;this.adjustControllerSize()}show(){var e,t;null!==(t=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())&&void 0!==t&&t&&(super.show(),this.updateLightProbeInfo(),this.updateController())}updateController(){var e,t;if(null===(t=null===(e=this.targetDelegate.target.model)||void 0===e?void 0:e.showTetrahedron())||void 0===t||!t)return;super.updateController(),this.updateLightProbeInfo();const r=this.getTetrahedronIndex();r>=0&&this.updateInnerTetrahedron(r),this.adjustControllerSize(),cce.Engine.repaintInEditMode()}updateLightProbeInfo(){var e;this.lightProbeInfo.update(null===(e=sceneGlobals())||void 0===e?void 0:e.lightProbeInfo)}updateInnerTetrahedron(e){var t,r,o,i,n,l;if(e<0)return;const s=null===(r=null===(t=sceneGlobals())||void 0===t?void 0:t.lightProbeInfo)||void 0===r?void 0:r.data,a=null===(i=null===(o=sceneGlobals())||void 0===o?void 0:o.lightProbeInfo)||void 0===i?void 0:i.reduceRinging,h=null!==(n=null===s||void 0===s?void 0:s.probes)&&void 0!==n?n:[];if(0===h.length)return;const d=h.map(e=>e.position),c=h.map(e=>e.coefficients),u=null!==(l=null===s||void 0===s?void 0:s.tetrahedrons)&&void 0!==l?l:[];if(0===u.length||e>u.length-1)return;const _=u[e],p=[_.vertex0,_.vertex1,_.vertex2];if(_.isInnerTetrahedron()&&p.push(_.vertex3),this._probeSphereNodes[this._probeSphereNodes.length-1].active=_.isInnerTetrahedron(),p.forEach((e,t)=>{if(this._probeSphereNodes[t].setPosition(d[e]),c[e].length>0){const t=c[e].slice();cc_1.SH.reduceRinging(t,a||0),cc_1.SH.updateUBOData(this._probeSHData,cc_1.pipeline.UBOSH.SH_LINEAR_CONST_R_OFFSET,t)}else for(let e=0;e<cc_1.pipeline.UBOSH.COUNT;e++)this._probeSHData[e]=0;setMeshSHCoefficients(this._probeSphereNodes[t],this._probeSHData)}),_.isInnerTetrahedron())controller_utils_1.default.drawLines(this._innerTetrahedron,p.map(e=>d[e]),light_probe_controller_1.default.TetrahedronLines,LightProbeTetrahedronController.LineColor);else if(_.isOuterCell()){const e=p.map(e=>(0,cc_1.v3)(h[e].position));e.push(...p.map(e=>(0,cc_1.v3)(h[e].position).add(h[e].normal))),d.length>0&&controller_utils_1.default.drawLines(this._innerTetrahedron,e,light_probe_controller_1.default.OuterCellLines,LightProbeTetrahedronController.LineColor)}}clearLayer(e){e.layer=cc_1.Layers.Enum.IGNORE_RAYCAST,e.children.forEach(e=>this.clearLayer(e))}getProbesData(){}getTetrahedronIndex(){const e=this.targetDelegate.target;if(!e)return-1;const t=e.model;return t?!t.node.activeInHierarchy||t.tetrahedronIndex<0?-1:t.tetrahedronIndex:-1}adjustControllerSize(){this.updateLightProbeInfo();for(const e of this._probeSphereNodes)this.tempAdjustSizeV3.set(this.lightProbeInfo.lightProbeSphereVolume,this.lightProbeInfo.lightProbeSphereVolume,this.lightProbeInfo.lightProbeSphereVolume),this.tempAdjustSizeV3.multiplyScalar(.06),e.setScale(this.tempAdjustSizeV3)}}exports.default=LightProbeTetrahedronController,LightProbeTetrahedronController.Count=0,LightProbeTetrahedronController.ProbeColor=new cc_1.Color("ACEDCF"),LightProbeTetrahedronController.LineColor=new cc_1.Color("CEF6E2");