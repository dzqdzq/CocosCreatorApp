"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,GizmoUtils=Utils.GizmoUtils,transform_gizmo_1=__importDefault(require("./transform-gizmo")),rotation_controller_1=__importDefault(require("../controller/rotation-controller")),transform_tool_data_1=require("../../../utils/transform-tool-data"),quat_1=require("../../../../../utils/math/quat"),EditorMath=external_1.default.EditorMath,MVec3=EditorMath.MVec3,GizmoConfig=require("../../../gizmo-config"),q_a=new cc_1.Quat,q_b=new cc_1.Quat,q_c=new cc_1.Quat,v3_a=new cc_1.Vec3,v3_b=new cc_1.Vec3;function minAngularDistance(t,o){return Math.min(Math.abs(t.x-o.x),Math.abs((t.x<0?360+t.x:t.x)-(o.x<0?360+o.x:o.x)))+Math.min(Math.abs(t.y-o.y),Math.abs((t.y<0?360+t.y:t.y)-(o.y<0?360+o.y:o.y)))+Math.min(Math.abs(t.z-o.z),Math.abs((t.z<0?360+t.z:t.z)-(o.z<0?360+o.z:o.z)))}class RotationGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._rotList=[],this._offsetList=[],this._center=new cc_1.Vec3(0,0),this._rotating=!1,this._keydownDelta=null}init(){this.createController()}layer(){return"foreground"}createController(){let t=new rotation_controller_1.default(this.getGizmoRoot());t.onControllerMouseDown=this.onControllerMouseDown.bind(this),t.onControllerMouseMove=this.onControllerMouseMove.bind(this),t.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller=t}onControllerMouseDown(){this._rotating=!0,this._rotList=[];const t=this.topNodes;for(let o=0;o<t.length;++o)if(GizmoConfig.isCreator2x&&this._controller.is2D)this._rotList.push(t[o].angle);else{const e=NodeUtils.getWorldRotation3D(t[o]);this._rotList.push(e)}if("center"===transform_tool_data_1.transformToolData.pivot){this._center=GizmoUtils.getCenterWorldPos3D(this.target),this._offsetList.length=0;for(let o=0;o<t.length;++o){let e=NodeUtils.getWorldPosition3D(t[o]),r=new cc_1.Vec3(e);r.subtract(this._center),this._offsetList.push(r)}}Utils.requestPointerLock()}onControllerMouseMove(t){this.updateDataFromController()}onControllerMouseUp(){if("center"===transform_tool_data_1.transformToolData.pivot){let t=GizmoUtils.getCenterWorldPos3D(this.target);this._controller.setPosition(t),this._controller.setRotation(cc_1.Quat.IDENTITY)}this._rotating=!1,this._controller.updated&&this.onControlEnd("rotation"),Utils.exitPointerLock()}onGizmoKeyDown(t){if(!this.target)return;let o=t.key.toLowerCase();if("arrowleft"!==o&&"arrowright"!==o&&"arrowup"!==o&&"arrowdown"!==o)return;this._rotating=!0;let e=t.shiftKey?10:1;if("arrowright"!==o&&"arrowdown"!==o||(e*=-1),!this._keydownDelta){this._keydownDelta=0;let t=this.topNodes;this._rotList=[];for(let o=0;o<t.length;++o)this._rotList.push(t[o].angle)}this._keydownDelta+=e,this.onControlUpdate("rotation"),this.updateRotationByZDeltaAngle(this._keydownDelta),Utils.repaintEngine()}onGizmoKeyUp(t){if(!this.target)return;let o=t.key.toLowerCase();if("arrowleft"===o||"arrowright"===o||"arrowup"===o||"arrowdown"===o){if("center"===transform_tool_data_1.transformToolData.pivot){let t=GizmoUtils.getCenterWorldPos3D(this.target);this._controller.setPosition(t),this._controller.setRotation(cc_1.Quat.IDENTITY)}this._keydownDelta=null,this._rotating=!1,this.onControlEnd("rotation")}}updateDataFromController(){GizmoConfig.isCreator2x&&this._controller.is2D?this.updateDataFromController2D():this.updateDataFromController3D()}getLocalRotFromWorldRot(t,o,e){return t.parent?(t.parent.getWorldRotation(q_c),cc_1.Quat.multiply(e,cc_1.Quat.conjugate(q_c,q_c),o)):e=o,e}repeat(t,o){return t-Math.floor(t/o)*o}setNodeWorldRotation3D(t,o){const e=q_b;this.getLocalRotFromWorldRot(t,o,e);const r=t.eulerAngles;cc_1.Quat.toEuler(v3_a,e,!1),cc_1.Quat.toEuler(v3_b,e,!0);const i=minAngularDistance(v3_a,r)<minAngularDistance(v3_b,r)?v3_a:v3_b;i.x=this.repeat(i.x-r.x+180,360)+r.x-180,i.y=this.repeat(i.y-r.y+180,360)+r.y-180,i.z=this.repeat(i.z-r.z+180,360)+r.z-180,NodeUtils.makeVec3InPrecision(i,3),t.eulerAngles=i}updateDataFromController3D(){if(this._controller.updated){let t;this.onControlUpdate("rotation");let o=q_b,e=this._controller.getDeltaRotation(),r=this.topNodes;if("center"===transform_tool_data_1.transformToolData.pivot)for(t=0;t<r.length;++t){let i=this._rotList[t];if(null==i)return;"global"===transform_tool_data_1.transformToolData.coordinate?cc_1.Quat.multiply(o,e,i):cc_1.Quat.multiply(o,i,e);const a=v3_b;MVec3.transformQuat(a,this._offsetList[t],e),v3_a.set(this._center),v3_a.add(a),NodeUtils.setWorldPosition3D(r[t],v3_a),this.setNodeWorldRotation3D(r[t],o),this.broadcastNodeChangeMessage(r[t])}else for(t=0;t<r.length;++t)"global"===transform_tool_data_1.transformToolData.coordinate?cc_1.Quat.multiply(o,e,this._rotList[t]):cc_1.Quat.multiply(o,this._rotList[t],e),this.setNodeWorldRotation3D(r[t],o),this.broadcastNodeChangeMessage(r[t])}}updateDataFromController2D(){if(this._controller.updated){this.onControlUpdate("rotation");let t=this._controller.getZDeltaAngle();this.updateRotationByZDeltaAngle(t)}}updateRotationByZDeltaAngle(t){let o;t=EditorMath.toPrecision(t,3);const e=q_a;let r=this.topNodes;if("center"===transform_tool_data_1.transformToolData.pivot)for(o=0;o<r.length;++o){let i=this._rotList[o];if(null==i)return;let a=i+t;r[o].angle=a,cc_1.Quat.fromEuler(e,0,0,t);let s=new cc.Vec3;MVec3.transformQuat(s,this._offsetList[o],e),v3_a.set(this._center),v3_a.add(s),NodeUtils.setWorldPosition3D(r[o],v3_a),this.broadcastNodeChangeMessage(r[o])}else for(o=0;o<r.length;++o){let e=this._rotList[o]+t;r[o].angle=e,this.broadcastNodeChangeMessage(r[o])}}updateControllerTransform(){const t=this.node;if(!t)return;let o,e=q_a;if(quat_1.MQuat.identity(e),"center"===transform_tool_data_1.transformToolData.pivot){if(this._rotating)return;o=GizmoUtils.getCenterWorldPos3D(this.target)}else o=NodeUtils.getWorldPosition3D(t);"global"===transform_tool_data_1.transformToolData.coordinate?e=this._controller.getDeltaRotation():NodeUtils.getWorldRotation3D(t,e),this._controller.setPosition(o),this._controller.setRotation(e)}}exports.default=RotationGizmo;