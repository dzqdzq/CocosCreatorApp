"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{AttributeName:AttributeName,getModel:getModel,updatePositions:updatePositions,setMeshColor:setMeshColor}=require("../../../utils/engine"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),EditorMath=external_1.default.EditorMath,MVec3=EditorMath.MVec3,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName;class SphereController extends editable_controller_1.default{constructor(e){super(e),this._center=new cc_1.Vec3,this._radius=100,this._deltaRadius=0,this._circleDataMap={},this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._controlDir=new cc_1.Vec3,this._editHandleKeys=[AxisName.x,AxisName.y,AxisName.neg_x,AxisName.neg_y,AxisName.neg_z],this.initShape()}get radius(){return this._radius}set radius(e){this.updateSize(this._center,e)}setColor(e){Object.keys(this._circleDataMap).forEach(t=>{let i=this._circleDataMap[t];setMeshColor(i.arcMR.node,e)}),this.setEditHandlesColor(e),this._color=e}createCircleByAxis(e,t,i){let s=axisDirMap[e],r=axisDirMap[t],a=Math.PI;"neg_z"===e&&(a=EditorMath.TWO_PI);let o=controller_utils_1.default.arc(this._center,s,r,a,this._radius,i);o.parent=this.shape;let l={};l.arcMR=getModel(o),l.normalDir=s,l.fromDir=r,this._circleDataMap[e]=l}_updateEditHandle(e){let t=this._handleDataMap[e].topNode,i=axisDirMap[e],s=new cc_1.Vec3;MVec3.multiplyScalar(s,i,this._radius);let r=new cc_1.Vec3(s);r.add(this._center),MVec3.multiply(r,r,this.getScale()),t.setPosition(r.x,r.y,r.z)}initShape(){this.createShapeNode("SphereController"),this._circleDataMap={},this.createCircleByAxis("x","neg_y",this._color),this.createCircleByAxis("y","x",this._color),this.createCircleByAxis("neg_z","x",this._color),this.hide()}updateSize(e,t){this._center=e,this._radius=t,Object.keys(this._circleDataMap).forEach(e=>{let t=this._circleDataMap[e].normalDir,i=this._circleDataMap[e].fromDir,s=this._circleDataMap[e].arcMR,r=Math.PI;"neg_z"===e&&(r=EditorMath.TWO_PI),this.updateArcMesh(s,this._center,t,i,r,this._radius)}),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}updateArcMesh(e,t,i,s,r,a){let o=controller_shape_1.default.calcArcPoints(t,i,s,r,a);updatePositions(e,o)}onMouseDown(e){this._mouseDeltaPos=cc.v2(0,0),this._curDistScalar=super.getDistScalar(),this._controlDir=new cc_1.Vec3(0,0,0),this.onControllerMouseDown&&this.onControllerMouseDown(e)}onMouseMove(e){if(this._isMouseDown){this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY;let t=axisDirMap[e.handleName];this._controlDir=t,this._deltaRadius=this.getAlignAxisMoveDistance(this.localToWorldDir(t),this._mouseDeltaPos)*this._curDistScalar,this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}getDeltaRadius(){return this._deltaRadius}getControlDir(){return this._controlDir}}exports.default=SphereController;