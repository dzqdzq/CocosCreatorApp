"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const editable_controller_1=__importDefault(require("./editable-controller")),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),{AttributeName:AttributeName,getModel:getModel,updatePositions:updatePositions,setMeshColor:setMeshColor,setNodeOpacity:setNodeOpacity,getNodeOpacity:getNodeOpacity,panPlaneLayer:panPlaneLayer,updateBoundingBox:updateBoundingBox}=require("../../../utils/engine"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),EditorCamera=external_1.default.EditorCamera,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;var RectHandleType;!function(e){e.None="none",e.TopLeft="tl",e.TopRight="tr",e.BottomLeft="bl",e.BottomRight="br",e.Left="neg_x",e.Right="x",e.Top="y",e.Bottom="neg_y",e.Area="area",e.Anchor="anchor"}(RectHandleType||(RectHandleType={}));class RectangleController extends editable_controller_1.default{constructor(e,t={}){super(e),this._center=new cc_1.Vec3,this._size=new cc_1.Vec2(100,100),this._deltaSize=new cc_1.Vec3,this._curHandleType=RectHandleType.None,this._rectNode=null,this._panPlane=null,this._areaMR=null,this._rectMR=null,this._mouseDownOnPlanePos=new cc_1.Vec3,this._areaColor=cc_1.Color.GREEN,this._areaOpacity=0,this._axisDir={},this._defaultEditHandleSize=10,this._axisDir.x=new cc_1.Vec3(1,0,0),this._axisDir.y=new cc_1.Vec3(0,1,0),this._axisDir[RectHandleType.Left]=new cc_1.Vec3(-1,0,0),this._axisDir[RectHandleType.Bottom]=new cc_1.Vec3(0,-1,0),this._axisDir[RectHandleType.TopLeft]=new cc_1.Vec3(-1,1,0),this._axisDir[RectHandleType.TopRight]=new cc_1.Vec3(1,1,0),this._axisDir[RectHandleType.BottomLeft]=new cc_1.Vec3(-1,-1,0),this._axisDir[RectHandleType.BottomRight]=new cc_1.Vec3(1,-1,0),t.needAnchor&&(this._axisDir[RectHandleType.Anchor]=new cc_1.Vec3),this._editHandleKeys=Object.keys(this._axisDir),this._hoverColor=controller_utils_1.default.YELLOW,this.initShape()}setColor(e){this._rectNode&&(this._color=e,setMeshColor(this._rectNode,e))}setOpacity(e){this._rectNode&&setNodeOpacity(this._rectNode,e)}setAreaColor(e){this._areaColor=e,this._areaNode&&setMeshColor(this._areaNode,e)}setAreaOpacity(e){this._areaOpacity=e,this._areaNode&&setNodeOpacity(this._areaNode,e)}isBorder(e){return e===RectHandleType.Left||e===RectHandleType.Right||e===RectHandleType.Top||e===RectHandleType.Bottom}isCorner(e){return e===RectHandleType.TopLeft||e===RectHandleType.TopRight||e===RectHandleType.BottomLeft||e===RectHandleType.BottomRight}onInitEditHandles(){let e=controller_utils_1.default.quad(new cc_1.Vec3,1e5,1e5);e.parent=this._rootNode,e.name="RectPanPlane",e.active=!1,e.layer=panPlaneLayer,setNodeOpacity(e,0),this._panPlane=e;let t=controller_utils_1.default.quad(new cc_1.Vec3,100,100,new cc_1.Vec3(0,0,1),this._areaColor,{unlit:!0});t.name="RectArea",t.parent=this.shape,t.setPosition(new cc_1.Vec3(0,0,-.1)),setNodeOpacity(t,this._areaOpacity),this._areaNode=t,this._areaMR=getModel(t),this.initHandle(t,RectHandleType.Area)}showEditHandles(){super.showEditHandles(),this._areaNode&&(this._areaNode.active=!0)}hideEditHandles(){super.hideEditHandles(),this._areaNode&&(this._areaNode.active=!1)}_updateEditHandle(e){let t=this._handleDataMap[e].topNode,i=this._axisDir[e],a=this._editHandleScales[e];if(e===RectHandleType.Anchor)t.setScale(a/this.getScale().x,a/this.getScale().y,a/this.getScale().z),t.setWorldPosition(this.getPosition());else{let e=new cc_1.Vec3;e.x=i.x*this._size.x/2,e.y=i.y*this._size.y/2;let s=new cc_1.Vec3(e);s.add(this._center),t.setScale(a/this.getScale().x,a/this.getScale().y,a/this.getScale().z),cc_1.Vec3.multiply(s,s,this.getScale()),t.setPosition(s.x,s.y,s.z)}}initShape(){this.createShapeNode("RectangleController"),this._rectNode=controller_utils_1.default.rectangle(this._center,cc_1.Quat.IDENTITY,this._size,this._color,{unlit:!0}),this._rectNode.parent=this.shape,this._rectMR=getModel(this._rectNode),EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}updateSize(e,t){this._center.set(e),this._size.set(t),this._size.x<0||this._size.y<0?setMeshColor(this._rectNode,cc_1.Color.RED):setMeshColor(this._rectNode,this._color);let i=controller_shape_1.default.calcRectanglePoints(this._center,cc_1.Quat.IDENTITY,this._size);if(updatePositions(this._rectMR,i.vertices),this._edit){this.updateEditHandles();let e=controller_shape_1.default.calcQuadData(this._center,this._size.x,this._size.y);updatePositions(this._areaMR,e.positions),updateBoundingBox(this._areaMR,e.minPos,e.maxPos)}this.adjustEditHandlesSize()}onMouseDown(e){this.edit&&(cc_1.Vec3.set(this._deltaSize,0,0,0),this._panPlane.active=!0,this._mouseDownOnPlanePos=new cc_1.Vec3,this.getPositionOnPanPlane(this._mouseDownOnPlanePos,e.x,e.y,this._panPlane),this.onControllerMouseDown&&this.onControllerMouseDown(e))}onMouseMove(e){if(this.edit&&this._isMouseDown){let t=new cc_1.Vec3;if(this.getPositionOnPanPlane(t,e.x,e.y,this._panPlane)){let i=new cc_1.Vec3(t);i.subtract(this._mouseDownOnPlanePos),this._curHandleType=e.handleName;let a=this._axisDir[e.handleName],s=0;this.isBorder(e.handleName)?(cc_1.Vec3.transformQuat(tempVec3,a,this.getRotation()),s=i.dot(tempVec3),this._curHandleType===RectHandleType.Left||this._curHandleType===RectHandleType.Right?this._deltaSize.x=s:this._deltaSize.y=s):this.isCorner(e.handleName)?(tempVec3.x=a.x,tempVec3.y=0,tempVec3.z=0,cc_1.Vec3.transformQuat(tempVec3,tempVec3,this.getRotation()),s=i.dot(tempVec3),this._deltaSize.x=s,tempVec3.x=0,tempVec3.y=a.y,tempVec3.z=0,cc_1.Vec3.transformQuat(tempVec3,tempVec3,this.getRotation()),s=i.dot(tempVec3),this._deltaSize.y=s):this._deltaSize=i}this.onControllerMouseMove&&this.onControllerMouseMove(e)}}onMouseUp(e){this._curHandleType=RectHandleType.None,this._panPlane.active=!1,this.onControllerMouseUp&&this.onControllerMouseUp(e)}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){if(this.edit)if(e.handleName!==RectHandleType.Area)this.setHandleColor(e.handleName,this._hoverColor);else{let t=getNodeOpacity(this._areaNode);t>0&&this.setHandleColor(e.handleName,this._hoverColor,t)}}onHoverOut(){this.resetHandleColor()}getDeltaSize(){return this._deltaSize.z=0,this._deltaSize}getCurHandleType(){return this._curHandleType}}RectangleController.RectHandleType=RectHandleType,exports.default=RectangleController;