"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorSelect=exports.TerrainEditorWeightMapData=void 0;const terrain_editor_mode_1=require("./terrain-editor-mode"),cc_1=require("cc");class TerrainEditorWeightMapData{constructor(){this.data=new Uint8Array,this.width=0,this.height=0}}exports.TerrainEditorWeightMapData=TerrainEditorWeightMapData;class TerrainEditorSelect extends terrain_editor_mode_1.TerrainEditorMode{constructor(e){super(e),this._selectMaterial=null,this._selectBlock=null,this._weightMap=null,this._weightData=null,this._layerList=[];const t=cc.EffectAsset.get("editor/terrain-select-brush");t&&(this._selectMaterial=new cc_1.Material,this._selectMaterial.initialize({effectAsset:t}))}setSelectBlock(e){if(this._selectBlock!==e)if(cce.Plugin.sendToFloatWindow("cc.Terrain",{action:"block-update"}),this._selectBlock&&this._updateBlockSelectMaterial(this._selectBlock,null),null!==e){const t=e.getTerrain();if(this._selectBlock=e,this._weightMap=e.weightmap,this._weightData=null,this._weightMap){this._weightData=new TerrainEditorWeightMapData,this._weightData.width=t.info.weightMapSize,this._weightData.height=t.info.weightMapSize,this._weightData.data=new Uint8Array(this._weightData.width*this._weightData.height*4);let i=0;const c=e.getIndex()[0]*t.info.weightMapSize,a=e.getIndex()[1]*t.info.weightMapSize,l=c+t.info.weightMapSize,r=a+t.info.weightMapSize;for(let t=a;t<r;++t)for(let a=c;a<l;++a){const c=e.getTerrain().getWeight(a,t);this._weightData.data[i++]=cc_1.clamp(255*c.x,0,255),this._weightData.data[i++]=cc_1.clamp(255*c.y,0,255),this._weightData.data[i++]=cc_1.clamp(255*c.z,0,255),this._weightData.data[i++]=cc_1.clamp(255*c.w,0,255)}}this._layerList.length=e.layers.length;for(let t=0;t<e.layers.length;++t){const i=e.layers[t];if(i>=0){const c=e.getTerrain().getLayer(i);this._layerList[t]=c?c.detailMap:null}else this._layerList[t]=null}this._updateBlockSelectMaterial(e,this._selectMaterial)}else this._selectBlock=null,this._weightMap=null,this._weightData=null,this._layerList=[]}getSelectBlock(){return this._selectBlock}getCurrentBlockIndex(){return this._selectBlock?this._selectBlock.getIndex():null}getCurrentWeightMap(){return this._weightMap}getCurrentWeightData(){return this._weightData}getCurrentLayerList(){return this._layerList}onDeactivate(){this.setSelectBlock(null)}onMouseDown(e,t,i,c){const a=t.node.getPosition(),l=new cc_1.Vec3(0,0,0),r=new cc_1.Vec3(0,0,0);t.screenToWorld(new cc_1.Vec3(i,c,0),l),cc_1.Vec3.subtract(r,l,a),cc_1.Vec3.normalize(r,r);const s=this._pickTerrainBlock(e,a,r,.35);s&&this.setSelectBlock(s)}_pickTerrainBlock(e,t,i,c){const a=t;cc_1.Vec3.subtract(a,t,e.node.getWorldPosition());const l=new cc_1.Vec3;l.set(i),l.multiplyScalar(c);let r=null;if(i.equals(new cc_1.Vec3(0,1,0))){const t=e.getHeightAt(a.x,a.z);null!==t&&a.y<=t&&(r=new cc_1.Vec3(a.x,t,a.z))}else if(i.equals(new cc_1.Vec3(0,-1,0))){const t=e.getHeightAt(a.x,a.z);null!==t&&a.y>=t&&(r=new cc_1.Vec3(a.x,t,a.z))}else{let t=0;for(;t++<2e3;){const t=e.getHeightAt(a.x,a.z);if(null!==t&&a.y<=t)break;a.add(i)}for(;t++<2e3;){const t=e.getHeightAt(a.x,a.z);if(null!==t&&a.y<=t){r=new cc_1.Vec3(a.x,t,a.z);break}a.add(l)}}if(!r)return null;const s=new cc_1.Vec2(r.x,r.z);let n=null;for(const t of e.getBlocks()){const i=t.getIndex(),c=new cc_1.Rect;if(c.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,c.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,c.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,c.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*e.info.tileSize,c.contains(s)){n=t;break}}return n}_updateBlockSelectMaterial(e,t){e.setBrushMaterial(t)}}exports.TerrainEditorSelect=TerrainEditorSelect;