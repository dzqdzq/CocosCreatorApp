"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),cc_1=require("cc"),NodeUtils=external_1.default.NodeUtils,EditorMath=external_1.default.EditorMath,transform_gizmo_1=__importDefault(require("./transform-gizmo")),rectangle_controller_1=require("../controller/rectangle-controller"),rect_transform_snapping_1=require("../../../utils/rect-transform-snapping"),lines_controller_1=__importDefault(require("../controller/lines-controller")),transform_tool_data_1=require("../../../utils/transform-tool-data"),tempVec2=new cc_1.Vec2,tempVec3=new cc_1.Vec3,tempMat4=new cc_1.Mat4,tempQuat_a=new cc_1.Quat;function boundsToRect(e){return new cc_1.Rect(e[1].x,e[1].y,e[3].x-e[1].x,e[3].y-e[1].y)}class RectGizmo extends transform_gizmo_1.default{constructor(){super(...arguments),this._controller=null,this._worldPosList=[],this._localPosList=[],this._sizeList=[],this._anchorList=[],this._rectList=[],this._validTarget=[],this._tempRect=new cc_1.Rect,this._editRect=new cc_1.Rect,this._altKey=!1,this._snapDistVec2=new cc_1.Vec2}init(){this.createController()}layer(){return"foreground"}isNodeAnchorLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsAnchorLocked)}isNodeContentSizeLocked(e){return!!e&&e.components.some(e=>e._objFlags&cc_1.CCObject.Flags.IsSizeLocked)}createController(){const e=this.getGizmoRoot(),t=new rectangle_controller_1.RectangleController(e,{needAnchor:!0});t.editable=!0,t.setColor(new cc.Color(0,153,255)),t.setEditHandlesColor(new cc.Color(0,153,255)),t.onControllerMouseDown=this.onControllerMouseDown.bind(this),t.onControllerMouseMove=this.onControllerMouseMove.bind(this),t.onControllerMouseUp=this.onControllerMouseUp.bind(this),this._controller=t,this._nodeSnapLinesCtrl=new lines_controller_1.default(e),this._canvasSnapLinesCtrl=new lines_controller_1.default(e),this._equalSpacingLinesCtrl=new lines_controller_1.default(e,{dashed:!0})}onControllerMouseDown(){this._controller&&this.target&&(this._controller.contentSizeLocked=this.target.some(e=>this.isNodeContentSizeLocked(e)),this._controller.anchorLocked=this.target.some(e=>this.isNodeAnchorLocked(e))),this._worldPosList.length=0,this._localPosList.length=0,this._sizeList.length=0,this._anchorList.length=0,this._rectList.length=0,this._validTarget.length=0;for(let e=0;e<this.target.length;e++){const t=this.target[e],n=t.getComponent(cc_1.UITransform);n&&(this._validTarget.push(n),this._worldPosList.push(NodeUtils.getWorldPosition3D(t)),this._localPosList.push(t.getPosition()),this._sizeList.push(n.contentSize.clone()),this._anchorList.push(n.anchorPoint.clone()),this._rectList.push(NodeUtils.getWorldBounds(t)))}const e=this._validTarget.map(e=>e.node),t=this.getBounds(!1,!1,e);this._tempRect=boundsToRect(t);const n=transform_tool_data_1.transformToolData.scale2D,o=rect_transform_snapping_1.rectTransformSnapping.snapThreshold/n;if(this._snapDistVec2.x=o,this._snapDistVec2.y=o,rect_transform_snapping_1.rectTransformSnapping.enableSnapping){const e=this.target[0];e&&(rect_transform_snapping_1.rectTransformSnapping.calculateNodeSnapGuidelines(e.parent,e),rect_transform_snapping_1.rectTransformSnapping.calculateCanvasSnapGuidelines(),rect_transform_snapping_1.rectTransformSnapping.calculateSpacingSnapGuidelines(e.parent,e))}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("position"),this.clearNodeSnappingGuideline(),this.clearCanvasSnappingGuideline(),this.clearEqualSpacingGuideline()}onGizmoKeyDown(e){this._altKey=e.altKey}onGizmoKeyUp(e){this._altKey=e.altKey}handleAreaMove(e){for(let t=0;t<this._validTarget.length;t++){const n=this._validTarget[t].node,o=(this._localPosList[t],this._worldPosList[t]);let i=new cc_1.Vec3;if(cc_1.Vec3.add(i,o,e),0===t&&rect_transform_snapping_1.rectTransformSnapping.enableSnapping){const e=this._rectList[t];i=rect_transform_snapping_1.rectTransformSnapping.snapPosToNodeGuidelines(i,e,this._snapDistVec2),this.drawNodeSnappingGuideline(),i=rect_transform_snapping_1.rectTransformSnapping.snapPosToCanvasSnapGuidelines(i,e,this._snapDistVec2),this.drawCanvasSnappingGuideline(),i=rect_transform_snapping_1.rectTransformSnapping.snapPosToEqualSpacing(i,e,this._snapDistVec2),this.drawEqualSpacingGuideline()}i.x=EditorMath.toPrecision(i.x,3),i.y=EditorMath.toPrecision(i.y,3),NodeUtils.setWorldPosition(n,i)}}handleAnchorMove(e){if(this._validTarget.length>1)return;const t=this._validTarget[0],n=t.node,o=this._sizeList[0],i=this._anchorList[0],r=this._worldPosList[0],s=e.clone();NodeUtils.makeVec3InPrecision(s,3),tempVec3.set(r),tempVec3.add(s),n.setWorldPosition(tempVec3),n.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(s,s,tempMat4),tempVec2.x=s.x/o.width,tempVec2.y=s.y/o.height,tempVec2.add(i),t.anchorPoint=tempVec2}getSizePoint(e){const t=new cc.Vec2,n=this._rectList[0];return e===rectangle_controller_1.RectHandleType.Right||e===rectangle_controller_1.RectHandleType.TopRight||e===rectangle_controller_1.RectHandleType.BottomRight?t.x=n.x+n.width:t.x=n.x,e===rectangle_controller_1.RectHandleType.BottomLeft||e===rectangle_controller_1.RectHandleType.Bottom||e===rectangle_controller_1.RectHandleType.BottomRight?t.y=n.y:t.y=n.y+n.height,t}modifyPosDeltaWithAnchor(e,t,n,o,i){e===rectangle_controller_1.RectHandleType.Right||e===rectangle_controller_1.RectHandleType.TopRight||e===rectangle_controller_1.RectHandleType.BottomRight?(i&&(n.x/=1-o.x),t.x=n.x*o.x):(i&&(n.x/=o.x),t.x=-n.x*(1-o.x)),e===rectangle_controller_1.RectHandleType.Bottom||e===rectangle_controller_1.RectHandleType.BottomRight||e===rectangle_controller_1.RectHandleType.BottomLeft?(i&&(n.y/=o.y),t.y=-n.y*(1-o.y)):(i&&(n.y/=1-o.y),t.y=n.y*o.y)}formatSizeDelta(e,t){e!==rectangle_controller_1.RectHandleType.Left&&e!==rectangle_controller_1.RectHandleType.TopLeft&&e!==rectangle_controller_1.RectHandleType.BottomLeft||(t.x=-t.x),e!==rectangle_controller_1.RectHandleType.Bottom&&e!==rectangle_controller_1.RectHandleType.BottomRight&&e!==rectangle_controller_1.RectHandleType.BottomLeft||(t.y=-t.y)}handleOneTargetSize(e,t,n){const o=this._sizeList[0],i=t.clone();let r=new cc_1.Vec2(t.x,t.y);const s=this._localPosList[0],c=this._validTarget[0],a=c.node,l=this._anchorList[0];if(rect_transform_snapping_1.rectTransformSnapping.enableSnapping&&(this.formatSizeDelta(e,r),r=rect_transform_snapping_1.rectTransformSnapping.snapSizeToNodeGuidelines(this.getSizePoint(e),r,this._snapDistVec2),this.formatSizeDelta(e,r),this.drawNodeSnappingGuideline()),r.x=EditorMath.toPrecision(r.x,3),r.y=EditorMath.toPrecision(r.y,3),this.modifyPosDeltaWithAnchor(e,i,r,l,n),a.parent&&(a.parent.getWorldMatrix(tempMat4),cc_1.Mat4.invert(tempMat4,tempMat4),tempMat4.m12=tempMat4.m13=0,cc_1.Vec3.transformMat4(i,i,tempMat4)),!n){const e=tempQuat_a;a.getRotation(e),cc_1.Vec3.transformQuat(i,i,e),i.z=0,tempVec3.set(s),tempVec3.add(i),a.setPosition(tempVec3)}const h=new cc_1.Vec3;a.getWorldScale(h),r.x=r.x/h.x,r.y=r.y/h.y;const _=o.width+r.x,p=o.height+r.y;c.contentSize=cc.size(_,p)}handleMultiTargetSize(e,t,n){const o=this._tempRect,i=new cc_1.Vec2(t.x,t.y),r=t.clone(),s=new cc_1.Vec2(0,0);i.x=EditorMath.toPrecision(i.x,3),i.y=EditorMath.toPrecision(i.y,3),this.modifyPosDeltaWithAnchor(e,r,i,s,!1);const c=o.clone();c.x=o.x+r.x,c.y=o.y+r.y,c.width=o.width+i.x,c.height=o.height+i.y,this._editRect=c;for(let e=0,t=this._validTarget.length;e<t;e++){const t=this._validTarget[e],n=t.node,r=this._worldPosList[e],s=(r.x-o.x)/o.width,a=(r.y-o.y)/o.height,l=new cc_1.Vec3(c.x+s*c.width,c.y+a*c.height,r.z);n.setWorldPosition(l);const h=this._rectList[e],_=h.width/o.width,p=h.height/o.height,d=this._sizeList[e],u=i.clone();u.x=u.x*_,u.y=u.y*p;const g=new cc_1.Vec3;n.getWorldScale(g),u.x=u.x/g.x,u.y=u.y/g.y,t.contentSize=cc.size(d.width+u.x,d.height+u.y)}}getBounds(e,t,n){let o,i=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=Number.MAX_VALUE,c=-Number.MAX_VALUE;function a(e){e.x>r&&(r=e.x),e.x<i&&(i=e.x),e.y>c&&(c=e.y),e.y<s&&(s=e.y)}return n.forEach(e=>{if(e.getComponent(cc_1.UITransform)){const t=NodeUtils.getWorldOrientedBounds(e);a(t[0]),a(t[1]),a(t[2]),a(t[3])}}),e&&(o=i,i=r,r=o),t&&(o=s,s=c,c=o),[new cc_1.Vec2(i,c),new cc_1.Vec2(i,s),new cc_1.Vec2(r,s),new cc_1.Vec2(r,c)]}updateDataFromController(){if(this._controller.updated){this.onControlUpdate("position");const e=this._controller,t=e.getCurHandleType(),n=e.getDeltaSize();if(t===rectangle_controller_1.RectHandleType.Area)this.handleAreaMove(n);else if(t===rectangle_controller_1.RectHandleType.Anchor)this.handleAnchorMove(n);else{const e=this._altKey;this.target.length>1?this.handleMultiTargetSize(t,n,e):this.handleOneTargetSize(t,n,e)}}}updateControllerTransform(){this.updateControllerData()}updateControllerData(){if(!this._isInited||null==this.target)return;const e=this._controller;if(e.checkEdit(),1===this.target.length){const t=this.target[0],n=NodeUtils.getWorldPosition3D(t),o=tempQuat_a;NodeUtils.getWorldRotation3D(t,o);const i=NodeUtils.getWorldScale3D(t);e.setPosition(n),e.setRotation(o),e.setScale(i);const r=t.getComponent(cc_1.UITransform);if(r){const t=r.contentSize,n=r.anchorPoint,o=new cc_1.Vec3;o.x=(.5-n.x)*t.width,o.y=(.5-n.y)*t.height,e.updateSize(o,new cc_1.Vec2(t.width,t.height))}else e.hide()}else{const t=!1,n=!1,o=boundsToRect(this.getBounds(t,n,this.nodes)),i=new cc_1.Vec3(o.x+o.width/2,o.y+o.height/2,0);e.setPosition(i),e.setRotation(cc_1.Quat.IDENTITY),e.setScale(new cc_1.Vec3(1,1,1)),e.updateSize(new cc_1.Vec3,new cc_1.Vec2(o.width,o.height))}}drawNodeGuidelineGroup(e){if(!e)return;const t=e.currentGuidelines;if(!t||t.length<=0)return;const n=rect_transform_snapping_1.rectTransformSnapping.guidelineColor,o=[];t.forEach(e=>{const t=e.lineVertices.slice(),n=e.checkNode;if(!n)return;function i(e){return function(t,n){return t[e]-n[e]}}const r=rect_transform_snapping_1.rectTransformSnapping.getWorldRectEx(n),s=r.center,c=r.width/2,a=r.height/2;"x"===e.axis?(t.push(new cc_1.Vec3(e.value,s.y+a,s.z)),t.push(new cc_1.Vec3(e.value,s.y-a,s.z)),t.sort(i("y"))):"y"===e.axis&&(t.push(new cc_1.Vec3(s.x+c,e.value,s.z)),t.push(new cc_1.Vec3(s.x-c,e.value,s.z)),t.sort(i("x"))),o.push(t[0]),o.push(t[t.length-1])}),this.drawGuidelines(this._nodeSnapLinesCtrl,o,n)}drawNodeSnappingGuideline(){this.clearNodeSnappingGuideline();const e=rect_transform_snapping_1.rectTransformSnapping.nodeSnapGuidelineGroups;this.drawNodeGuidelineGroup(e[0]),this.drawNodeGuidelineGroup(e[1])}clearNodeSnappingGuideline(){this._nodeSnapLinesCtrl.clearData()}getDrawLineVertices(e){if(!e)return null;const t=e.currentGuidelines;if(!t||t.length<=0)return null;const n=[];return t.forEach(e=>{const t=e.lineVertices;n.push(t[0]),n.push(t[t.length-1])}),n}drawGuidelineGroup(e,t,n=cc_1.Color.RED){if(!e)return;const o=e.currentGuidelines;if(!o||o.length<=0)return;const i=[];o.forEach(e=>{const t=e.lineVertices;i.push(t[0]),i.push(t[t.length-1])}),t.setColor(n);const r=[];i.forEach((e,t)=>{r.push(t)}),t.updateData(i,r)}drawGuidelines(e,t,n=cc_1.Color.RED){e.setColor(n);const o=[];t.forEach((e,t)=>{o.push(t)}),e.updateData(t,o)}drawCanvasSnappingGuideline(){this.clearCanvasSnappingGuideline();const e=rect_transform_snapping_1.rectTransformSnapping.canvasSnapGuidelineGroups,t=rect_transform_snapping_1.rectTransformSnapping.canvasSnapColor,n=[];let o=this.getDrawLineVertices(e[0]);o&&n.push(...o),(o=this.getDrawLineVertices(e[1]))&&n.push(...o),this.drawGuidelines(this._canvasSnapLinesCtrl,n,t)}clearCanvasSnappingGuideline(){this._canvasSnapLinesCtrl.clearData()}drawEqualSpacingGuideline(){this.clearEqualSpacingGuideline();const e=rect_transform_snapping_1.rectTransformSnapping.currentMatchMinDistInfos,t=rect_transform_snapping_1.rectTransformSnapping.guidelineColor,n=[];e.forEach(e=>{const t=e.minDistPosA,o=e.minDistPosB;n.push(t),n.push(o),"x"===e.axis?(n.push(new cc_1.Vec3(t.x,t.y+10)),n.push(new cc_1.Vec3(t.x,t.y-10)),n.push(new cc_1.Vec3(o.x,o.y+10)),n.push(new cc_1.Vec3(o.x,o.y-10))):"y"===e.axis&&(n.push(new cc_1.Vec3(t.x-10,t.y)),n.push(new cc_1.Vec3(t.x+10,t.y)),n.push(new cc_1.Vec3(o.x-10,o.y)),n.push(new cc_1.Vec3(o.x+10,o.y)))}),this.drawGuidelines(this._equalSpacingLinesCtrl,n,t)}clearEqualSpacingGuideline(){this._equalSpacingLinesCtrl.clearData()}}exports.default=RectGizmo;