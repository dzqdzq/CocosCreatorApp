"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,sphere_controller_1=__importDefault(require("../controller/sphere-controller")),box_controller_1=__importDefault(require("../controller/box-controller")),circle_controller_1=__importDefault(require("../controller/circle-controller")),particlesystem_cone_controller_1=__importDefault(require("../controller/particlesystem-cone-controller")),hemisphere_controller_1=__importDefault(require("../controller/hemisphere-controller")),gizmo_base_1=__importDefault(require("../gizmo-base")),cc_1=require("cc"),{create3DNode:create3DNode}=require("../../../utils/engine"),EditorMath=external_1.default.EditorMath,MVec3=EditorMath.MVec3,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat,ShapeType={Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4},CurveRangeMode={Constant:0,Curve:1,TwoCurves:2,TwoConstants:3},EmitLocation={Base:0,Edge:1,Shell:2,Volume:3};class ParticleSystemComponentGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._curEmitterShape=ShapeType.Box,this._shapeControllers={},this._PSGizmoColor=new cc_1.Color(100,100,255),this._activeController=null,this._pSGizmoRoot=null,this._scale=cc.v3(),this._size=cc.v3(),this._radius=0,this._arc=0,this._coneHeight=0,this._coneAngle=0,this._bottomRadius=0}init(){this._isInited=!0}onShow(){this.updateControllerData()}onHide(){this._activeController&&this._activeController.hide()}createControllerByShape(e){let t=this.getGizmoRoot(),o=create3DNode("ParticleSystemGizmo");o.parent=t,this._pSGizmoRoot=o;let r=null;switch(e){case ShapeType.Box:r=new box_controller_1.default(o);break;case ShapeType.Sphere:r=new sphere_controller_1.default(o);break;case ShapeType.Circle:r=new circle_controller_1.default(o);break;case ShapeType.Cone:r=new particlesystem_cone_controller_1.default(o);break;case ShapeType.Hemisphere:r=new hemisphere_controller_1.default(o);break;default:console.error("Invalid Type:",e)}return r&&(r.editable=!0,r.setColor(this._PSGizmoColor),r.onControllerMouseDown=this.onControllerMouseDown.bind(this),r.onControllerMouseMove=this.onControllerMouseMove.bind(this),r.onControllerMouseUp=this.onControllerMouseUp.bind(this)),r}getControllerByShape(e){let t=this._shapeControllers[e];return t?t.setRoot(this._pSGizmoRoot):(t=this.createControllerByShape(e),this._shapeControllers[e]=t),t}getConeData(e){let t=e.shapeModule,o=t.radius,r=t.angle,i=t.length,a=0;return r<0&&(r=0),{topRadius:o,height:i,bottomRadius:o+(a=r>=90?1e3:Math.tan(r*EditorMath.D2R)*i),coneAngle:r}}modifyConeData(e,t,o,r){let i=e.shapeModule;if(0!==t){let e=this._radius+t;(e=EditorMath.toPrecision(e,3))<0&&(e=1e-4),i.radius=e}else if(0!==o){let e=this._coneHeight+o;(e=EditorMath.toPrecision(e,3))<=0&&(e=1e-4),i.length=e}else if(0!==r){let e=this._bottomRadius+r;e<this._radius&&(e=this._radius);let t=Math.atan2(e-this._radius,this._coneHeight)*EditorMath.R2D;i.angle=EditorMath.toPrecision(t,3)}}setCurveRangeInitValue(e,t){switch(e.mode){case CurveRangeMode.Constant:e.constant=t;break;case CurveRangeMode.Curve:let o=e.curve.keyFrames[0];o&&(o.value=t);break;case CurveRangeMode.TwoCurves:(o=e.curveMax.keyFrames[0])&&(o.value=t);break;case CurveRangeMode.TwoConstants:e.constantMax=t;break;default:console.error("unknown cure range mode:",e.mode)}}onControllerMouseDown(){if(!this._isInited||null==this.target)return;let e=this.target.shapeModule;switch(this._curEmitterShape=e.shapeType,this._scale=NodeUtils.getWorldScale3D(this.node),this._curEmitterShape){case ShapeType.Box:this._size=e.scale.clone();break;case ShapeType.Sphere:this._radius=e.radius;break;case ShapeType.Circle:this._radius=e.radius,this._arc=e.arc;break;case ShapeType.Cone:let t=this.getConeData(this.target);this._radius=t.topRadius,this._coneHeight=t.height,this._coneAngle=t.coneAngle,this._bottomRadius=t.bottomRadius;break;case ShapeType.Hemisphere:this._radius=e.radius}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this.commitChanges()}getScaledDeltaRadius(e,t,o){return 0!==t.x?e/=o.x:0!==t.y?e/=o.y:0!==t.z&&(e/=o.z),e}updateDataFromController(){if(this._activeController.updated){this.recordChanges();let r=this.node,i=this.target.shapeModule;switch(this._curEmitterShape){case ShapeType.Box:let r=this._activeController.getDeltaSize();MVec3.divide(r,r,this._scale),MVec3.multiplyScalar(r,r,2);let a=MVec3.add(tempVec3,this._size,r);Utils.clampSize(a),i.scale=a;break;case ShapeType.Sphere:var e=this._activeController.getDeltaRadius(),t=this._activeController.getControlDir();e=this.getScaledDeltaRadius(e,t,this._scale);var o=this._radius+e;o=Math.abs(o),o=EditorMath.toPrecision(o,3),i.radius=o;break;case ShapeType.Circle:e=this._activeController.getDeltaRadius(),0!==(t=this._activeController.getControlDir()).x?e/=this._scale.x:0!==t.y&&(e/=this._scale.y),o=this._radius+e,o=Math.abs(o),o=EditorMath.toPrecision(o,3),i.radius=o;break;case ShapeType.Cone:let s=this._activeController.getDeltaRadius(),l=this._activeController.getDeltaHeight(),n=this._activeController.getDeltaBottomRadius();this.modifyConeData(this.target,s,l,n);break;case ShapeType.Hemisphere:e=this._activeController.getDeltaRadius(),t=this._activeController.getControlDir(),e=this.getScaledDeltaRadius(e,t,this._scale),o=this._radius+e,o=Math.abs(o),o=EditorMath.toPrecision(o,3),i.radius=o}this.onComponentChanged(r)}}updateControllerTransform(){if(this.target&&this.target.shapeModule){let e=this.target.shapeModule;if(e.enable&&this._pSGizmoRoot){let t=this.node,o=tempQuat_a,r=NodeUtils.getWorldPosition3D(t);NodeUtils.getWorldRotation3D(t,o);let i=NodeUtils.getWorldScale3D(t);this._pSGizmoRoot.setWorldPosition(r),this._pSGizmoRoot.setWorldRotation(o),this._pSGizmoRoot.setWorldScale(i);let a=e.rotation;const s=tempQuat_a;cc_1.Quat.fromEuler(s,a.x,a.y,a.z),this._activeController.setPosition(e.position),this._activeController.setRotation(s),this._activeController.setScale(e.scale)}}}getConeRadius(e,t){return Math.tan(e/2*EditorMath.D2R)*t}updateControllerData(){if(!this._isInited||null===this.target)return;let e=this.target.shapeModule;if(e.enable){switch(this._activeController&&this._activeController.hide(),this._activeController=this.getControllerByShape(e.shapeType),this._activeController.checkEdit(),this.updateControllerTransform(),e.shapeType){case ShapeType.Box:let t=this._activeController;t.edit&&t.updateEditHandles(),t.adjustEditHandlesSize();break;case ShapeType.Sphere:this._activeController.radius=e.radius;break;case ShapeType.Circle:this._activeController.updateSize(cc.v3(),e.radius,e.arc);break;case ShapeType.Cone:let o=this.getConeData(this.target);this._activeController.updateSize(cc.v3(),o.topRadius,o.height,o.bottomRadius);break;case ShapeType.Hemisphere:this._activeController.radius=e.radius}this._activeController.show()}else this._activeController&&this._activeController.hide()}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=ParticleSystemComponentGizmo;