"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,sphere_controller_1=__importDefault(require("../controller/sphere-controller")),box_controller_1=__importDefault(require("../controller/box-controller")),circle_controller_1=__importDefault(require("../controller/circle-controller")),particlesystem_cone_controller_1=__importDefault(require("../controller/particlesystem-cone-controller")),hemisphere_controller_1=__importDefault(require("../controller/hemisphere-controller")),gizmo_base_1=__importDefault(require("../gizmo-base")),cc_1=require("cc"),{create3DNode:create3DNode}=require("../../../utils/engine/index"),EditorMath=external_1.default.EditorMath,tempVec3=new cc_1.Vec3,tempQuat_a=new cc_1.Quat,ShapeType={Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4},CurveRangeMode={Constant:0,Curve:1,TwoCurves:2,TwoConstants:3},EmitLocation={Base:0,Edge:1,Shell:2,Volume:3};class ParticleSystemComponentGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this._curEmitterShape=ShapeType.Box,this._shapeControllers={},this._PSGizmoColor=new cc_1.Color(100,100,255),this._activeController=null,this._pSGizmoRoot=null,this._boundingBoxController=null,this._scale=cc.v3(),this._size=cc.v3(),this._radius=0,this._arc=0,this._coneHeight=0,this._coneAngle=0,this._bottomRadius=0,this._bbHalfSize=new cc_1.Vec3}init(){this.createController(),this._isInited=!0}createController(){const e=this.getGizmoRoot();this._boundingBoxController=new box_controller_1.default(e),this._boundingBoxController.setColor(cc_1.Color.GREEN),this._boundingBoxController.editable=!0,this._boundingBoxController.onControllerMouseDown=this.onBBControllerMouseDown.bind(this),this._boundingBoxController.onControllerMouseMove=this.onBBControllerMouseMove.bind(this),this._boundingBoxController.onControllerMouseUp=this.onBBControllerMouseUp.bind(this)}onShow(){this.updateControllerData()}onHide(){var e,t;null===(e=this._activeController)||void 0===e||e.hide(),null===(t=this._boundingBoxController)||void 0===t||t.hide()}createControllerByShape(e){const t=this.getGizmoRoot(),o=create3DNode("ParticleSystemGizmo");o.parent=t,this._pSGizmoRoot=o;let r=null;switch(e){case ShapeType.Box:r=new box_controller_1.default(o);break;case ShapeType.Sphere:r=new sphere_controller_1.default(o);break;case ShapeType.Circle:r=new circle_controller_1.default(o);break;case ShapeType.Cone:r=new particlesystem_cone_controller_1.default(o);break;case ShapeType.Hemisphere:r=new hemisphere_controller_1.default(o);break;default:console.error("Invalid Type:",e)}return r&&(r.editable=!0,r.setColor(this._PSGizmoColor),r.onControllerMouseDown=this.onControllerMouseDown.bind(this),r.onControllerMouseMove=this.onControllerMouseMove.bind(this),r.onControllerMouseUp=this.onControllerMouseUp.bind(this)),r}getControllerByShape(e){let t=this._shapeControllers[e];return t?t.setRoot(this._pSGizmoRoot):(t=this.createControllerByShape(e),this._shapeControllers[e]=t),t}getConeData(e){const t=e.shapeModule,o=t.radius;let r=t.angle;const i=t.length;let s=0;return r<0&&(r=0),{topRadius:o,height:i,bottomRadius:o+(s=r>=90?1e3:Math.tan(r*EditorMath.D2R)*i),coneAngle:r}}modifyConeData(e,t,o,r){const i=e.shapeModule;if(0!==t){let e=this._radius+t;(e=EditorMath.toPrecision(e,3))<0&&(e=1e-4),i.radius=e}else if(0!==o){let e=this._coneHeight+o;(e=EditorMath.toPrecision(e,3))<=0&&(e=1e-4),i.length=e}else if(0!==r){let e=this._bottomRadius+r;e<this._radius&&(e=this._radius);const t=Math.atan2(e-this._radius,this._coneHeight)*EditorMath.R2D;i.angle=EditorMath.toPrecision(t,3)}}setCurveRangeInitValue(e,t){switch(e.mode){case CurveRangeMode.Constant:e.constant=t;break;case CurveRangeMode.Curve:let o=e.curve.keyFrames[0];o&&(o.value=t);break;case CurveRangeMode.TwoCurves:(o=e.curveMax.keyFrames[0])&&(o.value=t);break;case CurveRangeMode.TwoConstants:e.constantMax=t;break;default:console.error("unknown cure range mode:",e.mode)}}onControllerMouseDown(){if(!this._isInited||null==this.target)return;const e=this.target.shapeModule;switch(this._curEmitterShape=e.shapeType,this._scale=NodeUtils.getWorldScale3D(this.node),this._curEmitterShape){case ShapeType.Box:this._size=e.scale.clone();break;case ShapeType.Sphere:this._radius=e.radius;break;case ShapeType.Circle:this._radius=e.radius,this._arc=e.arc;break;case ShapeType.Cone:const t=this.getConeData(this.target);this._radius=t.topRadius,this._coneHeight=t.height,this._coneAngle=t.coneAngle,this._bottomRadius=t.bottomRadius;break;case ShapeType.Hemisphere:this._radius=e.radius}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this.commitChanges()}getScaledDeltaRadius(e,t,o){return 0!==t.x?e/=o.x:0!==t.y?e/=o.y:0!==t.z&&(e/=o.z),e}updateDataFromController(){if(this._activeController.updated){this.recordChanges();const e=this.node,t=this.target.shapeModule;switch(this._curEmitterShape){case ShapeType.Box:{const e=this._activeController.getDeltaSize();cc_1.Vec3.divide(e,e,this._scale),cc_1.Vec3.multiplyScalar(e,e,2);const o=cc_1.Vec3.add(tempVec3,this._size,e);Utils.clampSize(o),t.scale=o;break}case ShapeType.Sphere:{let e=this._activeController.getDeltaRadius();const o=this._activeController.getControlDir();e=this.getScaledDeltaRadius(e,o,this._scale);let r=this._radius+e;r=Math.abs(r),r=EditorMath.toPrecision(r,3),t.radius=r;break}case ShapeType.Circle:{let e=this._activeController.getDeltaRadius();const o=this._activeController.getControlDir();0!==o.x?e/=this._scale.x:0!==o.y&&(e/=this._scale.y);let r=this._radius+e;r=Math.abs(r),r=EditorMath.toPrecision(r,3),t.radius=r;break}case ShapeType.Cone:{const e=this._activeController.getDeltaRadius(),t=this._activeController.getDeltaHeight(),o=this._activeController.getDeltaBottomRadius();this.modifyConeData(this.target,e,t,o);break}case ShapeType.Hemisphere:{let e=this._activeController.getDeltaRadius();const o=this._activeController.getControlDir();e=this.getScaledDeltaRadius(e,o,this._scale);let r=this._radius+e;r=Math.abs(r),r=EditorMath.toPrecision(r,3),t.radius=r;break}}this.onComponentChanged(e)}}updateControllerTransform(){if(this.target&&this.target.shapeModule){this.target;const e=this.target.shapeModule;if(e.enable&&this._pSGizmoRoot){const t=this.node,o=tempQuat_a,r=NodeUtils.getWorldPosition3D(t);NodeUtils.getWorldRotation3D(t,o);const i=NodeUtils.getWorldScale3D(t);this._pSGizmoRoot.setWorldPosition(r),this._pSGizmoRoot.setWorldRotation(o),this._pSGizmoRoot.setWorldScale(i);const s=e.rotation,a=tempQuat_a;cc_1.Quat.fromEuler(a,s.x,s.y,s.z),this._activeController.setPosition(e.position),this._activeController.setRotation(a),this._activeController.setScale(e.scale)}}}getConeRadius(e,t){return Math.tan(e/2*EditorMath.D2R)*t}updateControllerData(){if(!this._isInited||null===this.target)return;const e=this.target.shapeModule;if(e.enable){switch(this._activeController&&this._activeController.hide(),this._activeController=this.getControllerByShape(e.shapeType),this._activeController.checkEdit(),this.updateControllerTransform(),e.shapeType){case ShapeType.Box:{const e=this._activeController;e.edit&&e.updateEditHandles(),e.adjustEditHandlesSize();break}case ShapeType.Sphere:this._activeController.radius=e.radius;break;case ShapeType.Circle:this._activeController.updateSize(cc.v3(),e.radius,e.arc);break;case ShapeType.Cone:{const e=this.getConeData(this.target);this._activeController.updateSize(cc.v3(),e.topRadius,e.height,e.bottomRadius);break}case ShapeType.Hemisphere:this._activeController.radius=e.radius}this._activeController.show()}else this._activeController&&this._activeController.hide();this.updateBBControllerData()}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}updateDataFromBBController(){var e;if(null===(e=this._boundingBoxController)||void 0===e?void 0:e.updated){this.recordChanges();const e=this.node,t=this._boundingBoxController.getDeltaSize();cc_1.Vec3.add(tempVec3,this._bbHalfSize,t);const o=this.target;o.aabbHalfX=tempVec3.x,o.aabbHalfY=tempVec3.y,o.aabbHalfZ=tempVec3.z,this.onComponentChanged(e)}}updateBBControllerData(){var e,t,o,r;const i=this.target,s=i._boundingBox;if(i.renderCulling&&s&&i._isShowBB){this._boundingBoxController.edit=!0,null===(e=this._boundingBoxController)||void 0===e||e.setPosition(s.center);const r=s.halfExtents;null===(t=this._boundingBoxController)||void 0===t||t.updateSize(cc_1.Vec3.ZERO,tempVec3.set(2*r.x,2*r.y,2*r.z)),null===(o=this._boundingBoxController)||void 0===o||o.show()}else null===(r=this._boundingBoxController)||void 0===r||r.hide()}onBBControllerMouseDown(){if(!this._isInited||null==this.target)return;const e=this.target;this._bbHalfSize.set(e.aabbHalfX,e.aabbHalfY,e.aabbHalfZ)}onBBControllerMouseMove(){this.updateDataFromBBController()}onBBControllerMouseUp(){this.commitChanges()}showBoundingBox(e){const t=this.target;t&&(t._isShowBB=e),this.updateBBControllerData()}isShowBoundingBox(){var e;return null===(e=this.target)||void 0===e?void 0:e._isShowBB}}exports.default=ParticleSystemComponentGizmo;