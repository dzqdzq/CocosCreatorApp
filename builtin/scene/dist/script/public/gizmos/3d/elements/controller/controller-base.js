"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const external_1=__importDefault(require("../../../utils/external")),controller_shape_collider_1=require("../utils/controller-shape-collider"),controller_utils_1=__importDefault(require("../utils/controller-utils")),transform_tool_data_1=require("../../../utils/transform-tool-data"),utils_1=__importDefault(require("../../../utils")),cc_1=require("cc"),engine_1=__importDefault(require("../../../utils/engine")),EditorCamera=external_1.default.EditorCamera,{setNodeOpacity:setNodeOpacity,create3DNode:create3DNode,setMeshColor:setMeshColor,getModel:getModel,getMeshColor:getMeshColor,getNodeOpacity:getNodeOpacity,ProjectionType:ProjectionType,getRaycastResultsByNodes:getRaycastResultsByNodes}=engine_1.default,tempVec3_a=new cc_1.Vec3,tempVec2_a=new cc_1.Vec2;class ControllerBase{constructor(e){this.shape=null,this.isLock=!1,this._updated=!1,this._scale=new cc_1.Vec3(1,1,1),this._localRot=new cc_1.Quat,this._localPos=new cc_1.Vec3,this._rootNode=null,this._baseDist=600,this._handleDataMap={},this._twoPI=2*Math.PI,this._halfPI=Math.PI/2,this._degreeToRadianFactor=Math.PI/180,this._eventsRegistered=!1,this._isMouseDown=!1,this._color=cc_1.Color.WHITE,this._lockSize=!1,this._onDimensionChanged=null,this._onScale2DChanged=null,this._onCameraProjectionChanged=null,this._onCameraFovChanged=null,this._onCameraOrthoHeightChanged=null,this._mouseDownFuncs=new Map,this._mouseMoveFuncs=new Map,this._mouseUpFuncs=new Map,this._mouseLeaveFuncs=new Map,this._hoverInFuncs=new Map,this._hoverOutFuncs=new Map,this._rootNode=e}get is2D(){return transform_tool_data_1.transformToolData.is2D}get scale2D(){return transform_tool_data_1.transformToolData.scale2D}get updated(){return this._updated}get visible(){var e;return null===(e=this.shape)||void 0===e?void 0:e.active}get isMouseDown(){return this._isMouseDown}set lockSize(e){this._lockSize=e}setRoot(e){this._rootNode=e,this.shape&&(this.shape.parent=this._rootNode)}createShapeNode(e){this.shape=create3DNode(e),this.shape.parent=this._rootNode}registerEvents(){this._eventsRegistered||(this.registerCameraMovedEvent(),this.registerOrthoHeightChangedEvent(),this.registerCameraFovChangedEvent(),this._onDimensionChanged=this.onDimensionChanged.bind(this),this._onScale2DChanged=this.onScale2DChanged.bind(this),this._onCameraProjectionChanged=this.onCameraProjectionChanged.bind(this),transform_tool_data_1.transformToolData.on("dimension-changed",this._onDimensionChanged),transform_tool_data_1.transformToolData.on("scale-2d-changed",this._onScale2DChanged),transform_tool_data_1.transformToolData.on("camera-projection-changed",this._onCameraProjectionChanged),this._eventsRegistered=!0)}unregisterEvents(){this._eventsRegistered&&(this.unregisterCameraMoveEvent(),this.unregisterOrthoHeightChangedEvent(),this.unregisterCameraFovChangedEvent(),this._onDimensionChanged&&transform_tool_data_1.transformToolData.off("dimension-changed",this._onDimensionChanged),this._onScale2DChanged&&transform_tool_data_1.transformToolData.off("scale-2d-changed",this._onScale2DChanged),this._onCameraProjectionChanged&&transform_tool_data_1.transformToolData.off("camera-projection-changed",this._onCameraProjectionChanged),this._eventsRegistered=!1)}registerCameraMovedEvent(){EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}unregisterCameraMoveEvent(){EditorCamera.camera.node.off("transform-changed",this.onEditorCameraMoved,this)}registerCameraFovChangedEvent(){var e;this.onCameraFovChanged&&(null!==(e=this._onCameraFovChanged)&&void 0!==e||(this._onCameraFovChanged=this.onCameraFovChanged.bind(this)),cce.Camera.on("fov-changed",this._onCameraFovChanged))}registerOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged=this.onCameraOrthoHeightChanged.bind(this),transform_tool_data_1.transformToolData.on("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}unregisterCameraFovChangedEvent(){this._onCameraFovChanged&&cce.Camera.off("fov-changed",this._onCameraFovChanged)}unregisterOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged&&transform_tool_data_1.transformToolData.off("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}onEditorCameraMoved(){this.adjustControllerSize()}initHandle(e,t){const o=this.getRendererNodes(e),s=[],a=[];o.forEach(e=>{const t=getMeshColor(e);s.push(new cc.Color(t.r,t.g,t.b)),a.push(getNodeOpacity(e))});const n={name:t,topNode:e,rendererNodes:o,oriColors:s,oriOpacitys:a};return this.getRayDetectNodes(e).forEach(e=>{this.registerMouseEvents(e,t)}),this._handleDataMap[t]=n,n}removeHandle(e){if(this._handleDataMap[e]){const t=this._handleDataMap[e].topNode;this.getRayDetectNodes(t).forEach(t=>{this.unregisterMouseEvent(t,e)}),delete this._handleDataMap[e]}}setHandleColor(e,t,o){const s=this._handleDataMap[e].rendererNodes;s&&s.forEach(e=>{void 0!==o&&null!==o||(o=getNodeOpacity(e)),setMeshColor(e,t),setNodeOpacity(e,o)})}resetHandleColor(){for(const e in this._handleDataMap)if(e){const t=this._handleDataMap[e],o=t.rendererNodes,s=t.oriColors,a=t.oriOpacitys;for(let e=0;e<o.length;e++){const t=o[e];setMeshColor(t,s[e]),setNodeOpacity(t,a[e])}}}registerMouseEvents(e,t){this._mouseDownFuncs.set(t,(o=>{o.handleName=t,o.node=e,this._updated=!1,this._isMouseDown=!0,this.onMouseDown&&this.onMouseDown(o)}).bind(this)),e.on("mouseDown",this._mouseDownFuncs.get(t));this._mouseMoveFuncs.set(t,(o=>{this._updated=!0,o.handleName=t,o.node=e,!this.onMouseMove||this.shape&&!this.shape.active||this.onMouseMove(o),utils_1.default.repaintEngine()}).bind(this)),e.on("mouseMove",this._mouseMoveFuncs.get(t));this._mouseUpFuncs.set(t,(o=>{o.handleName=t,o.node=e,!this.onMouseUp||this.shape&&!this.shape.active||this.onMouseUp(o),this._updated=!1,this._isMouseDown=!1}).bind(this)),e.on("mouseUp",this._mouseUpFuncs.get(t));this._mouseLeaveFuncs.set(t,(o=>{o.handleName=t,o.node=e,this.onMouseLeave&&this.onMouseLeave(o),this._updated=!1,this._isMouseDown=!1}).bind(this)),e.on("mouseLeave",this._mouseLeaveFuncs.get(t));this._hoverInFuncs.set(t,(o=>{o.handleName=t,o.node=e,this.onHoverIn&&this.onHoverIn(o),utils_1.default.repaintEngine()}).bind(this)),e.on("hoverIn",this._hoverInFuncs.get(t));this._hoverOutFuncs.set(t,(o=>{o.handleName=t,o.node=e,this.onHoverOut&&this.onHoverOut(o),utils_1.default.repaintEngine()}).bind(this)),e.on("hoverOut",this._hoverOutFuncs.get(t))}unregisterMouseEvent(e,t){e.off("mouseDown",this._mouseDownFuncs.get(t)),e.off("mouseMove",this._mouseMoveFuncs.get(t)),e.off("mouseUp",this._mouseUpFuncs.get(t)),e.off("mouseLeaver",this._mouseLeaveFuncs.get(t)),e.off("hoverIn",this._hoverInFuncs.get(t)),e.off("hoverOut",this._hoverOutFuncs.get(t))}setPosition(e){var t;null===(t=this.shape)||void 0===t||t.setPosition(e),this.adjustControllerSize()}getPosition(e){var t;return e||(e=new cc_1.Vec3),null===(t=this.shape)||void 0===t||t.getPosition(e),e}getWorldPosition(e){return this.getWorldPositionForNode(this.shape,e)}getWorldPositionForNode(e,t){var o;return t||(t=new cc_1.Vec3),null===(o=null!==e&&void 0!==e?e:this.shape)||void 0===o||o.getWorldPosition(t),t}setRotation(e){var t;null===(t=this.shape)||void 0===t||t.setRotation(e),this.adjustControllerSize()}getRotation(e){var t;return e||(e=new cc_1.Quat),null===(t=this.shape)||void 0===t||t.getRotation(e),e}getScale(){return this._scale}setScale(e){this._scale=e,this.adjustControllerSize()}updateController(){this.adjustControllerSize()}getCameraDistScalar(e){const t=EditorCamera.camera.node;return controller_utils_1.default.getCameraDistanceFactor(e,t)/this._baseDist}getDistScalarInOrtho(){const e=controller_utils_1.default.getCameraDistanceFactor(this.getWorldPosition(tempVec3_a),EditorCamera.camera.node),t=EditorCamera.camera.fov,o=Math.tan(t/2*Math.PI/180)*e;return e/this._baseDist*(EditorCamera.camera.orthoHeight/o)}isCameraInOrtho(){return EditorCamera.camera.projection===ProjectionType.ORTHO}getDistScalar(e){let t=1;return t=this.is2D?1/this.scale2D:this.isCameraInOrtho()?this.getDistScalarInOrtho():this.getCameraDistScalar(this.getWorldPositionForNode(e,tempVec3_a))}adjustControllerSize(){var e;let t=1;this._lockSize&&(t=this.getDistScalar());const o=new cc_1.Vec3(this._scale);o.multiplyScalar(t),null===(e=this.shape)||void 0===e||e.setScale(o)}needRender(e){const t=e.getComponent(controller_shape_collider_1.ControllerShapeCollider);return!t||!1!==t.isRender}getRendererNodes(e){let t=[];getModel(e)&&this.needRender(e)&&t.push(e);for(let o=0;o<e.children.length;o++){const s=e.children[o];t=t.concat(this.getRendererNodes(s))}return t}getRayDetectNodes(e){let t=[];getModel(e)&&t.push(e);for(let o=0;o<e.children.length;o++){const s=e.children[o];t=t.concat(this.getRayDetectNodes(s))}return t}localToWorldPosition(e){var t;const o=cc.mat4(),s=cc.v3();return null===(t=this.shape)||void 0===t||t.getWorldMatrix(o),cc_1.Vec3.transformMat4(s,e,o),s}localToWorldDir(e){var t;const o=cc.mat4(),s=cc.v3();return null===(t=this.shape)||void 0===t||t.getWorldMatrix(o),cc_1.Vec3.transformMat4Normal(s,e,o),cc_1.Vec3.normalize(s,s),s}worldPosToScreenPos(e){const t=EditorCamera.camera.camera,o=cc.v3();return null===t||void 0===t||t.worldToScreen(o,e),o}getScreenPos(e){return this.worldPosToScreenPos(this.localToWorldPosition(e))}getAlignAxisMoveDistance(e,t){const o=cc_1.Vec3.add(tempVec3_a,this.getPosition(),e),s=this.worldPosToScreenPos(o),a=this.worldPosToScreenPos(this.getPosition());return cc_1.Vec2.subtract(s,s,a),cc_1.Vec2.normalize(s,s),cc_1.Vec2.dot(t,tempVec2_a.set(s.x,s.y))}getPositionOnPanPlane(e,t,o,s){const a=getRaycastResultsByNodes([s],t,o,1/0,!1);if(a.length>0){const t=a[0];return e.set(t.hitPoint),!0}return!1}show(){this.shape&&(this.shape.active=!0),this.onShow&&this.onShow()}hide(){this.shape&&(this.shape.active=!1),this._isMouseDown=!1,this.isLock=!1,this.resetHandleColor(),this.onHide&&this.onHide()}onDimensionChanged(){this.visible&&this.onShow&&this.onShow()}onScale2DChanged(){this.visible&&this.adjustControllerSize()}onCameraProjectionChanged(e){this.visible&&this.adjustControllerSize()}onCameraOrthoHeightChanged(){this.visible&&this.adjustControllerSize()}}exports.default=ControllerBase;