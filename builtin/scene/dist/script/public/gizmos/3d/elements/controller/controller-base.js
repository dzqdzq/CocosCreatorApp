"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const external_1=__importDefault(require("../../../utils/external")),EditorCamera=external_1.default.EditorCamera,controller_shape_collider_1=require("../utils/controller-shape-collider"),controller_utils_1=__importDefault(require("../utils/controller-utils")),{setNodeOpacity:setNodeOpacity,create3DNode:create3DNode,setMeshColor:setMeshColor,getModel:getModel,getMeshColor:getMeshColor,getNodeOpacity:getNodeOpacity,ProjectionType:ProjectionType,getRaycastResults:getRaycastResults}=require("../../../utils/engine/index"),transform_tool_data_1=require("../../../utils/transform-tool-data"),Utils=require("../../../utils"),cc_1=require("cc"),tempVec3_a=new cc_1.Vec3;class ControllerBase{constructor(e){this.shape=null,this.isLock=!1,this._updated=!1,this._scale=new cc_1.Vec3(1,1,1),this._localRot=new cc_1.Quat,this._localPos=new cc_1.Vec3,this._rootNode=null,this._baseDist=600,this._handleDataMap={},this._twoPI=2*Math.PI,this._halfPI=Math.PI/2,this._degreeToRadianFactor=Math.PI/180,this._eventsRegistered=!1,this._isMouseDown=!1,this._color=cc_1.Color.WHITE,this._lockSize=!1,this._onDimensionChanged=null,this._onScale2DChanged=null,this._onCameraProjectionChanged=null,this._onCameraOrthoHeightChanged=null,this._rootNode=e}get is2D(){return transform_tool_data_1.transformToolData.is2D}get scale2D(){return transform_tool_data_1.transformToolData.scale2D}get updated(){return this._updated}get visible(){var e;return null===(e=this.shape)||void 0===e?void 0:e.active}set lockSize(e){this._lockSize=e}setRoot(e){this._rootNode=e,this.shape&&(this.shape.parent=this._rootNode)}createShapeNode(e){this.shape=create3DNode(e),this.shape.parent=this._rootNode}registerEvents(){this._eventsRegistered||(this.registerCameraMovedEvent(),this.registerOrthoHeightChangedEvent(),this._onDimensionChanged=this.onDimensionChanged.bind(this),this._onScale2DChanged=this.onScale2DChanged.bind(this),this._onCameraProjectionChanged=this.onCameraProjectionChanged.bind(this),transform_tool_data_1.transformToolData.on("dimension-changed",this._onDimensionChanged),transform_tool_data_1.transformToolData.on("scale-2d-changed",this._onScale2DChanged),transform_tool_data_1.transformToolData.on("camera-projection-changed",this._onCameraProjectionChanged),this._eventsRegistered=!0)}unregisterEvents(){this._eventsRegistered&&(this.unregisterCameraMoveEvent(),this.unregisterOrthoHeightChangedEvent(),this._onDimensionChanged&&transform_tool_data_1.transformToolData.off("dimension-changed",this._onDimensionChanged),this._onScale2DChanged&&transform_tool_data_1.transformToolData.off("scale-2d-changed",this._onScale2DChanged),this._onCameraProjectionChanged&&transform_tool_data_1.transformToolData.off("camera-projection-changed",this._onCameraProjectionChanged),this._eventsRegistered=!1)}registerCameraMovedEvent(){EditorCamera.camera.node.on("transform-changed",this.onEditorCameraMoved,this)}unregisterCameraMoveEvent(){EditorCamera.camera.node.off("transform-changed",this.onEditorCameraMoved,this)}registerOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged=this.onCameraOrthoHeightChanged.bind(this),transform_tool_data_1.transformToolData.on("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}unregisterOrthoHeightChangedEvent(){this._onCameraOrthoHeightChanged&&transform_tool_data_1.transformToolData.off("camera-ortho-height-changed",this._onCameraOrthoHeightChanged)}onEditorCameraMoved(){this.adjustControllerSize()}initHandle(e,t){const o=this.getRendererNodes(e),a=[],s=[];o.forEach(e=>{const t=getMeshColor(e);a.push(new cc.Color(t.r,t.g,t.b)),s.push(getNodeOpacity(e))});const r={name:t,topNode:e,rendererNodes:o,oriColors:a,oriOpacitys:s};return this.getRayDetectNodes(e).forEach(e=>{this.registerMouseEvents(e,t)}),this._handleDataMap[t]=r,r}removeHandle(e){this._handleDataMap[e]&&delete this._handleDataMap[e]}setHandleColor(e,t,o){const a=this._handleDataMap[e].rendererNodes;a&&a.forEach(e=>{void 0!==o&&null!==o||(o=getNodeOpacity(e)),setMeshColor(e,t),setNodeOpacity(e,o)})}resetHandleColor(){for(const e in this._handleDataMap)if(e){const t=this._handleDataMap[e],o=t.rendererNodes,a=t.oriColors,s=t.oriOpacitys;for(let e=0;e<o.length;e++){const t=o[e];setMeshColor(t,a[e]),setNodeOpacity(t,s[e])}}}registerMouseEvents(e,t){e.on("mouseDown",o=>{o.handleName=t,o.node=e,this._updated=!1,this._isMouseDown=!0,this.onMouseDown&&this.onMouseDown(o)}),e.on("mouseMove",o=>{this._updated=!0,o.handleName=t,o.node=e,!this.onMouseMove||this.shape&&!this.shape.active||this.onMouseMove(o),Utils.repaintEngine()}),e.on("mouseUp",o=>{o.handleName=t,o.node=e,!this.onMouseUp||this.shape&&!this.shape.active||this.onMouseUp(o),this._updated=!1,this._isMouseDown=!1}),e.on("mouseLeave",o=>{o.handleName=t,o.node=e,this.onMouseLeave&&this.onMouseLeave(o),this._updated=!1,this._isMouseDown=!1}),e.on("hoverIn",o=>{o.handleName=t,o.node=e,this.onHoverIn&&this.onHoverIn(o),Utils.repaintEngine()}),e.on("hoverOut",o=>{o.handleName=t,o.node=e,this.onHoverOut&&this.onHoverOut(o),Utils.repaintEngine()})}setPosition(e){var t;null===(t=this.shape)||void 0===t||t.setPosition(e),this.adjustControllerSize()}getPosition(e){var t;return e||(e=new cc_1.Vec3),null===(t=this.shape)||void 0===t||t.getPosition(e),e}getWorldPosition(e){var t;return e||(e=new cc_1.Vec3),null===(t=this.shape)||void 0===t||t.getWorldPosition(e),e}setRotation(e){var t;null===(t=this.shape)||void 0===t||t.setRotation(e),this.adjustControllerSize()}getRotation(e){var t;return e||(e=new cc_1.Quat),null===(t=this.shape)||void 0===t||t.getRotation(e),e}getScale(){return this._scale}setScale(e){this._scale=e,this.adjustControllerSize()}updateController(){this.adjustControllerSize()}getCameraDistScalar(e){const t=EditorCamera.camera.node;return controller_utils_1.default.getCameraDistanceFactor(e,t)/this._baseDist}getDistScalarInOrtho(){const e=controller_utils_1.default.getCameraDistanceFactor(this.getWorldPosition(tempVec3_a),EditorCamera.camera.node),t=EditorCamera.camera.fov,o=Math.tan(t/2*Math.PI/180)*e;return e/this._baseDist*(EditorCamera.camera.orthoHeight/o)}isCameraInOrtho(){return EditorCamera.camera.projection===ProjectionType.ORTHO}getDistScalar(){let e=1;return e=this.is2D?1/this.scale2D:this.isCameraInOrtho()?this.getDistScalarInOrtho():this.getCameraDistScalar(this.getWorldPosition(tempVec3_a))}adjustControllerSize(){var e;let t=1;this._lockSize&&(t=this.getDistScalar());const o=new cc_1.Vec3(this._scale);o.multiplyScalar(t),null===(e=this.shape)||void 0===e||e.setScale(o)}needRender(e){const t=e.getComponent(controller_shape_collider_1.ControllerShapeCollider);return!t||!1!==t.isRender}getRendererNodes(e){let t=[];getModel(e)&&this.needRender(e)&&t.push(e);for(let o=0;o<e.children.length;o++){const a=e.children[o];t=t.concat(this.getRendererNodes(a))}return t}getRayDetectNodes(e){let t=[];getModel(e)&&t.push(e);for(let o=0;o<e.children.length;o++){const a=e.children[o];t=t.concat(this.getRayDetectNodes(a))}return t}localToWorldPosition(e){var t;const o=cc.mat4(),a=cc.v3();return null===(t=this.shape)||void 0===t||t.getWorldMatrix(o),cc_1.Vec3.transformMat4(a,e,o),a}localToWorldDir(e){var t;const o=cc.mat4(),a=cc.v3();return null===(t=this.shape)||void 0===t||t.getWorldMatrix(o),cc_1.Vec3.transformMat4Normal(a,e,o),cc_1.Vec3.normalize(a,a),a}worldPosToScreenPos(e){const t=EditorCamera.camera.camera,o=cc.v3();return t.worldToScreen(o,e),o}getScreenPos(e){return this.worldPosToScreenPos(this.localToWorldPosition(e))}getAlignAxisMoveDistance(e,t){const o=cc_1.Vec3.add(tempVec3_a,this.getPosition(),e),a=this.worldPosToScreenPos(o),s=this.worldPosToScreenPos(this.getPosition());return cc_1.Vec2.subtract(a,a,s),cc_1.Vec2.normalize(a,a),cc_1.Vec2.dot(t,a)}getPositionOnPanPlane(e,t,o,a){const s=getRaycastResults(a,t,o);s.ray;if(s.length>0){const t=s[0];return e.set(t.hitPoint),!0}return!1}show(){this.shape&&(this.shape.active=!0),this.onShow&&this.onShow()}hide(){this.shape&&(this.shape.active=!1),this._isMouseDown=!1,this.isLock=!1,this.resetHandleColor(),this.onHide&&this.onHide()}onDimensionChanged(){this.visible&&this.onShow&&this.onShow()}onScale2DChanged(){this.visible&&this.adjustControllerSize()}onCameraProjectionChanged(e){this.visible&&this.adjustControllerSize()}onCameraOrthoHeightChanged(){this.visible&&this.adjustControllerSize()}}exports.default=ControllerBase;