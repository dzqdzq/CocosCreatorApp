"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Utils=require("../../../utils"),external_1=__importDefault(require("../../../utils/external")),NodeUtils=external_1.default.NodeUtils,direction_light_controller_1=__importDefault(require("../controller/direction-light-controller")),sphere_controller_1=__importDefault(require("../controller/sphere-controller")),cone_controller_1=__importDefault(require("../controller/cone-controller")),gizmo_base_1=__importDefault(require("../gizmo-base")),cc_1=require("cc"),{create3DNode:create3DNode,getLightData:getLightData,setLightData:setLightData,LightType:LightType}=require("../../../utils/engine/index"),MathUtil=external_1.default.EditorMath,tempQuat_a=new cc_1.Quat;class LightComponentGizmo extends gizmo_base_1.default{constructor(){super(...arguments),this.Direction=LightType.DIRECTIONAL,this.Sphere=LightType.SPHERE,this.Spot=LightType.SPOT,this._curLightType=this.Direction,this._sphereLightRange=0,this._spotAngle=0,this._spotLightHeight=0,this._lightGizmoColor=new cc_1.Color(255,255,50),this._lightCtrlHoverColor=new cc_1.Color(0,255,0),this._activeController=null,this._lightController=[]}init(){this.createController(),this._isInited=!0}onShow(){this.updateControllerData()}onHide(){this._activeController.hide()}createController(){const t=this.getGizmoRoot(),e=create3DNode("LightGizmo");e.parent=t,this._lightController[this.Direction]=new direction_light_controller_1.default(e),this._lightController[this.Direction].setColor(this._lightGizmoColor);const o=new sphere_controller_1.default(e);o.setColor(this._lightGizmoColor),this._lightController[this.Sphere]=o,o.onControllerMouseDown=this.onControllerMouseDown.bind(this),o.onControllerMouseMove=this.onControllerMouseMove.bind(this),o.onControllerMouseUp=this.onControllerMouseUp.bind(this),o.editable=!0,o.hoverColor=this._lightCtrlHoverColor;const i=new cone_controller_1.default(e);this._lightController[this.Spot]=i,i.setColor(this._lightGizmoColor),i.onControllerMouseDown=this.onControllerMouseDown.bind(this),i.onControllerMouseMove=this.onControllerMouseMove.bind(this),i.onControllerMouseUp=this.onControllerMouseUp.bind(this),i.editable=!0,i.hoverColor=this._lightCtrlHoverColor,this._activeController=this._lightController[this._curLightType]}onControllerMouseDown(){if(!this._isInited||null==this.target)return;const t=getLightData(this.target);switch(this._curLightType){case this.Direction:break;case this.Sphere:this._sphereLightRange=t.range;break;case this.Spot:this._spotLightHeight=t.range,this._spotAngle=t.spotAngle}}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){}updateDataFromController(){if(this._activeController.updated){const t=this.node;switch(this._curLightType){case this.Direction:break;case this.Sphere:const t=this._activeController.getDeltaRadius();let e=this._sphereLightRange+t;e=MathUtil.toPrecision(e,3),e=Math.abs(e),setLightData(this.target,{range:e});break;case this.Spot:const o=this._activeController.getDeltaRadius(),i=this._activeController.getDeltaHeight();let r=this._spotLightHeight;0!==i&&(r=this._spotLightHeight+i,r=MathUtil.toPrecision(r,3),(r=Math.abs(r))<.01&&(r=.01));let l=this.getConeRadius(this._spotAngle,r),s=this._spotAngle;0!==o&&(l=this.getConeRadius(this._spotAngle,r)+o,l=Math.abs(l),(s=2*Math.atan2(l,r))<MathUtil.D2R&&(s=MathUtil.D2R),s*=MathUtil.R2D,s=MathUtil.toPrecision(s,3)),setLightData(this.target,{spotAngle:s,range:r})}this.onComponentChanged(t)}}updateControllerTransform(){const t=this.node,e=tempQuat_a,o=NodeUtils.getWorldPosition3D(t);this._curLightType!==this.Sphere&&NodeUtils.getWorldRotation3D(t,e),this._activeController.setPosition(o),this._activeController.setRotation(e)}getConeRadius(t,e){return Math.tan(t/2*MathUtil.D2R)*e}updateControllerData(){if(!this._isInited||null==this.target)return;const t=getLightData(this.target);if(t){if(this._activeController&&this._activeController.hide(),this._curLightType=t.type,this._curLightType>=this._lightController.length)return void console.error("no light controller of type:",this._curLightType);switch(this._activeController=this._lightController[this._curLightType],this._curLightType){case this.Direction:break;case this.Sphere:this._activeController.checkEdit(),this._activeController.radius=t.range;break;case this.Spot:this._activeController.checkEdit();const e=this.getConeRadius(t.spotAngle,t.range);this._activeController.updateSize(cc.v3(),e,t.range)}this._activeController.show(),this.updateControllerTransform()}}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=LightComponentGizmo;