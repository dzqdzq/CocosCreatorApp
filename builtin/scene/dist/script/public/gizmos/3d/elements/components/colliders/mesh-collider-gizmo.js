"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),mesh_controller_1=__importDefault(require("../../controller/mesh-controller")),gizmo_base_1=__importDefault(require("../../gizmo-base")),external_1=__importDefault(require("../../../../utils/external")),NodeUtils=external_1.default.NodeUtils,tempQuat_a=new cc_1.Quat;class MeshColliderGizmo extends gizmo_base_1.default{init(){this._controller=new mesh_controller_1.default(this.getGizmoRoot())}onShow(){this.updateControllerData()}onHide(){this._controller.hide()}updateControllerData(){if(this._isInited&&null!==this.target&&this.target instanceof cc_1.MeshCollider){const e=this.node,t=NodeUtils.getWorldScale3D(e),o=NodeUtils.getWorldPosition3D(e),i=tempQuat_a;NodeUtils.getWorldRotation3D(e,i),this._controller.setScale(t),this._controller.setPosition(o),this._controller.setRotation(i);const r=this.target,s=r.mesh;if(s){this._controller.show();const e=this.calcMeshData(s),t=e.points,o=r.center;for(let e=0;e<t.length;e+=3)t[e]+=o.x,t[e+1]+=o.y,t[e+2]+=o.z;this._controller.updateData(t,e.indices)}else this._controller.hide()}}calcMeshData(e){let t=[],o=[];const i=null===e||void 0===e?void 0:e.renderingSubMeshes.length;for(let r=0;r<i;r++){const i=e.renderingSubMeshes[r],s=i.geometricInfo;if(s){const e=i.primitiveMode,r=s.positions,l=s.indices,n=this._generateWireframeData(r,t.length/3,l,e);n&&(t=t.concat(n.positions),o=o.concat(n.edgeIndices))}}return{points:t,indices:o}}_generateWireframeData(e,t,o,i){if(!o)return console.error("indexBuffer of mesh is undefined"),null;let r=[];const s=[];if(i===cc_1.gfx.PrimitiveMode.TRIANGLE_LIST){r=Array.from(e);const i=o.length/3;for(let e=0;e<i;e++){const i=o[3*e+0]+t,r=o[3*e+1]+t,l=o[3*e+2]+t;s.push(i,r,r,l,l,i)}}else if(i===cc_1.gfx.PrimitiveMode.TRIANGLE_STRIP){r=Array.from(e);const i=o.length-2;let l=0;for(let e=0;e<i;e++){const i=o[e-l]+t,r=o[e+l+1]+t,n=o[e+2]+t;s.push(i,r,r,n,n,i),l=~l}}else if(i===cc_1.gfx.PrimitiveMode.TRIANGLE_FAN){r=Array.from(e);const i=o.length-2,l=o[0]+t;for(let e=0;e<i;e+=1){const i=o[e+1]+t,r=o[e+2]+t;s.push(l,i,i,r,r,l)}}return{positions:r,edgeIndices:s}}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}}exports.default=MeshColliderGizmo;