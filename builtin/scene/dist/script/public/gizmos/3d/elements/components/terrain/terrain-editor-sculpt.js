"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorSculpt=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_editor_sculpt_tools_1=require("./terrain-editor-sculpt-tools"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorSculpt extends terrain_editor_mode_1.TerrainEditorMode{constructor(t){super(t),this._undo=null,this._currentTool=null;const r=new terrain_brush_1.TerrainCircleBrush;r.strength=5;const e=new terrain_brush_1.TerrainImageBrush;e.strength=5,this._brushes=[r,e],this._currentBrush=this._brushes[0]}setCurrentBrush(t){const r=this._currentBrush.position,e=this._currentBrush.radius,i=this._currentBrush.strength,o=this._currentBrush._setHeight;this._currentBrush=this._brushes[t],this._currentBrush.position=r,this._currentBrush.radius=e,this._currentBrush.strength=i,this._currentBrush._setHeight=o}getCurrentBrush(){return this._currentBrush}getBrush(t){return this._brushes[t]}setBrushImage(t){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=t,null!==t?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}setSculptBrushRotation(t){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE)._rotation=t}onUpdate(t,r,e){if(null!=this._currentTool){const i=new terrain_brush_1.TerrainEdModifierKeyState;i.siftPressed=e,this._updateHeight(t,r,i),t.isTerrainChange=!0}}onUpdateBrushPosition(t,r){const e=this._currentBrush;e.update(t,r);for(const r of t.getBlocks()){const i=r.getIndex(),o=new cc_1.Rect;o.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,o.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,o.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize,o.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*t.info.tileSize;const n=new cc_1.Vec2,s=new cc_1.Vec2;e.getBound(n,s);const u=new cc_1.Rect;u.x=n.x,u.y=n.y,u.width=s.x-n.x,u.height=s.y-n.y,o.intersects(u)?r.setBrushMaterial(e.material):r.setBrushMaterial(null)}}onMouseDown(t){var r;this._undo=new terrain_operation_1.TerrainHeightUndoRedo(this.gizmo._target);let e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT;this.gizmo.isSmooth?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH:this.gizmo.isFlatten?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN:this.gizmo.isSetHeight&&(e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT),e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Sculpt(this.gizmo.isConcave):e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Smooth:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Flatten:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_SetHeight(this._currentBrush._setHeight):this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool;const i=this._currentBrush;let o=i.position.x,n=i.position.z;o/=t.info.tileSize,n/=t.info.tileSize,o=Math.floor(o),n=Math.floor(n),null===(r=this._currentTool)||void 0===r||r.start(t,o,n)}onMouseUp(){this._undo&&cce.SceneFacadeManager.beginRecording("",{customCommand:this._undo,auto:!0}),this._undo=null,this._currentTool=null}_updateHeight(t,r,e){const i=this._currentBrush;if(null===this._currentTool)return;const o=new cc_1.Vec2,n=new cc_1.Vec2;i.getBound(o,n);let s=o.x,u=o.y,_=n.x,l=n.y;if(s/=t.info.tileSize,u/=t.info.tileSize,_/=t.info.tileSize,l/=t.info.tileSize,s=Math.floor(s),u=Math.floor(u),_=Math.floor(_),l=Math.floor(l),s>t.info.vertexCount[0]-1||_<0)return;if(u>t.info.vertexCount[1]-1||l<0)return;s=clamp(s,0,t.info.vertexCount[0]-1),u=clamp(u,0,t.info.vertexCount[1]-1),_=clamp(_,0,t.info.vertexCount[0]-1),l=clamp(l,0,t.info.vertexCount[1]-1);const c=new terrain_operation_1.TerrainHeightOperation(t);this._undo&&this._undo.redoOperations.push(c);t.gizmo.isSmooth;for(let o=u;o<=l;++o)for(let n=s;n<=_;++n){let s=t.getHeightClamp(n,o);null!=this._undo&&this._undo.push(n,o,s);const u=n*t.info.tileSize,_=o*t.info.tileSize,l=i.getDelta(u,_)*r;s=this._currentTool.apply(t,n,o,s,l,e),c.push(n,o,s)}c.apply(),t.manager&&t.manager.onSculpt(t.node)}}exports.TerrainEditorSculpt=TerrainEditorSculpt;