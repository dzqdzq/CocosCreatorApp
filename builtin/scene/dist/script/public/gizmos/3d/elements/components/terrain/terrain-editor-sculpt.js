"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditorSculpt=void 0;const cc_1=require("cc"),terrain_brush_1=require("./terrain-brush"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_editor_sculpt_tools_1=require("./terrain-editor-sculpt-tools"),terrain_operation_1=require("./terrain-operation"),clamp=cc_1.math.clamp;class TerrainEditorSculpt extends terrain_editor_mode_1.TerrainEditorMode{constructor(r){super(r),this._undo=null,this._currentTool=null;const t=new terrain_brush_1.TerrainCircleBrush;t.strength=5;const e=new terrain_brush_1.TerrainImageBrush;e.strength=5,this._brushes=[t,e],this._currentBrush=this._brushes[0]}setCurrentBrush(r){const t=this._currentBrush.position,e=this._currentBrush.radius,i=this._currentBrush.strength,o=this._currentBrush._setHeight;this._currentBrush=this._brushes[r],this._currentBrush.position=t,this._currentBrush.radius=e,this._currentBrush.strength=i,this._currentBrush._setHeight=o}getCurrentBrush(){return this._currentBrush}getBrush(r){return this._brushes[r]}setBrushImage(r){this.getBrush(terrain_brush_1.TerrainBrushType.IMAGE).image=r,null!==r?this.setCurrentBrush(terrain_brush_1.TerrainBrushType.IMAGE):this.setCurrentBrush(terrain_brush_1.TerrainBrushType.CIRCLE)}onUpdate(r,t,e){if(null!=this._currentTool){const i=new terrain_brush_1.TerrainEdModifierKeyState;i.siftPressed=e,this._updateHeight(r,t,i),r.isTerrainChange=!0}}onUpdateBrushPosition(r,t){const e=this._currentBrush;e.update(r,t);for(const t of r.getBlocks()){const i=t.getIndex(),o=new cc_1.Rect;o.x=i[0]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.y=i[1]*cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.width=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize,o.height=cc_1.TERRAIN_BLOCK_TILE_COMPLEXITY*r.info.tileSize;const n=new cc_1.Rect;n.x=e.position.x-e.radius,n.y=e.position.z-e.radius,n.width=2*e.radius,n.height=2*e.radius,o.intersects(n)?t.setBrushMaterial(e.material):t.setBrushMaterial(null)}}onMouseDown(r){var t;this._undo=new terrain_operation_1.TerrainHeightUndoRedo(this.gizmo._target);let e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT;this.gizmo.isSmooth?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH:this.gizmo.isFlatten?e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN:this.gizmo.isSetHeight&&(e=terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT),e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SCULPT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Sculpt:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SMOOTH?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Smooth:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.FLATTEN?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_Flatten:e==terrain_editor_sculpt_tools_1.eTerrainTerrainEditorSculptToolMode.SET_HEIGHT?this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool_SetHeight(this._currentBrush._setHeight):this._currentTool=new terrain_editor_sculpt_tools_1.TerrainEditorSculptTool;const i=this._currentBrush;let o=i.position.x,n=i.position.z;o/=r.info.tileSize,n/=r.info.tileSize,o=Math.floor(o),n=Math.floor(n),null===(t=this._currentTool)||void 0===t||t.start(r,o,n)}onMouseUp(){this._undo&&cce.SceneFacadeManager.snapshot(this._undo),this._undo=null,this._currentTool=null}_updateHeight(r,t,e){const i=this._currentBrush;if(null===this._currentTool)return;let o=i.position.x-i.radius,n=i.position.z-i.radius,s=i.position.x+i.radius,u=i.position.z+i.radius;if(o/=r.info.tileSize,n/=r.info.tileSize,s/=r.info.tileSize,u/=r.info.tileSize,o=Math.floor(o),n=Math.floor(n),s=Math.floor(s),u=Math.floor(u),o>r.info.vertexCount[0]-1||s<0)return;if(n>r.info.vertexCount[1]-1||u<0)return;o=clamp(o,0,r.info.vertexCount[0]-1),n=clamp(n,0,r.info.vertexCount[1]-1),s=clamp(s,0,r.info.vertexCount[0]-1),u=clamp(u,0,r.info.vertexCount[1]-1);const _=new terrain_operation_1.TerrainHeightOperation(r);this._undo&&this._undo.redoOperations.push(_);r.gizmo.isSmooth;for(let l=n;l<=u;++l)for(let n=o;n<=s;++n){let o=r.getHeightClamp(n,l);null!=this._undo&&this._undo.push(n,l,o);const s=n*r.info.tileSize,u=l*r.info.tileSize,a=i.getDelta(s,u)*t;o=this._currentTool.apply(r,n,l,o,a,e),_.push(n,l,o)}_.apply(),r.manager&&r.manager.onSculpt(r.node)}}exports.TerrainEditorSculpt=TerrainEditorSculpt;