"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0});const events_1=require("events"),{create3DNode:create3DNode,getRaycastResults:getRaycastResults,raycast:raycast}=require("../utils/engine"),cc_1=require("cc"),node_1=__importDefault(require("../../../3d/manager/node")),node_2=__importDefault(require("../../../utils/node")),operation_1=__importDefault(require("../../operation")),selection_1=__importDefault(require("../../selection")),gizmo_config_1=__importDefault(require("../gizmo-config")),transform_tool_data_1=require("../utils/transform-tool-data"),world_axis_controller_1=__importDefault(require("./elements/controller/world-axis-controller")),vec3_1=require("../../../utils/math/vec3"),gizmo_defines_1=__importDefault(require("./gizmo-defines")),event_enum_1=require("../../../public/event-enum"),cce_1=__importDefault(require("./cce")),camera_1=__importDefault(require("../../../3d/manager/camera")),hitPoint=cc.v3(),SceneGizmoLayer=cc.Layers.Enum.SCENE_GIZMO;function setGizmoProperty(o,e){o.gizmo=e}function getGizmoProperty(o){return o.gizmo}function setIconGizmoProperty(o,e){o.iconGizmo=e}function getIconGizmoProperty(o){return o.iconGizmo}function setPersistentGizmoProperty(o,e){o.persistentGizmo=e}function getPersistentGizmoProperty(o){return o.persistentGizmo}function walkNodeComponent(o,e){o&&!node_2.default.isEditorNode(o)&&o.components.forEach(o=>{e(o)})}class GizmoManager extends events_1.EventEmitter{constructor(){super(...arguments),this.transformToolData=transform_tool_data_1.transformToolData,this._isIconGizmoVisible=!0,this._worldAxisController=null,this._sceneGizmoCamera=null,this.gizmoRootNode=null,this.hoverinNode=null,this.curSelectNode=null,this._gizmoToolMap={},this._selection=[],this._gizmosPool={},this._iconGizmoPool={},this._persistentGizmoPool={}}queryToolName(){return this.transformToolName}setTransformToolName(o){["position","rotation","scale","rect"].includes(o)&&(this.transformToolName=o)}queryCoordinate(){return this.coordinate}setCoordinate(o){["local","global"].includes(o)&&(this.coordinate=o)}queryPivot(){return this.pivot}setPivot(o){["pivot","center"].includes(o)&&(this.pivot=o)}queryIs2D(){return transform_tool_data_1.transformToolData.is2D}setIs2D(o){transform_tool_data_1.transformToolData.is2D=!!o,o?(this._worldAxisController.hide(),this.setIconGizmoVisible(!1)):(this._worldAxisController.show(),this.setIconGizmoVisible(!0)),this.emit("info-update")}isIconGizmoVisible(){return this._isIconGizmoVisible}setIconGizmoVisible(o){this._isIconGizmoVisible=o,node_1.default.queryUuids().forEach(e=>{walkNodeComponent(node_1.default.query(e),e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmoVisible(o)})})}isIconGizmo3D(){return gizmo_config_1.default.isIconGizmo3D}setIconGizmo3D(o){null!==o&&void 0!==o&&(gizmo_config_1.default.isIconGizmo3D=o,node_1.default.queryUuids().forEach(e=>{walkNodeComponent(node_1.default.query(e),e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmo3D(o)})}),cce.Engine.repaintInEditMode())}queryIconGizmoSize(){return gizmo_config_1.default.iconGizmoSize}setIconGizmoSize(o){null!==o&&void 0!==o&&(gizmo_config_1.default.iconGizmoSize=o,node_1.default.queryUuids().forEach(e=>{walkNodeComponent(node_1.default.query(e),e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmoSize(o)})}),cce.Engine.repaintInEditMode())}init(){this.gizmoRootNode=create3DNode("gizmoRoot"),this.gizmoRootNode.parent=cce.foregroundNode,this.initFromConfig(),operation_1.default.on("mousedown",this.onMouseDown.bind(this)),operation_1.default.on("mousemove",this.onMouseMove.bind(this)),operation_1.default.on("mouseup",this.onMouseUp.bind(this)),operation_1.default.on("wheel",this.onMouseWheel.bind(this)),operation_1.default.on("keydown",this.onKeyDown.bind(this)),operation_1.default.on("keyup",this.onKeyUp.bind(this)),camera_1.default.on("control-3d-mode",this.onCameraControlModeChanged.bind(this)),this._gizmoToolMap={},this._selection=[],this._gizmosPool={},selection_1.default.on("select",(o,e)=>{this.select(o,e)}),selection_1.default.on("unselect",o=>{this.unselect([o])}),this.createSceneGizmo(),cce_1.default.init(),this.emit("init")}async initFromConfig(){const o=await Editor.Profile.getConfig("scene","gizmos-infos");this.setIconGizmo3D(o.is3DIcon),this.setIconGizmoSize(o.iconSize),this.setIs2D(o.is2D)}createSceneGizmo(){const o=new cc.Node("Scene Gizmo Camera");o.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,o.parent=cce.backgroundNode;const e=o.addComponent("cc.Camera");e.inEditorMode=!0,this._sceneGizmoCamera=e,e.far=1e3,e.clearFlags=cc_1.gfx.ClearFlag.DEPTH_STENCIL,e.visibility=SceneGizmoLayer,e.rect=new cc.Rect(.7,.8,.2,.2),e.priority=1610612736,this._worldAxisController=new world_axis_controller_1.default(this.gizmoRootNode,e),this.setSceneGizmoCameraRect()}setSceneGizmoCameraRect(){const o=cc.director.root.curWindow.width,e=cc.director.root.curWindow.height,t=100/e,i=(o-e)*t/2/o;this._sceneGizmoCamera&&(this._sceneGizmoCamera.rect=new cc.Rect(1-t+i,1-t,t,t))}onSceneOpened(){this.clearAllGizmos(),this.transformToolName="position";const o=[];selection_1.default.query().forEach(e=>{o.push(e),this.select(e,o)}),this.initNodeGizmo(),this._worldAxisController.show(),this._worldAxisController.onEditorCameraMoved()}onSceneClosed(){this.saveGizmosInfos()}initNodeGizmo(){node_1.default.queryUuids().forEach(o=>{const e=node_1.default.query(o);e&&!node_2.default.isEditorNode(e)&&(this.showNodeGizmoOfNode(e),this.showComponentIconGizmoOfNode(e),this.showComponentPersistentGizmoOfNode(e))})}get transformTool(){return this._transformTool}get transformToolName(){return transform_tool_data_1.transformToolData.toolName}set transformToolName(o){transform_tool_data_1.transformToolData.toolName=o;const e=this.getGizmoToolByName(transform_tool_data_1.transformToolData.toolName);if(e&&e!==this._transformTool){let o=[];this._transformTool&&(this._transformTool.hide(),o=this._transformTool.target),this._transformTool=e,this.edit(o)}}get coordinate(){return transform_tool_data_1.transformToolData.coordinate}set coordinate(o){transform_tool_data_1.transformToolData.coordinate=o,this._transformTool&&this.edit(this._transformTool.target)}get pivot(){return transform_tool_data_1.transformToolData.pivot}set pivot(o){transform_tool_data_1.transformToolData.pivot=o,this._transformTool&&this.edit(this._transformTool.target)}lockGizmoTool(o){transform_tool_data_1.transformToolData.isLocked=o}isGizmoToolLocked(){return transform_tool_data_1.transformToolData.isLocked}getGizmoToolByName(o){let e=this._gizmoToolMap[o];if(!e){let t;switch(o){case"position":t=gizmo_defines_1.default.position;break;case"rotation":t=gizmo_defines_1.default.rotation;break;case"scale":t=gizmo_defines_1.default.scale;break;case"rect":t=gizmo_defines_1.default.rect}t?(this._gizmoToolMap[o]=this.createGizmo(o,t),e=this._gizmoToolMap[o]):console.error("Unknown transform tool %s",o)}return e}destroyGizmoInPool(o){Object.keys(o).forEach(e=>{o[e].forEach(o=>{this.destroyGizmo(o)})})}clearAllGizmos(){this.destroyGizmoInPool(this._gizmosPool),this.destroyGizmoInPool(this._iconGizmoPool),this.destroyGizmoInPool(this._persistentGizmoPool)}createGizmoFromPool(o,e,t,i=null){if(!t)return null;let n=o[e];n&&n[0]&&n[0].constructor!==t&&(n=null);let s=null;if(n){for(let o=0;o<n.length;o++)if(!n[o].visible()){(s=n[o]).target=i;break}s||(s=new t(i),n.push(s))}else n=[],s=new t(i),n.push(s),o[e]=n;return s}createGizmo(o,e,t=null){return this.createGizmoFromPool(this._gizmosPool,o,e,t)}destroyGizmo(o){o&&o.destroy()}hideGizmo(o){o&&o.hide()}hideComponentGizmo(o){const e=getGizmoProperty(o);e&&e.hide()}createIconGizmo(o,e,t=null){return this.createGizmoFromPool(this._iconGizmoPool,o,e,t)}createPersistentGizmo(o,e,t=null){return this.createGizmoFromPool(this._persistentGizmoPool,o,e,t)}showAllGizmoOfNode(o,e=!1){o&&!node_2.default.isEditorNode(o)&&(this.showNodeGizmoOfNode(o),this.showAllComponentsGizmoOfNode(o),!0===e&&o.children.forEach(o=>{this.showAllGizmoOfNode(o,!0)}))}showNodeGizmoOfNode(o,e=!1){if(o&&!node_2.default.isEditorNode(o)){if(o.activeInHierarchy){let e=null,t=null,i=getGizmoProperty(o);if(!i){const i=cc_1.js.getClassName(o);(e=gizmo_defines_1.default[i])&&setGizmoProperty(o,t=this.createGizmo(i,e,o))}(i=getGizmoProperty(o))&&i.show()}!0===e&&o.children.forEach(o=>{this.showNodeGizmoOfNode(o,!0)})}}showComponentGizmo(o){if(!getGizmoProperty(o)){const e=cc_1.js.getClassName(o),t=gizmo_defines_1.default.components[e];if(t){const i=this.createGizmo(e,t,o);i.show(),setGizmoProperty(o,i)}}}showComponentIconGizmo(o){if(!getIconGizmoProperty(o)){const e=cc_1.js.getClassName(o),t=gizmo_defines_1.default.iconGizmo[e];if(t){const i=this.createIconGizmo(e,t,o);i.setIconGizmoVisible(this.isIconGizmoVisible()),i.show(),setIconGizmoProperty(o,i)}}}showComponentPersistentGizmo(o){let e=getPersistentGizmoProperty(o);if(!e){const t=cc_1.js.getClassName(o),i=gizmo_defines_1.default.persistentGizmo[t];if(i){const n=this.createPersistentGizmo(t,i,o);setPersistentGizmoProperty(o,n),e=n}}null===e||void 0===e||e.show()}showComponentIconGizmoOfNode(o){o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentIconGizmo(o)})}showComponentPersistentGizmoOfNode(o){o&&o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentPersistentGizmo(o)})}showAllComponentsGizmoOfNode(o){o&&o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentIconGizmo(o),this.showComponentPersistentGizmo(o),o.enabledInHierarchy&&this.showComponentGizmo(o)})}removeAllGizmoOfNode(o,e=!1){o&&(this.removeNodeGizmoOfNode(o),this.removeAllComponentsGizmoOfNode(o),!0===e&&o.children.forEach(o=>{this.removeAllGizmoOfNode(o,!0)}))}removeNodeGizmoOfNode(o){if(!o)return;const e=getGizmoProperty(o);e&&(this.hideGizmo(e),setGizmoProperty(o,null))}removeComponentGizmo(o){const e=getGizmoProperty(o);e&&(this.hideGizmo(e),setGizmoProperty(o,null))}removeComponentIconGizmo(o){const e=getIconGizmoProperty(o);e&&(this.hideGizmo(e),setIconGizmoProperty(o,null))}removeComponentPersistentGizmo(o){const e=getPersistentGizmoProperty(o);e&&(this.hideGizmo(e),setPersistentGizmoProperty(o,null))}removeComponentsGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentGizmo(o)})}removeComponentsIconGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentIconGizmo(o)})}removeAllComponentsGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentGizmo(o),this.removeComponentIconGizmo(o),this.removeComponentPersistentGizmo(o)})}onComponentEnable(o){const e=cc.engine.getInstanceById(o);-1!==this._selection.indexOf(e.node.uuid)&&this.showAllComponentsGizmoOfNode(e.node)}onComponentDisable(o){const e=cc.engine.getInstanceById(o);if(!e)return;const t=getGizmoProperty(e);t&&(this.hideGizmo(t),setGizmoProperty(e,null))}updateGizmosState(o,e){if(!o)return;const t=o.components,i=getGizmoProperty(o);Object.keys(e).forEach(o=>{i&&(i[o]=e[o]),t.forEach(t=>{const i=getGizmoProperty(t);i&&(i[o]=e[o])})})}select(o,e){if(!o||!e)return;const t=node_1.default.query(o);if(!t)return;this.showAllComponentsGizmoOfNode(t),this._selection=e;const i=[];e.forEach(o=>{const e=node_1.default.query(o);e&&(this.updateGizmosState(e,{selecting:!0,editing:!1}),i.push(e))}),this.edit(i)}unselect(o){o.forEach(o=>{const e=this._selection.indexOf(o);-1!==e&&this._selection.splice(e,1);const t=node_1.default.query(o);this.updateGizmosState(t,{selecting:!1,editing:!1}),this.removeComponentsGizmoOfNode(t)});const e=this._selection.map(o=>node_1.default.query(o));this.edit(e.filter(o=>!!o)),cce.Engine.repaintInEditMode()}check(o){return o.filter(o=>cc.Node.isNode(o))}edit(o){0!==(o=this.check(o)).length?(1===o.length&&this.updateGizmosState(o[0],{selecting:!1,editing:!0}),this.transformTool&&(this.transformTool.target=o,this.transformTool.show(),cce.Engine.repaintInEditMode())):this._transformTool&&(this._transformTool.target=[])}onMouseDown(o){if(o.leftButton){const e=o.x,t=cc.game.canvas.height-o.y;let i=raycast(cc.director._scene._renderScene,this._sceneGizmoCamera._camera,SceneGizmoLayer,e,t);(!i||i.length<=0)&&(i=getRaycastResults(this.gizmoRootNode,e,t));i.ray;if(i.length>0){const n=i[0],s=new cc.Event("mouseDown",!0);return s.hitPoint=n.hitPoint.clone(),s.x=e,s.y=t,s.altKey=o.altKey,s.metaKey=o.metaKey,s.ctrlKey=o.ctrlKey,s.shiftKey=o.shiftKey,this.curSelectNode=n.node,this._emitEventToNode(this.curSelectNode,s),!0}return!1}return!0}onMouseWheel(o){}onMouseMove(o){const e=o.x,t=cc.game.canvas.height-o.y;let i=new cc.Event("mouseMove",!0);i.x=e,i.y=t,i.moveDeltaX=o.moveDeltaX,i.moveDeltaY=-o.moveDeltaY,i.altKey=o.altKey,i.metaKey=o.metaKey,i.ctrlKey=o.ctrlKey,i.shiftKey=o.shiftKey;let n=raycast(cc.director._scene._renderScene,this._sceneGizmoCamera._camera,SceneGizmoLayer,e,t);if((!n||n.length<=0)&&(n=getRaycastResults(this.gizmoRootNode,e,t)),this.curSelectNode)this._emitEventToNode(this.curSelectNode,i);else if(n.length>0){const o=n.ray;for(let e=0;e<n.length;e++)vec3_1.MVec3.multiplyScalar(hitPoint,o.d,n[e].distance),vec3_1.MVec3.add(hitPoint,o.o,hitPoint),i.hitPoint=hitPoint,n[e].node.emit(i.type,i);const s=n[0].node;s!==this.hoverinNode&&(this.hoverinNode&&(i=new cc.Event("hoverOut",!0),this._emitEventToNode(this.hoverinNode,i)),this.hoverinNode=s,(i=new cc.Event("hoverIn",!0)).x=e,i.y=t,this._emitEventToNode(this.hoverinNode,i))}else this.hoverinNode&&(i=new cc.Event("hoverOut",!0),this._emitEventToNode(this.hoverinNode,i)),this.hoverinNode=null}onMouseUp(o){const e=o.x,t=cc.game.canvas.height-o.y,i=new cc.Event("mouseUp",!0);if(i.x=e,i.y=t,i.altKey=o.altKey,i.metaKey=o.metaKey,i.ctrlKey=o.ctrlKey,i.shiftKey=o.shiftKey,this.curSelectNode)return this._emitEventToNode(this.curSelectNode,i),this.curSelectNode=null,!1;let n=raycast(cc.director._scene._renderScene,this._sceneGizmoCamera._camera,SceneGizmoLayer,e,t);(!n||n.length<=0)&&(n=getRaycastResults(this.gizmoRootNode,e,t));for(let o=0;o<n.length;o++)this._emitEventToNode(n[o].node,i);return!0}onMouseLeave(){const o=new cc.Event("mouseLeave",!0);this.curSelectNode&&(this._emitEventToNode(this.curSelectNode,o),this.curSelectNode=null)}onKeyDown(o){this.transformTool&&(this.transformTool.onGizmoKeyDown&&this.transformTool.onGizmoKeyDown(o),this.callAllGizmoFuncOfNode(this.transformTool.node,"onKeyDown",o))}onKeyUp(o){this.transformTool&&(this.transformTool.onGizmoKeyUp&&this.transformTool.onGizmoKeyUp(o),this.callAllGizmoFuncOfNode(this.transformTool.node,"onKeyUp",o))}callAllGizmoFuncOfNode(o,e,...t){if(!o)return;const i=getGizmoProperty(o);i&&i[e]&&i[e](...t),o.components.forEach(o=>{const i=getGizmoProperty(o);o&&i&&i[e]&&i[e](...t)})}notifyNodeChanged(o,e){if(!o)return;const t=getGizmoProperty(o);t&&t.onNodeChanged&&t.onNodeChanged(),!0===e&&o.children.forEach(o=>{this.notifyNodeChanged(o,!0)})}onNodeChanged(o,e){if(!o)return;const t=getGizmoProperty(o);t&&t.onNodeChanged&&t.onNodeChanged();const i=this._selection.indexOf(o.uuid),n=null===e||void 0===e?void 0:e.type;n===event_enum_1.NodeEventType.TRANSFORM_CHANGED||n===event_enum_1.NodeEventType.SIZE_CHANGED||n===event_enum_1.NodeEventType.ANCHOR_CHANGED||n===event_enum_1.NodeEventType.COMPONENT_CHANGED||n===event_enum_1.NodeEventType.PARENT_CHANGED||n===event_enum_1.NodeEventType.CHILD_CHANGED?o.components.length>0&&walkNodeComponent(o,o=>{const e=getPersistentGizmoProperty(o);e&&e.onNodeChanged&&e.onNodeChanged();const t=getIconGizmoProperty(o);t&&t.onNodeChanged&&t.onNodeChanged()}):(this.removeAllGizmoOfNode(o),this.showNodeGizmoOfNode(o),this.showComponentIconGizmoOfNode(o),this.showComponentPersistentGizmoOfNode(o),-1!==i&&this.showAllComponentsGizmoOfNode(o)),-1!==i&&(this.transformTool&&this.transformTool.onNodeChanged&&this.transformTool.onNodeChanged(),o.components.forEach(o=>{if(!o)return;const e=getGizmoProperty(o);e&&e.onNodeChanged&&e.onNodeChanged();const t=getIconGizmoProperty(o);t&&t.onNodeChanged&&t.onNodeChanged();const i=getPersistentGizmoProperty(o);i&&i.onNodeChanged&&i.onNodeChanged()})),n!==event_enum_1.NodeEventType.CHILD_CHANGED&&o.children.forEach(o=>{this.onNodeChanged(o,e)}),cce.Engine.repaintInEditMode()}onNodeAdded(o){if(o){this.showNodeGizmoOfNode(o,!0),-1!==this._selection.indexOf(o.uuid)&&this.showAllGizmoOfNode(o)}}onNodeRemoved(o){null!==o&&this.removeAllGizmoOfNode(o,!0)}onComponentAdded(o){if(o){-1!==this._selection.indexOf(o.node.uuid)&&this.showAllComponentsGizmoOfNode(o.node)}}onComponentRemoved(o){this.removeComponentIconGizmo(o),this.removeComponentPersistentGizmo(o);const e=getGizmoProperty(o);this.hideGizmo(e)}onResize(){this.setSceneGizmoCameraRect()}onUpdate(){this.transformTool&&this.transformTool.target&&this.transformTool.target.forEach(o=>{if(o){const e=getGizmoProperty(o);e&&e.update(),o._components&&o._components.forEach(o=>{const e=getGizmoProperty(o);o&&e&&e.update()})}})}saveGizmosInfos(){cce.Ipc.send("record-gizmos",{isIconGizmo3D:this.isIconGizmo3D(),iconGizmoSize:this.queryIconGizmoSize()})}onEditorCameraProjectionChanged(o){var e;null===(e=this._worldAxisController)||void 0===e||e.onCameraProjectionChanged(o)}_emitEventToNode(o,e){o.emit(e.type,e),cce.Engine.repaintInEditMode()}onCameraControlModeChanged(o){this.transformTool&&this.transformTool.target&&this.transformTool.target.forEach(e=>{e&&e._components&&e._components.forEach(e=>{const t=getGizmoProperty(e);e&&t&&t.onCameraControlModeChanged&&t.onCameraControlModeChanged(o)})})}}transform_tool_data_1.transformToolData.on("tool-name-changed",o=>{Editor.Message.broadcast("scene:gizmo-tool-changed",o)}),transform_tool_data_1.transformToolData.on("coordinate-changed",o=>{Editor.Message.broadcast("scene:gizmo-coordinate-changed",o)}),transform_tool_data_1.transformToolData.on("pivot-changed",o=>{Editor.Message.broadcast("scene:gizmo-pivot-changed",o)}),transform_tool_data_1.transformToolData.on("dimension-changed",o=>{Editor.Message.broadcast("scene:dimension-changed",o)}),exports.default=new GizmoManager;