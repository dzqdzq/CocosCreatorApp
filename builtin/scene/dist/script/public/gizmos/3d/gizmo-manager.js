"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GizmoManager=void 0;const events_1=require("events"),cc_1=require("cc"),node_1=__importDefault(require("../../../3d/manager/node")),node_2=__importDefault(require("../../../utils/node")),selection_1=__importDefault(require("../../selection")),gizmo_config_1=__importDefault(require("../gizmo-config")),transform_tool_data_1=require("../utils/transform-tool-data"),world_axis_controller_1=__importDefault(require("./elements/controller/world-axis-controller")),gizmo_base_1=__importDefault(require("./elements/gizmo-base")),gizmo_defines_1=__importDefault(require("./gizmo-defines")),event_enum_1=require("../../../public/event-enum"),cce_1=__importDefault(require("./cce")),camera_1=__importDefault(require("../../../3d/manager/camera")),message_1=require("../../../3d/manager/message"),rect_transform_snapping_1=require("../utils/rect-transform-snapping"),gizmo_operation_1=__importDefault(require("./gizmo-operation")),index_1=__importDefault(require("../utils/engine/index")),light_probe_gizmo_1=__importDefault(require("./elements/components/light/light-probe-gizmo")),model_component_gizmo_1=__importDefault(require("./elements/components/model-component-gizmo")),skinning_model_component_gizmo_1=__importDefault(require("./elements/components/skinning-model-component-gizmo")),index_2=__importDefault(require("../../../3d/manager/ipc/index")),selection_2=__importDefault(require("../../selection")),lodash_1=require("lodash"),gizmo_utils_1=require("./elements/gizmo-utils"),{create3DNode:create3DNode}=index_1.default,hitPoint=cc.v3(),SceneGizmoLayer=cc.Layers.Enum.SCENE_GIZMO;function setGizmoProperty(o,e){o.gizmo=e}function getGizmoProperty(o){return o.gizmo}function setIconGizmoProperty(o,e){o.iconGizmo=e}function getIconGizmoProperty(o){return o.iconGizmo}function setPersistentGizmoProperty(o,e){o.persistentGizmo=e}function getPersistentGizmoProperty(o){return o.persistentGizmo}function walkNodeComponent(o,e){o&&!node_2.default.isEditorNode(o)&&o.components.forEach(o=>{e(o)})}class GizmoManager extends events_1.EventEmitter{constructor(){super(...arguments),this.transformToolData=transform_tool_data_1.transformToolData,this._isIconGizmoVisible=!0,this._worldAxisController=null,this._sceneGizmoCamera=null,this.gizmoRootNode=null,this._gizmoToolMap={},this._selection=[],this._gizmosPool={},this._iconGizmoPool={},this._persistentGizmoPool={},this._transformTool=null,this._lightProbeEditModeListener=[gizmo_operation_1.default],this._lightProbeEditMode=!1,this._lightProbeBoundingBoxEditMode=!1}queryToolName(){return this.transformToolName}setTransformToolName(o){["position","rotation","scale","rect"].includes(o)&&(this.transformToolName=o)}queryCoordinate(){return this.coordinate}setCoordinate(o){["global","local"].includes(o)&&(this.coordinate=o)}queryPivot(){return this.pivot}setPivot(o){["center","pivot"].includes(o)&&(this.pivot=o)}queryIs2D(){return transform_tool_data_1.transformToolData.is2D}setIs2D(o){var e,t;transform_tool_data_1.transformToolData.is2D=!!o,o?(null===(e=this._worldAxisController)||void 0===e||e.hide(),this.setIconGizmoVisible(!1)):(null===(t=this._worldAxisController)||void 0===t||t.show(),this.setIconGizmoVisible(!0)),this.emit("info-update")}isIconGizmoVisible(){return this._isIconGizmoVisible}setIconGizmoVisible(o){this._isIconGizmoVisible=o,node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t&&walkNodeComponent(t,e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmoVisible(o)})})}isIconGizmo3D(){return gizmo_config_1.default.isIconGizmo3D}setIconGizmo3D(o){null!==o&&void 0!==o&&(gizmo_config_1.default.isIconGizmo3D=o,node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t&&walkNodeComponent(t,e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmo3D(o)})}),cce.Engine.repaintInEditMode())}queryIconGizmoSize(){return gizmo_config_1.default.iconGizmoSize}setIconGizmoSize(o){null!==o&&void 0!==o&&(gizmo_config_1.default.iconGizmoSize=o,node_1.default.queryUuids().forEach(e=>{const t=node_1.default.query(e);t&&walkNodeComponent(t,e=>{const t=getIconGizmoProperty(e);t&&t.setIconGizmoSize(o)})}),cce.Engine.repaintInEditMode())}queryToolsVisibility3d(){return gizmo_config_1.default.toolsVisibility3d}setToolsVisibility3d(o){gizmo_config_1.default.toolsVisibility3d=Boolean(o),selection_2.default.query().forEach(o=>{const e=node_1.default.query(o);e&&walkNodeComponent(e,o=>{const e=getGizmoProperty(o);e&&(e.target!==o&&this.showComponentGizmo(o,!0),(0,gizmo_utils_1.gizmoVisibilityCheck)(e)?e.show():e.hide())})}),cce.Engine.repaintInEditMode()}queryTransformSnapConfigs(){return transform_tool_data_1.transformToolData.snapConfigs.getPureDataObject()}setTransformSnapConfigs(o,e){transform_tool_data_1.transformToolData.snapConfigs[o]=e}queryRectSnappingConfigs(o){const e=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();return o?e[o]:e}setRectSnappingConfigs(o,e){rect_transform_snapping_1.rectTransformSnapping[o]=e,this.saveRectSnapConfigs()}init(){this.gizmoRootNode=create3DNode("gizmoRoot"),this.gizmoRootNode.parent=cce.foregroundNode,this.createSceneGizmo(),this.initFromConfig(),gizmo_operation_1.default.init(this),camera_1.default.on("control-3d-mode",this.onCameraControlModeChanged.bind(this)),this._gizmoToolMap={},this._selection=[],this._gizmosPool={},selection_1.default.on("select",(o,e)=>{this.select(o,e)}),selection_1.default.on("unselect",o=>{this.unselect([o])}),cce_1.default.init(),this.emit("init")}async initFromConfig(){const o=await Editor.Profile.getConfig("scene","gizmos-infos");this.setIconGizmo3D(o.is3DIcon),this.setIconGizmoSize(o.iconSize),this.setIs2D(o.is2D),this.setTransformToolName(o.transformToolName),this.setPivot(o.pivot),this.setCoordinate(o.coordinate),this.setToolsVisibility3d(!(0,lodash_1.isBoolean)(o.toolsVisibility3d)||o.toolsVisibility3d);const e=await Editor.Profile.getConfig("scene","snap-configs");e&&transform_tool_data_1.transformToolData.snapConfigs.initFromData(e);const t=await Editor.Profile.getConfig("scene","rect-snap-configs");t&&rect_transform_snapping_1.rectTransformSnapping.initFromData(t)}saveRectSnapConfigs(){const o=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();Editor.Profile.setConfig("scene","rect-snap-configs",o)}async saveConfig(){const o={is2D:this.queryIs2D(),is3DIcon:this.isIconGizmo3D(),iconSize:this.queryIconGizmoSize(),transformToolName:this.queryToolName(),pivot:this.queryPivot(),coordinate:this.queryCoordinate(),toolsVisibility3d:this.queryToolsVisibility3d()},e=transform_tool_data_1.transformToolData.snapConfigs.getPureDataObject(),t=rect_transform_snapping_1.rectTransformSnapping.getPureDataObject();index_2.default.send("record-gizmos",{gizmosInfos:o,snapConfigs:e,rectSnapConfigs:t})}createSceneGizmo(){const o=new cc.Node("Scene Gizmo Camera");o.layer=cc.Layers.Enum.EDITOR|cc.Layers.Enum.IGNORE_RAYCAST,o.parent=cce.backgroundNode;const e=o.addComponent("cc.Camera");e.inEditorMode=!0,this._sceneGizmoCamera=e,e.far=1e3,e.clearFlags=cc_1.gfx.ClearFlagBit.DEPTH_STENCIL,e.visibility=SceneGizmoLayer,e.rect=new cc.Rect(.7,.8,.2,.2),e.priority=1610612736,e.clearColor=new cc_1.Color(e.clearColor.r,e.clearColor.g,e.clearColor.b,0),this.gizmoRootNode&&(this._worldAxisController=new world_axis_controller_1.default(this.gizmoRootNode,e)),this.setSceneGizmoCameraRect()}setSceneGizmoCameraRect(){const o=cc.director.root.curWindow.width,e=cc.director.root.curWindow.height,t=e/6/e,i=(o-e)*t/2/o,n=30*window.devicePixelRatio/e;this._sceneGizmoCamera&&(this._sceneGizmoCamera.rect=new cc.Rect(1-t+i,1-t-n,t,t))}onSceneOpened(){var o,e;this.clearAllGizmos(),this.transformToolName="position";const t=[];selection_1.default.query().forEach(o=>{t.push(o),this.select(o,t),selection_1.default.select(o)}),this.initNodeGizmo(),transform_tool_data_1.transformToolData.is2D||null===(o=this._worldAxisController)||void 0===o||o.show(),null===(e=this._worldAxisController)||void 0===e||e.onEditorCameraMoved()}onSceneClosed(){this.saveConfig()}initNodeGizmo(){node_1.default.queryUuids().forEach(o=>{const e=node_1.default.query(o);e&&!node_2.default.isEditorNode(e)&&(this.showNodeGizmoOfNode(e),this.showComponentIconGizmoOfNode(e),this.showComponentPersistentGizmoOfNode(e))})}get transformTool(){return this._transformTool}get transformToolName(){return transform_tool_data_1.transformToolData.toolName}set transformToolName(o){transform_tool_data_1.transformToolData.toolName=o;const e=this.getGizmoToolByName(transform_tool_data_1.transformToolData.toolName);if(e&&e!==this._transformTool){let o=[];this._transformTool&&(this._transformTool.hide(),o=this._transformTool.target),this._transformTool=e,this.edit(o)}}get coordinate(){return transform_tool_data_1.transformToolData.coordinate}set coordinate(o){transform_tool_data_1.transformToolData.coordinate=o,this._transformTool&&this.edit(this._transformTool.target)}get pivot(){return transform_tool_data_1.transformToolData.pivot}set pivot(o){transform_tool_data_1.transformToolData.pivot=o,this._transformTool&&this.edit(this._transformTool.target)}lockGizmoTool(o){transform_tool_data_1.transformToolData.isLocked=o}isGizmoToolLocked(){return transform_tool_data_1.transformToolData.isLocked}getGizmoToolByName(o){let e=this._gizmoToolMap[o];if(!e){const t=gizmo_defines_1.default[o];t?(this._gizmoToolMap[o]=this.createGizmo(o,t),e=this._gizmoToolMap[o]):console.error("Unknown transform tool %s",o)}return e}destroyGizmoInPool(o){for(const e of Object.values(o))e.forEach(o=>{o.hide(),this.destroyGizmo(o)})}clearAllGizmos(){this.destroyGizmoInPool(this._gizmosPool),this.destroyGizmoInPool(this._iconGizmoPool),this.destroyGizmoInPool(this._persistentGizmoPool)}createGizmoFromPool(o,e,t,i=null){if(!t)return null;let n=o[e];n&&n[0]&&n[0].constructor!==t&&(n=null);let r=null;if(n){for(let o=0;o<n.length;o++)if(!n[o].visible()){(r=n[o]).target=i;break}r||(r=new t(i),n.push(r))}else n=[],r=new t(i),n.push(r),o[e]=n;return r instanceof gizmo_base_1.default&&r.shouldRegisterGizmoOperationEvent&&(gizmo_operation_1.default.registerGizmoOperationEventListener(r),r.shouldRegisterGizmoOperationEvent=!1),r}createGizmo(o,e,t=null){return this.createGizmoFromPool(this._gizmosPool,o,e,t)}destroyGizmo(o){o.target&&(o.target.gizmo&&(o.target.gizmo=null),o.target.iconGizmo&&(o.target.iconGizmo=null)),o&&o.destroy()}hideGizmo(o){o&&o.hide()}hideComponentGizmo(o){const e=getGizmoProperty(o);e&&e.hide()}createIconGizmo(o,e,t=null){return this.createGizmoFromPool(this._iconGizmoPool,o,e,t)}createPersistentGizmo(o,e,t=null){return this.createGizmoFromPool(this._persistentGizmoPool,o,e,t)}showAllGizmoOfNode(o,e=!1){o&&!node_2.default.isEditorNode(o)&&(this.showNodeGizmoOfNode(o),this.showAllComponentsGizmoOfNode(o),!0===e&&o.children.forEach(o=>{this.showAllGizmoOfNode(o,!0)}))}showNodeGizmoOfNode(o){if(o&&!node_2.default.isEditorNode(o)&&o.activeInHierarchy){const e=getGizmoProperty(o),t=cc_1.js.getClassName(o);if("cc.Scene"!==t)return;if(!e){const e=gizmo_defines_1.default[t];if(e){setGizmoProperty(o,this.createGizmo(t,e,o))}}const i=getGizmoProperty(o);i&&i.show()}}showComponentGizmo(o,e=!1){if(!getGizmoProperty(o)||e){const e=cc_1.js.getClassName(o),t=gizmo_defines_1.default.components[e];if(t){const i=this.createGizmo(e,t,o);i.initialize(),(0,gizmo_utils_1.gizmoVisibilityCheck)(t)&&i.show(),setGizmoProperty(o,i)}}}showComponentIconGizmo(o){const e=getIconGizmoProperty(o);if(!e){const e=cc_1.js.getClassName(o),t=gizmo_defines_1.default.iconGizmo[e];if(t){const i=this.createIconGizmo(e,t,o);i.setIconGizmoVisible(this.isIconGizmoVisible()),i.show(),setIconGizmoProperty(o,i)}}o instanceof cc_1.LightProbeGroup&&(null===e||void 0===e||e.show())}showComponentPersistentGizmo(o){let e=getPersistentGizmoProperty(o);if(!e){const t=cc_1.js.getClassName(o),i=gizmo_defines_1.default.persistentGizmo[t];if(i){const n=this.createPersistentGizmo(t,i,o);setPersistentGizmoProperty(o,n),e=n}}null===e||void 0===e||e.show()}showComponentIconGizmoOfNode(o){o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentIconGizmo(o)})}showComponentPersistentGizmoOfNode(o){o&&o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentPersistentGizmo(o)})}showAllComponentsGizmoOfNode(o){o&&o.parent&&o.activeInHierarchy&&walkNodeComponent(o,o=>{this.showComponentIconGizmo(o),this.showComponentPersistentGizmo(o),o.enabledInHierarchy&&this.showComponentGizmo(o)})}removeAllGizmoOfNode(o,e=!1){o&&(this.removeNodeGizmoOfNode(o),this.removeAllComponentsGizmoOfNode(o),!0===e&&o.children.forEach(o=>{this.removeAllGizmoOfNode(o,!0)}))}removeNodeGizmoOfNode(o){if(!o)return;const e=getGizmoProperty(o);e&&(this.hideGizmo(e),setGizmoProperty(o,null))}removeComponentGizmo(o){const e=getGizmoProperty(o);e&&(this.hideGizmo(e),setGizmoProperty(o,null))}removeComponentIconGizmo(o){const e=getIconGizmoProperty(o);e&&(this.hideGizmo(e),setIconGizmoProperty(o,null))}removeComponentPersistentGizmo(o){const e=getPersistentGizmoProperty(o);e&&(this.hideGizmo(e),setPersistentGizmoProperty(o,null))}removeComponentsGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentGizmo(o)})}removeComponentsIconGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentIconGizmo(o)})}removeAllComponentsGizmoOfNode(o){walkNodeComponent(o,o=>{this.removeComponentGizmo(o),this.removeComponentIconGizmo(o),this.removeComponentPersistentGizmo(o)})}showSceneNodeGizmo(o,e){if(o instanceof cc_1.Scene)if(e){let e=getGizmoProperty(o);if(!e){const e=cc_1.js.getClassName(o),t=gizmo_defines_1.default[e];if(t){setGizmoProperty(o,this.createGizmo(e,t,o))}}(e=getGizmoProperty(o))&&e.show()}else{const e=getGizmoProperty(o);e&&(this.hideGizmo(e),setGizmoProperty(o,null))}}showSelectionRegion(o,e,t,i){var n,r,s,a;const m=new cc_1.Vec3(o,i,.1),l=new cc_1.Vec3(e,i,.1),c=new cc_1.Vec3(e,t,.1),d=new cc_1.Vec3(o,t,.1),_=new cc_1.Vec3,h=new cc_1.Vec3,g=new cc_1.Vec3,f=new cc_1.Vec3;null===(n=camera_1.default.camera)||void 0===n||n.screenToWorld(m,_),null===(r=camera_1.default.camera)||void 0===r||r.screenToWorld(l,h),null===(s=camera_1.default.camera)||void 0===s||s.screenToWorld(c,g),null===(a=camera_1.default.camera)||void 0===a||a.screenToWorld(d,f);const u=cce.Engine.getGeometryRenderer();u&&(u.removeData("addQuad"),u.addQuad(_,h,g,f,new cc_1.Color(255,255,255,120),!1,!1,!0)),cce.Engine.repaintInEditMode()}hideSelectionRegion(){var o;null===(o=cce.Engine.getGeometryRenderer())||void 0===o||o.removeData("addQuad"),cce.Engine.repaintInEditMode()}onComponentEnable(o){const e=cc.engine.getInstanceById(o);-1!==this._selection.indexOf(e.node.uuid)&&this.showAllComponentsGizmoOfNode(e.node)}onComponentDisable(o){const e=cc.engine.getInstanceById(o);if(!e)return;const t=getGizmoProperty(e);t&&(this.hideGizmo(t),setGizmoProperty(e,null))}select(o,e){if(!o||!e)return;const t=node_1.default.query(o);if(!t)return;t instanceof cc_1.Scene&&this.showSceneNodeGizmo(t,!0),this.showAllComponentsGizmoOfNode(t),this._selection=e;const i=[];e.forEach(o=>{const e=node_1.default.query(o);e&&i.push(e)}),this.edit(i)}unselect(o){o.forEach(o=>{const e=this._selection.indexOf(o);-1!==e&&this._selection.splice(e,1);const t=node_1.default.query(o);if(t){t instanceof cc_1.Scene&&this.showSceneNodeGizmo(t,!1),t.getComponent(cc_1.LightProbeGroup)&&(this._lightProbeEditMode&&cce.SceneFacadeManager.toggleLightProbeEditMode(!1),this._lightProbeBoundingBoxEditMode&&cce.SceneFacadeManager.toggleLightProbeBoundingBoxEditMode(!1)),this.removeComponentsGizmoOfNode(t)}});const e=this._selection.map(o=>node_1.default.query(o));this.edit(e.filter(o=>!!o)),cce.Engine.repaintInEditMode()}check(o){if(!o)return[];return o.filter(o=>cc.Node.isNode(o))}edit(o){0!==(o=this.check(o)).length?this.transformTool&&(this.transformTool.target=o,this.transformTool.show(),cce.Engine.repaintInEditMode()):this._transformTool&&(this._transformTool.target=[])}onMouseLeave(){gizmo_operation_1.default.onMouseLeave()}callAllGizmoFuncOfNode(o,e,...t){let i=!1;return!o||(o.components.forEach(o=>{const n=getGizmoProperty(o);o&&n&&n[e]&&(i||(i=n[e](...t)))}),!i)}notifyNodeChanged(o,e){if(!o)return;const t=getGizmoProperty(o);t&&t.onNodeChanged&&(0,gizmo_utils_1.gizmoVisibilityCheck)(t)&&t.onNodeChanged({source:event_enum_1.EventSourceType.EDITOR,type:event_enum_1.NodeEventType.NOTIFY_NODE_CHANGED,modeName:"general"}),!0===e&&o.children.forEach(o=>{this.notifyNodeChanged(o,!0)})}onNodeChanged(o,e){if(!o)return;const t=getGizmoProperty(o);t&&t.onNodeChanged&&(0,gizmo_utils_1.gizmoVisibilityCheck)(t)&&t.onNodeChanged(e);const i=this._selection.indexOf(o.uuid),n=null===e||void 0===e?void 0:e.type;n===event_enum_1.NodeEventType.TRANSFORM_CHANGED||n===event_enum_1.NodeEventType.SIZE_CHANGED||n===event_enum_1.NodeEventType.ANCHOR_CHANGED||n===event_enum_1.NodeEventType.COMPONENT_CHANGED||n===event_enum_1.NodeEventType.PARENT_CHANGED||n===event_enum_1.NodeEventType.CHILD_CHANGED||n===event_enum_1.NodeEventType.PREFAB_INFO_CHANGED||n===event_enum_1.NodeEventType.LIGHT_PROBE_CHANGED?o.components.length>0&&walkNodeComponent(o,o=>{const t=getPersistentGizmoProperty(o);t&&t.onNodeChanged&&t.onNodeChanged(e);const i=getIconGizmoProperty(o);i&&i.onNodeChanged&&i.onNodeChanged(e)}):(this.removeAllGizmoOfNode(o),this.showNodeGizmoOfNode(o),this.showComponentIconGizmoOfNode(o),this.showComponentPersistentGizmoOfNode(o),-1!==i&&this.showAllComponentsGizmoOfNode(o)),-1!==i&&(this.transformTool&&this.transformTool.onNodeChanged&&this.transformTool.onNodeChanged(),o.components.forEach(o=>{if(!o)return;const t=getGizmoProperty(o);t&&t.onNodeChanged&&(0,gizmo_utils_1.gizmoVisibilityCheck)(t)&&t.onNodeChanged(e);const i=getIconGizmoProperty(o);i&&i.onNodeChanged&&i.onNodeChanged(e);const n=getPersistentGizmoProperty(o);n&&n.onNodeChanged&&n.onNodeChanged(e)})),n!==event_enum_1.NodeEventType.CHILD_CHANGED&&o.children.forEach(o=>{this.onNodeChanged(o,e)}),cce.Engine.repaintInEditMode()}onNodeAdded(o){if(o){this.showNodeGizmoOfNode(o),-1!==this._selection.indexOf(o.uuid)&&this.showAllGizmoOfNode(o)}}onNodeRemoved(o){null!==o&&this.removeAllGizmoOfNode(o,!0)}onComponentAdded(o){if(o){-1!==this._selection.indexOf(o.node.uuid)&&this.showAllComponentsGizmoOfNode(o.node)}}onComponentRemoved(o){this.removeComponentIconGizmo(o),this.removeComponentPersistentGizmo(o);const e=getGizmoProperty(o);this.hideGizmo(e)}onResize(){this.setSceneGizmoCameraRect()}onUpdate(o){this.transformTool&&this.transformTool.target&&this.transformTool.target.forEach(e=>{if(e){const t=getGizmoProperty(e);t&&t.update(o),e._components&&e._components.forEach(e=>{const t=getGizmoProperty(e);e&&t&&t.update(o)})}})}onEditorCameraProjectionChanged(o){var e;null===(e=this._worldAxisController)||void 0===e||e.onCameraProjectionChanged(o)}onCameraControlModeChanged(o){this.transformTool&&this.transformTool.target&&this.transformTool.target.forEach(e=>{e&&e._components&&e._components.forEach(e=>{const t=getGizmoProperty(e);e&&t&&t.onCameraControlModeChanged&&t.onCameraControlModeChanged(o)})})}onDimensionChanged(o){this.setToolsVisibility3d(gizmo_config_1.default.toolsVisibility3d)}get2DCanvas(){return this.rootCanvas?this.rootCanvas:(this.rootCanvasNode=create3DNode(GizmoManager.GIZMO_CANVAS_NODE_NAME),this.rootCanvas=this.rootCanvasNode.addComponent(cc_1.Canvas),this.rootCanvas.fitDesignResolution_EDITOR=(()=>{}),this.rootCanvasNode.setParent(this.gizmoRootNode),this.rootCanvas)}registerLightProbeEditModeListener(o){this._lightProbeEditModeListener.unshift(o)}lightProbeEditModeChanged(o){this._lightProbeEditMode=o,this._lightProbeEditModeListener.forEach(e=>{var t;return null===(t=e.lightProbeEditModeChanged)||void 0===t?void 0:t.call(e,o)})}get globalSelectProbes(){const o=[];return this._lightProbeEditModeListener.forEach(e=>{e instanceof light_probe_gizmo_1.default&&e.checkCurrentTargetPointingSelf()&&o.push(...e._controller.currentSelectedProbes)}),o}walkAllLightProbeGizmoListener(o){this._lightProbeEditModeListener.forEach(e=>{e instanceof light_probe_gizmo_1.default&&e.visible()&&e.checkCurrentTargetPointingSelf()&&o(e)})}updateLightProbeInnerTetrahedron(){this._gizmosPool["cc.MeshRenderer"]&&(this._gizmosPool["cc.MeshRenderer"].forEach(o=>{var e;if(o instanceof model_component_gizmo_1.default||o instanceof skinning_model_component_gizmo_1.default){if(!o.visible()||!o.target.model)return;null===(e=o.tetrahedronController)||void 0===e||e.updateInnerTetrahedron(o.tetrahedronController.getTetrahedronIndex())}}),cce.Engine.repaintInEditMode())}lightProbeInfoChanged(){this.walkAllLightProbeGizmoListener(o=>o.lightProbeInfoChanged())}boundingBoxEditModeChanged(o){this._lightProbeBoundingBoxEditMode=o,this._lightProbeEditModeListener.forEach(e=>{var t;return null===(t=e.boundingBoxEditModeChanged)||void 0===t?void 0:t.call(e,o)})}duplicateCurrentSelectedProbes(){gizmo_operation_1.default.duplicateCurrentSelectedProbes()}removeCurrentSelectedProbes(){gizmo_operation_1.default.removeCurrentSelectedProbes()}selectAllLightProbes(){gizmo_operation_1.default.selectAllLightProbes()}}function saveSnapConfigs(){const o=transform_tool_data_1.transformToolData.snapConfigs.getPureDataObject();Editor.Profile.setConfig("scene","snap-configs",o)}exports.GizmoManager=GizmoManager,GizmoManager.GIZMO_CANVAS_NODE_NAME="Gizmo Canvas Node",transform_tool_data_1.transformToolData.on("tool-name-changed",o=>{message_1.messageManager.broadcast("scene:gizmo-tool-changed",o)}),transform_tool_data_1.transformToolData.on("coordinate-changed",o=>{message_1.messageManager.broadcast("scene:gizmo-coordinate-changed",o)}),transform_tool_data_1.transformToolData.on("pivot-changed",o=>{message_1.messageManager.broadcast("scene:gizmo-pivot-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("snap-position-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:snap-position-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("snap-rotation-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:snap-rotation-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("snap-scale-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:snap-scale-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("enable-snap-position-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:enable-snap-position-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("enable-snap-rotation-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:enable-snap-rotation-changed",o)}),transform_tool_data_1.transformToolData.snapConfigs.on("enable-snap-scale-changed",o=>{saveSnapConfigs(),Editor.Message.broadcast("scene:enable-snap-scale-changed",o)}),exports.default=new GizmoManager;