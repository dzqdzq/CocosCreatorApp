"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=__importDefault(require("../utils")),external_1=__importDefault(require("../utils/external")),NodeUtils=external_1.default.NodeUtils,GizmoUtils=utils_1.default.GizmoUtils,transform_base_1=__importDefault(require("./transform-base")),scale_controller_1=__importDefault(require("./scale-controller")),cc_1=require("cc"),tempQuat_a=new cc_1.Quat;let _controller;class ScaleGizmo extends transform_base_1.default{_localScaleList=[];_offsetList=[];_center=new cc_1.Vec3;isNodeLocked(o){return!!o&&o.components.some(o=>o._objFlags&cc_1.CCObject.Flags.IsScaleLocked)}init(){this.createController()}layer(){return"foreground"}onTargetUpdate(){_controller&&((this._controller=_controller).onControllerMouseDown=this.onControllerMouseDown.bind(this),_controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),_controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)),super.onTargetUpdate()}createController(){_controller?this._controller=_controller:this._controller=_controller=new scale_controller_1.default(this.getGizmoRoot()),this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){this._controller&&(this._controller.isLock=this.nodes.some(o=>this.isNodeLocked(o))),this._localScaleList=[];var t=this.nodes;for(let o=0;o<t.length;++o){var e=t[o],r=(0,cc_1.v3)();e.getScale(r),this._localScaleList.push(r)}if("center"===this._controller.transformToolData.pivot){this._center=GizmoUtils.getCenterWorldPos3D(this.nodes);for(let o=this._offsetList.length=0;o<t.length;++o){var l=NodeUtils.getWorldPosition3D(t[o]),l=new cc_1.Vec3(l);l.subtract(this._center),this._offsetList.push(l)}}}onControllerMouseMove(o){this.updateDataFromController(o)}onControllerMouseUp(){this._controller.updated&&this.onControlEnd("scale")}onKeyDown(o){if(!this.nodes||0===this.nodes.length)return!0;var t=o.key.toLowerCase();if("arrowleft"!==t&&"arrowright"!==t&&"arrowup"!==t&&"arrowdown"!==t)return super.onKeyUp(o);o=o.shiftKey?1:.1;const e=(0,cc_1.v2)(),r=("arrowleft"===t?e.x=-1*o:"arrowright"===t?e.x=o:"arrowup"===t?e.y=o:"arrowdown"===t&&(e.y=-1*o),this.onControlUpdate("scale"),(0,cc_1.v3)());return this.nodes.forEach(o=>{o.getScale(r),r.x=r.x+e.x,r.y=r.y+e.y,this.setScaleWithPrecision(o,r,3)}),utils_1.default.repaintEngine(),!1}onKeyUp(o){var t;return!this.nodes||("arrowleft"!==(t=o.key.toLowerCase())&&"arrowright"!==t&&"arrowup"!==t&&"arrowdown"!==t?super.onKeyUp(o):(this.onControlEnd("scale"),!1))}setScaleWithPrecision(o,t,e){t=NodeUtils.makeVec3InPrecision(t,e),o.setScale(t.x,t.y,t.z)}checkSnap(t,e){var r=this._controller,l=r.moveAxisName;if(l){let o=0;o="xyz"===l?t.x:t[l],o=this.getSnappedValue(o,e),"xyz"===l?(t.x=o,t.y=o,t.z=o):t[l]=o;e=o*r.scaleFactor;r.onAxisSliderMove(l,e)}}updateDataFromController(t){if(this._controller.updated){this.onControlUpdate("scale");let o;var e,r=this._controller.getDeltaScale(),l=this._controller.transformToolData.snapConfigs,s=((this.isControlKeyPressed(t)||l.isScaleSnapEnabled)&&this.checkSnap(r,l.scale),(0,cc_1.v3)(1+r.x,1+r.y,1+r.z)),n=(0,cc_1.v3)(),i=this.nodes,a=new cc_1.Vec3;for(o=0;o<this._localScaleList.length;++o)n.x=this._localScaleList[o].x*s.x,n.y=this._localScaleList[o].y*s.y,n.z=this._localScaleList[o].z*s.z,this.setScaleWithPrecision(i[o],n,3),"center"===this._controller.transformToolData.pivot&&(e=(0,cc_1.v3)(this._offsetList[o].x*s.x,this._offsetList[o].y*s.y,this._offsetList[o].z*s.z),a.set(this._center),a.add(e),NodeUtils.setWorldPosition3D(i[o],a))}}updateControllerTransform(){var t=this.nodes[0];if(t){let o;var e=tempQuat_a;o="center"===this._controller.transformToolData.pivot?GizmoUtils.getCenterWorldPos3D(this.nodes):NodeUtils.getWorldPosition3D(t),NodeUtils.getWorldRotation3D(t,e),this._controller.setPosition(o),this._controller.setRotation(e)}}}exports.default=ScaleGizmo;