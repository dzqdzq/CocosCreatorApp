"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const base_1=__importDefault(require("../controller/base")),controller_utils_1=__importDefault(require("../utils/controller-utils")),external_1=__importDefault(require("../utils/external")),cc_1=require("cc"),operation_1=__importDefault(require("../../operation")),NodeUtils=external_1.default.NodeUtils,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,tempVec3_a=new cc_1.Vec3;class ScaleController extends base_1.default{_deltaScale=new cc_1.Vec3;_scaleFactor=125;static _baseCubeSize=12.5;static _baseAxisLength=70;static scale2D=new cc_1.Vec3(2,2,2);static scale3D=new cc_1.Vec3(1,1,1);_axisSliderNodes={};_mouseDeltaPos=new cc_1.Vec2;_cubeDragValue=0;_moveAxisName="";_axisDirMap={};get scaleFactor(){return this._scaleFactor}get moveAxisName(){return this._moveAxisName}constructor(e){super(e),this._lockSize=!0,this._axisDirMap.x=axisDirMap.x.clone(),this._axisDirMap.y=axisDirMap.y.clone(),this._axisDirMap.z=axisDirMap.z.clone(),this._axisDirMap.xyz=new cc_1.Vec3(1,1,1),this.initShape(),this.onDimensionChanged()}onCameraFovChanged=e=>{cce.Gizmo.is2D||(e=cc_1.Vec3.multiplyScalar(tempVec3_a,ScaleController.scale3D,e/45),this.setScale(e))};onDimensionChanged(){super.onDimensionChanged?.(),this.setScale(cce.Gizmo.is2D?ScaleController.scale2D:ScaleController.scale3D)}createAxis(e,t,a){t=controller_utils_1.default.scaleSlider(ScaleController._baseCubeSize,ScaleController._baseAxisLength,t,{priority:1e3}),t.name=e+"Slider",t.parent=this.shape,NodeUtils.setEulerAngles(t,a),a=this._axisDirMap[e],cc_1.Vec3.multiplyScalar(tempVec3_a,a,ScaleController._baseCubeSize/2),t.setPosition(tempVec3_a),this.initHandle(t,e),a={};a.head=t.getChildByName("ScaleSliderHead"),a.body=t.getChildByName("ScaleSliderBody"),this._axisSliderNodes[e]=a}initShape(){this.createShapeNode("ScaleController"),this.registerEvents(),this._axisSliderNodes={},this.createAxis("x",cc_1.Color.RED,new cc_1.Vec3(-90,-90,0)),this.createAxis("y",cc_1.Color.GREEN,new cc_1.Vec3(0,0,0)),this.createAxis("z",cc_1.Color.BLUE,new cc_1.Vec3(90,0,90));var e=controller_utils_1.default.cube(ScaleController._baseCubeSize,ScaleController._baseCubeSize,ScaleController._baseCubeSize,cc_1.Color.GRAY,void 0,{priority:1e3});e.name="xyzScale",e.parent=this.shape,this.initHandle(e,"xyz"),this.shape.active=!1}onAxisSliderMove(t,a){for(let e=0;e<t.length;e++){var s=t.charAt(e);if(null===s)return;var i=this._axisSliderNodes[s].head,s=this._axisSliderNodes[s].body,o=ScaleController._baseAxisLength+a,l=o/ScaleController._baseAxisLength;s.setScale(l,1,1),i.setPosition(0,o,0)}}getAlignAxisDeltaScale(e,t){var a=this._axisDirMap[e],t=this.getAlignAxisMoveDistance(this.localToWorldDir(a),t),s=(0,cc_1.v3)(),i=t/this._scaleFactor;return cc_1.Vec3.multiplyScalar(s,a,i),this.onAxisSliderMove(e,t),s}getAllAxisDeltaScale(e,t){let a=0,s=!1;var i=Math.abs(t.x),o=Math.abs(t.y),i=(.1<Math.abs(i-o)/Math.max(i,o)&&i<o&&(s=!0),t.length()),o=(a=s?Math.sign(t.y)*i:Math.sign(t.x)*i,this._cubeDragValue+=a,this._cubeDragValue/this._scaleFactor),t=(0,cc_1.v3)(o,o,o);return this.onAxisSliderMove(e,this._cubeDragValue),t}onMouseDown(e){e.propagationStopped=!0,this._deltaScale.set(0,0,0),this._mouseDeltaPos.set(0,0),this._cubeDragValue=0,cc_1.game.canvas&&(cc_1.game.canvas.style.cursor="pointer"),this._moveAxisName=e.handleName,this.onAxisSliderMove(e.handleName,0),this.onControllerMouseDown&&this.onControllerMouseDown(e),operation_1.default.requestPointerLock()}onMouseMove(e){e.propagationStopped=!0,this._isMouseDown&&(this._mouseDeltaPos.x+=e.moveDeltaX,this._mouseDeltaPos.y+=e.moveDeltaY,cc_1.Vec3.set(this._deltaScale,0,0,0),"xyz"===e.handleName?this._deltaScale=this.getAllAxisDeltaScale(e.handleName,(0,cc_1.v2)(e.moveDeltaX,e.moveDeltaY)):this._deltaScale=this.getAlignAxisDeltaScale(e.handleName,this._mouseDeltaPos),this.isLock?this.onControllerMouseMove&&this.onControllerMouseMove(e):(this.onControllerMouseMove&&this.onControllerMouseMove(e),this.updateController()))}onMouseUp(e){e.propagationStopped=!0,cc_1.game.canvas&&(cc_1.game.canvas.style.cursor="default"),this.onAxisSliderMove(this._moveAxisName,0),this.onControllerMouseUp&&this.onControllerMouseUp(e),operation_1.default.exitPointerLock()}onMouseLeave(e){this.onMouseUp(e)}onHoverIn(e){this.setHandleColor(e.handleName,cc_1.Color.YELLOW)}onHoverOut(e){this.resetHandleColor(e)}getDeltaScale(){return this._deltaScale}onShow(){this.registerEvents(),this.onCameraFovChanged(cce.Camera.getCameraFov()||0),this.transformToolData.is2D?(this._handleDataMap.z.topNode.active=!1,this.updateController()):this._handleDataMap.z.topNode.active=!0,this.onAxisSliderMove(this._moveAxisName,0)}onHide(){this.unregisterEvents()}}exports.default=ScaleController;