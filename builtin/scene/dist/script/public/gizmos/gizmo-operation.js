"use strict";var SelectMode,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,n)}:function(e,t,o,i){e[i=void 0===i?o:i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GizmoMouseEvent=void 0;const cc_1=require("cc"),camera_1=__importDefault(require("../../3d/manager/camera")),node_1=__importDefault(require("../../utils/node")),window_1=require("../../utils/window"),operation_1=__importStar(require("../operation")),selection_1=__importDefault(require("../selection")),gizmo_selection_1=__importDefault(require("../selection/gizmo-selection")),engine_1=__importDefault(require("./utils/engine")),set_util_1=__importStar(require("./utils/set-util")),gizmo_select_1=__importDefault(require("./components/light-probe-group/gizmo-select"));class GizmoMouseEvent extends cc_1.Event{constructor(e,t,o=!0){super(e,o),this.ctrlKey=!1,this.shiftKey=!1,this.altKey=!1,this.metaKey=!1,this.x=0,this.y=0,this.clientX=0,this.clientY=0,this.deltaX=0,this.deltaY=0,this.wheelDeltaX=0,this.wheelDeltaY=0,this.moveDeltaX=0,this.moveDeltaY=0,this.leftButton=!1,this.middleButton=!1,this.rightButton=!1,this.button=0,this.buttons=0,this.movementX=0,this.movementY=0,this.handleName="",this.x=t.x,this.y=adjustY(t.y),this.altKey=t.altKey,this.metaKey=t.metaKey,this.ctrlKey=t.ctrlKey,this.shiftKey=t.shiftKey,this.leftButton=t.leftButton,this.middleButton=t.middleButton,this.rightButton=t.rightButton,this.moveDeltaX=t.moveDeltaX,this.moveDeltaY=-t.moveDeltaY}}exports.GizmoMouseEvent=GizmoMouseEvent;const{getRaycastResults,raycast}=engine_1.default,hitPoint=(0,cc_1.v3)(),SceneGizmoLayer=cc_1.Layers.Enum.SCENE_GIZMO;function adjustY(e){return(0,window_1.getMainWindowSize)().height-e}!function(e){e[e.Node=0]="Node",e[e.Gizmo=1]="Gizmo"}(SelectMode=SelectMode||{});class GizmoOperation{constructor(){this._regionSelecting=!1,this._gizmoMoved=!1,this._selectMode=SelectMode.Node,this._hoverInNodeMap=new Map,this._curMouseDownInfos=[],this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._anyKeyDown=!1,this._gizmoOperationEventListeners=[],this._gizmoSelection=new gizmo_selection_1.default(this._gizmoOperationEventListeners)}raycastGizmos(e,t){var o;let i=raycast(null==(o=cc_1.director.getScene())?void 0:o.renderScene,cce.Gizmo.sceneGizmoCamera.camera,SceneGizmoLayer,e,t);return i=!i||i.length<=0?getRaycastResults(cce.Gizmo.gizmoRootNode,e,t,1/0,cc_1.Layers.Enum.IGNORE_RAYCAST):i}_emitEventToNode(e,t){t.type&&(e.emit(t.type,t),cce.Engine.repaintInEditMode())}_onNotGizmoMouseDown(t){this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseDown(t))}_onNotGizmoMouseUp(t){t.leftButton&&(this._regionSelecting?(this._regionSelecting=!1,cce.Gizmo.hideSelectionRegion(),this._selectMode===SelectMode.Gizmo&&this._gizmoSelection.confirm()):this._select(t),this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseUp(t)))}_onNotGizmoMouseMove(t){var e,o,i,n,s;return!!this._anyKeyDown||(e=this._noGizmoMouseDownEvent,t.leftButton&&e?(this._regionSelecting=!0,i=e.x>t.x,s=e.y<t.y,o=(i?t:e).x,i=(i?e:t).x,n=(s?e:t).y,s=(s?t:e).y,this._regionSelect(o,i,s,n,t.metaKey||t.ctrlKey),this._gizmoOperationEventListeners.forEach(e=>e.onNotGizmoMouseMove(t)),!1):void 0)}_onGizmoMouseDown(e,t){if(camera_1.default.controller.isMoving()||!e.leftButton)return!0;for(const i of t){var o={node:i.node,hitPoint:i.hitPoint.clone()};if(this._curMouseDownInfos.push(o),e.hitPoint=o.hitPoint,this._emitEventToNode(i.node,e),e.propagationStopped)break}return!1}_onGizmoMouseUp(t){if(!camera_1.default.controller.isMoving()){if(0<this._curMouseDownInfos.length){for(const n of this._curMouseDownInfos)if(t.hitPoint=n.hitPoint,this._emitEventToNode(n.node,t),t.propagationStopped)break;return this._curMouseDownInfos.length=0,this._gizmoMoved||this._selectMode!==SelectMode.Gizmo||this._selectGizmo(t),!1}var{x:e,y:o}=t,i=this.raycastGizmos(e,o);for(let e=0;e<i.length&&(this._emitEventToNode(i[e].node,t),!t.propagationStopped);e++);}return!0}_onGizmoMouseMove(e,t){if(0<this._curMouseDownInfos.length){const o=new Map;t.forEach(e=>o.set(e.node,e.hitPoint));for(const i of this._curMouseDownInfos)if(e.hitPoint=o.get(i.node)||(0,cc_1.v3)(),this._emitEventToNode(i.node,e),e.propagationStopped)break}}onMouseDown(e){this._gizmoMoved=!1,this._anyKeyDown=e.altKey||e.ctrlKey||e.shiftKey||e.metaKey;var e=new GizmoMouseEvent("mouseDown",e,!0),t=this.raycastGizmos(e.x,e.y);return 0<(this._mouseDownRaycastGizmos=t).length?(this._gizmoMouseDownEvent=e,this._onGizmoMouseDown(e,t)):(this._noGizmoMouseDownEvent=e,this._onNotGizmoMouseDown(e))}onMouseUp(e){this._gizmoMoved=!1,this._anyKeyDown=!1;e=new GizmoMouseEvent("mouseUp",e,!0);return this._mouseDownRaycastGizmos&&0<this._mouseDownRaycastGizmos.length?!this._gizmoMouseDownEvent||(this._gizmoMouseDownEvent=null,this._onGizmoMouseUp(e)):!this._noGizmoMouseDownEvent||(this._noGizmoMouseDownEvent=null,this._onNotGizmoMouseUp(e))}onMouseMove(e){this._gizmoMoved=!0;var e=new GizmoMouseEvent("mouseMove",e,!0),t=this.raycastGizmos(e.x,e.y);return this._mouseDownRaycastGizmos&&0<this._mouseDownRaycastGizmos.length?this._gizmoMouseDownEvent?this._onGizmoMouseMove(e,t):this._changeMouseHover(e,t):this._noGizmoMouseDownEvent?this._onNotGizmoMouseMove(e):this._changeMouseHover(e,t)}onMouseWheel(){}_changeMouseHover(o,t){if(!this._anyKeyDown){var e=cce.Selection.query();if(e[0]){e=cce.Node.query(e[0]);if(e)if(!1===cce.Gizmo.callAllGizmoFuncOfNode(e,"onVertexSnapMove",o))return!1}const n=new Set;if(0<t.length){var i=t.ray;for(let e=0;e<t.length;e++)cc_1.Vec3.multiplyScalar(hitPoint,i.d,t[e].distance),cc_1.Vec3.add(hitPoint,i.o,hitPoint),o.hitPoint=hitPoint,t[e].node.emit(o.type,o);for(const s of t)if(n.add(s.node),this._hoverInNodeMap.has(s.node)||(o.type="hoverIn",this._emitEventToNode(s.node,o),this._hoverInNodeMap.set(s.node,o.propagationStopped)),this._hoverInNodeMap.get(s.node))break}this._hoverInNodeMap.forEach((e,t)=>{n.has(t)||(o.type="hoverOut",o.customData={hoverInNodeMap:this._hoverInNodeMap},this._emitEventToNode(t,o),this._hoverInNodeMap.delete(t))})}return!0}_select(e){switch(this._selectMode){case SelectMode.Node:this._selectNode(e);break;case SelectMode.Gizmo:this._selectGizmo(e)}}_selectNode(e){e.metaKey||e.ctrlKey;var o=node_1.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR,cc_1.Layers.Enum.IGNORE_RAYCAST]));if(0<o.length){let t=null;for(let e=0;e<o.length;e++){var i=o[e];if(!(i._objFlags&cc_1.CCObject.Flags.LockedInEditor)){t=i;break}}if(t){var n=selection_1.default.query();if(e.ctrlKey||e.shiftKey||selection_1.default.clear(),e.ctrlKey)selection_1.default.isSelect(t.uuid)?selection_1.default.unselect(t.uuid):selection_1.default.select(t.uuid);else{var s=n[0];for(let e=0;e<o.length-1;e++)if(o[e]&&s===o[e].uuid){t=o[e+1];break}selection_1.default.select(t.uuid)}}}else!e.leftButton||e.ctrlKey||e.shiftKey||selection_1.default.clear()}_selectGizmo(e){var t=e.metaKey||e.ctrlKey,o=node_1.default.getRaycastResultNodes(camera_1.default.getCamera(),e.x,e.y,cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO]));0<o.length?this._gizmoSelection.processCurrent(o.map(e=>e.uuid),!1,t):!e.leftButton||e.ctrlKey||e.shiftKey||this._gizmoSelection.unselectAll()}_regionSelect(e,t,o,i,n=!1){switch(this._selectMode){case SelectMode.Node:this._regionSelectNode(e,t,o,i,n);break;case SelectMode.Gizmo:this._regionSelectGizmo(e,t,o,i,n)}}_regionSelectNode(e,t,o,i,n){cce.Gizmo.showSelectionRegion(e,t,o,i);var s=cc_1.Layers.makeMaskExclude([cc_1.Layers.Enum.GIZMOS,cc_1.Layers.Enum.SCENE_GIZMO,cc_1.Layers.Enum.EDITOR]),e=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,t,o,i,s);const r=new Set(selection_1.default.query());e.forEach(e=>{r.has(e.uuid)||selection_1.default.select(e.uuid),r.delete(e.uuid)});for(const c of r.keys())selection_1.default.unselect(c)}_regionSelectGizmo(e,t,o,i,n){cce.Gizmo.showSelectionRegion(e,t,o,i);var s=cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.GIZMOS]),e=node_1.default.getRegionNodes(camera_1.default.getCamera(),e,t,o,i,s,!1);this._gizmoSelection.processCurrent(e.map(e=>e.uuid),!0,n)}init(e){cce.Gizmo=e,operation_1.default.on("mousedown",this.onMouseDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousemove",this.onMouseMove.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mouseup",this.onMouseUp.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("mousewheel",this.onMouseWheel.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keydown",this.onKeyDown.bind(this),operation_1.OperationPriority.Gizmo),operation_1.default.on("keyup",this.onKeyUp.bind(this),operation_1.OperationPriority.Gizmo)}clear(){this._gizmoMouseDownEvent=null,this._noGizmoMouseDownEvent=null,this._hoverInNodeMap.clear(),this._curMouseDownInfos.length=0}onKeyDown(e){if(this._regionSelecting)return!1;var t=cce.Selection.query().map(e=>cce.Node.query(e));let o=!0;return o=t[0]?cce.Gizmo.callAllGizmoFuncOfNode(t[0],"onKeyDown",e):o}onKeyUp(e){var t=cce.Selection.query().map(e=>cce.Node.query(e));let o=!0;return o=t[0]?cce.Gizmo.callAllGizmoFuncOfNode(t[0],"onKeyUp",e):o}registerGizmoOperationEventListener(e){this._gizmoOperationEventListeners.push(e)}changeRegionSelectMode(e){this._selectMode=e,this._gizmoSelection.clear()}selectAllLightProbes(){for(const t of this._gizmoOperationEventListeners){var e;t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&(t.selectAll(),e=t.shouldEmitNodes(),this._gizmoSelection.logic.selected.addAll(e))}this._gizmoSelection.confirm()}unselectAllLightProbes(){for(const e of this._gizmoOperationEventListeners)e instanceof gizmo_select_1.default&&(e.unselectAll(),this._gizmoSelection.logic.selected.clear());this._gizmoSelection.confirm()}duplicateCurrentSelectedProbes(){var e=new set_util_1.default;for(const t of this._gizmoOperationEventListeners)t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&e.addAll(t.duplicateCurrentSelectedProbes());this._gizmoSelection.processCurrent(e.map(e=>e.uuid)),this._gizmoSelection.confirm()}removeCurrentSelectedProbes(){for(const t of this._gizmoOperationEventListeners){var e;t instanceof gizmo_select_1.default&&t.checkCurrentTargetPointingSelf()&&t.visible()&&(e=t.deleteCurrentSelectedProbes(),this._gizmoSelection.unselect((0,set_util_1.toSet)(e.map(e=>e.uuid))))}this._gizmoSelection.confirm()}}exports.default=new GizmoOperation;