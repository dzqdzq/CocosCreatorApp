"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),controller_shape_1=__importDefault(require("../utils/controller-shape")),controller_utils_1=__importDefault(require("../utils/controller-utils")),editable_1=__importDefault(require("./editable")),engine_1=__importDefault(require("../utils/engine")),{setMeshColor,getModel,updatePositions}=engine_1.default,axisDirMap=controller_utils_1.default.axisDirectionMap,AxisName=controller_utils_1.default.AxisName,tempVec3_a=new cc_1.Vec3,tempVec3_b=new cc_1.Vec3,tempVec3_c=new cc_1.Vec3,tempVec3_d=new cc_1.Vec3,tempVec3_e=new cc_1.Vec3,tempQuat_a=new cc_1.Quat;class CapsuleController extends editable_1.default{get radius(){return this._radius}set radius(t){this.updateSize(this._center,t,this._height)}get height(){return this._height}set height(t){this.updateSize(this._center,this._radius,t)}get direction(){return this._direction}set direction(t){this._direction=t}constructor(t){super(t),this._oriDir=cc.v3(0,1,0),this._direction=cc_1.EAxisDirection.Y_AXIS,this._center=cc.v3(),this._radius=100,this._height=100,this._halfHeight=this._height/2,this._deltaRadius=0,this._deltaHeight=0,this._mouseDeltaPos=new cc_1.Vec2,this._curDistScalar=0,this._upperCapMC=[],this._lowerCapMC=[],this._sideLineMC=null,this._upperCapNode=[],this._lowerCapNode=[],this._up=new cc_1.Vec3(0,1,0),this._right=new cc_1.Vec3(1,0,0),this._forward=new cc_1.Vec3(0,0,1),this._directionAxis=[new cc_1.Vec3(1,0,0),new cc_1.Vec3(0,1,0),new cc_1.Vec3(0,0,1)],this._editHandleKeys=Object.keys(axisDirMap),this.initShape()}setColor(e){this._upperCapNode.forEach(t=>{setMeshColor(t,e)}),this._lowerCapNode.forEach(t=>{setMeshColor(t,e)}),setMeshColor(this._sideLineNode,e),this.setEditHandlesColor(e),this._color=e}_updateEditHandle(t){var e=this._handleDataMap[t].topNode,i=axisDirMap[t],s=tempVec3_a.set(this._directionAxis[this._direction]),c=tempVec3_b;c.set(0,0,0),"y"===t?cc_1.Vec3.multiplyScalar(c,s,this._halfHeight):"neg_y"===t?cc_1.Vec3.multiplyScalar(c,s,-this._halfHeight):(cc_1.Vec3.multiplyScalar(c,i,this._radius),this._direction!==cc_1.EAxisDirection.Y_AXIS&&(t=tempQuat_a,cc_1.Quat.rotationTo(t,this._up,s),cc_1.Vec3.transformQuat(c,c,t))),c.add(this._center),cc_1.Vec3.multiply(c,c,this.getScale()),e.setPosition(c)}initShape(){this.createShapeNode("CapsuleController"),this.getUpperCapData(this._center,this._radius,this._height).forEach((t,e)=>{this._upperCapNode[e]=controller_utils_1.default.createShapeByData(t,this._color),this._upperCapNode[e].parent=this.shape,this._upperCapMC[e]=getModel(this._upperCapNode[e])});this.getLowerCapData(this._center,this._radius,this._height).forEach((t,e)=>{this._lowerCapNode[e]=controller_utils_1.default.createShapeByData(t,this._color),this._lowerCapNode[e].parent=this.shape,this._lowerCapMC[e]=getModel(this._lowerCapNode[e])});var t=this.getSideLinesData(this._center,this._radius,this._height);this._sideLineNode=controller_utils_1.default.createShapeByData(t,this._color),this._sideLineNode.parent=this.shape,this._sideLineMC=getModel(this._sideLineNode),this.hide()}updateSize(t,e,i){this._center=t,this._radius=e,this._height=i,this._halfHeight=i/2,this.getUpperCapData(this._center,this._radius,this._height).forEach((t,e)=>{e=this._upperCapMC[e];e&&updatePositions(e,t.positions)});this.getLowerCapData(this._center,this._radius,this._height).forEach((t,e)=>{e=this._lowerCapMC[e];e&&updatePositions(e,t.positions)});t=this.getSideLinesData(this._center,this._radius,this._height);this._sideLineMC&&updatePositions(this._sideLineMC,t.positions),this._edit&&this.updateEditHandles(),this.adjustEditHandlesSize()}onMouseDown(t){t.propagationStopped=!0,this._mouseDeltaPos=cc.v2(0,0),this._curDistScalar=super.getDistScalar(),this._deltaRadius=0,this._deltaHeight=0,this.onControllerMouseDown&&this.onControllerMouseDown(t)}onMouseMove(t){var e,i,s;t.propagationStopped=!0,this._isMouseDown&&(this._mouseDeltaPos.x+=t.moveDeltaX,this._mouseDeltaPos.y+=t.moveDeltaY,s=axisDirMap[t.handleName],e=tempVec3_a.set(this._directionAxis[this._direction]),i=tempQuat_a,cc_1.Quat.rotationTo(i,this._up,e),cc_1.Vec3.transformQuat(e,s,i),s=this.getAlignAxisMoveDistance(this.localToWorldDir(e),this._mouseDeltaPos)*this._curDistScalar,"y"===t.handleName||"neg_y"===t.handleName?this._deltaHeight=s:this._deltaRadius=s,this.onControllerMouseMove)&&this.onControllerMouseMove(t)}onMouseUp(t){t.propagationStopped=!0,this.onControllerMouseUp&&this.onControllerMouseUp(t)}onMouseLeave(t){this.onMouseUp(t)}getDeltaRadius(){return this._deltaRadius}getDeltaHeight(){return this._deltaHeight}getUpperCapData(t,e,i){var s,c,a=[],i=i/2,o=cc_1.Vec3.copy(tempVec3_a,this._up),r=cc_1.Vec3.copy(tempVec3_b,this._right),_=cc_1.Vec3.copy(tempVec3_c,this._forward),h=tempVec3_d,i=tempVec3_e.set(0,i,0);return this._direction!==cc_1.EAxisDirection.Y_AXIS&&(s=this._directionAxis[this._direction],c=tempQuat_a,cc_1.Quat.rotationTo(c,this._up,s),cc_1.Vec3.transformQuat(i,i,c),cc_1.Vec3.transformQuat(o,o,c),cc_1.Vec3.transformQuat(r,r,c),cc_1.Vec3.transformQuat(_,_,c)),cc_1.Vec3.add(h,t,i),a[0]=controller_shape_1.default.calcArcData(h,o,r,this._twoPI,e),a[1]=controller_shape_1.default.calcArcData(h,r,_,-Math.PI,e),a[2]=controller_shape_1.default.calcArcData(h,_,r,Math.PI,e),a}getLowerCapData(t,e,i){var s,c,a=[],i=i/2,o=cc_1.Vec3.copy(tempVec3_a,this._up),r=cc_1.Vec3.copy(tempVec3_b,this._right),_=cc_1.Vec3.copy(tempVec3_c,this._forward),h=tempVec3_d,i=tempVec3_e.set(0,-i,0);return this._direction!==cc_1.EAxisDirection.Y_AXIS&&(s=this._directionAxis[this._direction],c=tempQuat_a,cc_1.Quat.rotationTo(c,this._up,s),cc_1.Vec3.transformQuat(i,i,c),cc_1.Vec3.transformQuat(o,o,c),cc_1.Vec3.transformQuat(r,r,c),cc_1.Vec3.transformQuat(_,_,c)),cc_1.Vec3.add(h,t,i),a[0]=controller_shape_1.default.calcArcData(h,o,r,this._twoPI,e),a[1]=controller_shape_1.default.calcArcData(h,r,_,Math.PI,e),a[2]=controller_shape_1.default.calcArcData(h,_,r,-Math.PI,e),a}getSideLinesData(c,t,e){var i=[];const a=[];e/=2;return i.push(new cc_1.Vec3(t,e,0)),i.push(new cc_1.Vec3(t,-e,0)),i.push(new cc_1.Vec3(-t,e,0)),i.push(new cc_1.Vec3(-t,-e,0)),i.push(new cc_1.Vec3(0,e,t)),i.push(new cc_1.Vec3(0,-e,t)),i.push(new cc_1.Vec3(0,e,-t)),i.push(new cc_1.Vec3(0,-e,-t)),i.forEach((t,e)=>{var i,s;this._direction!==cc_1.EAxisDirection.Y_AXIS&&(i=this._directionAxis[this._direction],s=tempQuat_a,cc_1.Quat.rotationTo(s,this._up,i),cc_1.Vec3.transformQuat(t,t,s)),cc_1.Vec3.add(t,t,c),a.push(e)}),controller_shape_1.default.calcLinesData(i,a,!1)}}exports.default=CapsuleController;