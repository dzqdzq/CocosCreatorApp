"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Engine3D=void 0;const cc_1=require("cc"),raycast_1=__importDefault(require("../../../../utils/raycast")),external_1=__importDefault(require("../external")),aabb=external_1.default.GeometryUtils.aabb,CameraTool=external_1.default.EditorCamera,flat=(e,t)=>e.map(t).reduce((e,t)=>e.concat(t),[]),cmp=(e,t)=>e.distance-t.distance,ray=cc_1.geometry.Ray.create(),triangles=cc_1.gfx.PrimitiveMode.TRIANGLE_LIST;function setNodeMaterialProperty(e,t,o){e&&e.modelComp&&e.modelComp.material&&e.modelComp.material.setProperty(t,o)}const vbMap=new Map,ibMap=new Map;class Engine3D{constructor(){Engine3D.instance=this,this.panPlaneLayer=cc_1.Layers.Enum.EDITOR,this.CullMode=cc_1.gfx.CullMode,this.AttributeName=cc_1.gfx.AttributeName,this.PrimitiveMode=cc_1.gfx.PrimitiveMode,this.LightType=cc_1.Light.Type,this.ProjectionType=cc_1.Camera.ProjectionType,this.FOVAxis=cc_1.Camera.FOVAxis}static createInstance(){var e;return null!==(e=this.instance)&&void 0!==e?e:new Engine3D}create3DNode(e){const t=new cc.Node(e);return t._layer=cc.Layers.Enum.GIZMOS,t.modelColor=cc.color(),t}createMesh(e,t={}){const o={primitiveMode:e.primitiveType,positions:flat(e.positions,e=>[e.x,e.y,e.z]),indices:e.indices,minPos:e.minPos,maxPos:e.maxPos};e.normals&&(o.normals=flat(e.normals,e=>[e.x,e.y,e.z])),e.uvs&&(o.uvs=flat(e.uvs,e=>[e.x,e.y]));let r=o.customAttributes;if(t.dashed){r||(r=[]);const t=[];for(let o=0;o<e.positions.length;o+=2){const r=e.positions[o],n=e.positions[o+1];t[o]=0===o?0:t[o-1],t[o+1]=t[o]+cc_1.Vec3.distance(r,n)}r.push({attr:new cc_1.gfx.Attribute("a_lineDistance",cc_1.gfx.Format.R32F),values:t})}o.customAttributes=r;const n=cc.utils.createMesh(o),s=n.renderingSubMeshes[0],i=s.geometricInfo;i&&(i.doubleSided=e.doubleSided);const a=n.struct.vertexBundles[0].view;a&&(s.vBuffer=n.data.buffer.slice(a.offset,a.offset+a.length),vbMap.set(s,s.vBuffer));const c=n.struct.primitives[0].indexView;return c&&(s.iBuffer=n.data.buffer.slice(c.offset,c.offset+c.length),ibMap.set(s,s.iBuffer)),n}transformToDynamicGeometry(e){var t;return{primitiveMode:e.primitiveType,positions:Float32Array.from(flat(e.positions,e=>[e.x,e.y,e.z])),indices32:Uint32Array.from(null!==(t=e.indices)&&void 0!==t?t:[]),minPos:e.minPos,maxPos:e.maxPos}}createDynamicMesh(e,t){const o=e.transformToDynamicGeometry();e.normals&&(o.normals=Float32Array.from(flat(e.normals,e=>[e.x,e.y,e.z]))),e.uvs&&(o.uvs=Float32Array.from(flat(e.uvs,e=>[e.x,e.y])));let r=o.customAttributes;if(null===t||void 0===t?void 0:t.dashed){r||(r=[]);const t=[];for(let o=0;o<e.positions.length;o+=2){const r=e.positions[o],n=e.positions[o+1];t[o]=0===o?0:t[o-1],t[o+1]=t[o]+cc_1.Vec3.distance(r,n)}r.push({attr:new cc_1.gfx.Attribute("a_lineDistance",cc_1.gfx.Format.R32F),values:Float32Array.from(t)})}o.customAttributes=r;const n=cc_1.utils.MeshUtils.createDynamicMesh(0,o,void 0,t),s=n.renderingSubMeshes[0],i=s.geometricInfo;i&&(i.doubleSided=e.doubleSided);const a=n.struct.vertexBundles[0].view;a&&(s.vBuffer=n.data.buffer.slice(a.offset,a.offset+a.length),vbMap.set(s,s.vBuffer));const c=n.struct.primitives[0].indexView;return c&&(s.iBuffer=n.data.buffer.slice(c.offset,c.offset+c.length),ibMap.set(s,s.iBuffer)),n}updateDynamicMesh(e,t,o){var r;const n=o.transformToDynamicGeometry();null===(r=e.mesh)||void 0===r||r.updateSubMesh(t,n)}addMeshToNode(e,t,o={},r){const n=e.addComponent(cc_1.MeshRenderer),s={};o.forwardPipeline&&(s.USE_FORWARD_PIPELINE=!0),o.dashed&&(s.USE_DASHED_LINE=!0),o.instancing&&(s.USE_INSTANCING=!0),n.mesh=t;const i=n.onEnable.bind(n);n.onEnable=(()=>{i()});const a=t.renderingSubMeshes[0].primitiveMode;let c=0,l="editor/gizmo";o.effectName?l=o.effectName:c=o.unlit?1:o.texture?3:a<triangles?o.noDepthTestForLines?1:2:o.depthTestForTriangles?4:0;const d=null!==r&&void 0!==r?r:new cc_1.Material,u={};o.cullMode&&(u.rasterizerState={cullMode:o.cullMode}),a!==triangles&&(u.primitive=a),o.priority&&(u.priority=o.priority),d.isInitialized||d.initialize({effectName:l,technique:c,states:u,defines:s}),void 0!==o.alpha&&e.modelColor&&(e.modelColor.a=o.alpha),d.setProperty("mainColor",e.modelColor),n.material=d,e.modelComp=n}setMeshColor(e,t){let o=t.a;e.modelColor&&(o=e.modelColor.a),e.modelColor=t.clone(),e.modelColor.a=o,setNodeMaterialProperty(e,"mainColor",e.modelColor)}getMeshColor(e){return e.modelColor}setNodeOpacity(e,t){e.modelColor&&(e.modelColor.a=t),setNodeMaterialProperty(e,"mainColor",e.modelColor)}getNodeOpacity(e){var t,o;return null!==(o=null===(t=e.modelColor)||void 0===t?void 0:t.a)&&void 0!==o?o:0}setMaterialProperty(e,t,o){setNodeMaterialProperty(e,t,o)}getRaycastResults(e,t,o,r=1/0,n){const s=e.scene.renderScene,i=CameraTool.camera.camera;null===i||void 0===i||i.screenPointToRay(ray,t,o);let a=[];return raycast_1.default.raycastAllModels(s,ray,e._layer,r,n)&&(a=raycast_1.default.rayResultModels).sort(cmp),a.ray=ray,a}raycast(e,t,o,r,n,s=1/0,i){if(!t.enabled)return null;t.screenPointToRay(ray,r,n);let a=[];return raycast_1.default.raycastAllModels(e,ray,o,s,i)&&(a=raycast_1.default.rayResultModels).sort(cmp),a.ray=ray,a}raycastAllColliders(e,t,o){let r=[];return e.enabled?(e.screenPointToRay(ray,t,o),raycast_1.default.raycastAllColliders(ray)&&(r=raycast_1.default.raycastColliderResults).sort(cmp),r.ray=ray,r):r}getModel(e){return e.getComponent(cc_1.MeshRenderer)}updatePositions(e,t){const o=e.model&&e.model.subModels[0];if(!o||!o.inputAssembler||!o.subMesh)return;const{subMesh:r}=o,n=flat(t,e=>[e.x,e.y,e.z]);Engine3D.instance.updateVBAttr(e,cc_1.gfx.AttributeName.ATTR_POSITION,n),r.geometricInfo&&(r.geometricInfo.positions.length>=n.length?r.geometricInfo.positions.set(n):r.geometricInfo.positions=new Float32Array(n))}updateVBAttr(e,t,o){const r=e.model&&e.model.subModels[0];if(!r||!r.inputAssembler||!r.subMesh)return;const{inputAssembler:n,subMesh:s}=r;let i=s.vBuffer,a=0,c=cc_1.gfx.Format.UNKNOWN;for(const e of n.attributes){if(e.name===t){c=e.format;break}a+=cc_1.gfx.FormatInfos[e.format].size}const l=n.vertexBuffers[0];if(!c||!l)return;const d=l.stride*o.length/cc_1.gfx.FormatInfos[c].count;i.byteLength<d&&(i=new ArrayBuffer(d),vbMap.set(s,i),l.resize(d)),cc_1.utils.writeBuffer(new DataView(i),o,c,a,l.stride),l.update(i)}updateIB(e,t){const o=e.model&&e.model.subModels[0];if(!o||!o.inputAssembler||!o.subMesh)return;const{inputAssembler:r,subMesh:n}=o;let s=ibMap.get(n);const i=r.indexBuffer;if(i)if(r.indexCount===t.length)new Uint16Array(s).set(t),i.update(s),n.geometricInfo&&n.geometricInfo.indices&&n.geometricInfo.indices.set(t);else{const e=t.length*i.stride;if(e>s.byteLength&&(s=new ArrayBuffer(e),ibMap.set(n,s),i.resize(e)),new Uint16Array(s).set(t),i.update(s),r.indexCount=t.length,n.geometricInfo&&n.geometricInfo.indices){const e=new Uint16Array(t);n.geometricInfo.indices=e}}}updateBoundingBox(e,t,o){const r=e.model;r&&r.createBoundingShape(t,o)}getBoundingBox(e){var t;let o=null;if(e instanceof cc_1.MeshRenderer){if(e instanceof cc_1.SkinnedMeshRenderer)o=e.model&&e.model.worldBounds;else if(!(o=e.model&&e.model.modelBounds)){const t=e.mesh;t&&t.minPosition&&t.maxPosition&&(o=aabb.fromPoints(aabb.create(),t.minPosition,t.maxPosition))}}else if(e instanceof cc_1.SpriteRenderer){if(!(o=e.model&&e.model.modelBounds)){const r=null===(t=e.spriteFrame)||void 0===t?void 0:t.mesh;r&&r.struct.minPosition&&r.struct.maxPosition&&(o=aabb.fromPoints(aabb.create(),r.struct.minPosition,r.struct.maxPosition))}}else console.error("target is not a cc.MeshRenderer");return o}getRootBoneNode(e){let t=null;return e instanceof cc_1.SkinnedMeshRenderer?t=e.skinningRoot:console.error("target is not a cc.SkinnedMeshRenderer"),t}getRootBindPose(e){let t=null;if(e instanceof cc_1.SkinnedMeshRenderer){const o=e.skinningRoot,r=e.skeleton;if(o&&r){const e=r.joints.findIndex(e=>""===e);void 0!==e&&(t=r.bindposes[e])}}else console.error("target is not a cc.SkinnedMeshRenderer");return t}getCameraData(e){let t=null;if(e instanceof cc_1.Camera){(t={}).projection=e.projection,t.orthoHeight=e.orthoHeight,t.fov=e.fov;const o=e.camera?e.camera.width:800,r=e.camera?e.camera.height:600;t.aspect=o/r,t.near=e.near,t.far=e.far,t.fovAxis=e.fovAxis}else console.error("target is not a cc.Camera");return t}setCameraData(e,t){e instanceof cc_1.Camera?(t.fov&&(e.fov=t.fov),t.far&&(e.far=t.far),t.orthoHeight&&(e.orthoHeight=t.orthoHeight)):console.error("target is not a cc.Camera")}getLightData(e){let t=null;return e instanceof cc_1.Light?((t={}).type=e.type,t.range=e.range,t.spotAngle=e.spotAngle):console.error("target is not a cc.Light"),t}setLightData(e,t){e instanceof cc_1.Light?(t.range&&(e.range=t.range),t.spotAngle&&(e.spotAngle=t.spotAngle)):console.error("target is not a cc.Light")}}exports.Engine3D=Engine3D,exports.default=Engine3D.createInstance();