"use strict";var HighlightFace,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Engine3D=exports.HighlightFace=exports.RaycastResults=exports.ray=void 0;const cc_1=require("cc"),raycast_1=__importDefault(require("../../../../utils/raycast")),external_1=__importDefault(require("../external")),aabb=external_1.default.GeometryUtils.aabb,CameraTool=external_1.default.EditorCamera,flat=(e,t)=>e.map(t).reduce((e,t)=>e.concat(t),[]),cmp=(e,t)=>e.distance-t.distance,triangles=(exports.ray=cc_1.geometry.Ray.create(),cc_1.gfx.PrimitiveMode.TRIANGLE_LIST);class RaycastResults extends Array{ray;constructor(e){super(),this.ray=e}}function setNodeMaterialProperty(e,t,r){e&&e.modelComp&&e.modelComp.material&&e.modelComp.material.setProperty(t,r)}exports.RaycastResults=RaycastResults;const vbMap=new Map,ibMap=new Map;!function(e){e[e.NONE=0]="NONE",e[e.UP=1]="UP",e[e.DOWN=2]="DOWN",e[e.LEFT=3]="LEFT",e[e.RIGHT=4]="RIGHT",e[e.FRONT=5]="FRONT",e[e.BACK=6]="BACK"}(HighlightFace||(exports.HighlightFace=HighlightFace={}));class Engine3D{static instance;static createInstance(){return this.instance??new Engine3D}panPlaneLayer;CullMode;AttributeName;PrimitiveMode;LightType;ProjectionType;FOVAxis;constructor(){(Engine3D.instance=this).panPlaneLayer=cc_1.Layers.Enum.EDITOR,this.CullMode=cc_1.gfx.CullMode,this.AttributeName=cc_1.gfx.AttributeName,this.PrimitiveMode=cc_1.gfx.PrimitiveMode,this.LightType=cc_1.Light.Type,this.ProjectionType=cc_1.Camera.ProjectionType,this.FOVAxis=cc_1.Camera.FOVAxis}create3DNode(e){e=new cc.Node(e);return e._layer=cc.Layers.Enum.GIZMOS,e.modelColor=cc.color(),e}createMesh(t,e={}){var r={primitiveMode:t.primitiveType,positions:flat(t.positions,e=>[e.x,e.y,e.z]),indices:t.indices,minPos:t.minPos,maxPos:t.maxPos};t.normals&&(r.normals=flat(t.normals,e=>[e.x,e.y,e.z])),t.uvs&&(r.uvs=flat(t.uvs,e=>[e.x,e.y]));let o=r.customAttributes;if(e.dashed){o=o||[];var a=[];for(let e=0;e<t.positions.length;e+=2){var s=t.positions[e],i=t.positions[e+1];a[e]=0===e?0:a[e-1],a[e+1]=a[e]+cc_1.Vec3.distance(s,i)}o.push({attr:new cc_1.gfx.Attribute("a_lineDistance",cc_1.gfx.Format.R32F),values:a})}r.customAttributes=o;var e=cc_1.utils.createMesh(r),r=e.renderingSubMeshes[0],n=r.geometricInfo,n=(n&&(n.doubleSided=t.doubleSided),e.struct.vertexBundles[0].view),n=(n&&(r.vBuffer=e.data.buffer instanceof ArrayBuffer?e.data.buffer.slice(n.offset,n.offset+n.length):void 0,vbMap.set(r,r.vBuffer)),e.struct.primitives[0].indexView);return n&&(r.iBuffer=e.data.buffer instanceof ArrayBuffer?e.data.buffer.slice(n.offset,n.offset+n.length):void 0,ibMap.set(r,r.iBuffer)),e}transformToDynamicGeometry(e){return{primitiveMode:e.primitiveType,positions:Float32Array.from(flat(e.positions,e=>[e.x,e.y,e.z])),indices32:Uint32Array.from(e.indices??[]),minPos:e.minPos,maxPos:e.maxPos}}createDynamicMesh(t,e){var r=t.transformToDynamicGeometry();t.normals&&(r.normals=Float32Array.from(flat(t.normals,e=>[e.x,e.y,e.z]))),t.uvs&&(r.uvs=Float32Array.from(flat(t.uvs,e=>[e.x,e.y])));let o=r.customAttributes;if(e?.dashed){o=o||[];var a=[];for(let e=0;e<t.positions.length;e+=2){var s=t.positions[e],i=t.positions[e+1];a[e]=0===e?0:a[e-1],a[e+1]=a[e]+cc_1.Vec3.distance(s,i)}o.push({attr:new cc_1.gfx.Attribute("a_lineDistance",cc_1.gfx.Format.R32F),values:Float32Array.from(a)})}r.customAttributes=o;var r=cc_1.utils.MeshUtils.createDynamicMesh(0,r,void 0,e),e=r.renderingSubMeshes[0],n=e.geometricInfo,n=(n&&(n.doubleSided=t.doubleSided),r.struct.vertexBundles[0].view),n=(n&&(e.vBuffer=r.data.buffer.slice(n.offset,n.offset+n.length),vbMap.set(e,e.vBuffer)),r.struct.primitives[0].indexView);return n&&(e.iBuffer=r.data.buffer.slice(n.offset,n.offset+n.length),ibMap.set(e,e.iBuffer)),r}updateDynamicMesh(e,t,r){r=r.transformToDynamicGeometry();e.mesh?.updateSubMesh(t,r)}addMeshToNode(e,t,r={},o){var a=e.addComponent(cc_1.MeshRenderer),s={};r.forwardPipeline&&(s.USE_FORWARD_PIPELINE=!0),r.dashed&&(s.USE_DASHED_LINE=!0),r.instancing&&(s.USE_INSTANCING=!0),r.useLightProbe&&(s.CC_USE_LIGHT_PROBE=!0),a.mesh=t;const i=a.onEnable.bind(a);a.onEnable=()=>{i()};t=t.renderingSubMeshes[0].primitiveMode;let n=0,c="internal/editor/gizmo";r.effectName?c=r.effectName:n=r.technique||(r.unlit?1:r.texture?3:t<triangles?r.noDepthTestForLines?1:2:r.depthTestForTriangles?4:0);var o=o??new cc_1.Material,l={};r.cullMode&&(l.rasterizerState={cullMode:r.cullMode}),t!==triangles&&(l.primitive=t),r.priority&&(l.priority=r.priority),0===o.hash&&o.initialize({effectName:c,technique:n,states:l,defines:s}),void 0!==r.alpha&&e.modelColor&&(e.modelColor.a=r.alpha),o.setProperty("mainColor",e.modelColor),a.material=o,e.modelComp=a}setMeshSHCoefficients(t,r){var o=new cc_1.Vec4,a=["cc_sh_linear_const_r","cc_sh_linear_const_g","cc_sh_linear_const_b","cc_sh_quadratic_r","cc_sh_quadratic_g","cc_sh_quadratic_b","cc_sh_quadratic_a"];for(let e=0;e<a.length;e++){var s=4*e;o.set(r[s],r[1+s],r[2+s],r[3+s]),setNodeMaterialProperty(t,a[e],o)}}setMeshColor(e,t){let r=t.a;e.modelColor&&(r=e.modelColor.a),e.modelColor=t.clone(),e.modelColor.a=r,setNodeMaterialProperty(e,"mainColor",e.modelColor)}getMeshColor(e){return e.modelColor}setNodeOpacity(e,t){e.modelColor&&(e.modelColor.a=t),setNodeMaterialProperty(e,"mainColor",e.modelColor)}getNodeOpacity(e){return e.modelColor?.a??0}setMaterialProperty(e,t,r){setNodeMaterialProperty(e,t,r)}getRaycastResults(e,t,r,o=1/0,a){var s=e.scene.renderScene,t=(CameraTool.camera.camera?.screenPointToRay(exports.ray,t,r),new RaycastResults(exports.ray));return raycast_1.default.raycastAllModels(s,exports.ray,e._layer,o,!1,a)&&(t.push(...raycast_1.default.rayResultModels),t.sort(cmp)),t}getRaycastResultsByNodes(e,t,r,o=1/0,a,s){const i=new RaycastResults(exports.ray);CameraTool.camera.camera?.screenPointToRay(exports.ray,t,r);const n=(e,t)=>{e.getComponents(cc_1.MeshRenderer).forEach(e=>t(e)),0<e.children.length&&e.children.forEach(e=>{n(e,t)})};return e.forEach(t=>{n(t,e=>{e.model&&raycast_1.default.raycastSingleModel(exports.ray,e.model,t._layer,o,a,s)&&(i.push(...raycast_1.default.rayResultSingleModel),i.sort(cmp))})}),i}raycast(e,t,r,o,a,s=1/0,i){if(!t.enabled)return null;t.screenPointToRay(exports.ray,o,a);t=new RaycastResults(exports.ray);return raycast_1.default.raycastAllModels(e,exports.ray,r,s,!1,i)&&(t.push(...raycast_1.default.rayResultModels),t.sort(cmp)),t}raycastAllColliders(e,t,r){let o=[];return e.enabled&&(e.screenPointToRay(exports.ray,t,r),raycast_1.default.raycastAllColliders(exports.ray)&&(o=raycast_1.default.raycastColliderResults).sort(cmp),o.ray=exports.ray),o}getModel(e){return e.getComponent(cc_1.MeshRenderer)}updatePositions(e,t){var r=e.model&&e.model.subModels[0];r&&r.inputAssembler&&r.subMesh&&(r=r["subMesh"],t=flat(t,e=>[e.x,e.y,e.z]),Engine3D.instance.updateVBAttr(e,cc_1.gfx.AttributeName.ATTR_POSITION,t),r.geometricInfo)&&(r.geometricInfo.positions.length>=t.length?r.geometricInfo.positions.set(t):r.geometricInfo.positions=new Float32Array(t))}updateVBAttr(o,a,s){o=o.model&&o.model.subModels[0];if(o&&o.inputAssembler&&o.subMesh){var{inputAssembler:o,subMesh:i}=o;let e=i.vBuffer,t=0,r=cc_1.gfx.Format.UNKNOWN;for(const c of o.attributes){if(c.name===a){r=c.format;break}t+=cc_1.gfx.FormatInfos[c.format].size}var n,o=o.vertexBuffers[0];r&&o&&(n=o.stride*s.length/cc_1.gfx.FormatInfos[r].count,e.byteLength<n&&(e=new ArrayBuffer(n),vbMap.set(i,e),o.resize(n)),cc_1.utils.writeBuffer(new DataView(e),s,r,t,o.stride),o.update(e))}}updateIB(t,r){t=t.model&&t.model.subModels[0];if(t&&t.inputAssembler&&t.subMesh){var{inputAssembler:t,subMesh:o}=t;let e=ibMap.get(o);var a,s=t.indexBuffer;s&&(t.indexCount===r.length?(new Uint16Array(e).set(r),s.update(e),o.geometricInfo&&o.geometricInfo.indices&&o.geometricInfo.indices.set(r)):((a=r.length*s.stride)>e.byteLength&&(e=new ArrayBuffer(a),ibMap.set(o,e),s.resize(a)),new Uint16Array(e).set(r),s.update(e),t.indexCount=r.length,o.geometricInfo&&o.geometricInfo.indices&&(a=new Uint16Array(r),o.geometricInfo.indices=a)))}}updateBoundingBox(e,t,r){e=e.model;e&&e.createBoundingShape(t,r)}getBoundingBox(e){let t=null;var r;return e instanceof cc_1.MeshRenderer?e instanceof cc_1.SkinnedMeshRenderer?t=e.model&&e.model.worldBounds:(t=e.model&&e.model.modelBounds)||(r=e.mesh)&&r.minPosition&&r.maxPosition&&(t=aabb.fromPoints(aabb.create(),r.minPosition,r.maxPosition)):e instanceof cc_1.SpriteRenderer?(t=e.model&&e.model.modelBounds)||(r=e.spriteFrame?.mesh)&&r.struct.minPosition&&r.struct.maxPosition&&(t=aabb.fromPoints(aabb.create(),r.struct.minPosition,r.struct.maxPosition)):console.error("target is not a cc.MeshRenderer"),t}getRootBoneNode(e){let t=null;return e instanceof cc_1.SkinnedMeshRenderer?t=e.skinningRoot:console.error("target is not a cc.SkinnedMeshRenderer"),t}getRootBindPose(e){let t=null;var r;return e instanceof cc_1.SkinnedMeshRenderer?(r=e.skinningRoot,e=e.skeleton,r&&e&&void 0!==(r=e.joints.findIndex(e=>""===e))&&(t=e.bindposes[r])):console.error("target is not a cc.SkinnedMeshRenderer"),t}getCameraData(e){let t=null;var r,o;return e instanceof cc_1.Camera?((t={}).projection=e.projection,t.orthoHeight=e.orthoHeight,t.fov=e.fov,r=e.camera?e.camera.width:800,o=e.camera?e.camera.height:600,t.aspect=r/o,t.near=e.near,t.far=e.far,t.fovAxis=e.fovAxis):console.error("target is not a cc.Camera"),t}setCameraData(e,t){e instanceof cc_1.Camera?(t.fov&&(e.fov=t.fov),t.far&&(e.far=t.far),t.orthoHeight&&(e.orthoHeight=t.orthoHeight)):console.error("target is not a cc.Camera")}getLightData(e){let t=null;return e instanceof cc_1.Light?((t={}).type=e.type,t.range=e.range,t.spotAngle=e.spotAngle):console.error("target is not a cc.Light"),t}setLightData(e,t){e instanceof cc_1.Light?(t.range&&(e.range=t.range),t.spotAngle&&(e.spotAngle=t.spotAngle)):console.error("target is not a cc.Light")}}exports.Engine3D=Engine3D,exports.default=Engine3D.createInstance();