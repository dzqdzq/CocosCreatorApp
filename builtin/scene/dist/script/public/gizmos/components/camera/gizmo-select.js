"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const cc_1=require("cc"),external_1=__importDefault(require("../../utils/external")),scene_view_data_1=require("../../../../3d/manager/scene-view/scene-view-data"),index_1=__importDefault(require("../../utils/engine/index")),base_1=require("../base"),frustum_1=__importDefault(require("../../controller/frustum")),NodeUtils=external_1.default.NodeUtils,{getCameraData,setCameraData,ProjectionType,FOVAxis}=index_1.default,EditorMath=external_1.default.EditorMath,tempQuat_a=new cc_1.Quat;class CameraComponentGizmo extends base_1.SelectGizmo{_controller;_fov=0;_near=0;_far=0;_aspect=0;_farHalfWidth=0;_farHalfHeight=0;_projection=0;_fovAxis=FOVAxis.VERTICAL;_onTargetResolutionChanged;init(){this.createController(),this._isInitialized=!0,this._onTargetResolutionChanged=this.onTargetResolutionChanged.bind(this)}onShow(){this._controller.show(),this.updateControllerData(),scene_view_data_1.sceneViewData.on("target-resolution-changed",this._onTargetResolutionChanged)}onHide(){this._controller.hide(),scene_view_data_1.sceneViewData.off("target-resolution-changed",this._onTargetResolutionChanged)}createController(){var t=this.getGizmoRoot();this._controller=new frustum_1.default(t),this._controller.editable=!0,this._controller.onControllerMouseDown=this.onControllerMouseDown.bind(this),this._controller.onControllerMouseMove=this.onControllerMouseMove.bind(this),this._controller.onControllerMouseUp=this.onControllerMouseUp.bind(this)}onControllerMouseDown(){var t;this._isInitialized&&null!=this.target&&(t=getCameraData(this.target),this._projection=t.projection,this._fov=t.fov,this._near=t.near,this._far=t.far,this._aspect=scene_view_data_1.sceneViewData.targetAspect,this._fovAxis=t.fovAxis,this._projection===ProjectionType.PERSPECTIVE?this._fovAxis===FOVAxis.VERTICAL?(this._farHalfHeight=Math.tan(EditorMath.deg2rad(this._fov/2))*this._far,this._farHalfWidth=this._farHalfHeight*this._aspect):(this._farHalfWidth=Math.tan(EditorMath.deg2rad(this._fov/2))*this._far,this._farHalfHeight=this._farHalfWidth/this._aspect):(this._farHalfHeight=t.orthoHeight,this._farHalfWidth=this._farHalfHeight*this._aspect),this.onControlBegin(""))}onControllerMouseMove(){this.updateDataFromController()}onControllerMouseUp(){this.onControlEnd("")}updateDataFromController(){if(this._controller.updated){var t=this._controller.getDeltaWidth(),e=this._controller.getDeltaHeight(),r=this._controller.getDeltaDistance();let a=this._farHalfHeight,o=this._farHalfWidth,i=(0!==t&&(o=this._farHalfWidth+t,a=o/this._aspect),0!==e&&(a=this._farHalfHeight+e,o=a*this._aspect),this._far);if(0!==r&&(i=this._far+r,(i=Math.abs(i))<this._near&&(i=this._near+.01),i=EditorMath.toPrecision(i,3)),a=Math.abs(a),this._projection===ProjectionType.PERSPECTIVE){let t=this._fov,e=a;this._fovAxis===FOVAxis.HORIZONTAL&&(e=o),a===this._farHalfHeight&&o===this._farHalfWidth||((t=2*Math.atan2(e,this._far))<EditorMath.D2R&&(t=EditorMath.D2R),t*=EditorMath.R2D,t=EditorMath.toPrecision(t,3)),setCameraData(this.target,{fov:t,far:i})}else a=EditorMath.toPrecision(a,3),setCameraData(this.target,{orthoHeight:a,far:i});this.target&&this.onComponentChanged(this.target.node)}}updateControllerTransform(){var t,e,a;this.target&&(t=this.target.node,e=NodeUtils.getWorldPosition3D(t),a=tempQuat_a,NodeUtils.getWorldRotation3D(t,a),this._controller.setPosition(e),this._controller.setRotation(a))}updateControllerData(){var t,e;!this._isInitialized||null==this.target||this.target.node&&!this.target.node.activeInHierarchy||(t=getCameraData(this.target),e=scene_view_data_1.sceneViewData.targetAspect,t&&(this._controller.checkEdit(),this._controller.updateSize(t.projection,t.orthoHeight,t.fov,e,t.near,t.far,t.fovAxis),this.updateControllerTransform()))}onTargetUpdate(){this.updateControllerData()}onNodeChanged(){this.updateControllerData()}onTargetResolutionChanged(){this.updateControllerData(),cce.Engine.repaintInEditMode()}}exports.default=CameraComponentGizmo;