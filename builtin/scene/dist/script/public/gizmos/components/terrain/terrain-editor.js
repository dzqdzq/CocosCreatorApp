"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainEditor=void 0;const terrain_editor_manage_1=require("./terrain-editor-manage"),terrain_editor_mode_1=require("./terrain-editor-mode"),terrain_editor_paint_1=require("./terrain-editor-paint"),terrain_editor_sculpt_1=require("./terrain-editor-sculpt"),terrain_editor_select_1=require("./terrain-editor-select"),cc_1=require("cc"),controller_utils_1=__importDefault(require("../../utils/controller-utils")),external_1=__importDefault(require("../../utils/external")),terrain_brush_1=require("./terrain-brush"),EditorCamera=external_1.default.EditorCamera,tempVec3_1=new cc_1.Vec3,tempVec3_2=new cc_1.Vec3,tempVec3_3=new cc_1.Vec3;class TerrainEditor{_terrain=null;_modes;_currentMode=null;_cameraComp=null;isChanged=!1;_gizmo;constructor(e,r){this._modes=[new terrain_editor_manage_1.TerrainEditorManage(r),new terrain_editor_sculpt_1.TerrainEditorSculpt(r),new terrain_editor_paint_1.TerrainEditorPaint(r),new terrain_editor_select_1.TerrainEditorSelect(r)],this._cameraComp=e,this._gizmo=r,this.setMode(terrain_editor_mode_1.eTerrainEditorMode.MANAGE)}setEditTerrain(e){this._terrain=e}getEditTerrain(){return this._terrain}setMode(e){e=this._modes[e];null!=this._currentMode&&this._currentMode.onDeactivate(),this._currentMode=e,null!=this._currentMode&&this._currentMode.onActivate(),this.clearBrush()}clearBrush(){if(null!=this._terrain)for(const e of this._terrain.getBlocks())e.setBrushMaterial(null);this._currentMode?.onDeactivate()}getMode(e){return this._modes[e]}getCurrentMode(){return this._currentMode}getCurrentModeType(){return this._currentMode===this._modes[0]?terrain_editor_mode_1.eTerrainEditorMode.MANAGE:this._currentMode===this._modes[1]?terrain_editor_mode_1.eTerrainEditorMode.SCULPT:this._currentMode===this._modes[2]?terrain_editor_mode_1.eTerrainEditorMode.PAINT:this._currentMode===this._modes[3]?terrain_editor_mode_1.eTerrainEditorMode.SELECT:terrain_editor_mode_1.eTerrainEditorMode.SCULPT}setCurrentLayer(e){this.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT).setCurrentLayer(e)}getCurrentLayer(){return this.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT).getCurrentLayer()}update(e,r){null!=this._currentMode&&null!=this._terrain&&(this._currentMode.onUpdate(this._terrain,e,r),cce.Engine.repaintInEditMode())}onMouseDown(e,r){var t,i,o;null!=this._terrain&&(this.isChanged=!1,t=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT),i=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT),o=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SELECT),this._currentMode===t?(t.onMouseDown(this._terrain),this.isChanged=!0):this._currentMode===i?(i.onMouseDown(this._terrain),this.isChanged=!0):this._currentMode===o&&null!=this._cameraComp&&o.onMouseDown(this._terrain,this._cameraComp,e,r),cce.Engine.repaintInEditMode())}onMouseUp(){var e,r;null!=this._terrain&&(e=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT),r=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT),this._currentMode===e?e.onMouseUp():this._currentMode===r&&r.onMouseUp(),this.isChanged=!1,cce.Engine.repaintInEditMode())}onMouseMove(e,r){var t,i,o;null!=this._terrain&&null!=this._cameraComp&&null!=(o=this._cameraComp)&&(t=o.node.getPosition(),i=tempVec3_1,tempVec3_2.set(e,r,0),o.screenToWorld(tempVec3_2,i),cc_1.Vec3.subtract(tempVec3_3,i,t),cc_1.Vec3.normalize(tempVec3_3,tempVec3_3),null!=(e=this._terrain.rayCheck(t,tempVec3_3,.35,!0)))&&(r=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SCULPT),o=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.PAINT),this._currentMode===r?(r.onUpdateBrushPosition(this._terrain,e),this.isChanged=!0):this._currentMode===o&&(o.onUpdateBrushPosition(this._terrain,e),this.isChanged=!0),cce.Engine.repaintInEditMode())}onHoverOut(){var e=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SELECT);this._currentMode!==e&&(this.clearBrush(),cce.Engine.repaintInEditMode())}updateBlockDepthOffset(){var e=this._gizmo?.target?.node;e&&(terrain_brush_1.TerrainBrush.updateBrushDepthOffset(controller_utils_1.default.getCameraDistanceFactor(e.position,EditorCamera.camera.node)),e=this.getMode(terrain_editor_mode_1.eTerrainEditorMode.SELECT),this._currentMode===e)&&(e.forceUpdate(),cce.Engine.repaintInEditMode())}}exports.TerrainEditor=TerrainEditor;