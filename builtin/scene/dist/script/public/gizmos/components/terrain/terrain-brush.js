"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainImageBrush=exports.TerrainCircleBrush=exports.eTerrainCircleBrushType=exports.TerrainBrushData=exports.TerrainBrush=exports.TerrainEdModifierKeyState=exports.TerrainBrushType=void 0;const cc_1=require("cc");var TerrainBrushType,eTerrainCircleBrushType;!function(e){e[e.CIRCLE=0]="CIRCLE",e[e.IMAGE=1]="IMAGE",e[e._MAX=2]="_MAX"}(TerrainBrushType||(exports.TerrainBrushType=TerrainBrushType={}));class TerrainEdModifierKeyState{siftPressed=!1}exports.TerrainEdModifierKeyState=TerrainEdModifierKeyState;const brushDepthOffsetDefaultRatios=.001;let brushDepthOffset=.05;class TerrainBrush{static updateBrushDepthOffset(e){var t=brushDepthOffsetDefaultRatios+e/300*25e-5;brushDepthOffset=Math.max(.05,e*t)}static updateBrushDepthOffsetToMaterial(e){e&&e.setProperty("BrushDepthOffset",brushDepthOffset)}material=null;position=new cc_1.Vec3(0,0,0);radius=5;strength=1;_setHeight=0;_rotation=0;get rotation(){return this._rotation/180*Math.PI}getDelta(e,t){return 0}getBound(e,t){var r=this.position.x-this.radius,i=this.position.z-this.radius,a=this.position.x+this.radius,s=this.position.z+this.radius;e.x=r,e.y=i,t.x=a,t.y=s}update(e,t){this.position=t}}exports.TerrainBrush=TerrainBrush;class TerrainBrushData{bmin=[0,0];bmax=[0,0];width(){return this.bmax[0]-this.bmax[0]+1}height(){return this.bmax[1]-this.bmax[1]+1}}exports.TerrainBrushData=TerrainBrushData,function(e){e[e.Linear=0]="Linear",e[e.Smooth=1]="Smooth",e[e.Spherical=2]="Spherical",e[e.Tip=3]="Tip"}(eTerrainCircleBrushType||(exports.eTerrainCircleBrushType=eTerrainCircleBrushType={}));class TerrainCircleBrush extends TerrainBrush{type=eTerrainCircleBrushType.Linear;falloff=.5;constructor(){super(),this._updateMaterial()}setType(e){this.type!==e&&(this.type=e,this._updateMaterial())}getType(){return this.type}_updateMaterial(){var e=cc.EffectAsset.get("internal/editor/terrain-circle-brush");null!=e&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:e,defines:this._getTypeDefine()}))}_getTypeDefine(){switch(this.type){case eTerrainCircleBrushType.Linear:return{LINEAR:1};case eTerrainCircleBrushType.Smooth:return{SMOOTH:1};case eTerrainCircleBrushType.Spherical:return{SPHERICAL:1};case eTerrainCircleBrushType.Tip:return{TIP:1}}}static _calculateFalloff_Linear(e,t,r){return e<=t?1:t+r<e?0:Math.max(0,1-(e-t)/r)}static _calculateFalloff_Spherical(e,t,r){e=this._calculateFalloff_Linear(e,t,r);return e*e*(3-2*e)}static _calculateFalloff_Smooth(e,t,r){return e<=t?1:t+r<e?0:(e=(e-t)/r,Math.sqrt(1-e*e))}static _calculateFalloff_Tip(e,t,r){return e<=t?1:t+r<e?0:(t=(r+t-e)/r,1-Math.sqrt(1-t*t))}getDelta(e,t){var e=e-this.position.x,t=t-this.position.z,r=Math.sqrt(e*e+t*t),i=(1-this.falloff)*this.radius,a=this.falloff*this.radius;let s=0;switch(this.type){case eTerrainCircleBrushType.Linear:s=TerrainCircleBrush._calculateFalloff_Linear(r,i,a);break;case eTerrainCircleBrushType.Smooth:s=TerrainCircleBrush._calculateFalloff_Smooth(r,i,a);break;case eTerrainCircleBrushType.Spherical:s=TerrainCircleBrush._calculateFalloff_Spherical(r,i,a);break;case eTerrainCircleBrushType.Tip:s=TerrainCircleBrush._calculateFalloff_Tip(r,i,a)}return s*this.strength}update(r,e){if(super.update(r,e),null!=this.material){var t=(1-this.falloff)*this.radius,i=this.falloff*this.radius,a=new cc_1.Vec4,s=new cc_1.Vec4;a.x=r.node.getWorldPosition().x+e.x,a.y=r.node.getWorldPosition().y+e.y,a.z=r.node.getWorldPosition().z+e.z,s.x=t,s.y=i;for(let t=0;t<r.blockCount[0];++t)for(let e=0;e<r.blockCount[1];++e){var h=r.getBlock(t,e);h._getBrushMaterial()==this.material&&null!=h._getBrushPass()&&null!=(h=h.material)&&(h.setProperty("BrushPos",a),h.setProperty("BrushParams",s),TerrainBrush.updateBrushDepthOffsetToMaterial(h))}}}}exports.TerrainCircleBrush=TerrainCircleBrush;class TerrainImageBrush extends TerrainBrush{_image=null;_pixelData=null;constructor(){super();var e=cc.EffectAsset.get("internal/editor/terrain-image-brush");null!=e&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:e}))}set image(e){if(this._image!=e&&(this._image=e,(this._pixelData=null)!==this._image)){e=document.createElement("canvas");const i=e.getContext("2d");if(i){e.width=this._image.width,e.height=this._image.height;var e=this._image.mipmaps[0].data,t=e._src;if(t){const a=document.createElement("img");a.addEventListener("load",()=>{document.body.removeChild(a),i.drawImage(a,0,0,a.width,a.height);var t=i.getImageData(0,0,a.width,a.height);this._pixelData=new Array,this._pixelData.length=a.width*a.height;for(let e=0;e<this._pixelData.length;++e)this._pixelData[e]=t.data[4*e+0]/255}),a.addEventListener("error",()=>{document.body.removeChild(a)}),a.src="file://"+t,a.style.display="none",document.body.appendChild(a)}else{i.drawImage(e,0,0,this._image.width,this._image.height);var r=i.getImageData(0,0,this._image.width,this._image.height);this._pixelData=new Array,this._pixelData.length=this._image.width*this._image.height;for(let e=0;e<this._pixelData.length;++e)this._pixelData[e]=r.data[4*e+0]/255}}}}get image(){return this._image}static getColor(e,t,r,i,a){return i=(0,cc_1.clamp)(i,0,t-1),e[(a=(0,cc_1.clamp)(a,0,r-1))*t+i]}static sampleImage(e,t,r,i,a){i*=t-1,a*=r-1;var s=Math.floor(i),h=Math.floor(a),l=s+1,n=h+1,i=i-s,a=a-h,o=this.getColor(e,t,r,s,h),h=this.getColor(e,t,r,l,h),s=this.getColor(e,t,r,s,n),h=o+(h-o)*i;return h+(s+(this.getColor(e,t,r,l,n)-s)*i-h)*a}sample(e,t){return null===this._pixelData||null===this._image?1:TerrainImageBrush.sampleImage(this._pixelData,this._image.width,this._image.height,e,t)}getDelta(e,t){let r=this.position.x-e,i=this.position.z-t;0!=this.rotation&&(e=Math.sin(this.rotation),t=Math.cos(this.rotation),a=r*t+i*e,e=r*-e+i*t,r=a,i=e);var t=r/this.radius*.5+.5,a=i/this.radius*.5+.5;return t<0||1<t||a<0||1<a?0:this.sample(t,a)*this.strength}getBound(e,t){var r,i,a,s,h,l,n,o,u=-this.radius,c=-this.radius,p=this.radius,d=this.radius;0!=this.rotation&&(i=-(a=Math.sin(this.rotation)),a=a,s=r=Math.cos(this.rotation),(h=new cc_1.Vec2).x=u*r+c*i,h.y=u*a+c*s,(l=new cc_1.Vec2).x=p*r+c*i,l.y=p*a+c*s,(n=new cc_1.Vec2).x=p*r+c*i,n.y=p*a+c*s,(o=new cc_1.Vec2).x=p*r+d*i,o.y=p*a+d*s,e.x=h.x,e.y=h.y,e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),e.x=Math.min(e.x,l.x),e.y=Math.min(e.y,l.y),e.x=Math.min(e.x,o.x),e.y=Math.min(e.y,o.y),t.x=h.x,t.y=h.y,t.x=Math.max(t.x,n.x),t.y=Math.max(t.y,n.y),t.x=Math.max(t.x,l.x),t.y=Math.max(t.y,l.y),t.x=Math.max(t.x,o.x),t.y=Math.max(t.y,o.y)),e.x=u+this.position.x,e.y=c+this.position.z,t.x=p+this.position.x,t.y=d+this.position.z}update(r,e){if(super.update(r,e),null!==this.material){var t=this.radius,i=new cc_1.Vec4,a=new cc_1.Vec4;i.x=r.node.getWorldPosition().x+e.x,i.y=r.node.getWorldPosition().y+e.y,i.z=r.node.getWorldPosition().z+e.z,a.x=t,a.y=1,a.z=this.rotation;for(let t=0;t<r.blockCount[0];++t)for(let e=0;e<r.blockCount[1];++e){var s=r.getBlock(t,e);s._getBrushMaterial()==this.material&&null!=s._getBrushPass()&&null!=(s=s.material)&&(s.setProperty("BrushPos",i),s.setProperty("BrushParams",a),TerrainBrush.updateBrushDepthOffsetToMaterial(s),null!==this._image?s.setProperty("BrushImage",this._image):s.setProperty("BrushImage",cc_1.builtinResMgr.get("grey-texture")))}}}}exports.TerrainImageBrush=TerrainImageBrush;