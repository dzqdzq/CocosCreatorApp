"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TerrainImageBrush=exports.TerrainCircleBrush=exports.eTerrainCircleBrushType=exports.TerrainBrushData=exports.TerrainBrush=exports.TerrainEdModifierKeyState=exports.TerrainBrushType=void 0;const cc_1=require("cc");var TerrainBrushType,eTerrainCircleBrushType;!function(t){t[t.CIRCLE=0]="CIRCLE",t[t.IMAGE=1]="IMAGE",t[t._MAX=2]="_MAX"}(TerrainBrushType=exports.TerrainBrushType||(exports.TerrainBrushType={}));class TerrainEdModifierKeyState{constructor(){this.siftPressed=!1}}exports.TerrainEdModifierKeyState=TerrainEdModifierKeyState;const brushDepthOffsetDefaultRatios=.001;let brushDepthOffset=.05;class TerrainBrush{constructor(){this.material=null,this.position=new cc_1.Vec3(0,0,0),this.radius=5,this.strength=1,this._setHeight=0,this._rotation=0}static updateBrushDepthOffset(t){var e=brushDepthOffsetDefaultRatios+t/300*25e-5;brushDepthOffset=Math.max(.05,t*e)}static updateBrushDepthOffsetToMaterial(t){t&&t.setProperty("BrushDepthOffset",brushDepthOffset)}get rotation(){return this._rotation/180*Math.PI}getDelta(t,e){return 0}getBound(t,e){var r=this.position.x-this.radius,i=this.position.z-this.radius,a=this.position.x+this.radius,s=this.position.z+this.radius;t.x=r,t.y=i,e.x=a,e.y=s}update(t,e){this.position=e}}exports.TerrainBrush=TerrainBrush;class TerrainBrushData{constructor(){this.bmin=[0,0],this.bmax=[0,0]}width(){return this.bmax[0]-this.bmax[0]+1}height(){return this.bmax[1]-this.bmax[1]+1}}exports.TerrainBrushData=TerrainBrushData,function(t){t[t.Linear=0]="Linear",t[t.Smooth=1]="Smooth",t[t.Spherical=2]="Spherical",t[t.Tip=3]="Tip"}(eTerrainCircleBrushType=exports.eTerrainCircleBrushType||(exports.eTerrainCircleBrushType={}));class TerrainCircleBrush extends TerrainBrush{constructor(){super(),this.type=eTerrainCircleBrushType.Linear,this.falloff=.5,this._updateMaterial()}setType(t){this.type!==t&&(this.type=t,this._updateMaterial())}getType(){return this.type}_updateMaterial(){var t=cc.EffectAsset.get("internal/editor/terrain-circle-brush");null!=t&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:t,defines:this._getTypeDefine()}))}_getTypeDefine(){switch(this.type){case eTerrainCircleBrushType.Linear:return{LINEAR:1};case eTerrainCircleBrushType.Smooth:return{SMOOTH:1};case eTerrainCircleBrushType.Spherical:return{SPHERICAL:1};case eTerrainCircleBrushType.Tip:return{TIP:1}}}static _calculateFalloff_Linear(t,e,r){return t<=e?1:e+r<t?0:Math.max(0,1-(t-e)/r)}static _calculateFalloff_Spherical(t,e,r){t=this._calculateFalloff_Linear(t,e,r);return t*t*(3-2*t)}static _calculateFalloff_Smooth(t,e,r){return t<=e?1:e+r<t?0:(t=(t-e)/r,Math.sqrt(1-t*t))}static _calculateFalloff_Tip(t,e,r){return t<=e?1:e+r<t?0:(e=(r+e-t)/r,1-Math.sqrt(1-e*e))}getDelta(t,e){var t=t-this.position.x,e=e-this.position.z,r=Math.sqrt(t*t+e*e),i=(1-this.falloff)*this.radius,a=this.falloff*this.radius;let s=0;switch(this.type){case eTerrainCircleBrushType.Linear:s=TerrainCircleBrush._calculateFalloff_Linear(r,i,a);break;case eTerrainCircleBrushType.Smooth:s=TerrainCircleBrush._calculateFalloff_Smooth(r,i,a);break;case eTerrainCircleBrushType.Spherical:s=TerrainCircleBrush._calculateFalloff_Spherical(r,i,a);break;case eTerrainCircleBrushType.Tip:s=TerrainCircleBrush._calculateFalloff_Tip(r,i,a)}return s*this.strength}update(r,t){if(super.update(r,t),null!=this.material){var e=(1-this.falloff)*this.radius,i=this.falloff*this.radius,a=new cc_1.Vec4,s=new cc_1.Vec4;a.x=r.node.getWorldPosition().x+t.x,a.y=r.node.getWorldPosition().y+t.y,a.z=r.node.getWorldPosition().z+t.z,s.x=e,s.y=i;for(let e=0;e<r.blockCount[0];++e)for(let t=0;t<r.blockCount[1];++t){var h=r.getBlock(e,t);h._getBrushMaterial()==this.material&&null!=h._getBrushPass()&&null!=(h=h.material)&&(h.setProperty("BrushPos",a),h.setProperty("BrushParams",s),TerrainBrush.updateBrushDepthOffsetToMaterial(h))}}}}exports.TerrainCircleBrush=TerrainCircleBrush;class TerrainImageBrush extends TerrainBrush{constructor(){super(),this._image=null,this._pixelData=null;var t=cc.EffectAsset.get("internal/editor/terrain-image-brush");null!=t&&(this.material=new cc_1.Material,this.material.initialize({effectAsset:t}))}set image(t){if(this._image!=t&&(this._image=t,(this._pixelData=null)!==this._image)){t=document.createElement("canvas");const i=t.getContext("2d");if(i){t.width=this._image.width,t.height=this._image.height;var t=this._image.mipmaps[0].data,e=t._src;if(e){const a=document.createElement("img");a.addEventListener("load",()=>{document.body.removeChild(a),i.drawImage(a,0,0,a.width,a.height);var e=i.getImageData(0,0,a.width,a.height);this._pixelData=new Array,this._pixelData.length=a.width*a.height;for(let t=0;t<this._pixelData.length;++t)this._pixelData[t]=e.data[4*t+0]/255}),a.addEventListener("error",()=>{document.body.removeChild(a)}),a.src="file://"+e,a.style.display="none",document.body.appendChild(a)}else{i.drawImage(t,0,0,this._image.width,this._image.height);var r=i.getImageData(0,0,this._image.width,this._image.height);this._pixelData=new Array,this._pixelData.length=this._image.width*this._image.height;for(let t=0;t<this._pixelData.length;++t)this._pixelData[t]=r.data[4*t+0]/255}}}}get image(){return this._image}static getColor(t,e,r,i,a){return i=(0,cc_1.clamp)(i,0,e-1),t[(a=(0,cc_1.clamp)(a,0,r-1))*e+i]}static sampleImage(t,e,r,i,a){i*=e-1,a*=r-1;var s=Math.floor(i),h=Math.floor(a),n=s+1,l=h+1,i=i-s,a=a-h,o=this.getColor(t,e,r,s,h),h=this.getColor(t,e,r,n,h),s=this.getColor(t,e,r,s,l),h=o+(h-o)*i;return h+(s+(this.getColor(t,e,r,n,l)-s)*i-h)*a}sample(t,e){return null===this._pixelData||null===this._image?1:TerrainImageBrush.sampleImage(this._pixelData,this._image.width,this._image.height,t,e)}getDelta(t,e){let r=this.position.x-t,i=this.position.z-e;0!=this.rotation&&(t=Math.sin(this.rotation),e=Math.cos(this.rotation),a=r*e+i*t,t=r*-t+i*e,r=a,i=t);var e=r/this.radius*.5+.5,a=i/this.radius*.5+.5;return e<0||1<e||a<0||1<a?0:this.sample(e,a)*this.strength}getBound(t,e){var r,i,a,s,h,n,l,o,u=-this.radius,c=-this.radius,p=this.radius,d=this.radius;0!=this.rotation&&(i=-(a=Math.sin(this.rotation)),a=a,s=r=Math.cos(this.rotation),(h=new cc_1.Vec2).x=u*r+c*i,h.y=u*a+c*s,(n=new cc_1.Vec2).x=p*r+c*i,n.y=p*a+c*s,(l=new cc_1.Vec2).x=p*r+c*i,l.y=p*a+c*s,(o=new cc_1.Vec2).x=p*r+d*i,o.y=p*a+d*s,t.x=h.x,t.y=h.y,t.x=Math.min(t.x,l.x),t.y=Math.min(t.y,l.y),t.x=Math.min(t.x,n.x),t.y=Math.min(t.y,n.y),t.x=Math.min(t.x,o.x),t.y=Math.min(t.y,o.y),e.x=h.x,e.y=h.y,e.x=Math.max(e.x,l.x),e.y=Math.max(e.y,l.y),e.x=Math.max(e.x,n.x),e.y=Math.max(e.y,n.y),e.x=Math.max(e.x,o.x),e.y=Math.max(e.y,o.y)),t.x=u+this.position.x,t.y=c+this.position.z,e.x=p+this.position.x,e.y=d+this.position.z}update(r,t){if(super.update(r,t),null!==this.material){var e=this.radius,i=new cc_1.Vec4,a=new cc_1.Vec4;i.x=r.node.getWorldPosition().x+t.x,i.y=r.node.getWorldPosition().y+t.y,i.z=r.node.getWorldPosition().z+t.z,a.x=e,a.y=1,a.z=this.rotation;for(let e=0;e<r.blockCount[0];++e)for(let t=0;t<r.blockCount[1];++t){var s=r.getBlock(e,t);s._getBrushMaterial()==this.material&&null!=s._getBrushPass()&&null!=(s=s.material)&&(s.setProperty("BrushPos",i),s.setProperty("BrushParams",a),TerrainBrush.updateBrushDepthOffsetToMaterial(s),null!==this._image?s.setProperty("BrushImage",this._image):s.setProperty("BrushImage",cc_1.builtinResMgr.get("grey-texture")))}}}}exports.TerrainImageBrush=TerrainImageBrush;