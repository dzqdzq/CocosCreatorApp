"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const{join:join}=require("path"),vDependence=require("v-dependence"),host_1=__importDefault(require("../public/ipc/host")),ipc_1=__importDefault(require("./ipc")),listener_1=require("./listener"),tasks_1=__importDefault(require("./tasks")),float_window_1=__importDefault(require("./plugin/float-window")),toolbar_1=__importDefault(require("./plugin/toolbar")),infobar_1=__importDefault(require("./plugin/infobar"));class View extends window.HTMLElement{constructor(){super(),this.dirty=!1,this.managerReady=!1,this.$scene=document.createElement("webview"),this.depend=vDependence.create(),this.$floatWindow=float_window_1.default.get(),this.ipc=new host_1.default(this.$scene),tasks_1.default.$scene=this,toolbar_1.default.init(this.previousElementSibling),infobar_1.default.init(this.nextElementSibling),this.setAttribute("tabindex","-1"),this.$scene.addEventListener("destroyed",()=>{this.depend.reset(tasks_1.default.webviewReady[0])}),this.depend.add(...tasks_1.default.editorInit),this.depend.add(...tasks_1.default.assetDbReady),this.depend.add(...tasks_1.default.queryEngineInfo),this.depend.add(...tasks_1.default.webviewReady),this.depend.add(...tasks_1.default.webviewEngineInit),this.depend.add(...tasks_1.default.webviewManagerInit),this.depend.add(...tasks_1.default.packerDriverReady),this.depend.add(...tasks_1.default.autoOpenScene),this.appendChild(this.$floatWindow)}async init(){ipc_1.default(this);const e=join(__dirname,`../${Editor.Project.type}/preload.js`);this.$scene.setAttribute("webPreferences","webgl=1,nativeWindowOpen=1,contextIsolation=0,backgroundThrottling=0"),this.$scene.setAttribute("contextIsolation","false"),this.$scene.setAttribute("nodeintegration","true"),this.$scene.setAttribute("nodeintegrationinsubframes","true"),this.$scene.setAttribute("enableremotemodule","true"),this.$scene.setAttribute("disablewebsecurity","true"),this.$scene.setAttribute("allowpopups","true"),this.$scene.setAttribute("style","pointer-events: none;"),this.$scene.setAttribute("src",`packages://scene/static/template/${Editor.Project.type}-webview.html?url=${encodeURI(e)}`),this.appendChild(this.$scene);let t=!1,i=null;this.$scene&&this.$scene.addEventListener("dom-ready",()=>{t=!0,i&&i()}),Editor.Startup.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0]),listener_1.init(this),t||await new Promise(e=>{i=e})}async callSceneMethod(e,t=[],i=!1,a=!0){return i||tasks_1.default.updateDump(),await this.ipc.send("call-method",{module:"SceneFacadeManager",handler:e,params:t,queue:!i,timeout:a})}async executeComponentMethod(e){return this.dirty=!0,await this.ipc.send("call-method",{module:"Scene",handler:"executeComponentMethod",params:[e.uuid,e.index,...e.methodNames||[]],queue:!0,timeout:!0})}attachFloatWindow(e,t){float_window_1.default.register(e,t)}detachFloatWindow(e){float_window_1.default.unregister(e)}attachToolbar(e,t){toolbar_1.default.register(e,t)}detachToolbar(e){toolbar_1.default.unregister(e)}attachInfobar(e,t){infobar_1.default.register(e,t)}detachInfobar(e){infobar_1.default.unregister(e)}}exports.default=View;