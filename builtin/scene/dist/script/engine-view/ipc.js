"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const{basename:basename}=require("path"),float_window_1=__importDefault(require("./plugin/float-window")),toolbar_1=__importDefault(require("./plugin/toolbar")),infobar_1=__importDefault(require("./plugin/infobar")),listener_1=require("./listener"),path_1=require("path"),tasks_1=__importDefault(require("./tasks")),escToExitPointerLock=e=>{"Escape"===e.code&&document.exitPointerLock()},messages={ready(){this.depend.execute("webview-ready")},close(){this.depend.reset("webview-ready")},"immediately-dump"(e){tasks_1.default.updateDump(e)},"query-engine"(){return{path:this.info.path,utils:this.info.utils,compile:this.info.compile}},"query-scene":async()=>await Editor.Profile.getTemp("scene","current-scene")||"",async"set-scene"(e){Editor.Profile.setTemp("scene","current-scene",e||"")},async"clear-scene"(){Editor.Profile.setTemp("scene","current-scene","")},async"change-title"(e,t){let s="Cocos Creator - "+basename(Editor.Project.path)+" - ";if(e){const t=await Editor.Message.request("asset-db","query-asset-info",e);s+=t?t.source:"Untitled"}else s+="Untitled";t&&(s+="*"),Editor.Message.broadcast("editor-title-change",s)},"query-scripts":async()=>await Editor.Message.request("asset-db","query-assets",{type:"scripts"}),"query-effects":async()=>(await Editor.Message.request("asset-db","query-assets")).map(e=>{if("effect"===e.importer)return e.uuid}).filter(Boolean),"query-asset-info":async e=>Editor.Message.request("asset-db","query-asset-info",e),"query-asset-meta":async e=>Editor.Message.request("asset-db","query-asset-meta",e),"query-uuid":async e=>Editor.Message.request("asset-db","query-uuid",e),"query-assets":async e=>Editor.Message.request("asset-db","query-assets",e),"scene:ready"(){listener_1.start()},"scene:close"(){listener_1.stop(),float_window_1.default.unselect()},"select-nodes"(e){e.forEach(e=>{Editor.Selection.select("node",e)})},"unselect-nodes"(e){e.forEach(e=>{Editor.Selection.unselect("node",e)})},"lock-pointer"(e){e?(this.requestPointerLock(),document.addEventListener("keydown",escToExitPointerLock)):(document.exitPointerLock(),document.removeEventListener("keydown",escToExitPointerLock))},"change-pointer"(e){document.body.style.cursor=e},async"save-asset"(e,t){const s=await Editor.Message.request("asset-db","save-asset",e,t);return s&&Editor.Message.send("assets","twinkle",s.uuid,"shrink"),s},async"create-asset"(e,t,s){if(!e&&"scene"===s){const t=await Editor.Message.request("asset-db","generate-available-url","db://assets/scene.scene"),s=await Editor.Message.request("asset-db","query-path",t)||"",a=await Editor.Dialog.save({title:Editor.I18n.t("scene.save"),path:s,filters:[{name:"Scene File",extensions:["scene"]}]});if(!a.filePath)return;const i=path_1.join(Editor.Project.path,"assets");if(!Editor.Utils.Path.contains(i,a.filePath)||!a.filePath.endsWith(".scene"))return void await Editor.Dialog.warn(Editor.I18n.t("scene.messages.save_fail"),{title:Editor.I18n.t("scene.messages.warning")});const r=await Editor.Message.request("asset-db","query-url",a.filePath);if(!r)return;e=r}const a=await Editor.Message.request("asset-db","create-asset",e,t,{overwrite:!0});if(a)return Editor.Message.send("assets","twinkle",a.uuid,"shrink"),a.uuid},"save-asset-meta":async(e,t)=>await Editor.Message.request("asset-db","save-asset-meta",e,t),"dirty-dialog":async e=>(await Editor.Dialog.warn((e||"Scene")+Editor.I18n.t("scene.messages.scenario_modified"),{title:Editor.I18n.t("scene.messages.warning"),detail:Editor.I18n.t("scene.messages.want_to_save"),default:0,cancel:2,buttons:[Editor.I18n.t("scene.messages.save"),Editor.I18n.t("scene.messages.dont_save"),Editor.I18n.t("scene.messages.cancel")]})).response,"generate-available-url":e=>Editor.Message.request("asset-db","generate-available-url",e),async"record-camera"(e,t){let s=await Editor.Profile.getConfig("scene","camera-infos")||{},a=await Editor.Profile.getConfig("scene","camera-uuids")||[];"object"!=typeof s&&(s={}),Array.isArray(a)&&(a=[]);const i=t,r=a.indexOf(e);-1!==r?(delete s[a[r]],a.splice(r,1),a.push(e)):(a.push(e),a.length>50&&(delete s[a[0]],a.splice(0,1))),s[e]=i,Editor.Profile.setConfig("scene","camera-infos",s),Editor.Profile.setConfig("scene","camera-uuids",a)},async"record-gizmos"(e){const t=await Editor.Profile.getConfig("scene","gizmos-infos")||{};Object.assign(t,e),Editor.Profile.setConfig("scene","gizmos-infos",t)},"update-plugin"(e){const t={},s=[];e.nodes.forEach(e=>{e.components.forEach(e=>{s.includes(e.type)||s.push(e.type),(t[e.type]=t[e.type]||[]).push(e)})}),e.nodes.length>0?float_window_1.default.select(e,s,t):float_window_1.default.unselect(e,s,t),toolbar_1.default.update(e,s,t),infobar_1.default.update(e,s,t)},"send-plugin"(e,...t){"float-window"===e&&float_window_1.default.send(...t)},"force-update"(e,t){const s={},a=[];switch(t.nodes.forEach(e=>{e.components.forEach(e=>{if(a.includes(e.type))return;a.push(e.type),(s[e.type]=s[e.type]||[]).push(e)})}),e){case"toolbar":toolbar_1.default.update(t,a,s);break;case"float-window":float_window_1.default.update(t,a,s)}}};function default_1(e){Object.keys(messages).forEach(t=>{e.ipc.on(t,messages[t].bind(e))})}exports.default=default_1;