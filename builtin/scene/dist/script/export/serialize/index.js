"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.serialize=exports.serializeSafe=void 0;const cc_1=require("cc"),DELIMETER=cc.Class.Attr.DELIMETER,debugInfo=[],nodeExcludeProps=["_parent","_children","_prefab","_components"],checkedObjectSet=new Set;function checkComponents(e,t=""){const c=e.components;if(Array.isArray(c))for(let n=c.length-1;n>=0;n--){const s=c[n];if(s){if(s.node!==e&&(s.node=e,debugInfo.push()),checkedObjectSet.has(s))return;checkedObjectSet.add(s),checkSerializableProperties(s,`${t}:${s.name}`)}else c.splice(n,1)}else debugInfo.push(`${e.getPathInHierarchy()}'s components is not array`)}const baseTypeMap=new Map;function checkBaseType(e,t,c=""){if(cc.js.isChildClassOf(e.constructor,cc.ValueType)){const n=getDefaultMap(e.constructor);for(const s of t)typeof e[s]!=typeof n[s]&&debugInfo.push(`${c}|${s}'s value:${e[s]} is illegal,attr:${n[s]}`);return!0}return!1}function getDefaultMap(e){let t=baseTypeMap.get(e);if(!t){t={},baseTypeMap.set(e,t);const c=e.__attrs__;e.__values__.forEach(e=>{const n=`${e}${DELIMETER}default`;t[e]=c[n]})}return t}function checkSerializableProperties(e,t="",c){const n=e.constructor,s=null!==c&&void 0!==c?c:n.__values__,r=getDefaultMap(n);for(const c of s){const n=e[c],s=typeof n;if(n&&n.constructor&&n.constructor.__values__){if(checkedObjectSet.has(n))return;checkedObjectSet.add(n),checkSerializableProperties(n,`${t}.${c}`)}else if("object"===s)Object.keys(n).forEach(e=>{const c=n[e],s=c?c.constructor:void 0;if(s&&s.__values__){if(checkedObjectSet.has(c))return;checkedObjectSet.add(c),checkSerializableProperties(c,`${t}.${e}`)}});else{s!==typeof r[c]&&(debugInfo.push(`${t}.${c}'s value:${e[c]} is illegal,attr:${r[c]}`),e[c]=r[c])}}}function checkPrefabInfo(e){const t=e._prefab;if(t){const e={},c=t.nestedPrefabInstanceRoots;if(c)for(let t=c.length-1;t>=0;t--){const n=c[t],s=n._prefab;(null===s||void 0===s?void 0:s.instance)&&(e[s.instance.fileId]&&(debugInfo.push(`${n.getPathInHierarchy()} prefabInstanceFileId is not unique`),s.instance.fileId=EditorExtends.UuidUtils.uuid()),e[s.instance.fileId]=!0)}}}function checkNode(e,t,c=""){var n;const s=e.children;if(!Array.isArray(s))return void debugInfo.push(`${c}/${e.name} children is not an array`);const r=`${c}/${e.name}`;if(!checkedObjectSet.has(e)){checkedObjectSet.add(e);for(let c=s.length-1;c>=0;c--){const o=s[c];!o||o.objFlags&cc_1.CCObject.Flags.HideInHierarchy?null!==o&&void 0!==o||s.splice(c,1):(o.parent!==e&&(debugInfo.push(`${r}/${o.name} parent is illegal ${null===(n=o.parent)||void 0===n?void 0:n.name}`),o.parent=e),checkNode(o,t,r))}}}function checkScene(e){let t;if(e instanceof cc_1.SceneAsset?t=e.scene:e instanceof cc_1.Prefab&&(t=e.data),t){checkNode(t,t.constructor.__values__.slice().filter(e=>!nodeExcludeProps.includes(e))),checkPrefabInfo(t)}}function serializeSafe(e,t){return cce.Utils.serialize(e,t)}function serialize(e,t){return cce.Utils.serialize(e,t)}exports.serializeSafe=serializeSafe,exports.serialize=serialize;