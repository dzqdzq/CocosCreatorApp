"use strict";"use strcit";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var c=Object.getOwnPropertyDescriptor(t,r);c&&("get"in c?t.__esModule:!c.writable&&!c.configurable)||(c={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,c)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.decodeTargetOverrides=exports.updatePropertyFromNull=exports.resetProperty=exports.decodePatch=exports.decodeNode=exports.decodeScene=exports.decodeMountedRoot=void 0;const utils_1=require("./utils"),lodash_1=__importDefault(require("lodash")),{get:get,set:set}=lodash_1.default,dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function decodeChildren(e,t){const r=e.map(e=>e.value.uuid),o=t.children.map(e=>e.uuid);o.forEach(e=>{if(!r.includes(e)){const t=cce.Node.query(e);if(!t||t.objFlags&cc.Object.Flags.HideInHierarchy)return;t.parent=null}}),r.forEach((e,r)=>{const c=cce.Node.query(e);c&&(c.walk(e=>{e._objFlags&=cc.Object.Flags.PersistentMask,e._objFlags&=~cc.Object.Flags.Destroyed}),o.includes(e)||(c.parent=t),c.setSiblingIndex(r))})}function decodeMountedRoot(e,t){if(!e)return;const r=cce.Node.query(t);r?(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=r):e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0)}async function decodeComponents(e,t,r){if(!e)return;const o={},c=e.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(o[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean),a=t.components.map(e=>{if(r){const t=(0,utils_1.getTypeName)(e.constructor);if(r.includes(t))return""}if(e.__prefab&&e.__prefab.fileId){const t=o[e.__prefab.fileId];if(t){const r=c.indexOf(t.value.uuid.value);-1!==r&&(c.splice(r,1,e.uuid),t.value.uuid.value=e.uuid)}}return e.uuid}).filter(Boolean);let n=a.length**2,s=a.length-1;do{const e=a[s];e&&!c.includes(e)&&cce.Node.removeComponent(e)?a.splice(s,1):s--,n--}while(0!==a.length&&n);cc.Object._deferredDestroy();const i=t.components.slice();t._components.length=0;for(let r=0;r<e.length;r++){const o=e[r];if(!o.value||!o.value.uuid)continue;let c=i[r];const a=o.value.uuid.value;let n=cce.Component.query(a);n||(n=cce.Component.queryRecycle(a)),n&&(c!==n&&(n.node!==t&&l(n),(n.objFlags&cc.Object.Flags.Destroying||n.objFlags&cc.Object.Flags.Destroyed)&&(n.objFlags&=cc.Object.Flags.PersistentMask,n.objFlags&=~cc.Object.Flags.Destroyed),c=n),cce.Node.addComponentAt(t,c,r));const s=[];if(isPreviewProcess&&"cc.Animation"===o.type){const e=c;e.clips.map(t=>{var r;return e.getState(null!==(r=null===t||void 0===t?void 0:t.name)&&void 0!==r?r:"")}).filter(e=>null===e||void 0===e?void 0:e.isPlaying).forEach(e=>{s.push(e.name)})}for(const e in o.value)await decodePatch(e,o.value[e],c);if(s.length>0){const e=c;s.forEach(t=>{e.play(t)})}decodeMountedRoot(c,o.mountedRoot),c&&c.onRestore&&c.onRestore()}function l(e){if(e.objFlags&cc.Object.Flags.Destroying||e.objFlags&cc.Object.Flags.Destroyed)return;e.node._getDependComponent(e).forEach(e=>{l(e)}),cce.Node.removeComponent(e.uuid),cc.Object._deferredDestroy()}}async function decodePrefab(e,t){if(!e&&!t._prefab)return;if(!e&&t._prefab)return void(t._prefab=null);const r=new PrefabInfo,o=cce.Node.query(e.rootUuid);if(r.root=o||t,e.uuid)try{r.asset=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(e.uuid)}catch(t){console.error(t),r.asset=new cc_1.Prefab,r.asset.initDefault(e.uuid)}r.fileId=e.fileId||t.uuid,e.instance?await decodePatch("instance",e.instance,r):r.instance=void 0,e.targetOverrides?r.targetOverrides=decodeTargetOverrides(e.targetOverrides):r.targetOverrides=void 0,t._prefab=r}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const r of Object.keys(e._globals))await decodePatch(`_globals.${r}`,e._globals[r],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,r){if(!e)return null;if(!(t=t||new cc.Node))return null;await decodePrefab(e.__prefab__,t),t.name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.mobility=e.mobility.value,t.setPosition(e.position.value);const o=new cc_1.Quat,c=e.rotation.value;return cc_1.Quat.fromEuler(o,c.x,c.y,c.z),t.setRotation(o),t.setScale(e.scale.value),decodeMountedRoot(t,e.mountedRoot),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,r),t}async function _decodeByType(e,t,r,o,c){const a=dump_defines_1.DumpDefines[e];return!!a&&(await a.decode(t,r,o,c),!0)}async function decodePatch(e,t,r){var o;const c=(0,utils_1.parsingPath)(e,r),a=(0,utils_1.parsingPath)(c.search,r),n=[cc_1.editorExtrasTag,"__scriptAsset","node","uuid"],s=c.search?get(r,c.search):r;if(!s)return;if(s instanceof cc_1.Component&&n.includes(c.key))return;if("[object Object]"===Object.prototype.toString.call(s)){let e=Object.getOwnPropertyDescriptor(s,c.key);if(window.isSceneNative&&void 0===e&&(e=Object.getOwnPropertyDescriptor(s.__proto__,c.key)),void 0===e){if(!(e=cc.Class.attr(s,c.key))||!e.hasSetter)return void(c.key in s&&(!e||!0!==e.hasGetter)&&(s[c.key]=t.value))}else if(!e.writable&&!e.set)return}const i=a.search?get(r,a.search):r;if(!("value"in t)||"Unknown"===t.type){let e=cc.Class.attr(s,c.key);if(Array.isArray(i)&&"_components"!==a.search){const t=(0,utils_1.parsingPath)(a.search,r),o=t.search?get(r,t.search):r;e=cc.Class.attr(o,t.key),e=cc.Class.attr(e.ctor,c.key)}const t=getDefaultAttrData(e);return s[c.key]=t,t}const l=cc.js.getClassByName(t.type),u=l?(0,utils_1.getTypeInheritanceChain)(l):[];if(t.isArray)if(Array.isArray(t.value)){const e=[],r=cc.Class.attr(s.constructor,c.key);for(let o=0;o<t.value.length;o++)e[o]=(0,utils_1.ccClassAttrPropertyDefaultValue)(r),await decodePatch(`${o}`,t.value[o],e);s[c.key]=e}else s[c.key]=[];else{const o={};if(o.ccType=l,await _decodeByType(t.type,s,c,t,o));else if("cc.Scene"===t.type)_decodeByType("cc.Node",s,c,t,o);else if(ArrayBuffer.isView(t.value))_decodeByType("TypedArray",s,c,t,o);else if(u.includes("cc.Node")||"cc.Node"===t.type)_decodeByType("cc.Node",s,c,t,o);else if(u.includes("cc.Asset")||"cc.Asset"===t.type)await _decodeByType("cc.Asset",s,c,t,o);else if(u.includes("cc.Component")||"cc.Component"===t.type)_decodeByType("cc.Component",s,c,t,o);else if(u.includes("cc.ValueType"))_decodeByType("cc.ValueType",s,c,t,o);else if("length"===c.key&&"Array"===t.type){for(;s.length>t.value;)s.pop();const e=get(r,a.search),o=cc.Class.attr(e,a.key);for(let e=s.length;e<t.value;e++)s[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(o);set(r,c.search,s)}else if(l&&!s[c.key]&&null!==t.value){s[c.key]=new l;for(let o=0;o<l.__props__.length;o++){const c=l.__props__[o],a=t.value[c];a&&await decodePatch(`${e}.${c}`,a,r)}}else if(null===t.value)s[c.key]=t.value;else if("object"==typeof t.value)for(const e in t.value)void 0!==t.value[e]&&await decodePatch(e,t.value[e],s[c.key]);else s[c.key]=t.value}if(setNodeSpecialProperty(r,c),c.search&&set(r,c.search,s),a&&a.search){const e=get(r,a.search);e instanceof Object&&(null===(o=cc.Class.attr(e,c.key))||void 0===o?void 0:o.hasSetter)&&(e[a.key]=e[a.key])}}exports.decodeMountedRoot=decodeMountedRoot,exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch;const nodeSpecialPropertyDefaultValue={_lpos:()=>new cc_1.Vec3(0,0,0),eulerAngles:()=>new cc_1.Vec3(0,0,0),_lscale:()=>new cc_1.Vec3(1,1,1),mobility:()=>cc_1.MobilityMode.Static};function setNodeSpecialProperty(e,t){if(e instanceof cc.Node)switch(t.key){case"_lpos":e.setPosition(e._lpos);break;case"eulerAngles":e.setRotationFromEuler(e.eulerAngles.x,e.eulerAngles.y,e.eulerAngles.z);break;case"_lscale":e.setScale(e._lscale)}}function getDefaultAttrData(e){let t=(0,utils_1.getDefault)(e);return"object"==typeof t&&t&&(t="function"==typeof t.clone?t.clone():Array.isArray(t)?[]:{}),t}function resetProperty(e,t){const r=(0,utils_1.parsingPath)(t,e),o=r.search?get(e,r.search):e;if(o)if(r.key in nodeSpecialPropertyDefaultValue)o[r.key]=nodeSpecialPropertyDefaultValue[r.key](),setNodeSpecialProperty(o,r);else{const e=cc.Class.attr(o.constructor,r.key);o[r.key]=getDefaultAttrData(e)}}function updatePropertyFromNull(e,t){const r=(0,utils_1.parsingPath)(t,e),o=r.search?get(e,r.search):e;if(!o)return;const c=cc.Class.attr(o.constructor,r.key);o[r.key]=getDefaultAttrData(c),null!==o[r.key]&&void 0!==o[r.key]||!c.ctor||(o[r.key]=new c.ctor)}function decodeTargetOverrides(e){const t=[];return e.forEach(e=>{const r=new TargetOverrideInfo;if(r.source=cce.Node.query(e.source),e.sourceInfo){const t=new TargetInfo;t.localID=e.sourceInfo,r.sourceInfo=t}if(r.propertyPath=e.propertyPath,r.target=cce.Node.query(e.target),e.targetInfo){const t=new TargetInfo;t.localID=e.targetInfo,r.targetInfo=t}t.push(r)}),t}exports.resetProperty=resetProperty,exports.updatePropertyFromNull=updatePropertyFromNull,exports.decodeTargetOverrides=decodeTargetOverrides,exports.default=__importStar(require("./decode"));