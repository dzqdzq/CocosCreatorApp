"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeMountedRoot=decodeMountedRoot,exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch,exports.resetProperty=resetProperty,exports.updatePropertyFromNull=updatePropertyFromNull,exports.decodeTargetOverrides=decodeTargetOverrides;const utils_1=require("./utils"),lodash_1=__importDefault(require("lodash")),{get,set}=lodash_1.default,dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function decodeChildren(e,a){const t=e.map(e=>e.value.uuid),c=a.children.map(e=>e.uuid);c.forEach(e=>{t.includes(e)||!(e=cce.Node.query(e))||e.objFlags&cc.Object.Flags.HideInHierarchy||(e.parent=null)}),t.forEach((e,t)=>{var r=cce.Node.query(e);r&&(r.walk(e=>{e._objFlags&=cc.Object.Flags.PersistentMask,e._objFlags&=~cc.Object.Flags.Destroyed}),c.includes(e)||(r.parent=a),r.setSiblingIndex(t))})}function decodeMountedRoot(e,t){e&&((t=cce.Node.query(t))?(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=t):e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0))}async function decodeComponents(a,c,o){if(a){const d={},u=a.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(d[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean);var r=c.components.map(e=>{if(o){var t=(0,utils_1.getTypeName)(e.constructor);if(o.includes(t))return""}var r;return e.__prefab&&e.__prefab.fileId&&(t=d[e.__prefab.fileId])&&-1!==(r=u.indexOf(t.value.uuid.value))&&(u.splice(r,1,e.uuid),t.value.uuid.value=e.uuid),e.uuid}).filter(Boolean);let e=r.length**2,t=r.length-1;do{var s=r[t];s&&!u.includes(s)&&cce.Node.removeComponent(s)?r.splice(t,1):t--,e--}while(0!==r.length&&e);cc.Object._deferredDestroy();var l=c.components.slice();for(let r=c._components.length=0;r<a.length;r++){var n=a[r];if(n.value&&n.value.uuid){let e=l[r];var i=n.value.uuid.value;let t=cce.Component.query(i);(t=t||cce.Component.queryRecycle(i))&&(e!==t&&(t.node!==c&&!function t(e){if(e.objFlags&cc.Object.Flags.Destroying||e.objFlags&cc.Object.Flags.Destroyed)return;const r=e.node._getDependComponent(e);r.forEach(e=>{t(e)});cce.Node.removeComponent(e.uuid);cc.Object._deferredDestroy()}(t),(t.objFlags&cc.Object.Flags.Destroying||t.objFlags&cc.Object.Flags.Destroyed)&&(t.objFlags&=cc.Object.Flags.PersistentMask,t.objFlags&=~cc.Object.Flags.Destroyed),e=t),cce.Node.addComponentAt(c,e,r));const f=[];if(isPreviewProcess&&"cc.Animation"===n.type){const p=e;p.clips.map(e=>p.getState(e?.name??"")).filter(e=>e?.isPlaying).forEach(e=>{f.push(e.name)})}for(const y in n.value)await decodePatch(y,n.value[y],e);if(0<f.length){const _=e;f.forEach(e=>{_.play(e)})}decodeMountedRoot(e,n.mountedRoot),e&&e.onRestore&&e.onRestore()}}}}async function decodePrefab(t,e){if(t||e._prefab)if(!t&&e._prefab)e._prefab=null;else{var r=new PrefabInfo,a=cce.Node.query(t.rootUuid);if(r.root=a||e,t.uuid)try{r.asset=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(t.uuid)}catch(e){console.error(e),r.asset=new cc_1.Prefab,r.asset.initDefault(t.uuid)}r.fileId=t.fileId||e.uuid,t.instance?await decodePatch("instance",t.instance,r):r.instance=void 0,t.targetOverrides?r.targetOverrides=decodeTargetOverrides(t.targetOverrides):r.targetOverrides=void 0,e._prefab=r}}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const r of Object.keys(e._globals))await decodePatch("_globals."+r,e._globals[r],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,r){if(!e)return null;if(!(t=t||new cc.Node))return null;await decodePrefab(e.__prefab__,t),t.name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.mobility=e.mobility.value,t.setPosition(e.position.value);var a=new cc_1.Quat,c=e.rotation.value;return cc_1.Quat.fromEuler(a,c.x,c.y,c.z),t.setRotation(a),t.setScale(e.scale.value),decodeMountedRoot(t,e.mountedRoot),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,r),t}async function _decodeByType(e,t,r,a,c){e=dump_defines_1.DumpDefines[e];return!!e&&(await e.decode(t,r,a,c),!0)}async function decodePatch(t,r,a){var c=(0,utils_1.parsingPath)(t,a),o=(0,utils_1.parsingPath)(c.search,a),s=[cc_1.editorExtrasTag,"__scriptAsset","node","uuid"];const l=c.search?get(a,c.search):a;if(l&&!(l instanceof cc_1.Component&&s.includes(c.key))){if("[object Object]"===Object.prototype.toString.call(l)){let e=Object.getOwnPropertyDescriptor(l,c.key);if(void 0===(e=window.isSceneNative&&void 0===e?Object.getOwnPropertyDescriptor(l.__proto__,c.key):e)){if(!(e=cc.Class.attr(l,c.key))||!e.hasSetter)return void(c.key in l&&(!e||!0!==e.hasGetter)&&(l[c.key]=r.value))}else if(!e.writable&&!e.set)return}const h=o.search?get(a,o.search):a;if(!("value"in r)||"Unknown"===r.type){let e=cc.Class.attr(l,c.key);Array.isArray(h)&&"_components"!==o.search&&(n=(s=(0,utils_1.parsingPath)(o.search,a)).search?get(a,s.search):a,e=cc.Class.attr(n,s.key),e=cc.Class.attr(e.ctor,c.key));var n=getDefaultAttrData(e);return l[c.key]=n}var i=cc.js.getClassByName(r.type),s=i?(0,utils_1.getTypeInheritanceChain)(i):[],n="cc.Node",e="cc.Component",d="cc.Asset",u="cc.ValueType";if(r.isArray)if(Array.isArray(r.value)){var f=[],p=cc.Class.attr(l.constructor,c.key);for(let e=0;e<r.value.length;e++)f[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(p),await decodePatch(""+e,r.value[e],f);l[c.key]=f}else l[c.key]=[];else{var y={};if(y.ccType=i,c.key in nodeSpecialPropertyDefaultValue)setNodeSpecialProperty(a,c.key,r.value);else if(!await _decodeByType(r.type,l,c,r,y))if("cc.Scene"===r.type)_decodeByType(n,l,c,r,y);else if(ArrayBuffer.isView(r.value))_decodeByType("TypedArray",l,c,r,y);else if(s.includes(n)||n===r.type)_decodeByType(n,l,c,r,y);else if(s.includes(d)||d===r.type)await _decodeByType(d,l,c,r,y);else if(s.includes(e)||e===r.type)_decodeByType(e,l,c,r,y);else if(s.includes(u))_decodeByType(u,l,c,r,y);else if("length"===c.key&&"Array"===r.type){for(;l.length>r.value;)l.pop();const h=get(a,o.search);var _=cc.Class.attr(h,o.key);for(let e=l.length;e<r.value;e++)l[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(_);set(a,c.search,l)}else if(i&&!l[c.key]&&null!==r.value){l[c.key]=new i;for(let e=0;e<i.__props__.length;e++){var v=i.__props__[e],g=r.value[v];g&&await decodePatch(t+"."+v,g,a)}}else if(null===r.value)l[c.key]=r.value;else if("object"==typeof r.value)for(const b in r.value)void 0!==r.value[b]&&await decodePatch(b,r.value[b],l[c.key]);else l[c.key]=r.value}if(c.search&&set(a,c.search,l),o&&o.search){const l=get(a,o.search);l instanceof Object&&cc.Class.attr(l,c.key)?.hasSetter&&(l[o.key]=l[o.key])}}}const nodeSpecialPropertyDefaultValue={_lpos(){return new cc_1.Vec3(0,0,0)},eulerAngles(){return new cc_1.Vec3(0,0,0)},_lscale(){return new cc_1.Vec3(1,1,1)},mobility(){return cc_1.MobilityMode.Static}};function setNodeSpecialProperty(e,t,r){if(e instanceof cc.Node)switch(t){case"_lpos":e.position=r;break;case"eulerAngles":e.eulerAngles=r;break;case"_lscale":e.scale=r;break;case"mobility":e.mobility=r}}function getDefaultAttrData(e){let t=(0,utils_1.getDefault)(e);return"object"==typeof t&&t&&("function"==typeof t.clone?t=t.clone():Array.isArray(t)&&(t=[])),t}function resetProperty(e,t){var r,t=(0,utils_1.parsingPath)(t,e),e=t.search?get(e,t.search):e;e&&(t.key in nodeSpecialPropertyDefaultValue?(r=nodeSpecialPropertyDefaultValue[t.key](),setNodeSpecialProperty(e,t.key,r)):(r=cc.Class.attr(e.constructor,t.key),e[t.key]=getDefaultAttrData(r)))}function updatePropertyFromNull(e,t){var r,t=(0,utils_1.parsingPath)(t,e),e=t.search?get(e,t.search):e;e&&(r=cc.Class.attr(e.constructor,t.key),e[t.key]=getDefaultAttrData(r),null!==e[t.key]&&void 0!==e[t.key]||!r.ctor||(e[t.key]=new r.ctor))}function decodeTargetOverrides(e){const a=[];return e.forEach(e=>{var t,r=new TargetOverrideInfo;r.source=cce.Node.query(e.source),e.sourceInfo&&((t=new TargetInfo).localID=e.sourceInfo,r.sourceInfo=t),r.propertyPath=e.propertyPath,r.target=cce.Node.query(e.target),e.targetInfo&&((t=new TargetInfo).localID=e.targetInfo,r.targetInfo=t),a.push(r)}),a}exports.default={decodeScene:decodeScene,decodeNode:decodeNode,decodePatch:decodePatch,resetProperty:resetProperty,updatePropertyFromNull:updatePropertyFromNull,decodeMountedRoot:decodeMountedRoot,decodeTargetOverrides:decodeTargetOverrides};