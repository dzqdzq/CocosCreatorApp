"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.encodeObject=exports.encodeComponent=exports.encodeScene=exports.encodeNode=void 0;const utils_1=__importDefault(require("./utils")),dump_defines_1=require("./dump-defines"),cc_1=require("cc"),utils_2=require("../../3d/manager/prefab/utils"),attributeProps=["enumList","radioGroup","bitmaskList","displayName","group","multiline","min","max","step","slide","tooltip","animatable","unit","radian","displayOrder"],autoI18nAttributeNames=["displayName","tooltip"];function encodeNode(e){var t;const o=e.constructor,n=Object.keys(cc.Layers.Enum).map((e,t)=>({name:e,value:cc.Layers.Enum[e]}));n.sort((e,t)=>e.value-t.value);const c=Object.keys(cc_1.MobilityMode).map((e,t)=>({name:e,value:cc_1.MobilityMode[e]})),a="2d"===cce.SceneFacadeManager._projectType,r={active:encodeObject(e.active,{displayName:"Active",default:null},e),locked:encodeObject(Boolean(e.objFlags&cc.Object.Flags.LockedInEditor),{displayName:"Locked",default:!1,animatable:!1},e),name:encodeObject(e.name,{displayName:"Name",default:null,animatable:!1},e),position:encodeObject(e.position,{displayName:"Position",default:new cc.math.Vec3,tooltip:"i18n:scene.tooltips.positionTip"},e),rotation:encodeObject(e.eulerAngles,{displayName:"Rotation",default:new cc.math.Vec3,tooltip:`i18n:scene.tooltips.${a?"rotationTip2D":"rotationTip3D"}`},e),scale:encodeObject(e.scale,{displayName:"Scale",default:new cc.math.Vec3(1,1,1),tooltip:"i18n:scene.tooltips.scaleTip"},e),mobility:encodeObject(e.mobility,{displayName:"Mobility",default:0,type:"Enum",enumList:c},e),layer:encodeObject(e.layer,{displayName:"Layer",default:1073741824,type:"Enum",enumList:n,readonly:!1,animatable:!1},e),uuid:encodeObject(e.uuid,{displayName:"UUID",default:null,animatable:!1},e),parent:encodeObject(e.parent,{ctor:cc.Node},e),children:e.children.map(t=>{if(t&&!(t.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(t,{ctor:cc.Node},e)}).filter(Boolean),__type__:utils_1.default.getTypeName(o),__comps__:e._components.map(e=>encodeComponent(e)),mountedRoot:null===(t=utils_2.prefabUtils.getMountedRoot(e))||void 0===t?void 0:t.uuid};if(e._prefab){const t=utils_2.prefabUtils.getPrefabStateInfo(e);r.__prefab__={uuid:e._prefab.asset&&e._prefab.asset._uuid||"",fileId:e._prefab.fileId,rootUuid:e._prefab.root&&e._prefab.root.uuid,sync:!0,prefabStateInfo:t},e._prefab.targetOverrides&&(r.__prefab__.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),e._prefab.instance&&(r.__prefab__.instance=encodeObject(e._prefab.instance,{default:null},e));const o=utils_2.prefabUtils.getRemovedComponents(e);o.length>0&&(r.removedComponents=o.map(e=>({name:cc_1.js.getClassName(e),fileID:e.__prefab.fileId})))}return _checkObjFlags(e,r),r}function encodeScene(e){var t;const o=e.constructor,n={active:encodeObject(e.active,{default:null}),locked:encodeObject(!1,{default:!1}),name:encodeObject(e.name||o.name,{default:null}),uuid:encodeObject(e.uuid,{default:null}),autoReleaseAssets:encodeObject(e.autoReleaseAssets,{displayName:"Auto Release Assets",default:!1}),children:e.children.map(e=>{if(e&&!(e.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node})}).filter(Boolean),parent:"",__type__:utils_1.default.getTypeName(o),_globals:{},isScene:!0};return e._globals&&e._globals.constructor.__props__.map(t=>{const o=cc.Class.attr(e._globals.constructor,t);n._globals[t]=encodeObject(e._globals[t],o,e._globals)}),(null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides)&&(n.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),n}function encodeComponent(e){var t,o;const n=e.constructor,c=utils_2.prefabUtils.getMountedRoot(e);let a=null===c||void 0===c?void 0:c.uuid;if(c){const e=c._prefab;if(e&&e.root){const n=null===(o=null===(t=e.root._prefab)||void 0===t?void 0:t.instance)||void 0===o?void 0:o.prefabRootNode;n&&n!==cce.Scene.rootNode&&(a=void 0)}}const r={value:{uuid:encodeObject(e.uuid,{default:null,visible:!1},e),name:encodeObject(e.name,{default:null,visible:!1},e),enabled:encodeObject(e.enabled,{default:null,visible:!1},e)},default:void 0,type:utils_1.default.getTypeName(n),readonly:!1,visible:!0,cid:e.__cid__,mountedRoot:a};if(n.__props__.forEach(t=>{if(r.value)try{if(t in e){const o=cc.Class.attr(e,t),n=encodeObject(e[t],o,e,t);"Unknown"!==n.type&&(r.value[t]=n),_checkConstructorRewriteType(n,e[t],o)}}catch(o){console.warn(`Component property dump failed:\n  Node: ${e.node.name}(${e.node.uuid})\n Component: ${r.type}(${e.uuid})\n Property: ${t}`),console.warn(o),delete r.value[t]}}),r.editor={inspector:n._inspector||"",icon:n._icon||"",help:n._help||"",_showTick:"function"==typeof e.start||"function"==typeof e.update||"function"==typeof e.lateUpdate||"function"==typeof e.onEnable||"function"==typeof e.onDisable},r.value){const t=r.value.__scriptAsset;if(e instanceof cc._MissingScript){const o=e._$erialized;let n=o&&o.__type__;n=n&&EditorExtends.UuidUtils.decompressUuid(e._$erialized.__type__),t.visible=!(!n||!EditorExtends.UuidUtils.isUuid(n)),t.value={uuid:n}}else t.visible=!!e.__scriptUuid,t.value={uuid:e.__scriptUuid};t.displayOrder=-999}return n&&(r.extends=utils_1.default.getTypeInheritanceChain(n)),r}function _checkConstructorRewriteType(e,t,o){t&&"object"==typeof t&&!Array.isArray(t)&&t.constructor&&o&&o.ctor&&!(t instanceof o.ctor)&&(e.type="Unknown")}function _checkAttributes(e,t,o){if(void 0!==t.visible&&("function"==typeof t.visible?o?e.visible=!!t.visible.call(o):console.warn("try to use visible function without owner"):e.visible=!!t.visible),!t.ctor&&t.type&&(e.type=""+t.type),"enumList"in t&&"Enum"===t.type&&(e.type="Enum"),t&&t.hasGetter&&!t.hasSetter&&(e.readonly=!0),attributeProps.forEach(o=>{t.hasOwnProperty(o)&&(e[o]=t[o])}),"string"==typeof e.name&&o&&"object"==typeof o){const n=cc_1.js.getClassName(o);if(n.startsWith("cc."))for(const o of autoI18nAttributeNames)Object.prototype.hasOwnProperty.call(t,o)||(e[o]=`i18n:ENGINE.classes.${n}.properties.${e.name}.${o}`)}}function _encodeByType(e,t,o,n){e=e||"";const c=dump_defines_1.DumpDefines[e];return!!c&&(c.encode(t,o,n),!0)}function _checkObjFlags(e,t){let o=!1,n=!1,c=!1,a=!1,r=!1;e._components.forEach(e=>{e.objFlags&cc.Object.Flags.IsPositionLocked&&(o=!0),e.objFlags&cc.Object.Flags.IsSizeLocked&&(n=!0),e.objFlags&cc.Object.Flags.IsAnchorLocked&&(c=!0),e.objFlags&cc.Object.Flags.IsScaleLocked&&(a=!0),e.objFlags&cc.Object.Flags.IsRotationLocked&&(r=!0)}),o&&(t.position.readonly=!0),a&&(t.scale.readonly=!0),r&&(t.rotation.readonly=!0);const l=[];t.__comps__.forEach(e=>{"cc.UITransform"===e.cid&&l.push(e)}),l.length&&(n&&l.forEach(e=>{e.value.contentSize.readonly=!0}),c&&l.forEach(e=>{e.value.anchorPoint.readonly=!0}))}function encodeObject(e,t,o=null,n,c){const a=utils_1.default.getConstructor(e,t);let r=utils_1.default.getDefault(t);if(r&&"object"==typeof r&&r.constructor&&Array.isArray(r.constructor.__props__)){const e={type:utils_1.default.getTypeName(r.constructor),value:{}};r.constructor.__props__.forEach(t=>{const o=cc.Class.attr(r.constructor,t),n=encodeObject(r[t],o,r,t);"Unknown"!==n.type&&(e.value[t]=n)}),r=e}let l=utils_1.default.getTypeName(a);if(null===o&&null!==t.default&&void 0!==t.default){const e=utils_1.default.getConstructor(t.default,t);utils_1.default.getTypeName(e)!==l&&(l="Unknown")}const s={name:n,value:null,default:r,type:l,readonly:!!t.readonly,visible:!0,animatable:void 0===t.animatable||!!t.animatable};if(t.userData&&(s.userData=t.userData),_checkAttributes(s,t,o),r&&Array.isArray(r)&&(s.isArray=!0),!s.isArray&&Array.isArray(e)&&(s.isArray=!0),s.isArray)if(Array.isArray(e)&&"Array"!==s.type){const n=Object.assign({},t);n.visible=!0,n.readonly&&void 0!==n.readonly.deep&&(n.readonly=n.readonly.deep);const a=utils_1.default.ccClassAttrPropertyDefaultValue(t);n.default=getElementDefaultValue(t,a),c||(s.elementTypeData=encodeObject(n.default,n,a,void 0,!0));const r=[];for(let t=0;t<e.length;t++){const c=e[t];c&&c.constructor&&(n.ctor=c&&c.constructor);const a=encodeObject(c,n,o);"Unknown"!==a.type?r.push(a):r.push(s.elementTypeData)}s.value=r}else s.type="Unknown";else{const o={};if(o.ctor=a,_encodeByType(s.type,e,s,o));else if(ArrayBuffer.isView(e))_encodeByType("TypedArray",e,s,o);else if(cc.js.isChildClassOf(a,cc.ValueType))_encodeByType("cc.ValueType",e,s,o);else if(cc.js.isChildClassOf(a,cc.Node))_encodeByType("cc.Node",e,s,o);else if(cc.js.isChildClassOf(a,cc.Component))_encodeByType("cc.Component",e,s,o);else if(cc.js.isChildClassOf(a,cc.Asset))_encodeByType("cc.Asset",e,s,o);else if(a&&a.__props__)if(e){const o={};a.__props__.forEach(n=>{const c=cc.Class.attr(e,n);t.readonly&&t.readonly.deep&&(c.readonly={deep:!0});const a=encodeObject(e[n],c,e,n);"Unknown"!==a.type&&(o[n]=a),_checkConstructorRewriteType(a,e[n],c)}),s.value=o}else s.value=null;else"Unknown"!==s.type&&(s.value=e)}return a&&(s.extends=utils_1.default.getTypeInheritanceChain(a)),s}function getElementDefaultValue(e,t){return e.type?utils_1.default.ccClassAttrPropertyDefaultValue(e):getElementDefaultValueFromParentInitializer(t)}function getElementDefaultValueFromParentInitializer(e){if(!e||!Array.isArray(e)||0===e.length)return null;switch(typeof e[0]){case"number":return 0;case"string":return"";case"boolean":return!1}return null}function encodeTargetOverrides(e){if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{if(!e.source||!e.target)return;const o={source:e.source.uuid,sourceInfo:e.sourceInfo?e.sourceInfo.localID:void 0,propertyPath:e.propertyPath,target:e.target.uuid,targetInfo:e.targetInfo?e.targetInfo.localID:void 0};t.push(o)}),t}exports.encodeNode=encodeNode,exports.encodeScene=encodeScene,exports.encodeComponent=encodeComponent,exports.encodeObject=encodeObject,exports.default={encodeNode:encodeNode,encodeScene:encodeScene,encodeComponent:encodeComponent,encodeObject:encodeObject};