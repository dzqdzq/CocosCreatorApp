"use strict";var __decorate=this&&this.__decorate||function(e,o,n,t){var a,d=arguments.length,r=d<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,n):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,o,n,t);else for(var i=e.length-1;i>=0;i--)(a=e[i])&&(r=(d<3?a(r):d>3?a(o,n,r):a(o,n))||r);return d>3&&r&&Object.defineProperty(o,n,r),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.test=exports.TestComponent=void 0;const scene_1=require("./scene"),cc_1=require("cc"),component_1=require("../../3d/manager/prefab/component"),node_1=require("../../3d/manager/prefab/node"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo;let SceneTest;const{ccclass:ccclass,property:property}=cc_1._decorator;let TestComponent=class extends cc_1.Component{constructor(){super(...arguments),this.test=null}update(e){}};async function delay(e,o=20){return new Promise(n=>{setTimeout(async()=>{await e(),n(!0)},o)})}function equal(e,o,n){o===n?console.log(`test:${e} success`):console.error(`test:${e} fail,value:`,o,n)}async function createPrefabTestAsset(e){const o=cc.director.getScene();let n=new cc_1.Node(e);o.addChild(n),n.addComponent(TestComponent);const t=new cc_1.Node("child");return n.addChild(t),{assetID:await cce.SceneFacadeManager.createPrefab(n.uuid,`db://assets/${e}.prefab`),node:n=cc.find(e)}}async function testPrefab(){var e;const o=cc.director.getScene(),{assetID:n,node:t}=await createPrefabTestAsset("prefab"),{assetID:a,node:d}=await createPrefabTestAsset("prefab2");SceneTest.beginRecording([t.uuid,o.uuid]),await cce.Node.setProperty(t.uuid,"_name",{type:"string",value:"test"});const r={type:"cc.Node",value:{uuid:d.children[0].uuid}};await cce.Node.setProperty(t.uuid,"__comps__.0.test",r),await delay(async()=>{var e,n,a,r,i,c;const l=null!==(n=(null===(e=t._prefab)||void 0===e?void 0:e.instance).propertyOverrides)&&void 0!==n?n:[],s=o._prefab.targetOverrides;console.log("propertyOverrides",l),console.log("targetOverrides",s),await SceneTest.undo();for(const e of l)e.propertyPath.join().includes("name")&&equal("propertyOverrides undo",e.value,"prefab");equal("targetOverrides undo",null===(a=o._prefab)||void 0===a?void 0:a.targetOverrides,void 0),await SceneTest.redo();const u=null===(i=null===(r=t._prefab)||void 0===r?void 0:r.instance)||void 0===i?void 0:i.propertyOverrides;for(const e of u)e.propertyPath.join().includes("name")&&equal("propertyOverrides redo",e.value,"test");const p=null===(c=o._prefab)||void 0===c?void 0:c.targetOverrides;equal("targetOverrides redo",p.length,1),equal("targetOverrides redo",p[0].propertyPath[0],"test"),equal("targetOverrides redo",p[0].source,t),equal("targetOverrides redo",p[0].target,d)});const i={uuid:t.uuid,path:"__comps__",index:0},c=(null===(e=t.components[0].__prefab)||void 0===e?void 0:e.fileId)||"";await cce.SceneFacadeManager.removeNodeArrayElement(i);const l=t.uuid,s=await component_1.componentOperation.doApplyRemovedComponent(l,c);if(s){const e=new class extends scene_1.SceneUndoCommand{constructor(){super(...arguments),this.uuid="",this.fileID=""}async undo(){console.log("custom undo applyRemovedComponent"),await component_1.componentOperation.undoApplyRemovedComponent(this.data)}async redo(){console.log("custom redo applyRemovedComponent"),await component_1.componentOperation.doApplyRemovedComponent(this.uuid,this.fileID)}};e.uuid=l,e.fileID=c,e.data=s,SceneTest.beginRecording(t.uuid,{customCommand:e}),await delay(async()=>{var e,t,a;const d={parent:o.uuid,assetUuid:n,name:"prefabAfterApplyRemoveComponent.prefab",type:"cc.Prefab"};let r=await cce.SceneFacadeManager.createNode(d),i=cce.Node.query(r);equal("applyRemoveComponent before undo",!i,!1),equal("applyRemoveComponent before undo",null===(e=null===i||void 0===i?void 0:i.components)||void 0===e?void 0:e.length,0),await SceneTest.undo(),d.name="prefabAfterUndo.prefab",r=await cce.SceneFacadeManager.createNode(d),equal("applyRemoveComponent after undo1",!(i=cce.Node.query(r)),!1),equal("applyRemoveComponent after undo2",null===(t=null===i||void 0===i?void 0:i.components)||void 0===t?void 0:t.length,1),equal("applyRemoveComponent after undo3",null===i||void 0===i?void 0:i.components[0].name,"prefabAfterUndo<TestComponent>"),await SceneTest.redo(),d.name="prefabAfterRedo.prefab",r=await cce.SceneFacadeManager.createNode(d),equal("applyRemoveComponent after redo1",!(i=cce.Node.query(r)),!1),equal("applyRemoveComponent after redo2",null===(a=null===i||void 0===i?void 0:i.components)||void 0===a?void 0:a.length,0)})}await cce.Node.setProperty(d.children[0].uuid,"_name",{type:"string",value:"test2"}),await cce.Node.setProperty(d.uuid,"__comps__.0.test",{type:"cc.Node",value:{uuid:t.children[0].uuid}}),equal("applyPrefab修改属性",d.children[0].name,"test2"),equal("applyPrefab修改属性",!d.components[0].test,!1);const u=await node_1.nodeOperation.doApplyPrefab(d.uuid);if(equal("applyPrefab",!u,!1),u){const e=new class extends scene_1.SceneUndoCommand{constructor(){super(...arguments),this.uuid=""}async undo(){console.log("custom undo applyPrefab"),await node_1.nodeOperation.undoApplyPrefab(this.applyInfo)}async redo(){console.log("custom redo applyPrefab"),await node_1.nodeOperation.doApplyPrefab(this.uuid)}};e.applyInfo=u,e.uuid=d.uuid,SceneTest.beginRecording(d.uuid,{customCommand:e}),await delay(async()=>{var e,n,t,d,r,i;const c={parent:o.uuid,assetUuid:a,type:"cc.Prefab"},l=await cce.SceneFacadeManager.createNode(c),s=cce.Node.query(l),u=null===s||void 0===s?void 0:s.children[0],p=null===s||void 0===s?void 0:s.components[0];equal("applyPrefab before undo",!s,!1),equal("applyPrefab before undo",null===u||void 0===u?void 0:u.name,"test2"),equal("applyPrefab before undo",null===(e=null===s||void 0===s?void 0:s.components)||void 0===e?void 0:e.length,1),equal("applyPrefab before undo",null===(n=null===s||void 0===s?void 0:s.children)||void 0===n?void 0:n.length,1),equal("applyPrefab before undo",null===p||void 0===p?void 0:p.name,"prefab2<TestComponent>"),equal("applyPrefab before undo",null===p||void 0===p?void 0:p.test,null),await SceneTest.undo();const v=await cce.SceneFacadeManager.createNode(c),f=cce.Node.query(v),y=null===f||void 0===f?void 0:f.children[0];equal("applyPrefab after undo",!f,!1),equal("applyPrefab after undo",null===y||void 0===y?void 0:y.name,"child"),equal("applyPrefab after undo",null===(t=null===f||void 0===f?void 0:f.components)||void 0===t?void 0:t.length,1),equal("applyPrefab after undo",null===(d=null===f||void 0===f?void 0:f.children)||void 0===d?void 0:d.length,1),await SceneTest.redo();const m=await cce.SceneFacadeManager.createNode(c),b=cce.Node.query(m),g=null===b||void 0===b?void 0:b.children[0];null===b||void 0===b||b.components[0];equal("applyPrefab after redo",!b,!1),equal("applyPrefab after redo",null===g||void 0===g?void 0:g.name,"test2"),equal("applyPrefab after redo",null===(r=null===b||void 0===b?void 0:b.components)||void 0===r?void 0:r.length,1),equal("applyPrefab after redo",null===(i=null===b||void 0===b?void 0:b.children)||void 0===i?void 0:i.length,1)},200)}}async function testNode(){const e=new cc_1.Node("node"),o=new cc_1.Node("node2"),n=new cc_1.Node("parent");cc.director.getScene().addChild(n),SceneTest.beginRecording(n.uuid),n.addChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo add node",e.parent,null),await SceneTest.redo(),equal("redo add node",e.parent,n)}),SceneTest.beginRecording(e.uuid,{tag:"修改单个"}),e.name="xx",e.setPosition(new cc.Vec3(3,3,3)),await delay(async()=>{await SceneTest.undo(),equal("undo set property",e.name,"node"),equal("undo set property",e.position.x,0),equal("undo set property",e.position.y,0),equal("undo set property",e.position.z,0),await SceneTest.redo(),equal("redo set property",e.name,"xx"),equal("redo set property",e.position.x,3),equal("redo set property",e.position.y,3),equal("redo set property",e.position.z,3)}),SceneTest.beginRecording(n.uuid),n.removeChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo remove node",e.parent,n),await SceneTest.redo(),equal("redo remove node",e.parent,null)}),SceneTest.beginRecording(e.uuid);const t=e.addComponent("cc.EditBox");await delay(async()=>{await SceneTest.undo(),equal("undo add EditBox",e.components.length,0),await SceneTest.redo(),equal("redo add EditBox",e.components.length,2)}),SceneTest.beginRecording(t.uuid),t.string="test",await delay(async()=>{equal("modify EditBox before undo",t.string,"test"),await SceneTest.undo(),equal("modify EditBox after undo",t.string,""),await SceneTest.redo(),equal("modify EditBox after redo",t.string,"test")}),n.addChild(e),n.addChild(o),SceneTest.beginRecording([n.uuid,e.uuid]),o.setParent(e),await delay(async()=>{await SceneTest.undo(),equal("change parent undo",o.parent,n),await SceneTest.redo(),equal("change parent redo",o.parent,e)}),n.addChild(o),SceneTest.beginRecording(n.uuid),o.setSiblingIndex(0),await delay(async()=>{await SceneTest.undo(),equal("setSiblingIndex undo",n.children[0],e),equal("setSiblingIndex undo",n.children[1],o),await SceneTest.redo(),equal("setSiblingIndex redo",n.children[0],o),equal("setSiblingIndex redo",n.children[1],e)})}async function example(){SceneTest=new scene_1.SceneUndoManager,window.SceneTest=SceneTest,SceneTest.init(),await testNode(),await testPrefab()}function test(){try{example()}catch(e){console.log("undo test error: "+e)}}__decorate([property({type:cc_1.Node})],TestComponent.prototype,"test",void 0),TestComponent=__decorate([ccclass("TestComponent")],TestComponent),exports.TestComponent=TestComponent,exports.test=test;