"use strict";var __decorate=this&&this.__decorate||function(e,a,t,n){var o,r=arguments.length,d=r<3?a:null===n?n=Object.getOwnPropertyDescriptor(a,t):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)d=Reflect.decorate(e,a,t,n);else for(var c=e.length-1;0<=c;c--)(o=e[c])&&(d=(r<3?o(d):3<r?o(a,t,d):o(a,t))||d);return 3<r&&d&&Object.defineProperty(a,t,d),d};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TestComponent=void 0,exports.test=test;const scene_1=require("./scene"),cc_1=require("cc"),component_1=require("../../3d/manager/prefab/component"),node_1=require("../../3d/manager/prefab/node"),PrefabInfo=cc_1.Prefab._utils.PrefabInfo;let SceneTest;const{ccclass,property}=cc_1._decorator;let TestComponent=class extends cc_1.Component{test=null;update(e){}};async function delay(a,t=20){return new Promise(e=>{setTimeout(async()=>{await a(),e(!0)},t)})}function equal(e,a,t){a===t?console.log(`test:${e} success`):console.error(`test:${e} fail,value:`,a,t)}async function createPrefabTestAsset(e){var a=cc.director.getScene();let t=new cc_1.Node(e);a.addChild(t),t.addComponent(TestComponent);a=new cc_1.Node("child"),t.addChild(a),a=await cce.SceneFacadeManager.createPrefab(t.uuid,`db://assets/${e}.prefab`);return{assetID:a,node:t=cc.find(e)}}async function testPrefab(){const o=cc.director.getScene(),{assetID:n,node:r}=await createPrefabTestAsset("prefab"),{assetID:d,node:c}=await createPrefabTestAsset("prefab2");SceneTest.beginRecording([r.uuid,o.uuid]),await cce.Node.setProperty(r.uuid,"_name",{type:"string",value:"test"});var e={type:"cc.Node",value:{uuid:c.children[0].uuid}},e=(await cce.Node.setProperty(r.uuid,"__comps__.0.test",e),await delay(async()=>{var e=(r._prefab?.instance).propertyOverrides??[],a=o._prefab.targetOverrides;console.log("propertyOverrides",e),console.log("targetOverrides",a),await SceneTest.undo();for(const t of e)t.propertyPath.join().includes("name")&&equal("propertyOverrides undo",t.value,"prefab");equal("targetOverrides undo",o._prefab?.targetOverrides,void 0),await SceneTest.redo();for(const n of r._prefab?.instance?.propertyOverrides)n.propertyPath.join().includes("name")&&equal("propertyOverrides redo",n.value,"test");a=o._prefab?.targetOverrides;equal("targetOverrides redo",a.length,1),equal("targetOverrides redo",a[0].propertyPath[0],"test"),equal("targetOverrides redo",a[0].source,r),equal("targetOverrides redo",a[0].target,c)}),{uuid:r.uuid,path:"__comps__",index:0}),a=r.components[0].__prefab?.fileId||"";await cce.SceneFacadeManager.removeNodeArrayElement(e);class t extends scene_1.SceneUndoCommand{data;uuid="";fileID="";async undo(){console.log("custom undo applyRemovedComponent"),await component_1.componentOperation.undoApplyRemovedComponent(this.data)}async redo(){console.log("custom redo applyRemovedComponent"),await component_1.componentOperation.doApplyRemovedComponent(this.uuid,this.fileID)}}var s,e=r.uuid,i=await component_1.componentOperation.doApplyRemovedComponent(e,a);i&&((s=new t).uuid=e,s.fileID=a,s.data=i,SceneTest.beginRecording(r.uuid,{customCommand:s}),await delay(async()=>{var e={parent:o.uuid,assetUuid:n,name:"prefabAfterApplyRemoveComponent.prefab",type:"cc.Prefab"},a=await cce.SceneFacadeManager.createNode(e),t=cce.Node.query(a);equal("applyRemoveComponent before undo",!t,!1),equal("applyRemoveComponent before undo",t?.components?.length,0),await SceneTest.undo(),e.name="prefabAfterUndo.prefab",a=await cce.SceneFacadeManager.createNode(e),equal("applyRemoveComponent after undo1",!(t=cce.Node.query(a)),!1),equal("applyRemoveComponent after undo2",t?.components?.length,1),equal("applyRemoveComponent after undo3",t?.components[0].name,"prefabAfterUndo<TestComponent>"),await SceneTest.redo(),e.name="prefabAfterRedo.prefab",a=await cce.SceneFacadeManager.createNode(e),equal("applyRemoveComponent after redo1",!(t=cce.Node.query(a)),!1),equal("applyRemoveComponent after redo2",t?.components?.length,0)}));class p extends scene_1.SceneUndoCommand{applyInfo;uuid="";async undo(){console.log("custom undo applyPrefab"),await node_1.nodeOperation.undoApplyPrefab(this.applyInfo)}async redo(){console.log("custom redo applyPrefab"),await node_1.nodeOperation.doApplyPrefab(this.uuid)}}await cce.Node.setProperty(c.children[0].uuid,"_name",{type:"string",value:"test2"}),await cce.Node.setProperty(c.uuid,"__comps__.0.test",{type:"cc.Node",value:{uuid:r.children[0].uuid}}),equal("applyPrefab修改属性",c.children[0].name,"test2"),equal("applyPrefab修改属性",!c.components[0].test,!1);e=await node_1.nodeOperation.doApplyPrefab(c.uuid);equal("applyPrefab",!e,!1),e&&((a=new p).applyInfo=e,a.uuid=c.uuid,SceneTest.beginRecording(c.uuid,{customCommand:a}),await delay(async()=>{var e={parent:o.uuid,assetUuid:d,type:"cc.Prefab"},a=await cce.SceneFacadeManager.createNode(e),a=cce.Node.query(a),t=a?.children[0],n=a?.components[0],t=(equal("applyPrefab before undo",!a,!1),equal("applyPrefab before undo",t?.name,"test2"),equal("applyPrefab before undo",a?.components?.length,1),equal("applyPrefab before undo",a?.children?.length,1),equal("applyPrefab before undo",n?.name,"prefab2<TestComponent>"),equal("applyPrefab before undo",n?.test,null),await SceneTest.undo(),await cce.SceneFacadeManager.createNode(e)),a=cce.Node.query(t),n=a?.children[0],t=(equal("applyPrefab after undo",!a,!1),equal("applyPrefab after undo",n?.name,"child"),equal("applyPrefab after undo",a?.components?.length,1),equal("applyPrefab after undo",a?.children?.length,1),await SceneTest.redo(),await cce.SceneFacadeManager.createNode(e)),n=cce.Node.query(t),a=n?.children[0];n?.components[0];equal("applyPrefab after redo",!n,!1),equal("applyPrefab after redo",a?.name,"test2"),equal("applyPrefab after redo",n?.components?.length,1),equal("applyPrefab after redo",n?.children?.length,1)},200))}async function testNode(){const e=new cc_1.Node("node"),a=new cc_1.Node("node2"),t=new cc_1.Node("parent"),n=(cc.director.getScene().addChild(t),SceneTest.beginRecording(t.uuid),t.addChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo add node",e.parent,null),await SceneTest.redo(),equal("redo add node",e.parent,t)}),SceneTest.beginRecording(e.uuid,{tag:"修改单个"}),e.name="xx",e.setPosition(new cc.Vec3(3,3,3)),await delay(async()=>{await SceneTest.undo(),equal("undo set property",e.name,"node"),equal("undo set property",e.position.x,0),equal("undo set property",e.position.y,0),equal("undo set property",e.position.z,0),await SceneTest.redo(),equal("redo set property",e.name,"xx"),equal("redo set property",e.position.x,3),equal("redo set property",e.position.y,3),equal("redo set property",e.position.z,3)}),SceneTest.beginRecording(t.uuid),t.removeChild(e),await delay(async()=>{await SceneTest.undo(),equal("undo remove node",e.parent,t),await SceneTest.redo(),equal("redo remove node",e.parent,null)}),SceneTest.beginRecording(e.uuid),e.addComponent("cc.EditBox"));await delay(async()=>{await SceneTest.undo(),equal("undo add EditBox",e.components.length,0),await SceneTest.redo(),equal("redo add EditBox",e.components.length,2)}),SceneTest.beginRecording(n.uuid),n.string="test",await delay(async()=>{equal("modify EditBox before undo",n.string,"test"),await SceneTest.undo(),equal("modify EditBox after undo",n.string,""),await SceneTest.redo(),equal("modify EditBox after redo",n.string,"test")}),t.addChild(e),t.addChild(a),SceneTest.beginRecording([t.uuid,e.uuid]),a.setParent(e),await delay(async()=>{await SceneTest.undo(),equal("change parent undo",a.parent,t),await SceneTest.redo(),equal("change parent redo",a.parent,e)}),t.addChild(a),SceneTest.beginRecording(t.uuid),a.setSiblingIndex(0),await delay(async()=>{await SceneTest.undo(),equal("setSiblingIndex undo",t.children[0],e),equal("setSiblingIndex undo",t.children[1],a),await SceneTest.redo(),equal("setSiblingIndex redo",t.children[0],a),equal("setSiblingIndex redo",t.children[1],e)})}async function example(){SceneTest=new scene_1.SceneUndoManager,(window.SceneTest=SceneTest).init(),await testNode(),await testPrefab()}function test(){try{example()}catch(e){console.log("undo test error: "+e)}}exports.TestComponent=TestComponent,__decorate([property({type:cc_1.Node})],TestComponent.prototype,"test",void 0),exports.TestComponent=TestComponent=__decorate([ccclass("TestComponent")],TestComponent);