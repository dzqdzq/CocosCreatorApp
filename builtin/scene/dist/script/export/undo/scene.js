"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneUndoCommand=exports.SceneUndoManager=void 0;const node_1=__importDefault(require("../../3d/manager/node")),base_1=require("./base"),index_1=__importDefault(require("../dump/index")),event_enum_1=require("../../public/event-enum");class SceneUndoCommand extends base_1.UndoCommand{constructor(){super(...arguments),this.tag="",this.id="",this.auto=!1,this.custom=!1,this.uuids=[],this.undoData=new Map,this.redoData=new Map}async undo(){await this.applyData(this.undoData)}async applyData(e){for(const[t,n]of e){const e=cce.Node.query(t);if(e)n&&(await index_1.default.restoreNode(e,n),cce.Node.emit("change",e,{source:event_enum_1.EventSourceType.UNDO}));else{const e=cce.Component.query(t);if(e&&n){const t=n;for(const n in t.value)await index_1.default.restoreProperty(e,n,t.value[n]);cce.Node.emit("change",e.node,{source:event_enum_1.EventSourceType.UNDO})}}}}async redo(){await this.applyData(this.redoData)}}exports.SceneUndoCommand=SceneUndoCommand;class SceneUndoManager extends base_1.UndoManagerBase{constructor(){super(...arguments),this._autoCommands=[],this._manualCommands=[],this._uuidDumpMap={},this.id=0,this.records=[]}init(){cce.Engine.on("onEditorTick",()=>{this._recordTargetAtFrameEnd()})}_createCommand(e){let t=null;return e.customCommand?(t=e.customCommand).custom=!0:t=new SceneUndoCommand,void 0!==e.tag&&(t.tag=e.tag),void 0!==e.auto&&(t.auto=e.auto),!1!==t.auto?this._autoCommands.push(t):this._manualCommands.push(t),this.id++,t.id=t.tag+this.id,t}_isCommandExist(e){return-1!==this._commandArray.indexOf(e)}_recordTargetAtFrameEnd(){this._autoCommands.length>0&&(this._autoCommands.forEach(e=>{this.endRecording(e.id)}),this._autoCommands.length=0)}_setUndo(e,t){let n=null;if(this._uuidDumpMap[t])n=this._uuidDumpMap[t];else{const e=cce.Node.query(t);if(e)n=index_1.default.dumpNode(e);else{const e=cce.Component.query(t);n=e?index_1.default.dumpComponent(e):null}this._uuidDumpMap[t]=n}e.undoData.set(t,n)}_setRedo(e,t){let n=null;const o=cce.Node.query(t);if(o)n=index_1.default.dumpNode(o);else{const e=cce.Component.query(t);n=e?index_1.default.dumpComponent(e):null}this._uuidDumpMap[t]=n,e.redoData.set(t,n)}beginRecording(e,t){t=null!==t&&void 0!==t?t:{auto:!1};const n=this._createCommand(t);e=Array.isArray(e)?e:[e];const o=new Set(e);for(const e of o.values())n.uuids.push(e),n.custom||this._setUndo(n,e);return n.id}_removeCommand(e,t){const n=e.find(e=>e.id===t);if(n){const t=e.indexOf(n);if(-1!==t)return e.splice(t,1),!0}return!1}cancelRecording(e){let t=this._removeCommand(this._autoCommands,e);return t||(t=this._removeCommand(this._manualCommands,e)),t}endRecording(e){var t;const n=null!==(t=this._autoCommands.find(t=>t.id===e))&&void 0!==t?t:this._manualCommands.find(t=>t.id===e);if(!n)return!1;if(this._isCommandExist(n))return console.warn("command is already exist",n.tag),!1;if(n.custom||n.uuids.forEach(e=>{this._setRedo(n,e)}),""===n.tag){const e=n.uuids.map(e=>{var t,n;return(null===(t=cce.Node.query(e))||void 0===t?void 0:t.name)||(null===(n=cce.Component.query(e))||void 0===n?void 0:n.name)}).join(" ");n.tag=`modify:${e}`}this.push(n);const o=this._manualCommands.indexOf(n);return-1!==o&&this._manualCommands.splice(o,1),this.records.length>n.uuids.length&&console.debug("records length > command uuids length",this.records,n.uuids),this.records.length=0,!0}reset(){super.reset(),this._autoCommands.length=0,this._manualCommands.length=0,this._uuidDumpMap={}}_getUndoData(e=this.records){const t=new Map;return e.forEach(e=>{t.set(e,this._uuidDumpMap[e])}),t}_getRedoData(e=this.records){return this.updateDump(e),this._getUndoData(e)}updateDump(e=[],t=!0){e.forEach(e=>{try{const n=node_1.default.query(e);if(!n||n.objFlags&cc.Object.Flags.HideInHierarchy)return;!t&&this._uuidDumpMap[e]||(this._uuidDumpMap[e]=node_1.default.queryDumpAtAll(e))}catch(e){console.error(e)}})}async undo(){const e=await super.undo();return e&&!e.custom&&this.updateDump(e.uuids),e}async redo(){const e=await super.redo();return e&&!e.custom&&this.updateDump(e.uuids),e}snapshot(){try{const e=this._getUndoData(),t=this._getRedoData();if(this.records.length=0,JSON.stringify(Array.from(e.entries()))===JSON.stringify(Array.from(t.entries())))return!1;const n=new SceneUndoCommand;n.undoData=e,n.redoData=t;const o=this.beginRecording(n.uuids,{customCommand:n});this.endRecording(o)}catch(e){console.error(e)}}abort(){this.records.length=0}record(e){this.records.includes(e)||this.records.push(e)}}exports.SceneUndoManager=SceneUndoManager;