"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimationUndoManager=void 0;const animation_1=__importDefault(require("../../3d/manager/animation")),base_1=require("./base");class AnimationUndoManager extends base_1.UndoManagerBase{constructor(){super(...arguments),this.name="animation",this.id=0,this._manualCommands=[],this.nodeUuid="",this.clipUuid="",this.clipDump=null}init(){}getUndoData(){return{nodeUuid:this.nodeUuid,clipUuid:this.clipUuid,clipDump:this.clipDump}}getRedoData(){return this.updateCache(),this.getUndoData()}updateCache(){this.clipDump=animation_1.default.dumpClip(this.nodeUuid,this.clipUuid)}_createCommand(t){const a=new AnimationUndoCommand;return void 0!==t.tag&&(a.tag=t.tag),this.id++,a.id=this.name+this.id,this._manualCommands.push(a),a}beginRecording(t,a){if(t===this.nodeUuid&&(null===a||void 0===a?void 0:a.external)&&Object.prototype.hasOwnProperty.call(a.external,"animation")){const t=this._createCommand({tag:"animation edit"});return t.undoData=this.getUndoData(),t.id}return""}endRecording(t){const a=this._manualCommands.find(a=>a.id===t);if(!a)return!1;const i=this._manualCommands.indexOf(a);return-1!==i&&this._manualCommands.splice(i,1),a.redoData=this.getRedoData(),JSON.stringify(a.undoData)!==JSON.stringify(a.redoData)&&(this.push(a),!1)}cancelRecording(t){const a=this._manualCommands.find(a=>a.id===t);if(!a)return!1;const i=this._manualCommands.indexOf(a);return-1!==i&&this._manualCommands.splice(i,1),!0}reset(t,a){"string"==typeof t&&"string"==typeof a&&(super.reset(),this.nodeUuid=t,this.clipUuid=a,this.updateCache())}snapshot(t){}record(t){}abort(){}updateDump(t){}async undo(){const t=await super.undo();return t&&this.updateCache(),t}async redo(){const t=await super.redo();return t&&this.updateCache(),t}}exports.AnimationUndoManager=AnimationUndoManager;class AnimationUndoCommand extends base_1.UndoCommand{constructor(){super(...arguments),this.id="",this.tag=""}async undo(){await this.applyData(this.undoData)}async redo(){await this.applyData(this.redoData)}async applyData(t){const{nodeUuid:a,clipUuid:i,clipDump:n}=t;try{await animation_1.default.restoreFromDump(a,i,n)}catch(t){console.error(t)}}}