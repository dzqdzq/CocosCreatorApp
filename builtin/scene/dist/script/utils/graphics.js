"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveDataToImage=exports.flipImage=exports.readPixels=void 0;const cc_1=require("cc"),fs_extra_1=require("fs-extra"),sharp_1=__importDefault(require("sharp")),misc_1=require("./misc");function readPixels(e){const t=e.width,r=e.height,s=new Uint8Array(4*t*r),a=e.getGFXTexture();if(!a)return null;const i=cc_1.gfx.deviceManager.gfxDevice,n=[],o=[],c=new cc_1.gfx.BufferTextureCopy;return c.texOffset.x=0,c.texOffset.y=0,c.texExtent.width=e.width,c.texExtent.height=e.height,o.push(c),n.push(s),null===i||void 0===i||i.copyTextureToBuffers(a,n,o),s}function flipImage(e,t,r){if(!e)return null;const s=new Uint8Array(e.length);for(let a=0;a<r;a++)for(let i=0;i<t;i++){const n=4*(t*a+i),o=4*(t*(r-a-1)+i);s[o]=e[n],s[o+1]=e[n+1],s[o+2]=e[n+2],s[o+3]=e[n+3]}return s}async function saveDataToImage(e,t,r,s,a){let i="";await new Promise(async(n,o)=>{const c=await Editor.Message.request("asset-db","query-path","db://assets");if(null===c)return;const u=(0,misc_1.join)(c,s);(0,fs_extra_1.existsSync)(u)||(0,fs_extra_1.mkdirSync)(u),i=(0,misc_1.join)(u,a),(0,sharp_1.default)(e,{raw:{width:t,height:r,channels:4}}).toFile(i).then(async()=>{n()}).catch(e=>{o(e)})})}exports.readPixels=readPixels,exports.flipImage=flipImage,exports.saveDataToImage=saveDataToImage;