"use strict";var __importDefault=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallbacksInvoker=void 0;const createMap=cc.js.createMap,fastRemoveAt=cc.js.array.fastRemoveAt,pool_1=__importDefault(require("./pool"));function empty(){}class CallbackInfo{constructor(){this.callback=empty,this.target=void 0,this.once=!1}set(l,a,c,t){this.callback=l,this.target=a,this.once=!!c,this.off=t}}const callbackInfoPool=new pool_1.default(()=>new CallbackInfo,32);class CallbackList{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(l){for(let a=0;a<this.callbackInfos.length;++a){const c=this.callbackInfos[a];c&&c.callback===l&&(callbackInfoPool.free(c),fastRemoveAt(this.callbackInfos,a),--a)}}removeByTarget(l){for(let a=0;a<this.callbackInfos.length;++a){const c=this.callbackInfos[a];c&&c.target===l&&(callbackInfoPool.free(c),fastRemoveAt(this.callbackInfos,a),--a)}}cancel(l){const a=this.callbackInfos[l];a&&(callbackInfoPool.free(a),this.callbackInfos[l]=null),this.containCanceled=!0}cancelAll(){for(let l=0;l<this.callbackInfos.length;l++){const a=this.callbackInfos[l];a&&(callbackInfoPool.free(a),this.callbackInfos[l]=null)}this.containCanceled=!0}purgeCanceled(){for(let l=this.callbackInfos.length-1;l>=0;--l){this.callbackInfos[l]||fastRemoveAt(this.callbackInfos,l)}this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const MAX_SIZE=16,callbackListPool=new pool_1.default(()=>new CallbackList,16);class CallbacksInvoker{constructor(){this._callbackTable=createMap(!0)}on(l,a,c,t){let e=this._callbackTable[l];e||(e=this._callbackTable[l]=callbackListPool.alloc());const o=callbackInfoPool.alloc();o.set(a,c,t),e.callbackInfos.push(o)}hasEventListener(l,a,c){const t=this._callbackTable[l];if(!t)return!1;const e=t.callbackInfos;if(!a){if(t.isInvoking){for(const l of e)if(l)return!0;return!1}return e.length>0}for(let l=0;l<e.length;++l){const t=e[l];if(t&&t.callback===a&&t.target===c)return!0}return!1}removeAll(l){if("string"==typeof l){const a=this._callbackTable[l];a&&(a.isInvoking?a.cancelAll():(a.clear(),callbackListPool.free(a),delete this._callbackTable[l]))}else if(l)for(const a in this._callbackTable){const c=this._callbackTable[a];if(c.isInvoking){const a=c.callbackInfos;for(let t=0;t<a.length;++t){const e=a[t];e&&e.target===l&&c.cancel(t)}}else c.removeByTarget(l)}}removeAllListeners(){Object.keys(this._callbackTable).forEach(l=>{this.removeAll(l)})}off(l,a,c){const t=this._callbackTable[l];if(t){const e=t.callbackInfos;if(a)for(let l=0;l<e.length;++l){const o=e[l];if(o&&o.callback===a&&o.target===c){t.isInvoking?t.cancel(l):(fastRemoveAt(e,l),callbackInfoPool.free(o));break}}else this.removeAll(l)}}emit(l,...a){const c=this._callbackTable[l];if(c){const t=!c.isInvoking;c.isInvoking=!0;const e=c.callbackInfos;for(let c=0,t=e.length;c<t;++c){const t=e[c];if(t){const c=t.callback,e=t.target;t.once&&this.off(l,c,e),e?c.call(e,...a):c(...a)}}t&&(c.isInvoking=!1,c.containCanceled&&c.purgeCanceled())}}}exports.CallbacksInvoker=CallbacksInvoker;