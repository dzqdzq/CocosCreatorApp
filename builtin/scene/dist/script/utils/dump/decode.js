"use strict";"use strcit";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeTargetOverrides=exports.updatePropertyFromNull=exports.resetProperty=exports.decodePatch=exports.decodeNode=exports.decodeScene=exports.decodeMountedRoot=void 0;const utils_1=require("./utils"),lodash_1=require("lodash"),dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function decodeChildren(e,t){const o=e.map(e=>e.value.uuid),c=t.children.map(e=>e.uuid);c.forEach(e=>{if(!o.includes(e)){const t=cce.Node.query(e);if(!t||t.objFlags&cc.Object.Flags.HideInHierarchy)return;t.parent=null}}),o.forEach((e,o)=>{const r=cce.Node.query(e);r&&(r._objFlags&=cc.Object.Flags.PersistentMask,r._objFlags&=~cc.Object.Flags.Destroyed,c.includes(e)||(r.parent=t),r.setSiblingIndex(o))})}function decodeMountedRoot(e,t){if(!e)return;const o=cce.Node.query(t);o?(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=o):e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0)}async function decodeComponents(e,t,o){if(!e)return;const c={},r=e.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(c[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean),a=t.components.map(e=>{if(o){const t=(0,utils_1.getTypeName)(e.constructor);if(o.includes(t))return""}if(e.__prefab&&e.__prefab.fileId){const t=c[e.__prefab.fileId];if(t){const o=r.indexOf(t.value.uuid.value);-1!==o&&(r.splice(o,1,e.uuid),t.value.uuid.value=e.uuid)}}return e.uuid}).filter(Boolean);let s=a.length**2,n=a.length-1;do{const e=a[n];e&&!r.includes(e)&&cce.Node.removeComponent(e)?a.splice(n,1):n--,s--}while(0!==a.length&&s);cc.Object._deferredDestroy();const l=t.components.slice();t._components.length=0;for(let o=0;o<e.length;o++){const c=e[o];if(!c.value||!c.value.uuid)continue;let r=l[o];const a=c.value.uuid.value;let s=cce.Component.query(a);s||(s=cce.Component.queryRecycle(a)),s&&(r!==s?(s.node!==t&&i(s),(s.objFlags&cc.Object.Flags.Destroying||s.objFlags&cc.Object.Flags.Destroyed)&&(s.objFlags&=cc.Object.Flags.PersistentMask,s.objFlags&=~cc.Object.Flags.Destroyed,cce.Component.recycle(a)),cce.Node.addComponentAt(t,s,o),r=s):cce.Node.addComponentAt(t,r,o));for(const e in c.value)await decodePatch(e,c.value[e],r);decodeMountedRoot(r,c.mountedRoot),r&&r.onRestore&&r.onRestore()}function i(e){if(e.objFlags&cc.Object.Flags.Destroying||e.objFlags&cc.Object.Flags.Destroyed)return;e.node._getDependComponent(e).forEach(e=>{i(e)}),cce.Node.removeComponent(e.uuid),cc.Object._deferredDestroy()}}async function decodePrefab(e,t){if(!e&&!t._prefab)return;if(!e&&t._prefab)return void(t._prefab=null);const o=new PrefabInfo,c=cce.Node.query(e.rootUuid);if(o.root=c||t,e.uuid)try{o.asset=await(0,util_1.promisify)(cc_1.assetManager.loadAny)(e.uuid)}catch(t){console.error(t),o.asset=new cc_1.Prefab,o.asset.initDefault(e.uuid)}o.fileId=e.fileId||t.uuid,e.instance?await decodePatch("instance",e.instance,o):o.instance=void 0,e.targetOverrides?o.targetOverrides=decodeTargetOverrides(e.targetOverrides):o.targetOverrides=void 0,t._prefab=o}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const o of Object.keys(e._globals))await decodePatch(`_globals.${o}`,e._globals[o],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,o){return e&&(t=t||new cc.Node)?(decodePrefab(e.__prefab__,t),t.name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.mobility=e.mobility.value,t.setPosition(e.position.value),t.setRotationFromEuler(e.rotation.value.x,e.rotation.value.y,e.rotation.value.z),t.setScale(e.scale.value),decodeMountedRoot(t,e.mountedRoot),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,o),t):null}async function _decodeByType(e,t,o,c,r){const a=dump_defines_1.DumpDefines[e];return!!a&&(await a.decode(t,o,c,r),!0)}async function decodePatch(e,t,o){var c;const r=(0,utils_1.parsingPath)(e,o),a=(0,utils_1.parsingPath)(r.search,o),s=[cc_1.editorExtrasTag,"__scriptAsset","node","uuid"],n=r.search?(0,lodash_1.get)(o,r.search):o;if(!n)return;if(n instanceof cc_1.Component&&s.includes(r.key))return;if("[object Object]"===Object.prototype.toString.call(n)){let e=Object.getOwnPropertyDescriptor(n,r.key);if(window.isSceneNative&&void 0===e&&(e=Object.getOwnPropertyDescriptor(n.__proto__,r.key)),void 0===e){if(!(e=cc.Class.attr(n,r.key))||!e.hasSetter)return void(r.key in n&&(!e||!0!==e.hasGetter)&&(n[r.key]=t.value))}else if(!e.writable&&!e.set)return}const l=a.search?(0,lodash_1.get)(o,a.search):o;if(!("value"in t)||"Unknown"===t.type){let e=cc.Class.attr(n,r.key);if(Array.isArray(l)&&"_components"!==a.search){const t=(0,utils_1.parsingPath)(a.search,o),c=t.search?(0,lodash_1.get)(o,t.search):o;e=cc.Class.attr(c,t.key),e=cc.Class.attr(e.ctor,r.key)}const t=getDefaultAttrData(e);return n[r.key]=t,t}const i=cc.js.getClassByName(t.type),d=i?(0,utils_1.getTypeInheritanceChain)(i):[];if(t.isArray)if(Array.isArray(t.value)){const e=[],o=cc.Class.attr(n.constructor,r.key);for(let c=0;c<t.value.length;c++)e[c]=(0,utils_1.ccClassAttrPropertyDefaultValue)(o),await decodePatch(`${c}`,t.value[c],e);n[r.key]=e}else n[r.key]=[];else{const c={};if(c.ccType=i,await _decodeByType(t.type,n,r,t,c));else if("cc.Scene"===t.type)_decodeByType("cc.Node",n,r,t,c);else if(ArrayBuffer.isView(t.value))_decodeByType("TypedArray",n,r,t,c);else if(d.includes("cc.Node")||"cc.Node"===t.type)_decodeByType("cc.Node",n,r,t,c);else if(d.includes("cc.Asset")||"cc.Asset"===t.type)await _decodeByType("cc.Asset",n,r,t,c);else if(d.includes("cc.Component")||"cc.Component"===t.type)_decodeByType("cc.Component",n,r,t,c);else if(d.includes("cc.ValueType"))_decodeByType("cc.ValueType",n,r,t,c);else if("length"===r.key&&"Array"===t.type){for(;n.length>t.value;)n.pop();const e=(0,lodash_1.get)(o,a.search),c=cc.Class.attr(e,a.key);for(let e=n.length;e<t.value;e++)n[e]=(0,utils_1.ccClassAttrPropertyDefaultValue)(c);(0,lodash_1.set)(o,r.search,n)}else if(i&&!n[r.key]&&null!==t.value){n[r.key]=new i;for(let c=0;c<i.__props__.length;c++){const r=i.__props__[c],a=t.value[r];await decodePatch(`${e}.${r}`,a,o)}}else if(null===t.value)n[r.key]=t.value;else if("object"==typeof t.value)for(const e in t.value)void 0!==t.value[e]&&await decodePatch(e,t.value[e],n[r.key]);else n[r.key]=t.value}if(setNodeSpecialProperty(o,r),r.search&&(0,lodash_1.set)(o,r.search,n),a&&a.search){const e=(0,lodash_1.get)(o,a.search);e instanceof Object&&(null===(c=cc.Class.attr(e,r.key))||void 0===c?void 0:c.hasSetter)&&(e[a.key]=e[a.key])}}exports.decodeMountedRoot=decodeMountedRoot,exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch;const nodeSpecialPropertyDefaultValue={_lpos:()=>new cc_1.Vec3(0,0,0),eulerAngles:()=>new cc_1.Vec3(0,0,0),_lscale:()=>new cc_1.Vec3(1,1,1),mobility:()=>cc_1.MobilityMode.Static};function setNodeSpecialProperty(e,t){if(e instanceof cc.Node)switch(t.key){case"_lpos":e.setPosition(e._lpos);break;case"eulerAngles":e.setRotationFromEuler(e.eulerAngles.x,e.eulerAngles.y,e.eulerAngles.z);break;case"_lscale":e.setScale(e._lscale)}}function getDefaultAttrData(e){let t=(0,utils_1.getDefault)(e);return"object"==typeof t&&t&&(t="function"==typeof t.clone?t.clone():Array.isArray(t)?[]:{}),t}function resetProperty(e,t){const o=(0,utils_1.parsingPath)(t,e),c=o.search?(0,lodash_1.get)(e,o.search):e;if(c)if(o.key in nodeSpecialPropertyDefaultValue)c[o.key]=nodeSpecialPropertyDefaultValue[o.key](),setNodeSpecialProperty(c,o);else{const e=cc.Class.attr(c.constructor,o.key);c[o.key]=getDefaultAttrData(e)}}function updatePropertyFromNull(e,t){const o=(0,utils_1.parsingPath)(t,e),c=o.search?(0,lodash_1.get)(e,o.search):e;if(!c)return;const r=cc.Class.attr(c.constructor,o.key);c[o.key]=getDefaultAttrData(r),null!==c[o.key]&&void 0!==c[o.key]||!r.ctor||(c[o.key]=new r.ctor)}function decodeTargetOverrides(e){const t=[];return e.forEach(e=>{const o=new TargetOverrideInfo;if(o.source=cce.Node.query(e.source),e.sourceInfo){const t=new TargetInfo;t.localID=e.sourceInfo,o.sourceInfo=t}if(o.propertyPath=e.propertyPath,o.target=cce.Node.query(e.target),e.targetInfo){const t=new TargetInfo;t.localID=e.targetInfo,o.targetInfo=t}t.push(o)}),t}exports.resetProperty=resetProperty,exports.updatePropertyFromNull=updatePropertyFromNull,exports.decodeTargetOverrides=decodeTargetOverrides,exports.default=module.exports;