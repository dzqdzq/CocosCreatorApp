"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const{get:get,set:set}=require("lodash"),editor_1=require("editor"),cc_1=require("cc"),assets_1=__importDefault(require("../3d/assets")),aabb_1=__importDefault(require("./aabb")),math_1=__importDefault(require("./math")),vec3_1=require("./math/vec3"),raycast_1=__importDefault(require("./raycast")),message_1=require("../3d/manager/message"),ray=cc_1.geometry.Ray.create(),tempVec3_a=new cc_1.Vec3,tempMatrix=cc.mat4(),stack=new Array(32);var ShapeType;!function(e){e[e.Box=0]="Box",e[e.Circle=1]="Circle",e[e.Cone=2]="Cone",e[e.Sphere=3]="Sphere",e[e.Hemisphere=4]="Hemisphere"}(ShapeType||(ShapeType={}));const cmp=(e,t)=>e.distance-t.distance;function _disableChildComps(e){for(let t=0,o=e._components.length;t<o;++t){const o=e._components[t];o._enabled&&cc.director._compScheduler.disableComp(o)}const t=e._children;for(let e=0,o=t.length;e<o;++e){const o=t[e];o._active&&_disableChildComps(o)}}function invokeOnDestroyRecursively(e){const t=e.components.length;for(let o=0;o<t;++o){const t=e.components[o];if((cc.GAME_VIEW||t.constructor._executeInEditMode)&&t.onDestroy)try{t.onDestroy()}catch(e){cc._throw(e)}}for(let t=0,o=e.children.length;t<o;++t){const o=e.children[t];o.active&&_disableChildComps(o)}}class NodeUtils{getObbFromRect(e,t,o,n,r,c){const s=t.x,a=t.y,i=t.width,l=t.height,d=e.m00*s+e.m04*a+e.m12,h=e.m01*s+e.m05*a+e.m13,u=e.m00*i,m=e.m01*i,g=e.m04*l,f=e.m05*l;return o=o||cc.v2(),n=n||cc.v2(),r=r||cc.v2(),c=c||cc.v2(),n.x=d,n.y=h,r.x=u+d,r.y=m+h,o.x=g+d,o.y=f+h,c.x=u+g+d,c.y=m+f+h,[o,n,r,c]}getWorldBounds(e,t,o){let n=(t=t||cc.size(0,0)).width,r=t.height;const c=new cc.Rect(0,0,n,r),s=e.getComponent(cc_1.UITransform);if(s){n=(t=s.contentSize).width,r=t.height;const e=s.anchorPoint;c.x=-e.x*n,c.y=-e.y*r,c.width=n,c.height=r}return e.getWorldMatrix(tempMatrix),c.transformMat4(tempMatrix),o?(o.x=c.x,o.y=c.y,o.width=c.width,o.height=c.height,o):c}getWorldOrientedBounds(e,t=null,o=null,n=null,r=null,c=null){const s=e.getComponent(cc_1.MeshRenderer);if(e.getWorldMatrix(tempMatrix),s)return this.getObbFromMeshRenderer(s,tempMatrix);{let s=(t=t||cc.size(0,0)).width,a=t.height;const i=new cc.Rect(0,0,s,a),l=e.getComponent(cc_1.UITransform);if(l){s=(t=l.contentSize).width,a=t.height;const e=l.anchorPoint;i.x=-e.x*s,i.y=-e.y*a,i.width=s,i.height=a}const d=this.getObbFromRect(tempMatrix,i,o,n,r,c),h=this.getWorldPosition3D(e);return d.forEach(e=>{e.z=h.z}),d}}getObbFromMeshRenderer(e,t){var o,n;let r=null===(o=e.model)||void 0===o?void 0:o.worldBounds;if(!r){r=cc_1.geometry.aabb.create();const o=null===(n=e.model)||void 0===n?void 0:n.modelBounds;o?aabb_1.default.transform(r,o,t):aabb_1.default.transform(r,r,cc_1.Mat4.IDENTITY)}const c=cc.v3(),s=cc.v3();r.getBoundary(c,s);const a=[];return a.push(c),a.push(cc.v3(s.x,c.y,c.z)),a.push(cc.v3(s.x,s.y,c.z)),a.push(cc.v3(c.x,s.y,c.z)),a.push(s),a.push(cc.v3(c.x,s.y,s.z)),a.push(cc.v3(c.x,c.y,s.z)),a.push(cc.v3(s.x,c.y,s.z)),a}getScenePosition(e){return cc.director.getScene()?e.getWorldPosition(cc.v3()):(cc.error("Can not access scenePosition if no running scene"),vec3_1.MVec3.ZERO)}setScenePosition(e,t){cc.director.getScene()?e.setWorldPosition(t):cc.error("Can not access scenePosition if no running scene")}getSceneRotation(e){return cc.director.getScene()?this.getWorldRotation(e):(cc.error("Can not access sceneRotation if no running scene"),0)}setSceneRotation(e,t){cc.director.getScene()?this.setWorldRotation(e,t):cc.error("Can not access sceneRotation if no running scene")}getWorldPosition(e){return e.getWorldPosition()}setWorldPosition(e,t){t instanceof cc.Vec3?e.setWorldPosition(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldRotation(e){return e.getWorldRotation(cc.quat())}setWorldRotation(e,t){t instanceof cc.Quat?e.setWorldRotation(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldScale(e){return e.getWorldScale(cc.v3())}_hasFlagInComponents(e,t){const o=e.components;for(let e=0,n=o.length;e<n;++e){if(o[e].objFlags&t)return!0}return!1}_destroyForUndo(e,t){cc.Node.isNode(e)&&(e._activeInHierarchy&&_disableChildComps(e),invokeOnDestroyRecursively(e)),t(),e.destroy(),message_1.messageManager.broadcast("scene:delete-nodes-in-scene")}getNodePath(e){let t="";for(;e&&!(e instanceof cc.Scene);)t=t?e.name+"/"+t:e.name,e=e.parent;return t}getChildUuids(e,t){const o=[];t&&o.push(e.uuid);let n=0;for(stack[0]=e;n>=0;){const e=stack[n];if(stack[n]=null,--n,!e)continue;const t=e._children;if(t)for(let e=0,r=t.length;e<r;++e){const r=t[e];stack[++n]=r,o.push(r.uuid)}}return o}async createNodeFromAsset(e,t){const o=require("../lib/sandbox"),n=await editor_1.Message.request("asset-db","query-asset-info",e);n||t(new Error('Can not get asset info by uuid "'+e+'", the asset may be deleted.'));const r=assets_1.default.getCtor(n.importer);if(cc.js.isChildClassOf(r,cc._Script)){const r=Editor.Utils.UUID.compressUUID(e,!1),c=cc.js._getClassById(r);let s;if(cc.js.isChildClassOf(c,cc.Component))(s=new cc.Node(cc.js.getClassName(c))).addComponent(c),t(null,s);else{const e=require("fire-url").basename(n.url);"compiling"===Editor.remote.Compiler.state||o.reloading?t(new Error(`Can not load "${e}", please wait for the scene to reload.`)):t(new Error(`Can not find a component in the script "${e}".`))}}else cc.assetManager.loadAny(e,(e,o)=>{if(e)return t(e);if(o.createNode){if(o instanceof cc.Prefab){if(Editor.globalProfile.data["auto-sync-prefab"]){require("./prefab")._setPrefabSync(o.data,!0)}}o.createNode(t)}else t(new Error("Can not create node from "+cc.js.getClassName(r)))})}createNodeFromClass(e,t){const o=new cc.Node;let n=null;if(e){const t=cc.js._getClassById(e);if(t){const e=o.addComponent(t);e&&cc.director._nodeActivator.resetComp(e,!0)}else n=new Error(`Unknown node to create: ${e}`)}t&&t(n,o)}makeVec3InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e.z=math_1.default.toPrecision(e.z,t),e}makeVec2InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e}getWorldPosition3D(e,t){return t||(t=new cc_1.Vec3),e.getWorldPosition(t)}setWorldPosition3D(e,t,o=3){t=this.makeVec3InPrecision(t,o),e.setWorldPosition(t)}getWorldRotation3D(e,t){return t||(t=new cc_1.Quat),e.getWorldRotation(t)}setWorldRotation3D(e,t){e.setWorldRotation(t)}getEulerAngles(e){return e.eulerAngles}setEulerAngles(e,t){e.setRotationFromEuler(t.x,t.y,t.z)}getWorldScale3D(e){return e.getWorldScale()}limitRange(e){return math_1.default.clamp(e,-1e10,1e10)}makeVec3InRange(e,t,o){return e.x=math_1.default.clamp(e.x,t,o),e.y=math_1.default.clamp(e.y,t,o),e.z=math_1.default.clamp(e.z,t,o),e}getCenterWorldPos3D(e){let t=null,o=null,n=null,r=null,c=null,s=null;for(let a=0;a<e.length;++a){let i;const l=e[a],d=this.getWorldOrientedBounds(l);for(let e=0;e<d.length;++e)i=d[e],(null===t||i.x<t)&&(t=i.x),(null===r||i.x>r)&&(r=i.x),(null===o||i.y<o)&&(o=i.y),(null===c||i.y>c)&&(c=i.y),(null===n||i.z<n)&&(n=i.z),(null===s||i.z>s)&&(s=i.z)}const a=.5*((t=this.limitRange(t))+(r=this.limitRange(r))),i=.5*((o=this.limitRange(o))+(c=this.limitRange(c))),l=.5*((n=this.limitRange(n))+(s=this.limitRange(s)));return cc.v3(a,i,l)}getMaxRangeOfNode(e){let t=1;if(e&&!this.isEditorNode(e)){let o=0;e.components.forEach(n=>{switch(cc.js.getClassName(n)){case"cc.SphereLight":case"cc.SpotLight":o=n.range;break;case"cc.MeshRenderer":case"cc.SkinnedMeshRenderer":case"cc.AvatarModelComponent":case"cc.SkinnedMeshBatchRenderer":if(n.model){let t=n.model.worldBounds;if(!t){const o=n.model.modelBounds;o&&(t=aabb_1.default.create(),aabb_1.default.transform(t,o,e.worldMatrix))}t&&(o=Math.max(t.halfExtents.x,t.halfExtents.y,t.halfExtents.z))}break;case"cc.Camera":o=3;break;case"cc.UITransform":const t=n.contentSize;o=Math.max(t.width/2,t.height/2);break;case"cc.BoxCollider":const r=n.size;o=Math.max(r.x/2,r.y/2,r.z/2);break;case"cc.SphereCollider":o=n.radius;break;case"cc.CapsuleCollider":o=Math.max(n.height/2,n.radius);break;case"cc.ParticleSystem":o=this._getRangeFromParticleComp(n);break;case cc_1.js.getClassName(cc_1.Terrain):const c=n.info;o=Math.max(c.size.width/2,c.size.height/2)}o>t&&(t=o)})}return t=this.limitRange(t)}getMinRangeOfNodes(e){let t=Number.MAX_VALUE;if(e){let o=0;e.forEach(e=>{(o=this.getMaxRangeOfNode(e))<t&&(t=o)})}return t=this.limitRange(t)}getMaxRangeOfNodes(e){let t=Number.MIN_VALUE;if(e){let o=0;e.forEach(e=>{(o=this.getMaxRangeOfNode(e))>t&&(t=o),(o=this.getMaxRangeOfNodes(e.children))>t&&(t=o)})}return t}isEditorNode(e){let t=e;for(;t;){if(t.objFlags&cc.Object.Flags.HideInHierarchy)return!0;t=t.parent}return!1}_getRangeFromParticleComp(e){let t=0;if(e.shapeModule.enable){const o=e.shapeModule;switch(o.shapeType){case ShapeType.Box:t=Math.max(o.scale.x,o.scale.y,o.scale.z);break;case ShapeType.Sphere:case ShapeType.Circle:case ShapeType.Hemisphere:t=o.radius;break;case ShapeType.Cone:t=Math.max(o.radius,o.length)}}return t}getRaycastResultNodes(e,t,o,n=~cc_1.Layers.Enum.SCENE_GIZMO){const r=cc.screen.windowSize;e.screenPointToRay(ray,t,r.height-o);const c=cc.director._scene.renderScene,s=[];if(raycast_1.default.raycastAll(c,ray,n)){const e=raycast_1.default.rayResultAll;e.sort(cmp);for(let t=0;t<e.length;t++){const o=e[t].node;o.objFlags&cc.Object.Flags.LockedInEditor||o.objFlags&cc.Object.Flags.HideInHierarchy||s.push(o)}}return s}getNameDataByPropPath(e,t){const o=((t=t.replace(/^__comps__/,"_components"))||"").split(".");let n="",r="";if(1===o.length)r=o[0];else if(o.length>1&&"_components"===o[0]){const t=[o[0],o[1]].join("."),c=get(e,t);c&&(n=cc_1.js.getClassName(c.constructor)),o[2]&&(r=o[2])}return{compName:n,propName:r}}getBoundaryOfMeshNode(e){var t,o,n;if(e){const r=e.getComponent(cc_1.MeshRenderer);let c;if(r instanceof cc_1.SkinnedMeshRenderer)null===(t=r.model)||void 0===t||t.updateTransform(-1),c=null===(o=null===r||void 0===r?void 0:r.model)||void 0===o?void 0:o.worldBounds;else if(r&&r.mesh){if(!(c=r.model&&(null===(n=r.model.modelBounds)||void 0===n?void 0:n.clone()))){const e=r.mesh;e&&e.minPosition&&e.maxPosition&&(c=cc_1.geometry.AABB.fromPoints(cc_1.geometry.AABB.create(),e.minPosition,e.maxPosition))}c&&cc_1.geometry.AABB.transform(c,c,e.worldMatrix)}return c}}getBoundaryOfMeshNodes(e){let t;if(e){let o;return e.forEach(e=>{(o=this.getBoundaryOfMeshNode(e))&&(t?cc_1.geometry.AABB.merge(t,t,o):t=o),(o=this.getBoundaryOfMeshNodes(e.children))&&(t?cc_1.geometry.AABB.merge(t,t,o):t=o)}),t}return t}}exports.default=new NodeUtils;