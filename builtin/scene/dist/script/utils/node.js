"use strict";var ShapeType,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeUtils=void 0;const get=require("lodash")["get"],cc_1=require("cc"),aabb_1=__importDefault(require("./aabb")),math_1=__importDefault(require("./math")),vec3_1=require("./math/vec3"),raycast_1=__importDefault(require("./raycast")),ray=cc_1.geometry.Ray.create(),tempMatrix=(0,cc_1.mat4)(),m4_1=(0,cc_1.mat4)(),tempNodes=[],cmp=(!function(e){e[e.Box=0]="Box",e[e.Circle=1]="Circle",e[e.Cone=2]="Cone",e[e.Sphere=3]="Sphere",e[e.Hemisphere=4]="Hemisphere"}(ShapeType=ShapeType||{}),(e,t)=>e.distance-t.distance),regionTargetClassName=["cc.UITransform","cc.SpriteRenderer","cc.Camera","cc.DirectionalLight","cc.Terrain","cc.SphereLight","cc.ParticleSystem","cc.SpotLight"];function _disableChildComps(r){for(let e=0,t=r._components.length;e<t;++e){var o=r._components[e];o._enabled&&cc_1.director._compScheduler.disableComp(o)}var n=r._children;for(let e=0,t=n.length;e<t;++e){var c=n[e];c._active&&_disableChildComps(c)}}function invokeOnDestroyRecursively(r){var t=r.components.length;for(let e=0;e<t;++e){var o=r.components[e];if((cc.GAME_VIEW||o.constructor._executeInEditMode)&&o.onDestroy)try{o.onDestroy()}catch(e){cc._throw(e)}}for(let e=0,t=r.children.length;e<t;++e){var n=r.children[e];n.active&&_disableChildComps(n)}}function InRegion(e,t,r,o,n,c){return r<=e&&e<=o&&t<=n&&c<=t}function hasFlags(e,t){let r=e;for(;r;){if(t.some(e=>0!=(r.objFlags&e)))return!0;r=r.parent}return!1}class NodeUtils{getObbFromRect(e,t,r,o,n,c){var a=t.x,s=t.y,i=t.width,t=t.height,l=e.m00*a+e.m04*s+e.m12,a=e.m01*a+e.m05*s+e.m13,s=e.m00*i,i=e.m01*i,d=e.m04*t,e=e.m05*t;return r=r||cc.v2(),o=o||cc.v2(),n=n||cc.v2(),c=c||cc.v2(),o.x=l,o.y=a,n.x=s+l,n.y=i+a,r.x=d+l,r.y=e+a,c.x=s+d+l,c.y=i+e+a,[r,o,n,c]}getWorldBounds(e,t,r){var o=(t=t||cc.size(0,0)).width,n=t.height,c=new cc.Rect(0,0,o,n),a=e.getComponent(cc_1.UITransform);return a&&(o=(t=a.contentSize).width,n=t.height,t=a.anchorPoint,c.x=-t.x*o,c.y=-t.y*n,c.width=o,c.height=n),e.getWorldMatrix(tempMatrix),c.transformMat4(tempMatrix),r?(r.x=c.x,r.y=c.y,r.width=c.width,r.height=c.height,r):c}getWorldOrientedBounds(e,t=null,r=null,o=null,n=null,c=null){e.getWorldMatrix(tempMatrix);var a=e.getComponent(cc_1.MeshRenderer);if(a)return this.getObbFromMeshRenderer(a,tempMatrix);a=e.getComponent(cc_1.UITransform);if(a)return this.getObbFromUITransform(a,tempMatrix);a=(t=t||cc.size(0,0)).width,t=t.height,a=new cc.Rect(0,0,a,t),t=this.getObbFromRect(tempMatrix,a,r,o,n,c);const s=this.getWorldPosition3D(e);return t.map(e=>new cc_1.Vec3(e.x,e.y,s.z))}getObbFromUITransform(e,t){var r=cc.size(0,0),o=r.width,n=r.height,c=new cc.Rect(0,0,o,n),a=new cc_1.Vec2,s=new cc_1.Vec2,i=new cc_1.Vec2,l=new cc_1.Vec2,r=(e&&(o=(r=e.contentSize).width,n=r.height,r=e.anchorPoint,c.x=-r.x*o,c.y=-r.y*n,c.width=o,c.height=n),this.getObbFromRect(tempMatrix,c,a,s,i,l));const d=this.getWorldPosition3D(e.node);return r.map(e=>new cc_1.Vec3(e.x,e.y,d.z))}getObbFromMeshRenderer(e,t){e.model?.updateWorldBound();let r=e.model?.worldBounds;return r||(r=cc_1.geometry.AABB.create(),(e=e.model?.modelBounds)?aabb_1.default.transform(r,e,t):aabb_1.default.transform(r,r,cc_1.Mat4.IDENTITY)),this.getObbFromBound(r)}getObbFromBound(e){var t=cc.v3(),r=cc.v3(),e=(e.getBoundary(t,r),[]);return e.push(t),e.push(cc.v3(r.x,t.y,t.z)),e.push(cc.v3(r.x,r.y,t.z)),e.push(cc.v3(t.x,r.y,t.z)),e.push(r),e.push(cc.v3(t.x,r.y,r.z)),e.push(cc.v3(t.x,t.y,r.z)),e.push(cc.v3(r.x,t.y,r.z)),e}getScenePosition(e){return cc_1.director.getScene()?e.getWorldPosition(cc.v3()):(cc.error("Can not access scenePosition if no running scene"),vec3_1.MVec3.ZERO)}setScenePosition(e,t){cc_1.director.getScene()?e.setWorldPosition(t):cc.error("Can not access scenePosition if no running scene")}getSceneRotation(e){return cc_1.director.getScene()?this.getWorldRotation(e):(cc.error("Can not access sceneRotation if no running scene"),0)}setSceneRotation(e,t){cc_1.director.getScene()?this.setWorldRotation(e,t):cc.error("Can not access sceneRotation if no running scene")}getWorldPosition(e){return e.getWorldPosition()}setWorldPosition(e,t){t instanceof cc.Vec3?e.setWorldPosition(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldRotation(e){return e.getWorldRotation(cc.quat())}setWorldRotation(e,t){t instanceof cc.Quat?e.setWorldRotation(t):cc.error("The new worldPosition must be cc.Vec3")}getWorldScale(e){return e.getWorldScale(cc.v3())}_hasFlagInComponents(e,r){var o=e.components;for(let e=0,t=o.length;e<t;++e)if(o[e].objFlags&r)return!0;return!1}hasComponentInSelfAndParent(e,t){let r=e;for(;r;){if(this.hasComponent(r,t))return!0;r=r.parent}return!1}hasComponent(e,t){for(const r of t)if(e.getComponent(r))return!0;return!1}getNodePath(e){let t="";for(;e&&!(e instanceof cc.Scene);)t=t?e.name+"/"+t:e.name,e=e.parent;return t}makeVec3InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e.z=math_1.default.toPrecision(e.z,t),e}makeVec2InPrecision(e,t){return e.x=math_1.default.toPrecision(e.x,t),e.y=math_1.default.toPrecision(e.y,t),e}getWorldPosition3D(e,t){return t=t||new cc_1.Vec3,e.getWorldPosition(t)}setWorldPosition3D(e,t,r=3){t=this.makeVec3InPrecision(t,r),e.setWorldPosition(t)}getWorldRotation3D(e,t){return t=t||new cc_1.Quat,e.getWorldRotation(t)}setWorldRotation3D(e,t){e.setWorldRotation(t)}getEulerAngles(e){return e.eulerAngles}setEulerAngles(e,t){e.setRotationFromEuler(t.x,t.y,t.z)}getWorldScale3D(e){return e.getWorldScale()}limitRange(e){return math_1.default.clamp(e,-1e10,1e10)}makeVec3InRange(e,t,r){return e.x=math_1.default.clamp(e.x,t,r),e.y=math_1.default.clamp(e.y,t,r),e.z=math_1.default.clamp(e.z,t,r),e}getCenterWorldPos3D(t){let r=null,o=null,n=null,c=null,a=null,s=null;for(let e=0;e<t.length;++e){var i,l=t[e],d=this.getWorldOrientedBounds(l);for(let e=0;e<d.length;++e)i=d[e],(null===r||i.x<r)&&(r=i.x),(null===c||i.x>c)&&(c=i.x),(null===o||i.y<o)&&(o=i.y),(null===a||i.y>a)&&(a=i.y),(null===n||i.z<n)&&(n=i.z),(null===s||i.z>s)&&(s=i.z)}r=this.limitRange(r),c=this.limitRange(c),o=this.limitRange(o),a=this.limitRange(a),n=this.limitRange(n),s=this.limitRange(s);var e=.5*(r+c),h=.5*(o+a),u=.5*(n+s);return(0,cc_1.v3)(e,h,u)}getMaxRangeOfNode(n){let c=.001;if(n&&!this.isEditorNode(n)){let o=0;0===n.components.length&&(c=1),n.components.forEach(e=>{switch(cc.js.getClassName(e)){case"cc.SphereLight":case"cc.SpotLight":case"cc.PointLight":o=e.range;break;case"cc.LightProbeGroup":var t=(0,cc_1.v3)(e.maxPos).subtract(e.minPos);o=Math.max(Math.abs(t.x/2),Math.abs(t.y/2),Math.abs(t.z/2));break;case"cc.RangedDirectionalLight":case"cc.DirectionalLight":case"cc.Camera":o=3;break;case"cc.MeshRenderer":case"cc.SkinnedMeshRenderer":case"cc.AvatarModelComponent":case"cc.SkinnedMeshBatchRenderer":var t=e.model;if(e.mesh&&t){let e=t.worldBounds;e||(t=t.modelBounds)&&(e=aabb_1.default.create(),aabb_1.default.transform(e,t,n.worldMatrix)),(e=e&&(Number.isNaN(e.halfExtents.x)||Number.isNaN(e.halfExtents.y)||Number.isNaN(e.halfExtents.z))?this.getBoundaryOfMeshNode(n):e)&&(o=Math.max(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z))}break;case"cc.ReflectionProbe":t=e.size;o=Math.max(t.x,t.y,t.z)/2;break;case"cc.UITransform":var t=e,r=t.getBoundingBox();t.node.parent&&(t.node.parent.getWorldMatrix(tempMatrix),r.transformMat4(tempMatrix)),o=Math.max(r.width/2,r.height/2);break;case"cc.BoxCollider":t=e.size;o=Math.max(t.x/2,t.y/2,t.z/2);break;case"cc.SphereCollider":o=e.radius;break;case"cc.CapsuleCollider":o=Math.max(e.height/2,e.radius);break;case"cc.ParticleSystem":o=this._getRangeFromParticleComp(e);break;case cc_1.js.getClassName(cc_1.Terrain):r=e.info;o=Math.max(r.size.width/2,r.size.height/2)}o>c?c=o:0===o&&(c=1)})}return c=this.limitRange(c)}getMinRangeOfNodes(e){let r=Number.MAX_VALUE;if(e){let t;e.forEach(e=>{(t=this.getMaxRangeOfNode(e))<r&&(r=t)})}return r=this.limitRange(r)}getMaxRangeOfNodes(e){let r=Number.MIN_VALUE;if(e){let t;e.forEach(e=>{(t=this.getMaxRangeOfNode(e))>r&&(r=t),(t=this.getMaxRangeOfNodes(e.children))>r&&(r=t)})}return r}isPartOfNode(e,t){let r=e;for(;r;){if(r===t)return!0;r=r.parent}return!1}isEditorNode(e){if(e.layer&cc_1.Layers.Enum.GIZMOS)return!0;let t=e;for(;t;){if(t.objFlags&cc_1.CCObject.Flags.HideInHierarchy)return!0;t=t.parent}return!1}_getRangeFromParticleComp(e){let t=0;if(e.shapeModule.enable){var r=e.shapeModule;switch(r.shapeType){case ShapeType.Box:t=Math.max(r.scale.x,r.scale.y,r.scale.z);break;case ShapeType.Sphere:case ShapeType.Circle:case ShapeType.Hemisphere:t=r.radius;break;case ShapeType.Cone:t=Math.max(r.radius,r.length)}}return t}getRaycastResultNodes(e,t,r,o=~cc_1.Layers.Enum.SCENE_GIZMO){e.screenPointToRay(ray,t,r);var e=cc_1.director.getScene()?.renderScene,n=[];if(raycast_1.default.raycastAll(e,ray,o,1/0,!1,void 0,new cc_1.Vec2(t,r))){var c=raycast_1.default.rayResultAll;c.sort(cmp);for(let e=0;e<c.length;e++){var a=c[e].node;a.objFlags&cc_1.CCObject.Flags.LockedInEditor||a.objFlags&cc_1.CCObject.Flags.HideInHierarchy||n.push(a)}}return n}getFilteredRaycastNodes(e,t,r,o=~cc_1.Layers.Enum.SCENE_GIZMO,n=[cc_1.CCObject.Flags.LockedInEditor,cc_1.CCObject.Flags.HideInHierarchy]){var c=[];for(const a of this.getRaycastResults(e,t,r,o))hasFlags(a.node,n)||c.push(a.node);return c}getRaycastResults(e,t,r,o=~cc_1.Layers.Enum.SCENE_GIZMO){e.screenPointToRay(ray,t,r);e=cc_1.director.getScene()?.renderScene;return raycast_1.default.raycastAll(e,ray,o)?((t=raycast_1.default.rayResultAll).sort(cmp),t):[]}getRaycastResultsForSnap(e,t,r,o=~cc_1.Layers.Enum.SCENE_GIZMO){e.screenPointToRay(ray,t,r);e=cc_1.director.getScene()?.renderScene;return raycast_1.default.raycastAll(e,ray,o,1/0,!0)?((t=raycast_1.default.rayResultAll).sort(cmp),t):[]}_collectNodesForRegion(t=!0){const o={prefabs:[],models:[],nodes:[]},e=this,r=function(e,t){const r={prefab:e,models:[],nodes:[]};e.walk(e=>{e[cc_1.editorExtrasTag]?.mountedRoot?n(e,o):n(e,r)}),t.prefabs.push(r)},n=function(t,r){if(e.hasComponent(t,regionTargetClassName))r.nodes.push(t);else if(e.hasComponent(t,["cc.MeshRenderer","cc.SkinnedMeshRenderer"])){let e=t.getComponent("cc.MeshRenderer");!(e=e||t.getComponent("cc.SkinnedMeshRenderer")).model||cc_1.director.getScene()?.renderScene?.isCulledByLod(cce.Camera.camera.camera,e.model)||r.models.push(e.model)}},c=function(e,t=!1){!e._prefab||t&&!e?._prefab.instance?(n(e,o),e.children.forEach(e=>{c(e)})):r(e,o)};return cc_1.director.getScene()?.children.forEach(e=>{"Editor Scene Foreground"===e.name&&t||"Editor Scene Background"!==e.name&&c(e,!0)}),o}isNodeInRegion(e,t,r,o,n,c){var a=new cc_1.Vec3;return t.worldToScreen(a,e.worldPosition),!!InRegion(a.x,a.y,r,o,n,c)}isModelInRegion(e,t,r,o,n,c){if(e.worldBounds){var a=[1,-1],s=e.worldBounds.center,i=new cc_1.Vec3;if(t.worldToScreen(i,s),InRegion(i.x,i.y,r,o,n,c)){var l=e.worldBounds.halfExtents;for(const h of["x","y","z"])for(const u of a){var d=new cc_1.Vec3(s);if(d[h]=d[h]+u*l[h],t.worldToScreen(i,d),!InRegion(i.x,i.y,r,o,n,c))return!1}return!0}}return!1}getRegionNodes(o,n,c,a,s,i=~cc_1.Layers.Enum.SCENE_GIZMO,e=!0){const l=[];e=this._collectNodesForRegion(e);return e?.prefabs.forEach(e=>{for(const t of e.nodes)if(this.isNodeInRegion(t,o,n,c,a,s))return void l.push(e.prefab);for(const r of e.models){if(!(r.transform&&r.enabled&&r.node.layer&i&&r.worldBounds))return;if(this.isModelInRegion(r,o,n,c,a,s))return void l.push(e.prefab)}}),e?.nodes.forEach(e=>{var t=new cc_1.Vec3;o.worldToScreen(t,e.position),this.isNodeInRegion(e,o,n,c,a,s)&&l.push(e)}),e?.models.forEach(e=>{e.transform&&e.enabled&&e.node.layer&i&&e.worldBounds&&this.isModelInRegion(e,o,n,c,a,s)&&l.push(e.node)}),l}getNameDataByPropPath(e,t){var r,t=((t=t.replace(/^__comps__/,"_components"))||"").split(".");let o="",n="";return 1===t.length?n=t[0]:1<t.length&&"_components"===t[0]&&(r=[t[0],t[1]].join("."),(e=get(e,r))&&(o=cc_1.js.getClassName(e.constructor)),t[2])&&(n=t[2]),{compName:o,propName:n}}getBoundaryOfMeshNode(t){if(t){var r=t.getComponent(cc_1.MeshRenderer);let e;return r instanceof cc_1.SkinnedMeshRenderer?(r.model?.updateTransform(-1),e=r?.model?.worldBounds):r&&r.mesh&&((e=r.model&&r.model.modelBounds&&r.model.modelBounds.clone())||(r=r.mesh)&&r.minPosition&&r.maxPosition&&(e=cc_1.geometry.AABB.fromPoints(cc_1.geometry.AABB.create(),r.minPosition,r.maxPosition)),e)&&cc_1.geometry.AABB.transform(e,e,t.worldMatrix),e}}getBoundaryOfMeshNodes(e){let r;if(e){let t;e.forEach(e=>{(t=this.getBoundaryOfMeshNode(e))&&(r?cc_1.geometry.AABB.merge(r,r,t):r=t),(t=this.getBoundaryOfMeshNodes(e.children))&&(r?cc_1.geometry.AABB.merge(r,r,t):r=t)})}return r}getMeshVertexAroundMouse(h,u,m,g,f=30){const p=[];return h&&u&&(h.getComponentsInChildren(cc_1.RenderableComponent).forEach(e=>{var t=e.mesh,r=t?.renderingSubMeshes?.length;for(let e=0;e<r;e++){var o=t.renderingSubMeshes[e].geometricInfo;if(o){var n=o.positions,c=new cc_1.Vec3,a=new cc_1.Vec3,s=new cc_1.Vec3,i=h.getWorldMatrix();for(let e=0;e<n.length;e+=3){c.set(n[e],n[e+1],n[e+2]),cc_1.Vec3.transformMat4(a,c,i),u.worldToScreen(s,a);var l=s.x-m,d=s.y-g,l=Math.sqrt(l*l+d*d);l<f&&p.push((new cc_1.Vec4).set(c.x,c.y,c.z,l))}}}}),p.sort((e,t)=>e.w-t.w)),p}}exports.NodeUtils=NodeUtils,exports.default=new NodeUtils;