"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_base_ipc_1=require("@base/electron-base-ipc"),vs="\nattribute vec2 pos;\nattribute vec2 uv;\nvarying vec2 v_uv;\nvoid main () {\n    v_uv = uv;\n    gl_Position = vec4(pos, 0.0, 1.0);\n}\n",fs="\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D framebuffer1;\nuniform sampler2D framebuffer2;\nvoid main () {\n    vec4 buffer1 = texture2D(framebuffer1, v_uv);\n    vec4 buffer2 = texture2D(framebuffer2, v_uv);\n    if(buffer2.a > 0.0) {\n        gl_FragColor = buffer2;\n    } else {\n        gl_FragColor = buffer1;\n    }\n}\n";class GlPreview{constructor(t,e){this.gl=null,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.uniforms=[],this._framebufferCount=1,this.initialized=!1,this._registerName=t,this._name=e}set isMulFramebuffer(t){this._framebufferCount=t?2:1}get isMulFramebuffer(){return 2===this._framebufferCount}async init(t){t||(t={width:100,height:100}),electron_base_ipc_1.sendToChannel(this._registerName,this._name,{index:t.index,width:t.width,height:t.height}),this.initialized=!0}_applyTex(t,e,i,s,r,h){this.gl.activeTexture(this.gl.TEXTURE0+s),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(i,s),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,r,h,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t)}queryPreviewData(t){return t||(t={width:100,height:100}),new Promise((e,i)=>{electron_base_ipc_1.sendToChannel(this._registerName,this._name,{index:t.index,width:t.width,height:t.height}).option({original:!0}).callback((t,s)=>{if(t)return i(t);e(s)})})}resizeGL(t,e){this.gl&&(this.gl.viewport(0,0,t,e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null))}drawGL(t,e,i){this._applyTex(t,this.textures[0],this.uniforms[0],0,e,i),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_BYTE,0)}drawGLArray(t,e,i){if(1!==t.length){for(let s=0;s<this._framebufferCount;s++)this._applyTex(t[s],this.textures[s],this.uniforms[s],s,e,i);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_BYTE,0)}else this.drawGL(t[0],e,i)}initGL(t,e={}){if(!t)return;t.style.transform="scale(1, -1)",this.canvas=t,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.uniforms=[],this.gl=t.getContext("webgl",{alpha:!1,premultipliedAlpha:!0,depth:!1,stencil:!1});const i=this._initShaderProgram(this.gl,vs,fs),s=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.gl.STATIC_DRAW),this.buffers.push(s);const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.buffers.push(r);const h=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,h),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,2,1,3]),this.gl.STATIC_DRAW),this.buffers.push(h);let l=this.gl.getUniformLocation(i,"framebuffer1");this.uniforms.push(l);let a=this.gl.getUniformLocation(i,"framebuffer2");this.uniforms.push(a);let g=e.width||t.width,n=e.height||t.height;for(let t=0;t<this._framebufferCount;t++){const e=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,g,n,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.textures.push(e)}this.gl.viewport(0,0,g,n);const o=this.gl.getAttribLocation(i,"pos"),f=this.gl.getAttribLocation(i,"uv");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.enableVertexAttribArray(o),this.gl.vertexAttribPointer(o,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.enableVertexAttribArray(f),this.gl.vertexAttribPointer(f,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,h),this.gl.useProgram(i)}destroyGL(){this.buffers.forEach(t=>this.gl.deleteBuffer(t)),this.textures.forEach(t=>this.gl.deleteTexture(t)),this.shaders.forEach(t=>this.gl.deleteShader(t)),this.programs.forEach(t=>this.gl.deleteProgram(t)),this.gl&&this.gl.getExtension("WEBGL_lose_context")&&this.gl.getExtension("WEBGL_lose_context").loseContext()}_initShaderProgram(t,e,i){const s=this._loadShader(t,t.VERTEX_SHADER,e),r=this._loadShader(t,t.FRAGMENT_SHADER,i),h=t.createProgram();return t.attachShader(h,s),t.attachShader(h,r),t.linkProgram(h),t.getProgramParameter(h,t.LINK_STATUS)?(this.programs.push(h),h):(console.warn("Unable to initialize the shader program: "+t.getProgramInfoLog(h)),t.deleteProgram(h),null)}_loadShader(t,e,i){const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?(this.shaders.push(s),s):(console.warn("An error occurred compiling the shaders: "+t.getShaderInfoLog(s)),t.deleteShader(s),null)}}exports.default=GlPreview;