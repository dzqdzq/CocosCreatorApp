"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const electron_base_ipc_1=require("@base/electron-base-ipc");function DebugUV(t,e=1024){const i={x:0,y:0},r=[{x:0,y:0},{x:0,y:0},{x:0,y:0}],s=[],h=document.createElement("canvas"),a=e,l=e;h.width=a,h.height=l;const n=h.getContext("2d");n.lineWidth=.3,n.strokeStyle="#F8D299",n.textAlign="center",n.fillStyle="#353535",n.fillRect(0,0,a,l);const g=t.index||t.buffer,o=t.buffer,u=t.format.count,f=Object.keys(g).length;for(let t=0;t<f;t+=3)s[0]=g[t],s[1]=g[t+1],s[2]=g[t+2],r[0].x=o[s[0]*u],r[0].y=o[s[0]*u+1],r[1].x=o[s[1]*u],r[1].y=o[s[1]*u+1],r[2].x=o[s[2]*u],r[2].y=o[s[2]*u+1],c(r);return h;function c(t){n.beginPath(),i.x=0,i.y=0;for(let e=0,r=t.length;e<r;e++){const r=t[e];i.x+=r.x,i.y+=r.y,0===e?n.moveTo(r.x*(a-2)+.5,(1-r.y)*(l-2)+.5):n.lineTo(r.x*(a-2)+.5,(1-r.y)*(l-2)+.5)}n.closePath(),n.stroke()}}class GlPreview{constructor(t,e){this.gl=null,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.uniforms={framebufferLoc1:null},this._framebufferCount=1,this.initialized=!1,this._registerName=t,this._name=e}set isMulFramebuffer(t){this._framebufferCount=t?2:1}get isMulFramebuffer(){return 2===this._framebufferCount}async init(t){var e,i;t||(t={width:(null===(e=this.canvas)||void 0===e?void 0:e.width)||100,height:(null===(i=this.canvas)||void 0===i?void 0:i.height)||100}),(0,electron_base_ipc_1.sendToChannel)(this._registerName,this._name,{width:t.width,height:t.height}),this.initialized=!0}_applyTex(t,e,i,r,s,h){this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(i,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s,h,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t)}computedUV(t,e,i){var r;t||(t=[]),t.format&&t.format.count||console.warn("cannot get uv count");const s=DebugUV(t,Math.min(e,i)),h=null===(r=s.getContext("2d"))||void 0===r?void 0:r.getImageData(0,0,s.width,s.height),a=document.createElement("canvas");a.width=e,a.height=i;const l=a.getContext("2d");return l.fillStyle="rgb(71, 71, 71)",l.fillRect(0,0,e,i),l.putImageData(h,(e-Math.min(e,s.width))/2,(i-Math.min(i,s.height))/2),{buffer:l.getImageData(0,0,e,i).data,width:e,height:i}}queryPreviewData(t){var e,i;return t||(t={width:(null===(e=this.canvas)||void 0===e?void 0:e.width)||100,height:(null===(i=this.canvas)||void 0===i?void 0:i.height)||100}),new Promise((e,i)=>{(0,electron_base_ipc_1.sendToChannel)(this._registerName,this._name,{width:t.width,height:t.height}).option({original:!0}).callback((t,r)=>{if(t)return i(t);e(r)})})}resizeGL(t,e){this.gl&&(this.gl.viewport(0,0,t,e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,e,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null))}drawGL(t){this.gl&&(this._applyTex(t.buffer,this.textures[0],this.uniforms.framebufferLoc1,0,t.width,t.height),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_BYTE,0))}async getContext(t){let e;try{if(!(e=t.getContext("webgl",{alpha:!1,depth:!1,antialias:!0}))){for(let i=0;i<3;i++)if(e=await new Promise(e=>{setTimeout(()=>{e(t.getContext("webgl",{alpha:!1,depth:!1,antialias:!0}))},100)}))return e;throw new Error("cannot get webgl context")}}catch(t){console.error(t)}return e}async initGL(t,e={}){if(!t)return;this.canvas=t,this.buffers=[],this.textures=[],this.shaders=[],this.programs=[],this.gl=await this.getContext(t);const i=this._initShaderProgram(this.gl,"attribute vec3 pos;\nattribute vec2 uv;\nvarying vec2 v_uv;\nvoid main () {\n    gl_Position = vec4(pos, 1.0);\n    v_uv = uv;\n}","precision highp float;\nvarying vec2 v_uv;\nuniform sampler2D framebuffer1;\nvoid main () {\n    gl_FragColor = texture2D(framebuffer1, v_uv);\n}"),r=[-1,-1,1,-1,-1,1,1,1],s=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW),this.buffers.push(s);const h=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.buffers.push(h);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,2,3,3,1,0]),this.gl.STATIC_DRAW),this.buffers.push(a),this.uniforms.framebufferLoc1=this.gl.getUniformLocation(i,"framebuffer1"),t.width=e.width,t.height=e.height;const l=e.width||t.width,n=e.height||t.height;for(let t=0;t<this._framebufferCount;t++){const e=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,l,n,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.textures.push(e)}this.gl.viewport(0,0,l,n);const g=this.gl.getAttribLocation(i,"pos"),o=this.gl.getAttribLocation(i,"uv");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.enableVertexAttribArray(g),this.gl.vertexAttribPointer(g,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h),this.gl.enableVertexAttribArray(o),this.gl.vertexAttribPointer(o,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,a),this.gl.useProgram(i)}destroyGL(){this.buffers.forEach(t=>this.gl.deleteBuffer(t)),this.textures.forEach(t=>this.gl.deleteTexture(t)),this.shaders.forEach(t=>this.gl.deleteShader(t)),this.programs.forEach(t=>this.gl.deleteProgram(t)),this.gl&&this.gl.getExtension("WEBGL_lose_context")&&this.gl.getExtension("WEBGL_lose_context").loseContext()}_initShaderProgram(t,e,i){const r=this._loadShader(t,t.VERTEX_SHADER,e),s=this._loadShader(t,t.FRAGMENT_SHADER,i),h=t.createProgram();return t.attachShader(h,r),t.attachShader(h,s),t.linkProgram(h),t.getProgramParameter(h,t.LINK_STATUS)?(this.programs.push(h),h):(console.warn("Unable to initialize the shader program: "+t.getProgramInfoLog(h)),t.deleteProgram(h),null)}_loadShader(t,e,i){const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?(this.shaders.push(r),r):(console.warn("An error occurred compiling the shaders: "+t.getShaderInfoLog(r)),t.deleteShader(r),null)}}exports.default=GlPreview;