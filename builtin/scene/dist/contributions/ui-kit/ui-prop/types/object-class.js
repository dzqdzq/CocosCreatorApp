"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const dum_element_base_1=require("../dum-element-base"),utils_1=require("../utils"),i18nPrefix="i18n:";class ObjectClass extends dum_element_base_1.DumpElementBase{constructor(){super(...arguments),this.type=["cc.Object"],this.$section=null,this.$type=null,this.$help=null,this.$propList={},this.$groups={},this._listeners=[],this.template=`
        <ui-section expand>
            <div slot="header" style="overflow: hidden;">
                <ui-label name style="white-space: nowrap;"></ui-label>
                <ui-label type style="white-space: nowrap;opacity: 0.55;margin-left: 4px;flex:auto;font-weight:normal;"></ui-label>
                <ui-link style="display: none" tooltip="i18n:scene.menu.help_url">
                    <ui-icon value="help"><ui-icon>
                </ui-link>
            </div>
        </ui-section>`,this.style=":host { margin-left: 0; }"}parseAndSetData(s,i){return Object.keys(s).forEach(e=>{var t=s[e];i.value[e]&&t.type===i.value[e].type&&(i.value[e]=JSON.parse(JSON.stringify(t)))}),!0}queryParentCacheExpend(e,t){var s="cache-expand";let i=e;for(;i;){if(i.hasAttribute(s))return i.getAttribute(s)||"";i=i.parentElement}return t}toggleGroup(){for(const e in this.$groups)"section"===this.$groups[e].dump.style&&this.$groups[e].querySelectorAll(".ui-prop-group-content").forEach(e=>{Array.from(e.querySelectorAll(":scope > ui-prop")).some(e=>"none"!==getComputedStyle(e).display)?e.removeAttribute("hidden"):e.setAttribute("hidden","")}),"tab"===this.$groups[e].dump.style&&(Array.from(this.$groups[e].querySelectorAll(".tab-content > ui-prop")).some(e=>"none"!==getComputedStyle(e).display)?this.$groups[e].removeAttribute("hidden"):this.$groups[e].setAttribute("hidden",""))}createGroup(e){var t=document.createElement("div");return t.setAttribute("class","ui-prop-group"),t.dump=e,t.names={},t.displayOrder=e.displayOrder,t}createTabGroup(e){const s=document.createElement("div");function t(e){const t=Object.keys(s.tabs)[e];s.childNodes.forEach(e=>{e.classList.contains("tab-content")&&(e.getAttribute("name")===t?e.style.display="block":e.style.display="none")})}return s.setAttribute("class","tab-group"),s.dump=e,s.tabs={},s.displayOrder=e.displayOrder,s.$header=document.createElement("ui-tab"),s.$header.setAttribute("class","tab-header"),s.appendChild(s.$header),s.$header.addEventListener("change",e=>{t(e.target.value)}),setTimeout(()=>{t(0)}),s}getName(e){return(0,utils_1.getNameByDump)(e)}appendToGroup(t,s){if(!t.names[s]){var i=document.createElement("ui-section"),r=(i.setAttribute("class","ui-prop-group-content"),i.setAttribute("expand",""),this.queryParentCacheExpend(t,"ui-prop-group-content")),r=(i.setAttribute("cache-expand",r+"-"+s),document.createElement("ui-label"));r.setAttribute("slot","header");let e=s;e=e.startsWith(i18nPrefix)?this.getName({displayName:s}):this.getName({name:s}),r.setAttribute("value",e),i.appendChild(r),t.appendChild(i),t.names[s]=i}}appendToTabGroup(t,s){if(!t.tabs[s]){var i=document.createElement("div"),i=((t.tabs[s]=i).setAttribute("class","tab-content"),i.setAttribute("name",s),t.appendChild(i),document.createElement("ui-label"));let e=s;e=e.startsWith(i18nPrefix)?this.getName({displayName:s}):this.getName({name:s}),i.setAttribute("value",e);var r=document.createElement("ui-button");r.setAttribute("name",s),r.appendChild(i),t.$header.appendChild(r)}}appendChildByDisplayOrder(e,t){const s=t.displayOrder||0;var i=Array.from(e.children).find(e=>e.dump&&e.displayOrder>s?e:null);i?i.before(t):e.appendChild(t)}mounted(e){this.$section=e.querySelector("ui-section"),this.$label=e.querySelector("ui-label[name]"),this.$type=e.querySelector("ui-label[type]"),this.$help=e.querySelector("ui-link")}ready(){super.ready(),this.$help&&this.$help.addEventListener("click",e=>e.stopPropagation())}update(p){if(super.update(p),this.$parentElement&&this.$section){this.$type&&(this.$type.value=": "+p.type),this.$parentElement.setAttribute("no-label","");var e,t=p.path||p.name+":"+p.type,s=this.queryParentCacheExpend(this.$parentElement,"root"),t=(this.$section.setAttribute("cache-expand",s+"-"+t),this.$parentElement.hasAttribute("ui-section-config")&&this.$section.setAttribute("class","config"),p.help&&this.$help&&(this.$help.value=p.help,this.$help.style.display="flex",null!=(s=p.editor))&&s.help&&(this.$help.helpData=p.editor),Object.keys(this.$propList));const l=[];Object.keys(p.value).forEach((t,s)=>{var i,r,a=p.value[t];if(a.visible&&this.$section){l.push(t);let e=this.$propList[t];e?e.isConnected&&e.parentElement||(a.group&&p.groups?({id:i="default",name:r}=a.group,this.appendChildByDisplayOrder(this.$groups[i].names[r],e)):this.appendChildByDisplayOrder(this.$section,e)):((e=document.createElement("ui-prop")).setAttribute("type","dump"),this.$propList[t]=e,t=null!=(r=null==(i=a.group)?void 0:i.displayOrder)?r:a.displayOrder,e.displayOrder=void 0===t?s:Number(t),a.group&&p.groups?({id:i="default",name:r}=a.group,!this.$groups[i]&&p.groups[i]&&("tab"===p.groups[i].style?this.$groups[i]=this.createTabGroup(p.groups[i]):"section"===p.groups[i].style&&(this.$groups[i]=this.createGroup(p.groups[i]))),this.$groups[i]&&(this.$groups[i].isConnected||this.appendChildByDisplayOrder(this.$section,this.$groups[i]),"tab"===p.groups[i].style?this.appendToTabGroup(this.$groups[i],r):"section"===p.groups[i].style&&this.appendToGroup(this.$groups[i],r)),"tab"===p.groups[i].style?this.appendChildByDisplayOrder(this.$groups[i].tabs[r],e):"section"===p.groups[i].style&&this.appendChildByDisplayOrder(this.$groups[i].names[r],e)):this.appendChildByDisplayOrder(this.$section,e)),e.render(a),(0,utils_1.setElementReadonly)(a,e)}});for(const i of t)l.includes(i)||(e=this.$propList[i])&&e.parentElement&&e.parentElement.removeChild(e);this.toggleGroup()}}close(){for(const e in this.$groups)this.$groups[e].remove();this.$groups={},this.$propList={}}}exports.default=ObjectClass;