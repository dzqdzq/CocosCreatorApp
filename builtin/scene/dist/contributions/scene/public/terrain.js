"use strict";var ToolMode,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,n)}:function(e,t,o,r){e[r=void 0===r?o:r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.changePaint=exports.changeSculpt=exports.changeSculptMode=exports.changeInfo=exports.removeLayer=exports.changeLayer=exports.setLayer=exports.setPaintBrush=exports.setSculptBrushRotation=exports.setSculptBrush=exports.createLayer=exports.changeMode=exports.getBlockLayers=exports.getLayers=exports.close=exports.removeConfigByNodeID=exports.save=exports.select=exports.setCurrLayer=exports.getCurrLayer=exports.init=exports.off=exports.on=exports.layerDatas=exports.paint=exports.paint_brush=exports.sculpt_brush_rotate=exports.sculpt_brush=exports.sculpt=exports.info=exports.component=exports.uuid=exports.mode=exports.ToolMode=void 0;const DefaultLayerUuid="52ef29ed-bd92-4e94-ab2f-0ebc91bf3a60@6c48a",events_1=require("events");!function(e){e[e.SELECT=0]="SELECT",e[e.SCULPTUP=1]="SCULPTUP",e[e.SCULPTDOWN=2]="SCULPTDOWN",e[e.SMOOTH=3]="SMOOTH",e[e.PAINT=4]="PAINT",e[e.BLOCK=5]="BLOCK",e[e.FLATTEN=6]="FLATTEN",e[e.SETHEIGHT=7]="SETHEIGHT"}(ToolMode=exports.ToolMode||(exports.ToolMode={})),exports.mode=ToolMode.SELECT,exports.uuid="",exports.component=null,exports.info=null,exports.sculpt=null,exports.sculpt_brush=null,exports.sculpt_brush_rotate=0,exports.paint_brush=null,exports.paint=null;let currentLayer=-1,isSculptChange=!1,isPaintChange=!1,$scene;const eventEmitter=new events_1.EventEmitter;function on(e,t){eventEmitter.on(e,t)}function off(e,t){eventEmitter.removeListener(e,t)}async function getConfig(e,t){return Editor.Profile.getConfig("scene",`terrain-float-window.${e}.`+t)}async function setConfig(e,t,o){return Editor.Profile.setConfig("scene",`terrain-float-window.${e}.`+t,o)}async function removeConfig(e,t){return Editor.Profile.removeConfig("scene","terrain-float-window."+(t?e+"."+t:"uuid"))}async function init(e){$scene=e}function generateMethodParams(e,t,o=[]){return{uuid:e,name:t,args:o}}function getCurrLayer(){return currentLayer}function setCurrLayer(e){currentLayer=e}async function select(e){e&&exports.uuid;e&&(exports.uuid=e),exports.uuid&&(exports.component=await $scene.callSceneMethod("queryComponent",[exports.uuid]),eventEmitter.emit("component-changed",exports.component),exports.layerDatas=await getLayers(),eventEmitter.emit("apply-layers",exports.layerDatas),exports.info=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.queryTerrainInfo")]),eventEmitter.emit("info-changed",exports.info),exports.sculpt=await getConfig(exports.uuid,"sculpt"),isSculptChange=!1,exports.sculpt?await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setBrushOfMode",[1,exports.sculpt])]):exports.sculpt=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.queryBrushOfMode",[1])]),eventEmitter.emit("sculpt-changed",exports.sculpt),exports.sculpt_brush=await getConfig(exports.uuid,"sculpt_brush")||"",exports.sculpt_brush_rotate=await getConfig(exports.uuid,"sculpt_brush_rotate")||0,eventEmitter.emit("sculpt-brush-changed",exports.sculpt_brush,exports.sculpt_brush_rotate),isSculptChange=!0,exports.paint=await getConfig(exports.uuid,"paint"),isPaintChange=!1,exports.paint?await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setBrushOfMode",[2,exports.paint])]):exports.paint=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.queryBrushOfMode",[2])]),eventEmitter.emit("paint-changed",exports.paint),isPaintChange=!0,exports.paint_brush=await getConfig(exports.uuid,"paint_brush")||"",eventEmitter.emit("paint-brush-changed",exports.paint_brush),e=await getConfig(exports.uuid,"layer")||0,eventEmitter.emit("layer_change",e))}async function save(){exports.uuid&&(exports.sculpt&&await setConfig(exports.uuid,"sculpt",{radius:exports.sculpt.radius,strength:exports.sculpt.strength,_setHeight:exports.sculpt._setHeight}),exports.paint&&await setConfig(exports.uuid,"paint",{radius:exports.paint.radius,strength:exports.paint.strength,falloff:exports.paint.falloff}),await setConfig(exports.uuid,"sculpt_brush_rotate",exports.sculpt_brush_rotate))}async function removeConfigByNodeID(e){return console.debug("remove terrain config "+e),removeConfig(e)}async function close(){setCurrLayer(-1),save()}async function getLayers(){return await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.getLayers",[])])}async function getBlockLayers(){return await $scene.callSceneMethod("executeComponentMethod",[{uuid:exports.uuid,name:"gizmo.getBlockInfo",args:[]}])}function changeMode(e){switch(e){case ToolMode.SELECT:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[e])]);break;case ToolMode.SCULPTUP:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[1])]);break;case ToolMode.SCULPTDOWN:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[1,{isSculptDown:!0}])]);break;case ToolMode.SMOOTH:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[1,{isSmooth:!0}])]);break;case ToolMode.FLATTEN:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[1,{isFlatten:!0}])]);break;case ToolMode.SETHEIGHT:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[1,{isSetHeight:!0}])]);break;case ToolMode.PAINT:case ToolMode.BLOCK:$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditMode",[e-2])])}exports.mode=e,eventEmitter.emit("mode-changed",exports.mode)}async function createLayer(e){void 0===e&&(e=DefaultLayerUuid);e=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.addLayerByUuid",[e])]);return exports.layerDatas=await getLayers(),eventEmitter.emit("apply-layers",exports.layerDatas),e}async function setSculptBrush(e){var t=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setSculptBrush",[e])]);return await setConfig(exports.uuid,"sculpt_brush",e),t}async function setSculptBrushRotation(e){var t;if(isSculptChange)return t=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setSculptBrushRotation",[e])]),exports.sculpt_brush_rotate=e,save(),t}async function setPaintBrush(e){var t=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setPaintBrush",[e])]);return await setConfig(exports.uuid,"paint_brush",e),t}async function setLayer(e,t,n){var s=exports.layerDatas[e];if(-1!==e){if(void 0===t&&(t=s?s.detailMap:DefaultLayerUuid),void 0===n){let e=1,t=.1,o=.1,r=null;s&&(e=s.tileSize,t=s.metallic,o=s.roughness,r=s.normalMap||null),n={tileSize:e,metallic:t,roughness:o,normalMap:r}}s=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setLayerValue",[e,t,n])]);return exports.layerDatas=await getLayers(),eventEmitter.emit("apply-layers",exports.layerDatas),s}}async function changeLayer(e){if(0<=e&&e!==currentLayer)return setCurrLayer(e),setConfig(exports.uuid,"layer",e),await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setCurrentEditLayer",[e])])}async function removeLayer(e){await getConfig(exports.uuid,"layer")===e&&await removeConfig(exports.uuid,"layer");e=await $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.removeLayerByIndex",[e])]);return exports.layerDatas=await getLayers(),eventEmitter.emit("apply-layers",exports.layerDatas),e}async function changeInfo(e){for(const t in e)exports.info&&"object"==typeof exports.info&&t in exports.info&&(exports.info[t]=e[t]);return $scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.changeTerrainInfo",[exports.info])])}async function changeSculptMode(e){changeMode(e)}async function changeSculpt(e,o){if(exports.sculpt&&isSculptChange){let t=exports.sculpt;var e=e.split("."),r=e.pop();if(r)return e.length&&e.forEach(e=>{t=t&&t[e]}),t[r]=o,save(),$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setBrushOfMode",[1,exports.sculpt])])}}async function changePaint(e,o){if(exports.paint&&isPaintChange){let t=exports.paint;var e=e.split("."),r=e.pop();if(r)return e.length&&e.forEach(e=>{t=t&&t[e]}),t[r]=o,save(),$scene.callSceneMethod("executeComponentMethod",[generateMethodParams(exports.uuid,"gizmo.setBrushOfMode",[2,exports.paint])])}}exports.on=on,exports.off=off,exports.init=init,exports.getCurrLayer=getCurrLayer,exports.setCurrLayer=setCurrLayer,exports.select=select,exports.save=save,exports.removeConfigByNodeID=removeConfigByNodeID,exports.close=close,exports.getLayers=getLayers,exports.getBlockLayers=getBlockLayers,exports.changeMode=changeMode,exports.createLayer=createLayer,exports.setSculptBrush=setSculptBrush,exports.setSculptBrushRotation=setSculptBrushRotation,exports.setPaintBrush=setPaintBrush,exports.setLayer=setLayer,exports.changeLayer=changeLayer,exports.removeLayer=removeLayer,exports.changeInfo=changeInfo,exports.changeSculptMode=changeSculptMode,exports.changeSculpt=changeSculpt,exports.changePaint=changePaint,exports.default=__importStar(require("./terrain"));