"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.update=exports.close=exports.ready=exports.template=exports.height=exports.width=exports.type=void 0;const path_1=require("path"),fs_1=require("fs"),utils_1=require("./utils"),terrain_1=__importDefault(require("../../public/terrain")),Vue=require("vue/dist/vue");let panel,vm=null,cacheInfoForReset={};exports.type="cc.Terrain";const layerLength=4;async function ready(e,t,r){if((panel=e).hidden=!0,t.nodes.length>1)return removeListener(),void terrain_1.default.close();const a=e.querySelector(".scene-terrain");(vm=new Vue({el:a,data:{mode:terrain_1.default.mode<1?0:terrain_1.default.mode<4?1:2,info:{tileSize:0,weightMapSize:0,lightMapSize:0,blockCount:[0,0],isChanged:!1},sculpt:{radius:0,strength:0,mode:1,brushes:[],currBrush:null},paint:{radius:0,strength:0,falloff:0,brushes:[],currBrush:null,paintNorMap:""},select:0,layers:[]},components:{texture:{template:'\n<ui-drag-area droppable="cc.Texture2D"\n    @drop="_onDrop($event)"\n>\n    <img :src="src" @click="_onImgClick()"/>\n</ui-drag-area>\n',props:["layer","index"],data:()=>({src:""}),watch:{async layer(e){this.update()}},methods:{async update(){const e=this.layer.uuid,t=await Editor.Message.request("asset-db","query-asset-meta",e);this.src=t?await utils_1.getImageLikeAssetSource(t):""},_onImgClick(){this.$parent.$emit("select-layer",this.index)},_onDrop(e){e.stopPropagation();let t=e.dataTransfer.getData("value");if(!t)return;if(t&&-1!==t.indexOf("@")&&-1===t.indexOf("@6c48a"))return void console.warn("Terrain can't recognize texture without entity, ( FBX, gltf )");const r=this.index;terrain_1.default.setLayer(r,t)}},async mounted(){this.update()}}},methods:{changeToolMode(e){2===(e-=0)?e=4:1===e&&(e=vm.sculpt.mode),terrain_1.default.changeMode(e)},changeLayer(e){terrain_1.default.changeLayer(e)},setLayerTileSize(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{tileSize:e})},setLayerMetallic(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{metallic:e})},setLayerRoughness(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{roughness:e})},setLayerTexture(e){const t=this.select;terrain_1.default.setLayer(t,e,void 0)},setLayerNormalMap(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{normalMap:e})},setSculptBrush(e){terrain_1.default.setSculptBrush(e)},setPaintBrush(e){terrain_1.default.setPaintBrush(e)},createLayer(){vm.validLayerCount()>=layerLength||terrain_1.default.createLayer()},removeLayer(e){terrain_1.default.removeLayer(e)},changeInfo(){vm.info.isChanged||(vm.info.isChanged=!0)},resetInfos(){listeners.info(cacheInfoForReset),vm.info.isChanged=!1},applyInfos(){terrain_1.default.changeInfo(vm.info),vm.info.isChanged=!1},changeSculpt(e,t){terrain_1.default.changeSculpt(e,t)},changeSculptMode(e){vm.sculpt.mode=e,terrain_1.default.changeSculptMode(e)},changePaint(e,t){terrain_1.default.changePaint(e,t)},validLayerCount(){let e=0;for(let t=0;t<vm.layers.length;t++)null!==vm.layers[t]&&e++;return e},async _onLayerDrop(e){if(vm.validLayerCount()>=layerLength)return;let t=e.dataTransfer.getData("value");t&&(/@/.test(t)||(t+="@6c48a"),terrain_1.default.createLayer(t))}}})).$on("select-layer",e=>{vm.select=e,terrain_1.default.currLayer=e,vm.changeLayer(e)}),terrain_1.default.on("mode-changed",listeners.mode),terrain_1.default.on("component-changed",listeners.component),terrain_1.default.on("info-changed",listeners.info),terrain_1.default.on("sculpt-changed",listeners.sculpt),terrain_1.default.on("paint-changed",listeners.paint),terrain_1.default.on("layer_change",listeners.layer),terrain_1.default.on("sculpt-brush-changed",listeners.sculpt_brush),terrain_1.default.on("paint-brush-changed",listeners.paint_brush),terrain_1.default.on("apply-layers",listeners.apply_layers)}exports.width=250,exports.height=300,exports.template=fs_1.readFileSync(path_1.join(__dirname,"./index.html"),"utf-8"),exports.ready=ready;const listeners={mode(e){e<1?vm.mode=0:e<4?(vm.sculpt.mode=e,vm.mode=1):vm.mode=2},apply_layers(e){if(Array.isArray(e)&&(vm.layers=[],e.length>0))for(let t=0;t<=layerLength;t++){let r=null;e[t]&&e[t].detailMap&&(r={uuid:e[t].detailMap,tileSize:e[t].tileSize,normalMap:e[t].normalMap?e[t].normalMap:"",metallic:e[t].metallic,roughness:e[t].roughness}),vm.layers.push(r)}},layer(e){vm.$emit("select-layer",e)},component(e){!e||e&&!e.value._asset.value.uuid?panel.hidden=!0:panel.hidden=!1},info(e){e&&(cacheInfoForReset=e,vm.info.tileSize=e.tileSize,vm.info.weightMapSize=e.weightMapSize,vm.info.lightMapSize=e.lightMapSize,vm.info.blockCount[0]=e.blockCount[0],vm.info.blockCount[1]=e.blockCount[1])},sculpt(e){e&&(vm.sculpt.radius=e.radius,vm.sculpt.strength=e.strength)},sculpt_brush(e){e!==vm.sculpt.currBrush&&(vm.sculpt.currBrush=e,vm.setSculptBrush(e))},paint_brush(e){e!==vm.paint.currBrush&&(vm.paint.currBrush=e,vm.setPaintBrush(e))},paint(e){e&&(vm.paint.radius=e.radius,vm.paint.strength=e.strength,vm.paint.falloff=e.falloff)}};function removeListener(){terrain_1.default.off("mode-changed",listeners.mode),terrain_1.default.off("component-changed",listeners.component),terrain_1.default.off("info-changed",listeners.info),terrain_1.default.off("sculpt-changed",listeners.sculpt),terrain_1.default.off("paint-changed",listeners.paint),terrain_1.default.off("layer_change",listeners.layer),terrain_1.default.off("sculpt-brush-changed",listeners.sculpt_brush),terrain_1.default.off("paint-brush-changed",listeners.paint_brush),terrain_1.default.off("apply-layers",listeners.apply_layers)}async function close(){removeListener(),terrain_1.default.close()}function update(e,t){terrain_1.default.select()}exports.close=close,exports.update=update,exports.default=module.exports;