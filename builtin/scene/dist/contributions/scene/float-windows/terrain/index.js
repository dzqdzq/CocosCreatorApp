"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.send=exports.update=exports.close=exports.ready=exports.template=exports.height=exports.width=exports.type=void 0;const path_1=require("path"),fs_1=require("fs"),terrain_1=__importDefault(require("../../public/terrain")),texture_1=require("./texture"),Vue=require("vue/dist/vue.js");Vue.config.productionTip=!1,Vue.config.devtools=!1;let panel=null,vm=null,cacheInfoForReset={};const Listeners={mode(e){if(vm)switch(e){case 0:vm.mode=0;break;case 1:case 2:case 3:case 6:case 7:vm.sculpt.mode=e,vm.mode=1;break;case 4:vm.mode=2;break;default:vm.mode=3}},apply_layers(e){if(Array.isArray(e)&&vm&&(vm.layers=[],e.length>0))for(let t=0;t<=layerLength;t++){let r=null;e[t]&&e[t].detailMap&&(r={uuid:e[t].detailMap,tileSize:e[t].tileSize,normalMap:e[t].normalMap?e[t].normalMap:"",metallic:e[t].metallic,roughness:e[t].roughness}),vm.layers.push(r)}},layer(e){vm&&vm.$emit("select-layer",e)},component(e){panel&&(!e||e&&!e.value._asset.value.uuid?panel.hidden=!0:panel.hidden=!1)},info(e){e&&vm&&(cacheInfoForReset=e,vm.info.tileSize=e.tileSize,vm.info.weightMapSize=e.weightMapSize,vm.info.lightMapSize=e.lightMapSize,vm.info.blockCount[0]=e.blockCount[0],vm.info.blockCount[1]=e.blockCount[1])},sculpt(e){e&&vm&&(vm.sculpt.radius=e.radius,vm.sculpt.strength=e.strength,vm.sculpt._setHeight=e._setHeight)},sculpt_brush(e,t){vm&&(e!==vm.sculpt.currBrush&&(vm.sculpt.currBrush=e,vm.setSculptBrush(e)),t!==vm.sculpt.rotation&&(vm.sculpt.rotation=t,vm.setSculptBrushRotation(t)))},paint_brush(e){vm&&e!==vm.paint.currBrush&&(vm.paint.currBrush=e,vm.setPaintBrush(e))},paint(e){vm&&e&&(vm.paint.radius=e.radius,vm.paint.strength=e.strength,vm.paint.falloff=e.falloff)}};exports.type="cc.Terrain";const layerLength=4;exports.width=250,exports.height=300;const vueTemplate=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"./index.html"),"utf-8"),SceneTerrainVM=Vue.extend({name:"SceneTerrainVM",components:{texture:texture_1.Texture},data:()=>({mode:terrain_1.default.mode<1?0:terrain_1.default.mode<4?1:terrain_1.default.mode<5?2:3,info:{tileSize:0,weightMapSize:0,lightMapSize:0,blockCount:[0,0],isChanged:!1},sculpt:{radius:0,strength:0,_setHeight:0,mode:1,brushes:[],currBrush:"",rotation:0},paint:{radius:0,strength:0,falloff:0,brushes:[],currBrush:"",paintNorMap:""},select:0,layers:[],block:{index:{x:0,y:0},weight:"",layers:[]}}),watch:{mode(e){3===e&&send({action:"block-update"})}},methods:{changeToolMode(e){switch(e-=0){case 0:terrain_1.default.changeMode(0);break;case 1:terrain_1.default.changeMode(vm.sculpt.mode);break;case 2:terrain_1.default.changeMode(4);break;case 3:terrain_1.default.changeMode(5)}},changeLayer(e){terrain_1.default.changeLayer(e)},setLayerTileSize(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{tileSize:e})},setLayerMetallic(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{metallic:e})},setLayerRoughness(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{roughness:e})},setLayerTexture(e){const t=this.select;terrain_1.default.setLayer(t,e,void 0)},setLayerNormalMap(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{normalMap:e})},setSculptBrush(e){terrain_1.default.setSculptBrush(e)},setSculptBrushRotation(e){terrain_1.default.setSculptBrushRotation(e-0)},setPaintBrush(e){terrain_1.default.setPaintBrush(e)},createLayer(){vm.validLayerCount()>=layerLength||terrain_1.default.createLayer()},removeLayer(e){terrain_1.default.removeLayer(e)},changeInfo(){vm.info.isChanged||(vm.info.isChanged=!0)},resetInfos(){Listeners.info(cacheInfoForReset),vm.info.isChanged=!1},applyInfos(){terrain_1.default.changeInfo(vm.info),vm.info.isChanged=!1},changeSculpt(e,t){terrain_1.default.changeSculpt(e,t)},changeSculptMode(e){vm.sculpt.mode=e,terrain_1.default.changeSculptMode(e)},changePaint(e,t){terrain_1.default.changePaint(e,t)},validLayerCount(){let e=0;for(let t=0;t<vm.layers.length;t++)null!==vm.layers[t]&&e++;return e},async _onLayerDrop(e){const t=this.$refs.area;if(!t||t.hasAttribute("hoving"))return;if(this.validLayerCount()>=layerLength)return;let r=e.dataTransfer.getData("value");r&&(/@/.test(r)||(r+="@6c48a"),terrain_1.default.createLayer(r))}},template:vueTemplate});function ready(e,t,r){if((panel=e).hidden=!0,t.nodes.length>1)return void close();const a=e.querySelector(".scene-terrain");null===vm||void 0===vm||vm.$destroy(),(vm=new SceneTerrainVM).$mount(a),vm.$on("select-layer",e=>{vm.select=e,terrain_1.default.setCurrLayer(Number(e)),vm.changeLayer(e)}),terrain_1.default.on("mode-changed",Listeners.mode),terrain_1.default.on("component-changed",Listeners.component),terrain_1.default.on("info-changed",Listeners.info),terrain_1.default.on("sculpt-changed",Listeners.sculpt),terrain_1.default.on("paint-changed",Listeners.paint),terrain_1.default.on("layer_change",Listeners.layer),terrain_1.default.on("sculpt-brush-changed",Listeners.sculpt_brush),terrain_1.default.on("paint-brush-changed",Listeners.paint_brush),terrain_1.default.on("apply-layers",Listeners.apply_layers),terrain_1.default.component&&Listeners.component(terrain_1.default.component),terrain_1.default.layerDatas&&Listeners.apply_layers(terrain_1.default.layerDatas),terrain_1.default.info&&Listeners.info(terrain_1.default.info),terrain_1.default.sculpt&&Listeners.sculpt(terrain_1.default.sculpt),terrain_1.default.paint&&Listeners.paint(terrain_1.default.paint),Listeners.sculpt_brush(terrain_1.default.sculpt_brush,terrain_1.default.sculpt_brush_rotate),terrain_1.default.paint_brush&&Listeners.paint_brush(terrain_1.default.paint_brush),Listeners.layer(terrain_1.default.getCurrLayer())}function close(){terrain_1.default.off("mode-changed",Listeners.mode),terrain_1.default.off("component-changed",Listeners.component),terrain_1.default.off("info-changed",Listeners.info),terrain_1.default.off("sculpt-changed",Listeners.sculpt),terrain_1.default.off("paint-changed",Listeners.paint),terrain_1.default.off("layer_change",Listeners.layer),terrain_1.default.off("sculpt-brush-changed",Listeners.sculpt_brush),terrain_1.default.off("paint-brush-changed",Listeners.paint_brush),terrain_1.default.off("apply-layers",Listeners.apply_layers),terrain_1.default.close(),null===vm||void 0===vm||vm.$destroy(),vm=null,panel=null}function update(){terrain_1.default.select()}function send(e){window.requestIdleCallback(async()=>{if("block-update"===e.action){const e=await terrain_1.default.getBlockLayers();if(vm&&e)if(vm.block.index.x=e.index.x,vm.block.index.y=e.index.y,vm.block.layers=e.layers,e.weight){const t=70,r=4,a=e.weight.width,n=e.weight.height,i=a*n*r,s=new Uint8Array(t+i),o=new DataView(s.buffer);o.setUint16(0,16973,!1),o.setUint32(2,s.length,!0),o.setUint32(10,t,!0),o.setUint32(14,40,!0),o.setInt32(18,a,!0),o.setInt32(22,-n,!0),o.setUint16(26,1,!0),o.setUint16(28,8*r,!0),o.setUint32(30,6,!0),o.setUint32(34,i,!0),o.setInt32(38,0,!0),o.setInt32(42,0,!0),o.setUint32(46,0,!0),o.setUint32(50,0,!0),o.setUint32(54,255,!0),o.setUint32(58,65280,!0),o.setUint32(62,16711680,!0),o.setUint32(66,4278190080,!0);const l=t;for(let t=0;t<a*n;++t){const a=e.weight.data[4*t+0],n=e.weight.data[4*t+1],i=e.weight.data[4*t+2],o=e.weight.data[4*t+3];s[l+t*r+0]=a,s[l+t*r+1]=n,s[l+t*r+2]=i,s[l+t*r+3]=Math.max(o,1)}const u=new Blob([s],{type:"image/bmp"}),c=window.URL.createObjectURL(u);vm.block.weight=c}else vm.block.weight=""}})}exports.template='\n<style>\n.scene-terrain ui-prop { --left-width: 45%; margin-bottom: 4px; }\n.scene-terrain ui-asset { width: 100%; }\n.scene-terrain .buttons { display: flex; justify-content: space-around; margin-bottom: 4px; }\n.scene-terrain .buttons i { cursor: pointer; }\n.scene-terrain .row { margin-bottom: 4px; }\n.scene-terrain > header { text-align: center;margin-bottom: 8px; }\n.scene-terrain ui-prop > div[slot="content"] { display: flex; flex-wrap: wrap; width: 100%; }\n.scene-terrain ui-prop > div[slot="content"] ui-select { width: 100%; }\n.scene-terrain .layers { display: block; border: 1px solid var(--color-normal-border); border-radius: calc(var(--size-normal-radius) * 1px); padding: 0 5px; margin-bottom: 6px; }\n.scene-terrain .layers[hoving] { border-color: var(--color-active-contrast); }\n.scene-terrain .layers > header { margin-top: 8px; }\n.scene-terrain .layers > header > ui-button { line-height: 1.2; vertical-align: middle; padding: 0 2px; margin-left: 10px; font-size: 11px; }\n.scene-terrain .layers > section { margin-top: 8px; margin-bottom: 4px; }\n.scene-terrain .layers > section > ui-drag-area { overflow: hidden; display: inline-flex; width: 30px; height: 30px; border: 1px solid var(--color-normal-border); margin-right: 4px; border-radius: calc(var(--size-normal-radius) * 1px); }\n.scene-terrain .layers > section > ui-drag-area[hoving] { border-color: var(--color-active-contrast); }\n.scene-terrain .layers > section > ui-drag-area[active] { border-color: var(--color-active-contrast); }\n.scene-terrain .layers img { width: 30px; height: 30px; }\n.scene-terrain .layer > * { display: block; }\n.scene-terrain .manager-toolbar { padding-bottom: 5px; width: 100%; text-align: right; }\n.block-index { display: flex; pointer-events: none; }\n.block-index > ui-num-input { flex: 1; margin-right: 10px; }\n.scene-terrain .blocks ui-prop { --left-width: 35%; }\n.scene-terrain .block-weight ui-image { display: inline-block; border: none; overflow: hidden; width: 32px; height: 32px; margin-right: 4px; pointer-events: none; border-radius: calc(var(--size-normal-radius) * 1px); }\n.scene-terrain .block-layers .image { display: inline-block; border: none; overflow: hidden; width: 32px; height: 32px; margin-right: 4px; pointer-events: none; border-radius: calc(var(--size-normal-radius) * 1px); }\n</style>\n<div class="scene-terrain"></div>\n',exports.ready=ready,exports.close=close,exports.update=update,exports.send=send,exports.default=__importStar(require("./index"));