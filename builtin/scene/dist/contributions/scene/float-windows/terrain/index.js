"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.send=exports.update=exports.close=exports.ready=exports.template=exports.height=exports.width=exports.type=void 0;const path_1=require("path"),fs_1=require("fs"),utils_1=require("./utils"),terrain_1=__importDefault(require("../../public/terrain")),Vue=require("vue/dist/vue.js");let panel,vm=null,cacheInfoForReset={};exports.type="cc.Terrain";const layerLength=4;async function ready(e,t,r){if((panel=e).hidden=!0,t.nodes.length>1)return removeListener(),void terrain_1.default.close();const a=e.querySelector(".scene-terrain");(vm=new Vue({el:a,data:{mode:terrain_1.default.mode<1?0:terrain_1.default.mode<4?1:terrain_1.default.mode<5?2:3,info:{tileSize:0,weightMapSize:0,lightMapSize:0,blockCount:[0,0],isChanged:!1},sculpt:{radius:0,strength:0,_setHeight:0,mode:1,brushes:[],currBrush:"",rotation:0},paint:{radius:0,strength:0,falloff:0,brushes:[],currBrush:"",paintNorMap:""},select:0,layers:[],block:{index:{x:0,y:0},weight:"",layers:[]}},watch:{mode(e){3===e&&send({action:"block-update"})}},components:{texture:{template:'\n<ui-drag-area droppable="cc.Texture2D"\n    @drop="_onDrop($event)"\n>\n    <img v-if="src"\n        :src="src" \n        @click="_onImgClick()"\n    >\n</ui-drag-area>\n',props:["layer","index"],data:()=>({src:""}),watch:{layer(e){this.update()}},methods:{async update(){const e=this;if(!e.layer||!e.layer.uuid)return void(e.src="");if(e.isBusy)return;e.isBusy=!0;const t=e.layer.uuid,r=await Editor.Message.request("asset-db","query-asset-meta",t);e.src=r?await(0,utils_1.getImageLikeAssetSource)(r):"",e.isBusy=!1},_onImgClick(){this.$parent.$emit("select-layer",this.index)},_onDrop(e){e.stopPropagation();const t=e.dataTransfer.getData("additional");if(t)try{const e=JSON.parse(t);if(!Array.isArray(e)||!e[0])return;const r=e[0].value;if(!r||-1===r.indexOf("@")||-1===r.indexOf("@6c48a"))return void console.warn("Terrain Layer need cc.Texture2D asset, and can't recognize texture without entity, which maybe from FBX or GLTF.");const a=this.index;terrain_1.default.setLayer(a,r)}catch(e){console.error(e)}}},mounted(){this.update()}}},methods:{changeToolMode(e){switch(e-=0){case 0:terrain_1.default.changeMode(0);break;case 1:terrain_1.default.changeMode(vm.sculpt.mode);break;case 2:terrain_1.default.changeMode(4);break;case 3:terrain_1.default.changeMode(5)}},changeLayer(e){terrain_1.default.changeLayer(e)},setLayerTileSize(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{tileSize:e})},setLayerMetallic(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{metallic:e})},setLayerRoughness(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{roughness:e})},setLayerTexture(e){const t=this.select;terrain_1.default.setLayer(t,e,void 0)},setLayerNormalMap(e){const t=this.select;terrain_1.default.setLayer(t,void 0,{normalMap:e})},setSculptBrush(e){terrain_1.default.setSculptBrush(e)},setSculptBrushRotation(e){terrain_1.default.setSculptBrushRotation(e-0)},setPaintBrush(e){terrain_1.default.setPaintBrush(e)},createLayer(){vm.validLayerCount()>=layerLength||terrain_1.default.createLayer()},removeLayer(e){terrain_1.default.removeLayer(e)},changeInfo(){vm.info.isChanged||(vm.info.isChanged=!0)},resetInfos(){listeners.info(cacheInfoForReset),vm.info.isChanged=!1},applyInfos(){terrain_1.default.changeInfo(vm.info),vm.info.isChanged=!1},changeSculpt(e,t){terrain_1.default.changeSculpt(e,t)},changeSculptMode(e){vm.sculpt.mode=e,terrain_1.default.changeSculptMode(e)},changePaint(e,t){terrain_1.default.changePaint(e,t)},validLayerCount(){let e=0;for(let t=0;t<vm.layers.length;t++)null!==vm.layers[t]&&e++;return e},async _onLayerDrop(e){if(!this.$refs.area.hasAttribute("hoving"))return;if(vm.validLayerCount()>=layerLength)return;let t=e.dataTransfer.getData("value");t&&(/@/.test(t)||(t+="@6c48a"),terrain_1.default.createLayer(t))}}})).$on("select-layer",e=>{vm.select=e,terrain_1.default.setCurrLayer(Number(e)),vm.changeLayer(e)}),terrain_1.default.on("mode-changed",listeners.mode),terrain_1.default.on("component-changed",listeners.component),terrain_1.default.on("info-changed",listeners.info),terrain_1.default.on("sculpt-changed",listeners.sculpt),terrain_1.default.on("paint-changed",listeners.paint),terrain_1.default.on("layer_change",listeners.layer),terrain_1.default.on("sculpt-brush-changed",listeners.sculpt_brush),terrain_1.default.on("paint-brush-changed",listeners.paint_brush),terrain_1.default.on("apply-layers",listeners.apply_layers),terrain_1.default.component&&listeners.component(terrain_1.default.component),terrain_1.default.layerDatas&&listeners.apply_layers(terrain_1.default.layerDatas),terrain_1.default.info&&listeners.info(terrain_1.default.info),terrain_1.default.sculpt&&listeners.sculpt(terrain_1.default.sculpt),terrain_1.default.paint&&listeners.paint(terrain_1.default.paint),listeners.sculpt_brush(terrain_1.default.sculpt_brush,terrain_1.default.sculpt_brush_rotate),terrain_1.default.paint_brush&&listeners.paint_brush(terrain_1.default.paint_brush),listeners.layer(terrain_1.default.getCurrLayer())}exports.width=250,exports.height=300,exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"./index.html"),"utf-8"),exports.ready=ready;const listeners={mode(e){switch(e){case 0:vm.mode=0;break;case 1:case 2:case 3:case 6:case 7:vm.sculpt.mode=e,vm.mode=1;break;case 4:vm.mode=2;break;default:vm.mode=3}},apply_layers(e){if(Array.isArray(e)&&(vm.layers=[],e.length>0))for(let t=0;t<=layerLength;t++){let r=null;e[t]&&e[t].detailMap&&(r={uuid:e[t].detailMap,tileSize:e[t].tileSize,normalMap:e[t].normalMap?e[t].normalMap:"",metallic:e[t].metallic,roughness:e[t].roughness}),vm.layers.push(r)}},layer(e){vm.$emit("select-layer",e)},component(e){!e||e&&!e.value._asset.value.uuid?panel.hidden=!0:panel.hidden=!1},info(e){e&&(cacheInfoForReset=e,vm.info.tileSize=e.tileSize,vm.info.weightMapSize=e.weightMapSize,vm.info.lightMapSize=e.lightMapSize,vm.info.blockCount[0]=e.blockCount[0],vm.info.blockCount[1]=e.blockCount[1])},sculpt(e){e&&(vm.sculpt.radius=e.radius,vm.sculpt.strength=e.strength,vm.sculpt._setHeight=e._setHeight)},sculpt_brush(e,t){e!==vm.sculpt.currBrush&&(vm.sculpt.currBrush=e,vm.setSculptBrush(e)),t!==vm.sculpt.rotation&&(vm.sculpt.rotation=t,vm.setSculptBrushRotation(t))},paint_brush(e){e!==vm.paint.currBrush&&(vm.paint.currBrush=e,vm.setPaintBrush(e))},paint(e){e&&(vm.paint.radius=e.radius,vm.paint.strength=e.strength,vm.paint.falloff=e.falloff)}};function removeListener(){terrain_1.default.off("mode-changed",listeners.mode),terrain_1.default.off("component-changed",listeners.component),terrain_1.default.off("info-changed",listeners.info),terrain_1.default.off("sculpt-changed",listeners.sculpt),terrain_1.default.off("paint-changed",listeners.paint),terrain_1.default.off("layer_change",listeners.layer),terrain_1.default.off("sculpt-brush-changed",listeners.sculpt_brush),terrain_1.default.off("paint-brush-changed",listeners.paint_brush),terrain_1.default.off("apply-layers",listeners.apply_layers)}async function close(){removeListener(),terrain_1.default.close()}function update(e,t){terrain_1.default.select()}function send(e){window.requestIdleCallback(async()=>{if("block-update"===e.action){const e=await terrain_1.default.getBlockLayers();if(e)if(vm.block.index.x=e.index.x,vm.block.index.y=e.index.y,vm.block.layers=e.layers,e.weight){const t=70,r=4,a=e.weight.width,n=e.weight.height,i=a*n*r,s=new Uint8Array(t+i),l=new DataView(s.buffer);l.setUint16(0,16973,!1),l.setUint32(2,s.length,!0),l.setUint32(10,t,!0),l.setUint32(14,40,!0),l.setInt32(18,a,!0),l.setInt32(22,-n,!0),l.setUint16(26,1,!0),l.setUint16(28,8*r,!0),l.setUint32(30,6,!0),l.setUint32(34,i,!0),l.setInt32(38,0,!0),l.setInt32(42,0,!0),l.setUint32(46,0,!0),l.setUint32(50,0,!0),l.setUint32(54,255,!0),l.setUint32(58,65280,!0),l.setUint32(62,16711680,!0),l.setUint32(66,4278190080,!0);const o=t;for(let t=0;t<a*n;++t){const a=e.weight.data[4*t+0],n=e.weight.data[4*t+1],i=e.weight.data[4*t+2],l=e.weight.data[4*t+3];s[o+t*r+0]=a,s[o+t*r+1]=n,s[o+t*r+2]=i,s[o+t*r+3]=Math.max(l,1)}const u=new Blob([s],{type:"image/bmp"}),c=window.URL.createObjectURL(u);vm.block.weight=c}else vm.block.weight=""}})}exports.close=close,exports.update=update,exports.send=send,exports.default=__importStar(require("./index"));