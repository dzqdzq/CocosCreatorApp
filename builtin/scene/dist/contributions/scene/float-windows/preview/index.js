"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.send=exports.close=exports.ready=exports.template=exports.mode=exports.dock=exports.right=exports.bottom=exports.height=exports.width=exports.type=void 0;const fs_1=require("fs"),path_1=require("path"),ElectronModule=require("@base/electron-module"),GlPreview=ElectronModule.require("PreviewExtends").default,glPreview=new GlPreview("scene:mini-preview","query-mini-preview-data");let currWidth,currHeight,cameraPreview,canvas,panel,miniPreviewInfo,previewInfo;exports.type="cc.Camera",exports.width=200,exports.height=100,exports.bottom=10,exports.right=10,exports.dock=!0,exports.mode="simple";let $scene,frameId,currIndex=0,curCameraUUID="";function applyWindowSize(){canvas&&(previewInfo&&previewInfo.width&&previewInfo.height?(currHeight=$scene.clientHeight/4,(currWidth=currHeight*(previewInfo.width/previewInfo.height))>=$scene.clientWidth/2&&(currWidth=$scene.clientWidth/2,currHeight=currWidth/(previewInfo.width/previewInfo.height))):(currHeight=$scene.clientHeight/4,currWidth=2*currHeight),currWidth|=0,currHeight|=0,panel.style.height=`${currHeight}px`,panel.style.width=`${currWidth}px`,canvas.style.width=`${currWidth}px`,canvas.style.height=`${currHeight}px`,glPreview.resizeGL(currWidth,currHeight),send("cameraUpdate"))}async function callMiniPreviewFunction(e,...r){return await $scene.callSceneMethod("callPreviewFunction",["scene:mini-preview",e,r])}async function ready(e,r,i){if($scene=e.parentElement,(panel=e).style.opacity="1",panel.hidden=!0,r.nodes.length>1||!i[exports.type])return;if(!i[exports.type][0].enabled)return void(e.hidden=!0);curCameraUUID=i[exports.type][0].uuid,await callMiniPreviewFunction("handleSelect",curCameraUUID),canvas=panel.querySelector("canvas"),cameraPreview=panel.querySelector("camera-preview"),miniPreviewInfo=await callMiniPreviewFunction("queryWindowList"),previewInfo=await callMiniPreviewFunction("getPreviewInfo"),applyWindowSize();$scene.$scene.getWebContentsId();const t=miniPreviewInfo;for(const e of t)if(e.uuid===curCameraUUID){currIndex=e.index;break}canvas&&(await glPreview.init({index:currIndex,width:canvas.width,height:canvas.height}),glPreview.initGL(canvas),applyWindowSize(),await send("cameraUpdate"),panel.hidden=!1)}async function close(){glPreview.destroyGL(),await callMiniPreviewFunction("handleUnselect",curCameraUUID)}function drawBuffer(e){try{glPreview.drawGL(e.buffer,e.width,e.height)}catch(e){console.warn(e)}}async function send(e){if("cameraUpdate"===e){const e=await glPreview.queryPreviewData({index:currIndex,width:canvas.width,height:canvas.height});return!(!e||e instanceof Uint8Array)&&(drawBuffer(e),!0)}return"viewResize"===e?applyWindowSize():e&&e.name&&"preview-plugin"===e.name&&(previewInfo=e,applyWindowSize()),!0}exports.template=(0,fs_1.readFileSync)((0,path_1.join)(__dirname,"./index.html"),"utf-8"),exports.ready=ready,exports.close=close,exports.send=send,exports.default=module.exports;