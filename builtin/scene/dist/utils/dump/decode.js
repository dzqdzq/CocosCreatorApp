"use strict";"use strcit";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeTargetOverrides=exports.resetProperty=exports.decodePatch=exports.decodeNode=exports.decodeScene=void 0;const utils_1=require("./utils"),lodash_1=require("lodash"),dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo;function decodeChildren(e,t){const c=e.map(e=>e.value.uuid),r=t.children.map(e=>e.uuid);r.forEach(e=>{if(!c.includes(e)){const t=cce.Node.query(e);if(!t||t._objFlags&cc.Object.Flags.HideInHierarchy)return;t.parent=null}}),c.forEach((e,c)=>{const o=cce.Node.query(e);o&&(r.includes(e)||(o.parent=t),o.setSiblingIndex(c))})}async function decodeComponents(e,t,c){if(!e)return;const r={},o=e.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(r[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean),a=t._components.map(e=>{if(c){const t=utils_1.getTypeName(e.constructor);if(c.includes(t))return""}if(e.__prefab&&e.__prefab.fileId){const t=r[e.__prefab.fileId];if(t){const c=o.indexOf(t.value.uuid.value);-1!==c&&(o.splice(c,1,e.uuid),t.value.uuid.value=e.uuid)}}return e.uuid}).filter(Boolean);let s=a.length**2,n=a.length-1;do{const e=a[n];e&&!o.includes(e)&&cce.Node.removeComponent(e)?a.splice(n,1):n--,s--}while(0!==a.length&&s);cc.Object._deferredDestroy();const l=t._components.slice();t._components.length=0;for(let c=0;c<e.length;c++){const r=e[c];if(!r.value||!r.value.uuid)continue;let o=l[c];const a=r.value.uuid.value;let s=cce.Component.query(a);s||(s=cce.Component.queryRecycle(a)),s&&(o!==s?(s.node!==t&&i(s),(s._objFlags&cc.Object.Flags.Destroying||s._objFlags&cc.Object.Flags.Destroyed)&&(s._objFlags&=cc.Object.Flags.PersistentMask,s._objFlags&=~cc.Object.Flags.Destroyed,cce.Component.recycle(a)),t._addComponentAt(s,c),o=s):t._addComponentAt(o,c));for(const e in r.value)await decodePatch(e,r.value[e],o);o&&o.onRestore&&o.onRestore()}function i(e){if(e._objFlags&cc.Object.Flags.Destroying||e._objFlags&cc.Object.Flags.Destroyed)return;const t=e.node._getDependComponent(e);t&&i(t),cce.Node.removeComponent(e.uuid),cc.Object._deferredDestroy()}}async function decodePrefab(e,t){if(!e&&!t._prefab)return;if(!e&&t._prefab)return void(t._prefab=null);const c=new cc._PrefabInfo,r=cce.Node.query(e.rootUuid);c.root=r||t,e.uuid&&(c.asset=await util_1.promisify(cc_1.assetManager.loadAny)(e.uuid)),c.fileId=e.fileId||t.uuid,e.instance?decodePatch("instance",e.instance,c):c.instance=void 0,e.targetOverrides?c.targetOverrides=decodeTargetOverrides(e.targetOverrides):c.targetOverrides=void 0,t._prefab=c}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const c of Object.keys(e._globals))await decodePatch(`_globals.${c}`,e._globals[c],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,c){if(e)return(t=t||new cc.Node).name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.setPosition(e.position.value),t.setRotationFromEuler(e.rotation.value.x,e.rotation.value.y,e.rotation.value.z),t.setScale(e.scale.value),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,c),decodePrefab(e.__prefab__,t),t}async function _decodeByType(e,t,c,r,o){const a=dump_defines_1.DumpDefines[e];return!!a&&(await a.decode(t,c,r,o),!0)}async function decodePatch(e,t,c){const r=utils_1.parsingPath(e),o=utils_1.parsingPath(r.search);if("enabledInHierarchy"===r.key||"__scriptAsset"===r.key||"node"===r.key||"uuid"===r.key)return;const a=r.search?lodash_1.get(c,r.search):c;if(!a)return;if("[object Object]"===Object.prototype.toString.call(a)){let e=Object.getOwnPropertyDescriptor(a,r.key);if(void 0===e){if(!(e=cc.Class.attr(a,r.key))||!e.hasSetter)return void(r.key in a&&(!e||!0!==e.hasGetter)&&(a[r.key]=t.value))}else if(!e.writable&&!e.set)return}const s=o.search?lodash_1.get(c,o.search):c;if(!("value"in t)||"Unknown"===t.type){let e=cc.Class.attr(a,r.key);if(Array.isArray(s)&&"_components"!==o.search){const t=utils_1.parsingPath(o.search),a=t.search?lodash_1.get(c,t.search):c;e=cc.Class.attr(a,t.key),e=cc.Class.attr(e.ctor,r.key)}const t=getDefaultAttrData(e);return a[r.key]=t,t}const n=cc.js.getClassByName(t.type),l=n?utils_1.getTypeInheritanceChain(n):[];if(t.isArray)if(Array.isArray(t.value)){let e=[];const c=cc.Class.attr(a.constructor,r.key);for(let r=0;r<t.value.length;r++)e[r]=utils_1.ccClassAttrPropertyDefaultValue(c),await decodePatch(`${r}`,t.value[r],e);a[r.key]=e}else a[r.key]=[];else{const s={};if(s.ccType=n,await _decodeByType(t.type,a,r,t,s));else if("cc.Scene"===t.type)_decodeByType("cc.Node",a,r,t,s);else if(ArrayBuffer.isView(t.value))_decodeByType("TypedArray",a,r,t,s);else if(l.includes("cc.Node")||"cc.Node"===t.type)_decodeByType("cc.Node",a,r,t,s);else if(l.includes("cc.Asset")||"cc.Asset"===t.type)await _decodeByType("cc.Asset",a,r,t,s);else if(l.includes("cc.Component")||"cc.Component"===t.type)_decodeByType("cc.Component",a,r,t,s);else if(l.includes("cc.ValueType"))_decodeByType("cc.ValueType",a,r,t,s);else if("length"===r.key&&"Array"===t.type){for(;a.length>t.value;)a.pop();const e=lodash_1.get(c,o.search),s=cc.Class.attr(e,o.key);for(let e=a.length;e<t.value;e++)a[e]=utils_1.ccClassAttrPropertyDefaultValue(s);lodash_1.set(c,r.search,a)}else if(n&&!a[r.key]&&null!==t.value){a[r.key]=new n;for(let r=0;r<n.__props__.length;r++){const o=n.__props__[r],a=t.value[o];await decodePatch(`${e}.${o}`,a,c)}}else if(null===t.value)a[r.key]=t.value;else if("object"==typeof t.value)for(const e in t.value)void 0!==t.value[e]&&await decodePatch(e,t.value[e],a[r.key]);else a[r.key]=t.value}if(setNodeSpecialProperty(c,r),a[r.key]=a[r.key],r.search&&lodash_1.set(c,r.search,a),o&&o.search){const e=lodash_1.get(c,o.search);e[o.key]=e[o.key]}}function setNodeSpecialProperty(e,t){if(e instanceof cc.Node)switch(t.key){case"_lpos":e.setPosition(e._lpos);break;case"eulerAngles":e.setRotationFromEuler(e.eulerAngles.x,e.eulerAngles.y,e.eulerAngles.z);break;case"_lscale":e.setScale(e._lscale)}}function getDefaultAttrData(e){let t=utils_1.getDefault(e);return e.ctor?t=new e.ctor:"object"==typeof t&&t&&(t="function"==typeof t.clone?t.clone():Array.isArray(t)?[]:{}),t}function resetProperty(e,t){const c=utils_1.parsingPath(t),r=c.search?lodash_1.get(e,c.search):e;if(!r)return;const o=cc.Class.attr(r.constructor,c.key);r[c.key]=getDefaultAttrData(o),setNodeSpecialProperty(r,c)}function decodeTargetOverrides(e){let t=[];e.forEach(e=>{const c=new TargetOverrideInfo;if(c.source=cce.Node.query(e.source),e.sourceInfo){const t=new TargetInfo;t.localID=e.sourceInfo,c.sourceInfo=t}if(c.propertyPath=e.propertyPath,c.target=cce.Node.query(e.target),e.targetInfo){const t=new TargetInfo;t.localID=e.targetInfo,c.targetInfo=t}t.push(c)})}exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch,exports.resetProperty=resetProperty,exports.decodeTargetOverrides=decodeTargetOverrides,exports.default=module.exports;