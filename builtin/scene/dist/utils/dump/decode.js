"use strict";"use strcit";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeTargetOverrides=exports.resetProperty=exports.decodePatch=exports.decodeNode=exports.decodeScene=exports.decodeMountedRoot=void 0;const utils_1=require("./utils"),lodash_1=require("lodash"),dump_defines_1=require("./dump-defines"),cc_1=require("cc"),util_1=require("util"),TargetOverrideInfo=cc_1.Prefab._utils.TargetOverrideInfo,TargetInfo=cc_1.Prefab._utils.TargetInfo,PrefabInfo=cc_1.Prefab._utils.PrefabInfo;function decodeChildren(e,t){const o=e.map(e=>e.value.uuid),c=t.children.map(e=>e.uuid);c.forEach(e=>{if(!o.includes(e)){const t=cce.Node.query(e);if(!t||t.objFlags&cc.Object.Flags.HideInHierarchy)return;t.parent=null}}),o.forEach((e,o)=>{const r=cce.Node.query(e);r&&(r._objFlags&=cc.Object.Flags.PersistentMask,r._objFlags&=~cc.Object.Flags.Destroyed,c.includes(e)||(r.parent=t),r.setSiblingIndex(o))})}function decodeMountedRoot(e,t){if(!e)return;const o=cce.Node.query(t);o?(e[cc_1.editorExtrasTag]||(e[cc_1.editorExtrasTag]={}),e[cc_1.editorExtrasTag].mountedRoot=o):e[cc_1.editorExtrasTag]&&(e[cc_1.editorExtrasTag].mountedRoot=void 0)}async function decodeComponents(e,t,o){if(!e)return;const c={},r=e.map(e=>e.value.uuid?(e.value.__prefab&&e.value.__prefab.value&&e.value.__prefab.value.fileId.value&&(c[e.value.__prefab.value.fileId.value]=e),e.value.uuid.value):"").filter(Boolean),a=t.components.map(e=>{if(o){const t=utils_1.getTypeName(e.constructor);if(o.includes(t))return""}if(e.__prefab&&e.__prefab.fileId){const t=c[e.__prefab.fileId];if(t){const o=r.indexOf(t.value.uuid.value);-1!==o&&(r.splice(o,1,e.uuid),t.value.uuid.value=e.uuid)}}return e.uuid}).filter(Boolean);let s=a.length**2,n=a.length-1;do{const e=a[n];e&&!r.includes(e)&&cce.Node.removeComponent(e)?a.splice(n,1):n--,s--}while(0!==a.length&&s);cc.Object._deferredDestroy();const l=t.components.slice();t._components.length=0;for(let o=0;o<e.length;o++){const c=e[o];if(!c.value||!c.value.uuid)continue;let r=l[o];const a=c.value.uuid.value;let s=cce.Component.query(a);s||(s=cce.Component.queryRecycle(a)),s&&(r!==s?(s.node!==t&&d(s),(s.objFlags&cc.Object.Flags.Destroying||s.objFlags&cc.Object.Flags.Destroyed)&&(s.objFlags&=cc.Object.Flags.PersistentMask,s.objFlags&=~cc.Object.Flags.Destroyed,cce.Component.recycle(a)),cce.Node.addComponentAt(t,s,o),r=s):cce.Node.addComponentAt(t,r,o));for(const e in c.value)await decodePatch(e,c.value[e],r);decodeMountedRoot(r,c.mountedRoot),r&&r.onRestore&&r.onRestore()}function d(e){if(e.objFlags&cc.Object.Flags.Destroying||e.objFlags&cc.Object.Flags.Destroyed)return;e.node._getDependComponent(e).forEach(e=>{d(e)}),cce.Node.removeComponent(e.uuid),cc.Object._deferredDestroy()}}async function decodePrefab(e,t){if(!e&&!t._prefab)return;if(!e&&t._prefab)return void(t._prefab=null);const o=new PrefabInfo,c=cce.Node.query(e.rootUuid);if(o.root=c||t,e.uuid)try{o.asset=await util_1.promisify(cc_1.assetManager.loadAny)(e.uuid)}catch(t){console.error(t),o.asset=new cc_1.Prefab,o.asset.initDefault(e.uuid)}o.fileId=e.fileId||t.uuid,e.instance?await decodePatch("instance",e.instance,o):o.instance=void 0,e.targetOverrides?o.targetOverrides=decodeTargetOverrides(e.targetOverrides):o.targetOverrides=void 0,t._prefab=o}async function decodeScene(e,t){if(e){(t=t||new cc.Scene).name=e.name.value,t.active=e.active.value,e.children&&decodeChildren(e.children,t);for(const o of Object.keys(e._globals))await decodePatch(`_globals.${o}`,e._globals[o],t);e.targetOverrides?(t._prefab||(t._prefab=new cc._PrefabInfo),t._prefab.targetOverrides=decodeTargetOverrides(e.targetOverrides)):t._prefab=void 0}}async function decodeNode(e,t,o){return e&&(t=t||new cc.Node)?(decodePrefab(e.__prefab__,t),t.name=e.name.value,t.active=e.active.value,t.layer=e.layer.value,t.setPosition(e.position.value),t.setRotationFromEuler(e.rotation.value.x,e.rotation.value.y,e.rotation.value.z),t.setScale(e.scale.value),decodeMountedRoot(t,e.mountedRoot),e.parent&&e.parent.value&&e.parent.value.uuid?t.parent=cce.Node.query(e.parent.value.uuid):t.parent=null,e.children&&decodeChildren(e.children,t),await decodeComponents(e.__comps__,t,o),t):null}async function _decodeByType(e,t,o,c,r){const a=dump_defines_1.DumpDefines[e];return!!a&&(await a.decode(t,o,c,r),!0)}async function decodePatch(e,t,o){const c=utils_1.parsingPath(e),r=utils_1.parsingPath(c.search);if("enabledInHierarchy"===c.key||"__scriptAsset"===c.key||"node"===c.key||"uuid"===c.key)return;const a=c.search?lodash_1.get(o,c.search):o;if(!a)return;if("[object Object]"===Object.prototype.toString.call(a)){let e=Object.getOwnPropertyDescriptor(a,c.key);if(void 0===e){if(!(e=cc.Class.attr(a,c.key))||!e.hasSetter)return void(c.key in a&&(!e||!0!==e.hasGetter)&&(a[c.key]=t.value))}else if(!e.writable&&!e.set)return}const s=r.search?lodash_1.get(o,r.search):o;if(!("value"in t)||"Unknown"===t.type){let e=cc.Class.attr(a,c.key);if(Array.isArray(s)&&"_components"!==r.search){const t=utils_1.parsingPath(r.search),a=t.search?lodash_1.get(o,t.search):o;e=cc.Class.attr(a,t.key),e=cc.Class.attr(e.ctor,c.key)}const t=getDefaultAttrData(e);return a[c.key]=t,t}const n=cc.js.getClassByName(t.type),l=n?utils_1.getTypeInheritanceChain(n):[];if(t.isArray)if(Array.isArray(t.value)){const e=[],o=cc.Class.attr(a.constructor,c.key);for(let c=0;c<t.value.length;c++)e[c]=utils_1.ccClassAttrPropertyDefaultValue(o),await decodePatch(`${c}`,t.value[c],e);a[c.key]=e}else a[c.key]=[];else{const s={};if(s.ccType=n,await _decodeByType(t.type,a,c,t,s));else if("cc.Scene"===t.type)_decodeByType("cc.Node",a,c,t,s);else if(ArrayBuffer.isView(t.value))_decodeByType("TypedArray",a,c,t,s);else if(l.includes("cc.Node")||"cc.Node"===t.type)_decodeByType("cc.Node",a,c,t,s);else if(l.includes("cc.Asset")||"cc.Asset"===t.type)await _decodeByType("cc.Asset",a,c,t,s);else if(l.includes("cc.Component")||"cc.Component"===t.type)_decodeByType("cc.Component",a,c,t,s);else if(l.includes("cc.ValueType"))_decodeByType("cc.ValueType",a,c,t,s);else if("length"===c.key&&"Array"===t.type){for(;a.length>t.value;)a.pop();const e=lodash_1.get(o,r.search),s=cc.Class.attr(e,r.key);for(let e=a.length;e<t.value;e++)a[e]=utils_1.ccClassAttrPropertyDefaultValue(s);lodash_1.set(o,c.search,a)}else if(n&&!a[c.key]&&null!==t.value){a[c.key]=new n;for(let c=0;c<n.__props__.length;c++){const r=n.__props__[c],a=t.value[r];await decodePatch(`${e}.${r}`,a,o)}}else if(null===t.value)a[c.key]=t.value;else if("object"==typeof t.value)for(const e in t.value)void 0!==t.value[e]&&await decodePatch(e,t.value[e],a[c.key]);else a[c.key]=t.value}if(setNodeSpecialProperty(o,c),c.search&&lodash_1.set(o,c.search,a),r&&r.search){const e=lodash_1.get(o,r.search);e[r.key]=e[r.key]}}function setNodeSpecialProperty(e,t){if(e instanceof cc.Node)switch(t.key){case"_lpos":e.setPosition(e._lpos);break;case"eulerAngles":e.setRotationFromEuler(e.eulerAngles.x,e.eulerAngles.y,e.eulerAngles.z);break;case"_lscale":e.setScale(e._lscale)}}function getDefaultAttrData(e){let t=utils_1.getDefault(e);return e.ctor?t=new e.ctor:"object"==typeof t&&t&&(t="function"==typeof t.clone?t.clone():Array.isArray(t)?[]:{}),t}function resetProperty(e,t){const o=utils_1.parsingPath(t),c=o.search?lodash_1.get(e,o.search):e;if(!c)return;const r=cc.Class.attr(c.constructor,o.key);c[o.key]=getDefaultAttrData(r),setNodeSpecialProperty(c,o)}function decodeTargetOverrides(e){const t=[];return e.forEach(e=>{const o=new TargetOverrideInfo;if(o.source=cce.Node.query(e.source),e.sourceInfo){const t=new TargetInfo;t.localID=e.sourceInfo,o.sourceInfo=t}if(o.propertyPath=e.propertyPath,o.target=cce.Node.query(e.target),e.targetInfo){const t=new TargetInfo;t.localID=e.targetInfo,o.targetInfo=t}t.push(o)}),t}exports.decodeMountedRoot=decodeMountedRoot,exports.decodeScene=decodeScene,exports.decodeNode=decodeNode,exports.decodePatch=decodePatch,exports.resetProperty=resetProperty,exports.decodeTargetOverrides=decodeTargetOverrides,exports.default=module.exports;