"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.encodeObject=exports.encodeComponent=exports.encodeScene=exports.encodeNode=void 0;const utils_1=__importDefault(require("./utils")),dump_defines_1=require("./dump-defines"),utils_2=require("../../script/3d/manager/prefab/utils"),cc_1=require("cc"),attributeProps=["enumList","bitmaskList","displayName","group","multiline","min","max","step","slide","tooltip","animatable","unit","radian","displayOrder"];function encodeNode(e){var t;const o=e.constructor,n=Object.keys(cc.Layers.Enum).map((e,t)=>({name:e,value:cc.Layers.Enum[e]}));n.sort((e,t)=>e.value-t.value);const c={active:encodeObject(e.active,{displayName:"Active",default:null},e),locked:encodeObject(Boolean(e.objFlags&cc.Object.Flags.LockedInEditor),{displayName:"Locked",default:!1},e),name:encodeObject(e.name,{displayName:"Name",default:null},e),position:encodeObject(e._lpos,{displayName:"Position",default:new cc.math.Vec3},e),rotation:encodeObject(e.eulerAngles,{displayName:"Rotation",default:new cc.math.Vec3},e),scale:encodeObject(e._lscale,{displayName:"Scale",default:new cc.math.Vec3(1,1,1)},e),layer:encodeObject(e.layer,{displayName:"Layer",default:1073741824,type:"Enum",enumList:n,readonly:!1},e),uuid:encodeObject(e.uuid,{displayName:"UUID",default:null},e),parent:encodeObject(e.parent,{ctor:cc.Node},e),children:e.children.map(t=>{if(t&&!(t.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(t,{ctor:cc.Node},e)}).filter(Boolean),__type__:utils_1.default.getTypeName(o),__comps__:e._components.map(e=>encodeComponent(e)),mountedRoot:null===(t=utils_2.prefabUtils.getMountedRoot(e))||void 0===t?void 0:t.uuid};if(e._prefab){const t=utils_2.prefabUtils.getPrefabStateInfo(e);c.__prefab__={uuid:e._prefab.asset&&e._prefab.asset._uuid||"",fileId:e._prefab.fileId,rootUuid:e._prefab.root&&e._prefab.root.uuid,sync:!0,prefabStateInfo:t},e._prefab.targetOverrides&&(c.__prefab__.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),e._prefab.instance&&(c.__prefab__.instance=encodeObject(e._prefab.instance,{default:null},e));const o=utils_2.prefabUtils.getRemovedComponents(e);o.length>0&&(c.removedComponents=o.map(e=>({name:cc_1.js.getClassName(e),fileID:e.__prefab.fileId})))}return _checkObjFlags(e,c),c}function encodeScene(e){var t;const o=e.constructor,n={active:encodeObject(e.active,{default:null}),locked:encodeObject(!1,{default:!1}),name:encodeObject(e.name||o.name,{default:null}),uuid:encodeObject(e.uuid,{default:null}),autoReleaseAssets:encodeObject(e.autoReleaseAssets,{displayName:"Auto Release Assets",default:!1}),children:e.children.map(e=>{if(e&&!(e.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node})}).filter(Boolean),parent:"",__type__:utils_1.default.getTypeName(o),_globals:{},isScene:!0};return e._globals&&e._globals.constructor.__props__.map(t=>{const o=cc.Class.attr(e._globals,t);n._globals[t]=encodeObject(e._globals[t],o,e._globals)}),(null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides)&&(n.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),n}function encodeComponent(e){const t=e.constructor,o=utils_2.prefabUtils.getMountedRoot(e),n={value:{uuid:encodeObject(e.uuid,{default:null,visible:!1},e),name:encodeObject(e.name,{default:null,visible:!1},e),enabled:encodeObject(e.enabled,{default:null,visible:!1},e)},default:void 0,type:utils_1.default.getTypeName(t),readonly:!1,visible:!0,cid:e.__cid__,mountedRoot:null===o||void 0===o?void 0:o.uuid};if(t.__props__.map(t=>{if(n.value)try{if(t in e){const o=cc.Class.attr(e,t);n.value[t]=encodeObject(e[t],o,e,t)}}catch(o){console.warn(`Component property dump failed:\n  Node: ${e.node.name}(${e.node.uuid})\n Component: ${n.type}(${e.uuid})\n Property: ${t}`),console.warn(o),delete n.value[t]}}),n.editor={inspector:t._inspector||"",icon:t._icon||"",help:t._help||"",_showTick:"function"==typeof e.start||"function"==typeof e.update||"function"==typeof e.lateUpdate||"function"==typeof e.onEnable||"function"==typeof e.onDisable},n.value){const t=n.value.__scriptAsset;if(e instanceof cc._MissingScript){const o=e._$erialized;let n=o&&o.__type__;n=n&&EditorExtends.UuidUtils.decompressUuid(e._$erialized.__type__),t.visible=!(!n||!EditorExtends.UuidUtils.isUuid(n)),t.value={uuid:n}}else t.visible=!!e.__scriptUuid,t.value={uuid:e.__scriptUuid};t.displayOrder=-999}return t&&(n.extends=utils_1.default.getTypeInheritanceChain(t)),n}function _checkAttributes(e,t,o){void 0!==t.visible&&("function"==typeof t.visible?o?e.visible=!!t.visible.call(o):console.warn("try to use visible function without owner"):e.visible=!!t.visible),!t.ctor&&t.type&&(e.type=""+t.type),"enumList"in t&&"Enum"===t.type&&(e.type="Enum"),t&&t.hasGetter&&!t.hasSetter&&(e.readonly=!0),attributeProps.forEach(o=>{t.hasOwnProperty(o)&&(e[o]=t[o])})}function _encodeByType(e,t,o,n){e=e||"";const c=dump_defines_1.DumpDefines[e];return!!c&&(c.encode(t,o,n),!0)}function _checkObjFlags(e,t){let o=!1,n=!1,c=!1;e._components.forEach(e=>{e.objFlags&cc.Object.Flags.IsPositionLocked&&(o=!0),e.objFlags&cc.Object.Flags.IsSizeLocked&&(n=!0),e.objFlags&cc.Object.Flags.IsAnchorLocked&&(c=!0)}),o&&(t.position.readonly=!0);const a=[];t.__comps__.forEach(e=>{"cc.UITransform"===e.cid&&a.push(e)}),a.length&&n&&a.forEach(e=>{e.value.contentSize.readonly=!0})}function encodeObject(e,t,o=null,n,c){const a=utils_1.default.getConstructor(e,t),s=utils_1.default.getDefault(t);let l=utils_1.default.getTypeName(a);if(null===o)if(t.type)t.ctor&&e&&e.constructor&&t.ctor===e.constructor||t.type!==l&&(l="Unknown");else if(null!==t.default&&void 0!==t.default){const e=utils_1.default.getConstructor(t.default,t);utils_1.default.getTypeName(e)!==l&&(l="Unknown")}const i={name:n,value:null,default:s,type:l,readonly:!!t.readonly,visible:!0};if(_checkAttributes(i,t,o),s&&Array.isArray(s)&&(i.isArray=!0),!i.isArray&&Array.isArray(e)&&(i.isArray=!0),i.isArray){const a=Object.assign({},t);a.default=null;const s=utils_1.default.ccClassAttrPropertyDefaultValue(t);if(c||(i.elementTypeData=encodeObject(s,a,o,void 0,!0)),Array.isArray(e)){const t=[];for(let n=0;n<e.length;n++){const c=e[n];c&&c.constructor&&(a.ctor=c&&c.constructor);const s=encodeObject(c,a,o);t.push(s)}i.value=t}else{const t=o?o.name:"";console.warn(`${t} ${n} should be an array, but now it is  ${e}`),i.type="Unknown"}}else{const t={};if(t.ctor=a,_encodeByType(i.type,e,i,t));else if(ArrayBuffer.isView(e))_encodeByType("TypedArray",e,i,t);else if(cc.js.isChildClassOf(a,cc.ValueType))_encodeByType("cc.ValueType",e,i,t);else if(cc.js.isChildClassOf(a,cc.Node))_encodeByType("cc.Node",e,i,t);else if(cc.js.isChildClassOf(a,cc.Component))_encodeByType("cc.Component",e,i,t);else if(cc.js.isChildClassOf(a,cc.Asset))_encodeByType("cc.Asset",e,i,t);else if(a&&a.__props__)if(e){const t={};a.__props__.map(o=>{const n=cc.Class.attr(e,o);t[o]=encodeObject(e[o],n,e,o)}),i.value=t}else i.value=null;else"Unknown"!==i.type&&(i.value=e)}return a&&(i.extends=utils_1.default.getTypeInheritanceChain(a)),i}function encodeTargetOverrides(e){if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{if(!e.source||!e.target)return;const o={source:e.source.uuid,sourceInfo:e.sourceInfo?e.sourceInfo.localID:void 0,propertyPath:e.propertyPath,target:e.target.uuid,targetInfo:e.targetInfo?e.targetInfo.localID:void 0};t.push(o)}),t}exports.encodeNode=encodeNode,exports.encodeScene=encodeScene,exports.encodeComponent=encodeComponent,exports.encodeObject=encodeObject,exports.default=module.exports;