"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.encodeObject=exports.encodeComponent=exports.encodeScene=exports.encodeNode=void 0;const utils_1=__importDefault(require("./utils")),dump_defines_1=require("./dump-defines"),utils_2=require("../../script/3d/manager/prefab/utils"),attributeProps=["enumList","bitmaskList","displayName","multiline","min","max","step","slide","tooltip","animatable","unit","radian","displayOrder"];function encodeNode(e){const t=e.constructor;let o=Object.keys(cc.Layers.Enum).map((e,t)=>({name:e,value:cc.Layers.Enum[e]}));(o=o.filter(e=>0!==e.value&&4294967295!==e.value)).sort((e,t)=>e.value-t.value);const n={active:encodeObject(e.active,{default:null},e),locked:encodeObject(Boolean(e._objFlags&cc.Object.Flags.LockedInEditor),{default:!1},e),name:encodeObject(e.name,{default:null},e),position:encodeObject(e._lpos,{default:new cc.math.Vec3},e),rotation:encodeObject(e.eulerAngles,{default:new cc.math.Vec3},e),scale:encodeObject(e._lscale,{default:new cc.math.Vec3(1,1,1)},e),layer:encodeObject(e.layer,{default:1073741824,type:"Enum",enumList:o,readonly:!1},e),uuid:encodeObject(e.uuid,{default:null},e),parent:encodeObject(e.parent,{ctor:cc.Node},e),children:e.children.map(t=>{if(t&&!(t._objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(t,{ctor:cc.Node},e)}).filter(Boolean),__type__:utils_1.default.getTypeName(t),__comps__:e._components.map(e=>encodeComponent(e))};if(e._prefab){const t=utils_2.prefabUtils.getPrefabStateInfo(e);n.__prefab__={uuid:e._prefab.asset&&e._prefab.asset._uuid||"",fileId:e._prefab.fileId,rootUuid:e._prefab.root&&e._prefab.root.uuid,sync:!0,prefabStateInfo:t},e._prefab.targetOverrides&&(n.__prefab__.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),e._prefab.instance&&(n.__prefab__.instance=encodeObject(e._prefab.instance,{default:null},e))}return _checkObjFlags(e,n),n}function encodeScene(e){var t;const o=e.constructor,n={active:encodeObject(e.active,{default:null}),locked:encodeObject(!1,{default:!1}),name:encodeObject(e.name||o.name,{default:null}),uuid:encodeObject(e.uuid,{default:null}),autoReleaseAssets:encodeObject(e.autoReleaseAssets,{default:!1}),children:e.children.map(e=>{if(e&&!(e._objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node})}).filter(Boolean),parent:"",__type__:utils_1.default.getTypeName(o),_globals:{},isScene:!0};return e._globals&&e._globals.constructor.__props__.map(t=>{const o=cc.Class.attr(e._globals,t);n._globals[t]=encodeObject(e._globals[t],o,e._globals)}),(null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides)&&(n.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),n}function encodeComponent(e){const t=e.constructor,o={value:{uuid:encodeObject(e.uuid,{default:null,visible:!1},e),name:encodeObject(e.name,{default:null,visible:!1},e),enabled:encodeObject(e.enabled,{default:null,visible:!1},e)},default:void 0,type:utils_1.default.getTypeName(t),readonly:!1,visible:!0,cid:e.__cid__};if(t.__props__.map(t=>{if(o.value)try{if(t in e){const n=cc.Class.attr(e,t);o.value[t]=encodeObject(e[t],n,e,t)}}catch(n){console.warn(`Component property dump failed:\n  Node: ${e.node.name}(${e.node.uuid})\n Component: ${o.type}(${e.uuid})\n Property: ${t}`),console.warn(n),delete o.value[t]}}),o.editor={inspector:t._inspector||"",icon:t._icon||"",help:t._help||"",_showTick:"function"==typeof e.start||"function"==typeof e.update||"function"==typeof e.lateUpdate||"function"==typeof e.onEnable||"function"==typeof e.onDisable},o.value){const t=o.value.__scriptAsset;if(e instanceof cc._MissingScript){let o=e._$erialized,n=o&&o.__type__;n=n&&EditorExtends.UuidUtils.decompressUuid(e._$erialized.__type__),t.visible=!(!n||!EditorExtends.UuidUtils.isUuid(n)),t.value={uuid:n}}else t.visible=!!e.__scriptUuid,t.value={uuid:e.__scriptUuid};t.displayOrder=-999}return t&&(o.extends=utils_1.default.getTypeInheritanceChain(t)),o}function _checkAttributes(e,t,o){void 0!==t.visible&&("function"==typeof t.visible?o?e.visible=!!t.visible.call(o):console.warn("try to use visible function without owner"):e.visible=!!t.visible),!t.ctor&&t.type&&(e.type=""+t.type),"enumList"in t&&"Enum"===t.type&&(e.type="Enum"),t&&t.hasGetter&&!t.hasSetter&&(e.readonly=!0),attributeProps.forEach(o=>{t.hasOwnProperty(o)&&(e[o]=t[o])})}function _encodeByType(e,t,o,n){e=e||"";const c=dump_defines_1.DumpDefines[e];return!!c&&(c.encode(t,o,n),!0)}function _checkObjFlags(e,t){let o=!1,n=!1,c=!1;e._components.forEach(e=>{e._objFlags&cc.Object.Flags.IsPositionLocked&&(o=!0),e._objFlags&cc.Object.Flags.IsSizeLocked&&(n=!0),e._objFlags&cc.Object.Flags.IsAnchorLocked&&(c=!0)}),o&&(t.position.readonly=!0);const a=[];t.__comps__.forEach(e=>{"cc.UITransform"===e.cid&&a.push(e)}),a.length&&(n&&a.forEach(e=>{e.value.contentSize.readonly=!0}),c&&a.forEach(e=>{e.value.priority.readonly=!0}))}function encodeObject(e,t,o=null,n){const c=utils_1.default.getConstructor(e,t),a=utils_1.default.getDefault(t);let s=utils_1.default.getTypeName(c);if(null===o)if(t.type)t.ctor&&e&&e.constructor&&t.ctor===e.constructor||t.type!==s&&(s="Unknown");else if(null!==t.default&&void 0!==t.default){const e=utils_1.default.getConstructor(t.default,t);utils_1.default.getTypeName(e)!==s&&(s="Unknown")}const l={value:null,default:a,type:s,readonly:!!t.readonly,visible:!0};if(_checkAttributes(l,t,o),a&&Array.isArray(a)&&(l.isArray=!0),!l.isArray&&Array.isArray(e)&&(l.isArray=!0),l.isArray)if(Array.isArray(e)){const n=[];for(let c=0;c<e.length;c++){const a=e[c],s=Object.assign({},t);s.default=null,a&&a.constructor&&(s.ctor=a&&a.constructor);const l=encodeObject(a,s,o);n.push(l)}l.value=n}else{const t=o?o.name:"";console.warn(`${t} ${n} should be an array, but now it is  ${e}`),l.value=e}else{const t={};if(t.ctor=c,_encodeByType(l.type,e,l,t));else if(ArrayBuffer.isView(e))_encodeByType("TypedArray",e,l,t);else if(cc.js.isChildClassOf(c,cc.ValueType))_encodeByType("cc.ValueType",e,l,t);else if(cc.js.isChildClassOf(c,cc.Node))_encodeByType("cc.Node",e,l,t);else if(cc.js.isChildClassOf(c,cc.Component))_encodeByType("cc.Component",e,l,t);else if(cc.js.isChildClassOf(c,cc.Asset))_encodeByType("cc.Asset",e,l,t);else if(c&&c.__props__)if(e){const t={};c.__props__.map(o=>{const n=cc.Class.attr(e,o);t[o]=encodeObject(e[o],n,e,o)}),l.value=t}else l.value=null;else"Unknown"!==l.type&&(l.value=e)}return c&&(l.extends=utils_1.default.getTypeInheritanceChain(c)),l}function encodeTargetOverrides(e){if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{const o={source:e.source.uuid,sourceInfo:e.sourceInfo?e.sourceInfo.localID:void 0,propertyPath:e.propertyPath,target:e.target.uuid,targetInfo:e.targetInfo?e.targetInfo.localID:void 0};t.push(o)}),t}exports.encodeNode=encodeNode,exports.encodeScene=encodeScene,exports.encodeComponent=encodeComponent,exports.encodeObject=encodeObject,exports.default=module.exports;