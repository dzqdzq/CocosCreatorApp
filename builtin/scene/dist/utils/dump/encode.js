"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.encodeObject=exports.encodeComponent=exports.encodeScene=exports.encodeNode=void 0;const utils_1=__importDefault(require("./utils")),dump_defines_1=require("./dump-defines"),utils_2=require("../../script/3d/manager/prefab/utils"),cc_1=require("cc"),attributeProps=["enumList","bitmaskList","displayName","group","multiline","min","max","step","slide","tooltip","animatable","unit","radian","displayOrder"];function encodeNode(e){var t;const n=e.constructor,o=Object.keys(cc.Layers.Enum).map((e,t)=>({name:e,value:cc.Layers.Enum[e]}));o.sort((e,t)=>e.value-t.value);const a={active:encodeObject(e.active,{displayName:"Active",default:null},e),locked:encodeObject(Boolean(e.objFlags&cc.Object.Flags.LockedInEditor),{displayName:"Locked",default:!1},e),name:encodeObject(e.name,{displayName:"Name",default:null},e),position:encodeObject(e._lpos,{displayName:"Position",default:new cc.math.Vec3},e),rotation:encodeObject(e.eulerAngles,{displayName:"Rotation",default:new cc.math.Vec3,tooltip:"i18n:scene.tooltips.rotationTip"},e),scale:encodeObject(e._lscale,{displayName:"Scale",default:new cc.math.Vec3(1,1,1)},e),layer:encodeObject(e.layer,{displayName:"Layer",default:1073741824,type:"Enum",enumList:o,readonly:!1},e),uuid:encodeObject(e.uuid,{displayName:"UUID",default:null},e),parent:encodeObject(e.parent,{ctor:cc.Node},e),children:e.children.map(t=>{if(t&&!(t.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(t,{ctor:cc.Node},e)}).filter(Boolean),__type__:utils_1.default.getTypeName(n),__comps__:e._components.map(e=>encodeComponent(e)),mountedRoot:null===(t=utils_2.prefabUtils.getMountedRoot(e))||void 0===t?void 0:t.uuid};if(e._prefab){const t=utils_2.prefabUtils.getPrefabStateInfo(e);a.__prefab__={uuid:e._prefab.asset&&e._prefab.asset._uuid||"",fileId:e._prefab.fileId,rootUuid:e._prefab.root&&e._prefab.root.uuid,sync:!0,prefabStateInfo:t},e._prefab.targetOverrides&&(a.__prefab__.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),e._prefab.instance&&(a.__prefab__.instance=encodeObject(e._prefab.instance,{default:null},e));const n=utils_2.prefabUtils.getRemovedComponents(e);n.length>0&&(a.removedComponents=n.map(e=>({name:cc_1.js.getClassName(e),fileID:e.__prefab.fileId})))}return _checkObjFlags(e,a),a}function encodeScene(e){var t;const n=e.constructor,o={active:encodeObject(e.active,{default:null}),locked:encodeObject(!1,{default:!1}),name:encodeObject(e.name||n.name,{default:null}),uuid:encodeObject(e.uuid,{default:null}),autoReleaseAssets:encodeObject(e.autoReleaseAssets,{displayName:"Auto Release Assets",default:!1}),children:e.children.map(e=>{if(e&&!(e.objFlags&cc.Object.Flags.HideInHierarchy))return encodeObject(e,{ctor:cc.Node})}).filter(Boolean),parent:"",__type__:utils_1.default.getTypeName(n),_globals:{},isScene:!0};return e._globals&&e._globals.constructor.__props__.map(t=>{const n=cc.Class.attr(e._globals,t);o._globals[t]=encodeObject(e._globals[t],n,e._globals)}),(null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides)&&(o.targetOverrides=encodeTargetOverrides(e._prefab.targetOverrides)),o}function encodeComponent(e){const t=e.constructor,n=utils_2.prefabUtils.getMountedRoot(e),o={value:{uuid:encodeObject(e.uuid,{default:null,visible:!1},e),name:encodeObject(e.name,{default:null,visible:!1},e),enabled:encodeObject(e.enabled,{default:null,visible:!1},e)},default:void 0,type:utils_1.default.getTypeName(t),readonly:!1,visible:!0,cid:e.__cid__,mountedRoot:null===n||void 0===n?void 0:n.uuid};if(t.__props__.map(t=>{if(o.value)try{if(t in e){const n=cc.Class.attr(e,t);o.value[t]=encodeObject(e[t],n,e,t)}}catch(n){console.warn(`Component property dump failed:\n  Node: ${e.node.name}(${e.node.uuid})\n Component: ${o.type}(${e.uuid})\n Property: ${t}`),console.warn(n),delete o.value[t]}}),o.editor={inspector:t._inspector||"",icon:t._icon||"",help:t._help||"",_showTick:"function"==typeof e.start||"function"==typeof e.update||"function"==typeof e.lateUpdate||"function"==typeof e.onEnable||"function"==typeof e.onDisable},o.value){const t=o.value.__scriptAsset;if(e instanceof cc._MissingScript){const n=e._$erialized;let o=n&&n.__type__;o=o&&EditorExtends.UuidUtils.decompressUuid(e._$erialized.__type__),t.visible=!(!o||!EditorExtends.UuidUtils.isUuid(o)),t.value={uuid:o}}else t.visible=!!e.__scriptUuid,t.value={uuid:e.__scriptUuid};t.displayOrder=-999}return t&&(o.extends=utils_1.default.getTypeInheritanceChain(t)),o}function _checkAttributes(e,t,n){void 0!==t.visible&&("function"==typeof t.visible?n?e.visible=!!t.visible.call(n):console.warn("try to use visible function without owner"):e.visible=!!t.visible),!t.ctor&&t.type&&(e.type=""+t.type),"enumList"in t&&"Enum"===t.type&&(e.type="Enum"),t&&t.hasGetter&&!t.hasSetter&&(e.readonly=!0),attributeProps.forEach(n=>{t.hasOwnProperty(n)&&(e[n]=t[n])})}function _encodeByType(e,t,n,o){e=e||"";const a=dump_defines_1.DumpDefines[e];return!!a&&(a.encode(t,n,o),!0)}function _checkObjFlags(e,t){let n=!1,o=!1,a=!1;e._components.forEach(e=>{e.objFlags&cc.Object.Flags.IsPositionLocked&&(n=!0),e.objFlags&cc.Object.Flags.IsSizeLocked&&(o=!0),e.objFlags&cc.Object.Flags.IsAnchorLocked&&(a=!0)}),n&&(t.position.readonly=!0);const c=[];t.__comps__.forEach(e=>{"cc.UITransform"===e.cid&&c.push(e)}),c.length&&o&&c.forEach(e=>{e.value.contentSize.readonly=!0})}function encodeObject(e,t,n=null,o,a){const c=utils_1.default.getConstructor(e,t),l=utils_1.default.getDefault(t);let s=utils_1.default.getTypeName(c);if(null===n&&null!==t.default&&void 0!==t.default){const e=utils_1.default.getConstructor(t.default,t);utils_1.default.getTypeName(e)!==s&&(s="Unknown")}const r={name:o,value:null,default:l,type:s,readonly:!!t.readonly,visible:!0};if(_checkAttributes(r,t,n),l&&Array.isArray(l)&&(r.isArray=!0),!r.isArray&&Array.isArray(e)&&(r.isArray=!0),r.isArray){const c=Object.assign({},t),l=utils_1.default.ccClassAttrPropertyDefaultValue(t);if(c.default=getElementDefaultValue(t,l),a||(r.elementTypeData=encodeObject(c.default,c,l,void 0,!0)),Array.isArray(e)){const t=[];for(let o=0;o<e.length;o++){const a=e[o];a&&a.constructor&&(c.ctor=a&&a.constructor);const l=encodeObject(a,c,n);t.push(l)}r.value=t}else{const t=n?n.name:"";console.warn(`${t} ${o} should be an array, but now it is  ${e}`),r.type="Unknown"}}else{const t={};if(t.ctor=c,_encodeByType(r.type,e,r,t));else if(ArrayBuffer.isView(e))_encodeByType("TypedArray",e,r,t);else if(cc.js.isChildClassOf(c,cc.ValueType))_encodeByType("cc.ValueType",e,r,t);else if(cc.js.isChildClassOf(c,cc.Node))_encodeByType("cc.Node",e,r,t);else if(cc.js.isChildClassOf(c,cc.Component))_encodeByType("cc.Component",e,r,t);else if(cc.js.isChildClassOf(c,cc.Asset))_encodeByType("cc.Asset",e,r,t);else if(c&&c.__props__)if(e){const t={};c.__props__.map(n=>{const o=cc.Class.attr(e,n);t[n]=encodeObject(e[n],o,e,n)}),r.value=t}else r.value=null;else"Unknown"!==r.type&&(r.value=e)}return c&&(r.extends=utils_1.default.getTypeInheritanceChain(c)),r}function getElementDefaultValue(e,t){return e.type?utils_1.default.ccClassAttrPropertyDefaultValue(e):getElementDefaultValueFromParentInitializer(t)}function getElementDefaultValueFromParentInitializer(e){if(!e||!Array.isArray(e)||0===e.length)return null;switch(typeof e[0]){case"number":return 0;case"string":return"";case"boolean":return!1}return null}function encodeTargetOverrides(e){if(!e||e.length<=0)return null;const t=[];return e.forEach(e=>{if(!e.source||!e.target)return;const n={source:e.source.uuid,sourceInfo:e.sourceInfo?e.sourceInfo.localID:void 0,propertyPath:e.propertyPath,target:e.target.uuid,targetInfo:e.targetInfo?e.targetInfo.localID:void 0};t.push(n)}),t}exports.encodeNode=encodeNode,exports.encodeScene=encodeScene,exports.encodeComponent=encodeComponent,exports.encodeObject=encodeObject,exports.default=module.exports;