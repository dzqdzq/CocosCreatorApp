"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{outputFileSync:outputFileSync,readdirSync:readdirSync,removeSync:removeSync,readJSON:readJSON}=require("fs-extra"),{join:join}=require("path");class Tasks{constructor(){this.$scene=null,this._dump=null,this._timer=null,this._softOpen=!1,this.tmpDir=join(Editor.Project.tmpDir,"./scene/staging"),this.tmpTimers={},this.editorInit=["editor-init",{depends:[],async handle(){}}],this.assetDbReady=["asset-db-ready",{depends:[],handle:async()=>await Editor.Message.request("asset-db","query-ready")}],this.queryEngineInfo=["query-engine-info",{depends:[],handle:async()=>(await Editor.Message.request("engine","query-engine-info")).typescript}],this.webviewReady=["webview-ready",{depends:[],handle:async()=>{this.$scene.depend.finish("webview-ready"),this.$scene.ipc.setReady(!0)},reset:async()=>{Editor.Message.broadcast("scene:close"),this._softOpen=!0,this.$scene.ipc.setReady(!1)}}],this.webviewEngineInit=["webview-engine-init",{depends:["asset-db-ready","query-engine-info","webview-ready","packer-driver-ready"],handle:async()=>{try{const e=await Editor.Profile.getProject("project","layer"),t=await Editor.Profile.getProject("project","general.renderPipeline");await this.$scene.ipc.send("call-method",{module:"Startup",handler:"initEngine",params:[this.$scene.info,t,e],queue:!1,timeout:!1});const i=await Editor.Profile.getProject("project","general.designResolution");await this.$scene.ipc.send("call-method",{module:"Startup",handler:"initDesignResolution",params:[i.width,i.height],queue:!1,timeout:!1});const n=await Editor.Profile.getConfig("scene","camera.size");Editor.Message.send("scene","change-target-resolution",n)}catch(e){console.error(e)}this.$scene.depend.finish("webview-engine-init")}}],this.webviewManagerInit=["webview-manager-init",{depends:["webview-engine-init"],handle:async()=>{try{Editor.Metrics.trackTimeStart("[Metrics]open scene first time"),await this.$scene.ipc.send("call-method",{module:"Startup",handler:"initManager",params:[Object.assign(this.$scene.info,{project:Editor.Project.path})],queue:!1,timeout:!1}),await this.$scene.ipc.send("call-method",{module:"Ipc",handler:"startup",params:[],queue:!1,timeout:!1});const e=await Editor.Profile.getProject("engine","modules.includeModules");e&&!e.includes("3d")&&this.$scene.callSceneMethod("changeProjectMode",["2d"],!0),this.$scene.managerReady=!0,Editor.Metrics.trackTimeEnd("[Metrics]open scene first time",{output:!0})}catch(e){console.error(e)}this.$scene.setSceneManagerReady(!0),this.$scene.depend.finish("webview-manager-init")},reset:async()=>{this.$scene.managerReady=!1}}],this.packerDriverReady=["packer-driver-ready",{depends:[],handle:async()=>{const e=await Editor.Message.request("programming","packer-driver/ready","editor");return e?console.debug("Packer is ready. Immediately do first execution."):console.debug("Packer is not ready. Yield to wait for its completion."),e}}],this.autoOpenScene=["auto-open-scene",{depends:["editor-init","webview-manager-init"],handle:async()=>{let e=await Editor.Profile.getTemp("scene","current-scene")||"";e||(e=await Editor.Profile.getProject("scene","current-scene")||""),await this.$scene.callSceneMethod("openScene",[e]),this.$scene.depend.finish("auto-open-scene"),this._softOpen&&this._dump&&(await this.$scene.callSceneMethod("restoreAllScenes",[this._dump]),this._softOpen=!1)}}]}stagingDump(e,t){e&&(clearTimeout(this.tmpTimers[e]),this.tmpTimers[e]=setTimeout(()=>{const i=new Date,n=[i.getFullYear(),i.getMonth()+1,i.getDate()].join(""),s=[i.getHours(),i.getMinutes(),i.getSeconds()].map(e=>("0"+e).substr(-2)).join(""),r=join(this.tmpDir,e),a=join(r,n+" "+s+".json");outputFileSync(a,JSON.stringify(JSON.parse(t)));const o=readdirSync(r);for(;o.length>5;){const e=o.shift();removeSync(join(r,e))}},6e4))}updateDump(e){e?this._dump=e:this.$scene.ipc.isReady}}exports.default=new Tasks;