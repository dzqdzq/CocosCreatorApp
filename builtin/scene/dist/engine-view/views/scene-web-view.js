"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneView=void 0;const panel=require("@editor/panel"),{join:join}=require("path"),base_view_1=require("./base-view"),scene_web_ipc_1=__importDefault(require("../ipc/scene-web-ipc")),index_1=__importDefault(require("../ipc/index")),message_1=require("../ipc/message"),listener_1=require("../listener"),tasks_1=__importDefault(require("../tasks")),device_adapter_1=require("../../utils/device-adapter"),utils_1=require("../../utils/ipc/utils"),float_window_1=__importDefault(require("../plugin/float-window")),previewPreload=join(__dirname,"../../script/3d/preload/preview/preload.js"),previewURL=`packages://scene/static/template/3d-webview.html?url=${encodeURI(previewPreload)}`;class SceneView extends base_view_1.BaseView{constructor(){super(),this._isPreviewReady=!1,this._isPreviewFailed=!1,this._isPreviewEnabled=!1,this._readyResolve=null,this._lastSceneJson="",this._restarting=!1,this._platform="",this._previewIpc=null,this.previewMenuVisibled=!1,this._sceneIpc=new scene_web_ipc_1.default(this.$scene,utils_1.IPCChannel.SceneWebSend,utils_1.IPCChannel.SceneWebReply),this.ipc=new index_1.default(this._sceneIpc)}get isPreviewReady(){return this._isPreviewReady}set isPreviewReady(e){var i;this._isPreviewReady=e,null===(i=this._previewIpc)||void 0===i||i.setReady(e),e&&this._readyResolve&&this._readyResolve(!0)}get isPreviewFailed(){return this._isPreviewFailed}set isPreviewFailed(e){this._isPreviewFailed=e,e&&this._readyResolve&&this._readyResolve(!1)}async init(){Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{this._sceneIpc.on(e,message_1.EngineViewIPCMessages[e].bind(this))});const e=join(__dirname,`../../script/${Editor.Project.type}/preload/web/preload.js`);this._addWebview(this.$scene),this.$scene.setAttribute("style","pointer-events: none;flex:1;"),this.$scene.setAttribute("src",`packages://scene/static/template/${Editor.Project.type}-webview.html?url=${encodeURI(e)}`);let i=!1,t=null;this.$scene.addEventListener("dom-ready",()=>{i=!0,t&&t(),Editor.Profile.getConfig("preview","preview.current.platform","local").then(e=>{this.callPreviewMethod("setPlatform",e),requestAnimationFrame(()=>{device_adapter_1.DeviceAdapter.reset(this.$scene.clientWidth,this.$scene.clientHeight)})})}),Editor.Startup.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0]),(0,listener_1.init)(this),i||await new Promise(e=>{t=e})}async checkAvailability(e){return new Promise(i=>{this._isPreviewEnabled===e&&i(!1),this.isPreviewFailed&&(console.info(Editor.I18n.t("scene.game_view.failed")),i(!1)),this.isPreviewReady?i(!0):this._readyResolve=i})}async setPreviewEnabled(e){if(this._showLoading(),!await this.checkAvailability(e))return this._hideLoading(),!1;this._readyResolve=null;const i=await this._changePreviewState(e);return i&&(this._isPreviewEnabled=e,this.setPreviewMenuVisible(e),this._switchWebviewVisibility(e),this._updateTitle(e)),this._hideLoading(),i}async _changePreviewState(e){if(e){const i=await this.callSceneMethod("querySceneSerializedData")||"";this._lastSceneJson=i,await this.callSceneMethod("unregisterPreview");const[t,s]=await this.callEditorPreviewMethod("start");if(t)return console.error("Preview Error:",t),!1;this.ipc.setPreviewIpcEnabled(!0),await this.callSceneMethod("registerPreview"),await this.callSceneMethod("changePreviewPlayState",[e,i]),await this.changePreviewConfig()}else await this.callSceneMethod("changePreviewPlayState",[e]),await this.callSceneMethod("unregisterPreview"),this.ipc.setPreviewIpcEnabled(!1),await this.callSceneMethod("registerPreview"),await this.callSceneMethod("softReloadScene"),this.callSceneMethod("forceUpdatePlugin"),this._preview.reload(),this._lastSceneJson="";return!0}_switchWebviewVisibility(e){e?(this.$scene.setAttribute("style","display: none"),this.callSceneMethod("changeSceneViewVisible",[!1])):(this.$scene.setAttribute("style","pointer-events: none;flex:1;"),this._preview.setAttribute("style","display: none"),this.callSceneMethod("changeSceneViewVisible",[!0]))}_updateTitle(e){const i=panel.queryInfo("scene");i.userData.title=e?"i18n:scene.preview_title":"i18n:scene.title",panel.changeUserData("scene",i.userData)}setPreviewMenuVisible(e){var i;this.previewMenuVisibled=e,null===(i=this.previousElementSibling)||void 0===i||(i.__vue__.gameViewData.showGameView=e),device_adapter_1.DeviceAdapter.enable=e,e?(this.updateStyle(),float_window_1.default.unselect()):this.resetStyle()}async updateStyle(){var e,i;if(!(null===(e=this.previousElementSibling)||void 0===e?void 0:e.__vue__.gameViewData.showGameView))return;const t=null===(i=this.previousElementSibling)||void 0===i?void 0:i.__vue__.gameViewData,{rotate:s,scaleValue:a,devicesInfo:r,fullScreen:n}=t;let l=r.width,d=r.height;if("ratio"===r.type){const e=device_adapter_1.DeviceAdapter.ratioToSize(l,d);l=e.width,d=e.height}else if("design"===r.type){const e=await Editor.Profile.getProject("project","general.designResolution");l=e.width,d=e.height}else"free"===r.type&&(l=device_adapter_1.DeviceAdapter.screenWidth*window.devicePixelRatio,d=device_adapter_1.DeviceAdapter.screenHeight*window.devicePixelRatio);return device_adapter_1.DeviceAdapter.fitScreen(l,d,n,s,a/100),this._preview.setAttribute("style",`width:${device_adapter_1.DeviceAdapter.width}px; height:${device_adapter_1.DeviceAdapter.height}px;`),this._preview.parentElement&&(this._preview.parentElement.setAttribute("game-view",""),this._preview.parentElement.addEventListener("wheel",this.preventWheelScroll)),{scale:Math.floor(100*device_adapter_1.DeviceAdapter.scale)}}resetStyle(){this._preview.setAttribute("style","pointer-events: none;flex:1;"),this._preview.parentElement&&(this._preview.parentElement.removeAttribute("game-view"),this._preview.parentElement.removeEventListener("wheel",this.preventWheelScroll))}async changePreviewConfig(){var e;const i=null===(e=this.previousElementSibling)||void 0===e?void 0:e.__vue__.gameViewData,{fps:t,stats:s}=i;await this.callSceneMethod("callPreviewPlayMethod",["setFps",[t]]),await this.callSceneMethod("callPreviewPlayMethod",["showState",[s]])}async callPreviewMethod(e,...i){if(this._restarting)return!1;if("pause"===e){i[0]?this.setPreviewMenuVisible(!1):(this.setPreviewMenuVisible(!0),this.changePreviewConfig())}else if("setPlatform"===e){const e=i[0];if(e===this._platform)return;"gameView"===e?this._loadPreview():this._unloadPreview(),this._platform=e}return await this.callSceneMethod("callPreviewPlayMethod",[e,i])}preventWheelScroll(e){e.preventDefault()}_loadPreview(){this._preview=document.createElement("webview"),this._addWebview(this._preview),this._preview.setAttribute("src",previewURL),this._preview.setAttribute("style",`position:absolute; width:${device_adapter_1.DeviceAdapter.screenWidth}px;height:${device_adapter_1.DeviceAdapter.screenHeight}px;`),this._preview.addEventListener("dom-ready",()=>{this._restarting||this._preview.setAttribute("style","display:none")}),this._previewIpc=new scene_web_ipc_1.default(this._preview,utils_1.IPCChannel.PreviewSend,utils_1.IPCChannel.PreviewReply),this.ipc.setPreviewIpc(this._previewIpc),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{this._previewIpc.on(e,message_1.EngineViewIPCMessages[e].bind(this))})}_unloadPreview(){this._preview&&(this.removeChild(this._preview),this._hideLoading(),this.isPreviewFailed=!1,this.isPreviewReady=!1,this._isPreviewEnabled=!1,this._restarting=!1,this._preview=null,this._readyResolve&&(this._readyResolve(!1),this._readyResolve=null))}_addWebview(e){e.setAttribute("webPreferences","webgl=1,nativeWindowOpen=1,contextIsolation=0,backgroundThrottling=0"),e.setAttribute("contextIsolation","false"),e.setAttribute("nodeintegration","true"),e.setAttribute("nodeintegrationinsubframes","true"),e.setAttribute("enableremotemodule","true"),e.setAttribute("disablewebsecurity","true"),e.setAttribute("allowpopups","true"),this.appendChild(e)}async callEditorPreviewMethod(e,i=[]){return new Promise(t=>{var s;null===(s=this._previewIpc)||void 0===s||s.send("call-method",{module:"EditorPreview",handler:e,params:i,queue:!0,timeout:!1}).then(e=>{t([null,e])}).catch(e=>{t([e,null])})})}async restartPreview(){var e;if(this._preview){this._restarting=!0,this._showLoading(),null===(e=this._previewIpc)||void 0===e||e.setReady(!1);const i=(async()=>{var e,t;console.log("did-finish-load"),this._preview.removeEventListener("did-finish-load",i),null===(e=this._previewIpc)||void 0===e||e.clearBuffer(),null===(t=this._previewIpc)||void 0===t||t.setReady(!0);const[s,a]=await this.callEditorPreviewMethod("start");if(s)return console.error("Preview Error:",s,a),!1;console.log("preview started",this._lastSceneJson),await this.callSceneMethod("registerPreview"),await this.callSceneMethod("changePreviewPlayState",[!0,this._lastSceneJson]),await this.changePreviewConfig(),this._hideLoading(),this._restarting=!1}).bind(this);this._preview.addEventListener("did-finish-load",i),this._preview.reload()}}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}}exports.SceneView=SceneView;