"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseView=void 0;const{join:join}=require("path"),vDependence=require("v-dependence"),tasks_1=__importDefault(require("../tasks")),float_window_1=__importDefault(require("../plugin/float-window")),toolbar_1=__importDefault(require("../plugin/toolbar")),infobar_1=__importDefault(require("../plugin/infobar"));class BaseView extends window.HTMLElement{constructor(){super(),this.dirty=!1,this.managerReady=!1,this.$scene=document.createElement("webview"),this.depend=vDependence.create(),this.$floatWindow=float_window_1.default.get(),this.isSceneManagerReady=!1,this.sceneMessageBuffer=[],tasks_1.default.$scene=this,toolbar_1.default.init(this.previousElementSibling),infobar_1.default.init(this.nextElementSibling),this.setAttribute("tabindex","-1"),this.$scene.addEventListener("destroyed",()=>{this.depend.reset(tasks_1.default.webviewReady[0])}),this.depend.add(...tasks_1.default.editorInit),this.depend.add(...tasks_1.default.assetDbReady),this.depend.add(...tasks_1.default.queryEngineInfo),this.depend.add(...tasks_1.default.webviewReady),this.depend.add(...tasks_1.default.webviewEngineInit),this.depend.add(...tasks_1.default.webviewManagerInit),this.depend.add(...tasks_1.default.packerDriverReady),this.depend.add(...tasks_1.default.autoOpenScene),this.appendChild(this.$floatWindow)}async init(){}async callSceneMethod(e,t=[],a=!1,i=!0){return a||tasks_1.default.updateDump(),new Promise((n,d)=>{const s=function(e,t){e?d(e):n(t)};if(!this.isSceneManagerReady){const n={module:"SceneFacadeManager",handler:e,params:t,queue:!a,timeout:i,callback:s};return this.sceneMessageBuffer.push(n)}this.ipc.send("call-method",{module:"SceneFacadeManager",handler:e,params:t,queue:!a,timeout:i}).then(e=>{s(null,e)}).catch(e=>{s(e,null)})})}setSceneManagerReady(e){this.isSceneManagerReady=e,this.isSceneManagerReady&&this.sceneMessageBuffer.forEach(e=>{this.ipc.send("call-method",{module:e.module,handler:e.handler,params:e.params,queue:e.queue,timeout:e.timeout}).then(t=>{e.callback(null,t)})})}async executeComponentMethod(e){return this.dirty=!0,await this.ipc.send("call-method",{module:"Scene",handler:"executeComponentMethod",params:[e.uuid,e.index,...e.methodNames||[]],queue:!0,timeout:!0})}attachFloatWindow(e,t){float_window_1.default.register(e,t)}detachFloatWindow(e){float_window_1.default.unregister(e)}attachToolbar(e,t){toolbar_1.default.register(e,t)}detachToolbar(e){toolbar_1.default.unregister(e)}attachInfobar(e,t){infobar_1.default.register(e,t)}detachInfobar(e){infobar_1.default.unregister(e)}}exports.BaseView=BaseView;