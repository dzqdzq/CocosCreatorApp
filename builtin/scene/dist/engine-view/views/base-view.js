"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,n,i)}:function(e,t,a,n){e[n=void 0===n?a:n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var i=function(e){return(i=Object.getOwnPropertyNames||function(e){var t,a=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[a.length]=t);return a})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a=i(e),n=0;n<a.length;n++)"default"!==a[n]&&__createBinding(t,e,a[n]);return __setModuleDefault(t,e),t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseView=void 0;const vDependence=require("v-dependence"),float_window_1=__importDefault(require("../plugin/float-window")),tasks_1=__importDefault(require("../tasks")),toolbar=__importStar(require("../plugin/toolbar")),toolbar_1=require("../plugin/toolbar"),infobar_1=__importDefault(require("../plugin/infobar")),listener_1=require("../listener"),lodash_1=require("lodash");class BaseView extends HTMLElement{dirty=!1;managerReady=!1;isPreviewEnabled=!1;$scene;previewClient;depend=vDependence.create();$floatWindow=float_window_1.default.get();ipc;info;isSceneManagerReady=!1;sceneMessageBuffer=[];_gameViewService=toolbar_1.NullGameViewService;__plugin_info__=null;_updatePluginDebounce=null;constructor(){super(),(tasks_1.default.$scene=this).setAttribute("tabindex","-1"),this.depend.add(...tasks_1.default.editorInit),this.depend.add(...tasks_1.default.assetDbReady),this.depend.add(...tasks_1.default.queryEngineInfo),this.depend.add(...tasks_1.default.webviewReady),this.depend.add(...tasks_1.default.webviewEngineInit),this.depend.add(...tasks_1.default.webviewManagerInit),this.depend.add(...tasks_1.default.packerDriverReady),this.depend.add(...tasks_1.default.autoOpenScene),this.appendChild(this.$floatWindow),this._updatePluginDebounce=(0,lodash_1.debounce)((()=>{var e=this.__plugin_info__;if(e){const t={},a=[];e.nodes.forEach(e=>{e.components.forEach(e=>{a.includes(e.type)||a.push(e.type),(t[e.type]=t[e.type]||[]).push(e)})}),0<e.nodes.length?float_window_1.default.select(e,a,t):float_window_1.default.unselect(),toolbar.update(e,a,t),infobar_1.default.update(e,a,t)}}).bind(this),150)}async init(){this.$scene.webview.addEventListener("destroyed",()=>{this.depend.reset(tasks_1.default.webviewReady[0])}),await(0,listener_1.init)(this)}async callSceneMethod(i,r=[],d=!1,s=!0){return d||tasks_1.default.updateDump(),new Promise((a,n)=>{function t(e,t){e?n(e):a(t)}var e;if(!this.isSceneManagerReady)return e={module:"SceneFacadeManager",handler:i,params:r,queue:!d,timeout:s,callback:t},this.sceneMessageBuffer.push(e);this.ipc.send("call-method",{module:"SceneFacadeManager",handler:i,params:r,queue:!d,timeout:s}).then(e=>{t(null,e)}).catch(e=>{t(e,null)})})}setSceneManagerReady(e){this.isSceneManagerReady=e,this.isSceneManagerReady&&this.sceneMessageBuffer.forEach(t=>{this.ipc.send("call-method",{module:t.module,handler:t.handler,params:t.params,queue:t.queue,timeout:t.timeout}).then(e=>{t.callback(null,e)})})}async executeComponentMethod(e){return this.dirty=!0,this.ipc.send("call-method",{module:"Scene",handler:"executeComponentMethod",params:[e.uuid,e.index,...e.methodNames||[]],queue:!0,timeout:!0})}updatePlugin(e){this.__plugin_info__=e,this._updatePluginDebounce?.()}attachFloatWindow(e,t){float_window_1.default.register(e,t)}detachFloatWindow(e){float_window_1.default.unregister(e)}connectToGameView(e){this._gameViewService=e}attachToolbar(e,t){toolbar.register(e,t)}detachToolbar(e){toolbar.unregister(e)}attachInfobar(e,t){infobar_1.default.register(e,t)}detachInfobar(e){infobar_1.default.unregister(e)}onClose(){(0,listener_1.release)()}onCloseScene(e){this._gameViewService.onCloseScene(e)}onUpdateScene(e){this._gameViewService.onUpdateScene(e)}onSceneFocus(e){this._gameViewService.onSceneFocus(e)}onUpdateSceneDirty(e,t){this._gameViewService.onUpdateSceneDirty(e,t)}}exports.BaseView=BaseView;