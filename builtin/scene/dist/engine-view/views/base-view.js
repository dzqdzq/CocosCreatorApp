"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,n)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseView=void 0;const vDependence=require("v-dependence"),float_window_1=__importDefault(require("../plugin/float-window")),tasks_1=__importDefault(require("../tasks")),toolbar=__importStar(require("../plugin/toolbar")),toolbar_1=require("../plugin/toolbar"),infobar_1=__importDefault(require("../plugin/infobar")),listener_1=require("../listener"),lodash_1=require("lodash");class BaseView extends HTMLElement{constructor(){super(),this.dirty=!1,this.managerReady=!1,this.depend=vDependence.create(),this.$floatWindow=float_window_1.default.get(),this.isSceneManagerReady=!1,this.sceneMessageBuffer=[],this._gameViewService=toolbar_1.NullGameViewService,this.__plugin_info__=null,this._updatePluginDebounce=null,tasks_1.default.$scene=this,this.setAttribute("tabindex","-1"),this.depend.add(...tasks_1.default.editorInit),this.depend.add(...tasks_1.default.assetDbReady),this.depend.add(...tasks_1.default.queryEngineInfo),this.depend.add(...tasks_1.default.webviewReady),this.depend.add(...tasks_1.default.webviewEngineInit),this.depend.add(...tasks_1.default.webviewManagerInit),this.depend.add(...tasks_1.default.packerDriverReady),this.depend.add(...tasks_1.default.autoOpenScene),this.appendChild(this.$floatWindow),this._updatePluginDebounce=(0,lodash_1.debounce)((()=>{const e=this.__plugin_info__;if(!e)return;const t={},a=[];e.nodes.forEach(e=>{e.components.forEach(e=>{a.includes(e.type)||a.push(e.type),(t[e.type]=t[e.type]||[]).push(e)})}),e.nodes.length>0?float_window_1.default.select(e,a,t):float_window_1.default.unselect(),toolbar.update(e,a,t),infobar_1.default.update(e,a,t)}).bind(this),150)}async init(){this.$scene.webview.addEventListener("destroyed",()=>{this.depend.reset(tasks_1.default.webviewReady[0])}),(0,listener_1.init)(this)}async callSceneMethod(e,t=[],a=!1,i=!0){return a||tasks_1.default.updateDump(),new Promise((n,s)=>{const d=function(e,t){e?s(e):n(t)};if(!this.isSceneManagerReady){const n={module:"SceneFacadeManager",handler:e,params:t,queue:!a,timeout:i,callback:d};return this.sceneMessageBuffer.push(n)}this.ipc.send("call-method",{module:"SceneFacadeManager",handler:e,params:t,queue:!a,timeout:i}).then(e=>{d(null,e)}).catch(e=>{d(e,null)})})}setSceneManagerReady(e){this.isSceneManagerReady=e,this.isSceneManagerReady&&this.sceneMessageBuffer.forEach(e=>{this.ipc.send("call-method",{module:e.module,handler:e.handler,params:e.params,queue:e.queue,timeout:e.timeout}).then(t=>{e.callback(null,t)})})}async executeComponentMethod(e){return this.dirty=!0,await this.ipc.send("call-method",{module:"Scene",handler:"executeComponentMethod",params:[e.uuid,e.index,...e.methodNames||[]],queue:!0,timeout:!0})}updatePlugin(e){var t;this.__plugin_info__=e,null===(t=this._updatePluginDebounce)||void 0===t||t.call(this)}attachFloatWindow(e,t){float_window_1.default.register(e,t)}detachFloatWindow(e){float_window_1.default.unregister(e)}connectToGameView(e){this._gameViewService=e}attachToolbar(e,t){toolbar.register(e,t)}detachToolbar(e){toolbar.unregister(e)}attachInfobar(e,t){infobar_1.default.register(e,t)}detachInfobar(e){infobar_1.default.unregister(e)}onClose(){(0,listener_1.release)()}}exports.BaseView=BaseView;