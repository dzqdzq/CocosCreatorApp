"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeEngineView=void 0;const panel=require("@editor/panel"),base_view_1=require("../base-view"),index_1=__importDefault(require("../../ipc/index")),message_1=require("../../ipc/message"),tasks_1=__importDefault(require("../../tasks")),preview_client_1=require("./preview-client"),editor_client_1=require("./editor-client");class NativeEngineView extends base_view_1.BaseView{constructor(){super(),this.$scene=new editor_client_1.NativeEditorClient,this.previewClient=new preview_client_1.NativePreviewClient,this._isPreviewEnabled=!1,this._lastSceneJson="",this._platform=""}async init(){document.body.setAttribute("style","background:#434343"),this.$scene.load(this),this.ipc=new index_1.default(this.$scene.ipc),super.init(),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i,t;null===(t=null===(i=this.$scene.ipc)||void 0===i?void 0:i.on)||void 0===t||t.call(i,e,message_1.EngineViewIPCMessages[e].bind(this))}),Editor.Startup.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0])}async checkAvailable(e){return new Promise(async i=>{this._isPreviewEnabled===e&&i(!1),i(await this.previewClient.checkAvailable())})}async previewSetPlay(e){if(this._showLoading(),!await this.checkAvailable(e))return this._hideLoading(),!1;const i=await this._changePreviewState(e);return i&&(this._isPreviewEnabled=e,this._broadcastPreviewState()),this._hideLoading(),i}async _changePreviewState(e){if(e){const i=await this.safeCallSceneMethod("querySceneSerializedData",[])||"";this._lastSceneJson=i;const[t,a]=await this.callEditorPreviewMethod("start");if(t)return console.error("Preview Error:",t),!1;await Editor.Message.request("scene","create-preview-window",!0),this.ipc.setPreviewIpcEnabled(!0),await this.safeCallSceneMethod("changePreviewPlayState",[e,i]),await Editor.Message.request("scene","set-preview-window-visible",!0)}else await this.safeCallSceneMethod("changePreviewPlayState",[e]),this.ipc.setPreviewIpcEnabled(!1),await this.safeCallSceneMethod("softReloadScene",[]),this.safeCallSceneMethod("forceUpdatePlugin",[]),Editor.Message.send("scene","set-preview-window-visible",!1),this.previewClient.reload(),this._lastSceneJson="";return!0}resetStyle(){this.previewClient.resetStyle()}async previewUpdateConfig(){const e=await this._gameViewService.getGameViewData(),{fps:i,stats:t}=e;await this.safeCallSceneMethod("callPreviewPlayMethod",["setFps",i]),await this.safeCallSceneMethod("callPreviewPlayMethod",["showState",t])}async previewCallMethod(e,...i){if("setPlatform"===e){const e=i[0];if(e===this._platform)return;"gameView"===e?await this._loadPreview():await this._unloadPreview(),this._platform=e}return await this.safeCallSceneMethod("callPreviewPlayMethod",[e,...i])}_loadPreview(){this.previewClient.load(this),this.ipc.setPreviewIpc(this.previewClient.ipc),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i;null===(i=this.previewClient.ipc)||void 0===i||i.on(e,message_1.EngineViewIPCMessages[e].bind(this))})}_unloadPreview(){this.previewClient.unload(this),this._hideLoading(),this._isPreviewEnabled=!1}async restartPreview(){this._showLoading(),await this.previewClient.restart()&&(await this.safeCallSceneMethod("changePreviewPlayState",[!0,this._lastSceneJson]),await this.previewUpdateConfig()),this._hideLoading()}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}async safeCallSceneMethod(e,i,t=!1,a=!0){return new Promise(s=>{this.callSceneMethod(e,i,t,a).then(e=>{s(e)}).catch(t=>{console.debug("safeCallSceneMethod params",e,i),console.error(`SceneMethod ${e} executed failed:\n`,t),s(null)})})}async callEditorPreviewMethod(e,i=[]){return new Promise(t=>{this.previewClient.ipc.send("call-method",{module:"EditorPreview",handler:e,params:i,queue:!0,timeout:!1}).then(e=>{t([null,e])}).catch(e=>{t([e,null])})})}async callNativeSceneMethod(e=!1,i,...t){return new Promise(a=>{const s=e?this.previewClient.ipc:this.$scene.ipc;null===s||void 0===s||s.send("call-method",{module:"NativeScene",handler:i,params:t,queue:!0,timeout:!1}).then(e=>{a([null,e])}).catch(e=>{a([e,null])})})}_broadcastPreviewState(){Editor.Message.broadcast("scene:editor-preview-set-play",this._isPreviewEnabled)}}exports.NativeEngineView=NativeEngineView;