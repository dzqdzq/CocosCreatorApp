"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativeEngineView=void 0;const base_view_1=require("../base-view"),index_1=__importDefault(require("../../ipc/index")),message_1=require("../../ipc/message"),tasks_1=__importDefault(require("../../tasks")),preview_client_1=require("./preview-client"),editor_client_1=require("./editor-client"),panel_constant_1=require("../../../panel/panel-constant"),ipc_1=require("../../../panel/native/ipc");class NativeEngineView extends base_view_1.BaseView{constructor(){super(),this.$scene=new editor_client_1.NativeEditorClient,this.previewClient=new preview_client_1.NativePreviewClient,this.isPreviewEnabled=!1,this._lastSceneJson="",this._platform=""}listenIpc(e){e&&Object.keys(message_1.EngineViewIPCMessages).forEach(t=>{var i;null===(i=e.on)||void 0===i||i.call(e,t,async(...e)=>(ipc_1.PanelIpc.onSceneToPanel(t,...e),await message_1.EngineViewIPCMessages[t].call(this,...e)))})}async init(){document.body.setAttribute("style","background:#434343"),this.$scene.load(this),this.ipc=new index_1.default(this.$scene.ipc),super.init(),this.listenIpc(this.$scene.ipc),Editor.Startup.__protected__.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.__protected__.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0])}async checkAvailable(e){return new Promise(t=>{this.isPreviewEnabled===e&&t(!1),this.previewClient.checkAvailable().then(t)})}async previewSetPlay(e){if(this._showLoading(),!await this.checkAvailable(e))return this._hideLoading(),!1;this._broadcastPreviewState(panel_constant_1.EditorPreviewState.Changing,e);const t=await this._changePreviewState(e);return t&&(this.isPreviewEnabled=e,this._broadcastPreviewState(e?panel_constant_1.EditorPreviewState.Start:panel_constant_1.EditorPreviewState.Stop,e)),this._hideLoading(),t}async _changePreviewState(e){if(e){const t=await this.safeCallSceneMethod("querySceneSerializedData",[])||"";this._lastSceneJson=t;const[i,a]=await this.callEditorPreviewMethod("start");if(i)return console.error("Preview Error:",i),!1;this.ipc.setPreviewIpcEnabled(!0),await this.safeCallSceneMethod("changePreviewPlayState",[e,t])}else await this.safeCallSceneMethod("changePreviewPlayState",[e]),this.ipc.setPreviewIpcEnabled(!1),await this.safeCallSceneMethod("softReloadScene",[]),this.safeCallSceneMethod("forceUpdatePlugin",[]),this.previewClient.reload(),this._lastSceneJson="";return!0}resetStyle(){this.previewClient.resetStyle()}async previewUpdateConfig(){const e=await this._gameViewService.getGameViewData(),{fps:t,stats:i}=e;await this.safeCallSceneMethod("callPreviewPlayMethod",["setFps",t]),await this.safeCallSceneMethod("callPreviewPlayMethod",["showState",i])}async previewCallMethod(e,...t){if("setPlatform"===e){const e=t[0];if(e===this._platform)return;"gameView"===e?await this._loadPreview():await this._unloadPreview(),this._platform=e}return await this.safeCallSceneMethod("callPreviewPlayMethod",[e,...t])}_loadPreview(){this.previewClient.load(this),this.ipc.setPreviewIpc(this.previewClient.ipc),this.listenIpc(this.previewClient.ipc)}_unloadPreview(){this.previewClient.unload(this),this._hideLoading(),this.isPreviewEnabled=!1}async restartPreview(){this._showLoading(),await this.previewClient.restart()&&(await this.safeCallSceneMethod("changePreviewPlayState",[!0,this._lastSceneJson]),await this.previewUpdateConfig()),this._hideLoading()}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}async safeCallSceneMethod(e,t,i=!1,a=!0){return new Promise(s=>{this.callSceneMethod(e,t,i,a).then(e=>{s(e)}).catch(i=>{console.debug("safeCallSceneMethod params",e,t),console.error(`SceneMethod ${e} executed failed:\n`,i),s(null)})})}async callEditorPreviewMethod(e,t=[]){return new Promise(i=>{this.previewClient.ipc.send("call-method",{module:"EditorPreview",handler:e,params:t,queue:!0,timeout:!1}).then(e=>{i([null,e])}).catch(e=>{i([e,null])})})}async callNativeSceneMethod(e=!1,t,...i){return new Promise(a=>{const s=e?this.previewClient.ipc:this.$scene.ipc;null===s||void 0===s||s.send("call-method",{module:"NativeScene",handler:t,params:i,queue:!0,timeout:!1}).then(e=>{a([null,e])}).catch(e=>{a([e,null])})})}_broadcastPreviewState(e,t){Editor.Message.broadcast("scene:editor-preview-set-play",e,t)}}exports.NativeEngineView=NativeEngineView;