"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NativePreviewClient=void 0;const{join:join}=require("path"),scene_native_ipc_1=__importDefault(require("../../ipc/scene-native-ipc")),utils_1=require("../../../script/utils/ipc/utils"),remote_1=require("@electron/remote"),base_client_1=require("../base-client"),previewPreload=join(__dirname,"../../../script/3d/preload/native/preview.js"),previewURL=`packages://scene/static/template/3d-webview.html?url=${encodeURI(previewPreload)}`,PreviewMessages={"preview-ready"(){this.isPreviewReady=!0},"preview-failed"(){this.isPreviewFailed=!0},"preview-close"(){this.isPreviewReady=!1,this.isPreviewFailed=!1},"preview-restart"(){this.restart()}};class NativePreviewClient extends base_client_1.BaseClient{get isPreviewReady(){return this._isPreviewReady}set isPreviewReady(e){this._isPreviewReady=e,this.ipc.setReady(e),e&&this._readyResolve&&this._readyResolve(!0)}get isPreviewFailed(){return this._isPreviewFailed}set isPreviewFailed(e){this._isPreviewFailed=e,e&&this._readyResolve&&this._readyResolve(!1)}constructor(){super(),this._restarting=!1,this._loaded=!1,this._isPreviewReady=!1,this._isPreviewFailed=!1,this._readyResolve=null}preventWheelScroll(e){e.preventDefault()}async load(e){super.load(e),this.webview.setAttribute("src",previewURL),this.webview.setAttribute("style","position:absolute; width:100%;height:100%;"),this.webview.addEventListener("dom-ready",()=>{this._restarting||(this._loaded=!0);const i=remote_1.webContents.fromId(this.webview.getWebContentsId());null===i||void 0===i||i.setBackgroundThrottling(!1),null===i||void 0===i||i.on("render-process-gone",(i,t)=>{"crashed"===t.reason&&(this.unload(e),this._isPreviewFailed=!0)})}),this.ipc=new scene_native_ipc_1.default(this.webview,utils_1.IPCChannel.PreviewSend,utils_1.IPCChannel.PreviewReply),this._listerPreviewEvent()}_listerPreviewEvent(){Object.keys(PreviewMessages).forEach(e=>{var i,t;null===(t=null===(i=this.ipc)||void 0===i?void 0:i.on)||void 0===t||t.call(i,e,PreviewMessages[e].bind(this))})}unload(e){this._loaded&&(this.isPreviewFailed=!1,this.isPreviewReady=!1,this._loaded=!1,this._readyResolve&&(this._readyResolve(!1),this._readyResolve=null),this.webview.setAttribute("src",""),this.webview.parentElement&&this.webview.parentElement.removeChild(this.webview))}show(){this.webview.setAttribute("style","pointer-events: none;flex:1;")}hide(){}async updateStyle(e){return{scale:1}}resetStyle(){}async restart(){return new Promise((e,i)=>{this._showLoading(),this._restarting=!0,this.ipc.setReady(!1);const t=(async()=>{this.webview.removeEventListener("did-finish-load",t),this.ipc.clearBuffer(),this.ipc.setReady(!0);const[i,s]=await this.callEditorPreviewMethod("start");this._restarting=!1,this._hideLoading(),i?(console.error("Preview Error:",i,s),e(!1)):e(!0)}).bind(this);this.webview.addEventListener("did-finish-load",t),this.webview.reload()})}async checkAvailable(){return new Promise(e=>{this.isPreviewFailed&&(console.error(Editor.I18n.t("scene.game_view.failed")),e(!1)),this.isPreviewReady?e(!0):this._readyResolve=e})}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}}exports.NativePreviewClient=NativePreviewClient;