"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebEngineView=void 0;const panel=require("@editor/panel"),base_view_1=require("../base-view"),index_1=__importDefault(require("../../ipc/index")),message_1=require("../../ipc/message"),listener_1=require("../../listener"),tasks_1=__importDefault(require("../../tasks")),device_adapter_1=require("../../../script/utils/device-adapter"),float_window_1=__importDefault(require("../../plugin/float-window")),preview_client_1=require("./preview-client"),editor_client_1=require("./editor-client");class WebEngineView extends base_view_1.BaseView{constructor(){super(),this.$scene=new editor_client_1.EditorClient,this.previewClient=new preview_client_1.PreviewClient,this._isPreviewEnabled=!1,this._lastSceneJson="",this._platform="",this.previewMenuVisibled=!1}async init(){await this.$scene.load(this),this.ipc=new index_1.default(this.$scene.ipc),super.init(),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i,t;null===(t=null===(i=this.$scene.ipc)||void 0===i?void 0:i.on)||void 0===t||t.call(i,e,message_1.EngineViewIPCMessages[e].bind(this))}),Editor.Startup.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0]),(0,listener_1.init)(this)}async checkAvailable(e){return new Promise(async i=>{this._isPreviewEnabled===e&&i(!1),i(await this.previewClient.checkAvailable())})}async previewSetPlay(e){if(this._showLoading(),!await this.checkAvailable(e))return this._hideLoading(),!1;const i=await this._changePreviewState(e);return i&&(this._isPreviewEnabled=e,this._setPreviewMenuVisible(e),this._switchWebviewVisibility(e),this._updateTitle(e),this._broadcastPreviewState()),this._hideLoading(),i}async _changePreviewState(e){if(e){const i=await this.callSceneMethod("querySceneSerializedData",[])||"";this._lastSceneJson=i,await this.callSceneMethod("unregisterPreview",[]);const[t,s]=await this.callEditorPreviewMethod("start");if(t)return console.error("Preview Error:",t),!1;this.ipc.setPreviewIpcEnabled(!0),await this.callSceneMethod("registerPreview",[]),await this.callSceneMethod("changePreviewPlayState",[e,i]),await this.previewUpdateConfig()}else await this.callSceneMethod("changePreviewPlayState",[e]),await this.callSceneMethod("unregisterPreview",[]),this.ipc.setPreviewIpcEnabled(!1),await this.callSceneMethod("registerPreview",[]),await this.callSceneMethod("softReloadScene",[]),this.callSceneMethod("forceUpdatePlugin",[]),this.previewClient.reload(),this._lastSceneJson="";return!0}_switchWebviewVisibility(e){e?(this.$scene.hide(),this.callSceneMethod("changeSceneViewVisible",[!1])):(this.$scene.show(),this.previewClient.hide(),this.callSceneMethod("changeSceneViewVisible",[!0]))}_updateTitle(e){const i=panel.queryInfo("scene");i.userData.title=e?"i18n:scene.preview_title":"i18n:scene.title",panel.changeUserData("scene",i.userData)}_setPreviewMenuVisible(e){this.previewMenuVisibled=e,this._gameViewService.setGameViewVisible(e),device_adapter_1.WebAdapter.enable=e,e?(this.previewUpdateStyle(),float_window_1.default.unselect()):this.resetStyle()}async previewUpdateStyle(){const e=await this._gameViewService.getGameViewData();if(await this._gameViewService.showGameView())return device_adapter_1.WebAdapter.reset(this.clientWidth,this.clientHeight),await this.previewClient.updateStyle(e)}resetStyle(){this.previewClient.resetStyle()}async previewUpdateConfig(){const e=await this._gameViewService.getGameViewData(),{fps:i,stats:t}=e;await this.callSceneMethod("callPreviewPlayMethod",["setFps",i]),await this.callSceneMethod("callPreviewPlayMethod",["showState",t])}async previewCallMethod(e,...i){if("pause"===e){i[0]?this._setPreviewMenuVisible(!1):(this._setPreviewMenuVisible(!0),this.previewUpdateConfig())}else if("setPlatform"===e){const e=i[0];if(e===this._platform)return;"gameView"===e?this._loadPreview():this._unloadPreview(),this._platform=e}return await this.callSceneMethod("callPreviewPlayMethod",[e,...i])}_loadPreview(){this.previewClient.load(this),this.ipc.setPreviewIpc(this.previewClient.ipc),Object.keys(message_1.EngineViewIPCMessages).forEach(e=>{var i;null===(i=this.previewClient.ipc)||void 0===i||i.on(e,message_1.EngineViewIPCMessages[e].bind(this))})}_unloadPreview(){this.previewClient.unload(this),this._hideLoading(),this._isPreviewEnabled=!1}async callEditorPreviewMethod(e,i=[]){return new Promise(t=>{this.previewClient.ipc.send("call-method",{module:"EditorPreview",handler:e,params:i,queue:!0,timeout:!1}).then(e=>{t([null,e])}).catch(e=>{t([e,null])})})}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}_broadcastPreviewState(){Editor.Message.broadcast("scene:editor-preview-set-play",this._isPreviewEnabled)}}exports.WebEngineView=WebEngineView;