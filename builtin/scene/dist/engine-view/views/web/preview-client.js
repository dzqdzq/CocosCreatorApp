"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewClient=void 0;const{join:join}=require("path"),scene_web_ipc_1=__importDefault(require("../../ipc/scene-web-ipc")),utils_1=require("../../../script/utils/ipc/utils"),device_adapter_1=require("../../../script/utils/device-adapter"),base_client_1=require("../base-client"),previewPreload=join(__dirname,"../../../script/3d/preload/preview/preload.js"),previewURL=`packages://scene/static/template/3d-webview.html?url=${encodeURI(previewPreload)}`,PreviewMessages={"preview-ready"(){this.isPreviewReady=!0},"preview-failed"(){this.isPreviewFailed=!0},"preview-close"(){this.isPreviewReady=!1,this.isPreviewFailed=!1},"preview-restart"(){this.restart()}};class PreviewClient extends base_client_1.BaseClient{constructor(){super(),this._restarting=!1,this._loaded=!1,this._isPreviewReady=!1,this._isPreviewFailed=!1,this._isPreviewEnabled=!1,this._readyResolve=null}get isPreviewReady(){return this._isPreviewReady}set isPreviewReady(e){this._isPreviewReady=e,this.ipc.setReady(e),e&&this._readyResolve&&this._readyResolve(!0)}get isPreviewFailed(){return this._isPreviewFailed}set isPreviewFailed(e){this._isPreviewFailed=e,e&&this._readyResolve&&this._readyResolve(!1)}preventWheelScroll(e){e.preventDefault()}async load(e){super.load(e),this.webview.setAttribute("src",previewURL),this.webview.setAttribute("style",`position:absolute; width:${device_adapter_1.WebAdapter.screenWidth}px;height:${device_adapter_1.WebAdapter.screenHeight}px;`),this.webview.addEventListener("dom-ready",()=>{this._restarting||(this.webview.setAttribute("style","display:none"),this._loaded=!0)}),this.ipc=new scene_web_ipc_1.default(this.webview,utils_1.IPCChannel.PreviewSend,utils_1.IPCChannel.PreviewReply),this._listerPreviewEvent()}_listerPreviewEvent(){Object.keys(PreviewMessages).forEach(e=>{var i,t;null===(t=null===(i=this.ipc)||void 0===i?void 0:i.on)||void 0===t||t.call(i,e,PreviewMessages[e].bind(this))})}unload(e){this._loaded&&(this.isPreviewFailed=!1,this.isPreviewReady=!1,this._loaded=!1,this._readyResolve&&(this._readyResolve(!1),this._readyResolve=null),this.webview.setAttribute("src",""),this.webview.reload(),e.removeChild(this.webview))}show(){}hide(){this.webview.setAttribute("style","display: none")}async updateStyle(e){const i=e,{rotate:t,scaleValue:s,devicesInfo:r,fullScreen:a}=i;let d=r.width,l=r.height;if("ratio"===r.type){const e=device_adapter_1.WebAdapter.ratioToSize(d,l);d=e.width,l=e.height}else if("design"===r.type){const e=await Editor.Profile.getProject("project","general.designResolution");d=e.width,l=e.height}else"free"===r.type&&(d=device_adapter_1.WebAdapter.screenWidth*window.devicePixelRatio,l=device_adapter_1.WebAdapter.screenHeight*window.devicePixelRatio);return device_adapter_1.WebAdapter.fitScreen(d,l,a,t,s/100),this.webview.setAttribute("style",`width:${device_adapter_1.WebAdapter.width}px; height:${device_adapter_1.WebAdapter.height}px;`),this.webview.parentElement&&(this.webview.parentElement.setAttribute("game-view",""),this.webview.parentElement.addEventListener("wheel",this.preventWheelScroll)),{scale:Math.floor(100*device_adapter_1.WebAdapter.scale)}}resetStyle(){this.webview.setAttribute("style","pointer-events: none;flex:1;"),this.webview.parentElement&&(this.webview.parentElement.removeAttribute("game-view"),this.webview.parentElement.removeEventListener("wheel",this.preventWheelScroll))}async restart(){return new Promise((e,i)=>{this._showLoading(),this._restarting=!0,this.ipc.setReady(!1);const t=(async()=>{this.webview.removeEventListener("did-finish-load",t),this.ipc.clearBuffer(),this.ipc.setReady(!0);const[i,s]=await this.callEditorPreviewMethod("start");this._restarting=!1,this._hideLoading(),i?(console.error("Preview Error:",i,s),e(!1)):e(!0)}).bind(this);this.webview.addEventListener("did-finish-load",t),this.webview.reload()})}async checkAvailable(){return new Promise(e=>{this.isPreviewFailed&&(console.info(Editor.I18n.t("scene.game_view.failed")),e(!1)),this.isPreviewReady?e(!0):this._readyResolve=e})}_showLoading(){Editor.Message.broadcast("scene:show-loading")}_hideLoading(){Editor.Message.broadcast("scene:hide-loading")}}exports.PreviewClient=PreviewClient;