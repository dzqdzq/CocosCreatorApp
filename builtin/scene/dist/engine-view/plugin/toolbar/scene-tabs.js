"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ToolbarSceneTabs=void 0;const path_1=require("path"),scene_tab_item_1=__importDefault(require("./scene-tab-item")),scene_tab_drag_1=require("./scene-tab-drag"),Vue=require("vue/dist/vue.js"),template=`
    <div class="tabs-container" @mouseenter="scrollbarVisible = true" @mouseleave="scrollbarVisible = false">
        <div 
            ref='scrollTrack' 
            :class="['tabs-scrollbar-track', scrollbarVisible || isThumbDragging? 'tabs-scrollbar-show' : '']"
        >
            <div 
                class="tabs-scrollbar-thumb" 
                ref='scrollThumb'
                @mousedown="onThumbMouseDown"
                :style="{width: this.scrollbarStyle.width, left: this.scrollbarStyle.left}"
            ></div>
        </div> 
        <div class="tabs-content" ref="tabContent">
            <div class="tabs-toolbar" ref="tabToolbar" >
                <template v-for="(tab, index) in tabs"> 
                    <scene-tab-item 
                        :key="tab.uuid" 
                        :id="index" 
                        :data="tab"
                        :icon="tab.type"
                        :active="currentTabIndex === index" 
                        :title="getName(tab)"
                        :closeable="tabs.length > 1"
                        @select="onChangeTab"
                        @contextmenu="onContextmenuEvent"
                        @close="onClose"
                    >
                    </scene-tab-item>
                </template>
            </div>
        </div>
    </div>
`;exports.ToolbarSceneTabs=Vue.extend({name:"ToolbarSceneTabs",components:{SceneTabItem:scene_tab_item_1.default},props:{},data(){return{processingUuids:new Set,currentTabIndex:-1,canChangeTab:!0,tabs:[],leftEnabled:!1,rightEnabled:!1,scrollbarVisible:!1,scrollbarStyle:{width:"0px",left:"0px"},resizeHandle:null,isThumbDragging:!1,thumbStartX:0,startDragX:0}},watch:{currentTabIndex(){this.scrollToCurrentTab()}},async mounted(){var e=await Editor.Profile.getConfig("scene","scene.multi");const t=async()=>{this.tabs=await this.querySceneInfo()||[],this.currentTabIndex=this.tabs.length-1,console.debug("ToolbarSceneTabs mounted started"),Editor.Message.__protected__.removeBroadcastListener("scene:ready",t),this.$nextTick(()=>this.calculateScroll())};e&&Editor.Message.__protected__.addBroadcastListener("scene:ready",t);e=this.$refs.tabContent;e&&(e.addEventListener("wheel",this.onMouseWheel,{passive:!1}),e.addEventListener("scroll",this.onScrollEvent),this.resizeHandle=new window.ResizeObserver(()=>this.calculateScroll()).observe(e)),this.$refs.tabToolbar&&new scene_tab_drag_1.SceneTagDrag(this.$refs.tabToolbar,{draggable:".tab-container",animate:100,easing:"ease-in",onEnd:({newIndex:e,oldIndex:t})=>{e!==t&&(t=this.tabs[t],e=e>=this.tabs.length-1?"end":this.tabs[e],t)&&e&&this.moveTabsTo(t.uuid,"end"===e?"end":e.uuid)}})},beforeDestroy(){var e=this.$refs.tabContent;e&&(e.removeEventListener("wheel",this.onMouseWheel),e.removeEventListener("scroll",this.onScrollEvent),this.resizeHandle)&&(this.resizeHandle.disconnect(),this.resizeHandle=null)},methods:{getName(e){var t=(0,path_1.basename)(e.name,(0,path_1.extname)(e.name));return e.dirty?t+"*":t},async isDirty(){var e=(await Editor.Windows.__protected__.queryMainTitle()).split(" - ");return!!e[0]&&e[0].includes(".scene*")},addTab(e,t){return this.tabs.push({uuid:e,name:t?.displayName||t?.name||"Untitled",type:t?.type,dirty:!1}),this.tabs.length-1},async onCloseScene(e){await this._updateTabs()},async _updateTabs(){this.tabs=await this.querySceneInfo()||[],this.currentTabIndex=await this.querySceneFocus()},async closeOthers(e){return Editor.Message.request("scene","multi-close-others",e)},async closeToTheRight(e){return Editor.Message.request("scene","multi-close-to-the-right",e)},async moveTabsTo(e,t){return Editor.Message.request("scene","multi-move-tabs-to",e,t)},async onUpdateSceneDirty(){await this._updateTabs();Editor.EditMode.getMode()},async querySceneInfo(){return Editor.Message.request("scene","multi-scene-query")},async querySceneFocus(){const t=await Editor.Message.request("scene","multi-scene-focus-query");return this.tabs.findIndex(e=>e.uuid===t)},onSceneFocus(t){this.currentTabIndex=this.tabs.findIndex(e=>e.uuid===t)},async closeScene(e){return Editor.Message.send("scene","multi-close-scene",e)},async onUpdateScene(e){try{await this._updateTabs(),this.currentTabIndex>=this.tabs.length&&(this.currentTabIndex=this.tabs.length-1)}catch(e){console.error(e)}},setCurrentTabIndex(e){e<0?e=0:e>=this.tabs.length&&(e=this.tabs.length-1);var t=this.tabs[e];t&&this.currentTabIndex!==e&&(this.currentTabIndex=e,Editor.Message.send("scene","multi-scene-focus",t.uuid))},removeTab(e){-1!==e&&(this.tabs.splice(e,1),this.onChangeTab(e))},onChangeTab(e){this.isThumbDragging||this.canChangeTab&&this.setCurrentTabIndex(e)},async locateResource(e){Editor.Message.send("assets","twinkle",e.uuid,"shrink")},onContextmenuEvent(e,t,s){Editor.Menu.popup({menu:[{label:"i18n:scene.multi_tab_contextmenu.close",enabled:1<this.tabs.length,click:()=>{this.onClose(t)}},{label:"i18n:scene.multi_tab_contextmenu.close_others",enabled:1<this.tabs.length,click:()=>{this.closeOthers(s.uuid)}},{label:"i18n:scene.multi_tab_contextmenu.close_to_right",enabled:t<this.tabs.length-1,click:()=>{this.closeToTheRight(s.uuid)}},{type:"separator"},{label:"i18n:scene.multi_tab_contextmenu.locate_resource",click:()=>{this.locateResource(s)}}]})},onClose(e){this.canChangeTab&&(console.debug("close-scene "+e),e=this.tabs[e].uuid)&&this.closeScene(e)},calculateScroll(){var e,t,s,a=this.$refs.tabContent,n=this.$refs.scrollTrack;if(a&&n)return e=this.$refs.tabToolbar.scrollWidth,s=1<=(s=(t=a.clientWidth)/e)?0:Math.max(30,n.clientWidth*s),a=a.scrollLeft/(e-t),n=n.clientWidth-s,this.scrollbarStyle={width:s+"px",left:a*n+"px"},{contentWidth:e,visibleWidth:t,thumbWidth:s}},onMouseWheel(t){var s=this.$refs.tabContent;if(s&&(t.preventDefault(),0!==t.deltaY||0!==t.deltaX)){var a=0!==t.deltaX&&Math.abs(t.deltaY)<Math.abs(t.deltaX),n=t.wheelDelta&&t.wheelDelta%120!=0?5:25;let e;e=a?s.scrollLeft+(0<t.deltaX?n:-n):s.scrollLeft+(0<t.deltaY?n:-n),s.scrollTo({left:e,behavior:"auto"})}},onScrollEvent(e){requestAnimationFrame(()=>this.calculateScroll())},onThumbMouseDown(e){this.$refs.scrollThumb&&(e.preventDefault(),this.isThumbDragging=!0,this.thumbStartX=parseFloat(this.scrollbarStyle.left||"0"),this.startDragX=e.clientX,document.addEventListener("mousemove",this.onThumbMouseMove),document.addEventListener("mouseup",this.onThumbMouseUp))},onThumbMouseMove(e){var t,s,a;this.isThumbDragging&&(t=this.calculateScroll())&&({contentWidth:t,visibleWidth:s,thumbWidth:a}=t,e=e.clientX-this.startDragX,a=this.$refs.scrollTrack.clientWidth-a,e=this.thumbStartX+e,e=Math.max(0,Math.min(e,a)),this.scrollbarStyle.left=e+"px",this.$refs.tabContent.scrollLeft=e/a*(t-s))},onThumbMouseUp(){this.isThumbDragging=!1,document.removeEventListener("mousemove",this.onThumbMouseMove),document.removeEventListener("mouseup",this.onThumbMouseUp)},scrollToCurrentTab(){var e=this.$refs.tabContent,t=this.$refs.tabToolbar;!e||!t||this.currentTabIndex<0||(t=t.children[this.currentTabIndex])&&(t.offsetLeft<e.scrollLeft||t.offsetLeft+t.offsetWidth>e.scrollLeft+e.offsetWidth)&&e.scrollTo({left:t.offsetLeft,behavior:"smooth"})}},template:template});