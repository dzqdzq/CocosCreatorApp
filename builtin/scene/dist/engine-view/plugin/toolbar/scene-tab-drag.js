"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneTagDrag=void 0;const closest=(t,e)=>{let i=t;for(;i;){if(i.matches(e))return i;i=i.parentElement}return null},css=(t,e,i)=>{var s=t&&t.style;if(s){if(void 0===i)return document.defaultView&&document.defaultView.getComputedStyle&&(i=document.defaultView.getComputedStyle(t,"")),void 0===e?i:i[e];s[e=e in s||-1!==e.indexOf("webkit")?e:"-webkit-"+e]=i+("string"==typeof i?"":"px")}};class SceneTagDrag{container;options;startX=0;startY=0;initialX=0;initialY=0;chosenEl=null;ghostEl=null;originalIndex=-1;pointerdownEventBind=this.pointerdownEvent.bind(this);pointermoveEventBind=this.pointermoveEvent.bind(this);pointerupEventBind=this.pointerupEvent.bind(this);constructor(t,e){this.container=t,this.options=e,this.init()}index(t,e){let i=0;if(!t||!t.parentNode)return-1;for(;t=t.previousElementSibling;)"TEMPLATE"===t.nodeName.toUpperCase()||t===this.ghostEl||e&&!t.matches(e)||i++;return i}createGhostEl(t){var e;this.chosenEl&&(this.originalIndex=this.index(t),this.ghostEl=t.cloneNode(!0),this.chosenEl.classList.add(this.options.chosenClass||"draggable-chosen"),this.ghostEl.classList.add(this.options.ghostClass||"draggable-ghost"),t=t.getBoundingClientRect(),e=this.container.getBoundingClientRect(),this.initialX=t.left-e.left,this.initialY=t.top-e.top,css(this.ghostEl,"transform",`translate(${this.initialX}px, ${this.initialY}px)`),css(this.ghostEl,"position","absolute"),css(this.ghostEl,"top","0"),css(this.ghostEl,"left","0"),css(this.ghostEl,"width",t.width+"px"),css(this.ghostEl,"height",t.height+"px"),css(this.ghostEl,"zIndex","9999"),this.container.appendChild(this.ghostEl),this.options.onGhostCreated)&&this.options.onGhostCreated(this.ghostEl)}pointerdownEvent(t){var e;0===t.button&&(e=closest(t.target,this.options.draggable))&&(this.chosenEl=e,this.startX=t.clientX+this.container.scrollLeft,this.startY=t.clientY,document.addEventListener("pointermove",this.pointermoveEventBind),document.addEventListener("pointerup",this.pointerupEventBind))}pointermoveEvent(t){t.preventDefault();var e,i=t.clientX+this.container.scrollLeft-this.startX,s=t.clientY-this.startY,n=this.options.triggerDistance||5;if(!this.ghostEl&&(Math.abs(i)>n||Math.abs(s)>n)){var s=closest(this.chosenEl,this.options.draggable);if(!s)return;this.createGhostEl(s)}this.ghostEl&&({right:n,left:s}=this.container.getBoundingClientRect(),e=this.ghostEl.getBoundingClientRect()["width"],i=Math.min(Math.max(0,this.initialX+i),n-s-e),css(this.ghostEl,"transform",`translate(${i}px, ${this.initialY}px)`),this.dragMoveEvent(t))}getClosestElem(t,e){let i=document.elementFromPoint(t,e),s=document;for(;i?.shadowRoot&&s!==i.shadowRoot;)s=i.shadowRoot,i=i.shadowRoot.elementFromPoint(t,e);return s.elementsFromPoint(t,e)}dragMoveEvent(t){var e,i,s,n,o,h;this.ghostEl&&this.chosenEl&&(h=this.ghostEl.getBoundingClientRect(),0==(i=(e=this.chosenEl.getBoundingClientRect()).left>h.left?-1:e.left<h.left?1:0)||(s=0<i?h.right:h.left,n=h.top+h.height/2,!(s=this.getClosestElem(s,n).find(t=>t.matches(this.options.draggable)&&t!==this.chosenEl&&t!==this.ghostEl)))||s.animated||(n=this.options.swapThreshold||.5,o=s.getBoundingClientRect(),(0<i?Math.abs(h.right-o.left):Math.abs(o.right-h.left))<o.width*n)||(h=s.nextElementSibling,0<i&&!h?this.container.appendChild(this.chosenEl):this.container.insertBefore(this.chosenEl,0<i?s.nextElementSibling:s),this.animate(s,o,e,this.options.animate||0)))}animate(t,e,i,s){var n;s&&(css(t,"transition",""),css(t,"transform",""),n=e.left-i.left,e=e.top-i.top,css(t,"transform",`translate(${n}px, ${e}px)`),t.offsetHeight,css(t,"transition","transform "+s+"ms"+(this.options.easing?" "+this.options.easing:"")),css(t,"transform","translate(0, 0)"),"number"==typeof t.animated&&clearTimeout(t.animated),t.animated=setTimeout(function(){css(t,"transition",""),css(t,"transform",""),t.animated=!1},s))}pointerupEvent(t){0===t.button&&(this.ghostEl&&(t=this.index(this.chosenEl),this.options.onEnd&&this.options.onEnd({oldIndex:this.originalIndex,newIndex:t}),this.ghostEl.remove(),this.ghostEl=null,this.originalIndex=-1,this.chosenEl)&&(this.chosenEl.classList.remove(this.options.chosenClass||"draggable-chosen"),this.chosenEl=null),document.removeEventListener("pointermove",this.pointermoveEventBind),document.removeEventListener("pointerup",this.pointerupEventBind))}init(){if(!this.options.draggable)throw new Error("draggable is required");this.container.addEventListener("pointerdown",this.pointerdownEventBind)}}exports.SceneTagDrag=SceneTagDrag;