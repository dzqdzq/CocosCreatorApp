"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=exports.start=exports.stop=exports.status=void 0;const device_adapter_1=require("../script/utils/device-adapter"),preview_client_1=require("./views/web/preview-client");let leftButton=!1,middleButton=!1,rightButton=!1,isClicked=!1;const utils={createMouseEvent(e,t){const n=t.getBoundingClientRect(),o={ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,x:e.pageX-n.x,y:e.pageY-n.y,clientX:e.clientX-n.x,clientY:e.clientY-n.y,deltaX:e.deltaX||0,deltaY:e.deltaY||0,wheelDeltaX:e.wheelDeltaX||0,wheelDeltaY:e.wheelDeltaY||0,moveDeltaX:e.movementX||0,moveDeltaY:e.movementY||0,movementX:e.movementX,movementY:e.movementY,leftButton:leftButton,middleButton:middleButton,rightButton:rightButton};if(device_adapter_1.WebAdapter.enable){const e=device_adapter_1.WebAdapter.deltaX,n=device_adapter_1.WebAdapter.deltaY;n>0?(o.y-=n,o.clientY-=n):(o.y+=t.scrollTop,o.clientY+=t.scrollTop),e>0?(o.x-=e,o.clientX-=e):(o.x+=t.scrollTop,o.clientX+=t.scrollLeft)}return o},createKeyboardEvent:e=>({ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,key:e.key,keyCode:e.keyCode,code:e.code}),createDragEvent(e,t){const{type:n,value:o,name:a,additional:u}=Editor.UI.DragArea.currentDragInfo||{},s=utils.createMouseEvent(e,t);s.name=a,s.type=n,s.value=o,s.values=[];let r=[];return Array.isArray(u)&&(s.values=u,r=s.values.map(e=>e.value)),o&&!r.includes(o)&&s.values.push({value:o,type:n,name:a}),s},createConfirmEvent:e=>({path:e.target.getAttribute("path"),value:e.target.value})};function stop(){exports.status="pause"}function start(){exports.status="ready"}function updateMouseButtonState(e){leftButton=Boolean(1&e.buttons),rightButton=Boolean(2&e.buttons),middleButton=Boolean(4&e.buttons),isClicked=leftButton||rightButton||middleButton}function init(e){function t(t){"pause"!==exports.status&&e.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keydown",utils.createKeyboardEvent(t)],queue:!1,timeout:!0})}function n(t){"pause"!==exports.status&&e.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keyup",utils.createKeyboardEvent(t)],queue:!1,timeout:!0})}function o(t){"pause"!==exports.status&&(0===t.movementX&&0===t.movementY||e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousemove",utils.createMouseEvent(t,e)],queue:!1,timeout:!0}))}function a(t){"pause"!==exports.status&&(updateMouseButtonState(t),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousedown",utils.createMouseEvent(t,e)],queue:!1,timeout:!0}),document.body.style.pointerEvents="none")}function u(t){!function(t){if("pause"===exports.status)return;if(!isClicked)return;device_adapter_1.WebAdapter.enable&&e.previewClient instanceof preview_client_1.PreviewClient&&e.previewClient.webview.focus();e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mouseup",utils.createMouseEvent(t,e)],queue:!1,timeout:!0}),updateMouseButtonState(t),isClicked||(document.body.style.pointerEvents="",document.removeEventListener("mousemove",o),document.removeEventListener("mousedown",a),document.removeEventListener("mouseup",u),document.removeEventListener("keydown",s),document.removeEventListener("keyup",r))}(t),isClicked||e.focus()}function s(n){n.composedPath()[0]!==e&&t(n)}function r(t){t.composedPath()[0]!==e&&n(t)}e.addEventListener("mousedown",e=>{a(e),document.addEventListener("mousemove",o),document.addEventListener("mousedown",a),document.addEventListener("mouseup",u),document.addEventListener("keydown",s),document.addEventListener("keyup",r)}),e.addEventListener("mousemove",o),e.addEventListener("wheel",t=>{"pause"!==exports.status&&e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousewheel",utils.createMouseEvent(t,e)],queue:!1,timeout:!0})}),e.addEventListener("keydown",t),e.addEventListener("keyup",n),e.addEventListener("dragover",t=>{if("pause"===exports.status)return;const n=utils.createDragEvent(t,e);t.preventDefault(),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDragOver",n],queue:!1,timeout:!0})}),e.addEventListener("drop",t=>{"pause"!==exports.status&&(t.preventDefault(),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDrop",utils.createDragEvent(t,e)],queue:!1,timeout:!0}))})}exports.status="pause",exports.stop=stop,exports.start=start,exports.init=init;