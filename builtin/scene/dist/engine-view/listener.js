"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.release=exports.init=exports.start=exports.stop=exports.status=void 0;const device_adapter_1=require("../script/utils/device-adapter");let leftButton=!1,middleButton=!1,rightButton=!1,isClicked=!1;const utils={createMouseEvent(e,t){const o=t.getBoundingClientRect(),a={ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,x:e.pageX-o.x,y:e.pageY-o.y,clientX:e.clientX-o.x,clientY:e.clientY-o.y,deltaX:e.deltaX||0,deltaY:e.deltaY||0,wheelDeltaX:e.wheelDeltaX||0,wheelDeltaY:e.wheelDeltaY||0,moveDeltaX:e.movementX||0,moveDeltaY:e.movementY||0,movementX:e.movementX,movementY:e.movementY,leftButton:leftButton,middleButton:middleButton,rightButton:rightButton,button:e.button,buttons:e.buttons};if(device_adapter_1.WebAdapter.enable){const e=device_adapter_1.WebAdapter.deltaX,o=device_adapter_1.WebAdapter.deltaY;o>0?(a.y-=o,a.clientY-=o):(a.y+=t.scrollTop,a.clientY+=t.scrollTop),e>0?(a.x-=e,a.clientX-=e):(a.x+=t.scrollTop,a.clientX+=t.scrollLeft)}return a},createKeyboardEvent:e=>({ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,key:e.key,keyCode:e.keyCode,code:e.code}),createDragEvent(e,t){const{type:o,value:a,name:n,additional:s}=Editor.UI.DragArea.currentDragInfo||{},u=utils.createMouseEvent(e,t);u.name=n,u.type=o,u.value=a,u.values=[];let r=[];return Array.isArray(s)&&(u.values=s,r=u.values.map(e=>e.value)),a&&!r.includes(a)&&u.values.push({value:a,type:o,name:n}),u},createConfirmEvent:e=>({path:e.target.getAttribute("path"),value:e.target.value})};function stop(){exports.status="pause"}function start(){exports.status="ready"}function updateMouseButtonState(e){leftButton=Boolean(1&e.buttons),rightButton=Boolean(2&e.buttons),middleButton=Boolean(4&e.buttons),isClicked=leftButton||rightButton||middleButton}exports.status="pause",exports.stop=stop,exports.start=start;const keyDownMap=new Map,globalEventMap=new Map;function init(e){function t(t){0===t.movementX&&0===t.movementY||e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousemove",utils.createMouseEvent(t,e)],queue:!1,timeout:!0})}function o(t){!function(t){"pause"!==exports.status&&isClicked&&(e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mouseup",utils.createMouseEvent(t,e)],queue:!1,timeout:!0}),updateMouseButtonState(t),e.focus())}(t)}function a(t){!function(t){keyDownMap.has(t.key)&&(keyDownMap.delete(t.key),"pause"!==exports.status&&e.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keyup",utils.createKeyboardEvent(t)],queue:!1,timeout:!0}))}(t)}function n(e){"pause"!==exports.status&&isClicked&&t(e)}release(),e.addEventListener("mousedown",function(t){"pause"!==exports.status&&(updateMouseButtonState(t),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousedown",utils.createMouseEvent(t,e)],queue:!1,timeout:!0}))}),e.addEventListener("mousemove",function(e){"pause"!==exports.status&&(isClicked||t(e))}),e.addEventListener("wheel",t=>{"pause"!==exports.status&&e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousewheel",utils.createMouseEvent(t,e)],queue:!1,timeout:!0})}),e.addEventListener("keydown",function(t){"pause"!==exports.status&&(keyDownMap.set(t.key,{code:t.code,keyCode:t.keyCode}),e.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keydown",utils.createKeyboardEvent(t)],queue:!1,timeout:!0}))}),e.addEventListener("dragover",t=>{if("pause"===exports.status)return;const o=utils.createDragEvent(t,e);t.preventDefault(),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDragOver",o],queue:!1,timeout:!0})}),e.addEventListener("drop",t=>{"pause"!==exports.status&&(t.preventDefault(),e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDrop",utils.createDragEvent(t,e)],queue:!1,timeout:!0}))}),e.addEventListener("blur",function(t){for(const[t,o]of keyDownMap)e.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["keyup",utils.createKeyboardEvent({ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1,key:t,keyCode:o.keyCode,code:o.code})],queue:!1,timeout:!0});keyDownMap.clear()}),document.addEventListener("mousemove",n),document.addEventListener("mouseup",o),document.addEventListener("keyup",a),globalEventMap.set("mousemove",n),globalEventMap.set("mouseup",o),globalEventMap.set("keyup",a)}function release(){for(const[e,t]of globalEventMap.entries())document.removeEventListener(e,t);globalEventMap.clear(),keyDownMap.clear()}exports.init=init,exports.release=release;