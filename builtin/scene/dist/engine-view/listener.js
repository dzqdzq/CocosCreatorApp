"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.status=void 0,exports.stop=stop,exports.start=start,exports.init=init,exports.release=release;const device_adapter_1=require("../script/utils/device-adapter"),drag_drop_utils_1=__importDefault(require("../script/utils/drag-drop-utils"));let leftButton=!1,middleButton=!1,rightButton=!1,isClicked=!1;const utils={createMouseEvent(e,t){let a=e.offsetX,o=e.offsetY;var s=t.$scene.zoomFactor,n=(e.target===t||(n=t.getBoundingClientRect(),a=e.clientX-n.x,o=e.clientY-n.y),a*=s,o*=s,{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,x:a,y:o,clientX:a,clientY:o,deltaX:e.deltaX||0,deltaY:e.deltaY||0,wheelDeltaX:e.wheelDeltaX||0,wheelDeltaY:e.wheelDeltaY||0,moveDeltaX:e.movementX||0,moveDeltaY:e.movementY||0,movementX:e.movementX,movementY:e.movementY,leftButton:leftButton,middleButton:middleButton,rightButton:rightButton,button:e.button,buttons:e.buttons});return device_adapter_1.WebAdapter.enable&&(e=device_adapter_1.WebAdapter.offsetX*s,0<(s=device_adapter_1.WebAdapter.offsetY*s)?(n.y-=s,n.clientY-=s):(n.y+=t.scrollTop,n.clientY+=t.scrollTop),0<e?(n.x-=e,n.clientX-=e):(n.x+=t.scrollLeft,n.clientX+=t.scrollLeft)),n},createKeyboardEvent(e){return{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,key:e.key,keyCode:e.keyCode,code:e.code,repeat:e.repeat}},createDragEvent(e,t){var{type:a,value:o,name:s,additional:n}=Editor.UI.__protected__.DragArea.currentDragInfo||{},e=utils.createMouseEvent(e,t);e.name=s,e.type=a,e.value=o,e.values=[];let u=[];return Array.isArray(n)&&(e.values=n,u=e.values.map(e=>e.value)),o&&!u.includes(o)&&e.values.push({value:o,type:a,name:s}),e},createConfirmEvent(e){return{path:e.target.getAttribute("path"),value:e.target.value}}};function stop(){exports.status="pause"}function start(){exports.status="ready"}function updateMouseButtonState(e){leftButton=Boolean(1&e.buttons),rightButton=Boolean(2&e.buttons),middleButton=Boolean(4&e.buttons),isClicked=leftButton||rightButton||middleButton}exports.status="pause";const globalEventMap=new Map;function previewMousedownDisable(e,t){var a,o,s,n,u,r,i,l;return!!device_adapter_1.WebAdapter.enable&&({offsetX:i,offsetY:r,width:l,height:a,screenWidth:o,screenHeight:s}=device_adapter_1.WebAdapter,u=t.getBoundingClientRect(),n=e.clientX-u.x,e=e.clientY-u.y,n<i||i+l<n||e<r||r+a<e||(i=(u=o<l)?t.offsetWidth-t.clientWidth:0,l=(r=s<a)?t.offsetHeight-t.clientHeight:0,u&&o-i<n)||r&&s-l<e)}async function init(a){function t(e){0===e.movementX&&0===e.movementY||a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousemove",utils.createMouseEvent(e,a)],queue:!1,timeout:!0})}function e(e){e=e,"pause"!==exports.status&&isClicked&&(a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mouseup",utils.createMouseEvent(e,a)],queue:!1,timeout:!0}),updateMouseButtonState(e),a.focus())}function o(e){e=e,"pause"!==exports.status&&a.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keyup",utils.createKeyboardEvent(e)],queue:!1,timeout:!0})}function s(e){"pause"!==exports.status&&isClicked&&t(e)}release(),await drag_drop_utils_1.default.init(),a.addEventListener("dblclick",function(e){"pause"!==exports.status&&(updateMouseButtonState(e),a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["dblclick",utils.createMouseEvent(e,a)],queue:!1,timeout:!0}))}),a.addEventListener("mousedown",function(e){"pause"===exports.status||previewMousedownDisable(e,a)||(updateMouseButtonState(e),a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousedown",utils.createMouseEvent(e,a)],queue:!1,timeout:!0}))}),a.addEventListener("mousemove",function(e){"pause"===exports.status||isClicked||t(e)}),a.addEventListener("wheel",e=>{"pause"!==exports.status&&a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["mousewheel",utils.createMouseEvent(e,a)],queue:!1,timeout:!0})}),a.addEventListener("keydown",function(e){"pause"!==exports.status&&a.ipc.send("call-method",{module:"Operation",handler:"_emit",params:["keydown",utils.createKeyboardEvent(e)],queue:!1,timeout:!0})}),a.addEventListener("dragleave",e=>{"pause"!==exports.status&&(drag_drop_utils_1.default.closeTips(),e=utils.createDragEvent(e,a),a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDragLeave",e],queue:!1,timeout:!0}))}),a.addEventListener("dragover",async e=>{var t;"pause"!==exports.status&&(t=utils.createDragEvent(e,a),e.preventDefault(),e.dataTransfer&&!drag_drop_utils_1.default.isSameType(t.values)&&(e.dataTransfer.dropEffect="none",drag_drop_utils_1.default.showTips(Editor.I18n.t("scene.dragDrop.typeMismatch"),e.pageX,e.pageY)),a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDragOver",t],queue:!1,timeout:!0}))}),a.addEventListener("drop",e=>{"pause"!==exports.status&&(e.preventDefault(),a.ipc.send("call-method",{module:"Operation",handler:"_emitMouseEvent",params:["onDrop",utils.createDragEvent(e,a)],queue:!1,timeout:!0}))}),document.addEventListener("mousemove",s),document.addEventListener("mouseup",e),document.addEventListener("keyup",o),globalEventMap.set("mousemove",s),globalEventMap.set("mouseup",e),globalEventMap.set("keyup",o)}function release(){for(var[e,t]of globalEventMap.entries())document.removeEventListener(e,t);globalEventMap.clear()}