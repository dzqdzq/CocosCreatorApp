"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),utils_1=require("../../script/utils/ipc/utils"),v_stacks_1=require("v-stacks");class SceneNativeIpc extends EventEmitter{constructor(e,s,t){super(),this._storage=new utils_1.DataStorage,this.isReady=!1,this.$webview=null,this.messageBuffer=[],this.$webview=e,this._sendChannel=s,this._replyChannel=t,this.listen()}listen(){this.$webview.addEventListener("ipc-message",e=>{e.channel===this._sendChannel?this._onWebviewSend(e):e.channel===this._replyChannel&&this._onWebviewSendReply(e)})}setReady(e){this.isReady=e,this.isReady&&this.messageBuffer.forEach(e=>{this.$webview.send(this._sendChannel,e.id,e.data.message,e.data.arguments)}),this.messageBuffer.length=0}clearBuffer(){this.messageBuffer.length=0}send(e,...s){return new Promise((t,n)=>{const i={message:e,arguments:s.map(utils_1.encodeArgs),callback:function(e,s){e?n(e):t(s)},stack:""},a=this._storage.add(i);if(!this.isReady)return this.messageBuffer.push({id:a,data:i});this.$webview.send(this._sendChannel,a,i.message,i.arguments)})}async _onWebviewSend(e){const[s,t,n]=e.args,i=n.map(utils_1.decodeArgs),a=this._events[t];if(a)try{const e=await a(...i);if(!this.$webview.contentWindow)return;this.$webview.send(this._replyChannel,s,null,(0,utils_1.encodeArgs)(e))}catch(e){if(console.error(e),!this.$webview.contentWindow)return;return void this.$webview.send(this._replyChannel,s,(0,v_stacks_1.encode)(e))}else{const e=new Error(`Could not find the message: ${t}`);if(console.warn(e),!this.$webview.contentWindow)return;this.$webview.send(this._replyChannel,s,e)}}_onWebviewSendReply(e){const s=e.args[0];let t=e.args[1];const n=(0,utils_1.decodeArgs)(e.args[2]),i=this._storage.get(s);i?i.callback&&(t&&(t.stack?t.stack=t.stack.replace(/^[^\n]+/,e=>e+"\n    at <process:scene>"):t.stack=`${t.message}\n    at <process:scene>`,t=(0,v_stacks_1.decode)(t)),i.callback(t,n)):console.warn("IPC message has been lost."),this._storage.remove(s)}}exports.default=SceneNativeIpc;