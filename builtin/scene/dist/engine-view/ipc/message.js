"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EngineViewIPCMessages=void 0;const{basename:basename}=require("path"),float_window_1=__importDefault(require("../plugin/float-window")),toolbar_1=__importDefault(require("../plugin/toolbar")),infobar_1=__importDefault(require("../plugin/infobar")),listener_1=require("../listener"),path_1=require("path"),tasks_1=__importDefault(require("../tasks")),index_1=require("../particle/index"),index_2=require("../physics-2d/index"),electronIpc=__importStar(require("@base/electron-base-ipc")),escToExitPointerLock=e=>{"Escape"===e.code&&document.exitPointerLock()},messages={ready(){this.depend.execute("webview-ready")},close(){this.depend.reset("webview-ready")},"preview-ready"(){this.isPreviewReady=!0},"preview-failed"(){this.isPreviewFailed=!0},"preview-close"(){this.isPreviewReady=!1,this.isPreviewFailed=!1},"preview-restart"(){this.restartPreview()},"immediately-dump"(e){tasks_1.default.updateDump(e)},"query-engine"(){return{path:this.info.path,utils:this.info.utils,compile:this.info.compile}},"query-scene":async()=>await Editor.Profile.getTemp("scene","current-scene")||"",async"set-scene"(e){await Editor.Profile.setTemp("scene","current-scene",e||"")},async"clear-scene"(){Editor.Profile.setTemp("scene","current-scene","")},async"change-title"(e,t){const s=basename(Editor.Project.path);let a="Untitled";if(e){const t=await Editor.Message.request("asset-db","query-asset-info",e);t&&(a=basename(t.source||""))}t&&(a+="*");let i=`${a} - ${s}`;"darwin"!==process.platform&&(i+=`- Cocos Creator ${Editor.App.version}`),Editor.Message.broadcast("editor-title-change",i)},"query-scripts":async()=>await Editor.Message.request("asset-db","query-assets",{type:"scripts"}),"query-effects":async()=>(await Editor.Message.request("asset-db","query-assets")).map(e=>{if("effect"===e.importer)return e.uuid}).filter(Boolean),"query-asset-info":async e=>Editor.Message.request("asset-db","query-asset-info",e),"query-asset-meta":async e=>Editor.Message.request("asset-db","query-asset-meta",e),"query-uuid":async e=>Editor.Message.request("asset-db","query-uuid",e),"query-assets":async e=>Editor.Message.request("asset-db","query-assets",e),"query-app-path":async()=>Editor.App.path,"query-project-path":async()=>Editor.Project.path,"get-config":async(e,t,s)=>await Editor.Profile.getConfig(e,t,s),"set-config":async(e,t,s,a)=>Editor.Profile.setConfig(e,t,s,a),"get-project":async(e,t,s)=>Editor.Profile.getProject(e,t,s),"set-project":async(e,t,s,a)=>Editor.Profile.setProject(e,t,s,a),async"enter-mode"(e){Editor.EditMode.enter(e)},"get-packages":async e=>Editor.Package.getPackages(e),selection:async(e,...t)=>Editor.Selection[e](...t),"editor-dialog":async(e,...t)=>Editor.Dialog[e](...t),i18n:async(e,t)=>await Editor.I18n.t(e,t),"get-contour-points":async(e,t)=>await index_2.physics2DMgr.getContourPoints(e,t),"export-particle-plist":async(e,t)=>await index_1.particleMgr.exportParticlePlist(e,t),panel:async(e,...t)=>Editor.Panel[e](...t),async broadcast(e,...t){await Editor.Message.broadcast(e,...t)},async"init-preview-ipc"(e,t){electronIpc.unregisterChannel(e),electronIpc.registerChannel(e),electronIpc.on(t,async(t,s)=>{const a=await this.callSceneMethod("queryPreviewData",[e,s]);t.reply(null,a)})},"scene:ready"(){(0,listener_1.start)()},"scene:close"(){(0,listener_1.stop)(),float_window_1.default.unselect()},"select-nodes"(e){e.forEach(e=>{Editor.Selection.select("node",e)})},"unselect-nodes"(e){e.forEach(e=>{Editor.Selection.unselect("node",e)})},"lock-pointer"(e){e?(this.requestPointerLock(),document.addEventListener("keydown",escToExitPointerLock)):(document.exitPointerLock(),document.removeEventListener("keydown",escToExitPointerLock))},"change-pointer"(e){document.body.style.cursor=e},"save-asset":async(e,t)=>await Editor.Message.request("asset-db","save-asset",e,t),async"create-asset"(e,t,s){if(!e&&s){const t={scene:{url:"db://assets/scene.scene",title:"scene.save",name:"Scene File",warn:"scene.messages.save_fail"},prefab:{url:"db://assets/node.prefab",title:"scene.save_prefab",name:"Prefab File",warn:"scene.messages.save_fail_prefab"}},a=await Editor.Message.request("asset-db","generate-available-url",t[s].url),i=await Editor.Message.request("asset-db","query-path",a)||"",r=await Editor.Dialog.save({title:Editor.I18n.t(t[s].title),path:i,filters:[{name:t[s].name,extensions:[s]}]});if(!r.filePath)return;const n=(0,path_1.join)(Editor.Project.path,"assets");if(!Editor.Utils.Path.contains(n,r.filePath)||!r.filePath.endsWith(`.${s}`))return void await Editor.Dialog.warn(Editor.I18n.t(t[s].warn),{title:Editor.I18n.t("scene.messages.warning")});const o=await Editor.Message.request("asset-db","query-url",r.filePath);if(!o)return;e=o}const a=await Editor.Message.request("asset-db","create-asset",e,t,{overwrite:!0});if(a)return Editor.Message.send("assets","twinkle",a.uuid,"shrink"),a.uuid},"save-asset-meta":async(e,t)=>await Editor.Message.request("asset-db","save-asset-meta",e,t),"dirty-dialog":async e=>(await Editor.Dialog.warn((e||"Scene")+Editor.I18n.t("scene.messages.scenario_modified"),{title:Editor.I18n.t("scene.messages.warning"),detail:Editor.I18n.t("scene.messages.want_to_save"),default:0,cancel:2,buttons:[Editor.I18n.t("scene.messages.save"),Editor.I18n.t("scene.messages.dont_save"),Editor.I18n.t("scene.messages.cancel")]})).response,"generate-available-url":e=>Editor.Message.request("asset-db","generate-available-url",e),async"record-camera"(e,t){let s=await Editor.Profile.getConfig("scene","camera-infos")||{},a=await Editor.Profile.getConfig("scene","camera-uuids")||[];"object"!=typeof s&&(s={}),Array.isArray(a)&&(a=[]);const i=t,r=a.indexOf(e);-1!==r?(delete s[a[r]],a.splice(r,1),a.push(e)):(a.push(e),a.length>50&&(delete s[a[0]],a.splice(0,1))),s[e]=i,Editor.Profile.setConfig("scene","camera-infos",s),Editor.Profile.setConfig("scene","camera-uuids",a)},async"record-camera-config"(e){Editor.Profile.setConfig("scene","camera",e)},async"record-gizmos"(e){const t=await Editor.Profile.getConfig("scene","gizmos-infos")||{};Object.assign(t,e),Editor.Profile.setConfig("scene","gizmos-infos",t)},"update-plugin"(e){if(this.previewMenuVisibled)return;const t={},s=[];e.nodes.forEach(e=>{e.components.forEach(e=>{s.includes(e.type)||s.push(e.type),(t[e.type]=t[e.type]||[]).push(e)})}),e.nodes.length>0?float_window_1.default.select(e,s,t):float_window_1.default.unselect(e,s,t),toolbar_1.default.update(e,s,t),infobar_1.default.update(e,s,t)},"send-plugin"(e,...t){"float-window"===e&&float_window_1.default.send(...t)},"force-update"(e,t){const s={},a=[];switch(t.nodes.forEach(e=>{e.components.forEach(e=>{if(a.includes(e.type))return;a.push(e.type),(s[e.type]=s[e.type]||[]).push(e)})}),e){case"toolbar":toolbar_1.default.update(t,a,s);break;case"float-window":float_window_1.default.update(t,a,s)}}};exports.EngineViewIPCMessages=messages;