"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.View=void 0;const base_view_1=require("../base-view"),panel=require("@editor/panel"),{join:join}=require("path"),host_1=__importDefault(require("../../utils/ipc/host")),ipc_1=require("../ipc"),listener_1=require("../listener"),tasks_1=__importDefault(require("../tasks")),device_adapter_1=require("../../utils/device-adapter");class View extends base_view_1.BaseView{constructor(){super(),this.ipc=new host_1.default(this.$scene)}async init(){const e=join(__dirname,`../../script/${Editor.Project.type}/preload/web/preload.js`);this.$scene.setAttribute("webPreferences","webgl=1,nativeWindowOpen=1,contextIsolation=0,backgroundThrottling=0"),this.$scene.setAttribute("contextIsolation","false"),this.$scene.setAttribute("nodeintegration","true"),this.$scene.setAttribute("nodeintegrationinsubframes","true"),this.$scene.setAttribute("enableremotemodule","true"),this.$scene.setAttribute("disablewebsecurity","true"),this.$scene.setAttribute("allowpopups","true"),this.$scene.setAttribute("style","pointer-events: none;flex:1;"),this.$scene.setAttribute("src",`packages://scene/static/template/${Editor.Project.type}-webview.html?url=${encodeURI(e)}`),this.appendChild(this.$scene);let t=!1,i=null;this.$scene&&this.$scene.addEventListener("dom-ready",()=>{t=!0,i&&i();const e=JSON.parse(JSON.stringify(this.$scene.getBoundingClientRect()));device_adapter_1.DeviceAdapter.reset(e.width,e.height)}),Editor.Startup.ready.package?this.depend.finish(tasks_1.default.editorInit[0]):Editor.Startup.once("package-ready",()=>{this.depend.finish(tasks_1.default.editorInit[0])}),await this.depend.execute(tasks_1.default.assetDbReady[0])&&this.depend.finish(tasks_1.default.assetDbReady[0]),await this.depend.execute(tasks_1.default.packerDriverReady[0])&&this.depend.finish(tasks_1.default.packerDriverReady[0]),this.info=await this.depend.execute(tasks_1.default.queryEngineInfo[0]),this.depend.finish(tasks_1.default.queryEngineInfo[0]),Object.keys(ipc_1.NativeIPCMethods).forEach(e=>{this.ipc.on(e,ipc_1.NativeIPCMethods[e].bind(this))}),(0,listener_1.init)(this),t||await new Promise(e=>{i=e})}setPreviewMenuVisible(e){var t;null===(t=this.previousElementSibling)||void 0===t||(t.__vue__.gameViewData.showGameView=e),device_adapter_1.DeviceAdapter.enable=e;const i=panel.queryInfo("scene");i.userData.title=e?"i18n:scene.preview_title":"i18n:scene.title",panel.changeUserData("scene",i.userData)}async updateStyle(){var e,t;if(!(null===(e=this.previousElementSibling)||void 0===e?void 0:e.__vue__.gameViewData.showGameView))return;const i=null===(t=this.previousElementSibling)||void 0===t?void 0:t.__vue__.gameViewData,{rotate:s,scaleValue:r,devicesInfo:a,fullScreen:n}=i;let d=a.width,c=a.height;if("ratio"===a.type){const e=device_adapter_1.DeviceAdapter.ratioToSize(d,c);d=e.width,c=e.height}else if("design"===a.type){const e=await Editor.Profile.getProject("project","general.designResolution");d=e.width,c=e.height}else"free"===a.type&&(d=device_adapter_1.DeviceAdapter.screenWidth*window.devicePixelRatio,c=device_adapter_1.DeviceAdapter.screenHeight*window.devicePixelRatio);return device_adapter_1.DeviceAdapter.fitScreen(d,c,n,s,r/100),this.$scene.setAttribute("style",`width:${device_adapter_1.DeviceAdapter.width}px; height:${device_adapter_1.DeviceAdapter.height}px;`),this.$scene.parentElement&&(this.$scene.parentElement.setAttribute("game-view",""),this.$scene.parentElement.addEventListener("wheel",this.preventWheelScroll)),{scale:Math.floor(100*device_adapter_1.DeviceAdapter.scale)}}resetStyle(){this.$scene.removeAttribute("style"),this.$scene.parentElement&&(this.$scene.parentElement.removeAttribute("game-view"),this.$scene.parentElement.removeEventListener("wheel",this.preventWheelScroll))}preventWheelScroll(e){e.preventDefault()}}exports.View=View;