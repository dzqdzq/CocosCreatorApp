"use strict";const{expect:expect}=require("chai");function getMountedComponents(e){return e.__prefab__.instance.value.mountedComponents.value}function getMountedChildren(e){return e.__prefab__.instance.value.mountedChildren.value}function getRemovedComponents(e){return e.__prefab__.instance.value.removedComponents.value}describe("嵌套Prefab操作测试",()=>{let e=null;let t=null;let a=null,s=null;let n=null,o=null;describe("prepare test resources",async()=>{it("create cube node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"testPrefabRootNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde"});expect(!!t).to.true,e=t}),it("create testPrefab",async()=>{t=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab.prefab"),expect(!!t).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)});const a=await Editor.Message.request("scene","query-node",e),s=a.__prefab__.fileId;expect(!!s).to.true;const n=a.__prefab__.instance.value.propertyOverrides.value;expect(n.length).equal(3)}),it("open prefab",async()=>{await Editor.Message.request("scene","open-scene",t);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("add child node in prefab mode",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const n=e.children[0].uuid;console.log(n);const o=await Editor.Message.request("scene","create-node",{name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:n});expect(!!o).to.true;const r=await Editor.Message.request("scene","query-node",o);expect(r.__prefab__.uuid).to.equal(t),expect(!!r.__prefab__.instance).to.false,a=await Editor.Message.request("scene","create-node",{name:"childNode",parent:n}),expect(!!a).to.true,s=await Editor.Message.request("scene","create-node",{name:"childTorusNode",assetUuid:"d47f5d5e-c931-4ff4-987b-cc818a728b82",parent:a}),expect(!!s).to.true}),it("create child prefab",async()=>{n=await Editor.Message.request("scene","create-prefab",a,"db://assets/childPrefab.prefab"),expect(!!n).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("quit prefab mode",async()=>{await Editor.Message.request("scene","close-scene")});let r="";it("remove component in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2),a=t.children[1].value.uuid,t=await Editor.Message.request("scene","query-node",a),console.log(t),expect(t.children.length).equal(1),s=t.children[0].value.uuid;const n=(t=await Editor.Message.request("scene","query-node",s)).__comps__[0].value;console.log("meshComp:",n);const o=n.__prefab.value;r=o.fileId.value,await Editor.Message.request("scene","remove-array-element",{uuid:s,path:"__comps__",index:0}),t=await Editor.Message.request("scene","query-node",s),console.log("after remove component:",t),expect(t.__comps__.length).equal(0);const c=getRemovedComponents(t=await Editor.Message.request("scene","query-node",e));expect(c.length).equal(1)}),it("revert remove component in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);console.log("before revert remove component rootNode:",t),expect(t.children.length).equal(2),a=t.children[1].value.uuid,t=await Editor.Message.request("scene","query-node",a),console.log(t),expect(t.children.length).equal(1),s=t.children[0].value.uuid,t=await Editor.Message.request("scene","query-node",s),console.log("before revert remove component:",t),expect(t.__comps__.length).equal(0),await Editor.Message.request("scene","revert-removed-component",s,r),t=await Editor.Message.request("scene","query-node",s),console.log("after remove component:",t),expect(t.__comps__.length).equal(1);const n=getRemovedComponents(t=await Editor.Message.request("scene","query-node",e));expect(n.length).equal(0)}),it("remove component in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2),a=t.children[1].value.uuid,t=await Editor.Message.request("scene","query-node",a),expect(t.children.length).equal(1),s=t.children[0].value.uuid;const n=(t=await Editor.Message.request("scene","query-node",s)).__comps__[0].value.__prefab.value;r=n.fileId.value,await Editor.Message.request("scene","remove-array-element",{uuid:s,path:"__comps__",index:0}),t=await Editor.Message.request("scene","query-node",s),expect(t.__comps__.length).equal(0);const o=getRemovedComponents(t=await Editor.Message.request("scene","query-node",e));expect(o.length).equal(1)}),it("create component in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2),a=t.children[1].value.uuid,t=await Editor.Message.request("scene","query-node",a),console.log(t),expect(t.children.length).equal(1),s=t.children[0].value.uuid,await Editor.Message.request("scene","create-component",{uuid:s,component:"cc.BoxCollider"}),t=await Editor.Message.request("scene","query-node",s),console.log("after add component:",t),expect(t.__comps__.length).equal(1);const n=getMountedComponents(t=await Editor.Message.request("scene","query-node",e));expect(n.length).equal(1)}),it("create child in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2),a=t.children[1].value.uuid;const s=await Editor.Message.request("scene","create-node",{name:"nestedConeChild",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:a});expect(!!s).to.true,t=await Editor.Message.request("scene","query-node",a),console.log(t),expect(t.children.length).equal(2);const n=getMountedChildren(t=await Editor.Message.request("scene","query-node",e));expect(n.length).equal(1)});const c={x:0,y:2,z:0};it("move child in nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2),a=t.children[1].value.uuid,await Editor.Message.request("scene","set-property",{uuid:s,path:"position",dump:{type:"cc.Vec3",value:c}}),t=await Editor.Message.request("scene","query-node",e),console.log(t);const n=t.__prefab__.instance.value.propertyOverrides.value,o=n[n.length-1].value,r=o.propertyPath.value[0].value;expect(r).to.equal("_lpos");o.targetInfo.value;const u=o.value.value;expect(u.x).to.equal(c.x),expect(u.y).to.equal(c.y),expect(u.z).to.equal(c.z)}),it("apply prefab",async()=>{console.log(e),await Editor.Message.request("scene","apply-prefab",e),await new Promise(e=>{setTimeout(function(){e()},1200)});let t=await Editor.Message.request("scene","query-node",e);console.log(t);const s=getMountedComponents(t);expect(s.length).equal(0),t=await Editor.Message.request("scene","query-node",a),console.log(t);const n=getMountedComponents(t);expect(n.length).equal(1);const o=getRemovedComponents(t);expect(o.length).equal(1);const r=getMountedChildren(t);expect(r.length).equal(1);const u=t.__prefab__.instance.value.propertyOverrides.value,i=u[u.length-1].value.value.value;expect(i.x).to.equal(c.x),expect(i.y).to.equal(c.y),expect(i.z).to.equal(c.z)}),it("create prefabInstance 2",async()=>{o=await Editor.Message.request("scene","create-node",{name:"testPrefabInstance2",assetUuid:t,type:"cc.Prefab"}),expect(!!o).to.true;let e=await Editor.Message.request("scene","query-node",o);console.log(e);const a=getMountedChildren(e);expect(a.length).to.equal(0);const s=getRemovedComponents(e);expect(s.length).equal(0);const n=getMountedChildren(e);expect(n.length).equal(0)})}),describe("clear test resources",async()=>{it("remove test node",async()=>{await Editor.Message.request("scene","remove-node",{uuid:e})}),it("delete prefab asset",async()=>{const e=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab.prefab");expect(e).not.to.be.null;const t=await Editor.Message.request("asset-db","delete-asset","db://assets/childPrefab.prefab");expect(t).not.to.be.null})})});