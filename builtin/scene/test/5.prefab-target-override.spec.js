"use strict";const{expect:expect}=require("chai"),{queryNode:queryNode,setProperty:setProperty}=require("./utils");describe("Prefab的TargetOverride操作测试",()=>{let e=null;let t=null,s=null;let a=null;let o=null;describe("prepare test resources",async()=>{it("create Root node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"testPrefabRootNode"});expect(!!t).to.true,e=t}),it("create testPrefab",async()=>{t=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab.prefab"),expect(!!t).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)});const s=await Editor.Message.request("scene","query-node",e),a=s.__prefab__.fileId;expect(!!a).to.true;const o=s.__prefab__.instance.value.propertyOverrides.value;expect(o.length).equal(3)}),it("open prefab",async()=>{await Editor.Message.request("scene","open-scene",t);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("create testRef script",async()=>{const e=await Editor.Message.request("asset-db","create-asset","db://assets/__testRef__.ts"," \n        import { _decorator, Component, Node } from 'cc';\n        const { ccclass, property, type } = _decorator;\n\n        @ccclass('TestPrefabRef')\n        export class TestRef extends Component {\n            @type(Node)\n            public refNode: Node|null = null;\n            \n            @type(Component)\n            public refComp: Component|null = null;\n\n            start () {\n            }\n        }\n    ",{overwrite:!0});o=e.url,await new Promise(e=>{setTimeout(function(){e()},1500)})}),it("add child node in prefab mode",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const a=e.children[0].uuid;console.log(a);const o=await Editor.Message.request("scene","create-node",{name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:a});expect(!!o).to.true;const r=await Editor.Message.request("scene","query-node",o);expect(r.__prefab__.uuid).to.equal(t),expect(!!r.__prefab__.instance).to.false,s=await Editor.Message.request("scene","create-node",{name:"childNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde",parent:a}),expect(!!s).to.true;const n=await Editor.Message.request("scene","create-node",{name:"testOutRef",parent:s});expect(!!n).to.true,await Editor.Message.request("scene","create-component",{uuid:n,component:"TestPrefabRef"});const c=await Editor.Message.request("scene","create-node",{name:"testInRef",parent:s});expect(!!c).to.true,await Editor.Message.request("scene","create-component",{uuid:c,component:"TestPrefabRef"})}),it("create child prefab",async()=>{a=await Editor.Message.request("scene","create-prefab",s,"db://assets/childPrefab.prefab"),expect(!!a).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("open child prefab",async()=>{await Editor.Message.request("scene","open-scene",a);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("set in prefab reference",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const t=e.children[0].uuid;let s=await queryNode(t);console.log(s);s.children[0].value.uuid;const a=s.children[1].value.uuid;await setProperty({uuid:a,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:t}}}),s=await queryNode(a),console.log("after set property:",s),expect(s.__comps__[0].value.refNode.value.uuid).to.equal(t)}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("open Root prefab",async()=>{await Editor.Message.request("scene","open-scene",t);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("set nested prefab reference",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const t=e.children[0].uuid;let s=await queryNode(t);s.children[0].value.uuid;const a=s.children[1].value.uuid,o=(s=await queryNode(a)).children[0].value.uuid,r=s.children[1].value.uuid;await setProperty({uuid:o,path:"__comps__.0.refNode",dump:{type:"cc.Node",value:{uuid:t}}}),s=await queryNode(o),console.log("after set property:",s),expect(s.__comps__[0].value.refNode.value.uuid).to.equal(t),s=await queryNode(r),expect(!!s.__comps__[0].value.refNode.value.uuid).to.true,s=await queryNode(t),console.log("root",s)}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("quit prefab mode",async()=>{await Editor.Message.request("scene","close-scene")})}),describe("clear test resources",async()=>{it("remove test node",async()=>{await Editor.Message.request("scene","remove-node",{uuid:e})}),it("delete prefab asset",async()=>{const e=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab.prefab");expect(e).not.to.be.null;const t=await Editor.Message.request("asset-db","delete-asset",o);expect(t).not.to.be.null;const s=await Editor.Message.request("asset-db","delete-asset","db://assets/childPrefab.prefab");expect(s).not.to.be.null})})});