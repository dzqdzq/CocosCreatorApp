"use strict";const{expect:expect}=require("chai");describe("Prefab操作测试",()=>{let e=null;let t=null;let a=null,s=null;let n=null,o=null;describe("prepare test resources",async()=>{it("create cube node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"testPrefabRootNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde"});expect(!!t).to.true,e=t}),it("create testPrefab",async()=>{t=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab.prefab"),expect(!!t).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)});const a=await Editor.Message.request("scene","query-node",e),s=a.__prefab__.fileId;expect(!!s).to.true;const n=a.__prefab__.instance.value.propertyOverrides.value;expect(n.length).equal(3)}),it("open prefab",async()=>{await Editor.Message.request("scene","open-scene",t);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("add child prefab in prefab mode",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const a=e.children[0].uuid;console.log(a);const n=await Editor.Message.request("scene","create-node",{name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:a});expect(!!n).to.true;const o=await Editor.Message.request("scene","query-node",n);expect(o.__prefab__.uuid).to.equal(t),expect(!!o.__prefab__.instance).to.false,s=await Editor.Message.request("scene","create-node",{name:"childNode",parent:a}),expect(!!s).to.true;const r=await Editor.Message.request("scene","create-node",{name:"childTorusNode",assetUuid:"d47f5d5e-c931-4ff4-987b-cc818a728b82",parent:s});expect(!!r).to.true}),it("create child prefab",async()=>{n=await Editor.Message.request("scene","create-prefab",s,"db://assets/childPrefab.prefab"),expect(!!n).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},1200)})}),it("quit prefab mode",async()=>{await Editor.Message.request("scene","close-scene")}),it("move nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2);const a=t.children[1].value.uuid,s={x:0,y:2,z:0};await Editor.Message.request("scene","set-property",{uuid:a,path:"position",dump:{type:"cc.Vec3",value:s}}),t=await Editor.Message.request("scene","query-node",e),console.log(t);const n=t.__prefab__.instance.value.propertyOverrides.value,o=n[n.length-1].value,r=o.propertyPath.value[0].value;expect(r).to.equal("_lpos");const c=o.targetInfo.value.localID.value,u=await Editor.Message.request("scene","query-node",a),i=u.__prefab__.instance.value.fileId.value,l=u.__prefab__.fileId;expect(c[0].value).to.equal(i),expect(c[1].value).to.equal(l);const d=o.value.value;expect(d.x).to.equal(s.x),expect(d.y).to.equal(s.y),expect(d.z).to.equal(s.z)}),it("create child under prefab in general for revert",async()=>{for(let t=0;t<3;t++){const a=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!a).to.true;const s=await Editor.Message.request("scene","query-node",e);expect(!!s.__prefab__.instance.value.fileId).to.true,console.log(s);const n=s.__prefab__.instance.value.mountedChildren.value[0].value.nodes.value[t].value;expect(n.uuid===s.uuid.value);const o=await Editor.Message.request("scene","query-node",a);console.log("addedChild:",o),expect(!!o.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}}),it("revert prefab",async()=>{const t=await Editor.Message.request("scene","restore-prefab",e);expect(t).to.true;const a=await Editor.Message.request("scene","query-node",e),s=a.children[1].value.uuid,n=a.__prefab__.instance.value.propertyOverrides.value;expect(n.length).to.equal(3);const o=(await Editor.Message.request("scene","query-node",s)).position.value;expect(o.y).equal(0)}),it("create child under prefab in general",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!t).to.true;const a=await Editor.Message.request("scene","query-node",e);expect(!!a.__prefab__.instance.value.fileId).to.true,console.log(a);const s=a.__prefab__.instance.value.mountedChildren.value[0].value;expect(s.uuid===a.uuid.value);const n=await Editor.Message.request("scene","query-node",t);console.log("addedChild:",n),expect(!!n.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}),it("apply prefab",async()=>{console.log(e),await Editor.Message.request("scene","apply-prefab",e),await new Promise(e=>{setTimeout(function(){e()},1200)});const t=await Editor.Message.request("scene","query-node",e);console.log(t);const a=t.__prefab__.instance.value.mountedChildren.value;expect(a.length).equal(0);const s=t.children[2].value.uuid;console.log("addedChildNodeUUID:",s);const n=await Editor.Message.request("scene","query-node",s);console.log("childConeNodeDump:",n),expect(!!n.__prefab__).to.true}),it("move prefab Root",async()=>{console.log(e),await Editor.Message.request("scene","apply-prefab",e),await new Promise(e=>{setTimeout(function(){e()},1200)});const t={x:1,y:2,z:3};await Editor.Message.request("scene","set-property",{uuid:e,path:"position",dump:{type:"cc.Vec3",value:t}});const a=await Editor.Message.request("scene","query-node",e),s=a.__prefab__.fileId,n=a.__prefab__.instance.value.propertyOverrides.value[1].value,o=n.propertyPath.value[0].value;expect(o).to.equal("_lpos");const r=n.targetInfo.value.localID.value;expect(r[0].value).to.equal(s);const c=n.value.value;expect(c.x).to.equal(t.x),expect(c.y).to.equal(t.y),expect(c.z).to.equal(t.z)}),it("create child under prefab in general",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!t).to.true;const a=await Editor.Message.request("scene","query-node",e);expect(!!a.__prefab__.instance.value.fileId).to.true,console.log(a);const s=a.__prefab__.instance.value.mountedChildren.value[0].value;expect(s.uuid===a.uuid.value);const n=await Editor.Message.request("scene","query-node",t);console.log("addedChild:",n),expect(!!n.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}),it("create testPrefab2",async()=>{a=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab2.prefab"),expect(!!a).to.true,await new Promise(e=>{setTimeout(function(){e()},1200)});const t=await Editor.Message.request("scene","query-node",e),s=t.__prefab__.fileId;expect(!!s).to.true;const n=t.__prefab__.instance.value.propertyOverrides.value;expect(n.length).equal(3);const o=t.position.value;expect(o.z).equal(3);const r=t.__prefab__.instance.value.mountedChildren.value;expect(r.length).equal(0),expect(t.children.length).equal(4)}),it("add component in prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);const a=t.children.length,s=t.children[a-1].value;await Editor.Message.request("scene","create-component",{uuid:s.uuid,component:"cc.BoxCollider2D"});const n=(t=await Editor.Message.request("scene","query-node",e)).__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.mountedComponents.value;expect(o.length).equal(1)});let r=0;it("remove component in prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;let s=await Editor.Message.request("scene","query-node",a.uuid);r=s.__comps__[0].value.__prefab.value.fileId.value,await Editor.Message.request("scene","remove-array-element",{uuid:a.uuid,path:"__comps__",index:0}),s=await Editor.Message.request("scene","query-node",a.uuid),expect(s.__comps__.length).equal(0);const n=(t=await Editor.Message.request("scene","query-node",e)).__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.removedComponents.value;expect(o.length).equal(1)}),it("revert remove component in prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;await Editor.Message.request("scene","revert-removed-component",a.uuid,r);let s=await Editor.Message.request("scene","query-node",a.uuid);expect(s.__comps__.length).equal(1),t=await Editor.Message.request("scene","query-node",e),console.log("after revert remove component:",t);const n=t.__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.removedComponents.value;expect(o.length).equal(0)}),it("remove component in prefabInstance again",async()=>{let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;let s=await Editor.Message.request("scene","query-node",a.uuid);r=s.__comps__[0].value.__prefab.value.fileId.value,await Editor.Message.request("scene","remove-array-element",{uuid:a.uuid,path:"__comps__",index:0}),s=await Editor.Message.request("scene","query-node",a.uuid),expect(s.__comps__.length).equal(0);const n=(t=await Editor.Message.request("scene","query-node",e)).__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.removedComponents.value;expect(o.length).equal(1)}),it("apply remove component in prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;await Editor.Message.request("scene","apply-removed-component",a.uuid,r),await new Promise(e=>{setTimeout(function(){e()},1200)});let s=await Editor.Message.request("scene","query-node",a.uuid);expect(s.__comps__.length).equal(0),t=await Editor.Message.request("scene","query-node",e),console.log("after apply remove component:",t);const n=t.__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value,c=o.removedComponents.value;expect(c.length).equal(0);const u=o.mountedComponents.value[0].value.components.value[0].value.uuid;console.log(u);const i=await Editor.Message.request("scene","query-component",u);console.log(i),expect(i.isMounted).true}),it("undo apply remove component in prefabInstance",async()=>{await Editor.Message.request("scene","undo"),await new Promise(e=>{setTimeout(function(){e()},1200)});let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;let s=await Editor.Message.request("scene","query-node",a.uuid);expect(s.__comps__.length).equal(0),t=await Editor.Message.request("scene","query-node",e),console.log("after remove component:",t);const n=t.__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.removedComponents.value;expect(o.length).equal(1)}),it("redo apply remove component in prefabInstance",async()=>{await Editor.Message.request("scene","redo"),await new Promise(e=>{setTimeout(function(){e()},1200)});let t=await Editor.Message.request("scene","query-node",e);const a=t.children[0].value;let s=await Editor.Message.request("scene","query-node",a.uuid);expect(s.__comps__.length).equal(0),t=await Editor.Message.request("scene","query-node",e),console.log("after remove component:",t);const n=t.__prefab__.fileId;expect(!!n).to.true;const o=t.__prefab__.instance.value.removedComponents.value;expect(o.length).equal(0)}),it("create prefabInstance 2",async()=>{o=await Editor.Message.request("scene","create-node",{name:"testPrefabInstance2",assetUuid:a}),expect(!!o).to.true;const e=(await Editor.Message.request("scene","query-node",o)).children[0].value;let t=await Editor.Message.request("scene","query-node",e.uuid);expect(t.__comps__.length).equal(0)}),it("disconnect prefab",async()=>{await Editor.Message.request("scene","unlink-prefab",e);const t=await Editor.Message.request("scene","query-node",e);console.log(t);const a=t.__prefab__;expect(!!a).to.false,expect(t.children.length).equal(4);const s=t.children[1].value.uuid,n=await Editor.Message.request("scene","query-node",s);console.log("childPrefabDump:",n);const o=n.__prefab__.instance;expect(!!o).to.true})}),describe("clear test resources",async()=>{it("remove test node",async()=>{await Editor.Message.request("scene","remove-node",{uuid:e}),await Editor.Message.request("scene","remove-node",{uuid:o})}),it("delete prefab asset",async()=>{const e=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab.prefab");expect(e).not.to.be.null;const t=await Editor.Message.request("asset-db","delete-asset","db://assets/childPrefab.prefab");expect(t).not.to.be.null;const a=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab2.prefab");expect(a).not.to.be.null})})});