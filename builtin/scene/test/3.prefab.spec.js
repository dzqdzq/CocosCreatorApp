"use strict";const{expect:expect}=require("chai");describe("Prefab操作测试",()=>{let e=null;let t=null;let a=null,s=null;let o=null;describe("prepare test resources",async()=>{it("create cube node",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"testPrefabRootNode",assetUuid:"30da77a1-f02d-4ede-aa56-403452ee7fde"});expect(!!t).to.true,e=t}),it("create testPrefab",async()=>{t=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab.prefab"),expect(!!t).to.true,await new Promise(e=>{setTimeout(function(){e()},500)});const a=await Editor.Message.request("scene","query-node",e),s=a.__prefab__.fileId;expect(!!s).to.true;const o=a.__prefab__.instance.value.propertyOverrides.value;expect(o.length).equal(3)}),it("open prefab",async()=>{await Editor.Message.request("scene","open-scene",t);await new Promise(e=>{setTimeout(function(){e()},500)})}),it("add child prefab in prefab mode",async()=>{const e=await Editor.Message.request("scene","query-node-tree");console.log(e),expect(!!e).to.true;const a=e.children[0].uuid;console.log(a);const o=await Editor.Message.request("scene","create-node",{name:"childCylinderNode",assetUuid:"ab3e16f9-671e-48a7-90b7-d0884d9cbb85",parent:a});expect(!!o).to.true;const n=await Editor.Message.request("scene","query-node",o);expect(n.__prefab__.uuid).to.equal(t),expect(!!n.__prefab__.instance).to.false,s=await Editor.Message.request("scene","create-node",{name:"childNode",parent:a}),expect(!!s).to.true;const r=await Editor.Message.request("scene","create-node",{name:"childTorusNode",assetUuid:"d47f5d5e-c931-4ff4-987b-cc818a728b82",parent:s});expect(!!r).to.true}),it("create child prefab",async()=>{o=await Editor.Message.request("scene","create-prefab",s,"db://assets/childPrefab.prefab"),expect(!!o).to.true,await new Promise(e=>{setTimeout(function(){e()},500)})}),it("save prefab",async()=>{await Editor.Message.request("scene","save-scene");await new Promise(e=>{setTimeout(function(){e()},500)})}),it("quit prefab mode",async()=>{await Editor.Message.request("scene","close-scene")}),it("move nested prefabInstance",async()=>{let t=await Editor.Message.request("scene","query-node",e);expect(t.children.length).equal(2);const a=t.children[1].value.uuid,s={x:0,y:2,z:0};await Editor.Message.request("scene","set-property",{uuid:a,path:"position",dump:{type:"cc.Vec3",value:s}}),t=await Editor.Message.request("scene","query-node",e),console.log(t);const o=t.__prefab__.instance.value.propertyOverrides.value,n=o[o.length-1].value,r=n.propertyPath.value[0].value;expect(r).to.equal("position");const c=n.targetInfo.value.localID.value,i=await Editor.Message.request("scene","query-node",a),u=i.__prefab__.instance.value.fileId.value,l=i.__prefab__.fileId;expect(c[0].value).to.equal(u),expect(c[1].value).to.equal(l);const d=n.value.value;expect(d.x).to.equal(s.x),expect(d.y).to.equal(s.y),expect(d.z).to.equal(s.z)}),it("create child under prefab in general for revert",async()=>{for(let t=0;t<3;t++){const a=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!a).to.true;const s=await Editor.Message.request("scene","query-node",e);expect(!!s.__prefab__.instance.value.fileId).to.true,console.log(s);const o=s.__prefab__.instance.value.mountedChildren.value[0].value.nodes.value[t].value;expect(o.uuid===s.uuid.value);const n=await Editor.Message.request("scene","query-node",a);console.log("addedChild:",n),expect(!!n.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}}),it("revert prefab",async()=>{const t=await Editor.Message.request("scene","restore-prefab",e);expect(t).to.true;const a=await Editor.Message.request("scene","query-node",e),s=a.children[1].value.uuid,o=a.__prefab__.instance.value.propertyOverrides.value;expect(o.length).to.equal(3);const n=(await Editor.Message.request("scene","query-node",s)).position.value;expect(n.y).equal(0)}),it("create child under prefab in general",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!t).to.true;const a=await Editor.Message.request("scene","query-node",e);expect(!!a.__prefab__.instance.value.fileId).to.true,console.log(a);const s=a.__prefab__.instance.value.mountedChildren.value[0].value;expect(s.uuid===a.uuid.value);const o=await Editor.Message.request("scene","query-node",t);console.log("addedChild:",o),expect(!!o.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}),it("apply prefab",async()=>{console.log(e),await Editor.Message.request("scene","apply-prefab",e),await new Promise(e=>{setTimeout(function(){e()},500)});const t=await Editor.Message.request("scene","query-node",e);console.log(t);const a=t.__prefab__.instance.value.mountedChildren.value;expect(a.length).equal(0);const s=t.children[2].value.uuid;console.log("addedChildNodeUUID:",s);const o=await Editor.Message.request("scene","query-node",s);console.log("childConeNodeDump:",o),expect(!!o.__prefab__).to.true}),it("move prefab Root",async()=>{console.log(e),await Editor.Message.request("scene","apply-prefab",e),await new Promise(e=>{setTimeout(function(){e()},500)});const t={x:1,y:2,z:3};await Editor.Message.request("scene","set-property",{uuid:e,path:"position",dump:{type:"cc.Vec3",value:t}});const a=await Editor.Message.request("scene","query-node",e),s=a.__prefab__.fileId,o=a.__prefab__.instance.value.propertyOverrides.value[1].value,n=o.propertyPath.value[0].value;expect(n).to.equal("position");const r=o.targetInfo.value.localID.value;expect(r[0].value).to.equal(s);const c=o.value.value;expect(c.x).to.equal(t.x),expect(c.y).to.equal(t.y),expect(c.z).to.equal(t.z)}),it("create child under prefab in general",async()=>{const t=await Editor.Message.request("scene","create-node",{name:"childConeNode",assetUuid:"6350d660-e888-4acf-a552-f3b719ae9110",parent:e});expect(!!t).to.true;const a=await Editor.Message.request("scene","query-node",e);expect(!!a.__prefab__.instance.value.fileId).to.true,console.log(a);const s=a.__prefab__.instance.value.mountedChildren.value[0].value;expect(s.uuid===a.uuid.value);const o=await Editor.Message.request("scene","query-node",t);console.log("addedChild:",o),expect(!!o.__prefab__).to.false,await new Promise(e=>{setTimeout(function(){e()},200)})}),it("create testPrefab2",async()=>{a=await Editor.Message.request("scene","create-prefab",e,"db://assets/testPrefab2.prefab"),expect(!!a).to.true,await new Promise(e=>{setTimeout(function(){e()},500)});const t=await Editor.Message.request("scene","query-node",e),s=t.__prefab__.fileId;expect(!!s).to.true;const o=t.__prefab__.instance.value.propertyOverrides.value;expect(o.length).equal(3);const n=t.position.value;expect(n.z).equal(3);const r=t.__prefab__.instance.value.mountedChildren.value;expect(r.length).equal(0),expect(t.children.length).equal(4)}),it("disconnect prefab",async()=>{await Editor.Message.request("scene","unlink-prefab",e);const t=await Editor.Message.request("scene","query-node",e);console.log(t);const a=t.__prefab__;expect(!!a).to.false,expect(t.children.length).equal(4);const s=t.children[1].value.uuid,o=await Editor.Message.request("scene","query-node",s);console.log("childPrefabDump:",o);const n=o.__prefab__.instance;expect(!!n).to.true})}),describe("clear test resources",async()=>{it("remove node",async()=>{await Editor.Message.request("scene","remove-node",{uuid:e})}),it("delete prefab asset",async()=>{const e=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab.prefab");expect(e).not.to.be.null;const t=await Editor.Message.request("asset-db","delete-asset","db://assets/childPrefab.prefab");expect(t).not.to.be.null;const a=await Editor.Message.request("asset-db","delete-asset","db://assets/testPrefab2.prefab");expect(a).not.to.be.null})})});