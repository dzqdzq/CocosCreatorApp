"use strict";const __StartTime__=Date.now(),{readJSONSync:readJSONSync}=require("fs-extra"),{join:join}=require("path"),{app:app,crashReporter:crashReporter}=require("electron");exports.launch=async function(){const{editorProcessManager:e,ProcessMainManager:t}=require("@editor/process-message");e("DASHBOARD_STORE_EXTENSION_INSTALL",new t(process));const i=require("@editor/setting");if(i.PATH.PROJECT){const e=join(i.PATH.PROJECT,"temp/crash");app.setPath("crashDumps",e),crashReporter.start({uploadToServer:!1})}if(!i.PATH.PROJECT){app.requestSingleInstanceLock()||(app.quit(),process.exit(0));const e=require("./dashboard/startup");return await e.app(),void await e.validation(i.dev)}try{const e=require("./dashboard/script/util");await e.installProjectDepend(i.PATH.PROJECT)}catch(e){console.error(e)}const{inject:n}=require("./inject");if(await n(),i.args.build){await Editor.Startup.__protected__.manager(!0,!!i.args.metric);const e=await scanPrePackage(),t=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:e,list:t});const n={};i.args.build.split(";").forEach(e=>{if(!e)return;const t=e.split("=");n[t[0].trim()]=t[1]});const a=await Editor.Startup.__protected__.build(n,i.args.dev);return app.exit(a),void process.exit(a)}const a=await useNativeScene(i);let r=!1;await Promise.all([Editor.Startup.__protected__.manager(!!i.args.nologin,!!i.args.metric),Editor.Startup.__protected__.window({async beforeOpen(e,t){const i=checkLayout(t.layout);r||(r=!0,a?("win32"===process.platform&&(e.transparent=!0,e.resizable=!0,e.frame=!1),i||(t.layout=readJSONSync(join(__dirname,"./static/layout-native.json")))):i&&(t.layout=readJSONSync(join(__dirname,"./static/layout-web.json"))))},async afterOpen(e){Editor.Metrics.trackTimeEnd("main-window:start-up",{value:Date.now()-__StartTime__})}})]);const o=await scanPrePackage(),s=await scanPackage();await Editor.Startup.__protected__.startPackage({preList:o,list:s}),await runTest(i)};let nativeSceneOriConfig=void 0;async function useNativeScene(e){if(void 0!==e.args.testScene){nativeSceneOriConfig=await Editor.Profile.getConfig("scene","scene.native-engine","global");const t="native"===e.args.testScene;return await Editor.Profile.setConfig("scene","scene.native-engine",t,"global"),!0}const t=await Editor.Profile.getConfig("scene","scene.native-engine","global");return void 0!==t&&t}async function runTest(e){if(void 0===e.args.testScene){if(e.args.test){const t=function(e){const t={};return e.forEach(e=>{if(!e)return;const i=e.split("=");t[i[0].trim()]=["true","false"].includes(i[1])?JSON.parse(i[1]):i[1]}),t}(e.args.test.split(";")),i=await Editor.Startup.__protected__.test(t,e.args.dev);app.exit(i)}}else{Editor.Dialog.__protected__.setMode("command");const t={useNative:"native"===e.args.testScene},i=await Editor.Startup.__protected__.test(t,e.args.dev);if(await Editor.Profile.setConfig("scene","scene.native-engine",!!nativeSceneOriConfig,"global"),console.log("测试结果",i),e.args.dev)return;"success"===i?app.exit(1):app.exit(-1)}}function checkLayout(e){let t=!1;return function e(i){if(i.panels&&i.panels.includes("scene.preview"))return t=!0,!0;i.children&&i.children.some(e)}(e.layout),t}async function scanPrePackage(){const e=[];return["./builtin/metrics","./builtin/menu","./builtin/profile","./builtin/project","./builtin/messages","./builtin/utils","./builtin/program","./builtin/tester","./builtin/information","./builtin/preferences","./builtin/engine","./builtin/programming","./modules/editor-extensions/extensions/device","./modules/editor-extensions/extensions/ui-kit"].forEach(t=>{e.push(join(Editor.App.path,t))}),e}async function scanPackage(){const e={editor:join(Editor.App.path,"./modules/editor-extensions/extensions"),engine:join(Editor.App.path,"./modules/engine-extensions/extensions"),platform:join(Editor.App.path,"./modules/platform-extensions/extensions"),builtinOthers:join(Editor.App.path,"./extension"),globalBuiltin:join(Editor.App.home,`./builtin-extensions/${Editor.App.version}`),project:join(Editor.Project.path,"extensions")},t=[];["./builtin/asset-db","./builtin/scene","./builtin/server","./builtin/preview","./builtin/animator","./builtin/builder","./builtin/shortcuts","./builtin/animation-graph"].forEach(e=>{t.push(join(Editor.App.path,e))});for(const i in e){const n=e[i],a=await Editor.Package.__protected__.scan(n);t.push(...a)}return t.push(join(Editor.App.path,"./builtin/placeholder")),t}